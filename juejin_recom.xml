<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Hibernate（31）Hibernate的原生SQL查询是什么？]]></title>    <link>https://juejin.cn/post/7593165280488833065</link>    <guid>https://juejin.cn/post/7593165280488833065</guid>    <pubDate>2026-01-09T13:47:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593165280488833065" data-draft-id="7593098101432795190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（31）Hibernate的原生SQL查询是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T13:47:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（31）Hibernate的原生SQL查询是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T13:47:44.000Z" title="Fri Jan 09 2026 13:47:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的原生SQL查询</h3>
<p>在某些情况下，HQL（Hibernate Query Language）或Criteria API可能无法满足复杂查询的需要，这时可以使用原生SQL查询（Native SQL Query）。原生SQL查询允许开发者直接编写SQL语句，并通过Hibernate执行这些语句，将结果映射为实体类或自定义结果集。</p>
<h3 data-id="heading-1">使用原生SQL查询</h3>
<p>原生SQL查询主要分为两种：</p>
<ol>
<li><strong>实体查询</strong>：返回实体对象。</li>
<li><strong>非实体查询</strong>：返回自定义对象或投影结果。</li>
</ol>
<h3 data-id="heading-2">示例代码</h3>
<h4 data-id="heading-3">实体类定义</h4>
<p>我们将定义两个实体类：<code>Person</code> 和 <code>Address</code>。</p>
<h5 data-id="heading-4">Person类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "age")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h5 data-id="heading-5">Address类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "address")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "street")</span>
    <span class="hljs-keyword">private</span> String street;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "person_id", nullable = false)</span>
    <span class="hljs-keyword">private</span> Person person;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">(String street, Person person)</span> {
        <span class="hljs-built_in">this</span>.street = street;
        <span class="hljs-built_in">this</span>.person = person;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStreet</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> street;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStreet</span><span class="hljs-params">(String street)</span> {
        <span class="hljs-built_in">this</span>.street = street;
    }

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">getPerson</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> person;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPerson</span><span class="hljs-params">(Person person)</span> {
        <span class="hljs-built_in">this</span>.person = person;
    }
}
</code></pre>
<h4 data-id="heading-6">Hibernate配置文件 <code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Person"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Address"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">HibernateUtil类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h3 data-id="heading-8">使用原生SQL查询示例</h3>
<h4 data-id="heading-9">插入示例数据</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateInsertData</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Jane Doe"</span>, <span class="hljs-number">28</span>);

            session.save(person1);
            session.save(person2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-10">使用原生SQL查询</h4>
<h5 data-id="heading-11">查询所有Person记录</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.query.NativeQuery;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateNativeQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 使用原生SQL查询所有Person记录</span>
        queryAllPersons(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryAllPersons</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM person"</span>;
            NativeQuery&lt;Person&gt; query = session.createNativeQuery(sql, Person.class);
            List&lt;Person&gt; persons = query.getResultList();
            System.out.println(<span class="hljs-string">"Query all persons:"</span>);
            <span class="hljs-keyword">for</span> (Person person : persons) {
                System.out.println(person.getName() + <span class="hljs-string">" - "</span> + person.getAge());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-12">使用投影查询返回自定义结果</h5>
<p>假设我们只想查询Person的姓名和年龄，而不是整个实体，这时可以使用投影查询（Projection Query）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.query.NativeQuery;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateProjectionQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 使用原生SQL投影查询</span>
        queryPersonNameAndAge(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryPersonNameAndAge</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT name, age FROM person"</span>;
            NativeQuery&lt;Object[]&gt; query = session.createNativeQuery(sql);
            List&lt;Object[]&gt; results = query.getResultList();
            System.out.println(<span class="hljs-string">"Query person name and age:"</span>);
            <span class="hljs-keyword">for</span> (Object[] row : results) {
                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) row[<span class="hljs-number">0</span>];
                <span class="hljs-type">Integer</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> (Integer) row[<span class="hljs-number">1</span>];
                System.out.println(name + <span class="hljs-string">" - "</span> + age);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-13">原生SQL查询详细解释</h3>
<ol>
<li>
<p><strong>插入示例数据</strong>：向数据库中插入两个<code>Person</code>对象供查询使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateInsertData</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Jane Doe"</span>, <span class="hljs-number">28</span>);

            session.save(person1);
            session.save(person2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
</li>
<li>
<p><strong>查询所有Person记录</strong>：使用原生SQL查询所有Person记录并映射为<code>Person</code>实体。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateNativeQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 使用原生SQL查询所有Person记录</span>
        queryAllPersons(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：Netty通信]]></title>    <link>https://juejin.cn/post/7593164154631815177</link>    <guid>https://juejin.cn/post/7593164154631815177</guid>    <pubDate>2026-01-09T12:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593164154631815177" data-draft-id="7593164154631798793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Netty通信"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2026-01-09T12:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Netty通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T12:13:27.000Z" title="Fri Jan 09 2026 12:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前文中我们了解了 Flink 的数据交互过程，上游的 Task 将数据写入到 ResultSubpartition 的 buffers 队列中。下游的 Task 通过 LocalInputChannel 和 RemoteInputChannel 消费上游的数据。</p>
<p>LocalInputChannel 是上下游的 Task 部署在同一个 TaskManager 时使用的，在本地即可完成数据交换，无需网络通信。当上下游的 Task 部署在不同的 TaskManager 时，就需要用到 RemoteInputChannel，Flink 利用 Netty 来进行数据交互。本文我们来一起梳理一下 Netty 相关的源码。</p>
<h3 data-id="heading-0">初始化</h3>
<p>我们先来看 NettyServer 和 NettyClient 的初始化过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ba4706fbb604cc5884638aaad02c95b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=ro8kY7ZVGC%2BQRjha4Mu06IgMWMI%3D" alt="NettyInit" loading="lazy"/></p>
<p>Netty 的初始化阶段是在 TaskManager 启动的过程中执行的。在 <code>TaskManagerServices.fromConfiguration</code> 方法中，会创建并启动 ShuffleEnvironment。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> TaskManagerServices <span class="hljs-title function_ invoke__">fromConfiguration</span>(
        TaskManagerServicesConfiguration taskManagerServicesConfiguration,
        PermanentBlobService permanentBlobService,
        MetricGroup taskManagerMetricGroup,
        ExecutorService ioExecutor,
        ScheduledExecutor scheduledExecutor,
        FatalErrorHandler fatalErrorHandler,
        WorkingDirectory workingDirectory)
        throws <span class="hljs-built_in">Exception</span> {
    ...

    <span class="hljs-keyword">final</span> ShuffleEnvironment<span class="hljs-meta">&lt;?</span>, <span class="hljs-meta">?&gt;</span> shuffleEnvironment =
            <span class="hljs-title function_ invoke__">createShuffleEnvironment</span>(
                    taskManagerServicesConfiguration,
                    taskEventDispatcher,
                    taskManagerMetricGroup,
                    ioExecutor,
                    scheduledExecutor);
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> listeningDataPort = shuffleEnvironment.<span class="hljs-title function_ invoke__">start</span>();
    ...
}
</code></pre>
<p>我们顺着调用链路可以一直找到 <code>NettyShuffleServiceFactory.createNettyShuffleEnvironment</code> 方法，这个方法中创建了 NettyConnectionManager，在 NettyConnectionManager 中有几个很重要的对象。</p>
<pre><code class="hljs language-ini" lang="ini">public NettyConnectionManager(
        NettyBufferPool bufferPool,
        ResultPartitionProvider partitionProvider,
        TaskEventPublisher taskEventPublisher,
        NettyConfig nettyConfig,
        boolean connectionReuseEnabled) {

    <span class="hljs-attr">this.server</span> = new NettyServer(nettyConfig)<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.client</span> = new NettyClient(nettyConfig)<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.bufferPool</span> = checkNotNull(bufferPool)<span class="hljs-comment">;</span>

    <span class="hljs-attr">this.partitionRequestClientFactory</span> =
            new PartitionRequestClientFactory(
                    client, nettyConfig.getNetworkRetries(), connectionReuseEnabled)<span class="hljs-comment">;</span>

    <span class="hljs-attr">this.nettyProtocol</span> =
            new NettyProtocol(
                    checkNotNull(partitionProvider), checkNotNull(taskEventPublisher))<span class="hljs-comment">;</span>
}
</code></pre>
<p>server 和 client 不需要多介绍，就是 Netty 的服务端和客户端。bufferPool 是缓冲池，用于存储要传输的数据。nettyProtocol 提供了 NettyClient 和 NettyServer 引导启动注册的 Channel Handler。</p>
<p>后面就是创建 NettyShuffleEnvironment 及其需要的对象了。在创建完成后，会调用它的 start 方法启动。这个启动方法就是调用了 <code>connectionManager.start</code>，在 NettyConnectionManager 中，就是初始化客户端和服务端。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">start</span>() throws IOException</span> {
    client.<span class="hljs-keyword">init</span>(nettyProtocol, bufferPool);

    <span class="hljs-keyword">return</span> server.<span class="hljs-keyword">init</span>(nettyProtocol, bufferPool);
}
</code></pre>
<h4 data-id="heading-1">client 初始化</h4>
<p>client 的初始化过程是先创建并初始化 Bootstrap。</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">initEpollBootstrap</span>() {
    <span class="hljs-comment">// Add the server port number to the name in order to distinguish</span>
    <span class="hljs-comment">// multiple clients running on the same host.</span>
    String name =
            NettyConfig<span class="hljs-selector-class">.CLIENT_THREAD_GROUP_NAME</span> + " (" + config.getServerPortRange() + ")";

    EpollEventLoopGroup epollGroup =
            new <span class="hljs-built_in">EpollEventLoopGroup</span>(
                    config.getClientNumThreads(), NettyServer<span class="hljs-selector-class">.getNamedThreadFactory</span>(name));
    bootstrap<span class="hljs-selector-class">.group</span>(epollGroup)<span class="hljs-selector-class">.channel</span>(EpollSocketChannel.class);

    config<span class="hljs-selector-class">.getTcpKeepIdleInSeconds</span>()
            <span class="hljs-selector-class">.ifPresent</span>(idle -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPIDLE, idle));
    config<span class="hljs-selector-class">.getTcpKeepInternalInSeconds</span>()
            <span class="hljs-selector-class">.ifPresent</span>(
                    interval -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPINTVL, interval));
    config<span class="hljs-selector-class">.getTcpKeepCount</span>()
            <span class="hljs-selector-class">.ifPresent</span>(count -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPCNT, count));
}
</code></pre>
<p>初始化过程重要设置 EventLoopGroup 和 channel，可以用 epoll 的话就用 epoll，否则就用 nio。设置好这些后就是设置了一些通道参数（连接超时时间、Bufffer 池等）。</p>
<p>到这里 client 的初始化其实并没有结束，还需要设置 Handler 流水线，这些工作是在 Task 启动时执行了。</p>
<h4 data-id="heading-2">server 初始化</h4>
<p>server 的初始化过程是先创建并初始化了 ServerBootstrap。之后同样也是设置 EventLoopGroup 和 channel，以及通道相关的各种参数。</p>
<p>设置好之后，会添加 ChannelHandler 流水线，这里的 ChannelHandler 流水线就是我们前面创建的 NettyProtocol 提供的。</p>
<pre><code class="hljs language-ini" lang="ini">public ChannelHandler<span class="hljs-section">[]</span> getServerChannelHandlers() {
    PartitionRequestQueue <span class="hljs-attr">queueOfPartitionQueues</span> = new PartitionRequestQueue()<span class="hljs-comment">;</span>
    PartitionRequestServerHandler <span class="hljs-attr">serverHandler</span> =
            new PartitionRequestServerHandler(
                    partitionProvider, taskEventPublisher, queueOfPartitionQueues)<span class="hljs-comment">;</span>

    return new ChannelHandler<span class="hljs-section">[]</span> {
        messageEncoder,
        new NettyMessage.NettyMessageDecoder(),
        serverHandler,
        queueOfPartitionQueues
    }<span class="hljs-comment">;</span>
}
</code></pre>
<p>流水线上包含了消息编码器、解码器、PartitionRequestServerHandler 请求服务端处理器和 PartitionRequestQueue 分区请求队列。</p>
<p>这些都设置好之后，就开始启动 NettyServer 服务了。</p>
<pre><code class="hljs language-scss" lang="scss">Iterator&lt;Integer&gt; portsIterator = config<span class="hljs-selector-class">.getServerPortRange</span>()<span class="hljs-selector-class">.getPortsIterator</span>();
while (portsIterator.hasNext() &amp;&amp; bindFuture == null) {
    Integer port = portsIterator<span class="hljs-selector-class">.next</span>();
    LOG<span class="hljs-selector-class">.debug</span>("Trying to bind Netty server to port: {}", port);

    bootstrap<span class="hljs-selector-class">.localAddress</span>(config.getServerAddress(), port);
    try {
        bindFuture = bootstrap<span class="hljs-selector-class">.bind</span>()<span class="hljs-selector-class">.syncUninterruptibly</span>();
    } catch (Exception e) {
        <span class="hljs-comment">// syncUninterruptibly() throws checked exceptions via Unsafe</span>
        <span class="hljs-comment">// continue if the exception is due to the port being in use, fail early</span>
        <span class="hljs-comment">// otherwise</span>
        if (isBindFailure(e)) {
            LOG<span class="hljs-selector-class">.debug</span>("Failed to bind Netty server", e);
        } else {
            throw e;
        }
    }
}

if (bindFuture == null) {
    throw new <span class="hljs-built_in">BindException</span>(
            "Could not start rest endpoint on any port in port range "
                    + config.getServerPortRange());
}

localAddress = (InetSocketAddress) bindFuture<span class="hljs-selector-class">.channel</span>()<span class="hljs-selector-class">.localAddress</span>();
</code></pre>
<h3 data-id="heading-3">客户端请求远端子分区</h3>
<p>服务端和客户端初始化之后，在 Task 运行时，会先完成 Client 的 ChannelHandler 的配置，然后请求 Netty 远端服务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b99d38c65200487f8f5f1d7e05cc2b36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=7ig7BNFyUGozffh2yuryKQkj%2FHo%3D" alt="NettyRequestPartition" loading="lazy"/></p>
<p>我们来看具体过程，在 Task 初始化时，会调用 <code>StreamTask.invoke</code> 方法，其内部会调用 <code>StreamTask.restoreStateAndGate</code> 方法，这里会便利 Task 的所有 InputGate，然后调用 requestPartitions。在 InputGate 的 requestPartitions 逻辑中，又便利所有的 InputChannel，调用 requestSubpartitions。</p>
<pre><code class="hljs language-scss" lang="scss">for (InputGate inputGate : inputGates) {
    recoveredFutures<span class="hljs-selector-class">.add</span>(inputGate.getStateConsumedFuture());

    inputGate
            <span class="hljs-selector-class">.getStateConsumedFuture</span>()
            <span class="hljs-selector-class">.thenRun</span>(
                    () -&gt;
                            mainMailboxExecutor<span class="hljs-selector-class">.execute</span>(
                                    inputGate::requestPartitions,
                                    "Input gate request partitions"));
}


private void <span class="hljs-built_in">internalRequestPartitions</span>() {
    for (InputChannel inputChannel : inputChannels()) {
        try {
            inputChannel<span class="hljs-selector-class">.requestSubpartitions</span>();
        } catch (Throwable t) {
            inputChannel<span class="hljs-selector-class">.setError</span>(t);
            return;
        }
    }
}
</code></pre>
<p>我们来看 <code>RemoteInputChannel.requestSubpartitions</code> 的逻辑。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">requestSubpartitions</span>() throws IOException, InterruptedException</span> {
    <span class="hljs-keyword">if</span> (partitionRequestClient == <span class="hljs-literal">null</span>) {
        LOG.debug(
                <span class="hljs-string">"{}: Requesting REMOTE subpartitions {} of partition {}. {}"</span>,
                <span class="hljs-keyword">this</span>,
                consumedSubpartitionIndexSet,
                partitionId,
                channelStatePersister);
        <span class="hljs-comment">// Create a client and request the partition</span>
        <span class="hljs-keyword">try</span> {
            partitionRequestClient =
                    connectionManager.createPartitionRequestClient(connectionId);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-comment">// IOExceptions indicate that we could not open a connection to the remote</span>
            <span class="hljs-comment">// TaskExecutor</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> PartitionConnectionException(partitionId, e);
        }

        partitionRequestClient.requestSubpartition(
                partitionId, consumedSubpartitionIndexSet, <span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>);
    }
}
</code></pre>
<p>这里主要有两个步骤，先是创建 partitionRequestClient，然后调用 requestSubpartition。</p>
<h4 data-id="heading-4">创建请求客户端</h4>
<p>PartitionRequestClient 是在 <code>PartitionRequestClientFactory.connect</code> 中创建的。先调用了 <code>NettyClient.connect</code>，同步等待客户端连接到服务端，这个过程中会进行 ChannelHandler 配置，也就是我们在初始化的过程中介绍的，NettyClient 没有完成的步骤。</p>
<pre><code class="hljs language-scss" lang="scss">public ChannelHandler<span class="hljs-selector-attr">[]</span> <span class="hljs-built_in">getClientChannelHandlers</span>() {
    NetworkClientHandler networkClientHandler = new <span class="hljs-built_in">CreditBasedPartitionRequestClientHandler</span>();

    return new ChannelHandler<span class="hljs-selector-attr">[]</span> {
        messageEncoder,
        new <span class="hljs-built_in">NettyMessageClientDecoderDelegate</span>(networkClientHandler),
        networkClientHandler
    };
}
</code></pre>
<p>Handler 包括了消息编码器、解码器和 CreditBasedPartitionRequestClientHandler 这个基于 Credit 的分区请求客户端处理器。Handler 配置好之后会利用 bootstrap 连接到服务端。</p>
<p>在获取到 Channel 和 NetworkClientHandler 之后，就直接创建了 NettyPartitionRequestClient。</p>
<h4 data-id="heading-5">请求子分区数据</h4>
<p>让我们再回到 RemoteInputChannel 的 requestSubpartitions 方法中，现在我们创建好了 NettyPartitionRequestClient，接下来就是调用它的 requestSubpartition 方法来发起请求。</p>
<p>这里逻辑也比较简单：</p>
<ol>
<li>向 NetworkClientHandler 注册当前 RemoteInputChannel。</li>
<li>构造请求对象 PartitionRequest，这里包含了分区 ID、子分区索引、inputChannel ID 以及初识的 Credit。</li>
<li>调用 <code>tcpChannel.writeAndFlush</code> 发起请求，并添加请求失败的监听。</li>
<li>如果请求失败，移除当前 inputChannel。</li>
</ol>
<h3 data-id="heading-6">服务端响应</h3>
<p>现在数据到了服务端，我们来看服务端处理的具体过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/339a67c8d7c64865bc109c665e60c60c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=xpUm9gskdJn323LGxtvTmcAThSc%3D" alt="NettyServerHandler" loading="lazy"/></p>
<p>在 NettyServer 初始化的过程中，我们添加了两个重要的 Handler，分别是 PartitionRequestServerHandler 和 PartitionRequestQueue。服务端响应数据的过程就是这两个 Handler 在发挥作用。</p>
<p>PartitionRequestServerHandler 负责处理 Client 端通过 PartitionRequestClient 发送的请求，处理过程是先创建 CreditBasedSequenceNumberingViewReader 类型的 reader，然后将它放入 PartitionRequestQueue 维护的 reader 队列中。PartitionRequestQueue 会监听 Netty Channel 的可写入状态，当 Netty Channel 可写入时，会消费数据并写入网络。</p>
<p>下面我们来看具体的源码。</p>
<p>服务端的响应入口在 <code>PartitionRequestServerHandler.channelRead0</code> 方法，这里在处理 PartitionRequest 请求时，先是创建 CreditBasedSequenceNumberingViewReader，然后调用 requestSubpartitionViewOrRegisterListener。</p>
<p>requestSubpartitionViewOrRegisterListener 的逻辑是创建 ResultSubpartitionView，并提醒 PartitionRequestQueue 有数据可用。</p>
<pre><code class="hljs language-ini" lang="ini">Optional&lt;ResultSubpartitionView&gt; <span class="hljs-attr">subpartitionViewOptional</span> =
        partitionProvider.createSubpartitionViewOrRegisterListener(
                resultPartitionId,
                subpartitionIndexSet,
                this,
                partitionRequestListener)<span class="hljs-comment">;</span>
...

notifyDataAvailable(subpartitionView)<span class="hljs-comment">;</span>
</code></pre>
<p>ResultSubpartitionView 就是用来消费 ResultSubpartition 的数据。</p>
<p>notifyDataAvailable 内部调用了 notifyReaderNonEmpty，notifyReaderNonEmpty 又触发了 userEventTriggered，这里调用 enqueueAvailableReader 将 reader 放入到可用队列 availableReaders 中。</p>
<pre><code class="hljs language-scss" lang="scss">private void <span class="hljs-built_in">enqueueAvailableReader</span>(final NetworkSequenceViewReader reader) throws Exception {
    if (reader.isRegisteredAsAvailable()) {
        return;
    }

    ResultSubpartitionView<span class="hljs-selector-class">.AvailabilityWithBacklog</span> availabilityWithBacklog =
            reader<span class="hljs-selector-class">.getAvailabilityAndBacklog</span>();
    if (!availabilityWithBacklog.isAvailable()) {
        int backlog = availabilityWithBacklog<span class="hljs-selector-class">.getBacklog</span>();
        if (backlog &gt; <span class="hljs-number">0</span> &amp;&amp; reader.needAnnounceBacklog()) {
            <span class="hljs-built_in">announceBacklog</span>(reader, backlog);
        }
        return;
    }

    <span class="hljs-comment">// Queue an available reader for consumption. If the queue is empty,</span>
    <span class="hljs-comment">// we try trigger the actual write. Otherwise this will be handled by</span>
    <span class="hljs-comment">// the writeAndFlushNextMessageIfPossible calls.</span>
    boolean triggerWrite = availableReaders<span class="hljs-selector-class">.isEmpty</span>();
    <span class="hljs-built_in">registerAvailableReader</span>(reader);

    if (triggerWrite) {
        <span class="hljs-built_in">writeAndFlushNextMessageIfPossible</span>(ctx.channel());
    }
}
</code></pre>
<p>如果 reader 是队列中的第一个元素，会触发数据写入网络。</p>
<p>writeAndFlushNextMessageIfPossible 的处理步骤如下：</p>
<ol>
<li>取出可用 reader。</li>
<li>调用 <code>reader.getNextBuffer</code> 获取数据。</li>
<li>如果 reader 仍然可用，将其加回队列。</li>
<li>向下游写入数据并添加下次写入的监听。</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> BufferAndAvailability <span class="hljs-title function_">getNextBuffer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-type">BufferAndBacklog</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> subpartitionView.getNextBuffer();
    <span class="hljs-keyword">if</span> (next != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (next.buffer().isBuffer() &amp;&amp; --numCreditsAvailable &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"no credit available"</span>);
        }

        <span class="hljs-keyword">final</span> Buffer.<span class="hljs-type">DataType</span> <span class="hljs-variable">nextDataType</span> <span class="hljs-operator">=</span> getNextDataType(next);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAndAvailability</span>(
                next.buffer(), nextDataType, next.buffersInBacklog(), next.getSequenceNumber());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>在 getNextBuffer 方法中，会将 credit 值减 1，并判断是否小于 0。如果小于 0 会抛出异常，reader 是否可用也是根据 numCreditsAvailable 是否大于 0 来判断的。</p>
<h3 data-id="heading-7">客户端接收数据</h3>
<p>NettyClient 在消费数据时，同样也是以 ChannelHandler 作为入口。这里的入口方法是 <code>CreditBasedPartitionRequestClientHandler.channelRead</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e3e211ea7d445e8a040cfd2e5bac1dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=QzLjqwFQqFXMQxN4wlfezdFTli4%3D" alt="NettyClientHandler" loading="lazy"/></p>
<p>在 decodeMsg 方法中，先解码 msg，判断 InputChannel 是否可用，如果不可用，则取消当前 InputChannel 的订阅。如果可用，继续调用 decodeBufferOrEvent 进行处理。decodeBufferOrEvent 的核心逻辑是调用 <code>RemoteInputChannel.onBuffer</code> 方法，将数据加入到 receivedBuffers 队列。</p>
<p>如果 receivedBuffers 队列在此之前处于空闲状态，会调用 notifyChannelNonEmpty，将当前 RemoteInputChannel 加入到 inputChannelsWithData 队列中，同时还会唤醒 inputChannelsWithData 上的阻塞线程，让 inputGate 可以消费 RemoteInputChannel 的数据。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> boolean <span class="hljs-title">queueChannelUnsafe</span>(<span class="hljs-params">InputChannel channel, boolean priority</span>)</span> {
    assert Thread.holdsLock(inputChannelsWithData);
    <span class="hljs-keyword">if</span> (channelsWithEndOfPartitionEvents.<span class="hljs-keyword">get</span>(channel.getChannelIndex())) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    final boolean alreadyEnqueued =
            enqueuedInputChannelsWithData.<span class="hljs-keyword">get</span>(channel.getChannelIndex());
    <span class="hljs-keyword">if</span> (alreadyEnqueued
            &amp;&amp; (!priority || inputChannelsWithData.containsPriorityElement(channel))) {
        <span class="hljs-comment">// already notified / prioritized (double notification), ignore</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 当前 inputChannel 加入到 inputChannelsWithData</span>
    inputChannelsWithData.<span class="hljs-keyword">add</span>(channel, priority, alreadyEnqueued);
    <span class="hljs-keyword">if</span> (!alreadyEnqueued) {
        enqueuedInputChannelsWithData.<span class="hljs-keyword">set</span>(channel.getChannelIndex());
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 唤醒线程</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyDataAvailable</span>()</span> {
    availabilityMonitor.notifyAll();
    toNotify = inputGate.availabilityHelper.getUnavailableToResetAvailable();
}
</code></pre>
<p>如果客户端有积压，还需要根据积压申请 Buffer 并更新 Credit 值。这里申请的 buffer 数量为积压数量+初识 Credit 值。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSenderBacklog</span><span class="hljs-params">(<span class="hljs-type">int</span> backlog)</span> <span class="hljs-keyword">throws</span> IOException {
    notifyBufferAvailable(bufferManager.requestFloatingBuffers(backlog + initialCredit));
}
</code></pre>
<p>如果 RemoteInputChannel 没有足够的 buffer，则会向 LocalBufferPool 申请新的 buffer，如果申请不到，会加一个监听，等 LocalBufferPool 有空闲时再触发申请 buffer。</p>
<pre><code class="hljs language-ini" lang="ini">private int tryRequestBuffers() {
    assert Thread.holdsLock(bufferQueue)<span class="hljs-comment">;</span>

    int <span class="hljs-attr">numRequestedBuffers</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    while (bufferQueue.getAvailableBufferSize() &lt; numRequiredBuffers
            &amp;&amp; !isWaitingForFloatingBuffers) {
        BufferPool <span class="hljs-attr">bufferPool</span> = inputChannel.inputGate.getBufferPool()<span class="hljs-comment">;</span>
        Buffer <span class="hljs-attr">buffer</span> = bufferPool.requestBuffer()<span class="hljs-comment">;</span>
        if (buffer != null) {
            bufferQueue.addFloatingBuffer(buffer)<span class="hljs-comment">;</span>
            numRequestedBuffers++<span class="hljs-comment">;</span>
        } else if (bufferPool.addBufferListener(this)) {
            <span class="hljs-attr">isWaitingForFloatingBuffers</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            break<span class="hljs-comment">;</span>
        }
    }
    return numRequestedBuffers<span class="hljs-comment">;</span>
}
</code></pre>
<p>当 RemoteInputChannel 申请到了需要的 buffer 之后，就会向 NettyServer 发送 AddCredit 消息，请求更新 Credit 值。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyCreditAvailable</span>() throws IOException</span> {
    checkPartitionRequestQueueInitialized();

    partitionRequestClient.notifyCreditAvailable(<span class="hljs-keyword">this</span>);
}


<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyCreditAvailable</span>(<span class="hljs-params">RemoteInputChannel inputChannel</span>)</span> {
    sendToChannel(<span class="hljs-keyword">new</span> AddCreditMessage(inputChannel));
}
</code></pre>
<p>NettyServer 收到请求后，会将对应的 Credit 值进行更新。</p>
<pre><code class="hljs language-ini" lang="ini">else if (<span class="hljs-attr">msgClazz</span> == AddCredit.class) {
    AddCredit <span class="hljs-attr">request</span> = (AddCredit) msg<span class="hljs-comment">;</span>

    outboundQueue.addCreditOrResumeConsumption(
            request.receiverId, reader -&gt; reader.addCredit(request.credit))<span class="hljs-comment">;</span>
}

void addCreditOrResumeConsumption(
        InputChannelID receiverId, Consumer&lt;NetworkSequenceViewReader&gt; operation)
        throws Exception {
    if (fatalError) {
        return<span class="hljs-comment">;</span>
    }

    NetworkSequenceViewReader <span class="hljs-attr">reader</span> = obtainReader(receiverId)<span class="hljs-comment">;</span>

    operation.accept(reader)<span class="hljs-comment">;</span>
    enqueueAvailableReader(reader)<span class="hljs-comment">;</span>
}


public void addCredit(int creditDeltas) {
    numCreditsAvailable += creditDeltas<span class="hljs-comment">;</span>
}
</code></pre>
<p>此外，Flink 还有两种场景会更新 Credit 值。</p>
<p>一种是 LocalBufferPool 回收空闲 buffer 时，会将 buffer 分配给申请者，分配之后会调用对应 InputChannel 的 notifyBufferAvailable 方法通知更新 Credit。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91654d63dada40089adc39ddeaa32f16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=%2B6Q5%2FPKgLnUQeBSJ7%2BBwQflI7Ik%3D" alt="LocalBufferPool" loading="lazy"/></p>
<p>另一种是 RemoteInputChannel 独占的 buffer 队列释放 buffer 时，会触发 Credit 更新。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c5cb9fddc0d4e18802107951125230b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768565606&amp;x-signature=T4scDtDnWrMIvABCUiom8RV0bTQ%3D" alt="BufferManager" loading="lazy"/></p>
<h3 data-id="heading-8">反压</h3>
<p>通过前面的学习，我们其实已经理解了反压的机制了。当前 Flink 的反压就是通过 Credit 来实现反压的，如果下游数据处理速度慢，Credit 会被耗尽，上游也就不会继续处理和下发数据了。直到下游处理完成，有了空闲的 buffer，此时向上游反馈更新 Credit 值，上游就会继续处理数据。</p>
<h3 data-id="heading-9">总结</h3>
<p>最后我们总结一下，本文我们一起梳理了 Flink Netty 相关的源码。包括 NettyClient 和 NettyServer 的初始化，初始化过程中会创建一系列 ChannelHandler，之后利用这些Handler 处理数据，数据处理包括 Client 端的发送和接收消息，Server 端处理消息的过程。中间还穿插着 Credit 的处理。Flink 的反压逻辑就是依赖于 Credit 来实现的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（31）Hibernate的原生SQL查询是什么？]]></title>    <link>https://juejin.cn/post/7593145583348105258</link>    <guid>https://juejin.cn/post/7593145583348105258</guid>    <pubDate>2026-01-09T13:47:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593145583348105258" data-draft-id="7593098101432778806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（31）Hibernate的原生SQL查询是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T13:47:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（31）Hibernate的原生SQL查询是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T13:47:01.000Z" title="Fri Jan 09 2026 13:47:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Hibernate的原生SQL查询</h3>
<p>在某些情况下，HQL（Hibernate Query Language）或Criteria API可能无法满足复杂查询的需要，这时可以使用原生SQL查询（Native SQL Query）。原生SQL查询允许开发者直接编写SQL语句，并通过Hibernate执行这些语句，将结果映射为实体类或自定义结果集。</p>
<h3 data-id="heading-1">使用原生SQL查询</h3>
<p>原生SQL查询主要分为两种：</p>
<ol>
<li><strong>实体查询</strong>：返回实体对象。</li>
<li><strong>非实体查询</strong>：返回自定义对象或投影结果。</li>
</ol>
<h3 data-id="heading-2">示例代码</h3>
<h4 data-id="heading-3">实体类定义</h4>
<p>我们将定义两个实体类：<code>Person</code> 和 <code>Address</code>。</p>
<h5 data-id="heading-4">Person类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "age")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h5 data-id="heading-5">Address类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.domain;

<span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "address")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "street")</span>
    <span class="hljs-keyword">private</span> String street;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "person_id", nullable = false)</span>
    <span class="hljs-keyword">private</span> Person person;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Address</span><span class="hljs-params">(String street, Person person)</span> {
        <span class="hljs-built_in">this</span>.street = street;
        <span class="hljs-built_in">this</span>.person = person;
    }

    <span class="hljs-comment">// Getters 和 Setters</span>

    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStreet</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> street;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStreet</span><span class="hljs-params">(String street)</span> {
        <span class="hljs-built_in">this</span>.street = street;
    }

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">getPerson</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> person;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPerson</span><span class="hljs-params">(Person person)</span> {
        <span class="hljs-built_in">this</span>.person = person;
    }
}
</code></pre>
<h4 data-id="heading-6">Hibernate配置文件 <code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Person"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Address"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">HibernateUtil类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 从配置文件创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-comment">// 记录启动失败的错误</span>
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h3 data-id="heading-8">使用原生SQL查询示例</h3>
<h4 data-id="heading-9">插入示例数据</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateInsertData</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Jane Doe"</span>, <span class="hljs-number">28</span>);

            session.save(person1);
            session.save(person2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-10">使用原生SQL查询</h4>
<h5 data-id="heading-11">查询所有Person记录</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.query.NativeQuery;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateNativeQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 使用原生SQL查询所有Person记录</span>
        queryAllPersons(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryAllPersons</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM person"</span>;
            NativeQuery&lt;Person&gt; query = session.createNativeQuery(sql, Person.class);
            List&lt;Person&gt; persons = query.getResultList();
            System.out.println(<span class="hljs-string">"Query all persons:"</span>);
            <span class="hljs-keyword">for</span> (Person person : persons) {
                System.out.println(person.getName() + <span class="hljs-string">" - "</span> + person.getAge());
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-12">使用投影查询返回自定义结果</h5>
<p>假设我们只想查询Person的姓名和年龄，而不是整个实体，这时可以使用投影查询（Projection Query）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.query.NativeQuery;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateProjectionQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 使用原生SQL投影查询</span>
        queryPersonNameAndAge(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">queryPersonNameAndAge</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT name, age FROM person"</span>;
            NativeQuery&lt;Object[]&gt; query = session.createNativeQuery(sql);
            List&lt;Object[]&gt; results = query.getResultList();
            System.out.println(<span class="hljs-string">"Query person name and age:"</span>);
            <span class="hljs-keyword">for</span> (Object[] row : results) {
                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) row[<span class="hljs-number">0</span>];
                <span class="hljs-type">Integer</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> (Integer) row[<span class="hljs-number">1</span>];
                System.out.println(name + <span class="hljs-string">" - "</span> + age);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-13">原生SQL查询详细解释</h3>
<ol>
<li>
<p><strong>插入示例数据</strong>：向数据库中插入两个<code>Person</code>对象供查询使用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateInsertData</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">30</span>);
            <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Jane Doe"</span>, <span class="hljs-number">28</span>);

            session.save(person1);
            session.save(person2);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
                session.close();
            }
        }
    }
}
</code></pre>
</li>
<li>
<p><strong>查询所有Person记录</strong>：使用原生SQL查询所有Person记录并映射为<code>Person</code>实体。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateNativeQueryExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 使用原生SQL查询所有Person记录</span>
        queryAllPersons(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
</code></pre>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SQLInsight：从JDBC底层到API调用的零侵入SQL监控方案]]></title>    <link>https://juejin.cn/post/7593232758127280134</link>    <guid>https://juejin.cn/post/7593232758127280134</guid>    <pubDate>2026-01-10T08:25:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593232758127280134" data-draft-id="7593232758127247366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SQLInsight：从JDBC底层到API调用的零侵入SQL监控方案"/> <meta itemprop="keywords" content="后端,数据库,开源"/> <meta itemprop="datePublished" content="2026-01-10T08:25:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SQLInsight：从JDBC底层到API调用的零侵入SQL监控方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T08:25:40.000Z" title="Sat Jan 10 2026 08:25:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsql-insight" target="_blank" title="https://gitee.com/sh_wangwanbao/sql-insight" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a><br/>
<strong>上一篇文章</strong>：<a href="https://juejin.cn/post/7591513171199295551" target="_blank" title="https://juejin.cn/post/7591513171199295551">SQLInsight：一行依赖，自动追踪API背后的每一条SQL</a></p>
</blockquote>
<h2 data-id="heading-0">开篇</h2>
<p>上周写了一篇文章，分享了SQLInsight的设计思路和技术方案，没想到收到了不少反馈。有人问"啥时候能用"，有人问"技术细节是怎么实现的"。</p>
<p>花了小一周时间，终于把它实现出来了。今天周末，终于可以还债了。</p>
<p>这篇文章，我们来聊聊SQLInsight的技术实现细节：动态代理是怎么做的？StackTrace是怎么解析的？为什么说零侵入？性能到底如何？</p>
<p>代码已经开源，你可以直接用，也可以学习实现思路。</p>
<hr/>
<h2 data-id="heading-1">一、技术亮点速览</h2>
<p>在开始之前，先说几个核心亮点，让你知道这个项目有什么不一样：</p>
<h3 data-id="heading-2">1.1 真正的零侵入</h3>
<p>不需要在代码里加注解，不需要修改配置文件，甚至不需要加启动参数。加个依赖，启动应用，就能看到所有SQL执行情况。这是怎么做到的？答案是：<strong>在最底层做手脚</strong>。</p>
<h3 data-id="heading-3">1.2 完整的调用链自动追踪</h3>
<p>你在Controller写了个接口，调用Service，Service调用Mapper，最后执行了SQL。这整个链路，SQLInsight能自动给你串起来：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>users<span class="hljs-operator">/</span><span class="hljs-number">123</span> 
  → UserController.getUser()
    → UserService.findById()
      → <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span> (<span class="hljs-number">15</span>ms)
</code></pre>
<p>这不是靠AOP，不是靠埋点，而是靠<strong>读取线程栈</strong>。</p>
<h3 data-id="heading-4">1.3 兼容性好到让人惊讶</h3>
<p>不管你用的是MyBatis、JPA、Hibernate还是JdbcTemplate，不管你的连接池是Druid、HikariCP还是C3P0，SQLInsight都能工作。为什么？因为它代理的是JDBC标准接口，不依赖具体实现。</p>
<h3 data-id="heading-5">1.4 性能影响微乎其微</h3>
<p>动态代理？StackTrace扫描？这不会很慢吗？实测下来，单次SQL执行的额外开销在<strong>1微秒以内</strong>。怎么做到的？答案是：<strong>缓存 + 异步 + 限制扫描深度</strong>。</p>
<hr/>
<h2 data-id="heading-6">二、设计思想的来源</h2>
<p>做技术不是闭门造车，SQLInsight的核心设计思想来自两个成熟的开源组件。</p>
<h3 data-id="heading-7">2.1 动态代理：学习Seata</h3>
<p>Seata是阿里开源的分布式事务框架。它有个很巧妙的设计：通过动态代理DataSource，在JDBC层拦截所有SQL执行，实现分布式事务的透明化。</p>
<p>SQLInsight借鉴了这个思路，但做得更彻底：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[应用程序] --&gt;|调用| B[DataSourceProxy]
    B --&gt;|代理| C[ConnectionProxy]
    C --&gt;|代理| D[PreparedStatementProxy]
    D --&gt;|执行| E[真实的JDBC驱动]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style E fill:#f5e1ff
</code></pre>
<p><strong>为什么这个思路好？</strong></p>
<ol>
<li><strong>最底层拦截</strong>：不管你上层用什么框架，最终都要通过JDBC执行SQL</li>
<li><strong>标准接口</strong>：JDBC是Java标准，不会随便变</li>
<li><strong>透明性好</strong>：对上层业务代码完全透明</li>
</ol>
<p>Seata代理DataSource是为了加事务控制，SQLInsight代理DataSource是为了监控。本质上是同一个思路的不同应用。</p>
<h3 data-id="heading-8">2.2 StackTrace分析：学习MyBatis</h3>
<p>MyBatis有个很强大的功能：能把SQL执行日志和Mapper方法对应起来。它怎么做的？答案是：<strong>解析StackTrace</strong>。</p>
<p>当SQL执行时，MyBatis会读取当前线程的调用栈，找到是哪个Mapper接口的哪个方法触发的。</p>
<p>SQLInsight把这个思路往上延伸了一层：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[SQL执行] --&gt;|触发| B[获取StackTrace]
    B --&gt; C{扫描调用栈}
    C --&gt;|找到| D[RestController注解]
    D --&gt; E[解析API路径]
    E --&gt; F[解析方法名]
    F --&gt; G[构建完整调用链]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style E fill:#f5e1ff
    style F fill:#e1f5ff
    style G fill:#fff4e1
</code></pre>
<p><strong>为什么这个思路可行？</strong></p>
<p>Java的线程栈里包含了完整的方法调用链。通过扫描栈帧，可以找到：</p>
<ul>
<li>哪个Controller被调用了（有@RestController注解）</li>
<li>哪个Service方法被调用了</li>
<li>哪个Mapper方法被调用了</li>
</ul>
<p>这样就能把API调用和SQL执行串起来，形成完整的链路。</p>
<hr/>
<h2 data-id="heading-9">三、核心技术实现</h2>
<h3 data-id="heading-10">3.1 动态代理的三层结构</h3>
<p>JDBC的核心接口有三个：DataSource、Connection、Statement/PreparedStatement。SQLInsight为每一层都创建了代理。</p>
<h4 data-id="heading-11">3.1.1 第一层：代理DataSource</h4>
<p>这一层是入口。Spring Boot启动时，会创建DataSource Bean。我们通过<code>BeanPostProcessor</code>拦截这个过程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> {
    <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> DataSource) {
        <span class="hljs-comment">// 把原始DataSource包装成代理</span>
        <span class="hljs-keyword">return</span> DataSourceProxy.create((DataSource) bean, collector, handler);
    }
    <span class="hljs-keyword">return</span> bean;
}
</code></pre>
<p><strong>关键点</strong>：<code>BeanPostProcessor</code>是Spring提供的扩展点，能在Bean创建后、初始化后做一些处理。这是Spring生态常用的插件化机制。</p>
<h4 data-id="heading-12">3.1.2 第二层：代理Connection</h4>
<p>当业务代码调用<code>dataSource.getConnection()</code>时，我们返回一个代理的Connection：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"getConnection"</span>.equals(method.getName())) {
        <span class="hljs-comment">// 调用原始DataSource获取真实Connection</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">realConnection</span> <span class="hljs-operator">=</span> (Connection) method.invoke(target, args);
        <span class="hljs-comment">// 返回代理Connection</span>
        <span class="hljs-keyword">return</span> ConnectionProxy.createProxy(realConnection, collector, handler);
    }
    <span class="hljs-keyword">return</span> method.invoke(target, args);
}
</code></pre>
<p><strong>这里用到了Java动态代理的核心机制</strong>：<code>InvocationHandler</code>。每次调用代理对象的方法时，都会进入<code>invoke</code>方法，我们可以在这里做拦截。</p>
<h4 data-id="heading-13">3.1.3 第三层：代理PreparedStatement</h4>
<p>这一层是真正执行SQL的地方。当业务代码调用<code>connection.prepareStatement(sql)</code>时：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"prepareStatement"</span>.equals(method.getName())) {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> (String) args[<span class="hljs-number">0</span>];
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">realStmt</span> <span class="hljs-operator">=</span> (PreparedStatement) method.invoke(target, args);
        <span class="hljs-comment">// 返回代理PreparedStatement，并把SQL传进去</span>
        <span class="hljs-keyword">return</span> PreparedStatementProxy.createProxy(realStmt, sql, collector, handler);
    }
    <span class="hljs-keyword">return</span> method.invoke(target, args);
}
</code></pre>
<p><strong>这里的细节</strong>：我们把SQL语句传给了PreparedStatement代理。这样在执行SQL时，代理就知道要执行的是什么SQL了。</p>
<h3 data-id="heading-14">3.2 SQL执行的拦截</h3>
<p>PreparedStatement代理的核心逻辑在这里：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Integer, Object&gt; parameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-comment">// 1. 拦截参数设置方法（setString、setInt等）</span>
    <span class="hljs-keyword">if</span> (method.getName().startsWith(<span class="hljs-string">"set"</span>) &amp;&amp; args.length &gt;= <span class="hljs-number">2</span>) {
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) args[<span class="hljs-number">0</span>];
        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];
        parameters.put(index, value);  <span class="hljs-comment">// 记录参数值</span>
    }
    
    <span class="hljs-comment">// 2. 拦截执行方法（execute、executeQuery等）</span>
    <span class="hljs-keyword">if</span> (method.getName().startsWith(<span class="hljs-string">"execute"</span>)) {
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);  <span class="hljs-comment">// 执行真实SQL</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
        
        <span class="hljs-comment">// 3. 收集SQL执行信息</span>
        collectSqlExecution(sql, parameters, duration);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">return</span> method.invoke(target, args);
}
</code></pre>
<p><strong>这里有两个关键点</strong>：</p>
<ol>
<li><strong>参数拦截</strong>：PreparedStatement的参数是通过<code>setXxx(index, value)</code>方法设置的。我们拦截这些方法，把参数记下来。</li>
<li><strong>执行拦截</strong>：当调用<code>execute()</code>方法时，我们记录开始时间，执行SQL，然后记录结束时间，算出执行耗时。</li>
</ol>
<h3 data-id="heading-15">3.3 StackTrace解析：找到API调用者</h3>
<p>SQL执行时，我们需要知道是哪个API触发的。这里用到了StackTrace分析：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApiInfo <span class="hljs-title function_">extractApiInfo</span><span class="hljs-params">()</span> {
    StackTraceElement[] stack = Thread.currentThread().getStackTrace();
    
    <span class="hljs-comment">// 限制扫描深度，避免性能问题</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">maxDepth</span> <span class="hljs-operator">=</span> Math.min(stack.length, <span class="hljs-number">50</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxDepth; i++) {
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> stack[i].getClassName();
        
        <span class="hljs-comment">// 先查缓存</span>
        <span class="hljs-keyword">if</span> (controllerCache.containsKey(className)) {
            <span class="hljs-keyword">return</span> controllerCache.get(className);
        }
        
        <span class="hljs-comment">// 加载类，检查是否有@RestController或@Controller注解</span>
        Class&lt;?&gt; clazz = Class.forName(className);
        <span class="hljs-keyword">if</span> (clazz.isAnnotationPresent(RestController.class) || 
            clazz.isAnnotationPresent(Controller.class)) {
            <span class="hljs-type">ApiInfo</span> <span class="hljs-variable">apiInfo</span> <span class="hljs-operator">=</span> parseApiInfo(clazz, stack[i].getMethodName());
            controllerCache.put(className, apiInfo);  <span class="hljs-comment">// 缓存起来</span>
            <span class="hljs-keyword">return</span> apiInfo;
        }
    }
    
    <span class="hljs-keyword">return</span> ApiInfo.unknown();
}
</code></pre>
<p><strong>性能优化点</strong>：</p>
<ol>
<li><strong>限制扫描深度</strong>：只扫描前50层调用栈，避免深度递归</li>
<li><strong>缓存Controller信息</strong>：同一个Controller类只解析一次，后续直接从缓存取</li>
</ol>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[SQL执行] --&gt; B{读取线程栈}
    B --&gt; C[第1层: SQLInsight代理]
    C --&gt; D[第2层: MyBatis]
    D --&gt; E[第3层: Service]
    E --&gt; F[第4层: Controller]
    F --&gt; G{找到RestController?}
    G --&gt;|是| H[解析API信息]
    G --&gt;|否| I[继续向上扫描]
    H --&gt; J[返回API路径和方法]
    
    style A fill:#e1f5ff
    style F fill:#e1ffe1
    style H fill:#fff4e1
    style J fill:#ffe1f5
</code></pre>
<h3 data-id="heading-16">3.4 API信息解析</h3>
<p>找到Controller后，怎么解析出API路径呢？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApiInfo <span class="hljs-title function_">parseApiInfo</span><span class="hljs-params">(Class&lt;?&gt; controllerClass, String methodName)</span> {
    <span class="hljs-comment">// 1. 获取类级别的@RequestMapping</span>
    <span class="hljs-type">RequestMapping</span> <span class="hljs-variable">classMapping</span> <span class="hljs-operator">=</span> controllerClass.getAnnotation(RequestMapping.class);
    <span class="hljs-type">String</span> <span class="hljs-variable">basePath</span> <span class="hljs-operator">=</span> classMapping != <span class="hljs-literal">null</span> ? classMapping.value()[<span class="hljs-number">0</span>] : <span class="hljs-string">""</span>;
    
    <span class="hljs-comment">// 2. 找到对应的方法</span>
    <span class="hljs-keyword">for</span> (Method method : controllerClass.getDeclaredMethods()) {
        <span class="hljs-keyword">if</span> (method.getName().equals(methodName)) {
            <span class="hljs-comment">// 3. 获取方法级别的@GetMapping/@PostMapping等</span>
            <span class="hljs-type">GetMapping</span> <span class="hljs-variable">getMapping</span> <span class="hljs-operator">=</span> method.getAnnotation(GetMapping.class);
            <span class="hljs-keyword">if</span> (getMapping != <span class="hljs-literal">null</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> basePath + getMapping.value()[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfo</span>(path, <span class="hljs-string">"GET"</span>, methodName);
            }
            <span class="hljs-comment">// ... 处理PostMapping、PutMapping等</span>
        }
    }
    
    <span class="hljs-keyword">return</span> ApiInfo.unknown();
}
</code></pre>
<p>这样就能从注解中提取出完整的API路径，比如<code>/api/users/123</code>。</p>
<hr/>
<h2 data-id="heading-17">四、设计模式的应用</h2>
<h3 data-id="heading-18">4.1 代理模式</h3>
<p>这是SQLInsight的核心。Java的动态代理基于接口，这和JDBC的设计天然契合：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[业务代码] --&gt;|调用接口| B[代理对象]
    B --&gt;|拦截处理| C[收集SQL信息]
    B --&gt;|转发调用| D[真实对象]
    D --&gt;|执行SQL| E[数据库]
    C -.-&gt;|异步| F[日志输出]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style E fill:#f5e1ff
    style F fill:#fff4e1
</code></pre>
<p><strong>代理模式的好处</strong>：</p>
<ul>
<li>对业务代码透明</li>
<li>可以在不修改原有代码的情况下增加功能</li>
<li>符合开闭原则（对扩展开放，对修改关闭）</li>
</ul>
<h3 data-id="heading-19">4.2 观察者模式</h3>
<p>SQL执行信息收集后，可能有多种处理方式：输出到控制台、写入日志文件、持久化到数据库、发送到监控系统等。</p>
<p>SQLInsight用观察者模式来处理这个问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlExecutionHandler</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SqlExecution execution)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleSqlExecutionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlExecutionHandler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SqlExecution execution)</span> {
        System.out.println(formatSqlLog(execution));
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingSqlExecutionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlExecutionHandler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SqlExecution execution)</span> {
        logger.info(formatSqlLog(execution));
    }
}
</code></pre>
<p>这样可以灵活组合不同的处理器，满足不同场景的需求。</p>
<h3 data-id="heading-20">4.3 工厂模式</h3>
<p>DataSourceProxy的创建使用了工厂模式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSource <span class="hljs-title function_">create</span><span class="hljs-params">(DataSource target, 
                                 SqlExecutionCollector collector, 
                                 SqlExecutionHandler handler)</span> {
    <span class="hljs-keyword">return</span> (DataSource) Proxy.newProxyInstance(
        DataSource.class.getClassLoader(),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[] { DataSource.class },
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceProxy</span>(target, collector, handler)
    );
}
</code></pre>
<p><strong>为什么要用工厂模式？</strong></p>
<p>动态代理的创建比较复杂，涉及类加载器、接口数组等参数。通过工厂方法封装这些细节，让使用者更方便。</p>
<hr/>
<h2 data-id="heading-21">五、兼容性设计</h2>
<h3 data-id="heading-22">5.1 与Druid的兼容</h3>
<p>Druid是阿里开源的数据库连接池，自带监控功能。SQLInsight和Druid可以无缝配合：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[应用程序] --&gt; B[SQLInsight代理]
    B --&gt; C[Druid连接池]
    C --&gt; D[MySQL驱动]
    
    B -.-&gt;|收集| E[SQL执行信息]
    C -.-&gt;|收集| F[连接池监控]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style E fill:#f5e1ff
    style F fill:#fff4e1
</code></pre>
<p><strong>为什么能兼容？</strong></p>
<p>SQLInsight代理的是标准JDBC接口，不关心底层实现。Druid连接池也实现了JDBC接口，所以可以直接代理。</p>
<p>两者的监控数据是互补的：</p>
<ul>
<li>Druid监控：连接池状态、连接获取耗时、SQL执行统计</li>
<li>SQLInsight监控：SQL与API的关联、完整调用链、慢SQL检测</li>
</ul>
<h3 data-id="heading-23">5.2 与Seata的兼容</h3>
<p>Seata也会代理DataSource，这就涉及到<strong>代理链的顺序问题</strong>。</p>
<p>理想的顺序是：<code>应用程序 → Seata → SQLInsight → 连接池</code></p>
<p>为什么？因为Seata需要在最外层控制事务，SQLInsight只做监控，应该在内层。</p>
<p>如何保证顺序？通过调整<code>BeanPostProcessor</code>的优先级：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> SqlInsightDataSourceBeanPostProcessor <span class="hljs-title function_">processor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">SqlInsightDataSourceBeanPostProcessor</span> <span class="hljs-variable">processor</span> <span class="hljs-operator">=</span> 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlInsightDataSourceBeanPostProcessor</span>(collector, handler);
    processor.setOrder(Ordered.LOWEST_PRECEDENCE);  <span class="hljs-comment">// 设置最低优先级</span>
    <span class="hljs-keyword">return</span> processor;
}
</code></pre>
<p>这样Seata会先执行，SQLInsight后执行，代理顺序就对了。</p>
<hr/>
<h2 data-id="heading-24">六、性能优化策略</h2>
<h3 data-id="heading-25">6.1 缓存Controller信息</h3>
<p>第一次解析Controller信息后，缓存起来：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, ApiInfo&gt; controllerCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApiInfo <span class="hljs-title function_">extractApiInfo</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 先查缓存</span>
    <span class="hljs-keyword">if</span> (controllerCache.containsKey(className)) {
        <span class="hljs-keyword">return</span> controllerCache.get(className);
    }
    <span class="hljs-comment">// 解析并缓存</span>
    <span class="hljs-type">ApiInfo</span> <span class="hljs-variable">apiInfo</span> <span class="hljs-operator">=</span> parseApiInfo(clazz, methodName);
    controllerCache.put(className, apiInfo);
    <span class="hljs-keyword">return</span> apiInfo;
}
</code></pre>
<p><strong>效果</strong>：首次解析约50微秒，缓存命中后小于1微秒。</p>
<h3 data-id="heading-26">6.2 异步处理</h3>
<p>SQL执行信息的处理（输出日志、持久化等）是异步的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SqlExecution execution)</span> {
    executor.submit(() -&gt; {
        <span class="hljs-comment">// 处理SQL执行信息</span>
        persistence.save(execution);
        logger.info(formatSqlLog(execution));
    });
}
</code></pre>
<p>这样不会阻塞业务SQL的执行。</p>
<h3 data-id="heading-27">6.3 限制StackTrace扫描深度</h3>
<p>只扫描前50层调用栈：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">maxDepth</span> <span class="hljs-operator">=</span> Math.min(stack.length, <span class="hljs-number">50</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxDepth; i++) {
    <span class="hljs-comment">// 扫描栈帧</span>
}
</code></pre>
<p>实际测试中，Controller一般在前10层就能找到，50层已经足够了。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[SQL执行] --&gt; B{读取栈深度}
    B --&gt;|深度&lt;=50| C[扫描栈帧]
    B --&gt;|深度&gt;50| D[只扫描前50层]
    C --&gt; E[查找Controller]
    D --&gt; E
    E --&gt; F{找到了?}
    F --&gt;|是| G[返回API信息]
    F --&gt;|否| H[返回Unknown]
    
    style A fill:#e1f5ff
    style C fill:#e1ffe1
    style E fill:#fff4e1
    style G fill:#ffe1f5
</code></pre>
<hr/>
<h2 data-id="heading-28">七、核心代码剖析</h2>
<h3 data-id="heading-29">7.1 PreparedStatementProxy的精妙之处</h3>
<p>这是整个项目最核心的一段代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PreparedStatement target;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sql;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Object&gt; parameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
        
        <span class="hljs-comment">// 拦截参数设置方法</span>
        <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"set"</span>) &amp;&amp; args.length &gt;= <span class="hljs-number">2</span>) {
            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) args[<span class="hljs-number">0</span>];
            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];
            
            <span class="hljs-comment">// 扩展参数列表</span>
            <span class="hljs-keyword">while</span> (parameters.size() &lt; index) {
                parameters.add(<span class="hljs-literal">null</span>);
            }
            parameters.set(index - <span class="hljs-number">1</span>, value);  <span class="hljs-comment">// JDBC参数索引从1开始</span>
            
            <span class="hljs-keyword">return</span> method.invoke(target, args);
        }
        
        <span class="hljs-comment">// 拦截执行方法</span>
        <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"execute"</span>)) {
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
            
            <span class="hljs-comment">// 收集SQL执行信息</span>
            collectSqlExecution(sql, parameters, duration);
            
            <span class="hljs-keyword">return</span> result;
        }
        
        <span class="hljs-comment">// 其他方法直接转发</span>
        <span class="hljs-keyword">return</span> method.invoke(target, args);
    }
}
</code></pre>
<p><strong>这段代码的精妙之处</strong>：</p>
<ol>
<li>
<p><strong>拦截参数设置</strong>：PreparedStatement的参数是通过<code>setXxx(index, value)</code>方法设置的，而且索引从1开始（JDBC规范）。代码中用<code>parameters.set(index - 1, value)</code>处理了这个细节。</p>
</li>
<li>
<p><strong>动态扩展参数列表</strong>：参数可能不是按顺序设置的，比如先设置第3个参数，再设置第1个参数。代码用<code>while</code>循环动态扩展列表，保证不会越界。</p>
</li>
<li>
<p><strong>精确测量执行时间</strong>：在<code>invoke</code>方法里包裹真实的SQL执行，前后记录时间戳，得到精确的执行耗时。</p>
</li>
<li>
<p><strong>保持原有行为</strong>：所有拦截后，都要调用<code>method.invoke(target, args)</code>，确保原有功能不受影响。</p>
</li>
</ol>
<h3 data-id="heading-30">7.2 StackTrace分析的优雅实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApiInfo <span class="hljs-title function_">extractApiInfo</span><span class="hljs-params">()</span> {
    StackTraceElement[] stack = Thread.currentThread().getStackTrace();
    <span class="hljs-type">int</span> <span class="hljs-variable">maxDepth</span> <span class="hljs-operator">=</span> Math.min(stack.length, <span class="hljs-number">50</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; maxDepth; i++) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> stack[i].getClassName();
            
            <span class="hljs-comment">// 缓存命中</span>
            <span class="hljs-keyword">if</span> (controllerCache.containsKey(className)) {
                <span class="hljs-keyword">return</span> controllerCache.get(className);
            }
            
            <span class="hljs-comment">// 加载类并检查注解</span>
            Class&lt;?&gt; clazz = Class.forName(className);
            <span class="hljs-keyword">if</span> (isController(clazz)) {
                <span class="hljs-type">ApiInfo</span> <span class="hljs-variable">apiInfo</span> <span class="hljs-operator">=</span> parseApiInfo(clazz, stack[i].getMethodName());
                controllerCache.put(className, apiInfo);
                <span class="hljs-keyword">return</span> apiInfo;
            }
        } <span class="hljs-keyword">catch</span> (ClassNotFoundException e) {
            <span class="hljs-comment">// 忽略，继续扫描下一层</span>
        }
    }
    
    <span class="hljs-keyword">return</span> ApiInfo.unknown();
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isController</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> {
    <span class="hljs-keyword">return</span> clazz.isAnnotationPresent(RestController.class) || 
           clazz.isAnnotationPresent(Controller.class);
}
</code></pre>
<p><strong>这段代码的优雅之处</strong>：</p>
<ol>
<li>
<p><strong>异常处理得当</strong>：<code>Class.forName()</code>可能抛出<code>ClassNotFoundException</code>，但这不是错误，只是说明这个类不在当前ClassLoader里。代码用<code>try-catch</code>优雅地处理了这个问题。</p>
</li>
<li>
<p><strong>提前返回</strong>：一旦找到Controller，立即返回，不再继续扫描。这是性能优化的关键。</p>
</li>
<li>
<p><strong>缓存策略</strong>：用类名作为key缓存，而不是用完整的ApiInfo。这样即使方法不同，类名相同也能命中缓存。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-31">八、设计思想的升华</h2>
<p>做完这个项目后，我有一些更深层次的思考。</p>
<h3 data-id="heading-32">8.1 最少知识原则</h3>
<p>SQLInsight遵循了"最少知识原则"（Law of Demeter）。它只和JDBC接口打交道，不关心：</p>
<ul>
<li>你用的是什么ORM框架</li>
<li>你的连接池是什么</li>
<li>你的数据库是MySQL还是PostgreSQL</li>
</ul>
<p><strong>这个原则的好处</strong>：</p>
<ul>
<li>降低耦合</li>
<li>提高适应性</li>
<li>减少维护成本</li>
</ul>
<p>在设计系统时，我们应该尽量依赖抽象（接口），而不是具体实现。JDBC是一个很好的抽象层。</p>
<h3 data-id="heading-33">8.2 分层架构的威力</h3>
<p>JDBC的分层设计（DataSource → Connection → Statement）为代理提供了天然的切入点。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[业务层&lt;br/&gt;MyBatis/JPA] --&gt; B[JDBC抽象层&lt;br/&gt;标准接口]
    B --&gt; C[驱动实现层&lt;br/&gt;MySQL/Oracle驱动]
    
    D[SQLInsight] -.-&gt;|代理| B
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
</code></pre>
<p><strong>分层架构的好处</strong>：</p>
<ul>
<li>每一层都有明确的职责</li>
<li>层与层之间通过接口通信</li>
<li>可以在任何一层插入新功能（如监控、事务控制）</li>
</ul>
<p>这启发我们：在设计系统时，合理的分层能带来极大的扩展性。</p>
<h3 data-id="heading-34">8.3 组合优于继承</h3>
<p>SQLInsight没有通过继承来扩展功能，而是通过组合：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource target;  <span class="hljs-comment">// 组合原始DataSource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlExecutionCollector collector;  <span class="hljs-comment">// 组合收集器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlExecutionHandler handler;  <span class="hljs-comment">// 组合处理器</span>
}
</code></pre>
<p><strong>为什么组合优于继承？</strong></p>
<ol>
<li><strong>灵活性</strong>：可以动态替换组件（比如换一个不同的handler）</li>
<li><strong>低耦合</strong>：各个组件可以独立演化</li>
<li><strong>可测试</strong>：可以单独测试每个组件</li>
</ol>
<p>这是设计模式中的经典原则，值得反复体会。</p>
<h3 data-id="heading-35">8.4 开闭原则的实践</h3>
<p>SQLInsight对扩展开放，对修改关闭：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlExecutionHandler</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SqlExecution execution)</span>;
}

<span class="hljs-comment">// 新增一个handler，不需要修改核心代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlExecutionHandler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SqlExecution execution)</span> {
        <span class="hljs-comment">// 自定义处理逻辑</span>
    }
}
</code></pre>
<p>想增加新功能？实现一个新的Handler就行了，不需要改动核心代码。</p>
<p><strong>这给我们的启示</strong>：</p>
<ul>
<li>设计接口时要想清楚扩展点在哪里</li>
<li>核心逻辑要稳定，扩展逻辑要灵活</li>
<li>通过接口和抽象隔离变化</li>
</ul>
<h3 data-id="heading-36">8.5 性能与功能的平衡</h3>
<p>SQLInsight面临一个矛盾：</p>
<ul>
<li><strong>功能需求</strong>：需要扫描StackTrace，解析注解，收集信息</li>
<li><strong>性能需求</strong>：不能影响业务SQL的执行速度</li>
</ul>
<p>解决方案是：</p>
<ol>
<li><strong>缓存</strong>：减少重复计算</li>
<li><strong>异步</strong>：把耗时操作移到后台</li>
<li><strong>限制</strong>：限制扫描深度，避免极端情况</li>
</ol>
<p><strong>这个平衡的启示</strong>：</p>
<ul>
<li>性能优化不是无限制的，要找到合适的度</li>
<li>用空间换时间（缓存）</li>
<li>用异步换同步（后台处理）</li>
<li>设置合理的边界（扫描深度限制）</li>
</ul>
<hr/>
<h2 data-id="heading-37">九、使用示例</h2>
<blockquote>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsql-insight" target="_blank" title="https://gitee.com/sh_wangwanbao/sql-insight" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a><br/>
完整的示例代码在<code>examples</code>模块中，可以直接运行查看效果。</p>
</blockquote>
<h3 data-id="heading-38">9.1 引入依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.surfing<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sqlinsight-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-39">9.2 配置（可选）</h3>
<pre><code class="hljs language-properties" lang="properties"># 启用SQLInsight（默认true）
sqlinsight.enabled=true

# 慢SQL阈值（默认1000ms）
sqlinsight.slow-sql-threshold=50

# N+1查询检测阈值（默认10）
sqlinsight.n-plus-one-threshold=10
</code></pre>
<h3 data-id="heading-40">9.3 输出示例</h3>
<pre><code class="hljs language-sql" lang="sql">[<span class="hljs-keyword">SQL</span><span class="hljs-operator">-</span>Insight] <span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>users<span class="hljs-operator">/</span><span class="hljs-number">123</span> → UserController.findById
   <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span> (<span class="hljs-number">15</span>ms) [Type: <span class="hljs-keyword">SELECT</span>]

[<span class="hljs-keyword">SQL</span><span class="hljs-operator">-</span>Insight] <span class="hljs-keyword">GET</span> <span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>users<span class="hljs-operator">/</span>orders → UserController.getUserOrders
   [SLOW] <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> u.<span class="hljs-operator">*</span>, o.<span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users u <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> u.id <span class="hljs-operator">=</span> o.user_id (<span class="hljs-number">56</span>ms) [Type: <span class="hljs-keyword">SELECT</span>]
</code></pre>
<hr/>
<h2 data-id="heading-41">十、总结与展望</h2>
<h3 data-id="heading-42">10.1 技术总结</h3>
<p>SQLInsight通过三个核心技术实现了零侵入的SQL监控：</p>
<ol>
<li><strong>动态代理</strong>：在JDBC层拦截SQL执行（学习自Seata）</li>
<li><strong>StackTrace分析</strong>：自动追踪API调用链（学习自MyBatis）</li>
<li><strong>BeanPostProcessor</strong>：自动代理DataSource（Spring的扩展机制）</li>
</ol>
<p>这三个技术的组合，实现了：</p>
<ul>
<li>零配置集成</li>
<li>透明监控</li>
<li>完整的调用链追踪</li>
<li>良好的兼容性</li>
</ul>
<h3 data-id="heading-43">10.2 设计原则的践行</h3>
<p>项目体现了多个经典设计原则：</p>
<ul>
<li><strong>单一职责</strong>：每个类只做一件事</li>
<li><strong>开闭原则</strong>：对扩展开放，对修改关闭</li>
<li><strong>依赖倒置</strong>：依赖抽象（JDBC接口），不依赖具体实现</li>
<li><strong>最少知识</strong>：只和JDBC接口打交道</li>
<li><strong>组合优于继承</strong>：用组合构建功能</li>
</ul>
<h3 data-id="heading-44">10.3 未来展望</h3>
<p>SQLInsight还有很多可以优化的地方：</p>
<ol>
<li><strong>N+1查询检测</strong>：自动识别循环查询问题</li>
<li><strong>Web控制台</strong>：提供可视化的监控界面</li>
<li><strong>智能建议</strong>：根据SQL执行情况给出优化建议</li>
<li><strong>分布式追踪</strong>：集成OpenTelemetry，支持分布式链路追踪</li>
<li><strong>SQL审计</strong>：记录所有SQL操作，用于安全审计</li>
</ol>
<p>但核心思想不会变：<strong>在最底层做拦截，保持对业务代码的零侵入</strong>。</p>
<hr/>
<h2 data-id="heading-45">十一、写在最后</h2>
<p>做这个项目，最大的收获不是写了多少行代码，而是理解了<strong>设计思想的传承</strong>。</p>
<p>Seata的动态代理、MyBatis的StackTrace分析，这些都是前人智慧的结晶。我们站在巨人的肩膀上，把这些思想组合起来，创造出新的价值。</p>
<p>技术的本质不是炫技，而是解决问题。SQLInsight解决的问题很简单：让开发者知道每个API执行了哪些SQL，用了多长时间。但实现这个简单的目标，需要深入理解JDBC、动态代理、反射、线程栈等多个技术点。</p>
<p><strong>好的技术方案，应该是简单的。</strong></p>
<p>对使用者来说，只需要加一个依赖。对设计者来说，需要考虑性能、兼容性、扩展性、可维护性等多个维度。</p>
<p>这就是技术的魅力：表面简单，内在复杂；对外易用，对内精巧。</p>
<p>希望这篇文档能帮助你理解SQLInsight的设计思路，也希望这些设计思想能对你未来的项目有所启发。</p>
<hr/>
<h2 data-id="heading-46">十二、开发记录</h2>
<p>从想法到实现，花了小一周时间。</p>
<p>刚开始写代码的时候，遇到了不少坑：</p>
<ul>
<li>PreparedStatement的参数索引从1开始，而不是0（JDBC规范）</li>
<li>StackTrace扫描时要注意ClassNotFoundException</li>
<li>动态代理要完整实现接口的所有方法，不然会NPE</li>
<li>缓存策略要做好，不然性能会受影响</li>
</ul>
<p>调试的过程中，对JDBC标准、Java动态代理、反射机制有了更深的理解。看似简单的"拦截SQL执行"，背后涉及的技术点比想象中要多。</p>
<p>今天周末，终于把坑都填完了，代码也开源了。算是还了上周文章的债。</p>
<p>如果你在使用过程中遇到问题，或者有什么想法建议，欢迎提Issue或PR。</p>
<hr/>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsql-insight" target="_blank" title="https://gitee.com/sh_wangwanbao/sql-insight" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a><br/>
<strong>上一篇文章</strong>：<a href="https://juejin.cn/post/7591513171199295551" target="_blank" title="https://juejin.cn/post/7591513171199295551">SQLInsight：一行依赖，自动追踪API背后的每一条SQL</a><br/>
<strong>开源协议</strong>：MIT License<br/>
<strong>欢迎反馈</strong>：提Issue、PR，或者留言讨论</p>
<hr/>
<p><em>写代码的过程，也是学习的过程。希望SQLInsight能帮到你，也欢迎一起完善它。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第11章 LangChain]]></title>    <link>https://juejin.cn/post/7593258683750531106</link>    <guid>https://juejin.cn/post/7593258683750531106</guid>    <pubDate>2026-01-10T08:28:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593258683750531106" data-draft-id="7593262196843741236" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第11章 LangChain"/> <meta itemprop="keywords" content="LangChain,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-10T08:28:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XiaoYu2002"/> <meta itemprop="url" content="https://juejin.cn/user/251124329220663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第11章 LangChain
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/251124329220663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XiaoYu2002
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T08:28:33.000Z" title="Sat Jan 10 2026 08:28:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LangChain 是一个用于开发基于大语言模型（LLM）应用程序的开源框架，它通过提供模块化的抽象组件和链式调用工具，将 LLM 与外部数据源（如文档、数据库）和计算工具（如搜索引擎、代码解释器）智能连接，从而构建出具备记忆、推理和行动能力的增强型 AI 应用，典型场景包括智能问答、内容生成和智能体（Agent）系统。</p>
<p>LangChain官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2F%25E3%2580%2582%25E7%25BD%2591%25E5%259D%2580%25E7%259A%2584%25E7%25BB%2584%25E6%2588%2590%25E9%2580%25BB%25E8%25BE%2591%25E5%2592%258CNest.js%25E5%25AE%2598%25E6%2596%25B9%25E6%2596%2587%25E6%25A1%25A3%25E7%25B1%25BB%25E4%25BC%25BC%25EF%25BC%258C%25E5%258D%25B3docs.%25E5%2590%258D%25E7%25A7%25B0.com%25E3%2580%2582" target="_blank" title="https://docs.langchain.com/%E3%80%82%E7%BD%91%E5%9D%80%E7%9A%84%E7%BB%84%E6%88%90%E9%80%BB%E8%BE%91%E5%92%8CNest.js%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E7%B1%BB%E4%BC%BC%EF%BC%8C%E5%8D%B3docs.%E5%90%8D%E7%A7%B0.com%E3%80%82" ref="nofollow noopener noreferrer">docs.langchain.com/。网址的组成逻辑和Ne…</a></p>
<p>LangChain支持Python和TypeScript两种编程语言，如图11-1所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0decd565cb6f4105b0822cac46543c94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768638513&amp;x-signature=MHeeA5CYwSQTKaMV8bpJw4pEuJw%3D" alt="image-20251219041533100" loading="lazy"/></p>
<p align="center">
 <b> 图11-1 LangChain开源代理框架-语言选项</b>
</p>
<p>LangChain开源代理框架有3种选择方案：</p>
<p>（1）LangChain：一些普通对话，音频识别、文字生成，图片生成等等与AIGC相关的，用这选择方案就够了。</p>
<p>（2）LangGraph：想做工作流，类似Dify，Coze，那么就需要使用该方案。</p>
<p>（3）Deep Agents：想做一些大型的AI相关高级应用，就需要使用该方案，Deep Agents是深度集成的意思。</p>
<p>LangChain 作为基础框架，适合构建常规的AIGC应用（如对话、文生图）；LangGraph 专注于通过有状态、可循环的图结构来编排复杂、多步骤的智能体工作流，是开发类Dify/Coze平台或自动化业务流程的核心选择；而 Deep Agents 则代表了一种更深度集成、能处理高复杂度任务与自主决策的高级智能体架构，常用于需要多智能体协作或模拟人类工作流的大型企业级AI应用。</p>
<p>我们这里学习的话，使用第一个LangChain就完全够用。LangChain下载使用说明如图11-2所示。我们点击如图11-1所示的第一个选项后，会跳转到如图11-2所示的界面，需要点击左侧边栏的install选项。官方文档有对应的使用说明。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da1162df520b4c888fd7af9b16653f12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768638513&amp;x-signature=WHqI5tvJ5CV9ekFa4KAdTalfw%2FI%3D" alt="image-20251219042243761" loading="lazy"/></p>
<p align="center">
 <b> 图11-2 LangChain下载使用说明</b>
</p>
## 11.1 初始化项目
<p>接下来，我们要开始初始化这次的项目。会沿用第10章 SSE魔改的代码，在该基础上，需要补充以下安装步骤：</p>
<p>（1）@langchain/core：LangChain 的核心基础库，包含链、提示模板、检索器等核心抽象。</p>
<p>（2）@langchain/deepseek： LangChain 为DeepSeek 模型专门提供的集成包，让我们能在 LangChain 框架中直接调用 DeepSeek 的 API。安装规则是@langchain/所需AI大模型，例如@langchain/openai。</p>
<p>（3）langchain：LangChain 的主包，提供了高级、易于使用的接口来组合和使用 LLM。</p>
<p>安装LangChain之后，我们需要一个AI大模型来支持，在这次示例中，选择DeepSeek，因为它的API非常便宜。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 终端执行命令</span>
npm install <span class="hljs-meta">@langchain</span>/core <span class="hljs-meta">@langchain</span>/deepseek langchain
</code></pre>
<p>安装之后的package.json文件如下所示。</p>
<pre><code class="hljs language-ts" lang="ts">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"module"</span>,
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@langchain/core"</span>: <span class="hljs-string">"^1.1.6"</span>,
    <span class="hljs-string">"@langchain/deepseek"</span>: <span class="hljs-string">"^1.0.3"</span>,
    <span class="hljs-string">"@types/cors"</span>: <span class="hljs-string">"^2.8.19"</span>,
    <span class="hljs-string">"@types/express"</span>: <span class="hljs-string">"^5.0.6"</span>,
    <span class="hljs-string">"cors"</span>: <span class="hljs-string">"^2.8.5"</span>,
    <span class="hljs-string">"express"</span>: <span class="hljs-string">"^5.2.1"</span>,
    <span class="hljs-string">"langchain"</span>: <span class="hljs-string">"^1.2.1"</span>
  }
}
</code></pre>
<p>由于我们在7.1小节已经升级过Node.js版本，因此可以直接用Node.js去运行ts后缀文件，满足Node.js版本大于23的都可以这么做，如果无法运行ts后缀文件，需要检查一下Node.js版本或者采用ts-node。</p>
<p>接下来到index.ts文件中初始化后端服务。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// index.ts</span>
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'cors'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>())
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>())

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/chat'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; { })

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>)
})
</code></pre>
<h2 data-id="heading-0">11.2 接入大模型</h2>
<p>接着接入我们的AI大模型DeepSeek，还是在index.ts文件中。</p>
<p>在这里引入了一个key.ts文件，该文件存放着DeepSeek API的Key。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>
<span class="hljs-keyword">import</span> { key } <span class="hljs-keyword">from</span> <span class="hljs-string">'./key.ts'</span>
<span class="hljs-keyword">const</span> deepseek = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
    <span class="hljs-attr">apiKey</span>: key,
    <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
    <span class="hljs-attr">temperature</span>: <span class="hljs-number">1.3</span>,
    <span class="hljs-attr">maxTokens</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">//500-600个汉字</span>
    <span class="hljs-attr">topP</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">//设得越小，AI 说话越"死板"；设得越大，AI 说话越"放飞自我"</span>
    <span class="hljs-attr">frequencyPenalty</span>: <span class="hljs-number">0</span>,<span class="hljs-comment">//防复读机诉 AI："你别老重复同一个词！"-2   2</span>
    <span class="hljs-attr">presencePenalty</span>: <span class="hljs-number">0</span>,<span class="hljs-comment">//鼓励换话题告诉 AI："别老聊同一件事！" -2   2</span>
})
</code></pre>
<p>获取DeepSeek的key，如下4步骤：</p>
<p>（1）打开DeepSeek的API开放平台：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">platform.deepseek.com/</a>。</p>
<p>（2）微信扫码登录，去实名认证。</p>
<p>（3）点击左侧边栏的用量信息选择去充值选项，有在线充值和对公汇款两个选项，选择在线充值，自定义输入1块钱（够用了），然后自己选择支付宝或者微信支付去付款。</p>
<p>（4）付款成功后，点击左侧边栏的API keys选项，创建API key，随便输入一个名称（中英文都可以），然后会弹出key值，此时复制key值再关闭弹窗，因为当你关闭后，就再也拿不到这个key值了。忘记就只能重新再建一个，DeepSeek会提醒你的，如图11-3所示。</p>
<p>友情提示：保护好你的key值，别暴露在公网中，在开源项目上传GitHub中，可以让git忽略key.ts文件。或者如果你的DeepSeek API就只充了1块钱，然后用得剩几毛钱，并且以后都不怎么打算充，那想不想保护key值，就看你心情了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9013c784c7f24b3ba730495b375da82d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768638513&amp;x-signature=SkefVPDl8t1SPeYGB%2B9tEUCcaQc%3D" alt="image.png" loading="lazy"/></p>
<p align="center">
 <b> 图11-3 创建API key注意事项</b>
</p>
<p>通过以上步骤获取到DeepSeek的key值后，在项目创建key.ts文件，创建常量key，填入你的key值并导出。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> key = <span class="hljs-string">'你DeepSeek的key值'</span>
</code></pre>
<p>回到index.ts文件，接入DeepSeek大模型之后，ChatDeepSeek有一个model字段，这是用于选择我们模型的。已有的模型类型需要从DeepSeek官方文档中获取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2Fquick_start%2Fpricing" target="_blank" title="https://api-docs.deepseek.com/zh-cn/quick_start/pricing" ref="nofollow noopener noreferrer">模型 &amp; 价格 | DeepSeek API Docs</a>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// DeepSeek字段</span>
<span class="hljs-attr">apiKey</span>: key,
<span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
<span class="hljs-attr">temperature</span>: <span class="hljs-number">1.3</span>,
<span class="hljs-attr">maxTokens</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 500-600个汉字</span>
<span class="hljs-attr">topP</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 设得越小，AI 说话越"死板"；设得越大，AI 说话越"放飞自我"</span>
<span class="hljs-attr">frequencyPenalty</span>: <span class="hljs-number">0</span>,<span class="hljs-comment">// 防复读机诉 AI："你别老重复同一个词！"-2   2</span>
<span class="hljs-attr">presencePenalty</span>: <span class="hljs-number">0</span>,<span class="hljs-comment">// 鼓励换话题告诉 AI："别老聊同一件事！" -2   2</span>
</code></pre>
<p>目前可选的模型有deepseek-chat和deepseek-reasoner。DeepSeek官网价格计算是以百万Token为单位，其中1 个英文字符 ≈ 0.3 个 token；1 个中文字符 ≈ 0.6 个 token。只要大概知道很便宜就足够了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4333a60653334151b832d8eaa7663532~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768638513&amp;x-signature=rzQmAfUQ5NHRpYaM98NeratuXwI%3D" alt="image-20251219050542592" loading="lazy"/></p>
<p align="center">
 <b> 图11-4 DeepSeek模型选择</b>
</p>
<p>temperature字段是温度的含义，在DeepSeek官方文档中有直接给出对应的建议，我们的示例是打算用于对话，因此设置1.3就足够了，Temperature参数设置如图11-5所示。</p>
<p>从应用场景，我们可以理解为temperature字段大概是理性与感性的权衡度，逻辑性越强的场景，温度越低；越感性的场景温度越高。所有AI大模型都是类似的，从他们对应的官方文档去获取对应信息就可以了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38c09d7f2ecf4117a23169fbd1cdf885~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768638513&amp;x-signature=iwwwFnK%2B2IIhQ0IWhjm8v3nZhJ4%3D" alt="image-20251219050952588" loading="lazy"/></p>
<p align="center">
 <b> 图11-5 DeepSeek模型-Temperature参数设置</b>
</p>
<p>其余4个参数maxTokens、topP，frequencyPenalty和presencePenalty如下：</p>
<p>（1）maxTokens 直接决定了 AI 回复的最大长度，限制了单次响应的文本量；</p>
<p>（2）topP（核采样参数）通过控制候选词的概率分布来影响文本的创造性与稳定性——值越低则 AI 的选词越集中和可预测，输出趋于“死板”，值越高则选词范围越宽，输出越“放飞自我”并富有创意。</p>
<p>（3）而 frequencyPenalty 与 presencePenalty 则分别从词频和话题层面抑制重复：frequencyPenalty 正值会惩罚在当前回复中已经频繁出现的词语，促使用词更加多样；presencePenalty 正值则会惩罚在已生成的上下文中出现过的所有主题，鼓励 AI 主动切换到新的话题或角度，从而共同确保生成内容的多样性和连贯性，避免陷入单调或循环重复的表达。</p>
<p>这些值具体设置多少，则需要根据具体场景的经验以及自身的理解，推荐看我写的AI使用手册，开头有讲解到这一部分注意力机制：<a href="https://juejin.cn/post/7564351324860612623" target="_blank" title="https://juejin.cn/post/7564351324860612623">AI精准提问手册：从模糊需求到精准输出的核心技能（上）</a>。</p>
<h2 data-id="heading-1">11.3 AI对话</h2>
<p>接下来需要从langchain引入createAgent方法，并使用我们设置好的deepseek实例对象。我们调用agent身上的invoke()方法，该方法更适合单次输出（一次性直接返回），即非流式返回。</p>
<p>通过createAgent方法除了可以设置接入的大模型，还可以通过systemPrompt字段去设置Prompt提示词。</p>
<p>通过LangChain代理的stream()方法调用DeepSeek模型处理用户请求：将客户端发送的req.body.message作为用户消息输入，并设置streamMode为 "messages" 来获取结构化的消息流响应；在等待代理完成流式生成后，将整个结果集作为JSON数据一次性返回给客户端。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'cors'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>
<span class="hljs-keyword">import</span> { key } <span class="hljs-keyword">from</span> <span class="hljs-string">'./key.ts'</span>
<span class="hljs-keyword">import</span> { createAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'langchain'</span>
<span class="hljs-keyword">const</span> deepseek = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">apiKey</span>: key,
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">1.3</span>,
  <span class="hljs-attr">maxTokens</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 500-600个汉字</span>
  <span class="hljs-attr">topP</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 设得越小，AI 说话越"死板"；设得越大，AI 说话越"放飞自我"</span>
  <span class="hljs-attr">frequencyPenalty</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 防复读机诉 AI："你别老重复同一个词！"-2   2</span>
  <span class="hljs-attr">presencePenalty</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 鼓励换话题告诉 AI："别老聊同一件事！" -2   2</span>
})

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>())
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>())

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/chat'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/json'</span>)
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'no-cache'</span>)
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Connection'</span>, <span class="hljs-string">'keep-alive'</span>)
  <span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">model</span>: deepseek,
    <span class="hljs-attr">systemPrompt</span>: <span class="hljs-string">`你是一个聊天机器人，请根据用户的问题给出回答。`</span>,
  })
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">invoke</span>({
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: req.<span class="hljs-property">body</span>.<span class="hljs-property">message</span>,
      }
    ]
  })
  res.<span class="hljs-title function_">json</span>(result)
})

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>)
})
</code></pre>
<p>接下来回到index.html文件一下，我们需要设置客户端返回给后端的问题，也就是往req.body.message里塞一下咨询AI的问题。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;script&gt;
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://localhost:3000/api/chat'</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
        },
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请问你是什么AI大模型'</span> })
    }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> res=&gt;{
        <span class="hljs-keyword">const</span> reader = res.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>()
        <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>()
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>()
            <span class="hljs-keyword">if</span> (done) {
                <span class="hljs-keyword">break</span>
            }
            <span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> })
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(text)
        }
    })
&lt;/script&gt;
</code></pre>
<p>我们问了一个：“你是什么AI大模型”的问题，浏览器返回AI对话信息如图11-6所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca0955ecf9f7418996b77394d468b9bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768638513&amp;x-signature=21sxFKXTPK1IbJPurp0xo8FOtVw%3D" alt="image-20251219054656481" loading="lazy"/></p>
<p align="center">
 <b> 图11-6 DeepSeek模型-Temperature参数设置</b>
</p>
<p>到这为止，我们就正式打通了AI对话的环节。并且如果我们打开网络选项卡，可以发现AI对话返回的内容是post请求的。如果我们想改成流式输出也是post请求，在第10.3小节所学习的SSE设置post请求就可以用上了。</p>
<h2 data-id="heading-2">11.4 流式输出AI对话</h2>
<p>如果我们想修改成流式输出对话的话，需要修改3个地方：</p>
<p>（1）后端设置的Content-Type类型改成事件流类型。</p>
<p>（2）agent不使用invoke()方法，该换专门的agent.stream()流输出方法，并调整对应参数。</p>
<p>（3）agent.stream()流输出方法返回迭代器，针对迭代器去调整输出形式。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'cors'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>
<span class="hljs-keyword">import</span> { key } <span class="hljs-keyword">from</span> <span class="hljs-string">'./key.ts'</span>
<span class="hljs-keyword">import</span> { createAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'langchain'</span>
<span class="hljs-keyword">const</span> deepseek = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">apiKey</span>: key,
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">1.3</span>,
  <span class="hljs-attr">maxTokens</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 500-600个汉字</span>
  <span class="hljs-attr">topP</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 设得越小，AI 说话越"死板"；设得越大，AI 说话越"放飞自我"</span>
  <span class="hljs-attr">frequencyPenalty</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 防复读机诉 AI："你别老重复同一个词！"-2   2</span>
  <span class="hljs-attr">presencePenalty</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 鼓励换话题告诉 AI："别老聊同一件事！" -2   2</span>
})

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>())
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>())

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/chat'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/event-stream'</span>)
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'no-cache'</span>)
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Connection'</span>, <span class="hljs-string">'keep-alive'</span>)
  <span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">model</span>: deepseek,
    <span class="hljs-attr">systemPrompt</span>: <span class="hljs-string">`你是一个聊天机器人，请根据用户的问题给出回答。`</span>,
  })
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">stream</span>({
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: req.<span class="hljs-property">body</span>.<span class="hljs-property">message</span>,
      }
    ]
  }, { <span class="hljs-attr">streamMode</span>: <span class="hljs-string">"messages"</span> })
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> result) {
    res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(chunk)}</span>\n\n`</span>)
  }
  res.<span class="hljs-title function_">end</span>()
})

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>)
})
</code></pre>
<p>agent.stream()方法有第二个参数，用于指定流式输出的数据格式和粒度，决定了从流中接收到的是原始令牌、结构化消息还是其他中间结果。agent.stream()方法第二个参数的选项如表11-1所示。我们选择messages就可以了。如果想要真正存粹的打字效果并且节约token，可以使用values选项。</p>
<p align="center">
 <b> 表11-1 agent.stream()方法第二个参数的选项</b>
</p>





























<table><thead><tr><th align="left">流模式</th><th align="left">返回的数据类型</th><th align="left">典型用途</th><th align="left">示例输出（逐块）</th></tr></thead><tbody><tr><td align="left">"messages"</td><td align="left">完整的消息对象</td><td align="left">需要处理结构化对话（如获取AI回复的完整消息）</td><td align="left">{"role": "assistant", "content": "你好"}</td></tr><tr><td align="left">"values"</td><td align="left">底层值（如原始token）</td><td align="left">需要实现逐字打印效果或最低级控制</td><td align="left">"你" "好"</td></tr><tr><td align="left">"stream"</td><td align="left">混合事件流</td><td align="left">需要同时获取token和消息等多样信息</td><td align="left">{"type": "token", "value": "你"}</td></tr></tbody></table>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">stream</span>({
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: req.<span class="hljs-property">body</span>.<span class="hljs-property">message</span>,
      }
    ]
  }, { <span class="hljs-attr">streamMode</span>: <span class="hljs-string">"values"</span> })
</code></pre>
<p>其次，由于agent.stream()方法的返回值类型是<code>IterableReadableStream&lt;StreamMessageOutput&gt;</code>，说明返回值就是一个迭代器。因此可以使用for await of语法糖来流式输出内容，不用手动的去调用迭代器的next()方法。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> result) {
    res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(chunk)}</span>\n\n`</span>)
  }
  res.<span class="hljs-title function_">end</span>()
</code></pre>
<p>AI对话-流式输出如图11-7所示。会按顺序返回非常多的JSON格式数据，通过data字段下的kwargs的content可以看到AI返回内容以三两字的形式不断输出。并且在前端的接收流式输出，不会因post请求而出现问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/442cefcfac0e47ddb0813b0ab60cb020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768638513&amp;x-signature=%2FjSGLU6k0c5VBn3oQ%2B9%2F1esXxMM%3D" alt="image-20251219060557208" loading="lazy"/></p>
<p align="center">
 <b> 图11-7 AI对话-流式输出</b>
</p>
<p>流式输出AI对话的完整代码如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// index.ts</span>
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> cors <span class="hljs-keyword">from</span> <span class="hljs-string">'cors'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>
<span class="hljs-keyword">import</span> { key } <span class="hljs-keyword">from</span> <span class="hljs-string">'./key.ts'</span>
<span class="hljs-keyword">import</span> { createAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'langchain'</span>
<span class="hljs-keyword">const</span> deepseek = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">apiKey</span>: key,
  <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">1.3</span>,
  <span class="hljs-attr">maxTokens</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 500-600个汉字</span>
  <span class="hljs-attr">topP</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 设得越小，AI 说话越"死板"；设得越大，AI 说话越"放飞自我"</span>
  <span class="hljs-attr">frequencyPenalty</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 防复读机诉 AI："你别老重复同一个词！"-2   2</span>
  <span class="hljs-attr">presencePenalty</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 鼓励换话题告诉 AI："别老聊同一件事！" -2   2</span>
})

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>())
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>())

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/chat'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'application/event-stream'</span>)
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'no-cache'</span>)
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Connection'</span>, <span class="hljs-string">'keep-alive'</span>)
  <span class="hljs-keyword">const</span> agent = <span class="hljs-title function_">createAgent</span>({
    <span class="hljs-attr">model</span>: deepseek,
    <span class="hljs-attr">systemPrompt</span>: <span class="hljs-string">`你是一个聊天机器人，请根据用户的问题给出回答。`</span>,
  })
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">stream</span>({
    <span class="hljs-attr">messages</span>: [
      {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: req.<span class="hljs-property">body</span>.<span class="hljs-property">message</span>,
      }
    ]
  }, { <span class="hljs-attr">streamMode</span>: <span class="hljs-string">"messages"</span> })
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> result) {
    res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(chunk)}</span>\n\n`</span>)
  }
  res.<span class="hljs-title function_">end</span>()
})

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>)
})
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// index.html</span>
&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;script&gt;
    fetch('http://localhost:3000/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ message: '请问你是什么AI大模型' })
    }).then(async res =&gt; {
      const reader = res.body.getReader()
      const decoder = new TextDecoder()
      while (true) {
        const { done, value } = await reader.read()
        if (done) {
          break
        }
        const text = decoder.decode(value, { stream: true })
        console.log(text)
      }
    })
  &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<p>以上就是使用LangChain接入DeepSeek大模型并实现AI对话和基础提示词的案例。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[推荐几个国外比较流行的UI库（上）]]></title>    <link>https://juejin.cn/post/7593198957984301097</link>    <guid>https://juejin.cn/post/7593198957984301097</guid>    <pubDate>2026-01-10T06:45:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593198957984301097" data-draft-id="7593198957984038953" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="推荐几个国外比较流行的UI库（上）"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-10T06:45:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我的写法有点潮"/> <meta itemprop="url" content="https://juejin.cn/user/1643143620204234"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            推荐几个国外比较流行的UI库（上）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1643143620204234/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我的写法有点潮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T06:45:42.000Z" title="Sat Jan 10 2026 06:45:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、Tailwind CSS</h2>
<p>现在写样式的时候，我基本已经离不开 Tailwind CSS 了。最开始接触它的时候，其实挺不适应的，感觉类名又多又杂，全写在标签上。但真正用顺了之后，反而不太想回到以前那种来回切 CSS 文件的方式。</p>
<p>我比较喜欢的是它处理响应式的方式，断点直接写在类名前面，逻辑非常直观。页面在不同尺寸下怎么变，一眼就能看出来。再加上配置文件可以统一管颜色、间距、字体这些东西，对我来说维护起来反而更轻松。</p>
<p>缺点当然也有，比如结构看起来不那么“干净”，但这个在我这里已经不算什么问题了。</p>
<p><strong>下面我们来实现一个瀑布流</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"columns-3 ..."</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-3/2 ..."</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/mountains-1.jpg"</span> /&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-square ..."</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/mountains-2.jpg"</span> /&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-square ..."</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/mountains-3.jpg"</span> /&gt;</span> 
    <span class="hljs-comment">&lt;!-- ... --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>效果</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89fafbbaf8c14ba684aad39db134b1a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qE5YaZ5rOV5pyJ54K55r2u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634370&amp;x-signature=WtiWy51sP0B4zRCH1sf%2FIBv%2B7zs%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">2、Bootstrap</h2>
<p>虽然 Bootstrap 已经很多年了，但说实话，在一些需求明确、节奏比较快的项目里，它依然很好用。栅格、常见组件基本都有，直接拼就能出页面，几乎不用想太多。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b904d7f72ea4f6f8506bc351c91832c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qE5YaZ5rOV5pyJ54K55r2u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634370&amp;x-signature=KKiVIweFIrVwz%2FgNB8zg2urAs4w%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">3、Foundation</h2>
<p>Foundation 是一个开源的响应式前端框架，用于构建结构清晰、视觉一致的网页界面。它提供了完整的工具体系，包括响应式网格系统、设计模板，以及基于 HTML、CSS 和 SASS 的样式方案。同时，框架内置了按钮、导航、表单、排版等常见 UI 能力，并支持通过 JavaScript 扩展进一步增强交互功能。</p>
<p>Foundation 采用移动优先的设计理念，与 Bootstrap 类似，布局从小屏设备开始构建，再逐步扩展到更大的屏幕尺寸。这种方式使页面能够自然适配不同设备，无需额外处理复杂的适配逻辑，从而在手机、平板和桌面端之间保持一致且流畅的体验。</p>
<p>在布局层面，Foundation 提供了基于 Flexbox 的 12 列响应式网格系统。页面结构可以通过行与列的组合快速搭建，而网格系统会自动处理不同断点下的尺寸变化与内容堆叠，使整体布局保持简洁、直观且易于维护。</p>
<p>Foundation 的工具包体系也是其重要特性之一。框架内置了可直接使用的网页与邮件组件，使项目在启动阶段不必从零搭建基础结构。这种方式在多平台场景下有助于维持统一的视觉风格，并显著减少重复性工作。</p>
<p>在灵活性方面，Foundation 并未强制绑定特定的设计语言或样式规范。默认配置可根据项目需求进行调整或覆盖，从而在不受框架限制的前提下实现定制化界面设计。这种设计思路在效率与自由度之间取得了较好的平衡。</p>
<p>从整体特性来看，Foundation 对无障碍访问和移动优先设计的重视，使其在构建现代化、包容性网页体验时具有明显优势。模块化架构与 SASS 集成提升了组件定制的效率，也使复杂布局的原型构建更加顺畅。</p>
<p>相对而言，Foundation 的学习成本高于 Bootstrap 等更大众化的方案，对初学者存在一定门槛。此外，其社区规模和生态资源不及 Tailwind 和 Bootstrap 丰富，可直接复用的第三方资源相对有限。在功能完整度较高的同时，对于体量较小的项目而言，可能会引入不必要的复杂度。</p>
<p><strong>特点</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  <span class="hljs-strong">**响应式**</span>：先做好手机，再适配平板和电脑。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**网格灵活**</span>：12 列 Flexbox 布局，布局复杂也能处理好。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**组件齐全**</span>：带 JS 插件，交互也有现成的（弹窗、菜单等）。
</code></pre>
<p><strong>适合谁</strong>：想快速搭复杂页面，有交互，又想用框架自带组件的人。</p>
<p><strong>缺点</strong>：学习稍复杂，功能多了，小项目可能显得重。</p>
<p><strong>下面我们来使用它的按钮样式</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Anchors (links) --&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"about.html"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button"</span>&gt;</span>Learn More<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#features"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button"</span>&gt;</span>View All Features<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> 

<span class="hljs-comment">&lt;!-- Buttons (actions) --&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"submit success button"</span>&gt;</span>Save<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"alert button"</span>&gt;</span>Delete<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p><strong>效果</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be2c22903f1e42b8842f5f2e49bfc1fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qE5YaZ5rOV5pyJ54K55r2u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634370&amp;x-signature=T93mUi1gwOLHVYsKFj4ZBSUGjUA%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">4、Bulma</h2>
<p>Bulma 是那种一看就懂、上手很快的框架。类名语义清楚，布局基于 Flexbox，用起来很顺。</p>
<p>它不依赖 JavaScript 这一点，拿来配合任何技术栈都很方便。不过也正因为这样，一些交互相关的东西需要自己补，这点在用之前心里要有预期。</p>
<p><strong>特点</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  <span class="hljs-strong">**响应式**</span>：移动优先，Flexbox 网格布局。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**轻量**</span>：按钮、卡片、表单都有样式，但没有 JS。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**易用**</span>：学习成本低，改样式很方便。
</code></pre>
<p><strong>适合谁</strong>：只需要快速搭页面、布局和样式固定、不需要框架自带交互的人。</p>
<p><strong>缺点</strong>：没有交互组件，复杂行为要自己写。</p>
<p><strong>下面我们来写一个简单的表单</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"field"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"label"</span>&gt;</span>Email<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"control"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"e.g. alex@example.com"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"field"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"label"</span>&gt;</span>Password<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"control"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"********"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button is-primary"</span>&gt;</span>Sign in<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</code></pre>
<p><strong>效果</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6882c05f7b2a4cb2aae2eca977da9efe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qE5YaZ5rOV5pyJ54K55r2u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634370&amp;x-signature=Mgu7j96l%2BxUE%2BEmANr46eeSUcQ8%3D" alt="image.png" loading="lazy"/></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一篇文章带你搞懂原型和原型链]]></title>    <link>https://juejin.cn/post/7593212374922215451</link>    <guid>https://juejin.cn/post/7593212374922215451</guid>    <pubDate>2026-01-10T06:58:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593212374922215451" data-draft-id="7593212374922182683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一篇文章带你搞懂原型和原型链"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-10T06:58:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陟上青云"/> <meta itemprop="url" content="https://juejin.cn/user/3910338081725949"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一篇文章带你搞懂原型和原型链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3910338081725949/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陟上青云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T06:58:57.000Z" title="Sat Jan 10 2026 06:58:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们在理解原型和原型链的时候，喜欢去看概念强行记住，当时以为记住了就懂了可等下次又会忘记，其实是还没有真正弄懂。想要弄懂，就要先知道到底难在哪，理清它们之间的关系，再去看概念性的东西，就轻松很多了。</p>
<h4 data-id="heading-0">一、原型和原型链的核心难点拆解</h4>
<p>难点 1：<code>__proto__</code>、<code>prototype</code>、<code>constructor</code> 三者的关系（最易混淆）</p>
<p>这三个属性是原型体系的 “三角关系”，新手很容易记混、用错，先看核心结论</p>
<ul>
<li>prototype：<strong>函数独有</strong>，指向“原型对象”，原型对象里默认有constructor属性。</li>
<li><code>__proto__</code>：<strong>所有对象独有</strong>，指向自己的“原型对象”。</li>
<li>constructor：<strong>原型对象独有</strong>，指向创建该原型对象的构造函数。</li>
</ul>
<p>核心公式（必记）</p>
<pre><code class="hljs language-js" lang="js">实例.<span class="hljs-property">__proto__</span> === 构造函数.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
构造函数.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === 构造函数
实例.<span class="hljs-property">constructor</span> === 构造函数 （本质是通过原型链查找 constructor）
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
	<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
}
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'老王'</span>)
<span class="hljs-comment">// 验证1，实例的隐式原型（__proto__）=== 构造函数的显式原型（prototype）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,) <span class="hljs-comment">// true</span>
<span class="hljs-comment">// 验证2，原型对象的constructor指向构造函数</span>
 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>) <span class="hljs-comment">// true</span>
<span class="hljs-comment">// 验证3，实例的本身没有constructor 是通过原型链找到原型对象的constructor</span>
 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>) <span class="hljs-comment">//true</span>
</code></pre>
<p>原型对象本身也是对象，因此它的 <code>__proto__</code> 会指向<strong>更高层的原型对象</strong>，最终形成原型链</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Person.prototype 是对象，其 __proto__ 指向 Object.prototype</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>; <span class="hljs-comment">// true</span>

<span class="hljs-comment">// Object.prototype 是原型链的顶端，其 __proto__ 为 null</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-literal">null</span>; <span class="hljs-comment">// true</span>
</code></pre>
<p>注意点：修改 <code>prototype</code> 会影响 <code>constructor</code></p>
<p>若直接覆盖构造函数的 <code>prototype</code>（而非添加属性），会丢失原有的 <code>constructor</code>（默认指向 <code>Object</code>），需手动恢复</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 错误示例：直接覆盖prototype，constructor会指向Object</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">sayHi</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hi'</span>); }
};
p.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Object</span>; <span class="hljs-comment">// true（不符合预期）</span>

<span class="hljs-comment">// 正确做法：覆盖后手动设置constructor</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">constructor</span>: <span class="hljs-title class_">Person</span>, <span class="hljs-comment">// 手动指向原构造函数</span>
  <span class="hljs-attr">sayHi</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hi'</span>); }
};
p.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>; <span class="hljs-comment">// true（恢复预期）</span>
</code></pre>
<p>总结三者的核心关系</p>
<pre><code class="hljs language-javascript" lang="javascript">构造函数（如<span class="hljs-title class_">Person</span>）
  ↓ 拥有
  prototype → 原型对象（如<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>）
                ↓ 拥有
                constructor → 构造函数（<span class="hljs-title class_">Person</span>）
实例（如p）
  ↓ 拥有
  __proto__ → 原型对象（<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>）
</code></pre>
<p>二，原型和原型链的核心理解</p>
<p>简单来说每个函数创建都会默认添加一个prototype的属性，创建每个对象也会有一个__proto__的属性，上面也验证过 实例的__proto__(隐式原型)是指向构造函数的prototype(显示原型的)两者是相等的。</p>
<p>构造函数.prototype也是一个对象，所以也会有一个__proto__，指向的是<strong>Object.prototype</strong>,因此<strong>Object.prototype</strong>也是一个对象，所以也会有__proto__，Object.prototype.<strong>proto</strong> 指向的却是null，因为这是原型链的最顶层了，顶层就是null</p>
<p><strong>原型链</strong>：实例会先从自身上找，没找到会通过obj.<strong>proto</strong> 从原型对象上去找（构造函数.prototype）,没找到会通过obj.<strong>proto</strong>.<strong>proto</strong> 从原型对象上的原型上去找（构造函数.prototype.<strong>proto</strong>）,直到最顶层Object.prototype去找没找到，就回去Object.prototype.<strong>proto</strong> 值为null 结束 返回 undefined</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>
        }

        <span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'zhangsan'</span>)
        <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">age2</span> = <span class="hljs-number">30</span>
        <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">age3</span> = <span class="hljs-number">40</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>) <span class="hljs-comment">//访问的是自身上的属性</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age2</span>) <span class="hljs-comment">//访问的是原型对象上的属性</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age3</span>) <span class="hljs-comment">//访问的是原型对象的原型上的属性</span>

        <span class="hljs-comment">/**
         * obj={
         *   console.log(obj.age) 30  先找自身
         * __proto__ === 构造函数.prototype {
         *     console.log(obj.age2) 30  如果自身没有找到 就会去找原型对象
         *   Person.prototype.__proto__ === Object.prototype ={
         *       console.log(obj.age3) 40  原型对象上没有  就会去找原型对象上的原型上去找
         *     }
         *      Object.prototype.__proto__ {
         *        直到最顶层  Object.prototype 它的__proto__ === null  所有原型链的最顶层就是
         *      }  
         *   
         *   }
         * 
         * }
         * **/</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[fiuckjs 基于react的flutter动态化方案]]></title>    <link>https://juejin.cn/post/7593234983755808778</link>    <guid>https://juejin.cn/post/7593234983755808778</guid>    <pubDate>2026-01-10T06:21:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593234983755808778" data-draft-id="7593242327933157386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="fiuckjs 基于react的flutter动态化方案"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2026-01-10T06:21:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wey608"/> <meta itemprop="url" content="https://juejin.cn/user/2529294609550445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            fiuckjs 基于react的flutter动态化方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2529294609550445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wey608
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T06:21:27.000Z" title="Sat Jan 10 2026 06:21:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">FuickJS</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyanweimin7%2Ffuickjs" target="_blank" title="https://github.com/yanweimin7/fuickjs" ref="nofollow noopener noreferrer">github.com/yanweimin7/…</a></p>
<p>FuickJS 是一个基于 <strong>QuickJS</strong> 引擎实现的 Flutter 动态化渲染框架。它允许开发者使用 <strong>React</strong> 语法编写业务逻辑和 UI，并通过 Flutter 原生组件进行高性能渲染。</p>
<p><strong>目前作为技术探索，用于跑通原理，分层、命名什么的比较乱</strong> ，有兴趣的可以一起交流。</p>
<h3 data-id="heading-1">核心特性</h3>
<ul>
<li><strong>React 开发体验</strong>: 使用熟悉的 React 语法、Hooks 和生命周期。</li>
<li><strong>高性能渲染</strong>: 并非使用 WebView，而是将 JS 描述的 UI 树通过 FFI 传递给 Flutter，映射为原生 Widget。</li>
<li><strong>轻量级桥接</strong>: 采用 Dart FFI 直接与 C 层 QuickJS 交互，避免了 JSON 序列化的开销。</li>
<li><strong>动态更新</strong>: JS 代码可动态下发，实现不发版即可更新 App 功能。</li>
<li>支持android 、ios 、macos多平台</li>
<li>支持加载quickjs 字节码，实现页面秒开</li>
<li>支持分包加载，framework代码 &amp; 业务代码独立</li>
</ul>
<h3 data-id="heading-2">效果预览</h3>
<p align="center">
  <img src="https://github.com/yanweimin7/fuickjs/raw/master/imgs/Screenshot_20260107_225623.png" width="30%" loading="lazy"/>
  <img src="https://github.com/yanweimin7/fuickjs/raw/master/imgs/Simulator%20Screenshot%20-%20iPhone%2015%20Pro%20-%202026-01-07%20at%2022.58.08.png" width="30%" loading="lazy"/>
  <img src="https://github.com/yanweimin7/fuickjs/raw/master/imgs/screenshot-20260107-230007.png" width="30%" loading="lazy"/>
</p>
<h3 data-id="heading-3">项目结构</h3>
<pre><code class="hljs language-text" lang="text">fuickjs/
├── app/                # Flutter 侧代码 (Native 容器)
│   ├── lib/
│   │   ├── core/       # 核心逻辑 (渲染引擎、控制器、Handler)
│   │   ├── quickjs_ffi.dart # 底层 FFI 封装
│   │   └── main.dart   # 入口文件
│   └── assets/js/      # JS 产物存放目录
├── js/                 # JS 侧代码 (React 运行时)
│   ├── src/
│   │   ├── renderer.js # 自定义 React 渲染器
│   │   ├── hostConfig.js # 协调器配置
│   │   └── pages/      # 业务页面代码
│   └── esbuild.js      # 打包脚本
└── README.md           # 本文件
</code></pre>
<h3 data-id="heading-4">运行流程</h3>
<ol>
<li><strong>JS 打包</strong>:
在 <code>js</code> 目录下运行 <code>node esbuild.js</code>。脚本会编译 JS 代码并将 <code>bundle.js</code> 自动拷贝到 <code>app/assets/js/</code> 目录。</li>
<li><strong>Flutter 运行</strong>:
在 <code>app</code> 目录下运行 <code>flutter run</code>。Flutter 容器会启动 QuickJS 引擎，加载 <code>bundle.js</code>，并根据 JS 侧生成的 DSL 渲染 UI。</li>
</ol>
<h3 data-id="heading-5">快速开始</h3>
<h4 data-id="heading-6">1. 安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># JS 侧</span>
<span class="hljs-built_in">cd</span> js
npm install

<span class="hljs-comment"># Flutter 侧</span>
<span class="hljs-built_in">cd</span> app
flutter pub get
</code></pre>
<h4 data-id="heading-7">2. 编译 JS</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> js
npm run build
</code></pre>
<h4 data-id="heading-8">3. 运行项目</h4>
<p>使用 IDE 打开 <code>app</code> 目录，或在命令行运行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> app
flutter run
</code></pre>
<h3 data-id="heading-9">技术架构</h3>
<ul>
<li><strong>Engine</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fbellard.org%2Fquickjs%2F" target="_blank" title="https://bellard.org/quickjs/" ref="nofollow noopener noreferrer">QuickJS</a> (轻量级、高性能 JS 引擎)</li>
<li><strong>Bridge</strong>: Dart FFI (C-Style 接口调用)</li>
<li><strong>Framework</strong>: React (前端 UI 框架)</li>
<li><strong>Renderer</strong>: 自定义 Reconciler (DSL 转换器)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 进程管理]]></title>    <link>https://juejin.cn/post/7593232758127067142</link>    <guid>https://juejin.cn/post/7593232758127067142</guid>    <pubDate>2026-01-10T06:54:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593232758127067142" data-draft-id="7593198957984202793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 进程管理"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-10T06:54:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户46724454499"/> <meta itemprop="url" content="https://juejin.cn/user/502914754559866"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 进程管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/502914754559866/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户46724454499
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T06:54:57.000Z" title="Sat Jan 10 2026 06:54:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PID进程标识符</h2>
<p>每一个进程有唯一的进程标识符pid（<em>通常由1开始的正整数</em>），pid=1通常为系统进程，其他进程直接或间接由它创建
如使用命令ls时，系统会为ls程序创建一个新的进程，并分配唯一pid。</p>
<h3 data-id="heading-1">查看进程号</h3>
<pre><code class="hljs language-js" lang="js">echo $$  
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d717cda054444c7bbfd555ee8564110b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=P%2B3JuFjXCOv57l4hYzBsOKbA8Dk%3D" alt="image.png" loading="lazy"/></p>
<p>这里切换到test1用户，pid不同</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01019a2877274cb284f0c4ff80f2601f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=%2FHq8aSmvB5Gx8E6Hh9WFSC2NeEE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">查看电脑中有多少个进程</h3>
<p>ps -aux</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/990f431691d54cc99645a97c8bc5b374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=%2BJ5cbXq233%2FW2%2BF6mFAlvKAd%2FZ8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">top实时查看进程信息</h3>
<p>q退出</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0474093500874458bff989361fe6cb7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=zRJLhP%2Bmr4IMyVwmBIF3duz6Zt4%3D" alt="image.png" loading="lazy"/></p>
<p>大写P按cpu的大小进行排序</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52ae549a8d314c22b2c7d37e107cd1e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=nuU0w%2FWgHTK7sUffIbmrVOp4EMA%3D" alt="image.png" loading="lazy"/></p>
<p>大写M，按内存大小排序</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/676b0947febd44c5a1fdef685c459a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=vkrPaU47wEXQ3heqQn59kpY0aoc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">查找进程号</h3>
<p>pgrep [name]</p>
<p>查找所有进程名为[name]的进程号</p>
<p>pgrep sshd</p>
<p>这里查找 sshd的进程号</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44fd01dc77f140b2af240758b9b51acd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=3IheWcHbj%2BWU%2B%2B7DDNF0C%2Fn8sm8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">查看进程树</h3>
<p>pstree -p 进程号</p>
<p>如：
pstree -p 2202</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea77de1b2e664e3e904456264aac0c22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=R5uZ8%2FUPKwlKOq%2BdiC%2Bq94T1YJE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">进程控制</h2>
<h3 data-id="heading-7">kill命令</h3>
<p>kill -2 进程号     （终止该进程非强制）</p>
<p>kill -9 进程号     （强制终止）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4af80faa4c234ac79de3546ba01cf230~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=S3%2BsQmKAkUxYzlovpIKRUK07tzQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">nohup命令</h3>
<p>nohup bash 文件名 &amp;</p>
<p>这里是test.sh</p>
<p>自动执行脚本文件test.sh，因为这里的test.sh里是空的，所以被done了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24c68183306f4163893674f7c7b0365f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjQ0NTQ0OTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632897&amp;x-signature=uW2xdRADvScY6xqew8DrDJW%2FZIw%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mac安装Homebrew]]></title>    <link>https://juejin.cn/post/7593338828196610088</link>    <guid>https://juejin.cn/post/7593338828196610088</guid>    <pubDate>2026-01-10T06:58:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593338828196610088" data-draft-id="7593338828196577320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mac安装Homebrew"/> <meta itemprop="keywords" content="macOS"/> <meta itemprop="datePublished" content="2026-01-10T06:58:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YongPagani"/> <meta itemprop="url" content="https://juejin.cn/user/254742431009390"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mac安装Homebrew
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742431009390/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YongPagani
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T06:58:15.000Z" title="Sat Jan 10 2026 06:58:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在mac安装git软件的途中，发现其中一种方法是先安装Homebrew，然后通过Homebrew安装git。
然后按照别人的推荐执行命令：
<code>/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"</code></p>
<p>此时对于国内网络不好的环境执行上诉命令后会报如下图所示的错误</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8687b2d551c419aa3c99830764fbe05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWW9uZ1BhZ2FuaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768633520&amp;x-signature=EpN3j6MyYfRZppXybD72k34eklw%3D" alt="image.png" loading="lazy"/></p>
<p>上诉错误的主要原因是<strong>网络环境问题</strong>：本地网络不稳定、防火墙/代理拦截了 HTTPS 流量，或 GitHub 的 HTTP/2 连接在你的网络环境下兼容性不佳。</p>
<h3 data-id="heading-0">解决方案 1：使用国内镜像源安装（推荐，最稳定）</h3>
<p>原脚本访问 GitHub 资源容易超时 / 连接失败，改用国内镜像源能大幅提升成功率，执行以下命令即可</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 临时设置镜像源并执行安装脚本（一键式，无需手动改配置） </span>
/bin/bash -c <span class="hljs-string">"<span class="hljs-subst">$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)</span>"</span>
</code></pre>
<p>执行后按提示操作：</p>
<ol>
<li>选择一个国内镜像源（比如清华）；
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d22979eba05542969821a997947f5303~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWW9uZ1BhZ2FuaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768633520&amp;x-signature=9EpBXrz0TewP4Zgt2Ky9lp0KeyY%3D" alt="image.png" loading="lazy"/></li>
<li>等待脚本自动安装 Homebrew 核心组件；</li>
<li>安装完成后，脚本会自动配置好后续的镜像源，避免后续 <code>brew</code> 命令再出网络问题。</li>
</ol>
<p>安装完成后，执行以下命令检查：</p>
<pre><code class="hljs language-js" lang="js"># 查看 brew 版本 
brew -v 
# 测试基本功能 
brew doctor
</code></pre>
<p>如果能正常显示版本号，且 <code>brew doctor</code> 无严重错误，说明安装成功。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SQL Server 2017 EXISTS 关键字 完整用法详解（最全 + 最优写法 + 性能对比）]]></title>    <link>https://juejin.cn/post/7593258683750318114</link>    <guid>https://juejin.cn/post/7593258683750318114</guid>    <pubDate>2026-01-10T06:48:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593258683750318114" data-draft-id="7593258683750252578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SQL Server 2017 EXISTS 关键字 完整用法详解（最全 + 最优写法 + 性能对比）"/> <meta itemprop="keywords" content="SQL Server,SQL"/> <meta itemprop="datePublished" content="2026-01-10T06:48:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Waloo"/> <meta itemprop="url" content="https://juejin.cn/user/2065330513129546"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SQL Server 2017 EXISTS 关键字 完整用法详解（最全 + 最优写法 + 性能对比）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2065330513129546/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Waloo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T06:48:12.000Z" title="Sat Jan 10 2026 06:48:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>EXISTS</code>是 SQL 高频且高效的关键字，掌握后能大幅优化查询性能，内容全部适配 SQL Server 2017，直接套用即可。</p>
<h2 data-id="heading-0">✅ 一、<code>EXISTS</code> 核心定义 &amp; 执行逻辑（重中之重）</h2>
<h3 data-id="heading-1">1. 基础定义</h3>
<p><code>EXISTS</code> 是 <strong>SQL 逻辑判断运算符</strong>，专门用来判断「<strong>子查询是否返回数据行</strong>」，返回结果只有两种：<code>TRUE</code> 或 <code>FALSE</code>。</p>
<h3 data-id="heading-2">2. 核心执行逻辑（灵魂！必须记住）</h3>
<p><code>EXISTS</code> 执行时是 <strong>「存在即止」</strong> 的逻辑：</p>
<blockquote>
<p>子查询只要能查询到<strong>至少 1 条符合条件的数据</strong>，<code>EXISTS()</code> 就立刻返回 <code>TRUE</code>，<strong>不会继续查询剩余数据</strong>；子查询如果<strong>一条数据都查不到</strong>，则返回 <code>FALSE</code>。</p>
</blockquote>
<p>✅ 关键点：<strong><code>EXISTS</code> 只关心「有没有数据」，不关心子查询返回什么字段 / 什么值</strong>！</p>
<h2 data-id="heading-3">✅ 二、<code>EXISTS</code> 标准语法格式</h2>
<h3 data-id="heading-4">基础语法（2 种常用格式，完全等价，推荐第一种）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 格式1：标准写法（推荐，可读性最高）</span>
<span class="hljs-keyword">SELECT</span> 字段<span class="hljs-number">1</span>,字段<span class="hljs-number">2</span>,...
<span class="hljs-keyword">FROM</span> 主表 a
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-comment">-- 子查询：关联主表，设置匹配条件</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>  <span class="hljs-comment">-- 重点：这里写 * / 1 / 任意字段 效果完全一样，性能无差别</span>
    <span class="hljs-keyword">FROM</span> 子表 b
    <span class="hljs-keyword">WHERE</span> a.关联字段 <span class="hljs-operator">=</span> b.关联字段  <span class="hljs-comment">-- 主表和子表的关联条件【核心】</span>
    <span class="hljs-keyword">AND</span> 子表的过滤条件             <span class="hljs-comment">-- 可选，子表的额外筛选</span>
);

<span class="hljs-comment">-- 格式2：NOT EXISTS 反向查询（查询「不存在匹配数据」的结果）</span>
<span class="hljs-keyword">SELECT</span> 字段<span class="hljs-number">1</span>,字段<span class="hljs-number">2</span>,...
<span class="hljs-keyword">FROM</span> 主表 a
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
    <span class="hljs-keyword">FROM</span> 子表 b
    <span class="hljs-keyword">WHERE</span> a.关联字段 <span class="hljs-operator">=</span> b.关联字段
    <span class="hljs-keyword">AND</span> 子表的过滤条件
);
</code></pre>
<h3 data-id="heading-5">✨ 必记知识点：子查询里的 <code>SELECT *</code> 可以随便写！</h3>
<p><code>EXISTS</code> 只判断「子查询是否有结果集」，所以子查询里的 <code>SELECT</code> 后面写什么都可以：<code>SELECT *</code>、<code>SELECT 1</code>、<code>SELECT 主键</code>、<code>SELECT 任意字段</code> → <strong>性能完全一致、结果完全一致</strong>。✅ 行业最佳实践：写 <code>SELECT 1</code>，语义更清晰，告诉阅读者「这里只做存在判断，不关心具体字段」，例如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> 子表 b <span class="hljs-keyword">WHERE</span> a.id <span class="hljs-operator">=</span> b.main_id)
</code></pre>
<h2 data-id="heading-6">✅ 三、<code>EXISTS</code> 两种核心用法（含实战案例，最常用）</h2>
<p>为了方便你理解和套用，用<strong>业务场景化案例</strong>演示，所有 SQL 直接可运行，表结构是日常开发最常见的：</p>
<h3 data-id="heading-7">案例基础表（2 张关联表）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 部门表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> Dept(DeptId <span class="hljs-type">INT</span>, DeptName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>));
<span class="hljs-comment">-- 员工表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> Emp(EmpId <span class="hljs-type">INT</span>, EmpName <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>), DeptId <span class="hljs-type">INT</span>, Salary <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>));
</code></pre>
<h3 data-id="heading-8">✅ 用法 1：正向查询 → <code>EXISTS</code> 匹配【存在关联数据】的记录</h3>
<blockquote>
<p>业务需求：查询「<strong>有员工的部门</strong>」列表（即：部门表中，存在对应员工的部门）</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> DeptId, DeptName
<span class="hljs-keyword">FROM</span> Dept d
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> Emp e
    <span class="hljs-keyword">WHERE</span> d.DeptId <span class="hljs-operator">=</span> e.DeptId  <span class="hljs-comment">-- 主表Dept关联子表Emp</span>
);
</code></pre>
<h3 data-id="heading-9">✅ 用法 2：反向查询 → <code>NOT EXISTS</code> 匹配【无关联数据】的记录</h3>
<blockquote>
<p>业务需求：查询「<strong>空部门 / 无员工的部门</strong>」列表（即：部门表中，没有任何员工的部门）</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> DeptId, DeptName
<span class="hljs-keyword">FROM</span> Dept d
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> Emp e
    <span class="hljs-keyword">WHERE</span> d.DeptId <span class="hljs-operator">=</span> e.DeptId
);
</code></pre>
<h3 data-id="heading-10">✅ 进阶用法：带额外过滤条件的<code>EXISTS</code>（工作中 90% 的真实场景）</h3>
<blockquote>
<p>业务需求：查询「<strong>有【月薪大于 10000】员工的部门</strong>」列表</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> DeptId, DeptName
<span class="hljs-keyword">FROM</span> Dept d
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">FROM</span> Emp e
    <span class="hljs-keyword">WHERE</span> d.DeptId <span class="hljs-operator">=</span> e.DeptId
    <span class="hljs-keyword">AND</span> e.Salary <span class="hljs-operator">&gt;</span> <span class="hljs-number">10000</span>  <span class="hljs-comment">-- 子表的额外过滤条件</span>
);
</code></pre>
<h2 data-id="heading-11">✅ 四、<code>EXISTS</code> 与 <code>IN</code> 的区别（高频面试题 + 性能天壤之别）</h2>
<p>你大概率会有疑问：<code>SELECT ... WHERE 字段 IN (子查询)</code> 也能实现类似效果，和<code>EXISTS</code>有什么区别？用哪个更好？这是<strong>SQL 优化的核心考点</strong>，也是日常开发中最容易踩坑的点，<strong>结论先说：在 SQL Server 2017 中，优先用<code>EXISTS</code>，尤其是大数据量场景</strong>！</p>
<h3 data-id="heading-12">✅ 核心区别 1：执行逻辑完全不同</h3>
<h4 data-id="heading-13">① <code>IN (子查询)</code> 执行逻辑 → 「全量匹配」</h4>
<p><code>IN</code> 会先执行<strong>子查询</strong>，把子查询的结果集<strong>全部查询出来</strong>，生成一个临时的结果列表，然后<strong>主表的每一行数据都去和这个列表做匹配</strong>。</p>
<ul>
<li>过程：子查询全量执行 → 生成临时列表 → 主表逐条匹配</li>
<li>缺点：如果子查询返回的结果集很大（比如几万 / 几十万条），临时列表会占用大量内存，匹配效率极低，查询会很慢！</li>
</ul>
<h4 data-id="heading-14">② <code>EXISTS</code> 执行逻辑 → 「逐行匹配 + 存在即止」</h4>
<p><code>EXISTS</code> 是<strong>从主表开始逐行查询</strong>，每取主表的 1 条数据，就执行 1 次子查询做匹配，只要子查询能查到 1 条匹配数据，立刻停止匹配这条主数据，继续下一条。</p>
<ul>
<li>过程：主表逐行遍历 → 子查询按需执行 → 匹配到即停止</li>
<li>优点：<strong>不生成临时结果集</strong>，内存占用极低，哪怕主表和子表都是大数据量，效率依然很高！</li>
</ul>
<h3 data-id="heading-15">✅ 核心区别 2：对「NULL 值」的处理不同（必避坑）</h3>
<p><code>IN</code> 遇到子查询返回 <strong>NULL 值</strong> 时，会直接返回 <code>FALSE</code>，导致<strong>整个查询无结果</strong>；<code>EXISTS</code> 完全不受 NULL 值 影响，判断逻辑依然正常生效。</p>
<h4 data-id="heading-16">示例对比（踩坑案例）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景：子查询返回包含NULL的结果集</span>
<span class="hljs-comment">-- 写法1：IN 会返回空结果，踩坑！</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Emp <span class="hljs-keyword">WHERE</span> DeptId <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> DeptId <span class="hljs-keyword">FROM</span> Dept <span class="hljs-keyword">WHERE</span> DeptName<span class="hljs-operator">=</span><span class="hljs-string">'技术部'</span> <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">NULL</span>);

<span class="hljs-comment">-- 写法2：EXISTS 正常返回结果，无影响</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Emp e <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> Dept d <span class="hljs-keyword">WHERE</span> d.DeptId<span class="hljs-operator">=</span>e.DeptId <span class="hljs-keyword">AND</span> d.DeptName<span class="hljs-operator">=</span><span class="hljs-string">'技术部'</span> <span class="hljs-keyword">OR</span> d.DeptId <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>);
</code></pre>
<h2 data-id="heading-17">✅ 五、扩展：<code>EXISTS</code> 和<code>ROW_NUMBER()</code>一起使用</h2>
<p>若需求是 <strong><code>ROW_NUMBER() OVER(PARTITION BY 部门)</code> 分组排序 + 过滤指定部门</strong>，现在结合<code>EXISTS</code>，演示 2 个<strong>工作中最常用的实战组合场景</strong>，直接套用！</p>
<h3 data-id="heading-18">✅ 场景 1：查询「存在指定客户的部门」+ 按部门分组生成行号</h3>
<blockquote>
<p>需求：只保留「有【VIP 客户】的部门」，并对每个部门下的客户按负责人 + 客户名称排序生成行号</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    h.部门, h.负责人, h.客户名称,
    <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> h.部门 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> h.负责人, h.客户名称) <span class="hljs-keyword">AS</span> 行号
<span class="hljs-keyword">FROM</span> 你的表 h
<span class="hljs-comment">-- 核心：只保留存在VIP客户的部门</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> 你的表 t 
    <span class="hljs-keyword">WHERE</span> t.部门 <span class="hljs-operator">=</span> h.部门 <span class="hljs-keyword">AND</span> t.客户类型 <span class="hljs-operator">=</span> <span class="hljs-string">'VIP客户'</span>
);
</code></pre>
<h3 data-id="heading-19">✅ 场景 2：查询「不存在无效数据的部门」+ 分组去重（经典需求）</h3>
<blockquote>
<p>需求：过滤掉「有无效客户（客户名称为空）」的部门，同时给每个有效部门的客户生成行号，取每个部门的第一条数据</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> TempData <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> 
        h.部门, h.负责人, h.客户名称,
        <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> h.部门 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> h.负责人) <span class="hljs-keyword">AS</span> 行号
    <span class="hljs-keyword">FROM</span> 你的表 h
    <span class="hljs-comment">-- 过滤：无无效客户的部门</span>
    <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> 你的表 t <span class="hljs-keyword">WHERE</span> t.部门 <span class="hljs-operator">=</span> h.部门 <span class="hljs-keyword">AND</span> t.客户名称 <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>
    )
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> TempData <span class="hljs-keyword">WHERE</span> 行号<span class="hljs-operator">=</span><span class="hljs-number">1</span>; <span class="hljs-comment">-- 每个部门只取第一条</span>
</code></pre>
<h2 data-id="heading-20">✅ 六、<code>EXISTS</code> 高级用法补充（3 个高频场景）</h2>
<h3 data-id="heading-21">✅ 场景 1：<code>EXISTS</code> 实现「表的去重查询」（替代 DISTINCT，性能更好）</h3>
<p>DISTINCT 是全量查询后去重，大数据量效率低；EXISTS 是匹配到即停止，效率更高。</p>
<blockquote>
<p>需求：查询所有有订单的客户，去重显示客户信息</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 写法1：DISTINCT 效率低</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> c.<span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Customer c <span class="hljs-keyword">JOIN</span> OrderList o <span class="hljs-keyword">ON</span> c.CustId<span class="hljs-operator">=</span>o.CustId;

<span class="hljs-comment">-- 写法2：EXISTS 效率高（推荐）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Customer c <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> OrderList o <span class="hljs-keyword">WHERE</span> o.CustId<span class="hljs-operator">=</span>c.CustId);
</code></pre>
<h3 data-id="heading-22">✅ 场景 2：多层嵌套 <code>EXISTS</code>（多表关联判断）</h3>
<p>支持无限层嵌套，逻辑清晰，性能依然稳定，适合多表关联的复杂判断。</p>
<blockquote>
<p>需求：查询「有 VIP 客户，且该客户有未付款订单」的部门</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Dept d
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> Emp e <span class="hljs-keyword">WHERE</span> e.DeptId<span class="hljs-operator">=</span>d.DeptId
    <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
        <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> Customer c <span class="hljs-keyword">WHERE</span> c.EmpId<span class="hljs-operator">=</span>e.EmpId <span class="hljs-keyword">AND</span> c.CustType<span class="hljs-operator">=</span><span class="hljs-string">'VIP'</span>
        <span class="hljs-keyword">AND</span> <span class="hljs-keyword">EXISTS</span> (
            <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> OrderList o <span class="hljs-keyword">WHERE</span> o.CustId<span class="hljs-operator">=</span>c.CustId <span class="hljs-keyword">AND</span> o.PayStatus<span class="hljs-operator">=</span><span class="hljs-string">'未付款'</span>
        )
    )
);
</code></pre>
<h3 data-id="heading-23">✅ 场景 3：<code>EXISTS</code> 替代 <code>JOIN</code>（仅查询主表数据时）</h3>
<p>如果你的需求只是「查询主表数据，只需要判断是否存在关联数据」，不需要子表的字段，用<code>EXISTS</code>替代<code>JOIN</code>，性能会比<code>LEFT JOIN + IS NOT NULL</code>更好。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 写法1：LEFT JOIN 去重</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> d.<span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Dept d <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> Emp e <span class="hljs-keyword">ON</span> d.DeptId<span class="hljs-operator">=</span>e.DeptId <span class="hljs-keyword">WHERE</span> e.EmpId <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;

<span class="hljs-comment">-- 写法2：EXISTS 更简洁高效</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> Dept d <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> Emp e <span class="hljs-keyword">WHERE</span> e.DeptId<span class="hljs-operator">=</span>d.DeptId);
</code></pre>
<h2 data-id="heading-24">✅ 七、<code>EXISTS</code> 性能优化小技巧（SQL Server 2017 专属）</h2>
<ol>
<li>✅ 子查询中尽量用 <strong>主键 / 索引字段</strong> 做关联条件 → 子查询的匹配效率会翻倍（SQL Server 会走索引查询）；</li>
<li>✅ 子查询里只写「关联条件 + 必要过滤条件」，不要写多余的字段和逻辑；</li>
<li>✅ 对频繁查询的关联字段（比如 DeptId、EmpId）建立<strong>非聚集索引</strong>，能让 EXISTS 的查询效率再提升一个量级。</li>
</ol>
<h2 data-id="heading-25">✅ 总结（所有核心知识点浓缩，建议收藏）</h2>
<h3 data-id="heading-26">1. <code>EXISTS</code> 核心</h3>
<ul>
<li>是逻辑运算符，返回<code>TRUE/FALSE</code>，只判断「子查询是否有结果」；</li>
<li>子查询写<code>SELECT 1</code>最佳，<code>SELECT *</code>也可以，性能无差别；</li>
<li>执行逻辑：<strong>逐行匹配、存在即止</strong>，性能天花板级别的判断方式。</li>
</ul>
<h3 data-id="heading-27">2. <code>NOT EXISTS</code> 核心</h3>
<ul>
<li>反向判断「无匹配数据」，是查询「缺失数据」的最优写法，没有之一。</li>
</ul>
<h3 data-id="heading-28">3. <code>EXISTS</code> vs <code>IN</code> 核心</h3>
<ul>
<li>执行逻辑：EXISTS 逐行匹配，IN 全量生成临时列表；</li>
<li>性能：EXISTS &gt;&gt; IN（大数据量场景差距悬殊）；</li>
<li>坑点：IN 受 NULL 值影响，EXISTS 不受；</li>
<li>选择：优先用 EXISTS，固定值列表用 IN。</li>
</ul>
<h3 data-id="heading-29">4. 结合你的需求</h3>
<ul>
<li><code>EXISTS + ROW_NUMBER()</code> 是完美组合，既能高效过滤数据，又能按分组生成行号，是 SQL Server 中处理分组排序 + 条件过滤的最优写法。</li>
</ul>
<p>希望这份详解能帮你彻底掌握<code>EXISTS</code>，所有知识点都是 SQL Server 2017 的原生支持，直接用就行！💡</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Python源码】6G：PyTorch OFDM 教学仿真平台]]></title>    <link>https://juejin.cn/post/7593212374922297371</link>    <guid>https://juejin.cn/post/7593212374922297371</guid>    <pubDate>2026-01-10T07:12:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593212374922297371" data-draft-id="7593240931287400500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Python源码】6G：PyTorch OFDM 教学仿真平台"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-10T07:12:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="3GPP仿真实验室"/> <meta itemprop="url" content="https://juejin.cn/user/590875532999898"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Python源码】6G：PyTorch OFDM 教学仿真平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/590875532999898/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    3GPP仿真实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T07:12:09.000Z" title="Sat Jan 10 2026 07:12:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​
📡 PyTorch 3GPP NR OFDM 教学仿真平台</p>
<p><strong>PyTorch 深度学习与无线通信的完美融合 · 3GPP 标准逐行复现</strong>
<em>从 Tensor 基础到 Autograd 信道估计 · 探索 AI for Science 的通信基石</em></p>
<p>​</p>
<h2 data-id="heading-0">📌 为什么通过本项目学习 PyTorch？</h2>
<p>对着 <strong>PyTorch 文档</strong> 里的 <code>backward()</code> 发愁？只知道调库 <code>import torch.nn</code> 却不懂底层微分原理？想做 <strong>AI 通信 (AI-RAN)</strong> 却发现传统 MATLAB 仿真无法平滑迁移？</p>
<p>本平台提供了一套 <strong>教科书级</strong> 的 PyTorch 通信仿真教程，将抽象的张量操作映射到具象的物理层信号处理。</p>

























<table><thead><tr><th>痛点 (学习困境)</th><th>本平台解决方案</th></tr></thead><tbody><tr><td>🔴 <strong>张量操作抽象</strong>(dim, broadcast)</td><td>✅ <strong>通信场景化</strong>：用 <code>[Batch, Ant, Subcarrier]</code> 解释维度，秒懂广播机制</td></tr><tr><td>🔴<strong>Autograd 黑盒</strong></td><td>✅ <strong>物理意义解构</strong>：用“信道估计”演示梯度下降，<code>backward</code> 就是求导</td></tr><tr><td>🔴<strong>MATLAB 迁移难</strong></td><td>✅<strong>3GPP 标准复现</strong>：用 PyTorch Tensor 重写 TS 38.211，对标 MATLAB 写法</td></tr><tr><td>🔴 <strong>频域处理易错</strong></td><td>✅ <strong>标准 OFDM 流程</strong>：完美处理 <code>fftshift</code>、CP、子载波映射，符合 5G 标准</td></tr></tbody></table>
<h2 data-id="heading-1">🎯 核心价值</h2>
<p>​​</p>
<h3 data-id="heading-2">🔬 学术研究价值 (AI for Comm)</h3>
<ul>
<li><strong>可微分通信</strong>：全链路 Tensor 实现，支持端到端反向传播</li>
<li><strong>梯度下降信道估计</strong>：深入理解 MSE Loss 与 SGD 在物理层的作用</li>
<li><strong>高性能仿真</strong>：利用 GPU 加速大规模并行 OFDM 仿真</li>
<li><strong>3GPP 对标</strong>：严格遵循 TS 38.211 Numerology 定义</li>
</ul>

<h3 data-id="heading-3">💼 工程应用价值 (5G NR)</h3>
<ul>
<li><strong>模块解耦</strong>：Numerology / Modulator / Channel 均模块化设计</li>
<li><strong>工业级实现</strong>：支持 BPSK 到 1024QAM 全阶调制</li>
<li><strong>完整链路</strong>：从比特流到波形的 E2E 收发演示</li>
<li><strong>代码规范</strong>：类型提示 (Type Hint) + 详细中文注释</li>
</ul>

<h2 data-id="heading-4">⚡ 技术亮点</h2>
<h3 data-id="heading-5">🏗️ 课程阶段架构 (Staged Arch)</h3>
<pre><code class="hljs language-bash" lang="bash">src/
├── 【阶段一：Tensor 与基础信号处理】
│   ├── tensor_basics.py      <span class="hljs-comment"># 张量基础：广播、视图、复数操作</span>
│   ├── modulation.py         <span class="hljs-comment"># 3GPP 调制：BPSK/QPSK/16QAM...1024QAM (Gray Mapping)</span>
│   ├── nr_ofdm.py            <span class="hljs-comment"># [TS 38.211] NRNumerology &amp; NROFDMModulator</span>
│   └── nr_ofdm_system.py     <span class="hljs-comment"># E2E 系统：BER 仿真链路</span>
│
├── 【阶段二：Autograd 与信道估计】
│   └── channel_estimation.py <span class="hljs-comment"># 🔥 自动求导核心演示：基于梯度的信道估计</span>
│
├── 【通用模块】
│   └── channel.py            <span class="hljs-comment"># AWGN 信道模型</span>
│   
└── 【演示与可视化】
    ├── examples/
    │   ├── demo_nr_ofdm_ber.py   <span class="hljs-comment"># 阶段一：OFDM 星座图与 BER 曲线</span>
    │   └── src/channel_estimation.py ... (直接运行模块)
</code></pre>
<h3 data-id="heading-6">📊 性能实测</h3>
<h4 data-id="heading-7">阶段一：OFDM BER (3GPP Compliance)</h4>

































<table><thead><tr><th>SNR (dB)</th><th>QPSK (Sim)</th><th>16QAM (Sim)</th><th>64QAM (Sim)</th><th>Theory Match</th></tr></thead><tbody><tr><td>0</td><td>1.31e-01</td><td>2.63e-01</td><td>2.50e-01</td><td>✅</td></tr><tr><td>10</td><td><strong>2.06e-04</strong></td><td>4.26e-02</td><td>4.29e-02</td><td>✅</td></tr><tr><td>20</td><td>0</td><td>0</td><td>0</td><td>✅</td></tr></tbody></table>
<h4 data-id="heading-8">阶段二：自动求导信道估计 (h_true = 0.8 + 0.6j)</h4>





























<table><thead><tr><th>优化器</th><th>迭代次数</th><th>最终误差</th><th>收敛特性</th></tr></thead><tbody><tr><td><strong>Manual</strong></td><td>50</td><td>0.0026</td><td>快速，演示原理</td></tr><tr><td><strong>SGD</strong></td><td>50</td><td>0.0026</td><td>稳定，标准 GD</td></tr><tr><td><strong>Adam</strong></td><td>50</td><td>0.0170</td><td>振荡收敛</td></tr></tbody></table>
<h2 data-id="heading-9">💻 核心代码展示</h2>
<h3 data-id="heading-10">🔥 3GPP OFDM 调制 (<code>src/nr_ofdm.py</code>)</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">modulate</span>(<span class="hljs-params">self, freq_grid: torch.Tensor, symbol_idx: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span></span>) -&gt; torch.Tensor:
    <span class="hljs-string">"""
    频域 → 时域 (IFFT + CP) [TS 38.211]
    """</span>
    <span class="hljs-comment"># 1. IFFT (PyTorch 原生 FFT 支持)</span>
    <span class="hljs-comment">#    输入为标准 FFT 格式 (DC at index 0)</span>
    time_signal = torch.fft.ifft(freq_grid)
    
    <span class="hljs-comment"># 2. 添加 Cyclic Prefix (CP)</span>
    cp_length = self.numerology.get_cp_samples(self.n_fft, symbol_idx)
    time_signal_with_cp = torch.cat([time_signal[-cp_length:], time_signal])
    
    <span class="hljs-keyword">return</span> time_signal_with_cp
</code></pre>
<h3 data-id="heading-11">🚀 自动求导信道估计 (<code>src/channel_estimation.py</code>)</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 核心逻辑：利用 backward() 自动计算 ∂Loss/∂h</span>
<span class="hljs-attr">h_hat.requires_grad</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 告诉 PyTorch 追踪梯度</span>
​
for i in range(n_iterations):
    <span class="hljs-attr">y_pred</span> = h_hat * x      <span class="hljs-comment"># 前向传播 (Forward)</span>
    <span class="hljs-attr">loss</span> = torch.mean(torch.abs(y - y_pred) ** <span class="hljs-number">2</span>) <span class="hljs-comment"># 计算 MSE</span>
    
    loss.backward()         <span class="hljs-comment"># 反向传播 (Backward) -&gt; 自动计算 h_hat.grad</span>
    
    with torch.no_grad():   <span class="hljs-comment"># 参数更新</span>
        h_hat <span class="hljs-attr">-</span>= lr * h_hat.grad
    h_hat.grad.zero_()      <span class="hljs-comment"># 梯度清零</span>
</code></pre>
<h2 data-id="heading-12">🎬 一键运行</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装依赖</span>
pip install -r requirements.txt
​
<span class="hljs-comment"># --- 阶段一：OFDM 系统演示 ---</span>
<span class="hljs-comment"># 生成标准星座图、频谱图、BER 曲线</span>
python examples/demo_nr_ofdm_ber.py
​
<span class="hljs-comment"># --- 阶段二：Autograd 信道估计 ---</span>
<span class="hljs-comment"># 演示梯度下降在通信中的应用</span>
python src/channel_estimation.py
</code></pre>
<h3 data-id="heading-13">输出预览</h3>
<pre><code class="hljs language-ini" lang="ini">============================================================
Stage 2: Autograd Channel Estimation <span class="hljs-attr">Demo</span>
============================================================
True channel <span class="hljs-attr">h</span> = (<span class="hljs-number">0.8000</span>+<span class="hljs-number">0.6000</span>j)
​
--- SGD Optimizer ---
Iter   10: <span class="hljs-attr">Loss</span>=<span class="hljs-number">0.021901</span>, h_hat=<span class="hljs-number">0.7299</span>+<span class="hljs-number">0.5556</span>j
Iter   50: <span class="hljs-attr">Loss</span>=<span class="hljs-number">0.010527</span>, h_hat=<span class="hljs-number">0.8026</span>+<span class="hljs-number">0.6003</span>j
Final <span class="hljs-attr">h_hat</span> = <span class="hljs-number">0.8026</span>+<span class="hljs-number">0.6003</span>j, Error = <span class="hljs-number">0.0026</span>
</code></pre>
<h2 data-id="heading-14">🖥️ 运行环境</h2>
<ul>
<li><strong>Python</strong>: 3.8+</li>
<li><strong>PyTorch</strong>: 1.10+ (推荐 2.0+)</li>
<li><strong>Matplotlib</strong>: 用于绘图</li>
</ul>
<h2 data-id="heading-15">🛒 获取方式</h2>
<p>关注公众号 <strong>【3GPP 仿真实验室】</strong>，后台回复关键词 <strong>【Pytorch】</strong> 即可获取完整工程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eced213a26334767aead708112b45f60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM0dQUOS7v-ecn-WunumqjOWupA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768633929&amp;x-signature=9wTq8g%2BsWLxbgUpCMaNpvC5m36c%3D" alt="constellation.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23b9a3c03b9540f8bcf870c40e4e8cb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM0dQUOS7v-ecn-WunumqjOWupA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768633929&amp;x-signature=qxi84v%2B861T3j5Oeqq0AYfid6Tc%3D" alt="all_constellations.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/738c1a9fcf4649b1a77b18d1e645964d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM0dQUOS7v-ecn-WunumqjOWupA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768633929&amp;x-signature=yMg5jZwGnZaPAjdcqRlWzC2iqe4%3D" alt="ber_curve.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a7ace5f8cfd44f199af1d4d4580f6ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM0dQUOS7v-ecn-WunumqjOWupA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768633929&amp;x-signature=qv67rvif9CSfgdYZ7lFkij3PzIk%3D" alt="channel_estimation.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发一个美观的 VitePress 图片预览插件]]></title>    <link>https://juejin.cn/post/7593215107406266404</link>    <guid>https://juejin.cn/post/7593215107406266404</guid>    <pubDate>2026-01-10T07:32:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593215107406266404" data-draft-id="7593215107406233636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发一个美观的 VitePress 图片预览插件"/> <meta itemprop="keywords" content="前端,Vue.js,VitePress"/> <meta itemprop="datePublished" content="2026-01-10T07:32:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="粥里有勺糖"/> <meta itemprop="url" content="https://juejin.cn/user/1028798615918983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发一个美观的 VitePress 图片预览插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1028798615918983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    粥里有勺糖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T07:32:50.000Z" title="Sat Jan 10 2026 07:32:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>笔者维护的 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftheme.sugarat.top%2F" target="_blank" title="https://theme.sugarat.top/" ref="nofollow noopener noreferrer">VitePress 博客主题</a>已经集成了非常多的功能，为便于在主题之外复用，因此有计划将其一部分功能分离出来，形成独立的插件。</p>
<p><em>现在又有AI加持，再已经有通用插件模板前提下，使用AI就能完成95%的插件工作量！</em></p>
<p>分离的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fvitepress-plugin-image-preview" target="_blank" title="https://www.npmjs.com/package/vitepress-plugin-image-preview" ref="nofollow noopener noreferrer">图片预览插件</a>，效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5716412c82f34f9694069c8db798d097~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768635170&amp;x-signature=PohUBeKkEL54FWb625e8R8nRL%2B0%3D" alt="" loading="lazy"/></p>
<p>组件样式实现参考了 <a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2Fzh-CN%2Fcomponent%2Fimage%23%25E5%259B%25BE%25E7%2589%2587%25E9%25A2%2584%25E8%25A7%2588" target="_blank" title="https://element-plus.org/zh-CN/component/image#%E5%9B%BE%E7%89%87%E9%A2%84%E8%A7%88" ref="nofollow noopener noreferrer">Element Plus Image Viewer</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ba9582679804ff29a4d26bbbb40d39e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768635170&amp;x-signature=zfv4X7pXrzJB8Gflzwf9yvQGW0I%3D" alt="" loading="lazy"/></p>
<p>接下来先简单介绍一下用法，再快速讲解核心原理。</p>
<p>插件开发基于之前创建的一个通用模板，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FATQQ%2Fsugar-blog%2Ftree%2Fmaster%2Ftemplate%2Fvitepress-plugin-slot-inject-template" target="_blank" title="https://github.com/ATQQ/sugar-blog/tree/master/template/vitepress-plugin-slot-inject-template" ref="nofollow noopener noreferrer">vitepress-plugin-slot-inject-template</a>，在模板的基础上，<strong>插件95%的代码由 Gemini 3.0 生成。</strong></p>
<h2 data-id="heading-1">如何使用</h2>
<p><em>只需要 2 步：</em></p>
<ol>
<li>安装插件</li>
</ol>
<pre><code class="hljs language-sh" lang="sh">pnpm add vitepress-plugin-image-preview
</code></pre>
<ol start="2">
<li>配置插件</li>
</ol>
<p>引入插件在 <code>.vitepress/config.mts</code> VitePress 配置文件中</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitepress'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ImagePreviewPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitepress-plugin-image-preview'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">vite</span>: {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-title class_">ImagePreviewPlugin</span>()
    ]
  }
})
</code></pre>
<h2 data-id="heading-2">实现原理</h2>
<p><em>这里只阐述关键点，细节与之前的<a href="https://juejin.cn/post/7416625208766988324?searchId=20260110152755960C86037BF7AA755194" target="_blank" title="https://juejin.cn/post/7416625208766988324?searchId=20260110152755960C86037BF7AA755194">公告插件</a>类似，这里不做赘述。</em></p>
<p>VitePress 默认主题 <code>Layout.vue</code> 组件预设的一些插槽，只需将实现自定义组件注入到对应插槽为止即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369cfde9363a46bd88230c19463645a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768635170&amp;x-signature=g7If%2Fgct80uAmulWBK3fCHUZfCc%3D" alt="" loading="lazy"/></p>
<p>所有的 <code>slots</code> 在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvitepress.dev%2Fguide%2Fextending-default-theme%23layout-slots" target="_blank" title="https://vitepress.dev/guide/extending-default-theme#layout-slots" ref="nofollow noopener noreferrer">VitePress 文档里也有介绍</a></p>
<h3 data-id="heading-3">注入自定义组件</h3>
<p>利用插件的 <code>transform</code> 钩子，将我们的 <code>&lt;ImagePreview /&gt;</code> 组件插入到 <code>Layout.vue</code> 的特定插槽位置</p>
<p>图片预览组件我这里使用的是 <code>doc-before</code> 和 <code>page-top</code> 两个插槽。</p>
<p>使用 alias 保证引入组件的路径正确映射。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 仅包含关键代码</span>
<span class="hljs-keyword">const</span> componentName = <span class="hljs-string">'ImagePreview'</span>
<span class="hljs-keyword">const</span> componentFile = <span class="hljs-string">`<span class="hljs-subst">${componentName}</span>.vue`</span>
<span class="hljs-keyword">const</span> aliasComponentFile = <span class="hljs-string">`<span class="hljs-subst">${getDirname()}</span>/components/<span class="hljs-subst">${componentFile}</span>`</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImagePreviewPlugin</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 添加alias</span>
    <span class="hljs-attr">config</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">resolve</span>: {
          <span class="hljs-attr">alias</span>: {
            [<span class="hljs-string">`./<span class="hljs-subst">${componentFile}</span>`</span>]: aliasComponentFile
          }
        }
      }
    },
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-comment">// 筛选出 Layout.vue</span>
      <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'vitepress/dist/client/theme-default/Layout.vue'</span>)) {
        <span class="hljs-keyword">let</span> transformResult = code

        <span class="hljs-comment">// 插入组件</span>
        <span class="hljs-keyword">const</span> slots = [options.<span class="hljs-property">slots</span> || [<span class="hljs-string">'doc-before'</span>, <span class="hljs-string">'page-top'</span>]].<span class="hljs-title function_">flat</span>()
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> slot <span class="hljs-keyword">of</span> slots) {
          <span class="hljs-keyword">const</span> slotPosition = <span class="hljs-string">`&lt;slot name="<span class="hljs-subst">${slot}</span>" /&gt;`</span>
          <span class="hljs-comment">// 添加 ClientOnly 目的是避免组件在SSG的时候被渲染</span>
          transformResult = transformResult.<span class="hljs-title function_">replace</span>(slotPosition, <span class="hljs-string">`<span class="hljs-subst">${slotPosition}</span>\n&lt;ClientOnly&gt;&lt;<span class="hljs-subst">${componentName}</span> /&gt;&lt;/ClientOnly&gt;`</span>)
        }

        <span class="hljs-comment">// 导入组件</span>
        <span class="hljs-keyword">const</span> setupPosition = <span class="hljs-string">'&lt;script setup lang="ts"&gt;'</span>
        transformResult = transformResult.<span class="hljs-title function_">replace</span>(setupPosition, <span class="hljs-string">`<span class="hljs-subst">${setupPosition}</span>\nimport <span class="hljs-subst">${componentName}</span> from './<span class="hljs-subst">${componentFile}</span>'`</span>)
        <span class="hljs-keyword">return</span> transformResult
      }
    },
  }
}
</code></pre>
<h3 data-id="heading-4">插件配置传递</h3>
<p>采用虚拟模块的方式传递配置。</p>
<p>组件中导入配置：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> options <span class="hljs-keyword">from</span> <span class="hljs-string">'virtual:image-preview-options'</span>
</code></pre>
<p>插件中处理虚拟模块：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> virtualModuleId = <span class="hljs-string">'virtual:image-preview-options'</span>
<span class="hljs-keyword">const</span> resolvedVirtualModuleId = <span class="hljs-string">`\0<span class="hljs-subst">${virtualModuleId}</span>`</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImagePreviewPlugin</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 省略其它无关代码...</span>
    <span class="hljs-title function_">resolveId</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">if</span> (id === virtualModuleId) {
        <span class="hljs-keyword">return</span> resolvedVirtualModuleId
      }
    },
    <span class="hljs-title function_">load</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>, id</span>) {
      <span class="hljs-keyword">if</span> (id === resolvedVirtualModuleId) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`export default <span class="hljs-subst">${stringify(options)}</span>`</span>
      }
    },
  }
}
</code></pre>
<h3 data-id="heading-5">核心交互实现</h3>
<p>图片预览的核心逻辑在于监听图片的点击事件，获取图片列表，并显示预览遮罩。</p>
<ol>
<li><strong>事件监听</strong>：在 <code>onMounted</code>时，给内容的容器注册点击事件，在点击的时候获取容器中所有的图片元素，然后做后续操作。</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapperId = imagePreviewOptions?.<span class="hljs-property">wrapperId</span> || <span class="hljs-string">'#VPContent'</span>
  <span class="hljs-keyword">const</span> docDomContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(wrapperId)
  docDomContainer?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, previewImage)
})

<span class="hljs-keyword">function</span> <span class="hljs-title function_">previewImage</span>(<span class="hljs-params">e: Event</span>) {
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>
  <span class="hljs-keyword">const</span> currentTarget = e.<span class="hljs-property">currentTarget</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>
  <span class="hljs-keyword">if</span> (target.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>() === <span class="hljs-string">'img'</span>) {
    <span class="hljs-keyword">const</span> selector = imagePreviewOptions?.<span class="hljs-property">selector</span> || <span class="hljs-string">'.content-container .main img,.VPPage img'</span>
    <span class="hljs-keyword">const</span> imgs = currentTarget.<span class="hljs-property">querySelectorAll</span>&lt;<span class="hljs-title class_">HTMLImageElement</span>&gt;(selector)
    <span class="hljs-keyword">const</span> idx = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(imgs).<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el === target)
    <span class="hljs-keyword">const</span> urls = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(imgs).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el.<span class="hljs-property">src</span>)
    <span class="hljs-comment">// 省略其它逻辑</span>
  }
}
</code></pre>
<ol start="2">
<li><strong>预览组件</strong>：参考了 <a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2Fzh-CN%2Fcomponent%2Fimage%23%25E5%259B%25BE%25E7%2589%2587%25E9%25A2%2584%25E8%25A7%2588" target="_blank" title="https://element-plus.org/zh-CN/component/image#%E5%9B%BE%E7%89%87%E9%A2%84%E8%A7%88" ref="nofollow noopener noreferrer">Element Plus 的 图片预览组件</a>的样式与功能，这部分完全由 AI 实现(Gemini 3.0)，还原度非常高。</li>
</ol>
<h2 data-id="heading-6">插件模板介绍</h2>
<p>在开发插件的过程中，笔者把此类基于 slot 位置注入的插件分离了一个模板 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FATQQ%2Fsugar-blog%2Ftree%2Fmaster%2Ftemplate%2Fvitepress-plugin-slot-inject-template" target="_blank" title="https://github.com/ATQQ/sugar-blog/tree/master/template/vitepress-plugin-slot-inject-template" ref="nofollow noopener noreferrer">vitepress-plugin-slot-inject-template</a></p>
<p>有相关诉求的朋友，可以基于此模板，配合 AI 快速的开发各种基于插槽就可以实现的组件能力。</p>
<h2 data-id="heading-7">最后</h2>
<p>插件完整源码 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FATQQ%2Fsugar-blog%2Ftree%2Fmaster%2Fpackages%2Fvitepress-plugin-image-preview" target="_blank" title="https://github.com/ATQQ/sugar-blog/tree/master/packages/vitepress-plugin-image-preview" ref="nofollow noopener noreferrer">vitepress-plugin-image-preview</a></p>
<p><strong>最后再感叹一句，AI 太牛逼了，效率起飞。</strong></p>
<p><em>欢迎评论区交流&amp;指导。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小程序上线半年我赚了多少钱？]]></title>    <link>https://juejin.cn/post/7593338828196626472</link>    <guid>https://juejin.cn/post/7593338828196626472</guid>    <pubDate>2026-01-10T07:17:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593338828196626472" data-draft-id="7593338828196560936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小程序上线半年我赚了多少钱？"/> <meta itemprop="keywords" content="微信小程序,产品,创业"/> <meta itemprop="datePublished" content="2026-01-10T07:17:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是江迪呀"/> <meta itemprop="url" content="https://juejin.cn/user/4468854131529624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小程序上线半年我赚了多少钱？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4468854131529624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是江迪呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T07:17:26.000Z" title="Sat Jan 10 2026 07:17:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.  开发历程</h2>
<p>时间过得真快，转眼间福猪记账小程序上线已经有半年时间了，从v1.0.0 版本做到了 v1.6.1 版本。今天整理了开发日志，真的不敢相信自己在工作之余能够把它做出来并上线。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4481b17d01fd4fde8ae549bf7dbde51f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5rGf6L-q5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634245&amp;x-signature=GytMq8NGwZ8YIPQMv35X2cKeqMc%3D" alt="2026-01-10-14-22-50.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6df6d61fc874a2e8c418ac0735d0e54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5rGf6L-q5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634245&amp;x-signature=WRZdXBpYzhCUSudb6RS4GkXMa%2B4%3D" alt="2026-01-10-14-23-15.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc19b58cd0d44e46a135776fc3dae679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5rGf6L-q5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634245&amp;x-signature=DHGOSISxo3cK4Spj2a8obB7UH9Y%3D" alt="2026-01-10-14-23-23.png" loading="lazy"/></p>
<h2 data-id="heading-1">2.用户积累</h2>
<p>到目前2026年1月10日为止，已经积累了872位用户，感谢你们的使用和支持！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd97bec4dcb34fc1b42fe923506f6d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5rGf6L-q5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634245&amp;x-signature=WEB%2BY%2BGo7JI1JjH0iuhHd855dXg%3D" alt="2026-01-10-14-23-32.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f3ef7ace934209abcaa97ba6a419e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5rGf6L-q5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634245&amp;x-signature=5qfvFySWfbX8%2B4Kedcs1GnQUSmo%3D" alt="2026-01-10-14-23-42.png" loading="lazy"/></p>
<p>我在小程序上线后也没怎么宣传，只写了一篇公众号有1200多浏览量，然后全靠自然流量。虽然用户增长数据可观，但是留存数据不容乐观，从之前的日活：70多人到现在稳定在10几人。这也让我怀疑是不是我做的东西不好用，帮助不了用户，为了
防止闭门造车
我会积极听取身边朋友和用户的反馈和建议，作出调整优化，
让它越来越好
。
无论未来如何，这个项目我会一直更新迭代下去，
服务更多的用户，它是我的第一个完整的作品，同时也是我迈出独立开发的第一步！我一定会认真对待。</p>
<h2 data-id="heading-2">3.  收益</h2>
<p>目前收益途径仅有流量主，功能全部是免费的。为了不影响用户的体验在流量主开通后，我只引入了开屏广告。目前流量主开通了3个月，一共收入69.32。平均每天是0.4左右，收益等于没有，哈哈。没有收益的软件如同无源之水，无根之木，是不长久的，也容易让用户产生我会随时跑路的担忧，我的计划是等我把福猪记账做得更完整更好的时候，再推出VIP功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4132df94c514f96971c1077fe8a346b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5rGf6L-q5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768634245&amp;x-signature=7ueG3LtfKdrzz8SG4WtczDrqvbw%3D" alt="2026-01-10-14-24-02.png" loading="lazy"/></p>
<h2 data-id="heading-3">4.感悟</h2>
<p>开发福猪记账是我迈向独立开发的第一步，让我意识到做demo和做产品有着云泥之别。从能看的demo，做到能用，再从能用做到好用，是需要动脑子，下功夫的。需要考虑很多东西比如UI设计、用户体验、用户引导、功能测试等等。眼高手低是我常犯的一个错误，也是我要尽快克服的毛病，避免完美主义，完美的前提是完成。</p>
<p>做独立开发，要缩小程序员思维占的位置，要将产品思维、运营思维加入进来。在公司上班，你只需要关注你的一亩三分地即可，功能实现了没问题你就可以点杯咖啡开始划水了。但是独立开发不行，你要既当爹又当妈，不要太过于注重代码写的是否美观、健壮，也不要上来就用这个框架、那个技术、设计模式、算法咔咔一通乱整。前期一定要避免这样，不然精力很快就会被耗尽，你需要考虑的是什么可以让你的功能快速实现并上线！别管白猫黑猫逮到耗子就是好猫。</p>
<p>AI真的改变了我们的开发模式，它帮我节省了大量开发的时间，我们应该积极拥抱这种变化。我敢说如果没有AI的协助，我这个项目至少要双倍的时间来完成，甚至完不成！但是也不像网上说的那样离谱，一句话AI就可以给你做出一款APP，那不现实，即使做出来也存在很多问题，需要大量时间调整修复。通过这段时间和AI协作开发，我发现AI的能力的天花板其是你个人能力的天花板，你强AI就强，你就像是一个指挥官，AI帮你干活，但是如果你能力不行专业知识不够，瞎指挥，AI也变得傻乎乎的，它做不出来你脑子里面没有东西！在AI迅速发展的时代，我应该着重培养自己的思维能力：代码思维、产品思维。我记得一句话是这样说的：代码是在你脑海中形成的，只要思路正确，写代码只是一个堆砌的过程。现在AI帮我做了写代码这一步，那么我们就应该学会如何将脑海中的思维清晰的表述出来，让AI听得懂，并且按照我们的思路去做。</p>
<p>最重要的永远在最后：产品定位和运营宣传，你东西做的再好没人知道也是不行的。产品定位很重要，如果你选择的是红海领域比如记账，这个类型的应用随便一搜索就不下10几20个，要从头部app中抢流量这太难了，但是我们再仔细想一个问题：为什么记账app已经那么多了，偶尔还是会出现一两款记账软件呢？我的答案是：没有一款软件可以满足所有用户的需求！比如我就是其中之一，我相信肯定也有其他人和我一样，所以我要做到差异化，如果只是想复刻别人产品那是行不通的，差异化可以是功能、UI、交互。避免大而全，专注小而美，聚焦某一类特定的用户需求，才是破局之道。至于宣传，没有钱来投广告那就靠自己，除了在各大平台发文章宣传方式外别无他法，这种冷启动实是无奈之举，这也更加体现了打造个人IP的重要性。</p>
<p>独立开发是一条夜路，没有目标、没有终点，一切都是未知数，但是我喜欢未知数，这表示我的生活有着无限的可能！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[webpack/vite配置]]></title>    <link>https://juejin.cn/post/7593215107406250020</link>    <guid>https://juejin.cn/post/7593215107406250020</guid>    <pubDate>2026-01-10T07:28:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593215107406250020" data-draft-id="7593145583348940842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="webpack/vite配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-10T07:28:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不务正业的前端学徒"/> <meta itemprop="url" content="https://juejin.cn/user/1640911047494430"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            webpack/vite配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1640911047494430/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不务正业的前端学徒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T07:28:29.000Z" title="Sat Jan 10 2026 07:28:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">webpack配置</h3>
<p><strong>webpack.base.cjs</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导入 Node.js 内置的 path 模块，用于处理文件路径</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-comment">// 导入 vue-loader 插件，用于处理 .vue 文件</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">VueLoaderPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vue-loader'</span>);
<span class="hljs-comment">// 导入 HtmlWebpackPlugin，用于生成 HTML 文件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);
<span class="hljs-comment">// 导入 unplugin-auto-import 的 webpack 版本，用于自动导入 Vue 组合式 API</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AutoImport</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'unplugin-auto-import/webpack'</span>);
<span class="hljs-comment">// 导入 unplugin-vue-components 的 webpack 版本，用于自动导入 Vue 组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Components</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'unplugin-vue-components/webpack'</span>);
<span class="hljs-comment">// 导入 ElementPlusResolver，用于自动导入 Element Plus 组件和样式</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">ElementPlusResolver</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'unplugin-vue-components/resolvers'</span>);

<span class="hljs-comment">// 导出 webpack 配置对象</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-comment">// 入口文件配置</span>
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/main.ts'</span>,

    <span class="hljs-comment">// 输出配置</span>
    <span class="hljs-attr">output</span>: {
        <span class="hljs-comment">// 输出目录，使用绝对路径</span>
        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),
    },

    <span class="hljs-comment">// 解析配置</span>
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-comment">// 路径别名配置</span>
        <span class="hljs-attr">alias</span>: {
            <span class="hljs-comment">// 将 @ 别名指向 src 目录</span>
            <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
        },
        <span class="hljs-comment">// 自动解析的扩展名列表，这样导入时可以省略扩展名</span>
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>, <span class="hljs-string">'.vue'</span>, <span class="hljs-string">'.json'</span>],
    },

    <span class="hljs-comment">// 插件配置</span>
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-comment">// 自动导入配置</span>
        <span class="hljs-title class_">AutoImport</span>({
            <span class="hljs-comment">// 解析器配置，使用 ElementPlusResolver 自动导入 Element Plus</span>
            <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()],
        }),
        <span class="hljs-comment">// 自动组件导入配置</span>
        <span class="hljs-title class_">Components</span>({
            <span class="hljs-comment">// 解析器配置，使用 ElementPlusResolver 自动导入 Element Plus 组件</span>
            <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()],
        }),
        <span class="hljs-comment">// VueLoaderPlugin 必须配置，用于编译 Vue 单文件组件</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueLoaderPlugin</span>(),
        <span class="hljs-comment">// HtmlWebpackPlugin 配置，用于生成 HTML 文件</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
            <span class="hljs-comment">// 使用 public/index.html 作为模板</span>
            <span class="hljs-attr">template</span>: <span class="hljs-string">'./public/index.html'</span>,
        }),
    ],

    <span class="hljs-comment">// 模块配置</span>
    <span class="hljs-attr">module</span>: {
        <span class="hljs-comment">// 规则配置，用于处理不同类型的文件</span>
        <span class="hljs-attr">rules</span>: [
            <span class="hljs-comment">// 处理 .vue 文件的规则</span>
            {
                <span class="hljs-comment">// 匹配 .vue 文件</span>
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,
                <span class="hljs-comment">// 使用 vue-loader 处理</span>
                <span class="hljs-attr">loader</span>: <span class="hljs-string">'vue-loader'</span>,
                <span class="hljs-comment">// vue-loader 选项配置</span>
                <span class="hljs-attr">options</span>: {
                    <span class="hljs-comment">// 编译器选项</span>
                    <span class="hljs-attr">compilerOptions</span>: {
                        <span class="hljs-comment">// 不保留空格，减小文件体积</span>
                        <span class="hljs-attr">preserveWhitespace</span>: <span class="hljs-literal">false</span>,
                    },
                },
            },
            <span class="hljs-comment">// 处理 .ts 文件的规则</span>
            {
                <span class="hljs-comment">// 匹配 .ts 文件</span>
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.ts$/</span>,
                <span class="hljs-comment">// 排除 node_modules 目录</span>
                <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
                <span class="hljs-comment">// 使用多个 loader 处理</span>
                <span class="hljs-attr">use</span>: [
                    <span class="hljs-comment">// 首先使用 babel-loader 处理</span>
                    {
                        <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
                        <span class="hljs-comment">// babel-loader 选项</span>
                        <span class="hljs-attr">options</span>: {
                            <span class="hljs-comment">// 使用 @babel/preset-env 预设，将 ES6+ 转换为 ES5</span>
                            <span class="hljs-attr">presets</span>: [<span class="hljs-string">'@babel/preset-env'</span>],
                            <span class="hljs-comment">// 使用 @babel/plugin-transform-runtime 插件，避免重复注入 helper 函数</span>
                            <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'@babel/plugin-transform-runtime'</span>],
                        },
                    },
                    <span class="hljs-comment">// 然后使用 ts-loader 处理</span>
                    {
                        <span class="hljs-attr">loader</span>: <span class="hljs-string">'ts-loader'</span>,
                        <span class="hljs-comment">// ts-loader 选项</span>
                        <span class="hljs-attr">options</span>: {
                            <span class="hljs-comment">// 为 .vue 文件添加 .ts 后缀，以便 ts-loader 处理</span>
                            <span class="hljs-attr">appendTsSuffixTo</span>: [<span class="hljs-regexp">/\.vue$/</span>],
                            <span class="hljs-comment">// 只进行转译，不进行类型检查，提高构建速度</span>
                            <span class="hljs-attr">transpileOnly</span>: <span class="hljs-literal">true</span>,
                        },
                    },
                ],
            },
            <span class="hljs-comment">// 处理 .js 文件的规则</span>
            {
                <span class="hljs-comment">// 匹配 .js 文件</span>
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
                <span class="hljs-comment">// 排除 node_modules 目录</span>
                <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
                <span class="hljs-comment">// 使用 babel-loader 处理</span>
                <span class="hljs-attr">use</span>: {
                    <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
                    <span class="hljs-comment">// babel-loader 选项</span>
                    <span class="hljs-attr">options</span>: {
                        <span class="hljs-comment">// 使用 @babel/preset-env 预设，将 ES6+ 转换为 ES5</span>
                        <span class="hljs-attr">presets</span>: [<span class="hljs-string">'@babel/preset-env'</span>],
                        <span class="hljs-comment">// 使用 @babel/plugin-transform-runtime 插件，避免重复注入 helper 函数</span>
                        <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'@babel/plugin-transform-runtime'</span>],
                    },
                },
            },
            <span class="hljs-comment">// 处理 .css 文件的规则</span>
            {
                <span class="hljs-comment">// 匹配 .css 文件</span>
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
                <span class="hljs-comment">// 使用 style-loader 和 css-loader 处理</span>
                <span class="hljs-comment">// 执行顺序：从右到左，先使用 css-loader 解析 CSS，再使用 style-loader 将 CSS 插入到页面</span>
                <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>],
            },
            <span class="hljs-comment">// 处理 .scss 和 .sass 文件的规则</span>
            {
                <span class="hljs-comment">// 匹配 .scss 和 .sass 文件</span>
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.s[ac]ss$/i</span>,
                <span class="hljs-comment">// 使用 style-loader、css-loader 和 sass-loader 处理</span>
                <span class="hljs-comment">// 执行顺序：从右到左，先使用 sass-loader 编译 Sass，再使用 css-loader 解析 CSS，最后使用 style-loader 将 CSS 插入到页面</span>
                <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>, <span class="hljs-string">'sass-loader'</span>],
            },
            <span class="hljs-comment">// 处理图片文件的规则</span>
            {
                <span class="hljs-comment">// 匹配 png、jpg、jpeg、gif 和 webp 格式的图片文件</span>
                <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpe?g|gif|webp)$/i</span>,
                <span class="hljs-comment">// 使用 file-loader 处理，将图片文件复制到输出目录并返回文件路径</span>
                <span class="hljs-attr">use</span>: <span class="hljs-string">'file-loader'</span>,
            },
        ],
    },
};

</code></pre>
<p><strong>webpack.dev.cjs</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导入 webpack-merge 模块，用于合并 webpack 配置</span>
<span class="hljs-keyword">const</span> { merge } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-merge'</span>);
<span class="hljs-comment">// 导入基础配置文件</span>
<span class="hljs-keyword">const</span> baseConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.base.cjs'</span>);
<span class="hljs-comment">// 导入 Node.js 内置的 path 模块，用于处理文件路径</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-comment">// 合并基础配置和开发环境配置</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">merge</span>(baseConfig, {
    <span class="hljs-comment">// 模式设置为开发环境</span>
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,

    <span class="hljs-comment">// 输出配置</span>
    <span class="hljs-attr">output</span>: {
        <span class="hljs-comment">// 输出文件名，开发环境使用简单的 bundle.js</span>
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'bundle.js'</span>,
    },

    <span class="hljs-comment">// 开发工具配置，用于生成 source map</span>
    <span class="hljs-comment">// eval-cheap-module-source-map 能在开发时提供较好的性能和调试体验</span>
    <span class="hljs-attr">devtool</span>: <span class="hljs-string">'eval-cheap-module-source-map'</span>,

    <span class="hljs-comment">// 开发服务器配置</span>
    <span class="hljs-attr">devServer</span>: {
        <span class="hljs-comment">// 静态文件目录配置</span>
        <span class="hljs-attr">static</span>: {
            <span class="hljs-comment">// 指定 public 目录为静态文件目录</span>
            <span class="hljs-attr">directory</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'public'</span>),
        },
        <span class="hljs-comment">// 是否启用 gzip 压缩</span>
        <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 开发服务器端口</span>
        <span class="hljs-attr">port</span>: <span class="hljs-number">8000</span>,
        <span class="hljs-comment">// 是否启用热模块替换（HMR）</span>
        <span class="hljs-attr">hot</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 构建完成后是否自动打开浏览器</span>
        <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 客户端配置</span>
        <span class="hljs-attr">client</span>: {
            <span class="hljs-comment">// 错误和警告的覆盖层配置</span>
            <span class="hljs-attr">overlay</span>: {
                <span class="hljs-comment">// 显示错误覆盖层</span>
                <span class="hljs-attr">errors</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-comment">// 不显示警告覆盖层</span>
                <span class="hljs-attr">warnings</span>: <span class="hljs-literal">false</span>,
            },
        },
        <span class="hljs-comment">// 支持 SPA 路由，所有 404 请求都会返回 index.html</span>
        <span class="hljs-attr">historyApiFallback</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 代理配置，用于将 API 请求代理到后端服务器</span>
        <span class="hljs-attr">proxy</span>: [
            {
                <span class="hljs-comment">// 匹配需要代理的路径</span>
                <span class="hljs-attr">context</span>: [<span class="hljs-string">'/test'</span>],
                <span class="hljs-comment">// 代理目标地址</span>
                <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
                <span class="hljs-comment">// 是否验证 SSL 证书</span>
                <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-comment">// 是否修改请求头中的 Origin</span>
                <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-comment">// 路径重写配置（当前已注释）</span>
                <span class="hljs-comment">// pathRewrite: {</span>
                <span class="hljs-comment">//     '^/api': ''</span>
                <span class="hljs-comment">// }</span>
            },
        ],
    },

    <span class="hljs-comment">// 优化配置</span>
    <span class="hljs-attr">optimization</span>: {
        <span class="hljs-comment">// 启用 tree shaking，只打包使用到的代码</span>
        <span class="hljs-attr">usedExports</span>: <span class="hljs-literal">true</span>,
    },
});

</code></pre>
<p><strong>webpack.prod.cjs</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导入 webpack-merge 模块，用于合并 webpack 配置</span>
<span class="hljs-keyword">const</span> { merge } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-merge'</span>);
<span class="hljs-comment">// 导入基础配置文件</span>
<span class="hljs-keyword">const</span> baseConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./webpack.base.cjs'</span>);
<span class="hljs-comment">// 导入 TerserPlugin，用于压缩 JavaScript 代码</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'terser-webpack-plugin'</span>);
<span class="hljs-comment">// 导入 CssMinimizerPlugin，用于压缩 CSS 代码</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CssMinimizerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'css-minimizer-webpack-plugin'</span>);
<span class="hljs-comment">// 导入 BundleAnalyzerPlugin，用于分析打包后的文件结构和大小</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">BundleAnalyzerPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-bundle-analyzer'</span>);

<span class="hljs-comment">// 合并基础配置和生产环境配置</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">merge</span>(baseConfig, {
    <span class="hljs-comment">// 模式设置为生产环境</span>
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,

    <span class="hljs-comment">// 输出配置</span>
    <span class="hljs-attr">output</span>: {
        <span class="hljs-comment">// 输出文件名，使用 contenthash 确保文件内容变化时文件名变化，有利于缓存</span>
        <span class="hljs-attr">filename</span>: <span class="hljs-string">'bundle.[contenthash].js'</span>,
        <span class="hljs-comment">// 构建前清理输出目录</span>
        <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-attr">devtool</span>: <span class="hljs-string">'hidden-source-map'</span>,
    <span class="hljs-comment">// 优化配置</span>
    <span class="hljs-attr">optimization</span>: {
        <span class="hljs-comment">// 启用代码压缩</span>
        <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 配置压缩器</span>
        <span class="hljs-attr">minimizer</span>: [
            <span class="hljs-comment">// JavaScript 压缩器配置</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
                <span class="hljs-comment">// Terser 配置选项</span>
                <span class="hljs-attr">terserOptions</span>: {
                    <span class="hljs-comment">// 压缩配置</span>
                    <span class="hljs-attr">compress</span>: {
                        <span class="hljs-comment">// 删除所有 console 语句</span>
                        <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>,
                        <span class="hljs-comment">// 删除所有 debugger 语句</span>
                        <span class="hljs-attr">drop_debugger</span>: <span class="hljs-literal">true</span>,
                    },
                },
            }),
            <span class="hljs-comment">// CSS 压缩器</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>(),
            <span class="hljs-comment">// 打包分析工具配置</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>({
                <span class="hljs-comment">// 分析模式设置为静态文件</span>
                <span class="hljs-attr">analyzerMode</span>: <span class="hljs-string">'static'</span>,
                <span class="hljs-comment">// 不自动打开分析报告</span>
                <span class="hljs-attr">openAnalyzer</span>: <span class="hljs-literal">false</span>,
            }),
        ],
        <span class="hljs-comment">// 代码分割配置</span>
        <span class="hljs-attr">splitChunks</span>: {
            <span class="hljs-comment">// 对所有类型的 chunk 进行拆分（包括异步和同步）</span>
            <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
            <span class="hljs-comment">// 控制生成 chunk 的最小大小（20KB）</span>
            <span class="hljs-attr">minSize</span>: <span class="hljs-number">20000</span>,
            <span class="hljs-comment">// 剩余大小的最小值，确保拆分后剩余部分不会过小</span>
            <span class="hljs-attr">minRemainingSize</span>: <span class="hljs-number">0</span>,
            <span class="hljs-comment">// 模块被引用的最小次数</span>
            <span class="hljs-attr">minChunks</span>: <span class="hljs-number">1</span>,
            <span class="hljs-comment">// 异步加载时的最大请求数</span>
            <span class="hljs-attr">maxAsyncRequests</span>: <span class="hljs-number">30</span>,
            <span class="hljs-comment">// 初始加载时的最大请求数</span>
            <span class="hljs-attr">maxInitialRequests</span>: <span class="hljs-number">30</span>,
            <span class="hljs-comment">// 强制执行大小阈值（50KB），超过此值的 chunk 会被强制拆分</span>
            <span class="hljs-attr">enforceSizeThreshold</span>: <span class="hljs-number">50000</span>,
            <span class="hljs-comment">// 缓存组配置，用于将不同类型的模块分割到不同的 chunk 中</span>
            <span class="hljs-attr">cacheGroups</span>: {
                <span class="hljs-comment">// Element Plus 组件库缓存组</span>
                <span class="hljs-attr">elementPlus</span>: {
                    <span class="hljs-comment">// 输出文件名</span>
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'element-plus'</span>,
                    <span class="hljs-comment">// 匹配 Element Plus 模块</span>
                    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\/]node_modules[\/]element-plus[\/]/</span>,
                    <span class="hljs-comment">// 优先级，数字越大优先级越高</span>
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>,
                    <span class="hljs-comment">// 对所有类型的 chunk 生效</span>
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
                    <span class="hljs-comment">// 重用已存在的 chunk，避免重复打包</span>
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                },
                <span class="hljs-comment">// Vue Router 路由库缓存组</span>
                <span class="hljs-attr">vueRouter</span>: {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'vue-router'</span>,
                    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\/]node_modules[\/]vue-router[\/]/</span>,
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>,
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                },
                <span class="hljs-comment">// Pinia 状态管理库缓存组</span>
                <span class="hljs-attr">pinia</span>: {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'pinia'</span>,
                    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\/]node_modules[\/]pinia[\/]/</span>,
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>,
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                },
                <span class="hljs-comment">// Axios HTTP 客户端库缓存组</span>
                <span class="hljs-attr">axios</span>: {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'axios'</span>,
                    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\/]node_modules[\/]axios[\/]/</span>,
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>,
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                },
                <span class="hljs-comment">// Vue 核心库缓存组</span>
                <span class="hljs-attr">vue</span>: {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'vue'</span>,
                    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\/]node_modules[\/]vue[\/]/</span>,
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>,
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                },
                <span class="hljs-comment">// VueUse 工具库缓存组</span>
                <span class="hljs-attr">vueUse</span>: {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'vue-use'</span>,
                    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\/]node_modules[\/]@vueuse[\/]/</span>,
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>,
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                },
                <span class="hljs-comment">// 公共代码缓存组</span>
                <span class="hljs-attr">common</span>: {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'common'</span>,
                    <span class="hljs-comment">// 至少被引用 2 次的模块才会被打包到这个 chunk</span>
                    <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">5</span>,
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                },
                <span class="hljs-comment">// 其他第三方依赖缓存组</span>
                <span class="hljs-attr">vendors</span>: {
                    <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
                    <span class="hljs-comment">// 匹配所有 node_modules 中的模块</span>
                    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\/]node_modules[\/]/</span>,
                    <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>,
                    <span class="hljs-comment">// 只对初始加载的 chunk 生效</span>
                    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'initial'</span>,
                    <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-comment">// 强制执行缓存组，即使不符合其他条件</span>
                    <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>,
                },
            },
        },
        <span class="hljs-comment">// 运行时代码分割配置</span>
        <span class="hljs-attr">runtimeChunk</span>: {
            <span class="hljs-comment">// 运行时代码的输出文件名</span>
            <span class="hljs-attr">name</span>: <span class="hljs-string">'runtime'</span>,
        },
    },
});

</code></pre>
<h3 data-id="heading-1">vite配置</h3>
<p><strong>vite.base.ts</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导入Vite的defineConfig函数，用于定义Vite配置</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-comment">// 导入Vue插件，用于支持Vue组件</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;
<span class="hljs-comment">// 导入自动导入插件，用于自动导入Vue API和其他库</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>;
<span class="hljs-comment">// 导入组件自动注册插件，用于自动注册Vue组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>;
<span class="hljs-comment">// 导入Element Plus解析器，用于自动导入Element Plus组件和API</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElementPlusResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>;
<span class="hljs-comment">// 导入Node.js的path模块，用于处理文件路径</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-comment">// 导出公共配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
    <span class="hljs-comment">// 设置项目基础路径，使用相对路径</span>
    <span class="hljs-attr">base</span>: <span class="hljs-string">'./'</span>,

    <span class="hljs-comment">// 配置Vite插件</span>
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-comment">// 使用Vue插件</span>
        <span class="hljs-title function_">vue</span>(),

        <span class="hljs-comment">// 配置自动导入插件</span>
        <span class="hljs-title class_">AutoImport</span>({
            <span class="hljs-comment">// 使用Element Plus解析器</span>
            <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()],
            <span class="hljs-comment">// 生成类型声明文件</span>
            <span class="hljs-attr">dts</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-comment">// 自动导入的库</span>
            <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>, <span class="hljs-string">'pinia'</span>],
        }),

        <span class="hljs-comment">// 配置组件自动注册插件</span>
        <span class="hljs-title class_">Components</span>({
            <span class="hljs-comment">// 使用Element Plus解析器</span>
            <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()],
            <span class="hljs-comment">// 生成类型声明文件</span>
            <span class="hljs-attr">dts</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-comment">// 组件所在目录</span>
            <span class="hljs-attr">dirs</span>: [<span class="hljs-string">'./src/components'</span>],
        }),
    ],

    <span class="hljs-comment">// 配置模块解析</span>
    <span class="hljs-attr">resolve</span>: {
        <span class="hljs-comment">// 配置路径别名</span>
        <span class="hljs-attr">alias</span>: {
            <span class="hljs-comment">// 将@符号指向src目录</span>
            <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./src'</span>),
        },
        <span class="hljs-comment">// 配置文件扩展名，导入时可以省略</span>
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.mjs'</span>, <span class="hljs-string">'.js'</span>, <span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.jsx'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.json'</span>, <span class="hljs-string">'.vue'</span>],
    },

    <span class="hljs-comment">// 配置CSS</span>
    <span class="hljs-attr">css</span>: {
        <span class="hljs-comment">// 配置预处理器选项</span>
        <span class="hljs-attr">preprocessorOptions</span>: {
            <span class="hljs-comment">// SCSS预处理器配置</span>
            <span class="hljs-attr">scss</span>: {
                <span class="hljs-comment">// 移除了additionalData，因为style.css已经在main.ts中导入</span>
            },
        },
    },

    <span class="hljs-comment">// 配置开发服务器</span>
    <span class="hljs-attr">server</span>: {
        <span class="hljs-comment">// 服务器端口</span>
        <span class="hljs-attr">port</span>: <span class="hljs-number">9000</span>,
        <span class="hljs-comment">// 自动打开浏览器</span>
        <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 允许外部访问</span>
        <span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>,
        <span class="hljs-comment">// 配置代理</span>
        <span class="hljs-attr">proxy</span>: {
            <span class="hljs-comment">// 将/test路径代理到http://localhost:3000</span>
            <span class="hljs-string">'/test'</span>: {
                <span class="hljs-comment">// 代理目标地址</span>
                <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
                <span class="hljs-comment">// 改变请求头中的Origin</span>
                <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-comment">// 允许HTTPS证书无效</span>
                <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>,
            },
        },
    },

    <span class="hljs-comment">// 配置依赖优化</span>
    <span class="hljs-attr">optimizeDeps</span>: {
        <span class="hljs-comment">// 预构建的依赖列表</span>
        <span class="hljs-attr">include</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>, <span class="hljs-string">'pinia'</span>, <span class="hljs-string">'axios'</span>, <span class="hljs-string">'element-plus'</span>, <span class="hljs-string">'@vueuse/core'</span>],
    },
});

</code></pre>
<p><strong>vite.dev.ts</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导入Vite的defineConfig和mergeConfig函数</span>
<span class="hljs-comment">// defineConfig用于定义Vite配置，mergeConfig用于合并配置</span>
<span class="hljs-keyword">import</span> { defineConfig, mergeConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;

<span class="hljs-comment">// 导入公共配置</span>
<span class="hljs-keyword">import</span> baseConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'./vite.base.ts'</span>;

<span class="hljs-comment">// 导出开发环境配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(
    <span class="hljs-comment">// 使用mergeConfig合并公共配置和开发环境配置</span>
    <span class="hljs-title function_">mergeConfig</span>(
        <span class="hljs-comment">// 公共配置</span>
        baseConfig,
        <span class="hljs-comment">// 开发环境特定配置</span>
        <span class="hljs-title function_">defineConfig</span>({
            <span class="hljs-comment">// 设置环境模式为development</span>
            <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,
            <span class="hljs-comment">// 配置全局常量替换</span>
            <span class="hljs-attr">define</span>: {
                <span class="hljs-comment">// Vue feature flag for hydration mismatch details</span>
                <span class="hljs-attr">__VUE_PROD_HYDRATION_MISMATCH_DETAILS__</span>: <span class="hljs-literal">false</span>,
            },
            <span class="hljs-comment">// 配置构建选项</span>
            <span class="hljs-attr">build</span>: {
                <span class="hljs-comment">// 构建输出目录</span>
                <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>,
                <span class="hljs-comment">// 静态资源输出目录</span>
                <span class="hljs-attr">assetsDir</span>: <span class="hljs-string">'assets'</span>,
                <span class="hljs-comment">// 开发环境启用sourcemap，便于调试</span>
                <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-comment">// 开发环境不压缩代码，提高构建速度</span>
                <span class="hljs-attr">minify</span>: <span class="hljs-literal">false</span>,
            },
        })
    )
);

</code></pre>
<p><strong>vite.prod.ts</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导入Vite的defineConfig和mergeConfig函数</span>
<span class="hljs-comment">// defineConfig用于定义Vite配置，mergeConfig用于合并配置</span>
<span class="hljs-keyword">import</span> { defineConfig, mergeConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;

<span class="hljs-comment">// 导入构建分析工具，用于生成构建包大小分析报告</span>
<span class="hljs-keyword">import</span> { visualizer } <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-visualizer'</span>;

<span class="hljs-comment">// 导入Gzip压缩插件，用于压缩静态资源</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Compression</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-compression'</span>;

<span class="hljs-comment">// 导入公共配置</span>
<span class="hljs-keyword">import</span> baseConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'./vite.base.ts'</span>;

<span class="hljs-comment">// 导出生产环境配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(
    <span class="hljs-comment">// 使用mergeConfig合并公共配置和生产环境配置</span>
    <span class="hljs-title function_">mergeConfig</span>(
        <span class="hljs-comment">// 公共配置</span>
        baseConfig,
        <span class="hljs-comment">// 生产环境特定配置</span>
        <span class="hljs-title function_">defineConfig</span>({
            <span class="hljs-comment">// 设置环境模式为production</span>
            <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
            <span class="hljs-comment">// 配置全局常量替换</span>
            <span class="hljs-attr">define</span>: {
                <span class="hljs-comment">// Vue feature flag for hydration mismatch details</span>
                <span class="hljs-attr">__VUE_PROD_HYDRATION_MISMATCH_DETAILS__</span>: <span class="hljs-literal">true</span>,
            },
            <span class="hljs-comment">// 配置生产环境特定插件</span>
            <span class="hljs-attr">plugins</span>: [
                <span class="hljs-comment">// 构建分析工具配置</span>
                <span class="hljs-title function_">visualizer</span>({
                    <span class="hljs-comment">// 构建完成后不自动打开报告</span>
                    <span class="hljs-attr">open</span>: <span class="hljs-literal">false</span>,
                    <span class="hljs-comment">// 显示gzip压缩后的大小</span>
                    <span class="hljs-attr">gzipSize</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-comment">// 显示brotli压缩后的大小</span>
                    <span class="hljs-attr">brotliSize</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-comment">// 报告生成路径</span>
                    <span class="hljs-attr">filename</span>: <span class="hljs-string">'dist/stats.html'</span>,
                }),

                <span class="hljs-comment">// Gzip压缩插件配置</span>
                <span class="hljs-title class_">Compression</span>({
                    <span class="hljs-comment">// 输出压缩信息</span>
                    <span class="hljs-attr">verbose</span>: <span class="hljs-literal">true</span>,
                    <span class="hljs-comment">// 启用压缩</span>
                    <span class="hljs-attr">disable</span>: <span class="hljs-literal">false</span>,
                    <span class="hljs-comment">// 压缩阈值，大于10KB的文件才会被压缩</span>
                    <span class="hljs-attr">threshold</span>: <span class="hljs-number">10240</span>,
                    <span class="hljs-comment">// 压缩算法</span>
                    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'gzip'</span>,
                    <span class="hljs-comment">// 压缩文件扩展名</span>
                    <span class="hljs-attr">ext</span>: <span class="hljs-string">'.gz'</span>,
                }),
            ],

            <span class="hljs-comment">// 配置构建选项</span>
            <span class="hljs-attr">build</span>: {
                <span class="hljs-comment">// 构建输出目录</span>
                <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>,
                <span class="hljs-comment">// 静态资源输出目录</span>
                <span class="hljs-attr">assetsDir</span>: <span class="hljs-string">'assets'</span>,
                <span class="hljs-comment">// 生产环境禁用sourcemap，减少文件大小</span>
                <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-comment">// 生产环境使用terser进行代码压缩</span>
                <span class="hljs-attr">minify</span>: <span class="hljs-string">'terser'</span>,

                <span class="hljs-comment">// terser压缩配置</span>
                <span class="hljs-attr">terserOptions</span>: {
                    <span class="hljs-comment">// 压缩选项</span>
                    <span class="hljs-attr">compress</span>: {
                        <span class="hljs-comment">// 移除console语句</span>
                        <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>,
                        <span class="hljs-comment">// 移除debugger语句</span>
                        <span class="hljs-attr">drop_debugger</span>: <span class="hljs-literal">true</span>,
                    },
                },

                <span class="hljs-comment">// 输出配置（使用rolldown替代rollup）</span>
                <span class="hljs-attr">rollupOptions</span>: {
                    <span class="hljs-attr">output</span>: {
                        <span class="hljs-comment">// 入口文件命名规则</span>
                        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'assets/js/[name].[hash].js'</span>,
                        <span class="hljs-comment">// 代码块命名规则</span>
                        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'assets/js/[name].[hash].js'</span>,
                        <span class="hljs-comment">// 静态资源命名规则</span>
                        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'assets/[ext]/[name].[hash].[ext]'</span>,

                        <span class="hljs-comment">// 手动代码分割配置</span>
                        <span class="hljs-attr">manualChunks</span>: {
                            <span class="hljs-comment">// 将Vue相关库打包到vue-vendor chunk</span>
                            <span class="hljs-string">'vue-vendor'</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>, <span class="hljs-string">'pinia'</span>],
                            <span class="hljs-comment">// 将Element Plus打包到element-plus chunk</span>
                            <span class="hljs-string">'element-plus'</span>: [<span class="hljs-string">'element-plus'</span>],
                            <span class="hljs-comment">// 将Axios打包到axios chunk</span>
                            <span class="hljs-attr">axios</span>: [<span class="hljs-string">'axios'</span>],
                            <span class="hljs-comment">// 将@vueuse/core打包到@vueuse/core chunk</span>
                            <span class="hljs-string">'@vueuse/core'</span>: [<span class="hljs-string">'@vueuse/core'</span>],
                        },
                    },
                },
            },
        })
    )
);

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端模块化发展]]></title>    <link>https://juejin.cn/post/7593234983756120074</link>    <guid>https://juejin.cn/post/7593234983756120074</guid>    <pubDate>2026-01-10T07:42:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593234983756120074" data-draft-id="7593242327933370378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端模块化发展"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-10T07:42:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cxxcode"/> <meta itemprop="url" content="https://juejin.cn/user/3175045310711944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端模块化发展
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3175045310711944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cxxcode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T07:42:22.000Z" title="Sat Jan 10 2026 07:42:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端模块化</h2>
<h3 data-id="heading-1">前言</h3>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────────────────────┐
│                         知识体系递进关系                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  第一章：为什么需要模块化？                                                  │
│     └── 问题背景、历史演进                                                   │
│            │                                                                │
│            ▼                                                                │
│  第二章：模块化规范有哪些？                                                  │
│     └── <span class="hljs-title class_">CommonJS</span>、<span class="hljs-variable constant_">AMD</span>/<span class="hljs-variable constant_">UMD</span>、<span class="hljs-variable constant_">ESM</span> 语法与特性对比                                │
│            │                                                                │
│            ▼                                                                │
│  第三章：<span class="hljs-variable constant_">ESM</span> 如何工作？（官方标准深入）                                       │
│     └── 三阶段加载、静态特性、实时绑定、循环依赖                              │
│            │                                                                │
│            ▼                                                                │
│  第四章：为什么需要构建工具？                                                │
│     └── <span class="hljs-variable constant_">ESM</span> 的局限性、<span class="hljs-title class_">Webpack</span> 的价值定位                                     │
│            │                                                                │
│            ▼                                                                │
│  第五章：<span class="hljs-title class_">Webpack</span> 构建原理                                                   │
│     └── 构建流程、<span class="hljs-title class_">Module</span>/<span class="hljs-title class_">Chunk</span>/<span class="hljs-title class_">Bundle</span>、模块包裹机制                          │
│            │                                                                │
│            ▼                                                                │
│  第六章：<span class="hljs-title class_">Webpack</span> 运行时机制                                                 │
│     └── __webpack_require__、异步加载、<span class="hljs-title class_">JSON</span>P 回调                            │
│            │                                                                │
│            ▼                                                                │
│  第七章：优化策略与最佳实践                                                  │
│     └── <span class="hljs-title class_">Tree</span> <span class="hljs-title class_">Shaking</span>、代码分割、模块输出格式                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-2">第一章：模块化的历史演进与问题背景</h3>
<blockquote>
<p><strong>本章解决的问题</strong>：为什么 JavaScript 需要模块化？模块化是如何一步步发展的？</p>
</blockquote>
<h4 data-id="heading-3">1.1 无模块时代的痛点（1995-2009）</h4>
<p>JavaScript 诞生之初并没有模块系统，所有代码共享全局作用域：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// a.js</span>
<span class="hljs-keyword">var</span> name = <span class="hljs-string">"moduleA"</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">helper</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/*...*/</span> }

<span class="hljs-comment">// b.js</span>
<span class="hljs-keyword">var</span> name = <span class="hljs-string">"moduleB"</span>;  <span class="hljs-comment">// 💥 覆盖了 a.js 的 name！</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">helper</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/*...*/</span> }  <span class="hljs-comment">// 💥 覆盖了 a.js 的 helper！</span>

<span class="hljs-comment">// index.html - 必须手动管理加载顺序</span>
&lt;script src=<span class="hljs-string">"a.js"</span>&gt;&lt;/script&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"b.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>核心问题</strong>：</p>
<ol>
<li><strong>命名冲突</strong>：全局变量相互覆盖</li>
<li><strong>依赖管理</strong>：手动维护 script 标签顺序</li>
<li><strong>按需加载</strong>：无法实现，所有代码一次性加载</li>
</ol>
<p><strong>早期解决方案</strong>：IIFE + 命名空间</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> <span class="hljs-title class_">MyApp</span> = <span class="hljs-title class_">MyApp</span> || {};
<span class="hljs-title class_">MyApp</span>.<span class="hljs-property">moduleA</span> = (<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> privateVar = <span class="hljs-string">"private"</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">publicMethod</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) { <span class="hljs-comment">/*...*/</span> },
  };
})();
</code></pre>
<h4 data-id="heading-4">1.2 模块化演进时间线</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                     <span class="hljs-string">JavaScript</span> <span class="hljs-string">模块化演进史</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-number">1995        </span><span class="hljs-number">2009         </span><span class="hljs-number">2011         </span><span class="hljs-number">2015         </span><span class="hljs-number">2017</span>         <span class="hljs-string">现在</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>           <span class="hljs-string">│</span>            <span class="hljs-string">│</span>            <span class="hljs-string">│</span>            <span class="hljs-string">│</span>            <span class="hljs-string">│</span>       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">▼</span>           <span class="hljs-string">▼</span>            <span class="hljs-string">▼</span>            <span class="hljs-string">▼</span>            <span class="hljs-string">▼</span>            <span class="hljs-string">▼</span>       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">无模块</span> <span class="hljs-string">→</span> <span class="hljs-string">CommonJS</span> <span class="hljs-string">→</span> <span class="hljs-string">AMD/UMD</span> <span class="hljs-string">→</span> <span class="hljs-string">ES</span> <span class="hljs-string">Modules</span> <span class="hljs-string">→</span> <span class="hljs-string">Node支持ESM</span> <span class="hljs-string">→</span> <span class="hljs-string">ESM成为主流</span>     <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>           <span class="hljs-string">│</span>            <span class="hljs-string">│</span>            <span class="hljs-string">│</span>            <span class="hljs-string">│</span>            <span class="hljs-string">│</span>       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">全局变量</span>   <span class="hljs-string">Node.js</span>      <span class="hljs-string">浏览器异步</span>    <span class="hljs-string">语言标准</span>      <span class="hljs-string">生态统一</span>      <span class="hljs-string">构建工具</span> <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">命名冲突</span>   <span class="hljs-string">服务端模块</span>    <span class="hljs-string">加载需求</span>      <span class="hljs-string">静态分析</span>      <span class="hljs-string">双格式并存</span>    <span class="hljs-string">深度优化</span> <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                             <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────────────────┘</span>
</code></pre>








































<table><thead><tr><th>阶段</th><th>时间</th><th>规范</th><th>背景</th><th>特点</th></tr></thead><tbody><tr><td>1</td><td>2009</td><td>CommonJS</td><td>Node.js 诞生，服务端需要模块系统</td><td>同步加载，运行时解析</td></tr><tr><td>2</td><td>2011</td><td>AMD/UMD</td><td>浏览器需要异步加载（网络延迟）</td><td>异步加载，兼容多环境</td></tr><tr><td>3</td><td>2015</td><td>ES Modules</td><td>JavaScript 语言层面的官方标准</td><td>静态分析，编译时确定</td></tr><tr><td>4</td><td>2017+</td><td>生态统一</td><td>Node.js 12+ 原生支持 ESM</td><td>ESM + CJS 双格式并存</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">第二章：模块化规范详解</h3>
<blockquote>
<p><strong>本章解决的问题</strong>：三大模块规范（CommonJS、AMD/UMD、ESM）各有什么语法和特性？如何选择？</p>
</blockquote>
<h4 data-id="heading-6">2.1 规范对比总览</h4>






















































<table><thead><tr><th>特性</th><th>CommonJS</th><th>AMD</th><th>UMD</th><th>ESM</th></tr></thead><tbody><tr><td>设计目标</td><td>服务端</td><td>浏览器异步</td><td>通用兼容</td><td>语言标准</td></tr><tr><td>加载时机</td><td>运行时</td><td>运行时</td><td>运行时</td><td><strong>编译时</strong></td></tr><tr><td>加载方式</td><td>同步</td><td>异步</td><td>依环境</td><td>异步(可同步)</td></tr><tr><td>导出类型</td><td>值拷贝</td><td>值拷贝</td><td>值拷贝</td><td><strong>引用绑定</strong></td></tr><tr><td>静态分析</td><td>❌</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>Tree Shaking</td><td>❌</td><td>❌</td><td>❌</td><td>✅</td></tr></tbody></table>
<h4 data-id="heading-7">2.2 CommonJS 详解</h4>
<p><strong>语法</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导出</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-comment">// 或</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;
<span class="hljs-built_in">exports</span>.<span class="hljs-property">b</span> = <span class="hljs-number">2</span>;

<span class="hljs-comment">// 导入</span>
<span class="hljs-keyword">const</span> lib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib'</span>);
<span class="hljs-keyword">const</span> { a, b } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib'</span>);
</code></pre>
<p><strong>运行时特性（动态）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 条件导入</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./prod.js'</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dev.js'</span>);
}

<span class="hljs-comment">// ✅ 动态路径</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">'utils'</span>;
<span class="hljs-keyword">const</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./<span class="hljs-subst">${name}</span>.js`</span>);

<span class="hljs-comment">// ✅ 循环中导入</span>
[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {
  modules[name] = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./<span class="hljs-subst">${name}</span>.js`</span>);
});
</code></pre>
<p><strong>值拷贝特性</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// counter.js</span>
<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  count,
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> count++,
};

<span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">const</span> counter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./counter'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-property">count</span>);  <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-property">count</span>);  <span class="hljs-comment">// 0 ← 还是 0！值拷贝！</span>
</code></pre>
<h4 data-id="heading-8">2.3 UMD 详解（通用模块定义）</h4>
<p>UMD 的目标是<strong>一份代码，多环境运行</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span> (<span class="hljs-params">root, factory</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.<span class="hljs-property">amd</span>) {
    <span class="hljs-comment">// AMD 环境 (RequireJS)</span>
    <span class="hljs-title function_">define</span>([<span class="hljs-string">'dependency'</span>], factory);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">module</span> === <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>) {
    <span class="hljs-comment">// CommonJS 环境 (Node.js)</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">factory</span>(<span class="hljs-built_in">require</span>(<span class="hljs-string">'dependency'</span>));
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 浏览器全局变量</span>
    root.<span class="hljs-property">MyLibrary</span> = <span class="hljs-title function_">factory</span>(root.<span class="hljs-property">Dependency</span>);
  }
})(<span class="hljs-keyword">typeof</span> self !== <span class="hljs-string">'undefined'</span> ? self : <span class="hljs-variable language_">this</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">dependency</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">doSomething</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello from UMD!'</span>);
    },
  };
});
</code></pre>
<p><strong>环境判断流程</strong>：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">┌──────────────────────┐
│ <span class="hljs-keyword">typeof</span> exports ===   │
│ <span class="hljs-string">"object"</span> &amp;&amp;          │─── <span class="hljs-literal">YES</span> ──→ CommonJS2: module.exports = ...
│ <span class="hljs-keyword">typeof</span> module ===    │
│ <span class="hljs-string">"object"</span>             │
└──────────┬───────────┘
           │ <span class="hljs-literal">NO</span>
           ▼
┌──────────────────────┐
│ <span class="hljs-keyword">typeof</span> define ===    │
│ <span class="hljs-string">"function"</span> &amp;&amp;        │─── <span class="hljs-literal">YES</span> ──→ AMD: define([], factory)
│ define.amd           │
└──────────┬───────────┘
           │ <span class="hljs-literal">NO</span>
           ▼
┌──────────────────────┐
│ <span class="hljs-keyword">typeof</span> exports ===   │─── <span class="hljs-literal">YES</span> ──→ CommonJS: exports[<span class="hljs-string">"name"</span>] = ...
│ <span class="hljs-string">"object"</span>             │
└──────────┬───────────┘
           │ <span class="hljs-literal">NO</span>
           ▼
     浏览器全局变量: root[<span class="hljs-string">"name"</span>] = ...
</code></pre>
<h4 data-id="heading-9">2.4 ESM 详解（官方标准）</h4>
<p><strong>导出语法</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ─────────── 命名导出 ───────────</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> name = <span class="hljs-string">'ESM'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/*...*/</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> { <span class="hljs-comment">/*...*/</span> }

<span class="hljs-comment">// 批量导出</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>, b = <span class="hljs-number">2</span>;
<span class="hljs-keyword">export</span> { a, b };

<span class="hljs-comment">// 重命名导出</span>
<span class="hljs-keyword">export</span> { a <span class="hljs-keyword">as</span> aliasA, b <span class="hljs-keyword">as</span> aliasB };

<span class="hljs-comment">// ─────────── 默认导出 ───────────</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/*...*/</span> }
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> { <span class="hljs-comment">/*...*/</span> }

<span class="hljs-comment">// ─────────── 聚合导出（re-export）───────────</span>
<span class="hljs-keyword">export</span> { foo, bar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./other.js'</span>;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">as</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;  <span class="hljs-comment">// 命名空间聚合</span>
</code></pre>
<p><strong>导入语法</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ─────────── 命名导入 ───────────</span>
<span class="hljs-keyword">import</span> { name, greet } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;
<span class="hljs-keyword">import</span> { name <span class="hljs-keyword">as</span> aliasName } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;

<span class="hljs-comment">// ─────────── 默认导入 ───────────</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyDefault</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;

<span class="hljs-comment">// ─────────── 混合导入 ───────────</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyDefault</span>, { name, greet } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;

<span class="hljs-comment">// ─────────── 命名空间导入 ───────────</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Module</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;

<span class="hljs-comment">// ─────────── 副作用导入 ───────────</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./polyfill.js'</span>;  <span class="hljs-comment">// 只执行，不导入任何值</span>

<span class="hljs-comment">// ─────────── 动态导入 ───────────</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./module.js'</span>);
</code></pre>
<p><strong>静态结构限制（与 CommonJS 的关键区别）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ ESM 不允许 - 动态导入路径</span>
<span class="hljs-keyword">import</span> { foo } <span class="hljs-keyword">from</span> <span class="hljs-title function_">getModulePath</span>();  <span class="hljs-comment">// SyntaxError</span>

<span class="hljs-comment">// ❌ ESM 不允许 - 条件导入</span>
<span class="hljs-keyword">if</span> (condition) {
  <span class="hljs-keyword">import</span> { bar } <span class="hljs-keyword">from</span> <span class="hljs-string">'./bar.js'</span>;  <span class="hljs-comment">// SyntaxError</span>
}

<span class="hljs-comment">// ✅ CommonJS 允许 - 完全动态</span>
<span class="hljs-keyword">const</span> mod = <span class="hljs-built_in">require</span>(<span class="hljs-title function_">getModulePath</span>());
<span class="hljs-keyword">if</span> (condition) {
  <span class="hljs-keyword">const</span> bar = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./bar.js'</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-10">第三章：ESM 工作原理深入</h3>
<blockquote>
<p><strong>本章解决的问题</strong>：ESM 作为官方标准，它的加载机制是什么？静态特性和实时绑定是如何实现的？</p>
</blockquote>
<h4 data-id="heading-11">3.1 ESM 三阶段加载过程</h4>
<p>ESM 的加载过程分为三个完全独立的阶段：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                        时机划分                                  │
├──────────────────┬──────────────────────────────────────────────┤
│                  │                                              │
│   编译时/加载时   │  ① 构建 (Construction) - 解析、发现依赖      │
│   (静态分析)     │  ② 实例化 (Instantiation) - 分配内存、连接绑定│
│                  │                                              │
├──────────────────┼──────────────────────────────────────────────┤
│                  │                                              │
│   运行时         │  ③ 求值 (Evaluation) - 执行代码、填充导出值   │
│   (代码执行)     │                                              │
│                  │                                              │
└──────────────────┴──────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-12">3.1.1 构建阶段 (Construction)</h5>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────┐
│                      构建阶段                                │
├─────────────────────────────────────────────────────────────┤
│  <span class="hljs-number">1.</span> 解析模块说明符 (<span class="hljs-keyword">Module</span> Specifier)                        │
│     <span class="hljs-string">'./utils.js'</span> → <span class="hljs-string">'file:///project/utils.js'</span>              │
│                                                             │
│  <span class="hljs-number">2.</span> 获取模块文件 (<span class="hljs-keyword">Fetch</span>)                                     │
│     <span class="hljs-operator">-</span> 浏览器: HTTP 请求                                      │
│     <span class="hljs-operator">-</span> Node.js: 文件系统读取                                  │
│                                                             │
│  <span class="hljs-number">3.</span> 解析为模块记录 (<span class="hljs-keyword">Module</span> Record)                           │
│     <span class="hljs-operator">-</span> 静态分析 import<span class="hljs-operator">/</span>export 语句                            │
│     <span class="hljs-operator">-</span> 不执行任何代码                                         │
│     <span class="hljs-operator">-</span> 构建模块依赖图                                         │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>每个模块只会被解析一次，结果缓存在 <strong>Module Map</strong> 中</li>
<li>所有依赖通过深度优先遍历被发现和加载</li>
<li>此阶段完全是静态分析，<strong>不执行任何 JavaScript 代码</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模块记录 (Module Record) 的简化结构</span>
{
  [[<span class="hljs-title class_">RequestedModules</span>]]: [<span class="hljs-string">'./dep1.js'</span>, <span class="hljs-string">'./dep2.js'</span>],  <span class="hljs-comment">// 依赖列表</span>
  [[<span class="hljs-title class_">ImportEntries</span>]]: [...],   <span class="hljs-comment">// 导入条目</span>
  [[<span class="hljs-title class_">ExportEntries</span>]]: [...],   <span class="hljs-comment">// 导出条目</span>
  [[<span class="hljs-title class_">Status</span>]]: <span class="hljs-string">'unlinked'</span>,     <span class="hljs-comment">// 模块状态</span>
  [[<span class="hljs-title class_">EvaluationError</span>]]: <span class="hljs-literal">null</span>   <span class="hljs-comment">// 执行错误</span>
}
</code></pre>
<h5 data-id="heading-13">3.1.2 实例化阶段 (Instantiation / Linking)</h5>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────┐
│                      实例化阶段                              │
├─────────────────────────────────────────────────────────────┤
│  <span class="hljs-number">1.</span> 为每个模块分配内存空间 (Module Environment Record)        │
│                                                             │
│  <span class="hljs-number">2.</span> 创建导出绑定 (Export Bindings)                           │
│     - 在内存中为所有 <span class="hljs-keyword">export</span> 创建<span class="hljs-string">"槽位"</span>                        │
│     - 此时槽位未初始化 (uninitialized)                       │
│                                                             │
│  <span class="hljs-number">3.</span> 连接导入导出 (Linking)                                   │
│     - <span class="hljs-keyword">import</span> 直接指向 <span class="hljs-keyword">export</span> 的内存地址                      │
│     - 这就是<span class="hljs-string">"实时绑定"</span> (Live Binding)                        │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-14">3.1.3 求值阶段 (Evaluation)</h5>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                      求值阶段                                │
├─────────────────────────────────────────────────────────────┤
│  <span class="hljs-number">1</span>. 按照深度优先、后序遍历的顺序执行模块代码                    │
│     (先执行依赖模块，再执行当前模块)                          │
│                                                             │
│  <span class="hljs-number">2</span>. 填充导出槽位的实际值                                      │
│                                                             │
│  <span class="hljs-number">3</span>. 每个模块只执行一次，结果被缓存                            │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>执行顺序示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./b.js'</span>;
<span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'main'</span>);

<span class="hljs-comment">// a.js</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a'</span>);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-string">'A'</span>;

<span class="hljs-comment">// b.js</span>
<span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'b'</span>);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = <span class="hljs-string">'B'</span>;

<span class="hljs-comment">// 执行顺序: a → b → main</span>
<span class="hljs-comment">// 输出: 'a', 'b', 'main'</span>
</code></pre>
<h4 data-id="heading-15">3.2 静态结构特性</h4>
<p><strong>静态分析</strong>：在代码<strong>执行前</strong>（编译阶段），仅通过分析代码文本结构，就能确定所有模块依赖关系。</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────────┐
│                     静态 vs 动态                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  <span class="hljs-variable constant_">ESM</span> 静态分析（编译时）                                          │
│  ─────────────────────                                           │
│  <span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>;                                │
│       ↓                                                          │
│  编译器读取代码文本 → 看到 <span class="hljs-keyword">import</span> 语句 → 知道依赖 math.<span class="hljs-property">js</span>        │
│       ↓                                                          │
│  无需执行代码，<span class="hljs-number">100</span>% 确定依赖关系                                 │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  <span class="hljs-title class_">CommonJS</span> 动态分析（运行时）                                     │
│  ─────────────────────────                                       │
│  <span class="hljs-keyword">const</span> math = <span class="hljs-built_in">require</span>(<span class="hljs-title function_">getPath</span>());                                │
│       ↓                                                          │
│  必须执行 <span class="hljs-title function_">getPath</span>() 才知道路径是什么                             │
│       ↓                                                          │
│  编译时无法确定依赖！                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>静态结构的优势</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                   静态结构的优势                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  <span class="hljs-number">1</span>. Tree Shaking (摇树优化)                                  │
│     ├── 在构建时分析哪些导出被使用                           │
│     └── 移除未使用的代码 (Dead Code Elimination)             │
│                                                             │
│  <span class="hljs-number">2</span>. 更快的查找                                               │
│     ├── 变量查找在编译时确定                                 │
│     └── 无需运行时的动态查找                                 │
│                                                             │
│  <span class="hljs-number">3</span>. 类型检查                                                 │
│     ├── TypeScript 可在编译时验证导入                        │
│     └── IDE 提供准确的自动补全                               │
│                                                             │
│  <span class="hljs-number">4</span>. 循环依赖处理更可靠                                       │
│     └── 静态分析可以提前发现问题                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-16">3.3 实时绑定 (Live Binding)</h4>
<p>ESM 最重要的特性之一，与 CommonJS 的值拷贝形成鲜明对比：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============ ESM: 实时绑定 ============</span>
<span class="hljs-comment">// counter.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count++; }

<span class="hljs-comment">// main.mjs</span>
<span class="hljs-keyword">import</span> { count, increment } <span class="hljs-keyword">from</span> <span class="hljs-string">'./counter.mjs'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);  <span class="hljs-comment">// 0</span>
<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);  <span class="hljs-comment">// 1 ← 看到了变化！</span>

<span class="hljs-comment">// ============ CommonJS: 值拷贝 ============</span>
<span class="hljs-comment">// counter.cjs</span>
<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  count,
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) { count++; }
};

<span class="hljs-comment">// main.cjs</span>
<span class="hljs-keyword">const</span> { count, increment } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./counter.cjs'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);  <span class="hljs-comment">// 0</span>
<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);  <span class="hljs-comment">// 0 ← 还是 0！(拷贝的值)</span>
</code></pre>
<p><strong>绑定原理图解</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌──────────────────</span> <span class="hljs-string">ESM</span> <span class="hljs-string">实时绑定</span> <span class="hljs-string">──────────────────┐</span>
<span class="hljs-string">│</span>                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">导出模块内存</span>                 <span class="hljs-string">导入模块</span>          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">┌──────────────┐</span>           <span class="hljs-string">┌──────────────┐</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span> <span class="hljs-attr">count:</span> [<span class="hljs-string">ref</span>]<span class="hljs-string">─┼───────────┼─►</span> <span class="hljs-string">count</span>      <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>         <span class="hljs-string">│</span>    <span class="hljs-string">│</span>           <span class="hljs-string">│</span>              <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>         <span class="hljs-string">▼</span>    <span class="hljs-string">│</span>           <span class="hljs-string">│</span>              <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>      <span class="hljs-string">┌───┐</span>   <span class="hljs-string">│</span>           <span class="hljs-string">│</span>              <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>      <span class="hljs-string">│</span> <span class="hljs-number">0</span> <span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">同一内存</span>  <span class="hljs-string">│</span>              <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>      <span class="hljs-string">└───┘</span>   <span class="hljs-string">│</span>           <span class="hljs-string">│</span>              <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└──────────────┘</span>           <span class="hljs-string">└──────────────┘</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                  <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────────────────┘</span>

<span class="hljs-string">┌──────────────────</span> <span class="hljs-string">CJS</span> <span class="hljs-string">值拷贝</span> <span class="hljs-string">───────────────────┐</span>
<span class="hljs-string">│</span>                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">导出模块</span>                     <span class="hljs-string">导入模块</span>          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">┌──────────────┐</span>           <span class="hljs-string">┌──────────────┐</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span> <span class="hljs-attr">count:</span> <span class="hljs-string">───┐</span>  <span class="hljs-string">│</span>           <span class="hljs-string">│</span> <span class="hljs-attr">count:</span> <span class="hljs-string">───┐</span>  <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>           <span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">拷贝操作</span>  <span class="hljs-string">│</span>           <span class="hljs-string">│</span>  <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>           <span class="hljs-string">▼</span>  <span class="hljs-string">│</span>  <span class="hljs-string">═══════►</span> <span class="hljs-string">│</span>           <span class="hljs-string">▼</span>  <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>        <span class="hljs-string">┌───┐</span> <span class="hljs-string">│</span>           <span class="hljs-string">│</span>        <span class="hljs-string">┌───┐</span> <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>        <span class="hljs-string">│</span> <span class="hljs-number">0</span> <span class="hljs-string">│</span> <span class="hljs-string">│</span>           <span class="hljs-string">│</span>        <span class="hljs-string">│</span> <span class="hljs-number">0</span> <span class="hljs-string">│</span> <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>        <span class="hljs-string">└───┘</span> <span class="hljs-string">│</span>           <span class="hljs-string">│</span>        <span class="hljs-string">└───┘</span> <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└──────────────┘</span>           <span class="hljs-string">└──────────────┘</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>      <span class="hljs-string">独立内存</span>                    <span class="hljs-string">独立内存</span>        <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────────────────┘</span>
</code></pre>
<p><strong>导入是只读的</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// module.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> value = <span class="hljs-number">1</span>;

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { value } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;
value = <span class="hljs-number">2</span>;  <span class="hljs-comment">// TypeError: Assignment to constant variable</span>
<span class="hljs-comment">// 导入的绑定是只读的！</span>

<span class="hljs-comment">// 但可以修改导入对象的属性</span>
<span class="hljs-keyword">import</span> { obj } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;
obj.<span class="hljs-property">prop</span> = <span class="hljs-string">'new'</span>;  <span class="hljs-comment">// ✅ 这是允许的</span>
</code></pre>
<h4 data-id="heading-17">3.4 循环依赖处理</h4>
<h5 data-id="heading-18">使用 <code>const/let</code> 声明 —— 抛出 ReferenceError</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// a.mjs</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a.mjs 开始执行'</span>);
<span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./b.mjs'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'在 a.mjs 中, b ='</span>, b);
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-string">'a 的值'</span>;

<span class="hljs-comment">// b.mjs</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'b.mjs 开始执行'</span>);
<span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.mjs'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'在 b.mjs 中, a ='</span>, a);  <span class="hljs-comment">// ❌ ReferenceError!</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = <span class="hljs-string">'b 的值'</span>;

<span class="hljs-comment">// 执行 node a.mjs</span>
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// b.mjs 开始执行</span>
<span class="hljs-comment">// ReferenceError: Cannot access 'a' before initialization</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// 原因：const/let 存在暂时性死区 (TDZ)，在初始化前访问会报错</span>
</code></pre>
<h5 data-id="heading-19">使用 <code>var</code> 声明 —— 得到 undefined</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// a.mjs</span>
<span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./b.mjs'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">var</span> a = <span class="hljs-string">'a 的值'</span>;  <span class="hljs-comment">// 使用 var</span>

<span class="hljs-comment">// b.mjs</span>
<span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.mjs'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'在 b.mjs 中, a ='</span>, a);  <span class="hljs-comment">// undefined (var 会提升)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">var</span> b = <span class="hljs-string">'b 的值'</span>;
</code></pre>
<h5 data-id="heading-20">使用函数声明 —— 正常工作</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// a.mjs</span>
<span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./b.mjs'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'在 a.mjs 中, b() ='</span>, <span class="hljs-title function_">b</span>());
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">a</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'a 的值'</span>; }  <span class="hljs-comment">// 函数声明会提升</span>

<span class="hljs-comment">// b.mjs</span>
<span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.mjs'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'在 b.mjs 中, a() ='</span>, <span class="hljs-title function_">a</span>());  <span class="hljs-comment">// ✅ 正常工作！</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">b</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'b 的值'</span>; }
</code></pre>
<p><strong>循环依赖执行流程</strong>：</p>
<pre><code class="hljs language-less" lang="less">执行 <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.mjs</span>:
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ <span class="hljs-number">1</span>. 解析 <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.mjs</span>，发现依赖 <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.mjs</span>                                │
│ <span class="hljs-number">2</span>. 解析 <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.mjs</span>，发现依赖 <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.mjs</span> (循环！)                       │
│ <span class="hljs-number">3</span>. <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.mjs</span> 已在处理中，跳过 (使用未初始化的绑定)                │
│ <span class="hljs-number">4</span>. 执行 <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.mjs</span>，此时 <span class="hljs-selector-tag">a</span> 的导出槽位：                           │
│    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">const</span>/<span class="hljs-selector-tag">let</span>: 处于 <span class="hljs-selector-tag">TDZ</span> → 访问抛出 <span class="hljs-selector-tag">ReferenceError</span>          │
│    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">var</span>: 已提升但未赋值 → <span class="hljs-selector-tag">undefined</span>                        │
│    <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">function</span>: 完整提升 → 可正常调用                        │
│ <span class="hljs-number">5</span>. <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.mjs</span> 执行完毕（如果没有报错），<span class="hljs-selector-tag">b</span> 的导出槽位被填充        │
│ <span class="hljs-number">6</span>. 回到 <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.mjs</span> 继续执行                                       │
│ <span class="hljs-number">7</span>. <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.mjs</span> 执行完毕，<span class="hljs-selector-tag">a</span> 的导出槽位被填充                        │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>避免循环依赖问题的方法</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 方法1: 使用函数延迟访问</span>
<span class="hljs-comment">// a.mjs</span>
<span class="hljs-keyword">import</span> { getB } <span class="hljs-keyword">from</span> <span class="hljs-string">'./b.mjs'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-string">'a'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getA</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> a; }
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getB</span>());  <span class="hljs-comment">// 在函数调用时，b 已初始化</span>

<span class="hljs-comment">// b.mjs</span>
<span class="hljs-keyword">import</span> { getA } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.mjs'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = <span class="hljs-string">'b'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getB</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> b; }

<span class="hljs-comment">// ✅ 方法2: 将共享状态提取到第三个模块</span>
<span class="hljs-comment">// shared.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> shared = { <span class="hljs-attr">a</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">b</span>: <span class="hljs-literal">null</span> };

<span class="hljs-comment">// a.mjs</span>
<span class="hljs-keyword">import</span> { shared } <span class="hljs-keyword">from</span> <span class="hljs-string">'./shared.mjs'</span>;
shared.<span class="hljs-property">a</span> = <span class="hljs-string">'a'</span>;

<span class="hljs-comment">// b.mjs</span>
<span class="hljs-keyword">import</span> { shared } <span class="hljs-keyword">from</span> <span class="hljs-string">'./shared.mjs'</span>;
shared.<span class="hljs-property">b</span> = <span class="hljs-string">'b'</span>;
</code></pre>
<h4 data-id="heading-21">3.5 ESM 在不同环境中的实现</h4>
<h5 data-id="heading-22">浏览器中的 ESM</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 使用 type="module" --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { func } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;
  <span class="hljs-title function_">func</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 外部模块 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 模块特性 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 1. 默认 defer - 不阻塞 HTML 解析</span>
  <span class="hljs-comment">// 2. 默认 strict mode</span>
  <span class="hljs-comment">// 3. 顶层 this 是 undefined</span>
  <span class="hljs-comment">// 4. 支持顶层 await (ES2022)</span>
  <span class="hljs-comment">// 5. 同源策略 - 跨域需要 CORS</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 兼容降级 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"modern.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"legacy.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h5 data-id="heading-23">Node.js 中的 ESM</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式1: 使用 .mjs 扩展名</span>
<span class="hljs-comment">// utils.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">helper</span>(<span class="hljs-params"/>) {}

<span class="hljs-comment">// 方式2: package.json 中设置 "type": "module"</span>
<span class="hljs-comment">// package.json</span>
{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"module"</span>  <span class="hljs-comment">// 所有 .js 文件视为 ESM</span>
}

<span class="hljs-comment">// 方式3: .cjs 扩展名强制 CommonJS</span>
<span class="hljs-comment">// legacy.cjs - 即使 type: module，也是 CommonJS</span>

<span class="hljs-comment">// Node.js 特有的导入方式</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>;
<span class="hljs-keyword">import</span> { readFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs/promises'</span>;

<span class="hljs-comment">// import.meta 对象</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>);       <span class="hljs-comment">// file:///path/to/module.mjs</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">dirname</span>);   <span class="hljs-comment">// /path/to (Node 20.11+)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">filename</span>);  <span class="hljs-comment">// /path/to/module.mjs</span>
</code></pre>
<hr/>
<h3 data-id="heading-24">第四章：为什么需要构建工具？</h3>
<blockquote>
<p><strong>本章解决的问题</strong>：ESM 已经是官方标准了，为什么还需要 Webpack 这样的构建工具？</p>
</blockquote>
<h4 data-id="heading-25">4.1 前端工程化的痛点</h4>
<p>虽然 ESM 解决了模块化的语法标准问题，但前端开发还面临更多挑战：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────────────┐
│                        前端模块化的痛点                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  <span class="hljs-number">1.</span> 模块规范混乱        <span class="hljs-number">2.</span> 浏览器兼容性       <span class="hljs-number">3.</span> 资源类型多样            │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐           │
│  │ CommonJS    │       │ ES <span class="hljs-keyword">Module</span>   │       │ .js .css    │           │
│  │ AMD <span class="hljs-operator">/</span> UMD   │       │ 浏览器支持  │       │ .png .svg   │           │
│  │ ES <span class="hljs-keyword">Module</span>   │       │ 有限        │       │ .json .wasm │           │
│  └─────────────┘       └─────────────┘       └─────────────┘           │
│                                                                         │
│  <span class="hljs-number">4.</span> 开发效率            <span class="hljs-number">5.</span> 性能优化                                      │
│  ┌─────────────┐       ┌─────────────┐                                  │
│  │ 热更新      │       │ 代码分割    │                                  │
│  │ Source Map  │       │ Tree Shaking│                                  │
│  └─────────────┘       │ 压缩混淆    │                                  │
│                        └─────────────┘                                  │
│                                                                         │
│                              ↓                                          │
│                     ┌─────────────────┐                                 │
│                     │    Webpack      │                                 │
│                     │  统一解决方案    │                                 │
│                     └─────────────────┘                                 │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-26">4.2 Webpack 的价值定位</h4>
<p><strong>Webpack 本质</strong>：一个静态模块打包器，以 entry 为起点，递归构建依赖图，将所有模块打包成浏览器可运行的 Bundle。</p>



































<table><thead><tr><th>问题</th><th>ESM 原生能力</th><th>Webpack 解决方案</th></tr></thead><tbody><tr><td>模块规范混乱</td><td>只支持 ESM</td><td>统一处理 CJS/AMD/ESM</td></tr><tr><td>浏览器兼容</td><td>需要现代浏览器</td><td>转译为兼容代码</td></tr><tr><td>非 JS 资源</td><td>不支持</td><td>Loader 处理任意类型</td></tr><tr><td>性能优化</td><td>无</td><td>Tree Shaking、代码分割</td></tr><tr><td>开发体验</td><td>无</td><td>HMR、Source Map</td></tr></tbody></table>
<h4 data-id="heading-27">4.3 构建工具链全景</h4>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────────────────────┐
│                         现代构建工具处理流程                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  源代码 (<span class="hljs-title class_">ES6</span>+ / <span class="hljs-variable constant_">ESM</span>)                                                         │
│        │                                                                     │
│        ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         <span class="hljs-title class_">Babel</span>-loader                                 │    │
│  │  ─────────────────────────────────────────────────────────────────  │    │
│  │  • 转换 <span class="hljs-title class_">ES6</span>+ 语法（<span class="hljs-keyword">async</span>/<span class="hljs-keyword">await</span>, <span class="hljs-keyword">class</span>, 箭头函数等）                 │    │
│  │  • 保留 <span class="hljs-keyword">import</span>/<span class="hljs-keyword">export</span> 语法（<span class="hljs-attr">modules</span>: <span class="hljs-literal">false</span>）← 关键！                │    │
│  │  • 转换 <span class="hljs-variable constant_">JSX</span>、<span class="hljs-title class_">TypeScript</span> 等                                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                           <span class="hljs-title class_">Webpack</span>                                    │    │
│  │  ─────────────────────────────────────────────────────────────────  │    │
│  │  <span class="hljs-number">1.</span> 解析入口文件，构建依赖图                                        │    │
│  │  <span class="hljs-number">2.</span> 将 <span class="hljs-keyword">import</span>/<span class="hljs-keyword">export</span> 转换为 __webpack_require__                     │    │
│  │  <span class="hljs-number">3.</span> 标记未使用的导出（usedExports）                                 │    │
│  │  <span class="hljs-number">4.</span> 代码分割（动态 <span class="hljs-keyword">import</span> → 单独 chunk）                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                           <span class="hljs-title class_">Terser</span>                                     │    │
│  │  ─────────────────────────────────────────────────────────────────  │    │
│  │  • 删除标记为未使用的代码（<span class="hljs-title class_">Tree</span> <span class="hljs-title class_">Shaking</span> 完成）                      │    │
│  │  • 压缩变量名、移除空白、内联简单函数                               │    │
│  │  • 删除 <span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>（可配置）                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        ▼                                                                     │
│  最终 <span class="hljs-title class_">Bundle</span>（优化后的 <span class="hljs-title class_">ES5</span> 代码）                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-28">第五章：Webpack 构建原理</h3>
<blockquote>
<p><strong>本章解决的问题</strong>：Webpack 内部是如何工作的？构建流程是怎样的？</p>
</blockquote>
<h4 data-id="heading-29">5.1 三大核心角色</h4>

























<table><thead><tr><th>角色</th><th>职责</th><th>类比</th></tr></thead><tbody><tr><td><strong>Compiler</strong></td><td>编译器，全局单例，贯穿整个生命周期</td><td>总指挥</td></tr><tr><td><strong>Compilation</strong></td><td>单次编译过程，包含模块、依赖、Chunk 等</td><td>一次构建任务</td></tr><tr><td><strong>Module</strong></td><td>文件的抽象，每个源文件对应一个 Module</td><td>构建的最小单位</td></tr></tbody></table>
<h4 data-id="heading-30">5.2 核心概念：Module、Chunk、Bundle</h4>

























<table><thead><tr><th>概念</th><th>定义</th><th>生命阶段</th></tr></thead><tbody><tr><td><strong>Module</strong></td><td>源文件的抽象，Webpack 处理的最小单位</td><td>Make 阶段</td></tr><tr><td><strong>Chunk</strong></td><td>多个 Module 的集合，打包的中间态</td><td>Seal 阶段</td></tr><tr><td><strong>Bundle</strong></td><td>Chunk 经过处理后输出的最终文件</td><td>Emit 阶段</td></tr></tbody></table>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────────────┐
│                       三者关系：一对多                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Module (源文件)              Chunk (中间态)             Bundle (产物) │
│   ┌─────────┐                                                           │
│   │  <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.js</span>   │─┐                                                         │
│   └─────────┘ │              ┌─────────────────┐                        │
│   ┌─────────┐ ├─────────────→│   <span class="hljs-selector-tag">main</span> chunk    │────────→  <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.js</span>     │
│   │  <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.js</span>   │─┤              └─────────────────┘                        │
│   └─────────┘ │                                                         │
│   ┌─────────┐─┘                                                         │
│   │  c<span class="hljs-selector-class">.css</span>  │                                                           │
│   └─────────┘                                                           │
│                                                                         │
│   ┌─────────┐                ┌─────────────────┐                        │
│   │ lodash  │───────────────→│  vendor chunk   │────────→  vendor<span class="hljs-selector-class">.js</span>   │
│   └─────────┘                └─────────────────┘                        │
│                                                                         │
│   ┌─────────┐                ┌─────────────────┐                        │
│   │ lazy<span class="hljs-selector-class">.js</span> │───────────────→│   async chunk   │────────→  lazy<span class="hljs-selector-class">.js</span>     │
│   └─────────┘                └─────────────────┘                        │
│                                                                         │
│   关系：N Module → <span class="hljs-number">1</span> Chunk → <span class="hljs-number">1</span> Bundle                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Chunk 的三种产生方式</strong>：</p>

























<table><thead><tr><th>产生方式</th><th>触发条件</th><th>示例</th></tr></thead><tbody><tr><td><strong>Entry Chunk</strong></td><td>每个 entry 配置</td><td><code>entry: { main: './src/index.js' }</code></td></tr><tr><td><strong>Async Chunk</strong></td><td>动态导入 <code>import()</code></td><td><code>import('./lazy.js')</code></td></tr><tr><td><strong>Split Chunk</strong></td><td>SplitChunks 配置提取公共模块</td><td><code>splitChunks: { chunks: 'all' }</code></td></tr></tbody></table>
<h4 data-id="heading-31">5.3 完整构建流程</h4>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────────────────────────┐
│                          Webpack 构建全流程                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────┐ │
│  │Initialize│───→│   Make   │───→│   Seal   │───→│ Optimize │───→│ Emit  │ │
│  │  初始化   │    │  构建    │    │   封装   │    │   优化   │    │ 输出  │ │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └───────┘ │
│       │               │               │               │              │      │
│       ▼               ▼               ▼               ▼              ▼      │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────┐ │
│  │合并配置   │    │从Entry   │    │形成Chunk │    │SplitChunks│   │写入   │ │
│  │创建Compiler│   │递归解析  │    │建立映射  │    │TreeShaking│   │文件   │ │
│  │注册Plugin │    │执行Loader│    │生成代码  │    │压缩混淆  │    │系统   │ │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └───────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-32">5.3.1 Initialize 阶段</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 核心任务</span>
<span class="hljs-comment">// 1. 合并配置（命令行 + 配置文件 + 默认值）</span>
<span class="hljs-keyword">const</span> options = <span class="hljs-title function_">merge</span>(defaultConfig, userConfig, cliConfig);

<span class="hljs-comment">// 2. 创建 Compiler 实例（全局单例）</span>
<span class="hljs-keyword">const</span> compiler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Compiler</span>(options);

<span class="hljs-comment">// 3. 注册所有插件</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> options.<span class="hljs-property">plugins</span>) {
  plugin.<span class="hljs-title function_">apply</span>(compiler);  <span class="hljs-comment">// 插件通过 apply 方法注入 hooks</span>
}

<span class="hljs-comment">// 4. 触发 environment 钩子</span>
compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">environment</span>.<span class="hljs-title function_">call</span>();
compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterEnvironment</span>.<span class="hljs-title function_">call</span>();
</code></pre>
<h5 data-id="heading-33">5.3.2 Make 阶段（核心：构建 ModuleGraph）</h5>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────────────────┐
│                           <span class="hljs-title class_">Make</span> 阶段详解                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   <span class="hljs-title class_">Entry</span> <span class="hljs-title class_">Point</span>                      递归处理流程                          │
│   ┌─────────┐                                                           │
│   │index.<span class="hljs-property">js</span> │                                                           │
│   └────┬────┘                                                           │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  <span class="hljs-title class_">Step</span> <span class="hljs-number">1</span>: 创建 <span class="hljs-title class_">Module</span>                                             │  │
│   │  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NormalModule</span>({                               │  │
│   │    <span class="hljs-attr">request</span>: <span class="hljs-string">'./src/index.js'</span>,                                    │  │
│   │    <span class="hljs-attr">type</span>: <span class="hljs-string">'javascript/auto'</span>,                                      │  │
│   │    <span class="hljs-attr">loaders</span>: [babel-loader, ...]                                  │  │
│   │  });                                                             │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  <span class="hljs-title class_">Step</span> <span class="hljs-number">2</span>: <span class="hljs-title class_">Loader</span> 转换                                             │  │
│   │  source = <span class="hljs-title function_">runLoaders</span>(loaders, originalSource);                   │  │
│   │                                                                  │  │
│   │  <span class="hljs-comment">// Loader 链式调用（从右到左）                                   │  │</span>
│   │  <span class="hljs-comment">// sass-loader → css-loader → style-loader                      │  │</span>
│   │  <span class="hljs-comment">// ts-loader → babel-loader                                     │  │</span>
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  <span class="hljs-title class_">Step</span> <span class="hljs-number">3</span>: <span class="hljs-variable constant_">AST</span> 解析，提取依赖                                       │  │
│   │  <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(source);                                      │  │
│   │                                                                  │  │
│   │  <span class="hljs-comment">// 识别 import/require 语句                                      │  │</span>
│   │  <span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;  → <span class="hljs-title class_">HarmonyImportDependency</span>         │  │
│   │  <span class="hljs-built_in">require</span>(<span class="hljs-string">'./config'</span>);          → <span class="hljs-title class_">CommonJsDependency</span>              │  │
│   │  <span class="hljs-keyword">import</span>(<span class="hljs-string">'./lazy'</span>);             → <span class="hljs-title class_">ImportDependency</span> (<span class="hljs-keyword">async</span>)        │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  <span class="hljs-title class_">Step</span> <span class="hljs-number">4</span>: 递归处理依赖                                            │  │
│   │  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>) {                        │  │
│   │    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleModuleCreation</span>(dep);  <span class="hljs-comment">// 递归回到 Step 1           │  │</span>
│   │  }                                                               │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│        │                                                                │
│        ▼                                                                │
│   最终产物：<span class="hljs-title class_">ModuleGraph</span>（依赖关系图）                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-34">5.3.3 Seal 阶段（核心：生成 Chunk）</h5>
<p>这是 <strong>SplitChunks 生效的阶段</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                           <span class="hljs-string">Seal</span> <span class="hljs-string">阶段详解</span>                                   <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">Step 1:</span> <span class="hljs-string">形成初始</span> <span class="hljs-string">Chunk</span>                                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">Entry</span> <span class="hljs-string">A</span> <span class="hljs-string">──→</span> <span class="hljs-string">Initial</span> <span class="hljs-string">Chunk</span> <span class="hljs-string">A</span>                                    <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>              <span class="hljs-string">├──</span> <span class="hljs-string">a.js</span>                                           <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>              <span class="hljs-string">├──</span> <span class="hljs-string">utils.js</span> <span class="hljs-string">(被</span> <span class="hljs-string">A、B</span> <span class="hljs-string">都引用)</span>                       <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>              <span class="hljs-string">└──</span> <span class="hljs-string">lodash</span>   <span class="hljs-string">(被</span> <span class="hljs-string">A、B</span> <span class="hljs-string">都引用)</span>                       <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">Entry</span> <span class="hljs-string">B</span> <span class="hljs-string">──→</span> <span class="hljs-string">Initial</span> <span class="hljs-string">Chunk</span> <span class="hljs-string">B</span>                                    <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>              <span class="hljs-string">├──</span> <span class="hljs-string">b.js</span>                                           <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>              <span class="hljs-string">├──</span> <span class="hljs-string">utils.js</span> <span class="hljs-string">(重复！)</span>                               <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>              <span class="hljs-string">└──</span> <span class="hljs-string">lodash</span>   <span class="hljs-string">(重复！)</span>                               <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">import()</span> <span class="hljs-string">──→</span> <span class="hljs-string">Async</span> <span class="hljs-string">Chunk</span>                                       <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>              <span class="hljs-string">└──</span> <span class="hljs-string">lazy.js</span>                                        <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                              <span class="hljs-string">│</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                              <span class="hljs-string">▼</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">Step 2:</span> <span class="hljs-string">SplitChunks</span> <span class="hljs-string">优化（optimizeChunks</span> <span class="hljs-string">钩子）</span>                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">遍历所有</span> <span class="hljs-string">Module，检查：</span>                                         <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">┌───────────────────────────────────────────────────────────┐</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-attr">lodash:</span>                                                  <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">被引用次数:</span> <span class="hljs-number">2</span> <span class="hljs-string">(Chunk</span> <span class="hljs-string">A,</span> <span class="hljs-string">B)</span>    <span class="hljs-string">≥</span> <span class="hljs-attr">minChunks:</span> <span class="hljs-number">1</span>   <span class="hljs-string">✓</span>    <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">模块大小:</span> <span class="hljs-string">70KB</span>                <span class="hljs-string">≥</span> <span class="hljs-attr">minSize:</span> <span class="hljs-string">20KB</span>  <span class="hljs-string">✓</span>    <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">来源:</span> <span class="hljs-string">node_modules</span>            <span class="hljs-string">匹配</span> <span class="hljs-string">test</span> <span class="hljs-string">正则</span>   <span class="hljs-string">✓</span>    <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">→</span> <span class="hljs-string">提取到</span> <span class="hljs-string">vendors</span> <span class="hljs-string">chunk</span>                                 <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">└───────────────────────────────────────────────────────────┘</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">┌───────────────────────────────────────────────────────────┐</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-attr">utils.js:</span>                                                <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">被引用次数:</span> <span class="hljs-number">2</span> <span class="hljs-string">(Chunk</span> <span class="hljs-string">A,</span> <span class="hljs-string">B)</span>    <span class="hljs-string">≥</span> <span class="hljs-attr">minChunks:</span> <span class="hljs-number">2</span>   <span class="hljs-string">✓</span>    <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-bullet">-</span> <span class="hljs-string">模块大小:</span> <span class="hljs-string">5KB</span>                 <span class="hljs-string">&lt;</span> <span class="hljs-attr">minSize:</span> <span class="hljs-string">20KB</span>  <span class="hljs-string">✗</span>    <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">→</span> <span class="hljs-string">不提取，保留在原</span> <span class="hljs-string">chunk</span>                               <span class="hljs-string">│</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">└───────────────────────────────────────────────────────────┘</span> <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                              <span class="hljs-string">│</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                              <span class="hljs-string">▼</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">Step 3:</span> <span class="hljs-string">代码生成</span>                                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">最终</span> <span class="hljs-string">Chunk</span> <span class="hljs-string">结构:</span>                                               <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-attr">Chunk A:</span>  <span class="hljs-string">a.js</span> <span class="hljs-string">+</span> <span class="hljs-string">utils.js</span>                                      <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-attr">Chunk B:</span>  <span class="hljs-string">b.js</span> <span class="hljs-string">+</span> <span class="hljs-string">utils.js</span>                                      <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-attr">Chunk vendors:</span> <span class="hljs-string">lodash</span>                                          <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-attr">Chunk async:</span> <span class="hljs-string">lazy.js</span>                                           <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">为每个</span> <span class="hljs-string">Chunk</span> <span class="hljs-string">生成代码：</span>                                         <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">包裹</span> <span class="hljs-string">Module</span> <span class="hljs-string">为函数</span>                                           <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">注入</span> <span class="hljs-string">Runtime</span> <span class="hljs-string">代码</span>                                            <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">建立</span> <span class="hljs-string">Chunk</span> <span class="hljs-string">间依赖关系</span>                                        <span class="hljs-string">│</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                         <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h4 data-id="heading-35">5.4 Module 包裹机制</h4>
<h5 data-id="heading-36">为什么要包裹成函数？</h5>
<pre><code class="hljs language-java" lang="java">┌─────────────────────────────────────────────────────────────────────────┐
│                       Module 包裹的三大目的                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  <span class="hljs-number">1.</span> 创建独立作用域                                                       │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │  每个模块的变量不会污染全局                                     │  │
│     │  <span class="hljs-type">var</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">'a.js'</span> 和 <span class="hljs-type">var</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">'b.js'</span> 不会冲突               │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  <span class="hljs-number">2.</span> 注入模块系统                                                         │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │  <span class="hljs-keyword">module</span>        → 当前模块对象                                   │  │
│     │  <span class="hljs-keyword">exports</span>       → 导出对象 (<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> 的引用)               │  │
│     │  __webpack_require__ → 引入其他模块的函数                       │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  <span class="hljs-number">3.</span> 按需执行 + 缓存                                                      │
│     ┌───────────────────────────────────────────────────────────────┐  │
│     │  函数只有被 require 时才执行（惰性加载）                        │  │
│     │  执行一次后结果被缓存到 installedModules（单例模式）            │  │
│     └───────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-37">包裹前后对比</h5>
<p><strong>源代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/utils.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> name = <span class="hljs-string">'utils'</span>;
</code></pre>
<p><strong>编译后（ES Module）</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-string">"./src/utils.js"</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
  <span class="hljs-string">"use strict"</span>;
  <span class="hljs-comment">// 标记为 ES Module（用于和 CommonJS 区分）</span>
  __webpack_require__.<span class="hljs-title function_">r</span>(__webpack_exports__);

  <span class="hljs-comment">// 定义导出（使用 getter，实现 live binding）</span>
  __webpack_require__.<span class="hljs-title function_">d</span>(__webpack_exports__, {
    <span class="hljs-string">"add"</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> add; },
    <span class="hljs-string">"name"</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> name; }
  });

  <span class="hljs-comment">// 原始代码</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
  <span class="hljs-keyword">const</span> name = <span class="hljs-string">'utils'</span>;
}
</code></pre>
<h4 data-id="heading-38">5.5 最终 Bundle 结构</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// bundle.js</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params">modules</span>) {
  <span class="hljs-comment">// ========== Runtime 代码 ==========</span>

  <span class="hljs-comment">// 模块缓存</span>
  <span class="hljs-keyword">var</span> installedModules = {};

  <span class="hljs-comment">// 核心加载函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">__webpack_require__</span>(<span class="hljs-params">moduleId</span>) {
    <span class="hljs-comment">// 检查缓存</span>
    <span class="hljs-keyword">if</span> (installedModules[moduleId]) {
      <span class="hljs-keyword">return</span> installedModules[moduleId].<span class="hljs-property">exports</span>;
    }

    <span class="hljs-comment">// 创建新模块</span>
    <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = installedModules[moduleId] = {
      <span class="hljs-attr">i</span>: moduleId,
      <span class="hljs-attr">l</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">exports</span>: {}
    };

    <span class="hljs-comment">// 执行模块函数</span>
    modules[moduleId].<span class="hljs-title function_">call</span>(
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>,
      <span class="hljs-variable language_">module</span>,
      <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>,
      __webpack_require__
    );

    <span class="hljs-variable language_">module</span>.<span class="hljs-property">l</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
  }

  <span class="hljs-comment">// 工具函数</span>
  __webpack_require__.<span class="hljs-property">r</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-built_in">exports</span>, <span class="hljs-string">'__esModule'</span>, { <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> });
  };

  __webpack_require__.<span class="hljs-property">d</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">exports</span>, definition</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> definition) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-built_in">exports</span>, key, {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: definition[key]  <span class="hljs-comment">// getter 实现 live binding</span>
      });
    }
  };

  <span class="hljs-comment">// ========== 启动入口 ==========</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">__webpack_require__</span>(<span class="hljs-string">'./src/index.js'</span>);

})({
  <span class="hljs-comment">// ========== 所有 Module（包裹后）==========</span>
  <span class="hljs-string">"./src/index.js"</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, <span class="hljs-built_in">exports</span>, __webpack_require__</span>) {
    <span class="hljs-keyword">var</span> utils = <span class="hljs-title function_">__webpack_require__</span>(<span class="hljs-string">"./src/utils.js"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));
  },
  <span class="hljs-string">"./src/utils.js"</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
    __webpack_require__.<span class="hljs-title function_">r</span>(__webpack_exports__);
    __webpack_require__.<span class="hljs-title function_">d</span>(__webpack_exports__, {
      <span class="hljs-string">"add"</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> add; }
    });
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
  }
});
</code></pre>
<hr/>
<h3 data-id="heading-39">第六章：Webpack 运行时机制</h3>
<blockquote>
<p><strong>本章解决的问题</strong>：Webpack 打包后的代码在浏览器中是如何运行的？同步和异步加载是如何实现的？</p>
</blockquote>
<h4 data-id="heading-40">6.1 同步加载：<code>__webpack_require__</code></h4>
<pre><code class="hljs language-java" lang="java">┌─────────────────────────────────────────────────────────────────────────┐
│                    __webpack_require__(moduleId) 流程                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         require(<span class="hljs-string">'./utils.js'</span>)                           │
│                                   │                                     │
│                                   ▼                                     │
│                    ┌──────────────────────────────┐                     │
│                    │   检查 installedModules      │                     │
│                    │   是否有缓存？                │                     │
│                    └──────────────────────────────┘                     │
│                           │                                             │
│              ┌────────────┴────────────┐                                │
│              │ YES                     │ NO                             │
│              ▼                         ▼                                │
│      ┌─────────────┐         ┌─────────────────────┐                   │
│      │ 直接返回     │         │ 创建 <span class="hljs-keyword">module</span> 对象     │                   │
│      │ 缓存的       │         │ {                   │                   │
│      │ <span class="hljs-keyword">exports</span>     │         │   i: moduleId,      │                   │
│      └─────────────┘         │   l: <span class="hljs-literal">false</span>,         │                   │
│                              │   <span class="hljs-keyword">exports</span>: {}       │                   │
│                              │ }                   │                   │
│                              └─────────────────────┘                   │
│                                        │                                │
│                                        ▼                                │
│                              ┌─────────────────────┐                   │
│                              │ 放入缓存             │                   │
│                              │ installedModules    │                   │
│                              │ [moduleId] = <span class="hljs-keyword">module</span> │                   │
│                              └─────────────────────┘                   │
│                                        │                                │
│                                        ▼                                │
│                              ┌─────────────────────┐                   │
│                              │ 执行模块函数         │                   │
│                              │ modules[moduleId]   │                   │
│                              │ .call(...)          │                   │
│                              └─────────────────────┘                   │
│                                        │                                │
│                                        ▼                                │
│                              ┌─────────────────────┐                   │
│                              │ <span class="hljs-keyword">module</span>.l = <span class="hljs-literal">true</span>     │                   │
│                              │ 返回 <span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> │                   │
│                              └─────────────────────┘                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-41">6.2 异步加载：<code>__webpack_require__.e</code></h4>
<p>动态 <code>import()</code> 会被转换为 <code>__webpack_require__.e</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">import</span>(<span class="hljs-string">'./lazy'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
  <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>();
});

<span class="hljs-comment">// 编译后</span>
__webpack_require__.<span class="hljs-title function_">e</span>(<span class="hljs-comment">/* chunkId */</span> <span class="hljs-string">'lazy'</span>)
  .<span class="hljs-title function_">then</span>(__webpack_require__.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">'./src/lazy.js'</span>))
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
    <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>();
  });
</code></pre>
<p><strong><code>__webpack_require__.e</code> 实现原理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Chunk 加载状态</span>
<span class="hljs-comment">// undefined: 未加载</span>
<span class="hljs-comment">// [resolve, reject]: 正在加载</span>
<span class="hljs-comment">// 0: 已加载</span>
<span class="hljs-keyword">var</span> installedChunks = {};

__webpack_require__.<span class="hljs-property">e</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">chunkId</span>) {
  <span class="hljs-keyword">var</span> promises = [];

  <span class="hljs-keyword">var</span> installedChunkData = installedChunks[chunkId];

  <span class="hljs-comment">// 0 表示已加载</span>
  <span class="hljs-keyword">if</span> (installedChunkData !== <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 正在加载中，复用 Promise</span>
    <span class="hljs-keyword">if</span> (installedChunkData) {
      promises.<span class="hljs-title function_">push</span>(installedChunkData[<span class="hljs-number">2</span>]);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 创建新的 Promise</span>
      <span class="hljs-keyword">var</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
        installedChunkData = installedChunks[chunkId] = [resolve, reject];
      });
      promises.<span class="hljs-title function_">push</span>(installedChunkData[<span class="hljs-number">2</span>] = promise);

      <span class="hljs-comment">// 创建 script 标签</span>
      <span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">charset</span> = <span class="hljs-string">'utf-8'</span>;
      script.<span class="hljs-property">timeout</span> = <span class="hljs-number">120</span>;
      script.<span class="hljs-property">src</span> = __webpack_require__.<span class="hljs-property">p</span> + chunkId + <span class="hljs-string">'.bundle.js'</span>;

      <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(promises);
};
</code></pre>
<h4 data-id="heading-42">6.3 异步 Chunk 的注册（JSONP）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// lazy.chunk.js（异步 chunk 文件格式）</span>
(<span class="hljs-variable language_">window</span>[<span class="hljs-string">"webpackJsonp"</span>] = <span class="hljs-variable language_">window</span>[<span class="hljs-string">"webpackJsonp"</span>] || []).<span class="hljs-title function_">push</span>([
  [<span class="hljs-string">"lazy"</span>],  <span class="hljs-comment">// chunkIds</span>
  {          <span class="hljs-comment">// modules</span>
    <span class="hljs-string">"./src/lazy.js"</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, <span class="hljs-built_in">exports</span></span>) {
      <span class="hljs-built_in">exports</span>.<span class="hljs-property">doSomething</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"lazy loaded!"</span>);
      };
    }
  }
]);
</code></pre>
<p><strong>主 bundle 中的 JSONP 回调注册</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注册 JSONP 回调</span>
<span class="hljs-keyword">var</span> jsonpArray = <span class="hljs-variable language_">window</span>[<span class="hljs-string">"webpackJsonp"</span>] = <span class="hljs-variable language_">window</span>[<span class="hljs-string">"webpackJsonp"</span>] || [];
<span class="hljs-keyword">var</span> oldJsonpFunction = jsonpArray.<span class="hljs-property">push</span>.<span class="hljs-title function_">bind</span>(jsonpArray);

jsonpArray.<span class="hljs-property">push</span> = webpackJsonpCallback;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">webpackJsonpCallback</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">var</span> chunkIds = data[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">var</span> moreModules = data[<span class="hljs-number">1</span>];

  <span class="hljs-comment">// 将新模块添加到 modules 对象</span>
  <span class="hljs-keyword">for</span> (moduleId <span class="hljs-keyword">in</span> moreModules) {
    modules[moduleId] = moreModules[moduleId];
  }

  <span class="hljs-comment">// 标记 chunk 已加载，执行 resolve</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; chunkIds.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">var</span> chunkId = chunkIds[i];
    <span class="hljs-keyword">if</span> (installedChunks[chunkId]) {
      installedChunks[chunkId][<span class="hljs-number">0</span>]();  <span class="hljs-comment">// resolve</span>
    }
    installedChunks[chunkId] = <span class="hljs-number">0</span>;     <span class="hljs-comment">// 标记已加载</span>
  }
}
</code></pre>
<h4 data-id="heading-43">6.4 运行时流程总览</h4>
<pre><code class="hljs language-xml" lang="xml">┌─────────────────────────────────────────────────────────────────────────┐
│                          运行时完整流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  页面加载                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>                                 │   │
│  │ <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"vendor.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  初始化 Runtime                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ • 创建 installedModules 缓存                                     │   │
│  │ • 创建 installedChunks 缓存                                      │   │
│  │ • 定义 __webpack_require__ 函数                                  │   │
│  │ • 注册 JSONP 回调                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              ▼                                          │
│  执行入口模块                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ __webpack_require__("./src/index.js")                           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│               ┌──────────────┴──────────────┐                           │
│               │                             │                           │
│               ▼                             ▼                           │
│  同步依赖                              异步依赖                          │
│  ┌────────────────────┐            ┌────────────────────┐              │
│  │__webpack_require__ │            │__webpack_require__.e│              │
│  │ 从 modules 取      │            │ 创建 script 标签   │              │
│  │ 执行 + 缓存        │            │ 加载 chunk 文件    │              │
│  └────────────────────┘            └────────────────────┘              │
│                                             │                           │
│                                             ▼                           │
│                                    ┌────────────────────┐              │
│                                    │ JSONP 回调         │              │
│                                    │ 注册新 modules     │              │
│                                    │ resolve Promise    │              │
│                                    └────────────────────┘              │
│                                             │                           │
│                                             ▼                           │
│                                    ┌────────────────────┐              │
│                                    │__webpack_require__ │              │
│                                    │ 执行异步模块       │              │
│                                    └────────────────────┘              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-44">第七章：优化策略与最佳实践</h3>
<blockquote>
<p><strong>本章解决的问题</strong>：如何利用 ESM 的静态特性和 Webpack 的优化能力，实现最佳的构建效果？</p>
</blockquote>
<h4 data-id="heading-45">7.1 Tree Shaking 原理</h4>
<p><strong>Tree Shaking</strong>：移除 JavaScript 中未使用的代码（Dead Code Elimination）</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────────┐
│                <span class="hljs-title class_">Tree</span> <span class="hljs-title class_">Shaking</span> 工作原理                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  源代码（math.<span class="hljs-property">js</span>）                                               │
│  ─────────────                                                   │
│  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;      <span class="hljs-comment">// 被使用              │</span>
│  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">sub</span> = (<span class="hljs-params">a, b</span>) =&gt; a - b;      <span class="hljs-comment">// 未使用              │</span>
│  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">mul</span> = (<span class="hljs-params">a, b</span>) =&gt; a * b;      <span class="hljs-comment">// 未使用              │</span>
│                                                                  │
│  使用方（index.<span class="hljs-property">js</span>）                                              │
│  ─────────────                                                   │
│  <span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>;                                │
│  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));                                         │
│                                                                  │
│         │                                                        │
│         ▼                                                        │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  阶段 <span class="hljs-number">1</span>: <span class="hljs-title class_">Webpack</span> 标记（<span class="hljs-title class_">Mark</span> <span class="hljs-title class_">Phase</span>）                      │    │
│  │  ─────────────────────────────────                       │    │
│  │  分析 <span class="hljs-keyword">import</span> 语句 → 标记 add 为<span class="hljs-string">"已使用"</span>                  │    │
│  │  sub, mul 没有被任何 <span class="hljs-keyword">import</span> → 标记为<span class="hljs-string">"未使用"</span>             │    │
│  │                                                          │    │
│  │  生成代码（带标记）：                                    │    │
│  │  __webpack_require__.<span class="hljs-title function_">d</span>(<span class="hljs-built_in">exports</span>, { <span class="hljs-attr">add</span>: <span class="hljs-function">() =&gt;</span> add });     │    │
│  │  <span class="hljs-comment">/* unused harmony export sub */</span>                         │    │
│  │  <span class="hljs-comment">/* unused harmony export mul */</span>                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│         │                                                        │
│         ▼                                                        │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  阶段 <span class="hljs-number">2</span>: <span class="hljs-title class_">Terser</span> 删除（<span class="hljs-title class_">Sweep</span> <span class="hljs-title class_">Phase</span>）                      │    │
│  │  ─────────────────────────────────                       │    │
│  │  识别 unused 标记 → 这些变量没有被引用                   │    │
│  │  安全删除 sub 和 mul 的定义                              │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│         │                                                        │
│         ▼                                                        │
│                                                                  │
│  最终 <span class="hljs-title class_">Bundle</span>                                                     │
│  ──────────                                                      │
│  <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;  <span class="hljs-comment">// 只保留 add！                   │</span>
│  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Tree Shaking 生效条件</strong>：</p>



































<table><thead><tr><th>条件</th><th>说明</th><th>原因</th></tr></thead><tbody><tr><td>使用 ESM</td><td><code>import</code>/<code>export</code> 语法</td><td>静态分析的前提</td></tr><tr><td>production 模式</td><td>或 <code>usedExports: true</code></td><td>启用标记功能</td></tr><tr><td>声明无副作用</td><td><code>sideEffects: false</code></td><td>告诉打包工具可安全删除</td></tr><tr><td>启用压缩</td><td>Terser/UglifyJS</td><td>实际删除代码</td></tr><tr><td>避免整体导入</td><td>用 <code>{ a }</code> 不用 <code>* as</code></td><td>明确使用范围</td></tr></tbody></table>
<h4 data-id="heading-46">7.2 sideEffects 配置</h4>
<p><strong>什么是副作用？</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ─────────── 有副作用 ───────────</span>
<span class="hljs-comment">// polyfill.js - 修改全局对象</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {};

<span class="hljs-comment">// analytics.js - 执行时发送请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/track?page=home'</span>);

<span class="hljs-comment">// styles.css - 影响页面样式</span>
.<span class="hljs-property">button</span> { <span class="hljs-attr">color</span>: red; }

<span class="hljs-comment">// ─────────── 无副作用 ───────────</span>
<span class="hljs-comment">// utils.js - 纯函数，不影响外部</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">format</span> = (<span class="hljs-params">str</span>) =&gt; str.<span class="hljs-title function_">trim</span>();
</code></pre>
<p><strong>package.json 配置</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-library"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-library"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"*.css"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"*.scss"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"./src/polyfill.js"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-47">7.3 代码分割策略（SplitChunks）</h4>
<p><strong>默认配置详解</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">optimization</span>: {
  <span class="hljs-attr">splitChunks</span>: {
    <span class="hljs-comment">// 对哪些 chunk 生效</span>
    <span class="hljs-comment">// 'async': 只处理异步 chunk（默认）</span>
    <span class="hljs-comment">// 'initial': 只处理入口 chunk</span>
    <span class="hljs-comment">// 'all': 处理所有 chunk（推荐）</span>
    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'async'</span>,

    <span class="hljs-comment">// 分割阈值</span>
    <span class="hljs-attr">minSize</span>: <span class="hljs-number">20000</span>,           <span class="hljs-comment">// 最小 20KB 才分割</span>
    <span class="hljs-attr">minRemainingSize</span>: <span class="hljs-number">0</span>,      <span class="hljs-comment">// 分割后剩余最小体积</span>
    <span class="hljs-attr">minChunks</span>: <span class="hljs-number">1</span>,             <span class="hljs-comment">// 最少被引用 1 次</span>

    <span class="hljs-comment">// 并行请求限制</span>
    <span class="hljs-attr">maxAsyncRequests</span>: <span class="hljs-number">30</span>,     <span class="hljs-comment">// 按需加载时最大并行请求数</span>
    <span class="hljs-attr">maxInitialRequests</span>: <span class="hljs-number">30</span>,   <span class="hljs-comment">// 入口点最大并行请求数</span>

    <span class="hljs-comment">// 缓存组（核心配置）</span>
    <span class="hljs-attr">cacheGroups</span>: {
      <span class="hljs-comment">// 第三方库</span>
      <span class="hljs-attr">defaultVendors</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
        <span class="hljs-attr">priority</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-comment">// 公共模块</span>
      <span class="hljs-attr">default</span>: {
        <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">priority</span>: -<span class="hljs-number">20</span>,
        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
      },
    },
  },
}
</code></pre>
<p><strong>推荐配置</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">optimization</span>: {
  <span class="hljs-attr">splitChunks</span>: {
    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
    <span class="hljs-attr">cacheGroups</span>: {
      <span class="hljs-comment">// React 全家桶单独打包</span>
      <span class="hljs-attr">react</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](react|react-dom|react-router)[\\/]/</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'react-vendor'</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
      },
      <span class="hljs-comment">// 其他第三方库</span>
      <span class="hljs-attr">vendors</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
      },
      <span class="hljs-comment">// 业务公共模块</span>
      <span class="hljs-attr">common</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'common'</span>,
        <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">5</span>,
        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>,
      },
    },
  },
  <span class="hljs-comment">// 运行时代码单独分离（利于缓存）</span>
  <span class="hljs-attr">runtimeChunk</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'runtime'</span>,
  },
}
</code></pre>
<h4 data-id="heading-48">7.4 模块输出格式</h4>















































<table><thead><tr><th>格式</th><th>导出语法</th><th>使用场景</th><th>Tree Shaking</th></tr></thead><tbody><tr><td><code>var</code></td><td><code>var MyLib = ...</code></td><td>全局变量</td><td>❌</td></tr><tr><td><code>commonjs</code></td><td><code>exports.MyLib = ...</code></td><td>Node.js</td><td>❌</td></tr><tr><td><code>commonjs2</code></td><td><code>module.exports = ...</code></td><td>Node.js</td><td>❌</td></tr><tr><td><code>amd</code></td><td><code>define([], factory)</code></td><td>RequireJS</td><td>❌</td></tr><tr><td><code>umd</code></td><td>通用模块定义</td><td>多环境兼容</td><td>❌</td></tr><tr><td><code>module</code></td><td><code>export { ... }</code></td><td>ES Module</td><td>✅</td></tr></tbody></table>
<p><strong>多格式输出配置</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js - 同时输出多种格式</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = [
  <span class="hljs-comment">// ESM 版本（现代环境，支持 Tree Shaking）</span>
  {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>,
    <span class="hljs-attr">experiments</span>: { <span class="hljs-attr">outputModule</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'my-library.esm.js'</span>,
      <span class="hljs-attr">library</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'module'</span> },
    },
  },
  <span class="hljs-comment">// CommonJS 版本（Node.js）</span>
  {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>,
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'my-library.cjs.js'</span>,
      <span class="hljs-attr">library</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'commonjs2'</span> },
    },
  },
  <span class="hljs-comment">// UMD 版本（浏览器直接引用）</span>
  {
    <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>,
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'my-library.umd.js'</span>,
      <span class="hljs-attr">library</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'MyLibrary'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'umd'</span> },
      <span class="hljs-attr">globalObject</span>: <span class="hljs-string">'this'</span>,
    },
  },
];
</code></pre>
<p><strong>对应 package.json</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-library"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-library.cjs.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-library.esm.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"browser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-library.umd.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"."</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"import"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-library.esm.js"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"require"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/my-library.cjs.js"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-49">7.5 最佳实践汇总</h4>
<h5 data-id="heading-50">模块规范选择</h5>
<pre><code class="hljs">┌────────────────────────────────────────────────────────────────┐
│                     模块规范选择指南                            │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐                                          │
│   │ 新项目？        │                                          │
│   └────────┬────────┘                                          │
│            │                                                    │
│      是 ←──┴──→ 否                                              │
│      │          │                                               │
│      ▼          ▼                                               │
│   ┌──────┐   ┌─────────────────┐                               │
│   │ ESM  │   │ 需要兼容老环境？ │                               │
│   └──────┘   └────────┬────────┘                               │
│                       │                                         │
│                 是 ←──┴──→ 否                                   │
│                 │          │                                    │
│                 ▼          ▼                                    │
│              ┌─────┐    ┌──────┐                                │
│              │ UMD │    │ ESM  │                                │
│              └─────┘    └──────┘                                │
│                                                                 │
│   ─────────────────────────────────────────────────────────    │
│                                                                 │
│   发布 npm 包？ ────────────→ 同时提供 ESM + CJS                │
│                                                                 │
│   CDN 直接引用？ ───────────→ UMD                               │
│                                                                 │
│   需要 Tree Shaking？ ──────→ ESM（必须）                       │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
</code></pre>
<h5 data-id="heading-51">导入最佳实践</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不推荐：导入整个库</span>
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
_.<span class="hljs-title function_">map</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);

<span class="hljs-comment">// ✅ 推荐：按需导入</span>
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash-es'</span>;
<span class="hljs-title function_">map</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>], <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);

<span class="hljs-comment">// ❌ 不推荐：命名空间导入（阻止 Tree Shaking）</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
utils.<span class="hljs-title function_">format</span>(str);

<span class="hljs-comment">// ✅ 推荐：具名导入</span>
<span class="hljs-keyword">import</span> { format } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-title function_">format</span>(str);

<span class="hljs-comment">// ✅ 懒加载：大模块动态导入</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadChart</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">Chart</span> } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./chart'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Chart</span>();
};
</code></pre>
<h5 data-id="heading-52">CommonJS 迁移到 ESM</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ─────────── CommonJS ───────────</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> { myFunc } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { a, b };
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">c</span> = c;

<span class="hljs-comment">// ─────────── ESM ───────────</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> { myFunc } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;  <span class="hljs-comment">// 注意扩展名！</span>

<span class="hljs-keyword">export</span> { a, b };
<span class="hljs-keyword">export</span> { c };

<span class="hljs-comment">// __dirname/__filename 替代方案</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'url'</span>;
<span class="hljs-keyword">import</span> { dirname } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>);
<span class="hljs-keyword">const</span> __dirname = <span class="hljs-title function_">dirname</span>(__filename);
</code></pre>
<hr/>
<h3 data-id="heading-53">附录：核心概念速查表</h3>
<h4 data-id="heading-54">A. 模块规范对比</h4>








































<table><thead><tr><th>特性</th><th>CommonJS</th><th>ESM</th></tr></thead><tbody><tr><td>语法</td><td>require/exports</td><td>import/export</td></tr><tr><td>加载时机</td><td>运行时</td><td>编译时</td></tr><tr><td>绑定类型</td><td>值拷贝</td><td>实时绑定</td></tr><tr><td>静态分析</td><td>❌</td><td>✅</td></tr><tr><td>Tree Shaking</td><td>❌</td><td>✅</td></tr><tr><td>顶层 await</td><td>❌</td><td>✅</td></tr></tbody></table>
<h4 data-id="heading-55">B. Webpack 构建阶段</h4>



































<table><thead><tr><th>阶段</th><th>核心任务</th><th>关键 Hook</th></tr></thead><tbody><tr><td><strong>Initialize</strong></td><td>合并配置、创建 Compiler、注册 Plugin</td><td><code>environment</code></td></tr><tr><td><strong>Make</strong></td><td>从 Entry 递归解析，执行 Loader，构建 ModuleGraph</td><td><code>make</code></td></tr><tr><td><strong>Seal</strong></td><td>生成 Chunk、执行 SplitChunks、生成代码</td><td><code>optimizeChunks</code></td></tr><tr><td><strong>Optimize</strong></td><td>Tree Shaking、压缩混淆</td><td><code>optimizeTree</code></td></tr><tr><td><strong>Emit</strong></td><td>输出 Bundle 文件</td><td><code>emit</code></td></tr></tbody></table>
<h4 data-id="heading-56">C. 运行时机制</h4>





























<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><code>__webpack_require__</code></td><td>同步加载模块，从 modules 对象取并执行</td></tr><tr><td><code>__webpack_require__.e</code></td><td>异步加载 Chunk，动态创建 script 标签</td></tr><tr><td><code>installedModules</code></td><td>模块缓存，避免重复执行</td></tr><tr><td><code>installedChunks</code></td><td>Chunk 缓存，避免重复加载</td></tr><tr><td><code>webpackJsonp</code></td><td>JSONP 回调，注册异步 Chunk 的模块</td></tr></tbody></table>
<h4 data-id="heading-57">D. 知识体系一图总结</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                    JavaScript 模块化知识体系                                 │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   历史演进                                                                   │
│   ────────                                                                   │
│   全局变量 → <span class="hljs-built_in">CommonJS</span>(Node) → <span class="hljs-built_in">AMD</span>(浏览器) → <span class="hljs-built_in">UMD</span>(通用) → <span class="hljs-built_in">ESM</span>(标准)            │
│                                                                              │
│   核心区别                                                                   │
│   ────────                                                                   │
│   CommonJS: 运行时加载，值拷贝，动态路径 → 无法 Tree Shaking                 │
│   ESM:      编译时分析，引用绑定，静态路径 → 支持 Tree Shaking               │
│                                                                              │
│   ESM 三阶段                                                                 │
│   ──────────                                                                 │
│   构建(解析依赖) → 实例化(分配内存/连接绑定) → 求值(执行代码)                │
│                                                                              │
│   构建工具链                                                                 │
│   ──────────                                                                 │
│   源码(ESM) → <span class="hljs-built_in">Babel</span>(保留ESM,转语法) → <span class="hljs-built_in">Webpack</span>(打包,标记) → <span class="hljs-built_in">Terser</span>(删除,压缩) │
│                                                                              │
│   Webpack 核心                                                               │
│   ────────────                                                               │
│   <span class="hljs-built_in">Module</span>(源文件) → <span class="hljs-built_in">Chunk</span>(中间态) → <span class="hljs-built_in">Bundle</span>(产物)                              │
│   <span class="hljs-built_in">Make</span>(构建ModuleGraph) → <span class="hljs-built_in">Seal</span>(生成Chunk) → <span class="hljs-built_in">Emit</span>(输出文件)                   │
│                                                                              │
│   最佳实践                                                                   │
│   ────────                                                                   │
│   • 新项目首选 ESM                                                           │
│   • npm 包同时提供 ESM + CJS                                                 │
│   • 按需导入，避免 import *                                                  │
│   • 配置 sideEffects: false                                                  │
│   • 大模块使用动态 <span class="hljs-built_in">import</span>() 懒加载                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[docker+nginx部署]]></title>    <link>https://juejin.cn/post/7593262196843708468</link>    <guid>https://juejin.cn/post/7593262196843708468</guid>    <pubDate>2026-01-10T07:52:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593262196843708468" data-draft-id="7593240931287515188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="docker+nginx部署"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-10T07:52:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不务正业的前端学徒"/> <meta itemprop="url" content="https://juejin.cn/user/1640911047494430"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            docker+nginx部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1640911047494430/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不务正业的前端学徒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T07:52:40.000Z" title="Sat Jan 10 2026 07:52:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>nginx.conf</strong></p>
<pre><code class="hljs language-js" lang="js">

worker_processes  <span class="hljs-number">1</span>;

events {
    worker_connections  <span class="hljs-number">1024</span>;
}

http {
    include       mime.<span class="hljs-property">types</span>;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  <span class="hljs-number">65</span>;
    server {
        listen       <span class="hljs-number">80</span>;
        server_name  localhost;
        

        location / {
            root   /usr/share/nginx/html;
            index  index.<span class="hljs-property">html</span> index.<span class="hljs-property">htm</span>;
        }

        error_page   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.<span class="hljs-property">html</span>;
        location = /50x.<span class="hljs-property">html</span> {
            root   html;
        }
    }
}


</code></pre>
<p><strong>Dockerfile</strong></p>
<pre><code class="hljs language-js" lang="js">
#引入node
<span class="hljs-variable constant_">FROM</span> node <span class="hljs-keyword">as</span> build
#拷贝当前文件夹到docker中的demo文件夹，demo文件夹自动生成
<span class="hljs-variable constant_">COPY</span> . ./demo
#定位到demo文件夹
<span class="hljs-variable constant_">WORKDIR</span> /demo
#设置源
<span class="hljs-variable constant_">RUN</span> npm config set registry <span class="hljs-attr">https</span>:<span class="hljs-comment">//registry.npm.taobao.org</span>
#下载
<span class="hljs-variable constant_">RUN</span> npm install
#打包
<span class="hljs-variable constant_">RUN</span> npm run build
#引入nginx
<span class="hljs-variable constant_">FROM</span> nginx
#复制项目的nginx.<span class="hljs-property">conf</span>到 /etc/nginx目录，并修改为文件名为nginx.<span class="hljs-property">conf</span>
<span class="hljs-variable constant_">COPY</span> nginx.<span class="hljs-property">conf</span> /etc/nginx/nginx.<span class="hljs-property">conf</span>
#复制生成的dist文件夹到nginx的html目录下
<span class="hljs-variable constant_">COPY</span> --<span class="hljs-keyword">from</span>=build /demo/dist /usr/share/nginx/html
#显式地标明镜像开放端口，一定程度上提供了操作的便利，也提高了 <span class="hljs-title class_">Dockerfile</span> 的可读性和可维护性
<span class="hljs-variable constant_">EXPOSE</span> <span class="hljs-number">80</span>
#运行nginx
<span class="hljs-variable constant_">CMD</span> [<span class="hljs-string">"nginx"</span>,<span class="hljs-string">"-g"</span>,<span class="hljs-string">"daemon off;"</span>] 


</code></pre>
<p>项目根目录运行命令，打包为镜像</p>
<pre><code class="hljs language-js" lang="js">docker image build -t vue_nginx_demo .
</code></pre>
<p>运行镜像</p>
<pre><code class="hljs language-js" lang="js">docker container run -p <span class="hljs-number">8090</span>:<span class="hljs-number">80</span> -d vue_nginx_demo

</code></pre>
<p>其他的自动化，使用jenkins或者k8s写部署脚本</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[启动 Taro 4 项目报错：Error: The specified module could not be found.]]></title>    <link>https://juejin.cn/post/7593242327933485066</link>    <guid>https://juejin.cn/post/7593242327933485066</guid>    <pubDate>2026-01-10T07:59:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593242327933485066" data-draft-id="7593541290991648818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="启动 Taro 4 项目报错：Error: The specified module could not be found."/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-10T07:59:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="霉运全滚蛋好运围着转"/> <meta itemprop="url" content="https://juejin.cn/user/2496369082771673"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            启动 Taro 4 项目报错：Error: The specified module could not be found.
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2496369082771673/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    霉运全滚蛋好运围着转
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T07:59:28.000Z" title="Sat Jan 10 2026 07:59:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在 Windows 上 clone 了一个之前就写好的 <strong>Taro 4.x 小程序项目</strong>，本地用 VS Code 启动的时候直接报错：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Error</span>: <span class="hljs-title class_">The</span> specified <span class="hljs-variable language_">module</span> could not be found.
…/node_modules/<span class="hljs-meta">@tarojs</span>/plugin-doctor-win32-x64-msvc/
taro-doctor.<span class="hljs-property">win32</span>-x64-msvc.<span class="hljs-property">nodez</span>
</code></pre>
<p>最后在taro的github里面找到了一样的问题</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de2328b66c1947dd8406cebe2c13dd73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZyJ6L-Q5YWo5rua6JuL5aW96L-Q5Zu0552A6L2s:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768636768&amp;x-signature=rMvfUCyYeo5SYOuDZVA6HXmR8Kc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0e2f737bfd34932a5db67481f925b8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZyJ6L-Q5YWo5rua6JuL5aW96L-Q5Zu0552A6L2s:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768636768&amp;x-signature=vpkfy%2FgPwNFvNJ4lby6WTNt0HkI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-0">原因</h3>
<p><code>taro-doctor.win32-x64-msvc.node</code> 是一个 <strong>Node 原生模块</strong>，<br/>
在 Windows 上运行时，需要系统里有对应的 <strong>VC++ 运行库</strong>。</p>
<p>如果系统里没有，或者版本不完整，Node 加载这个 <code>.node</code> 文件时就会直接报：</p>
<pre><code class="hljs language-arduino" lang="arduino">The specified <span class="hljs-keyword">module</span> could <span class="hljs-keyword">not</span> be found
</code></pre>
<p>即使文件本身是存在的。</p>
<h3 data-id="heading-1">解决方法</h3>
<p>去微软官网下载并安装最新版的 <strong>Microsoft Visual C++ Redistributable</strong>：</p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fzh-cn%2Fcpp%2Fwindows%2Flatest-supported-vc-redist" target="_blank" title="https://learn.microsoft.com/zh-cn/cpp/windows/latest-supported-vc-redist" ref="nofollow noopener noreferrer">learn.microsoft.com/zh-cn/cpp/w…</a></p>
<p>装完之后 <strong>重启了一次系统</strong>，再启动项目：</p>
<pre><code class="hljs language-arduino" lang="arduino">npm run dev
</code></pre>
<p>没有再报错，可以正常运行了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 框架设计（二）：糟糕的代码有哪些特点?]]></title>    <link>https://juejin.cn/post/7592876744526233650</link>    <guid>https://juejin.cn/post/7592876744526233650</guid>    <pubDate>2026-01-09T01:38:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744526233650" data-draft-id="7592833068224299054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 框架设计（二）：糟糕的代码有哪些特点?"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-09T01:38:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 框架设计（二）：糟糕的代码有哪些特点?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:38:19.000Z" title="Fri Jan 09 2026 01:38:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>前言</strong>
你有没有过这种经历：新接手了一个项目，产品经理让你把一个按钮往左移 5 像素。你心想：“这不有手就行？”
结果你改了 CSS，保存，刷新。 按钮是移过去了，但登录弹窗打不开了，控制台红了一片，甚至 CI/CD 流程都挂了。</p>
<p>这一刻，你面对的不是代码，而是一座摇摇欲坠的<strong>屎山</strong>。
在框架设计和组件库开发中，这种现象尤为致命。业务代码写烂了，坑的是一个页面；框架设计写烂了，坑的是整个团队。今天我们要聊的不是具体的变量命名或缩进，而是<strong>架构层面的“设计臭味”</strong> 。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b1b752cb9a54d9ba2541bf79c08082b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527527&amp;x-signature=3Ug%2Fp7CsV%2BF7P8t2zkMGz3ZQ16o%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">什么是“设计臭味”？</h2>
<p>“代码臭味”（Code Smell）这个词不是说代码真的有味儿（虽然有时候看代码确实想吐），而是指<strong>代码结构中某些特征暗示了深层次的设计问题</strong>。</p>
<p>它就像煤气泄漏的味道，本身不一定会炸，但只要有一点火星（新的需求变更），整个系统就会原地升天。</p>
<p>作为前端架构师或核心开发者，如果你在 Code Review 时闻到了以下这 <strong>5 种味道</strong>，请务必警惕。</p>
<hr/>
<h2 data-id="heading-1">1. 僵化性 (Rigidity)：牵一发而动全身</h2>
<p><strong>症状：</strong> 你想复用一个通用的 <code>Header</code> 组件，结果发现它里面硬编码了 <code>useRouter()</code> 的跳转逻辑，甚至还直接 <code>import</code> 了 <code>Redux/Pinia</code> 的 store。 你想在另一个项目用它？没门。除非你把那边的路由和状态管理全套搬过来。</p>
<p><strong>前端实战翻译：</strong> 这就是典型的<strong>高耦合</strong>。组件不再是一个独立的乐高积木，而是一块焊死在主板上的芯片。</p>
<p><strong>反面教材 (React)：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是一个充满僵化味道的组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">UserProfile</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 致命伤1：直接依赖具体的全局状态</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>.<span class="hljs-property">info</span>);
  <span class="hljs-comment">// 致命伤2：直接依赖具体的路由实现</span>
  <span class="hljs-keyword">const</span> history = <span class="hljs-title function_">useHistory</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogout</span> = (<span class="hljs-params"/>) =&gt; {
     <span class="hljs-comment">// 业务逻辑耦合在UI里</span>
     api.<span class="hljs-title function_">logout</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> history.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login'</span>));
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name} <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleLogout}</span>&gt;</span>退出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<p><strong>指南：</strong></p>
<ul>
<li><strong>控制反转 (IoC)</strong> ：组件只管展示，逻辑通过 <code>Props</code> 传进来。</li>
<li><strong>Presentational vs Container</strong>：把“展示组件”和“容器组件”拆开。展示组件要像“傻瓜”一样，给什么吃什么，不要自己去冰箱（Store）里拿。</li>
</ul>
<hr/>
<h2 data-id="heading-2">2. 脆弱性 (Fragility)：改东崩西的蝴蝶效应</h2>
<p><strong>症状：</strong> 这比僵化性更搞心态。僵化性是你改不动，脆弱性是<strong>你改了，但崩在了你完全想不到的地方</strong>。 比如：你为了优化首页加载速度，调整了一个公共 <code>utils</code> 函数，结果结算页面的金额计算错了，多给了用户 100 块钱。</p>
<p><strong>前端实战翻译：</strong> 通常源于<strong>隐式依赖</strong>、<strong>全局变量污染</strong>或者<strong>CSS 样式穿透</strong>。</p>
<p><strong>反面教材 (CSS/Vue)：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 这种写法在全局样式里简直是灾难 */</span>
<span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">color</span>: red;
}

<span class="hljs-comment">/* 或者在组件里滥用 !important */</span>
<span class="hljs-selector-class">.btn</span> {
  <span class="hljs-attribute">background</span>: blue <span class="hljs-meta">!important</span>; <span class="hljs-comment">/* 你的同事想覆盖这个样式时，必须写得比你更恶心 */</span>
}
</code></pre>
<p><strong>指南：</strong></p>
<ul>
<li><strong>CSS Modules / Scoped CSS / Tailwind</strong>：坚决消灭全局样式冲突。</li>
<li><strong>纯函数 (Pure Functions)</strong> ：工具类函数坚决不能有副作用，输入相同，输出必须相同。</li>
<li><strong>依赖显式化</strong>：别在组件里偷偷摸摸读 <code>window.xxx</code> 或者 <code>localStorage</code>，把它们封装成 Hooks 或服务。</li>
</ul>
<hr/>
<h2 data-id="heading-3">3. 顽固性 (Immobility)：无法拆分的连体婴</h2>
<p><strong>症状：</strong> 你写了一个非常炫酷的 <code>DataGrid</code> 表格，支持排序、筛选、分页。隔壁组看到了说：“哇，这个好，我也要用。” 你自信满满地把代码发给他。 五分钟后他跑来说：“哥，我只要个表格UI，你为什么把 <code>Axios</code> 拦截器、<code>ElementUI</code> 的弹窗组件、甚至你们公司的埋点 SDK 都打包进来了？”</p>
<p><strong>前端实战翻译：</strong> 这是<strong>内聚性低</strong>的表现。业务逻辑和基础设施、UI 逻辑混在一起，导致根本无法拆分复用。</p>
<p><strong>反面教材：</strong></p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 一个原本想做通用组件的 hook，却混入了业务</span>
function <span class="hljs-built_in">useTableData</span>(url) {
  const <span class="hljs-selector-attr">[data, setData]</span> = <span class="hljs-built_in">useState</span>([]);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-comment">// 错误：这里耦合了特定的 HTTP 库和业务上的 token 逻辑</span>
    axios<span class="hljs-selector-class">.get</span>(url, { headers: { 'X-Auth': localStorage.getItem('token') } })
      <span class="hljs-selector-class">.then</span>(res =&gt; setData(res.data.list)); <span class="hljs-comment">// 错误：硬编码了数据结构 res.data.list</span>
  }, <span class="hljs-selector-attr">[url]</span>);

  return data;
}
</code></pre>
<p><strong>指南：</strong></p>
<ul>
<li><strong>Headless UI</strong>：这是现在的设计趋势（如 React Table, TanStack Query）。只提供逻辑钩子，不提供 UI。</li>
<li><strong>依赖倒置</strong>：网络请求层应该作为参数传入，而不是在组件内部直接实例化。</li>
</ul>
<hr/>
<h2 data-id="heading-4">4. 粘滞性 (Viscosity)：做错误的事更容易</h2>
<p><strong>症状：</strong> 这是一个人性问题。 假设你的框架支持 TypeScript。</p>
<ul>
<li><strong>正确的做法</strong>：定义 Interface，继承 Props，处理泛型，写 Mock 数据，跑单元测试。需要 10 分钟。</li>
<li><strong>错误的做法</strong>：<code>any</code> 一把梭。需要 10 秒钟。</li>
</ul>
<p>当<strong>做正确的事</strong>比<strong>做错误的事</strong>阻力大得多时，开发者就会倾向于破坏架构。这就是粘滞性。</p>
<p><strong>前端实战翻译：</strong> 环境配置太复杂、类型定义太反人类、测试难写。</p>
<p><strong>反面教材：</strong> 如果你的组件库要求使用者必须写 5 层嵌套的配置对象才能跑起来，那使用者一定会想办法绕过配置，直接去改源码。</p>
<p><strong>指南：</strong></p>
<ul>
<li><strong>约定优于配置</strong>：像 Next.js 或 Nuxt.js 那样，文件放对位置路由就自动生成了。</li>
<li><strong>提供开箱即用的类型</strong>：别让用户自己去猜泛型填什么。</li>
<li><strong>路径依赖设计</strong>：让最简单的写法，就是最佳实践。</li>
</ul>
<hr/>
<h2 data-id="heading-5">5. 晦涩性 (Opacity) &amp; 过度设计 (Needless Complexity)</h2>
<p><strong>症状：</strong> 这两个往往相伴而生。 你打开一个同事的代码，看到了一堆 <code>AbstractFactoryProvider</code>、<code>HighOrderComponentWrapper</code>。 你只是想渲染一个输入框，结果你需要先创建一个 <code>FormConfig</code>，再实例化一个 <code>FieldBuilder</code>，最后通过 <code>RenderProp</code> 传进去。</p>
<p>开发者看着你的代码会感叹：“虽然看不懂，但感觉很厉害的样子。” —— 别傻了，他们心里在骂娘。</p>
<p><strong>前端实战翻译：</strong> 为了封装而封装。比如把简单的 <code>if-else</code> 逻辑抽象成极其复杂的策略模式，或者写了无比抽象的 Hooks，结果参数传了 8 个，返回值 12 个。</p>
<p><strong>指南：</strong></p>
<ul>
<li><strong>YAGNI 原则</strong> (You Ain't Gonna Need It)：不要为你臆想的未来需求写代码。</li>
<li><strong>代码如文章</strong>：好的代码应该像大白话一样。如果一段代码需要你写 10 行注释来解释“我为什么要绕这么大弯子”，那通常意味着设计失败。</li>
<li><strong>组合优于继承，简单优于抽象</strong>：在前端，特别是 React Hooks 中，平铺直叙的逻辑往往比层层嵌套的高阶组件要好维护得多。</li>
</ul>
<hr/>
<h2 data-id="heading-6">总结：如何避免成为“制造臭味”的人？</h2>
<p>设计框架就像盖楼。</p>
<ul>
<li><strong>僵化性</strong>是钢筋没绑好，想改户型得拆承重墙。</li>
<li><strong>脆弱性</strong>是地基没打牢，楼上装修楼下漏水。</li>
<li><strong>顽固性</strong>是水电管线混在一起，修电线得砸水管。</li>
<li><strong>粘滞性</strong>是垃圾道设计不合理，大家只好往楼下扔垃圾。</li>
</ul>
<p>要去除这些“味道”，最核心的心法只有一句话：</p>
<p><strong>保持代码的“软”度 (Software)。</strong></p>
<p>软件之所以叫软件，是因为它应该是易于改变的。当我们写下一行代码时，多问自己一句： <em>“如果明天这个需求变了，我今天写的这行代码是资产，还是债务？”</em></p>
<hr/>
<p><strong>互动话题</strong></p>
<p>你的项目里有没有那种“甚至不敢看它一眼，怕看一眼它就崩了”的代码？或者你见过最离谱的“过度设计”是什么样的？欢迎在评论区晒出你的“受苦”经历，让大家开心一下（划掉）避避坑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 混合模式下：saveLayer 混合注意点]]></title>    <link>https://juejin.cn/post/7592887786966351908</link>    <guid>https://juejin.cn/post/7592887786966351908</guid>    <pubDate>2026-01-09T03:24:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786966351908" data-draft-id="7592912896591364115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 混合模式下：saveLayer 混合注意点"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-09T03:24:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 混合模式下：saveLayer 混合注意点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:24:13.000Z" title="Fri Jan 09 2026 03:24:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>直接Paint 绘制混合</p>
<pre><code class="hljs language-js" lang="js">    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">20</span>;
    dstPaint.<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">stroke</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), dstPaint);

    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">yellowAccent</span> <span class="hljs-comment">// 源颜色：蓝色</span>
      ..<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">fill</span> <span class="hljs-comment">// 填充模式</span>
      ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">clear</span>
      ..<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">70</span>; <span class="hljs-comment">// 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height).<span class="hljs-title function_">deflate</span>(<span class="hljs-number">100</span>), srcPaint);
</code></pre>
<p>效果图：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca0ab18fc0104e1d80d75a1cc2911f2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533853&amp;x-signature=ixgv4WOlft17x7UqUQBFAz0m0vo%3D" alt="image.png" width="30%" loading="lazy"/>
<p>但是如果改成如下：</p>
<pre><code class="hljs language-js" lang="js">    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">20</span>;
    dstPaint.<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">stroke</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), dstPaint);
    
    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>), ui.<span class="hljs-title class_">Paint</span>()
    ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">clear</span>);

    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">yellowAccent</span> <span class="hljs-comment">// 源颜色：蓝色</span>
      ..<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">fill</span> <span class="hljs-comment">// 填充模式</span>
      ..<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">70</span>; <span class="hljs-comment">// 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height).<span class="hljs-title function_">deflate</span>(<span class="hljs-number">100</span>), srcPaint);
</code></pre>
<p>目测代码逻辑是一样的只是把混合模式设置给了Layer。但是最终效果就是界面上啥页没有全部被清空了。这是因为设置了混合模式之后,整个图层都会被当作src 进行混合。并且第一个设置范围的参数也不生效。</p>
<p>如果想限制到指定范围可以在saveLayer前加如下内容:</p>
<pre><code class="hljs language-js" lang="js">  canvas.<span class="hljs-title function_">clipRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>));
</code></pre>
<p>那么加完之后的效果图如下:</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/558f554184234155b5564810a7766348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533853&amp;x-signature=wsSloCb0DJ%2BswQJUI2LyUk7FxSE%3D" alt="image.png" width="30%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[“死了么”App荣登付费榜第一名！]]></title>    <link>https://juejin.cn/post/7593212374922117147</link>    <guid>https://juejin.cn/post/7593212374922117147</guid>    <pubDate>2026-01-10T06:48:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593212374922117147" data-draft-id="7593215107406151716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="“死了么”App荣登付费榜第一名！"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2026-01-10T06:48:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            “死了么”App荣登付费榜第一名！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T06:48:45.000Z" title="Sat Jan 10 2026 06:48:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>2026年初的App Store付费榜，突然杀出一匹“黑马”——一款名为 <strong>「“死了么 - 官方正版”」</strong> 的产品，以8元付费下载的模式，毫无征兆地登顶付费榜单榜首，成为今年首个现象级爆款。对于常年关注应用市场的开发者和从业者来说，这波操作堪称“惊喜与意外并存”：既好奇这款突然冒头的产品究竟有何魅力，更疑惑为何一款2025年就上架的产品，直到现在才迎来流量爆发。</p>
<p><img src="" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/035ed6c39d71464cbab494a864944c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632525&amp;x-signature=eQP5ljROs%2FNo2oVFKn%2Fva2U%2Fumo%3D" alt="f5521fe6324e395d5a821f0a3f03e95c.jpg" loading="lazy"/></p>
<h3 data-id="heading-1">榜单变化</h3>
<p>直观的榜单表现，打开App Store付费榜，“死了么 - 官方正版”赫然占据TOP1位置，远超同类付费应用，下载量和付费转化数据一路飙升。从榜单页面能清晰看到，这款产品的登顶直接打乱了原有榜单格局，不少常年盘踞前列的付费应用纷纷退居其后，足见其短期内的爆发力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/820b28d228df42358770d527545f5939~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632525&amp;x-signature=179AK6FwJgwyRiBWBO5cESH01m0%3D" alt="ScreenShot_2026-01-10_142553_600.png" loading="lazy"/></p>
<h3 data-id="heading-2">关键词变化</h3>
<p>从行业常规逻辑来看，应用上架后若出现名称违规、内容不符合平台规范、关键词堆砌等问题，就可能被平台下架或限制曝光（即“清词、清榜”）。“死了么 - 官方正版”大概率是在初期运营中触碰了平台规则红线，导致被限制传播。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82339af4e1664ae0ab746e7ec413d10f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768632525&amp;x-signature=IZhzT5yALvIuow0ELO54rcu2TjQ%3D" alt="3333.png" loading="lazy"/></p>
<p><code>遵守规则，方得长治久安</code>，最后祝大家大吉大利，今晚过审！</p>
<h3 data-id="heading-3">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FV2F4BaEYh5HfeUUHm1tI6Q" target="_blank" title="https://mp.weixin.qq.com/s/V2F4BaEYh5HfeUUHm1tI6Q" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（代码篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FLs3su8fmMckTocPwMmFaNQ" target="_blank" title="https://mp.weixin.qq.com/s/Ls3su8fmMckTocPwMmFaNQ" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（ASO篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）]]></title>    <link>https://juejin.cn/post/7592815497848930367</link>    <guid>https://juejin.cn/post/7592815497848930367</guid>    <pubDate>2026-01-09T01:56:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848930367" data-draft-id="7592508079306670099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）"/> <meta itemprop="keywords" content="前端,开源,全栈"/> <meta itemprop="datePublished" content="2026-01-09T01:56:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秋天的一阵风"/> <meta itemprop="url" content="https://juejin.cn/user/3588413946594925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3588413946594925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秋天的一阵风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:56:33.000Z" title="Fri Jan 09 2026 01:56:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong/></p><p align="center"><strong>Hello~大家好。我是秋天的一阵风</strong></p><p/>
<p>rrweb 的核心魅力在于 “用极小的数据量复现完整的页面操作”，这背后是 DOM 快照、增量更新、事件序列化等技术的精密协作。本文将从原理本质出发，用通俗类比 + 源码解析的方式，拆解每个技术模块的实现逻辑，同时揭示 rrweb 在兼容性、性能优化上的关键设计。</p>
<h2 data-id="heading-0">一、 DOM 快照生成原理（snapshot）</h2>
<p><strong>通俗类比</strong>：DOM 快照就像给页面拍 “全景工程图”—— 不是简单记录像素（如截图），而是把页面的 “骨架”（DOM 层级结构）、“皮肤”（CSS 样式）、“零件参数”（元素属性、文本内容）都转化为结构化数据，后续能根据这张 “工程图” 1:1 还原出与原页面一致的初始状态。区别于普通照片，这张 “工程图” 包含所有可编辑的 “零件信息”，而非固定的视觉图像。</p>
<h3 data-id="heading-1">1.1 核心目标与技术路径</h3>
<p>DOM 快照的核心目标是生成 “可序列化、可重建、体积小” 的 DOM 数据，技术路径分为三步：<strong>DOM 遍历与节点过滤</strong>→<strong>节点属性与样式序列化</strong>→<strong>资源引用处理</strong>，最终输出 JSON 格式的FullSnapshot事件（rrweb 事件类型标识为 2）。</p>
<h3 data-id="heading-2">1.2 关键实现逻辑（参考 rrweb-snapshot 源码）</h3>
<p><code>rrweb-snapshot</code> 库的 <code>takeSnapshot</code> 函数是快照生成的核心，关键步骤如下：</p>
<h4 data-id="heading-3">1.2.1 根节点遍历与过滤</h4>
<p>从<code>document.documentElement</code>（HTML 根节点）开始深度优先遍历，跳过无需录制的节点（如script、style标签，或带屏蔽类名的元素），避免无效数据占用空间：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：DOM节点遍历逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">traverseNode</span>(<span class="hljs-params">node, config</span>) {
  <span class="hljs-comment">// 过滤规则：跳过脚本、样式、屏蔽元素、不可见元素</span>
  <span class="hljs-keyword">const</span> isIgnored = 
    node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'SCRIPT'</span> || 
    node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'STYLE'</span> || 
    node.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(config.<span class="hljs-property">blockClass</span>) || 
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(node).<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>;
  <span class="hljs-keyword">if</span> (isIgnored) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// 序列化当前节点</span>
  <span class="hljs-keyword">const</span> nodeSnapshot = <span class="hljs-title function_">serializeNode</span>(node);
  <span class="hljs-comment">// 递归处理子节点（构建DOM树结构）</span>
  <span class="hljs-keyword">const</span> children = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> child <span class="hljs-keyword">of</span> node.<span class="hljs-property">childNodes</span>) {
    <span class="hljs-keyword">const</span> childSnapshot = <span class="hljs-title function_">traverseNode</span>(child, config);
    <span class="hljs-keyword">if</span> (childSnapshot) children.<span class="hljs-title function_">push</span>(childSnapshot);
  }
  nodeSnapshot.<span class="hljs-property">children</span> = children;
  <span class="hljs-comment">// 内联计算样式（确保回放样式一致）</span>
  <span class="hljs-title function_">inlineComputedStyle</span>(node, nodeSnapshot);
  <span class="hljs-keyword">return</span> nodeSnapshot;
}
</code></pre>
<h4 data-id="heading-4">1.2.2 节点序列化（serializeNode）</h4>
<p>提取节点关键属性，转化为 JSON 结构，重点处理元素节点与文本节点：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：节点序列化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">serializeNode</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">const</span> snapshot = {
    <span class="hljs-attr">type</span>: node.<span class="hljs-property">nodeType</span>, <span class="hljs-comment">// 1=元素节点，3=文本节点，8=注释节点（跳过）</span>
  };
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 元素节点</span>
    snapshot.<span class="hljs-property">tagName</span> = node.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>(); <span class="hljs-comment">// 统一小写（如DIV→div）</span>
    snapshot.<span class="hljs-property">attributes</span> = {};
    <span class="hljs-comment">// 收集核心属性（id、class、src、href等，跳过自定义无关属性）</span>
    <span class="hljs-keyword">const</span> coreAttrs = [<span class="hljs-string">'id'</span>, <span class="hljs-string">'class'</span>, <span class="hljs-string">'src'</span>, <span class="hljs-string">'href'</span>, <span class="hljs-string">'alt'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'value'</span>, <span class="hljs-string">'checked'</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> attr <span class="hljs-keyword">of</span> node.<span class="hljs-property">attributes</span>) {
      <span class="hljs-keyword">if</span> (coreAttrs.<span class="hljs-title function_">includes</span>(attr.<span class="hljs-property">name</span>) || attr.<span class="hljs-property">name</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data-'</span>)) {
        snapshot.<span class="hljs-property">attributes</span>[attr.<span class="hljs-property">name</span>] = attr.<span class="hljs-property">value</span>;
      }
    }
    <span class="hljs-comment">// 特殊处理表单元素（记录当前值，而非初始值）</span>
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'SELECT'</span>].<span class="hljs-title function_">includes</span>(node.<span class="hljs-property">tagName</span>)) {
      snapshot.<span class="hljs-property">value</span> = node.<span class="hljs-property">value</span>;
      snapshot.<span class="hljs-property">checked</span> = node.<span class="hljs-property">checked</span> || <span class="hljs-literal">false</span>;
      snapshot.<span class="hljs-property">selectedIndex</span> = node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'SELECT'</span> ? node.<span class="hljs-property">selectedIndex</span> : -<span class="hljs-number">1</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">3</span>) { <span class="hljs-comment">// 文本节点</span>
    snapshot.<span class="hljs-property">text</span> = node.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>() || <span class="hljs-string">''</span>; <span class="hljs-comment">// 过滤空文本，减少体积</span>
  }
  <span class="hljs-keyword">return</span> snapshot;
}
</code></pre>
<h4 data-id="heading-5">1.2.3 样式收集与内联</h4>
<p>页面样式可能来自link、style或内联style，为避免回放时样式丢失，rrweb 会将<strong>计算样式（computedStyle）</strong> 内联到节点快照中，同时过滤默认样式减少数据量：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：样式内联处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">inlineComputedStyle</span>(<span class="hljs-params">node, snapshot</span>) {
  <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(node);
  <span class="hljs-keyword">const</span> styles = {};
  <span class="hljs-comment">// 仅收集影响视觉的关键样式属性（排除默认值）</span>
  <span class="hljs-keyword">const</span> criticalStyles = [
    <span class="hljs-string">'display'</span>, <span class="hljs-string">'position'</span>, <span class="hljs-string">'top'</span>, <span class="hljs-string">'left'</span>, <span class="hljs-string">'width'</span>, <span class="hljs-string">'height'</span>, 
    <span class="hljs-string">'color'</span>, <span class="hljs-string">'background'</span>, <span class="hljs-string">'font-size'</span>, <span class="hljs-string">'border'</span>, <span class="hljs-string">'padding'</span>, <span class="hljs-string">'margin'</span>
  ];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prop <span class="hljs-keyword">of</span> criticalStyles) {
    <span class="hljs-keyword">const</span> value = computedStyle.<span class="hljs-title function_">getPropertyValue</span>(prop);
    <span class="hljs-comment">// 过滤默认样式（如div的display:block、body的margin:8px）</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isDefaultStyle</span>(snapshot.<span class="hljs-property">tagName</span>, prop, value)) {
      styles[prop] = value;
    }
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    snapshot.<span class="hljs-property">styles</span> = styles; <span class="hljs-comment">// 仅当有非默认样式时才添加，减少体积</span>
  }
}
<span class="hljs-comment">// 辅助函数：判断是否为标签默认样式（基于rrweb内置的默认样式表）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDefaultStyle</span>(<span class="hljs-params">tagName, prop, value</span>) {
  <span class="hljs-keyword">const</span> defaultStyles = {
    <span class="hljs-attr">div</span>: { <span class="hljs-attr">display</span>: <span class="hljs-string">'block'</span>, <span class="hljs-attr">margin</span>: <span class="hljs-string">'0'</span> },
    <span class="hljs-attr">body</span>: { <span class="hljs-attr">margin</span>: <span class="hljs-string">'8px'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'rgb(0, 0, 0)'</span> },
    <span class="hljs-attr">input</span>: { <span class="hljs-attr">border</span>: <span class="hljs-string">'1px solid rgb(169, 169, 169)'</span> }
    <span class="hljs-comment">// 其他标签默认样式...</span>
  };
  <span class="hljs-keyword">return</span> defaultStyles[tagName]?.[prop] === value;
}
</code></pre>
<h3 data-id="heading-6">1.3 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：样式体积过大与浏览器兼容性</strong></p>
<p>直接收集所有计算样式会导致数据量激增（单个元素可能有上百个样式属性），且不同浏览器默认样式存在差异（如 Chrome 与 Safari 的body默认margin不同）。</p>
<p><strong>解决方案</strong>：
① 仅收集 “影响视觉的关键样式”（如display、position），过滤无关样式（如webkit-font-smoothing）；</p>
<p>② 维护 “标签默认样式表”，仅记录与默认值不同的样式，数据量可减少 60% 以上；</p>
<p>③ 对浏览器私有前缀样式（如-webkit-border-radius）进行兼容处理，统一转化为标准样式。</p>
</li>
<li>
<p><strong>难点 2：跨域资源无法加载</strong></p>
<p>页面中的跨域图片（如 CDN 图片）、字体等资源，回放时可能因 CORS 限制无法加载，导致样式错乱。</p>
<p><strong>解决方案</strong>：</p>
</li>
<li>
<p>① 配置<code>inlineImages: true</code>时，将图片转化为 Base64 编码内联到快照中（适合小图片）；</p>
</li>
<li>
<p>② 对大图片，回放时通过 “同源代理服务” 转发请求（如后端部署代理接口，将跨域图片 URL 转为同源 URL）；</p>
</li>
<li>
<p>③ 记录资源加载失败时的降级样式（如图片占位符），确保回放体验一致。</p>
</li>
</ul>
<h3 data-id="heading-7">1.4 DOM 快照生成流程图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06c362ed5ffc430d93116711b56412e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=Mi8sK5khRiJIu7UNyllRiks9Vlc%3D" alt="exported_image.png" width="70%" loading="lazy"/>
<h2 data-id="heading-8">二、增量更新机制（MutationObserver）</h2>
<p><strong>通俗类比</strong>：如果说 DOM 快照是 “初始工程图”，增量更新就是 “工程变更记录”—— 就像建筑施工时，不需要每次都重新绘制完整图纸，只需记录 <strong>“在 3 层增加 1 个窗户”</strong> <strong>“修改 2 层墙体颜色”</strong> 这类变化。</p>
<p>rrweb 通过监听 DOM 变化，只记录快照后的增量修改，大幅减少录制数据量。</p>
<h3 data-id="heading-9">2.1 核心技术：MutationObserver API</h3>
<p>rrweb 的增量更新完全依赖浏览器原生的MutationObserver API，该 API 可监听 DOM 树的 <strong>“节点变化、属性变化、文本变化”</strong> ，并<strong>异步批量触发回调</strong>（避免阻塞主线程）。</p>
<p>其核心优势：</p>
<ul>
<li>① 精准监听（可指定监听类型）；</li>
<li>② 批量处理（短时间内多次变化合并为一次回调）；</li>
<li>③ 性能友好（异步执行，不阻塞用户交互）。</li>
</ul>
<h3 data-id="heading-10">2.2 监听配置与事件转化</h3>
<p>rrweb 初始化时创建 <code>MutationObserver</code>实例，将原生变化事件转化为自定义的Mutation事件（rrweb 事件类型标识为 3），关键逻辑如下：</p>
<h4 data-id="heading-11">2.2.1 MutationObserver 初始化</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：rrweb中MutationObserver配置</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initMutationObserver</span>(<span class="hljs-params">emit, config</span>) {
  <span class="hljs-comment">// 回调函数：批量处理DOM变化</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">observerCallback</span> = (<span class="hljs-params">mutations</span>) =&gt; {
    <span class="hljs-comment">// 过滤无需记录的微小变化（如文本节点空字符修改）</span>
    <span class="hljs-keyword">const</span> validMutations = mutations.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> <span class="hljs-title function_">isMutationValid</span>(m, config));
    <span class="hljs-keyword">if</span> (validMutations.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 批量转化为rrweb增量事件并发送</span>
    validMutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mutation</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> incrementalEvent = <span class="hljs-title function_">transformMutation</span>(mutation);
      <span class="hljs-title function_">emit</span>(incrementalEvent); <span class="hljs-comment">// 发送到事件队列，后续存储/上传</span>
    });
  };
  <span class="hljs-comment">// 监听配置：覆盖所有关键变化类型</span>
  <span class="hljs-keyword">const</span> observerConfig = {
    <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// 监听子节点新增/删除</span>
    <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,         <span class="hljs-comment">// 监听元素属性变化</span>
    <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 监听文本节点内容变化</span>
    <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>,            <span class="hljs-comment">// 深度监听（子树所有节点，不仅是直接子节点）</span>
    <span class="hljs-attr">attributeOldValue</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 记录属性变化前的旧值（便于回放时还原）</span>
    <span class="hljs-attr">characterDataOldValue</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 记录文本变化前的旧值</span>
  };
  <span class="hljs-comment">// 开始监听根节点</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(observerCallback);
  observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>, observerConfig);
  <span class="hljs-keyword">return</span> observer; <span class="hljs-comment">// 返回实例，便于后续停止监听</span>
}
<span class="hljs-comment">// 辅助函数：过滤无效变化（如屏蔽元素内的变化、空文本修改）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isMutationValid</span>(<span class="hljs-params">mutation, config</span>) {
  <span class="hljs-comment">// 屏蔽元素内的变化不记录</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">`.<span class="hljs-subst">${config.blockClass}</span>`</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 文本节点空字符修改不记录（如用户输入后删除为空）</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'characterData'</span>) {
    <span class="hljs-keyword">return</span> mutation.<span class="hljs-property">oldValue</span>.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span> || mutation.<span class="hljs-property">target</span>.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-12">2.2.2 原生变化事件转化（transformMutation）</h4>
<p>将浏览器原生的<code>MutationRecord</code>转化为 “可回放的结构化数据”，核心是明确 “变化目标、变化类型、变化内容”：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：转化原生MutationRecord</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transformMutation</span>(<span class="hljs-params">mutation</span>) {
  <span class="hljs-keyword">const</span> event = {
    <span class="hljs-attr">type</span>: <span class="hljs-number">3</span>,                  <span class="hljs-comment">// Mutation事件类型标识</span>
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),    <span class="hljs-comment">// 事件发生时间戳（用于回放排序）</span>
    <span class="hljs-attr">data</span>: {}
  };
  <span class="hljs-comment">// 1. 子节点变化（新增/删除节点）</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'childList'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'childList'</span>;
    <span class="hljs-comment">// 记录父节点路径（便于回放时定位目标父节点）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">parentPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    <span class="hljs-comment">// 序列化新增/删除的节点（仅核心属性，减少体积）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">addedNodes</span> = mutation.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-title function_">serializeNode</span>(n)).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">removedNodes</span> = mutation.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-title function_">serializeNode</span>(n)).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);
    <span class="hljs-comment">// 记录插入位置参考节点（确保回放时插入顺序正确）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">nextSiblingId</span> = mutation.<span class="hljs-property">nextSibling</span> 
      ? <span class="hljs-title function_">getNodeUniqueId</span>(mutation.<span class="hljs-property">nextSibling</span>) 
      : <span class="hljs-literal">null</span>;
  }
  <span class="hljs-comment">// 2. 属性变化（如class、src修改）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'attributes'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'attributes'</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">targetPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">attributeName</span> = mutation.<span class="hljs-property">attributeName</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">oldValue</span> = mutation.<span class="hljs-property">oldValue</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">newValue</span> = mutation.<span class="hljs-property">target</span>.<span class="hljs-title function_">getAttribute</span>(mutation.<span class="hljs-property">attributeName</span>);
  }
  <span class="hljs-comment">// 3. 文本变化（如span内文本修改）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'characterData'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'characterData'</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">targetPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">oldValue</span> = mutation.<span class="hljs-property">oldValue</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">newValue</span> = mutation.<span class="hljs-property">target</span>.<span class="hljs-property">textContent</span>;
  }
  <span class="hljs-keyword">return</span> event;
}
<span class="hljs-comment">// 辅助函数：生成节点唯一路径（如"body&gt;div.container&gt;ul&gt;li:nth-child(2)"）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getNodeUniquePath</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node === <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'html'</span>;
  <span class="hljs-keyword">if</span> (node === <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'body'</span>;
  <span class="hljs-keyword">const</span> parentPath = <span class="hljs-title function_">getNodeUniquePath</span>(node.<span class="hljs-property">parentElement</span>);
  <span class="hljs-keyword">const</span> siblings = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(node.<span class="hljs-property">parentElement</span>.<span class="hljs-property">children</span>);
  <span class="hljs-comment">// 用"标签名+索引"确保唯一性（如li:nth-child(2)）</span>
  <span class="hljs-keyword">const</span> index = siblings.<span class="hljs-title function_">indexOf</span>(node) + <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> nodeName = node.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>();
  <span class="hljs-keyword">const</span> classAttr = node.<span class="hljs-property">classList</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> 
    ? <span class="hljs-string">`.<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(node.classList).join(<span class="hljs-string">'.'</span>)}</span>`</span> 
    : <span class="hljs-string">''</span>;
  <span class="hljs-keyword">const</span> idAttr = node.<span class="hljs-property">id</span> ? <span class="hljs-string">`#<span class="hljs-subst">${node.id}</span>`</span> : <span class="hljs-string">''</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${parentPath}</span>&gt;<span class="hljs-subst">${nodeName}</span><span class="hljs-subst">${idAttr}</span><span class="hljs-subst">${classAttr}</span>:nth-child(<span class="hljs-subst">${index}</span>)`</span>;
}
</code></pre>
<h3 data-id="heading-13">2.3 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：节点路径定位不准确</strong></p>
<p>增量变化需要明确 “哪个节点发生了变化”，但 DOM 节点没有天生的唯一标识，动态生成的节点（如 Vue 列表渲染的li）在刷新后路径可能变化，导致回放时无法定位目标节点。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>① 生成 “唯一路径”（结合标签名、ID、类名、兄弟节点索引），如body&gt;div.container&gt;ul&gt;li:nth-child(2)，确保即使节点动态更新，仍能通过路径找到；</p>
</li>
<li>
<p>② 维护 “节点 ID 映射表”，录制时为每个节点分配临时 ID（如node.__rrwebId），回放时通过 ID 快速定位，路径作为降级方案（应对 ID 丢失场景）。</p>
</li>
</ul>
</li>
<li>
<p><strong>难点 2：高频变化导致性能卡顿</strong></p>
<p>页面中的高频 DOM 变化（如倒计时、动画、滚动加载列表）会触发MutationObserver频繁回调（如每秒几十次），导致前端主线程阻塞，影响用户交互体验。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>① 结合 “采样率控制”，对高频变化事件（如文本倒计时）进行节流处理（如 100ms 内仅记录 1 次变化）；</li>
<li>② 批量合并短时间内的同类变化（如 100ms 内的多次文本修改合并为 1 次）；</li>
<li>③ 过滤 “无意义变化”（如元素scrollTop的微小波动、空文本修改），减少事件数量。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">2.4 增量更新流程示意图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38213ded1a94417689424eaa9f67279f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=qzF5MNVrmSzOBjSonF7tBbBHrlk%3D" alt="exported_image.png" width="70%" loading="lazy"/>
<h2 data-id="heading-15">三、事件捕获和序列化</h2>
<p><strong>通俗类比</strong>：如果说 DOM 快照是 “初始场景”，增量更新是 “场景变化”，那么事件捕获就是 “用户动作剧本”—— 就像电影拍摄时，不仅要搭建场景，还要记录演员的 “肢体动作”“台词”“表情”。</p>
<p>rrweb 需要捕获用户的点击、输入、滚动等交互动作，将其转化为结构化的 “剧本数据”，确保回放时能精准还原用户操作轨迹。</p>
<h3 data-id="heading-16">3.1 核心事件类型与捕获策略</h3>
<p>rrweb 主要捕获 6 类高频用户交互事件，覆盖 90% 以上的前端操作场景，采用 “全局事件委托 + 精准过滤” 的捕获策略，避免给每个节点绑定事件导致内存泄漏：</p>















































<table><thead><tr><th>事件类型</th><th>核心用途</th><th>关键数据字段</th><th>rrweb 事件类型标识</th></tr></thead><tbody><tr><td>鼠标点击（click）</td><td>记录按钮、链接等点击操作</td><td>点击坐标（x/y）、目标节点路径</td><td>4</td></tr><tr><td>键盘输入（keydown）</td><td>记录文本输入、功能键操作</td><td>按键码（keyCode）、输入内容、目标节点</td><td>5</td></tr><tr><td>鼠标移动（mousemove）</td><td>记录鼠标位置变化</td><td>鼠标坐标（x/y）、时间戳</td><td>6</td></tr><tr><td>滚动（scroll）</td><td>记录页面 / 元素滚动位置</td><td>滚动目标路径、scrollTop/scrollLeft</td><td>7</td></tr><tr><td>窗口 resize</td><td>记录窗口尺寸变化</td><td>窗口宽（width）、高（height）</td><td>8</td></tr><tr><td>表单提交（submit）</td><td>记录表单提交操作</td><td>表单节点路径、提交时间戳</td><td>9</td></tr></tbody></table>
<h3 data-id="heading-17">3.2 关键实现逻辑（全局事件委托）</h3>
<p>通过在document上绑定事件监听器，利用事件冒泡机制捕获所有子节点的交互，核心代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：rrweb事件捕获核心逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initEventCapture</span>(<span class="hljs-params">emit, config</span>) {
  <span class="hljs-comment">// 需捕获的事件类型与对应的处理函数</span>
  <span class="hljs-keyword">const</span> eventHandlers = {
    <span class="hljs-attr">click</span>: handleClick,
    <span class="hljs-attr">keydown</span>: handleKeydown,
    <span class="hljs-attr">mousemove</span>: handleMousemove,
    <span class="hljs-attr">scroll</span>: handleScroll,
    <span class="hljs-attr">resize</span>: handleResize,
    <span class="hljs-attr">submit</span>: handleSubmit
  };
  <span class="hljs-comment">// 绑定全局事件委托</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(eventHandlers).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[type, handler]</span>) =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(type, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-comment">// 过滤规则：1. 屏蔽元素内的事件 2. 非用户触发的事件（如脚本触发的click）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isIgnoredEvent</span>(e, config)) <span class="hljs-keyword">return</span>;
      <span class="hljs-comment">// 处理事件并序列化为结构化数据</span>
      <span class="hljs-keyword">const</span> eventData = <span class="hljs-title function_">handler</span>(e, config);
      <span class="hljs-comment">// 发送事件（携带时间戳，确保回放顺序）</span>
      <span class="hljs-title function_">emit</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-title function_">getRRwebEventType</span>(type), <span class="hljs-comment">// 转化为rrweb事件标识</span>
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">data</span>: eventData
      });
    }, {
      <span class="hljs-attr">passive</span>: type === <span class="hljs-string">'scroll'</span> || type === <span class="hljs-string">'resize'</span>, <span class="hljs-comment">// passive优化：避免滚动阻塞</span>
      <span class="hljs-attr">capture</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 冒泡阶段捕获，确保能获取最终目标节点</span>
    });
  });
}
<span class="hljs-comment">// 辅助函数：过滤无效事件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isIgnoredEvent</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-comment">// 1. 屏蔽元素内的事件（如带.rr-block类名的元素）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">`.<span class="hljs-subst">${config.blockClass}</span>`</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 2. 排除脚本触发的事件（仅保留用户手动触发）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">isTrusted</span> === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 3. 排除右键点击（contextmenu）和滚轮事件（默认不捕获）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">type</span> === <span class="hljs-string">'click'</span> &amp;&amp; e.<span class="hljs-property">button</span> === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-18">3.3 典型事件序列化实现（以键盘输入和滚动为例）</h3>
<p>不同事件的序列化重点不同，需针对性处理敏感数据（如密码）和冗余信息：</p>
<h4 data-id="heading-19">3.3.1 键盘输入事件（keydown）序列化</h4>
<p>需区分 “普通字符输入” 和 “功能键”，同时对密码等敏感输入进行掩码处理：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：键盘输入事件处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleKeydown</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
  <span class="hljs-comment">// 隐私处理：密码输入框且开启掩码，不记录真实内容</span>
  <span class="hljs-keyword">const</span> isPasswordInput = target.<span class="hljs-property">tagName</span> === <span class="hljs-string">'INPUT'</span> &amp;&amp; target.<span class="hljs-property">type</span> === <span class="hljs-string">'password'</span>;
  <span class="hljs-keyword">const</span> shouldMask = isPasswordInput &amp;&amp; config.<span class="hljs-property">maskInputPassword</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">targetPath</span>: <span class="hljs-title function_">getNodeUniquePath</span>(target), <span class="hljs-comment">// 目标输入框路径</span>
    <span class="hljs-attr">key</span>: shouldMask ? <span class="hljs-string">'*'</span> : e.<span class="hljs-property">key</span>, <span class="hljs-comment">// 敏感输入替换为*</span>
    <span class="hljs-attr">keyCode</span>: e.<span class="hljs-property">keyCode</span>, <span class="hljs-comment">// 按键码（回放时模拟输入需用到）</span>
    <span class="hljs-attr">value</span>: shouldMask ? <span class="hljs-string">'*'</span> : target.<span class="hljs-property">value</span>, <span class="hljs-comment">// 输入框当前值（非敏感场景）</span>
    <span class="hljs-attr">isFunctionalKey</span>: [<span class="hljs-string">'Enter'</span>, <span class="hljs-string">'Backspace'</span>, <span class="hljs-string">'Tab'</span>].<span class="hljs-title function_">includes</span>(e.<span class="hljs-property">key</span>) <span class="hljs-comment">// 是否为功能键</span>
  };
}
</code></pre>
<h4 data-id="heading-20">3.3.2 滚动事件（scroll）序列化</h4>
<p>需区分 “页面滚动” 和 “元素滚动”，避免重复记录高频滚动事件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：滚动事件处理（含节流优化）</span>
<span class="hljs-keyword">let</span> lastScrollTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-comment">// 节流优化：50ms内仅记录1次，减少高频滚动导致的数据量</span>
  <span class="hljs-keyword">if</span> (now - lastScrollTime &lt; <span class="hljs-number">50</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  lastScrollTime = now;
  <span class="hljs-comment">// 区分页面滚动和元素滚动</span>
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span> === <span class="hljs-variable language_">document</span> ? <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span> : e.<span class="hljs-property">target</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">targetPath</span>: <span class="hljs-title function_">getNodeUniquePath</span>(target),
    <span class="hljs-attr">scrollTop</span>: target.<span class="hljs-property">scrollTop</span>,
    <span class="hljs-attr">scrollLeft</span>: target.<span class="hljs-property">scrollLeft</span>,
    <span class="hljs-attr">isPageScroll</span>: e.<span class="hljs-property">target</span> === <span class="hljs-variable language_">document</span> <span class="hljs-comment">// 是否为页面滚动</span>
  };
}
</code></pre>
<h3 data-id="heading-21">3.4 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：事件顺序错乱</strong></p>
<p>不同事件的触发存在时间差（如 “点击按钮→输入文本→提交表单”），若录制时事件顺序错误，回放会出现逻辑混乱（如未输入就提交）。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>① 所有事件携带精确时间戳（Date.now()），回放时按时间戳升序执行；</p>
</li>
<li>
<p>② 对存在依赖关系的事件（如 “click” 后触发的 “keydown”），记录事件间的关联 ID（如parentEventId），确保回放时顺序一致。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">3.5 事件捕获流程示意图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/022ced5baa094839a29a8f042b525a2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=KM2%2FXkDZmNplhKC0zCIxuh0YvQ8%3D" alt="image.png" width="100%" loading="lazy"/>
<h2 data-id="heading-23">四、回放还原技术</h2>
<p><strong>通俗类比</strong>：回放就像 “按剧本复现舞台剧”——DOM 快照是 “初始舞台布置”，增量事件是 “舞台道具变化指令”，用户交互事件是 “演员动作指令”，rrweb-player 则是 “导演”，按时间顺序执行所有指令，最终还原完整场景。</p>
<h3 data-id="heading-24">4.1 回放核心流程</h3>
<p>回放过程分为 <strong>“初始化准备”</strong> <strong>“事件调度”</strong> <strong>“状态同步”</strong> 三步，核心是 “按时间戳排序事件” 与 “精准执行指令”：</p>
<h4 data-id="heading-25">4.1.1 初始化准备（加载快照）</h4>
<p>回放开始时，先基于<code>FullSnapshot</code>事件重建初始 DOM，再初始化节点路径映射表（便于后续定位目标节点）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：回放初始化</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span> = options.<span class="hljs-property">events</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">timestamp</span> - b.<span class="hljs-property">timestamp</span>); <span class="hljs-comment">// 按时间戳排序</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = options.<span class="hljs-property">target</span>; <span class="hljs-comment">// 回放容器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 节点ID→DOM节点映射表</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initSnapshot</span>(); <span class="hljs-comment">// 加载初始快照</span>
  }
  <span class="hljs-comment">// 基于FullSnapshot重建初始DOM</span>
  <span class="hljs-title function_">initSnapshot</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 找到首屏快照事件</span>
    <span class="hljs-keyword">const</span> fullSnapshot = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-property">type</span> === <span class="hljs-number">2</span>);
    <span class="hljs-keyword">if</span> (!fullSnapshot) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'缺少首屏快照，无法回放'</span>);
    
    <span class="hljs-comment">// 清空容器，重建DOM</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> rootNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(fullSnapshot.<span class="hljs-property">data</span>.<span class="hljs-property">node</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(rootNode);
    
    <span class="hljs-comment">// 初始化节点映射表（记录每个节点的唯一ID）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildNodeMap</span>(rootNode);
  }
  <span class="hljs-comment">// 从快照节点重建真实DOM</span>
  <span class="hljs-title function_">rebuildNode</span>(<span class="hljs-params">snapshotNode</span>) {
    <span class="hljs-keyword">let</span> node;
    <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 元素节点</span>
      node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(snapshotNode.<span class="hljs-property">tagName</span>);
      <span class="hljs-comment">// 还原属性（id、class、src等）</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(snapshotNode.<span class="hljs-property">attributes</span> || {}).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        node.<span class="hljs-title function_">setAttribute</span>(key, value);
      });
      <span class="hljs-comment">// 还原样式（内联快照中的非默认样式）</span>
      <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">styles</span>) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(snapshotNode.<span class="hljs-property">styles</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
          node.<span class="hljs-property">style</span>[key] = value;
        });
      }
      <span class="hljs-comment">// 还原表单状态（value、checked）</span>
      <span class="hljs-keyword">if</span> ([<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'SELECT'</span>].<span class="hljs-title function_">includes</span>(snapshotNode.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toUpperCase</span>())) {
        node.<span class="hljs-property">value</span> = snapshotNode.<span class="hljs-property">value</span> || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">checked</span> !== <span class="hljs-literal">undefined</span>) node.<span class="hljs-property">checked</span> = snapshotNode.<span class="hljs-property">checked</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">type</span> === <span class="hljs-number">3</span>) { <span class="hljs-comment">// 文本节点</span>
      node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(snapshotNode.<span class="hljs-property">text</span> || <span class="hljs-string">''</span>);
    }
    <span class="hljs-comment">// 递归重建子节点</span>
    <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">children</span> &amp;&amp; snapshotNode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      snapshotNode.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(childSnapshot);
        <span class="hljs-keyword">if</span> (childNode) node.<span class="hljs-title function_">appendChild</span>(childNode);
      });
    }
    <span class="hljs-keyword">return</span> node;
  }
}
</code></pre>
<h4 data-id="heading-26">4.1.2 事件调度（按时间顺序执行）</h4>
<p>采用 “定时器 + 事件队列” 模式，模拟真实时间流逝，按事件 timestamp 差值执行指令，支持倍速播放（如 1x、2x、4x）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：事件调度逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-comment">// ... 初始化逻辑 ...</span>
  <span class="hljs-comment">// 开始回放</span>
  <span class="hljs-title function_">play</span>(<span class="hljs-params">speed = <span class="hljs-number">1</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPlaying</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playSpeed</span> = speed;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 当前执行到的事件索引</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// 回放开始时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEventTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[<span class="hljs-number">0</span>].<span class="hljs-property">timestamp</span>; <span class="hljs-comment">// 第一个事件的时间戳</span>
    
    <span class="hljs-comment">// 启动调度器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheduler</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeEvents</span>(), <span class="hljs-number">16</span>); <span class="hljs-comment">// 约60fps，流畅度优先</span>
  }
  <span class="hljs-comment">// 执行当前时间点应触发的事件</span>
  <span class="hljs-title function_">executeEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isPlaying</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> currentPlayTime = <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEventTime</span> + (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">playSpeed</span>;
    
    <span class="hljs-comment">// 执行所有timestamp &lt;= 当前播放时间的事件</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">const</span> event = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span>];
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">timestamp</span> &gt; currentPlayTime) <span class="hljs-keyword">break</span>;
      
      <span class="hljs-comment">// 根据事件类型执行对应操作</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeEvent</span>(event);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span>++;
    }
    <span class="hljs-comment">// 回放结束，清除定时器</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pause</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFinish</span>?.();
    }
  }
  <span class="hljs-comment">// 执行单个事件</span>
  <span class="hljs-title function_">executeEvent</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// Mutation事件（增量更新）</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeMutation</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-comment">// click事件</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeClick</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-comment">// 键盘事件</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeKeyEvent</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-comment">// 其他事件类型执行逻辑...</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-27">4.1.3 增量事件执行（以 Mutation 为例）</h4>
<p>根据增量事件类型，执行 “节点新增 / 删除”“属性修改”“文本更新” 等操作：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：执行Mutation增量事件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-comment">// ... 其他方法 ...</span>
  <span class="hljs-title function_">executeMutation</span>(<span class="hljs-params">mutationData</span>) {
    <span class="hljs-comment">// 定位目标节点（通过路径或节点ID）</span>
    <span class="hljs-keyword">const</span> targetNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTargetNode</span>(mutationData.<span class="hljs-property">targetPath</span> || mutationData.<span class="hljs-property">parentPath</span>);
    <span class="hljs-keyword">if</span> (!targetNode) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">switch</span> (mutationData.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'childList'</span>: <span class="hljs-comment">// 子节点变化</span>
        <span class="hljs-comment">// 新增节点</span>
        mutationData.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(childSnapshot);
          <span class="hljs-keyword">if</span> (mutationData.<span class="hljs-property">nextSiblingId</span>) {
            <span class="hljs-comment">// 插入到参考节点之前</span>
            <span class="hljs-keyword">const</span> nextSibling = <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span>.<span class="hljs-title function_">get</span>(mutationData.<span class="hljs-property">nextSiblingId</span>);
            targetNode.<span class="hljs-title function_">insertBefore</span>(childNode, nextSibling);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 插入到末尾</span>
            targetNode.<span class="hljs-title function_">appendChild</span>(childNode);
          }
          <span class="hljs-comment">// 更新节点映射表</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildNodeMap</span>(childNode);
        });
        <span class="hljs-comment">// 删除节点</span>
        mutationData.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTargetNodeBySnapshot</span>(childSnapshot);
          <span class="hljs-keyword">if</span> (childNode &amp;&amp; childNode.<span class="hljs-property">parentElement</span> === targetNode) {
            targetNode.<span class="hljs-title function_">removeChild</span>(childNode);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span>.<span class="hljs-title function_">delete</span>(childNode.<span class="hljs-property">__rrwebId</span>); <span class="hljs-comment">// 从映射表移除</span>
          }
        });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'attributes'</span>: <span class="hljs-comment">// 属性修改</span>
        targetNode.<span class="hljs-title function_">setAttribute</span>(mutationData.<span class="hljs-property">attributeName</span>, mutationData.<span class="hljs-property">newValue</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'characterData'</span>: <span class="hljs-comment">// 文本修改</span>
        targetNode.<span class="hljs-property">textContent</span> = mutationData.<span class="hljs-property">newValue</span>;
        <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-28">4.2 技术难点与解决方案</h3>
<ul>
<li><strong>难点 1：事件执行顺序偏差</strong></li>
</ul>
<p>录制时事件按真实时间戳存储，但回放时若定时器精度不足（如 setInterval 存在延迟），可能导致 “先执行点击、后执行 DOM 更新” 的顺序错误，引发场景混乱。</p>
<p><strong>解决方案</strong>：
① 事件队列按 timestamp 严格排序，执行时通过 “当前播放时间 = 首事件时间 +（当前时间 - 回放开始时间）× 倍速” 精准计算应执行的事件；</p>
<p>② 对依赖 DOM 状态的事件（如 click），增加 “DOM 就绪检查”，确保增量更新执行完成后再触发交互事件。</p>
<ul>
<li><strong>难点 2：回放时节点定位失败</strong></li>
</ul>
<p>若录制时 DOM 结构动态变化（如 Vue 列表重新渲染），回放时可能出现 “路径找不到节点” 的问题。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>① 采用 “节点 ID 优先、路径降级” 的定位策略，录制时为每个节点分配<code>\_\_rrwebId</code>，回放时优先通过 ID 定位；</li>
<li>② 路径定位时支持 “模糊匹配”（如忽略动态索引，通过类名 + 标签名组合定位）；</li>
<li>③ 定位失败时触发 “降级处理”（如跳过该事件，避免整个回放崩溃）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Netty的TCP协议的Socket服务端]]></title>    <link>https://juejin.cn/post/7592903126177792050</link>    <guid>https://juejin.cn/post/7592903126177792050</guid>    <pubDate>2026-01-09T01:18:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592903126177792050" data-draft-id="7592884480731267118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Netty的TCP协议的Socket服务端"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-09T01:18:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Netty的TCP协议的Socket服务端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:18:09.000Z" title="Fri Jan 09 2026 01:18:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40b53a2b2228449aa7af28c2f736c676~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526289&amp;x-signature=qFmx82yE%2FPNijL2%2FL7gPieSubaE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>上一节分享<code>Websocket</code>独立部署的一个设计思路，我们今天接着聊一下基于Netty的TCP协议的Socket服务端如何搭建。这个对于熟悉的人可能很简单，但是对于新手或者不常用的开发者来说，可能一头雾水。</p>
<p>小编在初次使用<code>Socket</code>的时候，都是度娘一大堆，然后抄抄抄，完成自己的任务。至于为什么这么做，完全不知道。这一节将自己的理解分享并记录下来，以备不时之需。</p>
<h2 data-id="heading-1">02 服务端案例</h2>
<h3 data-id="heading-2">2.1 代码展示</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 创建线程组</span>
    <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
    <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">5</span>);

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 服务端类</span>
        <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">serverBootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
        <span class="hljs-comment">// 添加组</span>
        serverBootstrap.group(bossGroup, workGroup);
        <span class="hljs-comment">// 设置NioServerSocketChannel通道</span>
        serverBootstrap.channel(NioServerSocketChannel.class);
        <span class="hljs-comment">// 连接队列大小</span>
        serverBootstrap.option(ChannelOption.SO_BACKLOG, <span class="hljs-number">1024</span>)；
        <span class="hljs-comment">// 保持连接</span>
        serverBootstrap.childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-literal">true</span>); 
        serverBootstrap.childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;(){
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel socketChannel)</span> <span class="hljs-keyword">throws</span> Exception {
                <span class="hljs-comment">// 设置处理器链，依次执行</span>
                <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> socketChannel.pipeline();
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelimiterBasedFrameDecoder</span>(<span class="hljs-number">2048</span>, Unpooled.copiedBuffer(<span class="hljs-string">"_"</span>.getBytes())));
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>(StandardCharsets.UTF_8));
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>(StandardCharsets.UTF_8));
                <span class="hljs-comment">// 自定义的handler，处理业务逻辑</span>
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessHandler</span>&lt;&gt;());    
            }
        });

        <span class="hljs-comment">// 配置完成，开始绑定server，通过调用sync同步方法阻塞直到绑定成功</span>
        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> serverBootstrap.bind(<span class="hljs-number">9091</span>).sync();
        log.info(<span class="hljs-string">"Server started and listen on:{}"</span>,channelFuture.channel().localAddress());
        <span class="hljs-comment">// 对关闭通道进行监听</span>
        channelFuture.channel().closeFuture().sync();
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"信息异常："</span>, e);
    }<span class="hljs-keyword">finally</span> {
        bossGroup.close();
        workGroup.close();
    }
}
</code></pre>
<h3 data-id="heading-3">2.2 创建线程组</h3>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-comment">// 创建线程组</span>
<span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
<span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">5</span>);
</code></pre>
<p><code>EventLoopGroup</code>就是一个线程池。在<code>Netty</code>的<code>Socket</code>中需要两个不同的线程池，分别处理不同的任务。其中<code>bossGroup</code>用来接收客户端连接，通常设置1个线程，而<code>workGroup</code>用来处理I/O操作和业务逻辑，可以根据CPU的核心数指定。</p>
<h3 data-id="heading-4">2.3 创建服务端</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 服务端类</span>
<span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">bootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
<span class="hljs-comment">// 添加组</span>
serverBootstrap.group(bossGroup, workGroup);
<span class="hljs-comment">// 设置NioServerSocketChannel通道</span>
serverBootstrap.channel(NioServerSocketChannel.class);
<span class="hljs-comment">// 连接队列大小</span>
serverBootstrap.option(ChannelOption.SO_BACKLOG, <span class="hljs-number">1024</span>)；
<span class="hljs-comment">// 保持连接</span>
serverBootstrap.childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-literal">true</span>);
</code></pre>
<p>服务端引导类创建完成之后，需要设置参数：</p>
<ul>
<li>group()：添加线程池组，第一个参数为<code>bossGroup</code>，第二个是<code>workGroup</code></li>
<li>channel()：设置<code>NioServerSocketChannel</code>通道</li>
<li>option()：配置服务端监听的<code>ServerSocketChannel</code></li>
<li>childOption()：配置客户端连接的<code>SocketChannel</code></li>
</ul>
<p>所以这里的<code>ChannelOption.SO_BACKLOG</code>只能设置在<code>option</code>中，用来指定服务端接收的任务最大队列。<code>ChannelOption.SO_KEEPALIVE</code>用来TCP保活机制，检测死连接，是针对客户端的连接，所以需要设置在<code>childOption</code>上。</p>
<p><code>ChannelOption.SO_KEEPALIVE</code>也可以不同设置，采用心跳机制来保活。其使用有一定的局限性，通常都会通过心跳机制来代替。</p>
<h3 data-id="heading-5">2.4 设置处理链</h3>
<pre><code class="hljs language-java" lang="java">serverBootstrap.childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;(){
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel socketChannel)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 设置处理器链，依次执行</span>
        <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> socketChannel.pipeline();
      
        pipeline.addLast(<span class="hljs-string">"..."</span>); 
        pipeline.addLast(<span class="hljs-string">"..."</span>);  
    }
});
</code></pre>
<p>采用责任链模式，每个处理器处理特定任务，依次执行。里面具体的<code>Handler</code>单独说明。</p>
<h3 data-id="heading-6">2.5 绑定端口，同步阻塞</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置完成，开始绑定server，通过调用sync同步方法阻塞直到绑定成功</span>
<span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> serverBootstrap.bind(<span class="hljs-number">9091</span>).sync();
<span class="hljs-comment">// 对关闭通道进行监听</span>
channelFuture.channel().closeFuture().sync();
</code></pre>
<p>当前服务端绑定一个端口，客户端就可以通过当前端口连接，并同步阻塞，等待端口绑定成功。最后同步阻塞等待通过关闭。</p>
<h2 data-id="heading-7">03 消息处理</h2>
<p>消息的处理是接受和推送消息重要部分。<code>Netty</code>框架提供了丰富的处理器，我们可以选择适合自己的处理器。处理器都是实现<code>io.netty.channel.ChannelInboundHandler</code>接口</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10f257724c4f430d8fc42076c9d30588~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526289&amp;x-signature=zvnBXknvXTxwYTLlo0PGKTBgYmM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.1 框架自带编解码器</h3>
<p><code>Netty</code>框架下的Socket数据传输，默认都是<code>ByteBuf</code>（字节缓冲）。我们使用的时候自然想通过常用的字符串传输，而<code>Netty</code>自然帮我们提供了字符串相关的编解码处理器。</p>
<ul>
<li><code>io.netty.handler.codec.string.StringDecoder</code></li>
<li><code>io.netty.handler.codec.string.StringEncoder</code></li>
</ul>
<p>通过源码我们可以看到注释：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3446ecfbe67d4a5bbd54f4f7073ee95a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526289&amp;x-signature=3YVfWVvHQUuWJ61ds68L4V7K4VM%3D" alt="" loading="lazy"/></p>
<p><code>StringDecoder</code>是将<code>ByteBuf</code>转成字符串的解码器，但是在处理之前必须使用<code>ByteToMessageDecoder</code>先解码，子类包括：</p>
<ul>
<li><code>io.netty.handler.codec.DelimiterBasedFrameDecoder</code>：分隔符分割</li>
<li><code>io.netty.handler.codec.FixedLengthFrameDecoder</code>：固定长度分割</li>
<li><code>io.netty.handler.codec.LengthFieldBasedFrameDecoder</code>：按照字段长度分割</li>
<li><code>io.netty.handler.codec.LineBasedFrameDecoder</code>：按行分割</li>
</ul>
<p>这几种方式都是有效防止拆包、粘包的方法。</p>
<p>按照注释的案例，我们就可以配置。而<code>StringEncoder</code>是用来发送消息的解码器，用来将字符串转成<code>ByteBuf</code>。</p>
<p>我们这里采用分隔符的方式分割：</p>
<pre><code class="hljs language-java" lang="java">pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DelimiterBasedFrameDecoder</span>(<span class="hljs-number">2048</span>, Unpooled.copiedBuffer(<span class="hljs-string">"_"</span>.getBytes())));
pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>(StandardCharsets.UTF_8));
pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>(StandardCharsets.UTF_8));
</code></pre>
<p>而其中<code>DelimiterBasedFrameDecoder</code>的<code>maxFrameLength</code>参数用来控制接收消息的最大字节大小，超过就会异常。</p>
<h3 data-id="heading-9">3.2 自定义业务处理器</h3>
<p>自定义业务处理器是用来处理客户端连接以及消息的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerAdded</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 建立客户端</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ctx.channel();
        log.info(<span class="hljs-string">"Socket客户端建立连接：channelId={}"</span>, channel.id());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerRemoved</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 断开链接</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ctx.channel();
        log.info(<span class="hljs-string">"Socket客户端断开连接：channelId={}"</span>, channel.id());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 接受消息</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ctx.channel();
        log.info(<span class="hljs-string">"Socket收到来自通道channelId[{}]发送的消息：{}"</span>, channel.id(), msg);
        <span class="hljs-comment">// 通过WebSocket将方法发送给客户端</span>
        channel.writeAndFlush(msg + <span class="hljs-string">"789_000"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception {
        log.info(<span class="hljs-string">"异常："</span>, cause);
    }
}
</code></pre>
<p><strong>handlerAdded()</strong></p>
<p>客户端建立连接之后会触发该方法。可以通过<code>ctx.channel()</code>获取来连接的通道（客户端）。连接的通常可以通过<code>io.netty.channel.group.ChannelGroup</code>收集。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ChannelGroup</span> <span class="hljs-variable">channelGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultChannelGroup</span>(GlobalEventExecutor.INSTANCE)
channelGroup.add(channel);
</code></pre>
<p>向客户端发送消息时，可以通过<code>channelGroup.writeAndFlush()</code>统一给客户端发送消息。</p>
<p><strong>handlerRemoved()</strong></p>
<p>客户端断开连接的时触发，可以通过<code>channelGroup.remove(channel)</code>移除已经关闭的客户端通道</p>
<p><strong>channelRead0()</strong></p>
<p>接收客户端消息的重要方法，通过<code>channel.writeAndFlush()</code>可以直接向客户端发送消息</p>
<p><strong>exceptionCaught()</strong></p>
<p>处理异常的方法</p>
<h3 data-id="heading-10">3.3 客户端测试</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a650b8a56147df80a7e5c01054dba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526289&amp;x-signature=a1Bpa31M0yrWhMUwVbYYlxbYTlk%3D" alt="" loading="lazy"/></p>
<p>从图上可以看出，介绍的方法都被触发了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c822ddfe1a364d779ff9a814448f3afc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526289&amp;x-signature=xIyskKp9eWRcTh236r0eEl1xT80%3D" alt="" loading="lazy"/></p>
<p>从图可以看出客户端的也接收到服务端的消息了。</p>
<p><strong>注意</strong></p>
<p>客户端发送的消息：foo test..._</p>
<p>服务端发送的消息：foo test...789_000</p>
<p>客户端接受的消息：foo test...789</p>
<p>客户端和服务端接收到的消息都通过<code>_</code>截断的</p>
<h2 data-id="heading-11">04 小结</h2>
<p>简单的服务端搭建就已经好了，但是实际应用的时候，还需要考虑心跳机制、以及无效客户端的清理等。<code>TCP</code>协议服务端的介绍就到这里，客户端我们下一期介绍。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 实战 | 快速搭建 Python 开发环境]]></title>    <link>https://juejin.cn/post/7593165280488194089</link>    <guid>https://juejin.cn/post/7593165280488194089</guid>    <pubDate>2026-01-09T09:33:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593165280488194089" data-draft-id="7580723992498110500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 实战 | 快速搭建 Python 开发环境"/> <meta itemprop="keywords" content="LangChain,LLM,Python"/> <meta itemprop="datePublished" content="2026-01-09T09:33:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的松鼠"/> <meta itemprop="url" content="https://juejin.cn/user/2749193011073976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 实战 | 快速搭建 Python 开发环境
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2749193011073976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的松鼠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:33:35.000Z" title="Fri Jan 09 2026 09:33:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">介绍 uv</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv" target="_blank" title="https://docs.astral.sh/uv" ref="nofollow noopener noreferrer">uv</a> 是一个用 Rust 编写的 <strong>极快的 Python 包管理器和项目管理器。</strong></p>
<p>它整合了 Python 开发者常用的多种工具到一个 CLI 中，非常像 Node.js 生态里的 npm/pnpm。</p>
<ul>
<li>Rust 写的，<strong>速度比 pip 快 10～80 倍</strong></li>
<li>一个工具替代多个工具（pip、virtualenv、pip-tools、pyenv、poetry…）</li>
<li>和 Ruff 同一个团队，专业度高</li>
<li>配置统一在 <code>pyproject.toml</code></li>
<li>兼容 pip，不需要迁移成本</li>
</ul>
<p><strong>uv 命令速查表：</strong></p>





































<table><thead><tr><th>功能</th><th>命令</th></tr></thead><tbody><tr><td>创建虚拟环境</td><td><code>uv venv</code></td></tr><tr><td>使用虚拟环境运行脚本</td><td><code>uv run main.py</code></td></tr><tr><td>安装依赖</td><td><code>uv pip install fastapi</code></td></tr><tr><td>安装到项目（写入 pyproject）</td><td><code>uv add fastapi</code></td></tr><tr><td>安装 Python 版本</td><td><code>uv python install 3.12</code></td></tr><tr><td>运行工具</td><td><code>uv run uvicorn app:app</code></td></tr><tr><td>解析依赖锁定</td><td><code>uv pip compile</code></td></tr></tbody></table>
<h2 data-id="heading-1">安装 uv</h2>
<p>我们需要依据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv" target="_blank" title="https://docs.astral.sh/uv" ref="nofollow noopener noreferrer">uv 官网</a>给我们提供的安装方法将 uv 安装到计算机中。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e67e9d3fc2d47e5ac00bc781b20644d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=NmESSR4T2Uorm2GLLfsDQx2tvY0%3D" alt="01-001.png" width="100%" loading="lazy"/>
<p><code>powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"</code></p>
<p>以 Windows 为例，将上述命令输入到终端后等待几秒就会安装完成。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc768d845334b3b97baca0712c47b4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=jVNA%2BfiFMZzXUSM1Rp43WmyM8aA%3D" alt="01-002.png" width="100%" loading="lazy"/>
<h4 data-id="heading-2">初始化环境</h4>
<p>学习 <code>langchain</code> 我们要创建一个 <code>Python</code> 项目环境。</p>
<p>首先，创建 <code>langchain</code> 项目目录 <code>learn-langchain</code>，在目录下的终端命令行输入 <code>uv init</code>。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfb9d4344c6b4d109afe0a8e2ceed1d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=lh8JR1ZVlo0Eaj%2Btwag9wt48N3s%3D" alt="01-1.png" width="100%" loading="lazy"/>
<p>此时，<code>uv</code> 就会帮我们初始化开发环境，会生成如下初始文件：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2dfc5164e144ee58d4af506f02432ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=JYU%2FeW8qP6t7BbRygrU3MBctW44%3D" alt="01-2.png" width="100%" loading="lazy"/>
<p>其中，<code>pyproject.toml</code> 是 Python 项目的“<strong>总配置中心 + 依赖声明入口</strong>”。</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"learn-langchain"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"Add your description here"</span>
<span class="hljs-attr">readme</span> = <span class="hljs-string">"README.md"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.13"</span>
<span class="hljs-attr">dependencies</span> = []
</code></pre>
<p>可以把它类比成前端项目中的 <code>package.json</code> 文件，下面我们详细解释这个文件中各个字段的含义。</p>
<ul>
<li><strong>[project]</strong> ：这是一个 Python 项目的元数据声明，uv 会从这里读取项目信息。</li>
<li><strong>name</strong>：项目的官方名称。</li>
<li><strong>version</strong>：项目版本号。</li>
<li><strong>description</strong>：项目的一句话描述。</li>
<li><strong>readme</strong>：指定项目的 README 文件。</li>
<li><strong>requires-python</strong>：声明项目能运行的 Python 版本范围。</li>
<li><strong>dependencies</strong>：项目的运行时依赖，后续安装的依赖都会存到这里。</li>
</ul>
<h2 data-id="heading-3">安装项目依赖</h2>
<p>首先，安装 langchain 核心依赖，在项目跟目录终端输入：</p>
<p><code>uv add langchain langchain-core langchain-classic langchain-community</code></p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8037e3bbab2465e8aa43b9ebe6c7452~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=MXsDQ9g0ZYbolQJv1OKAI2eb%2Bh4%3D" alt="01-3.png" width="100%" loading="lazy"/>
<p>此时，新的依赖会声明在 <code>pyproject.toml</code> 文件的 <code>dependencies</code> 中。</p>
<p>同时，在项目中会生成 <code>uv.lovk</code> 文件和 <code>.venv</code> 文件：</p>
<ul>
<li><strong>uv.lovk</strong>： uv 自动生成的<strong>依赖锁文件</strong>， 记录每个依赖的<strong>最终版本。</strong></li>
<li><strong>.venv</strong>： uv 为当前项目创建的 Python 虚拟环境目录，避免全局 Python 环境污染。</li>
</ul>
<h2 data-id="heading-4">激活虚拟环境</h2>
<p>如果是 Windows 系统，在项目终端命令行输入：</p>
<p><code>.venv\Scripts\activate</code></p>
<p>如果是 macOS / Linux 系统，在项目终端命令行输入：</p>
<p><code>source .venv/bin/activate</code></p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5203a55b9934d238fe64c700f5cfc1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=EJc6mUuM%2FAxNLoIkPFY%2FFNrPGhc%3D" alt="01-4.png" width="100%" loading="lazy"/>
<p>虚拟环境激活后，会在终端命令行前端显示 <code>(learn-langchain)</code> 表示当前激活的 Python 虚拟环境名称。</p>
<h2 data-id="heading-5">创建项目示例</h2>
<h3 data-id="heading-6">安装依赖</h3>
<p>首先，安装必要的依赖，在项目跟目录终端输入：</p>
<p><code>uv add python-dotenv langchain-openai langchain-deepseek</code></p>
<ul>
<li><code>python-dotenv</code>是一个用于读取 <code>.env</code> 文件并将环境变量加载到 Python 运行时的工具。</li>
<li><code>langchain-openai</code> 提供对 <strong>OpenAI 官方模型</strong> 的接口封装。</li>
<li><code>langchain-deepseek</code> 提供对 <strong>DeepSeek 平台（OpenAI-compatible）的接口</strong> 封装。</li>
</ul>
<h3 data-id="heading-7">配置环境变量</h3>
<p>在项目根目录创建 <code>.env</code> 文件，输入如下内容：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">OPENAI_API_KEY</span>=sk-c97afa925b1745f79225c904dff53cba
<span class="hljs-attr">OPENAI_API_BASE</span>=https://api.deepseek.com/v1
</code></pre>
<p>在学习 <code>LangChain</code> 的前期阶段，我们暂时使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com" target="_blank" title="https://platform.deepseek.com" ref="nofollow noopener noreferrer">DeepSeek</a> 作为我们的大语言模型。</p>
<p>因为 DeepSeek <strong>兼容 OpenAI API 协议，</strong> 所以我们可以使用其 <code>API key</code> 赋值给 <code>OPENAI_API_KEY</code>。</p>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fapi_keys" target="_blank" title="https://platform.deepseek.com/api_keys" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a>，创建 <code>API key</code> 保存起来，然后赋值给 <code>.env</code> 中的 <code>OPENAI_API_KEY</code>。</p>
<p>使用官网提供的兼容 OpenAI 的<code>base_url</code> 赋值给 <code>OPENAI_API_BASE</code>。</p>
<h3 data-id="heading-8">创建示例</h3>
<p>创建第一个示例，在项目根目录创建 <code>01-hello-world</code> 文件夹，在其文件夹内创建 <code>01-chat.py</code> 文件。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

<span class="hljs-comment"># 加载环境变量</span>
load_dotenv()

<span class="hljs-comment"># 初始化聊天模型</span>
llm = ChatOpenAI(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    temperature=<span class="hljs-number">0</span>,
)

<span class="hljs-comment"># 调用模型</span>
response = llm.invoke(<span class="hljs-string">"你是谁"</span>)

<span class="hljs-built_in">print</span>(response.content)
</code></pre>
<p><strong>上述代码的含义是：</strong></p>
<ol>
<li><strong>导入依赖</strong></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
</code></pre>
<ul>
<li><code>from langchain_openai import ChatOpenAI</code>
<ul>
<li>从 <strong>LangChain 的 OpenAI 适配器包</strong>里导入 <strong>ChatOpenAI</strong> 类</li>
<li>这个类封装了对 OpenAI 或兼容 API（DeepSeek）的对话模型调用</li>
<li>本质上是一个 <strong>LLM（Large Language Model）客户端</strong></li>
</ul>
</li>
<li><code>from dotenv import load_dotenv</code>
<ul>
<li>从 <code>python-dotenv </code>导入 <code>load_dotenv</code></li>
<li>用来加载 <code>.env</code> 文件中的环境变量到 Python 的 <code>os.environ</code></li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>加载环境变量</strong></li>
</ol>
<ul>
<li><code>load_dotenv()</code>
<ul>
<li>读取项目根目录下的 <code>.env</code> 文件</li>
<li>将其中的内容（例如 <code>OPENAI_API_KEY</code>、<code>OPENAI_API_BASE</code>）导入环境变量</li>
<li>这样 <code>ChatOpenAI</code> 就可以自动读取 Key 和 API Base，无需在代码中硬编码</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>初始化 LLM</strong></li>
</ol>
<pre><code class="hljs language-python" lang="python">llm = ChatOpenAI(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    temperature=<span class="hljs-number">0</span>,
)
</code></pre>
<ul>
<li>创建一个 <strong>ChatOpenAI 对象</strong>，用于发送消息给 LLM</li>
<li><code>model="deepseek-chat" </code>：
<ul>
<li>因为 DeepSeek 兼容 OpenAI API，这里可以直接指定 DeepSeek 提供的模型</li>
</ul>
</li>
<li><code>temperature=0</code>：
<ul>
<li>控制生成文本的随机性， 0 → <strong>最确定、最稳妥， 越大 → 输出越多样化</strong></li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>调用 LLM</strong></li>
</ol>
<ul>
<li><code>response = llm.invoke("你是谁")</code>
<ul>
<li><code>invoke()</code> 是 ChatOpenAI 的核心方法</li>
<li>输入参数 <code>"你是谁"</code> 是 <strong>prompt</strong>，告诉 LLM 你希望它做什么</li>
<li>返回值 <code>response</code> 是一个对象，通常包含：<code>response.content</code> → LLM 的文本输出</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">结语</h2>
<p><strong>最终</strong>，在终端命令行输入：<code>python .\01-hello-world\01-chat.py</code> 等待几秒就会在控制台打印内容。</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef3c786bb9b49ecaf3f8c9edb074432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-b5Ye755qE5p2-6byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768557817&amp;x-signature=UQbmHSOHRpzCyMw16vyF0AI7n90%3D" alt="01-5.png" width="100%" loading="lazy"/>
<p>这说明，我们第一个 LangChain 示例运行成功，后续，我们将开始系统学习 LangChain 提供的强大的能力。</p>
<blockquote>
<p>此文章已同步至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvaesonshu%2Flearn-langchan%2Fissues%2F1" target="_blank" title="https://github.com/vaesonshu/learn-langchan/issues/1" ref="nofollow noopener noreferrer">Github</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react路由配置相关]]></title>    <link>https://juejin.cn/post/7592996072706097202</link>    <guid>https://juejin.cn/post/7592996072706097202</guid>    <pubDate>2026-01-09T07:30:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072706097202" data-draft-id="7592996072705589298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react路由配置相关"/> <meta itemprop="keywords" content="前端,React.js,Ant Design"/> <meta itemprop="datePublished" content="2026-01-09T07:30:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="加油乐"/> <meta itemprop="url" content="https://juejin.cn/user/84036866547575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react路由配置相关
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/84036866547575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    加油乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T07:30:36.000Z" title="Fri Jan 09 2026 07:30:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、路由配置接口设计</h2>
<ul>
<li>通过统一的接口定义，确保路由配置的类型安全，便于维护和扩展。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RouteConfig</span> {
  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>;                     <span class="hljs-comment">// 路由路径</span>
  element?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;        <span class="hljs-comment">// 渲染组件</span>
  children?: <span class="hljs-title class_">RouteConfig</span>[];         <span class="hljs-comment">// 子路由</span>
  redirect?: <span class="hljs-built_in">string</span>;                <span class="hljs-comment">// 重定向路径</span>
  meta?: {                          <span class="hljs-comment">// 路由元信息</span>
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;                  <span class="hljs-comment">// 页面标题</span>
    requiresAuth?: <span class="hljs-built_in">boolean</span>;         <span class="hljs-comment">// 是否需要登录</span>
    roles?: <span class="hljs-built_in">string</span>[];               <span class="hljs-comment">// 允许访问的角色</span>
  };
}
</code></pre>
<h2 data-id="heading-1">二、路由分离策略</h2>
<ul>
<li>将路由分为公共路由和私有路由</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">公共路由（无需登录）</span>
<span class="hljs-attr">const publicRoutes:</span> <span class="hljs-string">RouteConfig[]</span> <span class="hljs-string">=</span> [
  {
    <span class="hljs-attr">path:</span> <span class="hljs-string">'/login'</span>,
    <span class="hljs-attr">element:</span> <span class="hljs-string">&lt;Login</span> <span class="hljs-string">/&gt;</span>,
    <span class="hljs-attr">meta:</span> { <span class="hljs-attr">title:</span> <span class="hljs-string">'登录'</span>, <span class="hljs-attr">requiresAuth:</span> <span class="hljs-literal">false</span> }
  }
]<span class="hljs-string">;</span>

<span class="hljs-string">//</span> <span class="hljs-string">私有路由（需要登录）</span>
<span class="hljs-attr">const privateRoutes:</span> <span class="hljs-string">RouteConfig[]</span> <span class="hljs-string">=</span> [
  {
    <span class="hljs-attr">path:</span> <span class="hljs-string">'/dashboard'</span>,
    <span class="hljs-attr">element:</span> <span class="hljs-string">&lt;Dashboard</span> <span class="hljs-string">/&gt;</span>,
    <span class="hljs-attr">meta:</span> { <span class="hljs-attr">title:</span> <span class="hljs-string">'仪表板'</span>, <span class="hljs-attr">requiresAuth:</span> <span class="hljs-literal">true</span> }
  }
]<span class="hljs-string">;</span>
</code></pre>
<h2 data-id="heading-2">三、懒加载与代码分割</h2>
<ul>
<li><code>React.lazy</code> 是 React 中实现<strong>组件级代码分割</strong>的核心 API，它允许你将组件代码延迟加载，从而优化应用性能。</li>
<li><code>React.lazy</code><strong>必须在 Suspense 内使用</strong></li>
<li><strong>Suspense</strong> 是 React 中用于处理异步操作的组件，它让组件可以"等待"某些操作完成，在等待期间显示回退 UI。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 懒加载组件定义</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyAbout</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../pages/About'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyUserList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../pages/UserList'</span>));

<span class="hljs-comment">// 封装Suspense包装器组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">LazyComponent</span> = (<span class="hljs-params">{ component: Component }</span>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingFallback</span> /&gt;</span>}&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">Component</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
);
</code></pre>
<ul>
<li>页面加载时的等待状态</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//此处仅示例，实际可放置全局的未加载完成时的等待样式</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">LoadingFallback</span> = (<span class="hljs-params"/>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>页面加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
<h2 data-id="heading-3">四、路由守卫与权限控制</h2>
<ul>
<li>认证守卫组件：基于token的<code>认证检查</code>、<code>自动重定向</code>、replace<code>防止回退到受保护的页面</code></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">AuthGuard</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
  <span class="hljs-keyword">const</span> isAuthenticated = !!<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);
  
  <span class="hljs-comment">// 未认证重定向到登录页</span>
  <span class="hljs-keyword">if</span> (!isAuthenticated) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/login"</span> <span class="hljs-attr">replace</span> /&gt;</span></span>;
  }
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{children}<span class="hljs-tag">&lt;/&gt;</span></span>;
};
</code></pre>
<ul>
<li>元数据驱动的权限控制</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml">{
  <span class="hljs-attr">path:</span> <span class="hljs-string">'/user-center'</span>,
  <span class="hljs-attr">element:</span> <span class="hljs-string">&lt;UserCenter</span> <span class="hljs-string">/&gt;</span>,
  <span class="hljs-attr">meta:</span> {
    <span class="hljs-attr">title:</span> <span class="hljs-string">'用户中心'</span>,
    <span class="hljs-attr">requiresAuth:</span> <span class="hljs-literal">true</span>
    <span class="hljs-string">//权限控制</span>
    <span class="hljs-attr">roles:</span> [<span class="hljs-string">'admin'</span>]
  }
}
</code></pre>
<h2 data-id="heading-4">五、递归渲染与嵌套路由</h2>
<ul>
<li>支持无限层级嵌套</li>
<li>统一的认证处理逻辑</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">renderRoutes</span> = (<span class="hljs-params">routes: RouteConfig[]</span>) =&gt; {
  <span class="hljs-keyword">return</span> routes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { path, element, children, redirect, meta } = route;

    <span class="hljs-comment">// 处理重定向</span>
    <span class="hljs-keyword">if</span> (redirect) {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{path}</span>
          <span class="hljs-attr">path</span>=<span class="hljs-string">{path}</span>
          <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">{redirect}</span> <span class="hljs-attr">replace</span> /&gt;</span>}
        /&gt;</span>
      );
    }

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span>
        <span class="hljs-attr">key</span>=<span class="hljs-string">{path}</span>
        <span class="hljs-attr">path</span>=<span class="hljs-string">{path}</span>
        <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>
          // <span class="hljs-attr">根据元数据决定是否包裹AuthGuard</span>
          <span class="hljs-attr">meta</span>?<span class="hljs-attr">.requiresAuth</span> ? (
            &lt;<span class="hljs-attr">AuthGuard</span>&gt;</span>{element}<span class="hljs-tag">&lt;/<span class="hljs-name">AuthGuard</span>&gt;</span>
          ) : (
            element
          )
        }
      &gt;
        {/* 递归渲染子路由 */}
        {children &amp;&amp; renderRoutes(children)}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span>
    );
  });
};

</code></pre>
<ul>
<li>嵌套路由示例</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/father'</span>,
  <span class="hljs-attr">children</span>: [
    {
      <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,  <span class="hljs-comment">// 访问 /father</span>
      <span class="hljs-attr">redirect</span>: <span class="hljs-string">'son'</span>  <span class="hljs-comment">// 重定向到 /father/son</span>
    },
    {
      <span class="hljs-attr">path</span>: <span class="hljs-string">'son'</span>,  <span class="hljs-comment">// 访问 /father/son</span>
      <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Son</span> /&gt;</span></span>
    }
  ]
}
</code></pre>
<h2 data-id="heading-5">六、辅助工具函数</h2>
<h3 data-id="heading-6">1. 面包屑导航生成</h3>
<ul>
<li>显示当前页面</li>
<li>快速导航</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">export const <span class="hljs-attr">generateBreadcrumbs</span> = (pathname) =&gt; {
  const <span class="hljs-attr">segments</span> = pathname.split(<span class="hljs-string">'/'</span>).filter(Boolean)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">breadcrumbs</span> = []<span class="hljs-comment">;</span>
  let <span class="hljs-attr">currentPath</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>

  for (const segment of segments) {
    currentPath += `/${segment}`<span class="hljs-comment">;</span>
    const <span class="hljs-attr">route</span> = findRouteByPath(currentPath)<span class="hljs-comment">;</span>

    if (route?.meta?.title) {
      breadcrumbs.push({
        title: route.meta.title,
        path: route.path !== '/404' ? currentPath : undefined,
      })<span class="hljs-comment">;</span>
    }
  }

  return breadcrumbs<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-7">2. 路由查找功能</h3>
<pre><code class="hljs language-ini" lang="ini">export const <span class="hljs-attr">findRouteByPath</span> = (pathname, routes = getAllRoutes()) =&gt; {
  for (const route of routes) {
    if (<span class="hljs-attr">route.path</span> === pathname) return route<span class="hljs-comment">;</span>
    
    if (route.children) {
      const <span class="hljs-attr">found</span> = findRouteByPath(pathname, route.children)<span class="hljs-comment">;</span>
      if (found) return found<span class="hljs-comment">;</span>
    }
  }
  
  return null<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-8">七、汇总使用</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AppRouter.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span>, <span class="hljs-title class_">Navigate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/App'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Father</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/Father'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Son</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/Son'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/Login'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NotFound</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/NotFound'</span>;

<span class="hljs-comment">/**
 * ============================================
 * 定义路由配置接口
 * ============================================
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RouteConfig</span> {
  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>;                     <span class="hljs-comment">// 路由路径</span>
  element?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;        <span class="hljs-comment">// 渲染组件</span>
  children?: <span class="hljs-title class_">RouteConfig</span>[];         <span class="hljs-comment">// 子路由</span>
  redirect?: <span class="hljs-built_in">string</span>;                <span class="hljs-comment">// 重定向路径</span>
  meta?: {                          <span class="hljs-comment">// 路由元信息</span>
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;                  <span class="hljs-comment">// 页面标题</span>
    requiresAuth?: <span class="hljs-built_in">boolean</span>;         <span class="hljs-comment">// 是否需要登录</span>
    roles?: <span class="hljs-built_in">string</span>[];               <span class="hljs-comment">// 允许访问的角色</span>
  };
}

<span class="hljs-comment">/**
 * 懒加载配置区域
 * 使用 React.lazy 实现代码分割
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyApp</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../pages/App'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyFather</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../pages/Father'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LazySon</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../pages/Son'</span>));

<span class="hljs-comment">/**
 * 加载中组件
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">LoadingFallback</span> = (<span class="hljs-params"/>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>页面加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);

<span class="hljs-comment">/**
 * 懒加载组件包装器
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">LazyComponent</span> = (<span class="hljs-params">{ component: Component }</span>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingFallback</span> /&gt;</span>}&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">Component</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
);

<span class="hljs-comment">/**
 * 权限守卫组件
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">AuthGuard</span> = (<span class="hljs-params">{ children }</span>) =&gt; {
  <span class="hljs-keyword">const</span> isAuthenticated = !!<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);
  <span class="hljs-keyword">if</span> (!isAuthenticated) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/login"</span> <span class="hljs-attr">replace</span> /&gt;</span></span>;
  }
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{children}<span class="hljs-tag">&lt;/&gt;</span></span>;
};

<span class="hljs-comment">/**
 * 公共路由配置（不需要登录）
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">publicRoutes</span>: <span class="hljs-title class_">RouteConfig</span>[] = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/login'</span>,
    <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Login</span> /&gt;</span></span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'登录'</span>,
      <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">false</span>,
    },
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/404'</span>,
    <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NotFound</span> /&gt;</span></span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'页面不存在'</span>,
      <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">false</span>,
    },
  },
];

<span class="hljs-comment">/**
 * 私有路由配置（需要登录）
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">privateRoutes</span>: <span class="hljs-title class_">RouteConfig</span>[] = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">element</span>: (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthGuard</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>主布局<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> {/* 这里可以根据需要添加布局组件 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">AuthGuard</span>&gt;</span></span>
    ),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'首页'</span>,
      <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-attr">children</span>: [
      <span class="hljs-comment">// 默认重定向到 App 页面</span>
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/app'</span>,
      },
      <span class="hljs-comment">// App 页面</span>
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'app'</span>,
        <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{LazyApp}</span> /&gt;</span></span>,
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'App 页面'</span>,
          <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">true</span>,
        },
      },
      <span class="hljs-comment">// Father 页面</span>
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'father'</span>,
        <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{LazyFather}</span> /&gt;</span></span>,
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'Father 页面'</span>,
          <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">children</span>: [
          <span class="hljs-comment">// 访问 /father 时重定向到 /father/son</span>
          {
            <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>,
            <span class="hljs-attr">redirect</span>: <span class="hljs-string">'son'</span>,
          },
          <span class="hljs-comment">// Son 页面作为 Father 的子页面</span>
          {
            <span class="hljs-attr">path</span>: <span class="hljs-string">'son'</span>,
            <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{LazySon}</span> /&gt;</span></span>,
            <span class="hljs-attr">meta</span>: {
              <span class="hljs-attr">title</span>: <span class="hljs-string">'Son 页面'</span>,
              <span class="hljs-attr">requiresAuth</span>: <span class="hljs-literal">true</span>,
            },
          },
        ],
      },
    ],
  },
];

<span class="hljs-comment">/**
 * 递归渲染路由配置
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">renderRoutes</span> = (<span class="hljs-params">routes: RouteConfig[]</span>) =&gt; {
  <span class="hljs-keyword">return</span> routes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { path, element, children, redirect, meta } = route;

    <span class="hljs-comment">// 如果有重定向，直接返回重定向路由</span>
    <span class="hljs-keyword">if</span> (redirect) {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{path}</span>
          <span class="hljs-attr">path</span>=<span class="hljs-string">{path}</span>
          <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">{redirect}</span> <span class="hljs-attr">replace</span> /&gt;</span>}
        /&gt;</span>
      );
    }

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span>
        <span class="hljs-attr">key</span>=<span class="hljs-string">{path}</span>
        <span class="hljs-attr">path</span>=<span class="hljs-string">{path}</span>
        <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>
          &lt;<span class="hljs-attr">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingFallback</span> /&gt;</span>}&gt;
            {meta?.requiresAuth ? (
              <span class="hljs-tag">&lt;<span class="hljs-name">AuthGuard</span>&gt;</span>
                {element}
              <span class="hljs-tag">&lt;/<span class="hljs-name">AuthGuard</span>&gt;</span>
            ) : (
              element
            )}
          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        }
      &gt;
        {/* 递归渲染子路由 */}
        {children &amp;&amp; renderRoutes(children)}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span>
    );
  });
};

<span class="hljs-comment">/**
 * 主路由组件
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">AppRouter</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
      {/* 渲染所有路由 */}
      {renderRoutes([...publicRoutes, ...privateRoutes])}
      {/* 处理未匹配的路由 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"*"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/404"</span> <span class="hljs-attr">replace</span> /&gt;</span>} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span>
  );
};

<span class="hljs-comment">/**
 * 获取所有路由配置
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getAllRoutes</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> [...publicRoutes, ...privateRoutes];
};

<span class="hljs-comment">/**
 * 根据路径查找路由信息
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">findRouteByPath</span> = (<span class="hljs-params">
  pathname: <span class="hljs-built_in">string</span>,
  routes = getAllRoutes()
</span>) =&gt; {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> route <span class="hljs-keyword">of</span> routes) {
    <span class="hljs-keyword">if</span> (route.<span class="hljs-property">path</span> === pathname) {
      <span class="hljs-keyword">return</span> route;
    }

    <span class="hljs-keyword">if</span> (route.<span class="hljs-property">children</span>) {
      <span class="hljs-keyword">const</span> found = <span class="hljs-title function_">findRouteByPath</span>(pathname, route.<span class="hljs-property">children</span>);
      <span class="hljs-keyword">if</span> (found) {
        <span class="hljs-keyword">return</span> found;
      }
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-comment">/**
 * 生成面包屑导航数据
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">generateBreadcrumbs</span> = (<span class="hljs-params">pathname</span>) =&gt; {
  <span class="hljs-keyword">const</span> segments = pathname.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);
  <span class="hljs-keyword">const</span> breadcrumbs = [];
  <span class="hljs-keyword">let</span> currentPath = <span class="hljs-string">''</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> segment <span class="hljs-keyword">of</span> segments) {
    currentPath += <span class="hljs-string">`/<span class="hljs-subst">${segment}</span>`</span>;
    <span class="hljs-keyword">const</span> route = <span class="hljs-title function_">findRouteByPath</span>(currentPath);

    <span class="hljs-keyword">if</span> (route?.<span class="hljs-property">meta</span>?.<span class="hljs-property">title</span>) {
      breadcrumbs.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">title</span>: route.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>,
        <span class="hljs-attr">path</span>: route.<span class="hljs-property">path</span> !== <span class="hljs-string">'/404'</span> ? currentPath : <span class="hljs-literal">undefined</span>,
      });
    }
  }
  <span class="hljs-keyword">return</span> breadcrumbs;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">AppRouter</span>;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react使用Ant Design]]></title>    <link>https://juejin.cn/post/7593015632078405659</link>    <guid>https://juejin.cn/post/7593015632078405659</guid>    <pubDate>2026-01-09T03:58:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593015632078405659" data-draft-id="7592996072705032242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react使用Ant Design"/> <meta itemprop="keywords" content="前端,React.js,Ant Design"/> <meta itemprop="datePublished" content="2026-01-09T03:58:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="加油乐"/> <meta itemprop="url" content="https://juejin.cn/user/84036866547575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react使用Ant Design
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/84036866547575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    加油乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:58:56.000Z" title="Fri Jan 09 2026 03:58:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、安装</h2>
<ul>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fintroduce-cn" target="_blank" title="https://ant.design/docs/react/introduce-cn" ref="nofollow noopener noreferrer">Ant Design</a></li>
<li>npm</li>
</ul>
<pre><code class="hljs language-css" lang="css">npm install antd <span class="hljs-attr">--save</span>
</code></pre>
<ul>
<li>yarn</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">yarn <span class="hljs-keyword">add</span> antd
</code></pre>
<ul>
<li>pnpm</li>
</ul>
<pre><code class="hljs language-css" lang="css">pnpm install antd <span class="hljs-attr">--save</span>
</code></pre>
<h2 data-id="heading-1">二、main引用</h2>
<ul>
<li>引入Ant Design的<code>reset.css</code>文件</li>
<li>引入<code>ConfigProvider</code>全局配置，且包含所有组件</li>
<li>设置<code>locale</code>属性为<code>中文</code></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入严格模式组件，用于开发环境下检测潜在问题</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StrictMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-comment">// 导入客户端渲染方法，用于创建根节点并渲染应用</span>
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.jsx'</span>;
<span class="hljs-comment">// 导入Ant Design的样式文件</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'antd/dist/reset.css'</span>;
<span class="hljs-comment">// 导入全局自定义样式文件</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span>;
<span class="hljs-comment">// 导入Ant Design配置提供者组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-comment">// 导入Ant Design的中文语言包</span>
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/locale/zh_CN'</span>;

<span class="hljs-comment">// 获取 HTML 中 id 为 'root' 的 DOM 元素作为应用根节点</span>
<span class="hljs-keyword">const</span> rootElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>);

<span class="hljs-comment">// 如果找不到根节点，则抛出错误</span>
<span class="hljs-keyword">if</span> (!rootElement) {
	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'找不到id为"root"的DOM元素，请检查index.html文件'</span>);
}

<span class="hljs-comment">// 创建 React 根节点</span>
<span class="hljs-keyword">const</span> root = <span class="hljs-title function_">createRoot</span>(rootElement);

<span class="hljs-comment">// 渲染整个 React 应用</span>
root.<span class="hljs-title function_">render</span>(
	<span class="hljs-comment">// 使用严格模式包装应用</span>
	<span class="hljs-comment">// 注意：严格模式只在开发环境生效，生产环境会自动禁用</span>
	<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
		{/*
		 ConfigProvider 是 Ant Design 的全局配置组件
		 此处设置 locale 属性为中文语言包，实现组件国际化
		 可以在这里添加更多全局配置，如主题定制等
		 */}
		<span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">{zhCN}</span>&gt;</span>
			{/*
			 应用主组件
			 所有页面和路由都将在 App 组件内部定义和管理
			 */}
			<span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
);

</code></pre>
<h2 data-id="heading-2">三、组件引用</h2>
<ul>
<li>引用Button，查看使用效果</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
	<span class="hljs-keyword">return</span> (
		<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
	);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AQS 解析：从原理到实战]]></title>    <link>https://juejin.cn/post/7592815497848864831</link>    <guid>https://juejin.cn/post/7592815497848864831</guid>    <pubDate>2026-01-09T01:41:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848864831" data-draft-id="7592863358258905142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AQS 解析：从原理到实战"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2026-01-09T01:41:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gelald"/> <meta itemprop="url" content="https://juejin.cn/user/923245499657822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AQS 解析：从原理到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/923245499657822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gelald
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:41:59.000Z" title="Fri Jan 09 2026 01:41:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要 AQS</h2>
<p>经过 synchronized 的学习，我们知道 synchronized 可以很方便地给一段共享资源的操作加上锁，对操作进行同步控制；</p>
<p>但是 synchronized 也有一定的弊端：</p>
<ul>
<li><strong>不支持中断</strong> (线程无法响应 interrupt)</li>
<li><strong>不支持超时</strong> (无法进行 <code>tryLock(timeout)</code>)</li>
<li><strong>不支持公平锁</strong> (无法保证 FIFO 获取)</li>
</ul>
<p>AQS 全称 AbstractQueueSynchronizer (抽象队列同步器)，它正是用来解决以上弊端的，同时它作为 J.U.C 包的基础，提供了：</p>
<ul>
<li>标准化的同步框架：统一封装了线程排队、阻塞、唤醒等通用逻辑</li>
<li>灵活的扩展能力：使用模板方法设计模式，定制自定义同步语意</li>
<li>高性能无锁设计：CAS 原子操作 + <code>volatile</code> 保证数据修改是线程安全的</li>
</ul>
<h2 data-id="heading-1">AQS 核心组件</h2>
<blockquote>
<p>AQS 的设计精髓：一个状态(state) + 一个等待队列(CLH) + 一套原子操作(CAS)</p>
</blockquote>
<h3 data-id="heading-2"><code>state</code> 同步状态机</h3>
<p><code>state</code> 可以理解为锁的计数器，或者资源剩余量，用具体例子来说明：</p>
<ul>
<li><code>ReentrantLock</code>: <code>state = 0</code> 表示无锁，<code>state &gt; 0</code> 表示被持有以及锁重入的次数</li>
<li><code>CountDownLatch</code>: <code>state = 3</code> 表示还需要进行 3 次 <code>countDown()</code></li>
</ul>
<p>关键设计：<code>state</code> 被 <code>volatile</code> 修饰，保证了多个线程之间的可见性</p>
<h3 data-id="heading-3">CLH FIFO阻塞队列</h3>
<p>CLH 队列是一个双向链表实现的阻塞队列，<strong>AQS 通过 prev 和 next 两个指针来维护链表</strong></p>
<p>CLH 队列工作流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[线程尝试获取 state] --&gt;|失败| B[创建 Node 入队]
  B --&gt; C{前驱是 head ?}
  C --&gt;|是| D[再次尝试获取]
  C --&gt;|否| E[阻塞 park]
  D --&gt;|成功| F[设为新 head]
  D --&gt;|失败| E
  E --&gt;|被唤醒| C
</code></pre>
<p>CLH 队列高效关键：</p>
<ul>
<li>当线程获取 <code>state</code> 失败时，会被封装成一个 <code>Node</code> ，<strong>通过 CAS 的方式加入 CLH 队列尾部</strong>，避免使用 <code>synchronized</code> 而带来的开销</li>
<li>每个线程只需要关注前驱线程，比如线程 B 阻塞时，<strong>只等待前驱节点线程 A 唤醒</strong> (<code>LockSupport.unpark</code>)；避免了全局通知的开销，同时天然保证 FIFO 特性</li>
</ul>
<h3 data-id="heading-4">CAS 原子操作基石</h3>
<p>AQS 中对于 <code>state</code> 状态机的修改和线程加入 CLH 队列的操作都是使用 CAS 的方式，既安全又比 <code>synchronized</code> 高效</p>
<h2 data-id="heading-5">AQS 独占模式与共享模式</h2>



































<table><thead><tr><th align="center">对比维度</th><th align="center">独占模式 (Exclusive)</th><th align="center">共享模式 (Shared)</th></tr></thead><tbody><tr><td align="center">语义</td><td align="center">一次仅允许一个线程通过</td><td align="center">在资源足够的情况下，允许多个线程同时通过</td></tr><tr><td align="center">核心方法</td><td align="center"><code>tryAcquire() -&gt; boolean</code></td><td align="center"><code>tryAcquireShared() -&gt; int</code></td></tr><tr><td align="center">返回值含义</td><td align="center"><code>true</code> 表示成功</td><td align="center"><code>&gt;=0</code> 表示成功，值表示剩余资源 <br/> <code>&lt;0</code> 表示失败</td></tr><tr><td align="center">唤醒行为</td><td align="center">唤醒一个后继</td><td align="center">传播式唤醒 (多个线程同时通过)</td></tr><tr><td align="center">代表工具</td><td align="center"><code>ReentrantLock</code>、<code>ReentrantReadWriteLock.WriteLock</code></td><td align="center"><code>CountDownLatch</code>、<code>ReentrantReadWriteLock.ReadLock</code>、<code>Semaphore</code></td></tr></tbody></table>
<h2 data-id="heading-6">公平锁与非公平锁</h2>
<p>先简单讲讲公平锁和非公平锁的意思：</p>
<ul>
<li>公平锁：每个线程按照访问锁的先后顺序来获取锁，遵顼先访问先获取的规则</li>
<li>非公平锁：每个线程都会竞争锁的获取，获取顺序是随机的，不遵循先来先得的规则</li>
</ul>
<p>ReentrantLock 中对公平锁和非公平锁都进行了实现，主要的区别在于 <code>tryAcquire()</code> 方法中，其中 <code>FairSync</code> 的实现中，在 CAS 修改 <code>state</code> 之前还先检查了一下排队线程，前面没有其他线程等待锁了，才进行 CAS 修改 <code>state</code> 来获取锁；在 <code>NonfairSync</code> 的实现中，则所有线程不管队列，直接一起抢占</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-comment">// hasQueuedPredecessors: 如果当前线程前面有已排队的线程，则返回 true；如果当前线程位于队列头部或队列为空，则返回 false。</span>
        <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span> &amp;&amp; !hasQueuedPredecessors() &amp;&amp; compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
            setExclusiveOwnerThread(Thread.currentThread());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
        <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span> &amp;&amp; compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
            setExclusiveOwnerThread(Thread.currentThread());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h2 data-id="heading-7">AQS 简易实现</h2>
<h3 data-id="heading-8">不可重入锁</h3>
<p>接下来使用 AQS 来实现 synchronized 功能</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AQSDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">SimpleMutex</span> <span class="hljs-variable">simpleMutex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMutex</span>();

        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-comment">// 线程1：获取锁并持有3秒</span>
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 尝试获取锁"</span>);
            simpleMutex.lock();
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 获取锁成功"</span>);
            <span class="hljs-keyword">try</span> {
                TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            } <span class="hljs-keyword">finally</span> {
                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 释放锁"</span>);
                simpleMutex.unlock();
            }
        }, <span class="hljs-string">"Thread-1"</span>);

        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 确保线程1拿到锁</span>
                TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">100</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            <span class="hljs-comment">// 线程2：获取锁时会进入阻塞状态，直到线程1释放锁</span>
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 尝试获取锁"</span>);
            simpleMutex.lock();
            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 获取锁成功"</span>);
            <span class="hljs-keyword">try</span> {
                TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            } <span class="hljs-keyword">finally</span> {
                simpleMutex.unlock();
                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">" 释放锁"</span>);
            }
        }, <span class="hljs-string">"Thread-2"</span>);

        t1.start();
        t2.start();

        t1.join();
        t2.join();

        System.out.println(<span class="hljs-string">"主线程结束，锁状态："</span> + (simpleMutex.isLocked() ? <span class="hljs-string">"已锁"</span> : <span class="hljs-string">"未锁"</span>));
    }
}

<span class="hljs-comment">/**
 * 一个基于 AQS 的简单互斥锁（不可重入）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleMutex</span> {
    <span class="hljs-comment">// 实现互斥锁的核心组件，通过 AQS 来构建同步工具</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
            <span class="hljs-comment">// 通过 CAS 的方式修改 state 值</span>
            <span class="hljs-comment">// 原子地获取锁</span>
            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
                <span class="hljs-comment">// 记录当前拥有独立访问权限的线程</span>
                <span class="hljs-comment">// 可重入的基础</span>
                setExclusiveOwnerThread(Thread.currentThread());
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 如果 state 已经是 0，说明没有成功获取锁，或者已经被释放了，抛出异常</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();
            }
            <span class="hljs-comment">// 清除拥有独立访问权限线程的标识</span>
            setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
            <span class="hljs-comment">// state = 0 说明释放锁</span>
            setState(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 通过 state 是否等于 1 来判断锁是否被持有</span>
            <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">1</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        sync.acquire(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
        sync.release(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.isHeldExclusively();
    }
}
</code></pre>
<p>结果是：线程 2 也尝试获取锁，但是阻塞等待着线程 1 的释放</p>
<pre><code class="hljs">Thread-1 尝试获取锁
Thread-1 获取锁成功
Thread-2 尝试获取锁
Thread-1 释放锁
Thread-2 获取锁成功
Thread-2 释放锁
主线程结束，锁状态：未锁
</code></pre>
<h3 data-id="heading-9">可重入锁</h3>
<p>在简易实现的基础上添加重入的支持，核心要点就是检查 <code>state</code> 的数量和 <code>exclusiveOwnerThread</code> 的指向</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AQSDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">ReentrantMutex</span> <span class="hljs-variable">reentrantMutex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantMutex</span>();

        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            System.out.println(<span class="hljs-string">"线程开始"</span>);

            reentrantMutex.lock();
            System.out.println(<span class="hljs-string">"第1次 lock，holdCount = "</span> + reentrantMutex.getHoldCount());

            reentrantMutex.lock();
            System.out.println(<span class="hljs-string">"第2次 lock，holdCount = "</span> + reentrantMutex.getHoldCount());

            reentrantMutex.lock();
            System.out.println(<span class="hljs-string">"第3次 lock，holdCount = "</span> + reentrantMutex.getHoldCount());

            <span class="hljs-comment">// 释放三次</span>
            reentrantMutex.unlock();
            System.out.println(<span class="hljs-string">"第1次 unlock，holdCount = "</span> + reentrantMutex.getHoldCount());

            reentrantMutex.unlock();
            System.out.println(<span class="hljs-string">"第2次 unlock，holdCount = "</span> + reentrantMutex.getHoldCount());

            reentrantMutex.unlock();
            System.out.println(<span class="hljs-string">"第3次 unlock，holdCount = "</span> + reentrantMutex.getHoldCount());

            System.out.println(<span class="hljs-string">"线程结束，锁是否释放: "</span> + !reentrantMutex.isLocked());
        });

        t.start();
        <span class="hljs-keyword">try</span> {
            t.join();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantMutex</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
            <span class="hljs-type">int</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> getState();

            <span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 无锁，尝试获取</span>
                <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
                    setExclusiveOwnerThread(current);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (current == getExclusiveOwnerThread()) {
                <span class="hljs-comment">// 可重入：同一线程再次获取</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> state + acquires;
                <span class="hljs-keyword">if</span> (next &lt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// 溢出检查</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum lock count exceeded"</span>);
                }
                setState(next);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-type">int</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> getState() - releases;
            <span class="hljs-keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread()) {
                <span class="hljs-comment">// 非持有者释放锁，抛出异常</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();
            }

            <span class="hljs-type">boolean</span> <span class="hljs-variable">free</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 重入次数归零，真正释放</span>
                free = <span class="hljs-literal">true</span>;
                setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
            }
            <span class="hljs-comment">// 未归零，继续更新 state</span>
            setState(state);
            <span class="hljs-comment">// 注意：AQS release() 会检查 tryRelease() 返回值是否为 true</span>
            <span class="hljs-keyword">return</span> free;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHoldCount</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 如果被持有着，返回重入次数</span>
            <span class="hljs-comment">// 如果没有被持有，直接返回0</span>
            <span class="hljs-keyword">return</span> isHeldExclusively() ? getState() : <span class="hljs-number">0</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        sync.acquire(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
        sync.release(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.isHeldExclusively();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHoldCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.getHoldCount();
    }
}
</code></pre>
<p>结果是：</p>
<pre><code class="hljs language-ini" lang="ini">线程开始
第1次 lock，<span class="hljs-attr">holdCount</span> = <span class="hljs-number">1</span>
第2次 lock，<span class="hljs-attr">holdCount</span> = <span class="hljs-number">2</span>
第3次 lock，<span class="hljs-attr">holdCount</span> = <span class="hljs-number">3</span>
第1次 unlock，<span class="hljs-attr">holdCount</span> = <span class="hljs-number">2</span>
第2次 unlock，<span class="hljs-attr">holdCount</span> = <span class="hljs-number">1</span>
第3次 unlock，<span class="hljs-attr">holdCount</span> = <span class="hljs-number">0</span>
线程结束，锁是否释放: true
</code></pre>
<h2 data-id="heading-10">总结 AQS 的设计哲学</h2>
<ul>
<li><strong>分离关注点，高效扩展</strong>：AQS 中已经定义好通用的逻辑 (获取锁、阻塞排队、释放锁、唤醒)，比如 <code>acquire()</code> 和 <code>release()</code> 方法；子类只需要实现 “如何通过” (怎么样才算是获取/释放锁成功/失败)，比如 <code>tryAcquire()</code> 和 <code>tryRelease()</code> 方法，体现了模板方法的设计模式</li>
<li><strong>线程安全，操作高效</strong>：对于 <code>state</code> 状态机以及队列操作，都使用 <code>volatile</code> 修饰且使用 CAS 操作，避免直接使用 synchronized，既保证安全又保证了性能；CLH 队列的唤醒，只需要唤醒后一个线程，避免全局唤醒的开销</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dubbo微服务实战]]></title>    <link>https://juejin.cn/post/7593139476833157163</link>    <guid>https://juejin.cn/post/7593139476833157163</guid>    <pubDate>2026-01-09T06:17:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476833157163" data-draft-id="7592887786966761508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dubbo微服务实战"/> <meta itemprop="keywords" content="Dubbo"/> <meta itemprop="datePublished" content="2026-01-09T06:17:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dubbo微服务实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:17:28.000Z" title="Fri Jan 09 2026 06:17:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Dubbo微服务实战</h2>
<h2 data-id="heading-1">前言</h2>
<p>在微服务架构盛行的今天，分布式服务调用成为了企业级应用开发的标配。Apache Dubbo作为阿里巴巴开源的高性能、轻量级的RPC（远程过程调用）框架，在国内拥有广泛的应用场景。</p>
<h2 data-id="heading-2">一、Dubbo简介</h2>
<h3 data-id="heading-3">1.1 什么是Dubbo？</h3>
<p>Apache Dubbo是一款高性能、轻量级的开源Java RPC框架，它提供了三大核心能力：</p>
<ul>
<li><strong>面向接口的远程方法调用</strong>：像调用本地方法一样调用远程服务</li>
<li><strong>智能容错和负载均衡</strong>：内置多种负载均衡策略和容错机制</li>
<li><strong>服务自动注册与发现</strong>：支持多种注册中心，实现服务的自动注册和发现</li>
</ul>
<h3 data-id="heading-4">1.2 Dubbo的发展历程</h3>
<ul>
<li>2011年：阿里巴巴开源Dubbo 2.0</li>
<li>2014年：Dubbo进入维护期</li>
<li>2017年：阿里巴巴重启Dubbo开发</li>
<li>2019年：Dubbo成为Apache顶级项目</li>
<li>2023年：发布Dubbo 3.x系列，全面支持云原生</li>
</ul>
<h3 data-id="heading-5">1.3 为什么选择Dubbo？</h3>
<p><strong>对比Spring Cloud的优势：</strong></p>



































<table><thead><tr><th>特性</th><th>Dubbo</th><th>Spring Cloud</th></tr></thead><tbody><tr><td>通信协议</td><td>Dubbo协议（性能更优）</td><td>HTTP REST</td></tr><tr><td>序列化</td><td>Hessian2（效率高）</td><td>JSON</td></tr><tr><td>服务调用</td><td>RPC（透明）</td><td>REST API</td></tr><tr><td>学习曲线</td><td>较低</td><td>较高</td></tr><tr><td>社区活跃度</td><td>国内为主</td><td>国际化</td></tr></tbody></table>
<h2 data-id="heading-6">二、Dubbo核心架构</h2>
<h3 data-id="heading-7">2.1 系统架构图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a541008a7a74bcdbcc71fad848a65eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=ivotqTH%2BebmxfJK1JA3mMKkrcOk%3D" alt="" loading="lazy"/></p>
<p>上图展示了完整的Dubbo微服务六层架构，从客户端到数据层的完整调用链路。Dubbo的架构设计非常清晰，主要包含以下角色：</p>
<ul>
<li><strong>Registry（注册中心）</strong> ：负责服务的注册与发现</li>
<li><strong>Provider（服务提供者）</strong> ：暴露服务的应用</li>
<li><strong>Consumer（服务消费者）</strong> ：调用远程服务的应用</li>
<li><strong>Monitor（监控中心）</strong> ：统计服务调用次数和调用时间</li>
<li><strong>Container（服务容器）</strong> ：负责启动、加载和运行服务</li>
</ul>
<h3 data-id="heading-8">2.2 服务调用时序图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77e1484bc0c3476390d69d6b80ff0452~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=mtaD2Ig1tY9bl6PnxGglANXKVWM%3D" alt="" loading="lazy"/></p>
<p>从时序图中可以看到，一个完整的Dubbo服务调用包含以下步骤：</p>
<ol>
<li><strong>客户端发起HTTP请求</strong>到Consumer</li>
<li><strong>Consumer向Registry订阅服务</strong>，获取Provider列表</li>
<li><strong>Registry返回可用的Provider地址列表</strong></li>
<li><strong>Consumer根据负载均衡策略选择一个Provider</strong></li>
<li><strong>通过Dubbo协议进行RPC调用</strong>（默认端口20880）</li>
<li><strong>Provider查询数据并返回结果</strong></li>
<li><strong>Consumer将结果以HTTP响应返回给客户端</strong></li>
</ol>
<h3 data-id="heading-9">2.3 Dubbo工作原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7198cf5c9e24ec2a612bb8ad83d67e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=FoOfP62BMZQMeI8h6fz%2FHEgGJtA%3D" alt="" loading="lazy"/></p>
<p>Dubbo采用分层架构设计，从上到下共9层：</p>
<ol>
<li><strong>Service层（业务层）</strong> ：接口和实现定义，如UserService、OrderService</li>
<li><strong>Config层（配置层）</strong> ：@DubboService、@DubboReference等配置</li>
<li><strong>Proxy层（代理层）</strong> ：服务接口代理，透明化远程调用</li>
<li><strong>Registry层（注册层）</strong> ：服务的注册与发现</li>
<li><strong>Cluster层（集群层）</strong> ：负载均衡、容错处理</li>
<li><strong>Protocol层（协议层）</strong> ：RPC调用封装</li>
<li><strong>Exchange层（交换层）</strong> ：请求响应映射</li>
<li><strong>Network层（网络层）</strong> ：Netty、Mina等网络通信</li>
<li><strong>Serialize层（序列化层）</strong> ：Hessian2、JSON等数据序列化</li>
</ol>
<p>这种分层设计使得Dubbo具有良好的扩展性，每一层都可以独立替换和优化。</p>
<h2 data-id="heading-10">三、服务注册与发现</h2>
<h3 data-id="heading-11">3.1 服务注册发现流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9718a2344e71428ca918ae8740277ae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=gs2U0wq2TYMbNmjRdJzivysTYz4%3D" alt="" loading="lazy"/></p>
<p>服务注册与发现是Dubbo的核心机制，分为两个流程：</p>
<p><strong>Provider注册流程：</strong></p>
<ol>
<li>Provider服务启动</li>
<li>连接到Zookeeper注册中心</li>
<li>注册服务接口、版本、分组等信息</li>
<li>订阅配置变更</li>
<li>暴露Dubbo服务（默认20880端口）</li>
</ol>
<p><strong>Consumer发现流程：</strong></p>
<ol>
<li>Consumer服务启动</li>
<li>连接到Zookeeper注册中心</li>
<li>订阅所需的服务接口</li>
<li>获取Provider地址列表</li>
<li>根据负载均衡策略调用Provider</li>
</ol>
<h3 data-id="heading-12">3.2 Zookeeper配置</h3>
<p>Zookeeper是Dubbo最常用的注册中心：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载Zookeeper</span>
wget https://downloads.apache.org/zookeeper/

<span class="hljs-comment"># 启动Zookeeper</span>
bin/zkServer.sh start
</code></pre>
<p><strong>配置参数：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://127.0.0.1:2181</span>
    <span class="hljs-attr">sessiontimeout:</span> <span class="hljs-number">60000</span>
    <span class="hljs-attr">register:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">subscribe:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-13">3.3 其他注册中心</h3>
<p>Dubbo还支持：</p>
<ul>
<li><strong>Nacos</strong>：阿里开源，功能更强大，支持配置管理</li>
<li><strong>Redis</strong>：轻量级选择，适合小规模应用</li>
<li><strong>Consul</strong>：支持健康检查和服务网格</li>
</ul>
<p><strong>Nacos配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">nacos://127.0.0.1:8848</span>
</code></pre>
<h2 data-id="heading-14">四、负载均衡策略</h2>
<h3 data-id="heading-15">4.1 负载均衡原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a12ae92e4829450081eb203bd6526322~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=JkuCIlveyLj3rQbDjdyIz6%2F%2FiXI%3D" alt="" loading="lazy"/></p>
<p>Dubbo提供多种负载均衡策略，可以根据业务场景选择：</p>








































<table><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>Random（随机）</td><td>随机选择Provider</td><td>默认策略，Provider性能相近</td></tr><tr><td>RoundRobin（轮询）</td><td>按顺序轮流调用</td><td>Provider性能相近，请求均匀分布</td></tr><tr><td>LeastActive（最少活跃）</td><td>选择活跃数最少的Provider</td><td>Provider性能差异大</td></tr><tr><td>ConsistentHash（一致性哈希）</td><td>相同参数路由到同一Provider</td><td>有状态服务，如用户会话</td></tr><tr><td>WeightedRandom（加权随机）</td><td>根据权重随机选择</td><td>Provider性能不同</td></tr><tr><td>ShortestResponse（最短响应）</td><td>选择响应时间最短的Provider</td><td>对性能要求高</td></tr></tbody></table>
<h3 data-id="heading-16">4.2 配置示例</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 服务端配置</span>
<span class="hljs-variable">@DubboService</span>(loadbalance = <span class="hljs-string">"random"</span>)
public class UserServiceImpl implements UserService {}

<span class="hljs-comment">// 客户端配置</span>
<span class="hljs-variable">@DubboReference</span>(loadbalance = <span class="hljs-string">"roundrobin"</span>)
private UserService userService;

# 全局配置
<span class="hljs-selector-tag">dubbo</span>:
  <span class="hljs-selector-tag">provider</span>:
    <span class="hljs-selector-tag">loadbalance</span>: <span class="hljs-selector-tag">random</span>
  <span class="hljs-selector-tag">consumer</span>:
    <span class="hljs-selector-tag">loadbalance</span>: <span class="hljs-selector-tag">random</span>
</code></pre>
<h2 data-id="heading-17">五、集群容错机制</h2>
<h3 data-id="heading-18">5.1 容错策略</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a54ab60d3de74519baf054c8dd4b6ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=R2hgBAhH59SFZmoRWZUhH2xNyII%3D" alt="" loading="lazy"/></p>
<p>Dubbo提供6种集群容错策略，保证服务的高可用性：</p>








































<table><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>Failover（失败自动切换）</td><td>失败后重试其他Provider</td><td>默认策略，幂等操作</td></tr><tr><td>Failfast（快速失败）</td><td>失败后立即报错，不重试</td><td>非幂等操作，如写操作</td></tr><tr><td>Failsafe（失败安全）</td><td>失败后忽略，不报错</td><td>日志记录、审计等非关键操作</td></tr><tr><td>Failback（失败自动恢复）</td><td>失败后后台重试</td><td>消息通知、异步任务</td></tr><tr><td>Forking（并行调用）</td><td>并行调用多个Provider，返回成功结果</td><td>对实时性要求高的读操作</td></tr><tr><td>Broadcast（广播调用）</td><td>广播调用所有Provider</td><td>通知所有Provider更新缓存</td></tr></tbody></table>
<h3 data-id="heading-19">5.2 Failover流程详解</h3>
<p>从图中可以看到Failover（最常用的容错策略）的工作流程：</p>
<ol>
<li>Consumer调用Provider A</li>
<li>Provider A失败（超时/异常）</li>
<li>自动重试Provider B（基于负载均衡）</li>
<li>Provider B失败</li>
<li>自动重试Provider C</li>
<li>Provider C成功，返回结果</li>
</ol>
<h3 data-id="heading-20">5.3 配置示例</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 服务端配置</span>
<span class="hljs-variable">@DubboService</span>(
    cluster = <span class="hljs-string">"failover"</span>,
    retries = <span class="hljs-number">2</span>  <span class="hljs-comment">// 重试次数</span>
)
public class UserServiceImpl implements UserService {}

<span class="hljs-comment">// 客户端配置</span>
<span class="hljs-variable">@DubboReference</span>(
    cluster = <span class="hljs-string">"failfast"</span>,  <span class="hljs-comment">// 快速失败</span>
    retries = <span class="hljs-number">0</span>            <span class="hljs-comment">// 不重试</span>
)
private UserService userService;
</code></pre>
<p><strong>重试策略建议：</strong></p>
<ul>
<li>查询操作：可以重试2-3次（Failover）</li>
<li>写操作：建议不重试（Failfast）</li>
<li>重要业务：谨慎设置重试次数</li>
</ul>
<h2 data-id="heading-21">六、实战项目构建</h2>
<h3 data-id="heading-22">6.1 定义服务接口</h3>
<p>dubbo-api模块定义了所有服务的接口，这是Provider和Consumer之间的契约。</p>
<p><strong>用户服务接口：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public interface UserService {
    User <span class="hljs-built_in">getUserById</span>(Long userId);
    Long <span class="hljs-built_in">createUser</span>(User user);
    boolean <span class="hljs-built_in">updateUser</span>(User user);
    boolean <span class="hljs-built_in">deleteUser</span>(Long userId);
    List&lt;User&gt; <span class="hljs-built_in">getAllUsers</span>();
}
</code></pre>
<p><strong>注意事项：</strong></p>
<ol>
<li>服务接口必须保持稳定，避免频繁修改</li>
<li>参数和返回值必须实现Serializable接口</li>
<li>建议使用Java对象作为参数和返回值，便于序列化</li>
</ol>
<h3 data-id="heading-23">6.2 实现服务提供者</h3>
<p>使用<code>@DubboService</code>注解暴露服务：</p>
<pre><code class="hljs language-ini" lang="ini">@DubboService(
    <span class="hljs-attr">version</span> = <span class="hljs-string">"1.0.0"</span>,
    <span class="hljs-attr">group</span> = <span class="hljs-string">"user-service"</span>,
    <span class="hljs-attr">timeout</span> = <span class="hljs-number">5000</span>,
    <span class="hljs-attr">retries</span> = <span class="hljs-number">2</span>,
    <span class="hljs-attr">loadbalance</span> = <span class="hljs-string">"roundrobin"</span>
)
public class UserServiceImpl implements UserService {
    // 实现代码
}
</code></pre>
<p><strong>核心配置参数说明：</strong></p>



































<table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>version</td><td>服务版本号</td><td>-</td></tr><tr><td>group</td><td>服务分组</td><td>-</td></tr><tr><td>timeout</td><td>超时时间(毫秒)</td><td>1000</td></tr><tr><td>retries</td><td>失败重试次数</td><td>2</td></tr><tr><td>loadbalance</td><td>负载均衡策略</td><td>random</td></tr></tbody></table>
<h3 data-id="heading-24">6.3 服务提供者配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo-provider</span>
  <span class="hljs-attr">protocol:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">20880</span>
    <span class="hljs-attr">serialization:</span> <span class="hljs-string">hessian2</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://127.0.0.1:2181</span>
  <span class="hljs-attr">provider:</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">5000</span>
    <span class="hljs-attr">retries:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">loadbalance:</span> <span class="hljs-string">random</span>
</code></pre>
<h3 data-id="heading-25">6.4 实现服务消费者</h3>
<p>使用<code>@DubboReference</code>注解引用远程服务：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/users"</span>)
public class UserController {

    <span class="hljs-variable">@DubboReference</span>(
        version = <span class="hljs-string">"1.0.0"</span>,
        group = <span class="hljs-string">"user-service"</span>,
        check = false
    )
    private UserService userService;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/{id}"</span>)
    public String <span class="hljs-built_in">getUserById</span>(<span class="hljs-variable">@PathVariable</span> Long id) {
        <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">user</span> = <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.getUserById</span>(id);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">user</span> != <span class="hljs-selector-tag">null</span> ? <span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.toString</span>() : "用户不存在";
    }
}
</code></pre>
<h3 data-id="heading-26">6.5 服务消费者配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">dubbo-consumer</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">zookeeper://127.0.0.1:2181</span>
  <span class="hljs-attr">consumer:</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">5000</span>
    <span class="hljs-attr">retries:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">check:</span> <span class="hljs-literal">false</span>
</code></pre>
<h2 data-id="heading-27">七、服务间调用</h2>
<h3 data-id="heading-28">7.1 服务间通信示例</h3>
<p>在订单服务中调用用户服务：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@DubboService</span>
public class OrderServiceImpl implements OrderService {

    <span class="hljs-keyword">@DubboReference</span>
    private UserService userService;

    public Long <span class="hljs-built_in">createOrder</span>(Order order) {
        <span class="hljs-comment">// 1. 验证用户是否存在</span>
        User user = userService<span class="hljs-selector-class">.getUserById</span>(order.getUserId());
        if (user == null) {
            throw new <span class="hljs-built_in">RuntimeException</span>("用户不存在");
        }

        <span class="hljs-comment">// 2. 创建订单</span>
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setId</span>(ID_GENERATOR.getAndIncrement());
        ORDER_DATABASE<span class="hljs-selector-class">.put</span>(order.getId(), <span class="hljs-attribute">order</span>);

        return <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getId</span>();
    }
}
</code></pre>
<p><strong>生产环境注意事项：</strong></p>
<ol>
<li>服务间调用要设置合理的超时时间</li>
<li>考虑熔断机制，防止雪崩效应</li>
<li>重要业务逻辑要记录日志</li>
<li>使用分布式追踪系统监控调用链</li>
</ol>
<h2 data-id="heading-29">八、生产环境部署</h2>
<h3 data-id="heading-30">8.1 微服务部署架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0db13f1817aa4ab5b36dbd21c22d303b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768544248&amp;x-signature=IVGmg9xj%2FlorA%2BFetz1eEB4SO4s%3D" alt="" loading="lazy"/></p>
<p>生产环境通常采用多数据中心部署，提高系统的可用性和容灾能力：</p>
<p><strong>北京数据中心（Data Center 1）：</strong></p>
<ul>
<li>3个Provider实例（192.168.1.101-103）</li>
<li>2个Consumer实例（192.168.1.201-202）</li>
<li>3节点Zookeeper集群</li>
</ul>
<p><strong>上海数据中心（Data Center 2）：</strong></p>
<ul>
<li>2个Provider实例（192.168.2.101-102）</li>
<li>2个Consumer实例（192.168.2.201-202）</li>
<li>MySQL主从集群、Redis集群</li>
</ul>
<p><strong>跨数据中心连接：</strong></p>
<ul>
<li>通过VPN或专线连接</li>
<li>实现异地多活和容灾</li>
</ul>
<h3 data-id="heading-31">8.2 高可用部署</h3>
<p><strong>注册中心集群：</strong></p>
<ul>
<li>Zookeeper至少3个节点（奇数个）</li>
<li>Nacos集群模式部署</li>
</ul>
<p><strong>服务部署：</strong></p>
<ul>
<li>Provider至少部署2个实例</li>
<li>使用Docker容器化部署</li>
</ul>
<p><strong>数据库：</strong></p>
<ul>
<li>MySQL主从复制</li>
<li>Redis Cluster集群</li>
</ul>
<h3 data-id="heading-32">8.3 配置中心</h3>
<p>生产环境建议引入配置中心（如Nacos、Apollo）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 从配置中心读取</span>
<span class="hljs-attr">dubbo:</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">${dubbo.registry.address:zookeeper://127.0.0.1:2181}</span>
  <span class="hljs-attr">protocol:</span>
    <span class="hljs-attr">port:</span> <span class="hljs-string">${dubbo.protocol.port:20880}</span>
</code></pre>
<h2 data-id="heading-33">九、高级特性</h2>
<h3 data-id="heading-34">9.1 异步调用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@DubboReference</span>(<span class="hljs-keyword">async</span> = <span class="hljs-literal">true</span>)
<span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

<span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getUserAsync</span>(<span class="hljs-params">Long id</span>) {
    <span class="hljs-keyword">return</span> userService.<span class="hljs-title function_">getUserById</span>(id);
}
</code></pre>
<h3 data-id="heading-35">9.2 泛化调用</h3>
<p>无需依赖接口JAR包即可调用：</p>
<pre><code class="hljs language-ini" lang="ini">GenericService <span class="hljs-attr">genericService</span> = (GenericService) context.getBean(<span class="hljs-string">"genericService"</span>)<span class="hljs-comment">;</span>

Object <span class="hljs-attr">result</span> = genericService.<span class="hljs-variable">$invoke</span>(
    "getUserById",
    new String<span class="hljs-section">[]</span>{"java.lang.Long"},
    new Object<span class="hljs-section">[]</span>{1L}
)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-36">9.3 服务降级</h3>
<p>通过Mock实现服务降级：</p>
<pre><code class="hljs language-ini" lang="ini">@DubboReference(<span class="hljs-attr">mock</span> = <span class="hljs-string">"com.dubbo.demo.mock.UserServiceMock"</span>)
private UserService userService<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-37">9.4 结果缓存</h3>
<pre><code class="hljs language-ini" lang="ini">@DubboReference(<span class="hljs-attr">cache</span> = <span class="hljs-string">"lru"</span>)
private UserService userService<span class="hljs-comment">;</span>
</code></pre>
<p><strong>缓存策略：</strong></p>
<ul>
<li><code>lru</code>：最近最少使用</li>
<li><code>threadlocal</code>：线程缓存</li>
<li><code>jcache</code>：与JSR107集成</li>
</ul>
<h2 data-id="heading-38">十、监控与运维</h2>
<h3 data-id="heading-39">10.1 Dubbo Admin</h3>
<p>Dubbo Admin是官方提供的管理控制台：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载并启动</span>
git <span class="hljs-built_in">clone</span> https://github.com/apache/dubbo-admin
mvn clean package
java -jar dubbo-admin-server/target/dubbo-admin-server-0.1.0.jar
</code></pre>
<p><strong>功能特性：</strong></p>
<ul>
<li>服务查询</li>
<li>服务详情</li>
<li>路由规则配置</li>
<li>动态配置</li>
<li>服务测试</li>
</ul>
<h3 data-id="heading-40">10.2 日志监控</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;logger <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.dubbo"</span> level=<span class="hljs-string">"INFO"</span>/&gt;
&lt;logger <span class="hljs-attr">name</span>=<span class="hljs-string">"com.dubbo.demo"</span> level=<span class="hljs-string">"DEBUG"</span>/&gt;
</code></pre>
<h3 data-id="heading-41">10.3 链路追踪</h3>
<p>集成SkyWalking实现分布式追踪：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.skywalking<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>apm-toolkit-trace<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.16.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-42">十一、总结</h2>
<p>Dubbo作为成熟的RPC框架，在企业级微服务架构中发挥着重要作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高并发与分布式系统中的幂等处理]]></title>    <link>https://juejin.cn/post/7593139476840448006</link>    <guid>https://juejin.cn/post/7593139476840448006</guid>    <pubDate>2026-01-09T09:26:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476840448006" data-draft-id="7593139476840185862" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高并发与分布式系统中的幂等处理"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-09T09:26:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高并发与分布式系统中的幂等处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T09:26:34.000Z" title="Fri Jan 09 2026 09:26:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><h2 data-id="heading-0">一、为什么高并发系统一定会“被幂等教育”？</h2>
<p>先说一句可能不太好听的大实话：</p>
<blockquote>
<p><strong>绝大多数高并发事故，不是代码写错，而是请求被执行了不止一次。</strong></p>
</blockquote>
<p>很多新手工程师在本地测试时，接口逻辑跑得顺风顺水，但一上生产环境，就容易栽在“重复请求”这个坑里。不是代码逻辑有问题，而是真实的线上环境，根本不存在“请求只来一次”的理想状态。</p>
<p>你一定会遇到这些无法避免的场景：</p>
<ul>
<li>
<p><strong>网络抖动</strong>：客户端发完请求后，因网络延迟没及时收到响应，误以为请求失败</p>
</li>
<li>
<p><strong>客户端重试</strong>：前端按钮重复点击、APP 离线重连后重试、第三方调用方配置了自动重试</p>
</li>
<li>
<p><strong>网关重发</strong>：API 网关因超时等原因，主动重发请求到后端服务</p>
</li>
<li>
<p><strong>MQ 至少一次投递</strong>：为保证消息不丢失，Kafka、RocketMQ 等消息中间件默认都是“至少一次”投递策略，消息必然可能重复</p>
</li>
</ul>
<p>用一段真实的交互场景，就能明白这种无奈：</p>
<pre><code class="hljs language-text" lang="text">客户端：我刚刚是不是没成功？（因网络延迟没收到响应）
系统：成功了。（其实已经处理完并返回，但响应丢了）
客户端：那我再来一次。（触发重试机制）
系统：？？？（我到底该再处理一次还是直接返回？）
</code></pre>
<p>结论先行，记死这句话：</p>
<blockquote>
<p><strong>在高并发 + 分布式系统中，请求“只来一次”是奢望，“重复请求”才是常态。</strong></p>
</blockquote>
<p>这就是为什么所有成熟的高并发系统，都必须过“幂等”这一关——不是你想做，而是环境逼着你必须做。</p>
<hr/>
<h2 data-id="heading-1">二、什么是幂等？（工程师版本，拒绝废话）</h2>
<p>别去背教科书上的抽象定义，记住这一句人话就够了：</p>
<blockquote>
<p><strong>同一个请求，不管来多少次，系统最终的状态和结果都完全一样。</strong></p>
</blockquote>
<p>举个简单的例子：查询接口（GET /api/order?orderNo=123）天生就是幂等的，不管你调用1次还是100次，返回的都是同一个订单信息；但下单接口（POST /api/order/create）如果不做处理，调用2次就会生成2个订单，这就是非幂等的。</p>
<h3 data-id="heading-2">不做幂等，会发生什么？（真实事故案例）</h3>
<p>很多人觉得“幂等是高级优化”，直到踩了坑才明白这是“基础必备”。非幂等接口在高并发下，必然会出现这些致命问题：</p>
<ul>
<li>
<p><strong>重复下单</strong>：用户点击“提交订单”后因网络卡顿时重复点击，生成多笔订单，导致库存被多扣、用户收到多个发货通知</p>
</li>
<li>
<p><strong>重复扣款</strong>：支付接口重试导致用户账户被多次扣款，直接引发用户投诉，甚至监管介入</p>
</li>
<li>
<p><strong>MQ 重复消费</strong>：消息重复投递后被重复处理，导致库存扣为负数、优惠券被重复核销</p>
</li>
<li>
<p><strong>重复退款</strong>：退款接口被重试，用户收到多笔退款，企业直接产生资金损失</p>
</li>
</ul>
<p>这里有个判断标准，记下来直接用：</p>
<blockquote>
<p><strong>只要“同一个请求多执行一次会出事”，这个接口就必须做幂等处理。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、哪些场景是幂等“重灾区”？（优先处理这些）</h2>
<p>不是所有接口都需要做幂等，我们要把精力放在高风险场景上。直接列重点，这些场景必须优先保证幂等：</p>
<ul>
<li>
<p><strong>交易相关接口</strong>：下单、支付、退款、转账——核心是涉及资金变动，一旦重复必然出问题</p>
</li>
<li>
<p><strong>创建型接口（POST）</strong>：POST 接口的语义是“创建资源”，重复调用会生成多个资源，而 GET 接口是“查询资源”，天生幂等（这里要注意：RESTful 规范中，POST 是非幂等的，PUT 是幂等的，设计接口时要遵循这个语义）</p>
</li>
<li>
<p><strong>MQ 消费逻辑</strong>：如前所述，MQ 默认“至少一次”投递，消费端必须能处理重复消息</p>
</li>
<li>
<p><strong>分布式事务场景</strong>：Saga 模式的补偿接口、TCC 模式的 Confirm/Cancel 接口，都可能因重试触发重复执行</p>
</li>
<li>
<p><strong>对外提供的接口</strong>：给合作方、第三方调用的接口，无法控制对方的重试策略，必须自己兜底幂等</p>
</li>
<li>
<p><strong>用户高频操作接口</strong>：如优惠券领取、活动报名、秒杀下单——用户可能因操作失误或网络问题重复触发</p>
</li>
</ul>
<p>用一句扎心的话总结：</p>
<blockquote>
<p><strong>你不主动做幂等，流量会帮你做事故。</strong></p>
</blockquote>
<p>很多团队的线上故障复盘，最后结论都是“某个接口未做幂等，导致高并发下重复执行”。与其事后救火，不如事前预防。</p>
<hr/>
<h2 data-id="heading-4">四、幂等的本质是什么？（看透问题核心）</h2>
<p>很多人在设计幂等方案时会陷入“各种技巧的堆砌”，其实只要抓住本质，所有方案都能看懂。</p>
<p>所有幂等方案，本质上都在解决同一个核心问题：</p>
<blockquote>
<p><strong>“我怎么判断这个请求是不是已经处理过了？”</strong></p>
</blockquote>
<p>只要能准确回答这个问题，幂等就解决了一半。从工程实践的角度看，解决这个问题无非三种核心思路：</p>
<ul>
<li>
<p><strong>给请求加“唯一标识”</strong>：通过一个全局唯一的 ID 标记请求，系统处理前先检查这个 ID 是否已经处理过——这是最常用的思路</p>
</li>
<li>
<p><strong>让状态“不可逆”</strong>：通过状态机约束，让业务状态只能从“未处理”向“已处理”流转，无法回退，从而避免重复处理——比如订单状态从“待支付”到“已支付”，再收到支付请求时就无法再次变更</p>
</li>
<li>
<p><strong>记录“去重日志”</strong>：专门维护一个去重表或缓存，记录已经处理过的请求，处理新请求时先查去重记录——本质是“唯一标识”思路的延伸</p>
</li>
</ul>
<p>理解了这三种思路，下面的实战方案就很容易看懂了——所有方案都是这三种思路的具体落地。</p>
<hr/>
<h2 data-id="heading-5">五、4 种主流幂等方案（Java 实战，附代码+注意事项）</h2>
<p>下面介绍的 4 种方案，覆盖了 90% 以上的业务场景。从“稳定性”“实现成本”“适用场景”三个维度对比，大家可以根据自己的业务选择。</p>
<h3 data-id="heading-6">1️⃣ 唯一业务 ID + 唯一索引（最稳、最推荐）⭐</h3>
<p>这是工业界最常用、最可靠的方案，核心是“用业务唯一 ID 标记请求，用数据库唯一索引兜底”，从根源上防止重复数据插入。</p>
<h4 data-id="heading-7">核心思路</h4>
<ol>
<li>
<p>客户端发起请求时，携带一个全局唯一的业务 ID（比如订单号 orderNo、业务流水号 bizId）——这个 ID 可以由客户端生成，也可以由服务端生成后返回给客户端</p>
</li>
<li>
<p>服务端处理请求时，将这个唯一业务 ID 存入业务表（比如订单表）</p>
</li>
<li>
<p>在业务表上给这个唯一业务 ID 加“唯一索引”，利用数据库的约束机制，防止重复插入数据</p>
</li>
<li>
<p>当重复请求到来时，数据库会抛出唯一约束冲突异常，服务端捕获异常后，直接返回“处理成功”（因为第一次请求已经处理完成）</p>
</li>
</ol>
<h4 data-id="heading-8">实战代码（Java + MySQL）</h4>
<p>第一步：给业务表加唯一索引（以订单表为例）</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 订单表：order_no 是全局唯一的业务 ID</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号（全局唯一）'</span>,
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> KEY uk_order_no(order_no); <span class="hljs-comment">-- 唯一索引兜底</span>
</code></pre>
<p>第二步：Java 代码处理逻辑（结合 MyBatis）</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 下单接口（幂等版）
 * <span class="hljs-doctag">@param</span> createOrderDTO 下单请求DTO，包含唯一订单号 orderNo
 */</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> OrderVO <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderDTO createOrderDTO)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> createOrderDTO.getOrderNo();
    <span class="hljs-keyword">if</span> (StringUtils.isBlank(orderNo)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"订单号不能为空"</span>);
    }

    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
    order.setOrderNo(orderNo);
    order.setUserId(createOrderDTO.getUserId());
    order.setProductId(createOrderDTO.getProductId());
    order.setStatus(<span class="hljs-string">"CREATED"</span>); <span class="hljs-comment">// 初始状态：待支付</span>

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试插入订单</span>
        orderMapper.insert(order);
        <span class="hljs-comment">// 后续业务逻辑：扣减库存、锁定优惠券等</span>
        deductStock(createOrderDTO.getProductId(), createOrderDTO.getQuantity());
        lockCoupon(createOrderDTO.getUserId(), createOrderDTO.getCouponId());
        <span class="hljs-comment">// 返回成功结果</span>
        <span class="hljs-type">OrderVO</span> <span class="hljs-variable">orderVO</span> <span class="hljs-operator">=</span> convertToVO(order);
        <span class="hljs-keyword">return</span> orderVO;
    } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
        <span class="hljs-comment">// 捕获唯一索引冲突异常，说明是重复请求</span>
        log.info(<span class="hljs-string">"重复下单，订单号：{}"</span>, orderNo, e);
        <span class="hljs-comment">// 直接查询已存在的订单，返回成功结果</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
        <span class="hljs-keyword">return</span> convertToVO(existOrder);
    }
}
</code></pre>
<h4 data-id="heading-9">优点 &amp; 注意事项</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>实现简单，开发成本低</p>
</li>
<li>
<p>稳定性高，数据库唯一索引是“物理兜底”，不会出现漏判的情况</p>
</li>
<li>
<p>强一致性，能保证业务数据的准确性</p>
</li>
</ul>
<p>⚠️ 注意事项（关键！）：</p>
<blockquote>
<p><strong>唯一索引是最后一道防线，而不是第一道。</strong></p>
</blockquote>
<p>很多人会犯一个错误：每次请求都直接往数据库插数据，靠唯一索引挡重复请求。这样会导致数据库频繁抛出异常，增加数据库压力。</p>
<p>优化建议：在插入数据库之前，先查缓存（比如 Redis）判断订单号是否已存在——缓存命中则直接返回，未命中再执行插入逻辑。这样能减少数据库的异常抛出次数，提升性能。优化后的代码片段：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 优化：先查缓存，减少数据库压力</span>
<span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:idempotent:"</span> + orderNo;
<span class="hljs-type">Boolean</span> <span class="hljs-variable">isExist</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
<span class="hljs-keyword">if</span> (Boolean.TRUE.equals(isExist)) {
    <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    <span class="hljs-keyword">return</span> convertToVO(existOrder);
}

<span class="hljs-keyword">try</span> {
    orderMapper.insert(order);
    <span class="hljs-comment">// 插入成功后，往缓存放一份，过期时间设置为业务合理时间（比如30分钟）</span>
    redisTemplate.opsForValue().set(redisKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">30</span>, TimeUnit.MINUTES);
    <span class="hljs-comment">// 后续业务逻辑...</span>
} <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
    <span class="hljs-comment">// 重复请求处理...</span>
}
</code></pre>
<h3 data-id="heading-10">2️⃣ 状态机 + 乐观锁（订单系统标配）</h3>
<p>这个方案主要适用于“有明确状态流转”的业务场景，比如订单、支付、退款。核心是“通过状态机约束业务状态的流转，并用乐观锁保证并发安全”，避免重复处理。</p>
<h4 data-id="heading-11">核心思路</h4>
<ol>
<li>
<p>给业务实体定义清晰的状态机，比如订单状态：待支付（CREATED）→ 已支付（PAID）→ 已发货（SHIPPED）→ 已完成（COMPLETED）</p>
</li>
<li>
<p>状态只能“向前流转”，不能“向后流转”（比如已支付的订单，不能再回到待支付状态）</p>
</li>
<li>
<p>更新状态时，通过“乐观锁”（比如版本号 version 或状态字段本身）做条件判断，只有条件满足时才更新成功</p>
</li>
</ol>
<p>一句话理解：重复请求到来时，因为状态已经流转到下一个阶段，更新条件不满足，所以不会重复处理。</p>
<h4 data-id="heading-12">实战代码（Java + MySQL）</h4>
<p>第一步：订单表增加状态字段和版本号字段（乐观锁）</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单状态：CREATED-待支付，PAID-已支付，SHIPPED-已发货，COMPLETED-已完成'</span>,
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> version <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'版本号（乐观锁）'</span>;
</code></pre>
<p>第二步：更新状态的 SQL（以“订单支付”为例）</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 方式1：用状态作为条件（简单场景）</span>
<span class="hljs-keyword">UPDATE</span> orders 
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>, pay_time <span class="hljs-operator">=</span> NOW()
<span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'CREATED'</span>; <span class="hljs-comment">-- 只有状态是“待支付”时才能更新</span>

<span class="hljs-comment">-- 方式2：用版本号作为条件（并发更高的场景）</span>
<span class="hljs-keyword">UPDATE</span> orders 
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>, pay_time <span class="hljs-operator">=</span> NOW(), version <span class="hljs-operator">=</span> version <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> version <span class="hljs-operator">=</span> ?;
</code></pre>
<p>第三步：Java 代码处理逻辑</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 订单支付接口（幂等版）
 * <span class="hljs-doctag">@param</span> payDTO 支付请求DTO，包含订单号、支付金额等
 */</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">payOrder</span><span class="hljs-params">(PayDTO payDTO)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> payDTO.getOrderNo();
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(orderNo);
    <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"订单不存在"</span>);
    }

    <span class="hljs-comment">// 方式1：用状态作为条件更新</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">updateCount</span> <span class="hljs-operator">=</span> orderMapper.updateOrderStatusToPaid(orderNo, <span class="hljs-string">"CREATED"</span>);
    <span class="hljs-keyword">if</span> (updateCount == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 更新失败，说明订单已支付或状态异常（重复请求）</span>
        log.info(<span class="hljs-string">"订单已支付或状态异常，订单号：{}"</span>, orderNo);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 重复请求，返回成功</span>
    }

    <span class="hljs-comment">// 方式2：用版本号作为条件更新（推荐高并发场景）</span>
    <span class="hljs-comment">// int updateCount = orderMapper.updateOrderStatusToPaidWithVersion(orderNo, order.getVersion());</span>
    <span class="hljs-comment">// if (updateCount == 0) {</span>
    <span class="hljs-comment">//     log.info("订单已支付或状态异常，订单号：{}", orderNo);</span>
    <span class="hljs-comment">//     return true;</span>
    <span class="hljs-comment">// }</span>

    <span class="hljs-comment">// 后续业务逻辑：扣减用户余额、记录支付日志等</span>
    deductUserBalance(payDTO.getUserId(), payDTO.getAmount());
    recordPayLog(payDTO);

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-13">优点 &amp; 适用场景</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>贴合业务场景，状态机本身就是业务逻辑的一部分，不需要额外引入过多概念</p>
</li>
<li>
<p>并发性能好，乐观锁不会阻塞线程，适合高并发场景</p>
</li>
<li>
<p>能防止“状态乱序”问题（比如同时收到“支付”和“取消”请求，保证只有一个能执行）</p>
</li>
</ul>
<p>📌 适用场景：</p>
<ul>
<li>
<p>订单状态流转（支付、发货、取消）</p>
</li>
<li>
<p>退款流程（申请退款 → 退款中 → 退款成功/失败）</p>
</li>
<li>
<p>任何有明确状态流转的业务实体</p>
</li>
</ul>
<p>核心原则：</p>
<blockquote>
<p><strong>状态只往前走，本身就是幂等。</strong></p>
</blockquote>
<h3 data-id="heading-14">3️⃣ Token / Redis 去重（防重复提交首选）</h3>
<p>这个方案主要用于“用户交互型接口”，比如表单提交、按钮点击、秒杀下单。核心是“在请求执行前，先获取一个唯一 Token，执行时校验 Token 有效性”，从而防止重复提交。</p>
<h4 data-id="heading-15">核心流程</h4>
<ol>
<li>
<p>客户端先向服务端请求“获取 Token”（比如用户进入下单页面时，前端调用接口获取 Token）</p>
</li>
<li>
<p>服务端生成一个全局唯一的 Token（比如用 UUID），存入 Redis（设置过期时间），然后返回给客户端</p>
</li>
<li>
<p>客户端发起业务请求时，将 Token 放在请求头或请求参数中一起提交</p>
</li>
<li>
<p>服务端收到请求后，先校验 Token：如果 Redis 中存在该 Token，则删除 Token 并执行后续业务逻辑；如果不存在，则说明是重复请求，直接返回错误</p>
</li>
</ol>
<p>流程示意图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
sequenceDiagram
    Client-&gt;&gt;Server: 进入下单页面，请求获取Token
    Server-&gt;&gt;Server: 生成UUID作为Token，存入Redis（设置过期时间）
    Server-&gt;&gt;Client: 返回Token
    Client-&gt;&gt;Server: 提交订单（携带Token）
    Server-&gt;&gt;Server: 校验Redis中是否存在该Token，存在则删除
    Server-&gt;&gt;Server: 执行下单逻辑
    Server-&gt;&gt;Client: 返回下单结果
    Client-&gt;&gt;Server: 重复提交订单（携带相同Token）
    Server-&gt;&gt;Server: 校验Redis中已无该Token
    Server-&gt;&gt;Client: 返回“重复提交”错误
</code></pre>
<h4 data-id="heading-16">实战代码（Java + Redis）</h4>
<p>第一步：获取 Token 接口</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 获取防重复提交Token
 */</span>
<span class="hljs-meta">@GetMapping("/api/idempotent/token")</span>
<span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">getIdempotentToken</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 生成唯一Token（UUID）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
    <span class="hljs-comment">// 存入Redis，设置过期时间5分钟（根据业务调整，比如表单提交设置10分钟）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"idempotent:token:"</span> + token;
    redisTemplate.opsForValue().set(redisKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
    <span class="hljs-keyword">return</span> Result.success(token);
}
</code></pre>
<p>第二步：业务接口（结合 Spring AOP 实现更优雅）</p>
<p>先定义一个自定义注解，用于标记需要防重复提交的接口：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 防重复提交注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Idempotent {
    <span class="hljs-comment">// Token参数的名称（默认从请求头获取）</span>
    String <span class="hljs-title function_">tokenName</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"Idempotent-Token"</span>;
}

<span class="hljs-comment">// AOP切面实现</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;

    <span class="hljs-meta">@Around("@annotation(idempotent)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, Idempotent idempotent)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 1. 获取请求中的Token</span>
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(idempotent.tokenName());
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(token)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"Token不能为空"</span>);
        }

        <span class="hljs-comment">// 2. 校验Token是否存在于Redis</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"idempotent:token:"</span> + token;
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isExist</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(isExist)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"重复提交，请稍后再试"</span>);
        }

        <span class="hljs-comment">// 3. 原子性删除Token（防止并发问题）</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">deleteSuccess</span> <span class="hljs-operator">=</span> redisTemplate.delete(redisKey);
        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(deleteSuccess)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"重复提交，请稍后再试"</span>);
        }

        <span class="hljs-comment">// 4. 执行原业务逻辑</span>
        <span class="hljs-keyword">return</span> joinPoint.proceed();
    }
}
</code></pre>
<p>第三步：使用注解标记业务接口</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * 表单提交接口（防重复提交）
 */</span>
<span class="hljs-meta">@PostMapping("/api/form/submit")</span>
<span class="hljs-meta">@Idempotent(tokenName = "Idempotent-Token")</span>
<span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">submitForm</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> FormDTO formDTO)</span> {
    <span class="hljs-comment">// 执行表单提交逻辑</span>
    formService.submit(formDTO);
    <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"提交成功"</span>);
}
</code></pre>
<h4 data-id="heading-17">优点 &amp; 注意事项</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>实现优雅，通过 AOP 可以全局复用，开发成本低</p>
</li>
<li>
<p>性能好，基于 Redis 操作，响应速度快</p>
</li>
<li>
<p>适合前端交互场景，能有效防止用户重复点击</p>
</li>
</ul>
<p>⚠️ 注意事项：</p>
<ul>
<li>
<p>不适合核心交易链路：Redis 是缓存，存在宕机或数据丢失的风险，无法像数据库那样提供强一致性保证</p>
</li>
<li>
<p>Token 过期时间要合理：太短会导致正常请求失败，太长会占用 Redis 资源</p>
</li>
<li>
<p>必须保证“删除 Token”是原子操作：如果用“先查后删”的方式，会出现并发问题（两个请求同时查到 Token 存在，然后都执行删除，导致重复处理）</p>
</li>
</ul>
<p>核心结论：这个方案适合“非核心链路的防重复提交”，比如表单提交、评论发布、活动报名等；核心交易链路（下单、支付）不推荐单独使用，建议结合方案一（唯一索引）兜底。</p>
<h3 data-id="heading-18">4️⃣ MQ 消费幂等（面试必考，必须掌握）</h3>
<p>MQ 消费的幂等是高并发系统中的高频问题，因为所有 MQ 中间件都无法保证“恰好一次”投递（除非用事务消息，但复杂度高），默认都是“至少一次”投递。所以，消费端必须自己处理重复消息。</p>
<h4 data-id="heading-19">核心思路</h4>
<p>MQ 消息本身会携带一个全局唯一的消息 ID（比如 RocketMQ 的 msgId、Kafka 的 offset + partition），我们可以利用这个消息 ID 做去重；如果消息 ID 不可靠（比如有些 MQ 会重复生成 msgId），则可以用业务唯一 ID（比如订单号）做去重。</p>
<p>核心流程：</p>
<ol>
<li>
<p>消费消息前，先检查该消息的 ID（msgId 或 bizId）是否已经处理过</p>
</li>
<li>
<p>如果已经处理过，则直接返回成功，不执行后续逻辑</p>
</li>
<li>
<p>如果未处理过，则执行消费逻辑，执行完成后，记录该消息 ID 已处理</p>
</li>
</ol>
<p>一句话点破：</p>
<blockquote>
<p><strong>MQ 一定会重复，业务必须能扛住。</strong></p>
</blockquote>
<h4 data-id="heading-20">实战代码（Java + RocketMQ）</h4>
<p>这里提供两种实现方式：基于 Redis 去重（适合非核心消息）和基于数据库去重表（适合核心消息）。</p>
<p>方式一：基于 Redis 去重（简单场景）</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * MQ 消费者（基于Redis去重）
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = "order_topic", consumerGroup = "order_consumer_group")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;MessageExt&gt; {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(MessageExt messageExt)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> messageExt.getMsgId(); <span class="hljs-comment">// MQ自带的唯一消息ID</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(messageExt.getBody(), StandardCharsets.UTF_8);
        <span class="hljs-type">OrderMessage</span> <span class="hljs-variable">orderMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(body, OrderMessage.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">bizId</span> <span class="hljs-operator">=</span> orderMessage.getOrderNo(); <span class="hljs-comment">// 业务唯一ID（订单号）</span>

        <span class="hljs-comment">// 1. 先查Redis，判断是否已处理（用bizId更可靠，msgId可能重复）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mq:idempotent:order:"</span> + bizId;
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">isProcessed</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
        <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(isProcessed)) {
            log.info(<span class="hljs-string">"消息已处理，msgId：{}，bizId：{}"</span>, msgId, bizId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 执行消费逻辑（比如更新订单状态）</span>
            orderService.processOrderMessage(orderMessage);

            <span class="hljs-comment">// 3. 标记为已处理（存入Redis，设置过期时间，比如24小时）</span>
            redisTemplate.opsForValue().set(redisKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">24</span>, TimeUnit.HOURS);
            log.info(<span class="hljs-string">"消息处理成功，msgId：{}，bizId：{}"</span>, msgId, bizId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"消息处理失败，msgId：{}，bizId：{}"</span>, msgId, bizId, e);
            <span class="hljs-comment">// 抛出异常，让MQ重试（根据业务调整重试策略）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"消息处理失败，触发重试"</span>, e);
        }
    }
}
</code></pre>
<p>方式二：基于数据库去重表（核心消息，强一致）</p>
<p>第一步：创建 MQ 消息去重表</p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> mq_message_idempotent (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY COMMENT <span class="hljs-string">'主键ID'</span>,
    msg_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'MQ消息ID'</span>,
    biz_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'业务唯一ID'</span>,
    status TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'处理状态：0-未处理，1-已处理'</span>,
    create_time DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
    update_time DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY uk_biz_id (biz_id) COMMENT <span class="hljs-string">'业务ID唯一约束'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'MQ消息幂等表'</span>;
</code></pre>
<p>第二步：消费逻辑代码</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">/**
 * MQ 消费者（基于数据库去重表）
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = "payment_topic", consumerGroup = "payment_consumer_group")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;MessageExt&gt; {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MqMessageIdempotentMapper idempotentMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PaymentService paymentService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(MessageExt messageExt)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> messageExt.getMsgId();
        <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(messageExt.getBody(), StandardCharsets.UTF_8);
        <span class="hljs-type">PaymentMessage</span> <span class="hljs-variable">paymentMessage</span> <span class="hljs-operator">=</span> JSON.parseObject(body, PaymentMessage.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">bizId</span> <span class="hljs-operator">=</span> paymentMessage.getPayNo(); <span class="hljs-comment">// 支付流水号（业务唯一ID）</span>

        <span class="hljs-comment">// 1. 尝试插入去重表（唯一约束兜底）</span>
        <span class="hljs-type">MqMessageIdempotent</span> <span class="hljs-variable">idempotent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MqMessageIdempotent</span>();
        idempotent.setMsgId(msgId);
        idempotent.setBizId(bizId);
        idempotent.setStatus(<span class="hljs-number">0</span>); <span class="hljs-comment">// 未处理</span>

        <span class="hljs-keyword">try</span> {
            idempotentMapper.insert(idempotent);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 重复消息，查询处理状态</span>
            <span class="hljs-type">MqMessageIdempotent</span> <span class="hljs-variable">exist</span> <span class="hljs-operator">=</span> idempotentMapper.selectByBizId(bizId);
            <span class="hljs-keyword">if</span> (exist.getStatus() == <span class="hljs-number">1</span>) {
                log.info(<span class="hljs-string">"消息已处理，msgId：{}，bizId：{}"</span>, msgId, bizId);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 消息正在处理中，抛出异常让MQ重试（或根据业务处理）</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"消息处理中，请稍后重试"</span>);
            }
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 执行消费逻辑（比如处理支付结果）</span>
            paymentService.processPaymentResult(paymentMessage);

            <span class="hljs-comment">// 3. 更新去重表状态为“已处理”</span>
            idempotentMapper.updateStatusByBizId(bizId, <span class="hljs-number">1</span>);
            log.info(<span class="hljs-string">"消息处理成功，msgId：{}，bizId：{}"</span>, msgId, bizId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"消息处理失败，msgId：{}，bizId：{}"</span>, msgId, bizId, e);
            <span class="hljs-comment">// 可以更新状态为“处理失败”，后续人工介入</span>
            idempotentMapper.updateStatusByBizId(bizId, <span class="hljs-number">2</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"消息处理失败，触发重试"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-21">优点 &amp; 适用场景</h4>
<p>✅ 优点：</p>
<ul>
<li>
<p>可靠性高，尤其是基于数据库去重表的方式，能保证强一致性</p>
</li>
<li>
<p>适配所有 MQ 场景，通用性强</p>
</li>
</ul>
<p>📌 适用场景：</p>
<ul>
<li>
<p>基于 Redis ：非核心消息，比如日志同步、通知推送、数据统计</p>
</li>
<li>
<p>基于数据库：核心消息，比如订单支付结果通知、库存变更消息、退款消息</p>
</li>
</ul>
<p>面试小贴士：被问到“MQ 消费如何保证幂等”时，要先说明“MQ 无法避免重复投递”，然后分场景给出方案，最后强调“核心消息必须用数据库去重表兜底”，这样回答才够全面。</p>
<hr/>
<h2 data-id="heading-22">六、3 个最容易踩的幂等大坑（避坑指南）</h2>
<p>很多人做了幂等处理，但还是出了问题，原因是踩了一些“隐性坑”。下面这 3 个坑，一定要避开：</p>
<h3 data-id="heading-23">❌ 1. 先查再插/先查再更（高并发下必炸）</h3>
<p>这是最常见的错误做法：处理请求时，先查询数据库“这个请求是否已处理”，如果没处理再执行插入/更新操作。代码示例：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 错误代码：先查再插</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderDTO dto)</span> {
    <span class="hljs-comment">// 先查询订单是否存在</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByOrderNo(dto.getOrderNo());
    <span class="hljs-keyword">if</span> (existOrder != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// 插入订单</span>
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
    order.setOrderNo(dto.getOrderNo());
    orderMapper.insert(order);
}
</code></pre>
<p>问题出在“查询”和“插入”之间存在“时间窗口”：高并发下，两个相同的请求可能同时查询到“订单不存在”，然后同时插入订单，导致唯一索引冲突，或者直接生成两个订单（如果没加唯一索引）。</p>
<p>正确做法：</p>
<blockquote>
<p><strong>直接插/直接更，交给唯一约束或乐观锁兜底。</strong></p>
</blockquote>
<p>比如方案一中的“直接插入，捕获唯一索引冲突”，方案二中的“直接更新，判断影响行数”——用数据库的原子操作代替“先查后写”，避免并发问题。</p>
<h3 data-id="heading-24">❌ 2. 幂等逻辑不在事务里（数据灵异）</h3>
<p>这个坑的场景：标记“请求已处理”的操作，和核心业务逻辑不在同一个事务里。比如：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 错误代码：幂等标记不在事务中</span>
<span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(OrderMessage message)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">bizId</span> <span class="hljs-operator">=</span> message.getOrderNo();
    <span class="hljs-comment">// 1. 执行核心业务逻辑（更新订单状态）</span>
    orderMapper.updateStatus(bizId, <span class="hljs-string">"PAID"</span>);
    <span class="hljs-comment">// 2. 标记为已处理（存入Redis，不在事务中）</span>
    redisTemplate.opsForValue().set(<span class="hljs-string">"order:processed:"</span> + bizId, <span class="hljs-string">"1"</span>, <span class="hljs-number">24</span>, TimeUnit.HOURS);
}
</code></pre>
<p>问题：如果步骤 1 执行成功，但步骤 2 执行失败（比如 Redis 宕机），此时事务会回滚吗？不会！因为步骤 2 是 Redis 操作，不在数据库事务的管辖范围内。最终结果是：订单状态已经更新为“已支付”，但 Redis 中没有标记“已处理”——当下次重复消息到来时，会再次执行步骤 1，导致订单状态被重复更新（虽然状态机可能阻止，但如果是其他业务可能出问题）。</p>
<p>更严重的情况：如果步骤 2 先执行（标记已处理），步骤 1 执行失败（事务回滚），会导致“标记已处理，但业务没执行”——后续请求都会被当成重复请求，直接返回，导致业务丢失。</p>
<p>正确做法：</p>
<ul>
<li>
<p>如果用数据库去重（比如方案一、方案四的数据库去重表），一定要把“标记已处理”和核心业务逻辑放在同一个事务里——用数据库事务保证两者的原子性</p>
</li>
<li>
<p>如果用 Redis 去重，要采用“先执行业务，再标记已处理”的顺序，并且接受“极端情况下可能重复处理”的风险（因为 Redis 不支持事务回滚）；如果是核心业务，建议用数据库去重表兜底</p>
</li>
</ul>
<h3 data-id="heading-25">❌ 3. 幂等 = 吞异常（掩盖问题）</h3>
<p>这个坑的错误认知：“只要是重复请求，不管什么情况都返回成功”——把幂等当成了“吞异常”的遮羞布。比如：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 错误代码：幂等 = 吞异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderDTO dto)</span> {
    <span class="hljs-keyword">try</span> {
        orderMapper.insert(dto);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 不管什么异常，都当成重复请求返回成功</span>
        log.error(<span class="hljs-string">"创建订单失败"</span>, e);
        <span class="hljs-keyword">return</span>;
    }
}
</code></pre>
<p>问题：如果是真正的业务异常（比如库存不足、参数错误），也会被当成重复请求，直接返回成功——用户以为订单创建成功，但实际上并没有，导致用户投诉；同时，开发人员无法及时发现业务问题，因为异常被吞掉了。</p>
<p>正确做法：</p>
<blockquote>
<p><strong>幂等只处理“重复请求”的异常，不处理“业务逻辑”的异常。</strong></p>
</blockquote>
<p>比如方案一中，只捕获“DuplicateKeyException”（唯一索引冲突，代表重复请求），其他异常（比如库存不足的 BizException）要正常抛出，让上层处理（比如返回错误信息给用户）。</p>
<p>核心原则：幂等是“保证重复请求的结果一致”，而不是“掩盖所有异常”。</p>
<hr/>
<h2 data-id="heading-26">七、幂等与分布式事务（相辅相成）</h2>
<p>很多人会把“幂等”和“分布式事务”分开看，但实际上，两者是相辅相成的——没有幂等，分布式事务就跑不起来。</p>
<p>为什么？因为分布式事务的核心是“跨服务的协调”，而协调过程中必然会出现重试（比如 Saga 模式的补偿重试、TCC 模式的 Confirm/Cancel 重试）。如果这些重试的接口没有做幂等，就会导致重复处理，引发数据不一致。</p>
<p>下面是常见分布式事务场景中，幂等的作用：</p>





















<table><thead><tr><th>分布式事务场景</th><th>幂等的作用</th></tr></thead><tbody><tr><td>Saga 模式</td><td>Saga 分为“正向流程”和“补偿流程”，当正向流程某一步失败时，会重试补偿流程；如果补偿接口没有做幂等，多次补偿会导致数据错误（比如重复退款）</td></tr><tr><td>TCC 模式</td><td>TCC 的 Confirm（确认）和 Cancel（取消）接口可能因网络问题被重试；如果这些接口没有做幂等，会导致重复扣减/释放资源（比如重复扣库存）</td></tr><tr><td>MQ 事务消息</td><td>事务消息的“提交”或“回滚”可能被重试，消费端也会收到重复消息；幂等能保证重试和重复消息不会导致数据不一致</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p><strong>没有幂等，分布式事务跑不起来；有了幂等，分布式事务才能更稳定。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-27">八、推荐的 Java 技术组合（落地参考）</h2>
<p>结合前面的方案，这里给出一套工业界常用的 Java 技术组合，覆盖大部分业务场景：</p>
<ul>
<li>
<p><strong>核心框架</strong>：Spring Boot / Spring Cloud（成熟稳定，生态完善）</p>
</li>
<li>
<p><strong>数据存储</strong>：MySQL（唯一索引 + 状态机 + 去重表，保证强一致性）</p>
</li>
<li>
<p><strong>缓存</strong>：Redis（Token 防重复提交 + 非核心消息去重，提升性能）</p>
</li>
<li>
<p><strong>消息中间件</strong>：RocketMQ / Kafka（支持事务消息，适配高并发场景）</p>
</li>
<li>
<p><strong>ORM 框架</strong>：MyBatis-Plus（简化数据库操作，支持乐观锁插件）</p>
</li>
</ul>
<p>经验总结，记下来直接用：</p>
<blockquote>
<p><strong>核心链路靠 DB，外围防抖用 Redis。</strong></p>
</blockquote>
<ul>
<li>
<p>核心链路（下单、支付、退款）：用“唯一业务 ID + 唯一索引”兜底，结合“状态机 + 乐观锁”优化并发性能</p>
</li>
<li>
<p>外围链路（表单提交、通知推送、活动报名）：用“Token + Redis”防重复提交，简单高效</p>
</li>
<li>
<p>MQ 消费：核心消息用“数据库去重表”，非核心消息用“Redis 去重”</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-28">九、总结（核心观点再强调）</h2>
<p>最后用几句话总结全文，帮大家梳理核心知识点：</p>
<ol>
<li>
<p>幂等不是高级技巧，而是分布式高并发系统的“入场券”——你可以暂时没遇到幂等问题，但高并发一定会帮你遇到</p>
</li>
<li>
<p>幂等的本质是“判断请求是否已处理”，核心思路是“唯一标识、状态不可逆、去重记录”</p>
</li>
<li>
<p>4 种主流方案各有适用场景：唯一索引最稳，状态机适合订单，Token 适合表单，MQ 去重分核心/非核心</p>
</li>
<li>
<p>避坑重点：别用“先查后写”，幂等逻辑要在事务里，别把幂等当成吞异常的遮羞布</p>
</li>
<li>
<p>技术组合原则：核心链路靠 DB 保证强一致，外围链路用 Redis 提升性能</p>
</li>
</ol>
<p>最后再送大家一句实战感悟：</p>
<blockquote>
<p><strong>做幂等不是为了“解决问题”，而是为了“避免问题”——在高并发的世界里，预防永远比救火更重要。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【深度解析】为什么C++有了malloc，还需要new？]]></title>    <link>https://juejin.cn/post/7592921639464828970</link>    <guid>https://juejin.cn/post/7592921639464828970</guid>    <pubDate>2026-01-09T06:45:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592921639464828970" data-draft-id="7592921639464812586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【深度解析】为什么C++有了malloc，还需要new？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T06:45:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【深度解析】为什么C++有了malloc，还需要new？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T06:45:25.000Z" title="Fri Jan 09 2026 06:45:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6db449a842d4b658d7902b089f9dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768545925&amp;x-signature=Zwt72GxDtpj%2FHARfglaY4bWi4G0%3D" alt="image.png" loading="lazy"/></p>
<p>如果你是C程序员转向C++，一定会有一个疑问：<strong>为什么C++在有了<code>malloc</code>这个成熟的内存分配函数后，还要引入<code>new</code>这个看起来功能相似的操作符？</strong> 这难道不是多此一举吗？</p>
<p>让我用一个生动的比喻开始：<code>malloc</code>就像一个房地产商，他只负责给你一块空地；而<code>new</code>是一个完整的建筑公司，不仅给你土地，还按照你的要求建好房子，完成装修，甚至把家具都摆好。</p>
<h2 data-id="heading-0">第一章：从表面现象看起——一段令人沮丧的代码</h2>
<p>假设我们有一个简单的类：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> {
<span class="hljs-keyword">public</span>:
    string name;
    <span class="hljs-type">int</span> age;
    <span class="hljs-built_in">Student</span>(string n, <span class="hljs-type">int</span> a) : <span class="hljs-built_in">name</span>(n), <span class="hljs-built_in">age</span>(a) {
        cout &lt;&lt; <span class="hljs-string">"创建学生："</span> &lt;&lt; n &lt;&lt; endl;
    }
    ~<span class="hljs-built_in">Student</span>() {
        cout &lt;&lt; <span class="hljs-string">"销毁学生："</span> &lt;&lt; name &lt;&lt; endl;
    }
};
</code></pre>
<h3 data-id="heading-1">第一次尝试：用malloc创建对象</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C程序员会很自然地这样写：</span>
Student* s1 = (Student*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));
s1-&gt;name = <span class="hljs-string">"张三"</span>;  <span class="hljs-comment">// 编译错误！</span>
s1-&gt;age = <span class="hljs-number">20</span>;      <span class="hljs-comment">// 危险的操作！</span>
</code></pre>
<p><strong>问题出现了</strong>：编译器会告诉我们，string对象没有默认构造，不能直接赋值。更糟糕的是，即使能赋值，我们也没有调用构造函数，虚函数表（如果有的话）也没有初始化。</p>
<h3 data-id="heading-2">第二次尝试：寻找解决方案</h3>
<p>你可能会想："那我能不能malloc之后手动调用构造函数呢？"</p>
<pre><code class="hljs language-cpp" lang="cpp">Student* s2 = (Student*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));
s2-&gt;<span class="hljs-built_in">Student</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">21</span>);  <span class="hljs-comment">// 语法错误！不能这样调用构造函数</span>
</code></pre>
<p><strong>又一个问题</strong>：C++不允许直接调用构造函数，这是语言设计上的限制。</p>
<h2 data-id="heading-3">第二章：new的登场——解决问题的关键</h2>
<h3 data-id="heading-4">new的简单用法</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++的方式如此简洁：</span>
Student* s3 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Student</span>(<span class="hljs-string">"王五"</span>, <span class="hljs-number">22</span>);
<span class="hljs-comment">// 一切正常！对象被完整创建</span>
</code></pre>
<p><strong>发生了什么？</strong> <code>new</code>在这里做了三件事：</p>
<ol>
<li>计算<code>Student</code>类需要的内存大小</li>
<li>分配足够的内存</li>
<li>调用构造函数初始化对象</li>
</ol>
<h3 data-id="heading-5">对比实验：看看背后差异</h3>
<p>让我们通过一个更复杂的例子看清本质：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Complex</span> {
    vector&lt;<span class="hljs-type">int</span>&gt; data;  <span class="hljs-comment">// 动态容器</span>
    string name;       <span class="hljs-comment">// 字符串对象</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Complex</span>(string n) : <span class="hljs-built_in">name</span>(n), <span class="hljs-built_in">data</span>(<span class="hljs-number">100</span>) {
        cout &lt;&lt; name &lt;&lt; <span class="hljs-string">"构造完成，拥有"</span> &lt;&lt; data.<span class="hljs-built_in">size</span>() &lt;&lt; <span class="hljs-string">"个元素\n"</span>;
    }
    ~<span class="hljs-built_in">Complex</span>() {
        cout &lt;&lt; name &lt;&lt; <span class="hljs-string">"被销毁\n"</span>;
    }
};

<span class="hljs-comment">// 测试1：使用malloc（注定失败）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_malloc</span><span class="hljs-params">()</span> </span>{
    Complex* c = (Complex*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Complex));
    <span class="hljs-comment">// 此时c-&gt;data和c-&gt;name都是未初始化的！</span>
    <span class="hljs-comment">// 尝试使用它们会导致未定义行为</span>
    <span class="hljs-comment">// 而且我们无法调用构造函数</span>
}

<span class="hljs-comment">// 测试2：使用new（完美工作）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_new</span><span class="hljs-params">()</span> </span>{
    Complex* c = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Complex</span>(<span class="hljs-string">"测试对象"</span>);
    <span class="hljs-comment">// c-&gt;data已经被初始化为100个元素的vector</span>
    <span class="hljs-comment">// c-&gt;name已经被设置为"测试对象"</span>
    <span class="hljs-keyword">delete</span> c;  <span class="hljs-comment">// 自动调用析构函数</span>
}
</code></pre>
<h2 data-id="heading-6">第三章：深入原理——为什么malloc做不到？</h2>
<h3 data-id="heading-7">构造函数的特殊性</h3>
<p>构造函数在C++中是一个<strong>特殊的存在</strong>，它：</p>
<ol>
<li><strong>没有名字可以调用</strong>：你不能像普通函数那样调用<code>obj.Constructor()</code></li>
<li><strong>没有返回值</strong>：甚至不是void类型</li>
<li><strong>自动调用机制</strong>：只在对象创建时由编译器自动安排调用</li>
</ol>
<p><strong>设计哲学</strong>：构造函数是对象"诞生"的时刻，这个时刻应该由语言机制保证，而不是程序员手动控制。</p>
<h3 data-id="heading-8">虚函数表的秘密</h3>
<p>对于有虚函数的类，问题更严重：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">speak</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Animal</span>() {}
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> : <span class="hljs-keyword">public</span> Animal {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">speak</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"汪汪！\n"</span>; }
};

<span class="hljs-comment">// 危险的尝试：</span>
Animal* a = (Animal*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Dog));
a-&gt;<span class="hljs-built_in">speak</span>();  <span class="hljs-comment">// 灾难！虚函数表指针未初始化</span>
</code></pre>
<p>每个有虚函数的对象都有一个隐藏的<strong>虚函数表指针</strong>，这个指针必须在构造函数中初始化。<code>malloc</code>完全不知道这个指针的存在，而<code>new</code>会正确处理。</p>
<h2 data-id="heading-9">第四章：手动构造的桥梁——placement new</h2>
<h3 data-id="heading-10">发现解决方案</h3>
<p>既然不能直接调用构造函数，C++提供了<strong>placement new</strong>这个机制：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;new&gt;</span>  <span class="hljs-comment">// 必须包含这个头文件</span></span>

<span class="hljs-type">void</span>* memory = <span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));
Student* s = <span class="hljs-built_in">new</span>(memory) <span class="hljs-built_in">Student</span>(<span class="hljs-string">"赵六"</span>, <span class="hljs-number">23</span>);  <span class="hljs-comment">// placement new！</span>
</code></pre>
<p><strong>这是什么魔法？</strong> <code>new(memory)</code>的意思是："在<code>memory</code>指向的内存位置上构造一个对象"。</p>
<h3 data-id="heading-11">完整的手动管理流程</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 分配原始内存</span>
<span class="hljs-type">void</span>* raw_mem = <span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(Student));

<span class="hljs-comment">// 2. 在内存上构造对象</span>
Student* student = <span class="hljs-built_in">new</span>(raw_mem) <span class="hljs-built_in">Student</span>(<span class="hljs-string">"钱七"</span>, <span class="hljs-number">24</span>);

<span class="hljs-comment">// 3. 使用对象</span>
cout &lt;&lt; student-&gt;name &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; student-&gt;age &lt;&lt; endl;

<span class="hljs-comment">// 4. 手动调用析构函数</span>
student-&gt;~<span class="hljs-built_in">Student</span>();

<span class="hljs-comment">// 5. 释放内存</span>
<span class="hljs-built_in">free</span>(raw_mem);
</code></pre>
<h3 data-id="heading-12">有趣的现象：为什么析构函数可以手动调用？</h3>
<p>你可能注意到了，我们可以手动调用析构函数<code>student-&gt;~Student()</code>，但不能手动调用构造函数。这是因为：</p>
<ul>
<li><strong>析构函数</strong>是一个普通的成员函数，只是名字特殊</li>
<li><strong>构造函数</strong>是语言级别的特殊机制，不是普通函数</li>
</ul>
<h2 data-id="heading-13">第五章：设计哲学——为什么C++要这样设计？</h2>
<h3 data-id="heading-14">异常安全保证</h3>
<p>考虑这个场景：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceHolder</span> {
    FILE* file;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ResourceHolder</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename) {
        file = <span class="hljs-built_in">fopen</span>(filename, <span class="hljs-string">"r"</span>);
        <span class="hljs-keyword">if</span> (!file) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"文件打开失败"</span>);
        <span class="hljs-comment">// 可能还有其他可能抛出异常的操作</span>
    }
    ~<span class="hljs-built_in">ResourceHolder</span>() {
        <span class="hljs-keyword">if</span> (file) <span class="hljs-built_in">fclose</span>(file);
    }
};

<span class="hljs-comment">// 使用new：异常安全</span>
<span class="hljs-keyword">try</span> {
    ResourceHolder* rh = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ResourceHolder</span>(<span class="hljs-string">"data.txt"</span>);
    <span class="hljs-comment">// 如果构造失败，new保证内存被释放</span>
    <span class="hljs-keyword">delete</span> rh;
} <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> exception&amp; e) {
    <span class="hljs-comment">// 安全处理异常</span>
}

<span class="hljs-comment">// 如果允许malloc+手动构造：</span>
ResourceHolder* rh = (ResourceHolder*)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(ResourceHolder));
<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 假设我们可以手动调用构造函数</span>
    rh-&gt;<span class="hljs-built_in">ResourceHolder</span>(<span class="hljs-string">"data.txt"</span>);  <span class="hljs-comment">// 可能抛出异常</span>
} <span class="hljs-built_in">catch</span> (...) {
    <span class="hljs-built_in">free</span>(rh);  <span class="hljs-comment">// 容易忘记这个清理！</span>
    <span class="hljs-keyword">throw</span>;
}
</code></pre>
<p><strong>关键洞察</strong>：<code>new</code>提供了<strong>原子性操作</strong>——要么对象完整创建，要么完全失败且没有资源泄漏。</p>
<h3 data-id="heading-15">RAII原则</h3>
<p>RAII（Resource Acquisition Is Initialization）是C++的核心设计模式：</p>
<ul>
<li><strong>资源获取</strong>就是<strong>初始化</strong></li>
<li>构造函数获取资源</li>
<li>析构函数释放资源</li>
</ul>
<p><code>new</code>/<code>delete</code>完美支持RAII，而<code>malloc</code>/<code>free</code>需要手动管理所有细节。</p>
<h2 data-id="heading-16">第六章：实际应用——何时使用何种方式？</h2>
<h3 data-id="heading-17">现代C++的推荐实践</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ✅ 情况1：创建单个对象——使用new</span>
<span class="hljs-keyword">auto</span>* obj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MyClass</span>(args);

<span class="hljs-comment">// ✅ 情况2：创建对象数组——使用new[]</span>
<span class="hljs-keyword">auto</span>* arr = <span class="hljs-keyword">new</span> MyClass[<span class="hljs-number">10</span>];

<span class="hljs-comment">// ✅ 情况3：需要自定义内存位置——使用placement new</span>
<span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];
<span class="hljs-keyword">auto</span>* obj = <span class="hljs-built_in">new</span>(buffer) <span class="hljs-built_in">MyClass</span>(args);

<span class="hljs-comment">// ⚠️ 情况4：与C库交互——可以使用malloc</span>
<span class="hljs-type">void</span>* data = <span class="hljs-built_in">malloc</span>(size);
<span class="hljs-built_in">c_library_function</span>(data);
<span class="hljs-built_in">free</span>(data);

<span class="hljs-comment">// ❌ 大多数现代C++代码中：避免直接使用new</span>
<span class="hljs-comment">// 改用智能指针：</span>
<span class="hljs-keyword">auto</span> obj = <span class="hljs-built_in">make_unique</span>&lt;MyClass&gt;(args);  <span class="hljs-comment">// 更安全！</span>
</code></pre>
<h3 data-id="heading-18">性能考虑：真的需要担心吗？</h3>
<p>很多人担心<code>new</code>比<code>malloc</code>慢，但实际上：</p>
<ol>
<li>对于需要初始化的对象，<code>malloc</code>需要额外的初始化步骤</li>
<li>编译器可以对<code>new</code>进行深度优化</li>
<li>真正的性能瓶颈很少是内存分配本身</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 性能测试对比</span>
<span class="hljs-keyword">auto</span> start = chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
    <span class="hljs-keyword">auto</span>* p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ComplexObject</span>(<span class="hljs-string">"test"</span>);
    <span class="hljs-keyword">delete</span> p;
}
<span class="hljs-keyword">auto</span> end = chrono::high_resolution_clock::<span class="hljs-built_in">now</span>();

<span class="hljs-comment">// 通常差异小于10%，而安全性提升是巨大的</span>
</code></pre>
<h2 data-id="heading-19">第七章：从汇编层面看差异</h2>
<p>让我们看看编译器实际生成了什么代码：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++源代码：</span>
<span class="hljs-function">Student* <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Student</span>(<span class="hljs-string">"小明"</span>, <span class="hljs-number">18</span>);
}

<span class="hljs-comment">// 编译器生成的伪汇编（x64）：</span>
<span class="hljs-built_in">create</span>():
    push    rbx
    mov     edi, <span class="hljs-number">40</span>          <span class="hljs-meta"># sizeof(Student)，编译器自动计算</span>
    call    <span class="hljs-keyword">operator</span> <span class="hljs-keyword">new</span>     # <span class="hljs-number">1.</span> 分配内存
    
    mov     rbx, rax         # 保存指针
    mov     rdi, rbx         # 传递<span class="hljs-keyword">this</span>指针
    mov     esi, 地址_of_<span class="hljs-string">"小明"</span>  # 传递name参数
    mov     edx, <span class="hljs-number">18</span>          # 传递age参数
    call    Student构造函数   # <span class="hljs-number">2.</span> 调用构造函数！关键步骤！
    
    mov     rax, rbx         # 返回对象指针
    pop     rbx
    ret
</code></pre>
<p><strong>关键点</strong>：构造函数调用是编译器<strong>直接插入</strong>的，不是运行时查找的。</p>
<h2 data-id="heading-20">选择哪种方式？为什么？</h2>
<h3 data-id="heading-21">终极答案</h3>
<p><code>malloc</code>和<code>new</code>代表了两种不同的编程哲学：</p>






























<table><thead><tr><th>特性</th><th><code>malloc</code>/<code>free</code></th><th><code>new</code>/<code>delete</code></th></tr></thead><tbody><tr><td><strong>哲学</strong></td><td>C：分离关注点</td><td>C++：对象完整性</td></tr><tr><td><strong>视角</strong></td><td>内存分配器</td><td>对象生命周期管理器</td></tr><tr><td><strong>职责</strong></td><td>只给空地</td><td>给地+建房+装修</td></tr><tr><td><strong>安全</strong></td><td>程序员全责</td><td>语言提供保证</td></tr></tbody></table>
<h3 data-id="heading-22">现代C++的最佳实践</h3>
<ol>
<li><strong>默认使用new/delete</strong>——当你需要创建对象时</li>
<li><strong>优先使用智能指针</strong>——避免手动内存管理</li>
<li><strong>仅在必要时用malloc</strong>——与C库交互、实现内存池等低级操作</li>
<li><strong>理解背后的原理</strong>——即使使用高级工具，也要知道底层机制</li>
</ol>
<h3 data-id="heading-23">最后的思考</h3>
<p>回到最初的问题：<strong>为什么C++有了malloc还需要new？</strong></p>
<p>因为C++不仅仅是要分配内存，更是要管理<strong>对象的完整生命周期</strong>。<code>new</code>不是<code>malloc</code>的替代品，而是C++面向对象哲学的体现——它将内存分配、对象构造、异常安全、类型系统完美地结合在一起。</p>
<p>当你使用<code>new</code>时，你不仅是在分配内存，更是在告诉编译器："请为我创建一个完整的、类型安全的、异常安全的对象。" 这就是C++的力量所在，也是它区别于C的本质特征。</p>
<p>记住：在C++中，我们不是操作内存，我们是管理对象。这个理念的转变，正是从<code>malloc</code>到<code>new</code>跨越的核心。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[jsx/tsx使用cssModule和typescript-plugin-css-modules]]></title>    <link>https://juejin.cn/post/7592865044692008966</link>    <guid>https://juejin.cn/post/7592865044692008966</guid>    <pubDate>2026-01-09T01:51:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592865044692008966" data-draft-id="7592865044690698246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="jsx/tsx使用cssModule和typescript-plugin-css-modules"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2026-01-09T01:51:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            jsx/tsx使用cssModule和typescript-plugin-css-modules
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:51:30.000Z" title="Fri Jan 09 2026 01:51:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1，前言</h2>
<p>在<code>vite/webpack</code>搭建的项目中，不管是<code>vue</code>还是<code>react</code>，都可以写<code>jsx/tsx</code>，为了避免样式污染，常用的方式有两种。一种是每个组件都用一个唯一类名<code>class</code>包裹，使用<code>less/scss</code>嵌套样式。另一种是使用<code>cssModule</code>模块化。本文就分享一下如何使用<code>cssModule</code>，并推荐一个好用的插件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmrmckeb%2Ftypescript-plugin-css-modules" target="_blank" title="https://github.com/mrmckeb/typescript-plugin-css-modules" ref="nofollow noopener noreferrer">typescript-plugin-css-modules</a>，让你在<code>vscode</code>中，能拥有<code>typeScript</code>一样的智能提示。</p>
<h2 data-id="heading-1">2，效果图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0bd5997378846b9b12ef860fc3c02a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528289&amp;x-signature=VbpxS6gbIuZsMa9sowhqGPK9ibA%3D" alt="效果图" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daac9b0cb2cf49139d7978b35c2d8107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528289&amp;x-signature=ux2%2BRbzz5sUgV2hQgojwBiXs%2FAE%3D" alt="类型提示" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b4f9d8de17a4c47a31f352109a1a179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528289&amp;x-signature=rhqaxSgUhgn4IHHMT6GPiTCO1yA%3D" alt="类型提示" loading="lazy"/></p>
<h2 data-id="heading-2">3，如何使用</h2>
<p>注：本文各种配置均使用<code>vscode</code>编辑器。</p>
<h3 data-id="heading-3">3.1，安装</h3>
<ul>
<li>yarn</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">yarn <span class="hljs-keyword">add</span> -D typescript-plugin-css-modules
</code></pre>
<ul>
<li>npm</li>
</ul>

<pre><code class="hljs">npm install -D typescript-plugin-css-modules
</code></pre>
<h3 data-id="heading-4">3.2，配置</h3>
<p>配置后需要重启<code>vscode</code>，然后项目中使用<code>cssMoudule</code>时，就可以享受到<code>typeScript</code>提示的<code>class</code>类名了，配置如下：</p>
<ul>
<li>配置<code>tsconfig.json</code></li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"typescript-plugin-css-modules"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>配置<code>settings.json</code></li>
</ul>
<p>在项目根目录新建<code>.vscode</code>文件夹，在文件夹中新建<code>settings.json</code>，并写入如下配置，用于指明使用<code>typescript.tsdk</code>的位置以及开启提示，如果<code>vscode</code>有提示，记得同意。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"typescript.tsdk"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node_modules/typescript/lib"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"typescript.enablePromptUseWorkspaceTsdk"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>注意：<code>cssModule</code>可以用于<code>css，less，scss</code>等，使用时，<code>css/less/scss</code>文件后缀必须由<code>.css/.less/.scss</code>变为 <code>.module.css/.module.less/.module.scss</code></p>
</blockquote>
<h2 data-id="heading-5">4，示例</h2>
<ul>
<li>index.tsx</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./index.module.scss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'notFound'</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">{styles.main_box}</span>&gt;</span>11111&lt;/div &gt;
    )
  }
})
</span></code></pre>
<ul>
<li>index.module.scss</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.main_box</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
}
</code></pre>
<h2 data-id="heading-6">5，插件错误处理</h2>
<p>截止本文发布之时，<code>typescript-plugin-css-modules</code>的版本为<code>3.4.0</code>，此插件有一个bug，会导致<code>cssModule</code>类型提取失败，模块类型是一个<code>{}</code>的情况，如下所示：</p>
<blockquote>
<p>Property '' does not exist on type {}</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fe00da34d764b5a92e27317c127f946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528289&amp;x-signature=WD4gvahZv5D5qegFhFN5Iepq1Ro%3D" alt="类型提取错误" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmrmckeb%2Ftypescript-plugin-css-modules%2Fissues%2F146" target="_blank" title="https://github.com/mrmckeb/typescript-plugin-css-modules/issues/146" ref="nofollow noopener noreferrer">issues地址</a></p>
<h2 data-id="heading-7">5.1，错误触发原因</h2>
<p>这个bug目前有两个方式都会触发：</p>
<ul>
<li>
<p>1，当你项目中使用<code>less/scss</code>的<code>@include/@mixin</code>等等指令的时候</p>
</li>
<li>
<p>2，当你的项目使用<code>/ deep /</code>这样的深度选择器语法的时候</p>
</li>
</ul>
<h2 data-id="heading-8">5.2，解决办法</h2>
<ul>
<li>1，在需要使用<code>@include/@mixin</code>等等指令的时候，在<code>cssModule</code>文件的头上引入样式，就可以解决(之前是全局引入)，如下所示：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@use</span> <span class="hljs-string">"../../../static/styles/common.scss"</span> as *;
</code></pre>
<ul>
<li>2，换一种深度选择器写法，如下所示：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.main</span>{
  &amp; ::deep .el-button{
    <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">linear-gradient</span>(-<span class="hljs-number">90deg</span>, <span class="hljs-number">#29bdd9</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#276ace</span> <span class="hljs-number">100%</span>);
    &amp;<span class="hljs-selector-pseudo">:hover</span>{
      <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.8</span>;
    }
  }
}
</code></pre>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出 TinyEditor 富文本编辑器系列之一：TinyEditor 是什么]]></title>    <link>https://juejin.cn/post/7593261984189218866</link>    <guid>https://juejin.cn/post/7593261984189218866</guid>    <pubDate>2026-01-10T05:06:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593261984189218866" data-draft-id="7593242327932862474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出 TinyEditor 富文本编辑器系列之一：TinyEditor 是什么"/> <meta itemprop="keywords" content="前端,TypeScript,开源"/> <meta itemprop="datePublished" content="2026-01-10T05:06:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端开源星球"/> <meta itemprop="url" content="https://juejin.cn/user/1504599026445150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出 TinyEditor 富文本编辑器系列之一：TinyEditor 是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1504599026445150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端开源星球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:06:47.000Z" title="Sat Jan 10 2026 05:06:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你好，我是 Kagol，个人公众号：<code>前端开源星球</code>。</p>
<p>TinyEditor v4.0 已正式发布，接下来将通过一系列文章介绍 TinyEditor，让大家更好地理解和使用 TinyEditor。</p>
<p><a href="https://juejin.cn/post/7592089325913522176" target="_blank" title="https://juejin.cn/post/7592089325913522176">🎉历时1年，TinyEditor v4.0 正式发布！</a></p>
<p>TinyEditor 是一个基于 Quill 2.0 构建的强大富文本编辑器，通过全面的模块和格式扩展了基础功能。本概述介绍了项目架构、关键特性和结构，帮助初学者开发者了解 TinyEditor 提供的功能以及如何开始使用。</p>
<h2 data-id="heading-0">什么是 TinyEditor？</h2>
<p>TinyEditor 是一个框架无关的富文本编辑器，通过 30 多个额外的模块和格式增强了 Quill 2.0。它基于 Quill 生态系统，在保持完整 API 兼容性的同时，添加了强大的功能，如高级表格操作、图像处理、协作编辑、AI 集成等。该编辑器设计为与 Vue、React、Angular 及其他 Web 框架无缝协作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/103155482b99440fa671ed8daa8670ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768626406&amp;x-signature=tnr86h%2F8r3uJOYIEjwEP7yqfD1s%3D" alt="Tiny-editor-demo.png" loading="lazy"/></p>
<h2 data-id="heading-1">项目架构</h2>
<p>项目采用 pnpm workspaces 的 monorepo 结构，按不同关注点组织成独立的包：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0aab8c8d29c44ef0bf99dc8e4821e7dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768626406&amp;x-signature=zFLGHZ6E2Vhf26L0mryeBzq9XgI%3D" alt="项目架构.png" loading="lazy"/></p>
<h3 data-id="heading-2">核心包</h3>






























<table><thead><tr><th>包</th><th>用途</th><th>主要内容</th></tr></thead><tbody><tr><td>fluent-editor</td><td>主编辑器库</td><td>核心 FluentEditor 类、模块、格式、主题</td></tr><tr><td>collaborative-editing-backend</td><td>实时协作服务器</td><td>WebSocket 服务器、MongoDB 持久化、Yjs 集成</td></tr><tr><td>docs</td><td>文档和示例</td><td>文档站点、演示场、示例</td></tr><tr><td>projects</td><td>演示应用</td><td>Vue 演示、实现示例</td></tr></tbody></table>
<h2 data-id="heading-3">关键特性和模块</h2>
<p>TinyEditor 通过一套全面的模块和格式扩展了 Quill，使其开箱即用即可投入生产环境：</p>
<h3 data-id="heading-4">核心特性</h3>
<ul>
<li><strong>30+ 模块和格式</strong>：除了 Quill 的 21 个内置格式，还添加了 15+ 个增强模块，包括表格、图像、链接、计数器、表情符号、文件、剪贴板、提及、快速菜单和截图功能</li>
<li><strong>高级表格操作</strong>：插入自定义尺寸表格、拖动行列大小、插入/删除行列、合并/拆分单元格</li>
<li><strong>框架无关</strong>：兼容 Vue、React、Angular 和原生 JavaScript</li>
<li><strong>完全 Quill 兼容</strong>：与 Quill API 和生态系统模块保持 100% 兼容性</li>
</ul>
<h3 data-id="heading-5">模块架构</h3>
<p>编辑器按几个关键模块类别组织：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8106308c11cd4be3b472e6fe2a58c1fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768626406&amp;x-signature=3481r0VpVI8HXBhV3wxf5%2FrJqGg%3D" alt="模块架构.png" loading="lazy"/></p>
<h2 data-id="heading-6">技术栈</h2>
<h3 data-id="heading-7">核心依赖</h3>
<ul>
<li><strong>Quill 2.0</strong>：基础富文本编辑器引擎</li>
<li><strong>TypeScript</strong>：完整类型安全和开发体验</li>
<li><strong>Vite</strong>：用于开发和打包的现代构建工具</li>
<li><strong>Sass</strong>：主题的 CSS 预处理</li>
</ul>
<h3 data-id="heading-8">高级功能支持</h3>
<ul>
<li><strong>Yjs</strong>：实时协作编辑框架</li>
<li><strong>MongoDB</strong>：协作的文档持久化</li>
<li><strong>WebSocket</strong>：实时通信</li>
<li><strong>Emoji Mart</strong>：表情符号选择和插入</li>
<li><strong>Highlight.js</strong>：代码语法高亮</li>
<li><strong>MathLive</strong>：LaTeX 数学公式支持</li>
</ul>
<h2 data-id="heading-9">快速开始</h2>
<p>体验 TinyEditor 最快的方式是通过开发环境：</p>
<ol>
<li>克隆和安装：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> git@github.com:opentiny/tiny-editor.git
<span class="hljs-built_in">cd</span> tiny-editor
pnpm i
</code></pre>
<ol start="2">
<li>启动开发：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">pnpm dev
</code></pre>
<ol start="3">
<li>查看示例：访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2Ftiny-editor%2F" target="_blank" title="http://localhost:5173/tiny-editor/" ref="nofollow noopener noreferrer">http://localhost:5173/tiny-editor/</a></li>
</ol>
<p>生产环境使用，请安装包：</p>
<pre><code class="hljs language-bash" lang="bash">npm i @opentiny/fluent-editor
</code></pre>
<h2 data-id="heading-10">项目结构深入解析</h2>
<h3 data-id="heading-11">源码组织</h3>
<p>主编辑器源码结构如下：</p>
<ul>
<li><code>src/core/</code>：扩展 Quill 的核心 FluentEditor 类</li>
<li><code>src/modules/</code>：所有功能模块（工具栏、剪贴板、AI 等）</li>
<li><code>src/formats/</code>：自定义内容格式和 blot</li>
<li><code>src/attributors/</code>：样式和属性定义</li>
<li><code>src/themes/</code>：视觉主题实现</li>
<li><code>src/config/</code>：配置类型和国际化</li>
</ul>
<h3 data-id="heading-12">模块注册系统</h3>
<p>TinyEditor 使用复杂的模块注册系统，支持轻松扩展和定制。所有模块在主入口点注册，具有覆盖能力，使开发者能够自定义或替换任何组件。</p>
<p>模块化设计和全面的功能集使 TinyEditor 适用于从简单内容编辑到复杂协作应用的各种场景。项目对 Quill 兼容性的承诺确保你可以利用整个 Quill 生态系统，同时享受 TinyEditor 的增强功能。</p>
<p>后续将全面介绍 TinyEditor 如何使用、设计架构、实现原理、二次开发等内容，点个关注，不迷路。</p>
<h2 data-id="heading-13">联系我们</h2>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor" target="_blank" title="https://github.com/opentiny/tiny-editor" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a>（欢迎 Star ⭐）</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor" target="_blank" title="https://opentiny.github.io/tiny-editor" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor</a></p>
<p>个人博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkagol.github.io%2Fblogs%2F" target="_blank" title="https://kagol.github.io/blogs/" ref="nofollow noopener noreferrer">kagol.github.io/blogs/</a></p>
<p>小助手微信：opentiny-official</p>
<p>公众号：OpenTiny</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[Channel-Flip节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7593541290991124530</link>    <guid>https://juejin.cn/post/7593541290991124530</guid>    <pubDate>2026-01-10T05:17:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593541290991124530" data-draft-id="7593541290991108146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[Channel-Flip节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2026-01-10T05:17:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[Channel-Flip节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:17:22.000Z" title="Sat Jan 10 2026 05:17:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>在Unity通用渲染管线（URP）中，Shader Graph作为一种直观的可视化着色器编辑工具，为开发者提供了便捷的着色器构建方式。Flip节点作为Shader Graph中的一个基础但功能强大的组件，在图形效果开发中具有重要作用。本文将从技术原理、应用场景及实战技巧等多个维度，系统解析Flip节点的使用方法与最佳实践。</p>
<h2 data-id="heading-0">核心功能解析</h2>
<h3 data-id="heading-1">数学原理</h3>
<p>Flip节点的核心功能是对输入值的各个通道进行符号翻转，其数学表达式如下：</p>
<p>Out = (Flip × -2 + 1) × In</p>
<p>当Flip参数为1（True）时，系数变为-1，实现数值翻转；当参数为0（False）时，系数保持为1，数值保持不变。这种线性变换方式比传统的条件判断更为高效，尤其适用于GPU的并行计算环境。</p>
<h3 data-id="heading-2">通道选择机制</h3>
<p>Flip节点提供四个独立的通道控制开关：</p>
<ul>
<li>Red：控制红色通道的翻转</li>
<li>Green：控制绿色通道的翻转</li>
<li>Blue：控制蓝色通道的翻转</li>
<li>Alpha：控制透明通道的翻转</li>
</ul>
<p>每个开关均具备智能禁用机制：</p>
<ul>
<li>当输入为Float类型时，Green、Blue和Alpha通道自动禁用</li>
<li>当输入为Vector2类型时，Blue和Alpha通道自动禁用</li>
<li>当输入为Vector3类型时，Alpha通道自动禁用</li>
</ul>
<p>该设计既保证了节点的灵活性，也有效避免了用户误操作。</p>
<h2 data-id="heading-3">端口特性详解</h2>
<h3 data-id="heading-4">输入端口（In）</h3>
<ul>
<li>类型：动态矢量</li>
<li>功能：接受从浮点数到四维向量的各类输入</li>
<li>特点：自动适配输入维度，为通道控制提供基础数据支持</li>
</ul>
<h3 data-id="heading-5">输出端口（Out）</h3>
<ul>
<li>类型：动态矢量</li>
<li>功能：输出经过翻转处理后的结果</li>
<li>特点：保持与输入相同的维度，确保数据流连续性与一致性</li>
</ul>
<h3 data-id="heading-6">端口连接建议</h3>
<ul>
<li>颜色处理：将Color节点连接至In端口，Out端口连接至材质的BaseColor</li>
<li>法线处理：将Normal节点连接至In端口，Out端口连接至材质的Normal</li>
<li>特效处理：将Position节点连接至In端口，Out端口连接至自定义效果节点</li>
</ul>
<h2 data-id="heading-7">控件配置指南</h2>
<h3 data-id="heading-8">通道控制选项</h3>



































<table><thead><tr><th>通道</th><th>类型</th><th>功能</th><th>典型应用场景</th></tr></thead><tbody><tr><td>Red</td><td>开关</td><td>控制红色通道翻转</td><td>创建红色警告效果</td></tr><tr><td>Green</td><td>开关</td><td>控制绿色通道翻转</td><td>环境色适应调整</td></tr><tr><td>Blue</td><td>开关</td><td>控制蓝色通道翻转</td><td>冷色调效果创建</td></tr><tr><td>Alpha</td><td>开关</td><td>控制透明通道翻转</td><td>显示/隐藏切换</td></tr></tbody></table>
<h3 data-id="heading-9">配置策略</h3>
<ul>
<li>基础颜色翻转：同时启用Red、Green和Blue开关</li>
<li>单通道调整：仅启用目标通道开关</li>
<li>动态控制：将开关连接至Time节点，实现动画效果</li>
</ul>
<h2 data-id="heading-10">典型应用场景</h2>
<h3 data-id="heading-11">视觉效果增强</h3>
<ul>
<li>颜色反转特效：在角色受伤时快速创建闪白效果
<ul>
<li>配置：Red/Green/Blue = True，Alpha = False</li>
<li>连接：Color → Flip → Material</li>
</ul>
</li>
<li>法线翻转：处理双向表面光照
<ul>
<li>配置：Red/Green = False，Blue = True，Alpha = False</li>
<li>连接：Normal → Flip → Material</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12">功能实现</h3>
<ul>
<li>显示/隐藏切换：通过翻转Alpha通道实现
<ul>
<li>配置：Red/Green/Blue = False，Alpha = True</li>
<li>连接：Color → Flip → Material</li>
</ul>
</li>
<li>动态效果创建：结合Time节点创建周期性翻转
<ul>
<li>配置：连接Time节点到Flip开关</li>
<li>效果：实现颜色脉冲效果</li>
</ul>
</li>
</ul>
<h2 data-id="heading-13">高级应用技巧</h2>
<h3 data-id="heading-14">动态控制方案</h3>
<ul>
<li>
<p>基于时间的翻转：</p>
<p><code>// 伪代码示例 float time = Time.time;</code></p>
<p><code>// 获取当前时间 Flip.Red = sin(time * 2) &gt; 0;</code></p>
<p><code>// 根据正弦波控制红色通道</code></p>
</li>
<li>
<p>基于用户输入的翻转：</p>
<p><code>// 伪代码示例 Flip.Green = Input.GetKey(KeyCode.G); // 按下G键时翻转绿色通道</code></p>
</li>
</ul>
<h3 data-id="heading-15">多层翻转效果</h3>
<p>通过串联多个Flip节点可创建复杂效果：</p>
<ul>
<li>第一层：基础颜色翻转（Red/Green/Blue = True）</li>
<li>第二层：特定通道微调（仅Blue = True）</li>
<li>第三层：最终输出调整（Alpha = True）</li>
</ul>
<h3 data-id="heading-16">性能优化技巧</h3>
<ul>
<li>避免过度使用：在每帧更新的计算中应谨慎使用</li>
<li>静态翻转优先：对不变的效果使用静态配置</li>
<li>材质实例化：对频繁使用的翻转效果创建材质实例</li>
</ul>
<h2 data-id="heading-17">常见问题解决方案</h2>
<h3 data-id="heading-18">通道不匹配问题</h3>
<p><strong>现象</strong>：当输入向量维度与控件配置不匹配时，节点可能无法正常工作</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用Swizzle节点调整通道顺序</li>
<li>使用Split节点分离向量分量</li>
<li>使用Combine节点重新组合通道</li>
</ul>
<h3 data-id="heading-19">性能瓶颈识别</h3>
<p><strong>检测方法</strong>：</p>
<ul>
<li>使用Unity Profiler分析着色器性能</li>
<li>检查Flip节点在渲染队列中的位置</li>
<li>测试不同配置下的帧率变化</li>
</ul>
<p><strong>优化建议</strong>：</p>
<ul>
<li>简化复杂的翻转组合</li>
<li>使用LOD（Level of Detail）技术</li>
<li>避免在移动设备上过度使用动态翻转</li>
</ul>
<h2 data-id="heading-20">最佳实践指南</h2>
<h3 data-id="heading-21">项目组织建议</h3>
<ul>
<li>
<p>命名规范：</p>
<ul>
<li>基础翻转：Flip_BaseColor</li>
<li>特效翻转：Flip_Effect_Glow</li>
<li>功能翻转：Flip_HUD_Alpha</li>
</ul>
</li>
<li>
<p>注释标准：</p>
<p><code>// 翻转节点配置说明</code></p>
<p><code>// 功能：创建角色受伤时的闪白效果</code></p>
<p><code>// 通道：RGB全翻转，Alpha保持</code></p>
<p><code>// 连接：Color → Flip → Material</code></p>
</li>
<li>
<p>预设管理：</p>
<ul>
<li>创建常用翻转预设</li>
<li>建立配置文档</li>
<li>定期审查效果</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">测试验证方法</h3>
<ul>
<li>单元测试：
<ul>
<li>测试所有通道组合</li>
<li>验证边界条件处理</li>
</ul>
</li>
<li>集成测试：
<ul>
<li>在不同光照条件下测试</li>
<li>在多种材质上验证效果</li>
</ul>
</li>
<li>性能测试：
<ul>
<li>基准测试不同配置的性能</li>
<li>分析内存使用情况</li>
</ul>
</li>
</ul>
<h2 data-id="heading-23">未来发展趋势</h2>
<p>随着URP的持续演进，Flip节点也在不断发展：</p>
<ul>
<li>更多维度支持：可能扩展至更高维度的向量处理</li>
<li>更精细控制：引入通道强度的连续调节</li>
<li>智能优化：自动识别最佳翻转配置</li>
<li>跨平台增强：针对移动平台的进一步优化</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[记录protoc生成代码将optional改成omitepty问题]]></title>    <link>https://juejin.cn/post/7593234983755710474</link>    <guid>https://juejin.cn/post/7593234983755710474</guid>    <pubDate>2026-01-10T05:36:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593234983755710474" data-draft-id="7593251491935977518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="记录protoc生成代码将optional改成omitepty问题"/> <meta itemprop="keywords" content="后端,protobuf,Go"/> <meta itemprop="datePublished" content="2026-01-10T05:36:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="nil"/> <meta itemprop="url" content="https://juejin.cn/user/2893570337422670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            记录protoc生成代码将optional改成omitepty问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2893570337422670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    nil
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:36:41.000Z" title="Sat Jan 10 2026 05:36:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题现状</h2>
<p>在修改go项目的protoc文件，然后用protoc命令生成go代码的时候，会遇到将optional修改成omitempty的情况</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5130477f3d94c87aade0643ff38b7c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbmls:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768628201&amp;x-signature=%2BkhAuvFRJJVeqGbncQA5fG0gktk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">问题产生的原因</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215757bebcb7490d9c40fb6df57e2cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbmls:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768628201&amp;x-signature=Wdwhu9nxWdTo0A2SmrbSMyGoe94%3D" alt="image.png" loading="lazy"/></p>
<p>是因为我的protoc版本是v4.25.1，而之前的版本是v4.22.1</p>
<h2 data-id="heading-2">产生的结果</h2>
<p>这样修改会导致接口给前端返回的数组类型变成了null，而不是空数组。如果前端代码不严谨的话，就导致报错了。</p>
<h2 data-id="heading-3">解决过程</h2>
<p>先是询问大模型，提供了很多方法，但都行不通。下面介绍一下行不通的方案。</p>
<ul>
<li>重新安装protoc v4.22.1版本。但是的网上找了很多资料，发现只能下载源代码，需要自己编译。不能直接下载可执行文件。</li>
<li>用docker，在docker中安装protoc v4.22.1 生成代码</li>
<li>其他</li>
</ul>
<p>最终，采用最简单的方式，即将修改的omitempty改回optional</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 备份文件</span>
<span class="hljs-built_in">cp</span> pb/code_review.api.v1.pb.go pb/code_review.api.v1.pb.go.bak

<span class="hljs-comment"># 2. 使用简单的 sed 命令</span>
sed -i.bak <span class="hljs-string">'s/omitempty/optional/g'</span> pb/code_review.api.v1.pb.go

<span class="hljs-comment"># 3. 验证</span>
grep <span class="hljs-string">"optional"</span> pb/code_review.api.v1.pb.go | <span class="hljs-built_in">head</span> -3
</code></pre>
<p>这个方法最终生效了！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react native项目中使用React Hook 高级模式]]></title>    <link>https://juejin.cn/post/7593251491935993902</link>    <guid>https://juejin.cn/post/7593251491935993902</guid>    <pubDate>2026-01-10T05:32:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593251491935993902" data-draft-id="7593212374921494555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react native项目中使用React Hook 高级模式"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2026-01-10T05:32:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨狂之逸才"/> <meta itemprop="url" content="https://juejin.cn/user/624178332441166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react native项目中使用React Hook 高级模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178332441166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨狂之逸才
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:32:20.000Z" title="Sat Jan 10 2026 05:32:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Hook 高级模式：从触发器模式到实战应用</h2>
<h3 data-id="heading-1">前言</h3>
<p>在 React 开发中，我们经常遇到这样的场景：父组件需要控制子组件重新加载数据，但又不想重新挂载整个组件。本文将介绍一种优雅的解决方案——<strong>触发器模式（Trigger Pattern）</strong>，以及其他 9 种实用的 Hook 模式。</p>
<h3 data-id="heading-2">问题场景</h3>
<p>假设我们有一个图片上传组件 <code>FileUpload</code>，在编辑页面修改图片后返回列表页，需要刷新图片显示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 列表页</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">RecordsList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">refresh</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">fetchData</span>(); <span class="hljs-comment">// 刷新列表数据</span>
    <span class="hljs-comment">// 问题：如何让 FileUpload 组件也刷新？</span>
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {data.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">FileUpload</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{item.id}</span> /&gt;</span> // 需要刷新图片
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-3">常见的错误方案</h4>
<h5 data-id="heading-4">❌ 方案 1：使用 key 强制重新挂载</h5>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">FileUpload</span> key={<span class="hljs-string">`<span class="hljs-subst">${item.id}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>} id={item.<span class="hljs-property">id</span>} /&gt;
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>组件完全销毁重建，丢失所有内部状态</li>
<li>性能差，会触发完整的挂载/卸载生命周期</li>
<li>可能导致闪烁或动画中断</li>
</ul>
<h5 data-id="heading-5">❌ 方案 2：通过 ref 调用子组件方法</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fileUploadRef = <span class="hljs-title function_">useRef</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">refresh</span> = (<span class="hljs-params"/>) =&gt; {
  fileUploadRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">refresh</span>(); <span class="hljs-comment">// 命令式调用</span>
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FileUpload</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{fileUploadRef}</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{item.id}</span> /&gt;</span></span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>打破了 React 的单向数据流</li>
<li>不符合声明式编程理念</li>
<li>难以追踪数据流向</li>
</ul>
<h5 data-id="heading-6">❌ 方案 3：使用布尔值切换</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [shouldRefresh, setShouldRefresh] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">refresh</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setShouldRefresh</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setShouldRefresh</span>(<span class="hljs-literal">false</span>), <span class="hljs-number">0</span>);
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FileUpload</span> <span class="hljs-attr">shouldRefresh</span>=<span class="hljs-string">{shouldRefresh}</span> /&gt;</span></span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>需要复杂的状态重置逻辑</li>
<li>连续刷新可能失效（值没有变化）</li>
<li>代码不够优雅</li>
</ul>
<hr/>
<h3 data-id="heading-7">✅ 最佳方案：触发器模式</h3>
<h4 data-id="heading-8">核心思想</h4>
<blockquote>
<p><strong>用一个简单的数值变化来触发复杂的副作用</strong></p>
</blockquote>
<h4 data-id="heading-9">实现步骤</h4>
<h5 data-id="heading-10">1. 创建 Hook</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/hooks/useRefreshTrigger.js</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useRefreshTrigger</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [trigger, setTrigger] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-keyword">const</span> fire = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setTrigger</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  }, []);
  
  <span class="hljs-keyword">return</span> [trigger, fire];
};
</code></pre>
<h5 data-id="heading-11">2. 在父组件中使用</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 列表页</span>
<span class="hljs-keyword">import</span> { useRefreshTrigger } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useRefreshTrigger'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">RecordsList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [refreshTrigger, triggerRefresh] = <span class="hljs-title function_">useRefreshTrigger</span>();
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">refresh</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">fetchData</span>();
    <span class="hljs-title function_">triggerRefresh</span>(); <span class="hljs-comment">// 触发刷新</span>
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {data.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">FileUpload</span> 
          <span class="hljs-attr">id</span>=<span class="hljs-string">{item.id}</span> 
          <span class="hljs-attr">refreshTrigger</span>=<span class="hljs-string">{refreshTrigger}</span> // <span class="hljs-attr">传递触发器</span>
        /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h5 data-id="heading-12">3. 在子组件中响应</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// FileUpload 组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FileUpload</span>(<span class="hljs-params">{ id, refreshTrigger }</span>) {
  <span class="hljs-keyword">const</span> [pictures, setPictures] = <span class="hljs-title function_">useState</span>([]);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (id) {
      <span class="hljs-comment">// 当 id 或 refreshTrigger 变化时，重新加载图片</span>
      <span class="hljs-title function_">fetchImages</span>(id).<span class="hljs-title function_">then</span>(setPictures);
    }
  }, [id, refreshTrigger]); <span class="hljs-comment">// ← 关键：依赖 refreshTrigger</span>
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {pictures.map(pic =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{pic.url}</span> /&gt;</span>)}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-13">工作原理</h4>
<pre><code class="hljs language-scss" lang="scss">用户操作 → <span class="hljs-built_in">triggerRefresh</span>() → trigger: <span class="hljs-number">0</span> → <span class="hljs-number">1</span> → <span class="hljs-number">2</span> → ...
                                    ↓
                        useEffect 检测到依赖变化
                                    ↓
                            重新执行副作用
</code></pre>
<h4 data-id="heading-14">优势总结</h4>
<p>✅ <strong>声明式</strong> - 符合 React 理念，数据流清晰<br/>
✅ <strong>轻量级</strong> - 只触发 effect，不重新挂载组件<br/>
✅ <strong>可预测</strong> - 父组件控制，子组件响应<br/>
✅ <strong>可复用</strong> - Hook 可在任何场景使用<br/>
✅ <strong>性能好</strong> - 不会丢失组件状态</p>
<hr/>
<h3 data-id="heading-15">其他 9 种实用 Hook 模式</h3>
<h4 data-id="heading-16">1. Toggle Pattern - 开关模式</h4>
<p>管理布尔状态的切换，比 <code>useState</code> 更方便：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useToggle</span> = (<span class="hljs-params">initialValue = <span class="hljs-literal">false</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(initialValue);
  
  <span class="hljs-keyword">const</span> toggle = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setValue</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> !v), []);
  <span class="hljs-keyword">const</span> setTrue = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setValue</span>(<span class="hljs-literal">true</span>), []);
  <span class="hljs-keyword">const</span> setFalse = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setValue</span>(<span class="hljs-literal">false</span>), []);
  
  <span class="hljs-keyword">return</span> [value, { toggle, setTrue, setFalse }];
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isOpen, { toggle, setTrue, setFalse }] = <span class="hljs-title function_">useToggle</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{setTrue}</span>&gt;</span>打开<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span> <span class="hljs-attr">visible</span>=<span class="hljs-string">{isOpen}</span> <span class="hljs-attr">onClose</span>=<span class="hljs-string">{setFalse}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p><strong>适用场景：</strong> 模态框、折叠面板、显示/隐藏</p>
<hr/>
<h4 data-id="heading-17">2. Previous Value Pattern - 记录上一次的值</h4>
<p>获取状态的前一个值，用于对比：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">usePrevious</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>();
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ref.<span class="hljs-property">current</span> = value;
  }, [value]);
  
  <span class="hljs-keyword">return</span> ref.<span class="hljs-property">current</span>;
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> prevCount = <span class="hljs-title function_">usePrevious</span>(count);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>上一次: {prevCount}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>变化: {count - (prevCount || 0)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>适用场景：</strong> 对比新旧值、撤销操作、动画过渡</p>
<hr/>
<h4 data-id="heading-18">3. Debounce Pattern - 防抖模式</h4>
<p>延迟执行，避免频繁触发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useDebounce</span> = (<span class="hljs-params">value, delay = <span class="hljs-number">500</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> [debouncedValue, setDebouncedValue] = <span class="hljs-title function_">useState</span>(value);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setDebouncedValue</span>(value);
    }, delay);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer);
  }, [value, delay]);
  
  <span class="hljs-keyword">return</span> debouncedValue;
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchBox</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [searchTerm, setSearchTerm] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> debouncedSearchTerm = <span class="hljs-title function_">useDebounce</span>(searchTerm, <span class="hljs-number">500</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (debouncedSearchTerm) {
      <span class="hljs-title function_">searchAPI</span>(debouncedSearchTerm); <span class="hljs-comment">// 只在停止输入 500ms 后搜索</span>
    }
  }, [debouncedSearchTerm]);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{searchTerm}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setSearchTerm(e.target.value)} /&gt;</span>;
}
</code></pre>
<p><strong>适用场景：</strong> 搜索输入、窗口 resize、滚动事件</p>
<hr/>
<h4 data-id="heading-19">4. Async State Pattern - 异步状态管理</h4>
<p>统一管理异步请求的加载、成功、失败状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useAsync</span> = (<span class="hljs-params">asyncFunction</span>) =&gt; {
  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>,
  });
  
  <span class="hljs-keyword">const</span> execute = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> (...params) =&gt; {
    <span class="hljs-title function_">setState</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> });
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncFunction</span>(...params);
      <span class="hljs-title function_">setState</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, data, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> });
      <span class="hljs-keyword">return</span> data;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">setState</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, error });
      <span class="hljs-keyword">throw</span> error;
    }
  }, [asyncFunction]);
  
  <span class="hljs-keyword">return</span> { ...state, execute };
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> { loading, data, error, execute } = <span class="hljs-title function_">useAsync</span>(fetchUserData);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">execute</span>(userId);
  }, [userId]);
  
  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>错误: {error.message}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>用户名: {data.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>适用场景：</strong> API 调用、数据加载</p>
<hr/>
<h4 data-id="heading-20">5. Local Storage Pattern - 持久化状态</h4>
<p>自动同步状态到 localStorage：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocalStorage</span> = (<span class="hljs-params">key, initialValue</span>) =&gt; {
  <span class="hljs-keyword">const</span> [storedValue, setStoredValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">getItem</span>(key);
      <span class="hljs-keyword">return</span> item ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(item) : initialValue;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> initialValue;
    }
  });
  
  <span class="hljs-keyword">const</span> setValue = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> valueToStore = value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span> ? <span class="hljs-title function_">value</span>(storedValue) : value;
      <span class="hljs-title function_">setStoredValue</span>(valueToStore);
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(valueToStore));
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  }, [key, storedValue]);
  
  <span class="hljs-keyword">return</span> [storedValue, setValue];
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeSelector</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useLocalStorage</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-string">'light'</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setTheme(theme === 'light' ? 'dark' : 'light')}&gt;
      当前主题: {theme}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>适用场景：</strong> 用户偏好设置、表单草稿、主题切换</p>
<hr/>
<h4 data-id="heading-21">6. Interval Pattern - 定时器模式</h4>
<p>安全地使用 setInterval：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useInterval</span> = (<span class="hljs-params">callback, delay</span>) =&gt; {
  <span class="hljs-keyword">const</span> savedCallback = <span class="hljs-title function_">useRef</span>();
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedCallback.<span class="hljs-property">current</span> = callback;
  }, [callback]);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (delay !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> savedCallback.<span class="hljs-title function_">current</span>(), delay);
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
    }
  }, [delay]);
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Countdown</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">60</span>);
  
  <span class="hljs-title function_">useInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) <span class="hljs-title function_">setCount</span>(count - <span class="hljs-number">1</span>);
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>倒计时: {count}秒<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>适用场景：</strong> 倒计时、轮询、实时更新</p>
<hr/>
<h4 data-id="heading-22">7. Mount Status Pattern - 组件挂载状态</h4>
<p>避免在组件卸载后更新状态（防止内存泄漏）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useIsMounted</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> isMounted = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    isMounted.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      isMounted.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
    };
  }, []);
  
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> isMounted.<span class="hljs-property">current</span>, []);
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">SafeAsyncComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> isMounted = <span class="hljs-title function_">useIsMounted</span>();
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isMounted</span>()) { <span class="hljs-comment">// 只在组件还挂载时才更新</span>
        <span class="hljs-title function_">setData</span>(result);
      }
    });
  }, []);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{data}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>适用场景：</strong> 异步操作、延迟更新</p>
<hr/>
<h4 data-id="heading-23">8. Composite Pattern - 组合模式</h4>
<p>将多个相关的 Hook 组合成一个业务 Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useSearchableList</span> = (<span class="hljs-params">fetchFunction</span>) =&gt; {
  <span class="hljs-keyword">const</span> [searchTerm, setSearchTerm] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [refreshTrigger, triggerRefresh] = <span class="hljs-title function_">useRefreshTrigger</span>();
  <span class="hljs-keyword">const</span> debouncedSearchTerm = <span class="hljs-title function_">useDebounce</span>(searchTerm, <span class="hljs-number">300</span>);
  <span class="hljs-keyword">const</span> { loading, data, error, execute } = <span class="hljs-title function_">useAsync</span>(fetchFunction);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">execute</span>(debouncedSearchTerm);
  }, [debouncedSearchTerm, refreshTrigger]);
  
  <span class="hljs-keyword">return</span> {
    searchTerm,
    setSearchTerm,
    loading,
    data,
    error,
    <span class="hljs-attr">refresh</span>: triggerRefresh,
  };
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { searchTerm, setSearchTerm, loading, data, refresh } = 
    <span class="hljs-title function_">useSearchableList</span>(searchProducts);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{searchTerm}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setSearchTerm(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{refresh}</span>&gt;</span>刷新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {loading ? '加载中...' : data?.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>)}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>适用场景：</strong> 表单管理、分页列表、搜索功能</p>
<hr/>
<h4 data-id="heading-24">9. Event Listener Pattern - 事件监听模式</h4>
<p>安全地添加和移除事件监听器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useEventListener</span> = (<span class="hljs-params">eventName, handler, element = <span class="hljs-variable language_">window</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> savedHandler = <span class="hljs-title function_">useRef</span>();
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    savedHandler.<span class="hljs-property">current</span> = handler;
  }, [handler]);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> isSupported = element &amp;&amp; element.<span class="hljs-property">addEventListener</span>;
    <span class="hljs-keyword">if</span> (!isSupported) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">eventListener</span> = (<span class="hljs-params">event</span>) =&gt; savedHandler.<span class="hljs-title function_">current</span>(event);
    element.<span class="hljs-title function_">addEventListener</span>(eventName, eventListener);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      element.<span class="hljs-title function_">removeEventListener</span>(eventName, eventListener);
    };
  }, [eventName, element]);
};

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">KeyboardShortcuts</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">ctrlKey</span> &amp;&amp; e.<span class="hljs-property">key</span> === <span class="hljs-string">'s'</span>) {
      e.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'保存快捷键触发'</span>);
    }
  });
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>按 Ctrl+S 保存<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>适用场景：</strong> 键盘事件、窗口事件、自定义事件</p>
<hr/>
<h3 data-id="heading-25">Hook 设计原则</h3>
<h4 data-id="heading-26">1. 单一职责原则</h4>
<p>每个 Hook 只做一件事，保持简单和专注。</p>
<h4 data-id="heading-27">2. 可组合性</h4>
<p>小 Hook 可以组合成大 Hook，就像乐高积木。</p>
<h4 data-id="heading-28">3. 声明式</h4>
<p>通过 props 和返回值传递数据，避免命令式调用。</p>
<h4 data-id="heading-29">4. 可测试性</h4>
<p>逻辑独立，易于单元测试。</p>
<h4 data-id="heading-30">5. 可复用性</h4>
<p>不依赖具体业务，通用性强。</p>
<hr/>
<h3 data-id="heading-31">命名规范</h3>
<h4 data-id="heading-32">Hook 命名</h4>
<ul>
<li>格式：<code>use</code> + 功能描述（驼峰命名）</li>
<li>示例：<code>useRefreshTrigger</code>, <code>useToggle</code>, <code>useDebounce</code></li>
</ul>
<h4 data-id="heading-33">返回值规范</h4>
<ul>
<li>
<p><strong>单个值</strong>：直接返回</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> debouncedValue = <span class="hljs-title function_">useDebounce</span>(value);
</code></pre>
</li>
<li>
<p><strong>两个值</strong>：返回数组（类似 useState）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();
<span class="hljs-keyword">const</span> [isOpen, { toggle }] = <span class="hljs-title function_">useToggle</span>();
</code></pre>
</li>
<li>
<p><strong>多个值</strong>：返回对象</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { loading, data, error, execute } = <span class="hljs-title function_">useAsync</span>(fetchData);
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-34">实战案例：完整的列表刷新方案</h3>
<p>结合多个 Hook 模式，实现一个完整的列表页：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRefreshTrigger } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useRefreshTrigger'</span>;
<span class="hljs-keyword">import</span> { useDebounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useDebounce'</span>;
<span class="hljs-keyword">import</span> { useAsync } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useAsync'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">QualityInspectionRecords</span>(<span class="hljs-params">{ route, navigation }</span>) {
  <span class="hljs-comment">// 1. 刷新触发器</span>
  <span class="hljs-keyword">const</span> [refreshTrigger, triggerRefresh] = <span class="hljs-title function_">useRefreshTrigger</span>();
  
  <span class="hljs-comment">// 2. 搜索防抖</span>
  <span class="hljs-keyword">const</span> [searchTerm, setSearchTerm] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> debouncedSearchTerm = <span class="hljs-title function_">useDebounce</span>(searchTerm, <span class="hljs-number">300</span>);
  
  <span class="hljs-comment">// 3. 异步数据加载</span>
  <span class="hljs-keyword">const</span> { loading, data, execute } = <span class="hljs-title function_">useAsync</span>(fetchRecords);
  
  <span class="hljs-comment">// 4. 加载数据</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">execute</span>(route.<span class="hljs-property">params</span>?.<span class="hljs-property">outsourcingId</span>, debouncedSearchTerm);
  }, [route.<span class="hljs-property">params</span>?.<span class="hljs-property">outsourcingId</span>, debouncedSearchTerm, refreshTrigger]);
  
  <span class="hljs-comment">// 5. 刷新函数</span>
  <span class="hljs-keyword">const</span> refresh = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">triggerRefresh</span>();
  }, [triggerRefresh]);
  
  <span class="hljs-comment">// 6. 渲染</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SearchBar</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{searchTerm}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{setSearchTerm}</span> /&gt;</span>
      
      {loading ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">Loading</span> /&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">FlatList</span>
          <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span>
          <span class="hljs-attr">renderItem</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">item</span> }) =&gt;</span> (
            <span class="hljs-tag">&lt;<span class="hljs-name">View</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">FileUpload</span> 
                <span class="hljs-attr">id</span>=<span class="hljs-string">{item.id}</span> 
                <span class="hljs-attr">refreshTrigger</span>=<span class="hljs-string">{refreshTrigger}</span> // <span class="hljs-attr">传递触发器</span>
              /&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> 
                <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> navigation.navigate('Edit', {
                  item,
                  onBack: refresh, // 编辑完成后刷新
                })}
              &gt;
                编辑
              <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
          )}
        /&gt;
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h3 data-id="heading-35">总结</h3>
<p>Hook 模式的核心是<strong>关注点分离</strong>和<strong>逻辑复用</strong>。通过将常见的状态逻辑封装成 Hook，我们可以：</p>
<ol>
<li>✅ 减少重复代码</li>
<li>✅ 提高代码可读性</li>
<li>✅ 简化组件逻辑</li>
<li>✅ 提升可维护性</li>
<li>✅ 便于单元测试</li>
</ol>
<p>触发器模式只是其中一种，掌握这些模式后，你会发现 React 开发变得更加优雅和高效。</p>
<hr/>
<h3 data-id="heading-36">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact" target="_blank" title="https://react.dev/reference/react" ref="nofollow noopener noreferrer">React Hooks 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fusehooks.com%2F" target="_blank" title="https://usehooks.com/" ref="nofollow noopener noreferrer">usehooks.com</a> - Hook 示例集合</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fahooks.js.org%2F" target="_blank" title="https://ahooks.js.org/" ref="nofollow noopener noreferrer">ahooks</a> - 阿里开源的 Hook 库</li>
</ul>
<hr/>
<p><strong>作者：</strong> [你的名字]<br/>
<strong>日期：</strong> 2026-01-10<br/>
<strong>标签：</strong> React, Hooks, 设计模式, 最佳实践</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native Hooks 快速参考卡]]></title>    <link>https://juejin.cn/post/7593261984189317170</link>    <guid>https://juejin.cn/post/7593261984189317170</guid>    <pubDate>2026-01-10T05:33:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593261984189317170" data-draft-id="7593212374921822235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native Hooks 快速参考卡"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2026-01-10T05:33:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨狂之逸才"/> <meta itemprop="url" content="https://juejin.cn/user/624178332441166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native Hooks 快速参考卡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178332441166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨狂之逸才
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:33:39.000Z" title="Sat Jan 10 2026 05:33:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native Hooks 快速参考卡</h2>
<h3 data-id="heading-1">🎯 项目自定义 Hooks</h3>
<h4 data-id="heading-2">useRefreshTrigger</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRefreshTrigger } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks'</span>;

<span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> <span class="hljs-attr">refreshTrigger</span>=<span class="hljs-string">{trigger}</span> /&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{fire}</span>&gt;</span>刷新<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-3">useToggle</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useToggle } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks'</span>;

<span class="hljs-keyword">const</span> [isOpen, { toggle, setTrue, setFalse }] = <span class="hljs-title function_">useToggle</span>(<span class="hljs-literal">false</span>);
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">visible</span>=<span class="hljs-string">{isOpen}</span> <span class="hljs-attr">onClose</span>=<span class="hljs-string">{setFalse}</span> /&gt;</span></span>
</code></pre>
<h4 data-id="heading-4">useDebounce</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useDebounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks'</span>;

<span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> debouncedText = <span class="hljs-title function_">useDebounce</span>(text, <span class="hljs-number">500</span>);
</code></pre>
<h4 data-id="heading-5">useAsync</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useAsync } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks'</span>;

<span class="hljs-keyword">const</span> { loading, data, error, execute } = <span class="hljs-title function_">useAsync</span>(fetchData);
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-title function_">execute</span>(id); }, [id]);
</code></pre>
<h4 data-id="heading-6">usePrevious</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { usePrevious } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks'</span>;

<span class="hljs-keyword">const</span> prevValue = <span class="hljs-title function_">usePrevious</span>(currentValue);
</code></pre>
<hr/>
<h3 data-id="heading-7">📦 推荐第三方库</h3>
<h4 data-id="heading-8">ahooks（推荐安装）</h4>
<pre><code class="hljs language-bash" lang="bash">yarn add ahooks
</code></pre>
<h5 data-id="heading-9">状态管理</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useBoolean, useToggle, useSet, useMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'ahooks'</span>;

<span class="hljs-keyword">const</span> [state, { toggle, setTrue, setFalse }] = <span class="hljs-title function_">useBoolean</span>(<span class="hljs-literal">false</span>);
</code></pre>
<h5 data-id="heading-10">副作用</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useDebounce, useThrottle, useInterval } <span class="hljs-keyword">from</span> <span class="hljs-string">'ahooks'</span>;

<span class="hljs-keyword">const</span> debouncedValue = <span class="hljs-title function_">useDebounce</span>(value, { <span class="hljs-attr">wait</span>: <span class="hljs-number">500</span> });
</code></pre>
<h5 data-id="heading-11">数据请求</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">'ahooks'</span>;

<span class="hljs-keyword">const</span> { data, loading, error, run, refresh } = <span class="hljs-title function_">useRequest</span>(getUser, {
  <span class="hljs-attr">manual</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">debounceWait</span>: <span class="hljs-number">300</span>,
  <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data),
});
</code></pre>
<h5 data-id="heading-12">生命周期</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useMount, useUnmount, useUpdateEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'ahooks'</span>;

<span class="hljs-title function_">useMount</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件挂载'</span>));
<span class="hljs-title function_">useUnmount</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件卸载'</span>));
<span class="hljs-title function_">useUpdateEffect</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'更新，跳过首次'</span>), [dep]);
</code></pre>
<hr/>
<h4 data-id="heading-13">@react-native-community/hooks</h4>
<pre><code class="hljs language-bash" lang="bash">yarn add @react-native-community/hooks
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  useAppState,        <span class="hljs-comment">// 应用前后台状态</span>
  useBackHandler,     <span class="hljs-comment">// Android 返回键</span>
  useClipboard,       <span class="hljs-comment">// 剪贴板</span>
  useDimensions,      <span class="hljs-comment">// 屏幕尺寸</span>
  useKeyboard,        <span class="hljs-comment">// 键盘状态</span>
  useDeviceOrientation, <span class="hljs-comment">// 设备方向</span>
  useLayout,          <span class="hljs-comment">// 组件布局</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-community/hooks'</span>;

<span class="hljs-comment">// 应用状态</span>
<span class="hljs-keyword">const</span> appState = <span class="hljs-title function_">useAppState</span>(); <span class="hljs-comment">// 'active' | 'background' | 'inactive'</span>

<span class="hljs-comment">// 返回键</span>
<span class="hljs-title function_">useBackHandler</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 返回 true 阻止默认行为</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
});

<span class="hljs-comment">// 剪贴板</span>
<span class="hljs-keyword">const</span> [data, setString] = <span class="hljs-title function_">useClipboard</span>();

<span class="hljs-comment">// 屏幕尺寸</span>
<span class="hljs-keyword">const</span> { screen, <span class="hljs-variable language_">window</span> } = <span class="hljs-title function_">useDimensions</span>();

<span class="hljs-comment">// 键盘</span>
<span class="hljs-keyword">const</span> keyboard = <span class="hljs-title function_">useKeyboard</span>();
<span class="hljs-comment">// keyboard.keyboardShown: boolean</span>
<span class="hljs-comment">// keyboard.keyboardHeight: number</span>

<span class="hljs-comment">// 设备方向</span>
<span class="hljs-keyword">const</span> orientation = <span class="hljs-title function_">useDeviceOrientation</span>(); <span class="hljs-comment">// 'portrait' | 'landscape'</span>

<span class="hljs-comment">// 布局</span>
<span class="hljs-keyword">const</span> { onLayout, width, height, x, y } = <span class="hljs-title function_">useLayout</span>();
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">onLayout</span>=<span class="hljs-string">{onLayout}</span> /&gt;</span></span>
</code></pre>
<hr/>
<h4 data-id="heading-14">react-hook-form</h4>
<pre><code class="hljs language-bash" lang="bash">yarn add react-hook-form
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useForm, <span class="hljs-title class_">Controller</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-hook-form'</span>;

<span class="hljs-keyword">const</span> { control, handleSubmit, <span class="hljs-attr">formState</span>: { errors } } = <span class="hljs-title function_">useForm</span>();

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Controller</span>
  <span class="hljs-attr">control</span>=<span class="hljs-string">{control}</span>
  <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span>
  <span class="hljs-attr">rules</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">required:</span> '<span class="hljs-attr">必填</span>' }}
  <span class="hljs-attr">render</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">field:</span> { <span class="hljs-attr">onChange</span>, <span class="hljs-attr">value</span> } }) =&gt;</span> (
    <span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">onChangeText</span>=<span class="hljs-string">{onChange}</span> /&gt;</span>
  )}
/&gt;</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">@tanstack/react-query</h4>
<pre><code class="hljs language-bash" lang="bash">yarn add @tanstack/react-query
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useQuery, useMutation } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;

<span class="hljs-comment">// 查询</span>
<span class="hljs-keyword">const</span> { data, isLoading, error, refetch } = <span class="hljs-title function_">useQuery</span>({
  <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'users'</span>],
  <span class="hljs-attr">queryFn</span>: fetchUsers,
  <span class="hljs-attr">staleTime</span>: <span class="hljs-number">5000</span>,
});

<span class="hljs-comment">// 修改</span>
<span class="hljs-keyword">const</span> mutation = <span class="hljs-title function_">useMutation</span>({
  <span class="hljs-attr">mutationFn</span>: createUser,
  <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">() =&gt;</span> {
    queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'users'</span>] });
  },
});
</code></pre>
<hr/>
<h4 data-id="heading-16">zustand</h4>
<pre><code class="hljs language-bash" lang="bash">yarn add zustand
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;

<span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
}));

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span>);
<span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">increment</span>);
</code></pre>
<hr/>
<h4 data-id="heading-17">@react-navigation/native</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  useNavigation,
  useRoute,
  useFocusEffect,
  useIsFocused,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-navigation/native'</span>;

<span class="hljs-keyword">const</span> navigation = <span class="hljs-title function_">useNavigation</span>();
<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>();
<span class="hljs-keyword">const</span> isFocused = <span class="hljs-title function_">useIsFocused</span>();

<span class="hljs-title function_">useFocusEffect</span>(
  <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 页面聚焦时执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 页面失焦时执行</span>
    };
  }, [])
);
</code></pre>
<hr/>
<h3 data-id="heading-18">🔥 常见场景速查</h3>
<h4 data-id="heading-19">搜索防抖</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [keyword, setKeyword] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> debouncedKeyword = <span class="hljs-title function_">useDebounce</span>(keyword, <span class="hljs-number">500</span>);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (debouncedKeyword) {
    <span class="hljs-title function_">searchAPI</span>(debouncedKeyword);
  }
}, [debouncedKeyword]);
</code></pre>
<h4 data-id="heading-20">模态框控制</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [visible, { <span class="hljs-attr">setTrue</span>: open, <span class="hljs-attr">setFalse</span>: close }] = <span class="hljs-title function_">useToggle</span>(<span class="hljs-literal">false</span>);

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">visible</span>=<span class="hljs-string">{visible}</span> <span class="hljs-attr">onClose</span>=<span class="hljs-string">{close}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{close}</span>&gt;</span>关闭<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-21">列表刷新</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [refreshTrigger, triggerRefresh] = <span class="hljs-title function_">useRefreshTrigger</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">refresh</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">fetchData</span>();
  <span class="hljs-title function_">triggerRefresh</span>();
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FlatList</span>
  <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span>
  <span class="hljs-attr">renderItem</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">item</span> }) =&gt;</span> (
    <span class="hljs-tag">&lt;<span class="hljs-name">ItemCard</span> <span class="hljs-attr">refreshTrigger</span>=<span class="hljs-string">{refreshTrigger}</span> /&gt;</span>
  )}
/&gt;</span>
</code></pre>
<h4 data-id="heading-22">键盘适配</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> keyboard = <span class="hljs-title function_">useKeyboard</span>();

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeyboardAvoidingView</span>
  <span class="hljs-attr">behavior</span>=<span class="hljs-string">{Platform.OS</span> === <span class="hljs-string">'ios'</span> ? '<span class="hljs-attr">padding</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">height</span>'}
  <span class="hljs-attr">keyboardVerticalOffset</span>=<span class="hljs-string">{keyboard.keyboardHeight}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">KeyboardAvoidingView</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-23">页面聚焦刷新</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useFocusEffect</span>(
  <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchData</span>();
  }, [])
);
</code></pre>
<h4 data-id="heading-24">返回键拦截</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useBackHandler</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (hasUnsavedChanges) {
    <span class="hljs-title class_">Alert</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'提示'</span>, <span class="hljs-string">'有未保存的更改'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 阻止返回</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 允许返回</span>
});
</code></pre>
<h4 data-id="heading-25">异步数据加载</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { loading, data, error, execute } = <span class="hljs-title function_">useAsync</span>(fetchUser);

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">execute</span>(userId);
}, [userId]);

<span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Loading</span> /&gt;</span></span>;
<span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Error</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{error.message}</span> /&gt;</span></span>;
<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>;
</code></pre>
<h4 data-id="heading-26">表单验证</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { control, handleSubmit, <span class="hljs-attr">formState</span>: { errors } } = <span class="hljs-title function_">useForm</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onSubmit</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Controller</span>
  <span class="hljs-attr">control</span>=<span class="hljs-string">{control}</span>
  <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span>
  <span class="hljs-attr">rules</span>=<span class="hljs-string">{{</span>
    <span class="hljs-attr">required:</span> '<span class="hljs-attr">邮箱必填</span>',
    <span class="hljs-attr">pattern:</span> {
      <span class="hljs-attr">value:</span> /^[<span class="hljs-attr">A-Z0-9._</span>%+<span class="hljs-attr">-</span>]+@[<span class="hljs-attr">A-Z0-9.-</span>]+\<span class="hljs-attr">.</span>[<span class="hljs-attr">A-Z</span>]{<span class="hljs-attr">2</span>,}$/<span class="hljs-attr">i</span>,
      <span class="hljs-attr">message:</span> '<span class="hljs-attr">邮箱格式不正确</span>'
    }
  }}
  <span class="hljs-attr">render</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">field:</span> { <span class="hljs-attr">onChange</span>, <span class="hljs-attr">value</span> } }) =&gt;</span> (
    <span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">onChangeText</span>=<span class="hljs-string">{onChange}</span> /&gt;</span>
  )}
/&gt;</span>
{errors.<span class="hljs-property">email</span> &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>{errors.email.message}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span></span>}
&lt;<span class="hljs-title class_">Button</span> onPress={<span class="hljs-title function_">handleSubmit</span>(onSubmit)}&gt;提交&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<hr/>
<h3 data-id="heading-27">📖 完整文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=.%2FReact_Hook_Advanced_Patterns.md" target="_blank" title="./React_Hook_Advanced_Patterns.md" ref="nofollow noopener noreferrer">React Hook 高级模式</a></li>
<li><a href="https://link.juejin.cn?target=.%2Ftrigger-pattern-diagram.md" target="_blank" title="./trigger-pattern-diagram.md" ref="nofollow noopener noreferrer">触发器模式详解</a></li>
<li><a href="https://link.juejin.cn?target=.%2FReact_Native_Hooks_Libraries_Guide.md" target="_blank" title="./React_Native_Hooks_Libraries_Guide.md" ref="nofollow noopener noreferrer">React Native Hooks 库指南</a></li>
<li><a href="https://link.juejin.cn?target=..%2Fsrc%2Fhooks%2FREADME.md" target="_blank" title="../src/hooks/README.md" ref="nofollow noopener noreferrer">项目 Hooks 使用指南</a></li>
</ul>
<hr/>
<p><strong>提示：</strong> 将此文件保存为书签，随时查阅！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[useRefreshTrigger触发器模式工作流程图解]]></title>    <link>https://juejin.cn/post/7593234983755694090</link>    <guid>https://juejin.cn/post/7593234983755694090</guid>    <pubDate>2026-01-10T05:36:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593234983755694090" data-draft-id="7593212374921838619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="useRefreshTrigger触发器模式工作流程图解"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2026-01-10T05:36:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨狂之逸才"/> <meta itemprop="url" content="https://juejin.cn/user/624178332441166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            useRefreshTrigger触发器模式工作流程图解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178332441166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨狂之逸才
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:36:07.000Z" title="Sat Jan 10 2026 05:36:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">触发器模式工作流程图解</h2>
<h3 data-id="heading-1">完整数据流</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                        用户操作流程                              │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │  用户点击"编辑"按钮     │
                    └────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │  进入编辑页面 EditQa    │
                    │  修改图片并保存         │
                    └────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │  调用 <span class="hljs-built_in">onBack</span>() 回调     │
                    └────────────────────────┘
                                 │
┌────────────────────────────────┴────────────────────────────────┐
│                        父组件 (列表页)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  const <span class="hljs-selector-attr">[refreshTrigger, triggerRefresh]</span> = <span class="hljs-built_in">useRefreshTrigger</span>();  │
│                                                                  │
│  const refresh = () =&gt; {                                        │
│    <span class="hljs-built_in">query</span>({ ... });           <span class="hljs-comment">// ← 1. 刷新列表数据               │</span>
│    <span class="hljs-built_in">triggerRefresh</span>();         <span class="hljs-comment">// ← 2. 触发图片刷新               │</span>
│  };                                                              │
│                                                                  │
│  ┌──────────────────────────────────────────────────┐          │
│  │  <span class="hljs-built_in">triggerRefresh</span>() 执行过程：                      │          │
│  │                                                   │          │
│  │  <span class="hljs-built_in">setTrigger</span>(prev =&gt; prev + <span class="hljs-number">1</span>)                    │          │
│  │       │                                           │          │
│  │       ▼                                           │          │
│  │  refreshTrigger: <span class="hljs-number">0</span> → <span class="hljs-number">1</span> → <span class="hljs-number">2</span> → <span class="hljs-number">3</span> ...              │          │
│  └──────────────────────────────────────────────────┘          │
│                                                                  │
│  &lt;FileUpload                                                    │
│    id={problem<span class="hljs-selector-class">.id</span>}                                              │
│    refreshTrigger={refreshTrigger}  <span class="hljs-comment">// ← 传递触发器值           │</span>
│  /&gt;                                                              │
│                                                                  │
└──────────────────────────┬───────────────────────────────────────┘
                           │ props 传递
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                    子组件 (FileUpload)                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  function <span class="hljs-built_in">FileUpload</span>({ id, refreshTrigger }) {                  │
│    const <span class="hljs-selector-attr">[pictures, setPictures]</span> = <span class="hljs-built_in">useState</span>([]);                │
│                                                                  │
│    <span class="hljs-built_in">useEffect</span>(() =&gt; {                                            │
│      if (id) {                                                  │
│        <span class="hljs-built_in">getFileInfos</span>({ query: { fkId: id } })                   │
│          <span class="hljs-selector-class">.then</span>(res =&gt; setPictures(res));                        │
│      }                                                           │
│    }, <span class="hljs-selector-attr">[id, refreshTrigger]</span>);  <span class="hljs-comment">// ← 依赖 refreshTrigger          │</span>
│                                                                  │
│    ┌──────────────────────────────────────────────┐            │
│    │  React 检测依赖变化：                         │            │
│    │                                               │            │
│    │  refreshTrigger 从 <span class="hljs-number">0</span> 变成 <span class="hljs-number">1</span>                  │            │
│    │       ↓                                       │            │
│    │  useEffect 重新执行                           │            │
│    │       ↓                                       │            │
│    │  发起新的图片请求                             │            │
│    │       ↓                                       │            │
│    │  <span class="hljs-built_in">setPictures</span>(新数据)                          │            │
│    │       ↓                                       │            │
│    │  组件重新渲染，显示新图片                     │            │
│    └──────────────────────────────────────────────┘            │
│                                                                  │
│    return &lt;<span class="hljs-selector-tag">img</span> <span class="hljs-attribute">src</span>={pictures<span class="hljs-selector-attr">[0]</span><span class="hljs-selector-class">.url</span>} /&gt;;                        │
│  }                                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-2">关键点解析</h3>
<h4 data-id="heading-3">1. 为什么用数字而不是布尔值？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 使用布尔值的问题</span>
<span class="hljs-keyword">const</span> [refresh, setRefresh] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">triggerRefresh</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setRefresh</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setRefresh</span>(<span class="hljs-literal">false</span>), <span class="hljs-number">0</span>); <span class="hljs-comment">// 需要重置</span>
};

<span class="hljs-comment">// 连续两次调用会失效：</span>
<span class="hljs-title function_">triggerRefresh</span>(); <span class="hljs-comment">// true</span>
<span class="hljs-title function_">triggerRefresh</span>(); <span class="hljs-comment">// 还是 true，没有变化！</span>


<span class="hljs-comment">// ✅ 使用数字的优势</span>
<span class="hljs-keyword">const</span> [trigger, setTrigger] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">triggerRefresh</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTrigger</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
};

<span class="hljs-comment">// 每次调用都会变化：</span>
<span class="hljs-title function_">triggerRefresh</span>(); <span class="hljs-comment">// 0 → 1</span>
<span class="hljs-title function_">triggerRefresh</span>(); <span class="hljs-comment">// 1 → 2</span>
<span class="hljs-title function_">triggerRefresh</span>(); <span class="hljs-comment">// 2 → 3</span>
</code></pre>
<h4 data-id="heading-4">2. 为什么不用 key 强制重新挂载？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 使用 key 的问题</span>
&lt;<span class="hljs-title class_">FileUpload</span> key={<span class="hljs-string">`<span class="hljs-subst">${id}</span>-<span class="hljs-subst">${timestamp}</span>`</span>} id={id} /&gt;

<span class="hljs-comment">// 组件生命周期：</span>
<span class="hljs-comment">// 1. 卸载旧组件 (componentWillUnmount)</span>
<span class="hljs-comment">// 2. 销毁所有状态和 DOM</span>
<span class="hljs-comment">// 3. 挂载新组件 (componentDidMount)</span>
<span class="hljs-comment">// 4. 重新初始化所有状态</span>
<span class="hljs-comment">// 5. 重新渲染 DOM</span>

<span class="hljs-comment">// 性能开销大，可能导致：</span>
<span class="hljs-comment">// - 闪烁</span>
<span class="hljs-comment">// - 动画中断</span>
<span class="hljs-comment">// - 滚动位置丢失</span>
<span class="hljs-comment">// - 输入焦点丢失</span>


<span class="hljs-comment">// ✅ 使用 refreshTrigger 的优势</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FileUpload</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{id}</span> <span class="hljs-attr">refreshTrigger</span>=<span class="hljs-string">{trigger}</span> /&gt;</span></span>

<span class="hljs-comment">// 组件生命周期：</span>
<span class="hljs-comment">// 1. 组件保持挂载状态</span>
<span class="hljs-comment">// 2. 只执行 useEffect 回调</span>
<span class="hljs-comment">// 3. 只更新需要更新的数据</span>
<span class="hljs-comment">// 4. 保留其他状态和 DOM</span>

<span class="hljs-comment">// 性能好，用户体验流畅</span>
</code></pre>
<h4 data-id="heading-5">3. 为什么要封装成 Hook？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不封装的问题</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component1</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [trigger, setTrigger] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fire</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setTrigger</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component2</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [trigger, setTrigger] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fire</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setTrigger</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  <span class="hljs-comment">// ... 重复代码</span>
}


<span class="hljs-comment">// ✅ 封装成 Hook 的优势</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component1</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();
  <span class="hljs-comment">// 简洁、可复用</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component2</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();
  <span class="hljs-comment">// 同样简洁</span>
}
</code></pre>
<h3 data-id="heading-6">对比其他方案</h3>








































<table><thead><tr><th>方案</th><th>性能</th><th>易用性</th><th>可维护性</th><th>推荐度</th></tr></thead><tbody><tr><td><strong>触发器模式</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>✅ 强烈推荐</td></tr><tr><td>key 强制重挂载</td><td>⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⚠️ 不推荐</td></tr><tr><td>ref 命令式调用</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐</td><td>⚠️ 不推荐</td></tr><tr><td>布尔值切换</td><td>⭐⭐⭐⭐</td><td>⭐⭐</td><td>⭐⭐</td><td>⚠️ 不推荐</td></tr></tbody></table>
<h3 data-id="heading-7">实际应用场景</h3>
<h4 data-id="heading-8">场景 1：列表刷新</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FlatList</span>
  <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span>
  <span class="hljs-attr">renderItem</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">item</span> }) =&gt;</span> (
    <span class="hljs-tag">&lt;<span class="hljs-name">ItemCard</span> <span class="hljs-attr">refreshTrigger</span>=<span class="hljs-string">{trigger}</span> /&gt;</span>
  )}
/&gt;</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{fire}</span>&gt;</span>刷新全部<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-9">场景 2：表单重置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span> <span class="hljs-attr">resetTrigger</span>=<span class="hljs-string">{trigger}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Select</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{fire}</span>&gt;</span>重置表单<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-10">场景 3：图表重绘</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Chart</span> 
  <span class="hljs-attr">data</span>=<span class="hljs-string">{chartData}</span>
  <span class="hljs-attr">redrawTrigger</span>=<span class="hljs-string">{trigger}</span>
/&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{fire}</span>&gt;</span>刷新图表<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-11">场景 4：WebSocket 重连</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [trigger, fire] = <span class="hljs-title function_">useRefreshTrigger</span>();

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url);
  <span class="hljs-comment">// ... 连接逻辑</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> ws.<span class="hljs-title function_">close</span>();
}, [trigger]);

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{fire}</span>&gt;</span>重新连接<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-12">总结</h3>
<p>触发器模式的本质是：</p>
<blockquote>
<p><strong>通过一个简单的、可预测的值变化，来触发复杂的、可控的副作用</strong></p>
</blockquote>
<p>这种模式：</p>
<ul>
<li>✅ 符合 React 的声明式理念</li>
<li>✅ 保持单向数据流</li>
<li>✅ 性能优秀</li>
<li>✅ 易于理解和维护</li>
<li>✅ 可复用性强</li>
</ul>
<p>掌握这个模式，你就掌握了 React 状态管理的精髓！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis慢查询分析与优化：性能瓶颈排查实战指南]]></title>    <link>https://juejin.cn/post/7593240931287187508</link>    <guid>https://juejin.cn/post/7593240931287187508</guid>    <pubDate>2026-01-10T05:40:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593240931287187508" data-draft-id="7490784514842361906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis慢查询分析与优化：性能瓶颈排查实战指南"/> <meta itemprop="keywords" content="Redis,数据库,性能优化"/> <meta itemprop="datePublished" content="2026-01-10T05:40:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Go高并发架构_王工"/> <meta itemprop="url" content="https://juejin.cn/user/446863555701561"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis慢查询分析与优化：性能瓶颈排查实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/446863555701561/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Go高并发架构_王工
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:40:47.000Z" title="Sat Jan 10 2026 05:40:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、前言</h4>
<p>在现代后端开发中，Redis凭借其超高的内存操作性能和丰富的数据结构，已成为许多高并发场景下的“标配”数据库。无论是电商秒杀、实时排行榜，还是分布式锁和缓存，Redis的身影无处不在。然而，正如一辆跑车如果油路不畅就无法发挥全部马力，Redis的性能也可能因为慢查询问题而大打折扣。慢查询就像系统中的“隐形杀手”，悄无声息地拖慢响应时间、降低吞吐量，甚至引发连锁反应，让线上服务雪上加霜。</p>
<p>我从事Redis开发已有10年，从初学者到如今负责过多个大型项目的性能优化，踩过的坑和积累的经验让我深刻体会到：慢查询不仅是技术问题，更是业务稳定的关键一环。记得有一次，某电商秒杀活动中，慢查询导致订单处理延迟，最终引发用户投诉。那一刻我意识到，仅仅会用Redis远远不够，真正的高手需要能“驯服”它，找到并解决性能瓶颈。</p>
<p>这篇文章的目标读者是那些有1-2年Redis开发经验的开发者。你可能已经熟悉基本的SET/GET操作，也能写出简单的Lua脚本，但面对线上慢查询问题时，却不知道从何下手。别担心，我会带你从零开始，逐步掌握慢查询的分析与优化技巧。文章的核心亮点在于：</p>
<ul>
<li><strong>实战导向</strong>：从发现问题到优化落地，提供一步步可操作的方案。</li>
<li><strong>项目经验</strong>：分享真实案例和踩坑教训，让你少走弯路。</li>
<li><strong>代码示例</strong>：提供可直接复用的脚本和命令，拿来即用。</li>
</ul>
<p>无论你是想提升技术能力，还是准备应对下一次线上事故，这篇文章都将是你的“实战指南”。接下来，我们将从慢查询的基础知识入手，逐步深入到分析工具、优化策略和完整排查流程。希望你在读完后，不仅能理解慢查询的本质，还能自信地解决实际问题。让我们开始吧！</p>
<p><strong>过渡到下一节</strong>：在深入分析和优化之前，我们先要打好基础——理解什么是慢查询，以及Redis是如何记录它们的。只有掌握这些基本概念，我们才能在后续章节中游刃有余地排查和解决问题。</p>
<hr/>
<h4 data-id="heading-1">二、Redis慢查询基础知识</h4>
<p>Redis的慢查询问题看似复杂，但本质上并不神秘。只要掌握它的定义、工作原理和潜在影响，你就能为后续的分析与优化打下坚实基础。本节将带你了解慢查询的基本概念，剖析Redis的日志机制，并通过一个真实场景说明为何慢查询值得我们重视。</p>
<h5 data-id="heading-2">1. 什么是Redis慢查询</h5>
<p>简单来说，Redis中的慢查询是指执行时间超过某个阈值的命令。就像一场马拉松，跑得太慢的选手会被特别标记，慢查询也是如此。Redis通过两个关键配置参数来定义和管理它：</p>
<ul>
<li><strong><code>slowlog-log-slower-than</code></strong>：慢查询的阈值，单位是微秒（μs）。比如设置为10000（即10毫秒），任何执行时间超过10ms的命令都会被记录。</li>
<li><strong><code>slowlog-max-len</code></strong>：慢查询日志的最大条数，采用循环队列存储，超出时会覆盖最早的记录。</li>
</ul>
<p>假设你把阈值设为5ms，日志长度设为100，那么Redis会记录最近100条执行时间超过5ms的命令。这两个参数可以在<code>redis.conf</code>中配置，也可以通过<code>CONFIG SET</code>命令动态调整。</p>
<h5 data-id="heading-3">2. 慢查询日志的工作原理</h5>
<p>Redis的慢查询日志由<code>SLOWLOG</code>机制驱动，内置于Redis核心，无需额外插件。它就像一个“黑匣子”，默默记录每次“超速”的命令细节。日志的记录过程非常高效，不会显著影响Redis的性能。具体来说，每次命令执行后，Redis会：</p>
<ol>
<li>计算命令的执行时间（不包括网络传输时间）。</li>
<li>如果超过阈值，就将其写入慢查询日志。</li>
</ol>
<p>你可以用<code>SLOWLOG GET [n]</code>命令查看日志，其中<code>n</code>指定返回的条数。每条日志包含以下字段：</p>








































<table><thead><tr><th>字段名</th><th>含义</th><th>示例值</th></tr></thead><tbody><tr><td>id</td><td>日志的唯一标识</td><td>12345</td></tr><tr><td>timestamp</td><td>命令执行的时间戳</td><td>1617182400</td></tr><tr><td>duration</td><td>执行耗时（微秒）</td><td>15234</td></tr><tr><td>command</td><td>完整命令及其参数</td><td>"HGETALL user:1001"</td></tr><tr><td>client_addr</td><td>客户端地址（可选）</td><td>"127.0.0.1:54321"</td></tr><tr><td>client_name</td><td>客户端名称（可选）</td><td>"web-app"</td></tr></tbody></table>
<p><strong>示意图</strong>：慢查询日志记录流程</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[命令执行]</span> → <span class="hljs-selector-attr">[计算耗时]</span> → <span class="hljs-selector-attr">[比对阈值]</span> → <span class="hljs-selector-attr">[记录到慢查询日志]</span> → <span class="hljs-selector-attr">[存储到循环队列]</span>
</code></pre>
<h5 data-id="heading-4">3. 为何要关注慢查询</h5>
<p>慢查询的影响远不止“命令跑得慢”这么简单。它就像水管中的堵塞点，可能导致系统延迟上升、吞吐量下降，甚至引发业务故障。以一个电商秒杀场景为例：假设某个活动中有大量用户查询库存，开发者不小心用了<code>KEYS *</code>命令扫描所有键，结果每次执行耗时50ms。在高并发下，这不仅拖慢了响应，还占用了Redis的单线程处理能力，最终导致请求堆积，用户体验直线下降。</p>
<p>我在一次项目中就遇到过类似问题。当时系统QPS从平时的5000骤降到1000，排查后发现是某个大Hash的<code>HGETALL</code>操作引发的慢查询。解决后，性能恢复不说，用户的投诉也明显减少。这让我深刻体会到：慢查询不仅是技术细节，更是业务稳定的命脉。</p>
<p><strong>过渡到下一节</strong>：现在你已经了解了慢查询的定义和原理，接下来我们将进入实战环节——如何获取和分析慢查询日志。通过具体的工具和方法，你将学会从海量命令中找出“罪魁祸首”，为优化打下基础。让我们继续前行！</p>
<hr/>
<h4 data-id="heading-5">三、慢查询分析的核心工具与方法</h4>
<p>了解了慢查询的基础知识后，我们终于要进入实战环节了。分析慢查询就像侦探破案，需要从线索（日志）入手，结合工具和经验，找出性能瓶颈的根源。本节将带你掌握获取慢查询日志的方法，剖析常见的慢查询模式，并分享如何借助外部工具提升效率。有了这些技能，你就能迅速锁定问题，为优化做好准备。</p>
<h5 data-id="heading-6">1. 获取慢查询日志</h5>
<p>Redis提供了内置命令<code>SLOWLOG GET</code>来查看慢查询记录，这是分析的第一步。它的用法很简单，比如<code>SLOWLOG GET 10</code>会返回最近10条慢查询日志。为了方便自动化分析，我通常会用脚本批量拉取日志。以下是一个Python示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> redis

<span class="hljs-comment"># 连接Redis实例</span>
r = redis.Redis(host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-number">6379</span>, db=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 获取最近10条慢查询日志</span>
slow_logs = r.slowlog_get(<span class="hljs-number">10</span>)

<span class="hljs-comment"># 遍历并打印日志详情</span>
<span class="hljs-keyword">for</span> log <span class="hljs-keyword">in</span> slow_logs:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{log[<span class="hljs-string">'id'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Timestamp: <span class="hljs-subst">{log[<span class="hljs-string">'timestamp'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Command: <span class="hljs-subst">{log[<span class="hljs-string">'command'</span>].decode(<span class="hljs-string">'utf-8'</span>)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Duration: <span class="hljs-subst">{log[<span class="hljs-string">'duration'</span>]}</span>μs"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Client: <span class="hljs-subst">{log.get(<span class="hljs-string">'client_addr'</span>, <span class="hljs-string">'N/A'</span>)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">30</span>)
</code></pre>
<p><strong>代码注释说明</strong>：</p>
<ul>
<li><code>redis.Redis</code>：初始化Redis客户端连接。</li>
<li><code>slowlog_get(10)</code>：获取最近10条慢查询，返回一个列表。</li>
<li><code>log['command'].decode('utf-8')</code>：命令以字节形式存储，需解码为字符串。</li>
<li><code>log.get('client_addr', 'N/A')</code>：客户端地址可能为空，用<code>get</code>避免报错。</li>
</ul>
<p>运行后，你会看到每条慢查询的详细信息，比如某个<code>HGETALL</code>耗时15234微秒。掌握这个方法后，你就可以定期检查日志，快速发现异常。</p>
<h5 data-id="heading-7">2. 分析慢查询的常见模式</h5>
<p>慢查询的“罪魁祸首”通常逃不出几种模式。以下是三种常见类型，以及我在项目中总结的特征：</p>
<ul>
<li>
<p><strong>高频命令</strong><br/>
如<code>KEYS *</code>或<code>HGETALL</code>，这些命令复杂度高（O(N)级别），在数据量大时极易变慢。比如<code>KEYS *</code>会扫描所有键，线上环境几乎是“禁忌”。</p>
</li>
<li>
<p><strong>大数据量操作</strong><br/>
操作大Hash、大List或大Set时，比如<code>LRANGE 0 -1</code>获取整个列表，或者<code>HGETALL</code>读取上千字段的Hash，耗时会显著增加。</p>
</li>
<li>
<p><strong>网络延迟与客户端问题</strong><br/>
有时慢查询并非Redis本身问题，而是客户端连接频繁断开重连，或网络抖动导致的额外开销。</p>
</li>
</ul>
<p><strong>表格</strong>：常见慢查询模式对比</p>

































<table><thead><tr><th>类型</th><th>示例命令</th><th>复杂度</th><th>典型场景</th><th>影响</th></tr></thead><tbody><tr><td>高频命令</td><td><code>KEYS *</code></td><td>O(N)</td><td>全量键扫描</td><td>CPU占用高</td></tr><tr><td>大数据量操作</td><td><code>HGETALL</code></td><td>O(N)</td><td>大Hash读取</td><td>延迟上升</td></tr><tr><td>网络问题</td><td>-</td><td>-</td><td>客户端连接不稳定</td><td>吞吐量下降</td></tr></tbody></table>
<p>通过分析日志中的<code>command</code>和<code>duration</code>，你可以快速判断问题属于哪类。比如我曾发现某服务频繁调用<code>KEYS user:*</code>，耗时高达200ms，直接拖垮了QPS。</p>
<h5 data-id="heading-8">3. 借助外部工具提升效率</h5>
<p>除了Redis自带的<code>SLOWLOG</code>，外部工具也能帮你事半功倍。以下是几种选择及其对比：</p>
<ul>
<li>
<p><strong>redis-cli</strong><br/>
直接在终端运行<code>SLOWLOG GET</code>，适合临时排查，但不方便长期监控。</p>
</li>
<li>
<p><strong>RedisInsight</strong><br/>
一个图形化工具，能可视化慢查询趋势，还支持命令分析，适合初学者。不过对资源占用稍高。</p>
</li>
<li>
<p><strong>脚本+Grafana</strong><br/>
我在项目中最常用的方案。通过脚本定期拉取慢查询数据，推送到Prometheus，再用Grafana绘制趋势图。比如某次优化前，慢查询数量每天高达500条，优化后降到50条，效果一目了然。</p>
</li>
</ul>
<p><strong>项目经验</strong>：有一次线上服务响应变慢，我用脚本发现<code>HGETALL</code>占了慢查询的80%。结合Grafana监控，确认是某个大Hash引起的。这让我意识到，工具不仅能发现问题，还能验证优化效果。</p>
<p><strong>示意图</strong>：慢查询分析流程</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[拉取日志: SLOWLOG GET]</span> → <span class="hljs-selector-attr">[分析模式: 高频/大数据/网络]</span> → <span class="hljs-selector-attr">[借助工具: redis-cli 或 Grafana]</span> → <span class="hljs-selector-attr">[定位问题]</span>
</code></pre>
<p><strong>过渡到下一节</strong>：通过本节，你已经学会如何获取和分析慢查询日志，并能识别常见问题模式。接下来，我们将进入优化实战，探讨如何通过命令调整、数据结构优化和客户端配置，彻底解决这些性能瓶颈。准备好动手优化了吗？让我们继续！</p>
<hr/>
<h4 data-id="heading-9">四、慢查询优化的实战策略</h4>
<p>分析出慢查询的“元凶”只是第一步，真正解决问题还得靠优化。优化Redis慢查询就像修剪一棵大树，既要剪掉多余的枝叶（低效命令），也要调整根系（数据结构），甚至改善土壤（客户端配置）。本节将通过具体案例和代码，带你掌握命令选择、数据结构调整和客户端优化的实战策略，并分享我在项目中踩过的坑与解决方案。准备好动手了吗？让我们开始优化之旅！</p>
<h5 data-id="heading-10">1. 优化命令选择</h5>
<p>Redis提供了丰富的命令，但并非每条都适合高并发场景。以下是两个常见案例的优化方案：</p>
<ul>
<li>
<p><strong>案例1：将 <code>KEYS *</code> 替换为 <code>SCAN</code></strong><br/>
<code>KEYS *</code>是个“全家桶”命令，会一次性扫描所有键，复杂度O(N)，数据量大时极易引发慢查询。我曾在某项目中看到它耗时300ms，直接拖慢了服务。优化方案是用<code>SCAN</code>，它支持分批迭代，性能更稳定：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 错误用法：全量扫描，耗时长</span>
KEYS user:*

<span class="hljs-comment"># 优化后：分批迭代，指定每次返回100条</span>
SCAN 0 MATCH user:* COUNT 100
</code></pre>
<p><strong>效果</strong>：优化后单次耗时降到5ms以下，QPS提升20%。</p>
</li>
<li>
<p><strong>案例2：<code>HGETALL</code> 替换为 <code>HMGET</code></strong><br/>
<code>HGETALL</code>会返回Hash的所有字段，但在字段多时（如上千个）性能堪忧。改为<code>HMGET</code>，只取需要的字段，能显著降低开销：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 错误用法：读取整个Hash</span>
HGETALL user:1001

<span class="hljs-comment"># 优化后：只取所需字段</span>
HMGET user:1001 name age
</code></pre>
<p><strong>效果</strong>：耗时从50ms降到2ms，特别适合字段固定的场景。</p>
</li>
</ul>
<h5 data-id="heading-11">2. 数据结构优化</h5>
<p>Redis的性能很大程度上取决于数据结构选择。以下是两个实用优化：</p>
<ul>
<li>
<p><strong>大List拆分为小List</strong><br/>
一个包含10万元素的List用<code>LRANGE 0 -1</code>读取，耗时可能高达秒级。我的解决办法是按业务逻辑拆分，比如按日期存为<code>list:20250408</code>，每段控制在1000条以内。读取时只取特定段：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 优化前：读取整个大List</span>
LRANGE big_list 0 -1

<span class="hljs-comment"># 优化后：分段读取</span>
LRANGE list:20250408 0 999
</code></pre>
</li>
<li>
<p><strong>使用Set替代List</strong><br/>
在需要去重的场景下，List的<code>LREM</code>操作复杂度为O(N)，而Set的<code>SREM</code>仅O(1)。我曾将某排行榜从List改为Set，慢查询数量减少80%。</p>
</li>
</ul>
<p><strong>表格</strong>：数据结构优化对比</p>


























<table><thead><tr><th>场景</th><th>原结构/命令</th><th>优化后结构/命令</th><th>复杂度变化</th><th>效果</th></tr></thead><tbody><tr><td>大List读取</td><td>List / <code>LRANGE</code></td><td>多小List / <code>LRANGE</code></td><td>O(N) → O(1)</td><td>耗时降低90%</td></tr><tr><td>去重操作</td><td>List / <code>LREM</code></td><td>Set / <code>SREM</code></td><td>O(N) → O(1)</td><td>性能提升10倍</td></tr></tbody></table>
<h5 data-id="heading-12">3. 客户端与连接优化</h5>
<p>慢查询有时并非Redis本身问题，而是客户端配置不当。以下是两招实用优化：</p>
<ul>
<li>
<p><strong>连接池配置</strong><br/>
频繁建立/释放连接会增加网络开销。使用连接池能复用连接，减少慢查询。我常用Python的<code>redis-py</code>配置如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> redis

<span class="hljs-comment"># 配置连接池</span>
pool = redis.ConnectionPool(host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-number">6379</span>, db=<span class="hljs-number">0</span>, max_connections=<span class="hljs-number">100</span>)
r = redis.Redis(connection_pool=pool)
</code></pre>
</li>
<li>
<p><strong>Pipeline批量操作</strong><br/>
单条命令的网络往返（RTT）可能只有1ms，但在高频场景下累积严重。Pipeline将多条命令打包发送，减少RTT：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">with</span> r.pipeline() <span class="hljs-keyword">as</span> pipe:
    pipe.<span class="hljs-built_in">set</span>(<span class="hljs-string">'key1'</span>, <span class="hljs-string">'value1'</span>)
    pipe.<span class="hljs-built_in">set</span>(<span class="hljs-string">'key2'</span>, <span class="hljs-string">'value2'</span>)
    pipe.execute()  <span class="hljs-comment"># 一次性执行</span>
</code></pre>
<p><strong>效果</strong>：1000次SET从2秒降到50ms，效率提升40倍。</p>
</li>
</ul>
<h5 data-id="heading-13">4. 项目经验分享</h5>
<ul>
<li>
<p><strong>踩坑案例</strong>：某次线上服务QPS从5000跌到2000，慢查询日志显示大量<code>HGETALL</code>操作。检查发现是个包含5000字段的大Hash。优化方案是将Hash分片存储为多个小Hash（如<code>user:1001:base</code>和<code>user:1001:extra</code>），并用<code>HMGET</code>替换<code>HGETALL</code>，结果QPS提升50%。</p>
</li>
<li>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>分片存储</strong>：大数据结构按业务拆分，单结构大小控制在1MB以内。</li>
<li><strong>定期清理</strong>：用<code>EXPIRE</code>设置过期时间，避免无用数据堆积。</li>
</ul>
</li>
</ul>
<p><strong>示意图</strong>：慢查询优化流程</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[识别问题: KEYS/HGETALL]</span> → <span class="hljs-selector-attr">[优化命令: SCAN/HMGET]</span> → <span class="hljs-selector-attr">[调整结构: 小List/Set]</span> → <span class="hljs-selector-attr">[客户端优化: Pipeline]</span> → <span class="hljs-selector-attr">[验证效果]</span>
</code></pre>
<p><strong>过渡到下一节</strong>：通过命令调整、数据结构优化和客户端配置，你已经掌握了慢查询优化的核心技能。但在实际项目中，性能瓶颈往往需要系统化排查。下一节将带你走进完整的排查流程，从问题定位到优化落地，彻底解决线上难题。让我们继续！</p>
<hr/>
<h4 data-id="heading-14">五、性能瓶颈排查的完整流程</h4>
<p>优化慢查询的策略固然重要，但实际项目中，性能瓶颈往往隐藏在复杂的系统中，需要一套系统化的排查流程来“抽丝剥茧”。这就像医生诊断病情，得先检查症状（日志）、分析病因（数据），再开药方（优化）。本节将带你走一遍从问题定位到优化落地的完整流程，并通过一个真实案例展示如何在压力下快速恢复服务。</p>
<h5 data-id="heading-15">1. 问题定位</h5>
<p>排查的第一步是找到“痛点”。慢查询日志是核心线索，但还需要结合系统监控来全面判断。以下是我常用的方法：</p>
<ul>
<li>
<p><strong>查看慢查询日志</strong><br/>
用<code>SLOWLOG GET</code>抓取最近的慢查询，关注耗时最长和高频的命令。</p>
</li>
<li>
<p><strong>系统监控</strong><br/>
检查CPU、内存、网络等指标。比如Redis单线程CPU占满可能说明命令阻塞，网络延迟高则可能是客户端问题。</p>
</li>
<li>
<p><strong>示例命令</strong>：用<code>INFO</code>查看Redis状态</p>
<pre><code class="hljs language-bash" lang="bash">INFO ALL
<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># used_cpu_sys: 10.5  # 系统CPU使用</span>
<span class="hljs-comment"># used_memory: 2G     # 内存占用</span>
<span class="hljs-comment"># instantaneous_ops_per_sec: 3000  # 当前QPS</span>
</code></pre>
<p><strong>经验</strong>：某次支付系统QPS从1万降到2000，我先用<code>SLOWLOG GET</code>发现大量<code>LRANGE</code>耗时超50ms，再用<code>INFO</code>确认CPU占用100%，初步锁定是大数据量操作。</p>
</li>
</ul>
<h5 data-id="heading-16">2. 分析与验证</h5>
<p>定位问题后，要深入分析原因并验证假设。以下是我的步骤：</p>
<ul>
<li>
<p><strong>分析日志</strong><br/>
检查慢查询的命令模式，比如是<code>KEYS *</code>还是大Hash操作。</p>
</li>
<li>
<p><strong>模拟压测</strong><br/>
用工具（如<code>redis-benchmark</code>）重现问题，验证是否与并发量相关：</p>
<pre><code class="hljs language-bash" lang="bash">redis-benchmark -h localhost -p 6379 -c 50 -n 10000 -q -t LRANGE
<span class="hljs-comment"># -c 50: 50个并发客户端</span>
<span class="hljs-comment"># -n 10000: 总请求数</span>
<span class="hljs-comment"># 输出示例：LRANGE: 5000 req/s</span>
</code></pre>
</li>
<li>
<p><strong>验证假设</strong><br/>
调整命令或数据结构后，观察耗时变化。比如将<code>LRANGE 0 -1</code>改为<code>LRANGE 0 999</code>，确认性能提升。</p>
</li>
</ul>
<h5 data-id="heading-17">3. 优化落地与监控</h5>
<p>找到解决方案后，部署优化并持续监控是关键：</p>
<ul>
<li>
<p><strong>部署优化</strong><br/>
根据上一节策略调整命令或结构，比如用<code>SCAN</code>替换<code>KEYS</code>。注意小范围测试，避免影响线上服务。</p>
</li>
<li>
<p><strong>配置告警</strong><br/>
设置慢查询数量阈值（如每天超100条告警），可用脚本推送到监控系统：</p>
<pre><code class="hljs language-python" lang="python">slow_logs = r.slowlog_get(<span class="hljs-number">100</span>)
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(slow_logs) &gt; <span class="hljs-number">100</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Alert: Slow queries exceed threshold!"</span>)
</code></pre>
</li>
<li>
<p><strong>注意事项</strong><br/>
优化后观察业务指标（如订单成功率），确保没有副作用。</p>
</li>
</ul>
<p><strong>表格</strong>：排查与优化阶段对比</p>





























<table><thead><tr><th>阶段</th><th>工具/命令</th><th>目标</th><th>输出示例</th></tr></thead><tbody><tr><td>问题定位</td><td><code>SLOWLOG GET</code>, <code>INFO</code></td><td>锁定慢查询和资源瓶颈</td><td><code>LRANGE</code>耗时50ms</td></tr><tr><td>分析验证</td><td><code>redis-benchmark</code></td><td>确认原因并测试优化</td><td>QPS从2000升到8000</td></tr><tr><td>优化落地</td><td><code>SCAN</code>, 脚本告警</td><td>部署并监控效果</td><td>慢查询降到10条/天</td></tr></tbody></table>
<h5 data-id="heading-18">4. 真实案例</h5>
<ul>
<li><strong>背景</strong>：某电商项目中，用户下单延迟从50ms飙升到500ms，订单成功率下降10%。</li>
<li><strong>定位</strong>：用<code>SLOWLOG GET</code>发现<code>HGETALL order:1001</code>耗时200ms，<code>INFO</code>显示内存占用激增。</li>
<li><strong>分析</strong>：订单Hash字段从100涨到5000，导致读取变慢。压测验证：5000字段时QPS仅1000。</li>
<li><strong>优化</strong>：将Hash拆为<code>order:1001:base</code>（基本信息）和<code>order:1001:items</code>（商品列表），用<code>HMGET</code>替换<code>HGETALL</code>。</li>
<li><strong>结果</strong>：延迟降回60ms，QPS恢复到1万，订单成功率回升。</li>
</ul>
<p><strong>示意图</strong>：排查流程</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[问题发现: QPS下降]</span> → <span class="hljs-selector-attr">[定位: SLOWLOG+INFO]</span> → <span class="hljs-selector-attr">[分析: 压测+验证]</span> → <span class="hljs-selector-attr">[优化: 命令替换+分片]</span> → <span class="hljs-selector-attr">[监控: 告警+指标]</span>
</code></pre>
<p><strong>过渡到下一节</strong>：通过完整的排查流程，你已经能从混乱的线上问题中找到突破口，并落地优化。接下来，我们将总结常见的踩坑经验和最佳实践，帮助你在未来少走弯路。准备好迎接经验的“干货”了吗？让我们继续！</p>
<hr/>
<h4 data-id="heading-19">六、常见踩坑与经验总结</h4>
<p>经过前几节的实战演练，你已经掌握了慢查询分析与优化的核心技能。但在实际项目中，经验往往是从踩坑中提炼出来的。本节将分享我在10年Redis开发中遇到的典型问题和教训，并总结一些最佳实践，希望你能从中受益，避免重蹈覆辙。让我们一起来看看这些“血泪史”和实用建议吧！</p>
<h5 data-id="heading-20">1. 踩坑案例</h5>
<ul>
<li>
<p><strong>未设置合理阈值导致日志丢失</strong><br/>
有一次线上服务慢得像“乌龟爬”，却查不到慢查询日志。原因是我把<code>slowlog-log-slower-than</code>设为100ms，而大部分慢查询耗时在10-50ms之间，结果啥也没记录。调整为5000μs（5ms）后，问题暴露无遗。<br/>
<strong>教训</strong>：初始阈值设低点（如1-5ms），根据业务调整，别让日志“隐身”。</p>
</li>
<li>
<p><strong>盲目优化忽略业务逻辑</strong><br/>
某项目中，我发现<code>LRANGE</code>慢查询频发，果断拆成小List，结果发现业务需要全量读取排行榜，优化后反而多了一次合并逻辑，得不偿失。<br/>
<strong>教训</strong>：优化前要搞清楚业务需求，别“头痛医脚”。</p>
</li>
</ul>
<h5 data-id="heading-21">2. 最佳实践</h5>
<p>基于踩坑经验，我总结了以下几条实践建议：</p>
<ul>
<li>
<p><strong>定期审查慢查询日志</strong><br/>
每周运行脚本检查慢查询，防患于未然。可以用Cron任务自动化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 每小时检查一次</span>
0 * * * * redis-cli -h localhost -p 6379 SLOWLOG GET 50 &gt; /log/slowlog.txt
</code></pre>
</li>
<li>
<p><strong>结合业务选择数据结构</strong><br/>
比如缓存用户状态用Hash，实时排行用ZSet，别一味追求性能忽略场景适用性。</p>
</li>
<li>
<p><strong>小步快跑验证效果</strong><br/>
优化后先在测试环境压测，再灰度上线。比如调整<code>HGETALL</code>为<code>HMGET</code>，观察QPS和延迟后再全量部署。</p>
</li>
</ul>
<p><strong>表格</strong>：踩坑与解决对比</p>























<table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th><th>效果</th></tr></thead><tbody><tr><td>日志丢失</td><td>阈值过高</td><td>降低到5ms</td><td>问题及时暴露</td></tr><tr><td>优化与业务冲突</td><td>未考虑全量需求</td><td>先评估业务再调整结构</td><td>性能与逻辑兼顾</td></tr></tbody></table>
<h5 data-id="heading-22">3. 给读者的建议</h5>
<ul>
<li>
<p><strong>从小项目入手</strong><br/>
如果你是新手，别急着优化线上大系统。先在本地搭建Redis，模拟慢查询（比如用<code>DEBUG SLEEP</code>制造延迟），熟悉分析流程。</p>
</li>
<li>
<p><strong>善用工具与社区</strong><br/>
Redis官方文档、RedisInsight和Stack Overflow都是宝藏。遇到问题先查查，也许别人已经踩过同样的坑。</p>
</li>
<li>
<p><strong>保持好奇心</strong><br/>
慢查询优化是个持续学习的过程，每次排查都是一次提升。试着记录自己的优化案例，积累经验。</p>
</li>
</ul>
<p><strong>过渡到下一节</strong>：通过这些踩坑教训和实践建议，你应该对慢查询的应对更有信心了。接下来，我们将在结语中回顾核心要点，展望Redis未来的发展方向，并邀请你分享自己的经验。准备好迎接最后的总结了吗？让我们继续！</p>
<hr/>
<h4 data-id="heading-23">七、结语</h4>
<p>至此，我们已经一起走过了Redis慢查询分析与优化的完整旅程。从基础知识到分析工具，再到优化策略和排查流程，这篇文章不仅是一份技术指南，更是我10年实战经验的沉淀。慢查询虽小，却能影响整个系统的稳定性和用户体验。通过本文，你应该已经掌握了发现问题、分析原因并优化落地的核心技能。无论是替换低效命令、调整数据结构，还是配置告警监控，这些方法都能让你在面对性能瓶颈时更加从容。</p>
<h5 data-id="heading-24">1. 总结</h5>
<p>慢查询分析与优化的价值在于，它不仅是技术的提升，更是业务保障的基石。你现在能用<code>SLOWLOG GET</code>定位问题，用<code>SCAN</code>和<code>HMGET</code>优化命令，还能通过分片和Pipeline解决大数据量和高并发挑战。这些技能不仅能帮你提升QPS、降低延迟，还可能在关键时刻挽救一次线上事故。记住，性能优化没有终点，每一次排查都是一次成长。</p>
<h5 data-id="heading-25">2. 展望</h5>
<p>随着Redis的不断演进，慢查询相关的功能也在改进。比如Redis 7.x引入了更灵活的命令分析工具和内存管理优化，未来可能会提供更智能的慢查询诊断，甚至内置推荐优化方案。同时，随着云原生和分布式架构的普及，Redis Cluster和Sentinel的慢查询管理也将成为新热点。作为开发者，持续关注这些趋势，结合实际项目实践，才能保持竞争力。我建议你多关注Redis官方博客和社区动态，紧跟技术脉搏。</p>
<h5 data-id="heading-26">3. 互动</h5>
<p>技术是活的，经验是共享的。我在文中分享了自己的踩坑和心得，也很期待听到你的故事。你是否遇到过棘手的慢查询问题？又是怎么解决的？欢迎在评论区留言，或者通过X联系我（假设有这个平台），让我们一起交流成长。Redis的世界很大，优化之路还很长，希望我们都能在这条路上越走越远！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent Skills 完全指南：让你的 AI Agent 拥有超能力]]></title>    <link>https://juejin.cn/post/7593262196843380788</link>    <guid>https://juejin.cn/post/7593262196843380788</guid>    <pubDate>2026-01-10T03:45:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593262196843380788" data-draft-id="7593240931286990900" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent Skills 完全指南：让你的 AI Agent 拥有超能力"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-10T03:45:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乃瞻衡宇"/> <meta itemprop="url" content="https://juejin.cn/user/2373161075090537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent Skills 完全指南：让你的 AI Agent 拥有超能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373161075090537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乃瞻衡宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T03:45:39.000Z" title="Sat Jan 10 2026 03:45:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Agent Skills 完全指南：让你的 AI Agent 拥有超能力</h2>
<blockquote>
<p><strong>摘要：</strong> 本文详细介绍 Agent Skills 的概念、实现原理和最佳实践，通过实战案例教你如何为 AI Agent 添加自定义技能，让其能够调用外部工具、API 和服务，实现真正的自主任务执行。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">📌 前言</h3>
<p>随着大语言模型的快速发展，AI Agent 已经从简单的对话机器人进化成能够自主完成复杂任务的智能体。但是，仅仅依靠语言模型本身是不够的——Agent 需要 <strong>Skills（技能）</strong> 来与外部世界交互。</p>
<p>就像人类需要学习使用工具一样，AI Agent 也需要掌握各种技能：搜索网页、读写文件、调用 API、执行代码等。本文将带你深入了解 Agent Skills 的核心机制，并手把手教你实现自己的技能系统。</p>
<p><strong>适合人群：</strong></p>
<ul>
<li>AI Agent 开发者</li>
<li>LangChain/AutoGPT 用户</li>
<li>想要扩展 AI 能力的工程师</li>
</ul>
<hr/>
<h3 data-id="heading-2">🎯 什么是 Agent Skills？</h3>
<h4 data-id="heading-3">1.1 核心概念</h4>
<p><strong>Agent Skills</strong> 是赋予 AI Agent 执行特定任务的能力模块。每个 Skill 本质上是一个<strong>可调用的函数</strong>，包含：</p>
<ul>
<li><strong>函数名称</strong>：Agent 知道何时调用它</li>
<li><strong>函数描述</strong>：告诉 Agent 这个技能能做什么</li>
<li><strong>参数定义</strong>：需要什么输入</li>
<li><strong>执行逻辑</strong>：实际的业务代码</li>
</ul>
<h4 data-id="heading-4">1.2 工作原理</h4>
<pre><code class="hljs">用户输入 → Agent 分析 → 选择合适的 Skill → 执行 Skill → 返回结果 → 继续推理
</code></pre>
<p><strong>典型流程：</strong></p>
<ol start="0">
<li>用户："帮我查一下北京今天的天气"</li>
<li>Agent 识别需要使用 <code>get_weather</code> 技能</li>
<li>提取参数：<code>{"city": "北京"}</code></li>
<li>执行技能，调用天气 API</li>
<li>返回结果："北京今天多云，22-28°C"</li>
<li>Agent 组织语言回复用户</li>
</ol>
<h4 data-id="heading-5">1.3 为什么需要 Skills？</h4>

























<table><thead><tr><th>挑战</th><th>解决方案</th></tr></thead><tbody><tr><td>LLM 训练数据过时</td><td>通过搜索 Skill 获取实时信息</td></tr><tr><td>无法执行计算</td><td>添加代码执行 Skill</td></tr><tr><td>不能访问私有数据</td><td>创建数据库查询 Skill</td></tr><tr><td>无法操作外部系统</td><td>开发 API 调用 Skill</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">💻 实现你的第一个 Skill</h3>
<h4 data-id="heading-7">2.1 基础示例：天气查询 Skill</h4>
<p>以 Python 和 LangChain 为例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> Tool
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, AgentType
<span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">import</span> requests
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    查询指定城市的天气信息
​
    Args:
        city: 城市名称（中文或英文）
​
    Returns:
        天气信息字符串
    """</span>
    <span class="hljs-comment"># 这里使用模拟数据，实际应调用真实天气API</span>
    api_url = <span class="hljs-string">f"https://api.weatherapi.com/v1/current.json"</span>
    params = {
        <span class="hljs-string">"key"</span>: <span class="hljs-string">"YOUR_API_KEY"</span>,
        <span class="hljs-string">"q"</span>: city,
        <span class="hljs-string">"lang"</span>: <span class="hljs-string">"zh"</span>
    }
​
    <span class="hljs-keyword">try</span>:
        response = requests.get(api_url, params=params)
        data = response.json()
​
        weather_info = <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气：<span class="hljs-subst">{data[<span class="hljs-string">'current'</span>][<span class="hljs-string">'condition'</span>][<span class="hljs-string">'text'</span>]}</span>，"</span> \
                      <span class="hljs-string">f"温度 <span class="hljs-subst">{data[<span class="hljs-string">'current'</span>][<span class="hljs-string">'temp_c'</span>]}</span>°C，"</span> \
                      <span class="hljs-string">f"体感温度 <span class="hljs-subst">{data[<span class="hljs-string">'current'</span>][<span class="hljs-string">'feelslike_c'</span>]}</span>°C"</span>
        <span class="hljs-keyword">return</span> weather_info
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"查询天气失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
​
<span class="hljs-comment"># 将函数包装成 Tool</span>
weather_tool = Tool(
    name=<span class="hljs-string">"WeatherQuery"</span>,
    func=get_weather,
    description=<span class="hljs-string">"用于查询城市的实时天气信息。输入城市名称，返回天气状况、温度等信息。"</span>
)
​
<span class="hljs-comment"># 创建 Agent</span>
llm = OpenAI(temperature=<span class="hljs-number">0</span>)
tools = [weather_tool]
​
agent = initialize_agent(
    tools=tools,
    llm=llm,
    agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
    verbose=<span class="hljs-literal">True</span>
)
​
<span class="hljs-comment"># 使用 Agent</span>
response = agent.run(<span class="hljs-string">"北京今天天气怎么样？"</span>)
<span class="hljs-built_in">print</span>(response)
</code></pre>
<p><strong>关键点说明：</strong></p>
<ul>
<li><code>name</code>：简洁明确的技能名称</li>
<li><code>description</code>：详细描述功能，帮助 Agent 判断何时使用</li>
<li><code>func</code>：实际执行的函数</li>
<li>错误处理：必须捕获异常并返回友好信息</li>
</ul>
<h4 data-id="heading-8">2.2 进阶示例：文件操作 Skill</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_file_skill</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, encoding: <span class="hljs-built_in">str</span> = <span class="hljs-string">"utf-8"</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    读取文件内容
​
    Args:
        file_path: 文件路径（绝对路径或相对路径）
        encoding: 文件编码，默认 utf-8
​
    Returns:
        文件内容字符串
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(file_path):
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误：文件 <span class="hljs-subst">{file_path}</span> 不存在"</span>
​
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>, encoding=encoding) <span class="hljs-keyword">as</span> f:
            content = f.read()
​
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"成功读取文件，内容：\n<span class="hljs-subst">{content[:<span class="hljs-number">500</span>]}</span>..."</span>  <span class="hljs-comment"># 限制返回长度</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"读取文件失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file_skill</span>(<span class="hljs-params">file_path: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span>, mode: <span class="hljs-built_in">str</span> = <span class="hljs-string">"w"</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    写入内容到文件
​
    Args:
        file_path: 目标文件路径
        content: 要写入的内容
        mode: 写入模式，'w' 覆盖，'a' 追加
​
    Returns:
        操作结果描述
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, mode, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            f.write(content)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"成功写入文件 <span class="hljs-subst">{file_path}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"写入文件失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
​
<span class="hljs-comment"># 创建工具集</span>
file_tools = [
    Tool(
        name=<span class="hljs-string">"ReadFile"</span>,
        func=read_file_skill,
        description=<span class="hljs-string">"读取指定路径的文件内容。输入文件路径，返回文件内容。"</span>
    ),
    Tool(
        name=<span class="hljs-string">"WriteFile"</span>,
        func=write_file_skill,
        description=<span class="hljs-string">"将内容写入指定文件。需要文件路径和要写入的内容作为参数。"</span>
    )
]
</code></pre>
<hr/>
<h3 data-id="heading-9">🚀 实战案例：构建多技能 Agent</h3>
<h4 data-id="heading-10">3.1 需求场景</h4>
<p>创建一个能够：</p>
<ol start="0">
<li>搜索网页信息</li>
<li>进行数学计算</li>
<li>生成并保存代码文件</li>
</ol>
<p>的全能型 Agent。</p>
<h4 data-id="heading-11">3.2 完整实现</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> initialize_agent, Tool, AgentType
<span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> langchain.utilities <span class="hljs-keyword">import</span> SerpAPIWrapper
<span class="hljs-keyword">import</span> math
<span class="hljs-keyword">import</span> os
​
<span class="hljs-comment"># Skill 1: 网页搜索</span>
search = SerpAPIWrapper()
search_tool = Tool(
    name=<span class="hljs-string">"WebSearch"</span>,
    func=search.run,
    description=<span class="hljs-string">"用于搜索互联网信息。输入搜索关键词，返回相关网页结果摘要。"</span>
)
​
<span class="hljs-comment"># Skill 2: 数学计算</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator_skill</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""安全的数学表达式计算"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 仅允许数学运算，防止代码注入</span>
        allowed_names = {k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> math.__dict__.items() <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> k.startswith(<span class="hljs-string">"__"</span>)}
        result = <span class="hljs-built_in">eval</span>(expression, {<span class="hljs-string">"__builtins__"</span>: {}}, allowed_names)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算结果：<span class="hljs-subst">{result}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"计算错误：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
​
calculator_tool = Tool(
    name=<span class="hljs-string">"Calculator"</span>,
    func=calculator_skill,
    description=<span class="hljs-string">"执行数学计算。输入数学表达式（如 '2+2' 或 'sqrt(16)'），返回计算结果。"</span>
)
​
<span class="hljs-comment"># Skill 3: 代码生成与保存</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_code_skill</span>(<span class="hljs-params">code: <span class="hljs-built_in">str</span>, filename: <span class="hljs-built_in">str</span>, language: <span class="hljs-built_in">str</span> = <span class="hljs-string">"python"</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""生成代码文件"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 根据语言确定扩展名</span>
        ext_map = {<span class="hljs-string">"python"</span>: <span class="hljs-string">"py"</span>, <span class="hljs-string">"javascript"</span>: <span class="hljs-string">"js"</span>, <span class="hljs-string">"java"</span>: <span class="hljs-string">"java"</span>, <span class="hljs-string">"cpp"</span>: <span class="hljs-string">"cpp"</span>}
        ext = ext_map.get(language.lower(), <span class="hljs-string">"txt"</span>)
​
        full_path = <span class="hljs-string">f"<span class="hljs-subst">{filename}</span>.<span class="hljs-subst">{ext}</span>"</span>
​
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(full_path, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            f.write(code)
​
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"代码已保存到 <span class="hljs-subst">{full_path}</span>"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"保存失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
​
code_tool = Tool(
    name=<span class="hljs-string">"SaveCode"</span>,
    func=save_code_skill,
    description=<span class="hljs-string">"保存代码到文件。需要提供代码内容、文件名和编程语言类型。"</span>
)
​
<span class="hljs-comment"># 组装 Agent</span>
llm = OpenAI(temperature=<span class="hljs-number">0</span>, model_name=<span class="hljs-string">"gpt-4"</span>)
tools = [search_tool, calculator_tool, code_tool]
​
agent = initialize_agent(
    tools=tools,
    llm=llm,
    agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
    verbose=<span class="hljs-literal">True</span>,
    max_iterations=<span class="hljs-number">5</span>
)
​
<span class="hljs-comment"># 测试复杂任务</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 任务：搜索 Python 排序算法，计算时间复杂度，生成示例代码</span>
    result = agent.run(<span class="hljs-string">"""
    请帮我完成以下任务：
    1. 搜索快速排序算法的原理
    2. 计算对 1000 个元素排序，平均需要多少次比较（假设 O(n log n)）
    3. 生成一个 Python 快速排序的实现代码并保存为 quicksort.py
    """</span>)
​
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"最终结果："</span>)
    <span class="hljs-built_in">print</span>(result)
</code></pre>
<p><strong>运行效果：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">&gt; Entering <span class="hljs-built_in">new</span> AgentExecutor chain...
​
<span class="hljs-symbol">Thought:</span> 我需要先搜索快速排序的原理
<span class="hljs-symbol">Action:</span> WebSearch
Action Input: <span class="hljs-string">"快速排序算法原理"</span>
​
<span class="hljs-symbol">Observation:</span> 快速排序是一种分治算法...
​
<span class="hljs-symbol">Thought:</span> 现在计算比较次数
<span class="hljs-symbol">Action:</span> Calculator
Action Input: <span class="hljs-string">"1000 * log(1000, 2)"</span>
​
<span class="hljs-symbol">Observation:</span> 计算结果：<span class="hljs-number">9965.784284662087</span>
​
<span class="hljs-symbol">Thought:</span> 生成代码并保存
<span class="hljs-symbol">Action:</span> SaveCode
Action Input: code=<span class="hljs-string">"def quicksort(arr):\n    if len(arr) &lt;= 1:\n        return arr\n    ..."</span>, filename=<span class="hljs-string">"quicksort"</span>, language=<span class="hljs-string">"python"</span>
​
<span class="hljs-symbol">Observation:</span> 代码已保存到 quicksort.py
​
Final Answer: 已完成所有任务。快速排序采用分治策略...
</code></pre>
<hr/>
<h3 data-id="heading-12">📊 Skills 设计最佳实践</h3>
<h4 data-id="heading-13">4.1 设计原则</h4>



































<table><thead><tr><th>原则</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>单一职责</strong></td><td>每个 Skill 只做一件事</td><td>❌ <code>handle_data</code> → ✅ <code>read_csv</code>, <code>write_csv</code></td></tr><tr><td><strong>清晰命名</strong></td><td>名称要表达功能</td><td>❌ <code>tool1</code> → ✅ <code>GetWeather</code></td></tr><tr><td><strong>详细描述</strong></td><td>帮助 Agent 理解使用场景</td><td>"查询天气" → "查询指定城市的实时天气，包括温度、湿度、风速等信息"</td></tr><tr><td><strong>容错处理</strong></td><td>必须捕获异常</td><td>返回错误信息而不是抛出异常</td></tr><tr><td><strong>参数验证</strong></td><td>检查输入合法性</td><td>验证城市名不为空，文件路径存在等</td></tr></tbody></table>
<h4 data-id="heading-14">4.2 描述文本优化技巧</h4>
<p>好的描述能让 Agent 更准确地选择技能：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ❌ 不好的描述</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"查天气"</span>
​
<span class="hljs-comment"># ✅ 优秀的描述</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"""
查询指定城市的实时天气信息。
​
使用场景：
- 用户询问某个城市的天气
- 需要获取温度、天气状况、体感温度等信息
​
输入：城市名称（支持中英文，如 "北京" 或 "Beijing"）
输出：天气描述文本，包含温度、天气状况、风力等
​
示例：
输入: "上海"
输出: "上海当前天气：多云，温度 25°C，体感温度 27°C，东南风 3 级"
"""</span>
</code></pre>
<h4 data-id="heading-15">4.3 安全考虑</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_skill_wrapper</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""安全包装器：限制执行时间和资源"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        <span class="hljs-keyword">import</span> signal
​
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">timeout_handler</span>(<span class="hljs-params">signum, frame</span>):
            <span class="hljs-keyword">raise</span> TimeoutError(<span class="hljs-string">"技能执行超时"</span>)
​
        <span class="hljs-comment"># 设置 5 秒超时</span>
        signal.signal(signal.SIGALRM, timeout_handler)
        signal.alarm(<span class="hljs-number">5</span>)
​
        <span class="hljs-keyword">try</span>:
            result = func(*args, **kwargs)
            signal.alarm(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 取消超时</span>
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            signal.alarm(<span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"执行失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
​
    <span class="hljs-keyword">return</span> wrapper
​
<span class="hljs-meta">@safe_skill_wrapper</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">risky_skill</span>(<span class="hljs-params">command: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""可能耗时的操作"""</span>
    <span class="hljs-comment"># 执行逻辑</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">⚠️ 常见问题与解决方案</h3>
<h4 data-id="heading-17">Q1: Agent 不使用我的 Skill？</h4>
<p><strong>原因：</strong></p>
<ul>
<li>描述不够清晰</li>
<li>名称有歧义</li>
<li>功能与其他 Skill 重叠</li>
</ul>
<p><strong>解决：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 改进描述，明确使用场景</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"""
当用户明确要求读取文件内容时使用此技能。
不要用于写入、删除或修改文件。
输入必须是具体的文件路径。
"""</span>
</code></pre>
<h4 data-id="heading-18">Q2: Skill 执行失败但 Agent 没有重试？</h4>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">robust_skill</span>(<span class="hljs-params">param: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""带重试机制的技能"""</span>
    max_retries = <span class="hljs-number">3</span>
​
    <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_retries):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 执行逻辑</span>
            result = external_api_call(param)
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> attempt == max_retries - <span class="hljs-number">1</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">f"重试 <span class="hljs-subst">{max_retries}</span> 次后仍然失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
            time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 等待后重试</span>
</code></pre>
<h4 data-id="heading-19">Q3: 如何传递复杂参数（如 JSON）？</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">complex_skill</span>(<span class="hljs-params">json_str: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""接受 JSON 字符串参数"""</span>
    <span class="hljs-keyword">try</span>:
        params = json.loads(json_str)
        city = params.get(<span class="hljs-string">"city"</span>)
        date = params.get(<span class="hljs-string">"date"</span>)
        <span class="hljs-comment"># 处理逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"查询 <span class="hljs-subst">{city}</span> 在 <span class="hljs-subst">{date}</span> 的数据"</span>
    <span class="hljs-keyword">except</span> json.JSONDecodeError:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"参数格式错误，请提供有效的 JSON 字符串"</span>
​
<span class="hljs-comment"># 使用时</span>
Tool(
    name=<span class="hljs-string">"ComplexQuery"</span>,
    func=complex_skill,
    description=<span class="hljs-string">'需要 JSON 格式参数，例如：{"city": "北京", "date": "2024-01-01"}'</span>
)
</code></pre>
<hr/>
<h3 data-id="heading-20">🔗 常用技能库推荐</h3>






























<table><thead><tr><th>工具库</th><th>功能</th><th>链接</th></tr></thead><tbody><tr><td><strong>LangChain Tools</strong></td><td>官方预置技能集（搜索、计算、API调用）</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Fmodules%2Fagents%2Ftools%2F" target="_blank" title="https://python.langchain.com/docs/modules/agents/tools/" ref="nofollow noopener noreferrer">文档</a></td></tr><tr><td><strong>OpenAI Function Calling</strong></td><td>原生函数调用支持</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Ffunction-calling" target="_blank" title="https://platform.openai.com/docs/guides/function-calling" ref="nofollow noopener noreferrer">指南</a></td></tr><tr><td><strong>AutoGPT Plugins</strong></td><td>社区贡献的插件市场</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSignificant-Gravitas%2FAuto-GPT-Plugins" target="_blank" title="https://github.com/Significant-Gravitas/Auto-GPT-Plugins" ref="nofollow noopener noreferrer">GitHub</a></td></tr><tr><td><strong>Semantic Kernel</strong></td><td>微软的技能管理框架</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fsemantic-kernel%2F" target="_blank" title="https://learn.microsoft.com/en-us/semantic-kernel/" ref="nofollow noopener noreferrer">官网</a></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-21">📝 总结</h3>
<p>通过本文，你已经掌握了 Agent Skills 的核心知识：</p>
<p><strong>关键要点：</strong></p>
<ol start="0">
<li>✅ Skills 是 Agent 与外部世界交互的桥梁</li>
<li>✅ 设计 Skill 要遵循单一职责、清晰命名、容错处理原则</li>
<li>✅ 优秀的描述文本能显著提升 Agent 的技能选择准确率</li>
<li>✅ 实战中要注意安全性、超时控制和错误处理</li>
</ol>
<p><strong>下一步建议：</strong></p>
<ul>
<li>🔨 动手实现 3-5 个自己业务相关的 Skills</li>
<li>📚 深入学习 LangChain 或 Semantic Kernel 框架</li>
<li>🌐 探索 Function Calling 的高级用法</li>
<li>🤝 加入 AI Agent 开发社区，分享你的技能库</li>
</ul>
<p><strong>记住：</strong> 一个强大的 Agent 不仅取决于底层模型，更取决于你为它配备了哪些"武器"（Skills）。现在就开始构建你的技能库吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Zed 编辑器的 6 个隐藏技巧：提升开发效率的「冷知识」整理]]></title>    <link>https://juejin.cn/post/7593175890795036718</link>    <guid>https://juejin.cn/post/7593175890795036718</guid>    <pubDate>2026-01-10T00:23:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593175890795036718" data-draft-id="7582845425402642472" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Zed 编辑器的 6 个隐藏技巧：提升开发效率的「冷知识」整理"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-10T00:23:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Zed 编辑器的 6 个隐藏技巧：提升开发效率的「冷知识」整理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T00:23:24.000Z" title="Sat Jan 10 2026 00:23:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Zed 自从今年开始发布了win版本，也有更多的用户开始使用zed这块新时代的AI IDE，下面就来介绍几个非常实用的zed技巧，提升大家的效率！</p>
<h2 data-id="heading-0">一、任务命令实时修改：<code>Tab + Alt+Enter</code> 神操作</h2>
<p>Zed 的任务系统（Tasks）支持<strong>临时编辑命令</strong>后立即运行，特别适合调试场景。</p>
<h3 data-id="heading-1">🌰 场景举例：Rust 测试需开启 backtrace</h3>
<p>默认 <code>cargo test</code> 任务不带 <code>RUST_BACKTRACE=1</code>，但我们可以：</p>
<ol>
<li>按 <code>Cmd/Ctrl + Shift + P</code> → 输入 <code>task: spawn</code></li>
<li>选择一个任务后 → 按 <code>Tab</code> 键展开原始命令<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75d3a3cfebd145e78d6de2b60f714152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=QI2JIAs6RDZs7TamAGE%2BJrHHxDE%3D" alt="" loading="lazy"/></li>
<li>手动在命令前加上 <code>RUST_BACKTRACE=1 </code>（注意空格）</li>
<li>按 <code>Alt + Enter</code> 运行 → 即为 <strong>「一次性任务」（Oneshot Task）</strong><br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e1ff6853ebd4cefa7fc93c79025c02c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=5d6d%2F4oU9o6a%2FlclwuRwYOjGR4Y%3D" alt="" loading="lazy"/></li>
</ol>
<p>✅ 优点：</p>
<ul>
<li>不污染配置文件</li>
<li>历史记录会保存修改后的命令（下次可直接复用）<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4446b8c9ae0f4dd3b4cbe6efa4cdbaf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=IgPyMmFhbk6UiLY0%2F1z9py%2FFVkQ%3D" alt="" loading="lazy"/></li>
</ul>
<hr/>
<h2 data-id="heading-2">二、为 Bun 测试添加「行内 Run 按钮」</h2>
<p>Zed 支持在代码行号旁显示 ▶️ 按钮，点击直接运行当前测试。</p>
<h3 data-id="heading-3">✔️ 自动支持条件</h3>
<ul>
<li>项目 <code>package.json</code> 中包含 <code>"@types/bun"</code></li>
<li>文件为 <code>.test.ts</code> / <code>.spec.js</code> 等规范命名</li>
</ul>
<h3 data-id="heading-4">⚙️ 手动配置（通用方案）</h3>
<p>若未自动识别，可在项目根目录创建 <code>.zed/tasks.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bun Test"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bun test"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"\"$ZED_RELATIVE_FILE\" -t=\"$ZED_SYMBOL\""</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"js-test"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ts-test"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"bun-test"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tsx-test"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>✅ 效果：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61abc96daf9449ec9a69b249ce4c03ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=JytCtyODD0a67kXnLApyMGv521s%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>💡 <code>$ZED_RELATIVE_FILE</code> 和 <code>$ZED_SYMBOL</code> 是 Zed 内置变量，分别代表当前文件路径、光标所在符号（如测试函数名）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、给文件图标「加点颜色」—— 安装 Catppuccin Icons</h2>
<p>Zed 默认是<strong>单色图标</strong>：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b7e935163bc482f962619ae0ab6a24f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=yAzt9DTW7kqN1Bk9QOhZvf90TGU%3D" alt="" loading="lazy"/></p>
<p>👉 安装彩色图标主题三步走：</p>
<ol>
<li>命令面板 → <code>zed: extensions</code> → 搜索 <code>Catppuccin Icons</code> → Install</li>
<li>命令面板 → <code>icon theme selector: toggle</code> → 选择 <code>Catppuccin Mocha</code>（或其他变体）</li>
<li>（可选）开启 Tab 栏图标：<br/>
在 <code>settings.json</code> 中添加：
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"file_icons"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<p>🎉 效果对比：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/715dcde9f3d24c4bb9fdb21bbece5e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=4OyqOSv7cblxIqKsLTAQt1zdgY0%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">四、用 <code>television</code> 替代默认文件搜索（Vim 用户狂喜）</h2>
<blockquote>
<p><code>television</code> 是一个终端版的模糊查找器（类似 fzf + Telescope.nvim），支持预览、多选等高级功能。</p>
</blockquote>
<h3 data-id="heading-7">🔧 配置步骤</h3>
<ol>
<li>
<p>安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fayazhafiz%2Ftelevision" target="_blank" title="https://github.com/ayazhafiz/television" ref="nofollow noopener noreferrer">television</a>（需 Rust 环境）：</p>
<pre><code class="hljs language-bash" lang="bash">cargo install television
</code></pre>
</li>
<li>
<p>在 <code>tasks.json</code> 中添加任务：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Television File Finder"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zed \"$(tv files)\""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hide"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"allow_concurrent_runs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"use_new_terminal"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p>绑定快捷键（如覆盖 <code>Cmd/Ctrl+P</code>）：<br/>
编辑 <code>keymap.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"bindings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"cmd-p"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"task::Spawn"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"task_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Television File Finder"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"reveal_target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"center"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<p>✅ 最终效果：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00430f5b81394b9ba97e680fb34d7870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=11D4osPrJIEoJY%2BeATDQ6%2FmiO54%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">五、终端自动进入项目专属 tmux 会话</h2>
<p>适合重度 tmux 用户——每个项目独立 session，避免窗口混乱。</p>
<p>在 <code>settings.json</code> 中配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"terminal"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"shell"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"with_arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"program"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/bin/zsh"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-c"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"tmux new-session -A -s \"$(basename \"$PWD\")\""</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>-A</code>：若 session 存在则 attach，不存在则创建</li>
<li><code>-s</code>：指定 session 名为当前目录名（如 <code>my-project</code>）</li>
</ul>
<p>📌 效果：打开终端即进入专属 tmux，可自由分屏/切换窗口：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aea91a77370944369d21e7243ca33aa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768609403&amp;x-signature=9OgcGlMsctZM51%2Bfdf8mP2aq%2BiY%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>✅ 支持 bash/fish：只需修改 <code>program</code> 路径，如 <code>"/bin/bash"</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">六、让 Zed 认识「陌生」文件后缀（如 <code>.jsm</code>）</h2>
<p>Zed 默认仅识别常见后缀（<code>.js</code>, <code>.ts</code>, <code>.rs</code>…）。遇到 <code>.jsm</code>（ESM 模块）、<code>.svelte.ts</code> 等可手动映射：</p>
<h3 data-id="heading-10">🔁 临时方案（单次生效）</h3>
<p>命令面板 → <code>language selector: toggle</code> → 选 <code>JavaScript</code></p>
<p>⚠️ 缺点：关闭文件即失效。</p>
<h3 data-id="heading-11">✅ 永久方案：写入 <code>settings.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"file_types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"JavaScript"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.jsm"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"*.mjs"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"TypeScript"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.cts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"*.mts"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Python"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.pyi"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"*.tac"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Rust"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"*.rs.in"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>✅ 支持 glob 通配符<br/>
🔍 优先建议：先查 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzed.dev%2Fextensions" target="_blank" title="https://zed.dev/extensions" ref="nofollow noopener noreferrer">Zed 扩展市场</a> 是否有专属语言插件！</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[xampplinux_v174beta11在 Linux 下的安装与配置步骤]]></title>    <link>https://juejin.cn/post/7593181244709503028</link>    <guid>https://juejin.cn/post/7593181244709503028</guid>    <pubDate>2026-01-10T01:55:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593181244709503028" data-draft-id="7593240931286663220" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="xampplinux_v174beta11在 Linux 下的安装与配置步骤"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-10T01:55:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户613541146016"/> <meta itemprop="url" content="https://juejin.cn/user/1602431422584832"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            xampplinux_v174beta11在 Linux 下的安装与配置步骤
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1602431422584832/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户613541146016
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T01:55:51.000Z" title="Sat Jan 10 2026 01:55:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> 1. 把文件扔到服务器上</p>
<p><strong>安装包下载：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.quark.cn%2Fs%2F51842d549892" title="https://pan.quark.cn/s/51842d549892" target="_blank" ref="nofollow noopener noreferrer">pan.quark.cn/s/51842d549…</a>，找个地方放这个 <code>xampplinux_v174beta11.tar.gz</code>文件，比如 <code>/opt</code>目录或者你的个人目录都行。</p>
<h3 data-id="heading-0">2. 开个终端，进到放文件的目录</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /opt
</code></pre>
<p>（如果你放别的地方了，就把 <code>/opt</code>换成你自己的路径）</p>
<h3 data-id="heading-1">3. 解压它</h3>
<p>用 <code>tar</code>命令把这个压缩包解开。<code>z</code>是说它是 <code>.gz</code>格式的，<code>x</code>是解压，<code>v</code>是让你看过程，<code>f</code>后面跟上文件名。</p>
<pre><code class="hljs">sudo tar -zxvf xampplinux_v174beta11.tar.gz
</code></pre>
<p>敲完回车，等一会儿它就给你解压出一个新文件夹，名字大概叫 <code>xampp-linux-xxx...</code>。</p>
<h3 data-id="heading-2">4. 进去启动</h3>
<p>用 <code>cd</code>命令进到刚解压出来的那个文件夹里。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> xampp-linux-xxx... <span class="hljs-comment"># 打几个字母按 Tab 键可以自动补全名字</span>
</code></pre>
<p>然后直接运行启动脚本就行：</p>
<pre><code class="hljs language-bash" lang="bash">sudo ./xampp start
</code></pre>
<p>第一次启动可能会弹一堆协议让你看，一直按空格看完，最后输入 <code>yes</code>同意。之后服务就启动了。</p>
<h3 data-id="heading-3">5. 看看能不能用</h3>
<p>打开浏览器，地址栏里输入 <code>http://你这台机器的IP地址</code>（如果是本地机器就用 <code>localhost</code>或者 <code>127.0.0.1</code>），看到 XAMPP 的欢迎页面就说明一切 OK 了。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gradle 全局配置使用]]></title>    <link>https://juejin.cn/post/7593145583348678698</link>    <guid>https://juejin.cn/post/7593145583348678698</guid>    <pubDate>2026-01-10T03:45:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593145583348678698" data-draft-id="7593165280489439273" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gradle 全局配置使用"/> <meta itemprop="keywords" content="gradle,IntelliJ IDEA,Android Studio"/> <meta itemprop="datePublished" content="2026-01-10T03:45:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lzhang1689"/> <meta itemprop="url" content="https://juejin.cn/user/2963939077919255"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gradle 全局配置使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939077919255/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lzhang1689
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T03:45:00.000Z" title="Sat Jan 10 2026 03:45:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、原理</h3>
<p>Gradle 查找依赖时会<strong>按仓库声明顺序依次搜索</strong>，把本地仓库（<code>mavenLocal()</code>）放在所有远程仓库前面，即可实现优先使用本地依赖，本地不存在时才从远程下载。</p>
<h3 data-id="heading-1">二、配置全局初始化文件（关键步骤）</h3>
<p>全局配置文件对所有 Gradle 项目生效，无需逐个项目修改。</p>
<h4 data-id="heading-2">1. 定位 / 创建全局配置文件</h4>
<p>Gradle 全局初始化文件路径：</p>
<ul>
<li><strong>Windows</strong>：<code>C:\Users\&lt;用户名&gt;\.gradle\init.gradle</code>（或<code>init.gradle.kts</code>）</li>
<li><strong>Linux/macOS</strong>：<code>~/.gradle/init.gradle</code>（或<code>init.gradle.kts</code>）</li>
</ul>
<p>如果文件不存在，直接手动创建（无后缀，文件名固定为<code>init.gradle</code>）。</p>
<h4 data-id="heading-3">2. 编写全局仓库配置</h4>
<p>以下提供两种常用 DSL 写法，任选其一：</p>
<h6 data-id="heading-4">写法 1：Groovy DSL（<code>init.gradle</code>）</h6>
<pre><code class="hljs language-groovy" lang="groovy"> // Gradle 全局初始化配置文件
// 路径：Windows(C:\Users\&lt;用户名&gt;\.gradle\init.gradle) / Linux/macOS(~/.gradle/init.gradle)
// 作用：全局优先使用本地Maven仓库，搭配国内镜像加速远程依赖下载

// 1. 全局项目仓库配置（所有项目生效）
allprojects {
    repositories {
        // ==================== 核心：优先使用本地Maven仓库 ====================
        mavenLocal {
            // 替换下方路径为你的本地Maven仓库实际路径（删除注释后生效）
            //url = uri('D:/maven-repository')  // Windows 配置
            //url = uri('/Users/yourname/Documents/maven-repo') // macOS/Linux示例
            // 若使用默认路径（~/.m2/repository），可删除上面的url配置行
        }

        // ==================== 国内镜像仓库（加速远程下载） ====================
        // 阿里云中央仓库
        maven { url 'https://maven.aliyun.com/repository/public' }
        // 阿里云Google仓库（适配Android/Compose）
        maven { url 'https://maven.aliyun.com/repository/google' }
        // 阿里云Gradle插件仓库
        maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
        // 阿里云Spring仓库（如需Spring相关依赖）
        maven { url 'https://maven.aliyun.com/repository/spring' }
        // 阿里云Spring插件仓库
        maven { url 'https://maven.aliyun.com/repository/spring-plugin' }

        // ==================== 官方仓库（兜底） ====================
        google()              // Android/Compose官方仓库
        mavenCentral()        // 中央仓库
        gradlePluginPortal()  // Gradle插件仓库
        maven { url 'https://jitpack.io' } // 第三方开源库仓库（可选）
    }

    // 可选：依赖下载超时配置（解决网络慢导致的下载失败）
    configurations.all {
        resolutionStrategy {
            cacheDynamicVersionsFor 10, 'minutes'
            cacheChangingModulesFor 10, 'minutes'
        }
        // 超时时间设置
        setTimeout(300) // 单位：秒
    }
}

// 2. Gradle插件仓库配置（影响插件下载顺序）
settingsEvaluated { settings -&gt;
    settings.pluginManagement {
        repositories {
            // 插件优先从本地仓库查找
            mavenLocal {
                // 同上面的本地仓库路径，如需自定义则取消注释并修改
                // url = uri('D:/maven-repository')  //Windows示例
                // url = uri('/Users/yourname/Documents/maven-repo') // macOS/Linux示例
            }
            // 插件镜像仓库
            maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
            // 官方插件仓库兜底
            gradlePluginPortal()
            google()
            mavenCentral()
        }
    }
}

// 3. 可选：构建优化配置
gradle.projectsLoaded {
    rootProject.allprojects {
        buildDir = "${rootProject.rootDir}/.gradle-build/${project.name}"
    }
}

// 4. 可选：打印依赖查找日志（验证本地仓库是否生效）
gradle.addBuildListener(new BuildListener() {
    @Override
    void buildStarted(Gradle gradle) {
        println "===== Gradle 构建开始：优先使用本地仓库 ====="
    }

    @Override
    void settingsEvaluated(Settings settings) {}

    @Override
    void projectsLoaded(Gradle gradle) {}

    @Override
    void projectsEvaluated(Gradle gradle) {}

    @Override
    void buildFinished(BuildResult result) {
        println "===== Gradle 构建结束：本地仓库优先配置已生效 ====="
    }
})
</code></pre>
<h6 data-id="heading-5">写法 2：Kotlin DSL（<code>init.gradle.kts</code>）</h6>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-comment">// Gradle 全局初始化配置文件（Kotlin DSL）</span>
<span class="hljs-comment">// 路径：Windows(C:\Users\&lt;用户名&gt;\.gradle\init.gradle.kts) / Linux/macOS(~/.gradle/init.gradle.kts)</span>
<span class="hljs-comment">// 作用：全局优先使用本地Maven仓库，搭配阿里云镜像加速远程依赖下载</span>

<span class="hljs-comment">// 1. 全局项目仓库配置（所有Gradle项目生效）</span>
allprojects {
    repositories {
        <span class="hljs-comment">// ==================== 核心：优先使用本地Maven仓库 ====================</span>
        mavenLocal {
            <span class="hljs-comment">// 替换下方路径为你的本地Maven仓库实际路径（删除注释后生效）</span>
            <span class="hljs-comment">// url = uri("D:/maven-repository") // Windows示例</span>
            <span class="hljs-comment">// url = uri("/Users/yourname/.m2/repository") // macOS/Linux示例</span>
            <span class="hljs-comment">// 若使用默认路径（~/.m2/repository），直接注释掉url配置行即可</span>
        }

        <span class="hljs-comment">// ==================== 国内镜像仓库（加速远程下载） ====================</span>
        <span class="hljs-comment">// 阿里云中央仓库（适配Java/Kotlin基础依赖）</span>
        maven(<span class="hljs-string">"https://maven.aliyun.com/repository/public"</span>)
        <span class="hljs-comment">// 阿里云Google仓库（适配Android/Compose核心依赖）</span>
        maven(<span class="hljs-string">"https://maven.aliyun.com/repository/google"</span>)
        <span class="hljs-comment">// 阿里云Gradle插件仓库（适配Android Gradle插件）</span>
        maven(<span class="hljs-string">"https://maven.aliyun.com/repository/gradle-plugin"</span>)
        <span class="hljs-comment">// 阿里云Spring仓库（如需Spring相关依赖，可选）</span>
        maven(<span class="hljs-string">"https://maven.aliyun.com/repository/spring"</span>)
        <span class="hljs-comment">// 阿里云Spring插件仓库（可选）</span>
        maven(<span class="hljs-string">"https://maven.aliyun.com/repository/spring-plugin"</span>)
        <span class="hljs-comment">// JitPack（第三方开源库，如GitHub依赖，可选）</span>
        maven(<span class="hljs-string">"https://jitpack.io"</span>)

        <span class="hljs-comment">// ==================== 官方仓库（兜底，不可删除） ====================</span>
        google()              <span class="hljs-comment">// Android/Compose官方核心仓库</span>
        mavenCentral()        <span class="hljs-comment">// Maven中央仓库</span>
        gradlePluginPortal()  <span class="hljs-comment">// Gradle插件官方仓库</span>
    }

    <span class="hljs-comment">// 可选：依赖下载超时&amp;缓存优化（解决Android依赖下载慢/失败）</span>
    configurations.all {
        resolutionStrategy {
            <span class="hljs-comment">// 动态版本缓存时间</span>
            cacheDynamicVersionsFor(<span class="hljs-number">10</span>, <span class="hljs-string">"minutes"</span>)
            <span class="hljs-comment">// 快照版本缓存时间</span>
            cacheChangingModulesFor(<span class="hljs-number">10</span>, <span class="hljs-string">"minutes"</span>)
        }
        <span class="hljs-comment">// 依赖下载超时时间（单位：秒）</span>
        setTimeout(<span class="hljs-number">300</span>)
    }
}

<span class="hljs-comment">// 2. Gradle插件仓库配置（影响Android Gradle插件、自定义插件的下载顺序）</span>
settingsEvaluated {
    pluginManagement {
        repositories {
            <span class="hljs-comment">// 插件优先从本地仓库查找</span>
            mavenLocal {
                <span class="hljs-comment">// 同上面的本地仓库路径，如需自定义则取消注释并修改</span>
                <span class="hljs-comment">// url = uri("D:/maven-repository") //Windows示例</span>
                <span class="hljs-comment">// url = uri("/Users/yourname/.m2/repository") // macOS/Linux示例</span>
            }
            <span class="hljs-comment">// 插件镜像仓库</span>
            maven(<span class="hljs-string">"https://maven.aliyun.com/repository/gradle-plugin"</span>)
            <span class="hljs-comment">// 官方插件仓库兜底</span>
            gradlePluginPortal()
            google()
            mavenCentral()
        }
    }
}

<span class="hljs-comment">// 3. 可选：Android项目构建目录优化（避免模块间构建目录分散）</span>
gradle.projectsLoaded {
    rootProject.allprojects {
        buildDir = file(<span class="hljs-string">"<span class="hljs-subst">${rootProject.rootDir}</span>/.gradle-build/<span class="hljs-subst">${project.name}</span>"</span>)
    }
}

<span class="hljs-comment">// 4. 可选：打印构建日志（验证本地仓库配置是否生效）</span>
gradle.addBuildListener(<span class="hljs-keyword">object</span> : BuildListener {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildStarted</span><span class="hljs-params">(gradle: <span class="hljs-type">Gradle</span>)</span></span> {
        println(<span class="hljs-string">"===== Gradle 构建开始：优先使用本地仓库（Kotlin DSL配置） ====="</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">settingsEvaluated</span><span class="hljs-params">(settings: <span class="hljs-type">Settings</span>)</span></span> {}
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">projectsLoaded</span><span class="hljs-params">(gradle: <span class="hljs-type">Gradle</span>)</span></span> {}
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">projectsEvaluated</span><span class="hljs-params">(gradle: <span class="hljs-type">Gradle</span>)</span></span> {}
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildFinished</span><span class="hljs-params">(result: <span class="hljs-type">BuildResult</span>)</span></span> {
        <span class="hljs-keyword">val</span> status = <span class="hljs-keyword">if</span> (result.failure == <span class="hljs-literal">null</span>) <span class="hljs-string">"成功"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"失败"</span>
        println(<span class="hljs-string">"===== Gradle 构建结束：本地仓库优先配置已生效（构建<span class="hljs-subst">${status}</span>） ====="</span>)
    }
})

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员武学修炼手册（二）：进阶篇——小有所成，从能跑就行到知其所以然]]></title>    <link>https://juejin.cn/post/7593215107405660196</link>    <guid>https://juejin.cn/post/7593215107405660196</guid>    <pubDate>2026-01-10T01:42:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593215107405660196" data-draft-id="7593139476841496582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员武学修炼手册（二）：进阶篇——小有所成，从能跑就行到知其所以然"/> <meta itemprop="keywords" content="程序员,前端"/> <meta itemprop="datePublished" content="2026-01-10T01:42:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员武学修炼手册（二）：进阶篇——小有所成，从能跑就行到知其所以然
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T01:42:19.000Z" title="Sat Jan 10 2026 01:42:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"入门弟子求的是'能用'，三流高手求的是'好用'。"
—— 《程序员武学心法》</p>
</blockquote>
<h2 data-id="heading-0">前情回顾</h2>
<p>在上一篇中，我们讲述了初学乍练的修炼——那个"Hello World"到"能跑就行"的阶段。</p>
<p>当你开始思考"为什么要这样写"而不是"怎么让它跑起来"的时候，恭喜你，你已经踏入了<strong>小有所成</strong>的大门，成为了江湖上的三流高手。</p>
<hr/>
<h2 data-id="heading-1">第一章：小有所成的特征</h2>
<h3 data-id="heading-2">1.1 什么是小有所成？</h3>
<p>小有所成，是程序员从"会写代码"到"会写好代码"的关键阶段。</p>
<p>就像武侠小说里，弟子从"会几招花拳绣腿"到"开始修炼内功心法"的转变，虽然还算不上一流高手，但已经能在江湖上行走了。</p>
<p><strong>小有所成程序员的典型特征：</strong></p>
<ul>
<li>开始关注代码规范</li>
<li>知道什么是"代码坏味道"</li>
<li>会写单元测试（虽然经常偷懒不写）</li>
<li>开始使用设计模式（虽然经常用错）</li>
<li>Git 不再只会<code>add</code>、<code>commit</code>、<code>push</code></li>
</ul>
<h3 data-id="heading-3">1.2 初学乍练 vs 小有所成</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同一个需求，不同境界的实现</span>

<span class="hljs-comment">// 需求：根据用户类型返回不同的折扣</span>

<span class="hljs-comment">// 初学乍练写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getDiscount</span>(<span class="hljs-params">userType</span>) {
  <span class="hljs-keyword">if</span> (userType === <span class="hljs-string">"normal"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userType === <span class="hljs-string">"vip"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0.1</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userType === <span class="hljs-string">"svip"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0.2</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userType === <span class="hljs-string">"partner"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0.3</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  }
}

<span class="hljs-comment">// 小有所成写法</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DISCOUNT_MAP</span> = {
  <span class="hljs-attr">normal</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">vip</span>: <span class="hljs-number">0.1</span>,
  <span class="hljs-attr">svip</span>: <span class="hljs-number">0.2</span>,
  <span class="hljs-attr">partner</span>: <span class="hljs-number">0.3</span>,
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getDiscount</span>(<span class="hljs-params">userType</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">DISCOUNT_MAP</span>[userType] ?? <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 区别：</span>
<span class="hljs-comment">// 1. 配置与逻辑分离</span>
<span class="hljs-comment">// 2. 新增类型只需改配置，不需改代码</span>
<span class="hljs-comment">// 3. 更容易测试</span>
<span class="hljs-comment">// 4. 更容易理解</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">第二章：小有所成的修炼内容</h2>
<h3 data-id="heading-5">2.1 第一式：代码规范</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 小有所成必修：代码规范</span>

<span class="hljs-comment">// ===== 命名规范 =====</span>

<span class="hljs-comment">// 变量：小驼峰，名词</span>
<span class="hljs-keyword">const</span> userName = <span class="hljs-string">"张三"</span>
<span class="hljs-keyword">const</span> userAge = <span class="hljs-number">18</span>
<span class="hljs-keyword">const</span> isActive = <span class="hljs-literal">true</span> <span class="hljs-comment">// 布尔值用is/has/can开头</span>

<span class="hljs-comment">// 函数：小驼峰，动词开头</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params"/>) {}

<span class="hljs-comment">// 类：大驼峰</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderManager</span> {}

<span class="hljs-comment">// 常量：全大写，下划线分隔</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_RETRY_COUNT</span> = <span class="hljs-number">3</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_BASE_URL</span> = <span class="hljs-string">"https://api.example.com"</span>

<span class="hljs-comment">// ===== 格式规范 =====</span>

<span class="hljs-comment">// 缩进：2空格或4空格，团队统一即可</span>
<span class="hljs-comment">// 行宽：80-120字符</span>
<span class="hljs-comment">// 空行：逻辑块之间空一行</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">order</span>) {
  <span class="hljs-comment">// 参数校验</span>
  <span class="hljs-keyword">if</span> (!order) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Order is required"</span>)
  }

  <span class="hljs-comment">// 业务逻辑</span>
  <span class="hljs-keyword">const</span> total = <span class="hljs-title function_">calculateTotal</span>(order)
  <span class="hljs-keyword">const</span> discount = <span class="hljs-title function_">getDiscount</span>(order.<span class="hljs-property">user</span>)
  <span class="hljs-keyword">const</span> finalPrice = total * (<span class="hljs-number">1</span> - discount)

  <span class="hljs-comment">// 返回结果</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">orderId</span>: order.<span class="hljs-property">id</span>,
    finalPrice,
  }
}
</code></pre>
<h3 data-id="heading-6">2.2 第二式：函数的艺术</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 小有所成的函数修炼</span>

<span class="hljs-comment">// ===== 原则1：单一职责 =====</span>

<span class="hljs-comment">// 不好：一个函数做太多事</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUser</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-comment">// 验证</span>
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">email</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Email required"</span>)
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">name</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Name required"</span>)

  <span class="hljs-comment">// 格式化</span>
  user.<span class="hljs-property">email</span> = user.<span class="hljs-property">email</span>.<span class="hljs-title function_">toLowerCase</span>()
  user.<span class="hljs-property">name</span> = user.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>()

  <span class="hljs-comment">// 保存</span>
  database.<span class="hljs-title function_">save</span>(user)

  <span class="hljs-comment">// 发送邮件</span>
  <span class="hljs-title function_">sendWelcomeEmail</span>(user.<span class="hljs-property">email</span>)

  <span class="hljs-comment">// 记录日志</span>
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"User created"</span>, user)
}

<span class="hljs-comment">// 好：每个函数只做一件事</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateUser</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">email</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Email required"</span>)
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">name</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Name required"</span>)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatUser</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-keyword">return</span> {
    ...user,
    <span class="hljs-attr">email</span>: user.<span class="hljs-property">email</span>.<span class="hljs-title function_">toLowerCase</span>(),
    <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>(),
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-title function_">validateUser</span>(user)
  <span class="hljs-keyword">const</span> formattedUser = <span class="hljs-title function_">formatUser</span>(user)
  database.<span class="hljs-title function_">save</span>(formattedUser)
  <span class="hljs-title function_">sendWelcomeEmail</span>(formattedUser.<span class="hljs-property">email</span>)
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"User created"</span>, formattedUser)
}

<span class="hljs-comment">// ===== 原则2：参数不要太多 =====</span>

<span class="hljs-comment">// 不好：参数太多</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">
  userId,
  productId,
  quantity,
  price,
  discount,
  address,
  phone,
  note
</span>) {
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 好：使用对象参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-keyword">const</span> { userId, productId, quantity, price, discount, address, phone, note } =
    options
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 或者使用TypeScript定义接口</span>
interface <span class="hljs-title class_">CreateOrderOptions</span> {
  <span class="hljs-attr">userId</span>: string;
  <span class="hljs-attr">productId</span>: string;
  <span class="hljs-attr">quantity</span>: number;
  <span class="hljs-attr">price</span>: number;
  discount?: number;
  <span class="hljs-attr">address</span>: string;
  <span class="hljs-attr">phone</span>: string;
  note?: string;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createOrder</span>(<span class="hljs-params">options: CreateOrderOptions</span>) {
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ===== 原则3：避免副作用 =====</span>

<span class="hljs-comment">// 不好：修改了传入的参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addItem</span>(<span class="hljs-params">cart, item</span>) {
  cart.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>(item) <span class="hljs-comment">// 修改了原数组</span>
  cart.<span class="hljs-property">total</span> += item.<span class="hljs-property">price</span> <span class="hljs-comment">// 修改了原对象</span>
  <span class="hljs-keyword">return</span> cart
}

<span class="hljs-comment">// 好：返回新对象</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addItem</span>(<span class="hljs-params">cart, item</span>) {
  <span class="hljs-keyword">return</span> {
    ...cart,
    <span class="hljs-attr">items</span>: [...cart.<span class="hljs-property">items</span>, item],
    <span class="hljs-attr">total</span>: cart.<span class="hljs-property">total</span> + item.<span class="hljs-property">price</span>,
  }
}
</code></pre>
<h3 data-id="heading-7">2.3 第三式：错误处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 小有所成的错误处理修炼</span>

<span class="hljs-comment">// ===== 初学乍练的错误处理 =====</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> database.<span class="hljs-title function_">findUser</span>(id)
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e) <span class="hljs-comment">// 打印一下就完事了</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }
}

<span class="hljs-comment">// ===== 小有所成的错误处理 =====</span>

<span class="hljs-comment">// 1. 定义明确的错误类型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-variable language_">super</span>(message)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"ValidationError"</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NotFoundError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">resource, id</span>) {
    <span class="hljs-variable language_">super</span>(<span class="hljs-string">`<span class="hljs-subst">${resource}</span> with id <span class="hljs-subst">${id}</span> not found`</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"NotFoundError"</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resource</span> = resource
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message, originalError</span>) {
    <span class="hljs-variable language_">super</span>(message)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"DatabaseError"</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">originalError</span> = originalError
  }
}

<span class="hljs-comment">// 2. 在合适的层级处理错误</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">if</span> (!id) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationError</span>(<span class="hljs-string">"User ID is required"</span>)
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> user = database.<span class="hljs-title function_">findUser</span>(id)
    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundError</span>(<span class="hljs-string">"User"</span>, id)
    }
    <span class="hljs-keyword">return</span> user
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">NotFoundError</span>) {
      <span class="hljs-keyword">throw</span> error <span class="hljs-comment">// 业务错误，继续抛出</span>
    }
    <span class="hljs-comment">// 数据库错误，包装后抛出</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DatabaseError</span>(<span class="hljs-string">"Failed to fetch user"</span>, error)
  }
}

<span class="hljs-comment">// 3. 在最外层统一处理</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">req, res</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>)
    res.<span class="hljs-title function_">json</span>(user)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ValidationError</span>) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> })
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">NotFoundError</span>) {
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 未知错误，记录日志，返回通用错误</span>
      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Unexpected error"</span>, error)
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">"Internal server error"</span> })
    }
  }
}
</code></pre>
<h3 data-id="heading-8">2.4 第四式：单元测试</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 小有所成必修：单元测试</span>

<span class="hljs-comment">// 被测试的函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculatePrice</span>(<span class="hljs-params">basePrice, quantity, discount = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">if</span> (basePrice &lt; <span class="hljs-number">0</span> || quantity &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Price and quantity must be non-negative"</span>)
  }
  <span class="hljs-keyword">if</span> (discount &lt; <span class="hljs-number">0</span> || discount &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Discount must be between 0 and 1"</span>)
  }

  <span class="hljs-keyword">const</span> subtotal = basePrice * quantity
  <span class="hljs-keyword">const</span> discountAmount = subtotal * discount
  <span class="hljs-keyword">return</span> subtotal - discountAmount
}

<span class="hljs-comment">// 单元测试</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"calculatePrice"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 正常情况</span>
  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should calculate price without discount"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculatePrice</span>(<span class="hljs-number">100</span>, <span class="hljs-number">2</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">200</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should calculate price with discount"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculatePrice</span>(<span class="hljs-number">100</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0.1</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">180</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should handle zero quantity"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculatePrice</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">0</span>)
  })

  <span class="hljs-comment">// 边界情况</span>
  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should handle 100% discount"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculatePrice</span>(<span class="hljs-number">100</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">0</span>)
  })

  <span class="hljs-comment">// 错误情况</span>
  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should throw error for negative price"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">calculatePrice</span>(-<span class="hljs-number">100</span>, <span class="hljs-number">2</span>)).<span class="hljs-title function_">toThrow</span>(
      <span class="hljs-string">"Price and quantity must be non-negative"</span>
    )
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should throw error for invalid discount"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">calculatePrice</span>(<span class="hljs-number">100</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1.5</span>)).<span class="hljs-title function_">toThrow</span>(
      <span class="hljs-string">"Discount must be between 0 and 1"</span>
    )
  })
})

<span class="hljs-comment">// 测试覆盖的三个维度：</span>
<span class="hljs-comment">// 1. 正常路径（Happy Path）</span>
<span class="hljs-comment">// 2. 边界条件（Edge Cases）</span>
<span class="hljs-comment">// 3. 错误情况（Error Cases）</span>
</code></pre>
<h3 data-id="heading-9">2.5 第五式：设计模式入门</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 小有所成的设计模式修炼</span>

<span class="hljs-comment">// ===== 模式1：单例模式 =====</span>
<span class="hljs-comment">// 场景：全局只需要一个实例</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {
  <span class="hljs-keyword">static</span> instance = <span class="hljs-literal">null</span>

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Logger</span>.<span class="hljs-property">instance</span>) {
      <span class="hljs-title class_">Logger</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>()
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Logger</span>.<span class="hljs-property">instance</span>
  }

  <span class="hljs-title function_">log</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>] <span class="hljs-subst">${message}</span>`</span>)
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> logger1 = <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">getInstance</span>()
<span class="hljs-keyword">const</span> logger2 = <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">getInstance</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(logger1 === logger2) <span class="hljs-comment">// true</span>

<span class="hljs-comment">// ===== 模式2：工厂模式 =====</span>
<span class="hljs-comment">// 场景：根据条件创建不同类型的对象</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserFactory</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">type, data</span>) {
    <span class="hljs-keyword">switch</span> (type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"admin"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdminUser</span>(data)
      <span class="hljs-keyword">case</span> <span class="hljs-string">"vip"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VipUser</span>(data)
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NormalUser</span>(data)
    }
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> admin = <span class="hljs-title class_">UserFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">"admin"</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">"管理员"</span> })
<span class="hljs-keyword">const</span> vip = <span class="hljs-title class_">UserFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">"vip"</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">"VIP用户"</span> })

<span class="hljs-comment">// ===== 模式3：策略模式 =====</span>
<span class="hljs-comment">// 场景：根据不同情况使用不同的算法</span>

<span class="hljs-comment">// 不好：if-else地狱</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateShipping</span>(<span class="hljs-params">type, weight</span>) {
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">"standard"</span>) {
    <span class="hljs-keyword">return</span> weight * <span class="hljs-number">5</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">"express"</span>) {
    <span class="hljs-keyword">return</span> weight * <span class="hljs-number">10</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">"overnight"</span>) {
    <span class="hljs-keyword">return</span> weight * <span class="hljs-number">20</span>
  }
}

<span class="hljs-comment">// 好：策略模式</span>
<span class="hljs-keyword">const</span> shippingStrategies = {
  <span class="hljs-attr">standard</span>: <span class="hljs-function">(<span class="hljs-params">weight</span>) =&gt;</span> weight * <span class="hljs-number">5</span>,
  <span class="hljs-attr">express</span>: <span class="hljs-function">(<span class="hljs-params">weight</span>) =&gt;</span> weight * <span class="hljs-number">10</span>,
  <span class="hljs-attr">overnight</span>: <span class="hljs-function">(<span class="hljs-params">weight</span>) =&gt;</span> weight * <span class="hljs-number">20</span>,
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateShipping</span>(<span class="hljs-params">type, weight</span>) {
  <span class="hljs-keyword">const</span> strategy = shippingStrategies[type]
  <span class="hljs-keyword">if</span> (!strategy) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Unknown shipping type: <span class="hljs-subst">${type}</span>`</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">strategy</span>(weight)
}

<span class="hljs-comment">// ===== 模式4：观察者模式 =====</span>
<span class="hljs-comment">// 场景：一个对象状态变化时通知其他对象</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventEmitter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = {}
  }

  <span class="hljs-title function_">on</span>(<span class="hljs-params">event, callback</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event]) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event] = []
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event].<span class="hljs-title function_">push</span>(callback)
  }

  <span class="hljs-title function_">off</span>(<span class="hljs-params">event, callback</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event]) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event].<span class="hljs-title function_">filter</span>(
      <span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> cb !== callback
    )
  }

  <span class="hljs-title function_">emit</span>(<span class="hljs-params">event, data</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event]) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>[event].<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> <span class="hljs-title function_">callback</span>(data))
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> emitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventEmitter</span>()

emitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">"userCreated"</span>, <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发送欢迎邮件给"</span>, user.<span class="hljs-property">email</span>)
})

emitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">"userCreated"</span>, <span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"记录日志"</span>, user.<span class="hljs-property">name</span>)
})

emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"userCreated"</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"test@example.com"</span> })
</code></pre>
<h3 data-id="heading-10">2.6 第六式：Git 进阶</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 筑基期的Git修炼</span>

<span class="hljs-comment"># ===== 练气期的Git =====</span>
git add .
git commit -m <span class="hljs-string">"update"</span>
git push
<span class="hljs-comment"># 完事！</span>

<span class="hljs-comment"># ===== 小有所成的Git =====</span>

<span class="hljs-comment"># 1. 有意义的提交信息</span>
git commit -m <span class="hljs-string">"feat: 添加用户注册功能"</span>
git commit -m <span class="hljs-string">"fix: 修复登录页面样式错位问题"</span>
git commit -m <span class="hljs-string">"refactor: 重构订单计算逻辑"</span>
git commit -m <span class="hljs-string">"docs: 更新API文档"</span>
git commit -m <span class="hljs-string">"test: 添加用户服务单元测试"</span>

<span class="hljs-comment"># 提交信息格式：&lt;type&gt;: &lt;description&gt;</span>
<span class="hljs-comment"># type: feat, fix, refactor, docs, test, chore, style</span>

<span class="hljs-comment"># 2. 分支管理</span>
git checkout -b feature/user-registration  <span class="hljs-comment"># 功能分支</span>
git checkout -b bugfix/login-style         <span class="hljs-comment"># 修复分支</span>
git checkout -b hotfix/security-patch      <span class="hljs-comment"># 紧急修复</span>

<span class="hljs-comment"># 3. 合并前先rebase</span>
git checkout feature/user-registration
git rebase main  <span class="hljs-comment"># 把main的最新代码合并进来</span>
git checkout main
git merge feature/user-registration

<span class="hljs-comment"># 4. 交互式rebase整理提交</span>
git rebase -i HEAD~3  <span class="hljs-comment"># 整理最近3个提交</span>
<span class="hljs-comment"># 可以合并、修改、删除提交</span>

<span class="hljs-comment"># 5. 暂存工作区</span>
git stash           <span class="hljs-comment"># 暂存当前修改</span>
git stash list      <span class="hljs-comment"># 查看暂存列表</span>
git stash pop       <span class="hljs-comment"># 恢复最近的暂存</span>
git stash drop      <span class="hljs-comment"># 删除最近的暂存</span>

<span class="hljs-comment"># 6. 查看历史</span>
git <span class="hljs-built_in">log</span> --oneline --graph  <span class="hljs-comment"># 图形化查看提交历史</span>
git blame file.js          <span class="hljs-comment"># 查看每行代码是谁写的</span>
git diff HEAD~1            <span class="hljs-comment"># 查看最近一次提交的改动</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">第三章：小有所成的常见瓶颈</h2>
<h3 data-id="heading-12">3.1 过度设计</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 症状：简单问题复杂化</span>

<span class="hljs-comment">// 需求：计算两个数的和</span>

<span class="hljs-comment">// 过度设计版本</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">strategy</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">strategy</span> = strategy
  }

  <span class="hljs-title function_">setStrategy</span>(<span class="hljs-params">strategy</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">strategy</span> = strategy
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">strategy</span>.<span class="hljs-title function_">calculate</span>(a, b)
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AddStrategy</span> {
  <span class="hljs-title function_">calculate</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CalculatorFactory</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">type</span>) {
    <span class="hljs-keyword">switch</span> (type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"add"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AddStrategy</span>())
      <span class="hljs-comment">// ...更多策略</span>
    }
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> calculator = <span class="hljs-title class_">CalculatorFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">"add"</span>)
<span class="hljs-keyword">const</span> result = calculator.<span class="hljs-title function_">execute</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

<span class="hljs-comment">// 正常版本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b
}

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

<span class="hljs-comment">// 教训：不要为了用设计模式而用设计模式</span>
<span class="hljs-comment">// YAGNI原则：You Ain't Gonna Need It</span>
</code></pre>
<h3 data-id="heading-13">3.2 测试覆盖率焦虑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 症状：追求100%测试覆盖率</span>

<span class="hljs-comment">// 被测试的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>
}

<span class="hljs-comment">// 过度测试</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"greet"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should greet with name"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">"World"</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"Hello, World!"</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should greet with different name"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">"Alice"</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"Hello, Alice!"</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should greet with another name"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">"Bob"</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"Hello, Bob!"</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should greet with Chinese name"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">"张三"</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"Hello, 张三!"</span>)
  })

  <span class="hljs-comment">// 这些测试本质上是一样的，没有额外价值</span>
})

<span class="hljs-comment">// 合理的测试</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"greet"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should return greeting with provided name"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">"World"</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"Hello, World!"</span>)
  })

  <span class="hljs-title function_">test</span>(<span class="hljs-string">"should handle empty name"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">""</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"Hello, !"</span>)
  })

  <span class="hljs-comment">// 测试有意义的边界情况，而不是重复测试同样的逻辑</span>
})
</code></pre>
<h3 data-id="heading-14">3.3 规范教条主义</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 症状：死守规范，不知变通</span>

<span class="hljs-comment">// 规范说：函数不超过20行</span>
<span class="hljs-comment">// 于是...</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder_part1</span>(<span class="hljs-params">order</span>) {
  <span class="hljs-comment">// 第1-20行</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder_part2</span>(<span class="hljs-params">order</span>) {
  <span class="hljs-comment">// 第21-40行</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder_part3</span>(<span class="hljs-params">order</span>) {
  <span class="hljs-comment">// 第41-60行</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">order</span>) {
  <span class="hljs-title function_">processOrder_part1</span>(order)
  <span class="hljs-title function_">processOrder_part2</span>(order)
  <span class="hljs-title function_">processOrder_part3</span>(order)
}

<span class="hljs-comment">// 这样拆分毫无意义，反而更难理解</span>

<span class="hljs-comment">// 正确理解：规范是指导，不是法律</span>
<span class="hljs-comment">// 如果一个函数逻辑上是一个整体，50行也可以接受</span>
<span class="hljs-comment">// 关键是：代码是否清晰、是否容易理解</span>
</code></pre>
<hr/>
<h2 data-id="heading-15">第四章：小有所成的突破契机</h2>
<h3 data-id="heading-16">4.1 第一次重构遗留代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你接手的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">d</span>) {
  <span class="hljs-keyword">var</span> r = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; d.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (d[i].<span class="hljs-property">t</span> == <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (d[i].<span class="hljs-property">s</span> == <span class="hljs-string">"a"</span>) {
        r.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">n</span>: d[i].<span class="hljs-property">n</span>, <span class="hljs-attr">v</span>: d[i].<span class="hljs-property">v</span> * <span class="hljs-number">1.1</span> })
      } <span class="hljs-keyword">else</span> {
        r.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">n</span>: d[i].<span class="hljs-property">n</span>, <span class="hljs-attr">v</span>: d[i].<span class="hljs-property">v</span> })
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (d[i].<span class="hljs-property">t</span> == <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">if</span> (d[i].<span class="hljs-property">s</span> == <span class="hljs-string">"a"</span>) {
        r.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">n</span>: d[i].<span class="hljs-property">n</span>, <span class="hljs-attr">v</span>: d[i].<span class="hljs-property">v</span> * <span class="hljs-number">1.2</span> })
      } <span class="hljs-keyword">else</span> {
        r.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">n</span>: d[i].<span class="hljs-property">n</span>, <span class="hljs-attr">v</span>: d[i].<span class="hljs-property">v</span> * <span class="hljs-number">1.05</span> })
      }
    }
  }
  <span class="hljs-keyword">return</span> r
}

<span class="hljs-comment">// 你的重构</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MULTIPLIERS</span> = {
  <span class="hljs-number">1</span>: { <span class="hljs-attr">a</span>: <span class="hljs-number">1.1</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">1</span> },
  <span class="hljs-number">2</span>: { <span class="hljs-attr">a</span>: <span class="hljs-number">1.2</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">1.05</span> },
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateValue</span>(<span class="hljs-params">item</span>) {
  <span class="hljs-keyword">const</span> typeMultipliers = <span class="hljs-variable constant_">MULTIPLIERS</span>[item.<span class="hljs-property">type</span>]
  <span class="hljs-keyword">if</span> (!typeMultipliers) <span class="hljs-keyword">return</span> item.<span class="hljs-property">value</span>

  <span class="hljs-keyword">const</span> multiplier = typeMultipliers[item.<span class="hljs-property">status</span>] || typeMultipliers.<span class="hljs-property">default</span>
  <span class="hljs-keyword">return</span> item.<span class="hljs-property">value</span> * multiplier
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processItems</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-keyword">return</span> items
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-variable constant_">MULTIPLIERS</span>[item.<span class="hljs-property">type</span>])
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> ({
      <span class="hljs-attr">name</span>: item.<span class="hljs-property">name</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-title function_">calculateValue</span>(item),
    }))
}

<span class="hljs-comment">// 重构的收获：</span>
<span class="hljs-comment">// 1. 理解了代码的业务逻辑</span>
<span class="hljs-comment">// 2. 学会了如何让代码更清晰</span>
<span class="hljs-comment">// 3. 体会到了好代码和烂代码的区别</span>
</code></pre>
<h3 data-id="heading-17">4.2 第一次 Code Review 别人</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你Review的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserData</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/users/"</span> + userId)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> data
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)
    })
}

<span class="hljs-comment">// 你的Review意见</span>
<span class="hljs-comment">/*
 * 1. 使用模板字符串代替字符串拼接
 * 2. .then(data =&gt; { return data }) 可以简化
 * 3. 错误处理不完整，catch后应该重新抛出或返回默认值
 * 4. 建议使用async/await提高可读性
 *
 * 建议修改为：
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserData</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>)
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP error! status: <span class="hljs-subst">${response.status}</span>`</span>)
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to fetch user:"</span>, error)
    <span class="hljs-keyword">throw</span> error <span class="hljs-comment">// 让调用者决定如何处理</span>
  }
}

<span class="hljs-comment">// Review别人代码的收获：</span>
<span class="hljs-comment">// 1. 巩固了自己的知识</span>
<span class="hljs-comment">// 2. 学会了从不同角度看问题</span>
<span class="hljs-comment">// 3. 提高了代码审美</span>
</code></pre>
<h3 data-id="heading-18">4.3 第一次性能优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 问题：页面加载很慢</span>

<span class="hljs-comment">// 原始代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderUserList</span>(<span class="hljs-params">users</span>) {
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"user-list"</span>)

  users.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>)
    div.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;h3&gt;<span class="hljs-subst">${user.name}</span>&lt;/h3&gt;
      &lt;p&gt;<span class="hljs-subst">${user.email}</span>&lt;/p&gt;
    `</span>
    container.<span class="hljs-title function_">appendChild</span>(div) <span class="hljs-comment">// 每次都触发重排</span>
  })
}

<span class="hljs-comment">// 优化后</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderUserList</span>(<span class="hljs-params">users</span>) {
  <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"user-list"</span>)
  <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>()

  users.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">user</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>)
    div.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;h3&gt;<span class="hljs-subst">${user.name}</span>&lt;/h3&gt;
      &lt;p&gt;<span class="hljs-subst">${user.email}</span>&lt;/p&gt;
    `</span>
    fragment.<span class="hljs-title function_">appendChild</span>(div) <span class="hljs-comment">// 先添加到fragment</span>
  })

  container.<span class="hljs-title function_">appendChild</span>(fragment) <span class="hljs-comment">// 一次性添加到DOM</span>
}

<span class="hljs-comment">// 进一步优化：虚拟列表</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderUserListVirtual</span>(<span class="hljs-params">users, visibleCount = <span class="hljs-number">20</span></span>) {
  <span class="hljs-comment">// 只渲染可见区域的元素</span>
  <span class="hljs-comment">// 滚动时动态更新</span>
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 性能优化的收获：</span>
<span class="hljs-comment">// 1. 理解了浏览器渲染原理</span>
<span class="hljs-comment">// 2. 学会了性能分析工具</span>
<span class="hljs-comment">// 3. 知道了"过早优化是万恶之源"，但也知道了什么时候该优化</span>
</code></pre>
<hr/>
<h2 data-id="heading-19">第五章：小有所成的修炼心法</h2>
<h3 data-id="heading-20">5.1 心法一：代码是负债，不是资产</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初学乍练的认知</span>
<span class="hljs-comment">// "我写了1000行代码，好有成就感！"</span>

<span class="hljs-comment">// 筑基期的认知</span>
<span class="hljs-comment">// "代码越少越好，能用100行解决的问题，不要写200行"</span>

<span class="hljs-comment">// 实践</span>
<span class="hljs-comment">// 不好：代码很多，但很多是重复的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateName</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">if</span> (!name) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (name.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (name.<span class="hljs-property">length</span> &gt; <span class="hljs-number">50</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params">email</span>) {
  <span class="hljs-keyword">if</span> (!email) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (!email.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"@"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (email.<span class="hljs-property">length</span> &gt; <span class="hljs-number">100</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validatePhone</span>(<span class="hljs-params">phone</span>) {
  <span class="hljs-keyword">if</span> (!phone) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (phone.<span class="hljs-property">length</span> !== <span class="hljs-number">11</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/^\d+$/</span>.<span class="hljs-title function_">test</span>(phone)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-comment">// 好：抽象公共逻辑</span>
<span class="hljs-keyword">const</span> validators = {
  <span class="hljs-attr">name</span>: [
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> !!v, <span class="hljs-attr">message</span>: <span class="hljs-string">"Name is required"</span> },
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">2</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"Name too short"</span> },
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">50</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"Name too long"</span> },
  ],
  <span class="hljs-attr">email</span>: [
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> !!v, <span class="hljs-attr">message</span>: <span class="hljs-string">"Email is required"</span> },
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"@"</span>), <span class="hljs-attr">message</span>: <span class="hljs-string">"Invalid email"</span> },
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">100</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"Email too long"</span> },
  ],
  <span class="hljs-attr">phone</span>: [
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> !!v, <span class="hljs-attr">message</span>: <span class="hljs-string">"Phone is required"</span> },
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">length</span> === <span class="hljs-number">11</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"Phone must be 11 digits"</span> },
    { <span class="hljs-attr">check</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> <span class="hljs-regexp">/^\d+$/</span>.<span class="hljs-title function_">test</span>(v), <span class="hljs-attr">message</span>: <span class="hljs-string">"Phone must be numeric"</span> },
  ],
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">field, value</span>) {
  <span class="hljs-keyword">const</span> rules = validators[field]
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rule <span class="hljs-keyword">of</span> rules) {
    <span class="hljs-keyword">if</span> (!rule.<span class="hljs-title function_">check</span>(value)) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">valid</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: rule.<span class="hljs-property">message</span> }
    }
  }
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">valid</span>: <span class="hljs-literal">true</span> }
}
</code></pre>
<h3 data-id="heading-21">5.2 心法二：可读性优于性能（大多数时候）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初学乍练的认知</span>
<span class="hljs-comment">// "这样写性能更好！"</span>

<span class="hljs-comment">// 筑基期的认知</span>
<span class="hljs-comment">// "先让代码可读，性能问题等出现了再优化"</span>

<span class="hljs-comment">// 例子：找出数组中的最大值</span>

<span class="hljs-comment">// "高性能"版本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findMax</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">let</span> max = arr[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>, len = arr.<span class="hljs-property">length</span>; i &lt; len; i++) {
    <span class="hljs-keyword">if</span> (arr[i] &gt; max) max = arr[i]
  }
  <span class="hljs-keyword">return</span> max
}

<span class="hljs-comment">// 可读版本</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findMax</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...arr)
}

<span class="hljs-comment">// 除非你处理的是百万级数据，否则可读性更重要</span>
<span class="hljs-comment">// 过早优化是万恶之源 —— Donald Knuth</span>
</code></pre>
<h3 data-id="heading-22">5.3 心法三：写代码前先想清楚</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初学乍练的做法</span>
<span class="hljs-comment">// 想到哪写到哪，边写边改</span>

<span class="hljs-comment">// 筑基期的做法</span>
<span class="hljs-comment">// 先设计，再编码</span>

<span class="hljs-comment">// 设计步骤：</span>
<span class="hljs-comment">// 1. 明确需求：这个功能要做什么？</span>
<span class="hljs-comment">// 2. 定义接口：输入是什么？输出是什么？</span>
<span class="hljs-comment">// 3. 考虑边界：有哪些特殊情况？</span>
<span class="hljs-comment">// 4. 拆分任务：可以分成哪几个步骤？</span>
<span class="hljs-comment">// 5. 开始编码</span>

<span class="hljs-comment">// 例子：实现一个分页函数</span>

<span class="hljs-comment">// 1. 明确需求</span>
<span class="hljs-comment">// 输入：数组、页码、每页数量</span>
<span class="hljs-comment">// 输出：当前页的数据、总页数、是否有上/下一页</span>

<span class="hljs-comment">// 2. 定义接口</span>
interface <span class="hljs-title class_">PaginationResult</span>&lt;T&gt; {
  <span class="hljs-attr">data</span>: T[];
  <span class="hljs-attr">currentPage</span>: number;
  <span class="hljs-attr">totalPages</span>: number;
  <span class="hljs-attr">hasNextPage</span>: boolean;
  <span class="hljs-attr">hasPrevPage</span>: boolean;
}

<span class="hljs-keyword">function</span> paginate&lt;T&gt;(
  <span class="hljs-attr">items</span>: T[],
  <span class="hljs-attr">page</span>: number,
  <span class="hljs-attr">pageSize</span>: number
): <span class="hljs-title class_">PaginationResult</span>&lt;T&gt;;

<span class="hljs-comment">// 3. 考虑边界</span>
<span class="hljs-comment">// - 空数组</span>
<span class="hljs-comment">// - 页码小于1</span>
<span class="hljs-comment">// - 页码大于总页数</span>
<span class="hljs-comment">// - pageSize为0或负数</span>

<span class="hljs-comment">// 4. 拆分任务</span>
<span class="hljs-comment">// - 参数校验</span>
<span class="hljs-comment">// - 计算总页数</span>
<span class="hljs-comment">// - 截取当前页数据</span>
<span class="hljs-comment">// - 组装返回结果</span>

<span class="hljs-comment">// 5. 开始编码</span>
<span class="hljs-keyword">function</span> paginate&lt;T&gt;(
  <span class="hljs-attr">items</span>: T[],
  <span class="hljs-attr">page</span>: number = <span class="hljs-number">1</span>,
  <span class="hljs-attr">pageSize</span>: number = <span class="hljs-number">10</span>
): <span class="hljs-title class_">PaginationResult</span>&lt;T&gt; {
  <span class="hljs-comment">// 参数校验</span>
  <span class="hljs-keyword">if</span> (pageSize &lt;= <span class="hljs-number">0</span>) pageSize = <span class="hljs-number">10</span>;
  <span class="hljs-keyword">if</span> (page &lt; <span class="hljs-number">1</span>) page = <span class="hljs-number">1</span>;

  <span class="hljs-comment">// 计算总页数</span>
  <span class="hljs-keyword">const</span> totalPages = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(items.<span class="hljs-property">length</span> / pageSize);

  <span class="hljs-comment">// 修正页码</span>
  <span class="hljs-keyword">if</span> (page &gt; totalPages &amp;&amp; totalPages &gt; <span class="hljs-number">0</span>) page = totalPages;

  <span class="hljs-comment">// 截取当前页数据</span>
  <span class="hljs-keyword">const</span> start = (page - <span class="hljs-number">1</span>) * pageSize;
  <span class="hljs-keyword">const</span> data = items.<span class="hljs-title function_">slice</span>(start, start + pageSize);

  <span class="hljs-comment">// 组装返回结果</span>
  <span class="hljs-keyword">return</span> {
    data,
    <span class="hljs-attr">currentPage</span>: page,
    totalPages,
    <span class="hljs-attr">hasNextPage</span>: page &lt; totalPages,
    <span class="hljs-attr">hasPrevPage</span>: page &gt; <span class="hljs-number">1</span>,
  };
}
</code></pre>
<hr/>
<h2 data-id="heading-23">第六章：小有所成的出师考核</h2>
<h3 data-id="heading-24">6.1 自测题</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 问题1：重构这段代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">t, a</span>) {
  <span class="hljs-keyword">if</span> (t == <span class="hljs-string">"add"</span>) {
    <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>] + a[<span class="hljs-number">1</span>]
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t == <span class="hljs-string">"sub"</span>) {
    <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>] - a[<span class="hljs-number">1</span>]
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t == <span class="hljs-string">"mul"</span>) {
    <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>] * a[<span class="hljs-number">1</span>]
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t == <span class="hljs-string">"div"</span>) {
    <span class="hljs-keyword">if</span> (a[<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"error"</span>
    }
    <span class="hljs-keyword">return</span> a[<span class="hljs-number">0</span>] / a[<span class="hljs-number">1</span>]
  }
}

<span class="hljs-comment">// 问题2：这段代码有什么问题？如何改进？</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUsers</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/users"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">json</span>())
  <span class="hljs-keyword">const</span> result = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> users) {
    <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/orders?userId=<span class="hljs-subst">${user.id}</span>`</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span>
      r.<span class="hljs-title function_">json</span>()
    )
    result.<span class="hljs-title function_">push</span>({ ...user, orders })
  }
  <span class="hljs-keyword">return</span> result
}

<span class="hljs-comment">// 问题3：为这个函数写单元测试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">date, format = <span class="hljs-string">"YYYY-MM-DD"</span></span>) {
  <span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(date)
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(d.<span class="hljs-title function_">getTime</span>())) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Invalid date"</span>)
  }

  <span class="hljs-keyword">const</span> year = d.<span class="hljs-title function_">getFullYear</span>()
  <span class="hljs-keyword">const</span> month = <span class="hljs-title class_">String</span>(d.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>)
  <span class="hljs-keyword">const</span> day = <span class="hljs-title class_">String</span>(d.<span class="hljs-title function_">getDate</span>()).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>)

  <span class="hljs-keyword">return</span> format.<span class="hljs-title function_">replace</span>(<span class="hljs-string">"YYYY"</span>, year).<span class="hljs-title function_">replace</span>(<span class="hljs-string">"MM"</span>, month).<span class="hljs-title function_">replace</span>(<span class="hljs-string">"DD"</span>, day)
}
</code></pre>
<h3 data-id="heading-25">6.2 出师标准</h3>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│              小有所成出师标准 ✓                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   □ 代码符合团队规范，通过<span class="hljs-selector-tag">Code</span> Review                        │
│   □ 能写出清晰、可维护的代码                                 │
│   □ 会写单元测试，理解测试的价值                             │
│   □ 熟练使用Git进行版本控制                                  │
│   □ 了解常用设计模式，知道什么时候该用                       │
│   □ 能独立完成中等复杂度的功能开发                           │
│   □ 能重构遗留代码，提高代码质量                             │
│   □ 开始关注性能，但不过早优化                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-26">结语：小有所成的意义</h2>
<p>小有所成是程序员从"会写代码"到"会写好代码"的关键阶段。</p>
<p>在这个阶段，你会：</p>
<ul>
<li>开始关注代码质量，而不只是"能跑"</li>
<li>学会用规范和模式来组织代码</li>
<li>理解测试的价值</li>
<li>开始有代码审美</li>
</ul>
<p><strong>小有所成的核心是：建立正确的编程习惯和思维方式。</strong></p>
<p>这些习惯和思维方式，将成为你未来成长的基础。</p>
<p>就像武侠小说里，内功心法比招式更重要。一个内功深厚的人，学什么招式都快；一个只会花拳绣腿的人，永远只能停留在表面。</p>
<p>下一篇，我们将进入<strong>融会贯通</strong>——当你开始思考系统架构、开始能够独当一面的时候，你就踏入了一流高手的大门。</p>
<hr/>
<h2 data-id="heading-27">预告：融会贯通</h2>
<p>在融会贯通阶段，你将学习：</p>
<ul>
<li>系统设计与架构</li>
<li>技术选型与权衡</li>
<li>团队协作与沟通</li>
<li>项目管理基础</li>
<li>如何成为技术骨干</li>
</ul>
<p>敬请期待！</p>
<hr/>
<p><em>本文是《程序员武学修炼手册》系列的第二篇。</em></p>
<p><em>如果你正处于小有所成阶段，恭喜你已经超越了大多数"能跑就行"的程序员。</em></p>
<p><em>继续修炼，一流高手在向你招手！</em> 💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python自动化统计工具实战：Python批量分析Salesforce DML操作与错误处理]]></title>    <link>https://juejin.cn/post/7592990758477266963</link>    <guid>https://juejin.cn/post/7592990758477266963</guid>    <pubDate>2026-01-10T02:49:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592990758477266963" data-draft-id="7593145583348596778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python自动化统计工具实战：Python批量分析Salesforce DML操作与错误处理"/> <meta itemprop="keywords" content="面试,后端"/> <meta itemprop="datePublished" content="2026-01-10T02:49:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UrbanJazzerati"/> <meta itemprop="url" content="https://juejin.cn/user/550205947391389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python自动化统计工具实战：Python批量分析Salesforce DML操作与错误处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/550205947391389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UrbanJazzerati
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T02:49:05.000Z" title="Sat Jan 10 2026 02:49:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在日常的Salesforce开发中，Flow已成为业务自动化的重要工具。但你是否知道，大多数的数据处理异常都源于DML操作缺乏错误处理？本文将介绍如何构建一个自动化审计工具，批量检测Flow中的DML操作配置问题。</p>
</blockquote>
<h2 data-id="heading-0">为什么需要Flow DML操作审计？</h2>
<p>Salesforce Flow是一个强大的可视化业务自动化工具，但很多开发者在配置DML操作（Create、Update、Delete）时，往往忽视了错误处理。这导致：</p>
<ol>
<li><strong>数据不一致性</strong>：部分数据更新成功，部分失败</li>
<li><strong>用户体验差</strong>：用户遇到错误时无法获得清晰的反馈</li>
<li><strong>调试困难</strong>：生产环境异常难以追踪根源</li>
</ol>
<p>我们的目标是：<strong>自动化批量扫描所有Flow，识别未配置错误处理的DML操作</strong>。</p>
<h2 data-id="heading-1">整体解决方案架构</h2>
<p>本文将构建一个完整的Python工具，实现以下功能：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b03092668f864628a258d1294933fd50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVXJiYW5KYXp6ZXJhdGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768619569&amp;x-signature=mbtBvvWGJZyRZ5R4DyT0tLUC9QQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">核心实现：Flow DML分析器</h2>
<h3 data-id="heading-3">1. XML解析基础</h3>
<p>Salesforce Flow以XML格式存储，我们需要使用Python的ElementTree进行解析：</p>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-keyword">import</span> xml.etree.ElementTree <span class="hljs-keyword">as</span> ET
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> glob


<span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowDMLAnalyzer</span>:
    <span class="hljs-comment"># Salesforce Flow的XML命名空间</span>
    namespace = <span class="hljs-string">"http://soap.sforce.com/2006/04/metadata"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, flow_directory</span>):
        self.flow_directory = flow_directory
        self.dml_nodes = []
</code></pre>
<h3 data-id="heading-4">2. 智能检测DML节点</h3>
<p>关键点在于如何准确识别不同类型的DML操作：</p>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_flow_file</span>(<span class="hljs-params">self, file_path</span>):
    <span class="hljs-string">"""分析单个Flow文件，提取DML节点信息"""</span>
    <span class="hljs-keyword">try</span>:
        tree = ET.parse(file_path)
        root = tree.getroot()
        
        <span class="hljs-comment"># 只分析Active状态的Flow</span>
        flow_status = root.find(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}status'</span>)
        <span class="hljs-keyword">if</span> flow_status <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> flow_status.text != <span class="hljs-string">'Active'</span>:
            <span class="hljs-keyword">return</span> []
        
        dml_nodes_in_file = []
        
        <span class="hljs-comment"># 定义要检查的DML节点类型</span>
        dml_node_types = [
            (<span class="hljs-string">'recordCreates'</span>, <span class="hljs-string">'Create'</span>),
            (<span class="hljs-string">'recordUpdates'</span>, <span class="hljs-string">'Update'</span>),
            (<span class="hljs-string">'recordDeletes'</span>, <span class="hljs-string">'Delete'</span>)
        ]
        
        <span class="hljs-comment"># 遍历所有DML节点类型</span>
        <span class="hljs-keyword">for</span> node_type, node_type_cn <span class="hljs-keyword">in</span> dml_node_types:
            nodes = root.findall(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}<span class="hljs-subst">{node_type}</span>'</span>)
            
            <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> nodes:
                <span class="hljs-comment"># 关键检测：是否有错误处理连接器</span>
                fault_connector = node.find(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}faultConnector'</span>)
                has_fault_connector = fault_connector <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
                
                dml_node_info = {
                    <span class="hljs-string">'Flow API Name'</span>: flow_name,
                    <span class="hljs-string">'Flow Status'</span>: flow_status_text,
                    <span class="hljs-string">'Element Type'</span>: node_type_cn,
                    <span class="hljs-string">'Element Name'</span>: node_name,
                    <span class="hljs-string">'Element Label'</span>: node_label,
                    <span class="hljs-string">'Is Catch Error'</span>: <span class="hljs-string">'Yes'</span> <span class="hljs-keyword">if</span> has_fault_connector <span class="hljs-keyword">else</span> <span class="hljs-string">'No'</span>,
                    <span class="hljs-string">'Need Fix'</span>: <span class="hljs-string">'Yes'</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> has_fault_connector <span class="hljs-keyword">else</span> <span class="hljs-string">'No'</span>,
                }
                
                dml_nodes_in_file.append(dml_node_info)
                
        <span class="hljs-keyword">return</span> dml_nodes_in_file
</code></pre>
<h3 data-id="heading-5">3. 批量扫描所有Flow文件</h3>
<p>使用递归文件搜索确保不遗漏任何Flow：</p>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_all_flows</span>(<span class="hljs-params">self</span>):
    <span class="hljs-string">"""分析目录下所有Flow文件"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始分析目录: <span class="hljs-subst">{self.flow_directory}</span>"</span>)
    
    <span class="hljs-comment"># 查找所有.flow-meta.xml文件</span>
    flow_files = glob.glob(
        os.path.join(self.flow_directory, <span class="hljs-string">'**'</span>, <span class="hljs-string">'*.flow-meta.xml'</span>), 
        recursive=<span class="hljs-literal">True</span>
    )
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(flow_files)}</span> 个Flow文件"</span>)
    
    <span class="hljs-comment"># 进度显示增强用户体验</span>
    <span class="hljs-keyword">for</span> i, flow_file <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(flow_files, <span class="hljs-number">1</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"分析进度: <span class="hljs-subst">{i}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(flow_files)}</span> - <span class="hljs-subst">{os.path.basename(flow_file)}</span>"</span>)
        nodes = self.analyze_flow_file(flow_file)
        self.dml_nodes.extend(nodes)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"分析完成，共找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.dml_nodes)}</span> 个DML节点"</span>)
</code></pre>
<h2 data-id="heading-6">数据可视化：Excel报表生成</h2>
<h3 data-id="heading-7">4. 动态Excel报表创建</h3>
<p>使用xlwings生成专业级Excel报表：</p>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_excel_report</span>(<span class="hljs-params">self, output_file=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""生成Excel报告"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.dml_nodes:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># 智能文件名生成</span>
    <span class="hljs-keyword">if</span> output_file <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        timestamp = datetime.now().strftime(<span class="hljs-string">'%Y%m%d_%H%M%S'</span>)
        output_file = <span class="hljs-string">f'flow_dml_analysis_<span class="hljs-subst">{timestamp}</span>.xlsx'</span>
    
    <span class="hljs-comment"># 使用pandas整理数据结构</span>
    <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
    df = pd.DataFrame(self.dml_nodes)
    
    <span class="hljs-comment"># 列顺序优化</span>
    column_order = [
        <span class="hljs-string">'Flow API Name'</span>, <span class="hljs-string">'Flow Status'</span>, <span class="hljs-string">'Element Type'</span>,
        <span class="hljs-string">'Element Name'</span>, <span class="hljs-string">'Element Label'</span>, <span class="hljs-string">'Is Catch Error'</span>, <span class="hljs-string">'Need Fix'</span>
    ]
    df = df[column_order]
    
    <span class="hljs-comment"># 创建Excel应用</span>
    <span class="hljs-keyword">import</span> xlwings <span class="hljs-keyword">as</span> xw
    app = xw.App(visible=<span class="hljs-literal">True</span>)
    
    <span class="hljs-keyword">try</span>:
        wb = app.books.add()
        sheet = wb.sheets[<span class="hljs-number">0</span>]
        sheet.name = <span class="hljs-string">"DML节点分析"</span>
        
        <span class="hljs-comment"># 写入数据</span>
        sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A1'</span>).value = df.columns.tolist()
        sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A2'</span>).value = df.values.tolist()
        
        <span class="hljs-comment"># 视觉优化：标记需要处理的节点为红色</span>
        last_row = <span class="hljs-built_in">len</span>(df) + <span class="hljs-number">1</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, last_row + <span class="hljs-number">1</span>):
            <span class="hljs-keyword">if</span> sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">f'G<span class="hljs-subst">{i}</span>'</span>).value == <span class="hljs-string">'Yes'</span>:
                <span class="hljs-comment"># RGB颜色：浅红色背景</span>
                sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">f'A<span class="hljs-subst">{i}</span>:G<span class="hljs-subst">{i}</span>'</span>).color = (<span class="hljs-number">255</span>, <span class="hljs-number">199</span>, <span class="hljs-number">206</span>)
        
        <span class="hljs-comment"># 添加筛选功能</span>
        sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A1'</span>).api.AutoFilter(<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 创建汇总工作表</span>
        summary_sheet = wb.sheets.add(<span class="hljs-string">"汇总"</span>)
        self.create_summary_sheet(summary_sheet, df)
        
        <span class="hljs-comment"># 智能保存策略</span>
        output_file = self.safe_save_excel(wb, output_file)
        
        <span class="hljs-keyword">return</span> output_file
        
    <span class="hljs-keyword">finally</span>:
        app.quit()
</code></pre>
<h3 data-id="heading-8">5. 智能化汇总统计</h3>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_summary_sheet</span>(<span class="hljs-params">self, sheet, df</span>):
    <span class="hljs-string">"""创建汇总统计表"""</span>
    total_nodes = <span class="hljs-built_in">len</span>(df)
    
    summary_data = []
    summary_data.append([<span class="hljs-string">"统计项"</span>, <span class="hljs-string">"数量"</span>, <span class="hljs-string">"百分比"</span>])
    summary_data.append([<span class="hljs-string">"总DML节点数"</span>, total_nodes, <span class="hljs-string">"100%"</span>])
    
    <span class="hljs-comment"># 按节点类型统计</span>
    node_type_summary = df[<span class="hljs-string">'Element Type'</span>].value_counts()
    <span class="hljs-keyword">for</span> node_type, count <span class="hljs-keyword">in</span> node_type_summary.items():
        percentage = <span class="hljs-string">f"<span class="hljs-subst">{count / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>
        summary_data.append([<span class="hljs-string">f"<span class="hljs-subst">{node_type}</span>节点数"</span>, count, percentage])
    
    <span class="hljs-comment"># 错误处理统计分析</span>
    needs_attention = df[df[<span class="hljs-string">'Need Fix'</span>] == <span class="hljs-string">'Yes'</span>]
    needs_attention_count = <span class="hljs-built_in">len</span>(needs_attention)
    
    summary_data.append([<span class="hljs-string">"需要添加错误处理的节点数"</span>, 
                         needs_attention_count,
                         <span class="hljs-string">f"<span class="hljs-subst">{needs_attention_count / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>])
    
    <span class="hljs-comment"># 写入汇总数据</span>
    sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A1'</span>).value = summary_data
    sheet.autofit()
</code></pre>
<h2 data-id="heading-9">实战使用教程</h2>
<h3 data-id="heading-10">6. 一键运行工具</h3>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数"""</span>
    <span class="hljs-comment"># 配置Flow文件目录</span>
    flow_directory = <span class="hljs-string">r"你的Flow文件路径"</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(flow_directory):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"目录不存在: <span class="hljs-subst">{flow_directory}</span>"</span>)
        <span class="hljs-keyword">return</span>
    
    <span class="hljs-comment"># 创建分析器</span>
    analyzer = FlowDMLAnalyzer(flow_directory)
    
    <span class="hljs-comment"># 批量分析</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 开始扫描Flow文件..."</span>)
    analyzer.analyze_all_flows()
    
    <span class="hljs-comment"># 生成报告</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"📊 生成分析报告..."</span>)
    report = analyzer.generate_summary_report()
    <span class="hljs-built_in">print</span>(report)
    
    <span class="hljs-comment"># 生成Excel文件</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"💾 生成Excel文件..."</span>)
    excel_file = analyzer.generate_excel_report()
    
    <span class="hljs-keyword">if</span> excel_file:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 分析完成！文件已保存: <span class="hljs-subst">{excel_file}</span>"</span>)
        
        <span class="hljs-comment"># 自动打开选项</span>
        <span class="hljs-keyword">import</span> subprocess
        subprocess.Popen(<span class="hljs-string">f'start excel "<span class="hljs-subst">{excel_file}</span>"'</span>, shell=<span class="hljs-literal">True</span>)
</code></pre>
<h3 data-id="heading-11">7. 配置文件路径</h3>
<p>根据你的Salesforce项目结构调整：</p>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-comment"># 常见Salesforce DX项目结构</span>
flow_directory = <span class="hljs-string">r"force-app\main\default\flows"</span>


<span class="hljs-comment"># 或使用绝对路径</span>
flow_directory = <span class="hljs-string">r"C:\Users\YourName\projects\salesforce-project\force-app\main\default\flows"</span>
</code></pre>
<h2 data-id="heading-12">实际案例分析</h2>
<h3 data-id="heading-13">案例分析：项目审计结果</h3>
<p>我们曾在一个包含160+ Flow的项目中运行此工具：</p>
<pre><code class="hljs language-TEXT" lang="TEXT">============================================
 Salesforce Flow DML节点分析报告
============================================


分析时间: 2024-01-15 14:30:22
分析目录: C:\projects\salesforce\flows


总体统计:
----------
总DML节点数: 376
无错误处理的节点数: 214
需要处理比例: 56.9%


按节点类型统计:
----------
  Update: 215个 (57.2%)
  Create: 98个 (26.1%)
  Delete: 63个 (16.7%)


按Flow统计:
----------
  Customer_Update_Process: 28个 DML节点
  Order_Creation_Flow: 19个 DML节点
  Data_Cleanup_Batch: 43个 DML节点
</code></pre>
<h3 data-id="heading-14">性能优化建议</h3>
<p>对于大型项目：</p>
<pre><code class="hljs language-PYTHON" lang="PYTHON"><span class="hljs-comment"># 1. 并行处理加速</span>
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor


<span class="hljs-keyword">def</span> <span class="hljs-title function_">parallel_analyze_flows</span>(<span class="hljs-params">self, flow_files, max_workers=<span class="hljs-number">4</span></span>):
    <span class="hljs-string">"""并行分析Flow文件"""</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=max_workers) <span class="hljs-keyword">as</span> executor:
        results = <span class="hljs-built_in">list</span>(executor.<span class="hljs-built_in">map</span>(self.analyze_flow_file, flow_files))
    <span class="hljs-keyword">return</span> results


<span class="hljs-comment"># 2. 缓存机制</span>
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> pickle


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_hash</span>(<span class="hljs-params">self, file_path</span>):
    <span class="hljs-string">"""获取文件哈希值用于缓存"""</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">return</span> hashlib.md5(f.read()).hexdigest()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_cached_results</span>(<span class="hljs-params">self, file_path</span>):
    <span class="hljs-string">"""加载缓存结果"""</span>
    cache_file = <span class="hljs-string">f"<span class="hljs-subst">{file_path}</span>.cache"</span>
    <span class="hljs-keyword">if</span> os.path.exists(cache_file):
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(cache_file, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:
            <span class="hljs-keyword">return</span> pickle.load(f)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h2 data-id="heading-15">完整代码</h2>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> xml.etree.ElementTree <span class="hljs-keyword">as</span> ET
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> xlwings <span class="hljs-keyword">as</span> xw
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> glob

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowDMLAnalyzer</span>:
    namespace = <span class="hljs-string">"http://soap.sforce.com/2006/04/metadata"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, flow_directory</span>):
        <span class="hljs-string">"""
        初始化Flow DML分析器

        Args:
            flow_directory (str): Flow文件所在的目录路径
        """</span>
        self.flow_directory = flow_directory
        self.dml_nodes = []

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_flow_file</span>(<span class="hljs-params">self, file_path</span>):
        <span class="hljs-string">"""
        分析单个Flow文件，提取DML节点信息

        Args:
            file_path (str): Flow文件路径

        Returns:
            list: DML节点信息列表
        """</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 解析XML文件</span>
            tree = ET.parse(file_path)
            root = tree.getroot()

            <span class="hljs-comment"># 检查Flow状态</span>
            flow_status = root.find(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}status'</span>)
            flow_status_text = flow_status.text <span class="hljs-keyword">if</span> flow_status <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析文件 <span class="hljs-subst">{file_path}</span>: <span class="hljs-subst">{flow_status_text}</span>"</span>)
            <span class="hljs-comment"># 只分析Active的Flow</span>
            <span class="hljs-keyword">if</span> flow_status_text != <span class="hljs-string">'Active'</span>:
                <span class="hljs-keyword">return</span> []

            <span class="hljs-comment"># 从文件名获取Flow名称（去掉扩展名）</span>
            flow_name = os.path.splitext(os.path.basename(file_path))[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> flow_name.endswith(<span class="hljs-string">'.flow-meta'</span>):
                flow_name = flow_name.replace(<span class="hljs-string">'.flow-meta'</span>, <span class="hljs-string">''</span>)

            dml_nodes_in_file = []

            <span class="hljs-comment"># 定义要检查的DML节点类型</span>
            dml_node_types = [
                (<span class="hljs-string">'recordCreates'</span>, <span class="hljs-string">'Create'</span>),
                (<span class="hljs-string">'recordUpdates'</span>, <span class="hljs-string">'Update'</span>),
                (<span class="hljs-string">'recordDeletes'</span>, <span class="hljs-string">'Delete'</span>)
            ]

            <span class="hljs-comment"># 遍历所有DML节点类型</span>
            <span class="hljs-keyword">for</span> node_type, node_type_cn <span class="hljs-keyword">in</span> dml_node_types:
                nodes = root.findall(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}<span class="hljs-subst">{node_type}</span>'</span>)

                <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> nodes:
                    <span class="hljs-comment"># 获取节点名称</span>
                    name_elem = node.find(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}name'</span>)
                    node_name = name_elem.text <span class="hljs-keyword">if</span> name_elem <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>

                    <span class="hljs-comment"># 获取节点标签</span>
                    label_elem = node.find(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}label'</span>)
                    node_label = label_elem.text <span class="hljs-keyword">if</span> label_elem <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>

                    <span class="hljs-comment"># 检查是否有faultConnector（错误处理）</span>
                    fault_connector = node.find(<span class="hljs-string">f'.//{{<span class="hljs-subst">{self.namespace}</span>}}faultConnector'</span>)
                    has_fault_connector = fault_connector <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>

                    <span class="hljs-comment"># 记录节点信息</span>
                    dml_node_info = {
                        <span class="hljs-string">'Flow API Name'</span>: flow_name,
                        <span class="hljs-string">'Flow Status'</span>: flow_status_text,
                        <span class="hljs-string">'Element Type'</span>: node_type_cn,
                        <span class="hljs-string">'Element Name'</span>: node_name,
                        <span class="hljs-string">'Element Label'</span>: node_label,
                        <span class="hljs-string">'Is Catch Error'</span>: <span class="hljs-string">'Yes'</span> <span class="hljs-keyword">if</span> has_fault_connector <span class="hljs-keyword">else</span> <span class="hljs-string">'No'</span>,
                        <span class="hljs-string">'Need Fix'</span>: <span class="hljs-string">'Yes'</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> has_fault_connector <span class="hljs-keyword">else</span> <span class="hljs-string">'No'</span>,
                    }

                    dml_nodes_in_file.append(dml_node_info)

            <span class="hljs-keyword">return</span> dml_nodes_in_file

        <span class="hljs-keyword">except</span> ET.ParseError <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解析文件 <span class="hljs-subst">{file_path}</span> 时出错: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> []
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"分析文件 <span class="hljs-subst">{file_path}</span> 时出错: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> []

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_all_flows</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
           分析目录下所有Flow文件
           """</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始分析目录: <span class="hljs-subst">{self.flow_directory}</span>"</span>)

        <span class="hljs-comment"># 查找所有.flow-meta.xml文件</span>
        flow_files = glob.glob(os.path.join(self.flow_directory, <span class="hljs-string">'**'</span>, <span class="hljs-string">'*.flow-meta.xml'</span>), recursive=<span class="hljs-literal">True</span>)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(flow_files)}</span> 个Flow文件"</span>)

        <span class="hljs-comment"># 分析每个Flow文件</span>
        <span class="hljs-keyword">for</span> i, flow_file <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(flow_files, <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"分析进度: <span class="hljs-subst">{i}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(flow_files)}</span> - <span class="hljs-subst">{os.path.basename(flow_file)}</span>"</span>)

            nodes = self.analyze_flow_file(flow_file)
            self.dml_nodes.extend(nodes)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"分析完成，共找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.dml_nodes)}</span> 个DML节点"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_excel_report</span>(<span class="hljs-params">self, output_file=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""
        生成Excel报告

        Args:
            output_file (str): 输出Excel文件路径，如果为None则自动生成

        Returns:
            str: 生成的Excel文件路径
        """</span>
        <span class="hljs-keyword">global</span> wb
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.dml_nodes:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"没有找到DML节点，无法生成报告"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 如果没有指定输出文件，则自动生成</span>
        <span class="hljs-keyword">if</span> output_file <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            timestamp = datetime.now().strftime(<span class="hljs-string">'%Y%m%d_%H%M%S'</span>)
            <span class="hljs-comment"># 使用当前目录而不是原始flow目录</span>
            output_file = os.path.join(os.getcwd(), <span class="hljs-string">f'flow_dml_analysis_<span class="hljs-subst">{timestamp}</span>.xlsx'</span>)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"尝试保存Excel到: <span class="hljs-subst">{output_file}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"输出目录是否存在: <span class="hljs-subst">{os.path.exists(os.path.dirname(output_file))}</span>"</span>)

        <span class="hljs-comment"># 创建DataFrame</span>
        df = pd.DataFrame(self.dml_nodes)

        <span class="hljs-comment"># 重新排列列的顺序，便于阅读</span>
        column_order = [
            <span class="hljs-string">'Flow API Name'</span>, <span class="hljs-string">'Flow Status'</span>, <span class="hljs-string">'Element Type'</span>,
            <span class="hljs-string">'Element Name'</span>, <span class="hljs-string">'Element Label'</span>, <span class="hljs-string">'Is Catch Error'</span>, <span class="hljs-string">'Need Fix'</span>
        ]

        df = df[column_order] <span class="hljs-comment"># 插入标题，不会计入dataframe的size</span>

        <span class="hljs-comment"># 使用xlwings创建Excel文件</span>
        app = xw.App(visible=<span class="hljs-literal">True</span>)

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 创建工作簿</span>
            wb = app.books.add()

            <span class="hljs-comment"># 将数据写入工作表</span>
            sheet = wb.sheets[<span class="hljs-number">0</span>]
            sheet.name = <span class="hljs-string">"DML节点分析"</span>

            <span class="hljs-comment"># 写入标题</span>
            sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A1'</span>).value = df.columns.tolist()

            <span class="hljs-comment"># 写入数据</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> df.empty:
                sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A2'</span>).value = df.values.tolist()

            <span class="hljs-comment"># 调整列宽</span>
            sheet.autofit()

            <span class="hljs-comment"># 添加格式：将需要处理的节点标记为红色</span>
            last_row = <span class="hljs-built_in">len</span>(df) + <span class="hljs-number">1</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, last_row + <span class="hljs-number">1</span>):
                <span class="hljs-keyword">if</span> sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">f'G<span class="hljs-subst">{i}</span>'</span>).value == <span class="hljs-string">'Yes'</span>:  <span class="hljs-comment"># G列是"Need Fix"列</span>
                    <span class="hljs-comment"># 标记整行为浅红色背景</span>
                    sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">f'A<span class="hljs-subst">{i}</span>:G<span class="hljs-subst">{i}</span>'</span>).color = (<span class="hljs-number">255</span>, <span class="hljs-number">199</span>, <span class="hljs-number">206</span>)  <span class="hljs-comment"># 浅红色</span>

            <span class="hljs-comment"># 对colum header添加筛选</span>
            sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A1'</span>).api.AutoFilter(<span class="hljs-number">1</span>)

            <span class="hljs-comment"># 创建汇总工作表</span>
            summary_sheet = wb.sheets.add(<span class="hljs-string">"汇总"</span>)

            <span class="hljs-comment"># 按节点类型统计</span>
            summary_data = []
            total_nodes = <span class="hljs-built_in">len</span>(df)

            summary_data.append([<span class="hljs-string">"统计项"</span>, <span class="hljs-string">"数量"</span>, <span class="hljs-string">"百分比"</span>])
            summary_data.append([<span class="hljs-string">"总DML节点数"</span>, total_nodes, <span class="hljs-string">"100%"</span>])

            <span class="hljs-comment"># 按节点类型统计</span>
            node_type_summary = df[<span class="hljs-string">'Element Type'</span>].value_counts()
            <span class="hljs-keyword">for</span> node_type, count <span class="hljs-keyword">in</span> node_type_summary.items():
                percentage = <span class="hljs-string">f"<span class="hljs-subst">{count / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>
                summary_data.append([<span class="hljs-string">f"<span class="hljs-subst">{node_type}</span>节点数"</span>, count, percentage])

            <span class="hljs-comment"># 按错误处理状态统计</span>
            error_handling_summary = df[<span class="hljs-string">'Need Fix'</span>].value_counts()
            <span class="hljs-keyword">for</span> status, count <span class="hljs-keyword">in</span> error_handling_summary.items():
                status_text = <span class="hljs-string">"有"</span> <span class="hljs-keyword">if</span> status == <span class="hljs-string">"No"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"无"</span>
                percentage = <span class="hljs-string">f"<span class="hljs-subst">{count / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>
                summary_data.append([<span class="hljs-string">f"<span class="hljs-subst">{status_text}</span>错误处理的节点数"</span>, count, percentage])

            <span class="hljs-comment"># 需要处理的节点统计</span>
            needs_attention = df[df[<span class="hljs-string">'Need Fix'</span>] == <span class="hljs-string">'Yes'</span>]
            needs_attention_count = <span class="hljs-built_in">len</span>(needs_attention)
            summary_data.append([<span class="hljs-string">"需要添加错误处理的节点数"</span>, needs_attention_count,
                                 <span class="hljs-string">f"<span class="hljs-subst">{needs_attention_count / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>])

            <span class="hljs-comment"># 添加空行（用3个空字符串）</span>
            summary_data.append([<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>])
            summary_data.append([<span class="hljs-string">"按Flow统计"</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>])

            <span class="hljs-comment"># 按Flow统计</span>
            flow_summary = df[<span class="hljs-string">'Flow API Name'</span>].value_counts()
            <span class="hljs-keyword">for</span> flow_name, count <span class="hljs-keyword">in</span> flow_summary.items():
                summary_data.append([flow_name, count, <span class="hljs-string">f"<span class="hljs-subst">{count / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%"</span>])

            <span class="hljs-comment"># 写入汇总数据</span>
            summary_sheet.<span class="hljs-built_in">range</span>(<span class="hljs-string">'A1'</span>).value = summary_data
            summary_sheet.autofit()

            <span class="hljs-comment"># 保存工作簿 - 添加异常捕获</span>
            <span class="hljs-keyword">try</span>:
                wb.save(output_file)
                <span class="hljs-built_in">print</span>(
                    <span class="hljs-string">f"保存成功，文件大小: <span class="hljs-subst">{os.path.getsize(output_file) <span class="hljs-keyword">if</span> os.path.exists(output_file) <span class="hljs-keyword">else</span> <span class="hljs-string">'文件不存在'</span>}</span> 字节"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> save_error:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"保存文件时出错: <span class="hljs-subst">{save_error}</span>"</span>)
                <span class="hljs-comment"># 尝试另存为桌面</span>
                desktop = os.path.join(os.path.expanduser(<span class="hljs-string">'~'</span>), <span class="hljs-string">'Desktop'</span>)
                alt_file = os.path.join(desktop, <span class="hljs-string">f'flow_dml_analysis_<span class="hljs-subst">{timestamp}</span>.xlsx'</span>)
                wb.save(alt_file)
                output_file = alt_file
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已保存到备选位置: <span class="hljs-subst">{output_file}</span>"</span>)

            <span class="hljs-keyword">return</span> output_file

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成Excel报告时出现错误: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">import</span> traceback
            traceback.print_exc()
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        <span class="hljs-keyword">finally</span>:
            <span class="hljs-comment"># 关闭工作簿和应用</span>
            <span class="hljs-keyword">try</span>:
                wb.close()
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            <span class="hljs-keyword">try</span>:
                app.quit()
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_summary_report</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        生成分析摘要报告
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.dml_nodes:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"没有找到DML节点"</span>

        df = pd.DataFrame(self.dml_nodes)
        <span class="hljs-comment"># print(f"df ", df)</span>
        <span class="hljs-comment"># 统计信息</span>
        total_nodes = <span class="hljs-built_in">len</span>(df)
        nodes_without_error_handling = <span class="hljs-built_in">len</span>(df[df[<span class="hljs-string">'Is Catch Error'</span>] == <span class="hljs-string">'No'</span>])

        <span class="hljs-comment"># 按节点类型统计</span>
        node_type_counts = df[<span class="hljs-string">'Element Type'</span>].value_counts()

        <span class="hljs-comment"># 按Flow统计</span>
        <span class="hljs-comment"># flow_counts = df['Flow API Name'].value_counts()</span>

        <span class="hljs-comment"># 生成报告文本</span>
        report = <span class="hljs-string">f"""
         ============================================
         Salesforce Flow DML节点分析报告
         ============================================

         分析时间: <span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>
         分析目录: <span class="hljs-subst">{self.flow_directory}</span>

         总体统计:
         ----------
         总DML节点数: <span class="hljs-subst">{total_nodes}</span>
         无错误处理的节点数: <span class="hljs-subst">{nodes_without_error_handling}</span>
         需要处理比例: <span class="hljs-subst">{nodes_without_error_handling / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%

         按节点类型统计:
         ----------
         """</span>

        <span class="hljs-keyword">for</span> node_type, count <span class="hljs-keyword">in</span> node_type_counts.items():
            report += <span class="hljs-string">f"  <span class="hljs-subst">{node_type}</span>: <span class="hljs-subst">{count}</span>个 (<span class="hljs-subst">{count / total_nodes * <span class="hljs-number">100</span>:<span class="hljs-number">.1</span>f}</span>%)\n"</span>

        report += <span class="hljs-string">"\n需要添加错误处理的节点清单:\n"</span>
        report += <span class="hljs-string">"="</span> * <span class="hljs-number">60</span> + <span class="hljs-string">"\n"</span>

        <span class="hljs-comment"># 筛选出需要处理的节点</span>
        needs_attention = df[df[<span class="hljs-string">'Need Fix'</span>] == <span class="hljs-string">'Yes'</span>]

        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(needs_attention) &gt; <span class="hljs-number">0</span>:
            <span class="hljs-keyword">for</span> index, row <span class="hljs-keyword">in</span> needs_attention.iterrows():
                report += <span class="hljs-string">f"\nFlow: <span class="hljs-subst">{row[<span class="hljs-string">'Flow API Name'</span>]}</span>\n"</span>
                report += <span class="hljs-string">f"节点类型: <span class="hljs-subst">{row[<span class="hljs-string">'Element Type'</span>]}</span>\n"</span>
                report += <span class="hljs-string">f"节点名称: <span class="hljs-subst">{row[<span class="hljs-string">'Element Name'</span>]}</span>\n"</span>
                report += <span class="hljs-string">f"节点标签: <span class="hljs-subst">{row[<span class="hljs-string">'Element Label'</span>]}</span>\n"</span>
                report += <span class="hljs-string">"-"</span> * <span class="hljs-number">40</span> + <span class="hljs-string">"\n"</span>
        <span class="hljs-keyword">else</span>:
            report += <span class="hljs-string">"\n恭喜！所有DML节点都已经有错误处理。\n"</span>

        <span class="hljs-keyword">return</span> report

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""
    主函数
    """</span>
    <span class="hljs-comment"># 设置Flow目录路径</span>
    flow_directory = <span class="hljs-string">r"C:\Users\YourPath\vscode\force-app\main\default\flows"</span>

    <span class="hljs-comment"># 检查目录是否存在</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(flow_directory):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"目录不存在: <span class="hljs-subst">{flow_directory}</span>"</span>)
        <span class="hljs-keyword">return</span>

    <span class="hljs-comment"># 创建分析器并进行分析</span>
    analyzer = FlowDMLAnalyzer(flow_directory)
    analyzer.analyze_all_flows()

    <span class="hljs-comment"># 生成文本报告</span>
    report = analyzer.generate_summary_report()
    <span class="hljs-built_in">print</span>(report)

    <span class="hljs-comment"># 生成Excel报告</span>
    excel_file = analyzer.generate_excel_report()

    <span class="hljs-keyword">if</span> excel_file <span class="hljs-keyword">and</span> os.path.exists(excel_file):
        file_size = os.path.getsize(excel_file)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件存在，大小: <span class="hljs-subst">{file_size}</span> 字节"</span>)

        <span class="hljs-comment"># 可选：自动打开Excel文件</span>
        open_excel = <span class="hljs-built_in">input</span>(<span class="hljs-string">"\n是否要打开Excel文件？(y/n): "</span>).lower()
        <span class="hljs-keyword">if</span> open_excel == <span class="hljs-string">'y'</span>:
            <span class="hljs-keyword">try</span>:
                app = xw.App(visible=<span class="hljs-literal">True</span>, add_book=<span class="hljs-literal">False</span>)

                <span class="hljs-comment"># 2. 打开已有工作簿</span>
                app.books.<span class="hljs-built_in">open</span>(excel_file)  <span class="hljs-comment"># 注意文件路径前的 r</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"无法打开文件: <span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请手动打开: <span class="hljs-subst">{excel_file}</span>"</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-16">结尾</h2>
<p>通过这个工具，我们让每一个DML操作都得到了应有的关注，让每一个错误都能被妥善处理，最终为用户提供更稳定、更可靠的业务自动化体验。</p>
<p><strong>你现在就可以开始扫描你的Salesforce项目，看看有多少DML操作在"裸奔"！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JobFlow 负载感知调度：把任务分给最闲的机器]]></title>    <link>https://juejin.cn/post/7592990758477430803</link>    <guid>https://juejin.cn/post/7592990758477430803</guid>    <pubDate>2026-01-10T05:58:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592990758477430803" data-draft-id="7593215107406118948" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JobFlow 负载感知调度：把任务分给最闲的机器"/> <meta itemprop="keywords" content="后端,架构,开源"/> <meta itemprop="datePublished" content="2026-01-10T05:58:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JobFlow 负载感知调度：把任务分给最闲的机器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-10T05:58:52.000Z" title="Sat Jan 10 2026 05:58:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>这一周工作很忙，周末终于可以来还债了。</p>
<p>看到有读者提 issue 问负载感知调度的问题，心里挺高兴的。说明有人在真正用 JobFlow，而且在思考怎么让它更好。这种反馈对开源项目来说太重要了。</p>
<p>开发者一个人闷头写代码，很容易陷入自己的思维定式。用户提的问题往往是最真实的需求，也是最容易被忽略的细节。这次的负载感知调度功能就是一个很好的例子。</p>
<p>如果你在使用 JobFlow 的过程中遇到任何问题，或者有什么想法，欢迎提 issue 讨论。一起把它做得更好。</p>
<p>好，下面进入正题。</p>
<h2 data-id="heading-1">问题背景</h2>
<p>最近收到一个 issue：</p>
<blockquote>
<p>如果需要根据执行器的负载情况调度负载低的节点，应该怎么考虑？</p>
</blockquote>
<p>这是个很实际的问题。看看下面这个场景：</p>
<pre><code class="hljs language-diff" lang="diff">订单服务有 3 个实例：
<span class="hljs-deletion">- 实例 1：CPU 80%，内存 70%，线程池占用 90%</span>
<span class="hljs-deletion">- 实例 2：CPU 30%，内存 40%，线程池占用 20%</span>
<span class="hljs-deletion">- 实例 3：CPU 50%，内存 60%，线程池占用 50%</span>

定时任务触发，应该调度到哪个实例？
</code></pre>
<p>答案很明显：实例 2，因为它最闲。</p>
<p>但 JobFlow 最初的执行器选择逻辑很简单：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 轮询选择</span>
<span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> instances.get(shardIndex % instances.size());
</code></pre>
<p>按分片索引取模，机械分配。这样做的问题：</p>
<pre><code class="hljs">实例 1 很忙 → 分片 0 调度过去 → 越来越慢，任务堆积
实例 2 很闲 → 分片 1 快速执行完 → 空闲等待
实例 3 中等 → 分片 2 正常执行

结果：资源利用不均衡
</code></pre>
<p><strong>要解决这个问题，需要让调度器知道每个执行器的实时负载，然后把任务分配给负载最低的实例。</strong></p>
<h2 data-id="heading-2">方案选择</h2>
<p>看到这个需求，第一反应是引入 Redis：</p>
<pre><code class="hljs language-css" lang="css">方案 <span class="hljs-selector-tag">A</span>：Redis 中心化存储
执行器 → Redis（上报负载）
调度器 → Redis（读取负载）→ 选择最优实例
</code></pre>
<p>这个方案可以工作，但有几个问题：</p>
<p><strong>依赖问题</strong></p>
<p>引入 Redis 意味着：</p>
<ul>
<li>运维要部署 Redis 集群</li>
<li>要考虑 Redis 高可用</li>
<li>要处理 Redis 挂掉的降级逻辑</li>
</ul>
<p>JobFlow 的设计理念是轻量级，只依赖 Nacos 和 MySQL。</p>
<p><strong>一致性问题</strong></p>
<pre><code class="hljs language-diff" lang="diff">3 个调度器实例同时从 Redis 读取：
<span class="hljs-deletion">- 都看到 executor-1 负载最低</span>
<span class="hljs-deletion">- 都选择 executor-1</span>
<span class="hljs-deletion">- executor-1 瞬间负载升高</span>

要解决这个问题需要分布式锁，但加锁又影响性能。
</code></pre>
<p><strong>数据过期问题</strong></p>
<p>执行器每 60 秒上报一次，如果执行器挂了，Redis 里的数据怎么办？设置 TTL 自动过期？还是调度器主动检测？</p>
<p>思考之后，决定用更简单的方案：</p>
<pre><code class="hljs language-css" lang="css">方案 <span class="hljs-selector-tag">B</span>：HTTP 直接上报
执行器 → HTTP → 调度器（内存存储）
调度器需要时直接从内存读取
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>无额外依赖</li>
<li>实现简单</li>
<li>降级容易</li>
</ul>
<p><strong>代价：</strong></p>
<ul>
<li>调度器重启后数据丢失</li>
<li>不持久化</li>
</ul>
<p>但这两个代价都可以接受：</p>
<ul>
<li>调度器重启是小概率事件</li>
<li>负载数据本身就是实时的，60 秒后就会重新上报</li>
</ul>
<h2 data-id="heading-3">设计思路</h2>
<p>确定了用 HTTP 直接上报，接下来要解决几个问题。</p>
<h3 data-id="heading-4">问题 1：上报给哪个调度器？</h3>
<p>假设有 3 个调度器实例，执行器应该上报给谁？</p>
<pre><code class="hljs">随机选一个？→ 数据分散，不一致
上报给所有？→ 网络开销大
</code></pre>
<p>答案是：<strong>用 Hash 一致性选择，和任务调度的 Owner 判定逻辑一样。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 根据服务名 Hash，选择负责的调度器</span>
<span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-service"</span>;
List&lt;Instance&gt; schedulers = nacosService.getAllInstances(<span class="hljs-string">"jobflow-scheduler"</span>);

<span class="hljs-comment">// 排序（保证一致性）</span>
schedulers.sort(Comparator.comparing(i -&gt; i.getIp() + <span class="hljs-string">":"</span> + i.getPort()));

<span class="hljs-comment">// Hash 选择</span>
<span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Math.abs(serviceName.hashCode());
<span class="hljs-type">int</span> <span class="hljs-variable">targetIndex</span> <span class="hljs-operator">=</span> hash % schedulers.size();
<span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">targetScheduler</span> <span class="hljs-operator">=</span> schedulers.get(targetIndex);
</code></pre>
<p>这样做的好处：</p>
<pre><code class="hljs language-diff" lang="diff">order-service 的所有实例 → 上报给 scheduler-1
user-service 的所有实例 → 上报给 scheduler-2

<span class="hljs-deletion">- 负载数据集中，不会分散</span>
<span class="hljs-deletion">- 每个调度器负责一部分服务</span>
<span class="hljs-deletion">- 和任务调度逻辑一致</span>
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph 执行器
        E1[order-service-1]
        E2[order-service-2]
        E3[user-service-1]
        E4[user-service-2]
    end
    
    subgraph 调度器
        S1[Scheduler-1&lt;br/&gt;负责order-service]
        S2[Scheduler-2&lt;br/&gt;负责user-service]
    end
    
    E1 --&gt; |上报负载| S1
    E2 --&gt; |上报负载| S1
    E3 --&gt; |上报负载| S2
    E4 --&gt; |上报负载| S2
    
    style S1 fill:#90EE90
    style S2 fill:#87CEEB
</code></pre>
<p><strong>关键点：排序。</strong></p>
<p>所有实例必须看到相同的调度器顺序，否则 Hash 结果不一致。</p>
<h3 data-id="heading-5">问题 2：负载怎么衡量？</h3>
<p>需要收集哪些指标？</p>
<p>对于任务调度，主要关心：</p>
<ul>
<li><strong>CPU 使用率</strong>：任务执行需要计算资源</li>
<li><strong>内存使用率</strong>：任务处理数据需要内存</li>
<li><strong>线程池占用率</strong>：任务并发执行能力</li>
</ul>
<p>使用 Java 标准 API 收集，无外部依赖：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LightweightLoadCollector</span> {
    
    <span class="hljs-comment">// CPU 使用率</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getCpuUsage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">OperatingSystemMXBean</span> <span class="hljs-variable">osBean</span> <span class="hljs-operator">=</span> ManagementFactory.getOperatingSystemMXBean();
            <span class="hljs-keyword">if</span> (osBean <span class="hljs-keyword">instanceof</span> com.sun.management.OperatingSystemMXBean) {
                <span class="hljs-keyword">return</span> ((com.sun.management.OperatingSystemMXBean) osBean)
                    .getSystemCpuLoad() * <span class="hljs-number">100</span>;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.warn(<span class="hljs-string">"获取CPU使用率失败"</span>, e);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>; <span class="hljs-comment">// 降级：返回默认值</span>
    }
    
    <span class="hljs-comment">// 内存使用率</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getMemoryUsage</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();
        <span class="hljs-type">long</span> <span class="hljs-variable">totalMemory</span> <span class="hljs-operator">=</span> runtime.totalMemory();
        <span class="hljs-type">long</span> <span class="hljs-variable">freeMemory</span> <span class="hljs-operator">=</span> runtime.freeMemory();
        <span class="hljs-type">long</span> <span class="hljs-variable">usedMemory</span> <span class="hljs-operator">=</span> totalMemory - freeMemory;
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) usedMemory / totalMemory * <span class="hljs-number">100</span>;
    }
    
    <span class="hljs-comment">// 线程池指标</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getActiveThreadCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (threadPoolExecutor != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> threadPoolExecutor.getActiveCount();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
}
</code></pre>
<p><strong>降级策略：如果获取某个指标失败，返回默认值，不影响整体流程。</strong></p>
<h3 data-id="heading-6">问题 3：怎么选择执行器？</h3>
<p>有了负载数据，怎么选择最优实例？</p>
<p>使用加权平均算法：</p>
<pre><code class="hljs language-markdown" lang="markdown">权重分配：
<span class="hljs-bullet">-</span> CPU：40%
<span class="hljs-bullet">-</span> 内存：40%
<span class="hljs-bullet">-</span> 线程池：20%

计算公式（分数越高越好）：
weight = (100 - cpuUsage) * 0.4 
<span class="hljs-bullet">       +</span> (100 - memoryUsage) * 0.4 
<span class="hljs-bullet">       +</span> (100 - threadPoolUsage) * 0.2
</code></pre>
<p>为什么这样分配权重？</p>
<ul>
<li>CPU 和内存直接影响任务执行速度，权重较高</li>
<li>线程池只要不满，影响相对较小，权重较低</li>
</ul>
<p>后续可以根据实际情况调整。</p>
<h2 data-id="heading-7">代码实现</h2>
<p>把功能分成 4 个模块，各司其职。</p>
<h3 data-id="heading-8">模块 1：负载收集器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LightweightLoadCollector</span> {
    
    <span class="hljs-keyword">public</span> ExecutorLoadInfo <span class="hljs-title function_">collect</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ExecutorLoadInfo</span> <span class="hljs-variable">loadInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorLoadInfo</span>();
        loadInfo.setCpuUsage(getCpuUsage());
        loadInfo.setMemoryUsage(getMemoryUsage());
        loadInfo.setThreadPoolActive(getActiveThreadCount());
        loadInfo.setThreadPoolSize(getThreadPoolSize());
        loadInfo.setReportTime(System.currentTimeMillis());
        <span class="hljs-keyword">return</span> loadInfo;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getCpuUsage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">OperatingSystemMXBean</span> <span class="hljs-variable">osBean</span> <span class="hljs-operator">=</span> ManagementFactory.getOperatingSystemMXBean();
            <span class="hljs-keyword">if</span> (osBean <span class="hljs-keyword">instanceof</span> com.sun.management.OperatingSystemMXBean) {
                <span class="hljs-keyword">return</span> ((com.sun.management.OperatingSystemMXBean) osBean)
                    .getSystemCpuLoad() * <span class="hljs-number">100</span>;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.warn(<span class="hljs-string">"获取CPU使用率失败"</span>, e);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getMemoryUsage</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();
        <span class="hljs-type">long</span> <span class="hljs-variable">totalMemory</span> <span class="hljs-operator">=</span> runtime.totalMemory();
        <span class="hljs-type">long</span> <span class="hljs-variable">freeMemory</span> <span class="hljs-operator">=</span> runtime.freeMemory();
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) (totalMemory - freeMemory) / totalMemory * <span class="hljs-number">100</span>;
    }
}
</code></pre>
<p>职责：只负责收集负载信息。</p>
<h3 data-id="heading-9">模块 2：调度器选择器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerSelectionService</span> {
    
    <span class="hljs-keyword">public</span> ServiceInstance <span class="hljs-title function_">selectResponsibleScheduler</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 从 Nacos 获取所有调度器</span>
            List&lt;Instance&gt; instances = namingService.getAllInstances(schedulerServiceName);
            
            <span class="hljs-keyword">if</span> (instances.isEmpty()) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            
            <span class="hljs-comment">// 2. 排序（保证一致性）</span>
            instances.sort(Comparator.comparing(i -&gt; i.getIp() + <span class="hljs-string">":"</span> + i.getPort()));
            
            <span class="hljs-comment">// 3. Hash 选择</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Math.abs(serviceName.hashCode());
            <span class="hljs-type">int</span> <span class="hljs-variable">targetIndex</span> <span class="hljs-operator">=</span> hash % instances.size();
            <span class="hljs-type">Instance</span> <span class="hljs-variable">targetInstance</span> <span class="hljs-operator">=</span> instances.get(targetIndex);
            
            <span class="hljs-keyword">return</span> convertToServiceInstance(targetInstance);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.warn(<span class="hljs-string">"选择负责调度器失败"</span>, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<p>职责：根据服务名 Hash 选择负责调度器。</p>
<h3 data-id="heading-10">模块 3：负载上报器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LightweightLoadReporter</span> {
    
    <span class="hljs-meta">@Scheduled(fixedRateString = "${jobflow.executor.load-report.report-interval-seconds:60}000")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reportLoad</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!enabled) {
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 收集负载</span>
            <span class="hljs-type">ExecutorLoadInfo</span> <span class="hljs-variable">loadInfo</span> <span class="hljs-operator">=</span> loadCollector.collect();
            loadInfo.setServiceName(serviceName);
            loadInfo.setInstanceId(instanceId);
            
            <span class="hljs-comment">// 2. 选择调度器</span>
            <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> schedulerSelectionService.selectResponsibleScheduler();
            <span class="hljs-keyword">if</span> (scheduler == <span class="hljs-literal">null</span>) {
                log.warn(<span class="hljs-string">"未找到负责调度器，跳过负载上报"</span>);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 3. 上报（带重试）</span>
            reportWithRetry(scheduler, loadInfo);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.warn(<span class="hljs-string">"负载上报失败"</span>, e);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reportWithRetry</span><span class="hljs-params">(ServiceInstance scheduler, ExecutorLoadInfo loadInfo)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">retry</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; retry &lt; maxRetries; retry++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">String</span> <span class="hljs-variable">reportUrl</span> <span class="hljs-operator">=</span> scheduler.getUri() + <span class="hljs-string">"/internal/load/report"</span>;
                
                <span class="hljs-type">HttpHeaders</span> <span class="hljs-variable">headers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHeaders</span>();
                headers.setContentType(MediaType.APPLICATION_JSON);
                HttpEntity&lt;ExecutorLoadInfo&gt; request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpEntity</span>&lt;&gt;(loadInfo, headers);
                
                restTemplate.exchange(reportUrl, HttpMethod.POST, request, Void.class);
                
                log.debug(<span class="hljs-string">"负载上报成功，scheduler={}, cpu={}, memory={}"</span>,
                        scheduler.getUri(), loadInfo.getCpuUsage(), loadInfo.getMemoryUsage());
                <span class="hljs-keyword">return</span>;
                
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">if</span> (retry &lt; maxRetries - <span class="hljs-number">1</span>) {
                    <span class="hljs-comment">// 指数退避</span>
                    <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> retryDelayMs * (<span class="hljs-number">1</span> &lt;&lt; retry);
                    Thread.sleep(delay);
                }
            }
        }
        
        log.error(<span class="hljs-string">"负载上报最终失败，已重试 {} 次"</span>, maxRetries);
    }
}
</code></pre>
<p>职责：定期上报负载，带重试机制。</p>
<h3 data-id="heading-11">模块 4：负载均衡策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LightweightLoadBalancingStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalancingStrategy</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ServiceInstance <span class="hljs-title function_">select</span><span class="hljs-params">(List&lt;ServiceInstance&gt; instances, 
                                  String serviceName, 
                                  LoadInfoStorage loadInfoStorage)</span> {
        
        <span class="hljs-keyword">if</span> (instances == <span class="hljs-literal">null</span> || instances.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-keyword">if</span> (instances.size() == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> instances.get(<span class="hljs-number">0</span>);
        }
        
        <span class="hljs-comment">// 获取负载信息</span>
        List&lt;ExecutorLoadInfo&gt; loadInfos = loadInfoStorage.getLoadInfos(serviceName);
        
        <span class="hljs-comment">// 降级：没有负载信息</span>
        <span class="hljs-keyword">if</span> (loadInfos.isEmpty()) {
            log.debug(<span class="hljs-string">"没有负载信息，回退到随机选择"</span>);
            <span class="hljs-keyword">return</span> instances.get(RANDOM.nextInt(instances.size()));
        }
        
        <span class="hljs-comment">// 选择权重最高的实例</span>
        <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">bestInstance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">double</span> <span class="hljs-variable">bestWeight</span> <span class="hljs-operator">=</span> Double.MIN_VALUE;
        
        <span class="hljs-keyword">for</span> (ServiceInstance instance : instances) {
            <span class="hljs-type">String</span> <span class="hljs-variable">instanceId</span> <span class="hljs-operator">=</span> instance.getHost() + <span class="hljs-string">":"</span> + instance.getPort();
            <span class="hljs-type">ExecutorLoadInfo</span> <span class="hljs-variable">loadInfo</span> <span class="hljs-operator">=</span> findLoadInfo(loadInfos, instanceId);
            
            <span class="hljs-type">double</span> weight;
            <span class="hljs-keyword">if</span> (loadInfo == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 降级：该实例无负载信息，给予默认权重</span>
                weight = <span class="hljs-number">80.0</span>; <span class="hljs-comment">// 假设默认负载 20%</span>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 计算权重</span>
                <span class="hljs-type">double</span> <span class="hljs-variable">cpuScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> - loadInfo.getCpuUsage();
                <span class="hljs-type">double</span> <span class="hljs-variable">memoryScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span> - loadInfo.getMemoryUsage();
                <span class="hljs-type">double</span> <span class="hljs-variable">threadPoolScore</span> <span class="hljs-operator">=</span> calculateThreadPoolScore(loadInfo);
                weight = cpuScore * <span class="hljs-number">0.4</span> + memoryScore * <span class="hljs-number">0.4</span> + threadPoolScore * <span class="hljs-number">0.2</span>;
            }
            
            <span class="hljs-keyword">if</span> (weight &gt; bestWeight) {
                bestWeight = weight;
                bestInstance = instance;
            }
        }
        
        <span class="hljs-keyword">return</span> bestInstance;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateThreadPoolScore</span><span class="hljs-params">(ExecutorLoadInfo loadInfo)</span> {
        <span class="hljs-keyword">if</span> (loadInfo.getThreadPoolSize() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-type">double</span> <span class="hljs-variable">usage</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) loadInfo.getThreadPoolActive() 
                         / loadInfo.getThreadPoolSize() * <span class="hljs-number">100</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-number">100</span> - usage;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
    }
}
</code></pre>
<p>职责：根据负载信息选择最优执行器。</p>
<h2 data-id="heading-12">完整流程</h2>
<p>把各个模块串起来：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant E as 执行器
    participant N as Nacos
    participant S as 调度器
    
    Note over E: 定时收集负载
    E-&gt;&gt;E: 收集CPU、内存、线程池
    
    Note over E: 选择负责调度器
    E-&gt;&gt;N: 查询所有调度器实例
    N--&gt;&gt;E: 返回调度器列表
    E-&gt;&gt;E: Hash(serviceName) % count
    
    Note over E: 上报负载
    E-&gt;&gt;S: POST /internal/load/report
    S-&gt;&gt;S: 存储到内存Map
    S--&gt;&gt;E: 200 OK
    
    Note over S: 任务触发时选择执行器
    S-&gt;&gt;S: 获取负载信息
    S-&gt;&gt;S: 计算权重，选择最优
    S-&gt;&gt;E: 调用执行器
</code></pre>
<p>分两个阶段：</p>
<p><strong>阶段 1：负载上报（后台持续进行）</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">执行器每 60 秒：
<span class="hljs-bullet">1.</span> 收集负载信息（CPU、内存、线程池）
<span class="hljs-bullet">2.</span> Hash(serviceName) 选择负责调度器
<span class="hljs-bullet">3.</span> HTTP POST 上报给调度器
<span class="hljs-bullet">4.</span> 调度器存储到内存 Map
</code></pre>
<p><strong>阶段 2：任务调度（触发时进行）</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">当任务触发时：
<span class="hljs-bullet">1.</span> 调度器查询可用执行器列表（从 Nacos）
<span class="hljs-bullet">2.</span> 从内存 Map 获取负载信息
<span class="hljs-bullet">3.</span> 计算每个实例的权重
<span class="hljs-bullet">4.</span> 选择权重最高的实例
<span class="hljs-bullet">5.</span> HTTP 调用执行器
</code></pre>
<p><strong>关键设计：负载上报和任务调度解耦，即使上报失败，任务调度也能降级执行。</strong></p>
<h2 data-id="heading-13">降级策略</h2>
<p>系统设计了多层降级：</p>
<pre><code class="hljs language-erlang" lang="erlang">降级路径 <span class="hljs-number">1</span>：没有负载信息
→ 随机选择

降级路径 <span class="hljs-number">2</span>：部分实例无负载信息
→ 给予默认权重 <span class="hljs-number">80</span>（假设负载 <span class="hljs-number">20</span><span class="hljs-comment">%）</span>

降级路径 <span class="hljs-number">3</span>：负载均衡策略失败
→ 回退到轮询

降级路径 <span class="hljs-number">4</span>：所有调度器挂了
→ 上报失败，但不影响业务
</code></pre>
<p>每一层降级都在保护系统可用性。<strong>宁可功能退化，不能系统不可用。</strong></p>
<h2 data-id="heading-14">配置说明</h2>
<h3 data-id="heading-15">执行器配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobflow:</span>
  <span class="hljs-attr">executor:</span>
    <span class="hljs-attr">load-report:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 启用负载上报</span>
      <span class="hljs-attr">report-interval-seconds:</span> <span class="hljs-number">60</span> <span class="hljs-comment"># 上报间隔 60 秒</span>
      <span class="hljs-attr">max-retries:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 最大重试 3 次</span>
      <span class="hljs-attr">retry-delay-ms:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># 重试延迟 1 秒</span>
</code></pre>
<h3 data-id="heading-16">调度器配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">load-aware:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 启用负载感知调度</span>
</code></pre>
<h2 data-id="heading-17">测试验证</h2>
<h3 data-id="heading-18">1. 负载上报</h3>
<p>执行器日志：</p>
<pre><code class="hljs language-ini" lang="ini">2026-01-10T10:59:51.589+08:00 DEBUG --- <span class="hljs-section">[scheduling-1]</span> c.s.j.c.l.LightweightLoadReporter  : 
负载上报成功，<span class="hljs-attr">scheduler</span>=http://<span class="hljs-number">192.168</span>.<span class="hljs-number">71.174</span>:<span class="hljs-number">8080</span>, cpu=<span class="hljs-number">21.69</span>, memory=<span class="hljs-number">58.86</span>
</code></pre>
<p>调度器日志：</p>
<pre><code class="hljs language-ini" lang="ini">2026-01-10T10:59:51.589+08:00 DEBUG --- <span class="hljs-section">[nio-8080-exec-3]</span> c.s.j.s.c.LoadReportController  : 
收到负载上报，<span class="hljs-attr">instanceId</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">71.174</span>:<span class="hljs-number">8081</span>, serviceName=user-service-example, 
<span class="hljs-attr">cpuUsage</span>=<span class="hljs-number">21.69</span>, memoryUsage=<span class="hljs-number">58.86</span>
</code></pre>
<p>上报正常，调度器成功接收负载数据。</p>
<h3 data-id="heading-19">2. 任务调度</h3>
<p>任务触发时的日志：</p>
<pre><code class="hljs language-ini" lang="ini">2026-01-10T11:00:02.523+08:00 DEBUG --- <span class="hljs-section">[scheduling-1]</span> c.s.j.s.s.ClusterInstanceService  : 
调度 owner 判定, <span class="hljs-attr">jobKey</span>=user-service-example<span class="hljs-comment">#demo-job-every-minute, </span>
<span class="hljs-attr">schedulerInstanceId</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">71.174</span>:<span class="hljs-number">8080</span>, isOwner=<span class="hljs-literal">true</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini">2026-01-10T11:00:02.524+08:00  INFO --- <span class="hljs-section">[scheduling-1]</span> c.s.j.s.s.JobFlowSchedulerService  : 
触发任务执行, <span class="hljs-attr">jobName</span>=demo-job-every-minute, triggerTime=<span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-<span class="hljs-number">10</span>T11:<span class="hljs-number">00</span>:<span class="hljs-number">02.522789</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini">2026-01-10T11:00:02.528+08:00  INFO --- <span class="hljs-section">[scheduling-1]</span> c.s.j.s.s.JobExecutionService  : 
创建父执行记录, <span class="hljs-attr">jobName</span>=demo-job-every-minute, parentId=<span class="hljs-number">1576</span>, traceId=<span class="hljs-number">20260110110002</span>-<span class="hljs-number">06</span>f2ab24
</code></pre>
<h3 data-id="heading-20">3. 任务执行</h3>
<p>执行器日志：</p>
<pre><code class="hljs language-ini" lang="ini">2026-01-10 11:00:02.534 <span class="hljs-section">[http-nio-8081-exec-3]</span> INFO  c.s.j.c.e.JobExecutorController - 
<span class="hljs-section">[traceId=20260110110002-06f2ab24-0]</span> 开始执行任务，<span class="hljs-attr">handler</span>=demoJob
</code></pre>
<pre><code class="hljs language-ini" lang="ini">2026-01-10 11:00:02.534 <span class="hljs-section">[http-nio-8081-exec-3]</span> INFO  c.s.j.e.u.h.DemoJobHandler - 
<span class="hljs-section">[traceId=20260110110002-06f2ab24-0]</span> <span class="hljs-section">[DemoJob]</span> 执行开始, <span class="hljs-attr">shardStart</span>=<span class="hljs-number">0</span>, shardEnd=<span class="hljs-number">0</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini">2026-01-10 11:00:02.534 <span class="hljs-section">[http-nio-8081-exec-3]</span> INFO  c.s.j.e.u.h.DemoJobHandler - 
<span class="hljs-section">[traceId=20260110110002-06f2ab24-0]</span> <span class="hljs-section">[DemoJob]</span> 执行完成
</code></pre>
<p>回调完成：</p>
<pre><code class="hljs language-ini" lang="ini">2026-01-10 11:00:02.548 <span class="hljs-section">[jobflow-callback-71]</span> INFO  c.s.j.c.e.JobExecutorController - 
<span class="hljs-section">[traceId=20260110110002-06f2ab24-0]</span> 已回调 scheduler, <span class="hljs-attr">traceId</span>=<span class="hljs-number">20260110110002</span>-<span class="hljs-number">06</span>f2ab24-<span class="hljs-number">0</span>
</code></pre>
<p>全链路通了，TraceId 贯穿始终。</p>
<h3 data-id="heading-21">4. 负载均衡效果</h3>
<p>测试场景：</p>
<pre><code class="hljs language-ini" lang="ini">启动 3 个执行器实例
手动给实例 1 加压（CPU 打到 80%）
触发任务，观察调度结果

负载数据：
- 实例 1：CPU 80%，权重 = 20*0.4 + 40*0.4 + 80*<span class="hljs-attr">0.2</span> = <span class="hljs-number">40</span>
- 实例 2：CPU 30%，权重 = 70*0.4 + 50*0.4 + 80*<span class="hljs-attr">0.2</span> = <span class="hljs-number">64</span>
- 实例 3：CPU 50%，权重 = 50*0.4 + 60*0.4 + 80*<span class="hljs-attr">0.2</span> = <span class="hljs-number">60</span>

预期：调度器选择实例 2（权重最高）
实际：任务确实调度到了实例 2
</code></pre>
<p>负载感知调度生效。</p>
<h2 data-id="heading-22">关键设计点</h2>
<h3 data-id="heading-23">1. 为什么不用 Redis</h3>
<p>对比两种方案：</p>
<p><strong>Redis 方案：</strong></p>
<ul>
<li>优势：数据持久化、多调度器共享</li>
<li>劣势：引入依赖、需要处理一致性、需要处理过期</li>
</ul>
<p><strong>HTTP 方案：</strong></p>
<ul>
<li>优势：无依赖、实现简单、降级容易</li>
<li>劣势：数据不持久化、调度器重启丢失</li>
</ul>
<p>选择 HTTP 方案的理由：</p>
<ul>
<li>负载数据本身就是实时的，60 秒后会重新上报</li>
<li>调度器重启是小概率事件，即使丢失也能快速恢复</li>
<li>简单性比完美性更重要</li>
</ul>
<h3 data-id="heading-24">2. Hash 选择的一致性</h3>
<p>关键代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 排序保证一致性</span>
instances.sort(Comparator.comparing(i -&gt; i.getIp() + <span class="hljs-string">":"</span> + i.getPort()));
</code></pre>
<p>如果不排序：</p>
<pre><code class="hljs language-css" lang="css">执行器看到：<span class="hljs-selector-attr">[A, B, C]</span>
调度器看到：<span class="hljs-selector-attr">[C, A, B]</span>

Hash 结果不一致，负载数据对不上
</code></pre>
<p>排序是分布式一致性的基础。</p>
<h3 data-id="heading-25">3. 多层降级</h3>
<p>系统在多个层面都有降级：</p>
<pre><code class="hljs">层级 1：指标收集失败 → 返回默认值 0
层级 2：无负载信息 → 随机选择
层级 3：部分无负载 → 给予默认权重
层级 4：策略失败 → 回退轮询
</code></pre>
<p>分布式系统要假设任何环节都可能失败，降级是必须的。</p>
<h3 data-id="heading-26">4. 权重计算</h3>
<p>当前权重分配是 CPU(40%) + 内存(40%) + 线程池(20%)。</p>
<p>这是根据经验设定的，不同业务场景可能需要不同的权重。后续可以支持配置化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">load-aware:</span>
  <span class="hljs-attr">weight:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-number">0.4</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-number">0.4</span>
    <span class="hljs-attr">thread-pool:</span> <span class="hljs-number">0.2</span>
</code></pre>
<h2 data-id="heading-27">总结</h2>
<p>负载感知调度功能已经实现并验证，核心特点：</p>
<ol>
<li><strong>轻量级</strong>：无外部依赖，只用 Java 标准 API</li>
<li><strong>简单</strong>：HTTP 直接上报，调度器内存存储</li>
<li><strong>可靠</strong>：多层降级，功能退化但系统不挂</li>
<li><strong>灵活</strong>：权重可调整，适应不同场景</li>
</ol>
<p>这个功能解决了执行器负载不均衡的问题，提高了系统资源利用率。</p>
<p>最重要的是，它延续了 JobFlow 的设计理念：<strong>用最简单的方案，解决实际问题。</strong></p>
<hr/>
<p>代码已经提交到 Gitee：<code>https://gitee.com/sh_wangwanbao/job-flow</code></p>
<p>如果你有更好的想法或遇到问题，欢迎提 issue 讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 把代码改崩溃了？若爱 (IfAI) v0.2.7 发布：程序员的“后悔药”真的来了！]]></title>    <link>https://juejin.cn/post/7593193235251068980</link>    <guid>https://juejin.cn/post/7593193235251068980</guid>    <pubDate>2026-01-09T11:38:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593193235251068980" data-draft-id="7593181244708814900" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 把代码改崩溃了？若爱 (IfAI) v0.2.7 发布：程序员的“后悔药”真的来了！"/> <meta itemprop="keywords" content="AI编程,Rust"/> <meta itemprop="datePublished" content="2026-01-09T11:38:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="peterfei"/> <meta itemprop="url" content="https://juejin.cn/user/2700056287782663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 把代码改崩溃了？若爱 (IfAI) v0.2.7 发布：程序员的“后悔药”真的来了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056287782663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    peterfei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T11:38:33.000Z" title="Fri Jan 09 2026 11:38:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎙️ 引言：AI 时代，我们还在用“燃油车”改代码吗？</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8062bba147c54733a647efafc7d8c0c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768563513&amp;x-signature=o4ZOo6okUOJ0M1MuPOyHzgv2Yhc%3D" alt="截屏2026-01-09 17.49.43.png" loading="lazy"/></p>
<p>各位掘金的开发者，大家好，我是Peterfei。</p>
<p>在 2026 年初的 AI 浪潮中，智谱 AI 的估值狂飙、DeepSeek 的极速进化让我们目不暇接。但作为一个每天和代码打交道的程序员，你是否思考过：<strong>为什么我们还在传统编辑器（VS Code/JetBrains）的基础上，通过“缝合”插件来使用 AI？</strong></p>
<p>这种体验就像是在老旧的燃油车上强行挂了一个电动机——能跑，但总觉得哪里不对劲。直到我深度体验了 <strong>若爱 (IfAI) v0.2.7</strong>，我才意识到，所谓的“AI 原生（AI-Native）”编辑器，绝不是多一个对话框那么简单。</p>
<p>今天，我们就来硬核拆解一下 IfAI v0.2.7 带来的体验飞跃。</p>
<hr/>
<h2 data-id="heading-1">🏗️ v0.2.7 核心架构图：AI 原生是如何炼成的？</h2>
<p>在深入功能之前，我们先看一眼 IfAI 的底层逻辑。与传统编辑器“插件式”接入 AI 不同，IfAI 将 AI 推理与文件系统、Shell 环境进行了深度耦合。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8dbf93da74444639c021370580f73d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGV0ZXJmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768563513&amp;x-signature=cOgYD%2Fyt3rcw%2F%2FCbOu27%2Fmv%2FDmU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">一、 AI 代码回滚：程序员的“后悔药”逻辑</h2>
<p>很多人不敢让 AI 做大规模重构，是因为 AI 经常会“幻觉”。AI 啪的一下修改了 10 个文件，如果跑不通，手动 <code>Ctrl+Z</code> 简直是灾难。</p>
<p><strong>IfAI v0.2.7 实现了精准的“AI 原子变更记录器”。</strong></p>
<p>它不仅仅记录文本变化，还记录了 AI 交互的上下文。以下是其底层 Change Tracker 的核心实现逻辑：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 伪代码：IfAI 原子变更记录结构</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title">AIChangeRecord</span> {
  id: <span class="hljs-built_in">string</span>;              <span class="hljs-comment">// 交互 ID</span>
  timestamp: number;
  files: {
    path: <span class="hljs-built_in">string</span>;
    type: <span class="hljs-string">'modify'</span> | <span class="hljs-string">'add'</span> | <span class="hljs-string">'delete'</span>;
    contentBefore: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 变更前的全量快照</span>
    contentAfter: <span class="hljs-built_in">string</span>;
    diffSummary: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// 用于渲染 Smart Diff 的索引</span>
  }[];
}
​
<span class="hljs-comment">// 核心回滚逻辑：确保文件系统与 UI 状态同步</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">performRollback</span>(<span class="hljs-params">recordId: <span class="hljs-built_in">string</span></span>)</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">record</span> = <span class="hljs-keyword">await</span> changeHistory.<span class="hljs-keyword">get</span>(recordId);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file of <span class="hljs-keyword">record</span>.files) {
    <span class="hljs-keyword">if</span> (file.type === <span class="hljs-string">'add'</span>) {
      <span class="hljs-keyword">await</span> fs.<span class="hljs-keyword">remove</span>(file.path); <span class="hljs-comment">// 回滚新增：物理删除</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">await</span> fs.writeFile(file.path, file.contentBefore); <span class="hljs-comment">// 恢复原始内容</span>
    }
  }
  <span class="hljs-comment">// 触发 UI 层的 FileTree 刷新与编辑器重载</span>
  eventBus.emit(<span class="hljs-string">'FILES_RECOVERED'</span>, <span class="hljs-keyword">record</span>.files.map(f =&gt; f.path));
}
</code></pre>
<p>这种设计让你敢于放手让 AI 去实验，因为你永远拥有一键归位的能力。</p>
<hr/>
<h2 data-id="heading-3">二、 120FPS 性能信仰：Rust 层的片段合并算法</h2>
<p>为什么 IfAI 在 AI 疯狂生成代码时，UI 依然丝滑？这归功于我们在 Rust 层实现的 <strong>Streaming Buffer Manager</strong>。</p>
<p>传统流式渲染会为每一个收到的 Token 创建一个 DOM 节点，这在万行代码生成时会导致 React Fiber 调度爆炸。IfAI v0.2.7 在 Rust 中继层实现了一个高效的缓冲区合并策略：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 伪代码：Rust 层的流式片段合并逻辑</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">StreamBuffer</span> {
    last_fragment: <span class="hljs-type">String</span>,
    last_type: FragmentType,
}
​
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">StreamBuffer</span> {
    <span class="hljs-comment">// 当新的 Token 到达时，判断是否可以与上一片段合并</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">push</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, new_text: &amp;<span class="hljs-type">str</span>, frag_type: FragmentType) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt; {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.last_type == frag_type &amp;&amp; !<span class="hljs-title function_ invoke__">is_complex_markdown</span>(new_text) {
            <span class="hljs-comment">// 合并文本，减少跨进程传递给前端的频率</span>
            <span class="hljs-keyword">self</span>.last_fragment.<span class="hljs-title function_ invoke__">push_str</span>(new_text);
            <span class="hljs-literal">None</span> 
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">completed</span> = <span class="hljs-keyword">self</span>.last_fragment.<span class="hljs-title function_ invoke__">clone</span>();
            <span class="hljs-keyword">self</span>.last_fragment = new_text.<span class="hljs-title function_ invoke__">to_string</span>();
            <span class="hljs-keyword">self</span>.last_type = frag_type;
            <span class="hljs-title function_ invoke__">Some</span>(completed) <span class="hljs-comment">// 触发前端创建一个新的语义节点</span>
        }
    }
}
</code></pre>
<p>通过这种合并策略，我们减少了约 <strong>40% 的 DOM 节点</strong>，从而保证了在高 refresh rate 屏幕下的 <strong>120FPS</strong> 满帧体验。</p>
<hr/>
<h2 data-id="heading-4">三、 从“对话驱动”到“测试驱动”：E2E 测试闭环</h2>
<p>IfAI v0.2.7 最硬核的进化，是它不再只是“写”代码，它还会“验证”代码。</p>
<p>Agent 现在可以自主调用新引入的 <strong>全链路自动化测试框架</strong>。当它帮你写完一个登录组件，它会自动生成并运行如下脚本：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Agent 自动生成的验证脚本</span>
test(<span class="hljs-string">'Verify AI generated Login flow'</span>, <span class="hljs-keyword">async</span> ({ page }) =&gt; {
  <span class="hljs-keyword">await</span> page.<span class="hljs-keyword">goto</span>(<span class="hljs-string">'/preview/auth'</span>);
  
  <span class="hljs-comment">// 使用内置数据生成器注入 Mock 数据</span>
  <span class="hljs-keyword">await</span> page.fill(<span class="hljs-string">'input[name="email"]'</span>, DataGenerator.email());
  <span class="hljs-keyword">await</span> page.fill(<span class="hljs-string">'input[name="password"]'</span>, <span class="hljs-string">'StrongPass123!'</span>);
  <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'button[type="submit"]'</span>);
  
  <span class="hljs-comment">// 验证业务闭环</span>
  <span class="hljs-keyword">await</span> expect(page.locator(<span class="hljs-string">'.welcome-msg'</span>)).toBeVisible();
});
</code></pre>
<p>这种 <strong>“写代码 -&gt; 跑测试 -&gt; 自动纠错”</strong> 的闭环，才是 AI 编辑器的终极形态。</p>
<hr/>
<h2 data-id="heading-5">四、 生态与隐私：智谱、DeepSeek 与本地模型的混合路由</h2>
<p>在国产大模型全面崛起的今天，IfAI v0.2.7 提供了极致的灵活度：</p>
<ul>
<li><strong>云端增强</strong>：深度优化了对 <strong>DeepSeek-V3/R1</strong> 和 <strong>智谱清言</strong> 的适配，响应延迟降低了 30%。</li>
<li><strong>隐私至上</strong>：支持混合路由。你可以配置编辑器，让它把敏感的核心业务逻辑交给本地的 <strong>Qwen2.5-Coder</strong> 处理，而将繁琐的文档编写交给云端大模型。</li>
</ul>
<hr/>
<h2 data-id="heading-6">💬 结语</h2>
<p>AI 不应该取代程序员，AI 应该成为程序员的“机械外骨骼”。</p>
<p>从 v0.2.1 到 v0.2.7，IfAI 正在证明：一个懂环境、懂性能、甚至懂测试的编辑器，能让编程的爽感提升多少。</p>
<p><strong>如果你也厌倦了传统编辑器的臃肿，渴望那种 120FPS 的极致控制感，欢迎在 GitHub 搜索 <code>ifai</code> 体验。</strong></p>
<hr/>
<h3 data-id="heading-7">🎁 掘金福利互动</h3>
<p><strong>你认为 AI 编程工具最让你“血压飙升”的时刻是什么？</strong></p>
<p>欢迎在评论区分享。我们将从评论区抽取 5 位深度开发者，赠送 <strong>IfAI Pro 体验版</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员武学修炼手册（一）：入门篇——初学乍练，从 Hello World 到能跑就行]]></title>    <link>https://juejin.cn/post/7593165280488783913</link>    <guid>https://juejin.cn/post/7593165280488783913</guid>    <pubDate>2026-01-09T13:38:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593165280488783913" data-draft-id="7593098101432762422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员武学修炼手册（一）：入门篇——初学乍练，从 Hello World 到能跑就行"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-09T13:38:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员武学修炼手册（一）：入门篇——初学乍练，从 Hello World 到能跑就行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T13:38:02.000Z" title="Fri Jan 09 2026 13:38:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>"千里之行，始于足下；万行代码，始于 Hello World。"
—— 《程序员武学心法》</p>
</blockquote>
<h2 data-id="heading-0">开篇：程序员的武学境界</h2>
<p>在武侠世界里，习武之人从入门弟子到一代宗师，需要经历漫长的修炼。</p>
<p>在程序员的世界里，我们也有类似的成长路径。今天，让我们用武学的视角，重新审视程序员的修炼之路。</p>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────────┐
│              程序员武学境界总览                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   第一境：初学乍练 ——  能写代码，能跑就行（入门弟子）          │
│   第二境：小有所成 ——  代码规范，知其所以然（三流高手）        │
│   第三境：融会贯通 ——  架构设计，独当一面（一流高手）          │
│   第四境：登峰造极 ——  技术专家，指点江山（绝顶高手）          │
│   第五境：开宗立派 ——  自成一家，影响江湖（一代宗师）          │
│                                                             │
│   番外：走火入魔 —— 那些修炼路上的歧途                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p>本系列将分为六篇，今天是第一篇：<strong>初学乍练</strong>。</p>
<hr/>
<h2 data-id="heading-1">第一章：初学乍练的特征</h2>
<h3 data-id="heading-2">1.1 什么是初学乍练？</h3>
<p>初学乍练，是每个程序员的起点。</p>
<p>就像武侠小说里刚入门的弟子，刚拿到一本剑谱，连基本的扎马步都不稳，但眼里充满了对武学的向往。</p>
<p><strong>初学乍练程序员的典型特征：</strong></p>
<ul>
<li>刚学会一门语言，觉得自己无所不能</li>
<li>代码能跑就是胜利</li>
<li>变量命名：<code>a</code>, <code>b</code>, <code>c</code>, <code>temp</code>, <code>temp2</code>, <code>temp3</code></li>
<li>注释？不存在的</li>
<li>遇到 Bug 第一反应：重启试试？</li>
</ul>
<h3 data-id="heading-3">1.2 初学乍练的心理状态</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初学乍练程序员的内心独白</span>

<span class="hljs-keyword">const</span> beginnerMindset = {
  <span class="hljs-attr">day1</span>: <span class="hljs-string">"Hello World跑通了！我是天才！"</span>,
  <span class="hljs-attr">day7</span>: <span class="hljs-string">"这个for循环好难...算了，复制粘贴"</span>,
  <span class="hljs-attr">day30</span>: <span class="hljs-string">"我已经会写函数了，可以找工作了吧？"</span>,
  <span class="hljs-attr">day60</span>: <span class="hljs-string">"为什么我的代码别人看不懂？明明很清晰啊"</span>,
  <span class="hljs-attr">day90</span>: <span class="hljs-string">"原来我写的是屎山..."</span>,
}
</code></pre>
<hr/>
<h2 data-id="heading-4">第二章：初学乍练的修炼内容</h2>
<h3 data-id="heading-5">2.1 第一式：Hello World</h3>
<p>每个程序员的第一招，必是 Hello World。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript版</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello, World!"</span>)

<span class="hljs-comment">// 练气期程序员的进阶版</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello, World!"</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello, World!!"</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello, World!!!"</span>)
<span class="hljs-comment">// 为什么要打三遍？因为我能！</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python版</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, World!"</span>)

<span class="hljs-comment"># 练气期程序员的"优化"版</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, World!"</span> + <span class="hljs-string">"!"</span> * i)
<span class="hljs-comment"># 这样更有气势！</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java版</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"Hello, World!"</span>);
    }
}

<span class="hljs-comment">// 练气期程序员的困惑：</span>
<span class="hljs-comment">// 为什么打印个Hello World要写这么多？</span>
<span class="hljs-comment">// public是什么？static是什么？void又是什么？</span>
<span class="hljs-comment">// 算了，能跑就行...</span>
</code></pre>
<h3 data-id="heading-6">2.2 第二式：变量与类型</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的变量命名艺术</span>

<span class="hljs-comment">// 阶段1：单字母时期</span>
<span class="hljs-keyword">let</span> a = <span class="hljs-number">1</span>
<span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>
<span class="hljs-keyword">let</span> c = a + b

<span class="hljs-comment">// 阶段2：拼音时期</span>
<span class="hljs-keyword">let</span> nianling = <span class="hljs-number">18</span>
<span class="hljs-keyword">let</span> mingzi = <span class="hljs-string">"张三"</span>
<span class="hljs-keyword">let</span> gongzi = <span class="hljs-number">10000</span>

<span class="hljs-comment">// 阶段3：中英混搭时期</span>
<span class="hljs-keyword">let</span> userNianling = <span class="hljs-number">18</span>
<span class="hljs-keyword">let</span> userName = <span class="hljs-string">"张三"</span>
<span class="hljs-keyword">let</span> userGongzi = <span class="hljs-number">10000</span>

<span class="hljs-comment">// 阶段4：开始觉醒</span>
<span class="hljs-keyword">let</span> userAge = <span class="hljs-number">18</span>
<span class="hljs-keyword">let</span> userName = <span class="hljs-string">"张三"</span>
<span class="hljs-keyword">let</span> userSalary = <span class="hljs-number">10000</span>
<span class="hljs-comment">// 虽然还是有点问题，但已经在进步了</span>
</code></pre>
<h3 data-id="heading-7">2.3 第三式：条件判断</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的if-else艺术</span>

<span class="hljs-comment">// 初级写法：一路if到底</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getGrade</span>(<span class="hljs-params">score</span>) {
  <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>
  }
  <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>
  }
  <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">70</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>
  }
  <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>
}

<span class="hljs-comment">// 练气期"优化"版：嵌套地狱</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getGradeNested</span>(<span class="hljs-params">score</span>) {
  <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
    <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">70</span>) {
      <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span>) {
        <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-string">"A"</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-string">"B"</span>
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"C"</span>
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">"D"</span>
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"F"</span>
  }
}
<span class="hljs-comment">// 能跑！完美！（并不）</span>

<span class="hljs-comment">// 练气期的终极形态：复制粘贴大法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUser</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">type</span> === <span class="hljs-string">"admin"</span>) {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">status</span> === <span class="hljs-string">"active"</span>) {
      <span class="hljs-keyword">if</span> (user.<span class="hljs-property">level</span> &gt;= <span class="hljs-number">5</span>) {
        <span class="hljs-comment">// 100行代码</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 复制上面100行，改几个字</span>
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 再复制100行</span>
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 继续复制...</span>
  }
}
</code></pre>
<h3 data-id="heading-8">2.4 第四式：循环</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的循环修炼</span>

<span class="hljs-comment">// 第一层：for循环</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i)
}
<span class="hljs-comment">// 掌握了！我是天才！</span>

<span class="hljs-comment">// 第二层：while循环</span>
<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">10</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i)
  <span class="hljs-comment">// 忘记 i++ 了...</span>
  <span class="hljs-comment">// 程序卡死</span>
  <span class="hljs-comment">// 为什么？？？</span>
}

<span class="hljs-comment">// 第三层：嵌套循环</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10</span>; j++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">10</span>; k++) {
      <span class="hljs-comment">// 三层循环，性能杀手</span>
      <span class="hljs-comment">// 但是能跑！</span>
    }
  }
}

<span class="hljs-comment">// 练气期经典Bug：死循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">infiniteLoop</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    arr.<span class="hljs-title function_">push</span>(i) <span class="hljs-comment">// 数组越来越长...</span>
    <span class="hljs-comment">// 电脑风扇开始狂转</span>
    <span class="hljs-comment">// 浏览器卡死</span>
    <span class="hljs-comment">// 强制关机</span>
  }
}
</code></pre>
<h3 data-id="heading-9">2.5 第五式：函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的函数修炼</span>

<span class="hljs-comment">// 阶段1：不知道什么是函数</span>
<span class="hljs-comment">// 所有代码写在一起，500行一个文件</span>

<span class="hljs-comment">// 阶段2：知道函数，但不会用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 200行代码</span>
  <span class="hljs-comment">// 做了10件不同的事</span>
  <span class="hljs-comment">// 函数名叫doSomething，因为确实在做something</span>
}

<span class="hljs-comment">// 阶段3：函数太多，不知道怎么组织</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">step1</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">step2</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">step3</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">step4</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">step5</span>(<span class="hljs-params"/>) {}
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">step99</span>(<span class="hljs-params"/>) {}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">step1</span>()
  <span class="hljs-title function_">step2</span>()
  <span class="hljs-title function_">step3</span>()
  <span class="hljs-comment">// ...</span>
  <span class="hljs-title function_">step99</span>()
}

<span class="hljs-comment">// 阶段4：开始理解函数的意义</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTax</span>(<span class="hljs-params">income</span>) {
  <span class="hljs-comment">// 只做一件事：计算税</span>
  <span class="hljs-keyword">return</span> income * <span class="hljs-number">0.2</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatCurrency</span>(<span class="hljs-params">amount</span>) {
  <span class="hljs-comment">// 只做一件事：格式化金额</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">`¥<span class="hljs-subst">${amount.toFixed(<span class="hljs-number">2</span>)}</span>`</span>
}
</code></pre>
<h3 data-id="heading-10">2.6 第六式：数组与对象</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的数据结构</span>

<span class="hljs-comment">// 数组的使用</span>
<span class="hljs-keyword">let</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]

<span class="hljs-comment">// 练气期的数组操作</span>
<span class="hljs-comment">// 想删除第3个元素</span>
arr[<span class="hljs-number">2</span>] = <span class="hljs-literal">undefined</span> <span class="hljs-comment">// 这样对吗？</span>
<span class="hljs-comment">// 结果：[1, 2, undefined, 4, 5]</span>
<span class="hljs-comment">// 好像不太对...</span>

<span class="hljs-comment">// 正确做法（但练气期不知道）</span>
arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>)

<span class="hljs-comment">// 对象的使用</span>
<span class="hljs-keyword">let</span> user = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
}

<span class="hljs-comment">// 练气期的对象操作</span>
user.<span class="hljs-property">mingzi</span> = <span class="hljs-string">"李四"</span> <span class="hljs-comment">// 为什么不生效？</span>
<span class="hljs-comment">// 因为属性名是name不是mingzi...</span>

<span class="hljs-comment">// 练气期经典困惑：引用类型</span>
<span class="hljs-keyword">let</span> arr1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-keyword">let</span> arr2 = arr1
arr2.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr1) <span class="hljs-comment">// [1, 2, 3, 4] ???</span>
<span class="hljs-comment">// 为什么arr1也变了？？？</span>
<span class="hljs-comment">// 这个Bug找了三天...</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">第三章：初学乍练的常见走火入魔</h2>
<h3 data-id="heading-12">3.1 复制粘贴走火入魔</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 症状：同样的代码出现N次</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUserA</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-comment">// 验证用户</span>
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">name</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"name required"</span>)
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">email</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"email required"</span>)
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"phone required"</span>)

  <span class="hljs-comment">// 处理数据</span>
  user.<span class="hljs-property">name</span> = user.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>()
  user.<span class="hljs-property">email</span> = user.<span class="hljs-property">email</span>.<span class="hljs-title function_">toLowerCase</span>()

  <span class="hljs-comment">// 保存</span>
  database.<span class="hljs-title function_">save</span>(user)

  <span class="hljs-comment">// 发送通知</span>
  <span class="hljs-title function_">sendEmail</span>(user.<span class="hljs-property">email</span>, <span class="hljs-string">"Welcome!"</span>)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUserB</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-comment">// 复制上面的代码</span>
  <span class="hljs-comment">// 改了一个字</span>
  <span class="hljs-comment">// 验证用户</span>
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">name</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"name required"</span>)
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">email</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"email required"</span>)
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">phone</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"phone required"</span>)

  <span class="hljs-comment">// 处理数据</span>
  user.<span class="hljs-property">name</span> = user.<span class="hljs-property">name</span>.<span class="hljs-title function_">trim</span>()
  user.<span class="hljs-property">email</span> = user.<span class="hljs-property">email</span>.<span class="hljs-title function_">toLowerCase</span>()

  <span class="hljs-comment">// 保存</span>
  database.<span class="hljs-title function_">save</span>(user)

  <span class="hljs-comment">// 发送通知</span>
  <span class="hljs-title function_">sendEmail</span>(user.<span class="hljs-property">email</span>, <span class="hljs-string">"Welcome Back!"</span>) <span class="hljs-comment">// 就改了这里</span>
}

<span class="hljs-comment">// 后果：改一个地方要改N个地方，总有漏的</span>
</code></pre>
<h3 data-id="heading-13">3.2 过度注释走火入魔</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 症状：注释比代码还多</span>

<span class="hljs-comment">// 定义一个变量i，初始值为0</span>
<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>

<span class="hljs-comment">// 使用while循环</span>
<span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">10</span>) {
  <span class="hljs-comment">// 当i小于10时</span>
  <span class="hljs-comment">// 打印i的值</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i) <span class="hljs-comment">// 输出当前的i</span>
  <span class="hljs-comment">// i自增1</span>
  i++ <span class="hljs-comment">// i = i + 1</span>
} <span class="hljs-comment">// while循环结束</span>

<span class="hljs-comment">// 这种注释不如不写...</span>
</code></pre>
<h3 data-id="heading-14">3.3 变量命名走火入魔</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 症状：变量名让人怀疑人生</span>

<span class="hljs-comment">// 拼音派</span>
<span class="hljs-keyword">let</span> nianling = <span class="hljs-number">18</span>
<span class="hljs-keyword">let</span> xingming = <span class="hljs-string">"张三"</span>
<span class="hljs-keyword">let</span> shouji = <span class="hljs-string">"13800138000"</span>

<span class="hljs-comment">// 缩写派</span>
<span class="hljs-keyword">let</span> usrNm = <span class="hljs-string">"张三"</span>
<span class="hljs-keyword">let</span> usrAg = <span class="hljs-number">18</span>
<span class="hljs-keyword">let</span> usrPh = <span class="hljs-string">"13800138000"</span>

<span class="hljs-comment">// 数字派</span>
<span class="hljs-keyword">let</span> user1 = {}
<span class="hljs-keyword">let</span> user2 = {}
<span class="hljs-keyword">let</span> user11 = {} <span class="hljs-comment">// 不是user1的升级版</span>
<span class="hljs-keyword">let</span> user111 = {} <span class="hljs-comment">// 也不是user11的升级版</span>

<span class="hljs-comment">// 混搭派</span>
<span class="hljs-keyword">let</span> <span class="hljs-title function_">getUserXinxi</span> = (<span class="hljs-params"/>) =&gt; {} <span class="hljs-comment">// 中英混搭</span>
<span class="hljs-keyword">let</span> <span class="hljs-variable constant_">YONGHU_INFO</span> = {} <span class="hljs-comment">// 拼音+英文</span>

<span class="hljs-comment">// 终极形态</span>
<span class="hljs-keyword">let</span> aaaa = <span class="hljs-number">1</span>
<span class="hljs-keyword">let</span> bbbb = <span class="hljs-number">2</span>
<span class="hljs-keyword">let</span> cccc = aaaa + bbbb
<span class="hljs-keyword">let</span> dddd = cccc * <span class="hljs-number">2</span>
<span class="hljs-comment">// 一周后自己都看不懂</span>
</code></pre>
<h3 data-id="heading-15">3.4 缩进走火入魔</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 症状：缩进混乱，Tab和空格混用</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">chaos</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"2空格"</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"4空格？不，是Tab"</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"这是几个空格？"</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"这是Tab"</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Tab+空格混搭"</span>)
  }
}

<span class="hljs-comment">// 后果：代码在不同编辑器里显示不一样</span>
<span class="hljs-comment">// 同事打开你的代码：这是什么鬼？</span>
</code></pre>
<hr/>
<h2 data-id="heading-16">第四章：初学乍练的突破契机</h2>
<h3 data-id="heading-17">4.1 第一次代码审查</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你提交的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calc</span>(<span class="hljs-params">a, b, c</span>) {
  <span class="hljs-keyword">let</span> temp = a + b
  <span class="hljs-keyword">let</span> temp2 = temp * c
  <span class="hljs-keyword">return</span> temp2
}

<span class="hljs-comment">// 代码审查反馈</span>
<span class="hljs-comment">/*
 * 1. 函数名calc太模糊，计算什么？
 * 2. 参数a, b, c是什么意思？
 * 3. temp, temp2命名不清晰
 * 4. 可以直接return，不需要中间变量
 *
 * 建议修改为：
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotalPrice</span>(<span class="hljs-params">unitPrice, quantity, taxRate</span>) {
  <span class="hljs-keyword">return</span> unitPrice * quantity * taxRate
}

<span class="hljs-comment">// 你的内心：原来代码还可以这样写...</span>
</code></pre>
<h3 data-id="heading-18">4.2 第一次维护别人的代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你接手的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x</span>) {
  <span class="hljs-keyword">let</span> a = x[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">let</span> b = x[<span class="hljs-number">1</span>]
  <span class="hljs-keyword">let</span> c = x[<span class="hljs-number">2</span>]
  <span class="hljs-keyword">if</span> (a &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (b &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (c &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> a * b * c
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> a * b
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> a
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  }
}

<span class="hljs-comment">// 你的任务：修改这个函数，支持第四个参数</span>

<span class="hljs-comment">// 你的内心：</span>
<span class="hljs-comment">// 这是什么？</span>
<span class="hljs-comment">// x是什么？</span>
<span class="hljs-comment">// a, b, c是什么？</span>
<span class="hljs-comment">// 为什么要这样嵌套？</span>
<span class="hljs-comment">// 我改哪里？</span>
<span class="hljs-comment">// 算了，我重写一个...</span>

<span class="hljs-comment">// 顿悟：原来写清晰的代码这么重要</span>
</code></pre>
<h3 data-id="heading-19">4.3 第一次生产事故</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你写的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteUser</span>(<span class="hljs-params">userId</span>) {
  database.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"users"</span>, { <span class="hljs-attr">id</span>: userId })
}

<span class="hljs-comment">// 调用时</span>
<span class="hljs-title function_">deleteUser</span>() <span class="hljs-comment">// 忘记传参数了</span>

<span class="hljs-comment">// 结果</span>
database.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"users"</span>, { <span class="hljs-attr">id</span>: <span class="hljs-literal">undefined</span> })
<span class="hljs-comment">// 某些数据库会把这理解为：删除所有用户</span>
<span class="hljs-comment">// 用户表清空了...</span>

<span class="hljs-comment">// 事后复盘</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteUserSafe</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// 参数校验！</span>
  <span class="hljs-keyword">if</span> (!userId) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"userId is required"</span>)
  }

  <span class="hljs-comment">// 二次确认</span>
  <span class="hljs-keyword">const</span> user = database.<span class="hljs-title function_">findOne</span>(<span class="hljs-string">"users"</span>, { <span class="hljs-attr">id</span>: userId })
  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"user not found"</span>)
  }

  <span class="hljs-comment">// 软删除而不是硬删除</span>
  database.<span class="hljs-title function_">update</span>(<span class="hljs-string">"users"</span>, { <span class="hljs-attr">id</span>: userId }, { <span class="hljs-attr">deleted</span>: <span class="hljs-literal">true</span> })

  <span class="hljs-comment">// 记录日志</span>
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`User <span class="hljs-subst">${userId}</span> deleted`</span>)
}

<span class="hljs-comment">// 顿悟：防御性编程真的很重要</span>
</code></pre>
<hr/>
<h2 data-id="heading-20">第五章：初学乍练的修炼心法</h2>
<h3 data-id="heading-21">5.1 心法一：代码是写给人看的</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的认知</span>
<span class="hljs-comment">// "代码是写给电脑执行的"</span>

<span class="hljs-comment">// 突破后的认知</span>
<span class="hljs-comment">// "代码首先是写给人看的，其次才是给电脑执行的"</span>

<span class="hljs-comment">// 实践</span>
<span class="hljs-comment">// 不好的代码</span>
<span class="hljs-keyword">let</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
<span class="hljs-keyword">let</span> h = d.<span class="hljs-title function_">getHours</span>()
<span class="hljs-keyword">let</span> m = d.<span class="hljs-title function_">getMinutes</span>()
<span class="hljs-keyword">let</span> s = d.<span class="hljs-title function_">getSeconds</span>()
<span class="hljs-keyword">let</span> t = h + <span class="hljs-string">":"</span> + m + <span class="hljs-string">":"</span> + s

<span class="hljs-comment">// 好的代码</span>
<span class="hljs-keyword">const</span> currentDate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
<span class="hljs-keyword">const</span> hours = currentDate.<span class="hljs-title function_">getHours</span>()
<span class="hljs-keyword">const</span> minutes = currentDate.<span class="hljs-title function_">getMinutes</span>()
<span class="hljs-keyword">const</span> seconds = currentDate.<span class="hljs-title function_">getSeconds</span>()
<span class="hljs-keyword">const</span> timeString = <span class="hljs-string">`<span class="hljs-subst">${hours}</span>:<span class="hljs-subst">${minutes}</span>:<span class="hljs-subst">${seconds}</span>`</span>
</code></pre>
<h3 data-id="heading-22">5.2 心法二：不要重复自己（DRY）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params">email</span>) {
  <span class="hljs-keyword">if</span> (!email) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (!email.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"@"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateUserEmail</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">email</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (!user.<span class="hljs-property">email</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"@"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateAdminEmail</span>(<span class="hljs-params">admin</span>) {
  <span class="hljs-keyword">if</span> (!admin.<span class="hljs-property">email</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (!admin.<span class="hljs-property">email</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"@"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-comment">// 突破后的代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params">email</span>) {
  <span class="hljs-keyword">if</span> (!email) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> (!email.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"@"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateUserEmail</span>(<span class="hljs-params">user</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">validateEmail</span>(user?.<span class="hljs-property">email</span>)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateAdminEmail</span>(<span class="hljs-params">admin</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">validateEmail</span>(admin?.<span class="hljs-property">email</span>)
}
</code></pre>
<h3 data-id="heading-23">5.3 心法三：先让它工作，再让它正确，最后让它快</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 练气期的误区：一开始就追求完美</span>

<span class="hljs-comment">// 正确的修炼顺序：</span>

<span class="hljs-comment">// 第一步：让它工作（Make it work）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sort</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-comment">// 冒泡排序，O(n²)，但能用</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; j++) {
      <span class="hljs-keyword">if</span> (arr[j] &gt; arr[j + <span class="hljs-number">1</span>]) {
        <span class="hljs-keyword">let</span> temp = arr[j]
        arr[j] = arr[j + <span class="hljs-number">1</span>]
        arr[j + <span class="hljs-number">1</span>] = temp
      }
    }
  }
  <span class="hljs-keyword">return</span> arr
}

<span class="hljs-comment">// 第二步：让它正确（Make it right）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sort</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-comment">// 添加参数校验</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Input must be an array"</span>)
  }
  <span class="hljs-comment">// 不修改原数组</span>
  <span class="hljs-keyword">const</span> result = [...arr]
  <span class="hljs-comment">// 排序逻辑...</span>
  <span class="hljs-keyword">return</span> result
}

<span class="hljs-comment">// 第三步：让它快（Make it fast）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sort</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-comment">// 使用更高效的算法</span>
  <span class="hljs-comment">// 或者直接用内置方法</span>
  <span class="hljs-keyword">return</span> [...arr].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b)
}
</code></pre>
<hr/>
<h2 data-id="heading-24">第六章：初学乍练的出师考核</h2>
<h3 data-id="heading-25">6.1 自测题</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 问题1：这段代码有什么问题？</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>)) <span class="hljs-comment">// 输出什么？</span>

<span class="hljs-comment">// 问题2：这段代码会输出什么？</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i), <span class="hljs-number">100</span>)
}

<span class="hljs-comment">// 问题3：找出Bug</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findMax</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">let</span> max = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (arr[i] &gt; max) {
      max = arr[i]
    }
  }
  <span class="hljs-keyword">return</span> max
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">findMax</span>([-<span class="hljs-number">1</span>, -<span class="hljs-number">2</span>, -<span class="hljs-number">3</span>])) <span class="hljs-comment">// 期望-1，实际输出？</span>

<span class="hljs-comment">// 问题4：这段代码的问题是什么？</span>
<span class="hljs-keyword">let</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> }
<span class="hljs-keyword">let</span> copy = user
copy.<span class="hljs-property">name</span> = <span class="hljs-string">"李四"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>) <span class="hljs-comment">// 输出什么？</span>
</code></pre>
<h3 data-id="heading-26">6.2 出师标准</h3>
<p>当你能做到以下几点，就可以准备突破到小有所成了：</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────┐
│              初学乍练出师标准 ✓                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   □ 能独立完成简单功能的开发                                 │
│   □ 知道变量、函数、循环、条件判断的基本用法                  │
│   □ 能看懂简单的报错信息                                     │
│   □ 知道Google/Stack Overflow怎么用                         │
│   □ 开始意识到代码规范的重要性                               │
│   □ 能写出别人勉强能看懂的代码                               │
│   □ 经历过至少一次<span class="hljs-string">"我写的代码怎么不能用了"</span>的崩溃             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-27">结语：初学乍练的意义</h2>
<p>初学乍练是每个程序员必经的阶段。</p>
<p>在这个阶段，你会：</p>
<ul>
<li>写出很多"能跑就行"的代码</li>
<li>犯很多现在看来很蠢的错误</li>
<li>经历很多"为什么不行"的崩溃时刻</li>
</ul>
<p>但这些都是成长的必经之路。</p>
<p><strong>没有人一开始就是高手。</strong></p>
<p>那些现在写出优雅代码的大侠，当年也写过<code>var a = 1; var b = 2; var c = a + b;</code>。</p>
<p>所以，不要因为自己是新手而气馁。</p>
<p><strong>每一个 Bug 都是一次修炼，每一次崩溃都是一次突破的契机。</strong></p>
<p>下一篇，我们将进入<strong>小有所成</strong>——当你开始关注代码规范、开始思考"为什么要这样写"的时候，你就踏入了三流高手的大门。</p>
<hr/>
<h2 data-id="heading-28">预告：小有所成</h2>
<p>在小有所成阶段，你将学习：</p>
<ul>
<li>代码规范与最佳实践</li>
<li>设计模式入门</li>
<li>单元测试的重要性</li>
<li>版本控制的正确使用</li>
<li>如何写出"可维护"的代码</li>
</ul>
<p>敬请期待！</p>
<hr/>
<p><em>本文是《程序员武学修炼手册》系列的第一篇。</em></p>
<p><em>如果你正处于初学乍练阶段，不要焦虑，每个大侠都是从扎马步开始的。</em></p>
<p><em>欢迎在评论区分享你初学乍练时的"黑历史"——毕竟，能笑着回忆过去的蠢，说明你已经成长了。</em> 😄</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一步到位：M4 芯片 Mac 安装 PostgreSQL 16 并适配 pgvector 教程]]></title>    <link>https://juejin.cn/post/7593145583348318250</link>    <guid>https://juejin.cn/post/7593145583348318250</guid>    <pubDate>2026-01-09T16:18:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593145583348318250" data-draft-id="7593139476841267206" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一步到位：M4 芯片 Mac 安装 PostgreSQL 16 并适配 pgvector 教程"/> <meta itemprop="keywords" content="后端,PostgreSQL"/> <meta itemprop="datePublished" content="2026-01-09T16:18:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="利兄的视界"/> <meta itemprop="url" content="https://juejin.cn/user/2049145405715710"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一步到位：M4 芯片 Mac 安装 PostgreSQL 16 并适配 pgvector 教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145405715710/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    利兄的视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T16:18:22.000Z" title="Fri Jan 09 2026 16:18:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、安装 PostgreSQL 16</h2>
<h3 data-id="heading-1">1. 通过 Homebrew 安装 PostgreSQL 16</h3>
<p>打开终端，执行以下命令通过 Homebrew 安装指定版本的 PostgreSQL 16：</p>
<pre><code class="hljs language-css" lang="css">brew install postgresql<span class="hljs-keyword">@16</span>
</code></pre>
<h3 data-id="heading-2">2. 配置环境变量</h3>
<p>将 PostgreSQL 16 的可执行文件路径添加到环境变量，确保终端能直接识别 pg 相关命令（适配 zsh 终端，若使用 bash 需将 .zshrc 替换为 .bashrc）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> .zshrc
</code></pre>
<h3 data-id="heading-3">3. 配置允许局域网访问</h3>
<p>默认配置下 PostgreSQL 仅允许本地访问，若需局域网内其他设备连接，需修改配置文件：</p>
<pre><code class="hljs language-bash" lang="bash">vi /opt/homebrew/var/postgresql@16/postgresql.conf
</code></pre>
<p>在文件中找到被注释的 <code>listen_addresses</code> 行，取消注释并修改为以下内容（监听所有网络接口，支持本地及局域网访问）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">listen_addresses</span> = <span class="hljs-string">'*'</span>  <span class="hljs-comment"># 监听所有IP，如需仅本地访问可改为'localhost'</span>
<span class="hljs-comment"># 注：修改后需重启服务才能生效</span>
</code></pre>
<h3 data-id="heading-4">4. 启动 PostgreSQL 服务</h3>
<p>使用 Homebrew 命令启动服务，该命令会自动配置开机自启：</p>
<pre><code class="hljs language-sql" lang="sql">brew services <span class="hljs-keyword">start</span> postgresql<span class="hljs-variable">@16</span>
</code></pre>
<p>验证启动状态：若终端无报错，可通过 <code>brew services list</code> 查看，postgresql@16 一行显示 <code>started</code> 即为成功。</p>
<h3 data-id="heading-5">5. 创建 PostgreSQL 超级用户角色</h3>
<p>首先通过默认方式进入 PostgreSQL 命令行（默认连接系统自带的 postgres 数据库）：</p>
<pre><code class="hljs">psql -d postgres
</code></pre>
<p>若终端提示符变为 <code>postgres=#</code>，说明成功进入命令行环境。执行以下 SQL 语句创建超级用户角色（替换密码为自定义密码）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建 postgres 角色，赋予超级用户权限、创建数据库/角色权限，并设置密码</span>
<span class="hljs-keyword">CREATE</span> ROLE postgres <span class="hljs-keyword">WITH</span> LOGIN SUPERUSER CREATEDB CREATEROLE PASSWORD <span class="hljs-string">'你的自定义密码'</span>;
​
<span class="hljs-comment">-- （可选）验证角色创建结果：列出所有角色信息</span>
\du
​
<span class="hljs-comment">-- 退出 PostgreSQL 命令行</span>
\q
</code></pre>
<h3 data-id="heading-6">6. 修改认证规则（关键：确保密码登录生效）</h3>
<p>编辑 pg_hba.conf 配置文件，调整认证方式为密码认证（替换默认的 peer/trust 模式）：</p>
<pre><code class="hljs language-bash" lang="bash">vi /opt/homebrew/var/postgresql@16/pg_hba.conf
</code></pre>
<p>找到对应配置行，修改或添加以下规则（覆盖原有同名配置）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 本地socket连接：采用md5密码认证</span>
local   <span class="hljs-built_in">all</span>             <span class="hljs-built_in">all</span>                                     md5
<span class="hljs-comment"># TCP/IP本地连接（127.0.0.1）：采用md5密码认证</span>
host    <span class="hljs-built_in">all</span>             <span class="hljs-built_in">all</span>             <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>/<span class="hljs-number">32</span>            md5
<span class="hljs-comment"># （可选）允许局域网内所有设备访问：采用md5密码认证（需提前配置listen_addresses='*'）</span>
host    <span class="hljs-built_in">all</span>             <span class="hljs-built_in">all</span>             <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span>               md5
</code></pre>
<h3 data-id="heading-7">7. 重启服务使配置生效</h3>
<p>修改完 postgresql.conf 和 pg_hba.conf 后，必须重启服务才能让配置生效：</p>
<pre><code class="hljs language-css" lang="css">brew services restart postgresql<span class="hljs-keyword">@16</span>
</code></pre>
<h2 data-id="heading-8">二、安装并适配 pgvector 扩展</h2>
<p>pgvector 是 PostgreSQL 的向量数据库扩展，需通过源码编译安装以适配本地 PostgreSQL 16 环境。</p>
<h3 data-id="heading-9">1. 安装编译依赖工具</h3>
<p>首先安装 git、make、gcc 等编译必需的工具：</p>
<pre><code class="hljs language-go" lang="go">brew install git <span class="hljs-built_in">make</span> gcc
</code></pre>
<h3 data-id="heading-10">2. 克隆 pgvector 源码并编译安装</h3>
<p>通过 git 克隆源码，指定 PostgreSQL 16 的 pg_config 路径进行编译安装（确保适配当前安装的 PG 版本）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆 pgvector 源码到本地</span>
git <span class="hljs-built_in">clone</span> https://github.com/pgvector/pgvector.git
<span class="hljs-comment"># 进入源码目录</span>
<span class="hljs-built_in">cd</span> pgvector
​
<span class="hljs-comment"># 编译：指定 PostgreSQL 16 的 pg_config 路径（关键：避免适配错误版本）</span>
make PG_CONFIG=/opt/homebrew/opt/postgresql@16/bin/pg_config
​
<span class="hljs-comment"># 安装到 PostgreSQL 16 扩展目录（需输入电脑开机密码）</span>
sudo make install PG_CONFIG=/opt/homebrew/opt/postgresql@16/bin/pg_config
</code></pre>
<h3 data-id="heading-11">3. 验证 pgvector 编译安装结果</h3>
<p>通过查看 PostgreSQL 16 扩展目录是否存在 vector 相关文件，验证安装是否成功：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ls</span> -la /opt/homebrew/opt/postgresql@16/share/postgresql@16/extension/ | grep vector
</code></pre>
<p>若输出中包含 <code>vector.control</code> 和 <code>vector--x.x.x.sql</code>（x.x.x 为版本号），说明编译安装成功。</p>
<h3 data-id="heading-12">4. 重启 PostgreSQL 并创建 pgvector 扩展</h3>
<p>安装完成后需重启 PostgreSQL 服务，然后在数据库中创建 vector 扩展：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 重启 PostgreSQL 16 服务（修正原文档笔误：将@15改为@16）</span>
brew services restart postgresql@16
​
<span class="hljs-comment"># 进入 PostgreSQL 命令行</span>
psql -d postgres -U postgres  <span class="hljs-comment"># -U 指定刚创建的 postgres 角色，需输入之前设置的密码</span>
​
<span class="hljs-comment"># 在命令行中创建 vector 扩展</span>
CREATE EXTENSION IF NOT EXISTS vector<span class="hljs-comment">;</span>
</code></pre>
<p>若执行 <code>CREATE EXTENSION IF NOT EXISTS vector;</code> 后无报错，说明扩展创建成功。</p>
<h3 data-id="heading-13">5. 测试 pgvector 功能可用性</h3>
<p>通过创建向量表、插入数据、查询数据的流程，验证 pgvector 是否正常工作：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 创建包含向量字段的测试表（vector(3) 表示3维向量）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> test_vectors (
  id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
  vec vector(<span class="hljs-number">3</span>)
);
​
<span class="hljs-comment">-- 2. 插入2条3维向量测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_vectors (vec) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'[1,2,3]'</span>), (<span class="hljs-string">'[4,5,6]'</span>);
​
<span class="hljs-comment">-- 3. 查询插入的数据，验证向量字段正常存储</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> test_vectors;
​
<span class="hljs-comment">-- （可选）测试完成后删除测试表</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> test_vectors;
​
<span class="hljs-comment">-- （可选）退出命令行</span>
\q
</code></pre>
<p>若上述 SQL 语句均能正常执行且无报错，说明 pgvector 已完全适配 PostgreSQL 16 并可用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThinkPHP 8 报错"think\model\pivot" not found]]></title>    <link>https://juejin.cn/post/7593193235251626036</link>    <guid>https://juejin.cn/post/7593193235251626036</guid>    <pubDate>2026-01-09T20:25:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593193235251626036" data-draft-id="7593187953272209408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThinkPHP 8 报错&quot;think\model\pivot&quot; not found"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T20:25:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GZKING"/> <meta itemprop="url" content="https://juejin.cn/user/1018603594590138"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThinkPHP 8 报错"think\model\pivot" not found
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1018603594590138/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GZKING
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T20:25:42.000Z" title="Fri Jan 09 2026 20:25:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>不知道大家用不用TP框架<br/>
最近呢自己手搓了一个项目，放到线上运行后报错了，记录一下！</strong></h2>
<h2 data-id="heading-1"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51a68129b31743f893e15788326248be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR1pLSU5H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768595142&amp;x-signature=1LDpmBRx52istOPHet8nQwU%2BZZU%3D" alt="image.png" loading="lazy"/></h2>
<p><strong>一.触发原因</strong></p>
<p>1.使用TP的多应用模式think-multi-app<br/>
2.使用了模型中间表</p>
<p><strong>二.触发代码</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">admin</span>\<span class="hljs-title class_">model</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">Model</span>\<span class="hljs-title">Pivot</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminRole</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pivot</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$autoWriteTimestamp</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$convertNameToCamel</span> = <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>三.问题分析</strong></p>
<p>1.可以看到在IDE里面composer的自动引入是可以读取到的，但是在线上就无法找到</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25e6cd5f06fc4b2ca3a68a3974a6cb80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR1pLSU5H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768595142&amp;x-signature=qu5X5rVw0CWsC9OWQp5uX5uhVj4%3D" alt="image.png" loading="lazy"/>
且本地测试是可以运行起来也不会报错。<br/>
搜了很多帖子看没有大佬贴出来的，估计TP用的人不怎么多。<br/>
尝试删除缓存和依赖重新安装依赖还是不行。一开始考虑RS4规范问题，但是检查后没错。
问题甩给AI，也不好使。</p>
<p>2.这里主要问题是TP的命名空间是小写的model，但是正常我们在使用模型时继承的是Model，正常情况使用Model不会异常，不知道怎么回事官方也没有说明，且Model模型和Pivot都是属于TP的ORM的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99e10921bc60470787e53755e59de86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR1pLSU5H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768595142&amp;x-signature=ssBj0j4hdEddXZtSTS5v739FkTQ%3D" alt="image.png" loading="lazy"/>
3.最后问了下AI</p>
<blockquote>
<ul>
<li>TP8 把 ORM 独立成了<code>think-orm</code>包，<code>Pivot</code>类的真实文件路径是：<code>vendor/topthink/think-orm/src/model/Pivot.php</code><br/>
-该文件的命名空间是 <code>namespace think\model;</code> (<strong>小写的 model</strong>)，而不是 <code>namespace think\Model;</code> (大写的 Model)</li>
</ul>
</blockquote>
<p><strong>四.问题解决于总结</strong><br/>
将Model改为小写的就行了</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">app</span>\<span class="hljs-title class_">admin</span>\<span class="hljs-title class_">model</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">Pivot</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminRole</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pivot</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$autoWriteTimestamp</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$convertNameToCamel</span> = <span class="hljs-literal">true</span>;
}
</code></pre>
<p>问题原因也是我在开发时没有报错或者警告什么，代码也能正常运行
所以也没有留意，真是错一个就难搞！<br/>
写一个文章记录一下，避免下次在遇到这种低端问题。<br/>
这里贴个图吧</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/719677e6a95341049594273a5737ca02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR1pLSU5H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768595142&amp;x-signature=hFSXFr9IJnNAHJ2v4auoOkEd7z4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>