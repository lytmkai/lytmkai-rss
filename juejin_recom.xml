<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[【虚拟机】使用OpenWrt作为虚拟机集群的软路由（下）]]></title>    <link>https://juejin.cn/post/7585463195201945650</link>    <guid>https://juejin.cn/post/7585463195201945650</guid>    <pubDate>2025-12-20T13:57:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201945650" data-draft-id="7585446706328141833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【虚拟机】使用OpenWrt作为虚拟机集群的软路由（下）"/> <meta itemprop="keywords" content="Linux,网络协议"/> <meta itemprop="datePublished" content="2025-12-20T13:57:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猛喝威士忌"/> <meta itemprop="url" content="https://juejin.cn/user/3837719308930574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【虚拟机】使用OpenWrt作为虚拟机集群的软路由（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3837719308930574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猛喝威士忌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:57:42.000Z" title="Sat Dec 20 2025 13:57:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Background</h2>
<p>上一篇：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ceerdecy.com%2Farticle%2Fvm%2Fopenwrt%2Finstall" target="_blank" title="https://www.ceerdecy.com/article/vm/openwrt/install" ref="nofollow noopener noreferrer">【虚拟机】使用VMware安装Openwrt（上）</a></p>
<p>上一篇文章我们已经安装好了一个Openwrt虚拟机，那么这篇我们将教大家如何进行配来实现我们以下的架构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/683b08e719c746228b2c4a04c7de508b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=yuYhm2KDBTbhTQt35z5bFQC6s5M%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">设置网卡</h2>
<p>我们将为Openwrt的虚拟机添加两张<code>网络适配器</code></p>
<p>第一张使用<code>桥接模式</code>作为eth0网卡</p>
<p>第二张使用自定义的虚拟网络，选择<code>仅主机模式</code>的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c68365b35aab40e99c0180a9be69ca77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=Mc35NDRzkkYYr2JmBwmsmhX%2F%2FHE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">为Openwrt配置网络</h2>
<p>我们打开宿主机（Windows）的终端，使用<code>ifconfig</code>查看一下网络适配器。</p>
<p>这里我们需要关注一下宿主机在我们刚刚添加的虚拟网络中的<code>IP</code>和<code>子网掩码</code> 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9654966551f4938b424413efa6f3db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=oyNv8E%2Fpz0mQzDzCM4RMjLS80vA%3D" alt="image.png" loading="lazy"/></p>
<p>回到Openwrt的虚拟机中，输入<code>vi /etc/config/network</code> 。</p>
<p>输入<code>i</code>键进入编辑模式，配置按照图上的内容进行修改，需要单独留意一下红色方框中的<code>ipaddr</code>以及<code>netmask</code></p>
<p>ipaddr需要设置得与刚刚查询的宿主机ip不一样，比如宿主机ip为<code>192.168.211.1</code>，那么我们设置为<code>192.168.211.2</code> 即可，<code>netmask</code>则和宿主机的的子网掩码一致。</p>
<p>按下<code>esc</code>输入<code>:wq</code>保存</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb924b80d1e94d989f1ded5ee8b7ff3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=ruXM9Z%2Fb1JE52G0WKxYJRxWZvzs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7928d140b0a942d38c99942b1248a400~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=rgyUfG92neQNU5xnU%2BE12g6B5Y4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">配置转发规则</h2>
<p>执行命令<code>sysctl -w net.ipv4.ip_forward=1</code> 确保开启内核转发。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b933479e57c4bb5bbcdaab0423a2a02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=PI6z3Cj2OPeC%2ByouwtszhRj8z8w%3D" alt="image.png" loading="lazy"/>
执行以下命令,将Lan口流量通过Wan口进行转发，这样我们连接Openwrt的虚拟机就可以访问网络了。</p>
<pre><code class="hljs language-bash" lang="bash">uci <span class="hljs-built_in">set</span> firewall.@zone[1].masq=<span class="hljs-string">'1'</span>
uci add firewall forwarding
uci <span class="hljs-built_in">set</span> firewall.@forwarding[-1].src=<span class="hljs-string">'lan'</span>
uci <span class="hljs-built_in">set</span> firewall.@forwarding[-1].dest=<span class="hljs-string">'wan'</span>
uci commit firewall
/etc/init.d/firewall restart
</code></pre>
<h2 data-id="heading-4">连接Openwrt</h2>
<p>现在我们可以创建另一个Linux虚拟机来连接它，这里我们使用Ubuntu的镜像。考虑到需要作为k8s的节点，所以将<code>IP固定</code>下来会比较合适，而非使用<code>DHCP</code>。</p>
<p>这里我们只需要添加一个网络适配器即可，即仅主机模式的VMnet1。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8c65258635946ad8fbc3de5d3605f95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=TgXnZ%2FlckVgvGg4t%2Bez78qRJmiw%3D" alt="image.png" loading="lazy"/></p>
<p>输入<code>sudo vi /etc/netplan/50-cloud-init.yaml</code> 对网络进行设置：</p>
<p>其中<code>addresses</code>设置为本机想要绑定的ip</p>
<p><code>192.168.211.1</code>分配给了宿主机</p>
<p><code>192.168.211.2</code>分配给了Openwrt</p>
<p>因此本机的就不能是这两个了，而为了更好区分，我们可以从<code>10</code>开始分配，如果有多个虚拟机想要链接，那么<code>11</code>、<code>12</code>、<code>13</code>依次累加即可。这里我们就分配<code>192.168.211.10</code>给当前机器，<code>/24</code>是因为子网掩码为<code>255.255.255.0</code>，如果你的子网掩码与我的不同，那这个数值也需要修改。</p>
<p><code>gateway4</code>设置的是网关地址，即Openwrt的地址</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f5a14df97304f27abfd1278e472cf99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=3Qu47pKbk0Ac71LT4frEc0Pi%2Bqg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd4ac43f2c3f481cb38e1f3d73af7e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=r0%2Bi%2FfqgEEE1P9ZJ3MjgjtMxafY%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-yaml" lang="yaml">    <span class="hljs-attr">network:</span>
      <span class="hljs-attr">version:</span> <span class="hljs-number">2</span>
      <span class="hljs-attr">renderer:</span> <span class="hljs-string">networkd</span>
      <span class="hljs-attr">ethernets:</span>
        <span class="hljs-attr">ens33:</span>
          <span class="hljs-attr">dhcp4:</span> <span class="hljs-literal">no</span> <span class="hljs-comment"># 关闭DHCP</span>
          <span class="hljs-attr">addresses:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.10</span><span class="hljs-string">/24</span>
          <span class="hljs-attr">gateway4:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.2</span>
          <span class="hljs-attr">nameservers:</span>
            <span class="hljs-attr">addresses:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.211</span><span class="hljs-number">.2</span>
              <span class="hljs-bullet">-</span> <span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>
              <span class="hljs-bullet">-</span> <span class="hljs-number">114.114</span><span class="hljs-number">.114</span><span class="hljs-number">.114</span>
</code></pre>
<p>还有别忘了执行这个，应用一下设置。</p>
<pre><code class="hljs language-bash" lang="bash">sudo netplan apply
</code></pre>
<p>接着我们<code>curl</code>一下<code>www.baidu.com</code> ，就能发现这台机器已经可以正常访问网络了。这样我的Openwrt的配置就算完成了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cda91c47d6ba4d17b25d53d38d4b9f7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yb5Zad5aiB5aOr5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843862&amp;x-signature=MkSdqsUpWUIszm6DZ%2BeCMJQNXb8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>上一篇：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ceerdecy.com%2Farticle%2Fvm%2Fopenwrt%2Finstall" target="_blank" title="https://www.ceerdecy.com/article/vm/openwrt/install" ref="nofollow noopener noreferrer">【虚拟机】使用VMware安装Openwrt（上）</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：如何生成ExecutionGraph]]></title>    <link>https://juejin.cn/post/7585452404113637391</link>    <guid>https://juejin.cn/post/7585452404113637391</guid>    <pubDate>2025-12-20T13:59:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404113637391" data-draft-id="7585452404113621007" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：如何生成ExecutionGraph"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2025-12-20T13:59:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：如何生成ExecutionGraph
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:59:07.000Z" title="Sat Dec 20 2025 13:59:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天我们一起来了解 Flink 最后一种执行图，ExecutionGraph 的执行过程。</p>
<h3 data-id="heading-0">基本概念</h3>
<p>在阅读源码之前，我们先来了解一下 ExecutionGraph 中的一些基本概念。</p>
<ul>
<li>
<p><strong>ExecutionJobVertex:</strong>  ExecutionJobVertex 是 ExecutionGraph 中的节点，对应的是 JobGraph 中的 JobVertex。</p>
</li>
<li>
<p><strong>ExecutionVertex:</strong> 每个 ExecutionJobVertex 都包含了一组 ExecutionVertex，ExecutionVertex 的数量就是节点对应的并行度。</p>
</li>
<li>
<p><strong>IntermediateResult:</strong> IntermediateResult 表示节点的输出结果，与之对应的是 JobGraph 中的 IntermediateDataSet。</p>
</li>
<li>
<p><strong>IntermediateResultPartition:</strong> IntermediateResultPartition 是每个 ExecutionVertex 的输出。</p>
</li>
<li>
<p><strong>EdgeManager:</strong> EdgeManager 主要负责存储 ExecutionGraph 中所有之间的连接，包括其并行度。</p>
</li>
<li>
<p><strong>Execution:</strong> Execution 可以认为是一次实际的运行尝试。每次执行时，Flink 都会将ExecutionVertex 封装成一个 Execution，并通过一个 ExecutionAttemptID 来做唯一标识。</p>
</li>
</ul>
<h3 data-id="heading-1">ExecutionGraph 生成过程</h3>
<p>了解了这些基本概念之后，我们一起来看一下 ExecutionGraph 的具体生成过程。生成 ExecutionGraph 的代码入口是 DefaultExecutionGraphBuilder.build 方法。</p>
<p>首先是获取一些基本信息，包括 jobInformation、jobStatusChangedListeners 等。</p>
<p>接下来就是创建一个 DefaultExecutionGraph 和生成执行计划。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// create a new execution graph, if none exists so far</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">DefaultExecutionGraph</span> <span class="hljs-variable">executionGraph</span> <span class="hljs-operator">=</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultExecutionGraph</span>(
                jobInformation,
                futureExecutor,
                ioExecutor,
                rpcTimeout,
                executionHistorySizeLimit,
                classLoader,
                blobWriter,
                partitionGroupReleaseStrategyFactory,
                shuffleMaster,
                partitionTracker,
                executionDeploymentListener,
                executionStateUpdateListener,
                initializationTimestamp,
                vertexAttemptNumberStore,
                vertexParallelismStore,
                isDynamicGraph,
                executionJobVertexFactory,
                jobGraph.getJobStatusHooks(),
                markPartitionFinishedStrategy,
                taskDeploymentDescriptorFactory,
                jobStatusChangedListeners,
                executionPlanSchedulingContext);


<span class="hljs-keyword">try</span> {
    executionGraph.setPlan(JsonPlanGenerator.generatePlan(jobGraph));
} <span class="hljs-keyword">catch</span> (Throwable t) {
    log.warn(<span class="hljs-string">"Cannot create plan for job"</span>, t);
    <span class="hljs-comment">// give the graph an empty plan</span>
    executionGraph.setPlan(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JobPlanInfo</span>.Plan(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;()));
}
</code></pre>
<p>下面就是两个比较核心的方法 getVerticesSortedTopologicallyFromSources 和 attachJobGraph。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// topologically sort the job vertices and attach the graph to the existing one</span>
List&lt;JobVertex&gt; sortedTopology = jobGraph.getVerticesSortedTopologicallyFromSources();

executionGraph.attachJobGraph(sortedTopology, jobManagerJobMetricGroup);
</code></pre>
<p>这两个方法是先将 JobVertex 进行排序，然后构建 ExecutionGraph 的拓扑图。</p>
<h4 data-id="heading-2">getVerticesSortedTopologicallyFromSources</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;JobVertex&gt; <span class="hljs-title function_">getVerticesSortedTopologicallyFromSources</span><span class="hljs-params">()</span>
        <span class="hljs-keyword">throws</span> InvalidProgramException {
    <span class="hljs-comment">// early out on empty lists</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.taskVertices.isEmpty()) {
        <span class="hljs-keyword">return</span> Collections.emptyList();
    }

    List&lt;JobVertex&gt; sorted = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;JobVertex&gt;(<span class="hljs-built_in">this</span>.taskVertices.size());
    Set&lt;JobVertex&gt; remaining = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;JobVertex&gt;(<span class="hljs-built_in">this</span>.taskVertices.values());

    <span class="hljs-comment">// start by finding the vertices with no input edges</span>
    <span class="hljs-comment">// and the ones with disconnected inputs (that refer to some standalone data set)</span>
    {
        Iterator&lt;JobVertex&gt; iter = remaining.iterator();
        <span class="hljs-keyword">while</span> (iter.hasNext()) {
            <span class="hljs-type">JobVertex</span> <span class="hljs-variable">vertex</span> <span class="hljs-operator">=</span> iter.next();

            <span class="hljs-keyword">if</span> (vertex.isInputVertex()) {
                sorted.add(vertex);
                iter.remove();
            }
        }
    }

    <span class="hljs-type">int</span> <span class="hljs-variable">startNodePos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-comment">// traverse from the nodes that were added until we found all elements</span>
    <span class="hljs-keyword">while</span> (!remaining.isEmpty()) {

        <span class="hljs-comment">// first check if we have more candidates to start traversing from. if not, then the</span>
        <span class="hljs-comment">// graph is cyclic, which is not permitted</span>
        <span class="hljs-keyword">if</span> (startNodePos &gt;= sorted.size()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidProgramException</span>(<span class="hljs-string">"The job graph is cyclic."</span>);
        }

        <span class="hljs-type">JobVertex</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> sorted.get(startNodePos++);
        addNodesThatHaveNoNewPredecessors(current, sorted, remaining);
    }

    <span class="hljs-keyword">return</span> sorted;
}
</code></pre>
<p>这段代码是将所有的节点进行排序，先将所有的 Source 节点筛选出来，然后再将剩余节点假如列表。这样就能构建出最终的拓扑图。</p>
<h4 data-id="heading-3">attachJobGraph</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachJobGraph</span><span class="hljs-params">(
        List&lt;JobVertex&gt; verticesToAttach, JobManagerJobMetricGroup jobManagerJobMetricGroup)</span>
        <span class="hljs-keyword">throws</span> JobException {

    assertRunningInJobMasterMainThread();

    LOG.debug(
            <span class="hljs-string">"Attaching {} topologically sorted vertices to existing job graph with {} "</span>
                    + <span class="hljs-string">"vertices and {} intermediate results."</span>,
            verticesToAttach.size(),
            tasks.size(),
            intermediateResults.size());

    attachJobVertices(verticesToAttach, jobManagerJobMetricGroup);
    <span class="hljs-keyword">if</span> (!isDynamic) {
        initializeJobVertices(verticesToAttach);
    }

    <span class="hljs-comment">// the topology assigning should happen before notifying new vertices to failoverStrategy</span>
    executionTopology = DefaultExecutionTopology.fromExecutionGraph(<span class="hljs-built_in">this</span>);

    partitionGroupReleaseStrategy =
            partitionGroupReleaseStrategyFactory.createInstance(getSchedulingTopology());
}
</code></pre>
<p>attachJobGraph 方法主要包含两步逻辑，第一步是调用 attachJobVertices 方法创建 ExecutionJobVertex 实例，第二步是调用 fromExecutionGraph 创建一些其他的核心对象。</p>
<p><strong>attachJobVertices</strong></p>
<p>attachJobVertices 方法中就是遍历所有的 JobVertex，然后利用 JobVertex 生成 ExecutionJobVertex。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** Attach job vertices without initializing them. */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachJobVertices</span><span class="hljs-params">(
        List&lt;JobVertex&gt; topologicallySorted, JobManagerJobMetricGroup jobManagerJobMetricGroup)</span>
        <span class="hljs-keyword">throws</span> JobException {
    <span class="hljs-keyword">for</span> (JobVertex jobVertex : topologicallySorted) {

        <span class="hljs-keyword">if</span> (jobVertex.isInputVertex() &amp;&amp; !jobVertex.isStoppable()) {
            <span class="hljs-built_in">this</span>.isStoppable = <span class="hljs-literal">false</span>;
        }

        <span class="hljs-type">VertexParallelismInformation</span> <span class="hljs-variable">parallelismInfo</span> <span class="hljs-operator">=</span>
                parallelismStore.getParallelismInfo(jobVertex.getID());

        <span class="hljs-comment">// create the execution job vertex and attach it to the graph</span>
        <span class="hljs-type">ExecutionJobVertex</span> <span class="hljs-variable">ejv</span> <span class="hljs-operator">=</span>
                executionJobVertexFactory.createExecutionJobVertex(
                        <span class="hljs-built_in">this</span>,
                        jobVertex,
                        parallelismInfo,
                        coordinatorStore,
                        jobManagerJobMetricGroup);

        <span class="hljs-type">ExecutionJobVertex</span> <span class="hljs-variable">previousTask</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tasks.putIfAbsent(jobVertex.getID(), ejv);
        <span class="hljs-keyword">if</span> (previousTask != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobException</span>(
                    String.format(
                            <span class="hljs-string">"Encountered two job vertices with ID %s : previous=[%s] / new=[%s]"</span>,
                            jobVertex.getID(), ejv, previousTask));
        }

        <span class="hljs-built_in">this</span>.verticesInCreationOrder.add(ejv);
        <span class="hljs-built_in">this</span>.numJobVerticesTotal++;
    }
}
</code></pre>
<p><strong>initializeJobVertices</strong></p>
<p>在 DefaultExecutionGraph.initializeJobVertices 中是遍历了刚刚排好序的 JobVertex，获取了 ExecutionJobVertex 之后调用了 ExecutionGraph.initializeJobVertex 方法。</p>
<p>我们直接来看 ExecutionGraph.initializeJobVertex 的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeJobVertex</span><span class="hljs-params">(ExecutionJobVertex ejv, <span class="hljs-type">long</span> createTimestamp)</span>
        <span class="hljs-keyword">throws</span> JobException {
    initializeJobVertex(
            ejv,
            createTimestamp,
            VertexInputInfoComputationUtils.computeVertexInputInfos(
                    ejv, getAllIntermediateResults()::get));
}
</code></pre>
<p>这里先是调用了 VertexInputInfoComputationUtils.computeVertexInputInfos 方法，生成了 Map&lt;IntermediateDataSetID, JobVertexInputInfo&gt; jobVertexInputInfos。它表示的是每个 ExecutionVertex 消费上游 IntermediateResultPartition 的范围。</p>
<p>这里有两种模式，分别是 POINTWISE （点对点）和 ALL_TO_ALL（全对全）</p>
<p>在 POINTWISE 模式中，会按照尽量均匀分布的方式处理。</p>
<ul>
<li>
<p>例如上游并发度是4，下游并发度是2时，那么前两个 IntermediateResultPartition 就会被第一个 ExecutionVertex 消费，后两个 IntermediateResultPartition 就会被第二个 ExecutionVertex 消费。</p>
</li>
<li>
<p>如果上游并发度是2，下游是3时，那么下游前两个 IntermediateResultPartition 会被第一个 ExecutionVertex 消费，第三个 IntermediateResultPartition 则会被第二个 ExecutionVertex 消费。</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JobVertexInputInfo <span class="hljs-title function_">computeVertexInputInfoForPointwise</span><span class="hljs-params">(
        <span class="hljs-type">int</span> sourceCount,
        <span class="hljs-type">int</span> targetCount,
        Function&lt;Integer, Integer&gt; numOfSubpartitionsRetriever,
        <span class="hljs-type">boolean</span> isDynamicGraph)</span> {

    <span class="hljs-keyword">final</span> List&lt;ExecutionVertexInputInfo&gt; executionVertexInputInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">if</span> (sourceCount &gt;= targetCount) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; index &lt; targetCount; index++) {

            <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> index * sourceCount / targetCount;
            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> (index + <span class="hljs-number">1</span>) * sourceCount / targetCount;

            <span class="hljs-type">IndexRange</span> <span class="hljs-variable">partitionRange</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRange</span>(start, end - <span class="hljs-number">1</span>);
            <span class="hljs-type">IndexRange</span> <span class="hljs-variable">subpartitionRange</span> <span class="hljs-operator">=</span>
                    computeConsumedSubpartitionRange(
                            index,
                            <span class="hljs-number">1</span>,
                            () -&gt; numOfSubpartitionsRetriever.apply(start),
                            isDynamicGraph,
                            <span class="hljs-literal">false</span>,
                            <span class="hljs-literal">false</span>);
            executionVertexInputInfos.add(
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutionVertexInputInfo</span>(index, partitionRange, subpartitionRange));
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">partitionNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; partitionNum &lt; sourceCount; partitionNum++) {

            <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> (partitionNum * targetCount + sourceCount - <span class="hljs-number">1</span>) / sourceCount;
            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> ((partitionNum + <span class="hljs-number">1</span>) * targetCount + sourceCount - <span class="hljs-number">1</span>) / sourceCount;
            <span class="hljs-type">int</span> <span class="hljs-variable">numConsumers</span> <span class="hljs-operator">=</span> end - start;

            <span class="hljs-type">IndexRange</span> <span class="hljs-variable">partitionRange</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRange</span>(partitionNum, partitionNum);
            <span class="hljs-comment">// Variable used in lambda expression should be final or effectively final</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">finalPartitionNum</span> <span class="hljs-operator">=</span> partitionNum;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt; end; i++) {
                <span class="hljs-type">IndexRange</span> <span class="hljs-variable">subpartitionRange</span> <span class="hljs-operator">=</span>
                        computeConsumedSubpartitionRange(
                                i,
                                numConsumers,
                                () -&gt; numOfSubpartitionsRetriever.apply(finalPartitionNum),
                                isDynamicGraph,
                                <span class="hljs-literal">false</span>,
                                <span class="hljs-literal">false</span>);
                executionVertexInputInfos.add(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutionVertexInputInfo</span>(i, partitionRange, subpartitionRange));
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobVertexInputInfo</span>(executionVertexInputInfos);
}
</code></pre>
<p>在 ALL_TO_ALL 模式中，每个下游都会消费所有上游的数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JobVertexInputInfo <span class="hljs-title function_">computeVertexInputInfoForAllToAll</span><span class="hljs-params">(
        <span class="hljs-type">int</span> sourceCount,
        <span class="hljs-type">int</span> targetCount,
        Function&lt;Integer, Integer&gt; numOfSubpartitionsRetriever,
        <span class="hljs-type">boolean</span> isDynamicGraph,
        <span class="hljs-type">boolean</span> isBroadcast,
        <span class="hljs-type">boolean</span> isSingleSubpartitionContainsAllData)</span> {
    <span class="hljs-keyword">final</span> List&lt;ExecutionVertexInputInfo&gt; executionVertexInputInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">IndexRange</span> <span class="hljs-variable">partitionRange</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRange</span>(<span class="hljs-number">0</span>, sourceCount - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; targetCount; ++i) {
        <span class="hljs-type">IndexRange</span> <span class="hljs-variable">subpartitionRange</span> <span class="hljs-operator">=</span>
                computeConsumedSubpartitionRange(
                        i,
                        targetCount,
                        () -&gt; numOfSubpartitionsRetriever.apply(<span class="hljs-number">0</span>),
                        isDynamicGraph,
                        isBroadcast,
                        isSingleSubpartitionContainsAllData);
        executionVertexInputInfos.add(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutionVertexInputInfo</span>(i, partitionRange, subpartitionRange));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobVertexInputInfo</span>(executionVertexInputInfos);
}
</code></pre>
<p>生成好了 jobVertexInputInfos 之后，我们再回到 DefaultExecutionGraph.initializeJobVertex 方法中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeJobVertex</span><span class="hljs-params">(
        ExecutionJobVertex ejv,
        <span class="hljs-type">long</span> createTimestamp,
        Map&lt;IntermediateDataSetID, JobVertexInputInfo&gt; jobVertexInputInfos)</span>
        <span class="hljs-keyword">throws</span> JobException {

    checkNotNull(ejv);
    checkNotNull(jobVertexInputInfos);

    jobVertexInputInfos.forEach(
            (resultId, info) -&gt;
                    <span class="hljs-built_in">this</span>.vertexInputInfoStore.put(ejv.getJobVertexId(), resultId, info));

    ejv.initialize(
            executionHistorySizeLimit,
            rpcTimeout,
            createTimestamp,
            <span class="hljs-built_in">this</span>.initialAttemptCounts.getAttemptCounts(ejv.getJobVertexId()),
            executionPlanSchedulingContext);

    ejv.connectToPredecessors(<span class="hljs-built_in">this</span>.intermediateResults);

    <span class="hljs-keyword">for</span> (IntermediateResult res : ejv.getProducedDataSets()) {
        <span class="hljs-type">IntermediateResult</span> <span class="hljs-variable">previousDataSet</span> <span class="hljs-operator">=</span>
                <span class="hljs-built_in">this</span>.intermediateResults.putIfAbsent(res.getId(), res);
        <span class="hljs-keyword">if</span> (previousDataSet != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobException</span>(
                    String.format(
                            <span class="hljs-string">"Encountered two intermediate data set with ID %s : previous=[%s] / new=[%s]"</span>,
                            res.getId(), res, previousDataSet));
        }
    }

    registerExecutionVerticesAndResultPartitionsFor(ejv);

    <span class="hljs-comment">// enrich network memory.</span>
    <span class="hljs-type">SlotSharingGroup</span> <span class="hljs-variable">slotSharingGroup</span> <span class="hljs-operator">=</span> ejv.getSlotSharingGroup();
    <span class="hljs-keyword">if</span> (areJobVerticesAllInitialized(slotSharingGroup)) {
        SsgNetworkMemoryCalculationUtils.enrichNetworkMemory(
                slotSharingGroup, <span class="hljs-built_in">this</span>::getJobVertex, shuffleMaster);
    }
}
</code></pre>
<p>首先来看 ExecutionJobVertex.initialize 方法。这个方法主要是生成 IntermediateResult 和 ExecutionVertex。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">(
        <span class="hljs-type">int</span> executionHistorySizeLimit,
        Duration timeout,
        <span class="hljs-type">long</span> createTimestamp,
        SubtaskAttemptNumberStore initialAttemptCounts,
        ExecutionPlanSchedulingContext executionPlanSchedulingContext)</span>
        <span class="hljs-keyword">throws</span> JobException {

    checkState(parallelismInfo.getParallelism() &gt; <span class="hljs-number">0</span>);
    checkState(!isInitialized());

    <span class="hljs-built_in">this</span>.taskVertices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutionVertex</span>[parallelismInfo.getParallelism()];

    <span class="hljs-built_in">this</span>.inputs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(jobVertex.getInputs().size());

    <span class="hljs-comment">// create the intermediate results</span>
    <span class="hljs-built_in">this</span>.producedDataSets =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntermediateResult</span>[jobVertex.getNumberOfProducedIntermediateDataSets()];

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; jobVertex.getProducedDataSets().size(); i++) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">IntermediateDataSet</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jobVertex.getProducedDataSets().get(i);

        <span class="hljs-built_in">this</span>.producedDataSets[i] =
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntermediateResult</span>(
                        result,
                        <span class="hljs-built_in">this</span>,
                        <span class="hljs-built_in">this</span>.parallelismInfo.getParallelism(),
                        result.getResultType(),
                        executionPlanSchedulingContext);
    }

    <span class="hljs-comment">// create all task vertices</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.parallelismInfo.getParallelism(); i++) {
        <span class="hljs-type">ExecutionVertex</span> <span class="hljs-variable">vertex</span> <span class="hljs-operator">=</span>
                createExecutionVertex(
                        <span class="hljs-built_in">this</span>,
                        i,
                        producedDataSets,
                        timeout,
                        createTimestamp,
                        executionHistorySizeLimit,
                        initialAttemptCounts.getAttemptCount(i));

        <span class="hljs-built_in">this</span>.taskVertices[i] = vertex;
    }

    <span class="hljs-comment">// sanity check for the double referencing between intermediate result partitions and</span>
    <span class="hljs-comment">// execution vertices</span>
    <span class="hljs-keyword">for</span> (IntermediateResult ir : <span class="hljs-built_in">this</span>.producedDataSets) {
        <span class="hljs-keyword">if</span> (ir.getNumberOfAssignedPartitions() != <span class="hljs-built_in">this</span>.parallelismInfo.getParallelism()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"The intermediate result's partitions were not correctly assigned."</span>);
        }
    }

    <span class="hljs-comment">// set up the input splits, if the vertex has any</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
        InputSplitSource&lt;InputSplit&gt; splitSource =
                (InputSplitSource&lt;InputSplit&gt;) jobVertex.getInputSplitSource();

        <span class="hljs-keyword">if</span> (splitSource != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">currentThread</span> <span class="hljs-operator">=</span> Thread.currentThread();
            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">oldContextClassLoader</span> <span class="hljs-operator">=</span> currentThread.getContextClassLoader();
            currentThread.setContextClassLoader(graph.getUserClassLoader());
            <span class="hljs-keyword">try</span> {
                inputSplits =
                        splitSource.createInputSplits(<span class="hljs-built_in">this</span>.parallelismInfo.getParallelism());

                <span class="hljs-keyword">if</span> (inputSplits != <span class="hljs-literal">null</span>) {
                    splitAssigner = splitSource.getInputSplitAssigner(inputSplits);
                }
            } <span class="hljs-keyword">finally</span> {
                currentThread.setContextClassLoader(oldContextClassLoader);
            }
        } <span class="hljs-keyword">else</span> {
            inputSplits = <span class="hljs-literal">null</span>;
        }
    } <span class="hljs-keyword">catch</span> (Throwable t) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JobException</span>(
                <span class="hljs-string">"Creating the input splits caused an error: "</span> + t.getMessage(), t);
    }
}
</code></pre>
<p>在创建 ExecutionVertex 时，会创建 IntermediateResultPartition 和 Execution，创建 Execution 时，会设置 attemptNumber，这个值默认是0，如果 ExecutionVertex 是重新调度的，那么 attemptNumber 会自增加1。</p>
<p>ExecutionJobVertex.connectToPredecessors 方法主要是生成 ExecutionVertex 与 IntermediateResultPartition 的关联关系。这里设置关联关系也分成了点对点和全对全两种模式处理，点对点模式需要计算 ExecutionVertex 对应的 IntermediateResultPartition index 的范围。两种模式最终都调用了 connectInternal 方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/** Connect all execution vertices to all partitions. */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connectInternal</span><span class="hljs-params">(
        List&lt;ExecutionVertex&gt; taskVertices,
        List&lt;IntermediateResultPartition&gt; partitions,
        ResultPartitionType resultPartitionType,
        EdgeManager edgeManager)</span> {
    checkState(!taskVertices.isEmpty());
    checkState(!partitions.isEmpty());

    <span class="hljs-type">ConsumedPartitionGroup</span> <span class="hljs-variable">consumedPartitionGroup</span> <span class="hljs-operator">=</span>
            createAndRegisterConsumedPartitionGroupToEdgeManager(
                    taskVertices.size(), partitions, resultPartitionType, edgeManager);
    <span class="hljs-keyword">for</span> (ExecutionVertex ev : taskVertices) {
        ev.addConsumedPartitionGroup(consumedPartitionGroup);
    }

    List&lt;ExecutionVertexID&gt; consumerVertices =
            taskVertices.stream().map(ExecutionVertex::getID).collect(Collectors.toList());
    <span class="hljs-type">ConsumerVertexGroup</span> <span class="hljs-variable">consumerVertexGroup</span> <span class="hljs-operator">=</span>
            ConsumerVertexGroup.fromMultipleVertices(consumerVertices, resultPartitionType);
    <span class="hljs-keyword">for</span> (IntermediateResultPartition partition : partitions) {
        partition.addConsumers(consumerVertexGroup);
    }

    consumedPartitionGroup.setConsumerVertexGroup(consumerVertexGroup);
    consumerVertexGroup.setConsumedPartitionGroup(consumedPartitionGroup);
}
</code></pre>
<p>这个方法中 ev.addConsumedPartitionGroup(consumedPartitionGroup); 负责将 ExecutionVertex 到 IntermediateResultPartition 的关联关系保存在 EdgeManager.vertexConsumedPartitions 中。</p>
<p>而 partition.addConsumers(consumerVertexGroup); 则负责将 IntermediateResultPartition 到 ExecutionVertex 的关系保存在 EdgeManager.partitionConsumers 中。</p>
<h3 data-id="heading-4">总结</h3>
<p>通过本文，我们了解了 Flink 是如何将 JobGraph 转换成 ExecutionGraph 的。其中涉及到的一些核心概念名称比较类似，建议认真学习和理解透彻之后再研究其生成方法和对应关系，也可以借助前文中 ExecutionGraph 示意图辅助学习。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Antrl4 入门 —— 使用Antrl4实现一个表达式计算器]]></title>    <link>https://juejin.cn/post/7585476892976447522</link>    <guid>https://juejin.cn/post/7585476892976447522</guid>    <pubDate>2025-12-20T14:21:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585476892976447522" data-draft-id="7581210455827857444" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Antrl4 入门 —— 使用Antrl4实现一个表达式计算器"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-20T14:21:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="灵魂猎手"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289643895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Antrl4 入门 —— 使用Antrl4实现一个表达式计算器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289643895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    灵魂猎手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T14:21:21.000Z" title="Sat Dec 20 2025 14:21:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>在编译原理中，“解析”是将文本转化为计算机可理解结构的核心步骤，主要分为两步：词法分析和语法分析。我们用最常见的四则运算“(12+3)<em>4-5</em>”，就能直观理解这个过程。</p>
<p><strong>1. 词法分析：</strong>
就像我们读句子先拆出词语，词法分析会把输入文本拆成一个个“词法单元”（token），剔除空格、换行等无关内容。我们将例子替换为更贴近实际的带括号表达式“(12+3)<em>4-5”，最终会拆出 9 个 Token：<strong>左括号(</strong> 、<strong>数字1</strong> <strong>2</strong>、<strong>加号+</strong> 、<strong>数字</strong> <strong>3</strong>、<strong>右括号)</strong> 、<strong>乘号</strong></em> 、<strong>数字</strong> <strong>4</strong>、<strong>减号-</strong>、<strong>数字5</strong>，同时标记每个 Token 的类型（括号/数字/运算符）。</p>
<p><strong>2. 语法分析：</strong>
基于词法分析得到的 Token 序列，按照语言规则（四则运算优先级、括号优先级最高）构建结构化的“抽象语法树（AST）”。对“(12+3)*4-5”，语法分析会先识别出括号内的“12+3”是一个子表达式，再将其结果与“4”进行乘法运算，最后减去“5”，明确运算顺序为“((12+3)*4)-5”。对应的抽象语法树如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD  
A[减号] --&gt; B[乘号]  
A --&gt; C[5]  
B --&gt; D[加号]  
B --&gt; E[4]  
D --&gt; F[左括号]  
D --&gt; G[12]  
D --&gt; H[3]  
D --&gt; I[右括号]
</code></pre>
<p>如果我们手动实现词法分析器和语法分析器，细节较多，复杂度较高，而ANTLR4则可以帮我们解决这个问题 —— 它专门负责自动完成“词法分析”和“语法分析”环节。</p>
<p>简单说，你只需用ANTLR4定义好目标语言的语法规则（比如四则运算的数字、运算符、优先级规则），它就能自动生成对应的词法分析器和语法分析器，还能直接输出AST，无需手动编写解析逻辑。并提供listener和vistor两种模式，遍历语法树，帮助你完成剩余流程。凭借强大的解析能力，ANTLR4 被广泛应用于各类开源框架中，比如：Spark SQL（解析 SQL 语句）、Hive（处理 HiveQL），是构建语言解析相关工具的主流选择。</p>
<h2 data-id="heading-1">二、定义词法&amp;语法规则规则</h2>
<p>在使用ANTLR4帮助我们解析表达式，需要先告诉ANTLR4表达式的规则，这个规则定义在ANTLR4中是一个语法文件，以.g4结尾。这个文件中，主要包含词法规则和语法规则，g4文件结构是这样的：</p>
<pre><code class="hljs language-ini" lang="ini">// 语法名称（需与文件名一致）
grammar 语法名称<span class="hljs-comment">;</span>

// 1. 词法规则（大写字母开头）
词法规则1 : 匹配模式<span class="hljs-comment">;</span>
词法规则2 : 匹配模式<span class="hljs-comment">;</span>

// 2. 语法规则（小写字母开头）
语法规则1 : 规则组合逻辑<span class="hljs-comment">;</span>
语法规则2 : 规则组合逻辑<span class="hljs-comment">;</span>
</code></pre>
<p><strong>注意:</strong> 语法名称必须与 <code>.g4</code> 文件名完全一致（如语法名为 <code>Calc</code>，则文件名为 <code>Calc.g4</code>）；词法规则与语法规则通过首字母大小写严格区分，不可混淆。</p>
<p><strong>PS:</strong> 也可以把词法分析和语法分析的文件分开，如果定义较为复杂的表达式规则（比如SQL解析），可以分开管理：</p>
<ol>
<li>词法文件：文件名格式为 <code>XXXLexer.g4</code>，开头需用 <code>lexer grammar XXXLexer;</code> 声明（区别于组合语法的 <code>grammar XXX;</code>），仅包含词法规则（大写开头）；</li>
<li>语法文件：文件名格式为 <code>XXXParser.g4</code>，开头需用 <code>parser grammar XXXParser;</code> 声明，通过 <code>import XXXLexer;</code> 导入对应的词法文件，仅包含语法规则（小写开头）；</li>
<li>命名关联：词法文件与语法文件的前缀需一致（如 <code>CalcLexer.g4</code> 对应 <code>CalcParser.g4</code>），确保导入时能正确关联。</li>
</ol>
<p><strong>PS:</strong> ANTLR的全称是ANother Tool for Language Recognition（另一种语言识别工具）。</p>
<h3 data-id="heading-2">2.1 词法规则</h3>
<p>词法规则的核心作用是定义“什么是合法的 Token”，对应我们上一章提到的“词法分析”环节。对于四则运算，需要识别的 Token 包括：左括号 <code>(</code>、右括号 <code>)</code>、运算符（<code>+</code>、<code>-</code>、<code>*</code>、<code>/</code>）、数字（整数，如 12、3）。它的基本组成为：</p>
<pre><code class="hljs language-ini" lang="ini">规则名 : 匹配模式 <span class="hljs-section">[-&gt; 动作]</span><span class="hljs-comment">; // 中括号表示动作可选</span>
</code></pre>
<ul>
<li><strong>规则名：</strong> 首字母必须大写，推荐采用“全大写+下划线分隔”的语义化命名，比如<code>INT</code>，禁止使用 ANTLR4 关键字（如 <code>grammar</code>、<code>mode</code>）；</li>
<li><strong>匹配模式:</strong> 匹配模式采用<strong>正则表达式的核心子集</strong>语法（并非完整标准正则），用于描述 Token 的文本格式，足以覆盖绝大多数词法分析场景，但需注意：标准正则中的部分复杂特性（如 \d、\w、反向引用、零宽断言等）不被支持。</li>
<li><strong>可选动作配置:</strong> 动作通过 <code>-&gt;</code> 引导，用于对匹配到的Token执行特定操作，入门常用的只有是 <code>skip</code>（跳过无关内容）。比如<code>[ \t\r\n]+ -&gt; skip;</code>，即忽略空格、换行、制表符。其他在入门中不做介绍。</li>
<li><strong>优先级规则</strong>：规则定义顺序即匹配优先级——先定义的规则优先级更高，优先匹配（如关键字需优先于标识符定义，否则会被误识别）。</li>
</ul>
<p>以四则运算+简单函数为例：</p>
<pre><code class="hljs language-antlr4" lang="antlr4">// 1. 函数名规则：关键字优先，匹配max/min（不区分大小写可改为 [Mm][Aa][Xx]，此处统一大写）
MAX : 'MAX';  // 匹配MAX函数名
MIN : 'MIN';  // 匹配MIN函数名

// 2. 括号与分隔符规则
LEFT_PAREN  : '(';  // 匹配左括号 (
RIGHT_PAREN : ')';  // 匹配右括号 )
COMMA       : ',';  // 匹配参数分隔符 ,

// 3. 运算符规则：单个字符，直接匹配
ADD : '+';  // 加号
SUB : '-';  // 减号
MUL : '*';  // 乘号
DIV : '/';  // 除号

// 4. 整数规则：使用 [0-9]+ 匹配1位及以上数字
INT : [0-9]+;  // 可匹配 1、12、345 等整数，贪婪匹配特性保证完整匹配

// 5. 跳过无关内容：空格、制表符（\t）、回车（\r）、换行（\n）
WS  : [ \t\r\n]+ -&gt; skip;  // 多个空白字符连续出现时，一次性跳过
</code></pre>
<p><strong>PS:</strong> 如果所有规则，都不区分大小写，可以配置一个全局规则</p>
<pre><code class="hljs language-antlr4" lang="antlr4">options {
    caseInsensitive = true;
}
</code></pre>
<h3 data-id="heading-3">2.2 语法规则</h3>
<p>语法规则的核心作用是定义“Token 如何组合才合法”，语法规则基础格式为：</p>
<pre><code class="hljs language-ini" lang="ini">规则名 : 规则体分支1 | 规则体分支2 ... <span class="hljs-section">[# 可选标签]</span><span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><strong>规则名：</strong> 小写字母开头（如 <code>expr</code>、<code>term</code>），建议使用“全小写+下划线”的方式命名；</li>
<li><strong>规则体：</strong> 词法名字组合 + 正则的分组（也就是括号）&amp; 匹配次数（如 <code>*</code>、<code>?</code>）,多个分支用 <code>|</code> 分隔；</li>
<li><strong>可选标签：</strong> 用 <code>#</code> 开头，用于区分同一规则的不同分支（便于后续遍历 AST ），</li>
<li><strong>规则优先级：</strong> 可以有多个规则，互相引用，被引用的优先级更高。</li>
</ul>
<p>好，接下来我们开始定义四则运算的加减法：</p>
<pre><code class="hljs language-sql" lang="sql">expr : <span class="hljs-type">INT</span> (<span class="hljs-keyword">ADD</span> <span class="hljs-operator">|</span> SUB) <span class="hljs-type">INT</span>
</code></pre>
<p>等等，这里有个问题，这只能识别两个整数的加减法，那三个呢、四个呢？！好像可以这样定义：</p>
<pre><code class="hljs language-sql" lang="sql">expr : <span class="hljs-type">INT</span> ((<span class="hljs-keyword">ADD</span> <span class="hljs-operator">|</span> SUB) <span class="hljs-type">INT</span>)<span class="hljs-operator">*</span>
</code></pre>
<p>还是哪里不对，如果加法左右不止是整数呢，比如 <code>MAX(1,2)+3</code>，再比如<code>1+2*3</code>。这里必须引入递归，也就是说，需要自己定义自己。</p>
<p>比如这样：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">expr</span> : INT
     | <span class="hljs-built_in">expr</span> (ADD | SUB) <span class="hljs-built_in">expr</span>
</code></pre>
<p>那怎么定义优先级呢，比如括号优先级最高比乘除法高，乘除法比加减法高 —— 同一个语法规则下，书写顺序就是优先级，也就是前面的优先级高。</p>
<p>那么带有函数的完整的语法定义就是：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">expr</span> : (MAX | MIN) LEFT_PAREN <span class="hljs-built_in">expr</span> (COMMA <span class="hljs-built_in">expr</span>)* LEFT_PAREN <span class="hljs-comment"># FuncCallExpr</span>
     | INT <span class="hljs-comment"># IntExpr </span>
     | LEFT_PAREN <span class="hljs-built_in">expr</span> RIGHT_PAREN <span class="hljs-comment"># ParenExpr</span>
     | <span class="hljs-built_in">expr</span> (MUL | DIV) <span class="hljs-built_in">expr</span> <span class="hljs-comment"># MulDivExpr</span>
     | <span class="hljs-built_in">expr</span> (ADD | SUB) <span class="hljs-built_in">expr</span> <span class="hljs-comment"># AddSubExpr</span>
     ;
</code></pre>
<h3 data-id="heading-4">2.3 完整配置文件</h3>
<p>把词法和语法文件合并到一起，就得到了完整的配置文件：</p>
<pre><code class="hljs language-css" lang="css">grammar Calc;

// 词法规则（新增函数名、逗号）
MAX         : <span class="hljs-string">'MAX'</span>;  // MAX函数名
MIN         : <span class="hljs-string">'MIN'</span>;  // MIN函数名
LEFT_PAREN  : <span class="hljs-string">'('</span>;
RIGHT_PAREN : <span class="hljs-string">')'</span>;
COMMA       : <span class="hljs-string">','</span>;  // 参数分隔符
ADD         : <span class="hljs-string">'+'</span>;
SUB         : <span class="hljs-string">'-'</span>;
MUL         : <span class="hljs-string">'*'</span>;
<span class="hljs-selector-tag">DIV</span>         : <span class="hljs-string">'/'</span>;
INT         : [<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]+;
WS          : [ \t\r\n]+ -&gt; skip;

expr : (MAX | MIN) LEFT_PAREN expr (COMMA expr)* RIGHT_PAREN # FuncCallExpr
     | INT # IntExpr 
     | LEFT_PAREN expr RIGHT_PAREN # ParenExpr
     | expr (MUL | DIV) expr # MulDivExpr
     | expr (ADD | SUB) expr # AddSubExpr
     ;
</code></pre>
<h2 data-id="heading-5">三、测试 &amp; 生成代码</h2>
<h3 data-id="heading-6">3.1 测试</h3>
<p>有了配置文件，我们可以通过idea的插件验证。在idea的插件市场，搜索antrl4，安装即可。安装完成后，选中语法，右键Test Rule。输入表达式，就可以看到，转为了抽象语法树：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac4acb926e834b5489c2000306dfd948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16a2C54yO5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845548&amp;x-signature=hoh75pkz3qIMeNdrZxi7%2FM6VNvQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">3.2 代码生成</h3>
<p>测试没有问题后，我们就可以生成代码了。</p>
<ol>
<li><strong>配置代码生成的位置：</strong> 选择g4文件，右键Configuration ANTLR。
<ul>
<li>“Output directory where all output is generated” --&gt; java目录</li>
<li>“Package/namespace for the generated code” --&gt; 包名</li>
</ul>
</li>
<li><strong>代码生成：</strong> 点击g4文件，右键Generate ANTLR Recognition生成即可。</li>
</ol>
<p>这样代码就愉快的生成了：</p>
<ul>
<li><code>{GrammarName}Lexer.java</code> --&gt; 词法解析器；</li>
<li><code>{GrammarName}Parser.java</code> --&gt; 语法解析器；</li>
<li>监听器：提供被动监听的方式遍历语法树方法，当遍历器进入（<code>enter</code>）或退出（<code>exit</code>）树的某个节点时，自动调用监听器中对应的方法（如 <code>enterIntExpr</code>、<code>exitIntExpr</code>）。
<ul>
<li>接口：<code>{GrammarName}Listener.java</code></li>
<li>默认实现：<code>{GrammarName}BaseListener.java</code></li>
</ul>
</li>
<li>访问者：提供主动遍历语法树的方法，我们需要显式调用 <code>visit(child)</code> 方法访问子节点，并可以返回结果。
<ul>
<li>接口：<code>{GrammarName}Visitor.java</code></li>
<li>默认实现：<code>{GrammarName}BaseVisitor.java</code></li>
</ul>
</li>
<li>其他文件：还有些<code>.tokens</code> 文件（记录词汇符号的映射关系）和 <code>.interp</code> 文件（用于调试），通常可以忽略。</li>
</ul>
<h3 data-id="heading-8">3.3 如何使用</h3>
<p>接下来，我们梳理下这些生成的代码该如何使用，这里有个基本范式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 构造字符流</span>
<span class="hljs-type">CharStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> CharStreams.fromString(<span class="hljs-string">"1+2*3"</span>);
<span class="hljs-comment">// 词法解析</span>
<span class="hljs-type">CalcLexer</span> <span class="hljs-variable">lexer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcLexer</span>(input);
<span class="hljs-type">CommonTokenStream</span> <span class="hljs-variable">tokens</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonTokenStream</span>(lexer);
<span class="hljs-comment">// 语法解析，生成语法树</span>
<span class="hljs-type">CalcParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcParser</span>(tokens);
<span class="hljs-type">ParseTree</span> <span class="hljs-variable">tree</span> <span class="hljs-operator">=</span> parser.expr();

<span class="hljs-comment">// 使用listener、visitor遍历语法树</span>
<span class="hljs-comment">// todo ...</span>
</code></pre>
<h4 data-id="heading-9">3.3.1 listener模式</h4>
<p>先看下生成的listener的继承关系</p>
<ul>
<li><code>ParseTreeListener</code>：ANTLR4 中用于监听语法树遍历事件的核心接口，定义了最基础的事件回调。注意，这个不是自动生成的。
<ul>
<li><code>CalcListener</code>：根据你的语法，生成的接口，在我们这个例子中，会自动生成类似<code>enter/exitInt</code>、<code>enter/exitMaxFunc</code>这样的方法。
<ul>
<li><code>CalcBaseListener</code>：<code>CalcListener</code>的基础实现类，典型的适配器模式，实现了<code>CalcListener</code>接口所有方法，但什么都没做。这样你写一个继承<code>CalcBaseListener</code>的方法时，就可以按需实现，而不是实现所有接口。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>ParseTreeListener</code>接口方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ParseTreeListener</span> { 
    <span class="hljs-comment">// 进入任意规则节点时触发 </span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">enterEveryRule</span><span class="hljs-params">(ParserRuleContext ctx)</span>; 
    <span class="hljs-comment">// 退出任意规则节点时触发 </span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitEveryRule</span><span class="hljs-params">(ParserRuleContext ctx)</span>; 
    <span class="hljs-comment">// 访问终端节点（叶子节点）时触发 </span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitTerminal</span><span class="hljs-params">(TerminalNode node)</span>; 
    <span class="hljs-comment">// 访问错误节点（语法错误节点）时触发 </span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitErrorNode</span><span class="hljs-params">(ErrorNode node)</span>; 
}
</code></pre>
<p>而<code>CalcListener</code>接口则是enter/exit我们自定义的语法规则的方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Enter a parse tree produced by the {<span class="hljs-doctag">@code</span> MulDivExpr}
 * labeled alternative in {<span class="hljs-doctag">@link</span> calcParser#expr}.
 * <span class="hljs-doctag">@param</span> ctx the parse tree
 */</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">enterMulDivExpr</span><span class="hljs-params">(calcParser.MulDivExprContext ctx)</span>;
<span class="hljs-comment">/**
 * Exit a parse tree produced by the {<span class="hljs-doctag">@code</span> MulDivExpr}
 * labeled alternative in {<span class="hljs-doctag">@link</span> calcParser#expr}.
 * <span class="hljs-doctag">@param</span> ctx the parse tree
 */</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">exitMulDivExpr</span><span class="hljs-params">(calcParser.MulDivExprContext ctx)</span>;

<span class="hljs-comment">// 省略了一些其他方法。。。</span>
</code></pre>
<p>这里咱们简单的在Listener中打印一下，看下遍历顺序：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraversalListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">calcBaseListener</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">indent</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 用于缩进显示层级</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enterEveryRule</span><span class="hljs-params">(ParserRuleContext ctx)</span> {
        printWithIndent(<span class="hljs-string">"进入节点: "</span> + ctx.getClass().getSimpleName());
        indent++;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitEveryRule</span><span class="hljs-params">(ParserRuleContext ctx)</span> {
        indent--;
        printWithIndent(<span class="hljs-string">"退出节点: "</span> + ctx.getClass().getSimpleName());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">visitTerminal</span><span class="hljs-params">(TerminalNode node)</span> {
        printWithIndent(<span class="hljs-string">"访问叶子节点: "</span> + node.getText());
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printWithIndent</span><span class="hljs-params">(String message)</span> {
        System.out.println(StringUtils.repeat(<span class="hljs-string">"-&gt;"</span>, indent) + message);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">expr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"1+2*3-5"</span>;
        System.out.println(<span class="hljs-string">"表达式: "</span> + expr + <span class="hljs-string">"\n遍历顺序:"</span>);

        <span class="hljs-comment">// 解析为抽象语法树</span>
        <span class="hljs-type">CharStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> CharStreams.fromString(expr);
        <span class="hljs-type">calcLexer</span> <span class="hljs-variable">lexer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">calcLexer</span>(input);
        <span class="hljs-type">CommonTokenStream</span> <span class="hljs-variable">tokens</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonTokenStream</span>(lexer);
        <span class="hljs-type">calcParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">calcParser</span>(tokens);
        <span class="hljs-type">ParseTree</span> <span class="hljs-variable">tree</span> <span class="hljs-operator">=</span> parser.expr();
        <span class="hljs-comment">// 遍历监听</span>
        ParseTreeWalker.DEFAULT.walk(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TraversalListener</span>(), tree);
    }
}
</code></pre>
<p><strong>输出</strong></p>
<pre><code class="hljs language-rust" lang="rust">进入节点: AddSubExprContext
<span class="hljs-punctuation">-&gt;</span>进入节点: AddSubExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>进入节点: IntExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>访问叶子节点: <span class="hljs-number">1</span>
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>退出节点: IntExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>访问叶子节点: +
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>进入节点: MulDivExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>进入节点: IntExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>访问叶子节点: <span class="hljs-number">2</span>
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>退出节点: IntExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>访问叶子节点: *
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>进入节点: IntExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>访问叶子节点: <span class="hljs-number">3</span>
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>退出节点: IntExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>退出节点: MulDivExprContext
<span class="hljs-punctuation">-&gt;</span>退出节点: AddSubExprContext
<span class="hljs-punctuation">-&gt;</span>访问叶子节点: -
<span class="hljs-punctuation">-&gt;</span>进入节点: IntExprContext
<span class="hljs-punctuation">-&gt;</span><span class="hljs-punctuation">-&gt;</span>访问叶子节点: <span class="hljs-number">5</span>
<span class="hljs-punctuation">-&gt;</span>退出节点: IntExprContext
退出节点: AddSubExprContext
</code></pre>
<p>对比抽象语法树，不难看出，按照进入节点的顺序，是根-&gt;左-&gt;右的方式，深度优先遍历；按照出节点的顺序，则是左-&gt;右-&gt;根的顺序。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dfdb56d23d241dcb91672828a4d2388~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16a2C54yO5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845548&amp;x-signature=9u84VGUzaemX82um9wEU1G8Ipw8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">3.3.2 visitor模式</h4>
<p>先看下visitor模式的继承关系：</p>
<ul>
<li><code>ParseTreeVisitor&lt;T&gt;</code>: 基础接口，类似<code>ParseTreeListener</code>定义了比如<code>visit</code>、<code>visitChildren</code>这种基础方法。
<ul>
<li><code>CalcVisitor&lt;T&gt;</code>:自动生成的接口，包含<code>visitXXX</code>这样我们自定义的语法的接口方法。</li>
<li><code>AbstractParseTreeVisitor&lt;T&gt;</code>抽象类，<code>ParseTreeVisitor</code>的最基本实现。
<ul>
<li><code>CalcBaseVisitor&lt;T&gt;</code>: 自动生成的继承自<code>AbstractParseTreeVisitor&lt;T&gt;</code>,实现了<code>CalcVisitor&lt;T&gt;</code>的抽象类，也是典型的适配器，内部的所有实现都是<code>return visitChildren(ctx);</code>。也就是继续向下遍历。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>介绍下最基础的<code>ParseTreeVisitor&lt;T&gt;</code></p>
<ul>
<li>泛型T，是每个访问方法，需要返回的类型。</li>
<li><code>visit(ParseTree tree)</code>：启动对整个语法树的遍历；</li>
<li><code>visitChildren(RuleNode node)</code>：遍历节点的子节点并返回汇总结果；</li>
<li><code>visitTerminal(TerminalNode node)</code>：访问终端节点（叶子节点）；</li>
<li><code>visitErrorNode(ErrorNode node)</code>：访问错误节点。</li>
</ul>
<p>他的基础实现类<code>AbstractParseTreeVisitor&lt;T&gt;</code>，典型的模板模式，主要实现了基础的<code>visit</code>和<code>visitChildren</code>方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> T <span class="hljs-title function_">visit</span><span class="hljs-params">(ParseTree tree)</span> {
    <span class="hljs-comment">//启动遍历</span>
    <span class="hljs-keyword">return</span> tree.accept(<span class="hljs-built_in">this</span>);
}

<span class="hljs-keyword">public</span> T <span class="hljs-title function_">visitChildren</span><span class="hljs-params">(RuleNode node)</span> {
    <span class="hljs-comment">//遍历所有的子节点</span>
    <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.defaultResult();<span class="hljs-comment">//默认返回null，供子类复写。</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> node.getChildCount();

    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n &amp;&amp; <span class="hljs-built_in">this</span>.shouldVisitNextChild(node, result); ++i) {
        <span class="hljs-type">ParseTree</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> node.getChild(i);
        <span class="hljs-type">T</span> <span class="hljs-variable">childResult</span> <span class="hljs-operator">=</span> c.accept(<span class="hljs-built_in">this</span>);
        result = <span class="hljs-built_in">this</span>.aggregateResult(result, childResult);<span class="hljs-comment">//如何合并两个子节点的值，默认返回后面的</span>
    }

    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-keyword">protected</span> T <span class="hljs-title function_">defaultResult</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">protected</span> T <span class="hljs-title function_">aggregateResult</span><span class="hljs-params">(T aggregate, T nextResult)</span> {
    <span class="hljs-keyword">return</span> nextResult;
}
</code></pre>
<p>上文也说过了，自动生成的<code>CalcBaseVisitor&lt;T&gt;</code>实现的所有方法，内部的所有实现都是<code>return visitChildren(ctx);</code>，也就是上面<code>AbstractParseTreeVisitor&lt;T&gt;</code>的方法。</p>
<p>咱们也简单实现一个visitor，就输入是什么，原样输出出来：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">visitTerminal</span><span class="hljs-params">(TerminalNode node)</span> {
    <span class="hljs-keyword">return</span> node.getText();
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> String <span class="hljs-title function_">aggregateResult</span><span class="hljs-params">(String aggregate, String nextResult)</span> {
    <span class="hljs-keyword">if</span>(aggregate == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> nextResult;
    <span class="hljs-keyword">if</span>(nextResult == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> aggregate;
    <span class="hljs-keyword">return</span> aggregate + nextResult;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">CharStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> CharStreams.fromString(<span class="hljs-string">"1+2+3+4"</span>);
    <span class="hljs-type">CalcLexer</span> <span class="hljs-variable">lexer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcLexer</span>(input);
    <span class="hljs-type">CommonTokenStream</span> <span class="hljs-variable">tokens</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonTokenStream</span>(lexer);
    <span class="hljs-type">CalcParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcParser</span>(tokens);
    <span class="hljs-type">String</span> <span class="hljs-variable">visit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TraversalVisitor</span>().visit(parser.expr());
    System.out.println(visit);
}
</code></pre>
<p>这里重写了<code>AbstractParseTreeVisitor&lt;T&gt;</code>的</p>
<ul>
<li><code>visitTerminal</code>:叶子节点返回节点的文本。</li>
<li><code>aggregateResult</code>:合并两个节点的值，把字符串拼接起来。</li>
</ul>
<p><strong>输出</strong></p>
<pre><code class="hljs">1+2+3+4
</code></pre>
<p>我们简单的实现加法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">visitAddSubExpr</span><span class="hljs-params">(CalcParser.AddSubExprContext ctx)</span> {

    <span class="hljs-keyword">if</span>(ctx.ADD() != <span class="hljs-literal">null</span>){
        <span class="hljs-comment">//递归获取左右两侧的值</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> visit(ctx.expr(<span class="hljs-number">0</span>));
        <span class="hljs-type">String</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> visit(ctx.expr(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">if</span>(NumberUtils.isDigits(left) &amp;&amp; NumberUtils.isDigits(right)){
            <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Integer.parseInt(right) + Integer.parseInt(left);
            <span class="hljs-keyword">return</span> Integer.toString(result);
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.visitAddSubExpr(ctx);
}
</code></pre>
<p>那么上面的<code>1+2+3+4</code>就会输出10。当然，一旦有其他运算，这里就不灵了，不过起码我们离计算器近了一步，下一章我们具体实现。</p>
<h2 data-id="heading-11">四、实战</h2>
<h3 data-id="heading-12">4.1 需求</h3>
<p>接下来我们开始实战，就搞一个极简的表达式计算器吧，需要实现以下功能：</p>
<ul>
<li>支持变量，变量名：首字符为字母或者下划线，后续字符可为字母、数字或者下划线，大小写敏感；</li>
<li>支持整数和小数；</li>
<li>支持四则运算以及括号；</li>
<li>支持函数，本次仅实现MAX/MIN，大小写不敏感。</li>
</ul>
<h3 data-id="heading-13">4.2 语法文件</h3>
<pre><code class="hljs language-ini" lang="ini">grammar Calc<span class="hljs-comment">;</span>

// 词法规则
MAX         : <span class="hljs-section">[Mm]</span><span class="hljs-section">[Aa]</span><span class="hljs-section">[Xx]</span><span class="hljs-comment">;  // MAX函数名</span>
MIN         : <span class="hljs-section">[Mm]</span><span class="hljs-section">[Ii]</span><span class="hljs-section">[Nn]</span><span class="hljs-comment">;  // MIN函数名</span>
LEFT_PAREN  : '('<span class="hljs-comment">;</span>
RIGHT_PAREN : ')'<span class="hljs-comment">;</span>
COMMA       : ','<span class="hljs-comment">;</span>
ADD         : '+'<span class="hljs-comment">;</span>
SUB         : '-'<span class="hljs-comment">;</span>
MUL         : '*'<span class="hljs-comment">;</span>
DIV         : '/'<span class="hljs-comment">;</span>
VAR         : <span class="hljs-section">[a-zA-Z_]</span><span class="hljs-section">[a-zA-Z0-9_]</span>*<span class="hljs-comment">;</span>
INT         : <span class="hljs-section">[0-9]</span>+<span class="hljs-comment">;</span>
FLOAT       : <span class="hljs-section">[0-9]</span>+<span class="hljs-comment">; // 带符号小数</span>
WS          : <span class="hljs-section">[ \t\r\n]</span>+ -&gt; skip<span class="hljs-comment">;</span>
// 语法规则
number : INT | FLOAT<span class="hljs-comment">;</span>
function : MAX LEFT_PAREN expr (COMMA expr)* RIGHT_PAREN <span class="hljs-comment"># maxFunc</span>
         | MIN LEFT_PAREN expr (COMMA expr)* RIGHT_PAREN <span class="hljs-comment"># minFunc</span>
         <span class="hljs-comment">;</span>
expr : function <span class="hljs-comment"># FuncCallExpr</span>
     | number <span class="hljs-comment"># numberExpr</span>
     | VAR <span class="hljs-comment"># varExpr</span>
     | LEFT_PAREN expr RIGHT_PAREN <span class="hljs-comment"># ParenExpr</span>
     | expr (MUL | DIV) expr <span class="hljs-comment"># MulDivExpr</span>
     | expr (ADD | SUB) expr <span class="hljs-comment"># AddSubExpr</span>
     | (ADD | SUB) expr <span class="hljs-comment"># UnaryMinusPlus</span>
     <span class="hljs-comment">;</span>
</code></pre>
<p>与之前的语法文件区别不大</p>
<ol>
<li>新增了变量词法，<code>VAR: [a-zA-Z_][a-zA-Z0-9_]*</code>，注意要放在函数名的后面，否则函数名字会被解析成变量名字。</li>
<li>新增小数，并在后面与整数一起合并为number。</li>
<li>function单拿出来作为一个语法，被expr引用，这种写法与之前区别不大，只是生成的代码中，会多一个<code>visitFuncCallExpr</code>(visitor模式)或者<code>enter/exitFuncCallExpr</code>(listener模式)的方法。</li>
<li>增加了<code> (ADD | SUB) expr</code>这样的语法，以支持正负数这样的写法。</li>
</ol>
<p>Q ：为什么不再INT/FLOAT上直接支持正负号呢？
A : 这接定义会和加减法冲突，目前我没想好解决方案，所以在后面加了一个<code> (ADD | SUB) expr</code>表达式。</p>
<h3 data-id="heading-14">4.3 使用Visitor实现</h3>
<p>上一章节，我们使用visitor实现了，仅能支持加法的计算器，这里我们把所有的语法都实现一遍，也就实现了计算器，注意这里的泛型改为<code>Double</code>了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CalcVisitorEvaluator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CalcBaseVisitor</span>&lt;Double&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Double&gt; variables;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CalcVisitorEvaluator</span><span class="hljs-params">(Map&lt;String, Double&gt; variables)</span> {
        <span class="hljs-built_in">this</span>.variables = variables;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitNumberExpr</span><span class="hljs-params">(CalcParser.NumberExprContext ctx)</span> {
        <span class="hljs-keyword">return</span> Double.parseDouble(ctx.number().getText());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitVarExpr</span><span class="hljs-params">(CalcParser.VarExprContext ctx)</span> {
        <span class="hljs-keyword">return</span> variables.getOrDefault(ctx.VAR().getText(), <span class="hljs-number">0.0</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitParenExpr</span><span class="hljs-params">(CalcParser.ParenExprContext ctx)</span> {
        <span class="hljs-keyword">return</span> visit(ctx.expr());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitMulDivExpr</span><span class="hljs-params">(CalcParser.MulDivExprContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> visit(ctx.expr(<span class="hljs-number">0</span>));
        <span class="hljs-type">double</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> visit(ctx.expr(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">if</span> (ctx.MUL() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> left * right;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> left / right;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitAddSubExpr</span><span class="hljs-params">(CalcParser.AddSubExprContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> visit(ctx.expr(<span class="hljs-number">0</span>));
        <span class="hljs-type">double</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> visit(ctx.expr(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">if</span> (ctx.ADD() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> left + right;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> left - right;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitUnaryMinusPlus</span><span class="hljs-params">(CalcParser.UnaryMinusPlusContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> visit(ctx.expr());
        <span class="hljs-keyword">return</span> ctx.SUB() != <span class="hljs-literal">null</span> ? -value : value;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitMaxFunc</span><span class="hljs-params">(CalcParser.MaxFuncContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> Double.NEGATIVE_INFINITY;
        <span class="hljs-keyword">for</span> (CalcParser.ExprContext expr : ctx.expr()) {
            max = Math.max(max, visit(expr));
        }
        <span class="hljs-keyword">return</span> max;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitMinFunc</span><span class="hljs-params">(CalcParser.MinFuncContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> Double.POSITIVE_INFINITY;
        <span class="hljs-keyword">for</span> (CalcParser.ExprContext expr : ctx.expr()) {
            min = Math.min(min, visit(expr));
        }
        <span class="hljs-keyword">return</span> min;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">visitFuncCallExpr</span><span class="hljs-params">(CalcParser.FuncCallExprContext ctx)</span> {
        <span class="hljs-keyword">return</span> visit(ctx.function());
    }
}
</code></pre>
<p>是不是看起来很简单，只不过是把所有的简单的语法都实现了一遍，复杂的词法语法分析，以及语法树的遍历，都不需要自行实现了。</p>
<p>下面我们验证一下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    Map&lt;String, Double&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    variables.put(<span class="hljs-string">"a"</span>, <span class="hljs-number">10.0</span>);
    variables.put(<span class="hljs-string">"b"</span>, <span class="hljs-number">6.0</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> <span class="hljs-string">"max(a + 5, min(b * 3, 20)) - 3"</span>;

    <span class="hljs-comment">// 使用Visitor模式计算</span>
    CalcParser.<span class="hljs-type">ExprContext</span> <span class="hljs-variable">exprContext</span> <span class="hljs-operator">=</span> parseTree(expression);
    <span class="hljs-type">CalcVisitorEvaluator</span> <span class="hljs-variable">visitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcVisitorEvaluator</span>(variables);
    <span class="hljs-type">double</span> <span class="hljs-variable">visitorResult</span> <span class="hljs-operator">=</span> visitor.visit(exprContext);
    System.out.println(<span class="hljs-string">"Visitor结果: "</span> + visitorResult);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CalcParser.ExprContext <span class="hljs-title function_">parseTree</span><span class="hljs-params">(String expression)</span> {
    <span class="hljs-type">CharStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> CharStreams.fromString(expression);
    <span class="hljs-type">CalcLexer</span> <span class="hljs-variable">lexer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcLexer</span>(input);
    <span class="hljs-type">CommonTokenStream</span> <span class="hljs-variable">tokens</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommonTokenStream</span>(lexer);
    <span class="hljs-type">CalcParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcParser</span>(tokens);
    <span class="hljs-keyword">return</span> parser.expr();
}
</code></pre>
<p><strong>输出</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Visitor结果: 15.0</span>
</code></pre>
<p>是不是很神奇，我们简单梳理下遍历操作，语法树如下，根节点是这个减法。回头看下代码，减法就是先遍历计算左子节点的值，再遍历计算右子节点，把他们减起来就可以了。其实就是一个左右根的递归遍历，沿着这个顺序，就会一直递归到左下的加法分支。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd43c3d244b340c2bad36923e370e107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16a2C54yO5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845548&amp;x-signature=WW3RTw9BAV9mRwW3tSuabM4Aueg%3D" alt="image.png" loading="lazy"/></p>
<p>左下的加法计算完成后，就变成了这样。再遍历max的右边的节点，又到了中间的乘法，再进行乘法计算：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/780be613bbcb43cfbd7d3751da94f7a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16a2C54yO5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845548&amp;x-signature=fy1Z0Nwcs4u8aujWGlAzO9rcau0%3D" alt="image.png" loading="lazy"/></p>
<p>嗯，我相信你已经看懂是如何计算的了，我就不继续截图了。总之随着语法树的自底向上遍历，不断计算，汇总到根节点，就得到结果了。</p>
<h3 data-id="heading-15">4.4 使用Listener实现</h3>
<p>在visitor模式下，我们对语法树使用左右根的方式遍历整棵语法树，自底向上，把结果计算出来。在listener模式，也类似，不过listener没有返回值，在进入节点时，需要利用栈这种数据结构，把数据先存储起来，出栈再去计算：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CalcListenerEvaluator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CalcBaseListener</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Double&gt; variables;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;Double&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CalcListenerEvaluator</span><span class="hljs-params">(Map&lt;String, Double&gt; variables)</span> {
        <span class="hljs-built_in">this</span>.variables = variables;
    }

    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getResult</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stack.isEmpty() ? <span class="hljs-number">0.0</span> : stack.pop();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitNumberExpr</span><span class="hljs-params">(CalcParser.NumberExprContext ctx)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> ctx.number().getText();
        stack.push(Double.parseDouble(text));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitVarExpr</span><span class="hljs-params">(CalcParser.VarExprContext ctx)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">varName</span> <span class="hljs-operator">=</span> ctx.VAR().getText();
        <span class="hljs-type">Double</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> variables.getOrDefault(varName, <span class="hljs-number">0.0</span>);
        stack.push(value);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitParenExpr</span><span class="hljs-params">(CalcParser.ParenExprContext ctx)</span> {
        <span class="hljs-comment">// 括号表达式结果已在子表达式处理后入栈，无需额外操作</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitMulDivExpr</span><span class="hljs-params">(CalcParser.MulDivExprContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> stack.pop();
        <span class="hljs-type">double</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> stack.pop();
        <span class="hljs-keyword">if</span> (ctx.MUL() != <span class="hljs-literal">null</span>) {
            stack.push(left * right);
        } <span class="hljs-keyword">else</span> {
            stack.push(left / right);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitAddSubExpr</span><span class="hljs-params">(CalcParser.AddSubExprContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> stack.pop();
        <span class="hljs-type">double</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> stack.pop();
        <span class="hljs-keyword">if</span> (ctx.ADD() != <span class="hljs-literal">null</span>) {
            stack.push(left + right);
        } <span class="hljs-keyword">else</span> {
            stack.push(left - right);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitUnaryMinusPlus</span><span class="hljs-params">(CalcParser.UnaryMinusPlusContext ctx)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> stack.pop();
        <span class="hljs-keyword">if</span> (ctx.SUB() != <span class="hljs-literal">null</span>) {
            stack.push(-value);
        }
        <span class="hljs-comment">// 一元加号不改变值</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitMaxFunc</span><span class="hljs-params">(CalcParser.MaxFuncContext ctx)</span> {
        List&lt;CalcParser.ExprContext&gt; exprs = ctx.expr();
        <span class="hljs-type">double</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> stack.pop();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; exprs.size(); i++) {
            max = Math.max(max, stack.pop());
        }
        stack.push(max);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exitMinFunc</span><span class="hljs-params">(CalcParser.MinFuncContext ctx)</span> {
        List&lt;CalcParser.ExprContext&gt; exprs = ctx.expr();
        <span class="hljs-type">double</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> stack.pop();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; exprs.size(); i++) {
            min = Math.min(min, stack.pop());
        }
        stack.push(min);
    }

}
</code></pre>
<p>下面我们验证一下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    Map&lt;String, Double&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    variables.put(<span class="hljs-string">"a"</span>, <span class="hljs-number">10.0</span>);
    variables.put(<span class="hljs-string">"b"</span>, <span class="hljs-number">6.0</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> <span class="hljs-string">"max(a + 5, min(b * 3, 20)) - 3"</span>;

    <span class="hljs-comment">// 使用Listener模式计算</span>
    <span class="hljs-type">CalcListenerEvaluator</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CalcListenerEvaluator</span>(variables);
    ParseTreeWalker.DEFAULT.walk(listener, exprContext);
    System.out.println(<span class="hljs-string">"Listener结果: "</span> + listener.getResult());
}
</code></pre>
<p><strong>输出</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Visitor结果: 15.0</span>
</code></pre>
<p>listener模式，我们也简单捋一下。还是这张图，从根节点开始遍历，一直向下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd43c3d244b340c2bad36923e370e107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54G16a2C54yO5omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845548&amp;x-signature=WW3RTw9BAV9mRwW3tSuabM4Aueg%3D" alt="image.png" loading="lazy"/></p>
<p>直到遇到左侧加法的变量节点，入栈a,也就是10，再遍历加法右侧的数字节点，入栈5，这时栈的样子为：</p>
<pre><code class="hljs language-rust" lang="rust">栈底 <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">10</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">5</span> <span class="hljs-punctuation">-&gt;</span> 栈顶
</code></pre>
<p>然后回到AddSubExpr节点，执行<code>exitAddSubExpr</code>方法：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void exitAddSubExpr(CalcParser.AddSubExprContext ctx) {
    double <span class="hljs-attribute">right</span> = stack<span class="hljs-selector-class">.pop</span>();
    double <span class="hljs-attribute">left</span> = stack<span class="hljs-selector-class">.pop</span>();
    if (ctx.ADD() != null) {
        stack<span class="hljs-selector-class">.push</span>(left + right);
    } else {
        stack<span class="hljs-selector-class">.push</span>(left - right);
    }
}
</code></pre>
<p>计算了10+5，并把结果15入栈：</p>
<pre><code class="hljs language-rust" lang="rust">栈底 <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">15</span> <span class="hljs-punctuation">-&gt;</span> 栈顶
</code></pre>
<p>继续遍历，到中间的乘法节点，继续入栈b和3，那么现在是：</p>
<pre><code class="hljs language-rust" lang="rust">栈底 <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">15</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">6</span><span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">-&gt;</span> 栈顶
</code></pre>
<p>乘法也是从栈里取出两个数，计算再放回去，那么栈现在是：</p>
<pre><code class="hljs language-rust" lang="rust">栈底 <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">15</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">18</span> <span class="hljs-punctuation">-&gt;</span> 栈顶
</code></pre>
<p>是不是有点感觉了，伴随这样不断入栈出栈，栈中最终的结果，就是出根节点后计算的结果，也就是最终结果。</p>
<h2 data-id="heading-16">五、总结</h2>
<p>只需要定义语法规则，ANTRL4帮我们实现了比较复杂的词法、语法解析，并提供visitor和listener两种模式，协助遍历抽象语法树，让复杂的语法解析，瞬间变得简单。ANTRL4在很多开源软件中，都有应用，比如SPARK、HIVE的语法解析。</p>
<p><strong>另外</strong></p>
<ol>
<li>咱们实现的表达是计算，仅仅是能用，每次计算都需要重新解析，性能较差。一个可行的思路是，解析后直接生成java字节码，并缓存以提升性能。表达式引擎aviator就是这么做的，不过，aviator并没有使用ANTRL4。如果你需要这样一个表达式解析器，推荐aviator，没必要重复造轮子。</li>
<li>文章里总写根左右或者左右根这种遍历方式，实际上这是二叉树的概念，应用的并不准确。</li>
<li>语法文件编写是很复杂的，这里讲的很简略，可以在B站上看下这个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV16TNhz2EKG%2F%3Fspm_id_from%3D333.337.search-card.all.click%26vd_source%3D4ea2be483e14a3b23d2c952bd0c34230" target="_blank" title="https://www.bilibili.com/video/BV16TNhz2EKG/?spm_id_from=333.337.search-card.all.click&amp;vd_source=4ea2be483e14a3b23d2c952bd0c34230" ref="nofollow noopener noreferrer"># 【antlr】Antlr4从入门到精通</a></li>
<li>源码上传了Gitee，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fheyhu%2Fantlr4-express" target="_blank" title="https://gitee.com/heyhu/antlr4-express" ref="nofollow noopener noreferrer">可以自取</a>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发可掌握的知识：推荐系统]]></title>    <link>https://juejin.cn/post/7585645111875289115</link>    <guid>https://juejin.cn/post/7585645111875289115</guid>    <pubDate>2025-12-21T03:43:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585645111875289115" data-draft-id="7585553799297925166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发可掌握的知识：推荐系统"/> <meta itemprop="keywords" content="后端,Java,算法"/> <meta itemprop="datePublished" content="2025-12-21T03:43:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三年之约"/> <meta itemprop="url" content="https://juejin.cn/user/3448523142729784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发可掌握的知识：推荐系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3448523142729784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三年之约
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T03:43:39.000Z" title="Sun Dec 21 2025 03:43:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>推荐系统（Recommendation System）是一种信息过滤系统，其目标是预测用户对物品（如商品、电影、文章等）的偏好或评分，从而向用户推荐他们可能感兴趣的物品。推荐系统广泛应用于电商、视频平台、社交媒体、新闻推送等场景。</p>
<p>下面是一个典型推荐系统算法的完整流程，包括核心模块、常用算法以及整体工作流程：</p>
<h2 data-id="heading-0">一、推荐系统整体流程</h2>
<p>一个完整的推荐系统主要包括以下步骤：</p>
<pre><code class="hljs language-text" lang="text">1. 数据收集
2. 数据预处理
3. 特征工程
4. 模型选择与训练
5. 推荐生成（召回 + 排序）
6. 结果评估与反馈
7. 在线服务与更新
</code></pre>
<hr/>
<h3 data-id="heading-1">1. 数据收集（Data Collection）</h3>
<p>收集用户行为数据和物品信息，常见数据包括：</p>
<ul>
<li><strong>显式反馈</strong>：用户评分、点赞、收藏等（如电影评分）</li>
<li><strong>隐式反馈</strong>：点击、浏览、购买、停留时长等</li>
<li><strong>上下文信息</strong>：时间、地点、设备、天气等</li>
<li><strong>用户画像</strong>：年龄、性别、地域、兴趣标签等</li>
<li><strong>物品特征</strong>：类别、标签、描述、价格、作者等</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 数据预处理（Data Preprocessing）</h3>
<p>对原始数据进行清洗和转换：</p>
<ul>
<li>去除噪声（如异常点击、爬虫数据）</li>
<li>处理缺失值</li>
<li>数据归一化 / 标准化</li>
<li>构建用户-物品交互矩阵（User-Item Interaction Matrix）</li>
<li>划分训练集 / 验证集 / 测试集</li>
</ul>
<hr/>
<h3 data-id="heading-3">3. 特征工程（Feature Engineering）</h3>
<p>提取有效特征用于模型训练：</p>
<ul>
<li>用户侧特征：历史行为统计（如点击率、购买频次）、兴趣向量</li>
<li>物品侧特征：类别、热度、文本嵌入（如TF-IDF、BERT）</li>
<li>交叉特征：用户-物品交互特征（是否购买过同类商品）</li>
<li>时序特征：最近一次交互时间、行为衰减权重</li>
</ul>
<hr/>
<h3 data-id="heading-4">4. 模型选择与训练（Model Selection &amp; Training）</h3>
<p>根据场景选择合适的推荐算法。常见算法分类如下：</p>
<h4 data-id="heading-5">（1）基于内容的推荐（Content-Based）</h4>
<ul>
<li>原理：根据用户历史喜欢的物品内容，推荐相似内容的物品。</li>
<li>优点：可解释性强，无冷启动问题（对新物品友好）</li>
<li>缺点：推荐多样性差，难以发现用户新兴趣</li>
</ul>
<h4 data-id="heading-6">（2）协同过滤（Collaborative Filtering, CF）</h4>
<ul>
<li><strong>基于用户的CF</strong>：找相似用户，推荐他们喜欢的物品</li>
<li><strong>基于物品的CF</strong>：找相似物品，推荐用户喜欢的相似物品</li>
<li>优点：无需物品内容信息，发现潜在兴趣</li>
<li>缺点：冷启动问题（新用户/新物品难处理），数据稀疏性</li>
</ul>
<h4 data-id="heading-7">（3）矩阵分解（Matrix Factorization, MF）</h4>
<ul>
<li>将用户-物品评分矩阵分解为低维隐向量（User Embedding + Item Embedding）</li>
<li>经典算法：SVD、SVD++、NMF</li>
<li>优点：缓解稀疏性，捕捉隐式兴趣</li>
<li>缺点：难以融入丰富特征</li>
</ul>
<h4 data-id="heading-8">（4）深度学习模型</h4>
<ul>
<li><strong>Wide &amp; Deep</strong>：结合记忆（Wide）与泛化（Deep）</li>
<li><strong>Neural CF（NCF）</strong> ：用神经网络替代内积计算用户-物品匹配度</li>
<li><strong>DeepFM / DIN / DIEN</strong>：融合特征交叉与用户行为序列建模</li>
<li><strong>Graph Neural Networks（GNN）</strong> ：将用户-物品交互建模为图，如 PinSage</li>
</ul>
<h4 data-id="heading-9">（5）多任务学习与强化学习</h4>
<ul>
<li>多目标优化（如点击率 + 转化率 + 时长）</li>
<li>在线学习 / 强化学习（如 LinUCB、DQN）用于动态调整推荐策略</li>
</ul>
<hr/>
<h3 data-id="heading-10">5. 推荐生成：召回（Recall） + 排序（Ranking）</h3>
<p>由于物品库通常很大（百万级），需分两阶段：</p>
<h4 data-id="heading-11">（1）召回阶段</h4>
<ul>
<li>
<p>从全量物品中快速筛选出几百~几千个候选物品</p>
</li>
<li>
<p>常用方法：</p>
<ul>
<li>基于规则（热门、地域、新上架）</li>
<li>协同过滤（ItemCF、UserCF）</li>
<li>向量召回（ANN，如 Faiss、HNSW，用 Embedding 相似度）</li>
<li>多路召回（融合多种策略）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">（2）排序阶段</h4>
<ul>
<li>对召回结果打分排序，输出 Top-K 推荐</li>
<li>使用复杂模型（如 DeepFM、DIN、Transformer）</li>
<li>输入：用户特征 + 物品特征 + 上下文 + 交叉特征</li>
<li>输出：点击率（CTR）、转化率（CVR）等预测值</li>
</ul>
<blockquote>
<p>高级系统可能还有重排（Re-ranking）阶段，考虑多样性、公平性、业务规则等。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">6. 评估与反馈（Evaluation &amp; Feedback）</h3>
<h4 data-id="heading-14">离线评估指标：</h4>
<ul>
<li>准确率：RMSE（评分预测）、Precision@K、Recall@K、NDCG@K</li>
<li>覆盖率、多样性、新颖性</li>
</ul>
<h4 data-id="heading-15">在线评估（A/B测试）：</h4>
<ul>
<li>CTR（点击率）、转化率、人均观看时长、GMV 等业务指标</li>
</ul>
<h4 data-id="heading-16">用户反馈闭环：</h4>
<ul>
<li>实时收集用户对推荐结果的行为</li>
<li>用于在线学习或模型定期更新</li>
</ul>
<hr/>
<h3 data-id="heading-17">7. 在线服务与模型更新</h3>
<ul>
<li><strong>实时推荐</strong>：使用流处理（如 Flink）更新用户兴趣</li>
<li><strong>模型部署</strong>：通过 TF Serving、TorchServe 提供在线预测</li>
<li><strong>增量训练</strong>：每日/每小时更新模型（如使用在线学习算法）</li>
</ul>
<h2 data-id="heading-18">二、详细流程解析</h2>
<h3 data-id="heading-19">1. 推荐生成：召回（Recall） + 排序（Ranking）</h3>
<p>这个流程的核心目标是：<strong>从海量物品库中，高效、准确地为用户筛选出他们最可能感兴趣的少量物品，并最终以体验良好的方式呈现出来。</strong></p>
<hr/>
<h4 data-id="heading-20">1. 召回（Recall）</h4>
<ul>
<li>
<p><strong>目标</strong>：解决算法效率问题。从数以百万甚至千万计的物品库中，快速、粗略地筛选出几百到几千的候选集合，保证召回率（尽量不遗漏用户可能喜欢的物品）。</p>
</li>
<li>
<p><strong>核心思想</strong>：“海选”。不计较单个物品的精确得分，而是利用多种策略从不同角度“捞”回可能相关的物品。</p>
</li>
<li>
<p><strong>常用策略</strong>：工业通常采用<strong>多路召回（Multi-tower Recall）</strong> ，融合多种策略结果，再去重合并</p>
<ul>
<li>
<p><strong>基于协同过滤</strong>：根据用户的历史行为（如点击、购买）找相似。</p>
<ul>
<li><strong>物品协同过滤</strong>：“买了此商品的人，也买了XXX”。根据物品的共现关系进行推荐。</li>
<li><strong>用户协同过滤</strong>：“和你相似的人，也喜欢XXX”。找到相似用户，推荐他们喜欢的物品。</li>
</ul>
</li>
<li>
<p><strong>基于内容</strong>：根据用户喜欢的物品的内容特征（如关键词、标签、类别）来推荐相似特征的物品。</p>
</li>
<li>
<p><strong>基于热点</strong>：推荐当前最热门、最流行的物品。</p>
</li>
<li>
<p><strong>基于模型</strong>：使 <strong>用向量化技术（如Embedding）</strong> 将用户和物品表示为向量，通过向量相似度（如余弦相似度）进行快速检索，<strong>这是目前的主流模型方法</strong>。</p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-21">2. 排序（Ranking）</h4>
<p>排序阶段通常分为两步：粗排和精排。</p>
<ul>
<li>
<p><strong>粗排（Pre-ranking）</strong></p>
<ul>
<li><strong>目标</strong>：对召回阶段输出的几百上千个候选物品进行初步筛选，将数量缩减到几十或一百左右，为后续的精排阶段减压。</li>
<li><strong>特点</strong>：使用相对简单的模型（如逻辑回归、浅层神经网络）和少量关键特征，追求速度。</li>
</ul>
</li>
<li>
<p><strong>精排（Ranking）</strong></p>
<ul>
<li>
<p><strong>目标</strong>：这是推荐系统的核心，解决算法精准度问题。它对粗排后的候选集进行精准的点击率（CTR）、转化率（CVR）等目标预测。</p>
</li>
<li>
<p><strong>核心思想</strong>：“决赛”。为每个物品计算一个最终的得分。</p>
</li>
<li>
<p><strong>常用模型</strong>：</p>
<ul>
<li><strong>传统模型</strong>：逻辑回归（LR）、梯度提升决策树（GBDT）。</li>
<li><strong>深度学习模型</strong>： Wide &amp; Deep（兼顾记忆与泛化）、DeepFM（自动学习特征交叉）、DIN（针对用户兴趣多样性）等。这些模型能够处理海量特征并进行复杂的非线性拟合。</li>
</ul>
</li>
<li>
<p><strong>关键特征</strong>：</p>
<ul>
<li><strong>用户特征</strong>：年龄、性别、兴趣标签、购买力等。</li>
<li><strong>物品特征</strong>：类别、价格、品牌、标签等。</li>
<li><strong>上下文特征</strong>：时间、地点、天气、当前页面等。</li>
<li><strong>交叉特征</strong>：用户与物品之间的交互特征，是提升模型效果的关键。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">3. 重排（Re-ranking）</h4>
<ul>
<li>
<p><strong>目标</strong>：在精排生成的得分列表基础上，引入业务规则和多样性策略，调整最终展示给用户的列表顺序，提升用户体验和业务指标。</p>
</li>
<li>
<p><strong>常用策略</strong>：</p>
<ul>
<li><strong>去重</strong>：去除用户已经看过、买过或明确不喜欢的物品。</li>
<li><strong>多样性</strong>：避免推荐列表中出现过多同质化物品（例如，全是同一品牌的手机）。</li>
<li><strong>新颖性</strong>：适当给新物品或冷门物品一些曝光机会。</li>
<li><strong>业务规则</strong>：如保证某些战略商品的曝光位置、进行商业引流等。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端轮子（1）--前端部署后-判断页面是否为最新]]></title>    <link>https://juejin.cn/post/7585706951603601434</link>    <guid>https://juejin.cn/post/7585706951603601434</guid>    <pubDate>2025-12-21T02:18:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951603601434" data-draft-id="7585463258690502665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端轮子（1）--前端部署后-判断页面是否为最新"/> <meta itemprop="keywords" content="前端,Vue.js,Node.js"/> <meta itemprop="datePublished" content="2025-12-21T02:18:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小易"/> <meta itemprop="url" content="https://juejin.cn/user/2032344744857127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端轮子（1）--前端部署后-判断页面是否为最新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2032344744857127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小易
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:18:14.000Z" title="Sun Dec 21 2025 02:18:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>前端轮子系列：</p>
<ol>
<li><a href="https://juejin.cn/spost/7585706951603601434" target="_blank" title="https://juejin.cn/spost/7585706951603601434">前端部署后-判断页面是否为最新</a></li>
<li>如何优雅diy响应数据</li>
<li>如何优雅进行webview调试</li>
<li>如何实现测试环境的自动登录</li>
<li/>
</ol>
</blockquote>
<blockquote>
<p>项目部署后：通知更新、强制刷新、自测访问的页面为最新代码（是否发版成功）<br/>
重点：<strong>自测、提测、修改bug</strong>后，确认访问的为<strong>最新页面</strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5d14d5dcee4533938fe6b167aab982~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766888338&amp;x-signature=CZ5zNZQsNzIVWwr9mEh1fKlvH6M%3D" alt="check-version.gif" loading="lazy"/></p>
<h2 data-id="heading-0">实现思路</h2>
<p>目的：生成新的版本标识，通过对比标识 ==&gt; 当前为最新 还是 旧页面</p>
<ol>
<li>生成版本号：如：1.1.10 ，或者时间戳（202512201416）
<ul>
<li>自动化脚本生成</li>
<li>手动控制</li>
</ul>
</li>
<li>对比版本号：相等=&gt; 当前为最新；不等 =&gt; 当前为旧页面</li>
<li>通过对比结果 对应处理产品逻辑 完事儿~</li>
</ol>
<h2 data-id="heading-1">具体实现</h2>
<h3 data-id="heading-2">方案一：生成时间戳，注入变量，控制台打印</h3>
<h4 data-id="heading-3">在vue-cli项目中</h4>
<p>通过vue.config.js 入变量<br/>
然后在main.js中打印变量</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'__BUILD_TIME__'</span>, __BUILD_TIME__)
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">const</span> _date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUILD_TIME</span> = _date.<span class="hljs-property">toLocaleString</span> ? _date.<span class="hljs-title function_">toLocaleString</span>() : _date.<span class="hljs-title function_">getTime</span>()

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>({
        <span class="hljs-attr">__BUILD_TIME__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable constant_">BUILD_TIME</span>)
      })
    ]
  },
}

</code></pre>
<h4 data-id="heading-4">在vite项目中</h4>
<p>通过vite.config.js 注入 <strong>BUILD_TIME</strong> 变量<br/>
然后在main.js中打印 <strong>BUILD_TIME</strong> 变量</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'__BUILD_TIME__'</span>, __BUILD_TIME__)
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">const</span> _date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUILD_TIME</span> = _date.<span class="hljs-property">toLocaleString</span> ? _date.<span class="hljs-title function_">toLocaleString</span>() : _date.<span class="hljs-title function_">getTime</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">define</span>: {
      <span class="hljs-attr">__BUILD_TIME__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable constant_">BUILD_TIME</span>)
    },
  }
})
</code></pre>
<p>这种方案，实现了在控制台打印。但是对于生产环境，无法做到版本号的对比<br/>
为啥？ 因为上线 一般会去掉日志的打印， 所以咱通过版本号来~</p>
<h3 data-id="heading-5">方案二：记录版本号，轮询对比版本号</h3>
<ol>
<li>编写生成版本号的脚本，生成版本号文件</li>
<li>build结束，调用脚本去生成版本号文件</li>
<li>轮询对比版本号文件，如果版本号不一致，做相应操作</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// dist/version.json</span>
{
  <span class="hljs-string">"buildTime"</span>: <span class="hljs-string">"2025-12-20 14:16:00"</span>
}
</code></pre>
<p><strong>prebuild</strong>: build前执行的脚本<br/>
<strong>postbuild</strong>：build结束后执行的脚本，用于生成版本号文件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// package.json</span>
{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"postbuild"</span>: <span class="hljs-string">"node scripts/generate-version-dist.mjs"</span>
  }
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// scripts/generate-version-dist.mjs</span>
<span class="hljs-keyword">import</span> { writeFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs/promises'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>

<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)
<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(__filename)
<span class="hljs-keyword">const</span> root = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'..'</span>)


<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> _date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUILD_TIME</span> = _date.<span class="hljs-property">toLocaleString</span> ? _date.<span class="hljs-title function_">toLocaleString</span>() : _date.<span class="hljs-title function_">getTime</span>()

  <span class="hljs-keyword">const</span> outPath = path.<span class="hljs-title function_">join</span>(root, <span class="hljs-string">'dist'</span>, <span class="hljs-string">'version.json'</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">writeFile</span>(outPath, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-variable constant_">BUILD_TIME</span> }, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">'\n'</span>, <span class="hljs-string">'utf-8'</span>)

}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[generate-version] failed'</span>, e)
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>)
})
</code></pre>
<h4 data-id="heading-6">轮询对比版本号</h4>
<ol>
<li>轮询对比版本号文件，如果版本号不一致，做相应操作</li>
<li>页面隐藏、切后台时，停止轮询，页面关闭时，停止轮询</li>
<li>页面显示、切前台时，开始轮询</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createVersionPoller } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/versionPoller'</span>
<span class="hljs-title function_">createVersionPoller</span>({
  <span class="hljs-attr">versionUrl</span>: <span class="hljs-string">'/version.json'</span>,
  <span class="hljs-attr">storageKey</span>: <span class="hljs-string">'__VERSION_CHECK__CURRENT_BUILD_TIME__'</span>,
  <span class="hljs-attr">intervalMs</span>: <span class="hljs-number">15_000</span>,
  <span class="hljs-attr">maxDelayMs</span>: <span class="hljs-number">60_000</span>,
  <span class="hljs-attr">onResult</span>: <span class="hljs-function">(<span class="hljs-params">{ remoteVersion, remoteBuildTime }</span>) =&gt;</span> {
    <span class="hljs-comment">// 轮询到json文件 成功，额外处理逻辑</span>
  },
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 轮询失败，额外处理逻辑</span>
  },
  <span class="hljs-attr">onUpdate</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 版本号不一致，需要更新，额外处理逻辑</span>
  }
}).<span class="hljs-title function_">start</span>()


</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 轮询 /version.json，对比 buildTime 判断是否需要更新（setTimeout + 错误指数退让）
 *
 * 行为说明：
 * - start() 会自动注册监听：visibilitychange / beforeunload / unload
 * - stop() 会清理定时器并卸载监听
 * - 请求失败会指数退让（delay *= 2，最大不超过 maxDelayMs）；成功后恢复 intervalMs
 * - currentBuildTime 会写入 localStorage（storageKey）
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">options</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [options.versionUrl='/version.json'] 版本文件地址
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [options.storageKey='__VERSION_CHECK__CURRENT_BUILD_TIME__'] localStorage key
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [options.intervalMs=15000] 正常轮询间隔（毫秒）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [options.maxDelayMs=60000] 退让最大间隔（毫秒）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">(info:{localBuildTime:string,remoteBuildTime:string,remoteVersion:string,data:any</span>})=&gt;void} [options.onResult] 每次成功拉取后的回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">(error:any)=&gt;void</span>} [options.onError] 拉取失败回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">(info:{localBuildTime:string,remoteBuildTime:string,remoteVersion:string,data:any</span>})=&gt;void} [options.onUpdate] 发现新 buildTime 时回调（默认会 stop）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createVersionPoller</span>(<span class="hljs-params">{
  versionUrl = <span class="hljs-string">'/version.json'</span>,
  storageKey = <span class="hljs-string">'__VERSION_CHECK__CURRENT_BUILD_TIME__'</span>,
  intervalMs = <span class="hljs-number">15000</span>,
  maxDelayMs = <span class="hljs-number">60000</span>,
  onResult,
  onError,
  onUpdate
} = {}</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> stopped = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">let</span> delayMs = intervalMs
  <span class="hljs-keyword">let</span> bound = <span class="hljs-literal">false</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">readLocal</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">getItem</span>(storageKey) || <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">writeLocal</span> = (<span class="hljs-params">v</span>) =&gt; v &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">setItem</span>(storageKey, <span class="hljs-title class_">String</span>(v))

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!timer) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">clearTimeout</span>(timer)
    timer = <span class="hljs-literal">null</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">isVisible</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> !== <span class="hljs-string">'hidden'</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchRemote</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> sep = versionUrl.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${versionUrl}</span><span class="hljs-subst">${sep}</span>t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">cache</span>: <span class="hljs-string">'no-store'</span>, <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache'</span> } })
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`fetch <span class="hljs-subst">${versionUrl}</span> failed: <span class="hljs-subst">${res.status}</span>`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
  }

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tick</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (stopped || !<span class="hljs-title function_">isVisible</span>()) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> localBuildTime = <span class="hljs-title function_">readLocal</span>() || <span class="hljs-string">''</span>

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchRemote</span>()
      <span class="hljs-keyword">const</span> remoteVersion = <span class="hljs-title class_">String</span>(data?.<span class="hljs-property">version</span> || <span class="hljs-string">''</span>)
      <span class="hljs-keyword">const</span> remoteBuildTime = <span class="hljs-title class_">String</span>(data?.<span class="hljs-property">BUILD_TIME</span> || <span class="hljs-string">''</span>)

      delayMs = intervalMs
      onResult?.({ localBuildTime, remoteBuildTime, remoteVersion, data })

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>( remoteBuildTime , <span class="hljs-string">'=&gt;'</span>, localBuildTime)

      <span class="hljs-keyword">if</span> (remoteBuildTime &amp;&amp; remoteBuildTime !== localBuildTime) {
        <span class="hljs-comment">// 记录最新 buildTime，避免重复提示同一个更新</span>
        <span class="hljs-title function_">writeLocal</span>(remoteBuildTime)
        onUpdate?.({ localBuildTime, remoteBuildTime, remoteVersion, data })
      }
    } <span class="hljs-keyword">catch</span> (e) {
      delayMs = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(maxDelayMs, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">500</span>, delayMs * <span class="hljs-number">2</span>))
      onError?.(e)
    }

    timer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(tick, delayMs)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onVisibilityChange</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (stopped) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isVisible</span>()) <span class="hljs-keyword">return</span> <span class="hljs-title function_">clear</span>()
    <span class="hljs-title function_">clear</span>()
    timer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(tick, <span class="hljs-number">0</span>)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureBound</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (bound) <span class="hljs-keyword">return</span>
    bound = <span class="hljs-literal">true</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, onVisibilityChange)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, stop)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unload'</span>, stop)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureUnbound</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!bound) <span class="hljs-keyword">return</span>
    bound = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, onVisibilityChange)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'beforeunload'</span>, stop)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'unload'</span>, stop)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!stopped) <span class="hljs-keyword">return</span>
    stopped = <span class="hljs-literal">false</span>
    delayMs = intervalMs
    <span class="hljs-title function_">ensureBound</span>()
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isVisible</span>()) timer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(tick, <span class="hljs-number">0</span>)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    stopped = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">clear</span>()
    <span class="hljs-title function_">ensureUnbound</span>()
  }

  <span class="hljs-keyword">return</span> { start, stop }
}

</code></pre>
<h2 data-id="heading-7">注意点</h2>
<ul>
<li>轮询版本文件，拼 时间戳、设置请求头 避免命中缓存</li>
<li>轮询版本文件，时间间隔不要太短，耗费网络，虽然已经做了轮询指数退让</li>
<li>生成的版本文件 生成到dist下 注意访问路径</li>
<li>版本号需要上传到git，需要手动执行脚本&amp;commit + push</li>
</ul>
<h2 data-id="heading-8">源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoyi1255%2Fversion-check" target="_blank" title="https://github.com/xiaoyi1255/version-check" ref="nofollow noopener noreferrer">xiaoyi1255</a></p>
<h2 data-id="heading-9">结语</h2>
<p>如果本文对你有收获，麻烦动动发财的小手，点点关注、点点赞！！！👻👻👻</p>
<p>因为收藏===会了</p>
<p>如果有不对、更好的方式实现、可以优化的地方欢迎在评论区指出，谢谢👾👾👾</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[G1与ZGC垃圾收集器深度剖析]]></title>    <link>https://juejin.cn/post/7585474459776696356</link>    <guid>https://juejin.cn/post/7585474459776696356</guid>    <pubDate>2025-12-20T10:26:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776696356" data-draft-id="7585474459776679972" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="G1与ZGC垃圾收集器深度剖析"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-20T10:26:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="無量"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            G1与ZGC垃圾收集器深度剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    無量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T10:26:21.000Z" title="Sat Dec 20 2025 10:26:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>G1和ZGC是现代Java应用的首选垃圾收集器,代表了GC技术的演进方向。G1通过Region分区和可预测停顿,在JDK 9后成为默认收集器,适合4GB以上堆内存、追求平衡性能的应用;ZGC则通过染色指针和并发重定位技术,实现接近零停顿(&lt; 10ms),专为超大堆(TB级)和极低延迟场景设计。本文从理论到实战,深度剖析两者的核心原理(Region设计、RSet、SATB、染色指针、多重映射)、GC流程、参数调优,并通过生产案例对比分析,帮助读者在实际项目中选择合适的收集器,掌握性能调优技巧。</p>
<hr/>
<h2 data-id="heading-1">一、理论背景与演进</h2>
<h3 data-id="heading-2">1.1 传统GC的痛点</h3>
<p>在G1和ZGC出现之前,Java应用主要使用Serial、Parallel和CMS收集器。这些传统GC存在显著痛点:</p>
<p><strong>Serial GC (串行收集器)</strong>:</p>
<ul>
<li>单线程收集,Stop-The-World时间长</li>
<li>适用场景: Client模式,单核CPU环境</li>
<li>痛点: 生产环境不可接受,停顿时间达秒级</li>
</ul>
<p><strong>Parallel GC (并行收集器)</strong>:</p>
<ul>
<li>多线程并行,吞吐量优先</li>
<li>适用场景: 后台计算,批处理任务</li>
<li>痛点: Full GC时STW时间长,堆越大停顿越久(8GB堆可达2-5秒)</li>
</ul>
<p><strong>CMS GC (并发标记清除)</strong>:</p>
<ul>
<li>低延迟,大部分阶段并发执行</li>
<li>适用场景: 互联网应用,要求低停顿</li>
<li>痛点:
<ul>
<li><strong>CPU敏感</strong>: 并发阶段占用CPU,降低吞吐量</li>
<li><strong>浮动垃圾</strong>: 并发清除时产生的新垃圾无法回收</li>
<li><strong>内存碎片</strong>: 标记-清除算法,不整理碎片,可能提前触发Full GC</li>
<li><strong>Concurrent Mode Failure</strong>: 并发标记未完成老年代已满,退化为Serial Old,停顿时间更长</li>
</ul>
</li>
</ul>
<p><strong>核心矛盾</strong>:</p>
<p>传统GC面临"不可能三角":</p>
<ul>
<li><strong>吞吐量</strong> (Throughput): 运行用户代码时间占比</li>
<li><strong>延迟</strong> (Latency): GC停顿时间</li>
<li><strong>堆大小</strong> (Heap Size): 支持的最大堆内存</li>
</ul>
<p>传统GC只能在三者中选择两个,无法兼顾。例如:</p>
<ul>
<li>Parallel GC: 高吞吐量 + 支持大堆,但延迟高</li>
<li>CMS: 低延迟 + 支持中等堆,但吞吐量下降且有碎片问题</li>
</ul>
<h3 data-id="heading-3">1.2 G1的诞生背景</h3>
<p><strong>G1 (Garbage-First)</strong> 于JDK 7引入,JDK 9成为默认收集器,目标是打破传统GC的限制:</p>
<p><strong>设计目标</strong>:</p>
<ol>
<li><strong>可预测的停顿时间</strong>: 通过<code>-XX:MaxGCPauseMillis</code>设置停顿目标(软目标)</li>
<li><strong>适应大堆</strong>: 支持几十GB堆,Full GC时间可控</li>
<li><strong>平衡吞吐量和延迟</strong>: 不牺牲太多吞吐量的前提下,降低停顿时间</li>
</ol>
<p><strong>核心创新</strong>:</p>
<ul>
<li><strong>Region分区</strong>: 将堆划分为多个大小相等的Region,不再固定分代边界</li>
<li><strong>Garbage-First策略</strong>: 优先回收垃圾最多的Region,在停顿时间允许范围内最大化回收效果</li>
<li><strong>增量回收</strong>: 每次只回收部分Region,避免全堆扫描</li>
</ul>
<h3 data-id="heading-4">1.3 ZGC的诞生背景</h3>
<p><strong>ZGC (Z Garbage Collector)</strong> 于JDK 11引入(实验性),JDK 15转正,目标是实现超低延迟:</p>
<p><strong>设计目标</strong>:</p>
<ol>
<li><strong>极低停顿</strong>: 停顿时间 &lt; 10ms,与堆大小无关</li>
<li><strong>支持超大堆</strong>: 4TB以上堆,停顿时间依然在10ms以内</li>
<li><strong>高吞吐量</strong>: 停顿时间降低的同时,吞吐量损失控制在15%以内</li>
</ol>
<p><strong>核心创新</strong>:</p>
<ul>
<li><strong>染色指针</strong> (Colored Pointers): 将GC信息存储在指针中,而不是对象头</li>
<li><strong>读屏障</strong> (Load Barrier): 对象访问时通过读屏障自动处理重定位</li>
<li><strong>并发重定位</strong>: 对象移动与应用线程并发执行,无需STW</li>
<li><strong>多重映射</strong>: 同一物理内存映射到多个虚拟地址,实现并发安全</li>
</ul>
<p><strong>适用场景</strong>:</p>
<ul>
<li>低延迟要求极高的应用 (金融交易、实时系统)</li>
<li>超大堆内存应用 (几十GB到TB级)</li>
<li>追求极致用户体验的互联网应用</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、G1垃圾收集器原理</h2>
<h3 data-id="heading-6">2.1 G1的整体架构</h3>
<p>G1的核心设计思想是"化整为零",将堆划分为多个Region,打破传统分代GC的固定边界。</p>
<h4 data-id="heading-7">2.1.1 Region分区设计</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1854670ba37c4decbceda4d0454108d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766831181&amp;x-signature=lJK%2FJIW3pJkAJ4CHeSg6SoL3dQ4%3D" alt="g1-region-structure.svg" loading="lazy"/></p>
<p><strong>Region是G1的基本单位</strong>:</p>
<ul>
<li>将堆划分为多个大小相等的Region(默认2048个)</li>
<li>Region大小 = 堆大小 / 2048 (向上取2的幂)</li>
<li>范围: 1MB ~ 32MB,必须是2的幂</li>
</ul>
<p><strong>Region大小计算示例</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">堆8GB:  Region大小 = 8GB / 2048 ≈ 4MB
堆16GB: Region大小 = 16GB / <span class="hljs-attr">2048</span> = <span class="hljs-number">8</span>MB
堆32GB: Region大小 = 32GB / <span class="hljs-attr">2048</span> = <span class="hljs-number">16</span>MB
</code></pre>
<p><strong>手动设置Region大小</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">-XX:G1HeapRegionSize=8m  <span class="hljs-comment"># 设置Region大小为8MB</span>
</code></pre>
<p><strong>Region类型</strong>:</p>
<p>G1中的Region可以动态分配为不同类型:</p>
<ol>
<li>
<p><strong>Eden Region (Eden区)</strong>:</p>
<ul>
<li>新对象分配的区域</li>
<li>Young GC时全部清空</li>
</ul>
</li>
<li>
<p><strong>Survivor Region (Survivor区)</strong>:</p>
<ul>
<li>Young GC后存活对象的区域</li>
<li>采用复制算法,From/To角色互换</li>
</ul>
</li>
<li>
<p><strong>Old Region (老年代区)</strong>:</p>
<ul>
<li>存放晋升对象</li>
<li>Mixed GC时部分回收</li>
</ul>
</li>
<li>
<p><strong>Humongous Region (大对象区)</strong>:</p>
<ul>
<li>存放大对象(≥ Region大小的50%)</li>
<li>大对象直接分配到老年代</li>
<li>可能跨越多个连续Region</li>
</ul>
</li>
<li>
<p><strong>Free Region (空闲区)</strong>:</p>
<ul>
<li>未分配的Region</li>
<li>可随时分配为任何类型</li>
</ul>
</li>
</ol>
<p><strong>动态分配的优势</strong>:</p>
<p>传统分代GC中,新生代和老年代有固定边界:</p>
<pre><code class="hljs language-ini" lang="ini">传统GC: <span class="hljs-section">[新生代 | 老年代]</span>  ← 固定边界,无法动态调整
</code></pre>
<p>G1中,Region可以动态分配:</p>
<pre><code class="hljs language-ini" lang="ini">G1: <span class="hljs-section">[E]</span><span class="hljs-section">[E]</span><span class="hljs-section">[S]</span><span class="hljs-section">[O]</span><span class="hljs-section">[O]</span><span class="hljs-section">[O]</span><span class="hljs-section">[F]</span><span class="hljs-section">[F]</span>  ← E/S/O可以动态调整
</code></pre>
<ul>
<li>根据<code>MaxGCPauseMillis</code>目标,G1自动调整新生代大小</li>
<li>新生代Region数量在5%-60%之间动态变化</li>
<li>避免固定边界导致的空间浪费</li>
</ul>
<h4 data-id="heading-8">2.1.2 Remembered Set (RSet)</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b6717abccd47dc8ee071f028144404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766831181&amp;x-signature=n%2FfaoyQqWQsVQJJL5jh%2BHfJGpEM%3D" alt="g1-rset-structure.svg" loading="lazy"/></p>
<p><strong>为什么需要RSet?</strong></p>
<p>Young GC时,需要知道哪些老年代对象引用了年轻代对象。传统做法是全堆扫描,效率极低。G1通过RSet记录外部Region对本Region的引用。</p>
<p><strong>RSet结构</strong>:</p>
<p>每个Region维护一个RSet,记录哪些Region引用了本Region中的对象:</p>
<pre><code class="hljs language-css" lang="css">Region <span class="hljs-selector-tag">A</span>的RSet: {Region <span class="hljs-selector-tag">B</span>, Region C}
// 表示Region <span class="hljs-selector-tag">B</span>和Region C中的对象引用了Region <span class="hljs-selector-tag">A</span>中的对象
</code></pre>
<p><strong>示例</strong>:</p>
<p>假设有3个Region:</p>
<ul>
<li>Region A (Old): 包含对象A1、A2</li>
<li>Region B (Eden): 包含对象B1、B2</li>
<li>Region C (Old): 包含对象C1、C2</li>
</ul>
<p>引用关系:</p>
<ul>
<li>A1 → B1 (老年代引用年轻代)</li>
<li>A2 → B2</li>
</ul>
<p>则Region B的RSet记录: <code>{Region A}</code></p>
<p><strong>Young GC时使用RSet</strong>:</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">1</span>. 要回收Region <span class="hljs-selector-tag">B</span> (Eden区)
<span class="hljs-number">2</span>. 查看Region <span class="hljs-selector-tag">B</span>的RSet: {Region <span class="hljs-selector-tag">A</span>}
<span class="hljs-number">3</span>. 只需扫描Region <span class="hljs-selector-tag">A</span>中的对象,找出对Region <span class="hljs-selector-tag">B</span>的引用
<span class="hljs-number">4</span>. 无需扫描整个老年代,大幅提升效率
</code></pre>
<p><strong>写屏障维护RSet</strong>:</p>
<p>每次引用更新时,JVM插入写屏障代码,维护RSet:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码: G1的写屏障</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">oop_field_store</span><span class="hljs-params">(oop* field, oop new_value)</span> {
  <span class="hljs-comment">// 1. 前置写屏障 (SATB,记录旧值,下文详述)</span>
  pre_write_barrier(field);

  <span class="hljs-comment">// 2. 实际的引用更新</span>
  *field = new_value;

  <span class="hljs-comment">// 3. 后置写屏障 (维护RSet)</span>
  <span class="hljs-keyword">if</span> (is_in_young(new_value) &amp;&amp; is_in_old(field)) {
    <span class="hljs-comment">// 老年代对象引用年轻代对象</span>
    Region* young_region = get_region(new_value);
    Region* old_region = get_region(field);
    <span class="hljs-comment">// 将old_region添加到young_region的RSet</span>
    young_region-&gt;rset-&gt;add(old_region);
  }
}
</code></pre>
<p><strong>卡表(Card Table)实现细节</strong>:</p>
<p>RSet的底层实现使用卡表(Card Table):</p>
<ul>
<li>将堆划分为多个Card(默认512字节)</li>
<li>每个Card对应一个字节的标记位</li>
<li>引用变化时,标记对应Card为"脏"</li>
<li>RSet记录的是Card的集合,而不是具体对象</li>
<li>Young GC时,只需扫描RSet中标记为"脏"的Card</li>
</ul>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">Region内的卡表: <span class="hljs-section">[0]</span><span class="hljs-section">[1]</span><span class="hljs-section">[0]</span><span class="hljs-section">[1]</span><span class="hljs-section">[0]</span>
                  ↑  ↑  ↑  ↑  ↑
               干净 脏 干净 脏 干净
</code></pre>
<p><strong>RSet的优势与代价</strong>:</p>
<p>优势:</p>
<ul>
<li>Young GC无需全堆扫描,只扫描RSet记录的Region</li>
<li>大幅提升Young GC速度</li>
<li>支持部分回收(只回收部分Region)</li>
</ul>
<p>代价:</p>
<ul>
<li>RSet占用额外内存(约堆大小的5-10%)</li>
<li>写屏障带来额外CPU开销</li>
<li>每次引用更新都需要维护RSet</li>
</ul>
<h3 data-id="heading-9">2.2 G1的垃圾回收流程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c6de1f77fc44246bad6faf842d12947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766831181&amp;x-signature=AX10mOz%2FGYPZEo0S%2BhXLISxSoY4%3D" alt="g1-gc-flow.svg" loading="lazy"/></p>
<p>G1的GC流程包括三种类型:Young GC、Mixed GC和Full GC。</p>
<h4 data-id="heading-10">2.2.1 Young GC (纯年轻代回收)</h4>
<p><strong>触发条件</strong>: Eden Region满</p>
<p><strong>回收过程</strong> (STW停顿):</p>
<ol>
<li><strong>暂停应用线程</strong> (STW开始)</li>
<li><strong>扫描GC Roots</strong>: 线程栈、全局变量、JNI句柄等</li>
<li><strong>扫描RSet</strong>: 找出老年代Region对年轻代的引用</li>
<li><strong>复制存活对象</strong>:
<ul>
<li>Eden和Survivor中的存活对象复制到新的Survivor Region</li>
<li>年龄达到阈值(默认15)的对象晋升到Old Region</li>
</ul>
</li>
<li><strong>清空Eden</strong>: 所有Eden Region标记为空闲</li>
<li><strong>恢复应用线程</strong> (STW结束)</li>
</ol>
<p><strong>停顿时间</strong>: 20-100ms (取决于堆大小和存活对象数量)</p>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">GC前:
<span class="hljs-section">[E]</span><span class="hljs-section">[E]</span><span class="hljs-section">[E]</span><span class="hljs-section">[E]</span><span class="hljs-section">[S]</span><span class="hljs-section">[S]</span><span class="hljs-section">[O]</span><span class="hljs-section">[O]</span><span class="hljs-section">[F]</span><span class="hljs-section">[F]</span>
 ↑  ↑  ↑  ↑  ↑  ↑
Eden满,触发Young GC

GC后:
<span class="hljs-section">[F]</span><span class="hljs-section">[F]</span><span class="hljs-section">[F]</span><span class="hljs-section">[F]</span><span class="hljs-section">[S]</span><span class="hljs-section">[S]</span><span class="hljs-section">[O]</span><span class="hljs-section">[O]</span><span class="hljs-section">[F]</span><span class="hljs-section">[F]</span>
                ↑  ↑  ↑
          新的Survivor, 部分晋升到Old
</code></pre>
<h4 data-id="heading-11">2.2.2 Mixed GC (混合回收)</h4>
<p><strong>触发条件</strong>:</p>
<ol>
<li>并发标记周期完成</li>
<li>老年代使用率 ≥ <code>InitiatingHeapOccupancyPercent</code> (默认45%)</li>
</ol>
<p><strong>回收范围</strong>:</p>
<ul>
<li>年轻代(全部Eden + Survivor)</li>
<li>部分老年代Region (垃圾最多的)</li>
</ul>
<p><strong>核心策略: Garbage-First</strong></p>
<p>G1根据<code>MaxGCPauseMillis</code>目标,选择垃圾最多的老年代Region回收:</p>
<pre><code class="hljs language-erlang" lang="erlang">假设有<span class="hljs-number">10</span>个Old Region,垃圾占比分别为:
Region1: <span class="hljs-number">90</span><span class="hljs-comment">%</span>
Region2: <span class="hljs-number">85</span><span class="hljs-comment">%</span>
Region3: <span class="hljs-number">70</span><span class="hljs-comment">%</span>
Region4: <span class="hljs-number">50</span><span class="hljs-comment">%</span>
...

G1优先选择Region1、Region2、Region3回收,
在停顿时间允许范围内,尽可能多回收Region。
</code></pre>
<p><strong>停顿控制</strong>:</p>
<p>G1通过<code>MaxGCPauseMillis</code>控制停顿时间:</p>
<pre><code class="hljs language-bash" lang="bash">-XX:MaxGCPauseMillis=200  <span class="hljs-comment"># 期望最大停顿200ms</span>
</code></pre>
<p>注意: 这是软目标,G1会尽力达成但不保证。</p>
<p><strong>停顿时间</strong>: 50-200ms (可通过参数控制)</p>
<p><strong>多次Mixed GC</strong>:</p>
<p>一个并发标记周期后,可能触发多次Mixed GC,逐步回收老年代垃圾。</p>
<h4 data-id="heading-12">2.2.3 并发标记周期 (Concurrent Marking Cycle)</h4>
<p>并发标记周期是Mixed GC的前置阶段,用于标记老年代中的存活对象,确定哪些Region需要回收。</p>
<p><strong>阶段1: 初始标记 (Initial Mark, STW)</strong></p>
<ul>
<li><strong>STW停顿</strong>: 几毫秒</li>
<li><strong>工作</strong>: 标记GC Roots直接可达对象</li>
<li><strong>优化</strong>: 借用Young GC的STW,无额外停顿</li>
</ul>
<p><strong>阶段2: 并发标记 (Concurrent Mark, 并发)</strong></p>
<ul>
<li><strong>并发执行</strong>: 应用线程继续运行</li>
<li><strong>工作</strong>: 遍历整个对象图,标记所有存活对象</li>
<li><strong>耗时</strong>: 几百毫秒到几秒</li>
</ul>
<p><strong>阶段3: 最终标记 (Final Mark, STW)</strong></p>
<ul>
<li><strong>STW停顿</strong>: 几十毫秒</li>
<li><strong>工作</strong>: 处理SATB队列,修正并发标记期间的引用变化</li>
</ul>
<p><strong>阶段4: 清理 (Cleanup, 部分STW)</strong></p>
<ul>
<li><strong>STW部分</strong>: 统计Region存活率 (几毫秒)</li>
<li><strong>并发部分</strong>: 清理完全空的Region (几十毫秒)</li>
</ul>
<p><strong>完整流程</strong>:</p>
<pre><code class="hljs language-scss" lang="scss">初始标记 → 并发标记 → 最终标记 → 清理 → 触发Mixed GC
 (STW)     (并发)     (STW)    (部分STW)
</code></pre>
<h3 data-id="heading-13">2.3 SATB算法详解</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ebab0f2dd8b4fe9b2c0a9c04a90f1b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766831181&amp;x-signature=LLMz6uWL%2FqcDtxNAbuNuX7d9XDI%3D" alt="tricolor-satb.svg" loading="lazy"/></p>
<h4 data-id="heading-14">2.3.1 三色标记算法</h4>
<p>G1使用三色标记算法进行并发标记:</p>
<ul>
<li><strong>白色对象</strong>: 未标记,可能是垃圾</li>
<li><strong>灰色对象</strong>: 已标记,但子对象未扫描</li>
<li><strong>黑色对象</strong>: 已标记,且子对象已扫描</li>
</ul>
<p><strong>标记流程</strong>:</p>
<ol>
<li>初始: 所有对象为白色</li>
<li>GC Roots标记为灰色</li>
<li>从灰色对象队列取出对象,扫描其引用:
<ul>
<li>引用对象标记为灰色</li>
<li>当前对象标记为黑色</li>
</ul>
</li>
<li>重复步骤3,直到灰色对象队列为空</li>
<li>剩余白色对象 = 垃圾,回收</li>
</ol>
<p><strong>不变式</strong>: 黑色对象不能直接引用白色对象</p>
<p>若违反,可能导致对象漏标:</p>
<ul>
<li>黑色对象已扫描完成</li>
<li>新增白色引用不会被发现</li>
<li>白色对象被误认为垃圾</li>
<li><strong>存活对象被错误回收!</strong></li>
</ul>
<h4 data-id="heading-15">2.3.2 并发标记的问题</h4>
<p>并发标记期间,应用线程可能修改对象引用,导致对象漏标。</p>
<p><strong>对象漏标的两个充要条件</strong>:</p>
<ol>
<li>黑色对象新增对白色对象的引用</li>
<li>灰色对象删除对白色对象的引用</li>
</ol>
<p><strong>示例</strong>:</p>
<p>初始状态:</p>
<pre><code class="hljs language-scss" lang="scss">GC Root (黑) → 对象<span class="hljs-selector-tag">A</span> (灰) → 对象<span class="hljs-selector-tag">B</span> (白)
</code></pre>
<p>并发期间,应用线程执行:</p>
<pre><code class="hljs language-java" lang="java">root.fieldB = objectB;  <span class="hljs-comment">// 黑→白引用</span>
objectA.fieldB = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 删除灰→白引用</span>
</code></pre>
<p>结果:</p>
<pre><code class="hljs language-scss" lang="scss">GC Root (黑) → 对象<span class="hljs-selector-tag">B</span> (白)
</code></pre>
<p>问题:</p>
<ul>
<li>GC Root(黑)已扫描完,不会再扫描</li>
<li>对象A(灰)删除引用,不会访问B</li>
<li>对象B(白)没有其他引用路径</li>
<li><strong>对象B被误认为垃圾,错误回收!</strong></li>
</ul>
<h4 data-id="heading-16">2.3.3 SATB (Snapshot-At-The-Beginning) 解决方案</h4>
<p><strong>核心思想</strong>: 标记开始时的对象快照(逻辑快照,非物理快照)</p>
<p><strong>写屏障实现</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// G1的SATB写屏障 (前置屏障)</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">oop_field_store</span><span class="hljs-params">(oop* field, oop new_value)</span> {
  <span class="hljs-type">oop</span> <span class="hljs-variable">old_value</span> <span class="hljs-operator">=</span> *field;  <span class="hljs-comment">// 1. 读取旧值</span>
  <span class="hljs-keyword">if</span> (old_value != <span class="hljs-literal">null</span> &amp;&amp; is_marking_active()) {
    satb_enqueue(old_value);  <span class="hljs-comment">// 2. 保存旧值到SATB队列</span>
  }
  *field = new_value;  <span class="hljs-comment">// 3. 执行实际的引用更新</span>
}
</code></pre>
<p><strong>为什么记录旧值而不是新值?</strong></p>
<ul>
<li>SATB目标: 保证标记开始时的快照中的所有存活对象都被标记</li>
<li>旧值可能是唯一引用路径,删除后对象会孤立</li>
<li>新值会在并发标记中正常扫描到</li>
</ul>
<p><strong>SATB队列处理</strong>:</p>
<ul>
<li>每个线程维护一个本地SATB队列</li>
<li>队列满时,转移到全局队列</li>
<li>最终标记阶段,GC线程处理所有SATB队列</li>
<li>从队列中的对象重新扫描,标记为灰色</li>
</ul>
<p><strong>SATB的保守性</strong>:</p>
<ul>
<li>可能标记一些已经死亡的对象(浮动垃圾)</li>
<li>牺牲部分精度,换取不漏标的保证</li>
<li>浮动垃圾在下一次GC会被回收</li>
</ul>
<h3 data-id="heading-17">2.4 G1的参数调优</h3>
<h4 data-id="heading-18">2.4.1 核心参数</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用G1</span>
-XX:+UseG1GC

<span class="hljs-comment"># 期望最大停顿时间 (软目标)</span>
-XX:MaxGCPauseMillis=200  <span class="hljs-comment"># 默认200ms</span>

<span class="hljs-comment"># 堆大小 (建议Xms = Xmx)</span>
-Xms4g -Xmx4g

<span class="hljs-comment"># Region大小 (1MB-32MB,必须是2的幂)</span>
-XX:G1HeapRegionSize=8m

<span class="hljs-comment"># 老年代占用率达到此阈值时触发并发标记</span>
-XX:InitiatingHeapOccupancyPercent=45  <span class="hljs-comment"># 默认45%</span>

<span class="hljs-comment"># 保留空间,防止晋升失败</span>
-XX:G1ReservePercent=10  <span class="hljs-comment"># 默认10%</span>

<span class="hljs-comment"># 新生代大小范围</span>
-XX:G1NewSizePercent=5       <span class="hljs-comment"># 新生代最小占比5%</span>
-XX:G1MaxNewSizePercent=60   <span class="hljs-comment"># 新生代最大占比60%</span>

<span class="hljs-comment"># 并发标记线程数 (默认ParallelGCThreads/4)</span>
-XX:ConcGCThreads=4

<span class="hljs-comment"># 并行GC线程数 (默认等于CPU核心数)</span>
-XX:ParallelGCThreads=8
</code></pre>
<h4 data-id="heading-19">2.4.2 完整配置示例</h4>
<p><strong>Web应用 (4核8GB,堆4GB)</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms4g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:G1HeapRegionSize=8m \
     -XX:InitiatingHeapOccupancyPercent=45 \
     -XX:G1ReservePercent=10 \
     -XX:MetaspaceSize=256m \
     -XX:MaxMetaspaceSize=512m \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/var/log/heapdump.hprof \
     -Xloggc:/var/log/gc.log \
     -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -jar application.jar
</code></pre>
<p><strong>大内存应用 (16核32GB,堆24GB)</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms24g -Xmx24g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=100 \
     -XX:G1HeapRegionSize=16m \
     -XX:InitiatingHeapOccupancyPercent=40 \
     -XX:G1ReservePercent=15 \
     -XX:ConcGCThreads=4 \
     -XX:ParallelGCThreads=16 \
     -XX:MetaspaceSize=512m \
     -XX:MaxMetaspaceSize=1g \
     -Xloggc:/var/log/gc.log \
     -jar application.jar
</code></pre>
<hr/>
<h2 data-id="heading-20">三、ZGC垃圾收集器原理</h2>
<h3 data-id="heading-21">3.1 ZGC的整体架构</h3>
<p>ZGC是JDK 11引入的超低延迟垃圾收集器,目标是实现停顿时间 &lt; 10ms,与堆大小无关。</p>
<h4 data-id="heading-22">3.1.1 核心技术</h4>
<p>ZGC的三大核心技术:</p>
<ol>
<li><strong>染色指针 (Colored Pointers)</strong>: 将GC信息存储在指针中</li>
<li><strong>读屏障 (Load Barrier)</strong>: 对象访问时自动处理重定位</li>
<li><strong>并发重定位</strong>: 对象移动与应用线程并发执行</li>
</ol>
<h3 data-id="heading-23">3.2 染色指针 (Colored Pointers)</h3>
<p><img src="images/07/zgc-colored-pointers.svg" alt="ZGC染色指针结构" loading="lazy"/></p>
<h4 data-id="heading-24">3.2.1 64位指针布局</h4>
<p>ZGC利用64位指针的高位存储GC信息:</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">63</span>              <span class="hljs-number">47</span> <span class="hljs-number">46</span> <span class="hljs-number">45</span> <span class="hljs-number">44</span> <span class="hljs-number">43</span> <span class="hljs-number">42</span>                                        <span class="hljs-number">0</span>
┌────────────────┬──┬──┬──┬──┬────┬──────────────────────────────────────┐
│   Reserved     │Fi│Re│M1│M0│Res │      <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">Address</span> (<span class="hljs-number">42</span>位)           │
│   (<span class="hljs-number">16</span>位)       │na│ma│ar│ar│erv │                                      │
│                │<span class="hljs-selector-tag">li</span>│pp│ke│ke│ed  │                                      │
│                │za│ed│d1│d0│(<span class="hljs-number">2</span>) │                                      │
└────────────────┴──┴──┴──┴──┴────┴──────────────────────────────────────┘
</code></pre>
<p><strong>元数据位 [47:42]</strong>:</p>
<ul>
<li><strong>Marked0 (位44)</strong>: 奇数轮并发标记,标记为1表示对象存活</li>
<li><strong>Marked1 (位45)</strong>: 偶数轮并发标记,标记为1表示对象存活</li>
<li><strong>Remapped (位46)</strong>: 标记对象是否已重定位,1表示已移动到新地址</li>
<li><strong>Finalizable (位47)</strong>: 标记对象是否可终结,1表示有finalize方法</li>
</ul>
<p><strong>对象地址 [41:0]</strong>:</p>
<ul>
<li>42位地址可寻址 4TB (2^42 = 4TB)</li>
<li>Linux x86-64仅使用低48位</li>
</ul>
<h4 data-id="heading-25">3.2.2 为什么需要两个Marked位?</h4>
<p>ZGC每轮GC交替使用Marked0和Marked1:</p>
<ul>
<li>第1轮GC: 使用Marked0 (Marked0=1表示存活)</li>
<li>第2轮GC: 使用Marked1 (Marked1=1表示存活)</li>
</ul>
<p><strong>好处</strong>: 无需重置所有对象的标记位,直接切换使用哪个位即可。</p>
<p>例如:</p>
<ul>
<li>第1轮GC后,Marked0=1的对象是存活的</li>
<li>第2轮GC开始时,直接使用Marked1,无需清除Marked0</li>
</ul>
<h4 data-id="heading-26">3.2.3 染色指针的优势</h4>
<p><strong>1. 一次性标记</strong></p>
<p>无需遍历对象图,直接通过指针颜色判断对象状态:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查对象是否已标记</span>
<span class="hljs-type">boolean</span> <span class="hljs-title function_">is_marked</span><span class="hljs-params">(Object* ptr)</span> {
  <span class="hljs-keyword">return</span> (ptr &amp; MARKED_BIT) != <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>2. 并发重定位</strong></p>
<p>对象移动后,旧指针通过读屏障自动重定向到新地址,无需STW更新所有引用。</p>
<p><strong>3. 多代视图</strong></p>
<p>同一物理地址,通过不同颜色的指针,可以同时表示旧对象和新对象。</p>
<p><strong>4. 低延迟</strong></p>
<p>配合读屏障和多重映射,实现接近零停顿的GC (STW通常 &lt; 10ms)。</p>
<h3 data-id="heading-27">3.3 读屏障 (Load Barrier)</h3>
<p>ZGC使用读屏障(而不是写屏障)来实现并发重定位。</p>
<p><strong>读屏障伪代码</strong>:</p>
<pre><code class="hljs language-java" lang="java">Object <span class="hljs-title function_">load</span><span class="hljs-params">(Object* addr)</span> {
  <span class="hljs-type">Object</span> <span class="hljs-variable">ptr</span> <span class="hljs-operator">=</span> *addr;  <span class="hljs-comment">// 1. 读取指针</span>

  <span class="hljs-comment">// 2. 检查指针的颜色位</span>
  <span class="hljs-keyword">if</span> (is_good_color(ptr)) {
    <span class="hljs-keyword">return</span> ptr;  <span class="hljs-comment">// 颜色正确,直接返回</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> slow_path(ptr);  <span class="hljs-comment">// 颜色不对,进入慢速路径 (重定位/标记)</span>
  }
}
</code></pre>
<p><strong>快速路径</strong>: 颜色正确,直接返回指针 (几乎无开销)</p>
<p><strong>慢速路径</strong>: 颜色不对,进行重定位或标记,然后更新指针颜色</p>
<p><strong>优势</strong>:</p>
<ul>
<li>对象移动后,旧指针通过读屏障自动重定向到新地址</li>
<li>应用线程访问时自动完成重定位,无需STW</li>
</ul>
<p><strong>缺点</strong>:</p>
<ul>
<li>读操作有额外开销 (但现代CPU分支预测优化后影响很小)</li>
</ul>
<h3 data-id="heading-28">3.4 ZGC的垃圾回收流程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fef8decbcab344748d4128ccfb7a4779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766831181&amp;x-signature=xnCkYJ58A2hitKJ3%2Bqy3XFPwi88%3D" alt="zgc-gc-flow.svg" loading="lazy"/></p>
<p>ZGC的GC流程包括7个阶段,只有3个极短的STW阶段。</p>
<h4 data-id="heading-29">3.4.1 阶段1: Pause Mark Start (初始标记 - STW)</h4>
<ul>
<li><strong>STW停顿</strong>: ~1ms</li>
<li><strong>工作</strong>: 标记GC Roots直接可达对象</li>
<li><strong>颜色指针</strong>: 设置当前使用的Marked位 (Marked0或Marked1)</li>
</ul>
<h4 data-id="heading-30">3.4.2 阶段2: Concurrent Mark (并发标记)</h4>
<ul>
<li><strong>并发执行</strong>: 应用线程继续运行</li>
<li><strong>工作</strong>: 遍历整个对象图,标记所有可达对象</li>
<li><strong>颜色指针</strong>:
<ul>
<li>已标记对象: Marked位 = 1</li>
<li>未标记对象: Marked位 = 0 (垃圾候选)</li>
</ul>
</li>
</ul>
<h4 data-id="heading-31">3.4.3 阶段3: Pause Mark End (最终标记 - STW)</h4>
<ul>
<li><strong>STW停顿</strong>: ~1ms</li>
<li><strong>工作</strong>: 处理并发标记期间的弱引用、软引用等</li>
<li><strong>选择回收对象</strong>: Marked位 = 0 的对象为垃圾</li>
</ul>
<h4 data-id="heading-32">3.4.4 阶段4: Concurrent Process Non-Strong References (处理弱引用)</h4>
<ul>
<li><strong>并发执行</strong>: 处理软引用、弱引用、虚引用、Finalizer</li>
<li><strong>工作</strong>:
<ul>
<li>处理软引用: 根据内存情况决定是否回收</li>
<li>处理弱引用: 标记阶段未标记的对象,弱引用指向的对象会被回收</li>
<li>处理虚引用</li>
<li>处理Finalizer: 调用finalize()方法</li>
</ul>
</li>
</ul>
<h4 data-id="heading-33">3.4.5 阶段5: Concurrent Reset Relocation Set (重置重定位集)</h4>
<ul>
<li><strong>并发执行</strong>: 准备重定位,重置上一次GC的重定位映射表</li>
<li><strong>工作</strong>: 清理上一次GC的转发表 (Forwarding Table)</li>
</ul>
<h4 data-id="heading-34">3.4.6 阶段6: Pause Relocate Start (开始重定位 - STW)</h4>
<ul>
<li><strong>STW停顿</strong>: ~1ms</li>
<li><strong>工作</strong>: 重定位GC Roots直接引用的对象,更新GC Roots中的引用指针</li>
<li><strong>颜色指针</strong>:
<ul>
<li>已重定位对象: Remapped位 = 1</li>
<li>更新指针指向新地址</li>
</ul>
</li>
</ul>
<h4 data-id="heading-35">3.4.7 阶段7: Concurrent Relocate (并发重定位)</h4>
<ul>
<li><strong>并发执行</strong>: 移动对象,更新引用指针</li>
<li><strong>工作</strong>:
<ul>
<li>遍历Relocation Set中的Page,将存活对象移动到新Page</li>
<li>建立转发表 (Forwarding Table): 记录旧地址 → 新地址映射</li>
<li>通过读屏障,应用线程访问旧地址时自动转发到新地址</li>
</ul>
</li>
</ul>
<p><strong>读屏障的作用</strong>:</p>
<p>并发重定位期间,应用线程如何访问已移动的对象?</p>
<p>场景: GC线程已将对象A从地址0x1000移动到0x2000,但应用线程持有旧指针0x1000</p>
<ol>
<li>应用线程访问对象A: <code>obj = *ptr;</code> (触发读屏障)</li>
<li>读屏障检查颜色位:
<ul>
<li>Remapped = 0: 对象还在旧地址,直接返回</li>
<li>Remapped = 1: 对象已移动,查询转发表获取新地址</li>
</ul>
</li>
<li>转发到新地址:
<ul>
<li>从转发表查询: 0x1000 → 0x2000</li>
<li>返回新地址的对象</li>
<li>更新指针为新地址 (可选优化)</li>
</ul>
</li>
</ol>
<h3 data-id="heading-36">3.5 多重映射内存管理</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da1b1805c4a74a599643973ffa89e987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766831181&amp;x-signature=pDIQ9cgwlDBtCqg1ejFoiVLfgTg%3D" alt="zgc-multi-mapping.svg" loading="lazy"/></p>
<h4 data-id="heading-37">3.5.1 核心思想</h4>
<p>ZGC将同一块物理内存映射到3个不同的虚拟地址空间:</p>
<ul>
<li><strong>Marked0 View</strong>: Marked0=1 的指针访问此视图</li>
<li><strong>Marked1 View</strong>: Marked1=1 的指针访问此视图</li>
<li><strong>Remapped View</strong>: Remapped=1 的指针访问此视图</li>
</ul>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-sql" lang="sql">虚拟地址空间:
┌─────────────────┐
│ Marked0 <span class="hljs-keyword">View</span>    │ <span class="hljs-number">0x0000</span>_0000_0000 <span class="hljs-operator">-</span> <span class="hljs-number">0x0000</span>_03FF_FFFF
│ (虚拟地址)      │
└────────┬────────┘
         │ 映射
         ↓
┌─────────────────┐
│ 物理内存        │ <span class="hljs-number">0x1000</span>_0000 <span class="hljs-operator">-</span> <span class="hljs-number">0x13FF</span>_FFFF (<span class="hljs-number">64</span>MB)
│ (对象A, B, C...)│
└────────┬────────┘
         ↑ 映射
         │
┌─────────────────┐
│ Remapped <span class="hljs-keyword">View</span>   │ <span class="hljs-number">0x0000</span>_0800_0000 <span class="hljs-operator">-</span> <span class="hljs-number">0x0000</span>_0BFF_FFFF
│ (虚拟地址)      │
└─────────────────┘
</code></pre>
<h4 data-id="heading-38">3.5.2 工作原理</h4>
<p><strong>场景</strong>: 将对象A从物理地址0x1000_1000 重定位到 0x1000_5000</p>
<p><strong>步骤1: 并发标记阶段 (使用Marked0视图)</strong></p>
<ul>
<li>对象A的指针: 0x0001_0000_1000 (Marked0=1)</li>
<li>通过Marked0视图访问物理地址 0x1000_1000</li>
<li>虚拟地址: 0x0000_0000_1000 → 物理地址: 0x1000_1000</li>
</ul>
<p><strong>步骤2: 并发重定位阶段 (切换到Remapped视图)</strong></p>
<ul>
<li>GC线程将对象A复制到新物理地址 0x1000_5000</li>
<li>创建转发表: 0x1000_1000 → 0x1000_5000</li>
<li>新指针: 0x0004_0000_5000 (Remapped=1)</li>
<li>通过Remapped视图访问新物理地址 0x1000_5000</li>
<li>虚拟地址: 0x0000_0800_5000 → 物理地址: 0x1000_5000</li>
</ul>
<p><strong>步骤3: 读屏障处理旧指针</strong></p>
<ul>
<li>应用线程持有旧指针: 0x0001_0000_1000</li>
<li>读屏障检查Marked0=1, Remapped=0</li>
<li>查询转发表: 0x1000_1000 → 0x1000_5000</li>
<li>返回新地址对象</li>
<li>可选: 更新指针为 0x0004_0000_5000</li>
</ul>
<h4 data-id="heading-39">3.5.3 多重映射的优势</h4>
<p><strong>✅ 无需物理复制</strong></p>
<ul>
<li>对象重定位只需切换指针颜色位</li>
<li>无需复制对象数据</li>
<li>极大减少GC开销</li>
</ul>
<p><strong>✅ 并发安全</strong></p>
<ul>
<li>旧视图和新视图同时有效</li>
<li>应用线程通过读屏障自动转发</li>
<li>无需STW更新所有引用</li>
</ul>
<p><strong>✅ 多代切换</strong></p>
<ul>
<li>Marked0/Marked1 交替使用</li>
<li>无需清除上一轮标记位</li>
<li>节省标记重置时间</li>
</ul>
<p><strong>✅ 支持大堆</strong></p>
<ul>
<li>42位地址支持4TB堆</li>
<li>停顿时间与堆大小无关</li>
</ul>
<p><strong>❌ 缺点: 虚拟地址空间开销</strong></p>
<ul>
<li>需要3倍虚拟地址空间</li>
<li>Linux x86-64: 128TB虚拟地址空间,足够使用</li>
</ul>
<p><strong>❌ 缺点: 读屏障开销</strong></p>
<ul>
<li>每次读取对象引用都需要检查</li>
<li>现代CPU分支预测优化后影响较小</li>
</ul>
<h3 data-id="heading-40">3.6 ZGC的参数调优</h3>
<h4 data-id="heading-41">3.6.1 核心参数</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用ZGC</span>
-XX:+UseZGC

<span class="hljs-comment"># 堆大小 (建议Xms = Xmx)</span>
-Xms16g -Xmx16g

<span class="hljs-comment"># 并发GC线程数 (默认ParallelGCThreads/4)</span>
-XX:ConcGCThreads=4

<span class="hljs-comment"># 并行GC线程数 (默认等于CPU核心数)</span>
-XX:ParallelGCThreads=8

<span class="hljs-comment"># 软最大堆大小 (ZGC会尽力不超过此值)</span>
-XX:SoftMaxHeapSize=14g

<span class="hljs-comment"># 元空间</span>
-XX:MetaspaceSize=256m
-XX:MaxMetaspaceSize=512m
</code></pre>
<h4 data-id="heading-42">3.6.2 完整配置示例</h4>
<p><strong>大内存应用 (16核32GB,堆24GB)</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms24g -Xmx24g \
     -XX:+UseZGC \
     -XX:ConcGCThreads=4 \
     -XX:ParallelGCThreads=16 \
     -XX:SoftMaxHeapSize=20g \
     -XX:MetaspaceSize=512m \
     -XX:MaxMetaspaceSize=1g \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/var/log/heapdump.hprof \
     -Xlog:gc*:file=/var/log/gc.log:time,<span class="hljs-built_in">uptime</span>,level,tags \
     -jar application.jar
</code></pre>
<p><strong>超大堆应用 (32核128GB,堆96GB)</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms96g -Xmx96g \
     -XX:+UseZGC \
     -XX:ConcGCThreads=8 \
     -XX:ParallelGCThreads=32 \
     -XX:SoftMaxHeapSize=80g \
     -XX:MetaspaceSize=1g \
     -XX:MaxMetaspaceSize=2g \
     -Xlog:gc*:file=/var/log/gc.log:time,<span class="hljs-built_in">uptime</span>,level,tags \
     -jar application.jar
</code></pre>
<hr/>
<h2 data-id="heading-43">四、G1 vs ZGC对比分析</h2>
<h3 data-id="heading-44">4.1 核心技术对比</h3>








































<table><thead><tr><th>维度</th><th>G1</th><th>ZGC</th></tr></thead><tbody><tr><td><strong>分区设计</strong></td><td>Region分区 (1MB-32MB)</td><td>Page分区 (2MB, 32KB, 256KB三种)</td></tr><tr><td><strong>标记算法</strong></td><td>三色标记 + SATB</td><td>三色标记 + 染色指针</td></tr><tr><td><strong>屏障类型</strong></td><td>写屏障 (维护RSet) + 前置写屏障 (SATB)</td><td>读屏障 (Load Barrier)</td></tr><tr><td><strong>重定位</strong></td><td>复制算法 (STW)</td><td>并发重定位 (读屏障 + 转发表)</td></tr><tr><td><strong>内存管理</strong></td><td>单一视图</td><td>多重映射 (3个视图)</td></tr><tr><td><strong>GC信息存储</strong></td><td>对象头 (Mark Word)</td><td>指针元数据位</td></tr></tbody></table>
<h3 data-id="heading-45">4.2 性能对比</h3>








































<table><thead><tr><th>指标</th><th>G1</th><th>ZGC</th></tr></thead><tbody><tr><td><strong>停顿时间</strong></td><td>50-200ms</td><td>&lt; 10ms (通常 &lt; 1ms)</td></tr><tr><td><strong>吞吐量</strong></td><td>95-98%</td><td>85-95%</td></tr><tr><td><strong>堆大小</strong></td><td>4GB - 64GB (最佳)</td><td>8GB - 16TB</td></tr><tr><td><strong>适用场景</strong></td><td>通用场景,平衡性能</td><td>超大堆,极低延迟</td></tr><tr><td><strong>CPU开销</strong></td><td>中等</td><td>较高 (读屏障)</td></tr><tr><td><strong>内存开销</strong></td><td>RSet占5-10%</td><td>虚拟地址空间3倍 (物理内存不增加)</td></tr></tbody></table>
<h3 data-id="heading-46">4.3 GC流程对比</h3>



































<table><thead><tr><th>GC阶段</th><th>G1</th><th>ZGC</th></tr></thead><tbody><tr><td><strong>Young GC</strong></td><td>STW,20-100ms</td><td>无独立Young GC,统一流程</td></tr><tr><td><strong>并发标记</strong></td><td>4阶段,2个STW (初始/最终标记)</td><td>7阶段,3个STW (每个 &lt; 1ms)</td></tr><tr><td><strong>Mixed GC</strong></td><td>STW,50-200ms,回收部分老年代</td><td>无Mixed GC概念</td></tr><tr><td><strong>重定位</strong></td><td>STW,复制对象</td><td>并发,无STW</td></tr><tr><td><strong>Full GC</strong></td><td>可能发生,停顿几秒</td><td>几乎不发生</td></tr></tbody></table>
<h3 data-id="heading-47">4.4 参数复杂度对比</h3>






























<table><thead><tr><th>维度</th><th>G1</th><th>ZGC</th></tr></thead><tbody><tr><td><strong>核心参数</strong></td><td>~10个</td><td>~5个</td></tr><tr><td><strong>调优难度</strong></td><td>中等</td><td>低</td></tr><tr><td><strong>自适应能力</strong></td><td>较强</td><td>极强</td></tr><tr><td><strong>默认配置</strong></td><td>适用大多数场景</td><td>开箱即用</td></tr></tbody></table>
<h3 data-id="heading-48">4.5 选择建议</h3>
<p><strong>选择G1的场景</strong>:</p>
<p>✅ 堆内存 4GB - 64GB
✅ 停顿时间要求 50-200ms
✅ 追求吞吐量和延迟的平衡
✅ 通用互联网应用,电商,社交,内容平台
✅ 微服务架构</p>
<p><strong>选择ZGC的场景</strong>:</p>
<p>✅ 堆内存 ≥ 16GB,甚至TB级
✅ 停顿时间要求 &lt; 10ms
✅ 低延迟优先级高于吞吐量
✅ 金融交易系统,实时竞价,游戏服务器
✅ 大数据实时处理,流计算</p>
<hr/>
<h2 data-id="heading-49">五、生产环境应用场景</h2>
<h3 data-id="heading-50">5.1 电商秒杀系统 (选择G1)</h3>
<p><strong>业务特点</strong>:</p>
<ul>
<li>流量峰值: 秒杀活动瞬时QPS从1000飙升至10万</li>
<li>堆内存: 8GB</li>
<li>对象生命周期: 大部分对象短生命周期(HTTP请求对象、缓存对象)</li>
<li>延迟要求: TP99 &lt; 200ms</li>
</ul>
<p><strong>为什么选择G1</strong>:</p>
<ul>
<li>堆内存8GB,G1适用范围</li>
<li>动态调整新生代大小,应对流量峰值</li>
<li>Young GC频繁但停顿时间短(50ms)</li>
<li>Mixed GC可控制在100ms内</li>
</ul>
<p><strong>G1配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms8g -Xmx8g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=100 \
     -XX:G1HeapRegionSize=8m \
     -XX:InitiatingHeapOccupancyPercent=40 \
     -XX:G1ReservePercent=15 \
     -XX:MetaspaceSize=256m \
     -XX:MaxMetaspaceSize=512m \
     -Xloggc:/var/log/gc.log \
     -jar seckill-service.jar
</code></pre>
<p><strong>效果</strong>:</p>






























<table><thead><tr><th>指标</th><th>调优前 (Parallel GC)</th><th>调优后 (G1)</th></tr></thead><tbody><tr><td>TP99延迟</td><td>500ms</td><td>150ms</td></tr><tr><td>GC停顿</td><td>200-500ms</td><td>50-100ms</td></tr><tr><td>吞吐量</td><td>95%</td><td>96%</td></tr><tr><td>Full GC频率</td><td>每小时2次</td><td>基本无Full GC</td></tr></tbody></table>
<h3 data-id="heading-51">5.2 金融支付系统 (选择ZGC)</h3>
<p><strong>业务特点</strong>:</p>
<ul>
<li>流量: 稳定QPS 5000,峰值1万</li>
<li>堆内存: 32GB</li>
<li>延迟要求: <strong>极低延迟,TP99 &lt; 50ms,任何超过100ms的停顿都可能导致交易失败</strong></li>
<li>监管要求: 支付响应时间 &lt; 100ms</li>
</ul>
<p><strong>为什么选择ZGC</strong>:</p>
<ul>
<li>堆内存32GB,G1的Full GC可能达到1-2秒,不可接受</li>
<li>ZGC停顿时间 &lt; 10ms,与堆大小无关</li>
<li>金融系统对延迟敏感,愿意牺牲5-10%吞吐量换取极低停顿</li>
</ul>
<p><strong>ZGC配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms32g -Xmx32g \
     -XX:+UseZGC \
     -XX:ConcGCThreads=8 \
     -XX:ParallelGCThreads=16 \
     -XX:SoftMaxHeapSize=28g \
     -XX:MetaspaceSize=512m \
     -XX:MaxMetaspaceSize=1g \
     -Xlog:gc*:file=/var/log/gc.log:time,<span class="hljs-built_in">uptime</span>,level,tags \
     -jar payment-service.jar
</code></pre>
<p><strong>效果</strong>:</p>






























<table><thead><tr><th>指标</th><th>调优前 (G1)</th><th>调优后 (ZGC)</th></tr></thead><tbody><tr><td>TP99延迟</td><td>120ms</td><td>45ms</td></tr><tr><td>GC停顿</td><td>50-150ms</td><td>&lt; 5ms</td></tr><tr><td>吞吐量</td><td>97%</td><td>92%</td></tr><tr><td>Full GC停顿</td><td>偶尔1-2秒</td><td>无Full GC</td></tr></tbody></table>
<h3 data-id="heading-52">5.3 大数据实时计算 (选择ZGC)</h3>
<p><strong>业务特点</strong>:</p>
<ul>
<li>实时流处理: Flink任务,处理10亿条/天的日志数据</li>
<li>堆内存: 64GB</li>
<li>对象生命周期: 中长生命周期(状态数据、窗口数据)</li>
<li>延迟要求: 处理延迟 &lt; 1秒,GC停顿不能影响实时性</li>
</ul>
<p><strong>为什么选择ZGC</strong>:</p>
<ul>
<li>堆内存64GB,G1的Mixed GC可能达到200-500ms</li>
<li>实时计算对延迟敏感,长时间GC导致数据积压</li>
<li>ZGC并发重定位,对计算线程影响最小</li>
</ul>
<p><strong>ZGC配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms64g -Xmx64g \
     -XX:+UseZGC \
     -XX:ConcGCThreads=16 \
     -XX:ParallelGCThreads=32 \
     -XX:SoftMaxHeapSize=56g \
     -XX:MetaspaceSize=1g \
     -XX:MaxMetaspaceSize=2g \
     -Xlog:gc*:file=/var/log/gc.log:time,<span class="hljs-built_in">uptime</span>,level,tags \
     -jar flink-taskmanager.jar
</code></pre>
<p><strong>效果</strong>:</p>






























<table><thead><tr><th>指标</th><th>调优前 (G1)</th><th>调优后 (ZGC)</th></tr></thead><tbody><tr><td>数据处理延迟</td><td>800ms</td><td>400ms</td></tr><tr><td>GC停顿</td><td>100-300ms</td><td>&lt; 8ms</td></tr><tr><td>吞吐量</td><td>96%</td><td>90%</td></tr><tr><td>数据积压</td><td>偶尔发生</td><td>基本无积压</td></tr></tbody></table>
<h3 data-id="heading-53">5.4 微服务网关 (选择G1)</h3>
<p><strong>业务特点</strong>:</p>
<ul>
<li>高并发: QPS 2万,峰值5万</li>
<li>堆内存: 4GB</li>
<li>对象生命周期: 极短(HTTP请求/响应对象)</li>
<li>延迟要求: TP99 &lt; 100ms</li>
</ul>
<p><strong>为什么选择G1</strong>:</p>
<ul>
<li>堆内存4GB,G1够用</li>
<li>对象生命周期极短,大部分在Eden区回收</li>
<li>Young GC频繁但停顿时间短</li>
<li>G1的吞吐量优于ZGC</li>
</ul>
<p><strong>G1配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">java -Xms4g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=50 \
     -XX:G1HeapRegionSize=4m \
     -XX:G1NewSizePercent=40 \
     -XX:G1MaxNewSizePercent=60 \
     -XX:MetaspaceSize=128m \
     -XX:MaxMetaspaceSize=256m \
     -Xloggc:/var/log/gc.log \
     -jar gateway-service.jar
</code></pre>
<p><strong>效果</strong>:</p>






























<table><thead><tr><th>指标</th><th>调优前 (CMS)</th><th>调优后 (G1)</th></tr></thead><tbody><tr><td>TP99延迟</td><td>150ms</td><td>80ms</td></tr><tr><td>GC停顿</td><td>20-100ms</td><td>20-50ms</td></tr><tr><td>吞吐量</td><td>93%</td><td>97%</td></tr><tr><td>Full GC频率</td><td>每天2-3次</td><td>基本无Full GC</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-54">六、生产案例与调优实战</h2>
<h3 data-id="heading-55">6.1 案例1: G1频繁Full GC</h3>
<p><strong>故障现象</strong>:</p>
<p>某电商系统(堆8GB)使用G1,生产环境每小时触发5-10次Full GC,每次停顿2-3秒,导致接口超时。</p>
<p><strong>排查过程</strong>:</p>
<p><strong>1. 查看GC日志</strong></p>
<pre><code class="hljs language-bash" lang="bash">grep <span class="hljs-string">"Full GC"</span> gc.log | <span class="hljs-built_in">tail</span> -20
</code></pre>
<p>发现Full GC频繁,回收效果差(只回收500MB)。</p>
<p><strong>2. 分析触发原因</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2024-01-15T14:23:45.123</span><span class="hljs-string">+0800:</span> <span class="hljs-attr">7890.456:</span> [<span class="hljs-string">Full</span> <span class="hljs-string">GC</span> <span class="hljs-string">(Allocation</span> <span class="hljs-string">Failure)</span> <span class="hljs-string">7680M-&gt;7280M(8192M)</span>, <span class="hljs-number">2.3456789</span> <span class="hljs-string">secs</span>]
</code></pre>
<p>触发原因: <code>Allocation Failure</code> → 对象分配失败,晋升失败。</p>
<p><strong>3. 查看堆使用情况</strong></p>
<pre><code class="hljs language-bash" lang="bash">jstat -gc &lt;pid&gt; 1000 10
</code></pre>
<p>发现老年代使用率持续在90%以上。</p>
<p><strong>4. dump内存分析</strong></p>
<pre><code class="hljs language-bash" lang="bash">jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;
</code></pre>
<p>使用MAT分析,发现大量<code>byte[]</code>对象,占用4GB内存,引用链:</p>
<pre><code class="hljs language-arduino" lang="arduino">CacheManager.<span class="hljs-built_in">imageCache</span> (<span class="hljs-type">static</span>)
  ↓
ConcurrentHashMap
  ↓
SoftReference&lt;<span class="hljs-type">byte</span>[]&gt;  ← 缓存的图片数据
</code></pre>
<p><strong>问题定位</strong>:</p>
<p>代码使用<code>SoftReference</code>缓存图片,但缓存没有上限,内存不足时集中回收导致频繁Full GC。</p>
<p><strong>解决方案</strong>:</p>
<p>使用Guava Cache替代SoftReference:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 修复前</span>
Map&lt;String, SoftReference&lt;<span class="hljs-type">byte</span>[]&gt;&gt; imageCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-comment">// 修复后</span>
Cache&lt;String, <span class="hljs-type">byte</span>[]&gt; imageCache = CacheBuilder.newBuilder()
    .maximumSize(<span class="hljs-number">5000</span>)              <span class="hljs-comment">// 限制5000个</span>
    .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)
    .build();
</code></pre>
<p><strong>调整G1参数</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 降低并发标记触发阈值,提前触发Mixed GC</span>
-XX:InitiatingHeapOccupancyPercent=35  <span class="hljs-comment"># 从45%降至35%</span>

<span class="hljs-comment"># 增加保留空间,防止晋升失败</span>
-XX:G1ReservePercent=15  <span class="hljs-comment"># 从10%增至15%</span>
</code></pre>
<p><strong>效果</strong>:</p>





























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>改善</th></tr></thead><tbody><tr><td>Full GC频率</td><td>每小时5-10次</td><td>基本无</td><td><strong>99%↓</strong></td></tr><tr><td>堆使用率</td><td>90%</td><td>60%</td><td><strong>33%↓</strong></td></tr><tr><td>TP99延迟</td><td>2500ms</td><td>120ms</td><td><strong>95%↓</strong></td></tr></tbody></table>
<h3 data-id="heading-56">6.2 案例2: ZGC内存泄漏</h3>
<p><strong>故障现象</strong>:</p>
<p>某支付系统(堆32GB)使用ZGC,运行3天后,堆使用率持续增长至95%,触发频繁GC,但回收效果差。</p>
<p><strong>排查过程</strong>:</p>
<p><strong>1. 查看GC日志</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">tail</span> -1000 gc.log | grep <span class="hljs-string">"Heap: "</span>
</code></pre>
<p>发现堆使用率从60%逐步增长到95%,GC无法有效回收。</p>
<p><strong>2. 对比不同时间点的heap dump</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第1天</span>
jmap -dump:live,format=b,file=heap_day1.hprof &lt;pid&gt;

<span class="hljs-comment"># 第3天</span>
jmap -dump:live,format=b,file=heap_day3.hprof &lt;pid&gt;
</code></pre>
<p><strong>3. MAT对比分析</strong></p>
<p>使用MAT的Histogram对比功能,发现:</p>
<ul>
<li><code>java.util.concurrent.ConcurrentHashMap$Node</code>对象数量从10万增长到500万</li>
<li>占用内存从500MB增长到15GB</li>
</ul>
<p><strong>4. 定位泄漏代码</strong></p>
<p>通过Dominator Tree,找到引用链:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">RequestContextHolder</span> (<span class="hljs-keyword">static</span>)
  ↓
<span class="hljs-title class_">ThreadLocal</span>&lt;<span class="hljs-title class_">RequestContext</span>&gt;
  ↓
<span class="hljs-title class_">ConcurrentHashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; (request attributes)
</code></pre>
<p><strong>问题定位</strong>:</p>
<p>代码在每个请求中将大量数据存入<code>ThreadLocal</code>,但请求结束后未清理,导致线程池场景下<code>ThreadLocal</code>泄漏。</p>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;RequestContext&gt; context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> {
        context.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestContext</span>(request));
        chain.doFilter(request, response);
        <span class="hljs-comment">// ❌ 忘记清理!</span>
    }
}

<span class="hljs-comment">// 修复后</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;RequestContext&gt; context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> {
        <span class="hljs-keyword">try</span> {
            context.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestContext</span>(request));
            chain.doFilter(request, response);
        } <span class="hljs-keyword">finally</span> {
            context.remove();  <span class="hljs-comment">// ✅ 清理ThreadLocal</span>
        }
    }
}
</code></pre>
<p><strong>效果</strong>:</p>





























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>改善</th></tr></thead><tbody><tr><td>堆使用率</td><td>95%</td><td>60%</td><td><strong>37%↓</strong></td></tr><tr><td>GC频率</td><td>每分钟10次</td><td>每10分钟1次</td><td><strong>99%↓</strong></td></tr><tr><td>内存泄漏</td><td>每天增长5GB</td><td>无增长</td><td><strong>100%修复</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-57">七、常见问题解答</h2>
<h3 data-id="heading-58">7.1 G1和ZGC如何选择?</h3>
<p><strong>决策树</strong>:</p>
<pre><code class="hljs language-objectivec" lang="objectivec">堆内存大小?
  ├── &lt; <span class="hljs-number">4</span>GB  → G1 或 <span class="hljs-built_in">CMS</span>
  ├── <span class="hljs-number">4</span><span class="hljs-number">-16</span>GB → G1
  ├── <span class="hljs-number">16</span><span class="hljs-number">-64</span>GB → G1 或 ZGC (根据延迟要求)
  └── ≥ <span class="hljs-number">64</span>GB  → ZGC

延迟要求?
  ├── TP99 &lt; <span class="hljs-number">10</span>ms  → ZGC
  ├── TP99 &lt; <span class="hljs-number">100</span>ms → G1
  └── 吞吐量优先 → G1

应用类型?
  ├── 金融交易、实时系统 → ZGC
  ├── 电商、社交、内容平台 → G1
  ├── 大数据实时计算 → ZGC
  └── 微服务、网关 → G1
</code></pre>
<h3 data-id="heading-59">7.2 G1的MaxGCPauseMillis如何设置?</h3>
<p><strong>原则</strong>:</p>
<ul>
<li>这是软目标,G1会尽力达成但不保证</li>
<li>设置过小(如10ms),G1无法达成,可能频繁触发Full GC</li>
<li>设置过大(如500ms),失去G1的低延迟优势</li>
</ul>
<p><strong>建议</strong>:</p>
<ul>
<li>通用应用: 100-200ms</li>
<li>低延迟应用: 50-100ms</li>
<li>吞吐量优先: 200-500ms</li>
</ul>
<p><strong>验证方法</strong>:</p>
<p>查看GC日志,确认实际停顿时间:</p>
<pre><code class="hljs language-bash" lang="bash">grep <span class="hljs-string">"GC pause"</span> gc.log | awk <span class="hljs-string">'{print $NF}'</span> | <span class="hljs-built_in">sort</span> -n | <span class="hljs-built_in">tail</span> -100
</code></pre>
<p>如果实际停顿时间远超目标,考虑:</p>
<ul>
<li>增大堆内存</li>
<li>降低<code>InitiatingHeapOccupancyPercent</code>,提前触发并发标记</li>
<li>增加并发GC线程数</li>
</ul>
<h3 data-id="heading-60">7.3 为什么G1仍然会触发Full GC?</h3>
<p><strong>Full GC的触发场景</strong>:</p>
<ol>
<li>
<p><strong>晋升失败 (Promotion Failure)</strong>:</p>
<ul>
<li>Young GC时,老年代没有足够空间容纳晋升对象</li>
<li>解决: 增大堆内存,降低<code>InitiatingHeapOccupancyPercent</code></li>
</ul>
</li>
<li>
<p><strong>巨型对象分配失败 (Humongous Allocation Failure)</strong>:</p>
<ul>
<li>无法找到足够的连续Region存储大对象</li>
<li>解决: 增大<code>G1HeapRegionSize</code>,避免大对象(优化代码,拆分对象)</li>
</ul>
</li>
<li>
<p><strong>并发模式失败 (Concurrent Mode Failure)</strong>:</p>
<ul>
<li>并发标记未完成,老年代已满</li>
<li>解决: 降低<code>InitiatingHeapOccupancyPercent</code>,增加<code>ConcGCThreads</code></li>
</ul>
</li>
<li>
<p><strong>元空间不足</strong>:</p>
<ul>
<li>Metaspace OOM</li>
<li>解决: 增大<code>MaxMetaspaceSize</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-61">7.4 ZGC有哪些限制?</h3>
<p><strong>ZGC的限制</strong>:</p>
<ol>
<li>
<p><strong>JDK版本</strong>:</p>
<ul>
<li>JDK 11: 实验性特性 (<code>-XX:+UnlockExperimentalVMOptions -XX:+UseZGC</code>)</li>
<li>JDK 15+: 正式特性 (<code>-XX:+UseZGC</code>)</li>
</ul>
</li>
<li>
<p><strong>操作系统</strong>:</p>
<ul>
<li>Linux (x86-64): 完全支持</li>
<li>macOS: JDK 14+支持</li>
<li>Windows: JDK 14+支持</li>
</ul>
</li>
<li>
<p><strong>堆大小</strong>:</p>
<ul>
<li>最小: 8GB (建议)</li>
<li>最大: 16TB (理论上)</li>
<li>实际生产: 16GB - 512GB</li>
</ul>
</li>
<li>
<p><strong>CPU开销</strong>:</p>
<ul>
<li>读屏障带来额外CPU开销</li>
<li>并发GC线程占用CPU</li>
<li>吞吐量损失5-15%</li>
</ul>
</li>
<li>
<p><strong>不支持压缩类指针</strong>:</p>
<ul>
<li>ZGC不支持<code>-XX:+UseCompressedClassPointers</code></li>
<li>元空间占用略高</li>
</ul>
</li>
</ol>
<h3 data-id="heading-62">7.5 如何监控G1和ZGC的性能?</h3>
<p><strong>GC日志分析</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># JDK 8及之前 (G1)</span>
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-Xloggc:/var/log/gc.log

<span class="hljs-comment"># JDK 9+ (G1/ZGC)</span>
-Xlog:gc*:file=/var/log/gc.log:time,<span class="hljs-built_in">uptime</span>,level,tags
</code></pre>
<p><strong>在线分析工具</strong>:</p>
<ul>
<li><strong>GCEasy</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgceasy.io" target="_blank" title="https://gceasy.io" ref="nofollow noopener noreferrer">gceasy.io</a> (免费,可视化GC日志)</li>
<li><strong>GCViewer</strong>: 开源GC日志分析工具</li>
</ul>
<p><strong>关键指标</strong>:</p>



































<table><thead><tr><th>指标</th><th>G1目标</th><th>ZGC目标</th></tr></thead><tbody><tr><td>吞吐量</td><td>≥ 95%</td><td>≥ 90%</td></tr><tr><td>Young GC停顿</td><td>&lt; 100ms</td><td>N/A</td></tr><tr><td>Mixed GC停顿</td><td>&lt; 200ms</td><td>N/A</td></tr><tr><td>ZGC停顿</td><td>N/A</td><td>&lt; 10ms</td></tr><tr><td>Full GC频率</td><td>0</td><td>0</td></tr></tbody></table>
<p><strong>APM系统集成</strong>:</p>
<ul>
<li>Prometheus + Grafana</li>
<li>SkyWalking</li>
<li>Arthas dashboard</li>
</ul>
<hr/>
<h2 data-id="heading-63">八、最佳实践与建议</h2>
<h3 data-id="heading-64">8.1 G1最佳实践</h3>
<h4 data-id="heading-65">8.1.1 参数配置Checklist</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-Xms</code> = <code>-Xmx</code> (避免动态扩容)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 堆大小 = 物理内存的60-80%</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:MaxGCPauseMillis=100-200</code> (根据业务调整)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:G1HeapRegionSize</code> 手动设置(堆 ≥ 16GB时)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:InitiatingHeapOccupancyPercent=40-45</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:G1ReservePercent=10-15</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 开启GC日志,配置日志滚动</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:+HeapDumpOnOutOfMemoryError</code></li>
</ul>
<h4 data-id="heading-66">8.1.2 代码层面优化</h4>
<p><strong>避免大对象</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误: 创建大数组</span>
<span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];  <span class="hljs-comment">// 10MB,可能成为Humongous对象</span>

<span class="hljs-comment">// ✅ 正确: 使用对象池</span>
<span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> bufferPool.acquire();
</code></pre>
<p><strong>及时释放资源</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误: 资源泄漏</span>
<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection();
<span class="hljs-comment">// 忘记close()</span>

<span class="hljs-comment">// ✅ 正确: try-with-resources</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection()) {
    <span class="hljs-comment">// 使用conn</span>
}  <span class="hljs-comment">// 自动close()</span>
</code></pre>
<p><strong>使用本地变量</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误: 静态集合持有对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-comment">// 永不清理,泄漏!</span>
}

<span class="hljs-comment">// ✅ 正确: 使用Guava Cache</span>
Cache&lt;String, Object&gt; cache = CacheBuilder.newBuilder()
    .maximumSize(<span class="hljs-number">10000</span>)
    .expireAfterWrite(<span class="hljs-number">30</span>, TimeUnit.MINUTES)
    .build();
</code></pre>
<h3 data-id="heading-67">8.2 ZGC最佳实践</h3>
<h4 data-id="heading-68">8.2.1 参数配置Checklist</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-Xms</code> = <code>-Xmx</code> (避免动态扩容)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 堆大小 ≥ 16GB</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:SoftMaxHeapSize</code> 设置为Xmx的80-90%</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:ConcGCThreads</code> 根据CPU核心数调整</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 元空间配置 (ZGC不支持压缩类指针)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 开启GC日志 (使用JDK 9+统一日志格式)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>-XX:+HeapDumpOnOutOfMemoryError</code></li>
</ul>
<h4 data-id="heading-69">8.2.2 适用场景评估</h4>
<p><strong>ZGC适合</strong>:</p>
<p>✅ 堆内存 ≥ 16GB
✅ 延迟敏感应用 (TP99 &lt; 10ms)
✅ 愿意牺牲5-15%吞吐量换取低延迟
✅ JDK 15+</p>
<p><strong>ZGC不适合</strong>:</p>
<p>❌ 小堆应用 (&lt; 8GB)
❌ 吞吐量优先场景
❌ JDK 8/11 (需要升级到JDK 15+)
❌ CPU资源紧张的环境</p>
<h3 data-id="heading-70">8.3 调优流程</h3>
<h4 data-id="heading-71">8.3.1 性能基线建立</h4>
<ol>
<li>
<p><strong>收集当前性能数据</strong> (至少24小时):</p>
<ul>
<li>GC日志</li>
<li>接口RT/TP99</li>
<li>系统资源使用率 (CPU/内存/IO)</li>
<li>业务指标 (QPS/TPS/错误率)</li>
</ul>
</li>
<li>
<p><strong>分析当前瓶颈</strong>:</p>
<ul>
<li>GC频率过高?</li>
<li>GC停顿过长?</li>
<li>堆使用率过高?</li>
<li>Full GC频繁?</li>
</ul>
</li>
</ol>
<h4 data-id="heading-72">8.3.2 调优步骤</h4>
<ol>
<li><strong>小步快跑</strong>: 每次只调整一个参数</li>
<li><strong>压测验证</strong>: 模拟生产流量压测</li>
<li><strong>灰度发布</strong>: 10% → 50% → 100%</li>
<li><strong>持续监控</strong>: 观察7天,确保无异常</li>
</ol>
<h4 data-id="heading-73">8.3.3 监控告警</h4>
<p>设置告警阈值:</p>
<ul>
<li>Full GC频率 &gt; 1次/小时</li>
<li>堆使用率 &gt; 80%</li>
<li>GC停顿 &gt; 目标值 (G1: 200ms, ZGC: 10ms)</li>
<li>接口TP99 &gt; 业务目标</li>
</ul>
<h3 data-id="heading-74">8.4 常见陷阱</h3>
<p><strong>陷阱1: 盲目追求MaxGCPauseMillis</strong></p>
<p>设置过小的停顿目标(如10ms),G1无法达成,可能频繁触发Full GC。</p>
<p><strong>陷阱2: 忽略吞吐量</strong></p>
<p>ZGC低延迟的代价是吞吐量下降5-15%,需要评估业务是否可接受。</p>
<p><strong>陷阱3: 不监控GC日志</strong></p>
<p>GC日志是调优的基础,必须开启并定期分析。</p>
<p><strong>陷阱4: 代码问题靠GC解决</strong></p>
<p>内存泄漏、大对象频繁创建等代码问题,调整GC参数无法根治,必须优化代码。</p>
<hr/>
<h2 data-id="heading-75">总结</h2>
<p>G1和ZGC代表了Java GC技术的演进方向,从平衡性能到极致低延迟。<strong>G1通过Region分区、RSet和SATB算法,实现可预测的停顿时间,适用于4GB-64GB堆的通用场景;ZGC通过染色指针、读屏障和并发重定位,实现&lt; 10ms的超低停顿,专为超大堆和极低延迟场景设计。</strong></p>
<p><strong>核心要点</strong>:</p>
<ol>
<li><strong>Region设计</strong>: G1的核心创新,打破固定分代边界,支持动态调整</li>
<li><strong>RSet机制</strong>: 记录跨Region引用,避免全堆扫描,大幅提升Young GC效率</li>
<li><strong>SATB算法</strong>: G1的并发标记实现,保证不漏标对象,代价是浮动垃圾</li>
<li><strong>染色指针</strong>: ZGC的核心创新,将GC信息存储在指针中,实现并发标记和重定位</li>
<li><strong>读屏障</strong>: ZGC的关键技术,对象访问时自动处理重定位,无需STW</li>
<li><strong>多重映射</strong>: ZGC的内存管理技术,同一物理内存映射到多个虚拟地址,实现并发安全</li>
</ol>
<p><strong>选择建议</strong>:</p>
<ul>
<li><strong>堆 &lt; 16GB,延迟要求中等</strong>: 选择G1,平衡性能,吞吐量高</li>
<li><strong>堆 ≥ 16GB,延迟要求极高</strong>: 选择ZGC,超低停顿,代价是吞吐量下降</li>
<li><strong>通用互联网应用</strong>: G1是首选,开箱即用,调优简单</li>
<li><strong>金融、实时系统</strong>: ZGC是首选,低延迟优先级高于吞吐量</li>
</ul>
<p><strong>调优原则</strong>:</p>
<ul>
<li>建立性能基线,小步快跑,压测验证,灰度发布</li>
<li>代码优化优于参数调优,避免内存泄漏和大对象</li>
<li>持续监控GC日志,定期Review性能数据</li>
<li>根据业务场景选择合适的收集器,不要盲目追求新技术</li>
</ul>
<p>掌握G1和ZGC的原理与调优,能够在生产环境中游刃有余地进行GC调优,提升系统性能,降低故障风险。</p>
<hr/>
<p><strong>参考资料</strong>:</p>
<ul>
<li>《深入理解Java虚拟机:JVM高级特性与最佳实践(第3版)》- 周志明</li>
<li>《Java性能权威指南》- Scott Oaks</li>
<li>Oracle官方JVM文档</li>
<li>OpenJDK ZGC官方文档</li>
<li>GCEasy: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgceasy.io" target="_blank" title="https://gceasy.io" ref="nofollow noopener noreferrer">gceasy.io</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL架构原理与执行流程]]></title>    <link>https://juejin.cn/post/7585474459776761892</link>    <guid>https://juejin.cn/post/7585474459776761892</guid>    <pubDate>2025-12-20T11:36:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776761892" data-draft-id="7585468725332574262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL架构原理与执行流程"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2025-12-20T11:36:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="無量"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL架构原理与执行流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    無量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T11:36:42.000Z" title="Sat Dec 20 2025 11:36:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读32分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>MySQL作为最流行的开源关系型数据库,在互联网应用中扮演着核心角色。理解MySQL的架构原理与SQL执行流程,是每位后端工程师的必修课。本文从MySQL逻辑架构、InnoDB存储引擎、Buffer Pool缓冲池、B+树索引原理、SQL执行流程(SELECT/UPDATE)、EXPLAIN执行计划分析等多个维度,深入剖析MySQL的内部运行机制,并结合生产环境实战案例,讲解慢查询优化、索引优化等最佳实践,帮助读者构建完整的MySQL性能优化知识体系,在面试和实际工作中游刃有余。</p>
<hr/>
<h2 data-id="heading-1">一、理论知识与核心概念</h2>
<h3 data-id="heading-2">1.1 MySQL的定位与特点</h3>
<p>MySQL是一款开源的关系型数据库管理系统(RDBMS),由瑞典MySQL AB公司开发,现属于Oracle旗下产品。MySQL凭借其高性能、高可靠性、易用性,成为互联网应用的首选数据库。</p>
<p><strong>核心特点</strong>:</p>
<ul>
<li><strong>开源免费</strong>: 社区版(GPL许可)免费使用,降低企业成本</li>
<li><strong>跨平台</strong>: 支持Linux、Windows、macOS等多种操作系统</li>
<li><strong>高性能</strong>: 支持千万级数据表,QPS可达数万甚至数十万</li>
<li><strong>高可用</strong>: 支持主从复制、MGR集群等高可用方案</li>
<li><strong>丰富的存储引擎</strong>: InnoDB、MyISAM、Memory等,满足不同场景需求</li>
<li><strong>ACID事务支持</strong>: InnoDB引擎支持完整的ACID事务特性</li>
<li><strong>强大的社区支持</strong>: 庞大的开发者社区,丰富的文档和工具</li>
</ul>
<h3 data-id="heading-3">1.2 InnoDB vs MyISAM</h3>
<p>MySQL支持多种存储引擎,其中InnoDB和MyISAM是最常用的两种:</p>
<p><strong>InnoDB (MySQL 5.5+默认引擎)</strong>:</p>
<ul>
<li>✅ <strong>支持事务</strong>(ACID特性),适合金融、电商等对数据一致性要求高的场景</li>
<li>✅ <strong>行级锁</strong>,并发性能好,支持高并发写操作</li>
<li>✅ <strong>支持外键约束</strong>,保证数据完整性</li>
<li>✅ <strong>崩溃恢复能力强</strong>,通过Redo Log保证数据不丢失</li>
<li>✅ <strong>MVCC多版本并发控制</strong>,提升读写并发性能</li>
<li>❌ <strong>占用空间大</strong>,每个表对应.ibd文件,包含数据和索引</li>
</ul>
<p><strong>MyISAM (老版本默认引擎)</strong>:</p>
<ul>
<li>❌ <strong>不支持事务</strong>,无法保证数据一致性</li>
<li>❌ <strong>表级锁</strong>,并发写性能差</li>
<li>❌ <strong>不支持外键约束</strong></li>
<li>✅ <strong>插入速度快</strong>,适合日志、历史数据等只读或少写场景</li>
<li>✅ <strong>占用空间小</strong>,每个表对应3个文件(.frm/.MYD/.MYI)</li>
</ul>
<p><strong>结论</strong>: 生产环境强烈推荐使用InnoDB引擎,MyISAM已逐步被淘汰。</p>
<h3 data-id="heading-4">1.3 核心概念</h3>
<p><strong>Buffer Pool (缓冲池)</strong>:</p>
<ul>
<li>InnoDB的核心内存结构,缓存数据页和索引页,减少磁盘I/O</li>
<li>默认大小128MB,生产环境建议设置为物理内存的50-80%</li>
<li>采用改进的LRU算法管理缓存,分为Young区和Old区</li>
</ul>
<p><strong>B+树</strong>:</p>
<ul>
<li>MySQL索引的底层数据结构,非叶子节点只存储键值,所有数据在叶子节点</li>
<li>3层B+树能存储约2000万行数据,查询只需3次磁盘I/O</li>
<li>叶子节点通过双向链表连接,范围查询高效</li>
</ul>
<p><strong>WAL (Write-Ahead Logging)</strong>:</p>
<ul>
<li>先写日志,再写数据的机制,核心是Redo Log</li>
<li>Redo Log顺序写(快),数据文件随机写(慢),写入性能提升10-100倍</li>
<li>崩溃恢复时通过Redo Log重放,保证数据不丢失</li>
</ul>
<p><strong>2PC (Two-Phase Commit)</strong>:</p>
<ul>
<li>两阶段提交协议,保证Redo Log和Binlog一致性</li>
<li>流程: Redo Log prepare → 写Binlog → Redo Log commit</li>
<li>避免主从数据不一致</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、MySQL逻辑架构详解</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bd3db2455784f61929c84e1c5cba10a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766835402&amp;x-signature=xa1KMdQ%2Fm9JVDrtbUB9WBmNUvG8%3D" alt="mysql-architecture.svg" loading="lazy"/></p>
<p>MySQL采用<strong>分层架构设计</strong>,从上到下分为3层:连接层、SQL层(Server层)、存储引擎层。这种分层设计实现了Server层与存储引擎的解耦,支持插件式存储引擎。</p>
<h3 data-id="heading-6">2.1 第1层: 连接层 (Connector)</h3>
<p><strong>连接层负责客户端连接管理,包括连接建立、身份验证、权限获取。</strong></p>
<p><strong>连接建立流程</strong>:</p>
<ol>
<li><strong>TCP三次握手</strong>: 客户端(如JDBC、MySQL命令行)与MySQL Server建立TCP连接</li>
<li><strong>身份验证</strong>: 服务器验证用户名和密码,查询<code>mysql.user</code>表</li>
<li><strong>权限获取</strong>: 验证通过后,从权限表中读取该用户的权限信息,缓存到连接对象中</li>
<li><strong>加入连接池</strong>: 连接加入连接池,可通过<code>SHOW PROCESSLIST</code>查看当前所有连接</li>
</ol>
<p><strong>连接类型</strong>:</p>
<ul>
<li><strong>短连接</strong>: 每次查询后立即断开,适合低频访问场景</li>
<li><strong>长连接</strong>: 保持连接不断开,适合高频访问场景(如Web应用)</li>
</ul>
<p><strong>长连接的问题</strong>: 长时间使用后,MySQL Server内存占用会持续增长,因为连接过程中的临时内存不会释放。</p>
<p><strong>解决方案</strong>:</p>
<ol>
<li><strong>定期断开长连接</strong>: 连接使用超过一定时间(如8小时)或执行过大查询后,主动断开重连</li>
<li><strong>执行<code>mysql_reset_connection</code></strong>: MySQL 5.7+支持,重置连接状态,释放临时内存,无需重新建立连接</li>
</ol>
<p><strong>关键参数</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">max_connections=1000         <span class="hljs-comment"># 最大连接数,默认151</span>
wait_timeout=28800           <span class="hljs-comment"># 非交互连接超时时间(秒),默认8小时</span>
interactive_timeout=28800    <span class="hljs-comment"># 交互式连接超时时间(秒)</span>
</code></pre>
<h3 data-id="heading-7">2.2 第2层: SQL层 (Server层) - 查询缓存</h3>
<p><strong>查询缓存是MySQL Server层的第一道关卡,在MySQL 8.0已被移除。</strong></p>
<p><strong>工作原理</strong>:</p>
<ul>
<li>使用SQL语句作为key,查询结果作为value,存储到缓存中</li>
<li>后续完全相同的SQL直接返回缓存结果,跳过后续的分析、优化、执行步骤</li>
</ul>
<p><strong>为什么被移除?</strong></p>
<ol>
<li><strong>命中率极低</strong>: SQL必须完全相同(包括空格、大小写),稍有差异就无法命中</li>
<li><strong>失效频繁</strong>: 只要表有任何更新(INSERT/UPDATE/DELETE),该表的所有查询缓存全部失效</li>
<li><strong>维护成本高</strong>: 缓存的加锁、失效、淘汰机制带来额外开销</li>
<li><strong>适用场景少</strong>: 只适合静态表(如配置表、字典表),实际生产中极少</li>
</ol>
<p><strong>替代方案</strong>: 使用Redis、Memcached等外部缓存中间件,更灵活、命中率更高。</p>
<h3 data-id="heading-8">2.3 第3层: SQL层 (Server层) - 分析器</h3>
<p><strong>分析器负责对SQL语句进行词法分析和语法分析,生成语法树(AST)。</strong></p>
<p><strong>词法分析 (Lexical Analysis)</strong>:</p>
<p>将SQL字符串拆解为一个个token(词法单元):</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">10</span>;
</code></pre>
<p>拆解结果:</p>
<ul>
<li>关键字: SELECT, FROM, WHERE, ORDER BY, LIMIT</li>
<li>标识符: id, name, age, users</li>
<li>常量: 25, 10</li>
<li>运算符: &gt;, =</li>
</ul>
<p><strong>语法分析 (Syntax Analysis)</strong>:</p>
<p>根据MySQL的语法规则,将token序列组织成语法树(Parse Tree / AST):</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span>
├── <span class="hljs-keyword">SELECT</span> LIST: id, name, age
├── <span class="hljs-keyword">FROM</span>: users
├── <span class="hljs-keyword">WHERE</span>: age &gt; <span class="hljs-number">25</span>
├── <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>: id
└── LIMIT: <span class="hljs-number">10</span>
</code></pre>
<p><strong>语法错误检查</strong>:</p>
<p>如果SQL不符合语法规则,分析器报错:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> FORM users;  <span class="hljs-comment">-- 错误: 关键字拼写错误(FROM写成FORM)</span>
</code></pre>
<p>报错信息: <code>You have an error in your SQL syntax; check the manual...</code></p>
<p><strong>输出</strong>: 语法树(AST),供优化器使用。</p>
<h3 data-id="heading-9">2.4 第4层: SQL层 (Server层) - 优化器</h3>
<p><strong>优化器负责生成最优的执行计划,决定如何高效地执行SQL。</strong></p>
<p><strong>核心任务</strong>:</p>
<p><strong>1. 索引选择</strong>:</p>
<p>查询<code>users</code>表有哪些索引可用:</p>
<ul>
<li>主键索引: <code>PRIMARY KEY (id)</code></li>
<li>二级索引: <code>idx_age (age)</code>, <code>idx_name (name)</code>, <code>idx_age_name (age, name)</code></li>
</ul>
<p><strong>成本计算 (CBO - Cost-Based Optimizer)</strong>:</p>
<p>MySQL使用基于成本的优化器,计算每种执行方式的成本,选择成本最低的:</p>
<ul>
<li><strong>全表扫描成本</strong>: 读取所有数据页的I/O成本 + CPU计算成本</li>
<li><strong>索引扫描成本</strong>: 读取索引页的I/O成本 + 回表I/O成本 + CPU成本</li>
</ul>
<p>成本公式(简化版):</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Cost</span> = I/O_cost + CPU_cost
I/<span class="hljs-attr">O_cost</span> = pages_read × io_cost_per_page
<span class="hljs-attr">CPU_cost</span> = rows_examined × cpu_cost_per_row
</code></pre>
<p><strong>索引选择策略</strong>:</p>
<ul>
<li>条件字段有索引: 优先使用索引</li>
<li>多个索引可选: 选择选择性最高的索引(扫描行数最少)</li>
<li>索引扫描成本 &gt; 全表扫描成本: 使用全表扫描(如查询结果占表总行数的30%以上)</li>
</ul>
<p><strong>2. JOIN顺序优化</strong>:</p>
<p>多表JOIN时,JOIN顺序影响性能:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> users u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id
<span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> o.product_id <span class="hljs-operator">=</span> p.id
<span class="hljs-keyword">WHERE</span> u.age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;
</code></pre>
<p>可能的JOIN顺序:</p>
<ul>
<li><code>orders → users → products</code></li>
<li><code>users → orders → products</code> (优化器可能选择这个,因为先过滤users.age &gt; 25,减少JOIN行数)</li>
</ul>
<p><strong>3. 子查询改写</strong>:</p>
<p>优化器可能将子查询改写为JOIN:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 原始SQL (子查询)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>);

<span class="hljs-comment">-- 优化器改写为JOIN (可能更高效)</span>
<span class="hljs-keyword">SELECT</span> u.<span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> u.id <span class="hljs-operator">=</span> o.user_id
<span class="hljs-keyword">WHERE</span> o.status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>输出</strong>: 执行计划(Execution Plan),可通过<code>EXPLAIN</code>查看。</p>
<h3 data-id="heading-10">2.5 第5层: SQL层 (Server层) - 执行器</h3>
<p><strong>执行器负责执行SQL,调用存储引擎接口逐行读取数据。</strong></p>
<p><strong>执行流程</strong>:</p>
<p><strong>1. 权限检查</strong>:</p>
<p>检查用户是否有该表的SELECT权限(权限在连接阶段已获取):</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, name <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;
</code></pre>
<p>如果无权限,报错: <code>Access denied for user 'xxx'@'xxx' to table 'users'</code></p>
<p><strong>2. 调用存储引擎接口</strong>:</p>
<p>执行器调用InnoDB引擎的read接口,传入条件<code>age &gt; 25</code>:</p>
<pre><code class="hljs language-ini" lang="ini">executor.read(<span class="hljs-attr">table</span>=<span class="hljs-string">"users"</span>, condition=<span class="hljs-string">"age &gt; 25"</span>)
</code></pre>
<p><strong>3. 逐行读取数据</strong>:</p>
<ul>
<li>InnoDB根据执行计划(使用idx_age索引)定位数据</li>
<li>通过B+树查找age &gt; 25的第一行</li>
<li>返回给执行器</li>
<li>执行器继续调用read接口,读取下一行</li>
<li>重复直到读完所有符合条件的行</li>
</ul>
<p><strong>4. 过滤、排序、限制</strong>:</p>
<ul>
<li>过滤: WHERE条件过滤不符合条件的行</li>
<li>排序: ORDER BY id (可能使用idx_id索引避免排序,或使用filesort)</li>
<li>限制: LIMIT 10,只返回前10行</li>
</ul>
<p><strong>5. 返回结果集</strong>:</p>
<p>执行器将结果集返回给客户端。</p>
<p><strong>6. 记录慢查询日志</strong>:</p>
<p>如果查询时间 &gt; <code>long_query_time</code>(默认10秒),记录到慢查询日志:</p>
<pre><code class="hljs language-bash" lang="bash">slow_query_log=ON                          <span class="hljs-comment"># 开启慢查询日志</span>
long_query_time=1                          <span class="hljs-comment"># 慢查询阈值1秒</span>
slow_query_log_file=/var/log/mysql-slow.log
</code></pre>
<h3 data-id="heading-11">2.6 Server层总结</h3>
<p><strong>Server层是MySQL的大脑</strong>,负责连接管理、SQL解析、优化、执行,与存储引擎无关。同一条SQL,无论使用InnoDB还是MyISAM,Server层的处理流程完全相同,只是最后调用的存储引擎接口不同。</p>
<p><strong>Server层与存储引擎的分层设计优势</strong>:</p>
<ul>
<li><strong>解耦</strong>: Server层专注SQL处理,存储引擎专注数据存储和读写</li>
<li><strong>插件式架构</strong>: 可自由切换存储引擎(InnoDB/MyISAM/Memory),无需修改SQL</li>
<li><strong>灵活性</strong>: 不同表可使用不同存储引擎,满足不同业务需求</li>
</ul>
<hr/>
<h2 data-id="heading-12">三、InnoDB存储引擎架构</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c86e176846d846baa86acc68214e4753~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766835402&amp;x-signature=4faIJMs8oQZ%2FHUCgKys0oSrPqp4%3D" alt="innodb-architecture.svg" loading="lazy"/>
InnoDB是MySQL的默认存储引擎(MySQL 5.5+),专为事务处理设计,架构分为<strong>内存结构</strong>和<strong>磁盘结构</strong>两大部分。</p>
<h3 data-id="heading-13">3.1 InnoDB整体架构</h3>
<p><strong>InnoDB的核心设计思想</strong>: <strong>内存优先 + WAL机制 + 崩溃恢复</strong></p>
<ul>
<li><strong>内存优先</strong>: 数据优先缓存到Buffer Pool,减少磁盘I/O</li>
<li><strong>WAL (Write-Ahead Logging)</strong>: 先写日志(Redo Log),再异步刷脏页,提升写入性能</li>
<li><strong>崩溃恢复</strong>: 通过Redo Log重放,保证事务持久性(Durability)</li>
</ul>
<h3 data-id="heading-14">3.2 内存结构 (In-Memory Structure)</h3>
<p><strong>1. Buffer Pool (缓冲池)</strong>:</p>
<p><strong>Buffer Pool是InnoDB性能的核心</strong>,缓存数据页和索引页,减少磁盘I/O。</p>
<p><strong>缓存内容</strong>:</p>
<ul>
<li>数据页 (Data Page): 表的行数据</li>
<li>索引页 (Index Page): B+树索引节点</li>
<li>插入缓冲 (Insert Buffer): 二级索引的插入缓冲</li>
<li>自适应哈希索引 (Adaptive Hash Index): InnoDB自动创建的哈希索引</li>
<li>锁信息 (Lock Info): 行锁、表锁信息</li>
</ul>
<p><strong>LRU链表管理</strong>:</p>
<p>Buffer Pool采用改进的LRU(Least Recently Used)算法管理缓存页,分为两个区域:</p>
<ul>
<li><strong>Young区</strong> (新数据区): 占Buffer Pool的5/8 (62.5%),存放热数据</li>
<li><strong>Old区</strong> (老数据区): 占Buffer Pool的3/8 (37.5%),存放冷数据</li>
</ul>
<p><strong>Midpoint插入策略</strong>:</p>
<p>传统LRU算法的问题: 全表扫描会将大量冷数据加载到缓存,挤掉热数据(缓存污染)。</p>
<p><strong>InnoDB的改进</strong>:</p>
<ul>
<li>新数据页不插入链表头,而是插入Old区头部(Midpoint位置)</li>
<li>只有在Old区停留≥1秒(<code>innodb_old_blocks_time=1000</code>)后再次访问,才移动到Young区</li>
<li>全表扫描的数据页只停留在Old区,不影响Young区的热数据</li>
</ul>
<p><strong>Buffer Pool参数配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">innodb_buffer_pool_size=8G          <span class="hljs-comment"># Buffer Pool大小,建议物理内存的50-80%</span>
innodb_buffer_pool_instances=8      <span class="hljs-comment"># Buffer Pool实例数,减少锁竞争</span>
innodb_old_blocks_pct=37            <span class="hljs-comment"># Old区占比37% (默认)</span>
innodb_old_blocks_time=1000         <span class="hljs-comment"># Old区停留时间1秒 (默认)</span>
</code></pre>
<p><strong>2. Change Buffer (写缓冲)</strong>:</p>
<p><strong>Change Buffer用于缓存二级索引(非唯一索引)的变更操作,减少随机I/O。</strong></p>
<p><strong>工作原理</strong>:</p>
<p>当更新非唯一索引时:</p>
<ol>
<li>如果索引页在Buffer Pool: 直接更新</li>
<li>如果索引页不在Buffer Pool: 将变更记录到Change Buffer (而不是立即从磁盘加载索引页)</li>
<li>后续读取该索引页时,合并Change Buffer中的变更(Merge操作)</li>
</ol>
<p><strong>适用场景</strong>: 非唯一索引,写多读少的场景(如日志表、历史记录表)</p>
<p><strong>为什么唯一索引不能用Change Buffer?</strong></p>
<p>唯一索引需要检查唯一性约束,必须读取索引页,无法延迟更新。</p>
<p><strong>3. Adaptive Hash Index (自适应哈希索引)</strong>:</p>
<p>InnoDB自动创建的哈希索引,加速等值查询。</p>
<p><strong>工作原理</strong>:</p>
<ul>
<li>InnoDB监控B+树索引的访问模式</li>
<li>对于频繁访问的索引页,自动创建哈希索引</li>
<li>哈希查询O(1)时间复杂度,比B+树O(log n)更快</li>
</ul>
<p><strong>限制</strong>: 只支持等值查询(=),不支持范围查询(&lt;, &gt;),由InnoDB自动管理,无法手动配置。</p>
<p><strong>4. Log Buffer (日志缓冲)</strong>:</p>
<p><strong>Log Buffer缓存Redo Log,提高日志写入性能。</strong></p>
<p><strong>工作流程</strong>:</p>
<ol>
<li>事务修改数据时,先写Redo Log Buffer (内存)</li>
<li>事务提交时,将Redo Log Buffer刷盘到ib_logfile0/1 (磁盘)</li>
<li>刷盘策略由<code>innodb_flush_log_at_trx_commit</code>控制</li>
</ol>
<p><strong>参数配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">innodb_log_buffer_size=16M          <span class="hljs-comment"># Log Buffer大小,默认16MB</span>
innodb_flush_log_at_trx_commit=1   <span class="hljs-comment"># 刷盘策略:</span>
                                    <span class="hljs-comment"># 0: 每秒刷盘一次 (性能最好,但可能丢失1秒数据)</span>
                                    <span class="hljs-comment"># 1: 每次事务提交刷盘 (最安全,推荐)</span>
                                    <span class="hljs-comment"># 2: 每次提交写OS缓存,每秒刷盘 (折中)</span>
</code></pre>
<h3 data-id="heading-15">3.3 磁盘结构 (On-Disk Structure)</h3>
<p><strong>1. 表空间 (Tablespace)</strong>:</p>
<p><strong>系统表空间 (System Tablespace)</strong>:</p>
<ul>
<li>文件: ibdata1</li>
<li>存储: 数据字典、Undo Log、Change Buffer、Doublewrite Buffer</li>
<li>特点: 所有表共享,不推荐存储用户数据</li>
</ul>
<p><strong>独立表空间 (File-Per-Table Tablespace)</strong>:</p>
<ul>
<li>文件: 每个表一个.ibd文件 (如users.ibd)</li>
<li>存储: 表的数据和索引</li>
<li>参数: <code>innodb_file_per_table=ON</code> (MySQL 5.6+默认开启)</li>
<li>优势: 表级别管理,DROP TABLE直接删除.ibd文件,回收空间</li>
</ul>
<p><strong>2. 数据文件结构</strong>:</p>
<p><strong>表空间 → 段(Segment) → 区(Extent) → 页(Page) → 行(Row)</strong></p>
<ul>
<li><strong>页(Page)</strong>: InnoDB最小I/O单位,默认16KB (<code>innodb_page_size=16384</code>)</li>
<li><strong>区(Extent)</strong>: 连续64个页,大小1MB (64 × 16KB)</li>
<li><strong>段(Segment)</strong>: 数据段、索引段、回滚段</li>
</ul>
<p><strong>3. Redo Log (重做日志)</strong>:</p>
<p><strong>Redo Log是InnoDB崩溃恢复的核心,记录数据页的物理修改。</strong></p>
<p><strong>文件</strong>:</p>
<ul>
<li>ib_logfile0, ib_logfile1 (默认2个文件)</li>
<li>循环写入(Circular Write),写满ib_logfile1后回到ib_logfile0</li>
</ul>
<p><strong>作用</strong>:</p>
<ul>
<li><strong>崩溃恢复</strong>: 重启后,通过Redo Log重放(redo),恢复未刷盘的脏页数据</li>
<li><strong>事务持久性(Durability)</strong>: 事务提交后,即使立即崩溃,Redo Log保证数据不丢失</li>
</ul>
<p><strong>Redo Log vs Binlog</strong>:</p>



































<table><thead><tr><th>维度</th><th>Redo Log</th><th>Binlog</th></tr></thead><tbody><tr><td><strong>层次</strong></td><td>InnoDB引擎层</td><td>MySQL Server层</td></tr><tr><td><strong>作用</strong></td><td>崩溃恢复</td><td>主从复制、数据备份</td></tr><tr><td><strong>内容</strong></td><td>物理日志(数据页的修改)</td><td>逻辑日志(SQL语句或行变更)</td></tr><tr><td><strong>写入方式</strong></td><td>循环写(固定大小,覆盖旧数据)</td><td>追加写(一直写新文件)</td></tr><tr><td><strong>事务提交</strong></td><td>2PC两阶段提交</td><td>2PC两阶段提交</td></tr></tbody></table>
<p><strong>4. Undo Log (回滚日志)</strong>:</p>
<p><strong>Undo Log用于事务回滚和MVCC多版本并发控制。</strong></p>
<p><strong>作用</strong>:</p>
<ol>
<li><strong>事务回滚</strong>: 记录修改前的旧值,事务失败时通过Undo Log回滚</li>
<li><strong>MVCC</strong>: 其他事务读取旧版本数据,实现快照读</li>
</ol>
<p><strong>存储位置</strong>: 系统表空间(ibdata1)或Undo表空间(undo_001, undo_002)</p>
<h3 data-id="heading-16">3.4 B+树索引原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdff00281b9f4e38b1a5175ab8027754~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766835402&amp;x-signature=CjnbB9eDm5P%2B0f1Rv280ihdLJFI%3D" alt="btree-structure.svg" loading="lazy"/></p>
<p><strong>为什么MySQL选择B+树作为索引数据结构?</strong></p>
<p><strong>对比其他数据结构</strong>:</p>
<p><strong>哈希表</strong>:</p>
<ul>
<li>❌ 不支持范围查询: <code>age &gt; 25</code>无法使用哈希索引</li>
<li>❌ 不支持排序: <code>ORDER BY age</code>无法使用哈希索引</li>
<li>❌ 不支持模糊查询: <code>name LIKE 'abc%'</code>无法使用哈希索引</li>
</ul>
<p><strong>二叉搜索树(BST)</strong>:</p>
<ul>
<li>❌ 可能退化成链表: 插入顺序数据(如1,2,3,4,5)时,树变成链表</li>
<li>❌ 树高过高: 百万数据树高约20层,查询需要20次磁盘I/O</li>
</ul>
<p><strong>AVL树 / 红黑树</strong>:</p>
<ul>
<li>❌ 树高依然过高: 百万数据树高约20层</li>
<li>❌ 磁盘I/O次数多: 每层一次I/O,太慢</li>
</ul>
<p><strong>B树</strong>:</p>
<ul>
<li>❌ 非叶子节点存储数据: 浪费空间,每个节点存储的键值数量少</li>
<li>❌ 范围查询需要中序遍历: 需要回溯到根节点,效率低</li>
</ul>
<p><strong>B+树 (InnoDB选择)</strong>:</p>
<ul>
<li>✅ <strong>非叶子节点只存储键值</strong>: 每个节点能存储更多键(约1170个),树高低(3层约2000万行)</li>
<li>✅ <strong>所有数据在叶子节点</strong>: 查询稳定,每次查询路径长度相同</li>
<li>✅ <strong>叶子节点双向链表连接</strong>: 范围查询只需顺序遍历链表,无需回溯</li>
<li>✅ <strong>磁盘I/O次数少</strong>: 树高 = I/O次数,3次I/O即可定位任意数据</li>
</ul>
<p><strong>3层B+树能存多少数据?</strong></p>
<p><strong>前提条件</strong>:</p>
<ul>
<li>InnoDB页大小: 16KB (<code>innodb_page_size=16384</code>)</li>
<li>主键(Bigint): 8字节</li>
<li>指针大小: 6字节(InnoDB页号)</li>
<li>每行数据大小: 假设1KB</li>
</ul>
<p><strong>计算过程</strong>:</p>
<p><strong>1. 非叶子节点能存多少个键?</strong></p>
<p>每个键 = 主键(8B) + 指针(6B) = 14字节</p>
<p>每个节点(16KB) 能存: 16KB / 14B ≈ <strong>1170个键</strong></p>
<p><strong>2. 叶子节点能存多少行数据?</strong></p>
<p>每行数据 = 1KB (假设)</p>
<p>每个节点(16KB) 能存: 16KB / 1KB = <strong>16行数据</strong></p>
<p><strong>3. 3层B+树能存多少行?</strong></p>
<ul>
<li>第1层(根节点): 1个节点, 1170个键, 指向1170个第2层节点</li>
<li>第2层: 1170个节点, 每个1170个键, 指向 1170 × 1170 = 1,368,900 个叶子节点</li>
<li>第3层(叶子节点): 1,368,900 × 16 = <strong>21,902,400 ≈ 2190万行</strong></li>
</ul>
<p><strong>结论</strong>: <strong>3层B+树, 仅需3次磁盘I/O, 就能定位到2000万条数据中的任意一条!</strong></p>
<p><strong>对比</strong>: 如果用红黑树, 2000万数据树高约25层, 需要25次I/O,性能差距1000倍以上!</p>
<p><strong>为什么树高这么低?</strong></p>
<p>非叶子节点不存储数据,只存储键+指针,每个节点能存储1000+个键,树的扇出(Fan-out)极大,树高极低。</p>
<p><strong>为什么I/O次数重要?</strong></p>
<p>磁盘随机I/O是性能瓶颈:</p>
<ul>
<li>机械硬盘: 约10ms/次</li>
<li>SSD: 约0.1ms/次</li>
</ul>
<p>3次I/O约30ms,25次I/O约250ms,差距10倍!</p>
<hr/>
<h2 data-id="heading-17">四、一条SQL的执行流程</h2>
<h3 data-id="heading-18">4.1 SELECT语句的执行流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3668fdf2a47b4fc6b7a39485c724344c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766835402&amp;x-signature=XOq1yiHJ5qaqmIWIi4yJeMLjeZk%3D" alt="select-execution-flow.svg" loading="lazy"/></p>
<p><strong>示例SQL</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">10</span>;
</code></pre>
<p><strong>完整流程</strong>:</p>
<p><strong>步骤1: 连接器 (Connector)</strong></p>
<ul>
<li>TCP握手,建立连接</li>
<li>验证用户名密码(查询<code>mysql.user</code>表)</li>
<li>获取用户权限(保存到连接对象中)</li>
<li>加入连接池(<code>SHOW PROCESSLIST</code>可查看)</li>
</ul>
<p><strong>步骤2: 查询缓存 (Query Cache, MySQL 8.0已移除)</strong></p>
<ul>
<li>使用SQL语句作为key,查询结果作为value</li>
<li><strong>命中缓存</strong>: 直接返回结果,跳过后续步骤</li>
<li><strong>未命中</strong>: 继续执行后续步骤</li>
<li><strong>表更新会清空该表的所有缓存</strong>(命中率极低)</li>
</ul>
<p><strong>步骤3: 分析器 (Analyzer)</strong></p>
<p><strong>3.1 词法分析 (Lexical Analysis)</strong>:</p>
<ul>
<li>识别SQL中的关键字: SELECT, FROM, WHERE, ORDER BY, LIMIT</li>
<li>识别表名: users, 字段名: id, name, age</li>
</ul>
<p><strong>3.2 语法分析 (Syntax Analysis)</strong>:</p>
<ul>
<li>构建语法树 (Parse Tree)</li>
<li>检查语法错误(如: <code>SELECT * FORM users</code>)</li>
</ul>
<p><strong>输出</strong>: 语法树(AST)</p>
<p><strong>步骤4: 优化器 (Optimizer)</strong></p>
<p><strong>4.1 索引选择</strong>:</p>
<ul>
<li>查询users表有哪些索引(主键索引、age索引、name索引...)</li>
<li><strong>成本计算 (CBO - Cost-Based Optimizer)</strong>: 计算全表扫描 vs 索引扫描的成本</li>
<li>选择成本最低的索引(假设选择idx_age索引)</li>
</ul>
<p><strong>4.2 执行计划生成</strong>:</p>
<ul>
<li>确定JOIN顺序(多表查询)</li>
<li>确定是否使用临时表/排序</li>
<li>生成最优执行计划</li>
</ul>
<p><strong>输出</strong>: 执行计划(Execution Plan) - 可通过<code>EXPLAIN</code>查看</p>
<p><strong>步骤5: 执行器 (Executor)</strong></p>
<ul>
<li><strong>权限检查</strong>: 检查用户是否有users表的SELECT权限(第1步已获取)</li>
<li><strong>调用存储引擎接口</strong>: InnoDB引擎的read接口,传入条件: <code>age &gt; 25</code></li>
<li><strong>逐行读取数据</strong>: 过滤不符合条件的行</li>
<li><strong>排序</strong>: <code>ORDER BY id</code></li>
<li><strong>限制结果</strong>: <code>LIMIT 10</code></li>
<li><strong>记录慢查询日志</strong>(如超过阈值)</li>
</ul>
<p><strong>步骤6: 存储引擎 (InnoDB)</strong></p>
<p><strong>6.1 检查Buffer Pool</strong>:</p>
<ul>
<li><strong>数据页在缓存中</strong>: 直接返回数据(缓存命中, 无磁盘I/O)</li>
<li><strong>数据页不在缓存中</strong>: 从磁盘加载数据页到Buffer Pool(磁盘I/O)</li>
</ul>
<p><strong>6.2 读取数据</strong>:</p>
<ul>
<li>通过age索引定位数据(B+树查找)</li>
<li><strong>回表查询</strong>: 通过主键索引获取完整行</li>
</ul>
<p><strong>返回数据给执行器 → 返回结果集给客户端</strong></p>
<p><strong>SELECT执行流程关键点</strong>:</p>
<ul>
<li>完整流程: 连接器 → 查询缓存(8.0已移除) → 分析器 → 优化器 → 执行器 → 存储引擎</li>
<li><strong>慢查询优化重点</strong>: 优化器的索引选择、执行器的回表次数、存储引擎的Buffer Pool命中率</li>
</ul>
<h3 data-id="heading-19">4.2 UPDATE语句的执行流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/727e8844b0ca4d0e82e704836f61dbc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766835402&amp;x-signature=rATo1PrVy8cJJiW1E5g4AF2lsE8%3D" alt="update-execution-flow.svg" loading="lazy"/></p>
<p><strong>示例SQL</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">26</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
</code></pre>
<p><strong>前5步与SELECT相同</strong>: 连接器 → 查询缓存 → 分析器 → 优化器 → 执行器</p>
<p><strong>步骤6: InnoDB更新流程 (WAL + 2PC)</strong></p>
<p><strong>6.1 查找数据 (WHERE id = 100)</strong></p>
<ul>
<li>先查询Buffer Pool缓存: 数据页在缓存中,直接返回</li>
<li>数据页不在缓存: 从磁盘.ibd文件加载到Buffer Pool</li>
</ul>
<p><strong>6.2 写Undo Log (回滚日志)</strong></p>
<ul>
<li>记录旧值: <code>id=100, age=25</code> (用于事务回滚)</li>
<li>用于MVCC多版本并发控制(其他事务读取旧版本数据)</li>
<li>存储位置: Undo表空间或系统表空间(ibdata1)</li>
</ul>
<p><strong>6.3 更新Buffer Pool内存数据</strong></p>
<ul>
<li>在Buffer Pool中修改数据: <code>id=100, age=25 → age=26</code></li>
<li>标记数据页为"<strong>脏页</strong>" (Dirty Page)</li>
<li><strong>此时数据只在内存中更新,尚未写入磁盘</strong> (WAL机制核心)</li>
</ul>
<p><strong>6.4 写Redo Log - prepare阶段 (InnoDB引擎层)</strong></p>
<ul>
<li>先写Redo Log Buffer (内存)</li>
<li>刷盘到ib_logfile0/1 (磁盘,顺序写)</li>
<li>记录内容: "将users表id=100的age字段改为26"</li>
<li><strong>状态: prepare</strong> (两阶段提交第1阶段)</li>
<li><strong>作用</strong>: 崩溃恢复时,通过Redo Log重放,保证数据不丢失</li>
</ul>
<p><strong>参数</strong>: <code>innodb_flush_log_at_trx_commit=1</code> (每次事务提交刷盘,最安全)</p>
<p><strong>6.5 写Binlog (MySQL Server层)</strong></p>
<ul>
<li>Binlog是MySQL Server层的日志(所有存储引擎共享)</li>
<li>记录完整的SQL语句或行变更</li>
<li>刷盘到binlog文件(mysql-bin.000001)</li>
<li><strong>参数</strong>: <code>sync_binlog=1</code> (每次事务提交刷盘,最安全)</li>
<li><strong>作用</strong>: 主从复制、数据备份、数据恢复(point-in-time recovery)</li>
<li><strong>Binlog格式</strong>: ROW(行模式,推荐), STATEMENT, MIXED</li>
</ul>
<p><strong>6.6 提交事务 - Redo Log commit阶段 (两阶段提交第2阶段)</strong></p>
<ul>
<li>将Redo Log状态从prepare改为commit</li>
<li>事务正式提交成功</li>
<li><strong>2PC两阶段提交完成</strong>: prepare → 写Binlog → commit (保证Redo Log和Binlog一致性)</li>
<li><strong>此时数据仍在Buffer Pool,尚未写入.ibd文件</strong></li>
</ul>
<p><strong>6.7 刷脏页 (Flush Dirty Pages) - 异步后台线程</strong></p>
<ul>
<li><strong>后台线程异步将脏页刷回磁盘</strong> (.ibd数据文件, 随机写)</li>
<li><strong>触发时机</strong>:
<ol>
<li>Redo Log满了(必须刷脏页,腾出Redo Log空间)</li>
<li>Buffer Pool空间不足(淘汰脏页,需先刷盘)</li>
<li>MySQL空闲时(后台线程定期刷盘)</li>
<li>MySQL正常关闭时(刷所有脏页)</li>
</ol>
</li>
</ul>
<p><strong>参数</strong>:</p>
<ul>
<li><code>innodb_io_capacity=200</code>: 刷盘IOPS能力(SSD可调高到1000-5000)</li>
<li><code>innodb_max_dirty_pages_pct=75</code>: 脏页比例阈值75%</li>
</ul>
<p><strong>WAL (Write-Ahead Logging) 机制核心</strong>:</p>
<p><strong>为什么先写日志,再异步刷脏页?</strong></p>
<ul>
<li><strong>Redo Log顺序写</strong> (append追加模式), 速度极快(磁盘顺序I/O约100MB/s)</li>
<li><strong>数据文件随机写</strong> (.ibd文件, 速度慢, 磁盘随机I/O约100次/s)</li>
<li><strong>事务提交时只需刷Redo Log</strong>(快), 脏页异步刷盘(慢,但不阻塞事务) → <strong>写入性能提升10-100倍</strong></li>
<li><strong>崩溃恢复</strong>: 重启后,通过Redo Log重放(redo),恢复未刷盘的脏页数据,保证事务持久性(Durability)</li>
</ul>
<p><strong>2PC (Two-Phase Commit) 两阶段提交</strong>:</p>
<p><strong>为什么需要2PC? 保证Redo Log和Binlog一致性</strong></p>
<ul>
<li>Redo Log (InnoDB引擎层) + Binlog (MySQL Server层) 两份日志,必须保持一致</li>
<li><strong>2PC流程</strong>: Redo Log prepare → 写Binlog → Redo Log commit</li>
<li><strong>崩溃恢复场景</strong>:
<ul>
<li>① prepare成功,Binlog失败 → 回滚</li>
<li>② prepare成功,Binlog成功,commit失败 → 提交(通过Binlog恢复)</li>
</ul>
</li>
<li><strong>保证主从数据一致性</strong>: Binlog用于主从复制,2PC确保主库Redo Log和从库Binlog一致</li>
</ul>
<p><strong>UPDATE执行流程关键点</strong>:</p>
<ul>
<li><strong>WAL机制</strong>: 先写日志(Redo Log/Binlog, 顺序I/O), 再异步刷脏页(数据文件, 随机I/O), 写入性能提升10-100倍</li>
<li><strong>2PC两阶段提交</strong>: 保证Redo Log和Binlog一致性, 避免主从数据不一致</li>
<li><strong>事务持久性保证</strong>: 事务提交后,即使立即崩溃,重启后通过Redo Log重放,数据不丢失</li>
</ul>
<hr/>
<h2 data-id="heading-20">五、Buffer Pool缓冲池原理与优化</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb0fc9da772440ea84459e5530cbdcbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766835402&amp;x-signature=N2miBGwfnLffaWt2X2eHxsH8ek0%3D" alt="buffer-pool-lru.svg" loading="lazy"/></p>
<h3 data-id="heading-21">5.1 Buffer Pool整体结构</h3>
<p><strong>Buffer Pool是InnoDB性能的核心</strong>,缓存数据页和索引页,减少磁盘I/O。</p>
<p><strong>Buffer Pool结构</strong>:</p>
<ul>
<li><strong>Young区</strong> (新数据区): 占Buffer Pool的5/8 (62.5%),存放热数据</li>
<li><strong>Old区</strong> (老数据区): 占Buffer Pool的3/8 (37.5%),存放冷数据</li>
<li><strong>Midpoint分界点</strong>: Young区和Old区的边界</li>
</ul>
<h3 data-id="heading-22">5.2 改进的LRU链表</h3>
<p><strong>传统LRU算法的问题</strong>:</p>
<p>全表扫描会将大量冷数据加载到缓存,挤掉热数据(缓存污染)。</p>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> large_table;  <span class="hljs-comment">-- 全表扫描,加载几百万行数据到缓存</span>
</code></pre>
<p>传统LRU: 新数据插入链表头,热数据被挤到链表尾,最终被淘汰 → <strong>缓存污染</strong></p>
<p><strong>InnoDB的改进 (Midpoint插入策略)</strong>:</p>
<ol>
<li><strong>新数据页不插入链表头,而是插入Old区头部(Midpoint位置)</strong></li>
<li><strong>只有在Old区停留≥1秒后再次访问,才移动到Young区</strong></li>
<li><strong>全表扫描的数据页只停留在Old区,不影响Young区的热数据</strong></li>
</ol>
<p><strong>参数</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">innodb_old_blocks_pct=37            <span class="hljs-comment"># Old区占比37% (默认)</span>
innodb_old_blocks_time=1000         <span class="hljs-comment"># Old区停留时间1秒 (默认)</span>
</code></pre>
<p><strong>好处</strong>:</p>
<ul>
<li><strong>全表扫描的数据页只停留在Old区,不影响Young区的热数据</strong></li>
<li><strong>真正的热数据(多次访问)才会进入Young区</strong></li>
<li><strong>有效防止缓存污染</strong></li>
</ul>
<h3 data-id="heading-23">5.3 数据页加载与淘汰流程</h3>
<p><strong>场景1: 从磁盘加载新数据页</strong></p>
<ol>
<li>检查Buffer Pool是否有空闲页</li>
<li>若无空闲,从LRU链表尾淘汰最久未使用的页</li>
<li>将新数据页加载到Buffer Pool</li>
<li><strong>插入到LRU链表的Old区头部(Midpoint)</strong></li>
<li>1秒后再次访问,移动到Young区头部</li>
</ol>
<p><strong>场景2: 脏页刷盘</strong></p>
<ul>
<li><strong>脏页</strong> = 内存中已修改但未写入磁盘的数据页</li>
<li><strong>刷盘时机</strong>:
<ul>
<li>Redo Log满了</li>
<li>Buffer Pool空间不足,需要淘汰脏页</li>
<li>MySQL空闲时,后台线程刷盘</li>
<li>MySQL正常关闭时</li>
</ul>
</li>
</ul>
<p><strong>场景3: 页被访问</strong></p>
<ol>
<li><strong>页在Young区</strong>: 不移动,避免频繁调整链表</li>
<li><strong>页在Old区</strong>:
<ul>
<li>刚进入Old区(&lt;1秒): 不移动</li>
<li>在Old区停留≥1秒: 移动到Young区头部</li>
</ul>
</li>
<li><strong>页不在Buffer Pool</strong>: 从磁盘加载(场景1)</li>
</ol>
<h3 data-id="heading-24">5.4 预读机制 (Read-Ahead)</h3>
<p><strong>预读机制</strong>: InnoDB预测即将访问的数据页,提前加载到Buffer Pool。</p>
<p><strong>1. 线性预读 (Linear Read-Ahead)</strong>:</p>
<ul>
<li>顺序访问区(Extent, 64个连续页)中的页达到阈值,预读下一个区的所有页</li>
<li>参数: <code>innodb_read_ahead_threshold=56</code> (默认56,范围0-64)</li>
<li>适用: 全表扫描、范围查询</li>
</ul>
<p><strong>2. 随机预读 (Random Read-Ahead)</strong>:</p>
<ul>
<li>同一个区中,多个页被访问,预读整个区的其他页</li>
<li>默认关闭: <code>innodb_random_read_ahead=OFF</code></li>
</ul>
<p><strong>预读的影响</strong>:</p>
<ul>
<li>✅ <strong>好处</strong>: 减少磁盘I/O,提升顺序读性能</li>
<li>❌ <strong>坏处</strong>: 可能预读无用页,浪费Buffer Pool空间</li>
</ul>
<h3 data-id="heading-25">5.5 Buffer Pool核心要点</h3>
<ul>
<li><strong>Buffer Pool是InnoDB性能的核心</strong>,缓存热数据,减少磁盘I/O</li>
<li><strong>改进的LRU算法避免全表扫描污染热数据</strong>(Old区+1秒延迟策略)</li>
<li><strong>脏页异步刷盘</strong>,WAL机制保证性能和数据持久性</li>
</ul>
<hr/>
<h2 data-id="heading-26">六、实战场景应用</h2>
<h3 data-id="heading-27">6.1 使用EXPLAIN分析执行计划</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae6579d53d6d438997a486e111fda543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766835402&amp;x-signature=goDDkWwvREh9bqhoI0an%2B89a4ik%3D" alt="explain-example.svg" loading="lazy"/></p>
<p><strong>EXPLAIN是SQL优化的第一步</strong>,分析执行计划,定位性能瓶颈。</p>
<p><strong>关键字段</strong>:</p>
<p><strong>type (访问类型,性能关键)</strong>:</p>
<ul>
<li>✅ <strong>system &gt; const &gt; eq_ref &gt; ref</strong> (优秀,使用索引精确查找)</li>
<li>⚠️ <strong>range &gt; index</strong> (可接受,索引范围扫描或索引全扫描)</li>
<li>❌ <strong>ALL</strong> (全表扫描,最差)</li>
</ul>
<p><strong>key (实际使用的索引)</strong>:</p>
<ul>
<li><strong>NULL</strong>: 未使用索引,需优化</li>
<li><strong>idx_name</strong>: 使用索引,性能好</li>
</ul>
<p><strong>rows (扫描的行数)</strong>:</p>
<ul>
<li><strong>越少越好</strong>,rows过大(如&gt;10万)需检查索引是否生效</li>
</ul>
<p><strong>Extra (额外信息)</strong>:</p>
<ul>
<li>✅ <strong>Using index</strong>: 覆盖索引,只读索引,不回表,性能最优</li>
<li>✅ <strong>Using where</strong>: 使用WHERE过滤</li>
<li>❌ <strong>Using filesort</strong>: 文件排序,性能差,需优化 → 在ORDER BY字段上建索引</li>
<li>❌ <strong>Using temporary</strong>: 使用临时表,性能差,需优化 → 在GROUP BY字段上建索引</li>
</ul>
<p><strong>示例1: 优秀的执行计划</strong></p>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN <span class="hljs-keyword">SELECT</span> id, name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">25</span>;
</code></pre>
<p><strong>结果</strong>: type=ref (优秀), key=idx_age, rows=1000</p>
<p><strong>分析</strong>: 使用idx_age索引,扫描1000行,性能良好</p>
<p><strong>示例2: 糟糕的执行计划</strong></p>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN <span class="hljs-keyword">SELECT</span> id, name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(birthday) <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;
</code></pre>
<p><strong>结果</strong>: type=ALL (全表扫描), key=NULL (未使用索引), rows=5000000</p>
<p><strong>问题</strong>:</p>
<ul>
<li>WHERE条件使用了函数<code>YEAR(birthday)</code>,导致索引失效</li>
<li>全表扫描500万行,性能极差</li>
</ul>
<p><strong>优化</strong>: 改为 <code>WHERE birthday BETWEEN '2000-01-01' AND '2000-12-31'</code>,可使用idx_birthday索引</p>
<p><strong>示例3: 文件排序</strong></p>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN <span class="hljs-keyword">SELECT</span> id, name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> birthday;
</code></pre>
<p><strong>结果</strong>: type=range, key=idx_age, Extra=<strong>Using filesort</strong></p>
<p><strong>问题</strong>: ORDER BY的字段(birthday)与WHERE条件的索引(idx_age)不同,无法利用索引排序,需要额外的filesort操作</p>
<p><strong>优化</strong>: 创建联合索引<code>idx_age_birthday(age, birthday)</code>,ORDER BY字段在索引中,避免filesort</p>
<h3 data-id="heading-28">6.2 慢查询优化实战</h3>
<p><strong>慢查询日志配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">slow_query_log=ON                           <span class="hljs-comment"># 开启慢查询日志</span>
long_query_time=1                           <span class="hljs-comment"># 慢查询阈值1秒</span>
slow_query_log_file=/var/log/mysql-slow.log
log_queries_not_using_indexes=ON            <span class="hljs-comment"># 记录未使用索引的查询</span>
</code></pre>
<p><strong>慢查询分析工具</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># mysqldumpslow: MySQL自带的慢查询分析工具</span>
mysqldumpslow -s t -t 10 /var/log/mysql-slow.log  <span class="hljs-comment"># 按时间排序,显示前10条</span>

<span class="hljs-comment"># pt-query-digest: Percona Toolkit工具(推荐)</span>
pt-query-digest /var/log/mysql-slow.log
</code></pre>
<p><strong>常见慢查询场景与优化</strong>:</p>
<p><strong>场景1: 索引失效 - 在索引列上使用函数</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 慢查询 (索引失效)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(birthday) <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;

<span class="hljs-comment">-- ✅ 优化 (使用索引)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> birthday <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2000-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2000-12-31'</span>;
</code></pre>
<p><strong>场景2: 索引失效 - 隐式类型转换</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 慢查询 (name是varchar,与数字123比较,发生隐式类型转换,索引失效)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;

<span class="hljs-comment">-- ✅ 优化</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'123'</span>;
</code></pre>
<p><strong>场景3: 索引失效 - LIKE前缀通配符</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 慢查询 (前缀通配符,索引失效)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%abc'</span>;

<span class="hljs-comment">-- ✅ 优化 (后缀通配符,可使用索引)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'abc%'</span>;
</code></pre>
<p><strong>场景4: 回表次数过多 - 使用覆盖索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 慢查询 (回表100万次)</span>
<span class="hljs-keyword">SELECT</span> id, name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;  <span class="hljs-comment">-- 假设返回100万行</span>

<span class="hljs-comment">-- ✅ 优化 (覆盖索引,无需回表)</span>
<span class="hljs-comment">-- 创建联合索引 idx_age_name_id(age, name, id)</span>
<span class="hljs-comment">-- 或者只查询索引列</span>
<span class="hljs-keyword">SELECT</span> id, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;
</code></pre>
<p><strong>场景5: 深分页问题</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 慢查询 (扫描100万+10行,丢弃100万行)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">1000000</span>, <span class="hljs-number">10</span>;

<span class="hljs-comment">-- ✅ 优化1: 使用id范围查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000000</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">10</span>;

<span class="hljs-comment">-- ✅ 优化2: 延迟关联 (先查主键,再回表)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">1000000</span>, <span class="hljs-number">10</span>);
</code></pre>
<p><strong>场景6: 未添加必要索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 慢查询 (WHERE条件列无索引)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">123</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- ✅ 优化: 创建联合索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> orders <span class="hljs-keyword">ADD</span> INDEX idx_user_id_status (user_id, status);
</code></pre>
<hr/>
<h2 data-id="heading-29">七、最佳实践与总结</h2>
<h3 data-id="heading-30">7.1 SQL编写规范</h3>
<p>**1. 避免SELECT ***:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 错误</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- ✅ 正确 (只查询需要的字段)</span>
<span class="hljs-keyword">SELECT</span> id, name, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>好处</strong>: 减少网络传输、减少Buffer Pool占用、可能使用覆盖索引</p>
<p><strong>2. WHERE条件列添加索引</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 错误 (age列无索引)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;

<span class="hljs-comment">-- ✅ 正确 (添加索引)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> INDEX idx_age (age);
</code></pre>
<p><strong>3. 避免在索引列上使用函数</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 错误 (索引失效)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(birthday) <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;

<span class="hljs-comment">-- ✅ 正确</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> birthday <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2000-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2000-12-31'</span>;
</code></pre>
<p><strong>4. 使用LIMIT限制查询结果</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 错误 (返回全部100万行)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;

<span class="hljs-comment">-- ✅ 正确 (限制返回1000行)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span> LIMIT <span class="hljs-number">1000</span>;
</code></pre>
<p><strong>5. 避免大事务,控制事务范围</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 错误 (大事务,锁定时间长)</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">26</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- ... 执行100条SQL ...</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ✅ 正确 (拆分为多个小事务)</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">26</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> age <span class="hljs-operator">=</span> <span class="hljs-number">27</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h3 data-id="heading-31">7.2 索引设计最佳实践</h3>
<p><strong>1. 高选择性字段优先建索引</strong>:</p>
<ul>
<li>✅ <strong>选择性高</strong>: 主键、唯一键、手机号、邮箱 (每个值几乎唯一)</li>
<li>❌ <strong>选择性低</strong>: 性别、状态、类型 (只有2-5个值)</li>
</ul>
<p><strong>2. 联合索引遵循最左前缀原则</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建联合索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> INDEX idx_age_name (age, name);

<span class="hljs-comment">-- ✅ 能使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">25</span>;                    <span class="hljs-comment">-- 使用age</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">25</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'Alice'</span>; <span class="hljs-comment">-- 使用age + name</span>

<span class="hljs-comment">-- ❌ 不能使用索引 (违反最左前缀原则)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'Alice'</span>;              <span class="hljs-comment">-- name不是最左列</span>
</code></pre>
<p><strong>3. 覆盖索引,避免回表</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询: SELECT id, age FROM users WHERE age &gt; 25;</span>

<span class="hljs-comment">-- ✅ 创建覆盖索引 (索引包含id, age)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">ADD</span> INDEX idx_age (age);  <span class="hljs-comment">-- id是主键,自动包含在二级索引中</span>

<span class="hljs-comment">-- 执行计划: Extra=Using index (覆盖索引,无需回表)</span>
</code></pre>
<p><strong>4. 索引列不宜过多</strong>:</p>
<ul>
<li>单表索引数量建议 ≤ 5个</li>
<li>联合索引字段数量建议 ≤ 3个</li>
<li><strong>索引过多</strong>: 影响INSERT/UPDATE/DELETE性能,占用空间</li>
</ul>
<p><strong>5. 定期清理无用索引</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询未使用的索引 (MySQL 5.7+)</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.schema_unused_indexes;

<span class="hljs-comment">-- 删除无用索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users <span class="hljs-keyword">DROP</span> INDEX idx_unused;
</code></pre>
<h3 data-id="heading-32">7.3 Buffer Pool调优</h3>
<p><strong>1. 合理设置Buffer Pool大小</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">innodb_buffer_pool_size=8G     <span class="hljs-comment"># 建议:物理内存的50-80%</span>
</code></pre>
<p><strong>监控Buffer Pool命中率</strong>:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">GLOBAL</span> STATUS <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'Innodb_buffer_pool%'</span>;

<span class="hljs-comment">-- 计算命中率</span>
Buffer Pool命中率 <span class="hljs-operator">=</span> (Innodb_buffer_pool_read_requests <span class="hljs-operator">-</span> Innodb_buffer_pool_reads) <span class="hljs-operator">/</span> Innodb_buffer_pool_read_requests

<span class="hljs-comment">-- 建议: 命中率 ≥ 99%</span>
</code></pre>
<p><strong>2. 多实例减少锁竞争</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">innodb_buffer_pool_instances=8  <span class="hljs-comment"># Buffer Pool实例数,默认8 (≥1GB时生效)</span>
</code></pre>
<h3 data-id="heading-33">7.4 日志参数调优</h3>
<p><strong>1. Redo Log配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">innodb_log_file_size=1G              <span class="hljs-comment"># Redo Log单个文件大小</span>
innodb_log_files_in_group=2          <span class="hljs-comment"># Redo Log文件数量</span>
innodb_flush_log_at_trx_commit=1     <span class="hljs-comment"># 刷盘策略:</span>
                                     <span class="hljs-comment"># 0: 每秒刷盘一次 (性能最好,但可能丢失1秒数据)</span>
                                     <span class="hljs-comment"># 1: 每次事务提交刷盘 (最安全,推荐)</span>
                                     <span class="hljs-comment"># 2: 每次提交写OS缓存,每秒刷盘 (折中)</span>
</code></pre>
<p><strong>2. Binlog配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">sync_binlog=1                        <span class="hljs-comment"># 每次事务提交刷盘(最安全)</span>
binlog_format=ROW                    <span class="hljs-comment"># ROW模式(推荐),记录行变更</span>
expire_logs_days=7                   <span class="hljs-comment"># Binlog保留7天</span>
</code></pre>
<h3 data-id="heading-34">7.5 总结</h3>
<p><strong>MySQL架构核心要点</strong>:</p>
<ol>
<li><strong>逻辑架构分为3层</strong>: 连接层、SQL层(Server层)、存储引擎层,Server层与存储引擎解耦</li>
<li><strong>InnoDB是默认引擎</strong>: 支持事务、行级锁、外键、崩溃恢复、MVCC,生产环境首选</li>
<li><strong>Buffer Pool是性能核心</strong>: 缓存数据页和索引页,减少磁盘I/O,改进的LRU算法防止缓存污染</li>
<li><strong>B+树索引结构</strong>: 3层B+树能存2000万行,查询只需3次I/O,范围查询高效</li>
<li><strong>WAL机制</strong>: 先写日志(Redo Log/Binlog),再异步刷脏页,写入性能提升10-100倍</li>
<li><strong>2PC两阶段提交</strong>: 保证Redo Log和Binlog一致性,避免主从数据不一致</li>
<li><strong>EXPLAIN是SQL优化第一步</strong>: 分析执行计划,定位性能瓶颈,type达到ref以上,避免全表扫描和Using filesort</li>
</ol>
<p><strong>性能优化建议</strong>:</p>
<ul>
<li><strong>合理设计索引</strong>: 高选择性字段优先,遵循最左前缀原则,使用覆盖索引避免回表</li>
<li><strong>避免索引失效</strong>: 不在索引列上使用函数,避免隐式类型转换,LIKE避免前缀通配符</li>
<li><strong>合理配置Buffer Pool</strong>: 设置为物理内存的50-80%,监控命中率≥99%</li>
<li><strong>使用EXPLAIN分析每条SQL</strong>: 上线前必须EXPLAIN,确保type达到ref以上</li>
<li><strong>定期Review慢查询日志</strong>: 发现性能瓶颈,及时优化</li>
</ul>
<p>掌握MySQL架构原理与执行流程,是每位后端工程师的必备技能。通过深入理解MySQL的内部运行机制,结合EXPLAIN执行计划分析和慢查询优化实战,能够在面试和实际工作中游刃有余,构建高性能、高可用的数据库系统。</p>
<hr/>
<p><strong>参考资料</strong>:</p>
<ul>
<li>《MySQL技术内幕: InnoDB存储引擎》(第2版) - 姜承尧</li>
<li>《高性能MySQL》(第4版) - Baron Schwartz等</li>
<li>MySQL官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2F" target="_blank" title="https://dev.mysql.com/doc/" ref="nofollow noopener noreferrer">dev.mysql.com/doc/</a></li>
<li>InnoDB存储引擎官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.0%2Fen%2Finnodb-storage-engine.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html" ref="nofollow noopener noreferrer">dev.mysql.com/doc/refman/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java多线程开发实战：解锁线程安全与性能优化的关键技术]]></title>    <link>https://juejin.cn/post/7585706951583842313</link>    <guid>https://juejin.cn/post/7585706951583842313</guid>    <pubDate>2025-12-20T12:00:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951583842313" data-draft-id="7585484081435787315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java多线程开发实战：解锁线程安全与性能优化的关键技术"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-20T12:00:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="okseekw"/> <meta itemprop="url" content="https://juejin.cn/user/1933379625032649"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java多线程开发实战：解锁线程安全与性能优化的关键技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1933379625032649/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    okseekw
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T12:00:17.000Z" title="Sat Dec 20 2025 12:00:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java多线程开发实战：解锁线程安全与性能优化的关键技术</h2>
<p>在现代Java开发中，多线程是提升程序性能、优化资源利用率的核心技术之一。无论是高并发的电商系统、实时通信应用，还是后台数据处理服务，都离不开多线程的支持。本文将从线程基础概念出发，逐步深入线程创建、常用方法、线程安全、线程池等核心技术，并通过实战案例帮助大家掌握多线程的实际应用。</p>
<h3 data-id="heading-1">一、线程与多线程基础认知</h3>
<h4 data-id="heading-2">1. 什么是线程？</h4>
<p>线程（Thread）是程序内部的一条执行流程，一个程序若只有一条执行流程，则为单线程程序。例如，简单的控制台输出程序通常是单线程执行的。</p>
<h4 data-id="heading-3">2. 多线程的定义与应用场景</h4>
<p>多线程是指从软硬件层面实现多条执行流程的技术，多条线程由CPU调度执行。其核心价值在于<strong>提高程序执行效率</strong>，让多个任务并行处理。</p>
<p><strong>典型应用场景</strong>：</p>
<ul>
<li>12306购票系统：同时处理成千上万用户的查询、购票请求</li>
<li>百度网盘上传下载：后台传输文件的同时，前台可进行其他操作</li>
<li>电商平台：订单处理、库存更新、消息推送等任务并行执行</li>
</ul>
<h4 data-id="heading-4">3. 并发与并行的区别</h4>
<ul>
<li><strong>并发</strong>：CPU轮询调度多个线程，由于切换速度极快，给人"同时执行"的错觉（实际同一时刻只有一个线程在执行）</li>
<li><strong>并行</strong>：同一时刻多个线程被CPU同时调度执行（需多核CPU支持）</li>
</ul>
<h3 data-id="heading-5">二、Java多线程的三种创建方式</h3>
<p>Java提供了三种主流的线程创建方式，各有优劣，适用于不同场景。</p>
<h4 data-id="heading-6">1. 继承Thread类</h4>
<p>这是最基础的创建方式，步骤简单直接。</p>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>定义子类继承<code>java.lang.Thread</code></li>
<li>重写<code>run()</code>方法，编写线程任务逻辑</li>
<li>创建子类对象，调用<code>start()</code>方法启动线程</li>
</ol>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDemo1</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 创建线程对象</span>
        Thread t1 = <span class="hljs-keyword">new</span> MyThread();
        <span class="hljs-comment">// 启动线程（必须调用start()，而非直接调用run()）</span>
        t1.start();

        <span class="hljs-comment">// 主线程任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"主线程输出："</span> + i);
        }
    }
}

<span class="hljs-comment">// 自定义线程类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">MyThread</span> <span class="hljs-title">extends</span> <span class="hljs-title">Thread</span> {
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
        <span class="hljs-comment">// 子线程任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"子线程输出："</span> + i);
        }
    }
}
</code></pre>
<p><strong>优缺点</strong>：</p>
<ul>
<li>优点：编码简单，可直接使用Thread类的方法</li>
<li>缺点：Java单继承限制，线程类无法继承其他类，扩展性差</li>
</ul>
<h4 data-id="heading-7">2. 实现Runnable接口</h4>
<p>推荐使用的创建方式，规避了单继承限制，扩展性更强。</p>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>定义任务类实现<code>Runnable</code>接口</li>
<li>重写<code>run()</code>方法，编写任务逻辑</li>
<li>创建任务对象，交给Thread处理</li>
<li>调用<code>start()</code>方法启动线程</li>
</ol>
<p><strong>代码示例</strong>（含匿名内部类简化写法）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDemo2_2</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 方式1：常规写法</span>
        Runnable r = <span class="hljs-keyword">new</span> Runnable() {
            @Override
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"子线程1输出："</span> + i);
                }
            }
        };
        <span class="hljs-keyword">new</span> Thread(r).start();

        <span class="hljs-comment">// 方式2：匿名内部类简化</span>
        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {
            @Override
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"子线程2输出："</span> + i);
                }
            }
        }).start();

        <span class="hljs-comment">// 方式3：Lambda表达式（JDK8+）</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"子线程3输出："</span> + i);
            }
        }).start();

        <span class="hljs-comment">// 主线程任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"主线程输出："</span> + i);
        }
    }
}
</code></pre>
<p><strong>优缺点</strong>：</p>
<ul>
<li>优点：任务类可继承其他类、实现其他接口，扩展性强</li>
<li>缺点：无法直接返回线程执行结果</li>
</ul>
<h4 data-id="heading-8">3. 实现Callable接口（JDK5+）</h4>
<p>解决了前两种方式无法返回执行结果的问题，适用于需要获取线程执行结果的场景。</p>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>定义任务类实现<code>Callable</code>接口，指定返回值类型</li>
<li>重写<code>call()</code>方法（可抛出异常），编写任务逻辑并返回结果</li>
<li>将Callable对象封装为<code>FutureTask</code>（兼具Runnable和结果获取功能）</li>
<li>交给Thread处理并启动线程</li>
<li>通过<code>FutureTask.get()</code>方法获取执行结果</li>
</ol>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.Callable;
<span class="hljs-keyword">import</span> java.util.concurrent.FutureTask;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadDemo3</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 创建Callable任务对象</span>
        Callable&lt;String&gt; c1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCallable</span>(<span class="hljs-number">100</span>);
        Callable&lt;String&gt; c2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCallable</span>(<span class="hljs-number">50</span>);

        <span class="hljs-comment">// 封装为FutureTask</span>
        FutureTask&lt;String&gt; f1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureTask</span>&lt;&gt;(c1);
        FutureTask&lt;String&gt; f2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureTask</span>&lt;&gt;(c2);

        <span class="hljs-comment">// 启动线程</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(f1).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(f2).start();

        <span class="hljs-comment">// 获取执行结果（主线程会阻塞直到结果返回）</span>
        System.out.println(f1.get());
        System.out.println(f2.get());
    }
}

<span class="hljs-comment">// 自定义Callable任务类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCallable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;String&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> n;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyCallable</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-built_in">this</span>.n = n;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= n; i++) {
            sum += i;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"1-"</span> + n + <span class="hljs-string">"的和是："</span> + sum;
    }
}
</code></pre>
<p><strong>优缺点</strong>：</p>
<ul>
<li>优点：扩展性强，可获取线程执行结果</li>
<li>缺点：编码相对复杂，获取结果时可能阻塞</li>
</ul>
<h3 data-id="heading-9">三、线程常用核心方法</h3>

































<table><thead><tr><th>方法名</th><th>功能说明</th></tr></thead><tbody><tr><td><code>start()</code></td><td>启动线程，JVM调用<code>run()</code>方法</td></tr><tr><td><code>run()</code></td><td>线程任务逻辑所在，不可直接调用</td></tr><tr><td><code>getName()</code>/<code>setName()</code></td><td>获取/设置线程名称</td></tr><tr><td><code>currentThread()</code></td><td>获取当前执行的线程对象</td></tr><tr><td><code>sleep(long millis)</code></td><td>让当前线程休眠指定毫秒数</td></tr><tr><td><code>join()</code></td><td>让调用线程先执行完毕，其他线程再继续</td></tr></tbody></table>
<p><strong>关键方法示例</strong>：</p>
<ol>
<li><strong>线程休眠（sleep）</strong> ：</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThreadApiDemo2</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"main线程输出："</span> + i);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 休眠1秒</span>
                Thread.sleep(<span class="hljs-number">1000</span>);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<ol start="2">
<li><strong>线程插队（join）</strong> ：</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThreadApiDemo3</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>) throws InterruptedException</span> {
        MyThread2 t1 = <span class="hljs-keyword">new</span> MyThread2();
        t1.start();

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"主线程输出："</span> + i);
            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">3</span>) {
                <span class="hljs-comment">// 让t1线程插队，执行完毕后主线程再继续</span>
                t1.<span class="hljs-keyword">join</span>();
            }
        }
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title">MyThread2</span> <span class="hljs-title">extends</span> <span class="hljs-title">Thread</span> {
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"子线程输出："</span> + i);
        }
    }
}
</code></pre>
<h3 data-id="heading-10">四、线程安全问题与解决方案</h3>
<h4 data-id="heading-11">1. 线程安全问题的产生条件</h4>
<p>当满足以下三个条件时，会出现线程安全问题：</p>
<ul>
<li>多个线程同时执行</li>
<li>线程共享同一个资源</li>
<li>线程对共享资源进行修改操作</li>
</ul>
<p><strong>模拟线程安全问题</strong>（银行取款案例）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 账户类（共享资源）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> cardId;
    <span class="hljs-keyword">private</span> double money;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">drawMoney</span>(<span class="hljs-params">double money</span>) {
        <span class="hljs-title class_">String</span> name = <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">getName</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">money</span> &gt;= money) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(name + <span class="hljs-string">"取钱成功，吐出"</span> + money + <span class="hljs-string">"元"</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">money</span> -= money;
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"余额："</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">money</span> + <span class="hljs-string">"元"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(name + <span class="hljs-string">"取钱失败，余额不足"</span>);
        }
    }
}

<span class="hljs-comment">// 取款线程</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DrawThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Thread</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Account</span> account;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DrawThread</span>(<span class="hljs-title class_">String</span> name, <span class="hljs-title class_">Account</span> account) {
        <span class="hljs-variable language_">super</span>(name);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">account</span> = account;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
        account.<span class="hljs-title function_">drawMoney</span>(<span class="hljs-number">100000</span>);
    }
}

<span class="hljs-comment">// 测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadDemo1</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 同一个账户，初始余额10万</span>
        <span class="hljs-title class_">Account</span> account = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"ICBC-110"</span>, <span class="hljs-number">100000</span>);
        <span class="hljs-comment">// 两个线程同时取款10万</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">DrawThread</span>(<span class="hljs-string">"小明"</span>, account).<span class="hljs-title function_">start</span>();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">DrawThread</span>(<span class="hljs-string">"小红"</span>, account).<span class="hljs-title function_">start</span>();
    }
}
</code></pre>
<p><strong>问题现象</strong>：可能出现小明和小红同时取款成功，余额变为负数的情况。</p>
<h4 data-id="heading-12">2. 线程同步解决方案</h4>
<p>核心思想：让多个线程<strong>先后依次访问</strong>共享资源，避免并发修改。</p>
<h5 data-id="heading-13">（1）同步代码块</h5>
<p>将访问共享资源的核心代码上锁，每次只允许一个线程进入执行。</p>
<p><strong>语法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span> (锁对象) {
    <span class="hljs-comment">// 访问共享资源的核心代码</span>
}
</code></pre>
<p><strong>优化后的账户类</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> String cardId;
    <span class="hljs-keyword">private</span> double money;

    <span class="hljs-keyword">public</span> void drawMoney(double money) {
        String name = Thread.currentThread().getName();
        <span class="hljs-comment">// 锁对象：推荐使用共享资源本身（this）</span>
        synchronized (<span class="hljs-keyword">this</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.money &gt;= money) {
                System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"取钱成功，吐出"</span> + money + <span class="hljs-string">"元"</span>);
                <span class="hljs-keyword">this</span>.money -= money;
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"余额："</span> + <span class="hljs-keyword">this</span>.money + <span class="hljs-string">"元"</span>);
            } <span class="hljs-keyword">else</span> {
                System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"取钱失败，余额不足"</span>);
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-14">（2）同步方法</h5>
<p>将整个方法上锁，简化同步代码块的写法。</p>
<p><strong>语法</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">修饰符 <span class="hljs-keyword">synchronized</span> 返回值类型 方法名(参数列表) {
    <span class="hljs-comment">// 操作共享资源的代码</span>
}
</code></pre>
<p><strong>优化后的取款方法</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">drawMoney</span>(<span class="hljs-params"><span class="hljs-built_in">double</span> money</span>)</span> {
    String name = Thread.currentThread().getName();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.money &gt;= money) {
        System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"取钱成功，吐出"</span> + money + <span class="hljs-string">"元"</span>);
        <span class="hljs-keyword">this</span>.money -= money;
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"余额："</span> + <span class="hljs-keyword">this</span>.money + <span class="hljs-string">"元"</span>);
    } <span class="hljs-keyword">else</span> {
        System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"取钱失败，余额不足"</span>);
    }
}
</code></pre>
<p><strong>底层原理</strong>：</p>
<ul>
<li>实例方法：默认使用<code>this</code>作为锁对象</li>
<li>静态方法：默认使用<code>类名.class</code>作为锁对象</li>
</ul>
<h5 data-id="heading-15">（3）Lock锁（JDK5+）</h5>
<p><code>java.util.concurrent.locks.Lock</code>接口提供了更灵活的锁定操作，推荐使用其实现类<code>ReentrantLock</code>。</p>
<p><strong>核心方法</strong>：</p>
<ul>
<li><code>lock()</code>：获取锁</li>
<li><code>unlock()</code>：释放锁（建议在<code>finally</code>中执行，确保锁一定释放）</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.locks.Lock;
<span class="hljs-keyword">import</span> java.util.concurrent.locks.ReentrantLock;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> String cardId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> money;
    <span class="hljs-comment">// 创建Lock锁对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawMoney</span><span class="hljs-params">(<span class="hljs-type">double</span> money)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();
        lock.lock(); <span class="hljs-comment">// 加锁</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.money &gt;= money) {
                System.out.println(name + <span class="hljs-string">"取钱成功，吐出"</span> + money + <span class="hljs-string">"元"</span>);
                <span class="hljs-built_in">this</span>.money -= money;
                System.out.println(<span class="hljs-string">"余额："</span> + <span class="hljs-built_in">this</span>.money + <span class="hljs-string">"元"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(name + <span class="hljs-string">"取钱失败，余额不足"</span>);
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock(); <span class="hljs-comment">// 释放锁（无论是否异常，都必须释放）</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-16">五、线程池技术（JDK5+）</h3>
<h4 data-id="heading-17">1. 线程池的核心价值</h4>
<ul>
<li>避免频繁创建和销毁线程的开销（线程创建成本高）</li>
<li>控制线程数量，防止线程过多导致系统资源耗尽</li>
<li>复用线程，提高程序响应速度</li>
</ul>
<h4 data-id="heading-18">2. 线程池的创建方式</h4>
<h5 data-id="heading-19">（1）通过ThreadPoolExecutor手动创建（推荐）</h5>
<p><code>ThreadPoolExecutor</code>是线程池的核心实现类，可灵活配置参数。</p>
<p><strong>构造器参数说明</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPoolExecutor</span><span class="hljs-params">(
    <span class="hljs-type">int</span> corePoolSize, <span class="hljs-comment">// 核心线程数（常驻线程）</span>
    <span class="hljs-type">int</span> maximumPoolSize, <span class="hljs-comment">// 最大线程数（核心+临时线程）</span>
    <span class="hljs-type">long</span> keepAliveTime, <span class="hljs-comment">// 临时线程空闲时间</span>
    TimeUnit unit, <span class="hljs-comment">// 时间单位</span>
    BlockingQueue&lt;Runnable&gt; workQueue, <span class="hljs-comment">// 任务队列</span>
    ThreadFactory threadFactory, <span class="hljs-comment">// 线程工厂（创建线程）</span>
    RejectedExecutionHandler handler <span class="hljs-comment">// 任务拒绝策略</span>
)</span>
</span></code></pre>
<p><strong>任务拒绝策略</strong>：</p>

























<table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td>AbortPolicy</td><td>丢弃任务并抛出异常（默认）</td></tr><tr><td>DiscardPolicy</td><td>丢弃任务，不抛出异常</td></tr><tr><td>DiscardOldestPolicy</td><td>丢弃队列中最久的任务，加入新任务</td></tr><tr><td>CallerRunsPolicy</td><td>由提交任务的线程（如主线程）直接执行</td></tr></tbody></table>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutorServiceDemo1</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建线程池</span>
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            <span class="hljs-number">3</span>, <span class="hljs-comment">// 核心线程数3</span>
            <span class="hljs-number">5</span>, <span class="hljs-comment">// 最大线程数5</span>
            <span class="hljs-number">10</span>, <span class="hljs-comment">// 临时线程空闲10秒后销毁</span>
            TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">3</span>), <span class="hljs-comment">// 任务队列容量3</span>
            Executors.defaultThreadFactory(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy() <span class="hljs-comment">// 拒绝策略</span>
        );

        <span class="hljs-comment">// 提交任务（Runnable）</span>
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">9</span>; i++) {
            pool.execute(task);
        }

        <span class="hljs-comment">// 关闭线程池（一般不主动关闭，除非程序结束）</span>
        <span class="hljs-comment">// pool.shutdown(); // 等待所有任务执行完毕后关闭</span>
    }
}
</code></pre>
<h5 data-id="heading-20">（2）通过Executors工具类创建（不推荐在大型系统中使用）</h5>
<p>Executors提供了简化的线程池创建方法，但存在资源耗尽风险：</p>
<ul>
<li><code>newFixedThreadPool(int n)</code>：固定线程数的线程池</li>
<li><code>newSingleThreadExecutor()</code>：单线程线程池</li>
<li><code>newCachedThreadPool()</code>：缓存线程池（线程数可无限增长）</li>
<li><code>newScheduledThreadPool(int corePoolSize)</code>：定时任务线程池</li>
</ul>
<p><strong>风险说明</strong>（阿里巴巴Java开发手册）：</p>
<ul>
<li><code>FixedThreadPool</code>和<code>SingleThreadExecutor</code>：任务队列长度为<code>Integer.MAX_VALUE</code>，可能堆积大量任务导致OOM</li>
<li><code>CachedThreadPool</code>和<code>ScheduledThreadPool</code>：最大线程数为<code>Integer.MAX_VALUE</code>，可能创建大量线程导致OOM</li>
</ul>
<h3 data-id="heading-21">六、实战案例：红包雨游戏</h3>
<h4 data-id="heading-22">需求说明</h4>
<ul>
<li>100名员工（100个线程）抢200个红包</li>
<li>小红包（1-30元）占80%（160个），大红包（31-100元）占20%（40个）</li>
<li>输出抢红包过程，活动结束后按员工抢到的总金额降序排序</li>
</ul>
<h4 data-id="heading-23">核心思路</h4>
<ol>
<li>生成符合要求的红包集合（线程共享资源）</li>
<li>100个线程并发抢红包，通过同步机制保证线程安全</li>
<li>统计每个员工抢到的总金额，排序后展示</li>
</ol>
<h4 data-id="heading-24">完整代码</h4>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.*;

<span class="hljs-comment">// 红包抢夺线程</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">PeopleGetRedPacket</span> <span class="hljs-title">extends</span> <span class="hljs-title">Thread</span> {
    <span class="hljs-keyword">private</span> List&lt;Integer&gt; redPackets;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Integer&gt; totalMoneyMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(); <span class="hljs-comment">// 统计总金额</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PeopleGetRedPacket</span>(<span class="hljs-params">List&lt;Integer&gt; redPackets, String name</span>)</span> {
        super(name);
        <span class="hljs-keyword">this</span>.redPackets = redPackets;
        totalMoneyMap.put(name, <span class="hljs-number">0</span>); <span class="hljs-comment">// 初始化总金额为0</span>
    }

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
        String name = Thread.currentThread().getName();
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            synchronized (redPackets) {
                <span class="hljs-keyword">if</span> (redPackets.isEmpty()) {
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-comment">// 随机抢夺一个红包</span>
                <span class="hljs-built_in">int</span> index = <span class="hljs-keyword">new</span> Random().nextInt(redPackets.size());
                Integer money = redPackets.<span class="hljs-keyword">remove</span>(index);
                System.<span class="hljs-keyword">out</span>.println(name + <span class="hljs-string">"抢到红包："</span> + money + <span class="hljs-string">"元"</span>);
                <span class="hljs-comment">// 更新总金额</span>
                totalMoneyMap.put(name, totalMoneyMap.<span class="hljs-keyword">get</span>(name) + money);
                <span class="hljs-keyword">if</span> (redPackets.isEmpty()) {
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n红包雨结束！"</span>);
                    <span class="hljs-comment">// 排序并展示结果</span>
                    showResult();
                    <span class="hljs-keyword">break</span>;
                }
            }
        }
    }

    <span class="hljs-comment">// 展示抢红包结果（按总金额降序）</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showResult</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== 抢红包结果排名 ==="</span>);
        <span class="hljs-comment">// 将map转换为list并排序</span>
        List&lt;Map.Entry&lt;String, Integer&gt;&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(totalMoneyMap.entrySet());
        list.sort((o1, o2) -&gt; o2.getValue() - o1.getValue());

        <span class="hljs-comment">// 输出排名</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; list.size(); i++) {
            Map.Entry&lt;String, Integer&gt; entry = list.<span class="hljs-keyword">get</span>(i);
            System.<span class="hljs-keyword">out</span>.println((i + <span class="hljs-number">1</span>) + <span class="hljs-string">"、"</span> + entry.getKey() + <span class="hljs-string">" 总金额："</span> + entry.getValue() + <span class="hljs-string">"元"</span>);
        }
    }
}

<span class="hljs-comment">// 测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ThreadTest</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 生成200个红包</span>
        List&lt;Integer&gt; redPackets = getRedPackets();
        <span class="hljs-comment">// 创建100个员工线程抢红包</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100</span>; i++) {
            <span class="hljs-keyword">new</span> PeopleGetRedPacket(redPackets, <span class="hljs-string">"员工"</span> + i).start();
        }
    }

    <span class="hljs-comment">// 生成红包：160个小红包，40个大红包</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;Integer&gt; <span class="hljs-title">getRedPackets</span>()</span> {
        List&lt;Integer&gt; redPackets = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        Random random = <span class="hljs-keyword">new</span> Random();
        <span class="hljs-comment">// 小红包（1-30元）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">160</span>; i++) {
            redPackets.<span class="hljs-keyword">add</span>(random.nextInt(<span class="hljs-number">30</span>) + <span class="hljs-number">1</span>);
        }
        <span class="hljs-comment">// 大红包（31-100元）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">40</span>; i++) {
            redPackets.<span class="hljs-keyword">add</span>(random.nextInt(<span class="hljs-number">70</span>) + <span class="hljs-number">31</span>);
        }
        <span class="hljs-keyword">return</span> redPackets;
    }
}
</code></pre>
<h3 data-id="heading-25">七、总结</h3>
<p>Java多线程技术是一把"双刃剑"：合理使用能大幅提升程序性能，但如果处理不当（如线程安全问题、资源耗尽），会导致程序异常甚至崩溃。</p>
<p><strong>核心要点回顾</strong>：</p>
<ol>
<li>线程创建优先选择<code>Runnable</code>或<code>Callable</code>接口，规避单继承限制</li>
<li>线程安全问题需通过同步代码块、同步方法或Lock锁解决</li>
<li>线程池推荐使用<code>ThreadPoolExecutor</code>手动创建，明确配置参数</li>
<li>高并发场景需注意资源控制，避免OOM等风险</li>
</ol>
<p>掌握多线程技术需要不断实践，在实际开发中需根据业务场景选择合适的技术方案，平衡性能与安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NestJS 架构设计系列：应用服务与领域服务的区别]]></title>    <link>https://juejin.cn/post/7585458459166375970</link>    <guid>https://juejin.cn/post/7585458459166375970</guid>    <pubDate>2025-12-20T12:32:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585458459166375970" data-draft-id="7585452404113424399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NestJS 架构设计系列：应用服务与领域服务的区别"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-12-20T12:32:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄永标hyb"/> <meta itemprop="url" content="https://juejin.cn/user/8451822197277"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NestJS 架构设计系列：应用服务与领域服务的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451822197277/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄永标hyb
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T12:32:10.000Z" title="Sat Dec 20 2025 12:32:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在上一篇文章《<a href="https://juejin.cn/post/7578198815729696768" target="_blank" title="https://juejin.cn/post/7578198815729696768">NestJS 架构设计：5 分钟抓住 DDD 的命脉</a>》中，我们介绍了 DDD （领域驱动设计）的经典分层架构。其中，应用层与领域层分别对应两类关键服务：</p>
<ul>
<li><strong>应用服务（Application Service / Usecase）</strong>：位于应用层，负责流程编排；</li>
<li><strong>领域服务（Domain Service）</strong>：位于领域层，承载核心业务规则。</li>
</ul>
<blockquote>
<p>简单来说：应用服务表达用户想做什么，领域服务表达业务该怎么做。</p>
</blockquote>
<p>以创建订单为例：</p>
<ul>
<li><strong>应用服务</strong>：用户点击结算 → 计算金额 → 发起支付 → 创建订单 → 通知用户；</li>
<li><strong>领域服务</strong>：金额计算、支付处理、订单状态变更等具体业务规则。</li>
</ul>
<p>应用服务负责<strong>串联整个用例流程</strong>，而领域服务则专注于<strong>每个环节的业务实现</strong>。</p>
<h2 data-id="heading-1">应用服务（Usecase）</h2>
<p>应用服务是表达具体业务场景（如取消订单、创建支付）的主要载体，它对应用户发起的一个完整操作流程。</p>
<h3 data-id="heading-2">核心职责</h3>
<p>应用服务本质上是一个协调器，其职责包括：</p>
<ul>
<li>协调多个领域对象与领域服务；</li>
<li>控制业务用例的执行顺序；</li>
<li>组装并返回最终结果。</li>
</ul>
<p>尽管应用层不应包含核心业务逻辑，但它可以合理处理以下非核心但必要的横切关注点：<strong>权限校验、事务控制、结果组装、发送通知（邮件、消息等非核心业务）</strong>。</p>
<h3 data-id="heading-3">代码示例</h3>
<p>我们来看一个真实 NestJS 项目中的应用服务 <code>CancelOrderUsecase</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrderStatus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/modules/payment/client/constant/Order'</span>;
<span class="hljs-comment">// ... 省略其他 imports</span>

@<span class="hljs-title class_">Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CancelOrderUsecase</span> {
  @<span class="hljs-title class_">Inject</span>()
  private readonly <span class="hljs-attr">dataAssembler</span>: <span class="hljs-title class_">DataAssembler</span>;

  @<span class="hljs-title class_">Inject</span>()
  private readonly <span class="hljs-attr">cancelOrderByOrderIdService</span>: <span class="hljs-title class_">CancelOrderByOrderIdService</span>;

  @<span class="hljs-title class_">Inject</span>()
  private readonly <span class="hljs-attr">getOrderByOrderIdService</span>: <span class="hljs-title class_">GetOrderByOrderIdService</span>;

  @<span class="hljs-title class_">Inject</span>()
  private readonly <span class="hljs-attr">validatePaymentRelatedEntityPrivilegeService</span>: <span class="hljs-title class_">ValidatePaymentRelatedEntityPrivilegeService</span>;

  @<span class="hljs-title class_">Inject</span>()
  private readonly <span class="hljs-attr">stripeService</span>: <span class="hljs-title class_">StripeService</span>;
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">orderId: number, userId: number</span>) {
    <span class="hljs-comment">// 1. 获取订单信息</span>
    <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">getOrderByOrderIdService</span>.<span class="hljs-title function_">execute</span>(orderId);

    <span class="hljs-comment">// 2. 状态校验</span>
    <span class="hljs-keyword">if</span> (order.<span class="hljs-property">status</span> === <span class="hljs-title class_">OrderStatus</span>.<span class="hljs-property">Pending</span>) <span class="hljs-keyword">throw</span> <span class="hljs-title class_">ExceptionFactory</span>.<span class="hljs-title function_">bizException</span>(<span class="hljs-title class_">ErrorCode</span>.<span class="hljs-property">INVALID_PARAM</span>);

    <span class="hljs-comment">// 3. 权限验证</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">validatePaymentRelatedEntityPrivilegeService</span>.<span class="hljs-title function_">execute</span>({
      <span class="hljs-attr">entityId</span>: order.<span class="hljs-property">entityId</span>,
      <span class="hljs-attr">entityType</span>: order.<span class="hljs-property">entityType</span>,
      userId,
    });

    <span class="hljs-comment">// 4. 调用领域服务执行核心业务</span>
    <span class="hljs-keyword">const</span> cancelResult = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelOrderByOrderIdService</span>.<span class="hljs-title function_">execute</span>(orderId);

    <span class="hljs-comment">// 5. 处理第三方服务（非核心业务）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">configService</span>.<span class="hljs-property">bizConfig</span>.<span class="hljs-property">isGlobalEdition</span> &amp;&amp; order.<span class="hljs-property">paymentInfo</span>.<span class="hljs-property">invoice</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">stripeService</span>.<span class="hljs-title function_">voidInvoice</span>(order.<span class="hljs-property">paymentInfo</span>.<span class="hljs-property">invoice</span>.<span class="hljs-property">id</span>);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 第三方调用失败不影响主流程</span>
      }
    }

    <span class="hljs-comment">// 6. 发送通知（非核心业务）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendNotification</span>(order, userId);

    <span class="hljs-comment">// 7. 组装返回结果</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataAssembler</span>.<span class="hljs-property">assemble</span>&lt;<span class="hljs-title class_">EntityDTO</span>&lt;<span class="hljs-title class_">Order</span>&gt;&gt;({
      <span class="hljs-attr">domainObject</span>: cancelResult,
    });

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">SingleResponse</span>.<span class="hljs-title function_">of</span>(result);
  }
}
</code></pre>
<p>从以上代码我们可以知道应用服务的特点：</p>
<ul>
<li><strong>不包含业务逻辑</strong>：订单取消的核心逻辑由 <code>CancelOrderByOrderIdService</code> 领域服务实现；</li>
<li><strong>编排多个服务</strong>：依次调用查询、验证、取消等服务；</li>
<li><strong>处理非核心业务</strong>：发送通知、调用 Stripe 第三方 API；</li>
<li><strong>组装返回结果</strong>：通过 <code>DataAssembler</code> 将领域对象转换为 DTO。</li>
</ul>
<h2 data-id="heading-4">领域服务（Domain Service）</h2>
<p>并非所有业务逻辑都能自然地归属到某个<strong>实体</strong>或<strong>值对象</strong>中。当一个操作涉及多个聚合、需要协调多个领域对象，或本身是无状态的业务规则时，我们就将其抽为<strong>领域服务</strong>。</p>
<p>它是领域层的重要组成部分，专注于实现核心业务逻辑，但仅限于那些<strong>不属于任何单一领域对象</strong>的场景。</p>
<h3 data-id="heading-5">核心原则</h3>
<p>领域服务的设计遵循以下核心原则：</p>
<ul>
<li><strong>单一职责</strong>：每个服务专注于一个具体的业务操作；</li>
<li><strong>无状态</strong>：状态由领域对象（如实体 Entity）保存，领域服务本身不持有状态；</li>
<li><strong>可复用性</strong>：可以被多个应用服务调用以执行相同的业务逻辑；</li>
<li><strong>纯粹性</strong>：只处理核心业务逻辑，避免混入非业务相关的代码。</li>
</ul>
<h3 data-id="heading-6">什么时候使用领域服务？</h3>
<ul>
<li>当需要执行一个显著的业务操作过程时；</li>
<li>对领域对象进行转换或计算；</li>
<li>当业务逻辑涉及多个领域对象，并且需要返回一个值对象作为结果时。</li>
</ul>
<h3 data-id="heading-7">代码示例</h3>
<p>我们同样来看一个真实 NestJS 项目中的领域服务 <code>TransferUserCreditToTeamService</code>（用户积分转团队）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">{
  userId,
  teamId,
  transactionId,
  userCreditHistoryData,
  teamCreditHistoryData,
  amount,
}: {
  userId: number;
  teamId: number;
  transactionId: string;
  amount: number;
  userCreditHistoryData: Record&lt;string, unknown&gt;;
  teamCreditHistoryData: Record&lt;string, unknown&gt;;
}</span>) {
  <span class="hljs-comment">// 开启事务前的准备工作</span>
  <span class="hljs-keyword">const</span> knex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">teamCreditRepository</span>.<span class="hljs-title function_">getKnex</span>();
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateRedisLock</span>(teamId);
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">teamCreditRepository</span>.<span class="hljs-title function_">findOrCreateOne</span>(teamId);
  <span class="hljs-keyword">const</span> userCredit = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userCreditRepository</span>.<span class="hljs-title function_">findOrCreateOne</span>(userId);
  
  <span class="hljs-comment">// 业务规则校验：余额是否足够</span>
  <span class="hljs-keyword">if</span> (userCredit.<span class="hljs-property">amount</span> &lt; amount) {
    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`user <span class="hljs-subst">${userId}</span> credit not enough`</span>);
  }
  
  <span class="hljs-comment">// 创建 Stripe 余额记录</span>
  <span class="hljs-keyword">const</span> balanceTransactionId = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createStripeCustomerBalance</span>(...);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> knex.<span class="hljs-title function_">transaction</span>(<span class="hljs-keyword">async</span> (trx) =&gt; {
      <span class="hljs-comment">// 事务内的业务逻辑：</span>
      <span class="hljs-comment">// 1. 检查流水是否已存在（幂等性）</span>
      <span class="hljs-comment">// 2. 扣减用户积分</span>
      <span class="hljs-comment">// 3. 增加团队积分</span>
      <span class="hljs-comment">// 4. 校验最终状态</span>
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> error;
  }
  
  <span class="hljs-comment">// 发布领域事件</span>
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">domainEventPublisher</span>.<span class="hljs-title function_">publishSync</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCreditHistoryCreatedEvent</span>(...)
  );
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">domainEventPublisher</span>.<span class="hljs-title function_">publishSync</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TeamCreditHistoryCreatedEvent</span>(...)
  );
}
</code></pre>
<p>这个领域服务具体展示了以下几个方面：</p>
<ul>
<li><strong>业务规则</strong>：如余额校验、流水幂等性检查；</li>
<li><strong>事务处理</strong>：确保转账过程中的原子性，保障数据一致性；</li>
<li><strong>领域事件</strong>：过发布领域事件通知其他聚合关于积分变动的信息。</li>
</ul>
<h2 data-id="heading-8">实体（Entity）与领域服务的职责划分</h2>
<p>在前面介绍中，我们提到了<strong>实体（Entity）和值对象</strong>，在 DDD 中，<strong>业务逻辑应优先内聚在实体或值对象中</strong>。只有当某个行为无法自然归属于单一实体（例如涉及多个聚合、无状态操作、或跨对象协作）时，<strong>才将其提取为领域服务</strong>。</p>
<p>那么，具体如何判断一段逻辑该放在哪里？可以从以下几个维度进行权衡：</p>






























<table><thead><tr><th>维度</th><th>实体（Entity）</th><th>领域服务（Domain Service</th></tr></thead><tbody><tr><td>状态依赖</td><td>逻辑强依赖于自身状态（如实例属性）</td><td>无状态，不持有数据，仅基于输入参数执行操作</td></tr><tr><td>作用范围</td><td>仅操作当<strong>前实体实例</strong></td><td>通常涉及<strong>多个实体、聚合或值对象</strong></td></tr><tr><td>聚合边界</td><td>不应跨越聚合边界（即不直接操作其他聚合根）</td><td>可协调<strong>多个聚合</strong>之间的交互（但需谨慎）多个领域对象</td></tr><tr><td>内聚性</td><td>行为是该实体<strong>天然具备的能力</strong>（如 order.cancel()）</td><td>行为是<strong>外部赋予的协作逻辑</strong>（如 transferCredit(user, team)）</td></tr></tbody></table>
<p>来看一个真实 NestJS 项目中的 <code>Order</code> 实体中的行为：</p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-title class_">Property</span>({ <span class="hljs-attr">persist</span>: <span class="hljs-literal">false</span> })
<span class="hljs-keyword">get</span> <span class="hljs-title function_">paymentInfo</span>(): <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_paymentInfo</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> databaseValue =
      <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_paymentInfo</span> === <span class="hljs-string">'string'</span>
        ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_paymentInfo</span>)
        : <span class="hljs-variable language_">this</span>.<span class="hljs-property">_paymentInfo</span>;
    <span class="hljs-keyword">const</span> clone = <span class="hljs-title function_">cloneDeep</span>(databaseValue);

    <span class="hljs-comment">// 基于当前订单 ID 生成预览路径（强依赖 this.id）</span>
    <span class="hljs-keyword">if</span> (
      clone.<span class="hljs-property">credential</span>?.<span class="hljs-property">receiptFiles</span>?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>
    ) {
      clone.<span class="hljs-property">credential</span>.<span class="hljs-property">receiptFiles</span> = clone.<span class="hljs-property">credential</span>.<span class="hljs-property">receiptFiles</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span>
        <span class="hljs-title function_">getCredentialImagePreviewPath</span>(<span class="hljs-title class_">String</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>), item)
      );
    }

    <span class="hljs-keyword">return</span> clone;
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> {};
  }
}

<span class="hljs-keyword">set</span> <span class="hljs-title function_">paymentInfo</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">const</span> parsed = <span class="hljs-title function_">safeJsonParse</span>(value, {});

  <span class="hljs-comment">// 清理路径前缀（同样依赖 this.id）</span>
  <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">credential</span>?.<span class="hljs-property">receiptFiles</span>?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    parsed.<span class="hljs-property">credential</span>.<span class="hljs-property">receiptFiles</span> = parsed.<span class="hljs-property">credential</span>.<span class="hljs-property">receiptFiles</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span>
      <span class="hljs-title function_">removeCredentialImagePrefix</span>(<span class="hljs-title class_">String</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>), item)
    );
  }

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_paymentInfo</span> = parsed;
}
</code></pre>
<p>这段逻辑：</p>
<ul>
<li>完全基于 <code>this.id</code> 和 <code>this._paymentInfo</code> 运行；</li>
<li>不调用其他聚合或服务；</li>
<li>是对自身持久化数据的视图转换，而非业务决策。</li>
</ul>
<p>因此，它非常适合放在实体内部，既保持了内聚性，又避免了不必要的服务膨胀。</p>
<p>最后，<strong>应用服务</strong>和<strong>领域服务</strong>的区别已介绍完毕，阅读本篇文章最好结合上篇文章《<a href="https://juejin.cn/post/7578198815729696768" target="_blank" title="https://juejin.cn/post/7578198815729696768">NestJS 架构设计：5 分钟抓住 DDD 的命脉</a>》一起阅读，可能会更好理解，如果你觉得有什么地方遗漏、疑惑，欢迎评论讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL主从延迟飙升？元数据锁可能是“真凶”]]></title>    <link>https://juejin.cn/post/7585706951602946074</link>    <guid>https://juejin.cn/post/7585706951602946074</guid>    <pubDate>2025-12-20T12:46:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951602946074" data-draft-id="7585463195201847346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL主从延迟飙升？元数据锁可能是“真凶”"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T12:46:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术不打烊"/> <meta itemprop="url" content="https://juejin.cn/user/893244690677165"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL主从延迟飙升？元数据锁可能是“真凶”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/893244690677165/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术不打烊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T12:46:35.000Z" title="Sat Dec 20 2025 12:46:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b48074932b2460aade85ae0ca5642d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5LiN5omT54OK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766839594&amp;x-signature=4DwwL750q9J0tMZ7vobEDqA10h8%3D" alt="bdf10e7027a93077604be8d3a1238ffe09d8b8ef055fc8360f5ece011507cb9f_1766233783492.jpg" loading="lazy"/>
现象：IO线程欢快，SQL线程却在划水看到从库的SecondsBehindMaster从30秒直线飙升到1000秒，你是不是冷汗直冒？<br/>
IO线程还在欢快地读取日志，SQL线程却像被冻住了一样，一步一步往后挪，而且越来越慢。<br/>
这真的不是网络问题，而是你的DDL操作在暗地里搞破坏。我见过太多线上事故的根源就藏在一条看似不起眼的ALTERTABLE里——有个哥们改了一个varchar(5000)字段，想扩容到varchar(6000)，结果整个从库崩溃了。<br/>
今天就给你讲清楚这个坑到底怎么踩，以及怎么安稳地跨过去。问题最初看起来很诡异。你用SHOWREPLICASTATUS一看，SecondsBehindMaster直接冲到1000+秒，业务告诉你数据没同步，但是你登上从库查看：</p>
<p>SecondsBehindMaster:1000<br/>
IOThreadRunning:Yes<br/>
SQLThreadRunning:Yes<br/>
RelayLogIORunning:Yes</p>
<p>这说明读日志的线程活得好好的，问题一定出在应用日志的线程上。<br/>
<strong>IO线程正常工作，说明主库没问题，网络也没问题。</strong><br/>
那为什么SQL线程这么慢呢？多半是被什么东西卡住了。定位：SHOWREPLICASTATUS里的假象这里最轻易出现的差错就是看错位置。你或许会看到SQLDelay:0<br/>
RelayLogPos:1024看起来SQLDelay是0，说明没有故意延迟复制，RelayLogPos也在那儿……可这TM一个小时都没动过！<br/>
<strong>这就是关键信号：中继日志位置不再增长，说明SQL线程卡住了。</strong><br/>
这时候，很多人会傻愣愣地查看网络、检查磁盘空间、观察缓冲池，完全没察觉到，问题就在这时出现了：某张表已经被锁定，SQL线程正在依次排队等着解锁抓锁：performanceschema里的真凶打开performanceschema，看看有没有元数据锁：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT * FROM performance_schema.metadata_locks WHERE <span class="hljs-attr">OBJECT_SCHEMA</span> = <span class="hljs-string">'your_db'</span>   AND OBJECT_NAME = <span class="hljs-string">'your_table'</span>   AND LOCK_TYPE = <span class="hljs-string">'EXCLUSIVE'</span><span class="hljs-comment">;</span>
</code></pre>
<p>如果这里蹦出一条记录，LOCKTYPE是EXCLUSIVE，状态是WAITINGFOR，那你就找到真凶了。
大概率是：</p>

































<table><thead><tr><th>字段名</th><th>值</th></tr></thead><tbody><tr><td>OBJECTSCHEMA</td><td>yourdb</td></tr><tr><td>OBJECTNAME</td><td>yourtable</td></tr><tr><td>LOCKTYPE</td><td>EXCLUSIVE</td></tr><tr><td>LOCKDURATION</td><td>TRANSACTION</td></tr><tr><td>STATUS</td><td>WAITING FOR TABLE METADATA LOCK</td></tr><tr><td>OBJECTTYPE</td><td>TABLE</td></tr></tbody></table>
<p>这说明有个ALTERTABLE操作正在等待表的元数据锁，而它成功地把整个复制队列给堵死了。根因：大字段改动触发全表重建你的DBA或者开发在改表的时候，执行了这样的命令：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> big_table MODIFY <span class="hljs-keyword">COLUMN</span> description <span class="hljs-type">varchar</span>(<span class="hljs-number">6000</span>);
</code></pre>
<p>看起来是个很小的改动对吧？</p>
<p>但是问题来了：varchar(5000)改到varchar(6000)，虽然都是可变长度字段，但MySQL5.7和早期的8.0不认啊！<br/>
它们不能用INSTANT算法，必须重建整个表，这意味着：</p>
<ul>
<li>需要一把排他锁（EXCLUSIVE）</li>
<li>要把所有行都重新写一遍</li>
</ul>
<p>要是表有这10GB数据，那可能要花10分。<br/>
在这10分钟里，所有试图访问这个表的查询都被挡在外面。<br/>
<strong>从库上的SQL线程要同步这个DDL，但是它排在队伍最后面，要等主库上的所有数据变更都复制完了才能轮到它……结果就是：延迟越来越大，最后彻底崩溃。</strong> 解决：MySQL8.0的INSTANT魔法如果你用的是MySQL8.0.12及以上，恭喜你，有个秘密武器：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> big_table MODIFY <span class="hljs-keyword">COLUMN</span> description <span class="hljs-type">varchar</span>(<span class="hljs-number">6000</span>), ALGORITHM<span class="hljs-operator">=</span>INSTANT;
</code></pre>
<p>只要改动的字段长度≤255字节，或者只是扩大长度（从小到大），ALGORITHM=INSTANT就能秒级完成，真的，就是秒级。</p>
<p>这个算法有多猛：</p>
<ul>
<li>✅ 只修改元数据，不碰表数据</li>
<li>✅ 不需要排他锁，其他查询照常执行</li>
<li>✅ 不产生大量binlog</li>
<li>✅ 从库完全无感知</li>
<li>✅ SecondsBehindMaster还是0</li>
</ul>
<p>秒杀，真的大扩容怎么办？用gh-ost救命但是，如果你这样做</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> big_table MODIFY <span class="hljs-keyword">COLUMN</span> data <span class="hljs-type">varchar</span>(<span class="hljs-number">5000</span>) <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">50000</span>);
</code></pre>
<p>这超出255字节的跨度，INSTANT也爱莫能助，得重新构建表，这时候，不可以让主库直接开展ALTER操作，得运用专业工具gh-ost。</p>
<p>gh-ost是怎么活命的</p>
<pre><code class="hljs language-scss" lang="scss">gh-ost <span class="hljs-attr">--user</span>="root" <span class="hljs-attr">--password</span>="pass" <span class="hljs-attr">--host</span>="<span class="hljs-number">127.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span>" \  <span class="hljs-attr">--database</span>="your_db" <span class="hljs-attr">--table</span>="your_table" \  <span class="hljs-attr">--alter</span>="MODIFY COLUMN data <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50000</span>)" \  <span class="hljs-attr">--execute</span>
</code></pre>
<p>这个工具会在后台悄悄地</p>
<ol>
<li>创建影子表（跟原表一样的结构）</li>
<li>边改表边复制数据，业务照常读写</li>
<li>在二进制日志里抄下增量更新，不断应用到影子表</li>
<li>到最后一瞬间，原表和影子表闪电切换</li>
</ol>
<p>整个过程中，原表一秒都不锁，业务无感知。<br/>
虽然比INSTANT慢，但也就是几分钟的事，遥遥好过直接ALTER要花的半小时。预防：打好这三道保险第一道：所有DDL先验证一遍</p>
<pre><code class="hljs language-scss" lang="scss">pt-online-schema-change \  <span class="hljs-attr">--user</span>=root <span class="hljs-attr">--password</span>=pass <span class="hljs-attr">--host</span>=<span class="hljs-number">127.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span> \  <span class="hljs-attr">--database</span>=your_db <span class="hljs-attr">--table</span>=your_table \  <span class="hljs-attr">--alter</span>="MODIFY COLUMN description <span class="hljs-built_in">varchar</span>(<span class="hljs-number">6000</span>)" \  <span class="hljs-attr">--dry-run</span>
</code></pre>
<p>--dry-run不会真的改表，但会告诉你这个改动会花多长时间，需要多少资源。
如果输出显示"模拟成功"，真正执行的时候成功率就很高。</p>
<p>第二道：加上执行时间限制把这个参数写进my.cnf`</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[mysqld]</span><span class="hljs-attr">max_execution_time</span>=<span class="hljs-number">300000</span>
</code></pre>
<p>所有查询最多，耗费时间300秒（也就是300000毫秒），要是超出时间就会自动断开连接，不要让慢查询一直占用资源不释放。第三道：关键的DDL一定在业务低谷期执行。凌晨3点修改表格，清晨8点又上线，即便出现些许问题也不会影响白天的用户，结语<strong>MySQL主从延迟的根源往往不在网络、不在磁盘、也不在缓冲池，而在你对DDL操作的敬畏心不够。</strong>  一条小小的ALTERTABLE，如果处理不当，就能把整条主从链路炸掉，让你排查半天还摸不着头脑。牢记这个顺序，先用，pt-online-schema-change--dry-run来验证，小的改动使用INSTANT，大的改动采用gh-ost，关键操作，设置maxexecution_time，接着挑选一个业务低峰期去执行，这种情况下，1000秒的延迟雪崩便永远不会到来。如果这篇文章帮你避免了一次线上事故，最好的回报就是关注和转发。<br/>
让更多人知道DDL操作的正确打开方式，咱们一起把数据库搞稳定。</p>
<p>声明，本文内容九成是本人原创，少量素材经过AI辅助生成，并且所有内容都经过本人严格核查，图片素材，都来自真实素材或者AI原创，文章旨在宣扬正能量，没有低俗不良导向，希望读者知道。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【MCP入门篇】从0到1教你搭建MCP服务]]></title>    <link>https://juejin.cn/post/7585452404113522703</link>    <guid>https://juejin.cn/post/7585452404113522703</guid>    <pubDate>2025-12-20T13:06:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404113522703" data-draft-id="7585476892976119842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【MCP入门篇】从0到1教你搭建MCP服务"/> <meta itemprop="keywords" content="后端,MCP"/> <meta itemprop="datePublished" content="2025-12-20T13:06:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="omenkk7"/> <meta itemprop="url" content="https://juejin.cn/user/933901076016858"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【MCP入门篇】从0到1教你搭建MCP服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933901076016858/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    omenkk7
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:06:26.000Z" title="Sat Dec 20 2025 13:06:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MCP基础概念讲解</h2>
<h3 data-id="heading-1">为什么需要MCP</h3>
<p>对于不同厂商提供的大模型 对FunctionCalling的格式要求各不相同 在对接多个大模型时</p>
<p>开发者需要为每种模型编写适配逻辑 这种情况下维护成本非常高</p>
<p>因此需要有一种统一的规范 规范工具的描述 调用 响应等</p>
<p>使得工具服务只需要按照这种规范去实现 就可以被任意支持MCP的LLM客户端调用</p>
<h3 data-id="heading-2">什么是MCP</h3>
<p>MCP就是<strong>一种标准化工具调用协议规范</strong></p>
<p>他解决了以下问题:</p>
<ul>
<li>工具服务怎么暴露出能力</li>
<li>调用端如何去声明自己有哪些工具</li>
<li>模型如何发现可用工具</li>
<li>模型如何发起工具调用</li>
<li>调用结果如何返回并且继续推理</li>
</ul>
<p><strong>工具服务只需要按照这种规范去构建应用</strong></p>
<p><strong>LLM</strong> <strong>客户端在和</strong> <strong>大模型</strong> <strong>进行交互的时候 将</strong> <strong>MCP</strong> <strong>工具描述转换为对应模型所需要的Function Tool参数</strong></p>
<p><strong>当</strong> <strong>大模型</strong> <strong>决定调用工具的时候 会返回一个工具调用的请求</strong> <strong>MCP</strong> <strong>去拦截该请求 将其转发给对应的MCP Server执行</strong></p>
<p>再将结果回填给大模型 让大模型生成最终答案</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8039fa6aa4864687801b19319cf499cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb21lbmtrNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766840786&amp;x-signature=0F%2BKpWlvE8l2mxr6eIbPDlyKNI4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">SpringAI搭建MCP-Server</h2>
<p>本文以Java语言 通过SpringAI为例 讲解Stdio SSE两种形式的MCP-Server的完整流程</p>
<p>实现一个加减乘除的Tool 适合想要入门学习MCP的小白</p>
<h3 data-id="heading-4">STDIO模式</h3>
<p>创建基于进程内通信的传输</p>
<p>当你使用 STDIO 传输方式连接 MCP 服务时，客户端通常会创建一个子进程来运行你的 MCP 服务程序</p>
<h4 data-id="heading-5">引入依赖</h4>
<p>本文以1.0.0-RC1版本为例 需要引入如下依赖:</p>
<p>spring-ai-starter-mcp-server提供了快速构建 MCP服务器的功能</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai.version</span>&gt;</span>1.0.0-RC1<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">创建工具服务</h4>
<p>SpringAI提供了Tool注解 通过Tool注解 可以将我们定义的方法定义为一种工具</p>
<p>通过description来描述这个工具的作用 这是给AI看的</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> cn.omenkk.service;

<span class="hljs-keyword">import</span> org.springframework.ai.tool.annotation.Tool;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-comment">/**
* <span class="hljs-doctag">@author</span> omenkk7
* <span class="hljs-doctag">@description</span> 数学工具类，提供基本的加减乘除运算
* <span class="hljs-doctag">@create</span> 2025/12/20
*/</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MathTool</span> {

    <span class="hljs-comment">/**
* 加法运算
* <span class="hljs-doctag">@param</span> a 第一个数
* <span class="hljs-doctag">@param</span> b 第二个数
* <span class="hljs-doctag">@return</span> 两数之和
*/</span>
<span class="hljs-meta">@Tool(description = "执行加法运算，计算两个数的和")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        <span class="hljs-keyword">return</span> a + b;
    }

    <span class="hljs-comment">/**
* 减法运算
* <span class="hljs-doctag">@param</span> a 被减数
* <span class="hljs-doctag">@param</span> b 减数
* <span class="hljs-doctag">@return</span> 两数之差
*/</span>
<span class="hljs-meta">@Tool(description = "执行减法运算，计算两个数的差")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">subtract</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        <span class="hljs-keyword">return</span> a - b;
    }

    <span class="hljs-comment">/**
* 乘法运算
* <span class="hljs-doctag">@param</span> a 第一个数
* <span class="hljs-doctag">@param</span> b 第二个数
* <span class="hljs-doctag">@return</span> 两数之积
*/</span>
<span class="hljs-meta">@Tool(description = "执行乘法运算，计算两个数的积")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">multiply</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        <span class="hljs-keyword">return</span> a * b;
    }

    <span class="hljs-comment">/**
* 除法运算
* <span class="hljs-doctag">@param</span> a 被除数
* <span class="hljs-doctag">@param</span> b 除数
* <span class="hljs-doctag">@return</span> 两数之商
* <span class="hljs-doctag">@throws</span> IllegalArgumentException 当除数为0时抛出异常
*/</span>
<span class="hljs-meta">@Tool(description = "执行除法运算，计算两个数的商")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">divide</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
        <span class="hljs-keyword">if</span> (b == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"除数不能为0"</span>);
        }
        <span class="hljs-keyword">return</span> a / b;
    }

}
</code></pre>
<h4 data-id="heading-7">创建你的Spring Application</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpDemo3Application</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">McpDemo3Application</span>.<span class="hljs-property">class</span>, args);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ToolCallbackProvider</span> <span class="hljs-title function_">mathTools</span>(<span class="hljs-params">MathTool mathTool</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">MethodToolCallbackProvider</span>.<span class="hljs-title function_">builder</span>().<span class="hljs-title function_">toolObjects</span>(mathTool).<span class="hljs-title function_">build</span>();
    }
}
</code></pre>
<h4 data-id="heading-8">构建项目</h4>
<p>执行mvn package 将项目打成jar包</p>
<h4 data-id="heading-9">在客户端使用</h4>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"mcpServers"</span>: {
    <span class="hljs-string">"计算MCP"</span>: {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"计算MCP"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"stdio"</span>,
      <span class="hljs-string">"command"</span>: <span class="hljs-string">"C:\Users\连庆辉\AppData\Local\Programs\Eclipse Adoptium\jdk-17.0.17.10-hotspot\bin\java.exe"</span>,
      <span class="hljs-string">"args"</span>: [
       <span class="hljs-comment">// 禁用 Spring Boot Web 应用上下文（STDIO 模式不需要启动HTTP服务器）</span>
        <span class="hljs-string">"-Dspring.main.web-application-type=none"</span>,  
        <span class="hljs-comment">// // 启用 MCP 服务器的 STDIO 传输模式</span>
        <span class="hljs-string">"-Dspring.ai.mcp.server.stdio=true"</span>,
        <span class="hljs-string">"-jar"</span>,
        <span class="hljs-string">"G:\ai-agent\code\mcp-demo2<span class="hljs-subst">\t</span>arget\mcp-demo2-0.0.1-SNAPSHOT.jar"</span>
      ],
      <span class="hljs-string">"environmentVariables"</span>: {
      },
      <span class="hljs-string">"timeout"</span>: <span class="hljs-number">60</span>
    }
  }
}
</code></pre>
<p>我是在Cherry studio上跑的 像类似的应用 如cursor Trae上均可以使用</p>
<p>读者可以检索资料 尝试做一个MCP Client 对接自己的MCP Server</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a92625c4a6cf4bcebcc36f1ac4707c95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb21lbmtrNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766840786&amp;x-signature=j2xArvukl61DJboxrVnCnnYyrZc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">SSE模式</h3>
<p>SSE 是基于 HTTP 协议的一种“单向、服务器主动推送”的长连接通信机制 因此我们可以通过SpringMVC来构建</p>
<p>通过SSE模式跑的MCP服务 可以部署在服务器上 通过SSE连接向外提供功能</p>
<p>下面我采用的是1.1.2的版本spring-ai-bom 它能够帮你管理spring-ai相关依赖的版本</p>
<h4 data-id="heading-11">引入依赖</h4>
<p>重点是引入spring-ai-starter-mcp-server-webmvc依赖:</p>
<ul>
<li>使用 Spring MVC 的基于 HTTP 的传输</li>
<li>自动配置 SSE 传输所需的 Web 端点与 Controller或处理流式响应逻辑，无需额外编码。</li>
<li>可选<code>STDIO</code>传输（通过设置启用<code>spring.ai.mcp.server.stdio=true</code>）</li>
<li>包含<code>spring-boot-starter-web</code>依赖项</li>
</ul>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai.version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># spring.main.web-application-type=none</span>

<span class="hljs-comment"># <span class="hljs-doctag">NOTE:</span> You must disable the banner and the console logging</span>
<span class="hljs-comment"># to allow the STDIO transport to work !!!</span>
<span class="hljs-attr">spring.main.banner-mode</span>=<span class="hljs-literal">off</span>
<span class="hljs-comment"># logging.pattern.console=</span>

<span class="hljs-comment"># spring.ai.mcp.server.stdio=false</span>

<span class="hljs-attr">spring.ai.mcp.server.name</span>=my-weather-server
<span class="hljs-attr">spring.ai.mcp.server.version</span>=<span class="hljs-number">0.0</span>.<span class="hljs-number">1</span>

<span class="hljs-attr">spring.ai.mcp.server.protocol</span>=STREAMABLE
<span class="hljs-comment"># spring.ai.mcp.server.protocol=STATELESS</span>

<span class="hljs-attr">logging.file.name</span>=./model-context-protocol/weather/starter-webmvc-server/target/starter-webmvc-server.log
</code></pre>
<h4 data-id="heading-12">创建工具服务</h4>
<p>与SSE模式类似 不再赘述</p>
<h4 data-id="heading-13">创建你的SpringApplication</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpDemo3Application</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">McpDemo3Application</span>.<span class="hljs-property">class</span>, args);
    }

<span class="hljs-comment">//显式手动注册你的工具服务</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ToolCallbackProvider</span> <span class="hljs-title function_">mathTools</span>(<span class="hljs-params">MathTool mathTool</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">MethodToolCallbackProvider</span>.<span class="hljs-title function_">builder</span>().<span class="hljs-title function_">toolObjects</span>(mathTool).<span class="hljs-title function_">build</span>();
    }
}
</code></pre>
<h4 data-id="heading-14">在客户端使用</h4>
<p>首先需要在本地或者服务器启动你的Web服务 接下来 暴露你的服务给客户端 让他知道怎么去调用你的服务</p>
<pre><code class="hljs language-css" lang="css">{
  "mcpServers": {
    "数学运算服务<span class="hljs-number">1</span>": {
      "name": <span class="hljs-string">"数学运算服务1"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"streamableHttp"</span>,
      <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:8080/mcp"</span>,
      <span class="hljs-string">"headers"</span>: {
        "<span class="hljs-attribute">Content</span>-Type": <span class="hljs-string">"application/json"</span>,
        <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">"Bearer token"</span>
      },
      "timeout": <span class="hljs-number">60</span>,
      <span class="hljs-string">"advancedSettings"</span>: {}
    }
  }
}
</code></pre>
<h4 data-id="heading-15">示例</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42eca20f5cba43d789636c0b9b67cf1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb21lbmtrNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766840786&amp;x-signature=%2BKZn9cP%2FDoEi7KlYY%2FJpRISLVZs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">小结</h2>
<p>本文讲解了关于MCP 以及简单讲解了怎么使用SpringAI去创建一个MCP Server</p>
<p>如果对你有帮助 请点个赞谢谢!!!</p>
<p><strong>参考资料:</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2F1.0%2Fapi%2Fmcp%2Fmcp-server-boot-starter-docs.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/1.0/api/mcp/mcp-server-boot-starter-docs.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai-examples" target="_blank" title="https://github.com/spring-projects/spring-ai-examples" ref="nofollow noopener noreferrer">github.com/spring-proj…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 钩子全集实战（三）：`EnvironmentPostProcessor` 详解]]></title>    <link>https://juejin.cn/post/7585502118459473939</link>    <guid>https://juejin.cn/post/7585502118459473939</guid>    <pubDate>2025-12-20T13:08:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585502118459473939" data-draft-id="7585474459776843812" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Spring Boot 钩子全集实战（三）：`EnvironmentPostProcessor` 详解"/> <meta itemprop="keywords" content="Java,Spring"/> <meta itemprop="datePublished" content="2025-12-20T13:08:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Spring Boot 钩子全集实战（三）：`EnvironmentPostProcessor` 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:08:11.000Z" title="Sat Dec 20 2025 13:08:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 钩子全集实战（三）：<code>EnvironmentPostProcessor</code> 详解</h2>
<p>在上一篇中，我们聚焦了 Spring Boot 启动最早的扩展点 <code>SpringApplicationRunListener.starting()</code>，解决了启动监控、失败告警等核心问题。今天，我们将深入讲解<strong>配置加载阶段的核心扩展点</strong>——<code>EnvironmentPostProcessor</code>，它是定制化配置加载、动态配置注入、配置加密解密的 “黄金入口”，也是生产环境中配置治理的核心工具。</p>
<h3 data-id="heading-1">一、什么是 <code>EnvironmentPostProcessor</code>？</h3>
<p><code>EnvironmentPostProcessor</code> 是 Spring Boot 提供的配置后置处理扩展点，在以下时机被触发：</p>
<ul>
<li><strong>Environment 已初始化</strong>（但未完全加载所有配置源）；</li>
<li><strong>应用配置文件（application.yml/properties）已读取，但未生效</strong>；</li>
<li><strong>ApplicationContext 尚未创建</strong>，但可修改 Environment 中的配置；</li>
<li><strong>执行优先级高于 <code>@Configuration</code>、<code>@Value</code> 等配置注入逻辑</strong>。</li>
</ul>
<blockquote>
<p>✅ <strong>核心价值</strong>：在配置最终生效前，对配置进行动态修改、补充、加密解密，实现配置的统一治理。</p>
</blockquote>
<p>生产环境中，这个扩展点常用于解决 “配置中心化”“配置加密”“多环境配置动态切换” 等核心问题。</p>
<h3 data-id="heading-2">二、场景 1：配置中心拉取（替代原生配置文件）</h3>
<h4 data-id="heading-3">业务痛点</h4>
<p>生产环境中，若将配置写死在 <code>application.yml</code> 中，存在以下问题：</p>
<ul>
<li>配置与代码耦合，修改配置需重新打包部署；</li>
<li>多环境（dev/test/prod）配置管理混乱，易出错；</li>
<li>配置缺乏统一管控，泄露风险高。</li>
</ul>
<h4 data-id="heading-4">解决方案</h4>
<p>基于 <code>EnvironmentPostProcessor</code> 从配置中心（如 Nacos/Apollo/ 携程 Apollo）拉取配置，覆盖本地配置，实现配置与代码解耦。</p>
<h5 data-id="heading-5">实现代码</h5>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">envprocessor</span>;

<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">env</span>.<span class="hljs-property">EnvironmentPostProcessor</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">env</span>.<span class="hljs-property">ConfigurableEnvironment</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">env</span>.<span class="hljs-property">MapPropertySource</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">env</span>.<span class="hljs-property">MutablePropertySources</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;

<span class="hljs-comment">/**
 * 生产级配置中心拉取处理器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigCenterEnvironmentPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnvironmentPostProcessor</span> {

    <span class="hljs-comment">// 模拟配置中心客户端（生产环境替换为真实Nacos/Apollo客户端）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigCenterClient</span> {
        <span class="hljs-comment">// 根据环境拉取配置</span>
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">pullConfig</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> env</span>) {
            <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; configMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-comment">// 生产环境从配置中心拉取真实配置</span>
            <span class="hljs-keyword">switch</span> (env) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"prod"</span>:
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.url"</span>, <span class="hljs-string">"jdbc:mysql://prod-mysql:3306/prod_db?useSSL=false"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.username"</span>, <span class="hljs-string">"prod_user"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.password"</span>, <span class="hljs-string">"prod_pass123"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"redis.host"</span>, <span class="hljs-string">"prod-redis:6379"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"app.prod.mode"</span>, <span class="hljs-string">"true"</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"test"</span>:
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.url"</span>, <span class="hljs-string">"jdbc:mysql://test-mysql:3306/test_db?useSSL=false"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.username"</span>, <span class="hljs-string">"test_user"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.password"</span>, <span class="hljs-string">"test_pass123"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"redis.host"</span>, <span class="hljs-string">"test-redis:6379"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"app.prod.mode"</span>, <span class="hljs-string">"false"</span>);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-attr">default</span>:
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.url"</span>, <span class="hljs-string">"jdbc:mysql://localhost:3306/dev_db?useSSL=false"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.username"</span>, <span class="hljs-string">"root"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"spring.datasource.password"</span>, <span class="hljs-string">"root"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"redis.host"</span>, <span class="hljs-string">"localhost:6379"</span>);
                    configMap.<span class="hljs-title function_">put</span>(<span class="hljs-string">"app.prod.mode"</span>, <span class="hljs-string">"false"</span>);
            }
            <span class="hljs-keyword">return</span> configMap;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postProcessEnvironment</span>(<span class="hljs-params">ConfigurableEnvironment environment, SpringApplication application</span>) {
        <span class="hljs-comment">// 1. 获取当前激活的环境（通过启动参数/系统变量传递）</span>
        <span class="hljs-title class_">String</span>[] activeProfiles = environment.<span class="hljs-title function_">getActiveProfiles</span>();
        <span class="hljs-title class_">String</span> env = activeProfiles.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? activeProfiles[<span class="hljs-number">0</span>] : <span class="hljs-string">"dev"</span>;
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"[配置中心] 开始拉取 %s 环境配置%n"</span>, env);

        <span class="hljs-comment">// 2. 从配置中心拉取配置</span>
        <span class="hljs-title class_">ConfigCenterClient</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigCenterClient</span>();
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; configMap = client.<span class="hljs-title function_">pullConfig</span>(env);

        <span class="hljs-comment">// 3. 将配置注入Environment（优先级高于本地配置）</span>
        <span class="hljs-title class_">MutablePropertySources</span> propertySources = environment.<span class="hljs-title function_">getPropertySources</span>();
        <span class="hljs-comment">// 添加到最前面，确保优先级最高</span>
        propertySources.<span class="hljs-title function_">addFirst</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MapPropertySource</span>(<span class="hljs-string">"configCenterProperties"</span>, configMap));

        <span class="hljs-comment">// 4. 打印加载结果（生产环境建议用SLF4J）</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"[配置中心] 成功加载 %d 个配置项，环境：%s%n"</span>, configMap.<span class="hljs-title function_">size</span>(), env);
        configMap.<span class="hljs-title function_">forEach</span>((key, value) -&gt; {
            <span class="hljs-comment">// 密码脱敏输出</span>
            <span class="hljs-title class_">String</span> displayValue = key.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"password"</span>) ? <span class="hljs-string">"******"</span> : <span class="hljs-title class_">String</span>.<span class="hljs-title function_">valueOf</span>(value);
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"[配置中心] %s = %s%n"</span>, key, displayValue);
        });
    }
}
</code></pre>
<h5 data-id="heading-6">配置加载</h5>
<p>在 <code>resources/META-INF/spring.factories</code> 中配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">org.springframework.boot.env.EnvironmentPostProcessor</span>=\
com.example.demo.envprocessor.ConfigCenterEnvironmentPostProcessor
</code></pre>
<h5 data-id="heading-7">启动测试</h5>
<p>添加启动参数激活生产环境：<code>--spring.profiles.active=prod</code></p>
<h5 data-id="heading-8">输出</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[配置中心]</span> 开始拉取 prod 环境配置
<span class="hljs-section">[配置中心]</span> 成功加载 5 个配置项，环境：prod
<span class="hljs-section">[配置中心]</span> <span class="hljs-attr">spring.datasource.username</span> = prod_user
<span class="hljs-section">[配置中心]</span> <span class="hljs-attr">spring.datasource.url</span> = jdbc:mysql://prod-mysql:<span class="hljs-number">3306</span>/prod_db?useSSL=<span class="hljs-literal">false</span>
<span class="hljs-section">[配置中心]</span> <span class="hljs-attr">redis.host</span> = prod-redis:<span class="hljs-number">6379</span>
<span class="hljs-section">[配置中心]</span> <span class="hljs-attr">app.prod.mode</span> = <span class="hljs-literal">true</span>
<span class="hljs-section">[配置中心]</span> <span class="hljs-attr">spring.datasource.password</span> = ******

  .   ____          _            __ _ _
 /\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )___ | '_ | '_| | '_ / _` | \ \ \ \
 \/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |___, | / / / /
 =========|_|==============|___/=/_/_/_/

 :: Spring Boot ::                (v3.5.8)

2025-12-11T21:46:23.284+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> com.example.demo.DemoApplication         : Starting DemoApplication using Java 21.0.9 with PID 10075 (/Users/wangmingfei/Documents/个人/05 java天梯之路/01 源码/03 每日打卡系列/daily-check-in/springboot钩子/demo/target/classes started by wangmingfei in /Users/wangmingfei/Documents/个人/05 java天梯之路/01 源码/03 每日打卡系列/daily-check-in/springboot钩子/demo)
2025-12-11T21:46:23.288+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> com.example.demo.DemoApplication         : The following 1 profile is active: "prod"
2025-12-11T21:46:23.575+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port 8080 (http)
2025-12-11T21:46:23.582+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> o.apache.catalina.core.StandardService   : Starting service <span class="hljs-section">[Tomcat]</span>
2025-12-11T21:46:23.582+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> o.apache.catalina.core.StandardEngine    : Starting Servlet engine: <span class="hljs-section">[Apache Tomcat/10.1.49]</span>
2025-12-11T21:46:23.600+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> o.a.c.c.C.<span class="hljs-section">[Tomcat]</span>.<span class="hljs-section">[localhost]</span>.<span class="hljs-section">[/]</span>       : Initializing Spring embedded WebApplicationContext
2025-12-11T21:46:23.600+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 298 ms
2025-12-11T21:46:23.739+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port 8080 (http) with context path '/'
2025-12-11T21:46:23.743+08:00  INFO 10075 --- <span class="hljs-section">[           main]</span> com.example.demo.DemoApplication         : Started DemoApplication in 9.056 seconds (process running for 9.206)
</code></pre>
<h5 data-id="heading-9">生产价值</h5>
<ul>
<li>配置与代码解耦，修改配置无需重新部署；</li>
<li>多环境配置统一管控，避免配置混乱；</li>
<li>配置中心可实现配置热更新、灰度发布等高级特性；</li>
<li>配置拉取过程可增加鉴权、加密，提升安全性。</li>
</ul>
<h3 data-id="heading-10">三、场景 2：配置加密解密（敏感配置防泄露）</h3>
<h4 data-id="heading-11">业务痛点</h4>
<p>生产环境中，数据库密码、Redis 密码、接口密钥等敏感配置若明文存储，存在严重安全风险：</p>
<ul>
<li>配置文件泄露导致敏感信息被盗；</li>
<li>运维人员可直接查看明文密码，不符合安全规范；</li>
<li>审计无法追溯密码使用记录。</li>
</ul>
<h4 data-id="heading-12">解决方案</h4>
<p>基于 <code>EnvironmentPostProcessor</code> 对加密的配置进行解密，敏感配置在配置文件中以密文存储，运行时动态解密。</p>
<h5 data-id="heading-13">实现代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.envprocessor;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.env.EnvironmentPostProcessor;
<span class="hljs-keyword">import</span> org.springframework.core.env.ConfigurableEnvironment;
<span class="hljs-keyword">import</span> org.springframework.core.env.PropertySource;
<span class="hljs-keyword">import</span> org.springframework.util.StringUtils;

<span class="hljs-keyword">import</span> javax.crypto.Cipher;
<span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;
<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword">import</span> java.util.Base64;

<span class="hljs-comment">/** * 敏感配置解密处理器 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncryptedConfigEnvironmentPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnvironmentPostProcessor</span> {

    <span class="hljs-comment">// 加密密钥（生产环境从安全存储中读取，如KMS/本地加密文件）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ENCRYPT_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"prod_key_1234567"</span>; <span class="hljs-comment">// 实际使用需16/24/32位</span>
    <span class="hljs-comment">// 密文前缀标识</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ENCRYPT_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"encrypt:"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessEnvironment</span><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span> {
        System.out.println(<span class="hljs-string">"[配置解密] 开始处理敏感配置解密"</span>);

        <span class="hljs-comment">// 遍历所有配置源，解密敏感配置</span>
        <span class="hljs-keyword">for</span> (PropertySource&lt;?&gt; propertySource : environment.getPropertySources()) {
            <span class="hljs-comment">// 跳过系统配置源，只处理应用配置</span>
            <span class="hljs-keyword">if</span> (propertySource.getName().startsWith(<span class="hljs-string">"system"</span>) || propertySource.getName().startsWith(<span class="hljs-string">"configCenter"</span>)) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-comment">// 解密核心敏感配置</span>
            decryptConfig(environment, <span class="hljs-string">"spring.datasource.password"</span>);
            decryptConfig(environment, <span class="hljs-string">"redis.password"</span>);
            decryptConfig(environment, <span class="hljs-string">"app.api.secret"</span>);
        }

        System.out.println(<span class="hljs-string">"[配置解密] 敏感配置解密完成"</span>);
    }

    <span class="hljs-comment">// 解密单个配置项</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decryptConfig</span><span class="hljs-params">(ConfigurableEnvironment environment, String configKey)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> environment.getProperty(configKey);
        <span class="hljs-keyword">if</span> (StringUtils.hasText(value) &amp;&amp; value.startsWith(ENCRYPT_PREFIX)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 截取密文部分</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">cipherText</span> <span class="hljs-operator">=</span> value.substring(ENCRYPT_PREFIX.length());
                <span class="hljs-comment">// 解密</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">plainText</span> <span class="hljs-operator">=</span> decrypt(cipherText, ENCRYPT_KEY);
                <span class="hljs-comment">// 替换为明文（注入到最高优先级配置源）</span>
                environment.getSystemProperties().put(configKey, plainText);
                System.out.printf(<span class="hljs-string">"[配置解密] 成功解密配置项：%s%n"</span>, configKey);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"配置解密失败："</span> + configKey, e);
            }
        }
    }

    <span class="hljs-comment">// AES解密实现（生产环境建议使用非对称加密RSA）</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">decrypt</span><span class="hljs-params">(String cipherText, String key)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">secretKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(key.getBytes(StandardCharsets.UTF_8), <span class="hljs-string">"AES"</span>);
        <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(<span class="hljs-string">"AES/ECB/PKCS5Padding"</span>);
        cipher.init(Cipher.DECRYPT_MODE, secretKey);
        <span class="hljs-type">byte</span>[] decryptedBytes = cipher.doFinal(Base64.getDecoder().decode(cipherText));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decryptedBytes, StandardCharsets.UTF_8);
    }

    <span class="hljs-comment">// 加密方法（用于生成密文配置）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encrypt</span><span class="hljs-params">(String plainText, String key)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">SecretKeySpec</span> <span class="hljs-variable">secretKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(key.getBytes(StandardCharsets.UTF_8), <span class="hljs-string">"AES"</span>);
        <span class="hljs-type">Cipher</span> <span class="hljs-variable">cipher</span> <span class="hljs-operator">=</span> Cipher.getInstance(<span class="hljs-string">"AES/ECB/PKCS5Padding"</span>);
        cipher.init(Cipher.ENCRYPT_MODE, secretKey);
        <span class="hljs-type">byte</span>[] encryptedBytes = cipher.doFinal(plainText.getBytes(StandardCharsets.UTF_8));
        <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(encryptedBytes);
    }

    <span class="hljs-comment">// 测试生成密文</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 生成密文：encrypt:xxxxxx</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"prod_pass123"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">cipherText</span> <span class="hljs-operator">=</span> encrypt(password, ENCRYPT_KEY);
        System.out.println(<span class="hljs-string">"密文配置：encrypt:"</span> + cipherText);
    }
}
</code></pre>
<h5 data-id="heading-14">配置加载</h5>
<p>在 <code>resources/META-INF/spring.factories</code> 中配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">org.springframework.boot.env.EnvironmentPostProcessor</span>=\
com.example.demo.envprocessor.EncryptedConfigEnvironmentPostProcessor
</code></pre>
<h5 data-id="heading-15">配置文件（application.yml）</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://prod-mysql:3306/prod_db?useSSL=false</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">prod_user</span>
    <span class="hljs-comment"># 密文存储，前缀标识需要解密</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">encrypt:DC76b3+IyNwp+f/1QxPiIA==</span>
<span class="hljs-attr">redis:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">prod-redis:6379</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">encrypt:DC76b3+IyNwp+f/1QxPiIA==</span>
<span class="hljs-attr">app:</span>
  <span class="hljs-attr">api:</span>
    <span class="hljs-attr">secret:</span> <span class="hljs-string">encrypt:DC76b3+IyNwp+f/1QxPiIA==</span>
</code></pre>
<h5 data-id="heading-16">输出</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[配置解密]</span> 开始处理敏感配置解密
<span class="hljs-selector-attr">[配置解密]</span> 成功解密配置项：spring<span class="hljs-selector-class">.datasource</span><span class="hljs-selector-class">.password</span>
<span class="hljs-selector-attr">[配置解密]</span> 成功解密配置项：redis<span class="hljs-selector-class">.password</span>
<span class="hljs-selector-attr">[配置解密]</span> 成功解密配置项：app<span class="hljs-selector-class">.api</span><span class="hljs-selector-class">.secret</span>
<span class="hljs-selector-attr">[配置解密]</span> 敏感配置解密完成
</code></pre>
<h5 data-id="heading-17">生产价值</h5>
<ul>
<li>敏感配置密文存储，即使配置文件泄露也无法获取明文；</li>
<li>解密逻辑集中管控，符合等保合规要求；</li>
<li>可结合 KMS（密钥管理服务）实现密钥的安全存储，避免硬编码；</li>
<li>解密过程可增加审计日志，追溯敏感配置使用记录。</li>
</ul>
<h3 data-id="heading-18">四、场景 3：多环境配置动态覆盖（解决配置冲突）</h3>
<h4 data-id="heading-19">业务痛点</h4>
<p>生产环境中，多环境配置常出现以下问题：</p>
<ul>
<li>测试环境配置污染生产环境；</li>
<li>不同环境的配置优先级混乱；</li>
<li>特殊场景（如灰度发布）需要临时覆盖配置。</li>
</ul>
<h4 data-id="heading-20">解决方案</h4>
<p>基于 <code>EnvironmentPostProcessor</code> 实现配置的动态覆盖，根据环境、机器标签等条件动态调整配置优先级。</p>
<h5 data-id="heading-21">实现代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.envprocessor;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.env.EnvironmentPostProcessor;
<span class="hljs-keyword">import</span> org.springframework.core.env.ConfigurableEnvironment;
<span class="hljs-keyword">import</span> org.springframework.core.env.MapPropertySource;
<span class="hljs-keyword">import</span> org.springframework.core.env.MutablePropertySources;

<span class="hljs-keyword">import</span> java.net.InetAddress;
<span class="hljs-keyword">import</span> java.net.UnknownHostException;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/** * 多环境配置动态覆盖处理器 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnvConfigOverrideProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnvironmentPostProcessor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessEnvironment</span><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 获取机器标识（生产环境可从机器标签/ECS元数据获取）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">hostName</span> <span class="hljs-operator">=</span> InetAddress.getLocalHost().getHostName();
            <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> InetAddress.getLocalHost().getHostAddress();
            System.out.printf(<span class="hljs-string">"[配置覆盖] 机器信息：%s(%s)%n"</span>, hostName, ip);

            <span class="hljs-comment">// 2. 判断是否为灰度机器</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isGray</span> <span class="hljs-operator">=</span> hostName.contains(<span class="hljs-string">"gray"</span>) || ip.startsWith(<span class="hljs-string">"192.168.100."</span>);
            <span class="hljs-comment">// 判断是否为生产环境</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isProd</span> <span class="hljs-operator">=</span> environment.getActiveProfiles().length &gt; <span class="hljs-number">0</span> &amp;&amp;
                    <span class="hljs-string">"prod"</span>.equals(environment.getActiveProfiles()[<span class="hljs-number">0</span>]);

            <span class="hljs-comment">// 3. 动态覆盖配置</span>
            Map&lt;String, Object&gt; overrideConfig = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-keyword">if</span> (isProd &amp;&amp; isGray) {
                <span class="hljs-comment">// 灰度机器使用灰度配置</span>
                overrideConfig.put(<span class="hljs-string">"spring.datasource.url"</span>, <span class="hljs-string">"jdbc:mysql://gray-mysql:3306/prod_db?useSSL=false"</span>);
                overrideConfig.put(<span class="hljs-string">"redis.host"</span>, <span class="hljs-string">"gray-redis:6379"</span>);
                overrideConfig.put(<span class="hljs-string">"app.gray.mode"</span>, <span class="hljs-string">"true"</span>);
                System.out.println(<span class="hljs-string">"[配置覆盖] 灰度机器，加载灰度配置"</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isProd) {
                <span class="hljs-comment">// 生产机器使用生产配置</span>
                overrideConfig.put(<span class="hljs-string">"app.gray.mode"</span>, <span class="hljs-string">"false"</span>);
                overrideConfig.put(<span class="hljs-string">"app.log.level"</span>, <span class="hljs-string">"INFO"</span>);
                System.out.println(<span class="hljs-string">"[配置覆盖] 生产机器，加载生产配置"</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 测试/开发机器放宽配置限制</span>
                overrideConfig.put(<span class="hljs-string">"app.log.level"</span>, <span class="hljs-string">"DEBUG"</span>);
                overrideConfig.put(<span class="hljs-string">"spring.datasource.hikari.maximum-pool-size"</span>, <span class="hljs-string">"10"</span>);
                System.out.println(<span class="hljs-string">"[配置覆盖] 非生产机器，加载测试配置"</span>);
            }

            <span class="hljs-comment">// 4. 覆盖配置（优先级最高）</span>
            <span class="hljs-type">MutablePropertySources</span> <span class="hljs-variable">propertySources</span> <span class="hljs-operator">=</span> environment.getPropertySources();
            propertySources.addFirst(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MapPropertySource</span>(<span class="hljs-string">"dynamicOverrideConfig"</span>, overrideConfig));

            <span class="hljs-comment">// 5. 打印最终生效的核心配置</span>
            System.out.printf(<span class="hljs-string">"[配置覆盖] 最终生效的数据库地址：%s%n"</span>,
                    environment.getProperty(<span class="hljs-string">"spring.datasource.url"</span>));
            System.out.printf(<span class="hljs-string">"[配置覆盖] 最终生效的灰度模式：%s%n"</span>,
                    environment.getProperty(<span class="hljs-string">"app.gray.mode"</span>));

        } <span class="hljs-keyword">catch</span> (UnknownHostException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取机器信息失败"</span>, e);
        }
    }
}
</code></pre>
<h5 data-id="heading-22">配置加载</h5>
<p>在 <code>resources/META-INF/spring.factories</code> 中配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">org.springframework.boot.env.EnvironmentPostProcessor</span>=\
com.example.demo.envprocessor.EnvConfigOverrideProcessor
</code></pre>
<h5 data-id="heading-23">输出（生产机器）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[配置覆盖]</span> 机器信息：xxx(127.0.0.1)
<span class="hljs-section">[配置覆盖]</span> 生产机器，加载生产配置
<span class="hljs-section">[配置覆盖]</span> 最终生效的数据库地址：jdbc:mysql://prod-mysql:3306/prod_db?<span class="hljs-attr">useSSL</span>=<span class="hljs-literal">false</span>
<span class="hljs-section">[配置覆盖]</span> 最终生效的灰度模式：false
</code></pre>
<h5 data-id="heading-24">生产价值</h5>
<ul>
<li>基于机器标签动态调整配置，实现灰度发布、蓝绿部署；</li>
<li>避免测试配置污染生产环境，配置隔离更彻底；</li>
<li>生产环境可临时覆盖配置，无需修改配置文件；</li>
<li>配置优先级可精细化控制，解决配置冲突问题。</li>
</ul>
<h3 data-id="heading-25">五、场景 4：配置校验与补全（提前拦截非法配置）</h3>
<h4 data-id="heading-26">业务痛点</h4>
<p>生产环境中，配置错误常导致应用启动后不可用：</p>
<ul>
<li>核心配置缺失（如数据库地址为空）；</li>
<li>配置格式错误（如端口号非数字）；</li>
<li>配置值超出合理范围（如线程池大小设置为 0）。</li>
</ul>
<h4 data-id="heading-27">解决方案</h4>
<p>基于 <code>EnvironmentPostProcessor</code> 在配置生效前进行校验，非法配置直接终止启动，并给出明确的错误提示。</p>
<h5 data-id="heading-28">实现代码</h5>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">envprocessor</span>;

<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">SpringApplication</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">env</span>.<span class="hljs-property">EnvironmentPostProcessor</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">core</span>.<span class="hljs-property">env</span>.<span class="hljs-property">ConfigurableEnvironment</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">util</span>.<span class="hljs-property">StringUtils</span>;

<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">regex</span>.<span class="hljs-property">Pattern</span>;

<span class="hljs-comment">/** * 配置校验与补全处理器 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigValidateProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnvironmentPostProcessor</span> {

    <span class="hljs-comment">// 端口号正则</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">Pattern</span> <span class="hljs-variable constant_">PORT_PATTERN</span> = <span class="hljs-title class_">Pattern</span>.<span class="hljs-title function_">compile</span>(<span class="hljs-string">"^\d{1,5}$"</span>);
    <span class="hljs-comment">// 数据库URL正则</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">Pattern</span> <span class="hljs-variable constant_">DB_URL_PATTERN</span> = <span class="hljs-title class_">Pattern</span>.<span class="hljs-title function_">compile</span>(<span class="hljs-string">"^jdbc:\w+://.+:\d+/\w+.*$"</span>);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postProcessEnvironment</span>(<span class="hljs-params">ConfigurableEnvironment environment, SpringApplication application</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"[配置校验] 开始校验核心配置"</span>);

        <span class="hljs-comment">// 1. 校验核心配置是否存在</span>
        <span class="hljs-title function_">validateConfigExists</span>(environment, <span class="hljs-string">"spring.datasource.url"</span>);
        <span class="hljs-title function_">validateConfigExists</span>(environment, <span class="hljs-string">"spring.datasource.username"</span>);
        <span class="hljs-title function_">validateConfigExists</span>(environment, <span class="hljs-string">"spring.datasource.password"</span>);
        <span class="hljs-title function_">validateConfigExists</span>(environment, <span class="hljs-string">"redis.host"</span>);

        <span class="hljs-comment">// 2. 校验配置格式</span>
        <span class="hljs-title function_">validateConfigFormat</span>(environment, <span class="hljs-string">"spring.datasource.url"</span>, <span class="hljs-variable constant_">DB_URL_PATTERN</span>, <span class="hljs-string">"数据库URL格式非法"</span>);
        <span class="hljs-title function_">validateConfigFormat</span>(environment, <span class="hljs-string">"server.port"</span>, <span class="hljs-variable constant_">PORT_PATTERN</span>, <span class="hljs-string">"端口号格式非法"</span>);

        <span class="hljs-comment">// 3. 校验配置值范围</span>
        <span class="hljs-title function_">validatePortRange</span>(environment, <span class="hljs-string">"server.port"</span>);
        <span class="hljs-title function_">validateThreadPoolSize</span>(environment, <span class="hljs-string">"spring.datasource.hikari.maximum-pool-size"</span>);

        <span class="hljs-comment">// 4. 补全默认配置</span>
        <span class="hljs-title function_">supplementDefaultConfig</span>(environment, <span class="hljs-string">"server.port"</span>, <span class="hljs-string">"8080"</span>);
        <span class="hljs-title function_">supplementDefaultConfig</span>(environment, <span class="hljs-string">"spring.datasource.hikari.minimum-idle"</span>, <span class="hljs-string">"5"</span>);

        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"[配置校验] 核心配置校验通过，默认配置已补全"</span>);
    }

    <span class="hljs-comment">// 校验配置是否存在</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateConfigExists</span>(<span class="hljs-params">ConfigurableEnvironment environment, <span class="hljs-built_in">String</span> configKey</span>) {
        <span class="hljs-title class_">String</span> value = environment.<span class="hljs-title function_">getProperty</span>(configKey);
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">hasText</span>(value)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"核心配置缺失："</span> + configKey);
        }
    }

    <span class="hljs-comment">// 校验配置格式</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateConfigFormat</span>(<span class="hljs-params">ConfigurableEnvironment environment, <span class="hljs-built_in">String</span> configKey,
                                      Pattern pattern, <span class="hljs-built_in">String</span> errorMsg</span>) {
        <span class="hljs-title class_">String</span> value = environment.<span class="hljs-title function_">getProperty</span>(configKey);
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">hasText</span>(value) &amp;&amp; !pattern.<span class="hljs-title function_">matcher</span>(value).<span class="hljs-title function_">matches</span>()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(errorMsg + <span class="hljs-string">"，配置项："</span> + configKey + <span class="hljs-string">"，值："</span> + value);
        }
    }

    <span class="hljs-comment">// 校验端口号范围</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validatePortRange</span>(<span class="hljs-params">ConfigurableEnvironment environment, <span class="hljs-built_in">String</span> configKey</span>) {
        <span class="hljs-title class_">String</span> value = environment.<span class="hljs-title function_">getProperty</span>(configKey);
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">hasText</span>(value) &amp;&amp; <span class="hljs-variable constant_">PORT_PATTERN</span>.<span class="hljs-title function_">matcher</span>(value).<span class="hljs-title function_">matches</span>()) {
            int port = <span class="hljs-title class_">Integer</span>.<span class="hljs-built_in">parseInt</span>(value);
            <span class="hljs-keyword">if</span> (port &lt; <span class="hljs-number">1</span> || port &gt; <span class="hljs-number">65535</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"端口号超出范围(1-65535)："</span> + configKey + <span class="hljs-string">"="</span> + value);
            }
        }
    }

    <span class="hljs-comment">// 校验线程池大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateThreadPoolSize</span>(<span class="hljs-params">ConfigurableEnvironment environment, <span class="hljs-built_in">String</span> configKey</span>) {
        <span class="hljs-title class_">String</span> value = environment.<span class="hljs-title function_">getProperty</span>(configKey);
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">hasText</span>(value)) {
            <span class="hljs-keyword">try</span> {
                int size = <span class="hljs-title class_">Integer</span>.<span class="hljs-built_in">parseInt</span>(value);
                <span class="hljs-keyword">if</span> (size &lt; <span class="hljs-number">1</span> || size &gt; <span class="hljs-number">100</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"线程池大小超出合理范围(1-100)："</span> + configKey + <span class="hljs-string">"="</span> + value);
                }
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">NumberFormatException</span> e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"线程池大小必须为数字："</span> + configKey + <span class="hljs-string">"="</span> + value);
            }
        }
    }

    <span class="hljs-comment">// 补全默认配置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">supplementDefaultConfig</span>(<span class="hljs-params">ConfigurableEnvironment environment, <span class="hljs-built_in">String</span> configKey, <span class="hljs-built_in">String</span> defaultValue</span>) {
        <span class="hljs-title class_">String</span> value = environment.<span class="hljs-title function_">getProperty</span>(configKey);
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">hasText</span>(value)) {
            environment.<span class="hljs-title function_">getSystemProperties</span>().<span class="hljs-title function_">put</span>(configKey, defaultValue);
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"[配置补全] 配置项 %s 缺失，使用默认值：%s%n"</span>, configKey, defaultValue);
        }
    }
}
</code></pre>
<h5 data-id="heading-29">配置加载</h5>
<p>在 <code>resources/META-INF/spring.factories</code> 中配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">org.springframework.boot.env.EnvironmentPostProcessor</span>=\
com.example.demo.envprocessor.ConfigValidateProcessor
</code></pre>
<h5 data-id="heading-30">配置文件</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment">#spring:</span>
<span class="hljs-comment">#  datasource:</span>
<span class="hljs-comment">#    url: jdbc:mysql://prod-mysql:3306/prod_db?useSSL=false</span>
<span class="hljs-comment">#    username: prod_user</span>
<span class="hljs-comment">#    # 密文存储，前缀标识需要解密</span>
<span class="hljs-comment">#    password: encrypt:DC76b3+IyNwp+f/1QxPiIA==</span>
<span class="hljs-attr">redis:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">prod-redis:6379</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">encrypt:DC76b3+IyNwp+f/1QxPiIA==</span>
<span class="hljs-attr">app:</span>
  <span class="hljs-attr">api:</span>
    <span class="hljs-attr">secret:</span> <span class="hljs-string">encrypt:DC76b3+IyNwp+f/1QxPiIA==</span>
</code></pre>
<h5 data-id="heading-31">错误输出示例</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[配置校验]</span> 开始校验核心配置
<span class="hljs-number">22</span>:<span class="hljs-number">15</span>:<span class="hljs-number">56.187</span> [main] ERROR org.springframework.boot.SpringApplication -- Application run failed
java.lang.IllegalArgumentException: 核心配置缺失：spring.datasource.url
    at com.example.demo.envprocessor.ConfigValidateProcessor.<span class="hljs-built_in">validateConfigExists</span>(ConfigValidateProcessor.java:<span class="hljs-number">47</span>)
    at com.example.demo.envprocessor.ConfigValidateProcessor.<span class="hljs-built_in">postProcessEnvironment</span>(ConfigValidateProcessor.java:<span class="hljs-number">23</span>)
    at org.springframework.boot.env.EnvironmentPostProcessorApplicationListener.<span class="hljs-built_in">onApplicationEnvironmentPreparedEvent</span>(EnvironmentPostProcessorApplicationListener.java:<span class="hljs-number">132</span>)
    at org.springframework.boot.env.EnvironmentPostProcessorApplicationListener.<span class="hljs-built_in">onApplicationEvent</span>(EnvironmentPostProcessorApplicationListener.java:<span class="hljs-number">115</span>)
    at org.springframework.context.event.SimpleApplicationEventMulticaster.<span class="hljs-built_in">doInvokeListener</span>(SimpleApplicationEventMulticaster.java:<span class="hljs-number">185</span>)
    at org.springframework.context.event.SimpleApplicationEventMulticaster.<span class="hljs-built_in">invokeListener</span>(SimpleApplicationEventMulticaster.java:<span class="hljs-number">178</span>)
    at org.springframework.context.event.SimpleApplicationEventMulticaster.<span class="hljs-built_in">multicastEvent</span>(SimpleApplicationEventMulticaster.java:<span class="hljs-number">156</span>)
    at org.springframework.context.event.SimpleApplicationEventMulticaster.<span class="hljs-built_in">multicastEvent</span>(SimpleApplicationEventMulticaster.java:<span class="hljs-number">138</span>)
    at org.springframework.boot.context.event.EventPublishingRunListener.<span class="hljs-built_in">multicastInitialEvent</span>(EventPublishingRunListener.java:<span class="hljs-number">136</span>)
    at org.springframework.boot.context.event.EventPublishingRunListener.<span class="hljs-built_in">environmentPrepared</span>(EventPublishingRunListener.java:<span class="hljs-number">81</span>)
    at org.springframework.boot.SpringApplicationRunListeners.lambda$environmentPrepared$<span class="hljs-number">2</span>(SpringApplicationRunListeners.java:<span class="hljs-number">64</span>)
    at java.base/java.lang.Iterable.<span class="hljs-built_in">forEach</span>(Iterable.java:<span class="hljs-number">75</span>)
    at org.springframework.boot.SpringApplicationRunListeners.<span class="hljs-built_in">doWithListeners</span>(SpringApplicationRunListeners.java:<span class="hljs-number">118</span>)
    at org.springframework.boot.SpringApplicationRunListeners.<span class="hljs-built_in">doWithListeners</span>(SpringApplicationRunListeners.java:<span class="hljs-number">112</span>)
    at org.springframework.boot.SpringApplicationRunListeners.<span class="hljs-built_in">environmentPrepared</span>(SpringApplicationRunListeners.java:<span class="hljs-number">63</span>)
    at org.springframework.boot.SpringApplication.<span class="hljs-built_in">prepareEnvironment</span>(SpringApplication.java:<span class="hljs-number">353</span>)
    at org.springframework.boot.SpringApplication.<span class="hljs-built_in">run</span>(SpringApplication.java:<span class="hljs-number">313</span>)
    at org.springframework.boot.SpringApplication.<span class="hljs-built_in">run</span>(SpringApplication.java:<span class="hljs-number">1361</span>)
    at org.springframework.boot.SpringApplication.<span class="hljs-built_in">run</span>(SpringApplication.java:<span class="hljs-number">1350</span>)
    at com.example.demo.DemoApplication.<span class="hljs-built_in">main</span>(DemoApplication.java:<span class="hljs-number">11</span>)
已与地址为 <span class="hljs-string">''</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">57589</span><span class="hljs-string">'，传输: '</span>套接字<span class="hljs-string">''</span> 的目标虚拟机断开连接
</code></pre>
<h5 data-id="heading-32">生产价值</h5>
<ul>
<li>提前拦截非法配置，避免应用启动后不可用；</li>
<li>错误提示明确，缩短配置问题排查时间；</li>
<li>补全默认配置，减少配置文件维护成本；</li>
<li>统一校验规则，符合生产环境配置规范。</li>
</ul>
<h3 data-id="heading-33">六、总结</h3>
<p><code>EnvironmentPostProcessor</code> 是 Spring Boot 配置治理的核心扩展点，它在配置最终生效前提供了强大的定制化能力：</p>
<ul>
<li><strong>配置中心化</strong>：从配置中心拉取配置，解耦配置与代码；</li>
<li><strong>配置加密</strong>：敏感配置密文存储，运行时动态解密；</li>
<li><strong>动态覆盖</strong>：基于环境 / 机器标签动态调整配置；</li>
<li><strong>配置校验</strong>：提前拦截非法配置，保障应用启动成功。</li>
</ul>
<p>相较于 <code>SpringApplicationRunListener</code>，<code>EnvironmentPostProcessor</code> 更聚焦于配置层面的扩展，是构建 “配置即代码”“配置统一管控” 生产级应用的关键工具。</p>
<p>📌 <strong>关注我</strong>，每天 5 分钟，带你从 Java 小白变身编程高手！</p>
<p>👉 点赞 + 关注 + 转发，让更多小伙伴一起进步！</p>
<p>👉 私信 "SpringBoot 钩子源码" 获取完整源码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：Checkpoint机制（下）]]></title>    <link>https://juejin.cn/post/7585458459166507042</link>    <guid>https://juejin.cn/post/7585458459166507042</guid>    <pubDate>2025-12-20T13:59:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585458459166507042" data-draft-id="7585458459166490658" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Checkpoint机制（下）"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2025-12-20T13:59:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Checkpoint机制（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:59:07.000Z" title="Sat Dec 20 2025 13:59:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>书接上回，前文我们梳理的 Checkpoint 机制的源码，但是对于如何写入状态数据并没有深入了解。今天就一起来梳理一下这部分代码。</p>
<h3 data-id="heading-0">写在前面</h3>
<p>前面我们了解到在 <code>StreamOperatorStateHandler.snapshotState</code> 方法中会创建四个 Future，用来支持不同类型的状态写入。</p>
<pre><code class="hljs language-java" lang="java">snapshotInProgress.setKeyedStateRawFuture(snapshotContext.getKeyedStateStreamFuture());
snapshotInProgress.setOperatorStateRawFuture(
        snapshotContext.getOperatorStateStreamFuture());

<span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != operatorStateBackend) {
    snapshotInProgress.setOperatorStateManagedFuture(
            operatorStateBackend.snapshot(
                    checkpointId, timestamp, factory, checkpointOptions));
}

<span class="hljs-keyword">if</span> (useAsyncState &amp;&amp; <span class="hljs-literal">null</span> != asyncKeyedStateBackend) {
    <span class="hljs-keyword">if</span> (isCanonicalSavepoint(checkpointOptions.getCheckpointType())) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">"Not supported yet."</span>);
    } <span class="hljs-keyword">else</span> {
        snapshotInProgress.setKeyedStateManagedFuture(
                asyncKeyedStateBackend.snapshot(
                        checkpointId, timestamp, factory, checkpointOptions));
    }
}
</code></pre>
<p>我们主要关心 ManagedState，ManagedState 都是调用 <code>Snapshotable.snapshot</code> 方法来写入数据的，下面具体看 KeyedState 和 OperatorState 的具体实现。</p>
<h3 data-id="heading-1">KeyedState</h3>
<p>KeyedState 我们以 HeapKeyedStateBackend 为例，这里先是创建了一个 <code>SnapshotStrategyRunner</code> 实例，SnapshotStrategyRunner 是一个快照策略的一个执行类，创建完成后就会调用 snapshot 方法。在这个 snapshot 方法中主要做了做了下面几件事：</p>
<ol>
<li>
<p>同步拷贝状态数据的引用。</p>
</li>
<li>
<p>创建 Checkpoint 输出流 <code>CheckpointStateOutputStream</code></p>
</li>
<li>
<p>完成 Checkpoint 持久化</p>
</li>
<li>
<p>返回元信息结果</p>
</li>
</ol>
<h4 data-id="heading-2">状态数据引用拷贝</h4>
<p>在 HeapSnapshotStrategy 的 syncPrepareResources 方法中调用了 <code>HeapSnapshotResources.create</code> 方法。这里有一个比较重要的参数是 registeredKVStates，它代表我们在业务代码中注册的状态数据表。</p>
<pre><code class="hljs language-java" lang="java">ValueStateDescriptor&lt;Tuple2&lt;Long, Long&gt;&gt; descriptor =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueStateDescriptor</span>&lt;&gt;(
                <span class="hljs-string">"average"</span>,
                TypeInformation.of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHint</span>&lt;Tuple2&lt;Long, Long&gt;&gt;() {}));
</code></pre>
<p>例如我们这样注册状态数据表，那么 registeredKVStates 的 key 就是 average，value 就是状态表，它通常是一个 CopyOnWriteStateTable。具体的状态数据引用拷贝的逻辑在 <code>processSnapshotMetaInfoForAllStates</code> 方法中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSnapshotMetaInfoForAllStates</span><span class="hljs-params">(
        List&lt;StateMetaInfoSnapshot&gt; metaInfoSnapshots,
        Map&lt;StateUID, StateSnapshot&gt; cowStateStableSnapshots,
        Map&lt;StateUID, Integer&gt; stateNamesToId,
        Map&lt;String, ? extends StateSnapshotRestore&gt; registeredStates,
        StateMetaInfoSnapshot.BackendStateType stateType)</span> {

    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StateSnapshotRestore</span>&gt; kvState :
            registeredStates.entrySet()) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">StateUID</span> <span class="hljs-variable">stateUid</span> <span class="hljs-operator">=</span> StateUID.of(kvState.getKey(), stateType);
        stateNamesToId.put(stateUid, stateNamesToId.size());
        <span class="hljs-type">StateSnapshotRestore</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> kvState.getValue();
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != state) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">StateSnapshot</span> <span class="hljs-variable">stateSnapshot</span> <span class="hljs-operator">=</span> state.stateSnapshot();
            metaInfoSnapshots.add(stateSnapshot.getMetaInfoSnapshot());
            cowStateStableSnapshots.put(stateUid, stateSnapshot);
        }
    }
}
</code></pre>
<p>针对每个 State，这里都创建一个 CopyOnWriteStateTableSnapshot，然后存在 cowStateStableSnapshots 里。这里 CopyOnWriteStateTableSnapshot 就是拷贝数据的引用，因此可以同步执行。</p>
<h4 data-id="heading-3">创建 CheckpointStateOutputStream</h4>
<p>创建 CheckpointStateOutputStream 的方法是 <code>CheckpointStreamWithResultProvider.createSimpleStream</code>，生产环境通常使用的是 FsCheckpointStateOutputStream。FsCheckpointStateOutputStream 中的参数如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 状态数据写入缓冲数组，数据先写到内存中，然后 flush 到磁盘</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] writeBuffer;

<span class="hljs-comment">// 缓冲数组当前写入位置</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pos;

<span class="hljs-comment">// 文件输出流</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> FSDataOutputStream outStream;

<span class="hljs-comment">// 内存中状态大小阈值，超过阈值会 flush 到磁盘，默认20KB，最大1MB</span>
<span class="hljs-comment">// 目的是为了减少小文件数量</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> localStateThreshold;

<span class="hljs-comment">// checkpoint 基础路径</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Path basePath;

<span class="hljs-comment">// Flink 自己封装的文件系统</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FileSystem fs;

<span class="hljs-comment">// 状态数据完整路径</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Path statePath;

<span class="hljs-comment">// 相对路径</span>
<span class="hljs-keyword">private</span> String relativeStatePath;

<span class="hljs-comment">// 是否已关闭</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> closed;

<span class="hljs-comment">// 是否允许使用相对路径</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> allowRelativePaths;
</code></pre>
<h4 data-id="heading-4">Checkpoint 持久化</h4>
<p>创建完 CheckpointStateOutputStream 之后，会调用 <code>serializationProxy.write(outView)</code> 写入状态的元数据。元数据包括状态的名称、类型、序列化器等一些配置。</p>
<p>元数据写完之后，就开始分组写入状态数据。在写入时，先写 keyGroupId，然后再写当前分组的状态数据</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">keyGroupPos</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        keyGroupPos &lt; keyGroupRange.getNumberOfKeyGroups();
        ++keyGroupPos) {
    <span class="hljs-type">int</span> <span class="hljs-variable">keyGroupId</span> <span class="hljs-operator">=</span> keyGroupRange.getKeyGroupId(keyGroupPos);
    keyGroupRangeOffsets[keyGroupPos] = localStream.getPos();
    <span class="hljs-comment">// 写 keyGroupId</span>
    outView.writeInt(keyGroupId);

    <span class="hljs-keyword">for</span> (Map.Entry&lt;StateUID, StateSnapshot&gt; stateSnapshot :
            cowStateStableSnapshots.entrySet()) {
        StateSnapshot.<span class="hljs-type">StateKeyGroupWriter</span> <span class="hljs-variable">partitionedSnapshot</span> <span class="hljs-operator">=</span>
                stateSnapshot.getValue().getKeyGroupWriter();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStream</span> <span class="hljs-variable">kgCompressionOut</span> <span class="hljs-operator">=</span>
                keyGroupCompressionDecorator.decorateWithCompression(localStream)) {
            <span class="hljs-type">DataOutputViewStreamWrapper</span> <span class="hljs-variable">kgCompressionView</span> <span class="hljs-operator">=</span>
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataOutputViewStreamWrapper</span>(kgCompressionOut);
            kgCompressionView.writeShort(stateNamesToId.get(stateSnapshot.getKey()));
            <span class="hljs-comment">// 写状态数据</span>
            partitionedSnapshot.writeStateInKeyGroup(kgCompressionView, keyGroupId);
        } <span class="hljs-comment">// this will just close the outer compression stream</span>
    }
}
</code></pre>
<p>状态数据写入的调用链路如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8532e00e4e14497d964c456054bcacba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843949&amp;x-signature=kgoMWNFeh65SzeUp4yF%2F7vhDS5Q%3D" alt="writeState" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeState</span><span class="hljs-params">(
        TypeSerializer&lt;K&gt; keySerializer,
        TypeSerializer&lt;N&gt; namespaceSerializer,
        TypeSerializer&lt;S&gt; stateSerializer,
        <span class="hljs-meta">@Nonnull</span> DataOutputView dov,
        <span class="hljs-meta">@Nullable</span> StateSnapshotTransformer&lt;S&gt; stateSnapshotTransformer)</span>
        <span class="hljs-keyword">throws</span> IOException {
    SnapshotIterator&lt;K, N, S&gt; snapshotIterator =
            getIterator(
                    keySerializer,
                    namespaceSerializer,
                    stateSerializer,
                    stateSnapshotTransformer);

    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> snapshotIterator.size();
    dov.writeInt(size);
    <span class="hljs-keyword">while</span> (snapshotIterator.hasNext()) {
        StateEntry&lt;K, N, S&gt; stateEntry = snapshotIterator.next();
        namespaceSerializer.serialize(stateEntry.getNamespace(), dov);
        keySerializer.serialize(stateEntry.getKey(), dov);
        stateSerializer.serialize(stateEntry.getState(), dov);
    }
}
</code></pre>
<h4 data-id="heading-5">返回结果</h4>
<p>最后一步就是封装并返回元信息，这里收集的信息包括了每个 keyGroup 的状态数据在状态文件中的存储位置，状态数据存储的文件路径、文件大小等。</p>
<h3 data-id="heading-6">OperatorState</h3>
<p>OperatorState 的处理逻辑比 KeyedState 更简单一些，流程上都是先做状态数据的引用快照，然后写入状态数据和返回结果。在写入数据时，没有了分组写入的逻辑。直接处理 operatorState 和 broadcastState。这里就只贴一下调用流程，不做过多赘述了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50fefebe3e664ff1b639d9d3fbfb4bb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843949&amp;x-signature=f0ziWpm1rFWYSxSJffCQessZf%2FY%3D" alt="operatorState" loading="lazy"/></p>
<h3 data-id="heading-7">总结</h3>
<p>本文我们重点梳理了 KeyedState 数据写入的代码。其主要步骤包括：同步拷贝状态数据的引用，创建 Checkpoint 输出流 <code>CheckpointStateOutputStream</code> 并完成 Checkpoint 持久化，最后返回元信息结果。OperatorState 的处理过程和 KeyedState 的过程类似，只是少了分组的逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：状态管理]]></title>    <link>https://juejin.cn/post/7585485284152721443</link>    <guid>https://juejin.cn/post/7585485284152721443</guid>    <pubDate>2025-12-20T13:59:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485284152721443" data-draft-id="7585485284152705059" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：状态管理"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2025-12-20T13:59:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：状态管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:59:08.000Z" title="Sat Dec 20 2025 13:59:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前面我们介绍了 Flink 状态的分类和应用。今天从源码层面再看一下 Flink 是如何管理状态的。</p>
<h3 data-id="heading-0">State 概述</h3>
<p>关于 State 的详细介绍可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjackeyzhe.github.io%2F2025%2F08%2F04%2FFlink%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25EF%25BC%259A%25E7%258A%25B6%25E6%2580%2581%25E7%25B1%25BB%25E5%259E%258B%25E5%2592%258C%25E5%25BA%2594%25E7%2594%25A8%2F" target="_blank" title="https://jackeyzhe.github.io/2025/08/04/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9A%E7%8A%B6%E6%80%81%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%BA%94%E7%94%A8/" ref="nofollow noopener noreferrer">Flink学习笔记：状态类型和应用</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjackeyzhe.github.io%2F2025%2F08%2F24%2FFlink%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25EF%25BC%259A%25E7%258A%25B6%25E6%2580%2581%25E5%2590%258E%25E7%25AB%25AF%2F" target="_blank" title="https://jackeyzhe.github.io/2025/08/24/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9A%E7%8A%B6%E6%80%81%E5%90%8E%E7%AB%AF/" ref="nofollow noopener noreferrer">Flink学习笔记：状态后端</a>这两篇文章，为了方面阅读，这里我们再简单介绍一下。</p>
<h4 data-id="heading-1">State 使用</h4>
<p>State 是 Flink 做复杂逻辑所依赖的核心组件。它的分类如下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ad090ad897d49c6960c91af4f4dfcea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843950&amp;x-signature=CCLUmR20a58UhW88Y03xyDuUTDA%3D" alt="State 分类" loading="lazy"/></p>
<p>常见的是 Keyed State 和 Operator State，Keyed State 作用于 KeyedStream 上，Operator State 可以作用于所有的 Operator 上。Keyed State 使用时，需要先创建 StateDescriptor，然后再调用 getState 获取。</p>
<pre><code class="hljs language-java" lang="java">ValueStateDescriptor&lt;Tuple2&lt;Long, Long&gt;&gt; descriptor =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueStateDescriptor</span>&lt;&gt;(
                <span class="hljs-string">"average"</span>,
                TypeInformation.of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHint</span>&lt;Tuple2&lt;Long, Long&gt;&gt;() {}));
ValueState&lt;Tuple2&lt;Long, Long&gt;&gt; sum = getRuntimeContext().getState(descriptor);
</code></pre>
<p>Opeartor State 的获取方式与 Keyed State 类似，都需要 StateDescriptor。Operator State 在定义时需要实现 CheckpointedFunction。</p>
<h4 data-id="heading-2">State 存储</h4>
<p>State Backend 用来管理 State 存储，根据存储格式和存储类型的组合，可以分为三类：</p>
<ol>
<li>
<p>MemoryStateBackend：HashMapStateBackend 和 JobManagerCheckpointStorage 的组合，即将 State 以 Java 对象的形式存储在 JobManager 内存中。</p>
</li>
<li>
<p>FsStateBackend：HashMapStateBackend 和 FileSystemCheckpointStorage 的组合，将 State 以 Java 对象的形式存储在远端文件系统中。</p>
</li>
<li>
<p>RocksDBStateBackend：EmbeddedRocksDBStateBackend 和 FileSystemCheckpointStorage 的组合，State 序列化后存储在 RocksDB。</p>
</li>
</ol>
<h3 data-id="heading-3">创建 State Backend</h3>
<p>创建 State Backend 的入口在 StreamTask，StreamTask 是 Flink 部署和运行在 TaskManager 的基本单元。</p>
<p>在 StreamTask 的 invoke 方法中，会先调用 restoreStateAndGates 方法去创建 State Backend。完整的调用链路如下图所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69608e44b8314186b748a766bb8eef6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843950&amp;x-signature=BVoarsKFnzdP%2BJASPW8XWtPuIoo%3D" alt="stateBackend" loading="lazy"/></p>
<p>在 streamOperatorStateContext 方法中，分别调用了 keyedStatedBackend 和 operatorStateBackend 来创建两种 State Backend。</p>
<p>我们先来看 keyedStateBackend 的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> &lt;K, R <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Disposable</span> &amp; Closeable&gt; R <span class="hljs-title function_">keyedStatedBackend</span><span class="hljs-params">(
        TypeSerializer&lt;K&gt; keySerializer,
        String operatorIdentifierText,
        PrioritizedOperatorSubtaskState prioritizedOperatorSubtaskStates,
        CloseableRegistry backendCloseableRegistry,
        MetricGroup metricGroup,
        <span class="hljs-type">double</span> managedMemoryFraction,
        StateObject.StateObjectSizeStatsCollector statsCollector,
        KeyedStateBackendCreator&lt;K, R&gt; keyedStateBackendCreator)</span>
        <span class="hljs-keyword">throws</span> Exception {

    <span class="hljs-keyword">if</span> (keySerializer == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    ......

    <span class="hljs-keyword">final</span> <span class="hljs-type">KeyGroupRange</span> <span class="hljs-variable">keyGroupRange</span> <span class="hljs-operator">=</span>
            KeyGroupRangeAssignment.computeKeyGroupRangeForOperatorIndex(
                    taskInfo.getMaxNumberOfParallelSubtasks(),
                    taskInfo.getNumberOfParallelSubtasks(),
                    taskInfo.getIndexOfThisSubtask());

    <span class="hljs-comment">// Now restore processing is included in backend building/constructing process, so we need</span>
    <span class="hljs-comment">// to make sure</span>
    <span class="hljs-comment">// each stream constructed in restore could also be closed in case of task cancel, for</span>
    <span class="hljs-comment">// example the data</span>
    <span class="hljs-comment">// input stream opened for serDe during restore.</span>
    <span class="hljs-type">CloseableRegistry</span> <span class="hljs-variable">cancelStreamRegistryForRestore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloseableRegistry</span>();
    backendCloseableRegistry.registerCloseable(cancelStreamRegistryForRestore);
    BackendRestorerProcedure&lt;R, KeyedStateHandle&gt; backendRestorer =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">BackendRestorerProcedure</span>&lt;&gt;(
                    (stateHandles) -&gt; {
                        KeyedStateBackendParametersImpl&lt;K&gt; parameters =
                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyedStateBackendParametersImpl</span>&lt;&gt;(...);
                        <span class="hljs-keyword">return</span> keyedStateBackendCreator.create(...),
                                parameters);
                    },
                    backendCloseableRegistry,
                    logDescription);

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> backendRestorer.createAndRestore(
                prioritizedOperatorSubtaskStates.getPrioritizedManagedKeyedState(),
                statsCollector);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (backendCloseableRegistry.unregisterCloseable(cancelStreamRegistryForRestore)) {
            IOUtils.closeQuietly(cancelStreamRegistryForRestore);
        }
    }
}
</code></pre>
<p>这里的创建过程也比较简单，先是获取 KeyGroupRange，它表示的是当前 Operator 上处理的 key 的范围。然后就是创建 StateBackend 实例，这里通过 BackendRestorerProcedure 封装统一的恢复、异常处理和资源清理逻辑。operatorStateBackend 方法的逻辑相比较来说，只是少了 KeyGroupRange 的处理，直接创建 StateBackend 实例。</p>
<h3 data-id="heading-4">创建和使用 State</h3>
<h4 data-id="heading-5">创建 KeyedState</h4>
<p>KeyedState 是通过调用 StreamingRuntimeContext.getState 方法获取的。我们先来看完整的调用流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9fcfec7f0c14599b878274c903f8105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766843950&amp;x-signature=e4sko2oJgvXk7%2BBo4jNViJQjnUY%3D" alt="getState" loading="lazy"/></p>
<p>在调用 getState 这些方法时，都会先调用 keyedStateStore 提供的方法，它是 Flink 提供的一个封装 keyedStateBackend 的接口。调用流程的最后，是调用 keyedStateBackend 中的 createOrUpdateInternalState 方法（这里我们以 HeapStateBackend 为例）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> &lt;N, SV, SEV, S <span class="hljs-keyword">extends</span> <span class="hljs-title class_">State</span>, IS <span class="hljs-keyword">extends</span> <span class="hljs-title class_">S</span>&gt; IS <span class="hljs-title function_">createOrUpdateInternalState</span><span class="hljs-params">(
        <span class="hljs-meta">@Nonnull</span> TypeSerializer&lt;N&gt; namespaceSerializer,
        <span class="hljs-meta">@Nonnull</span> StateDescriptor&lt;S, SV&gt; stateDesc,
        <span class="hljs-meta">@Nonnull</span> StateSnapshotTransformFactory&lt;SEV&gt; snapshotTransformFactory,
        <span class="hljs-type">boolean</span> allowFutureMetadataUpdates)</span>
        <span class="hljs-keyword">throws</span> Exception {
    StateTable&lt;K, N, SV&gt; stateTable =
            tryRegisterStateTable(
                    namespaceSerializer,
                    stateDesc,
                    getStateSnapshotTransformFactory(stateDesc, snapshotTransformFactory),
                    allowFutureMetadataUpdates);

    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-type">IS</span> <span class="hljs-variable">createdState</span> <span class="hljs-operator">=</span> (IS) createdKVStates.get(stateDesc.getName());
    <span class="hljs-keyword">if</span> (createdState == <span class="hljs-literal">null</span>) {
        <span class="hljs-type">StateCreateFactory</span> <span class="hljs-variable">stateCreateFactory</span> <span class="hljs-operator">=</span> STATE_CREATE_FACTORIES.get(stateDesc.getType());
        <span class="hljs-keyword">if</span> (stateCreateFactory == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlinkRuntimeException</span>(stateNotSupportedMessage(stateDesc));
        }
        createdState =
                stateCreateFactory.createState(stateDesc, stateTable, getKeySerializer());
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-type">StateUpdateFactory</span> <span class="hljs-variable">stateUpdateFactory</span> <span class="hljs-operator">=</span> STATE_UPDATE_FACTORIES.get(stateDesc.getType());
        <span class="hljs-keyword">if</span> (stateUpdateFactory == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlinkRuntimeException</span>(stateNotSupportedMessage(stateDesc));
        }
        createdState = stateUpdateFactory.updateState(stateDesc, stateTable, createdState);
    }

    createdKVStates.put(stateDesc.getName(), createdState);
    <span class="hljs-keyword">return</span> createdState;
}


<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;StateDescriptor.Type, StateCreateFactory&gt; STATE_CREATE_FACTORIES =
        Stream.of(
                        Tuple2.of(
                                StateDescriptor.Type.VALUE,
                                (StateCreateFactory) HeapValueState::create),
                        Tuple2.of(
                                StateDescriptor.Type.LIST,
                                (StateCreateFactory) HeapListState::create),
                        Tuple2.of(
                                StateDescriptor.Type.MAP,
                                (StateCreateFactory) HeapMapState::create),
                        Tuple2.of(
                                StateDescriptor.Type.AGGREGATING,
                                (StateCreateFactory) HeapAggregatingState::create),
                        Tuple2.of(
                                StateDescriptor.Type.REDUCING,
                                (StateCreateFactory) HeapReducingState::create))
                .collect(Collectors.toMap(t -&gt; t.f0, t -&gt; t.f1));
</code></pre>
<p>这里首先是注册了一个 StateTable，这个是 State 中一个非常重要的成员变量，它内部是一个类似 Map 的结构，用来保存 key 和 key 的状态。</p>
<p>STATE_CREATE_FACTORIES 这个变量保存了不同类型的 State 和它对应的创建方法，同理 STATE_UPDATE_FACTORIES 保存的是不同 State 对应的 更新方法。</p>
<h4 data-id="heading-6">创建 OperatorState</h4>
<p>看完了 KeyedState 的创建过程后，我们再来看下 OperatorState 的创建过程。</p>
<p>OperatorState 的创建方法是通过 FunctionInitializationContext 先获取到 OperatorStateStore，它与 KeyedStateStore 类似，都是对 StateBackend 的方法进行了封装。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeState</span><span class="hljs-params">(FunctionInitializationContext context)</span> <span class="hljs-keyword">throws</span> Exception {
    ListStateDescriptor&lt;Tuple2&lt;String, Integer&gt;&gt; descriptor =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListStateDescriptor</span>&lt;&gt;(
                    <span class="hljs-string">"buffered-elements"</span>,
                    TypeInformation.of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHint</span>&lt;Tuple2&lt;String, Integer&gt;&gt;() {}));

    checkpointedState = context.getOperatorStateStore().getListState(descriptor);

    <span class="hljs-keyword">if</span> (context.isRestored()) {
        <span class="hljs-keyword">for</span> (Tuple2&lt;String, Integer&gt; element : checkpointedState.get()) {
            bufferedElements.add(element);
        }
    }
}
</code></pre>
<p>OperatorStateStore 的 getListState 方法中，直接创建出了 PartitionableListState，同时也做了一些缓存操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> &lt;S&gt; ListState&lt;S&gt; <span class="hljs-title function_">getListState</span><span class="hljs-params">(
        ListStateDescriptor&lt;S&gt; stateDescriptor, OperatorStateHandle.Mode mode)</span>
        <span class="hljs-keyword">throws</span> StateMigrationException {

    ......
    PartitionableListState&lt;S&gt; partitionableListState =
            (PartitionableListState&lt;S&gt;) registeredOperatorStates.get(name);

    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == partitionableListState) {
        <span class="hljs-comment">// no restored state for the state name; simply create new state holder</span>

        partitionableListState =
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PartitionableListState</span>&lt;&gt;(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegisteredOperatorStateBackendMetaInfo</span>&lt;&gt;(
                                name, partitionStateSerializer, mode));

        registeredOperatorStates.put(name, partitionableListState);
    } <span class="hljs-keyword">else</span> {
        ......
    }

    accessedStatesByName.put(name, partitionableListState);
    <span class="hljs-keyword">return</span> partitionableListState;
}
</code></pre>
<p>PartitionableListState 内部有一个 ArrayList 用于保存数据。</p>
<h4 data-id="heading-7">使用 KeyedState</h4>
<p>了解完 State 的创建之后，接下来就是 State 的使用了。我们以 HeapValueState 为例来看如何获取 State。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// HeapValueState 类</span>
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">value</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">V</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stateTable.get(currentNamespace);

    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> getDefaultValue();
    }

    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>在 HeapValueState 类的 value 方法中，直接调用 StateTable 的 get 方法，最终调用的是 CopyOnWriteStateMap 的 get 方法，这个方法与 HashMap 的 get 方法比较类似。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> S <span class="hljs-title function_">get</span><span class="hljs-params">(K key, N namespace)</span> {

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> computeHashForOperationAndDoIncrementalRehash(key, namespace);
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">requiredVersion</span> <span class="hljs-operator">=</span> highestRequiredSnapshotVersion;
    <span class="hljs-keyword">final</span> StateMapEntry&lt;K, N, S&gt;[] tab = selectActiveTable(hash);
    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> hash &amp; (tab.length - <span class="hljs-number">1</span>);

    <span class="hljs-keyword">for</span> (StateMapEntry&lt;K, N, S&gt; e = tab[index]; e != <span class="hljs-literal">null</span>; e = e.next) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">K</span> <span class="hljs-variable">eKey</span> <span class="hljs-operator">=</span> e.key;
        <span class="hljs-keyword">final</span> <span class="hljs-type">N</span> <span class="hljs-variable">eNamespace</span> <span class="hljs-operator">=</span> e.namespace;
        <span class="hljs-keyword">if</span> ((e.hash == hash &amp;&amp; key.equals(eKey) &amp;&amp; namespace.equals(eNamespace))) {

            <span class="hljs-comment">// copy-on-write check for state</span>
            <span class="hljs-keyword">if</span> (e.stateVersion &lt; requiredVersion) {
                <span class="hljs-comment">// copy-on-write check for entry</span>
                <span class="hljs-keyword">if</span> (e.entryVersion &lt; requiredVersion) {
                    e = handleChainedEntryCopyOnWrite(tab, hash &amp; (tab.length - <span class="hljs-number">1</span>), e);
                }
                e.stateVersion = stateMapVersion;
                e.state = getStateSerializer().copy(e.state);
            }

            <span class="hljs-keyword">return</span> e.state;
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-8">使用 OperatorState</h4>
<p>OperatorState 底层使用的是 PartitionableListState，前面也提到了，它的内部用了一个 ArrayList 来保存数据，对于 OperatorState 的各种操作也都是来操作这个 ArrayList。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
    internalList.clear();
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Iterable&lt;S&gt; <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> internalList;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(S value)</span> {
    Preconditions.checkNotNull(value, <span class="hljs-string">"You cannot add null to a ListState."</span>);
    internalList.add(value);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(List&lt;S&gt; values)</span> {
    internalList.clear();

    addAll(values);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(List&lt;S&gt; values)</span> {
    Preconditions.checkNotNull(values, <span class="hljs-string">"List of values to add cannot be null."</span>);
    <span class="hljs-keyword">if</span> (!values.isEmpty()) {
        <span class="hljs-keyword">for</span> (S value : values) {
            checkNotNull(value, <span class="hljs-string">"Any value to add to a list cannot be null."</span>);
            add(value);
        }
    }
}
</code></pre>
<h3 data-id="heading-9">总结</h3>
<p>本文对 State 的相关代码进行了梳理。包括 StateBackend 的创建，KeyedState 和 OperatorState 的创建和使用。State 和 Checkpoint 两者需要结合使用，因此后面我们会再梳理 Checkpoint 的相关代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 的金额计算用 long 还是 BigDecimal？资深程序员这样选]]></title>    <link>https://juejin.cn/post/7585485074038554630</link>    <guid>https://juejin.cn/post/7585485074038554630</guid>    <pubDate>2025-12-21T02:42:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038554630" data-draft-id="7577705544875589670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 的金额计算用 long 还是 BigDecimal？资深程序员这样选"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-21T02:42:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 的金额计算用 long 还是 BigDecimal？资深程序员这样选
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:42:38.000Z" title="Sun Dec 21 2025 02:42:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>最近接触一个新项目，发现系统中所有金额相关字段都使用<code>long</code>类型来表示。</p>
<p>作为一个习惯使用<code>BigDecimal</code>处理金额的开发者，这让我产生了疑惑：这会不会有精度问题？为什么要这样设计？</p>
<p>“用<code>double</code>不行吗？它也能表示小数啊！”</p>
<p>经过一番研究和思考，把最终得出的结论来和大家详细分享一下。</p>
<h3 data-id="heading-1">一、double、float类型比较</h3>
<p><code>double</code>和<code>float</code>都是Java中的浮点数类型，它们采用IEEE 754标准来表示小数。</p>
<p>这种表示方法类似于科学计数法，但存在一个致命问题：<strong>不是所有小数都能精确表示</strong>。</p>
<p>举一个简单的例子：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">double</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span>;
<span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.2</span>;
<span class="hljs-type">double</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> a + b;
System.out.println(result); 
<span class="hljs-comment">// 输出：0.30000000000000004</span>
</code></pre>
<p>什么？简单的0.1 + 0.2居然不等于0.3？</p>
<p>是的，这是因为在二进制的计算中，有些十进制小数没有办法精确表示，就像1除以3一样，在十进制中也不能精确表示（0.33333...）。</p>
<h3 data-id="heading-2">二、BigDecimal 解决方案</h3>
<h4 data-id="heading-3">BigDecimal的正确用法</h4>
<p><code>BigDecimal</code>可以解决精度问题，但必须正确使用。</p>
<p><strong>错误的构造方式</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">wrong1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.1</span>); 
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">wrong2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.2</span>);
</code></pre>
<p>这种传入浮点型的构造方式还是会有精度问题。</p>
<p><strong>正确的构造方式</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">correct1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.1"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">correct2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.2"</span>);
System.out.println(<span class="hljs-string">"正确方式: "</span> + correct1.add(correct2)); <span class="hljs-comment">// 0.3</span>
</code></pre>
<p>通过传入字符串进行构造。</p>
<p><strong>或者用valueOf（内部也是转字符串）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">safe1</span> <span class="hljs-operator">=</span> BigDecimal.valueOf(<span class="hljs-number">0.1</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">safe2</span> <span class="hljs-operator">=</span> BigDecimal.valueOf(<span class="hljs-number">0.2</span>);
System.out.println(<span class="hljs-string">"安全方式: "</span> + safe1.add(safe2)); <span class="hljs-comment">// 0.3</span>
</code></pre>
<h4 data-id="heading-4">BigDecimal的运算规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDecimalOperations</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"19.99"</span>);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">quantity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"3"</span>);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">taxRate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.13"</span>);
        
        <span class="hljs-comment">// 乘法</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">subtotal</span> <span class="hljs-operator">=</span> price.multiply(quantity);
        
        <span class="hljs-comment">// 除法必须指定精度和舍入模式</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">tax</span> <span class="hljs-operator">=</span> subtotal.multiply(taxRate)
                               .setScale(<span class="hljs-number">2</span>, RoundingMode.HALF_UP);
        
        <span class="hljs-comment">// 加法</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> subtotal.add(tax);
        
        System.out.println(<span class="hljs-string">"小计: "</span> + subtotal); <span class="hljs-comment">// 59.97</span>
        System.out.println(<span class="hljs-string">"税金: "</span> + tax);      <span class="hljs-comment">// 7.80</span>
        System.out.println(<span class="hljs-string">"总计: "</span> + total);    <span class="hljs-comment">// 67.77</span>
    }
}
</code></pre>
<h4 data-id="heading-5">BigDecimal的比较操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDecimalComparison</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.00"</span>);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.000"</span>);
        
        <span class="hljs-comment">// 错误：比较引用</span>
        System.out.println(<span class="hljs-string">"== 比较: "</span> + (num1 == num2)); <span class="hljs-comment">// false</span>
        
        <span class="hljs-comment">// 错误：equals会比较精度</span>
        System.out.println(<span class="hljs-string">"equals比较: "</span> + num1.equals(num2)); <span class="hljs-comment">// false</span>
        
        <span class="hljs-comment">// 正确：compareTo只比较数值</span>
        System.out.println(<span class="hljs-string">"compareTo比较: "</span> + (num1.compareTo(num2) == <span class="hljs-number">0</span>)); <span class="hljs-comment">// true</span>
    }
}
</code></pre>
<h4 data-id="heading-6">BigDecimal的缺点</h4>
<ol>
<li><strong>性能开销</strong>：对象创建和运算成本高</li>
<li><strong>内存占用</strong>：每个对象需要20-30字节</li>
<li><strong>使用复杂</strong>：容易用错构造方法和运算规则</li>
<li><strong>代码冗长</strong>：简单的运算也需要多行代码</li>
</ol>
<h3 data-id="heading-7">三、long方案</h3>
<h4 data-id="heading-8">核心思想：以分为单位存储</h4>
<p>使用<code>long</code>表示金额的核心思路是：不以元为单位，而以最小货币单位（分）存储。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongAmountDemo</span> {
    <span class="hljs-comment">// 工具方法：元转分</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">yuanToFen</span><span class="hljs-params">(<span class="hljs-type">double</span> yuan)</span> {
        <span class="hljs-keyword">return</span> Math.round(yuan * <span class="hljs-number">100</span>);
    }
    
    <span class="hljs-comment">// 工具方法：分转元（用于显示）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fenToYuanDisplay</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"¥%.2f"</span>, fen / <span class="hljs-number">100.0</span>);
    }
    
    <span class="hljs-comment">// 工具方法：分转元（用于计算）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">fenToYuan</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> fen / <span class="hljs-number">100.0</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 以分为单位存储所有金额</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> yuanToFen(<span class="hljs-number">19.99</span>);  <span class="hljs-comment">// 1999分 = 19.99元</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">quantity</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">taxRate</span> <span class="hljs-operator">=</span> <span class="hljs-number">13</span>;  <span class="hljs-comment">// 13% = 0.13，这里用整数表示百分比</span>
        
        <span class="hljs-comment">// 计算过程全部使用整数运算</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">subtotal</span> <span class="hljs-operator">=</span> price * quantity;                    <span class="hljs-comment">// 5997分</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">tax</span> <span class="hljs-operator">=</span> (subtotal * taxRate) / <span class="hljs-number">100</span>;               <span class="hljs-comment">// 780分</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> subtotal + tax;                         <span class="hljs-comment">// 6777分</span>
        
        System.out.println(<span class="hljs-string">"小计: "</span> + fenToYuanDisplay(subtotal)); <span class="hljs-comment">// ¥59.97</span>
        System.out.println(<span class="hljs-string">"税金: "</span> + fenToYuanDisplay(tax));      <span class="hljs-comment">// ¥7.80</span>
        System.out.println(<span class="hljs-string">"总计: "</span> + fenToYuanDisplay(total));    <span class="hljs-comment">// ¥67.77</span>
    }
}
</code></pre>
<h4 data-id="heading-9">long方案的优势</h4>
<p><strong>1.绝对精确</strong>
整数运算在计算机中是精确的，不会出现浮点数的精度问题。</p>
<p><strong>2.性能卓越</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// long运算 - 机器指令级别，极快</span>
<span class="hljs-type">long</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000L</span>, b = <span class="hljs-number">2000L</span>;
<span class="hljs-type">long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> a + b;

<span class="hljs-comment">// BigDecimal运算 - 方法调用，对象创建，较慢</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"20.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> c.add(d);
</code></pre>
<p><strong>3.存储高效</strong></p>
<ul>
<li><code>long</code>：固定8字节</li>
<li><code>BigDecimal</code>：对象头+数值，通常20-30字节</li>
</ul>
<p><strong>4.序列化简单</strong>
在数据库、JSON、网络传输中处理更简单。</p>
<h4 data-id="heading-10">实际业务应用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-comment">// 订单金额（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> orderAmount;
    <span class="hljs-comment">// 优惠金额（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> discountAmount;
    <span class="hljs-comment">// 实付金额（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> actualAmount;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateOrder</span><span class="hljs-params">(<span class="hljs-type">long</span> unitPrice, <span class="hljs-type">int</span> quantity, <span class="hljs-type">long</span> discountRate)</span> {
        <span class="hljs-comment">// 计算订单金额</span>
        orderAmount = unitPrice * quantity;
        
        <span class="hljs-comment">// 计算优惠金额</span>
        discountAmount = (orderAmount * discountRate) / <span class="hljs-number">100</span>;
        
        <span class="hljs-comment">// 计算实付金额</span>
        actualAmount = orderAmount - discountAmount;
    }
    
    <span class="hljs-comment">// 显示方法</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDisplayAmount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"订单金额: %s, 优惠: %s, 实付: %s"</span>, 
            formatFen(orderAmount),
            formatFen(discountAmount),
            formatFen(actualAmount));
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatFen</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"¥%.2f"</span>, fen / <span class="hljs-number">100.0</span>);
    }
}
</code></pre>
<h3 data-id="heading-11">四、各种方案的适用场景</h3>
<h4 data-id="heading-12">double/float：绝对不要用于金额</h4>
<ul>
<li>科学计算、图形处理</li>
<li>统计分析（允许误差）</li>
<li>物理模拟</li>
<li>不适用于任何金额计算</li>
</ul>
<h4 data-id="heading-13">BigDecimal：复杂金融计算</h4>
<ul>
<li>高精度利率、汇率计算</li>
<li>税务计算（需要复杂小数运算）</li>
<li>银行核心系统</li>
<li>需要任意精度的场景</li>
</ul>
<h4 data-id="heading-14">long：大多数业务系统</h4>
<ul>
<li>电商订单系统</li>
<li>支付系统</li>
<li>账户余额管理</li>
<li>积分、优惠券系统</li>
</ul>
<h3 data-id="heading-15">五、BigDecimal的最佳实践</h3>
<p>如果确实需要使用BigDecimal，请遵循以下规则：</p>
<h4 data-id="heading-16">1. 构造方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.1"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> BigDecimal.valueOf(<span class="hljs-number">0.1</span>);  <span class="hljs-comment">// 内部转字符串</span>

<span class="hljs-comment">// 避免</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.1</span>);      <span class="hljs-comment">// 精度问题</span>
</code></pre>
<h4 data-id="heading-17">2. 运算控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"3.00"</span>);

<span class="hljs-comment">// 除法必须指定精度</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> num1.divide(num2, <span class="hljs-number">4</span>, RoundingMode.HALF_UP);

<span class="hljs-comment">// 乘法建议控制精度</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> num1.multiply(num2).setScale(<span class="hljs-number">2</span>, RoundingMode.HALF_UP);
</code></pre>
<h4 data-id="heading-18">3. 数值比较</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">amount1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">amount2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.000"</span>);

<span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">if</span> (amount1.compareTo(amount2) == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 数值相等</span>
}

<span class="hljs-comment">// 错误</span>
<span class="hljs-keyword">if</span> (amount1.equals(amount2)) {
    <span class="hljs-comment">// 不会执行，因为精度不同</span>
}
</code></pre>
<h3 data-id="heading-19">六、long方案的实施建议</h3>
<h4 data-id="heading-20">1. 建立工具类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyUtils</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MoneyUtils</span><span class="hljs-params">()</span> {} <span class="hljs-comment">// 工具类，防止实例化</span>
    
    <span class="hljs-comment">// 元转分</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">yuanToFen</span><span class="hljs-params">(<span class="hljs-type">double</span> yuan)</span> {
        <span class="hljs-keyword">return</span> Math.round(yuan * <span class="hljs-number">100</span>);
    }
    
    <span class="hljs-comment">// 分转元（显示用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fenToDisplayYuan</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"¥%.2f"</span>, fen / <span class="hljs-number">100.0</span>);
    }
    
    <span class="hljs-comment">// 分转元（计算用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">fenToYuan</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> fen / <span class="hljs-number">100.0</span>;
    }
    
    <span class="hljs-comment">// 金额加法（防止溢出）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">long</span> amount1, <span class="hljs-type">long</span> amount2)</span> {
        <span class="hljs-keyword">return</span> Math.addExact(amount1, amount2);
    }
    
    <span class="hljs-comment">// 金额乘法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">multiply</span><span class="hljs-params">(<span class="hljs-type">long</span> amount, <span class="hljs-type">int</span> multiplier)</span> {
        <span class="hljs-keyword">return</span> Math.multiplyExact(amount, multiplier);
    }
}
</code></pre>
<h4 data-id="heading-21">2. 数据库设计</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用bigint存储金额（分）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    order_amount <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'订单金额（分）'</span>,
    discount_amount <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'优惠金额（分）'</span>,
    actual_amount <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'实付金额（分）'</span>
);
</code></pre>
<h4 data-id="heading-22">3. API设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求和响应中使用Long类型表示金额（分）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderRequest</span> {
    <span class="hljs-keyword">private</span> Long productId;
    <span class="hljs-keyword">private</span> Integer quantity;
    <span class="hljs-keyword">private</span> Long unitPrice;  <span class="hljs-comment">// 单价（分）</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderResponse</span> {
    <span class="hljs-keyword">private</span> String orderNo;
    <span class="hljs-keyword">private</span> Long totalAmount;  <span class="hljs-comment">// 总金额（分）</span>
    <span class="hljs-keyword">private</span> String displayAmount; <span class="hljs-comment">// 显示金额 "¥99.99"</span>
}
</code></pre>
<h3 data-id="heading-23">总结与选择</h3>
<h4 data-id="heading-24">为什么那个项目选择long？</h4>
<p>现在我可以理解那个项目的设计思路了：</p>
<ol>
<li><strong>业务特性</strong>：主要是简单的加减乘运算，没有复杂的小数除法</li>
<li><strong>性能要求</strong>：高并发场景，需要最优性能</li>
<li><strong>团队协作</strong>：统一规范，避免BigDecimal的误用</li>
<li><strong>系统复杂度</strong>：降低系统复杂度和维护成本</li>
</ol>
<h4 data-id="heading-25">如何选择？</h4>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>简单业务系统</td><td><strong>long</strong></td><td>性能好，简单可靠</td></tr><tr><td>银行金融系统</td><td><strong>BigDecimal</strong></td><td>精度要求极高</td></tr><tr><td>高并发交易</td><td><strong>long</strong></td><td>性能至关重要</td></tr><tr><td>复杂税务计算</td><td><strong>BigDecimal</strong></td><td>需要复杂小数运算</td></tr><tr><td>新项目启动</td><td><strong>long</strong></td><td>技术债务少</td></tr></tbody></table>
<p>技术选型从来都不是单一的，理解业务的需求，能选择出最适合的技术方案就是最好的方案。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-26">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6V83qjR6u0nyfzL-14xYAw" target="_blank" title="https://mp.weixin.qq.com/s/6V83qjR6u0nyfzL-14xYAw" ref="nofollow noopener noreferrer">《async/await 到底要不要加 try-catch？异步错误处理最佳实践》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3 和 Vue2 的核心区别？很多开发者都没完全搞懂的 10 个细节》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqI3TRTdDfRJSH9kCTqAQUw" target="_blank" title="https://mp.weixin.qq.com/s/qI3TRTdDfRJSH9kCTqAQUw" ref="nofollow noopener noreferrer">《这 10 个 MySQL 高级用法，让你的代码又快又好看》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 列表转树（List to Tree）详解：前端面试中如何从递归 O(n²) 优化到一次遍历 O(n)]]></title>    <link>https://juejin.cn/post/7585706951603716122</link>    <guid>https://juejin.cn/post/7585706951603716122</guid>    <pubDate>2025-12-21T02:53:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951603716122" data-draft-id="7585534343561822258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 列表转树（List to Tree）详解：前端面试中如何从递归 O(n²) 优化到一次遍历 O(n)"/> <meta itemprop="keywords" content="JavaScript,算法,面试"/> <meta itemprop="datePublished" content="2025-12-21T02:53:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 列表转树（List to Tree）详解：前端面试中如何从递归 O(n²) 优化到一次遍历 O(n)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:53:55.000Z" title="Sun Dec 21 2025 02:53:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：Offer 是怎么没的？</h2>
<p>在前端面试的江湖里，<strong>「列表转树（List to Tree）」</strong> 是一道妥妥的高频题。</p>
<p>很多同学一看到这道题，内心 OS 都是：</p>
<blockquote>
<p>😎「简单啊，递归！」</p>
</blockquote>
<p>代码写完，自信抬头。<br/>
面试官却慢悠悠地问了一句：</p>
<blockquote>
<p>🤨「如果是 <strong>10 万条数据</strong> 呢？<br/>
👉 时间复杂度多少？<br/>
👉 会不会栈溢出？」</p>
</blockquote>
<p><strong>空气突然安静。</strong></p>
<p>今天这篇文章，我们就把这道题彻底拆开：<br/>
从「能写」到「写得对」，再到「写得漂亮」。</p>
<hr/>
<h2 data-id="heading-1">一、为什么面试官总盯着这棵“树”？</h2>
<p>因为在真实业务中，<strong>后端给你的几乎永远是扁平数据</strong>。</p>
<p>例如：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">const</span> <span class="hljs-string">list</span> <span class="hljs-string">=</span> [
  { <span class="hljs-attr">id:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">parentId:</span> <span class="hljs-number">0</span>, <span class="hljs-attr">name:</span> <span class="hljs-string">'北京市'</span> },
  { <span class="hljs-attr">id:</span> <span class="hljs-number">2</span>, <span class="hljs-attr">parentId:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">name:</span> <span class="hljs-string">'顺义区'</span> },
  { <span class="hljs-attr">id:</span> <span class="hljs-number">3</span>, <span class="hljs-attr">parentId:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">name:</span> <span class="hljs-string">'朝阳区'</span> },
  { <span class="hljs-attr">id:</span> <span class="hljs-number">4</span>, <span class="hljs-attr">parentId:</span> <span class="hljs-number">2</span>, <span class="hljs-attr">name:</span> <span class="hljs-string">'后沙峪'</span> },
  { <span class="hljs-attr">id:</span> <span class="hljs-number">121</span>, <span class="hljs-attr">parentId:</span> <span class="hljs-number">0</span>, <span class="hljs-attr">name:</span> <span class="hljs-string">'江西省'</span> },
  { <span class="hljs-attr">id:</span> <span class="hljs-number">155</span>, <span class="hljs-attr">parentId:</span> <span class="hljs-number">121</span>, <span class="hljs-attr">name:</span> <span class="hljs-string">'抚州市'</span> }
]<span class="hljs-string">;</span>
</code></pre>
<p>而前端组件（Menu、Tree、Cascader）要的却是👇</p>
<pre><code class="hljs language-markdown" lang="markdown">省
 └─ 市
<span class="hljs-code">     └─ 区
</span></code></pre>
<hr/>
<h3 data-id="heading-2">🎯 面试官的真实考点</h3>
<ul>
<li><strong>数据结构理解</strong>：是否真正理解 <code>parentId</code></li>
<li><strong>递归意识 &amp; 代价</strong>：不只会写，还要知道坑在哪</li>
<li><strong>性能优化能力</strong>：能否从 <code>O(n²)</code> 优化到 <code>O(n)</code></li>
<li><strong>JS 引用理解</strong>：是否理解对象在内存中的表现</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、第一重境界：递归法（能写，但不稳）</h2>
<h3 data-id="heading-4">1️⃣ 最基础的递归写法</h3>
<pre><code class="hljs language-ini" lang="ini">function list2tree(list, <span class="hljs-attr">parentId</span> = <span class="hljs-number">0</span>) {
  return list
    .filter(<span class="hljs-attr">item</span> =&gt; item.parentId === parentId)
    .map(<span class="hljs-attr">item</span> =&gt; ({
      ...item,
      children: list2tree(list, item.id)
    }))<span class="hljs-comment">;</span>
}
</code></pre>
<p>逻辑非常直观：</p>
<ul>
<li>找当前 <code>parentId</code> 的所有子节点</li>
<li>对每个子节点继续递归</li>
<li>没有子节点时自然退出</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、进阶：ES6 优雅写法（看起来很高级）</h2>
<p>如果你在面试中写出下面这段代码👇<br/>
<strong>面试官大概率会先点头。</strong></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">list2tree</span> = (list, parentId = <span class="hljs-number">0</span>) =&gt;
  list
    .filter(<span class="hljs-attr">item</span> =&gt; item.parentId === parentId)
    .map(<span class="hljs-attr">item</span> =&gt; ({
      ...item,              // 解构赋值，保持原对象纯净
      children: list2tree(list, item.id)
    }))<span class="hljs-comment">;</span>
</code></pre>
<p>这一版代码：</p>
<ul>
<li>✅ 箭头函数</li>
<li>✅ <code>filter + map</code> 链式调用</li>
<li>✅ 解构赋值，不污染原数据</li>
<li>✅ 可读性很好，看起来很“ES6”</li>
</ul>
<p>👉 <strong>很多同学到这一步就觉得稳了。</strong></p>
<hr/>
<h3 data-id="heading-6">🤔 面试官的经典追问</h3>
<blockquote>
<p>「这个方案，有什么问题？」</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">🎯 标准回答（一定要说出来）</h3>
<blockquote>
<p>「这个方案的本质是 <strong>嵌套循环</strong>。<br/>
每一层递归，都会遍历一次完整的 <code>list</code>。</p>
<p>👉 时间复杂度是 <strong><code>O(n²)</code></strong><br/>
👉 如果层级过深，还可能导致 <strong>栈溢出（Stack Overflow）</strong> 。」</p>
</blockquote>
<p>📌 <strong>一句话总结</strong>：</p>
<blockquote>
<p>ES6 写法只是“看起来优雅”，<br/>
性能问题不会因为代码好看就自动消失。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、第二重境界：Map 优化（面试及格线）</h2>
<p>既然慢，是因为<strong>反复遍历找父节点</strong>，<br/>
那就用 <strong>Map 建立索引</strong>。</p>
<blockquote>
<p>👉 典型的：<strong>空间换时间</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-9">核心思路</h3>
<ol>
<li>第一遍：把所有节点放进 <code>Map</code></li>
<li>第二遍：通过 <code>parentId</code> 直接挂载</li>
<li>利用 JS <strong>对象引用</strong>，自动同步树结构</li>
</ol>
<hr/>
<h3 data-id="heading-10">代码实现</h3>
<pre><code class="hljs language-ini" lang="ini">function listToTreeWithMap(list) {
  const <span class="hljs-attr">map</span> = new Map()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">tree</span> = []<span class="hljs-comment">;</span>

  // 初始化
  for (const item of list) {
    map.set(item.id, { ...item, children: <span class="hljs-section">[]</span> })<span class="hljs-comment">;</span>
  }

  // 构建树
  for (const item of list) {
    const <span class="hljs-attr">node</span> = map.get(item.id)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">item.parentId</span> === <span class="hljs-number">0</span>) {
      tree.push(node)<span class="hljs-comment">;</span>
    } else {
      const <span class="hljs-attr">parent</span> = map.get(item.parentId)<span class="hljs-comment">;</span>
      parent &amp;&amp; parent.children.push(node)<span class="hljs-comment">;</span>
    }
  }

  return tree<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-11">⏱ 复杂度分析</h3>
<ul>
<li>时间复杂度：<code>O(n)</code></li>
<li>空间复杂度：<code>O(n)</code></li>
</ul>
<p>📌 到这一步，<strong>已经可以应付大多数面试</strong>了。</p>
<hr/>
<h2 data-id="heading-12">五、终极奥义：一次遍历 + 引用魔法（Top Tier）</h2>
<blockquote>
<p>面试官：<br/>
「能不能只遍历一次？」</p>
</blockquote>
<p>答案是：<strong>能，而且这才是天花板解法。</strong></p>
<hr/>
<h3 data-id="heading-13">核心精髓：占位 + 引用同步</h3>
<ul>
<li>子节点可能先于父节点出现</li>
<li>先在 Map 里给父节点 <strong>占位</strong></li>
<li>后续再补全数据</li>
<li>引用地址始终不变，树会“自己长好”</li>
</ul>
<hr/>
<h3 data-id="heading-14">代码实现（一次遍历）</h3>
<pre><code class="hljs language-ini" lang="ini">function listToTreePerfect(list) {
  const <span class="hljs-attr">map</span> = new Map()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">tree</span> = []<span class="hljs-comment">;</span>

  for (const item of list) {
    const { id, parentId } = item<span class="hljs-comment">;</span>

    if (!map.has(id)) {
      map.set(id, { children: <span class="hljs-section">[]</span> })<span class="hljs-comment">;</span>
    }

    const <span class="hljs-attr">node</span> = map.get(id)<span class="hljs-comment">;</span>
    Object.assign(node, item)<span class="hljs-comment">;</span>

    if (<span class="hljs-attr">parentId</span> === <span class="hljs-number">0</span>) {
      tree.push(node)<span class="hljs-comment">;</span>
    } else {
      if (!map.has(parentId)) {
        map.set(parentId, { children: <span class="hljs-section">[]</span> })<span class="hljs-comment">;</span>
      }
      map.get(parentId).children.push(node)<span class="hljs-comment">;</span>
    }
  }

  return tree<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-15">🏆 为什么这是王者解法？</h3>
<ul>
<li>✅ 一次遍历，<code>O(n)</code></li>
<li>✅ 支持乱序数据</li>
<li>✅ 深度理解 JS 引用机制</li>
<li>✅ 面试官一眼就懂你是“真会”</li>
</ul>
<hr/>
<h2 data-id="heading-16">六、真实开发中的应用场景</h2>
<ul>
<li>🔹 权限 / 菜单树（Ant Design / Element）</li>
<li>🔹 省市区 / Cascader</li>
<li>🔹 文件目录结构（云盘、编辑器）</li>
</ul>
<hr/>
<h2 data-id="heading-17">七、面试总结 &amp; 避坑指南</h2>

























<table><thead><tr><th>方案</th><th>时间复杂度</th><th>评价</th></tr></thead><tbody><tr><td>递归</td><td><code>O(n²)</code></td><td>能写，但危险</td></tr><tr><td>Map 两次遍历</td><td><code>O(n)</code></td><td>面试合格</td></tr><tr><td>一次遍历</td><td><code>O(n)</code></td><td>面试加分</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">面试加分表达</h3>
<ul>
<li>主动提 <strong>空间换时间</strong></li>
<li>点出 <strong>JS 对象是引用类型</strong></li>
<li>询问 <code>parentId</code> 是否可能为 <code>null</code></li>
<li>说明是否会修改原数据（必要时深拷贝）</li>
</ul>
<hr/>
<h2 data-id="heading-19">结语</h2>
<blockquote>
<p>算法不是为了为难人，<br/>
而是为了在复杂业务中，<br/>
<strong>选出那条最稳、最优雅的路。</strong></p>
</blockquote>
<p>如果这篇文章对你有帮助👇<br/>
👍 点个赞<br/>
💬 评论区聊聊你在项目里遇到过的奇葩数据结构</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——从技术特性、底层架构到落地逻辑的全维度解析]]></title>    <link>https://juejin.cn/post/7585484081436606515</link>    <guid>https://juejin.cn/post/7585484081436606515</guid>    <pubDate>2025-12-21T02:57:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585484081436606515" data-draft-id="7585463195202502706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——从技术特性、底层架构到落地逻辑的全维度解析"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-21T02:57:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——从技术特性、底层架构到落地逻辑的全维度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:57:17.000Z" title="Sun Dec 21 2025 02:57:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>近年来，大模型以其颠覆性的智能表现席卷技术领域——从精准的代码生成到自然的多轮对话，从跨模态的文生图到复杂的逻辑推理，其背后是一套融合<strong>规模、架构、数据与训练范式</strong>的技术体系。本文将从核心特性、架构基础、行业现状到落地逻辑，深入拆解大模型的底层运行原理。</p>
<h2 data-id="heading-1">一、大模型的核心技术特性：“大”之外的底层逻辑</h2>
<p>大模型的“能力壁垒”并非仅源于“参数多”，而是多维度技术特性的协同作用：</p>
<h3 data-id="heading-2">1. 超大规模参数与自监督预训练：通用规律的“学习底座”</h3>
<ul>
<li><strong>参数规模的技术定义</strong>：大模型的“大”通常指<strong>百亿级以上的可训练参数</strong>（如GPT-3达1750亿参数），对应模型结构中Transformer的“编码器/解码器层数”“注意力头数”“隐藏层维度”等组件的规模扩张（例如GPT-4的Transformer解码器层数超过90层）。</li>
<li><strong>自监督预训练的核心逻辑</strong>：模型通过“无标注数据的自我学习”掌握通用语义，典型任务包括：
<ul>
<li><strong>掩码语言模型（MLM）</strong>：随机遮盖文本中的部分token，让模型预测被遮盖内容（BERT的核心预训练任务）；</li>
<li><strong>下一句预测（NSP）</strong>：让模型判断两个句子是否为连续的上下文；</li>
<li><strong>自回归语言建模</strong>：从左到右逐token预测下一个词（GPT系列的核心任务）。</li>
</ul>
</li>
<li><strong>数据规模的匹配要求</strong>：预训练需投喂<strong>万亿级token的高质量数据</strong>（涵盖文本、图像、音频等），数据的多样性与覆盖度直接决定模型的“通用认知能力”。</li>
</ul>
<h3 data-id="heading-3">2. 涌现能力：规模突破后的“智能跃迁”</h3>
<p>“涌现能力”是大模型最独特的属性——当参数规模、数据量突破某一阈值后，模型会突然具备预训练任务中未明确学习的能力（如思维链推理、上下文学习）。</p>
<ul>
<li><strong>技术本质</strong>：目前学界认为，大参数模型能在高维特征空间中捕捉到数据的“复杂隐式模式”，当规模足够大时，这些模式会形成“泛化能力的叠加”；</li>
<li><strong>典型案例</strong>：思维链（Chain-of-Thought）能力——通过在提示词中加入“分步推理”示例，模型可学会拆解复杂任务（如数学题、逻辑题），其本质是调用了预训练中学习到的“因果推理类特征”。</li>
</ul>
<h3 data-id="heading-4">3. 多模态与通用适配性：向AGI靠近的技术路径</h3>
<p>大模型的“通用性”源于<strong>统一的语义表示框架</strong>：</p>
<ul>
<li><strong>多模态技术基础</strong>：通过“跨模态对齐”将文本、图像、音频等不同类型数据转化为统一的token表示（例如CLIP模型通过“图文对”数据，让文本嵌入与图像嵌入映射到同一语义空间）；</li>
<li><strong>领域适配方式</strong>：无需重新训练模型，仅通过“提示学习”或“轻量微调”即可适配不同场景：
<ul>
<li><strong>少样本提示</strong>：给模型1-5个任务示例，即可让其模仿完成新任务；</li>
<li><strong>指令微调</strong>：用“自然语言指令+任务输出”的数据集微调模型，提升其对人类指令的理解能力；</li>
<li><strong>RAG（检索增强生成）</strong>：结合外部知识库（如行业文档、实时数据），让模型生成更精准的领域内容。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">4. 超长上下文与非实时性限制：能力的“边界”</h3>
<ul>
<li><strong>超长上下文的技术支撑</strong>：基于Transformer的“注意力机制”，通过优化（如滑动窗口注意力、稀疏注意力）实现对长序列的处理（例如GPT-4的上下文窗口达128k token，可容纳约20万字的文本），其核心是让模型能“记住”长文本中的关联信息；</li>
<li><strong>非实时性的根源</strong>：大模型的预训练是基于“静态数据快照”（如GPT-4的训练数据截止到2023年10月），推理阶段无法实时接入新数据——这是其与搜索引擎的核心区别（搜索引擎依赖实时索引，而大模型依赖预训练知识）。</li>
</ul>
<h2 data-id="heading-6">二、大模型的架构基础：Transformer的“统治力”</h2>
<p>当前所有大模型均基于<strong>Transformer架构</strong>（2017年由Google提出），其核心组件决定了模型的“规模扩展性”与“语义捕捉能力”：</p>
<ol>
<li><strong>注意力机制</strong>：通过“缩放点积注意力”计算每个token与其他token的关联权重，让模型在处理文本时“聚焦关键信息”；</li>
<li><strong>Encoder-Decoder结构</strong>：
<ul>
<li><strong>Encoder</strong>：负责将输入文本转化为“语义嵌入”（如BERT仅用Encoder）；</li>
<li><strong>Decoder</strong>：负责基于语义嵌入生成输出文本（如GPT仅用Decoder）；</li>
</ul>
</li>
<li><strong>位置编码</strong>：给token添加位置信息（如正弦余弦编码），解决Transformer“无序列感知”的问题；</li>
<li><strong>残差连接与层归一化</strong>：缓解大模型训练中的“梯度消失”问题，支撑超多层数的模型训练。</li>
</ol>
<h2 data-id="heading-7">三、大模型的行业技术现状：规模与壁垒的博弈</h2>
<h3 data-id="heading-8">1. 模型同质化：Transformer的“技术锁定”</h3>
<p>目前几乎所有大模型均基于Transformer衍生架构（如GPT的Decoder-only、PaLM的Pathways架构），核心原因是：Transformer的“注意力机制+残差连接”是当前唯一能支撑“千亿级参数+万亿级数据”训练的架构，暂无更优替代方案。</p>
<h3 data-id="heading-9">2. 规模效应：“大力出奇迹”的技术依据</h3>
<p>学界研究显示，大模型的性能（如困惑度、任务准确率）与<strong>参数规模、训练数据量</strong>呈“幂律关系”：当参数从10亿提升到1000亿时，性能会出现“阶梯式跃升”（例如GPT-2（15亿参数）与GPT-3（1750亿参数）的能力差距）。</p>
<h3 data-id="heading-10">3. 头部垄断：技术门槛的“马太效应”</h3>
<p>大模型的研发存在极高的“算力+数据+资金”壁垒：</p>
<ul>
<li><strong>算力成本</strong>：训练一次千亿级参数模型需消耗“数万张A100显卡×数月时间”，成本超过千万美元；</li>
<li><strong>数据壁垒</strong>：高质量训练数据（尤其是多模态、多语言数据）被头部企业垄断；</li>
<li><strong>技术闭环</strong>：头部企业通过“模型不开源+API商业化”构建壁垒，中小企业仅能基于API进行二次开发。</li>
</ul>
<h2 data-id="heading-11">四、大模型的落地应用：技术逻辑的场景化实现</h2>
<p>大模型的应用并非“黑箱调用”，而是技术特性与场景需求的精准匹配：</p>
<h3 data-id="heading-12">1. 文本生成：自回归的“内容生产链”</h3>
<ul>
<li><strong>技术逻辑</strong>：基于自回归语言建模，从左到右逐token预测（例如生成代码时，模型会基于前文的语法规则，预测下一个字符/关键字）；</li>
<li><strong>典型场景</strong>：代码生成（GitHub Copilot）、文案撰写、数学解题（通过思维链拆解步骤）。</li>
</ul>
<h3 data-id="heading-13">2. 智能客服：RAG的“知识增强”</h3>
<ul>
<li><strong>技术逻辑</strong>：先通过检索引擎从“行业知识库”（如银行产品手册、医院诊疗指南）中获取相关信息，再将信息传入大模型，生成符合场景的回复；</li>
<li><strong>价值</strong>：解决大模型“知识过时”“幻觉（编造信息）”的问题，提升回复的精准性。</li>
</ul>
<h3 data-id="heading-14">3. 多模态任务：跨模态对齐的“能力延伸”</h3>
<ul>
<li><strong>文生图</strong>：大语言模型将文本描述转化为“语义嵌入”，再输入扩散模型（如Stable Diffusion），生成与语义匹配的图像；</li>
<li><strong>看图说话</strong>：大模型将图像转化为“视觉嵌入”，再映射为自然语言描述（依赖预训练中的图文对齐数据）。</li>
</ul>
<h3 data-id="heading-15">4. 情感分析：语义表示的“细粒度理解”</h3>
<ul>
<li><strong>技术逻辑</strong>：大模型通过预训练中学习的“情感类词汇特征”（如“开心”“失望”），对文本的情感倾向（正面/负面/中性）进行分类，甚至能识别“讽刺”“反话”等复杂情感。</li>
</ul>
<h2 data-id="heading-16">总结</h2>
<p>大模型的本质是“数据与规模驱动的通用语义引擎”，其能力边界仍在扩张，但技术底层的逻辑（Transformer架构、自监督预训练）已相对清晰。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-190 Filebeat→Kafka→Logstash→Elasticsearch 实战]]></title>    <link>https://juejin.cn/post/7585502118459965459</link>    <guid>https://juejin.cn/post/7585502118459965459</guid>    <pubDate>2025-12-21T01:33:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585502118459965459" data-draft-id="7585502118459949075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-190 Filebeat→Kafka→Logstash→Elasticsearch 实战"/> <meta itemprop="keywords" content="后端,大数据,Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-21T01:33:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-190 Filebeat→Kafka→Logstash→Elasticsearch 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T01:33:10.000Z" title="Sun Dec 21 2025 01:33:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：Nginx access.log 采集到 Kafka，经 Logstash 清洗（含 GeoIP）落 ES</li>
<li>结论：Ubuntu 22.04 上 Filebeat 7.3 可能启动失败，升级到 7.17 可直接恢复</li>
<li>产出：可复用的 filebeat.yml + logstash_kafka_es.conf 及常见故障定位/修复表</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a079c04ef87c482a83d324b56e56f9b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=xmJV1l6nxgxbX1NyXNAUzSTM12U%3D" alt="大数据-190 Filebeat→Kafka→Logstash→Elasticsearch 实战" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>















































<table><thead><tr><th>组件</th><th>版本</th><th>环境/系统</th><th>已验证</th><th>说明</th></tr></thead><tbody><tr><td>Filebeat</td><td>7.3.0</td><td>Ubuntu 22.04.3</td><td>否</td><td>文中出现 cgo/pthread 报错，无法启动（同机型/权限场景下）</td></tr><tr><td>Filebeat</td><td>7.17.0</td><td>Ubuntu 22.04.3</td><td>是</td><td>按文中配置可启动并向 Kafka 写入事件，事件 metadata 显示 7.17.0</td></tr><tr><td>Logstash</td><td>7.3.0</td><td>未明确</td><td>部分</td><td>-t 配置测试通过并可启动；系统/JDK 未提供，跨环境结论不外推</td></tr><tr><td>Kafka</td><td>未提供</td><td>未提供</td><td>部分</td><td>仅验证到可被 filebeat 写入、可用 console-consumer 消费（版本/鉴权未描述）</td></tr><tr><td>Elasticsearch</td><td>未提供</td><td>未提供</td><td>否</td><td>仅给出 output 配置与索引命名规则，未提供 ES 版本与落库验证截图/查询</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbfeaa3325e3420fa2f24eb3f02a8085~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=7ijvokJ3tQ%2BK4nCLJ5wEE1Pxi3k%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">Filebeat</h2>
<h3 data-id="heading-3">官方地址</h3>
<p>Filebeat主要为了解决Logstash工具是消耗资源比较严重的问题，因为Logstash是Java语言编写的，需要启动一个虚拟机。官方为了优化这个问题推出了一些轻量级的采集工具，Beats系列，其中比较广泛使用的是Filebeat。</p>
<pre><code class="hljs language-shell" lang="shell">https://www.elastic.co/guide/en/beats/filebeat/7.3/index.html
</code></pre>
<h3 data-id="heading-4">对比区别</h3>
<ul>
<li>Logstash是运行在Java虚拟机上的，启动一个Logstash需要消耗500M的内存（所以启动特别慢），而Filebeat只需要10M左右</li>
<li>常用的ELK日志采集中，大部分的做法就是将所有节点的日志内容通过Filebeat发送到Kafka集群，Logstash消费Kafka，再根据配置文件进行过滤，然后将过滤的文件输出到Elasticsearch中，再到Kibana去展示。</li>
</ul>
<h3 data-id="heading-5">项目安装</h3>
<p>目前我选择在 h121 节点上，你可以按照自己的情况来安装。</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/software
wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-linux-x86_64.tar.gz
</code></pre>
<p>结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcef53d87c9d42559a460f5e876a2aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=XDQ2WPLzMRQDfKS9FXA%2ByQ3QHTc%3D" alt="Logstash filebeat" loading="lazy"/></p>
<h3 data-id="heading-6">解压配置</h3>
<pre><code class="hljs language-shell" lang="shell">tar -zxvf filebeat-7.3.0-linux-x86_64.tar.gz
mv filebeat-7.3.0-linux-x86_64 ../servers
cd ../servers
</code></pre>
<p>对应的内容如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81c0c360a2db41a998ebe8cb7cf527b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=LLRCbuWtU%2BoLUYVawmnRHcl3JWg%3D" alt="FileBeat 配置" loading="lazy"/>
修改配置文件如下：</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/filebeat-7.3.0-linux-x86_64
vim filebeat.yml
</code></pre>
<p>当前文件内容如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a51385114eea45709c4a52ae4e1ce7a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=DXi0w6cPFxLrBF%2ByQLuhS8Fwn%2F8%3D" alt="FileBeat 配置文件" loading="lazy"/></p>
<h4 data-id="heading-7">input部分</h4>
<p>修改为如下的内容 filebeat.inputs 部分的内容：</p>
<pre><code class="hljs language-shell" lang="shell">- type: log
<span class="hljs-meta prompt_">
  # </span><span class="bash">Change to <span class="hljs-literal">true</span> to <span class="hljs-built_in">enable</span> this input configuration.</span>
  enabled: true
<span class="hljs-meta prompt_">
  # </span><span class="bash">Paths that should be crawled and fetched. Glob based paths.</span>
  paths:
    - /opt/wzk/logs/access.log
    #- c:\programdata\elasticsearch\logs\*
<span class="hljs-meta prompt_">
  # </span><span class="bash">Exclude lines. A list of regular expressions to match. It drops the lines that are</span>
<span class="hljs-meta prompt_">  # </span><span class="bash">matching any regular expression from the list.</span>
<span class="hljs-meta prompt_">  #</span><span class="bash">exclude_lines: [<span class="hljs-string">'^DBG'</span>]</span>
<span class="hljs-meta prompt_">
  # </span><span class="bash">Include lines. A list of regular expressions to match. It exports the lines that are</span>
<span class="hljs-meta prompt_">  # </span><span class="bash">matching any regular expression from the list.</span>
<span class="hljs-meta prompt_">  #</span><span class="bash">include_lines: [<span class="hljs-string">'^ERR'</span>, <span class="hljs-string">'^WARN'</span>]</span>
<span class="hljs-meta prompt_">
  # </span><span class="bash">Exclude files. A list of regular expressions to match. Filebeat drops the files that</span>
<span class="hljs-meta prompt_">  # </span><span class="bash">are matching any regular expression from the list. By default, no files are dropped.</span>
<span class="hljs-meta prompt_">  #</span><span class="bash">exclude_files: [<span class="hljs-string">'.gz$'</span>]</span>
<span class="hljs-meta prompt_">
  # </span><span class="bash">Optional additional fields. These fields can be freely picked</span>
<span class="hljs-meta prompt_">  # </span><span class="bash">to add additional information to the crawled <span class="hljs-built_in">log</span> files <span class="hljs-keyword">for</span> filtering</span>
  fields:
    app: www
    type: nginx-access
  fields_under_root: true
<span class="hljs-meta prompt_">  #</span><span class="bash"><span class="hljs-comment">## Multiline options</span></span>
</code></pre>
<p>修改的截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a6b970dd544721b64c02ea4c8eb880~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=1qOOWumgLOO3oVvCqbv6puJWSN4%3D" alt="FileBeat input配置" loading="lazy"/></p>
<h4 data-id="heading-8">output部分</h4>
<pre><code class="hljs language-shell" lang="shell">output.kafka:
  hosts: ["h121.wzk.icu:9092"]
  topic: "nginx_access_log"
</code></pre>
<p>对应的截图如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b699aec78cfc4b789578f18e2fa48755~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=C7XSkGjA68v4DN77p3diP0EOnn4%3D" alt="FileBeat output 配置" loading="lazy"/></p>
<h3 data-id="heading-9">启动服务</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/filebeat-7.3.0-linux-x86_64
./filebeat -e -c filebeat.yml
</code></pre>
<p>如果你在这里遇到了 runtime-cgo-pthread-create-failed-operation-not-permitted 的错误，那你可以尝试将 FileBeat 的版本进行提升，我这里就遇到了，所以后续进行版本提升</p>
<h3 data-id="heading-10">遇到错误 runtime-cgo-pthread-create-failed-operation-not-permitted</h3>
<p>如果你没有遇到，直接跳过！
我这里版本一点点的往上尝试，大致猜测是操作系统的版本可能新一些，所以原来的Go的库无法支持新的操作系统了（猜测的）。
这里我测试到 7.17 的版本就好了：</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/software
wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.0-linux-x86_64.tar.gz
</code></pre>
<p>根据刚才的操作，我已经配置好了路劲等内容，且修改了 filebeat.yml 的配置文件内容
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/098bb25df873458b9e8ad8e234811a6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=V8rd3HwZ22piN9xmglC15X%2FqR%2Bs%3D" alt="FileBeat 配置文件" loading="lazy"/>
进行启动测试：</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/filebeat-7.17.0-linux-x86_64
./filebeat -e -c filebeat.yml
</code></pre>
<p>顺利启动，启动结果如下图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cffe5bda76fe4ca8af40e2ba94c0a735~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=kKlbCMO15EPTlb1eT1RRZKdLaCc%3D" alt="FileBeat 日志文件" loading="lazy"/></p>
<h3 data-id="heading-11">测试数据</h3>
<p>启动一切正常之后，我们在Nginx刷新几次，来生成一些数据出来。</p>
<h3 data-id="heading-12">查看消费</h3>
<pre><code class="hljs language-shell" lang="shell">kafka-console-consumer.sh --bootstrap-server h121.wzk.icu:9092 --topic nginx_access_log --
from-beginning
</code></pre>
<p>可以看到数据已经来了：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e59e867337ad4ca491316ca4b572cb8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=1Qd59gRGaPJNpfYbWklZcjPmkbo%3D" alt="FileBeat Kafka消费者启动" loading="lazy"/>
我们进行一下JSON的格式化操作：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
	<span class="hljs-attr">"@timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-08-19T08:14:52.073Z"</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"@metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"beat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"filebeat"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"_doc"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"7.17.0"</span>
	<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"cloud"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"availability_zone"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cn-north-1b"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
			<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ECS"</span>
		<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"huawei"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"instance"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
			<span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ccf8173b-3e47-468e-be8a-5ea3a03c76e0"</span>
		<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"region"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cn-north-1"</span>
	<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"log"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"offset"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2034</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
			<span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/opt/wzk/logs/access.log"</span>
		<span class="hljs-punctuation">}</span>
	<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{ \"@timestamp\": \"2024-08-19T16:14:46+08:00\", \"remote_addr\": \"223.80.101.21\", \"remote_user\": \"-\", \"body_bytes_sent\": \"0\", \"request_time\": \"0.000\", \"status\": \"304\", \"request_uri\": \"/\", \"request_method\": \"GET\", \"http_referrer\": \"-\", \"http_x_forwarded_for\": \"-\", \"http_user_agent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36\"}"</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"app"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"www"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nginx-access"</span>
	<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"log"</span>
	<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"agent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"hostname"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"h121.wzk.icu"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"ephemeral_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ebc9ac86-db92-4bb1-a631-e6a868393270"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"da3cc603-7d17-4b4a-ac3b-6b557805a2e2"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"h121.wzk.icu"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"filebeat"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"7.17.0"</span>
	<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"ecs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.12.0"</span>
	<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
	<span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
		<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"h121.wzk.icu"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"mac"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"fa:16:3e:6b:c3:30"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"hostname"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"h121.wzk.icu"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"architecture"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"x86_64"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"os"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
			<span class="hljs-attr">"codename"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"jammy"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"linux"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"platform"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ubuntu"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"22.04.3 LTS (Jammy Jellyfish)"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"family"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"debian"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Ubuntu"</span><span class="hljs-punctuation">,</span>
			<span class="hljs-attr">"kernel"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.15.0-92-generic"</span>
		<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"42ed7c7740bf4c19a180c6b736d11bbf"</span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"containerized"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
		<span class="hljs-attr">"ip"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"192.168.0.109"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"fe80::f816:3eff:fe6b:c330"</span><span class="hljs-punctuation">]</span>
	<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-13">Logstash</h2>
<h3 data-id="heading-14">官方文档</h3>
<p>Logstash用来读取Kafka中的数据</p>
<pre><code class="hljs language-shell" lang="shell">https://www.elastic.co/guide/en/logstash/7.3/plugins-inputs-kafka.html
</code></pre>
<h3 data-id="heading-15">编写配置</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0/config
vim logstash_kafka_es.conf
</code></pre>
<p>修改如下的配置如何：</p>
<pre><code class="hljs language-shell" lang="shell">input {
    kafka {
        bootstrap_servers =&gt; "h121.wzk.icu:9092"
        topics =&gt; ["nginx_access_log"]
        codec =&gt; "json"
    }
}

filter {
    if [app] == "www" {
        if [type] == "nginx-access" {
            json {
                source =&gt; "message"
                remove_field =&gt; ["message"]
            }
            geoip {
                source =&gt; "remote_addr"
                target =&gt; "geoip"
                database =&gt; "/opt/wzk/GeoLite2-City.mmdb"
                add_field =&gt; ["[geoip][coordinates]", "%{[geoip][longitude]}"]
                add_field =&gt; ["[geoip][coordinates]", "%{[geoip][latitude]}"]
            }
            mutate {
                convert =&gt; ["[geoip][coordinates]", "float"]
            }
        }
    }
}

output {
    elasticsearch {
        hosts =&gt; ["http://h121.wzk.icu:9200"]
        index =&gt; "logstash-%{type}-%{+YYYY.MM.dd}"
    }
    stdout {
        codec =&gt; rubydebug
    }
}

</code></pre>
<h3 data-id="heading-16">下载依赖</h3>
<p>我们看到这里用了一个 GeoLite2-City.mmdb，我们需要下载GeoLite2-City.mmdb：</p>
<pre><code class="hljs language-shell" lang="shell">https://github.com/P3TERX/GeoLite.mmdb?tab=readme-ov-file
</code></pre>
<p>这里我直接下载：</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/wzk/
wget https://git.io/GeoLite2-City.mmdb
</code></pre>
<p>下载过程如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9663451f16234837a932d68a4b97846b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=KngFemdDrbsmdqqGV0noVQdReNo%3D" alt="FileBeat Logstash" loading="lazy"/></p>
<h3 data-id="heading-17">测试服务</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/logstash_kafka_es.conf -t
</code></pre>
<p>运行的结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e21f4bb28264e0a909e3a96949273f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=jEGfip6EHFR%2FkSVU1S6iYswj%2Fyg%3D" alt="FileBeat Logstash 测试服务" loading="lazy"/></p>
<h3 data-id="heading-18">启动服务</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/logstash_kafka_es.conf
</code></pre>
<p>启动之后结果如下图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b0169c31630494fbcf0b2d42ec20850~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=3hNVl%2FSPmLLkvM7JMwNBQPiTkh0%3D" alt="FileBeat Logstash 启动测试" loading="lazy"/>
Kafa对应的日志部分：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc1b7a4814c49d1a2832ce7b081ba22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=Te2BkM28JiD4hf8IhfTT6RYjKT4%3D" alt="FileBeat Kafka日志" loading="lazy"/></p>
<h3 data-id="heading-19">测试数据</h3>
<p>我们刷新Nginx的页面，提供一些数据出来。
我们可以看到 Logstash 的控制台输出了对应的内容：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd194aeb840d47249402cb5a90f06a3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766885590&amp;x-signature=KJQFsQwCRJGDBq6zWQb13vy2sBQ%3D" alt="FileBeat 测试数据" loading="lazy"/></p>
<h2 data-id="heading-20">错误速查</h2>















































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>Filebeat 启动报 runtime-cgo-pthread-create-failed-operation-not-permitted</td><td>二进制/Go 运行时与系统/权限/线程限制不兼容（在新系统更常见）</td><td>直接在 ./filebeat -e -c filebeat.yml 控制台复现</td><td>升级 Filebeat 到 7.17.0（文中验证可用），保持原配置迁移</td></tr><tr><td>Kafka 端消费不到数据</td><td>input 路径无新日志、enabled 未开、topic/hosts 配错</td><td>Filebeat 控制台看 harvest/publish；Kafka 用 console-consumer 验证</td><td>确认 filebeat.inputs.enabled: true、paths 指向真实文件、output.kafka.hosts/topic 正确；刷新 Nginx 产生新行</td></tr><tr><td>Kafka console-consumer 命令报错或不输出</td><td>命令参数被换行/截断（--from-beginning 写成 --\nfrom-beginning）</td><td>直接看命令行回显</td><td>使用完整一行命令：kafka-console-consumer.sh --bootstrap-server ... --topic ... --from-beginning</td></tr><tr><td>Logstash 解析后字段缺失/仍是原 message 字符串</td><td>codec =&gt; json 只解析 Kafka 外层事件；真正业务 JSON 在 message 字段内，需要二次 json filter</td><td>stdout(rubydebug) 观察事件结构：外层字段 vs message 字符串</td><td>保持 codec =&gt; json，再用 json { source =&gt; "message" remove_field =&gt; ["message"] } 二次解析（文中已配置）</td></tr><tr><td>GeoIP 不生效或启动报数据库路径错误</td><td>mmdb 文件不存在/路径不对/权限不足</td><td>Logstash 日志搜 GeoIP/mmdb；检查 /opt/wzk/GeoLite2-City.mmdb</td><td>确保 mmdb 存在且可读；路径与配置一致；必要时调整文件权限/属主</td></tr><tr><td>ES 无索引或写入失败</td><td>ES 地址不可达、索引权限/模板问题、网络/认证未配置</td><td>Logstash 输出中看 elasticsearch output 的错误堆栈</td><td>先用 curl 测 ES 连通；确认 hosts =&gt; ["<a href="https://link.juejin.cn?target=http%3A%2F%2F...%3A9200" target="_blank" title="http://...:9200" ref="nofollow noopener noreferrer">http://...:9200</a>"] 可访问；如启用安全认证需补充用户名密码/SSL 配置</td></tr></tbody></table>
<h2 data-id="heading-21">其他系列</h2>
<h3 data-id="heading-22">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-23">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-196 消息队列选型：RabbitMQ vs RocketMQ vs Kafka</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-24">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当遇见 CatchAdmin V5-模块化设计重新定义 Laravel 后台开发]]></title>    <link>https://juejin.cn/post/7585474459777187876</link>    <guid>https://juejin.cn/post/7585474459777187876</guid>    <pubDate>2025-12-21T00:07:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459777187876" data-draft-id="7585502118459899923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当遇见 CatchAdmin V5-模块化设计重新定义 Laravel 后台开发"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-21T00:07:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当遇见 CatchAdmin V5-模块化设计重新定义 Laravel 后台开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T00:07:38.000Z" title="Sun Dec 21 2025 00:07:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当遇见 CatchAdmin V5-模块化设计重新定义 Laravel 后台开发</h2>
<h3 data-id="heading-1">选型困境中的一次偶然</h3>
<p>做 Laravel 开发这些年,每次启动新项目时总会面临同一个问题:后台管理系统该怎么搭?自己从零写一套权限、菜单、用户管理?太耗时。用现成的方案?市面上的选择不少,但总有些地方不够顺手。有些过于臃肿,集成了一堆用不上的功能;有些又过于简陋,稍微复杂点的需求就得大改。</p>
<p>直到某天在 GitHub 上闲逛时,偶然看到了 CatchAdmin V5 的介绍。"基于 Laravel 12 和 Vue3 的模块化后台管理系统"——这个标签立刻吸引了我。Laravel 12 是最新版本,Vue3 + Element Plus 的前端组合也很现代,但真正让我点进去的,是"模块化"这三个字。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fcatchadmin-v5-modular-laravel-admin" target="_blank" title="https://catchadmin.com/post/2025-12/catchadmin-v5-modular-laravel-admin" ref="nofollow noopener noreferrer">原文链接 当遇见 CatchAdmin V5-模块化设计重新定义 Laravel 后台开发</a></p>
<h3 data-id="heading-2">第一印象:安装体验出乎意料</h3>
<p>抱着试试看的心态,我决定在本地跑一下。整个安装过程简单得让人意外:</p>
<pre><code class="hljs language-bash" lang="bash">composer global -W require catchadmin/installer

<span class="hljs-comment"># 新建项目</span>
catch new my-admin

<span class="hljs-comment"># 安装项目</span>
<span class="hljs-built_in">cd</span> my-admin &amp;&amp; php artisan catch:install

<span class="hljs-comment"># 启动项目</span>
composer run dev
</code></pre>
<p>四行命令,一个完整的后台管理系统就立在了眼前。没有复杂的配置文件要填,没有繁琐的依赖要装,甚至连数据库迁移都是自动完成的。这种"开箱即用"的体验,让我想起了第一次用 Laravel 时的那种惊喜——一切都被安排得恰到好处。</p>
<p>打开浏览器访问后台,界面干净利落。Element Plus 的组件风格很舒服,没有那种"后台系统特有的老气感"。侧边栏、表格、表单,每个交互都很流畅。但这些都还只是表面,真正让我眼前一亮的,是它的架构设计。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea9af422a95f4b85bf7ab74fbbd6c936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmluZ29Hbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766880458&amp;x-signature=RcMjtH%2FufLJEVAQpJGkaEJxrNJY%3D" alt="CatchAdmin v5 欢迎回来" loading="lazy"/></p>
<h3 data-id="heading-3">模块化设计:不只是说说而已</h3>
<p>很多框架都声称自己"模块化",但实际用起来,模块之间往往还是藕断丝连。CatchAdmin 在这方面做得很彻底:每个模块都有独立的控制器、路由、模型、数据表,甚至配置文件都是隔离的。</p>
<p>举个具体例子。我想给系统加一个"文章管理"模块。传统做法是在现有代码里东加一点、西改一点,最后整个项目变成一团意大利面。但在 CatchAdmin 里,我可以这样做:</p>
<pre><code class="hljs language-bash" lang="bash">php artisan catch:module:install
</code></pre>
<p>系统会列出所有可用的模块,我选择安装 <code>permissions</code>(权限管理)模块。安装完成后,刷新页面,左侧菜单栏自动出现了对应的菜单项,数据表也自动创建好了。整个过程完全不需要手动修改任何代码。</p>
<p>更妙的是,模块的配置也是独立的。不像传统 Laravel 项目里所有配置都堆在 <code>config/</code> 目录下,CatchAdmin 的模块配置是这样访问的:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 访问 permissions 模块的配置</span>
<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'permissions.one.some_key'</span>)
</code></pre>
<p>这种设计让模块之间的边界非常清晰。我可以放心地开发自己的业务模块,不用担心会影响到其他功能。如果某天不需要某个模块了,直接卸载即可,不会留下任何"遗迹"。</p>
<h3 data-id="heading-4">代码生成器:从重复劳动中解放</h3>
<p>如果说模块化设计是 CatchAdmin 的骨架,那代码生成器就是它的灵魂。</p>
<p>做后台开发,最烦的就是写 CRUD。用户表要 CRUD,文章表要 CRUD,订单表也要 CRUD……每次都是复制粘贴改字段名,枯燥又容易出错。CatchAdmin 的代码生成器彻底解决了这个问题。</p>
<p>在后台的"代码生成"模块里,我只需要:</p>
<ol>
<li>选择一张数据表(比如 <code>articles</code>)</li>
<li>在可视化界面上配置字段信息:哪些字段要在列表页显示,哪些要在表单里编辑,用什么组件(输入框、下拉框、富文本编辑器等)</li>
<li>点击"一键生成"</li>
</ol>
<p>然后,魔法发生了。后端的 Controller、Model、Request 验证类,前端的列表页、新增页、编辑页,全部自动生成并注册到系统中。刷新页面,左侧菜单栏已经出现了"文章管理"项,完整的增删改查、搜索、导出功能全都就绪。</p>
<p>我几乎没有手写一行业务代码,就完成了一个完整的功能模块。这种效率提升,是质的飞跃。</p>
<h3 data-id="heading-5">权限体系:细致到让人安心</h3>
<p>后台管理系统的核心是权限控制。CatchAdmin 在这方面做得很扎实。</p>
<p>它采用的是标准的 RBAC(基于角色的访问控制)模型,但做了很多细节优化:</p>
<p><strong>三级权限管控</strong>:菜单权限、按钮权限、数据权限。不仅可以控制用户能看到哪些菜单,还能控制能点击哪些按钮(比如"删除"按钮),甚至能控制能看到哪些数据(比如"华南区经理只能看华南区的订单")。</p>
<p><strong>部门与岗位</strong>:支持树形的部门结构,可以给用户分配岗位。这让权限管理更贴近实际业务场景。</p>
<p><strong>动态菜单</strong>:菜单是根据用户权限动态生成的。不同角色登录后台,看到的菜单完全不同。这在多租户或多角色的系统中特别有用。</p>
<p>在后台的"角色管理"页面,我可以用树形选择器勾选权限,非常直观。配置好之后,整个权限体系就自动生效了,不需要在代码里写一堆 <code>if</code> 判断。</p>
<h3 data-id="heading-6">插件生态:拥抱 Composer</h3>
<p>CatchAdmin V5 的另一个亮点是插件系统。它没有自己发明一套插件机制,而是直接绑定 Composer 生态。</p>
<p>这意味着什么?任何一个 Composer 包都可以成为 CatchAdmin 的插件。我不需要学习新的插件开发规范,只需要按照 Laravel Package 的标准写代码,然后通过 Composer 安装即可。</p>
<p>这种设计非常聪明。它没有把自己封闭起来,而是拥抱了整个 PHP 生态。我可以轻松地集成第三方服务(支付、短信、OSS 等),也可以把自己的业务逻辑封装成插件,在不同项目间复用。</p>
<h3 data-id="heading-7">开发体验:细节里的贴心</h3>
<p>用了一段时间后,我发现 CatchAdmin 在很多细节上都很贴心:</p>
<p><strong>操作日志</strong>:系统自动记录用户的所有操作,包括访问了哪个页面、修改了哪条数据。这在排查问题或审计时非常有用。</p>
<p><strong>登录日志</strong>:记录每次登录的时间、IP、设备信息。可以快速发现异常登录。</p>
<p><strong>数据表维护</strong>:可以在后台直接查看数据表结构,清理碎片,优化表。不需要打开 phpMyAdmin 或 Navicat。</p>
<p><strong>字典管理</strong>:对于一些固定的枚举值(比如"订单状态:待支付、已支付、已取消"),可以在字典里统一管理,然后在代码里引用。甚至可以一键导出成 PHP 枚举类。</p>
<p>这些功能看起来不起眼,但在实际开发中能省下不少时间。</p>
<h3 data-id="heading-8">前端体验:Vue3 + Element Plus 的现代感</h3>
<p>前端是基于 Vue3 和 Element Plus 构建的,代码组织得很清晰。CatchAdmin 封装了一套 Composition API 的 Hooks,用起来非常顺手:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 列表页</span>
<span class="hljs-keyword">const</span> { data, query, search, reset, loading } = <span class="hljs-title function_">useGetList</span>(api)
<span class="hljs-keyword">const</span> tableData = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> data.<span class="hljs-property">value</span>?.<span class="hljs-property">data</span>)

<span class="hljs-comment">// 新增/编辑</span>
<span class="hljs-keyword">const</span> { formData, form, loading, submitForm, close } = <span class="hljs-title function_">useCreate</span>(props.<span class="hljs-property">api</span>, props.<span class="hljs-property">primary</span>)

<span class="hljs-comment">// 删除</span>
<span class="hljs-keyword">const</span> { destroy, deleted } = <span class="hljs-title function_">useDestroy</span>()
</code></pre>
<p>这些 Hooks 把常见的 CRUD 操作都封装好了,我只需要传入 API 地址,就能快速搭建出一个功能完整的页面。</p>
<p>前端支持"即时渲染",也就是说我可以在不编译的情况下直接修改 Vue 文件,刷新浏览器就能看到效果。这在开发阶段非常方便。</p>
<h3 data-id="heading-9">一个具体的场景:快速搭建 CMS</h3>
<p>假设我要用 CatchAdmin 搭建一个简单的内容管理系统(CMS)。需要管理文章、分类、标签。</p>
<p><strong>第一步</strong>:创建数据表。我可以用 Laravel 的 Migration,也可以直接在 CatchAdmin 的"Schema 管理"里可视化创建。</p>
<p><strong>第二步</strong>:用代码生成器生成 CRUD 代码。选择 <code>articles</code> 表,配置字段(标题用输入框,内容用富文本编辑器,分类用下拉框),一键生成。</p>
<p><strong>第三步</strong>:配置权限。在"角色管理"里给"编辑"角色分配"文章管理"权限。</p>
<p><strong>第四步</strong>:如果需要自定义逻辑(比如文章发布时自动推送通知),在生成的 Controller 里加几行代码即可。</p>
<p>整个过程,核心业务逻辑之外的代码,我几乎一行都没写。这就是 CatchAdmin 带来的效率提升。</p>
<h3 data-id="heading-10">性能与稳定性</h3>
<p>CatchAdmin 基于 Laravel 12,充分利用了 PHP 8+ 的特性。在我的测试环境里(本地 XAMPP,没做任何优化),响应速度很快,列表页加载基本在 100ms 以内。</p>
<p>当然,它毕竟是传统的 PHP-FPM 模式,不像 Swoole 或 Webman 那样常驻内存。如果对性能有极致要求,可以考虑官方提供的 Webman 版本。但对于大多数中小型项目来说,Laravel 版本的性能已经完全够用。</p>
<h3 data-id="heading-11">适用场景</h3>
<p>用了一段时间后,我觉得 CatchAdmin 特别适合这些场景:</p>
<p><strong>企业内部管理系统</strong>:OA、CRM、进销存等。模块化设计让你可以按需组合功能,不会有太多冗余。</p>
<p><strong>SaaS 平台的管理后台</strong>:多租户、多角色的权限管理是刚需,CatchAdmin 的 RBAC 体系能很好地满足。</p>
<p><strong>内容管理系统</strong>:CMS、博客、新闻站等。代码生成器能快速搭建出内容管理的基础框架。</p>
<p><strong>快速原型开发</strong>:如果你需要在短时间内做出一个可演示的后台系统,CatchAdmin 是个很好的选择。</p>
<h3 data-id="heading-12">一些思考</h3>
<p>体验 CatchAdmin V5 的过程,让我对"框架"这个概念有了新的理解。</p>
<p>好的框架不应该是一个"黑盒",而应该是一个"脚手架"。它提供了坚实的基础和便捷的工具,但不会限制你的发挥空间。CatchAdmin 在这方面做得很好:模块化设计让你可以自由组合功能,代码生成器帮你处理重复劳动,插件系统让你可以无缝集成第三方能力。</p>
<p>它没有试图成为"大而全"的解决方案,而是专注于做好"后台管理系统"这一件事。这种克制,反而让它更加实用。</p>
<h3 data-id="heading-13">写在最后</h3>
<p>如果你正在寻找一个现代化的 Laravel 后台管理系统框架,或者对现有方案的开发效率感到不满,我建议你花半个小时试试 CatchAdmin V5。</p>
<p>它不会让你失望。模块化的架构、强大的代码生成器、完善的权限体系,以及对 Laravel 生态的深度整合,都让它成为一个值得信赖的选择。</p>
<p>好的工具自己会说话。当你第一次用代码生成器一键生成出一个完整的 CRUD 模块时,你就会明白我在说什么。</p>
<p>Laravel 生态依然充满活力,而 CatchAdmin 正是这种活力的证明。它告诉我们,PHP 后台开发可以更高效、更优雅、更现代。</p>
<h3 data-id="heading-14">项目地址</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJaguarJack%2Fcatch-admin" target="_blank" title="https://github.com/JaguarJack/catch-admin" ref="nofollow noopener noreferrer">GitHub 地址</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fcatchadmin%2FcatchAdmin" target="_blank" title="https://gitee.com/catchadmin/catchAdmin" ref="nofollow noopener noreferrer">Gitee 地址</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript性能优化：7个V8引擎内部原理帮你减少90%内存泄漏的实战技巧]]></title>    <link>https://juejin.cn/post/7585458459167195170</link>    <guid>https://juejin.cn/post/7585458459167195170</guid>    <pubDate>2025-12-21T00:17:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585458459167195170" data-draft-id="7585476892977152034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript性能优化：7个V8引擎内部原理帮你减少90%内存泄漏的实战技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-21T00:17:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript性能优化：7个V8引擎内部原理帮你减少90%内存泄漏的实战技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T00:17:03.000Z" title="Sun Dec 21 2025 00:17:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript性能优化：7个V8引擎内部原理帮你减少90%内存泄漏的实战技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代Web开发中，JavaScript的性能优化是一个永恒的话题。随着应用复杂度的提升，内存泄漏、GC（垃圾回收）停顿和低效的代码执行成为开发者面临的常见问题。V8引擎作为Chrome和Node.js的核心，其内部机制对JavaScript的执行效率有着决定性影响。本文将深入剖析V8引擎的7个关键原理，并结合实战技巧，帮助你将内存泄漏减少90%，同时提升代码运行效率。</p>
<h2 data-id="heading-2">1. 理解V8的内存模型</h2>
<h3 data-id="heading-3">堆内存的分代管理</h3>
<p>V8将堆内存分为<strong>新生代（Young Generation）<strong>和</strong>老生代（Old Generation）</strong>：</p>
<ul>
<li><strong>新生代</strong>：存放存活时间短的对象，通过Scavenge算法快速回收。</li>
<li><strong>老生代</strong>：存放长期存活的对象，采用标记-清除（Mark-Sweep）和标记-整理（Mark-Compact）算法。</li>
</ul>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>避免频繁创建大对象，直接分配到老生代会增加GC压力。</li>
<li>使用<code>Object.assign</code>或展开运算符替代深拷贝，减少临时对象生成。</li>
</ul>
<h2 data-id="heading-4">2. 隐藏类与内联缓存（Inline Cache）</h2>
<h3 data-id="heading-5">隐藏类（Hidden Class）</h3>
<p>V8通过隐藏类优化属性访问速度。当对象结构变化时（如动态添加属性），隐藏类会失效，导致性能下降。</p>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>在构造函数中一次性初始化所有属性。</li>
<li>避免使用<code>delete</code>删除对象属性，这会破坏隐藏类。</li>
</ul>
<h3 data-id="heading-6">内联缓存</h3>
<p>V8通过内联缓存缓存方法调用路径，加速重复操作。</p>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>保持函数参数类型稳定，避免多态调用（如同一函数处理多种类型参数）。</li>
</ul>
<h2 data-id="heading-7">3. 逃逸分析与栈分配</h2>
<h3 data-id="heading-8">逃逸分析（Escape Analysis）</h3>
<p>V8会分析对象的生命周期。如果对象未逃逸出函数作用域，可能被分配到栈上而非堆中，从而减少GC压力。</p>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>尽量限制对象的可见范围（如使用闭包时谨慎暴露对象）。</li>
</ul>
<h2 data-id="heading-9">4. GC触发机制与优化策略</h2>
<h3 data-id="heading-10">Major GC与Minor GC</h3>
<ul>
<li><strong>Minor GC</strong>：频繁清理新生代，速度快但可能引发短暂停顿。</li>
<li><strong>Major GC</strong>：清理老生代，耗时长且阻塞主线程。</li>
</ul>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>使用<code>weakMap</code>或<code>weakSet</code>存储临时引用，避免干扰GC。</li>
<li>Node.js中可通过<code>--max-old-space-size</code>调整老生代大小。</li>
</ul>
<h2 data-id="heading-11">5. TurboFan编译器与热点代码优化</h2>
<h3 data-id="heading-12">JIT编译流程</h3>
<p>V8通过Ignition解释器生成字节码，TurboFan将热点代码编译为高效机器码。</p>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>避免在热点代码中使用<code>eval</code>或<code>with</code>，它们会阻止TurboFan优化。</li>
<li>使用类型明确的变量（如<code>let sum = 0</code>而非<code>let sum = ''</code>）。</li>
</ul>
<h2 data-id="heading-13">6. 内存泄漏的常见模式与排查</h2>
<h3 data-id="heading-14">典型泄漏场景</h3>
<ol>
<li><strong>全局变量污染</strong>：意外定义的全局变量无法被回收。</li>
<li><strong>闭包引用</strong>：未释放的外部变量导致闭包持有内存。</li>
<li><strong>定时器/事件监听未清除</strong>：如未清理的<code>setInterval</code>或DOM事件绑定。</li>
</ol>
<p><strong>排查工具</strong>：</p>
<ul>
<li>Chrome DevTools的Memory面板（Heap Snapshots对比）。</li>
<li>Node.js的<code>heapdump</code>模块生成堆快照分析。</li>
</ul>
<h2 data-id="heading-15">7. ArrayBuffer与SharedArrayBuffer的高效使用</h2>
<h3 data-id="heading-16">TypedArray与内存共享</h3>
<p>直接操作二进制数据可减少中间转换开销，但需注意内存安全。</p>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>优先使用TypedArray而非普通数组处理大数据集。</li>
<li>SharedArrayBuffer需配合Atomics避免竞态条件（仅在安全上下文可用）。</li>
</ul>
<h2 data-id="heading-17">总结</h2>
<p>理解V8的内部工作原理是性能优化的关键。通过合理利用隐藏类、控制GC行为、避免内存泄漏模式以及善用编译器优化特性，开发者可以显著提升JavaScript应用的效率并减少资源消耗。建议结合Chrome DevTools和Node.js的分析工具持续监控性能表现，将理论转化为实践中的高性能代码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[INFINI Labs 产品更新 - Coco AI v0.10 × Easysearch v2.0 联袂上线：UI 全面重构，体验焕然一新]]></title>    <link>https://juejin.cn/post/7585474459777040420</link>    <guid>https://juejin.cn/post/7585474459777040420</guid>    <pubDate>2025-12-20T16:01:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459777040420" data-draft-id="7585485074038226950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="INFINI Labs 产品更新 - Coco AI v0.10 × Easysearch v2.0 联袂上线：UI 全面重构，体验焕然一新"/> <meta itemprop="keywords" content="人工智能,数据库,产品"/> <meta itemprop="datePublished" content="2025-12-20T16:01:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极限实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1258294223312599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            INFINI Labs 产品更新 - Coco AI v0.10 × Easysearch v2.0 联袂上线：UI 全面重构，体验焕然一新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1258294223312599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极限实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T16:01:14.000Z" title="Sat Dec 20 2025 16:01:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87b3cf45ea364c72b6de8313cd849c09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=oZ4jGSnf%2FriNljOwhOrN5VLvAAc%3D" alt="release" loading="lazy"/></p>
<p>此次更新主要包括 Coco AI v0.10.0 更换全新的 UI 组件，服务端新增 milvus 和 dropbox 连接器；Easysearch v2.0.2 正式发布， 新增嵌入文档语义搜索，优化内置 UI 响应速度，无需依赖 Kibana，实现集群“开箱即管”；INFINI Console、Gateway、Agent、Loadgen v1.30.1.1 统一基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fframework%2Fv1.4.0" target="_blank" title="https://docs.infinilabs.com/framework/v1.4.0" ref="nofollow noopener noreferrer">Framework v1.4.0</a> 升级，优化本地磁盘队列数据消费。详情见 Release Notes。</p>
<h2 data-id="heading-0">Coco AI 0.10</h2>
<p>Coco AI 是一款完全开源、跨平台的企业级智能搜索与助手系统，专为现代企业打造。它通过统一搜索入口，连接企业内外部的异构数据源，融合大模型能力，帮助团队高效访问知识，智能决策协作。</p>
<p>Coco AI 本次详细更新记录如下：</p>
<h3 data-id="heading-1">Coco AI 客户端 0.10</h3>
<h3 data-id="heading-2">🚀 功能特性 (Features)</h3>
<ul>
<li>扩展程序 UI 支持可调整窗口大小
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cfcf0f5ec5344df971c8f8c25a2248e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=3LfmwUilwxIzsCn8vyvdXrCTdA0%3D" alt="" loading="lazy"/></li>
<li>添加打开按钮以启动已安装的扩展程序
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d1cda9fedda4197af56eb70064d658c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=ISfKKivS0PHL8zO%2F9NSioqUGW04%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-3">✈️ 改进优化 (Improvements)</h3>
<ul>
<li>将应用程序和文件搜索视为普通扩展</li>
<li>通过深度链接安装扩展失败时，显示错误消息（而非错误代码）</li>
<li>用 shadcn/ui 组件替换旧组件
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9905d490877f422cbe393caa6a46fe3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=HbdZKDHyWZ2tcZlqU7%2BHCHvSeHc%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f918d306c56435e92a6c28f477c2b4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=O7NQ5NE2Xpyc%2BMUnSgj3MCbH50c%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-4">🐛 问题修复(Bug Fixes)</h3>
<ul>
<li>修复输入框高度异常问题</li>
<li>为 Extension.minimum_coco_version 实现自定义序列化</li>
</ul>
<h3 data-id="heading-5">Coco AI 服务端 0.10</h3>
<h3 data-id="heading-6">🚀 功能特性 (Features)</h3>
<ul>
<li>新增 milvus 连接器
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aa68d6552f84388955e7ac844d83011~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=cYEfJ%2FLrQuWbhOPJfZU7srw3Rcs%3D" alt="" loading="lazy"/></li>
<li>新增 dropbox 连接器
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/150a330ec4814e3ca1653ba8be66bbeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=bDnQGicjduBQaEJa8EqbtG%2Bs64E%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-7">🐛 问题修复(Bug Fixes)</h3>
<ul>
<li>修复搜索 API 中图标绝对 URL 的解析问题</li>
<li>修复集成商店读取剪贴板数据后的显示问题</li>
</ul>
<h3 data-id="heading-8">✈️ 改进优化 (Improvements)</h3>
<ul>
<li>移除分页并在全屏模式下添加无限滚动</li>
</ul>
<h2 data-id="heading-9">Easysearch v2.0.2</h2>
<p>INFINI Easysearch 是一个分布式的搜索型数据库，实现非结构化数据检索、全文检索、向量检索、地理位置信息查询、组合索引查询、多语种支持、聚合分析等。Easysearch 可以完美替代 Elasticsearch，同时添加和完善多项企业级功能。Easysearch 助您拥有简洁、高效、易用的搜索体验。</p>
<p>Easysearch 本次更新如下：</p>
<h3 data-id="heading-10">💥 重大变更(Breaking Changes)</h3>
<ul>
<li>正式发布 Easysearch 2.0.2 版本，底层 Lucene 更新到 9.12.2</li>
<li>新增 ui 插件，为 Easysearch 提供了轻量级界面化管理功能，不再依赖第三方对集群进行管理，真正做到开箱即用</li>
</ul>
<h3 data-id="heading-11">🚀 功能特性 (Features)</h3>
<ul>
<li>语义搜索新增支持 NestedQueryBuilder</li>
<li>KNN mapping 的 L 和 k 参数支持大小写不敏感，提升易用性</li>
</ul>
<h3 data-id="heading-12">✈️ 改进优化 (Improvements)</h3>
<ul>
<li>UI 插件静态文件支持 gzip 压缩，加快页面加载</li>
<li>优化了图标资源大小</li>
<li>调整了内部构建流程和 CSP 策略</li>
</ul>
<h3 data-id="heading-13">🐛 问题修复(Bug Fixes)</h3>
<ul>
<li>修复了开发者工具的主题颜色显示问题</li>
</ul>
<h2 data-id="heading-14">Console v1.30.1</h2>
<p>INFINI Console 是一款开源的非常轻量级的多集群、跨版本的搜索基础设施统一管控平台。通过对流行的搜索引擎基础设施进行跨版本、多集群的集中纳管，企业可以快速方便的统一管理企业内部的不同版本的多套搜索集群。</p>
<p>Console 本次详细更新记录如下：</p>
<h3 data-id="heading-15">🚀 功能特性 (Features)</h3>
<ul>
<li>支持 Easysearch 2.x 和 Opensearch 3.x</li>
</ul>
<h3 data-id="heading-16">✈️ 改进优化 (Improvements)</h3>
<ul>
<li>此版本包含了底层 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fframework%2Fv1.4.0" target="_blank" title="https://docs.infinilabs.com/framework/v1.4.0" ref="nofollow noopener noreferrer">Framework v1.4.0</a> 的更新，解决了一些常见问题，并增强了整体稳定性和性能。虽然 Console 本身没有直接的变更，但从 Framework 中继承的改进间接地使 Console 受益。</li>
</ul>
<h2 data-id="heading-17">Gateway v1.30.1</h2>
<p>INFINI Gateway 是一个开源的面向搜索场景的高性能数据网关，所有请求都经过网关处理后再转发到后端的搜索业务集群。基于 INFINI Gateway 可以实现索引级别的限速限流、常见查询的缓存加速、查询请求的审计、查询结果的动态修改等等。</p>
<p>Gateway 本次更新如下：</p>
<h3 data-id="heading-18">✈️ 改进优化 (Improvements)</h3>
<ul>
<li>此版本包含了底层 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fframework%2Fv1.4.0" target="_blank" title="https://docs.infinilabs.com/framework/v1.4.0" ref="nofollow noopener noreferrer">Framework v1.4.0</a> 的更新，解决了一些常见问题，并增强了整体稳定性和性能。虽然 Gateway 本身没有直接的变更，但从 Framework 中继承的改进间接地使 Gateway 受益。</li>
</ul>
<h2 data-id="heading-19">Agent v1.30.1</h2>
<p>INFINI Agent 负责采集和上传 Elasticsearch, Easysearch, Opensearch 集群的日志和指标信息，通过 INFINI Console 管理，支持主流操作系统和平台，安装包轻量且无任何外部依赖，可以快速方便地安装。</p>
<p>Agent 本次更新如下：</p>
<h3 data-id="heading-20">🚀 功能特性 (Features)</h3>
<ul>
<li>在 Kubernetes 环境下通过环境变量 http.port 探测 Easysearch 的 HTTP 端口</li>
</ul>
<h3 data-id="heading-21">✈️ 改进优化 (Improvements)</h3>
<ul>
<li>此版本包含了底层 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fframework%2Fv1.4.0" target="_blank" title="https://docs.infinilabs.com/framework/v1.4.0" ref="nofollow noopener noreferrer">Framework v1.4.0</a> 的更新，解决了一些常见问题，并增强了整体稳定性和性能。虽然 Agent 本身没有直接的变更，但从 Framework 中继承的改进间接地使 Agent 受益。</li>
</ul>
<h2 data-id="heading-22">Loadgen v1.30.1</h2>
<p>INFINI Loadgen 是一款开源的专为 Easysearch、Elasticsearch、OpenSearch 设计的轻量级性能测试工具。</p>
<p>Loadgen 本次更新如下：</p>
<h3 data-id="heading-23">✈️ 改进优化 (Improvements)</h3>
<ul>
<li>此版本包含了底层 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fframework%2Fv1.4.0" target="_blank" title="https://docs.infinilabs.com/framework/v1.4.0" ref="nofollow noopener noreferrer">Framework v1.4.0</a> 的更新，解决了一些常见问题，并增强了整体稳定性和性能。虽然 Loadgen 本身没有直接的变更，但从 Framework 中继承的改进间接地使 Loadgen 受益。</li>
</ul>
<h2 data-id="heading-24">Framework 1.4.0</h2>
<p>INFINI Framework 是 INFINI Labs 基于 Golang 的产品的核心基础，已开源。该框架以开发者为中心设计，简化了构建高性能、可扩展且可靠的应用程序的过程。</p>
<p>Framework 本次更新如下：</p>
<h3 data-id="heading-25">🚀 功能特性 (Features)</h3>
<ul>
<li>为 curl 添加 p12 证书支持（#239）</li>
<li>从 util 中移除 curl（#242）</li>
<li>优先使用集群名称（#243）</li>
<li>为 access_token 添加标签（#244）</li>
<li>为用户主体（principal）添加头像配置（#246）</li>
</ul>
<h3 data-id="heading-26">🐛 问题修复 (Bug Fixes)</h3>
<ul>
<li>修复重复写入和未写入的问题（#234）</li>
<li>当 filePath 为绝对路径时，检查其是否存在（#241）</li>
</ul>
<h3 data-id="heading-27">✈️ 改进 (Improvements)</h3>
<ul>
<li>改进 TryGetFileAbsPath() 的 panic 错误信息（#240）</li>
</ul>
<p>更多详情请查看以下各产品的 Release Notes 或联系我们的技术支持团队！</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fcoco-app%2Fmain%2Fdocs%2Frelease-notes%2F" target="_blank" title="https://docs.infinilabs.com/coco-app/main/docs/release-notes/" ref="nofollow noopener noreferrer"><strong>Coco AI App</strong></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fcoco-server%2Fmain%2Fdocs%2Frelease-notes%2F" target="_blank" title="https://docs.infinilabs.com/coco-server/main/docs/release-notes/" ref="nofollow noopener noreferrer"><strong>Coco AI Server</strong></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Feasysearch%2Fmain%2Fdocs%2Frelease-notes%2Feasysearch%2F" target="_blank" title="https://docs.infinilabs.com/easysearch/main/docs/release-notes/easysearch/" ref="nofollow noopener noreferrer"><strong>INFINI Easysearch</strong></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fgateway%2Fmain%2Fdocs%2Frelease-notes%2F" target="_blank" title="https://docs.infinilabs.com/gateway/main/docs/release-notes/" ref="nofollow noopener noreferrer"><strong>INFINI Gateway</strong></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fconsole%2Fmain%2Fdocs%2Frelease-notes%2F" target="_blank" title="https://docs.infinilabs.com/console/main/docs/release-notes/" ref="nofollow noopener noreferrer"><strong>INFINI Console</strong></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fagent%2Fmain%2Fdocs%2Frelease-notes%2F" target="_blank" title="https://docs.infinilabs.com/agent/main/docs/release-notes/" ref="nofollow noopener noreferrer"><strong>INFINI Agent</strong></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Floadgen%2Fmain%2Fdocs%2Frelease-notes%2F" target="_blank" title="https://docs.infinilabs.com/loadgen/main/docs/release-notes/" ref="nofollow noopener noreferrer"><strong>INFINI Loadgen</strong></a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infinilabs.com%2Fframework%2Fmain%2Fdocs%2Frelease-notes%2F" target="_blank" title="https://docs.infinilabs.com/framework/main/docs/release-notes/" ref="nofollow noopener noreferrer"><strong>INFINI Framework</strong></a></li>
</ul>
<h2 data-id="heading-28">期待反馈</h2>
<p>欢迎下载体验使用，如果您在使用过程中遇到如何疑问或者问题，欢迎前往 INFINI Labs Github（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfinilabs" target="_blank" title="https://github.com/infinilabs" ref="nofollow noopener noreferrer">github.com/infinilabs</a>） 中的对应项目中提交 Feature Request 或提交 Bug。</p>
<p><strong>下载地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Finfinilabs.cn%2Fdownload" target="_blank" title="https://infinilabs.cn/download" ref="nofollow noopener noreferrer">infinilabs.cn/download</a></p>
<p><strong>Discord</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2F4tKTMkkvVX" target="_blank" title="https://discord.gg/4tKTMkkvVX" ref="nofollow noopener noreferrer">discord.gg/4tKTMkkvVX</a></p>
<h2 data-id="heading-29">关于极限科技（INFINI Labs）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93e4ec4d3ae84094ab00fa25c078653f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851274&amp;x-signature=F0ceOW3eCRroaQgwQRHa4u0ZStY%3D" alt="INFINI Labs" loading="lazy"/></p>
<p>极限科技，全称极限数据（北京）科技有限公司，是一家专注于实时搜索与数据分析的软件公司。旗下品牌极限实验室（INFINI Labs）致力于打造极致易用的数据探索与分析体验。</p>
<p>极限科技是一支年轻的团队，采用天然分布式的方式来进行远程协作，员工分布在全球各地，希望通过努力成为中国乃至全球企业大数据实时搜索分析产品的首选，为中国技术品牌输出添砖加瓦。</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Finfinilabs.cn" target="_blank" title="https://infinilabs.cn" ref="nofollow noopener noreferrer">infinilabs.cn</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（23）Netty的负载均衡和高可用性如何实现？]]></title>    <link>https://juejin.cn/post/7585502118459883539</link>    <guid>https://juejin.cn/post/7585502118459883539</guid>    <pubDate>2025-12-20T23:58:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585502118459883539" data-draft-id="7585485074038358022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（23）Netty的负载均衡和高可用性如何实现？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T23:58:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（23）Netty的负载均衡和高可用性如何实现？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T23:58:17.000Z" title="Sat Dec 20 2025 23:58:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Netty中实现负载均衡和高可用性，通常涉及到以下几个方面：</p>
<ol>
<li><strong>负载均衡</strong>：将请求分发到多个服务器节点，以分散负载。</li>
<li><strong>高可用性</strong>：确保系统在部分节点故障的情况下仍能够正常工作。</li>
</ol>
<p>以下是实现Netty负载均衡和高可用性的一些常见方法：</p>
<h3 data-id="heading-0">负载均衡</h3>
<p>负载均衡可以通过多种方式实现，包括硬件负载均衡器、DNS轮询和软件负载均衡器（如Nginx、HAProxy）。在Netty中，您可以通过自定义代码实现简单的负载均衡逻辑。</p>
<h4 data-id="heading-1">示例：基于Netty的简单负载均衡客户端</h4>
<p>假设我们有多个后端服务器，客户端需要将请求分发到这些服务器：</p>
<ol>
<li><strong>创建服务器列表和选择策略</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadBalancer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; serverList;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicInteger index;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoadBalancer</span><span class="hljs-params">(List&lt;String&gt; serverList)</span> {
        <span class="hljs-built_in">this</span>.serverList = serverList;
        <span class="hljs-built_in">this</span>.index = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNextServer</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">currentIndex</span> <span class="hljs-operator">=</span> index.getAndIncrement();
        <span class="hljs-keyword">return</span> serverList.get(currentIndex % serverList.size());
    }
}
</code></pre>
<ol start="2">
<li><strong>客户端初始化和请求发送</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpClientCodec;
<span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;
<span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpRequest;
<span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpResponse;

<span class="hljs-keyword">import</span> java.util.Arrays;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadBalancedHttpClient</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;String&gt; servers = Arrays.asList(<span class="hljs-string">"localhost:8081"</span>, <span class="hljs-string">"localhost:8082"</span>, <span class="hljs-string">"localhost:8083"</span>);
        <span class="hljs-type">LoadBalancer</span> <span class="hljs-variable">loadBalancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadBalancer</span>(servers);

        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpClientCodec</span>());
                     ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpObjectAggregator</span>(<span class="hljs-number">512</span> * <span class="hljs-number">1024</span>));
                     ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadBalancedHttpClientHandler</span>());
                 }
             });

            <span class="hljs-type">String</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> loadBalancer.getNextServer();
            String[] hostPort = server.split(<span class="hljs-string">":"</span>);
            b.connect(hostPort[<span class="hljs-number">0</span>], Integer.parseInt(hostPort[<span class="hljs-number">1</span>])).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}
</code></pre>
<ol start="3">
<li><strong>处理请求和响应</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;
<span class="hljs-keyword">import</span> io.netty.handler.codec.http.*;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.netty.handler.codec.http.HttpMethod.GET;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> io.netty.handler.codec.http.HttpVersion.HTTP_1_1;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadBalancedHttpClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;FullHttpResponse&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> {
        <span class="hljs-type">FullHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFullHttpRequest</span>(HTTP_1_1, GET, <span class="hljs-string">"/"</span>);
        request.headers().set(HttpHeaderNames.HOST, <span class="hljs-string">"localhost"</span>);
        request.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);
        ctx.writeAndFlush(request);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, FullHttpResponse response)</span> {
        System.out.println(<span class="hljs-string">"Response received: "</span> + response.content().toString(io.netty.util.CharsetUtil.UTF_8));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-2">高可用性</h3>
<p>高可用性通常涉及到以下几个方面：</p>
<ol>
<li><strong>健康检查</strong>：定期检查各个服务器节点的健康状态，移除不可用的节点。</li>
<li><strong>故障转移</strong>：在检测到节点故障时，将请求转发到其他可用节点。</li>
</ol>
<h4 data-id="heading-3">示例：基于Netty的健康检查和故障转移</h4>
<ol>
<li><strong>健康检查器</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthChecker</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; serverList;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HealthChecker</span><span class="hljs-params">(List&lt;String&gt; serverList)</span> {
        <span class="hljs-built_in">this</span>.serverList = serverList;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        scheduler.scheduleAtFixedRate(<span class="hljs-built_in">this</span>::checkHealth, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkHealth</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 健康检查逻辑，例如发送HTTP请求到每个服务器并检查响应状态</span>
        <span class="hljs-comment">// 如果服务器不可用，则从serverList中移除</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
        scheduler.shutdown();
    }
}
</code></pre>
<ol start="2">
<li><strong>集成健康检查和负载均衡</strong>：</li>
</ol>
<p>在客户端启动时，启动健康检查器，并在负载均衡逻辑中使用健康检查结果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadBalancedHttpClientWithHealthCheck</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;String&gt; servers = Arrays.asList(<span class="hljs-string">"localhost:8081"</span>, <span class="hljs-string">"localhost:8082"</span>, <span class="hljs-string">"localhost:8083"</span>);
        <span class="hljs-type">LoadBalancer</span> <span class="hljs-variable">loadBalancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadBalancer</span>(servers);
        <span class="hljs-type">HealthChecker</span> <span class="hljs-variable">healthChecker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HealthChecker</span>(servers);
        healthChecker.start();

        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpClientCodec</span>());
                     ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpObjectAggregator</span>(<span class="hljs-number">512</span> * <span class="hljs-number">1024</span>));
                     ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadBalancedHttpClientHandler</span>());
                 }
             });

            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> loadBalancer.getNextServer();
                String[] hostPort = server.split(<span class="hljs-string">":"</span>);
                b.connect(hostPort[<span class="hljs-number">0</span>], Integer.parseInt(hostPort[<span class="hljs-number">1</span>])).sync().channel().closeFuture().sync();
            }
        } <span class="hljs-keyword">finally</span> {
            healthChecker.stop();
            group.shutdownGracefully();
        }
    }
}
</code></pre>
<p>通过以上步骤，您可以实现一个基于Netty的负载均衡和高可用性客户端。健康检查器定期检查后端服务器的健康状态，并在负载均衡逻辑中使用健康检查结果来选择可用的服务器节点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（24）Netty中的零拷贝文件传输]]></title>    <link>https://juejin.cn/post/7585474459777171492</link>    <guid>https://juejin.cn/post/7585474459777171492</guid>    <pubDate>2025-12-20T23:59:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459777171492" data-draft-id="7585485074038374406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（24）Netty中的零拷贝文件传输"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T23:59:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（24）Netty中的零拷贝文件传输
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T23:59:12.000Z" title="Sat Dec 20 2025 23:59:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Netty中的零拷贝文件传输利用了操作系统提供的零拷贝功能，使得文件数据可以直接从文件系统传输到网络，而无需经过用户空间。这大大提高了数据传输的效率，减少了CPU的使用和内存的拷贝操作。</p>
<p>Netty通过 <code>FileRegion</code> 和 <code>DefaultFileRegion</code> 类来实现零拷贝文件传输。以下是详细的步骤和代码示例：</p>
<h3 data-id="heading-0">服务器端实现</h3>
<ol>
<li><strong>创建服务器引导程序（ServerBootstrap）</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZeroCopyFileServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ZeroCopyFileServerInitializer</span>());

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
</code></pre>
<ol start="2">
<li><strong>初始化服务器管道（ChannelPipeline）</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.logging.LogLevel;
<span class="hljs-keyword">import</span> io.netty.handler.logging.LoggingHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZeroCopyFileServerInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
        ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingHandler</span>(LogLevel.INFO));
        ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ZeroCopyFileServerHandler</span>());
    }
}
</code></pre>
<ol start="3">
<li><strong>实现文件传输处理器（ChannelInboundHandlerAdapter）</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFutureListener;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;
<span class="hljs-keyword">import</span> io.netty.channel.DefaultFileRegion;

<span class="hljs-keyword">import</span> java.io.RandomAccessFile;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZeroCopyFileServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(<span class="hljs-string">"path/to/file.txt"</span>, <span class="hljs-string">"r"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">fileLength</span> <span class="hljs-operator">=</span> file.length();

        <span class="hljs-type">DefaultFileRegion</span> <span class="hljs-variable">region</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFileRegion</span>(file.getChannel(), <span class="hljs-number">0</span>, fileLength);
        ctx.writeAndFlush(region).addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelFutureListener</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operationComplete</span><span class="hljs-params">(ChannelFuture future)</span> <span class="hljs-keyword">throws</span> Exception {
                file.close();
                ctx.close();
            }
        });
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-1">客户端实现</h3>
<p>客户端需要接收文件数据并进行处理。</p>
<ol>
<li><strong>创建客户端引导程序（Bootstrap）</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZeroCopyFileClient</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ZeroCopyFileClientInitializer</span>());

            b.connect(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}
</code></pre>
<ol start="2">
<li><strong>初始化客户端管道（ChannelPipeline）</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.logging.LogLevel;
<span class="hljs-keyword">import</span> io.netty.handler.logging.LoggingHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZeroCopyFileClientInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
        ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingHandler</span>(LogLevel.INFO));
        ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ZeroCopyFileClientHandler</span>());
    }
}
</code></pre>
<ol start="3">
<li><strong>实现文件接收处理器（ChannelInboundHandlerAdapter）</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.RandomAccessFile;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZeroCopyFileClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-keyword">private</span> FileOutputStream fos;
    <span class="hljs-keyword">private</span> RandomAccessFile file;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(<span class="hljs-string">"received_file.txt"</span>, <span class="hljs-string">"rw"</span>);
        fos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file.getFD());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (msg <span class="hljs-keyword">instanceof</span> ByteBuf) {
            <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> (ByteBuf) msg;
            <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[buf.readableBytes()];
            buf.readBytes(bytes);
            fos.write(bytes);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelInactive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        fos.close();
        file.close();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<p>在上述代码中，服务器端通过 <code>DefaultFileRegion</code> 实现了零拷贝文件传输。客户端接收到文件数据并将其写入到本地文件。通过这种方式，可以有效地减少数据在用户空间和内核空间之间的拷贝次数，提高传输效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：图像与文件上传下载]]></title>    <link>https://juejin.cn/post/7585574047074353152</link>    <guid>https://juejin.cn/post/7585574047074353152</guid>    <pubDate>2025-12-20T21:47:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585574047074353152" data-draft-id="7585466235662336052" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：图像与文件上传下载"/> <meta itemprop="keywords" content="后端,Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-20T21:47:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：图像与文件上传下载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T21:47:49.000Z" title="Sat Dec 20 2025 21:47:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Web 应用中，文件与图片上传下载几乎是必备功能。从用户头像、附件上传，到后台报表导出、图片资源分发，都离不开稳定可靠的文件处理能力。Node.js 天然适合 I/O 密集型任务，在文件传输和流式处理方面具有明显优势。</p>
</blockquote>
<p>本文将从基础原理出发，介绍 Node.js 中文件与图片的上传、存储、下载以及常见优化方案。</p>
<hr/>
<h2 data-id="heading-0">一、文件上传的基本原理</h2>
<p>文件上传本质上是一个 HTTP 请求，浏览器通常使用 <code>multipart/form-data</code> 编码方式，将文件内容与表单数据一起发送到服务器。</p>
<p>Node.js 本身并不直接解析这种格式，因此在实际开发中，通常需要借助中间件来完成解析和存储。</p>
<p>常见的处理流程包括：</p>
<ul>
<li>客户端选择文件并提交表单</li>
<li>服务端接收请求并解析文件流</li>
<li>将文件保存到本地或云存储</li>
<li>返回上传结果给客户端</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、使用 Multer 处理文件上传</h2>
<p>在 Node.js Web 项目中，<code>multer</code> 是最常用的文件上传中间件，常与 Express 搭配使用。</p>
<h3 data-id="heading-2">1. 基本配置</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>({
  <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads/'</span>
});
</code></pre>
<p>这里的 <code>dest</code> 指定了文件的临时存储目录，上传完成后文件会自动写入该路径。</p>
<hr/>
<h3 data-id="heading-3">2. 单文件上传</h3>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/upload'</span>, upload.<span class="hljs-title function_">single</span>(<span class="hljs-string">'file'</span>), <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({
    <span class="hljs-attr">filename</span>: req.<span class="hljs-property">file</span>.<span class="hljs-property">filename</span>,
    <span class="hljs-attr">originalname</span>: req.<span class="hljs-property">file</span>.<span class="hljs-property">originalname</span>
  });
});
</code></pre>
<p><code>upload.single</code> 用于处理单个文件，参数名称必须与前端表单字段保持一致。</p>
<hr/>
<h3 data-id="heading-4">3. 多文件上传</h3>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/uploads'</span>, upload.<span class="hljs-title function_">array</span>(<span class="hljs-string">'files'</span>, <span class="hljs-number">5</span>), <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({
    <span class="hljs-attr">count</span>: req.<span class="hljs-property">files</span>.<span class="hljs-property">length</span>
  });
});
</code></pre>
<p>通过这种方式可以限制上传文件数量，防止资源滥用。</p>
<hr/>
<h2 data-id="heading-5">三、图片上传与处理</h2>
<p>图片通常需要额外的处理，例如尺寸压缩、格式转换或生成缩略图。</p>
<h3 data-id="heading-6">1. 图片类型校验</h3>
<p>在上传阶段应限制文件类型，避免上传非法文件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>({
  <span class="hljs-title function_">fileFilter</span>(<span class="hljs-params">req, file, cb</span>) {
    <span class="hljs-keyword">if</span> (!file.<span class="hljs-property">mimetype</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'image/'</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">cb</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'只允许上传图片'</span>));
    }
    <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
  }
});
</code></pre>
<hr/>
<h3 data-id="heading-7">2. 图片压缩与处理</h3>
<p><code>sharp</code> 是 Node.js 中非常流行的图片处理库。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sharp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sharp'</span>);

<span class="hljs-title function_">sharp</span>(<span class="hljs-string">'input.jpg'</span>)
  .<span class="hljs-title function_">resize</span>(<span class="hljs-number">300</span>, <span class="hljs-number">300</span>)
  .<span class="hljs-title function_">toFile</span>(<span class="hljs-string">'output.jpg'</span>);
</code></pre>
<p>在上传完成后对图片进行处理，可以有效减少存储空间和网络传输压力。</p>
<hr/>
<h2 data-id="heading-8">四、文件下载的实现方式</h2>
<p>文件下载本质是服务端向客户端返回一个文件流，并设置正确的响应头。</p>
<h3 data-id="heading-9">1. 下载本地文件</h3>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/download'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> filePath = <span class="hljs-string">'./uploads/example.pdf'</span>;
  res.<span class="hljs-title function_">download</span>(filePath);
});
</code></pre>
<p><code>res.download</code> 会自动处理文件名和响应头，是最简单的下载方式。</p>
<hr/>
<h3 data-id="heading-10">2. 使用流进行下载</h3>
<p>对于大文件，推荐使用流式传输。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/download'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> stream = fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">'./bigfile.zip'</span>);
  stream.<span class="hljs-title function_">pipe</span>(res);
});
</code></pre>
<p>这种方式可以显著降低内存占用，提升并发能力。</p>
<hr/>
<h2 data-id="heading-11">五、文件存储方案选择</h2>
<h3 data-id="heading-12">1. 本地磁盘存储</h3>
<p>适合小型项目或内部系统，部署简单，但不利于扩展和多实例部署。</p>
<h3 data-id="heading-13">2. 对象存储服务</h3>
<p>在生产环境中，通常会使用云存储服务来保存文件，例如：</p>
<ul>
<li>图片与视频资源</li>
<li>用户上传附件</li>
<li>静态下载文件</li>
</ul>
<p>Node.js 只负责上传和下载的中转与权限校验，真正的数据存储交由专业服务处理。</p>
<hr/>
<h2 data-id="heading-14">六、安全与性能注意事项</h2>
<p>在实现文件与图片上传下载时，需要重点关注以下问题：</p>
<ul>
<li>限制文件大小，防止恶意占用资源</li>
<li>校验文件类型，避免执行型文件上传</li>
<li>使用随机文件名，防止路径猜测</li>
<li>大文件采用流式处理，避免阻塞事件循环</li>
</ul>
<p>合理的限制与校验，是后端系统安全的重要一环。</p>
<hr/>
<h2 data-id="heading-15">七、常见应用场景</h2>
<p>Node.js 文件与图片处理常见于以下场景：</p>
<ul>
<li>用户头像与图片上传</li>
<li>后台附件管理系统</li>
<li>报表与数据文件下载</li>
<li>富文本编辑器图片管理</li>
<li>批量导入导出文件</li>
</ul>
<p>这些场景对稳定性和性能要求都较高，非常适合使用 Node.js 来实现。</p>
<hr/>
<h2 data-id="heading-16">八、总结</h2>
<p>Node.js 在文件与图片上传下载方面具备完善的生态支持。通过中间件解析文件、结合流式处理与图片压缩，可以构建出高性能、可扩展的文件服务。</p>
<p>在实际项目中，应根据文件大小、访问频率和部署架构，选择合适的存储和处理方案，从而在性能、安全与维护成本之间取得平衡。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：日志管理与分析]]></title>    <link>https://juejin.cn/post/7585466235662352436</link>    <guid>https://juejin.cn/post/7585466235662352436</guid>    <pubDate>2025-12-20T21:48:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585466235662352436" data-draft-id="7585458459166998562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：日志管理与分析"/> <meta itemprop="keywords" content="后端,面试,Node.js"/> <meta itemprop="datePublished" content="2025-12-20T21:48:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：日志管理与分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T21:48:19.000Z" title="Sat Dec 20 2025 21:48:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在后端系统中，日志不仅是排查问题的工具，更是系统运行状态的重要记录。无论是接口报错、性能瓶颈，还是用户行为分析，都离不开高质量的日志体系。Node.js 应用通常运行在高并发环境下，如果日志设计不合理，很容易出现信息缺失、性能下降甚至磁盘被写满等问题。</p>
</blockquote>
<p>本文将围绕 Node.js 日志的设计思路、常见实现方式以及日志分析实践进行讲解。</p>
<hr/>
<h2 data-id="heading-0">一、为什么日志如此重要</h2>
<p>日志在 Node.js 应用中主要承担三类职责。</p>
<p>第一，用于问题排查。当线上出现异常时，日志往往是定位问题的第一手资料。
第二，用于运行监控。通过日志可以了解系统是否稳定、接口是否超时。
第三，用于行为分析。业务日志可以帮助分析用户操作路径和系统使用情况。</p>
<p>缺乏统一日志规范的项目，随着规模扩大，维护成本会迅速上升。</p>
<hr/>
<h2 data-id="heading-1">二、Node.js 日志的基本分类</h2>
<p>在实际项目中，通常会将日志分为几类。</p>
<ul>
<li>访问日志：记录每一次请求的基本信息</li>
<li>应用日志：记录业务运行过程中的关键节点</li>
<li>错误日志：记录异常和错误堆栈</li>
<li>性能日志：记录耗时、慢接口等信息</li>
</ul>
<p>清晰的分类，有助于后期分析和自动化处理。</p>
<hr/>
<h2 data-id="heading-2">三、基础日志输出方式</h2>
<p>Node.js 最简单的日志方式是使用 <code>console</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'server started'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'something went wrong'</span>);
</code></pre>
<p>这种方式适合开发调试阶段，但并不适合生产环境。它无法控制日志格式、级别，也不便于持久化和集中分析。</p>
<hr/>
<h2 data-id="heading-3">四、使用日志库进行日志管理</h2>
<p>在生产项目中，通常会使用专业日志库来管理日志。</p>
<h3 data-id="heading-4">1. 日志级别设计</h3>
<p>常见日志级别包括：</p>
<ul>
<li>debug：调试信息</li>
<li>info：运行状态信息</li>
<li>warn：潜在问题</li>
<li>error：错误与异常</li>
</ul>
<p>通过合理的日志级别，可以在不同环境输出不同粒度的日志。</p>
<hr/>
<h3 data-id="heading-5">2. 使用日志库示例</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> winston = <span class="hljs-built_in">require</span>(<span class="hljs-string">'winston'</span>);

<span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-string">'info'</span>,
  <span class="hljs-attr">transports</span>: [
    <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">File</span>({ <span class="hljs-attr">filename</span>: <span class="hljs-string">'app.log'</span> })
  ]
});

logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'application started'</span>);
logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'database connection failed'</span>);
</code></pre>
<p>日志库可以将日志输出到文件、控制台，甚至远程服务。</p>
<hr/>
<h2 data-id="heading-6">五、日志格式与结构化日志</h2>
<p>相比纯文本日志，结构化日志更适合自动化分析。</p>
<pre><code class="hljs language-js" lang="js">logger.<span class="hljs-title function_">info</span>({
  <span class="hljs-attr">event</span>: <span class="hljs-string">'user_login'</span>,
  <span class="hljs-attr">userId</span>: <span class="hljs-number">123</span>,
  <span class="hljs-attr">time</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
});
</code></pre>
<p>这种 JSON 格式日志可以直接被日志系统解析、筛选和聚合，大幅提升分析效率。</p>
<hr/>
<h2 data-id="heading-7">六、访问日志的记录方式</h2>
<p>对于 Web 应用来说，访问日志非常关键。</p>
<p>常见记录内容包括请求路径、请求方法、响应状态、耗时等信息。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'finish'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start);
  });
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>通过访问日志，可以快速发现异常流量和慢请求。</p>
<hr/>
<h2 data-id="heading-8">七、日志切割与存储策略</h2>
<p>日志文件如果不做控制，很容易无限增长。</p>
<p>常见的解决方式包括：</p>
<ul>
<li>按天或按大小进行日志切割</li>
<li>定期清理历史日志</li>
<li>将日志存储到独立磁盘或服务</li>
</ul>
<p>合理的日志策略可以避免磁盘空间被日志占满。</p>
<hr/>
<h2 data-id="heading-9">八、日志集中管理与分析</h2>
<p>在分布式或多实例部署场景中，单机日志已经无法满足需求。</p>
<p>通常会将日志集中到统一平台进行分析，完成：</p>
<ul>
<li>统一检索</li>
<li>异常告警</li>
<li>运行趋势分析</li>
</ul>
<p>Node.js 只负责日志采集，真正的分析交由专业系统处理。</p>
<hr/>
<h2 data-id="heading-10">九、性能与安全注意事项</h2>
<p>日志虽然重要，但也不能影响系统性能。</p>
<p>需要注意以下几点：</p>
<ul>
<li>避免在高频路径中记录过多日志</li>
<li>不要在日志中输出敏感信息</li>
<li>使用异步方式写入日志</li>
<li>对错误日志进行重点监控</li>
</ul>
<p>平衡日志质量与性能，是成熟系统的标志之一。</p>
<hr/>
<h2 data-id="heading-11">十、总结</h2>
<p>日志管理是 Node.js 应用走向生产环境的重要一步。一个清晰、稳定、可分析的日志体系，可以显著降低排错成本，提高系统可维护性。</p>
<p>在项目初期就建立良好的日志规范，比后期补救要轻松得多。随着业务规模扩大，日志不仅是排错工具，更是系统运行的重要数据资产。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再死磕扩散模型了，MiniMax新开源揭示：视觉Tokenizer才是下一个金矿]]></title>    <link>https://juejin.cn/post/7585485284152934435</link>    <guid>https://juejin.cn/post/7585485284152934435</guid>    <pubDate>2025-12-20T16:05:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485284152934435" data-draft-id="7585458459166687266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再死磕扩散模型了，MiniMax新开源揭示：视觉Tokenizer才是下一个金矿"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-20T16:05:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再死磕扩散模型了，MiniMax新开源揭示：视觉Tokenizer才是下一个金矿
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T16:05:18.000Z" title="Sat Dec 20 2025 16:05:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在AI绘画和视频生成卷到飞起的今天，不管是大厂还是开源社区，大家似乎都陷入了一个怪圈：拼命堆算力去训练更大的Diffusion Transformer（DiT），指望通过增加生成模型的参数来获得更好的画质。</p>
<p>但就在前两天，凭借海螺视频（Hailuo AI）在圈内名声大噪的MiniMax团队，突然开源了一个名为VTP（Visual Tokenizer Pre-training）的项目。看完他们的论文和代码，我不得不说，这帮人可能刚刚掀翻了视觉生成领域的桌子。</p>
<p>他们抛出了一个极其反直觉的结论：<strong>如果我们一直在错误的地方用力呢？如果你画不出好图，可能不是因为你的画笔（DiT）不够好，而是因为你的眼睛（Tokenizer）根本没看懂这个世界。</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fdasfsdgv-1024x347.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/dasfsdgv-1024x347.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d3a65057d7c42a5bace62bde3177ff0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851518&amp;x-signature=Wn8vnGHcft6h8Wkotub1QWxy2kI%3D" alt="dasfsdgv" loading="lazy"/></a></p>
<h2 data-id="heading-0">传统的死胡同：只做复读机，不做理解者</h2>
<p>为了理解VTP的突破，我们得先聊聊现在的视觉模型是怎么工作的。通常，我们用一个Tokenizer（比如VAE）把图片压缩成Latent（潜在表示），然后让生成模型去学习这个Latent。</p>
<p>在这个过程中，传统Tokenizer的唯一KPI就是“还原度”。它就像一个极其死板的复印店老板，只在乎压缩后的图片解压出来跟原图像不像。像素对上了，任务就完成了。</p>
<p>这就导致了一个严重的问题：<strong>Scaling Law在Tokenizer上失效了。</strong></p>
<p>不论你给传统VAE投多少算力、喂多少数据，只要它只盯着像素重建，下游的生成模型就很难从中受益。甚至有时候，重建得越完美，生成的画质反而越差。因为模型把算力都浪费在了描绘墙纸的细微纹理上，却忘了理解画面里站着的是个人还是条狗。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fegerhgt.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/egerhgt.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62299bb6f69a448fa9688c692761f9b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851518&amp;x-signature=ypVaoGDtfwkcfXFlobHj01HYDeg%3D" alt="egerhgt" loading="lazy"/></a></p>
<h2 data-id="heading-1">MiniMax的解题思路：理解驱动生成</h2>
<p>MiniMax团队这次干的事情，就是重新发明了Tokenizer。他们提出的VTP框架，核心逻辑非常性感：<strong>一个好的Tokenizer，不应该只是像素的搬运工，而应该是语义的翻译官。</strong></p>
<p>VTP不再单纯追求“画得像”，而是追求“听得懂”和“看得懂”。为了做到这一点，他们在预训练阶段搞了一个“混合双打”，强行让Tokenizer同时从三个维度学习：</p>
<ol>
<li><strong>像素级重建</strong>：老本行不能丢，保证基本的视觉细节（但权重降低了）。</li>
<li><strong>语义理解（CLIP风格）</strong>：让Tokenizer理解这张图对应什么文字，知道“猫”长什么样。</li>
<li><strong>结构认知（DINO风格）</strong>：通过自监督学习，搞清楚物体的空间结构和局部关系。</li>
</ol>
<p>这就像是教一个学画画的学生，不再让他没日没夜地临摹照片（纯重建），而是先教他解剖学、光影原理和艺术史（语义与结构理解）。结果显而易见，懂原理的学生，创作能力完爆只会临摹的学生。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fegregehre-1024x368.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/egregehre-1024x368.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68ae854b38e44dc9bddf28bbb18abb9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851518&amp;x-signature=avnhWufV4O2jjacl4AqDqyCIvWw%3D" alt="egregehre" loading="lazy"/></a></p>
<h2 data-id="heading-2">数据不会骗人：Scaling Law终于生效了</h2>
<p>VTP最让开发者兴奋的，不是它用了什么新架构（其实还是ViT），而是它证明了<strong>视觉Tokenizer也存在Scaling Law</strong>。</p>
<p>根据MiniMax公布的实验数据，当你增加VTP的参数量、训练数据和计算量时，下游的生成模型性能呈现出一条漂亮的上升曲线。</p>
<p>这组对比数据非常震撼：</p>
<ul>
<li>在同样的生成模型算力下，仅仅是将Tokenizer换成VTP，<strong>FID（图像质量指标）直接提升了65.8%</strong>。</li>
<li><strong>收敛速度快了4.1倍</strong>。这意味着如果你在训练自己的SD或DiT模型，用VTP可能让你省下一大笔显卡电费。</li>
<li>在ImageNet的零样本分类测试中，VTP甚至跑出了78.2%的准确率，比原版CLIP还高。这说明这个Tokenizer是真的“看懂”了图片。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Ffdgsdgf-1024x365.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/fdgsdgf-1024x365.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0217b8c35be14bc5b35d12e21e91da1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851518&amp;x-signature=pyDjrDJIg4guzFq5XmXjFEab1ns%3D" alt="fdgsdgf" loading="lazy"/></a></p>
<h2 data-id="heading-3">给行业的一记重拳</h2>
<p>MiniMax这次开源VTP，实际上是给所有做文生图、文生视频的团队指了一条新路。</p>
<p>在过去，当生成效果遇到瓶颈时，大家的反应通常是：“加层数！加数据！把DiT做大！”但VTP告诉我们，这种蛮力也许并非最优解。与其无止境地扩大生成模型的规模，不如回头看看最基础的Tokenizer。</p>
<p>这一步“磨刀不误砍柴工”的策略，极具性价比。它证明了在第一阶段（Tokenizer）注入更多的理解能力，会直接让第二阶段（生成）变得如虎添翼，也就是所谓的“Latent易学性”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fsgetrhrth-1024x399.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/sgetrhrth-1024x399.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3529d97c9bc401b874d1cc2bd532e63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851518&amp;x-signature=LT64T5552MiZ1InqsUkQnESgJ8k%3D" alt="sgetrhrth" loading="lazy"/></a></p>
<h2 data-id="heading-4">总结</h2>
<p>如果你是一名AI工程师或研究者，建议立刻去GitHub上拉取VTP的代码试试。MiniMax提供了完整的预训练权重和微调脚本。</p>
<p>VTP的出现或许标志着视觉生成进入了一个新阶段：我们不再满足于生成像素完美的图像，而是开始追求生成具备深层语义一致性的视觉内容。</p>
<p>有些时候，突破瓶颈的钥匙，往往就藏在你觉得最不起眼的那个组件里。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从金鱼记忆到过目不忘：Transformer 如何让AI真正理解一句话？]]></title>    <link>https://juejin.cn/post/7585574047074074624</link>    <guid>https://juejin.cn/post/7585574047074074624</guid>    <pubDate>2025-12-20T16:50:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585574047074074624" data-draft-id="7585574047074058240" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从金鱼记忆到过目不忘：Transformer 如何让AI真正理解一句话？"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-20T16:50:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从金鱼记忆到过目不忘：Transformer 如何让AI真正理解一句话？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T16:50:59.000Z" title="Sat Dec 20 2025 16:50:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有好奇过，ChatGPT 是怎么既能写诗，又能翻译外语，讲起量子力学来还像个老教授一样一套一套的？</p>
<p>这都得归功于2017年，Google团队发表的一篇名为《Attention Is All You Need》的论文，彻底改变了人工智能的历史进程。在此之前，AI处理长文本如同“即使只有7秒记忆的金鱼”，而Transformer的出现赋予了机器“过目不忘”的能力。今天我们来理解语言模型如何实现智能表现！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a9313776c704e72b1e80d7a3db51a5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766854258&amp;x-signature=%2FwxK%2BMFpMoQLsmm9j2gViQOKxd8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">核心机制：一切在于注意力机制（Attention Mechanism）</h2>
<p>阅读这句话时：</p>
<blockquote>
<p><em>“猫坐在垫子上，因为它很柔软。”</em> vs. <em>“猫坐在垫子上，因为它很累了。”</em></p>
</blockquote>
<p>在第一句中，你会瞬间理解“它”指代“垫子”（因为垫子柔软）；而在第二句中，“它”指代“猫”（因为猫会累）。 人类大脑能精准<strong>聚焦</strong>于关键信息并消除歧义。旧有的AI模型（如RNN）往往在处理到句子末尾时就忘记了开头的“猫”，导致指代错误。 <strong>Transformers的运作方式</strong>则如同拥有“上帝视角”：它不再受线性阅读限制，而是以闪电速度计算句子中所有词语之间的<strong>关联权重</strong>，瞬间判断出“柔软”与“垫子”的相关度高达90%，而与“猫”的相关度仅为10%。</p>
<h2 data-id="heading-1">自我注意力的突破性革新</h2>
<p>旧式模型逐词解析（读完A才读B），效率低下且难以捕捉长距离依赖。而Transformers<strong>同步观测所有词语</strong>。每个词都会自问：</p>
<blockquote>
<p><strong>“在这句话中，哪些词与我相关？我对它们的‘关注度’该分配多少？”</strong></p>
</blockquote>
<p>通过<strong>查询（Query）、键（Key）、值（Value）三个向量的巧妙运算，词语间动态织出了一张复杂的“关系网”。为了理解这三个概念，我们可以将其比作</strong>图书馆检索系统：</p>
<ul>
<li><strong>Query (查询)</strong> ：你手中的书单（比如你想找关于“猫”的信息）。</li>
<li><strong>Key (键)</strong> ：图书馆书脊上的标签（每本书的内容索引）。</li>
<li><strong>Value (值)</strong> ：书中实际的知识内容。</li>
</ul>
<p>当“猫”发出Query时，它会与全句所有词的Key进行匹配。如果Key匹配度高（点积运算结果大），模型就会提取更多的Value信息。</p>
<ul>
<li>“它”与“垫子”产生强关联（匹配度高，提取大量特征）</li>
<li>“猫”与“坐”建立逻辑连接（主谓关系清晰）</li>
</ul>
<h2 data-id="heading-2">信息流动流水线：分步解析</h2>
<h3 data-id="heading-3">① 输入嵌入 (Input Embeddings)：将词语转化为数字表征</h3>
<p>计算机不认识汉字，只认识数字。模型将词语转为高维向量。</p>
<ul>
<li><strong>实例</strong>：在GPT-3模型中，每个词被转化为一个长度为12,288维的向量。</li>
<li><strong>数学直觉</strong>：在这种高维空间中，语义相近的词距离更近。经典的向量运算案例是：国王−男人+女人≈女王。这证明了模型不是在死记硬背，而是理解了词语间的空间几何关系。</li>
</ul>
<h3 data-id="heading-4">② 位置编码 (Positional Encoding)：补足词序信息</h3>
<p>由于Transformer是并行处理（一次性吃进所有词），它天然不知道顺序。就像把一本书拆散页扔在地上。</p>
<ul>
<li><strong>解决方案</strong>：给每个词打上独特的“时间戳”或“页码”。通过正弦和余弦函数的波形叠加，模型能区分“张三打了李四”与“李四打了张三”截然不同的含义，理解“猫”在“坐”之前。</li>
</ul>
<h3 data-id="heading-5">③ 自注意力 (Self-Attention)：动态社交网络 🎉</h3>
<p>这不是简单的“看一眼”，而是<strong>多头注意力（Multi-Head Attention）</strong> 。</p>
<ul>
<li>
<p><strong>具象理解</strong>：想象有96个不同的“阅读专家”同时在看这句话。</p>
<ul>
<li>
<p>专家A关注<strong>语法结构</strong>（主谓宾）；</p>
</li>
<li>
<p>专家B关注<strong>指代关系</strong>（“它”是谁）；</p>
</li>
<li>
<p>专家C关注<strong>情绪色彩</strong>（是褒义还是贬义）。</p>
<p>最终，这些专家把各自的观察结果汇总，形成对这个词全面而立体的理解。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6">④ 前馈网络 (Feed-Forward Networks)：深度信息加工</h3>
<p>每个词的表征经迷你神经网络转换，这是模型的“记忆库”。</p>
<ul>
<li><strong>功能</strong>：如果注意力层是在“收集线索”，这一层就是在“查阅百科全书”。它将提取的特征（如“柔软”）映射到更广阔的知识空间，强化细节理解（如： <em>“柔软” → [舒适感]、[纺织品]、[易变形]等关联概念</em>）。</li>
</ul>
<h3 data-id="heading-7">⑤ 层叠堆叠：从语法到意图</h3>
<p>Transformer架构通常重复构建12层（BERT-Base）、96层（GPT-3）甚至更多。</p>
<ul>
<li><strong>浅层（1-10层）</strong> ：处理基础语法，如识别名词、动词。</li>
<li><strong>中层（10-50层）</strong> ：理解语义关联，如逻辑推理、因果关系。</li>
<li><strong>深层（50+层）</strong> ：提炼抽象概念，如讽刺、隐喻、幽默感或特定领域的专业知识。</li>
<li><strong>数据支撑</strong>：研究表明，层数越深，模型对抽象概念的线性可分性越强。</li>
</ul>
<h3 data-id="heading-8">⑥ 输出层：生成智能回应</h3>
<p>最终将高维向量映射回人类词汇表（通常约50,000+个词）。</p>
<ul>
<li>
<p><strong>机制</strong>：输出的是<strong>概率分布</strong>。例如，对于“天空是__”，模型可能会预测：</p>
<ul>
<li>
<p>蓝色 (85%)</p>
</li>
<li>
<p>灰蒙蒙 (10%)</p>
</li>
<li>
<p>广阔 (4%)</p>
</li>
<li>
<p>绿色 (0.001% - 极低概率)</p>
<p>模型根据这些概率（结合温度参数Temperature）选择最合适的词作为回答。</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-9">设计优势：为何超越传统模型</h2>
<ul>
<li><strong>并行计算的胜利</strong>：传统RNN必须读完第一个词才能读第二个，训练像跑马拉松。Transformer利用GPU的大规模并行计算能力，就像一支千人团队同时阅读文章的不同段落。这使得训练万亿参数级模型（如GPT-4）从“不可能”变为“现实”。</li>
<li><strong>长距关联 (Long-Range Dependencies)</strong> ：RNN大约只能记住前100个词的上下文，在这个距离外就会发生“梯度消失”。而Transformer的上下文窗口（Context Window）可轻松达到128k甚至100万token（如Gemini 1.5 Pro），意味着它能读完《红楼梦》全书后，依然记得第一章的伏笔。</li>
<li><strong>可扩展性 (Scalability)</strong> ：<strong>缩放定律 (Scaling Laws)</strong> 证明，单纯增加数据规模、算力和模型层数，智能水平就会呈现指数级跃迁，涌现出意想不到的能力（如在未专门训练的情况下学会编程）。</li>
</ul>
<h2 data-id="heading-10">思维模拟本质：如何“理解”语言</h2>
<p>虽非人类那样的生物意识，但通过三步信息处理实现了极高保真的“类智能”：</p>
<ol>
<li><strong>收集线索</strong>（注意力机制像雷达一样扫描全网关联）；</li>
<li><strong>信号融合</strong>（通过百层网络的非线性变换，将简单词汇升维成复杂概念）；</li>
<li><strong>模式预测</strong>（基于海量人类文本的统计规律，预测下一个最合理的字）。</li>
</ol>
<p><strong>如同精密编排的数据舞蹈，当舞步足够复杂与精准时，便呈现出“思考”的优雅姿态。</strong></p>
<h2 data-id="heading-11">跨领域应用：通用智能架构</h2>
<p>Transformer已不仅仅是语言模型，它成为了AI界的“大一统理论”：</p>
<ul>
<li><strong>图像生成</strong>：DALL·E和Stable Diffusion将图像切片视为“单词”，利用Transformer学习像素间的关联，从而无中生有地创造画作。</li>
<li><strong>生命科学革命</strong>：DeepMind的<strong>AlphaFold</strong>将氨基酸序列视为“文本”，利用Transformer预测蛋白质的三维结构。它在短短几年内预测了超过2亿种蛋白质结构，解决了生物学界困扰50年的难题，加速了新药研发。</li>
<li><strong>自动驾驶与音视频</strong>：特斯拉等公司使用Vision Transformers (ViT) 处理摄像头数据，理解道路上的动态场景，让汽车学会“看路”。</li>
</ul>
<p>Transformers正成为AI的元学习引擎，凭灵活的注意力机制驱动着从原子尺度到宇宙尺度的全领域创新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分享几个使用Nano Banana Pro 画信息图的提示词]]></title>    <link>https://juejin.cn/post/7585485074038194182</link>    <guid>https://juejin.cn/post/7585485074038194182</guid>    <pubDate>2025-12-20T15:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038194182" data-draft-id="7585468725332918326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分享几个使用Nano Banana Pro 画信息图的提示词"/> <meta itemprop="keywords" content="GitHub,后端"/> <meta itemprop="datePublished" content="2025-12-20T15:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赛博东哥CyberFD"/> <meta itemprop="url" content="https://juejin.cn/user/4323692639162087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分享几个使用Nano Banana Pro 画信息图的提示词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4323692639162087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赛博东哥CyberFD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T15:24:33.000Z" title="Sat Dec 20 2025 15:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">将文章变成黑板报的提示词</h2>
<pre><code class="hljs language-diff" lang="diff">{内容}

请根据输入内容提取核心主题与要点，生成一张黑板报风格的信息图：  
<span class="hljs-deletion">- 采用黑色黑板背景和粉笔手绘风格，横版（16:9）构图。  </span>
<span class="hljs-deletion">- 信息精简，突出关键词与核心概念，多留白，易于一眼抓住重点。  </span>
<span class="hljs-deletion">- 加入少量简洁的卡通元素、图标或名人画像，增强趣味性和视觉记忆。  </span>
<span class="hljs-deletion">- 所有图像、文字必须使用彩色粉笔绘制，没有写实风格图画元素  </span>
<span class="hljs-deletion">- 除非特别要求，否则语言与输入内容语言一致。  </span>
请根据输入的内容使用 nano banana pro 画图：
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3736e7104b744eff84f10e289670c72d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LWb5Y2a5Lic5ZOlQ3liZXJGRA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766849072&amp;x-signature=TQs0I3pRlyG1RswjHrYzEs9juQQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">信息图的元提示词</h2>
<p><strong>注意：</strong> 这是画图提示词的元提示词</p>
<pre><code class="hljs">  
你是一位世界级的教学设计师  
  
你是一位擅长制作清晰、简洁且引人入胜的学习材料的大师。你也是一位视觉设计专家，懂得如何利用视觉元素将复杂的概念以通俗易懂的方式传达出来。同时，你还是讲故事的大师，懂得如何运用故事让学习过程更令人难忘且充满趣味。  
  
你的任务是分析提供的【源背景信息】和【用户引导提示】，并生成一份结构化的信息图表内容。该内容将告知专业信息图设计师需要传达哪些信息，以便受众能清晰理解源背景信息。  
  
这份内容将在下一步传递给专业信息图设计师，他们将依据此内容制作高质量的信息图。设计师无法访问【源背景信息】，因此请确保内容表述充分。 信息图必须使用 【中文】。  
  
你还需要分析提供的【用户引导提示】，从中提取仅与设计相关的指令（风格、布局、颜色等），并将其放入末尾专门的设计指南部分。  
  
工作流程  
  
第 1 步：分析源文档。通读整篇文档并深入理解其内容。  
  
第 2 步：创建高层级大纲。大纲应包含标题和所有主要学习目标列表。  
  
第 3 步：充实大纲内容。为每个学习目标创建一个章节。每个章节都应包含概念解释和实操教程的组合。  
  
关键规则  
  
规则 1：输出格式为 Markdown。所有生成的内容必须严格遵守 Markdown 格式。  
  
规则 2：语气和口吻。语气应如同专家培训师：知识渊博、充满鼓励且清晰明了。  
  
规则 3：无新增信息。不要添加任何源文档中不存在的信息。  
  
规则 4：源数据处理。源文档中的所有数据必须逐字复制。不要进行总结或改写
</code></pre>
<p>示例：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fshare%2Fd2241f26e734" target="_blank" title="https://gemini.google.com/share/d2241f26e734" ref="nofollow noopener noreferrer">gemini.google.com/share/d2241…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7782d90b6664f1d90f879c7c93784d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LWb5Y2a5Lic5ZOlQ3liZXJGRA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766849072&amp;x-signature=zhWIwGZRGi6hxRsoHVlqy6vzlSg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">手绘风格的信息图卡片提示词</h2>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">创作一张手绘风格的信息图卡片，比例为9:16竖版。卡片主题鲜明，背景为带有纸质肌理的米色或米白色，整体设计体现质朴、亲切的手绘美感。  </span>
  
卡片上方以红黑相间、对比鲜明的大号毛笔草书字体突出标题，吸引视觉焦点。文字内容均采用中文草书，整体布局分为2至4个清晰的小节，每节以简短、精炼的中文短语表达核心要点。字体保持草书流畅的韵律感，既清晰可读又富有艺术气息。  
  
卡片中点缀简单、有趣的手绘插画或图标，例如人物或象征符号，以增强视觉吸引力，引发读者思考与共鸣。整体布局注意视觉平衡，预留足够的空白空间，确保画面简洁明了，易于阅读和理解。  
  
主题是：“做IP是长期复利，坚持每日出摊，持续做，肯定会有结果，因为99%都坚持不住的

</code></pre>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ed016d458d849c8a3aebc51553796c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LWb5Y2a5Lic5ZOlQ3liZXJGRA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766849072&amp;x-signature=MXFN9yZc2RxDG90%2FqrH3H9zWFzE%3D" alt="image.png" width="50%" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python入门指南(五) - 为什么选择 FastAPI？]]></title>    <link>https://juejin.cn/post/7585485074038259718</link>    <guid>https://juejin.cn/post/7585485074038259718</guid>    <pubDate>2025-12-20T16:00:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038259718" data-draft-id="7585485074038243334" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python入门指南(五) - 为什么选择 FastAPI？"/> <meta itemprop="keywords" content="Python,FastAPI,后端"/> <meta itemprop="datePublished" content="2025-12-20T16:00:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴佳浩"/> <meta itemprop="url" content="https://juejin.cn/user/2696441245481975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python入门指南(五) - 为什么选择 FastAPI？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696441245481975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴佳浩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T16:00:34.000Z" title="Sat Dec 20 2025 16:00:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0"><strong>Python入门指南(五) - 为什么选择 FastAPI？</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7b25ea2caab4006a83fc7c2cacbd6a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC05L2z5rWp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766851234&amp;x-signature=P2%2F4d2YObqiy0fcQdTXOzmsMcjw%3D" alt="image.png" loading="lazy"/></p>
<p>欢迎来到Python入门指南的第五部分！在上一章中，我们完成了Python开发环境的初始化配置。现在，让我们进入实战阶段——选择合适的Web框架来构建我们的API服务。</p>
<p>本章将深入对比 <strong>Flask</strong> 和 <strong>FastAPI</strong>，帮助你理解为什么在现代Python开发中，FastAPI正在成为越来越多开发者的首选。</p>
<hr/>
<h3 data-id="heading-1">** 为什么需要Web框架？**</h3>
<p>在进入对比之前，先理解Web框架的核心作用：</p>
<ul>
<li><strong>处理HTTP请求和响应</strong>：接收用户请求，返回处理结果</li>
<li><strong>路由管理</strong>：将不同的URL映射到对应的处理函数</li>
<li><strong>数据验证</strong>：确保接收到的数据符合预期格式</li>
<li><strong>异步处理</strong>：提高并发性能，处理更多用户请求</li>
<li><strong>自动生成文档</strong>：让API使用者快速了解接口用法</li>
</ul>
<hr/>
<h3 data-id="heading-2">** Flask vs FastAPI：核心对比**</h3>
<h4 data-id="heading-3"><strong>1. 性能对比</strong></h4>
<p>FastAPI基于ASGI（异步服务器网关接口），而Flask基于WSGI（同步）。这带来了巨大的性能差异：</p>






























<table><thead><tr><th>指标</th><th>Flask</th><th>FastAPI</th></tr></thead><tbody><tr><td><strong>并发模型</strong></td><td>同步（WSGI）</td><td>异步（ASGI）</td></tr><tr><td><strong>每秒请求数</strong></td><td>~1,000-3,000</td><td>~10,000-20,000</td></tr><tr><td><strong>延迟</strong></td><td>较高</td><td>极低</td></tr><tr><td><strong>适用场景</strong></td><td>传统Web应用</td><td>高并发API服务</td></tr></tbody></table>
<p><strong>性能测试对比示例</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 相同的简单端点，FastAPI比Flask快3-5倍</span>
<span class="hljs-comment"># 在高并发场景下，差距可达10倍以上</span>
</code></pre>
<hr/>
<h4 data-id="heading-4"><strong>2. 代码对比：一目了然的差异</strong></h4>
<h5 data-id="heading-5"><strong>Flask 代码示例</strong></h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify

app = Flask(__name__)

<span class="hljs-comment"># 定义数据模型（需要手动验证）</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/users'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>():
    data = request.get_json()
    
    <span class="hljs-comment"># 手动验证数据</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'name'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(data[<span class="hljs-string">'name'</span>], <span class="hljs-built_in">str</span>):
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'error'</span>: <span class="hljs-string">'名称必须是字符串'</span>}), <span class="hljs-number">400</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'age'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(data[<span class="hljs-string">'age'</span>], <span class="hljs-built_in">int</span>):
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'error'</span>: <span class="hljs-string">'年龄必须是整数'</span>}), <span class="hljs-number">400</span>
    <span class="hljs-keyword">if</span> data[<span class="hljs-string">'age'</span>] &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> data[<span class="hljs-string">'age'</span>] &gt; <span class="hljs-number">150</span>:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'error'</span>: <span class="hljs-string">'年龄必须在0-150之间'</span>}), <span class="hljs-number">400</span>
    
    <span class="hljs-comment"># 处理逻辑</span>
    <span class="hljs-keyword">return</span> jsonify({
        <span class="hljs-string">'id'</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">'name'</span>: data[<span class="hljs-string">'name'</span>],
        <span class="hljs-string">'age'</span>: data[<span class="hljs-string">'age'</span>]
    })

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/users/&lt;int:user_id&gt;'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">user_id</span>):
    <span class="hljs-comment"># 同步数据库查询（会阻塞）</span>
    user = {<span class="hljs-string">'id'</span>: user_id, <span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>}
    <span class="hljs-keyword">return</span> jsonify(user)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>)
</code></pre>
<p><strong>Flask的痛点</strong>：</p>
<ul>
<li>数据验证需要大量手动代码</li>
<li>类型提示不完善，IDE无法有效辅助</li>
<li>同步模式，高并发性能差</li>
<li>没有自动生成的API文档</li>
</ul>
<hr/>
<h5 data-id="heading-6"><strong>FastAPI 代码示例</strong></h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field

app = FastAPI()

<span class="hljs-comment"># 使用Pydantic自动验证数据</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span> = Field(..., min_length=<span class="hljs-number">1</span>, max_length=<span class="hljs-number">50</span>)
    age: <span class="hljs-built_in">int</span> = Field(..., ge=<span class="hljs-number">0</span>, le=<span class="hljs-number">150</span>)

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">'/users'</span>, response_model=User</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">user: User</span>):
    <span class="hljs-comment"># 数据自动验证，无效数据自动返回400错误</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'id'</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">'name'</span>: user.name,
        <span class="hljs-string">'age'</span>: user.age
    }

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/users/{user_id}'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">user_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-comment"># 异步处理，不阻塞其他请求</span>
    user = {<span class="hljs-string">'id'</span>: user_id, <span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>}
    <span class="hljs-keyword">return</span> user

<span class="hljs-comment"># 自动生成的文档访问：http://localhost:8000/docs</span>
</code></pre>
<p><strong>FastAPI的优势</strong>：</p>
<ul>
<li>✅ 自动数据验证，代码量减少60%</li>
<li>✅ 完整的类型提示，IDE智能补全</li>
<li>✅ 异步支持，性能提升5-10倍</li>
<li>✅ 自动生成Swagger UI文档</li>
</ul>
<hr/>
<h4 data-id="heading-7"><strong>3. 数据验证对比</strong></h4>
<p>这是两个框架最大的差异之一：</p>
<p><strong>Flask需要手动验证</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Flask：每个字段都要写验证逻辑</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.get(<span class="hljs-string">'email'</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">'@'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> data[<span class="hljs-string">'email'</span>]:
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'error'</span>: <span class="hljs-string">'邮箱格式错误'</span>}, <span class="hljs-number">400</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.get(<span class="hljs-string">'password'</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(data[<span class="hljs-string">'password'</span>]) &lt; <span class="hljs-number">8</span>:
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'error'</span>: <span class="hljs-string">'密码至少8位'</span>}, <span class="hljs-number">400</span>
<span class="hljs-comment"># ... 更多字段验证</span>
</code></pre>
<p><strong>FastAPI自动验证</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># FastAPI：声明即验证</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRegister</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    email: EmailStr  <span class="hljs-comment"># 自动验证邮箱格式</span>
    password: <span class="hljs-built_in">str</span> = Field(..., min_length=<span class="hljs-number">8</span>)  <span class="hljs-comment"># 自动验证长度</span>
    age: <span class="hljs-built_in">int</span> = Field(..., ge=<span class="hljs-number">18</span>, le=<span class="hljs-number">100</span>)  <span class="hljs-comment"># 自动验证范围</span>

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">'/register'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">user: UserRegister</span>):
    <span class="hljs-comment"># 到达这里，数据已经100%符合要求</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'message'</span>: <span class="hljs-string">'注册成功'</span>}
</code></pre>
<hr/>
<h4 data-id="heading-8"><strong>4. 自动生成API文档</strong></h4>
<p>这是FastAPI的杀手级特性：</p>
<p><strong>Flask</strong>：</p>
<ul>
<li>❌ 需要手动编写文档</li>
<li>❌ 需要使用第三方库（如flask-swagger）</li>
<li>❌ 文档和代码容易不同步</li>
</ul>
<p><strong>FastAPI</strong>：</p>
<ul>
<li>启动后自动生成Swagger UI文档：<code>http://localhost:8000/docs</code></li>
<li>自动生成ReDoc文档：<code>http://localhost:8000/redoc</code></li>
<li>文档始终与代码同步</li>
</ul>
<p><strong>FastAPI自动文档界面预览</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────┐
│  FastAPI - Swagger UI                   │
├─────────────────────────────────────────┤
│                                         │
│  POST  /users      创建用户             │
│  ├─ Request Body                        │
│  │   {                                  │
│  │     <span class="hljs-string">"name"</span>: <span class="hljs-string">"string"</span>,                │
│  │     <span class="hljs-string">"age"</span>: 0                         │
│  │   }                                  │
│  └─ Try it out (可直接测试)             │
│                                         │
│  GET   /users/{<span class="hljs-built_in">id</span>}  获取用户             │
│  └─ Parameters: user_id (<span class="hljs-built_in">integer</span>)       │
│                                         │
└─────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-9"><strong>架构流程对比</strong></h3>
<p>让我们用Mermaid图直观展示两个框架的请求处理流程：</p>
<h4 data-id="heading-10"><strong>Flask 请求处理流程</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[客户端请求] --&gt; B[WSGI服务器]
    B --&gt; C[Flask路由匹配]
    C --&gt; D[视图函数处理]
    D --&gt; E{手动数据验证}
    E --&gt;|验证失败| F[返回错误响应]
    E --&gt;|验证成功| G[业务逻辑处理]
    G --&gt; H[同步数据库查询]
    H --&gt;|阻塞等待| I[返回响应]
    I --&gt; J[客户端接收]
    
    style E fill:#ff6b6b
    style H fill:#ff6b6b
    style F fill:#ffd93d
</code></pre>
<p><strong>关键问题</strong>：</p>
<ul>
<li>每个请求都会阻塞一个线程</li>
<li>手动验证容易出错且代码冗余</li>
<li>高并发时性能急剧下降</li>
</ul>
<hr/>
<h4 data-id="heading-11"><strong>FastAPI 请求处理流程</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[客户端请求] --&gt; B[ASGI服务器 Uvicorn]
    B --&gt; C[FastAPI路由匹配]
    C --&gt; D{Pydantic自动验证}
    D --&gt;|验证失败| E[自动返回422错误]
    D --&gt;|验证成功| F[异步处理函数]
    F --&gt; G[异步数据库查询]
    G --&gt;|非阻塞| H[其他请求继续处理]
    G --&gt; I[返回响应]
    I --&gt; J[客户端接收]
    
    style D fill:#51cf66
    style F fill:#51cf66
    style G fill:#51cf66
    style H fill:#4dabf7
</code></pre>
<p><strong>核心优势</strong>：</p>
<ul>
<li>异步处理，单线程处理数千并发</li>
<li>自动验证，零手动代码</li>
<li>非阻塞IO，性能极致优化</li>
</ul>
<hr/>
<h3 data-id="heading-12"><strong>性能对比：实战测试</strong></h3>
<h4 data-id="heading-13"><strong>并发能力对比</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[1000个并发请求] --&gt; B[Flask同步处理]
    A --&gt; C[FastAPI异步处理]
    
    B --&gt; D[耗时: 10秒&lt;br/&gt;CPU: 95%&lt;br/&gt;内存: 500MB]
    C --&gt; E[耗时: 2秒&lt;br/&gt;CPU: 40%&lt;br/&gt;内存: 150MB]
    
    style D fill:#ff6b6b
    style E fill:#51cf66
</code></pre>
<h4 data-id="heading-14"><strong>实际场景示例</strong></h4>
<p><strong>场景：调用外部API获取数据</strong></p>
<p><strong>Flask（同步）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/weather'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>():
    <span class="hljs-comment"># 调用外部API（阻塞3秒）</span>
    response = requests.get(<span class="hljs-string">'https://api.weather.com/...'</span>)
    <span class="hljs-comment"># 这3秒内，该线程无法处理其他请求</span>
    <span class="hljs-keyword">return</span> response.json()
</code></pre>
<p><strong>FastAPI（异步）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/weather'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>():
    <span class="hljs-comment"># 异步调用（非阻塞）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
        response = <span class="hljs-keyword">await</span> client.get(<span class="hljs-string">'https://api.weather.com/...'</span>)
    <span class="hljs-comment"># 等待期间，可以处理其他请求</span>
    <span class="hljs-keyword">return</span> response.json()
</code></pre>
<hr/>
<h3 data-id="heading-15">** 生态系统**</h3>
<h4 data-id="heading-16"/>
<p><strong>FastAPI生态</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((FastAPI))
    内置功能
      自动文档
      数据验证
      依赖注入
      异步支持
    集成工具
      SQLAlchemy异步
      Tortoise ORM
      Redis异步
      WebSocket
    现代特性
      类型提示
      异步优先
      高性能
      简洁API
</code></pre>
<hr/>
<h3 data-id="heading-17"><strong>📈 使用场景推荐</strong></h3>
<h4 data-id="heading-18"><strong>什么时候选择Flask？</strong></h4>
<p>适合场景：</p>
<ul>
<li>传统Web应用（模板渲染为主）</li>
<li>小型项目，快速原型</li>
<li>团队已有Flask经验</li>
<li>不需要高并发处理</li>
</ul>
<h4 data-id="heading-19"><strong>什么时候选择FastAPI？</strong></h4>
<p>适合场景：</p>
<ul>
<li><strong>现代API服务</strong>（RESTful API）</li>
<li><strong>高并发场景</strong>（微服务、实时系统）</li>
<li><strong>需要自动文档</strong>（团队协作）</li>
<li><strong>AI/ML模型部署</strong>（如YOLO检测服务）</li>
<li><strong>WebSocket实时通信</strong></li>
</ul>
<hr/>
<h3 data-id="heading-20">** FastAPI + YOLO：完美组合**</h3>
<p>在接下来的章节中，我们将用FastAPI构建YOLO目标检测服务，这是一个完美的应用场景：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as 客户端
    participant F as FastAPI服务
    participant Y as YOLO模型
    participant D as 数据库
    
    C-&gt;&gt;F: 上传图片/视频
    F-&gt;&gt;F: 异步验证数据
    F-&gt;&gt;Y: 异步调用模型检测
    Y--&gt;&gt;F: 返回检测结果
    F-&gt;&gt;D: 异步保存结果
    F--&gt;&gt;C: 实时返回结果
    
    Note over F,Y: 异步处理允许同时&lt;br/&gt;处理多个检测请求
</code></pre>
<p><strong>为什么YOLO需要FastAPI？</strong></p>
<ul>
<li>模型推理需要时间，异步处理避免阻塞</li>
<li>自动文档让前端开发者快速对接</li>
<li>支持视频流实时检测（WebSocket）</li>
<li>高并发处理多个检测请求</li>
</ul>
<hr/>
<h3 data-id="heading-21"><strong>💡实战建议</strong></h3>
<h4 data-id="heading-22"><strong>学习路径</strong></h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[学习FastAPI基础] --&gt; B[掌握Pydantic验证]
    B --&gt; C[理解异步编程]
    C --&gt; D[集成数据库]
    D --&gt; E[部署YOLO模型]
    E --&gt; F[构建完整项目]
    
    style A fill:#4dabf7
    style C fill:#ffd93d
    style E fill:#ff6b6b
</code></pre>
<h4 data-id="heading-23"><strong>第一个FastAPI项目</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># main.py</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI

app = FastAPI(title=<span class="hljs-string">"我的第一个FastAPI项目"</span>)

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">root</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello FastAPI!"</span>}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, q: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"item_id"</span>: item_id, <span class="hljs-string">"q"</span>: q}
</code></pre>
<p><strong>运行项目</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装FastAPI和Uvicorn</span>
pip install fastapi uvicorn

<span class="hljs-comment"># 启动服务</span>
uvicorn main:app --reload

<span class="hljs-comment"># 访问文档：http://localhost:8000/docs</span>
</code></pre>
<hr/>
<h3 data-id="heading-24"><strong>🎯 本章总结</strong></h3>













































<table><thead><tr><th>维度</th><th>Flask</th><th>FastAPI</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>开发效率</strong></td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>类型安全</strong></td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>自动文档</strong></td><td>⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>异步支持</strong></td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>学习曲线</strong></td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>生态成熟度</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<p><strong>核心结论</strong>：</p>
<blockquote>
<p>FastAPI是现代Python Web开发的最佳选择，特别适合API服务、高并发场景和AI模型部署。它用更少的代码，实现更高的性能和更好的开发体验。</p>
</blockquote>
<hr/>
<h3 data-id="heading-25">** 下一章预告**</h3>
<p>在第六章中，我们将：</p>
<ul>
<li>使用FastAPI搭建第一个Web服务</li>
<li>集成Ultralytics YOLO模型</li>
<li>实现图片上传和实时目标检测</li>
<li>构建一个完整的AI检测API</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI概念扫盲：LoRA微调原理是什么？]]></title>    <link>https://juejin.cn/post/7585463195201962034</link>    <guid>https://juejin.cn/post/7585463195201962034</guid>    <pubDate>2025-12-20T14:05:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201962034" data-draft-id="7585686247285211187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI概念扫盲：LoRA微调原理是什么？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-20T14:05:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI概念扫盲：LoRA微调原理是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T14:05:17.000Z" title="Sat Dec 20 2025 14:05:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LoRA(Low-Rank Adaptation)是一种用于微调大型语言模型(LLM)的高效方法，能够在不大幅增加计算资源的情况下，让模型快速适应新任务或新领域。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51c4da85ec324fbcbbca748dfb4ed30e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=poOcH1riiDt6MBN5ltewyT48%2FJo%3D" alt="图片" loading="lazy"/></p>
<p><strong>1.背景: 为什么需要 LoRA?</strong></p>
<p>想象一下，大型语言模型(比如 GPT-3、LLaMA)就像一辆超级跑车，里面有几十亿甚至上千亿个零件(参数)。</p>
<p>这些模型在通用任务上很强，但如果你想让它专门处理某个新任务(比如医疗问答、金融分析)，传统方法是把整个型的参数重新调整一遍。</p>
<p>这就像为了让跑车跑得更快，把发动机、轮胎、底盘全拆了重装一遍，费时费力还费钱。</p>
<p>但现实中，我们往往没有那么多资源--训练一个大模型需要超级计算机和海量时间。</p>
<p>于是，LORA 出现了。它的核心思路是: 不用动整个模型，只调整一小部分参数，就能让模型适应新任务。</p>
<p>这就像在跑车上加个小涡轮增压器，既省钱又省力，效果还不错。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p><strong>2.LoRA 的原理: 低秩适配是什么?</strong></p>
<p>翻译成中文就是“低秩适配”。这个名LORA 的全称是 Low-Rank Adaptation,字听起来有点学术，但其实原理很简单。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/656443e03f4d4622858a9edc27be0c14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=Vf8M4WilOvs68f%2B03pEGB2dvxrw%3D" alt="图片" loading="lazy"/></p>
<p><strong>模型的参数是大矩阵</strong></p>
<p>大型语言模型的参数很多是以矩阵形式存在的，比如自注意力层里的权重矩阵。这些矩阵很大，包含了模型的核心知识。</p>
<p><strong>低秩分解: 精简更新</strong></p>
<p>LORA 的聪明之处在于，它认为你不需要更新整个大矩阵，而是可以用一个“精简版“来代替。这个精简版叫“低秩矩阵”，它捕捉了大矩阵里最核心的变化信息，但参数量小得多。</p>
<p>具体操作是这样的:</p>
<p>在原始的权重矩阵(记为(W))旁边，加两个小矩阵(A)和(B); (A)和(B)的“秩”(rank)很低(比如8或16)，参数量远小于(W); 微调时，原始矩阵(W)不动，只更新(A)和(B)。</p>
<p>最后，模型的输出变成 w+AxB，这里的 AxB就像一个小助手，帮原始模型适应新任务。</p>
<p><strong>通俗比喻</strong></p>
<p>想象你有个大公司(原始模型)，要接手一个新业务。传统方法是把所有部门都改组，太麻烦。</p>
<p>LORA则是派一个小团队((A)和(B))，专门负责新业务，既高效又不影响公司核心运作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae1e471ff73457e934f270f6065129c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=Zk8ei4w9KS8jpvO0JgPuxmD8ewA%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.LoRA 的优势: 为什么这么受欢迎?</strong></p>
<p>LoRA 能火起来，是因为它有几个特别牛的优势</p>
<p>参数超少: 传统微调要更新全部参数(比如几十亿个)LORA 只更新一小部分(通常是原始模型的 0.01%到1%)存储和计算成本大幅降低。</p>
<p>训练超快: 参数少，训练自然快，普通 GPU就能跑，不用超算。</p>
<p>部署超方便: LoRA 模块像“插件“一样，可以随时插拔。比如一个基础模型，可以加载不同的 LoRA 模块来处理不同任务。</p>
<p>效果还不错: 虽然参数少，但在很多任务上，LORA的表现和全参数微调差不多，甚至更好。</p>
<p><strong>通俗比喻</strong></p>
<p>LORA 就像给手机装个小应用。不用换新手机，只需下载个插件，就能让手机多会几招，既省钱又方便。</p>
<p><strong>4. LoRA 的应用场景: 能干啥?</strong></p>
<p>LoRA 在实际中用途很广，尤其是在自然语言处理(NLP)领域。以下是几个典型场景:</p>
<p>领域适配:让通用模型变成“专家”。比如拿医疗数据微调一个 LoRA 模块，模型就能回答医学问题。</p>
<p>多任务学习:一个基础模型，通过不同 LoRA 模块处理不同任务，比如翻译、对话、文本生成。</p>
<p>个性化定制:为特定用户或场景定制模型，比如让聊天机器人模仿你的语言风格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbcaed83281249d3813cc03f842536b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=77osFiTC1IElKvqlgBjZL1t7Yh0%3D" alt="图片" loading="lazy"/></p>
<p><strong>实际例子</strong></p>
<p>假设你有个通用聊天机器人，想让它在金融领域表现更好。传统方法是用金融数据重训整个模型，费时费力。</p>
<p>LORA 则是训练一个金融领域的 LoRA 模块，插到原始模型上，机器人立马变成“金融专家”。</p>
<p><strong>5.LoRA 的工作流程: 怎么用?</strong></p>
<p>LoRA 的使用过程很简单，步骤如下</p>
<p>1.选个基础模型: 比如一个预训练好的大模型(LLaMA、GPT等)</p>
<p>2.加 LoRA 模块: 在模型的某些层(比如自注意力层)旁边加两个小矩阵(A)和(B)。</p>
<p>冻结原始参数: 训练时，原始模型的参数不动，只更新(A)和(B)。</p>
<p>微调: 用新任务的数据训练(A)和(B)，让它们学会A.新技能。</p>
<p>推理: 用的时候，把 LoRA 模块加到原始模型上，模型就能干新活了。</p>
<p><strong>通俗比喻</strong></p>
<p>你有个智能音箱，想让它会讲笑话。不用把音箱拆了重装，只需下载个“笑话插件”(LORA 模块)，插上就能讲笑话。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec0d84a409ff41248552b1ed4f4183f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=8MB5XxUXZYsLD1izuPg9%2FZv05Js%3D" alt="图片" loading="lazy"/></p>
<p><strong>6.LoRA 的数学细节: 想深入了解?</strong></p>
<p>如果你对数学感兴趣，可以看看 LoRA 的简单原理(不感兴趣可以跳过)</p>
<p>原始权重矩阵(W)是dxd的，参数量是 d^2(比如，d=1000 参数量就是 100 万)。</p>
<p>LORA加了Delta(w)=AxB，其中(A)是d x r(B)是rxd,(r)很小(比如8)。参数量变成 2xdxr(比如)2x1000 x8=16000 ，远小于 d^2</p>
<p>简单说，LoRA 用很少的参数(比如1.6万个)代替了更新全部参数(100 万个)，但效果依然很好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71f936604d384417bbd7bedc1c648e36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766844317&amp;x-signature=4dQUjGpQb88rj17gtFl%2BMrir2vw%3D" alt="图片" loading="lazy"/></p>
<p><strong>7.LoRA 的局限性: 有啥不足?</strong></p>
<p>LORA 虽然好用，但也不是万能的:</p>
<p>效果有限: 某些复杂任务上，LORA 可能不如全参数微调。</p>
<p>超参数麻烦: 比如秩(r)的选择，太小效果不好，太大参数又多，需要试错。</p>
<p>位置选择: LORA 加在哪些层效果最好，靠经验或实验。</p>
<p>为了改进这些问题，出现了 LORA+、DORA 等升级版性能更强，适应性更好。</p>
<p><strong>8.总结: LORA 到底是啥?</strong></p>
<p>LoRA 是一种高效微调大型语言模型的方法，通过在原始模型旁边加两个小矩阵(低秩矩阵)，让模型快速适应新任务。</p>
<p>它的优势是参数少、训练快、部署方便，特别适合资源有限或需要快速适应的场景。</p>
<p>简单来说，LoRA 就像给模型装了个“外挂”，不用大动干戈，就能让模型学会新技能。</p>
<p><strong>通俗总结</strong></p>
<p>LORA 是模型的“涡轮增压器”，小投入大回报，让微调变得像装插件一样简单。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现在还有Java面试者不会开发Starter组件]]></title>    <link>https://juejin.cn/post/7585534343561396274</link>    <guid>https://juejin.cn/post/7585534343561396274</guid>    <pubDate>2025-12-20T14:21:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585534343561396274" data-draft-id="7585706951603175450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现在还有Java面试者不会开发Starter组件"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-20T14:21:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱海贼的无处不在"/> <meta itemprop="url" content="https://juejin.cn/user/2359988032644541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现在还有Java面试者不会开发Starter组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359988032644541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱海贼的无处不在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T14:21:46.000Z" title="Sat Dec 20 2025 14:21:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景说明：真实的面试感受</h2>
<p>最近在公司面试了一批 <strong>4–7 年开发经验</strong>的后端工程师，简历整体并不差，做过的项目也不少，但有一个问题让我印象非常深刻：</p>
<blockquote>
<p><strong>几乎没有人能把「如何开发一个 Spring Boot Starter」以及相关原理说清楚。</strong></p>
</blockquote>
<p>进一步交流后发现，这类候选人普遍有一个共同点：<br/>
<strong>长期处在外包环境或业务高度固化的项目中</strong>，技术使用停留在“会用框架”，但很少去思考：</p>
<ul>
<li>
<p>框架能力是如何被封装出来的</p>
</li>
<li>
<p>通用技术能力如何被复用、标准化</p>
</li>
<li>
<p>一个组件是如何做到“即插即用、不侵入业务”的</p>
</li>
</ul>
<p>在面试中，这直接体现在：<br/>
<strong>对 Spring Boot Starter 的理解模糊、表达混乱、缺乏工程抽象意识</strong>，最终只能给出不通过的结论。</p>
<p>其实，<strong>开发一个 Spring Boot Starter 本身并不难</strong>。<br/>
真正难的不是 API，而是：</p>
<blockquote>
<p><strong>你有没有在技术领域进行持续、主动的学习和抽象。</strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bedfdcbc0094013a52562f03151ed91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845306&amp;x-signature=FfBPUgluilk9Bl0SH%2F8DH%2B%2FgpVY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、开发 Spring Boot Starter 的核心步骤</h2>
<p>我认为<strong>任何一个后端工程师都应该能说清楚、并且实践过的</strong> Starter 开发流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6861139e51a404085ca0d39df3f9d8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845306&amp;x-signature=o7Q%2F1RSRjud3JGp77BU6XbM9nwE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">第一步：明确 Starter 提供的技术能力及其边界</h3>
<p>在写任何代码之前，首先要想清楚三件事：</p>
<ul>
<li>
<p>Starter <strong>解决什么技术问题</strong></p>
</li>
<li>
<p>Starter <strong>不解决什么问题</strong></p>
</li>
<li>
<p>Starter 是否只是提供 <strong>默认能力</strong>，而不是强制能力</p>
</li>
</ul>
<h3 data-id="heading-3">第二步：创建 xxx-spring-boot-starter 包</h3>
<p>Starter 本身是一个<strong>对外暴露的入口模块</strong>，它的职责非常简单：</p>
<ul>
<li>
<p>作为业务系统的依赖入口</p>
</li>
<li>
<p>聚合所需的依赖</p>
</li>
<li>
<p>不承载具体实现逻辑</p>
</li>
</ul>
<p>这一层存在的意义是：<br/>
<strong>让使用方“只引一个依赖”就能获得能力</strong>。</p>
<h3 data-id="heading-4">第三步：创建 XxxxProperties 与 XxxxAutoConfiguration</h3>
<p>这是 Starter 的核心实现部分：</p>
<ul>
<li>
<p><code>XxxxProperties</code>：</p>
<ul>
<li>
<p>用于绑定外部配置</p>
</li>
<li>
<p>定义统一的配置前缀</p>
</li>
<li>
<p>提供默认配置值</p>
</li>
</ul>
</li>
<li>
<p><code>XxxxAutoConfiguration</code>：</p>
<ul>
<li>
<p>作为自动装配入口</p>
</li>
<li>
<p>负责初始化 Starter 提供的技术能力</p>
</li>
<li>
<p>向 Spring 容器注册默认 Bean</p>
</li>
</ul>
</li>
</ul>
<p>这一层的关键目标只有一个：<br/>
<strong>让技术能力在合适的时机被自动注入到容器中。</strong></p>
<h3 data-id="heading-5">第四步：通过条件控制 Starter 是否生效</h3>
<p>一个合格的 Starter <strong>一定不是无条件生效的</strong>。</p>
<p>常见的控制方式包括：</p>
<ul>
<li>
<p>是否开启：<code>enabled</code> 总开关</p>
</li>
<li>
<p>是否存在某些依赖</p>
</li>
<li>
<p>用户是否已经定义了同类 Bean</p>
</li>
<li>
<p>当前运行环境是否满足要求</p>
</li>
</ul>
<p>核心原则只有一句话：</p>
<blockquote>
<p><strong>Starter 提供的是“兜底能力”，不是“强制接管”。</strong></p>
</blockquote>
<h3 data-id="heading-6">第五步：通过 spring.factories 声明自动装配类</h3>
<p>要让 Spring Boot 在启动过程中发现你的自动配置类，需要：</p>
<ul>
<li>
<p>在指定位置声明自动配置入口</p>
</li>
<li>
<p>让其参与 Spring Boot 的自动装配流程</p>
</li>
</ul>
<p>这一步的作用是：<br/>
<strong>把你的 Starter 挂载到 Spring Boot 的自动配置体系中。</strong></p>
<h3 data-id="heading-7">第六步：验证三种关键使用场景</h3>
<p>一个 Starter 是否合格，至少要验证三种场景：</p>
<ol>
<li>
<p><strong>完全不写任何配置</strong>，应用是否能正常启动</p>
</li>
<li>
<p><strong>用户自定义 Bean</strong>，是否优先生效</p>
</li>
<li>
<p><strong>关闭 enabled 开关</strong>，Starter 是否彻底失效</p>
</li>
</ol>
<h2 data-id="heading-8">三、面试中我重点关注的几个问题</h2>
<p>在面试中，我通常会围绕 Starter 追问下面这些问题，用来判断候选人是否真正理解过。</p>
<ul>
<li>
<p><strong>Starter 和普通 jar 的核心区别是什么？</strong></p>
</li>
<li>
<p><strong>Spring Boot 是如何发现并加载 Starter 的？</strong></p>
</li>
<li>
<p><strong>如果用户自己定义了相同类似的 Bean，你的 Starter 如何处理？</strong></p>
</li>
<li>
<p><strong>Starter 为什么一定要有 enabled 开关？</strong></p>
</li>
<li>
<p><strong>如何避免 Starter 对业务产生侵入？</strong></p>
</li>
<li>
<p><strong>你在写 Starter 时遇到过什么问题？</strong></p>
</li>
<li>
<p><strong>Starter 组件中的 <code>spring.factories</code> 是否有必要存在？为什么？</strong></p>
</li>
</ul>
<p>这些问题的目的并不是刁难人，而是判断：</p>
<blockquote>
<p>你是“用过 Starter”，还是“设计过 Starter”。</p>
</blockquote>
<h2 data-id="heading-9">四、技术能力来自持续学习与拆解优秀项目</h2>
<p>技术能力并不是只靠项目堆出来的。<br/>
<strong>长期在固定模式的项目里，很容易形成技术惰性。</strong></p>
<p>如果想真正理解 Starter、自动装配、组件化设计，<strong>最有效的方式就是看成熟项目的实现</strong>。</p>
<p>比如这个非常值得学习的项目：</p>
<blockquote>
<p><strong>admin4j-framework</strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fadmin4j%2Fadmin4j-framework" target="_blank" title="https://github.com/admin4j/admin4j-framework" ref="nofollow noopener noreferrer">github.com/admin4j/adm…</a></p>
</blockquote>
<p>这个项目本身就是一个 <strong>Starter 组件集合</strong>，涵盖了：</p>
<ul>
<li>
<p>安全</p>
</li>
<li>
<p>日志追踪</p>
</li>
<li>
<p>多租户</p>
</li>
<li>
<p>数据脱敏</p>
</li>
<li>
<p>中间件集成</p>
</li>
</ul>
<p>非常适合用来学习：</p>
<ul>
<li>
<p>Starter 的模块拆分方式</p>
</li>
<li>
<p>自动配置的设计思路</p>
</li>
<li>
<p>条件化生效与边界控制</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d519b2016044647afbfe302ca70a2f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766845306&amp;x-signature=LmyW6wzTjJTAQk3GprY8eDpVltY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">五、结语</h2>
<p>Spring Boot Starter 不是一个“高难度技术点”，<br/>
但它是一个<strong>非常好的工程能力分水岭</strong>。</p>
<blockquote>
<p><strong>是否愿意把“用的技术”，变成“可复用的能力”，<br/>
往往决定了一个工程师能走多远。</strong></p>
</blockquote>
<p>如果你记住上面这 6 步，并且自己完整动手实现过一次，<br/>
无论是面试，还是日常架构设计，都会明显不一样。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 大厂的“护城河”，也会成为它们的束缚]]></title>    <link>https://juejin.cn/post/7585485074038145030</link>    <guid>https://juejin.cn/post/7585485074038145030</guid>    <pubDate>2025-12-20T14:46:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038145030" data-draft-id="7585474459776958500" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 大厂的“护城河”，也会成为它们的束缚"/> <meta itemprop="keywords" content="人工智能,创业"/> <meta itemprop="datePublished" content="2025-12-20T14:46:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 大厂的“护城河”，也会成为它们的束缚
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T14:46:36.000Z" title="Sat Dec 20 2025 14:46:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，我的一个根深蒂固的认知被轻轻撬动了一下。</p>
<p>长久以来，我一直笃信一个“常识”：<strong>一旦大厂下场做 AI，创业团队基本就凉了</strong>。</p>
<p>理由很朴素——大厂有钱、有人、有数据、有算力，还有现成的用户和生态。它们只要看中某个方向，调集资源一压，创业公司那点微弱的火苗，不是被扑灭，就是被收编。</p>
<p>这种“大厂碾压论”在很多领域都成立，久而久之，我甚至把它当成了默认逻辑。</p>
<p>但前几天看到一个观点，让我愣了一下：</p>
<p>“<strong>大厂有自有模型的优势，但也被自己的模型‘绑架’了。</strong>”</p>
<p>这句话乍听简单，细想却很有嚼头。</p>
<p>比如 <code>OpenAI</code>，哪怕它私下承认 <code>Claude</code> 在某些任务上更稳、推理更清晰、幻觉更少，它也不可能在自家产品里调用 <code>Anthropic</code> 的 <code>API</code>。</p>
<p>不是技术不行，而是身份不允许。</p>
<p>它的整个品牌、叙事、估值，都建立在“我们拥有世界最好的模型”这个前提上。一旦它开始用别人的模型，等于动摇了自己的根基。</p>
<p>而创业团队恰恰相反 —— 它们没有“必须用自己模型”的包袱。谁家模型效果好、成本低、响应快，就用谁的。今天用 GPT，明天切 Claude，后天试试 DeepSeek。</p>
<p>甚至，都可以在一个业务流程的<strong>不同阶段调用不同的模型</strong>，达到各家产品<strong>优势的充分利用</strong>。</p>
<p>换句话说，大厂要证明“我的引擎天下第一”，而创业团队只需回答“这辆车能不能把你安全快速地送到目的地”。</p>
<p>原来不是赛道被封死，而是我看窄了。</p>
<p>大厂忙着造自己的航母，而我们可以自由拼装引擎、船体和导航系统——用最好的零件，造一艘真正服务用户的快艇。</p>
<p>也许，我们还能更快到对岸呢~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Hooks 深度理解：useState / useEffect 如何管理副作用与内存]]></title>    <link>https://juejin.cn/post/7585484081436033075</link>    <guid>https://juejin.cn/post/7585484081436033075</guid>    <pubDate>2025-12-20T13:32:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585484081436033075" data-draft-id="7585686247270006793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Hooks 深度理解：useState / useEffect 如何管理副作用与内存"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-20T13:32:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Hooks 深度理解：useState / useEffect 如何管理副作用与内存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T13:32:06.000Z" title="Sat Dec 20 2025 13:32:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🤯你以为 React Hooks 只是语法糖？</h2>
<h3 data-id="heading-1">不——它们是在帮你对抗「副作用」和「内存泄漏」</h3>
<blockquote>
<p><strong>如果你只把 Hooks 当成“不用 class 了”，<br/>
那你可能只理解了 React 的 10%。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🚀 一、一个“看起来毫无问题”的组件</h3>
<p>我们先从一个你我都写过无数次的组件开始：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">App</span>() {
  const <span class="hljs-selector-attr">[num, setNum]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>)

  return (
    &lt;div onClick={() =&gt; <span class="hljs-built_in">setNum</span>(num + <span class="hljs-number">1</span>)}&gt;
      {num}
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  )
}
</code></pre>
<p>看起来非常完美：</p>
<ul>
<li>✅ 没有 class</li>
<li>✅ 没有 this</li>
<li>✅ 就是一个普通函数</li>
</ul>
<p>但问题是：</p>
<blockquote>
<p><strong>React 为什么要发明 Hooks？</strong><br/>
<strong>useState / useEffect 到底解决了什么“本质问题”？</strong></p>
</blockquote>
<p>答案其实只有一个关键词👇</p>
<hr/>
<h3 data-id="heading-3">💣 二、React 世界的终极敌人：副作用（Side Effect）</h3>
<p>React 背后有一个<strong>很少被明说，但极其重要的信仰</strong>：</p>
<blockquote>
<p><strong>组件 ≈ 纯函数</strong></p>
</blockquote>
<h4 data-id="heading-4">🧠 什么是纯函数？</h4>
<ul>
<li>相同输入 → 永远相同输出</li>
<li>不依赖外部变量</li>
<li>不产生额外影响（I/O、定时器、请求）</li>
</ul>
<pre><code class="hljs language-css" lang="css">function add(<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) {
  return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
}
</code></pre>
<p>而理想中的 React 组件是：</p>
<pre><code class="hljs language-perl" lang="perl">(props + <span class="hljs-keyword">state</span>) → JSX
</code></pre>
<blockquote>
<p><strong>React 希望你“只负责算 UI”，<br/>
而不是在渲染时干别的事。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">⚠️ 但现实是：你必须干“坏事”</h3>
<p>真实业务中，你不可避免要做这些事：</p>
<ul>
<li>🌐 请求接口</li>
<li>⏱️ 设置定时器</li>
<li>🎧 事件监听</li>
<li>📦 订阅 / 取消订阅</li>
<li>🧱 操作 DOM</li>
</ul>
<p>这些行为有一个共同点👇</p>
<blockquote>
<p>❌ <strong>它们都不是纯函数行为</strong><br/>
✅ <strong>它们都是副作用</strong></p>
</blockquote>
<p>如果你直接把副作用写进组件函数，会发生什么？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>) <span class="hljs-comment">// ❌</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> /&gt;</span></span>
}
</code></pre>
<p>👉 每一次 render 都请求<br/>
👉 状态更新 → 再 render → 再请求<br/>
👉 <strong>组件直接失控</strong></p>
<hr/>
<h3 data-id="heading-6">🧯 三、useEffect：副作用的“隔离区”</h3>
<p><code>useEffect</code> 的存在，本质只干一件事：</p>
<blockquote>
<p><strong>把副作用从“渲染阶段”挪走</strong></p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 副作用逻辑</span>
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p>💡 <strong>一句话理解：</strong></p>
<blockquote>
<p><strong>render 阶段必须纯，<br/>
effect 阶段允许脏。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-7">📦 四、依赖数组不是细节，而是“副作用边界”</h3>
<h4 data-id="heading-8">1️⃣ 只执行一次（挂载）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>('mounted')
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<ul>
<li>只在组件挂载时执行</li>
<li>类似 Vue 的 <code>onMounted</code></li>
</ul>
<hr/>
<h4 data-id="heading-9">2️⃣ 依赖变化才执行</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>(num)
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<ul>
<li><code>num</code> 变化 → 执行</li>
<li>不变 → 不执行</li>
</ul>
<blockquote>
<p><strong>依赖数组的本质是：<br/>
“这个副作用依赖谁？”</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-10">3️⃣ 不写依赖项？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'every render'</span>)
})
</code></pre>
<p>👉 每次 render 都执行<br/>
👉 <strong>99% 的时候是性能陷阱</strong></p>
<hr/>
<h3 data-id="heading-11">💥 五、90% 新手都会踩的坑：内存泄漏</h3>
<p>来看一个<strong>极其经典</strong>的 Hooks 错误写法👇</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(num)
  }, <span class="hljs-number">1000</span>)
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<p>你觉得这段代码有问题吗？</p>
<blockquote>
<p><strong>有，而且非常致命。</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-12">❌ 问题在哪里？</h4>
<ul>
<li><code>num</code> 每变一次</li>
<li>effect 重新执行</li>
<li>新建一个定时器</li>
<li>❗旧定时器还活着</li>
</ul>
<p>结果就是：</p>
<ul>
<li>⏱️ 定时器越来越多</li>
<li>📈 内存持续上涨</li>
<li>💥 控制台疯狂打印</li>
<li>🧠 <strong>内存泄漏</strong></li>
</ul>
<hr/>
<h3 data-id="heading-13">🧹 六、useEffect return：副作用的“善终机制”</h3>
<p>React 给你准备了一个<strong>官方清理通道</strong>👇</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(num)
  }, <span class="hljs-number">1000</span>)

  return () =&gt; {
    <span class="hljs-built_in">clearInterval</span>(timer)
  }
}, <span class="hljs-selector-attr">[num]</span>)
</code></pre>
<h4 data-id="heading-14">⚠️ 重点来了</h4>
<blockquote>
<p><strong>return 的函数不是“卸载时才执行”</strong></p>
</blockquote>
<p>而是：</p>
<blockquote>
<p><strong>下一次 effect 执行前，一定会先执行它</strong></p>
</blockquote>
<p>React 内部顺序是这样的：</p>
<ol>
<li>执行上一次 effect 的 cleanup</li>
<li>再执行新的 effect</li>
</ol>
<p>👉 <strong>这就是 Hooks 防内存泄漏的核心设计</strong></p>
<hr/>
<h3 data-id="heading-15">🧠 七、useState：为什么初始化不能异步？</h3>
<p>你在学习 Hooks 时，一定问过这个问题👇</p>
<blockquote>
<p>❓ 我能不能在 useState 初始化时请求接口？</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">useState(async () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = await fetchData()
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>
})
</code></pre>
<p>答案很干脆：</p>
<blockquote>
<p>❌ <strong>不行</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-16">🤔 为什么不行？</h4>
<p>因为 React 必须保证：</p>
<ul>
<li>首次 render <strong>立即有确定的 state</strong></li>
<li>异步结果是不确定的</li>
<li>state 一旦初始化，必须是同步值</li>
</ul>
<p>React 允许的只有这种👇</p>
<pre><code class="hljs language-css" lang="css">useState(() =&gt; {
  const <span class="hljs-selector-tag">a</span> = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>
  const <span class="hljs-selector-tag">b</span> = <span class="hljs-number">2</span> + <span class="hljs-number">3</span>
  return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
})
</code></pre>
<p>💡 这叫 <strong>惰性初始化</strong><br/>
💡 但前提是：<strong>同步 + 纯函数</strong></p>
<hr/>
<h3 data-id="heading-17">🌐 八、那异步请求到底该写哪？</h3>
<p>答案只有一个地方：</p>
<blockquote>
<p><strong>useEffect</strong></p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  async function <span class="hljs-built_in">query</span>() {
    const data = await <span class="hljs-built_in">queryData</span>()
    <span class="hljs-built_in">setNum</span>(data)
  }
  <span class="hljs-built_in">query</span>()
}, <span class="hljs-selector-attr">[]</span>)
</code></pre>
<p>🎯 <strong>这是 React 官方推荐模式</strong></p>
<ul>
<li>state 初始化 → 确定</li>
<li>异步请求 → 副作用</li>
<li>数据回来 → 更新状态</li>
</ul>
<hr/>
<h3 data-id="heading-18">🔄 九、为什么 setState 可以传函数？</h3>
<pre><code class="hljs language-ini" lang="ini">setNum(<span class="hljs-attr">prev</span> =&gt; prev + <span class="hljs-number">1</span>)
</code></pre>
<p>这不是“花里胡哨”，而是<strong>并发安全设计</strong>。</p>
<p>React 内部可能会：</p>
<ul>
<li>合并多次更新</li>
<li>延迟执行 setState</li>
</ul>
<p>如果你直接用 <code>num + 1</code>，很可能拿到的是旧值。</p>
<blockquote>
<p><strong>函数式 setState = 永远安全</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-19">🏁 十、Hooks 的真正价值（总结）</h3>
<p>如果你只把 Hooks 当成：</p>
<blockquote>
<p>“不用写 class 了”</p>
</blockquote>
<p>那你只看到了表面。</p>
<h4 data-id="heading-20">Hooks 真正解决的是：</h4>
<ul>
<li>🧩 <strong>状态如何在函数中稳定存在</strong></li>
<li>🧯 <strong>副作用如何被精确控制</strong></li>
<li>🧠 <strong>生命周期如何显式建模</strong></li>
<li>🔒 <strong>内存泄漏如何被主动规避</strong></li>
</ul>
<hr/>
<h3 data-id="heading-21">✨ 最后的掘金金句</h3>
<blockquote>
<p><strong>useState 解决的是：数据如何“活着”</strong><br/>
<strong>useEffect 解决的是：副作用如何“善终”</strong></p>
<p>React Hooks 不只是语法升级，<br/>
而是一场从“命令式生命周期”<br/>
到“声明式副作用管理”的革命。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 介绍]]></title>    <link>https://juejin.cn/post/7585458459166359586</link>    <guid>https://juejin.cn/post/7585458459166359586</guid>    <pubDate>2025-12-20T12:18:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585458459166359586" data-draft-id="7585476892976070690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 介绍"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-20T12:18:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子洋"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子洋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T12:18:00.000Z" title="Sat Dec 20 2025 12:18:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>这周在组内做了一次关于 <strong>Agent 设计模式</strong> 的分享，主要介绍和讲解了 <strong>ReAct 模式</strong> 与 <strong>P&amp;A（Plan and Execute）模式</strong>。我计划将这次分享拆分为三篇文章，对我在组会中讲解的内容进行更加系统和细致的整理。</p>
<p>在正式进入具体的 Agent 模式实现之前，有一个绕不开的问题需要先回答清楚：</p>
<blockquote>
<p><strong>什么是 AI Agent？它解决了什么问题？以及在近几年 AI 技术与应用快速演进的过程中，AI 应用的开发范式经历了哪些关键变化？</strong></p>
</blockquote>
<p>这一篇将不直接展开某一种 Agent 模式的实现细节，而是先回到更宏观的视角，从 <strong>AI 应用形态与工程范式的演进</strong> 入手，梳理 Agent 出现的技术背景与必然性。</p>
<p>需要说明的是，下文对 AI 应用演进阶段的划分，是一种<strong>以“应用开发范式”为核心的抽象总结</strong>。真实的技术演进在时间上存在明显重叠，但这种阶段化的叙述有助于我们理解：<strong>为什么 Agent 会在当下成为主流方向</strong>。</p>
<h2 data-id="heading-1">AI 应用的发展历程</h2>
<h3 data-id="heading-2">第一阶段：提示词工程</h3>
<p>2022 年 11 月，GPT-3.5 发布后，大模型开始从研究领域进入大众视野。对开发者来说，这是第一次可以在实际产品中直接使用通用语言模型。</p>
<p>这一阶段的 AI 应用形态非常简单，大多数产品本质上都是一个对话界面：<code>用户输入问题</code> → <code>模型生成回答</code> → <code>结束</code>。</p>
<p>很快，围绕 Prompt 的工程实践开始出现。由于模型对上下文非常敏感，<strong>系统提示词（System Prompt）成为当时最直接、也最有效的控制手段</strong>。常见的做法是通过提示词约束模型的角色、输出形式和关注重点，例如：</p>
<blockquote>
<p>“你是一个资深的前端开发工程师，请严格以 JSON 格式输出结果……”</p>
</blockquote>
<p>这类“身份面具”式的提示，本质上是通过上下文约束来减少模型输出的发散性，让结果更贴近预期。在这一阶段，也陆续出现了 <strong>Chain-of-Thought、Few-shot Prompting</strong> 等推理增强技巧，但它们依然属于<strong>单次生成模式</strong>：模型在一次调用中完成全部推理，过程中无法获得外部反馈，也无法根据中间结果调整策略。</p>
<h3 data-id="heading-3">第二阶段：RAG</h3>
<p>当 AI 开始被用于真实业务场景时，很快暴露出两个问题：<strong>模型不了解私有知识</strong>，以及<strong>生成结果难以校验</strong>。以 GPT-3.5 为例，它的训练数据截止在 21 年左右，对于新技术以及企业内部文档、业务规则更是不了解，直接使用往往不可控。</p>
<p>RAG（Retrieval-Augmented Generation）是在这种背景下被广泛采用的方案。它的核心做法是：</p>
<ul>
<li>将私有知识进行切分和向量化存储；</li>
<li>用户提问时，先进行相似度检索；</li>
<li>将命中的内容作为上下文提供给模型，再由模型完成生成。</li>
</ul>
<p>通过这种方式，模型不需要记住所有知识，而是在生成时按需获取参考信息。</p>
<p>RAG 的价值不仅在于补充新知识，更重要的是带来了<strong>可控性和可追溯性</strong>：生成内容可以明确对应到原始文档，这一点在企业场景中尤为关键。</p>
<h3 data-id="heading-4">第三阶段：Tool Calling</h3>
<p>如果说 RAG 让模型能够“查资料”，那么 <strong>Function / Tool Calling</strong> 则让模型开始能够“做事情”。</p>
<p>在这一阶段，开发者会把可用能力（如查询数据库、调用接口、执行脚本）以结构化的方式提供给模型，包括函数名、参数说明和功能描述。模型在理解用户意图后，可以返回一个明确的工具调用请求，再由程序完成实际执行。</p>
<p>这一能力的出现，标志着 <strong>AI 第一次在工程上具备了可靠调用外部系统的能力</strong>。它不再只是一个聊天机器人，而是一个可以触发真实世界动作的“控制器”，这也是后续 Agent 能够落地的关键技术支撑。</p>
<h3 data-id="heading-5">第四阶段：AI Workflow</h3>
<p>当 RAG 能力和 Tool Calling 能力逐渐成熟后，开发者开始尝试把多个步骤组合起来，形成完整的业务流程。这催生了以 Dify、Coze 为代表的 <strong>AI Workflow</strong> 范式。</p>
<p>在 Workflow 模式下，一个 AI 应用会被拆解为多个固定节点，并按照预设顺序执行，例如：检索 → 判断 → 工具调用 → 汇总输出。</p>
<p>Workflow 的优势非常明显：</p>
<ul>
<li>流程清晰，行为可预期；</li>
<li>易于测试和运营；</li>
<li>对非工程人员友好。</li>
</ul>
<p>但问题也同样明显：流程完全由人设计，模型只是执行者。无论问题复杂与否，都必须走完整条路径。这种方式在应对高度动态或非标准任务时，灵活性有限。</p>
<h3 data-id="heading-6">第五阶段：Agent</h3>
<p>在 Agent 出现之前，大多数 AI 应用仍然遵循一种典型模式：<code>输入</code> → <code>单次/编排好的推理</code> → <code>输出</code>。</p>
<p>而 Agent 的出现，本质上是<strong>将“任务编排”的控制权从人类手中交还给了 AI</strong>。在 Agent 架构下，AI 不再是被动执行一段代码，而是一个具备以下核心能力的闭环系统：</p>
<ul>
<li>将复杂目标拆解为多个可执行步骤；</li>
<li>根据工具执行结果调整后续行动；</li>
<li>在失败时尝试修正策略；</li>
<li>在多步过程中维护上下文状态。</li>
</ul>
<p>这些能力并不是一次模型调用完成的，而是通过多轮推理与执行形成闭环。也正是在这一点上，Agent 与前面的应用形态拉开了差距。</p>
<h2 data-id="heading-7">Agent 设计模式解决的问题</h2>
<p>当 Agent 开始承担更复杂的任务时，问题也随之出现：</p>
<ul>
<li>多步推理容易跑偏；</li>
<li>执行失败后缺乏统一的修正策略；</li>
<li>成本和稳定性难以控制。</li>
</ul>
<p><strong>Agent 设计模式的作用，就是把这些反复出现的问题抽象成可复用的结构。</strong></p>
<p>无论是 <strong>ReAct</strong>，还是 <strong>Plan and Execute</strong>，它们关注的核心并不是“让模型更聪明”，而是：<strong>如何在工程上组织模型的推理、行动和反馈过程，使系统整体可控、可维护。</strong></p>
<p>理解这些模式，有助于我们在构建 Agent 系统时少走弯路，而不是每一次都从零开始设计整套交互与控制逻辑。</p>
<h2 data-id="heading-8">结语</h2>
<p>从最初基于 Prompt 的简单对话，到如今具备一定自主能力的 Agent，我们看到的不只是模型能力的提升，更是 AI 在实际使用方式上的变化。</p>
<p>回顾整个过程会发现，很多关键技术并不是最近才出现的。RAG 的核心思路早在几年前就已经被提出，ReAct 也并非新概念，只是在最近随着模型推理能力提升、工具链逐渐成熟，才真正具备了工程落地的条件。很多时候，并不是想法不存在，而是时机还没到。</p>
<p>理解这些演进背景，有助于我们判断哪些能力是短期噱头，哪些是长期方向。下一篇文章将聚焦 Agent 设计模式中最常见、也最实用的 ReAct 模式，结合实际实现，看看它是如何让 AI 在执行任务的过程中逐步思考、不断调整策略的。</p>
<h2 data-id="heading-9">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.promptingguide.ai%2F" target="_blank" title="https://www.promptingguide.ai/" ref="nofollow noopener noreferrer">提示工程指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578838" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578838" ref="nofollow noopener noreferrer">Chain-of-Thought Prompting Elicits Reasoning in Large Language Models.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8579062" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8579062" ref="nofollow noopener noreferrer">Language Models are Few-Shot Learners</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578906%26activeReadTab%3Dchat" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578906&amp;activeReadTab=chat" ref="nofollow noopener noreferrer">Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578958%26activeReadTab%3Dchat" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578958&amp;activeReadTab=chat" ref="nofollow noopener noreferrer">Toolformer: Language Models Can Teach Themselves to Use Tools.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8578981" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8578981" ref="nofollow noopener noreferrer">A Survey on Large Language Model based Autonomous Agents.</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[LinearToGammaSpaceExact节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7585484081435639859</link>    <guid>https://juejin.cn/post/7585484081435639859</guid>    <pubDate>2025-12-20T11:07:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585484081435639859" data-draft-id="7585463258691174409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[LinearToGammaSpaceExact节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-20T11:07:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[LinearToGammaSpaceExact节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T11:07:21.000Z" title="Sat Dec 20 2025 11:07:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0">线性颜色空间与伽马颜色空间基础概念</h2>
<p>在计算机图形学中，颜色空间的管理是渲染流程中至关重要的环节。理解线性颜色空间和伽马颜色空间的区别对于创建逼真的渲染效果至关重要。</p>
<p>线性颜色空间指的是颜色数值与实际物理光强呈线性关系的颜色表示方式。在这种空间中，颜色值0.5表示的光强正好是颜色值1.0的一半。这种表示方式符合物理世界的真实光照行为，在渲染计算中能够产生准确的数学结果。</p>
<p>伽马颜色空间则是为了适应传统显示设备的非线性特性而设计的颜色表示系统。由于CRT显示器以及其他显示设备对输入信号的响应不是线性的，实际上显示设备会对输入信号进行伽马变换。在伽马空间中，颜色数值与最终显示的亮度之间不是简单的线性关系，而是遵循一个幂函数关系。</p>
<h3 data-id="heading-1">伽马校正的历史背景</h3>
<p>伽马校正的概念起源于早期的CRT显示器时代。CRT显示器具有固有的非线性响应特性，其亮度输出与输入电压之间的关系大致符合幂函数规律，指数约为2.2。这意味着即使输入线性的颜色信号，显示器也会自动应用一个近似的伽马变换。</p>
<p>为了补偿这种非线性，图像和视频内容在创建时就会预先应用一个反向的伽马变换（指数约为1/2.2），这样当内容在显示器上显示时，两者的变换相互抵消，最终用户看到的就是正确的线性亮度关系。这种预处理过程就是所谓的伽马校正。</p>
<h3 data-id="heading-2">现代渲染中的伽马处理</h3>
<p>在现代渲染管线中，虽然CRT显示器已逐渐被LCD、OLED等新技术取代，但伽马校正的概念仍然非常重要。主要原因包括：</p>
<ul>
<li>向后兼容性：大量现有的图像内容和标准都是基于伽马空间设计的</li>
<li>感知均匀性：人类视觉系统对亮度的感知也是非线性的，伽马编码可以更有效地利用有限的比特深度</li>
<li>行业标准：sRGB等现代颜色标准仍然建立在伽马编码的基础上</li>
</ul>
<h2 data-id="heading-3">LinearToGammaSpaceExact节点核心功能</h2>
<p>LinearToGammaSpaceExact节点是Unity URP Shader Graph中专门用于颜色空间转换的工具节点。该节点执行从线性颜色空间到伽马颜色空间的精确数学转换，确保颜色数据在不同空间之间的准确转换。</p>
<h3 data-id="heading-4">数学原理</h3>
<p>LinearToGammaSpaceExact节点实现的数学转换基于标准的sRGB伽马校正公式。转换过程使用分段函数来精确处理整个数值范围：</p>
<p>对于输入值小于或等于0.0031308的情况：</p>
<pre><code class="hljs">伽马值 = 12.92 × 线性值
</code></pre>
<p>对于输入值大于0.0031308的情况：</p>
<pre><code class="hljs language-scss" lang="scss">伽马值 = <span class="hljs-number">1.055</span> × 线性值^(<span class="hljs-number">1</span>/<span class="hljs-number">2.4</span>) - <span class="hljs-number">0.055</span>
</code></pre>
<p>这种分段处理确保了在低亮度区域的线性关系和较高亮度区域的幂函数关系之间的平滑过渡，符合sRGB标准规范。</p>
<h3 data-id="heading-5">与近似方法的区别</h3>
<p>Unity提供了两种伽马转换方法：LinearToGammaSpaceExact和LinearToGammaSpace。两者的主要区别在于精度和性能：</p>
<ul>
<li>LinearToGammaSpaceExact：使用精确的sRGB转换公式，计算结果准确但计算量稍大</li>
<li>LinearToGammaSpace：使用近似的转换公式（通常为线性值^(1/2.2)），计算速度快但精度略低</li>
</ul>
<p>在大多数情况下，两种方法的视觉差异不大，但在需要严格颜色准确性的场景中（如专业图像处理、颜色分级等），应优先使用Exact版本。</p>
<h2 data-id="heading-6">节点接口详解</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/LinearToGammaSpaceExactNodeThumb.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">输入端口</h3>
<p>In输入端口接收Float类型的数值，代表线性颜色空间中的颜色分量。该端口可以接受以下类型的数值：</p>
<ul>
<li>单个浮点数值：表示单颜色通道的线性值</li>
<li>二维向量：表示两个颜色通道的线性值</li>
<li>三维向量：表示RGB颜色的线性值</li>
<li>四维向量：表示RGBA颜色的线性值，包括透明度</li>
</ul>
<p>输入值的有效范围通常是[0,1]，但节点也可以处理超出此范围的HDR值，转换时会保持数值的相对关系。</p>
<h3 data-id="heading-8">输出端口</h3>
<p>Out输出端口返回转换后的Float类型数值，表示伽马颜色空间中的颜色分量。输出值的范围与输入相对应：</p>
<ul>
<li>对于标准范围[0,1]的输入，输出也在[0,1]范围内</li>
<li>对于HDR值（大于1），输出会保持相应的相对亮度关系</li>
</ul>
<p>输出数据类型与输入保持一致，如果输入是向量类型，输出也是相应的向量类型，每个分量都独立进行伽马转换。</p>
<h2 data-id="heading-9">实际应用场景</h2>
<h3 data-id="heading-10">后处理效果中的颜色校正</h3>
<p>在后处理渲染中，LinearToGammaSpaceExact节点常用于将线性空间的计算结果转换为适合显示的伽马空间。例如，在实现色彩分级、色调映射或Bloom效果时：</p>
<ul>
<li>在色调映射过程中，首先在线性空间中进行亮度压缩和颜色调整</li>
<li>使用LinearToGammaSpaceExact将结果转换到伽马空间</li>
<li>最终输出到屏幕缓冲区，确保显示设备能正确呈现</li>
</ul>
<p>这种工作流程保证了颜色处理的准确性，避免了因颜色空间不匹配导致的颜色失真。</p>
<h3 data-id="heading-11">UI元素与渲染结果的混合</h3>
<p>当需要将3D渲染结果与UI元素结合时，正确管理颜色空间至关重要：</p>
<ul>
<li>3D渲染通常在线性空间中进行计算</li>
<li>UI元素和纹理通常存储在伽马空间中</li>
<li>使用LinearToGammaSpaceExact可以将渲染结果转换到与UI一致的颜色空间</li>
<li>确保混合后的视觉效果颜色一致，没有明显的界限或差异</li>
</ul>
<h3 data-id="heading-12">自定义光照模型开发</h3>
<p>在开发自定义光照模型时，正确管理颜色空间是保证光照计算准确性的关键：</p>
<ul>
<li>光照计算在线性空间中执行，符合物理规律</li>
<li>使用LinearToGammaSpaceExact将最终光照结果转换到显示空间</li>
<li>确保光照的亮度和颜色关系在显示时保持正确</li>
</ul>
<p>特别是在实现复杂的PBR材质时，颜色空间的正确转换对于金属度、粗糙度等参数的准确表现尤为重要。</p>
<h2 data-id="heading-13">使用示例与案例分析</h2>
<h3 data-id="heading-14">基础颜色空间转换</h3>
<p>以下是一个简单的Shader Graph设置，演示如何使用LinearToGammaSpaceExact节点进行基本的颜色空间转换：</p>
<ul>
<li>创建Color节点作为线性空间的颜色输入</li>
<li>将Color节点连接到LinearToGammaSpaceExact节点的In端口</li>
<li>将LinearToGammaSpaceExact节点的Out端口连接到主节点的Base Color输入</li>
<li>通过调节输入颜色，观察转换前后颜色的变化</li>
</ul>
<p>这种基础设置可以帮助理解线性空间与伽马空间之间颜色表现的差异，特别是在中等亮度区域，差异最为明显。</p>
<h3 data-id="heading-15">HDR颜色处理案例</h3>
<p>在处理高动态范围颜色时，LinearToGammaSpaceExact节点的行为值得特别关注：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 假设在线性空间中有以下HDR颜色值</span>
float3 linearColor = <span class="hljs-built_in">float3</span>(<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.5</span>);

<span class="hljs-comment">// 应用LinearToGammaSpaceExact转换</span>
float3 gammaColor = <span class="hljs-built_in">LinearToGammaSpaceExact</span>(linearColor);

<span class="hljs-comment">// 结果会保持相对的亮度关系</span>
<span class="hljs-comment">// 但数值可能超出标准[0,1]范围</span>
</code></pre>
<p>在实际应用中，通常会在伽马转换前先进行色调映射，将HDR值压缩到显示设备能够处理的范围内。</p>
<h3 data-id="heading-16">自定义后处理效果实现</h3>
<p>下面是一个实现简单颜色分级效果的Shader Graph示例：</p>
<ul>
<li>使用Scene Color节点获取当前渲染的线性空间颜色</li>
<li>应用颜色调整节点（如对比度、饱和度、色相调整）</li>
<li>所有调整在线性空间中执行，保证计算准确性</li>
<li>使用LinearToGammaSpaceExact节点将结果转换到伽马空间</li>
<li>输出到Blit命令或后处理堆栈</li>
</ul>
<p>这种方法确保了颜色调整的物理准确性，避免了在伽马空间中进行调整可能引入的数学错误。</p>
<h2 data-id="heading-17">性能考量与优化建议</h2>
<h3 data-id="heading-18">计算开销分析</h3>
<p>LinearToGammaSpaceExact节点的计算开销主要来自幂函数计算和条件判断。虽然单个节点的开销不大，但在像素着色器中大量使用时仍需注意：</p>
<ul>
<li>每个像素至少需要执行一次条件判断和一次幂运算</li>
<li>在高分辨率渲染中，这些操作会累积成可观的计算量</li>
<li>在移动平台或性能受限的环境中应谨慎使用</li>
</ul>
<h3 data-id="heading-19">优化策略</h3>
<p>针对性能敏感的场景，可以考虑以下优化策略：</p>
<ul>
<li>在顶点着色器中进行转换：如果颜色数据在顶点间变化不大，可以在顶点阶段进行转换</li>
<li>使用近似版本：在视觉要求不高的场景中，使用LinearToGammaSpace替代Exact版本</li>
<li>批量处理：将多个颜色通道的转换合并处理，减少条件判断次数</li>
<li>LUT优化：对于固定的颜色转换，可以使用查找表替代实时计算</li>
</ul>
<h3 data-id="heading-20">平台特异性考虑</h3>
<p>不同硬件平台对超越函数（如幂运算）的支持程度不同：</p>
<ul>
<li>现代桌面GPU通常有专门的硬件单元处理这类运算，效率较高</li>
<li>移动GPU可能通过软件模拟，效率相对较低</li>
<li>在针对多平台开发时，应测试目标平台的性能表现</li>
</ul>
<h2 data-id="heading-21">常见问题与解决方案</h2>
<h3 data-id="heading-22">颜色显示不一致问题</h3>
<p>在使用LinearToGammaSpaceExact节点时，可能会遇到颜色显示不一致的问题：</p>
<ul>
<li>问题表现：在不同设备或不同查看条件下颜色显示有差异</li>
<li>可能原因：颜色空间配置错误、显示器校准不一致、图像格式不匹配</li>
<li>解决方案：确保整个渲染管线颜色空间设置一致，使用标准颜色配置文件，定期校准显示设备</li>
</ul>
<h3 data-id="heading-23">性能瓶颈识别与解决</h3>
<p>如果发现使用LinearToGammaSpaceExact节点后性能下降：</p>
<ul>
<li>使用Unity Profiler分析着色器执行时间</li>
<li>检查是否在不需要精确转换的地方使用了Exact版本</li>
<li>考虑将转换移到渲染管线的后期阶段，减少重复计算</li>
<li>评估是否可以使用更简化的颜色空间处理方案</li>
</ul>
<h3 data-id="heading-24">HDR与LDR工作流切换</h3>
<p>在HDR和LDR渲染管线之间切换时，颜色空间处理需要特别注意：</p>
<ul>
<li>HDR管线通常在线性空间中处理更多计算</li>
<li>LDR管线可能混合使用线性和伽马空间</li>
<li>使用LinearToGammaSpaceExact节点时应明确当前的颜色空间状态</li>
<li>建立统一的颜色空间管理策略，确保在不同管线间的一致性</li>
</ul>
<h2 data-id="heading-25">最佳实践总结</h2>
<p>正确使用LinearToGammaSpaceExact节点需要遵循一系列最佳实践：</p>
<ul>
<li>始终了解数据当前所处的颜色空间，在线性空间中进行光照和颜色计算</li>
<li>仅在最终输出到屏幕或非浮点格式纹理时进行伽马转换</li>
<li>在需要最高颜色准确性的场景中使用Exact版本，其他情况可考虑使用近似版本</li>
<li>建立项目统一的颜色空间管理规范，避免混乱的颜色空间使用</li>
<li>定期测试在不同显示设备上的颜色表现，确保一致性</li>
<li>文档化颜色空间决策，便于团队协作和后续维护</li>
</ul>
<p>通过遵循这些实践原则，可以确保渲染结果的视觉准确性，同时在性能和画质之间取得良好平衡。LinearToGammaSpaceExact节点作为颜色管理工具箱中的重要组件，在正确的使用场景下能够显著提升渲染质量。</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[15 Go Eino AI应用开发实战 | 性能优化]]></title>    <link>https://juejin.cn/post/7585468725332475958</link>    <guid>https://juejin.cn/post/7585468725332475958</guid>    <pubDate>2025-12-20T09:57:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332475958" data-draft-id="7585474459776450596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="15 Go Eino AI应用开发实战 | 性能优化"/> <meta itemprop="keywords" content="后端,面试,Go"/> <meta itemprop="datePublished" content="2025-12-20T09:57:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            15 Go Eino AI应用开发实战 | 性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:57:57.000Z" title="Sat Dec 20 2025 09:57:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>声明：本AI应用开发系列教程首发在同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5DYsyMKh9cDJdVvs_Mn9_Q" target="_blank" title="https://mp.weixin.qq.com/s/5DYsyMKh9cDJdVvs_Mn9_Q" ref="nofollow noopener noreferrer">王中阳</a>，未经授权禁止转载。</p>
</blockquote>
<p>Go-Eino Interview Agent 平台的性能优化专注于实现高吞吐量、低延迟和高效资源利用，涵盖数据库连接、缓存策略、消息队列和向量搜索操作。这种综合方法确保系统能够处理并发面试会话，同时保持响应式 AI 交互。</p>
<h2 data-id="heading-0">数据库连接池优化</h2>
<p>数据库层采用复杂的连接池技术来高效管理 MySQL 连接。系统使用 GORM 配合优化的连接参数，平衡资源使用与性能需求。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 来自 database.go 的连接池配置</span>
sqlDB.SetMaxIdleConns(dbConfig.MaxIdleConns)
sqlDB.SetMaxOpenConns(dbConfig.MaxOpenConns)
<span class="hljs-keyword">if</span> dbConfig.ConnMaxLifetime != <span class="hljs-string">""</span> {
    connMaxLifetime, err := time.ParseDuration(dbConfig.ConnMaxLifetime)
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
        sqlDB.SetConnMaxLifetime(connMaxLifetime)
    }
}
</code></pre>
<p>该配置支持通过 YAML 配置文件动态调整连接池参数，允许基于生产工作负载模式进行微调。系统维护全局数据库实例，在所有服务组件间复用连接，最小化连接开销。</p>
<blockquote>
<p><strong>优化建议</strong>：应根据实际数据库指标监控并调整连接池参数。在典型面试工作负载下，将 <code>MaxIdleConns</code> 设置为 <code>MaxOpenConns</code> 的 20-30% 可获得最佳性能。</p>
</blockquote>
<h2 data-id="heading-1">Redis 缓存策略</h2>
<p>Redis 作为缓存层和消息队列基础设施，为频繁访问的数据提供亚毫秒级访问。缓存实现专注于会话管理、面试状态持久化和 AI 生成内容的临时存储。</p>
<p><strong>来源</strong>：redis.go</p>
<p>Redis 客户端配置通过底层 go-redis 库支持连接池，具有自动连接复用和故障转移处理功能。缓存层实现了简单的键值接口，支持可配置的过期时间：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 支持上下文的缓存操作</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetCache</span><span class="hljs-params">(ctx context.Context, key <span class="hljs-type">string</span>, value <span class="hljs-keyword">interface</span>{}, expiration <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">return</span> RedisClient.Set(ctx, key, value, <span class="hljs-number">0</span>).Err()
}
</code></pre>
<p>系统利用 Redis pub/sub 功能在面试组件间实时分发消息，当面试状态变化时能够立即更新连接的客户端。</p>
<h2 data-id="heading-2">消息队列性能</h2>
<p>基于 Redis 的消息队列实现为计算密集型操作（如 AI 模型推理和评估报告生成）提供异步处理能力。队列架构确保非阻塞请求处理，同时维护消息顺序和交付保证。</p>
<p><strong>来源</strong>：redis_queue.go</p>
<p>队列系统实现了基于 goroutine 的处理器的并发消息处理：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 并发消息处理</span>
<span class="hljs-keyword">for</span> _, h := <span class="hljs-keyword">range</span> handlers {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(handler MessageHandler, m *Message)</span></span> {
        <span class="hljs-keyword">if</span> err := handler(ctx, m); err != <span class="hljs-literal">nil</span> {
            log.Printf(<span class="hljs-string">"[RedisQueue] Error processing message: %v, type: %s"</span>, err, m.Type)
        }
    }(h, &amp;message)
}
</code></pre>
<p>基于通道的消息路由确保根据消息类型高效分发到相应处理器，而 pub/sub 机制为订阅组件提供实时交付。</p>
<h2 data-id="heading-3">向量搜索优化</h2>
<p>Milvus 向量数据库集成实现了针对简历匹配和问题检索的优化相似性搜索。系统专注于最小化查询延迟，同时保持面试相关内容的高召回率。</p>
<p><strong>来源</strong>：milvus_retriever_tool.go</p>
<p>向量搜索工作流程包括：</p>
<ol>
<li><strong>查询预处理</strong>：输入验证和嵌入生成</li>
<li><strong>索引选择</strong>：基于数据特征自动选择最优索引</li>
<li><strong>相似性搜索</strong>：高效 ANN（近似最近邻）搜索，支持可配置的 top-k 结果</li>
<li><strong>结果格式化</strong>：包含相似度分数和元数据的结构化输出</li>
</ol>
<p>检索器服务实现了连接池和查询批处理，以在面试高峰期最大化吞吐量。</p>
<h2 data-id="heading-4">模型管理性能</h2>
<p>静态模型管理器实现了 AI 模型配置的高效内存缓存，具有 O(1) 查找性能。系统使用读写互斥锁确保线程安全，同时最小化锁争用。</p>
<p><strong>来源</strong>：manager_impl.go</p>
<p>模型管理架构支持：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 支持映射优化的线程安全模型查找</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *staticManager)</span></span> Get(ctx context.Context, id <span class="hljs-type">int64</span>) (*InternalModel, <span class="hljs-type">error</span>) {
    s.mu.RLock()
    <span class="hljs-keyword">defer</span> s.mu.RUnlock()
    
    <span class="hljs-keyword">if</span> m, ok := s.mapping[id]; ok {
        <span class="hljs-keyword">return</span> m, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>批量操作（MGet）通过单次操作检索多个模型来最小化数据库往返，而 list 函数支持分页和过滤以减少内存占用。</p>
<h2 data-id="heading-5">内存管理和并发</h2>
<p>系统采用多种内存优化策略：</p>
<ul>
<li><strong>对象池</strong>：复用频繁分配的对象以减少 GC 压力</li>
<li><strong>流式处理</strong>：分块处理大型文档以最小化内存使用</li>
<li><strong>Goroutine 管理</strong>：控制 goroutine 生命周期以防止资源泄漏</li>
<li><strong>缓冲区管理</strong>：为 I/O 操作使用大小合适的缓冲区以平衡内存使用和性能</li>
</ul>
<p>并发架构使用 <code>sync.RWMutex</code> 处理读密集型操作（如模型查找），使用 <code>sync.Mutex</code> 处理写操作，确保在混合读写工作负载下的最佳性能。</p>
<h2 data-id="heading-6">性能监控和指标</h2>
<p>虽然基础基础设施已就位，但生产环境应实施全面的性能监控：</p>
<ol>
<li>数据库查询延迟和连接池指标</li>
<li>Redis 缓存命中率和内存使用情况</li>
<li>消息队列吞吐量和处理延迟</li>
<li>向量搜索查询时间和准确性指标</li>
<li>AI 模型推理延迟和资源利用率</li>
</ol>
<p>实施带有关联 ID 的结构化日志记录，以追踪面试处理管道中的性能瓶颈。这有助于对端到端延迟进行详细分析。</p>
<h2 data-id="heading-7">优化建议</h2>
<p>基于当前架构，考虑以下性能增强措施：</p>
<ol>
<li><strong>数据库索引</strong>：为面试记录和用户会话中的频繁查询模式添加复合索引</li>
<li><strong>缓存预热</strong>：将频繁访问的面试模板和问题集预加载到 Redis 缓存中</li>
<li><strong>连接池调优</strong>：根据并发用户指标调整数据库和 Redis 连接池</li>
<li><strong>批处理</strong>：为 AI 模型推理实现批处理操作以提高 GPU 利用率</li>
<li><strong>CDN 集成</strong>：通过 CDN 提供静态资源和缓存响应以减少延迟</li>
</ol>
<p>性能优化基础为处理不断增长的面试工作负载提供了可扩展的基础，同时保持系统响应性和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三种依赖注入详解]]></title>    <link>https://juejin.cn/post/7585463195201519666</link>    <guid>https://juejin.cn/post/7585463195201519666</guid>    <pubDate>2025-12-20T10:05:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201519666" data-draft-id="7585463258690977801" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三种依赖注入详解"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-20T10:05:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="L0CK"/> <meta itemprop="url" content="https://juejin.cn/user/3555195572989993"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三种依赖注入详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3555195572989993/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    L0CK
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T10:05:03.000Z" title="Sat Dec 20 2025 10:05:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Spring 框架中，将一个 Bean 注入到另一个 Bean 里，主要有三种方式。</p>
<hr/>
<h2 data-id="heading-0">1. 属性注入 (Field Injection)</h2>
<p>这是初学阶段和各种教程中最常见的方式。直接在成员变量上加 <code>@Autowired</code>。</p>
<p><strong>代码示例：</strong></p>
<p>Java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// 核心动作：直接在属性上点名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">list</span>(<span class="hljs-params"/>) {
        userService.<span class="hljs-title function_">findAll</span>();
    }
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong>：代码最简洁，看起来非常干净。</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>难以脱离容器使用</strong>：如果你想在没有 Spring 环境的情况下（比如写纯 Java 的单元测试）手动 new 这个对象，你没法给 <code>userService</code> 赋值。</li>
<li><strong>容易循环依赖</strong>：如果 A 注入 B，B 又注入 A，这种方式有时会掩盖代码设计的缺陷。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. Setter 方法注入 (Setter Injection)</h2>
<p>通过类的 Setter 方法来完成注入。</p>
<p><strong>代码示例：</strong></p>
<p>Java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> userService;

    <span class="hljs-meta">@Autowired</span> <span class="hljs-comment">// 核心动作：在 Setter 方法上点名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUserService</span>(<span class="hljs-params">UserService userService</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span> = userService;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">list</span>(<span class="hljs-params"/>) {
        userService.<span class="hljs-title function_">findAll</span>();
    }
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong>：比较灵活，可以在对象创建后重新修改注入的实例。</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ul>
<li><strong>安全性较低</strong>：对象在被调用时，可能还没有被注入（比如有人不小心改了值），导致空指针异常。</li>
<li><strong>代码冗长</strong>：每个属性都要写一套 Setter。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. 构造器注入 (Constructor Injection) —— <strong>官方推荐</strong></h2>
<p>通过类的构造方法来完成注入。这是 Spring 官方目前最推荐的方式。</p>
<p><strong>代码示例：</strong></p>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService; <span class="hljs-comment">// 甚至可以加 final，保证不可变</span>

    <span class="hljs-comment">// 核心动作：在构造函数上注入（Spring 4.3后，如果只有一个构造函数，@Autowired可省略）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">list</span><span class="hljs-params">()</span> {
        userService.findAll();
    }
}
</code></pre>
<ul>
<li>
<p><strong>优点</strong>：</p>
<ol>
<li><strong>保证不为空</strong>：对象一出生（构造时）就必须把依赖传进来，否则编译报错。</li>
<li><strong>不可变性</strong>：可以使用 <code>final</code> 关键字，防止以后被修改。</li>
<li><strong>利于测试</strong>：即便没有 Spring，你也可以轻松地通过 <code>new UserController(mockService)</code> 来进行测试。</li>
</ol>
</li>
<li>
<p><strong>缺点</strong>：当依赖非常多（比如有 10 个）时，构造函数的参数列表会非常长。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-3">总结：面试怎么答？</h2>

























<table><thead><tr><th><strong>方式</strong></th><th><strong>推荐程度</strong></th><th><strong>理由</strong></th></tr></thead><tbody><tr><td><strong>构造器注入</strong></td><td>⭐⭐⭐⭐⭐</td><td>官方推荐，安全、可靠、方便测试，保证对象状态完整。</td></tr><tr><td><strong>属性注入</strong></td><td>⭐⭐⭐</td><td>开发快，代码省事，但在大型项目和严格测试中不推荐。</td></tr><tr><td><strong>Setter 注入</strong></td><td>⭐⭐</td><td>除非需要在运行期间动态改变依赖，否则很少使用。</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux入侵挖矿处理记录]]></title>    <link>https://juejin.cn/post/7585412203979096107</link>    <guid>https://juejin.cn/post/7585412203979096107</guid>    <pubDate>2025-12-20T10:05:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585412203979096107" data-draft-id="7585412203979079723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Linux入侵挖矿处理记录"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T10:05:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="平凡的运维之路"/> <meta itemprop="url" content="https://juejin.cn/user/917424464473512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Linux入侵挖矿处理记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/917424464473512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    平凡的运维之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T10:05:29.000Z" title="Sat Dec 20 2025 10:05:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Linux入侵挖矿处理记录</h3>
<ul>
<li>突然收到系统告警，cpu使用超50%以上，实际周末业务低谷期，不会使用这么高的cpu使用率。</li>
</ul>
<h4 data-id="heading-1">解决思路</h4>
<ul>
<li>
<p>系统基础命令被替换导致，无法展示隐藏的进程或者其他信息，使用BusyBox 命令代替基础命令，能输出完整信息。</p>
<ul>
<li>下载地址 <code>https://www.busybox.net/downloads/binaries/1.30.0-i686/busybox</code></li>
</ul>
</li>
<li>
<p>使用busybox top命令</p>
<ul>
<li>使用busybox top命令，可以清楚发现异常进程占用cpu超50%,</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e923f90398e24bb38cb1bc02a0ed04e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmz5Yeh55qE6L-Q57u05LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766829929&amp;x-signature=BXOQitlP3GekJ8aMv0s%2Ba7omr4s%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>找到进程文件，清理该文件
<ul>
<li>进入/proc目录下找到对应pid，查看environ文件，SSC_ARGV0=就是程序本身，删除该文件后，重启服务器看是否还会有异常进程。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feb6d0e294604584b578e445bc80cd89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmz5Yeh55qE6L-Q57u05LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766829929&amp;x-signature=WSmx8bJ0rh7h11v90efV5UmB57Y%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Strapi 5 怎么用才够爽？这款插件带你实现“建站自由”]]></title>    <link>https://juejin.cn/post/7585452404113227791</link>    <guid>https://juejin.cn/post/7585452404113227791</guid>    <pubDate>2025-12-20T09:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585452404113227791" data-draft-id="7585452404113195023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Strapi 5 怎么用才够爽？这款插件带你实现“建站自由”"/> <meta itemprop="keywords" content="后端,Node.js"/> <meta itemprop="datePublished" content="2025-12-20T09:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知航驿站"/> <meta itemprop="url" content="https://juejin.cn/user/4125023356335576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Strapi 5 怎么用才够爽？这款插件带你实现“建站自由”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023356335576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知航驿站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:10:10.000Z" title="Sat Dec 20 2025 09:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>Strapi 5 是一个优秀的基石，而 <strong>strapi-plugin-bag</strong> 则是其上的“精装修”方案。我们致力于解决开发者在商业化交付过程中的那些重复劳动，让大家能把精力集中在真正的业务逻辑上。</p>
<p>本项目已在 GitHub 开源，并基于 <strong>Turborepo</strong> 维护，包含了完整的文档和前后端代码。</p>
<ul>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhangjob%2Fstrapi-plugin-bag" target="_blank" title="https://github.com/hangjob/strapi-plugin-bag" ref="nofollow noopener noreferrer">github.com/hangjob/str…</a></li>
<li><strong>在线文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhangjob.github.io%2Fstrapi-plugin-bag%2F" target="_blank" title="https://hangjob.github.io/strapi-plugin-bag/" ref="nofollow noopener noreferrer">hangjob.github.io/strapi-plug…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3be8cfd60d9942b08d2b6f5cd91cc7c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=vqmEgr8EqX9brTXu41eqHLr%2BkEQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">核心特性</h2>
<ul>
<li>🛡️ <strong>安全防御</strong>：内置动态 IP 黑白名单、多重验证码拦截逻辑。</li>
<li>🔐 <strong>隐私加固</strong>：一键启用 RSA 2048 与 AES 256 数据加密服务。</li>
<li>📰 <strong>内容生态</strong>：完善的文章、分类、标签管理，内置 SEO 与阅读量统计。</li>
<li>🗺️ <strong>可视化运营</strong>：可视化管理多级菜单、幻灯片、友情链接。</li>
<li>💬 <strong>互动交互</strong>：强大的多级评论审核机制与独立留言板。</li>
<li>🚀 <strong>极速交付</strong>：全中文适配，深度优化 Strapi 5 操作体验。</li>
<li/>
</ul>
<h2 data-id="heading-1">环境要求</h2>
<p>在开始之前，请确保您的开发环境满足以下要求：</p>
<ul>
<li><strong>Strapi 版本</strong>: <code>^5.0.0</code> (支持最新的 Strapi 5 架构)</li>
<li><strong>Node.js 版本</strong>: <code>&gt;=22.10.0</code></li>
<li><strong>数据库</strong>: MySQL, PostgreSQL 或 SQLite</li>
</ul>
<h2 data-id="heading-2">安装步骤</h2>
<p>您可以使用您喜欢的包管理器将插件添加到您的 Strapi 项目中。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add strapi-plugin-bag
</code></pre>
<h2 data-id="heading-3">启用插件</h2>
<p>安装完成后，您需要手动在 Strapi 的配置文件中启用该插件。</p>
<p>编辑或创建项目根目录下的 <code>config/plugins.js</code> (或 <code>config/plugins.ts</code>) 文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">{ env }</span>) =&gt;</span> ({
  <span class="hljs-comment">// ... 其他插件配置</span>
  <span class="hljs-string">"strapi-plugin-bag"</span>: {
    <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
  },
});
</code></pre>
<h2 data-id="heading-4">重新构建</h2>
<p>为了让插件的后台管理界面生效，您需要重新构建 Strapi 的管理面板并重启服务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建管理面板</span>
npm run build

<span class="hljs-comment"># 启动开发服务器</span>
npm run dev
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98a42f9b6b8c4bfab6fa57256a876ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=AyHO1SHMe%2Fv2P9ts4dI%2BLF9PsI4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">权限配置</h2>
<p>启用插件后，您需要为相应的角色配置 API 访问权限：</p>
<ol>
<li>登录 Strapi 管理后台。</li>
<li>前往 <strong>Settings (设置)</strong> -&gt; <strong>Users &amp; Permissions Plugin</strong> -&gt; <strong>Roles (角色)</strong>。</li>
<li>选择您想要配置的角色（如 <code>Public</code> 或 <code>Authenticated</code>）。</li>
<li>在 <strong>Permissions (权限)</strong> 列表中找到 <strong>Strapi-plugin-bag</strong>。</li>
<li>勾选您需要开放的 API 权限（如 <code>article.find</code>, <code>menu.findOne</code> 等）。</li>
<li>点击右上角的 <strong>Save (保存)</strong>。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7481680accff4270b0df50836742b563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=8%2FSWWqCtXMnQcYAESliBfHl91RI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">环境可视化配置</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3db7f4873f4ab38d1dbec6fd4914c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-l6Iiq6am_56uZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826610&amp;x-signature=c%2ByHVcnSweVJqau6aANHwykrmhY%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚手架开发工具——dotenv]]></title>    <link>https://juejin.cn/post/7585474459776466980</link>    <guid>https://juejin.cn/post/7585474459776466980</guid>    <pubDate>2025-12-20T08:58:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776466980" data-draft-id="7585485074037456902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚手架开发工具——dotenv"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:58:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚手架开发工具——dotenv
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:58:20.000Z" title="Sat Dec 20 2025 08:58:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>dotenv 是一个<strong>轻量级的 Node.js 环境变量管理工具</strong>，其核心作用是：<strong>从项目根目录的 <code>.env</code> 文件中加载自定义的环境变量，并将它们注入到 Node.js 的 <code>process.env</code> 对象中</strong>，使得我们可以在项目代码中统一通过 <code>process.env.XXX</code> 的方式获取这些环境配置，无需手动在系统环境中配置临时变量或永久变量。</p>
<h2 data-id="heading-1">核心工作原理</h2>
<ol>
<li>当在项目中引入并执行 dotenv 时，它会自动查找项目根目录下的 <code>.env</code> 文件（该文件为纯文本格式，采用键值对配置）；</li>
<li>它会解析 <code>.env</code> 文件中的每一行配置（格式通常为 <code>KEY=VALUE</code>）；</li>
<li>将解析后的键值对逐一挂载到 Node.js 内置的 <code>process.env</code> 对象上（<code>process.env</code> 原本用于存储系统级环境变量，dotenv 为其扩展了项目自定义环境变量）；</li>
<li>之后在项目的任意代码文件中，都可以通过 <code>process.env.KEY</code> 的形式获取对应的值。</li>
</ol>
<h2 data-id="heading-2">使用示例</h2>
<pre><code class="hljs language-css" lang="css">npm install dotenv <span class="hljs-attr">--save</span>
</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env 文件内容 当前用户路径下创建 `.env` 文件</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
<span class="hljs-attr">DB_HOST</span>=localhost
<span class="hljs-attr">DB_USER</span>=root
<span class="hljs-attr">DB_PASSWORD</span>=<span class="hljs-number">123456</span>
<span class="hljs-attr">API_KEY</span>=abcdefg123456
</code></pre>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">const</span> dotenv = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>);
    <span class="hljs-keyword">const</span> dotenvPath = path.<span class="hljs-title function_">resolve</span>(userHome, <span class="hljs-string">'.env'</span>); <span class="hljs-comment">// /Users/***/.env</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">pathExists</span>(dotenvPath)) {
        dotenv.<span class="hljs-title function_">config</span>({
            <span class="hljs-attr">path</span>: dotenvPath,
        });
    }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 26 -持续集成与部署]]></title>    <link>https://juejin.cn/post/7585463195201404978</link>    <guid>https://juejin.cn/post/7585463195201404978</guid>    <pubDate>2025-12-20T08:56:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201404978" data-draft-id="7585686247269548041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 26 -持续集成与部署"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-20T08:56:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 26 -持续集成与部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:56:38.000Z" title="Sat Dec 20 2025 08:56:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>代码写得再好，没有自动化的流水线，就像法拉利引擎装在牛车上！！！</p>
</blockquote>
<p><strong>什么是持续集成与部署？简单说就是：</strong></p>
<ul>
<li>你写代码 → 自动测试 → 自动打包 → 自动发布</li>
<li>就像工厂的流水线，代码进去，App出来</li>
</ul>
<p>今天我们一起来搭建这条"代码流水线"，让你的开发效率大幅提升！</p>
<h3 data-id="heading-1">一：CI/CD到底是什么？为什么每个团队都需要？</h3>
<h4 data-id="heading-2">1.1 从手动操作到自动化流水线</h4>
<p>先看看传统开发流程的痛点：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 传统发布流程（手动版）</span>
  <span class="hljs-number">1.</span> 本地运行测试();       <span class="hljs-comment">// 某些测试可能忘记运行</span>
  <span class="hljs-number">2.</span> 手动打包Android();    <span class="hljs-comment">// 配置证书、签名、版本号...</span>
  <span class="hljs-number">3.</span> 手动打包iOS();        <span class="hljs-comment">// 证书、描述文件、上架截图...</span>
  <span class="hljs-number">4.</span> 上传到测试平台();     <span class="hljs-comment">// 找测试妹子要手机号</span>
  <span class="hljs-number">5.</span> 收集反馈修复bug();    <span class="hljs-comment">// 来回沟通，效率低下</span>
  <span class="hljs-number">6.</span> 重复步骤<span class="hljs-number">1</span><span class="hljs-number">-5</span>();        <span class="hljs-comment">// 无限循环...</span>
</code></pre>
<p>再看自动化流水线：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 自动化发布流程（CI/CD版）</span>
<span class="hljs-string">流程:</span>
  <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">推送代码到GitHub/Gitlab</span> <span class="hljs-string">→</span> <span class="hljs-string">自动触发</span>
  <span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">运行所有测试</span> <span class="hljs-string">→</span> <span class="hljs-string">失败自动通知</span>
  <span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">打包所有平台</span> <span class="hljs-string">→</span> <span class="hljs-string">同时进行</span>
  <span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">分发到测试环境</span> <span class="hljs-string">→</span> <span class="hljs-string">自动分发给测试人员</span>
  <span class="hljs-number">5</span><span class="hljs-string">.</span> <span class="hljs-string">发布到应用商店</span> <span class="hljs-string">→</span> <span class="hljs-string">条件触发</span>
</code></pre>
<h4 data-id="heading-3">1.2 CI/CD的核心价值</h4>
<p>很多新手觉得CI/CD是"大公司才需要的东西"，其实完全错了！它解决的是这些痛点：</p>
<p><strong>问题1：环境不一致</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">本地环境: Flutter 3.10, Dart 2.18, Mac M1</span>
<span class="hljs-section">测试环境: Flutter 3.7, Dart 2.17, Windows</span>
<span class="hljs-section">生产环境: ???</span>
</code></pre>
<p><strong>问题2：手动操作容易出错</strong>
之前遇到过同事把debug包发给了用户，因为打包时选错了构建变体。</p>
<p><strong>问题3：反馈周期太长</strong>
代码提交 → 手动打包 → 发给测试 → 发现问题 → 已经过了半天</p>
<h4 data-id="heading-4">1.3 CI/CD的三个核心概念</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[代码提交] --&gt; B[持续集成 CI]
    B --&gt; C[持续交付 CD]
    C --&gt; D[持续部署 CD]
    
    B --&gt; E[自动构建]
    B --&gt; F[自动测试]
    
    C --&gt; G[自动打包]
    C --&gt; H[自动发布到测试]
    
    D --&gt; I[自动发布到生产]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
</code></pre>
<p><strong>持续集成（CI）</strong>：频繁集成代码到主干，每次集成都通过自动化测试</p>
<p><strong>持续交付（CD）</strong>：自动将代码打包成可部署的产物</p>
<p><strong>持续部署（CD）</strong>：自动将产物部署到生产环境</p>
<blockquote>
<p>注意：两个CD虽然缩写一样，但含义不同。Continuous Delivery（持续交付）和 Continuous Deployment（持续部署）</p>
</blockquote>
<h3 data-id="heading-5">二：GitHub Actions</h3>
<p>我们以github为例，当然各公司有单独部署的gitlab，大同小异这里不在赘述。。。</p>
<h4 data-id="heading-6">2.1 GitHub Actions工作原理</h4>
<p>GitHub Actions不是魔法，而是GitHub提供的<strong>自动化执行环境</strong>。想象一下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[你的代码仓库] --&gt; B[事件推送/PR]
    B --&gt; C[GitHub Actions服务器]
    C --&gt; D[分配虚拟机]
    D --&gt; E[你的工作流]
    E --&gt; F[运行你的脚本]

    style A fill:#f9f,stroke:#333,stroke-width:1px
    style C fill:#9f9,stroke:#333,stroke-width:1px
    style E fill:#99f,stroke:#333,stroke-width:1px
</code></pre>
<p><strong>核心组件解析</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 工作流组件关系图</span>
<span class="hljs-string">工作流文件</span> <span class="hljs-string">(.github/workflows/ci.yml)</span>
    <span class="hljs-string">├──</span> <span class="hljs-string">触发器:</span> <span class="hljs-string">什么情况下运行</span> <span class="hljs-string">(push,</span> <span class="hljs-string">pull_request)</span>
    <span class="hljs-string">├──</span> <span class="hljs-string">任务:</span> <span class="hljs-string">在什么环境下运行</span> <span class="hljs-string">(ubuntu-latest)</span>
    <span class="hljs-string">└──</span> <span class="hljs-string">步骤:</span> <span class="hljs-string">具体执行什么</span> <span class="hljs-string">(安装Flutter、运行测试)</span>
</code></pre>
<h4 data-id="heading-7">2.2 创建你的第一个工作流</h4>
<p>别被吓到，其实创建一个基础的CI流程只需要5分钟：</p>
<ol>
<li><strong>在项目根目录创建文件夹</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p .github/workflows
</code></pre>
<ol start="2">
<li><strong>创建CI配置文件</strong>：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/flutter-ci.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">CI</span>  <span class="hljs-comment"># 工作流名称</span>

<span class="hljs-comment"># 触发条件：当有代码推送到main分支，或者有PR时</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span>, <span class="hljs-string">develop</span> ]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-comment"># 设置权限</span>
<span class="hljs-attr">permissions:</span>
  <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>  <span class="hljs-comment"># 只读权限，保证安全</span>

<span class="hljs-comment"># 工作流中的任务</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-comment"># 任务1：运行测试</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-comment"># 运行在Ubuntu最新版</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-comment"># 任务步骤</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-comment"># 步骤1：检出代码</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-comment"># 步骤2：安装Flutter</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.10.x'</span>  <span class="hljs-comment"># 指定Flutter版本</span>
          <span class="hljs-attr">channel:</span> <span class="hljs-string">'stable'</span>          <span class="hljs-comment"># 稳定版</span>
        
      <span class="hljs-comment"># 步骤3：获取依赖</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-comment"># 步骤4：运行测试</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">test</span>
        
      <span class="hljs-comment"># 步骤5：检查代码格式</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">formatting</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">format</span> <span class="hljs-string">--set-exit-if-changed</span> <span class="hljs-string">.</span>
        
      <span class="hljs-comment"># 步骤6：静态分析</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Analyze</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">analyze</span>
</code></pre>
<ol start="3">
<li><strong>提交并推送代码</strong>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git add .github/workflows/flutter-ci.yml
git commit -m <span class="hljs-string">"添加CI工作流"</span>
git push origin main
</code></pre>
<p>推送到GitHub后，打开你的仓库页面，点击"Actions"标签，你会看到一个工作流正在运行！</p>
<h4 data-id="heading-8">2.3 GitHub Actions架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;GitHub Actions架构&amp;#34;
        A[你的代码仓库] --&gt; B[触发事件]
        B --&gt; C[GitHub Actions Runner]
        
        subgraph &amp;#34;Runner执行环境&amp;#34;
            C --&gt; D[创建虚拟机]
            D --&gt; E[执行工作流]
            
            subgraph &amp;#34;工作流步骤&amp;#34;
                E --&gt; F[检出代码]
                F --&gt; G[环境配置]
                G --&gt; H[执行脚本]
                H --&gt; I[产出物]
            end
        end
        
        I --&gt; J[结果反馈]
        J --&gt; K[GitHub UI显示]
        J --&gt; L[邮件/通知]
    end
    
    style A fill:#e3f2fd
    style C fill:#f3e5f5
    style E fill:#e8f5e8
    style I fill:#fff3e0
</code></pre>
<p><strong>核心概念解释</strong>：</p>
<ol>
<li><strong>Runner</strong>：GitHub提供的虚拟机（或你自己的服务器），用来执行工作流</li>
<li><strong>Workflow</strong>：工作流，一个完整的自动化流程</li>
<li><strong>Job</strong>：任务，工作流中的独立单元</li>
<li><strong>Step</strong>：步骤，任务中的具体操作</li>
<li><strong>Action</strong>：可复用的操作单元，如"安装Flutter"</li>
</ol>
<h3 data-id="heading-9">三：自动化测试流水线</h3>
<h4 data-id="heading-10">3.1 为什么自动化测试如此重要？</h4>
<p>功能上线前，全部功能手动测试耗时长，易出bug。加入自动化测试，有效减少bug率。</p>
<p><strong>测试金字塔理论</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">        /\
       /  \      E2E测试（少量）
      /____\     
     /      \    集成测试（适中）
    /________\
   /          \  单元测试（大量）
  /____________\
</code></pre>
<p>对于Flutter，测试分为三层：</p>
<h4 data-id="heading-11">3.2 配置单元测试</h4>
<p>单元测试是最基础的，测试单个函数或类：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/unit-tests.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Unit</span> <span class="hljs-string">Tests</span>

<span class="hljs-attr">on:</span> [<span class="hljs-string">push</span>, <span class="hljs-string">pull_request</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">unit-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># 在不同版本的Flutter上运行测试</span>
        <span class="hljs-attr">flutter:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>]
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter</span> <span class="hljs-string">}}</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">unit</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 运行所有单元测试
          flutter test
</span>          
          <span class="hljs-comment"># 生成测试覆盖率报告</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">--coverage</span>
          
          <span class="hljs-comment"># 上传覆盖率报告</span>
          <span class="hljs-string">bash</span> <span class="hljs-string">&lt;(curl</span> <span class="hljs-string">-s</span> <span class="hljs-string">https://codecov.io/bash)</span>
</code></pre>
<p><strong>单元测试</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// test/calculator_test.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_test/flutter_test.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:my_app/utils/calculator.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  group(<span class="hljs-string">'以Calculator测试为例'</span>, () {
    <span class="hljs-keyword">late</span> Calculator calculator;
    
    <span class="hljs-comment">// 准备工作</span>
    setUp(() {
      calculator = Calculator();
    });
    
    test(<span class="hljs-string">'两个正数相加'</span>, () {
      expect(calculator.add(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), <span class="hljs-number">5</span>);
    });
    
    test(<span class="hljs-string">'正数与负数相加'</span>, () {
      expect(calculator.add(<span class="hljs-number">5</span>, <span class="hljs-number">-3</span>), <span class="hljs-number">2</span>);
    });
    
    test(<span class="hljs-string">'除以零应该抛出异常'</span>, () {
      expect(() =&gt; calculator.divide(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>), throwsA(isA&lt;ArgumentError&gt;()));
    });
  });
}
</code></pre>
<h4 data-id="heading-12">3.3 配置集成测试</h4>
<p>集成测试测试多个组件的交互：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 集成测试工作流</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">integration-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>  <span class="hljs-comment"># iOS集成测试需要macOS</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 启动模拟器
          # flutter emulators --launch flutter_emulator
</span>          
          <span class="hljs-comment"># 运行集成测试</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">integration_test/</span>
          
      <span class="hljs-comment"># 如果集成测试失败，上传截图辅助调试</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">screenshots</span> <span class="hljs-string">on</span> <span class="hljs-string">failure</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">integration-test-screenshots</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">screenshots/</span>
</code></pre>
<h4 data-id="heading-13">3.4 配置Widget测试</h4>
<p>Widget测试测试UI组件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">widget-tests:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flutter pub get
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">widget</span> <span class="hljs-string">tests</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 运行所有widget测试
          flutter test test/widget_test.dart
</span>          
          <span class="hljs-comment"># 或者运行特定目录</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">test/widgets/</span>
</code></pre>
<h4 data-id="heading-14">3.5 测试流水线</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant D as 开发者
    participant G as Git仓库
    participant CI as CI服务器
    participant UT as 单元测试服务
    participant WT as Widget测试服务
    participant IT as 集成测试服务
    participant R as 报告服务
    participant N as 通知服务
    
    D-&gt;&gt;G: 推送代码
    G-&gt;&gt;CI: 触发Webhook
    
    CI-&gt;&gt;CI: 解析工作流配置
    CI-&gt;&gt;CI: 分配测试资源
    
    par 并行执行
        CI-&gt;&gt;UT: 启动单元测试
        UT-&gt;&gt;UT: 准备环境
        UT-&gt;&gt;UT: 执行测试
        UT-&gt;&gt;UT: 分析覆盖率
        UT--&gt;&gt;CI: 返回结果
    and
        CI-&gt;&gt;WT: 启动Widget测试
        WT-&gt;&gt;WT: 准备UI环境
        WT-&gt;&gt;WT: 执行测试
        WT-&gt;&gt;WT: 截图对比
        WT--&gt;&gt;CI: 返回结果
    and
        CI-&gt;&gt;IT: 启动集成测试
        IT-&gt;&gt;IT: 准备设备
        IT-&gt;&gt;IT: 执行测试
        IT-&gt;&gt;IT: 端到端验证
        IT--&gt;&gt;CI: 返回结果
    end
    
    CI-&gt;&gt;CI: 收集所有结果
    
    alt 所有测试通过
        CI-&gt;&gt;R: 请求生成报告
        R-&gt;&gt;R: 生成详细报告
        R--&gt;&gt;CI: 返回报告
        CI-&gt;&gt;N: 发送成功通知
        N--&gt;&gt;D: 通知开发者
    else 有测试失败
        CI-&gt;&gt;R: 请求生成错误报告
        R-&gt;&gt;R: 生成错误报告
        R--&gt;&gt;CI: 返回报告
        CI-&gt;&gt;N: 发送失败通知
        N--&gt;&gt;D: 警报开发者
    end
</code></pre>
<h3 data-id="heading-15">四：自动打包与发布流水线</h3>
<h4 data-id="heading-16">4.1 Android自动打包</h4>
<p>Android打包相对简单，但要注意签名问题：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/android-build.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Android</span> <span class="hljs-string">Build</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>  <span class="hljs-comment"># 只有打tag时才触发打包</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-android:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Java</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">distribution:</span> <span class="hljs-string">'temurin'</span>
          <span class="hljs-attr">java-version:</span> <span class="hljs-string">'17'</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Get</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">pub</span> <span class="hljs-string">get</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">keystore</span>
        <span class="hljs-comment"># 从GitHub Secrets读取签名密钥</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "${{ secrets.ANDROID_KEYSTORE }}" &gt; android/app/key.jks.base64
          base64 -d android/app/key.jks.base64 &gt; android/app/key.jks
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">APK</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 构建Release版APK
          flutter build apk --release \
            --dart-define=APP_VERSION=${{ github.ref_name }} \
            --dart-define=BUILD_NUMBER=${{ github.run_number }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">App</span> <span class="hljs-string">Bundle</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 构建App Bundle
          flutter build appbundle --release
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">android-build-${{</span> <span class="hljs-string">github.run_number</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
</span></code></pre>
<h4 data-id="heading-17">4.2 iOS自动打包</h4>
<p>iOS打包相对复杂，需要苹果开发者账号：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/ios-build.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">iOS</span> <span class="hljs-string">Build</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'v*'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-ios:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">CocoaPods</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          cd ios
          pod install
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Xcode</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 设置Xcode版本
          sudo xcode-select -s /Applications/Xcode_14.2.app
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">provisioning</span> <span class="hljs-string">profiles</span>
        <span class="hljs-comment"># 配置证书和描述文件</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">BUILD_CERTIFICATE_BASE64:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.BUILD_CERTIFICATE</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">P12_PASSWORD:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.P12_PASSWORD</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">BUILD_PROVISION_PROFILE_BASE64:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.BUILD_PROVISION_PROFILE</span> <span class="hljs-string">}}</span>
          
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 导入证书
          echo $BUILD_CERTIFICATE_BASE64 | base64 --decode &gt; certificate.p12
</span>          
          <span class="hljs-comment"># 创建钥匙链</span>
          <span class="hljs-string">security</span> <span class="hljs-string">create-keychain</span> <span class="hljs-string">-p</span> <span class="hljs-string">""</span> <span class="hljs-string">build.keychain</span>
          <span class="hljs-string">security</span> <span class="hljs-string">default-keychain</span> <span class="hljs-string">-s</span> <span class="hljs-string">build.keychain</span>
          <span class="hljs-string">security</span> <span class="hljs-string">unlock-keychain</span> <span class="hljs-string">-p</span> <span class="hljs-string">""</span> <span class="hljs-string">build.keychain</span>
          
          <span class="hljs-comment"># 导入证书到钥匙链</span>
          <span class="hljs-string">security</span> <span class="hljs-string">import</span> <span class="hljs-string">certificate.p12</span> <span class="hljs-string">-k</span> <span class="hljs-string">build.keychain</span> <span class="hljs-string">\</span>
            <span class="hljs-string">-P</span> <span class="hljs-string">$P12_PASSWORD</span> <span class="hljs-string">-T</span> <span class="hljs-string">/usr/bin/codesign</span>
          
          <span class="hljs-comment"># 导入描述文件</span>
          <span class="hljs-string">echo</span> <span class="hljs-string">$BUILD_PROVISION_PROFILE_BASE64</span> <span class="hljs-string">|</span> <span class="hljs-string">base64</span> <span class="hljs-string">--decode</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">profile.mobileprovision</span>
          <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">~/Library/MobileDevice/Provisioning\</span> <span class="hljs-string">Profiles</span>
          <span class="hljs-string">cp</span> <span class="hljs-string">profile.mobileprovision</span> <span class="hljs-string">~/Library/MobileDevice/Provisioning\</span> <span class="hljs-string">Profiles/</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">iOS</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 构建iOS应用
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --dart-define=APP_VERSION=${{ github.ref_name }} \
            --dart-define=BUILD_NUMBER=${{ github.run_number }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">IPA</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ios-build-${{</span> <span class="hljs-string">github.run_number</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">build/ios/ipa/*.ipa</span>
</code></pre>
<h4 data-id="heading-18">4.3 多环境构建配置</h4>
<p>真实的项目通常有多个环境：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 多环境构建配置</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-comment"># 根据分支选择环境</span>
  <span class="hljs-attr">APP_ENV:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">'production'</span> <span class="hljs-string">||</span> <span class="hljs-string">'staging'</span> <span class="hljs-string">}}</span>
  <span class="hljs-attr">APP_NAME:</span> <span class="hljs-string">${{</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">'生产'</span> <span class="hljs-string">||</span> <span class="hljs-string">'测试'</span> <span class="hljs-string">}}</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># 同时构建多个Flavor</span>
        <span class="hljs-attr">flavor:</span> [<span class="hljs-string">development</span>, <span class="hljs-string">staging</span>, <span class="hljs-string">production</span>]
        <span class="hljs-attr">platform:</span> [<span class="hljs-string">android</span>, <span class="hljs-string">ios</span>]
        
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">}}</span> <span class="hljs-string">for</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          if [ "${{ matrix.platform }}" = "android" ]; then
            flutter build apk --flavor ${{ matrix.flavor }} --release
          else
            flutter build ipa --flavor ${{ matrix.flavor }} --release
          fi
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">}}-${{</span> <span class="hljs-string">matrix.flavor</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk
            build/ios/ipa/*.ipa
</span></code></pre>
<h4 data-id="heading-19">4.4 自动化发布到测试平台</h4>
<p>构建完成后，自动分发给测试人员：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 分发到测试平台</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">distribute:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">needs:</span> [<span class="hljs-string">build</span>]  <span class="hljs-comment"># 依赖build任务</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/download-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">artifacts/</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">to</span> <span class="hljs-string">Firebase</span> <span class="hljs-string">App</span> <span class="hljs-string">Distribution</span>
        <span class="hljs-comment"># 分发到Firebase</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 安装Firebase CLI
          curl -sL https://firebase.tools | bash
</span>          
          <span class="hljs-comment"># 登录Firebase</span>
          <span class="hljs-string">echo</span> <span class="hljs-string">"$<span class="hljs-template-variable">{{ secrets.FIREBASE_TOKEN }}</span>"</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">firebase_token.json</span>
          
          <span class="hljs-comment"># 分发Android APK</span>
          <span class="hljs-string">firebase</span> <span class="hljs-string">appdistribution:distribute</span> <span class="hljs-string">artifacts/android-production/app-release.apk</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--app</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.FIREBASE_ANDROID_APP_ID</span> <span class="hljs-string">}}</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--groups</span> <span class="hljs-string">"testers"</span> <span class="hljs-string">\</span>
            <span class="hljs-string">--release-notes-file</span> <span class="hljs-string">CHANGELOG.md</span>
            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">to</span> <span class="hljs-string">TestFlight</span>
        <span class="hljs-comment"># iOS上传到TestFlight</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">matrix.platform</span> <span class="hljs-string">==</span> <span class="hljs-string">'ios'</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 使用altool上传到App Store Connect
          xcrun altool --upload-app \
            -f artifacts/ios-production/*.ipa \
            -t ios \
            --apiKey ${{ secrets.APPSTORE_API_KEY }} \
            --apiIssuer ${{ secrets.APPSTORE_API_ISSUER }}
            
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Notify</span> <span class="hljs-string">testers</span>
        <span class="hljs-comment"># 通知测试人员</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">8398a7/action-slack@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">status:</span> <span class="hljs-string">${{</span> <span class="hljs-string">job.status</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">fields:</span> <span class="hljs-string">repo,message,commit,author,action,eventName,ref,workflow,job,took</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SLACK_WEBHOOK_URL:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SLACK_WEBHOOK_URL</span> <span class="hljs-string">}}</span>
</code></pre>
<h4 data-id="heading-20">4.5 打包发布流水线</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">gantt
    title Flutter打包发布流水线
    dateFormat HH:mm
    axisFormat %H:%M
    
    section 触发与准备
    代码提交检测 :00:00, 2m
    环境初始化 :00:02, 3m
    依赖安装 :00:05, 4m
    
    section Android构建
    Android环境准备 :00:05, 2m
    Android代码编译 :00:07, 6m
    Android代码签名 :00:13, 3m
    Android打包 :00:16, 2m
    
    section iOS构建
    iOS环境准备 :00:05, 3m
    iOS代码编译 :00:08, 8m
    iOS证书配置 :00:16, 4m
    iOS打包 :00:20, 3m
    
    section 测试分发
    上传到测试平台 :00:23, 5m
    测试人员通知 :00:28, 2m
    测试执行周期 :00:30, 30m
    
    section 生产发布
    测试结果评估 :01:00, 3m
    生产环境准备 :01:03, 5m
    提交到应用商店 :01:08, 10m
    商店审核等待 :01:18, 30m
    发布完成通知 :01:48, 2m
    
    section 环境配置管理
    密钥加载 :00:02, 3m
    环境变量设置 :00:05, 2m
    配置文件解析 :00:07, 3m
    版本号处理 :00:10, 2m
</code></pre>
<h3 data-id="heading-21">五：环境配置管理</h3>
<h4 data-id="heading-22">5.1 为什么需要环境配置管理？</h4>
<p>先看一个反面教材：我们项目早期，不同环境的API地址是硬编码的：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：硬编码配置</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiConfig</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> baseUrl = <span class="hljs-string">'https://api.production.com'</span>;
  <span class="hljs-comment">// 测试时需要手动改成：'https://api.staging.com'</span>
  <span class="hljs-comment">// 很容易忘记改回来！</span>
}
</code></pre>
<p>结果就是：测试时调用了生产接口，把测试数据插到了生产数据库！💥</p>
<h4 data-id="heading-23">5.2 多环境配置方案</h4>
<p><strong>方案一：基于Flavor的配置</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/config/flavors.dart</span>
<span class="hljs-keyword">enum</span> AppFlavor {
  development,
  staging,
  production,
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppConfig</span> </span>{
  <span class="hljs-keyword">final</span> AppFlavor flavor;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> appName;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> apiBaseUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableAnalytics;
  
  AppConfig({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.flavor,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.appName,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.apiBaseUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.enableAnalytics,
  });
  
  <span class="hljs-comment">// 根据Flavor创建配置</span>
  <span class="hljs-keyword">factory</span> AppConfig.fromFlavor(AppFlavor flavor) {
    <span class="hljs-keyword">switch</span> (flavor) {
      <span class="hljs-keyword">case</span> AppFlavor.development:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp Dev'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.dev.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">false</span>,
        );
      <span class="hljs-keyword">case</span> AppFlavor.staging:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp Staging'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.staging.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">true</span>,
        );
      <span class="hljs-keyword">case</span> AppFlavor.production:
        <span class="hljs-keyword">return</span> AppConfig(
          flavor: flavor,
          appName: <span class="hljs-string">'MyApp'</span>,
          apiBaseUrl: <span class="hljs-string">'https://api.xxxx.com'</span>,
          enableAnalytics: <span class="hljs-keyword">true</span>,
        );
    }
  }
}
</code></pre>
<p><strong>方案二：使用dart-define传入配置</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># CI配置中传入环境变量</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">environment</span> <span class="hljs-string">variables</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    flutter build apk --release \
      --dart-define=APP_FLAVOR=production \
      --dart-define=API_BASE_URL=https://api.xxxx.com \
      --dart-define=ENABLE_ANALYTICS=true
</span></code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 在代码中读取环境变量</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnvConfig</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> flavor = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'APP_FLAVOR'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> apiBaseUrl = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'API_BASE_URL'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">bool</span> enableAnalytics = <span class="hljs-built_in">bool</span>.fromEnvironment(<span class="hljs-string">'ENABLE_ANALYTICS'</span>);
}
</code></pre>
<h4 data-id="heading-24">5.3 管理敏感信息</h4>
<p>敏感信息绝不能写在代码里！</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 使用GitHub Secrets</span>
<span class="hljs-attr">steps:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">secrets</span>
    <span class="hljs-attr">env:</span>
      <span class="hljs-comment"># 从Secrets读取</span>
      <span class="hljs-attr">API_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.API_KEY</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">DATABASE_URL:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.DATABASE_URL</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">SIGNING_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.ANDROID_SIGNING_KEY</span> <span class="hljs-string">}}</span>
      
    <span class="hljs-attr">run:</span> <span class="hljs-string">|
      # 在脚本中使用
      echo "API Key: $API_KEY"
</span>      
      <span class="hljs-comment"># 写入到配置文件</span>
      <span class="hljs-string">echo</span> <span class="hljs-string">"{ \"apiKey\": \"$API_KEY\" }"</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">config.json</span>
</code></pre>
<p><strong>如何设置Secrets</strong>：</p>
<ol>
<li>打开GitHub仓库 → Settings → Secrets and variables → Actions</li>
<li>点击"New repository secret"</li>
<li>输入名称和值</li>
</ol>
<h4 data-id="heading-25">5.4 配置文件管理</h4>
<p>推荐以下分层配置策略：</p>
<pre><code class="hljs language-bash" lang="bash">config/
├── .env.example          <span class="hljs-comment"># 示例文件，不含真实值</span>
├── .env.development      <span class="hljs-comment"># 开发环境配置</span>
├── .env.staging          <span class="hljs-comment"># 测试环境配置</span>
├── .env.production       <span class="hljs-comment"># 生产环境配置</span>
└── config_loader.dart    <span class="hljs-comment"># 配置加载器</span>
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// config/config_loader.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_dotenv/flutter_dotenv.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigLoader</span> </span>{
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; load(<span class="hljs-built_in">String</span> env) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 根据环境加载对应的配置文件</span>
    <span class="hljs-keyword">await</span> dotenv.load(fileName: <span class="hljs-string">'.env.<span class="hljs-subst">$env</span>'</span>);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> apiBaseUrl =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'API_BASE_URL'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> apiKey =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'API_KEY'</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isDebug =&gt; dotenv.<span class="hljs-keyword">get</span>(<span class="hljs-string">'DEBUG'</span>) == <span class="hljs-string">'true'</span>;
}

<span class="hljs-comment">// main.dart</span>
<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 根据编译模式选择环境</span>
  <span class="hljs-keyword">const</span> flavor = <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'FLAVOR'</span>, defaultValue: <span class="hljs-string">'development'</span>);
  
  <span class="hljs-keyword">await</span> ConfigLoader.load(flavor);
  
  runApp(MyApp());
}
</code></pre>
<h4 data-id="heading-26">5.5 设计环境配置</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph &amp;#34;环境配置管理架构&amp;#34;
        A[配置来源] --&gt; B[优先级]
        
        subgraph &amp;#34;B[优先级]&amp;#34;
            B1[1. 运行时环境变量] --&gt; B2[最高优先级]
            B3[2. 配置文件] --&gt; B4[中等优先级]
            B5[3. 默认值] --&gt; B6[最低优先级]
        end
        
        A --&gt; C[敏感信息处理]
        
        subgraph &amp;#34;C[敏感信息处理]&amp;#34;
            C1[密钥/密码] --&gt; C2[GitHub Secrets]
            C3[API令牌] --&gt; C4[环境变量注入]
            C5[数据库连接] --&gt; C6[运行时获取]
        end
        
        A --&gt; D[环境类型]
        
        subgraph &amp;#34;D[环境类型]&amp;#34;
            D1[开发环境] --&gt; D2[本地调试]
            D3[测试环境] --&gt; D4[CI/CD测试]
            D5[预发环境] --&gt; D6[生产前验证]
            D7[生产环境] --&gt; D8[线上用户]
        end
        
        B --&gt; E[配置合并]
        C --&gt; E
        D --&gt; E
        
        E --&gt; F[最终配置]
        
        F --&gt; G[应用启动]
        F --&gt; H[API调用]
        F --&gt; I[功能开关]
    end
    
    subgraph &amp;#34;安全实践&amp;#34;
        J[永远不要提交] --&gt; K[.env文件到Git]
        L[使用.gitignore] --&gt; M[忽略敏感文件]
        N[定期轮换] --&gt; O[密钥和令牌]
        P[最小权限原则] --&gt; Q[仅授予必要权限]
    end
    
    style A fill:#e3f2fd
    style C fill:#f3e5f5
    style D fill:#e8f5e8
    style J fill:#fff3e0
</code></pre>
<h3 data-id="heading-27">六：常见CI/CD技巧</h3>
<h4 data-id="heading-28">6.1 使用缓存加速构建</h4>
<p>Flutter项目依赖下载很慢，使用缓存可以大幅提速：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            /opt/hostedtoolcache/flutter
            ${{ github.workspace }}/.pub-cache
            ${{ github.workspace }}/build
</span>          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-flutter-${{</span> <span class="hljs-string">hashFiles('pubspec.lock')</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|
            ${{ runner.os }}-flutter-
</span>            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">Android</span> <span class="hljs-string">dependencies</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">|
            ~/.gradle/caches
            ~/.gradle/wrapper
</span>          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-gradle-${{</span> <span class="hljs-string">hashFiles('**/*.gradle*',</span> <span class="hljs-string">'**/gradle-wrapper.properties'</span><span class="hljs-string">)</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|
            ${{ runner.os }}-gradle-
</span></code></pre>
<h4 data-id="heading-29">6.2 构建策略</h4>
<p>同时测试多个配置组合：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.os</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-comment"># 定义</span>
        <span class="hljs-attr">os:</span> [<span class="hljs-string">ubuntu-latest</span>, <span class="hljs-string">macos-latest</span>]
        <span class="hljs-attr">flutter-version:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>]
    
        <span class="hljs-attr">exclude:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">os:</span> <span class="hljs-string">macos-latest</span>
            <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.7.x'</span>
        <span class="hljs-comment"># 包含特定组合</span>
        <span class="hljs-attr">include:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">os:</span> <span class="hljs-string">windows-latest</span>
            <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">'3.10.x'</span>
            <span class="hljs-attr">channel:</span> <span class="hljs-string">'beta'</span>
            
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Test</span> <span class="hljs-string">on</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.os</span> <span class="hljs-string">}}</span> <span class="hljs-string">with</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.flutter-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Running tests..."</span>
</code></pre>
<h4 data-id="heading-30">6.3 条件执行与工作流控制</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-comment"># 只有特定分支才执行</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>
    
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">changed</span> <span class="hljs-string">files</span>
        <span class="hljs-comment"># 只有特定文件改动才执行</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">dorny/paths-filter@v2</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">changes</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">filters:</span> <span class="hljs-string">|
            src:
              - 'src/**'
            configs:
              - 'config/**'
              
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">if</span> <span class="hljs-string">src</span> <span class="hljs-string">changed</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">steps.changes.outputs.src</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">echo</span> <span class="hljs-string">"Source code changed"</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Skip</span> <span class="hljs-string">if</span> <span class="hljs-string">only</span> <span class="hljs-string">docs</span> <span class="hljs-string">changed</span>
        <span class="hljs-attr">if:</span> <span class="hljs-string">github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">'pull_request'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">contains(github.event.pull_request.title,</span> <span class="hljs-string">'[skip-ci]'</span><span class="hljs-string">)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "Skipping CI due to [skip-ci] in PR title"
          exit 0
</span></code></pre>
<h4 data-id="heading-31">6.4 自定义Actions</h4>
<p>当通用Actions不够用时，可以自定义：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/actions/flutter-setup/action.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">'Flutter Setup with Custom Options'</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">'Setup Flutter environment with custom configurations'</span>

<span class="hljs-attr">inputs:</span>
  <span class="hljs-attr">flutter-version:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Flutter version'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'stable'</span>
  <span class="hljs-attr">channel:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Flutter channel'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'stable'</span>
  <span class="hljs-attr">enable-web:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">'Enable web support'</span>
    <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default:</span> <span class="hljs-string">'false'</span>

<span class="hljs-attr">runs:</span>
  <span class="hljs-attr">using:</span> <span class="hljs-string">"composite"</span>
  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">flutter-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.flutter-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">channel:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.channel</span> <span class="hljs-string">}}</span>
        
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enable</span> <span class="hljs-string">web</span> <span class="hljs-string">if</span> <span class="hljs-string">needed</span>
      <span class="hljs-attr">if:</span> <span class="hljs-string">${{</span> <span class="hljs-string">inputs.enable-web</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span> <span class="hljs-string">}}</span>
      <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">config</span> <span class="hljs-string">--enable-web</span>
      
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">licenses</span>
      <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">doctor</span> <span class="hljs-string">--android-licenses</span>
</code></pre>
<h3 data-id="heading-32">七：为现有项目添加CI/CD</h3>
<h4 data-id="heading-33">7.1 分析现有项目</h4>
<p>如果我们有一个现成的Flutter应用，需要添加CI/CD：</p>
<pre><code class="hljs language-bash" lang="bash">项目结构：
my_flutter_app/
├── lib/
├── <span class="hljs-built_in">test</span>/
├── android/
├── ios/
└── pubspec.yaml
</code></pre>
<p><strong>当前问题</strong>：</p>
<ol>
<li>手动测试，经常漏测</li>
<li>打包需要20分钟，且容易出错</li>
<li>不同开发者环境不一致</li>
<li>发布流程繁琐</li>
</ol>
<h4 data-id="heading-34">7.2 分阶段实施自动化</h4>
<p><strong>第一阶段：实现基础CI</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 添加基础测试流水线</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 代码质量检查</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 配置GitHub Actions</li>
</ul>
<p><strong>第二阶段：自动化构建</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Android自动打包</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> iOS自动打包</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 多环境配置</li>
</ul>
<p><strong>第三阶段：自动化发布</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 测试环境自动分发</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 生产环境自动发布</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 监控与告警</li>
</ul>
<h4 data-id="heading-35">7.3 配置文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/ecommerce-ci.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">E-commerce</span> <span class="hljs-string">App</span> <span class="hljs-string">CI/CD</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">develop</span>]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>, <span class="hljs-string">develop</span>]
  <span class="hljs-attr">schedule:</span>
    <span class="hljs-comment"># 每天凌晨2点跑一遍测试</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">cron:</span> <span class="hljs-string">'0 2 * * *'</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-comment"># 代码质量</span>
  <span class="hljs-attr">quality-gate:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">outputs:</span>
      <span class="hljs-attr">passed:</span> <span class="hljs-string">${{</span> <span class="hljs-string">steps.quality-check.outputs.passed</span> <span class="hljs-string">}}</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Quality</span> <span class="hljs-string">Check</span>
        <span class="hljs-attr">id:</span> <span class="hljs-string">quality-check</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 代码规范检查
          flutter analyze . || echo "::warning::Code analysis failed"
</span>          
          <span class="hljs-comment"># 检查测试覆盖率</span>
          <span class="hljs-string">flutter</span> <span class="hljs-string">test</span> <span class="hljs-string">--coverage</span>
          <span class="hljs-string">PERCENTAGE=$(lcov</span> <span class="hljs-string">--summary</span> <span class="hljs-string">coverage/lcov.info</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">lines</span> <span class="hljs-string">|</span> <span class="hljs-string">awk</span> <span class="hljs-string">'{print $4}'</span> <span class="hljs-string">|</span> <span class="hljs-string">sed</span> <span class="hljs-string">'s/%//'</span><span class="hljs-string">)</span>
          <span class="hljs-string">if</span> <span class="hljs-string">((</span> <span class="hljs-string">$(echo</span> <span class="hljs-string">"$PERCENTAGE &lt; 80"</span> <span class="hljs-string">|</span> <span class="hljs-string">bc</span> <span class="hljs-string">-l)</span> <span class="hljs-string">));</span> <span class="hljs-string">then</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"::error::Test coverage $PERCENTAGE% is below 80% threshold"</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"passed=false"</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-string">$GITHUB_OUTPUT</span>
          <span class="hljs-string">else</span>
            <span class="hljs-string">echo</span> <span class="hljs-string">"passed=true"</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-string">$GITHUB_OUTPUT</span>
          <span class="hljs-string">fi</span>
          
  <span class="hljs-comment"># 集成测试</span>
  <span class="hljs-attr">integration-test:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">quality-gate</span>
    <span class="hljs-attr">if:</span> <span class="hljs-string">needs.quality-gate.outputs.passed</span> <span class="hljs-string">==</span> <span class="hljs-string">'true'</span>
    
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
    
    <span class="hljs-attr">services:</span>
      <span class="hljs-comment"># 启动测试数据库</span>
      <span class="hljs-attr">postgres:</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:14</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">postgres</span>
        <span class="hljs-attr">options:</span> <span class="hljs-string">&gt;-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
</span>          
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Flutter</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">subosito/flutter-action@v2</span>
        
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">integration</span> <span class="hljs-string">tests</span> <span class="hljs-string">with</span> <span class="hljs-string">database</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">DATABASE_URL:</span> <span class="hljs-string">postgres://postgres:postgres@postgres:5432/test_db</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          flutter test integration_test/ --dart-define=DATABASE_URL=$DATABASE_URL
</span>          
  <span class="hljs-comment"># 性能测试</span>
  <span class="hljs-attr">performance-test:</span>
    <span class="hljs-attr">needs:</span> <span class="hljs-string">integration-test</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">performance</span> <span class="hljs-string">benchmarks</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 运行性能测试
          flutter drive --target=test_driver/app_perf.dart
</span>          
          <span class="hljs-comment"># 分析性能数据</span>
          <span class="hljs-string">dart</span> <span class="hljs-string">analyze_performance.dart</span> <span class="hljs-string">perf_data.json</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">performance</span> <span class="hljs-string">report</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">performance-report</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">perf_report.json</span>
          
  <span class="hljs-comment"># 安全扫描</span>
  <span class="hljs-attr">security-scan:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">security</span> <span class="hljs-string">scan</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">snyk/actions/dart@master</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">SNYK_TOKEN:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SNYK_TOKEN</span> <span class="hljs-string">}}</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Check</span> <span class="hljs-string">for</span> <span class="hljs-string">secrets</span> <span class="hljs-string">in</span> <span class="hljs-string">code</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">trufflesecurity/trufflehog@main</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">./</span>
          
  <span class="hljs-comment"># 报告</span>
  <span class="hljs-attr">report:</span>
    <span class="hljs-attr">needs:</span> [<span class="hljs-string">quality-gate</span>, <span class="hljs-string">integration-test</span>, <span class="hljs-string">performance-test</span>, <span class="hljs-string">security-scan</span>]
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">if:</span> <span class="hljs-string">always()</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Report</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          echo "# CI/CD Run Report" &gt; report.md
          echo "## Run: ${{ github.run_id }}" &gt;&gt; report.md
          echo "## Status: ${{ job.status }}" &gt;&gt; report.md
          echo "## Jobs:" &gt;&gt; report.md
          echo "- Quality Gate: ${{ needs.quality-gate.result }}" &gt;&gt; report.md
          echo "- Integration Test: ${{ needs.integration-test.result }}" &gt;&gt; report.md
          echo "- Performance Test: ${{ needs.performance-test.result }}" &gt;&gt; report.md
          echo "- Security Scan: ${{ needs.security-scan.result }}" &gt;&gt; report.md
</span>          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">report</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ci-cd-report</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">report.md</span>
</code></pre>
<h4 data-id="heading-36">7.4 流程优化</h4>
<p>CI/CD不是一次性的，需要持续优化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 监控CI/CD性能</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Performance</span> <span class="hljs-string">Monitoring</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">workflow_run:</span>
    <span class="hljs-attr">workflows:</span> [<span class="hljs-string">"E-commerce App CI/CD"</span>]
    <span class="hljs-attr">types:</span> [<span class="hljs-string">completed</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">analyze-performance:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Download</span> <span class="hljs-string">workflow</span> <span class="hljs-string">artifacts</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/github-script@v6</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">script:</span> <span class="hljs-string">|
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
</span>            
            <span class="hljs-string">//</span> <span class="hljs-string">分析执行时间</span>
            <span class="hljs-string">const</span> <span class="hljs-string">runDuration</span> <span class="hljs-string">=</span> <span class="hljs-string">new</span> <span class="hljs-string">Date(context.payload.workflow_run.updated_at)</span> <span class="hljs-bullet">-</span> 
                               <span class="hljs-string">new</span> <span class="hljs-string">Date(context.payload.workflow_run.run_started_at);</span>
            
            <span class="hljs-string">console.log(`Workflow</span> <span class="hljs-string">took</span> <span class="hljs-string">${runDuration</span> <span class="hljs-string">/</span> <span class="hljs-number">1000</span><span class="hljs-string">}</span> <span class="hljs-string">seconds`);</span>
            
            <span class="hljs-string">//</span> <span class="hljs-string">发送到监控系统</span>
            <span class="hljs-string">//</span> <span class="hljs-string">...</span>
            
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Send</span> <span class="hljs-string">to</span> <span class="hljs-string">monitoring</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 发送指标到Prometheus/Grafana
          echo "ci_duration_seconds $DURATION" | \
            curl -X POST -H "Content-Type: text/plain" \
            --data-binary @- http://monitoring.xxxx.com/metrics
</span></code></pre>
<h3 data-id="heading-37">八：常见问题</h3>
<h4 data-id="heading-38">8.1 GitHub Actions常见问题</h4>
<p><strong>Q：工作流运行太慢怎么办？</strong></p>
<p>A：优化手段：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 使用缓存</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">~/.pub-cache</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">}}-pub-${{</span> <span class="hljs-string">hashFiles('pubspec.lock')</span> <span class="hljs-string">}}</span>

<span class="hljs-comment"># 2. 并行执行独立任务</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test-android:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
  <span class="hljs-attr">test-ios:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">macos-latest</span>
  <span class="hljs-comment"># 两个任务会并行执行</span>

<span class="hljs-comment"># 3. 项目大可以考虑使用自托管Runner</span>
<span class="hljs-attr">runs-on:</span> [<span class="hljs-string">self-hosted</span>, <span class="hljs-string">linux</span>, <span class="hljs-string">x64</span>]
</code></pre>
<p><strong>Q：iOS构建失败，证书问题？</strong></p>
<p>A：iOS证书配置流程：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 导出开发证书</span>
openssl pkcs12 -<span class="hljs-keyword">in</span> certificate.p12 -out certificate.pem -nodes

<span class="hljs-comment"># 2. 在GitHub Secrets中存储</span>
<span class="hljs-comment"># 使用base64编码</span>
<span class="hljs-built_in">base64</span> -i certificate.p12 &gt; certificate.txt

<span class="hljs-comment"># 3. 在CI中还原</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">${{ secrets.IOS_CERTIFICATE }</span>}"</span> | <span class="hljs-built_in">base64</span> --decode &gt; certificate.p12
security import certificate.p12 -k build.keychain -P <span class="hljs-string">"<span class="hljs-variable">${{ secrets.CERT_PASSWORD }</span>}"</span>
</code></pre>
<p><strong>Q：如何调试失败的CI？</strong></p>
<p>A：调试技巧：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 启用调试日志</span>
<span class="hljs-attr">run:</span> <span class="hljs-string">|
  # 显示详细日志
  flutter build apk --verbose
</span>  
  <span class="hljs-comment"># 或使用环境变量</span>
  <span class="hljs-attr">env:</span>
    <span class="hljs-attr">FLUTTER_VERBOSE:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 2. 上传构建日志</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">build</span> <span class="hljs-string">logs</span>
  <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/upload-artifact@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">build-logs</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">|
      ~/flutter/bin/cache/
      build/
</span>      
<span class="hljs-comment"># 3. 使用tmate进行SSH调试</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">tmate</span> <span class="hljs-string">session</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">mxschmitt/action-tmate@v3</span>
  <span class="hljs-attr">if:</span> <span class="hljs-string">failure()</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">github.ref</span> <span class="hljs-string">==</span> <span class="hljs-string">'refs/heads/main'</span>
</code></pre>
<h4 data-id="heading-39">8.2 Flutter问题</h4>
<p><strong>Q：不同版本兼容性？</strong></p>
<p>A：版本管理策略：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 使用版本测试兼容性</span>
<span class="hljs-attr">strategy:</span>
  <span class="hljs-attr">matrix:</span>
    <span class="hljs-attr">flutter-version:</span> [<span class="hljs-string">'3.7.x'</span>, <span class="hljs-string">'3.10.x'</span>, <span class="hljs-string">'stable'</span>]
    
<span class="hljs-comment"># 在代码中检查版本</span>
<span class="hljs-string">void</span> <span class="hljs-string">checkFlutterVersion()</span> {
  <span class="hljs-string">const</span> <span class="hljs-string">minVersion</span> <span class="hljs-string">=</span> <span class="hljs-string">'3.7.0'</span><span class="hljs-string">;</span>
  <span class="hljs-string">final</span> <span class="hljs-string">currentVersion</span> <span class="hljs-string">=</span> <span class="hljs-string">FlutterVersion.instance.version;</span>
  
  <span class="hljs-string">if</span> <span class="hljs-string">(Version.parse(currentVersion)</span> <span class="hljs-string">&lt;</span> <span class="hljs-string">Version.parse(minVersion))</span> {
    <span class="hljs-string">throw</span> <span class="hljs-string">Exception('Flutter</span> <span class="hljs-string">version</span> <span class="hljs-string">$minVersion</span> <span class="hljs-string">or</span> <span class="hljs-string">higher</span> <span class="hljs-string">required');</span>
  }
}
</code></pre>
<p><strong>Q：Web构建失败？</strong></p>
<p>A：Web构建配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 确保启用Web支持</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enable</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">flutter</span> <span class="hljs-string">config</span> <span class="hljs-string">--enable-web</span>

<span class="hljs-comment"># 构建Web版本</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">for</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    flutter build web \
      --web-renderer canvaskit \
      --release \
      --dart-define=FLUTTER_WEB_USE_SKIA=true
      
</span><span class="hljs-comment"># 处理Web特定问题</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Fix</span> <span class="hljs-string">web</span> <span class="hljs-string">issues</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    # 清理缓存
    flutter clean
</span>    
    <span class="hljs-comment"># 更新Web引擎</span>
    <span class="hljs-string">flutter</span> <span class="hljs-string">precache</span> <span class="hljs-string">--web</span>
</code></pre>
<h4 data-id="heading-40">8.3 安全与权限问题</h4>
<p><strong>Q：如何管理敏感信息？</strong></p>
<p>A：安全实践：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 使用环境级别的Secrets</span>
<span class="hljs-attr">env:</span>
  <span class="hljs-attr">SUPER_SECRET_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.PRODUCTION_KEY</span> <span class="hljs-string">}}</span>

<span class="hljs-comment"># 2. 最小权限原则</span>
<span class="hljs-attr">permissions:</span>
  <span class="hljs-attr">contents:</span> <span class="hljs-string">read</span>
  <span class="hljs-attr">packages:</span> <span class="hljs-string">write</span>  <span class="hljs-comment"># 只有需要时才写</span>
  
<span class="hljs-comment"># 3. 使用临时凭证</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">AWS</span> <span class="hljs-string">credentials</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">aws-actions/configure-aws-credentials@v1</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">aws-access-key-id:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_ACCESS_KEY_ID</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">aws-secret-access-key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="hljs-string">}}</span>
    <span class="hljs-attr">aws-region:</span> <span class="hljs-string">us-east-1</span>
    
<span class="hljs-comment"># 4. 定期轮换密钥</span>
<span class="hljs-comment"># 设置提醒每月更新一次Secrets</span>
</code></pre>
<h3 data-id="heading-41">最后</h3>
<p>通过这篇教程我们掌握了Flutter CI/CD的核心知识，一个完美的流水线是一次次迭代出来的，需要不断优化。<strong>如果觉得文章对你有帮助，别忘了一键三连，支持一下</strong></p>
<hr/>
<p><strong>有任何问题或想法，欢迎在评论区交流讨论。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Gemini简直无敌了】掌间星河：通过MediaPipe实现手势控制粒子]]></title>    <link>https://juejin.cn/post/7585463258690863113</link>    <guid>https://juejin.cn/post/7585463258690863113</guid>    <pubDate>2025-12-20T09:15:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463258690863113" data-draft-id="7585706951583416329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Gemini简直无敌了】掌间星河：通过MediaPipe实现手势控制粒子"/> <meta itemprop="keywords" content="Gemini,React.js"/> <meta itemprop="datePublished" content="2025-12-20T09:15:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小鱼小鱼干"/> <meta itemprop="url" content="https://juejin.cn/user/2162083945256777"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Gemini简直无敌了】掌间星河：通过MediaPipe实现手势控制粒子
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2162083945256777/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小鱼小鱼干
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:15:45.000Z" title="Sat Dec 20 2025 09:15:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>受掘金大佬“不如摸鱼去”的启发，我也试试 Gemini 3做一下手势+粒子交互， 确实学到了不少东西，在这里简单的分享下。
github地址：掌间星河：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuijieya%2FGesture-Galaxy.git" target="_blank" title="https://github.com/huijieya/Gesture-Galaxy.git" ref="nofollow noopener noreferrer">github.com/huijieya/Ge…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25f905388d114ac69818a85dd2cf3cf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85bCP6bG85bmy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826945&amp;x-signature=lrD0UZyeu9uscVe8UxT8t66b%2FIE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript">基于原生h5、浏览器、<span class="hljs-variable constant_">PC</span>摄像头实现手势控制粒子特效交互的逻辑，粒子默认离散，类似银河系分布缓慢移动，同时有<span class="hljs-number">5</span>种手势：

手势<span class="hljs-number">1</span>: 握拳，握拳后粒子聚拢显示爱心的形状

手势<span class="hljs-number">2</span>: 展开手掌并挥手，展开手掌挥手后粒子从当前状态恢复到离散状态

手势<span class="hljs-number">3</span>: 👆 比 <span class="hljs-number">1</span> ：只有食指伸直，其他 <span class="hljs-number">3</span> 根弯曲，此时粒子聚拢显示第一句话：春来夏往

手势<span class="hljs-number">4</span>: ✌ 比 <span class="hljs-number">2</span> ：只有食指和中指伸直，其他 <span class="hljs-number">2</span> 根弯曲手此时粒子聚拢显示第二句话： 秋收冬藏

手势<span class="hljs-number">5</span>: 👌 比 <span class="hljs-number">3</span> ：只有中指、无名指、小指伸直，食指弯曲，此时粒子聚拢显示第三句话：我们来日方长
</code></pre>
<h2 data-id="heading-0">效果展示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692793d7f1254e37a0fa1f4787aa72a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6bG85bCP6bG85bmy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766826945&amp;x-signature=AUwLnI1AilLfnzkzxYmDz7tjPvI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">源码地址</h2>
<p>掌间星河：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuijieya%2FGesture-Galaxy.git" target="_blank" title="https://github.com/huijieya/Gesture-Galaxy.git" ref="nofollow noopener noreferrer">github.com/huijieya/Ge…</a></p>
<h2 data-id="heading-2">源码分析</h2>
<h3 data-id="heading-3">手势识别流程</h3>
<h4 data-id="heading-4">1. 手部检测初始化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// HandTracker.tsx 中初始化 MediaPipe Hands</span>
<span class="hljs-keyword">const</span> hands = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-title class_">Hands</span>({
  <span class="hljs-attr">locateFile</span>: <span class="hljs-function">(<span class="hljs-params">file: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-string">`https://cdn.jsdelivr.net/npm/@mediapipe/hands/<span class="hljs-subst">${file}</span>`</span>
});

hands.<span class="hljs-title function_">setOptions</span>({
  <span class="hljs-attr">maxNumHands</span>: <span class="hljs-number">1</span>,           <span class="hljs-comment">// 最多检测一只手</span>
  <span class="hljs-attr">modelComplexity</span>: <span class="hljs-number">1</span>,       <span class="hljs-comment">// 模型复杂度</span>
  <span class="hljs-attr">minDetectionConfidence</span>: <span class="hljs-number">0.7</span>,  <span class="hljs-comment">// 最小检测置信度</span>
  <span class="hljs-attr">minTrackingConfidence</span>: <span class="hljs-number">0.7</span>    <span class="hljs-comment">// 最小跟踪置信度</span>
});
</code></pre>
<h4 data-id="heading-5">2. 手部关键点获取</h4>
<p>MediaPipe 会检测手部的21个关键点（landmarks），每个关键点包含 x, y, z 坐标：</p>
<ul>
<li>指尖: 4(拇指), 8(食指), 12(中指), 16(无名指), 20(小指)</li>
<li>指关节: 用于判断手指是否伸直</li>
</ul>
<h4 data-id="heading-6">3. 手势分类逻辑</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// gestureLogic.ts 中的 classifyGesture 函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">isExtended</span> = (<span class="hljs-params">tipIdx: <span class="hljs-built_in">number</span>, mcpIdx: <span class="hljs-built_in">number</span></span>) =&gt; landmarks[tipIdx].<span class="hljs-property">y</span> &lt; landmarks[mcpIdx].<span class="hljs-property">y</span>;

<span class="hljs-comment">// 判断各手指是否伸直</span>
<span class="hljs-keyword">const</span> indexExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">8</span>, <span class="hljs-number">5</span>);   <span class="hljs-comment">// 食指</span>
<span class="hljs-keyword">const</span> middleExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">12</span>, <span class="hljs-number">9</span>); <span class="hljs-comment">// 中指</span>
<span class="hljs-keyword">const</span> ringExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">16</span>, <span class="hljs-number">13</span>);  <span class="hljs-comment">// 无名指</span>
<span class="hljs-keyword">const</span> pinkyExt = <span class="hljs-title function_">isExtended</span>(<span class="hljs-number">20</span>, <span class="hljs-number">17</span>); <span class="hljs-comment">// 小指</span>

<span class="hljs-comment">// 根据手指状态识别不同手势</span>
<span class="hljs-keyword">if</span> (!indexExt &amp;&amp; !middleExt &amp;&amp; !ringExt &amp;&amp; !pinkyExt) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">HEART</span>; <span class="hljs-comment">// 握拳 - 显示爱心</span>
}
<span class="hljs-keyword">if</span> (indexExt &amp;&amp; middleExt &amp;&amp; ringExt &amp;&amp; pinkyExt) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">GALAXY</span>; <span class="hljs-comment">// 手掌展开 - 银河状态</span>
}
<span class="hljs-comment">// ... 其他手势判断</span>
</code></pre>
<h3 data-id="heading-7">粒子绘制机制</h3>
<h4 data-id="heading-8">1. 粒子系统初始化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ParticleCanvas.tsx 中初始化粒子</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">particles</span>: <span class="hljs-title class_">Particle</span>[] = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">PARTICLE_COUNT</span>; i++) {
    particles.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,     <span class="hljs-comment">// 随机初始位置</span>
      <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
      <span class="hljs-attr">targetX</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-comment">// 目标位置</span>
      <span class="hljs-attr">targetY</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
      <span class="hljs-attr">vx</span>: <span class="hljs-number">0</span>,                                    <span class="hljs-comment">// 速度</span>
      <span class="hljs-attr">vy</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">size</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1.5</span> + <span class="hljs-number">0.5</span>,          <span class="hljs-comment">// 大小</span>
      <span class="hljs-attr">color</span>: <span class="hljs-variable constant_">COLORS</span>[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable constant_">COLORS</span>.<span class="hljs-property">length</span>)], <span class="hljs-comment">// 颜色</span>
      <span class="hljs-attr">alpha</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.4</span> + <span class="hljs-number">0.4</span>,         <span class="hljs-comment">// 透明度</span>
    });
  }
  particlesRef.<span class="hljs-property">current</span> = particles;
}, []);
</code></pre>
<h4 data-id="heading-9">2. 形状生成算法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> getShapePoints = (<span class="hljs-attr">type</span>: <span class="hljs-title class_">GestureType</span>, <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Point</span>[] =&gt; {
  <span class="hljs-keyword">const</span> centerX = width / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">const</span> centerY = height / <span class="hljs-number">2</span>;
  
  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">HEART</span>: 
      <span class="hljs-comment">// 心形方程参数化生成点</span>
      <span class="hljs-comment">// x = 16sin³(t)</span>
      <span class="hljs-comment">// y = 13cos(t) - 5cos(2t) - 2cos(3t) - cos(4t)</span>
      
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">TEXT_1</span>/<span class="hljs-number">2</span>/<span class="hljs-number">3</span>:
      <span class="hljs-comment">// 使用 Canvas 绘制文字并提取像素点</span>
      
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">GestureType</span>.<span class="hljs-property">GALAXY</span>:
    <span class="hljs-attr">default</span>:
      <span class="hljs-comment">// 螺旋银河形状</span>
      <span class="hljs-keyword">const</span> angle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> r = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(), <span class="hljs-number">0.7</span>) * maxRadius;
      <span class="hljs-keyword">const</span> spiralFactor = <span class="hljs-number">2.0</span>;
      <span class="hljs-keyword">const</span> offset = r * (spiralFactor / maxRadius) * <span class="hljs-number">5</span>;
      points.<span class="hljs-title function_">push</span>({ 
        <span class="hljs-attr">x</span>: centerX + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle + offset) * r, 
        <span class="hljs-attr">y</span>: centerY + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle + offset) * r 
      });
  }
}
</code></pre>
<h4 data-id="heading-10">3. 粒子动画更新</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 粒子运动和渲染循环</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">render</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 半透明背景覆盖产生拖尾效果</span>
  ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(0, 0, 0, 0.18)'</span>;
  ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
  
  particlesRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> {
    <span class="hljs-comment">// 平滑插值移动到目标位置</span>
    p.<span class="hljs-property">x</span> += (tx - p.<span class="hljs-property">x</span>) * <span class="hljs-variable constant_">LERP_FACTOR</span>;
    p.<span class="hljs-property">y</span> += (ty - p.<span class="hljs-property">y</span>) * <span class="hljs-variable constant_">LERP_FACTOR</span>;
    
    <span class="hljs-comment">// 手势交互影响粒子位置</span>
    <span class="hljs-keyword">if</span> (hPos &amp;&amp; canInteract) {
      <span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">x</span> - hPos.<span class="hljs-property">x</span>;
      <span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">y</span> - hPos.<span class="hljs-property">y</span>;
      <span class="hljs-keyword">const</span> distSq = dx * dx + dy * dy;
      <span class="hljs-keyword">if</span> (distSq &lt; <span class="hljs-variable constant_">INTERACTION_RADIUS</span> * <span class="hljs-variable constant_">INTERACTION_RADIUS</span>) {
        <span class="hljs-comment">// 排斥力计算</span>
        <span class="hljs-keyword">const</span> dist = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(distSq);
        <span class="hljs-keyword">const</span> force = (<span class="hljs-number">1</span> - dist / <span class="hljs-variable constant_">INTERACTION_RADIUS</span>) * <span class="hljs-variable constant_">INTERACTION_STRENGTH</span>;
        p.<span class="hljs-property">x</span> += dx * force;
        p.<span class="hljs-property">y</span> += dy * force;
      }
    }
    
    <span class="hljs-comment">// 添加随机扰动使粒子更生动</span>
    p.<span class="hljs-property">x</span> += (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.6</span>;
    p.<span class="hljs-property">y</span> += (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.6</span>;
    
    <span class="hljs-comment">// 绘制粒子</span>
    ctx.<span class="hljs-property">fillStyle</span> = p.<span class="hljs-property">color</span>;
    ctx.<span class="hljs-property">globalAlpha</span> = p.<span class="hljs-property">alpha</span>;
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(p.<span class="hljs-property">x</span>, p.<span class="hljs-property">y</span>, p.<span class="hljs-property">size</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
  });
  
  animationRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">requestAnimationFrame</span>(render);
};
</code></pre>
<h4 data-id="heading-11">4. 银河旋转效果</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 银河状态下的旋转动画</span>
galaxyAngleRef.<span class="hljs-property">current</span> += <span class="hljs-variable constant_">GALAXY_ROTATION_SPEED</span>;
<span class="hljs-keyword">const</span> cosA = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(galaxyAngleRef.<span class="hljs-property">current</span>);
<span class="hljs-keyword">const</span> sinA = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(galaxyAngleRef.<span class="hljs-property">current</span>);

<span class="hljs-comment">// 对每个粒子应用旋转变换</span>
<span class="hljs-keyword">const</span> dx = p.<span class="hljs-property">targetX</span> - cx;
<span class="hljs-keyword">const</span> dy = p.<span class="hljs-property">targetY</span> - cy;
tx = cx + dx * cosA - dy * sinA;
ty = cy + dx * sinA + dy * cosA;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ConcurrentHashMap实现原理]]></title>    <link>https://juejin.cn/post/7585468725332394038</link>    <guid>https://juejin.cn/post/7585468725332394038</guid>    <pubDate>2025-12-20T09:20:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332394038" data-draft-id="7585412203978948651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ConcurrentHashMap实现原理"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-20T09:20:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="無量"/> <meta itemprop="url" content="https://juejin.cn/user/1116759546145086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ConcurrentHashMap实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759546145086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    無量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:20:39.000Z" title="Sat Dec 20 2025 09:20:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读30分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、理论知识与核心概念</h2>
<h3 data-id="heading-1">1.1 为什么需要ConcurrentHashMap？</h3>
<p>在多线程环境下，我们经常需要使用Map来存储共享数据。但普通的<code>HashMap</code>并不是线程安全的，在高并发场景下会出现严重问题。</p>
<p><strong>HashMap的线程不安全问题：</strong></p>
<ol>
<li>
<p><strong>数据丢失</strong>：多个线程同时put，可能导致一个线程的数据被覆盖</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1和线程2同时执行put</span>
Thread-<span class="hljs-number">1</span>: put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>)  <span class="hljs-comment">// 计算到index=5</span>
Thread-<span class="hljs-number">2</span>: put(<span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>)  <span class="hljs-comment">// 也计算到index=5</span>
<span class="hljs-comment">// 结果：只有一个数据被保存，另一个丢失</span>
</code></pre>
</li>
<li>
<p><strong>死循环问题（JDK 1.7）</strong>：扩容时多线程并发导致链表成环</p>
<ul>
<li>线程A扩容到一半被挂起</li>
<li>线程B完成扩容，链表反转</li>
<li>线程A恢复执行，形成环形链表</li>
<li>get操作时CPU 100%，无限循环</li>
</ul>
</li>
<li>
<p><strong>数据不一致</strong>：size()返回值不准确，迭代过程中数据变化</p>
</li>
</ol>
<h3 data-id="heading-2">1.2 Hashtable的性能问题</h3>
<p><code>Hashtable</code>通过对所有方法加<code>synchronized</code>实现线程安全，但性能极差：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> { ... }
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> { ... }
</code></pre>
<p><strong>性能问题</strong>：</p>
<ul>
<li><strong>全表锁</strong>：无论操作哪个桶，都要锁住整个表</li>
<li><strong>读写互斥</strong>：即使只是读取，也需要等待写操作释放锁</li>
<li><strong>并发度为1</strong>：同一时刻只允许一个线程访问</li>
</ul>
<p><strong>性能测试数据</strong>：</p>
<ul>
<li>单线程：HashMap ≈ Hashtable</li>
<li>10线程并发：HashMap不安全，Hashtable吞吐量仅为HashMap的1/10</li>
</ul>
<h3 data-id="heading-3">1.3 Collections.synchronizedMap的局限性</h3>
<p><code>Collections.synchronizedMap</code>是对Map的简单包装：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;K,V&gt; syncMap = Collections.synchronizedMap(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());

<span class="hljs-comment">// 底层实现</span>
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">synchronized</span> (mutex) {  <span class="hljs-comment">// mutex = this</span>
        <span class="hljs-keyword">return</span> m.put(key, value);
    }
}
</code></pre>
<p><strong>局限性</strong>：</p>
<ul>
<li>本质仍是<strong>全表锁</strong>，性能与Hashtable类似</li>
<li>迭代时需要手动加锁，否则抛<code>ConcurrentModificationException</code></li>
<li>复合操作（如putIfAbsent）不是原子的，需要额外加锁</li>
</ul>
<h3 data-id="heading-4">1.4 ConcurrentHashMap的设计目标</h3>
<p>为了解决上述问题，<code>ConcurrentHashMap</code>应运而生，设计目标：</p>
<ol>
<li><strong>高并发</strong>：支持高并发读写，锁粒度细化</li>
<li><strong>高性能</strong>：读操作无锁，写操作局部锁</li>
<li><strong>线程安全</strong>：保证数据一致性</li>
<li><strong>弱一致性</strong>：允许读到稍旧的数据，换取性能</li>
</ol>
<p><strong>核心思想</strong>：</p>
<ul>
<li><strong>分段锁（JDK 1.7）</strong>：将Map分为多个Segment，每个Segment独立加锁</li>
<li><strong>CAS + synchronized（JDK 1.8）</strong>：更细粒度的锁，锁定单个Node</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、原理深度剖析</h2>
<h3 data-id="heading-6">2.1 JDK 1.7 Segment分段锁机制</h3>
<h4 data-id="heading-7">2.1.1 Segment数组结构</h4>
<p>JDK 1.7的<code>ConcurrentHashMap</code>采用<strong>Segment数组 + HashEntry数组 + 链表</strong>的结构：</p>
<pre><code class="hljs language-css" lang="css">ConcurrentHashMap
    |
    +-- Segment<span class="hljs-selector-attr">[0]</span> (extends ReentrantLock)
    |       |
    |       +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
    |               |
    |               +-- HashEntry -&gt; HashEntry -&gt; null (链表)
    |
    +-- Segment<span class="hljs-selector-attr">[1]</span>
    |       |
    |       +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
    |
    +-- Segment<span class="hljs-selector-attr">[15]</span>  (默认<span class="hljs-number">16</span>个Segment)
            |
            +-- HashEntry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
</code></pre>
<p><strong>核心数据结构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt; {
    <span class="hljs-comment">// Segment数组</span>
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments;

    <span class="hljs-comment">// Segment继承ReentrantLock</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Segment</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReentrantLock</span> {
        <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt;[] table;  <span class="hljs-comment">// HashEntry数组</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> count;  <span class="hljs-comment">// Segment中元素数量</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> modCount;  <span class="hljs-comment">// 修改次数</span>
        <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> threshold;  <span class="hljs-comment">// 扩容阈值</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> loadFactor;  <span class="hljs-comment">// 加载因子</span>
    }

    <span class="hljs-comment">// HashEntry节点</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V value;
        <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt; next;  <span class="hljs-comment">// volatile保证可见性</span>
    }
}
</code></pre>
<p><strong>关键参数：</strong></p>
<ul>
<li><strong>concurrencyLevel（并发度）</strong>：Segment数组长度，默认16</li>
<li><strong>initialCapacity</strong>：初始容量，默认16</li>
<li><strong>loadFactor</strong>：加载因子，默认0.75</li>
</ul>
<h4 data-id="heading-8">2.1.2 put操作流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    Segment&lt;K,V&gt; s;
    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();  <span class="hljs-comment">// value不允许null</span>

    <span class="hljs-comment">// 1. 计算hash值</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(key);

    <span class="hljs-comment">// 2. 定位Segment (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;

    <span class="hljs-comment">// 3. 获取Segment</span>
    <span class="hljs-keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject(segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="hljs-literal">null</span>)
        s = ensureSegment(j);  <span class="hljs-comment">// 延迟初始化Segment</span>

    <span class="hljs-comment">// 4. 调用Segment的put方法</span>
    <span class="hljs-keyword">return</span> s.put(key, hash, value, <span class="hljs-literal">false</span>);
}

<span class="hljs-comment">// Segment的put方法</span>
<span class="hljs-keyword">final</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, <span class="hljs-type">int</span> hash, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-comment">// 1. 尝试获取锁(tryLock)</span>
    HashEntry&lt;K,V&gt; node = tryLock() ? <span class="hljs-literal">null</span> :
        scanAndLockForPut(key, hash, value);  <span class="hljs-comment">// 失败则自旋获取锁</span>

    V oldValue;
    <span class="hljs-keyword">try</span> {
        HashEntry&lt;K,V&gt;[] tab = table;
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (tab.length - <span class="hljs-number">1</span>) &amp; hash;  <span class="hljs-comment">// 定位桶</span>
        HashEntry&lt;K,V&gt; first = entryAt(tab, index);  <span class="hljs-comment">// 获取链表头</span>

        <span class="hljs-comment">// 2. 遍历链表</span>
        <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) {
            <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
                K k;
                <span class="hljs-comment">// 找到相同key，替换value</span>
                <span class="hljs-keyword">if</span> ((k = e.key) == key ||
                    (e.hash == hash &amp;&amp; key.equals(k))) {
                    oldValue = e.value;
                    <span class="hljs-keyword">if</span> (!onlyIfAbsent) {
                        e.value = value;
                        ++modCount;
                    }
                    <span class="hljs-keyword">break</span>;
                }
                e = e.next;
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 3. 插入新节点</span>
                <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span>)
                    node.setNext(first);  <span class="hljs-comment">// 头插法</span>
                <span class="hljs-keyword">else</span>
                    node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, first);

                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> count + <span class="hljs-number">1</span>;
                <span class="hljs-comment">// 4. 判断是否需要扩容</span>
                <span class="hljs-keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)
                    rehash(node);
                <span class="hljs-keyword">else</span>
                    setEntryAt(tab, index, node);
                ++modCount;
                count = c;
                oldValue = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">break</span>;
            }
        }
    } <span class="hljs-keyword">finally</span> {
        unlock();  <span class="hljs-comment">// 释放锁</span>
    }
    <span class="hljs-keyword">return</span> oldValue;
}
</code></pre>
<p><strong>流程总结：</strong></p>
<ol>
<li>计算hash，定位Segment</li>
<li>Segment加锁（ReentrantLock）</li>
<li>定位HashEntry桶位置</li>
<li>遍历链表，找到则替换，否则头插法插入</li>
<li>判断是否扩容</li>
<li>释放锁</li>
</ol>
<h4 data-id="heading-9">2.1.3 get操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Segment&lt;K,V&gt; s;
    HashEntry&lt;K,V&gt;[] tab;

    <span class="hljs-comment">// 1. 计算hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> hash(key);

    <span class="hljs-comment">// 2. 定位Segment</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;

    <span class="hljs-comment">// 3. 无锁获取Segment和table</span>
    <span class="hljs-keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != <span class="hljs-literal">null</span> &amp;&amp;
        (tab = s.table) != <span class="hljs-literal">null</span>) {

        <span class="hljs-comment">// 4. 遍历链表查找（无锁）</span>
        <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile
                 (tab, ((<span class="hljs-type">long</span>)(((tab.length - <span class="hljs-number">1</span>) &amp; h)) &lt;&lt; TSHIFT) + TBASE);
             e != <span class="hljs-literal">null</span>; e = e.next) {
            K k;
            <span class="hljs-keyword">if</span> ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))
                <span class="hljs-keyword">return</span> e.value;  <span class="hljs-comment">// volatile读，保证可见性</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>无锁读取</strong>：get不加锁，依赖volatile保证可见性</li>
<li><strong>UNSAFE操作</strong>：直接从内存读取，保证读到最新值</li>
<li><strong>性能极高</strong>：并发读不会阻塞</li>
</ul>
<h4 data-id="heading-10">2.1.4 扩容机制</h4>
<p><strong>Segment独立扩容</strong>：</p>
<ul>
<li>只扩容单个Segment，不影响其他Segment</li>
<li>扩容时持有Segment锁，阻塞该Segment的写操作</li>
<li>读操作仍可并发进行</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rehash</span><span class="hljs-params">(HashEntry&lt;K,V&gt; node)</span> {
    HashEntry&lt;K,V&gt;[] oldTable = table;
    <span class="hljs-type">int</span> <span class="hljs-variable">oldCapacity</span> <span class="hljs-operator">=</span> oldTable.length;

    <span class="hljs-comment">// 扩容为2倍</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> oldCapacity &lt;&lt; <span class="hljs-number">1</span>;
    threshold = (<span class="hljs-type">int</span>)(newCapacity * loadFactor);

    HashEntry&lt;K,V&gt;[] newTable =
        (HashEntry&lt;K,V&gt;[]) <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>[newCapacity];
    <span class="hljs-type">int</span> <span class="hljs-variable">sizeMask</span> <span class="hljs-operator">=</span> newCapacity - <span class="hljs-number">1</span>;

    <span class="hljs-comment">// 遍历旧table，重新分配节点</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; oldCapacity ; i++) {
        HashEntry&lt;K,V&gt; e = oldTable[i];

        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
            HashEntry&lt;K,V&gt; next = e.next;
            <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> e.hash &amp; sizeMask;

            <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>)  <span class="hljs-comment">// 单节点直接放入</span>
                newTable[idx] = e;
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 遍历链表，重新hash分配</span>
                HashEntry&lt;K,V&gt; lastRun = e;
                <span class="hljs-type">int</span> <span class="hljs-variable">lastIdx</span> <span class="hljs-operator">=</span> idx;
                <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; last = next;
                     last != <span class="hljs-literal">null</span>;
                     last = last.next) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> last.hash &amp; sizeMask;
                    <span class="hljs-keyword">if</span> (k != lastIdx) {
                        lastIdx = k;
                        lastRun = last;
                    }
                }
                newTable[lastIdx] = lastRun;

                <span class="hljs-comment">// Clone remaining nodes</span>
                <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) {
                    <span class="hljs-type">V</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> p.value;
                    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> p.hash;
                    <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> h &amp; sizeMask;
                    HashEntry&lt;K,V&gt; n = newTable[k];
                    newTable[k] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(h, p.key, v, n);
                }
            }
        }
    }

    <span class="hljs-comment">// 插入新节点</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">nodeIndex</span> <span class="hljs-operator">=</span> node.hash &amp; sizeMask;
    node.setNext(newTable[nodeIndex]);
    newTable[nodeIndex] = node;
    table = newTable;
}
</code></pre>
<h4 data-id="heading-11">2.1.5 size()方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="hljs-built_in">this</span>.segments;
    <span class="hljs-type">int</span> size;
    <span class="hljs-type">boolean</span> overflow;
    <span class="hljs-type">long</span> sum;
    <span class="hljs-type">long</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">retries</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">for</span> (;;) {
            <span class="hljs-comment">// 1. 尝试2次无锁统计</span>
            <span class="hljs-keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) {
                <span class="hljs-comment">// 2. 失败则锁定所有Segment</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)
                    ensureSegment(j).lock();
            }

            sum = <span class="hljs-number">0L</span>;
            size = <span class="hljs-number">0</span>;
            overflow = <span class="hljs-literal">false</span>;

            <span class="hljs-comment">// 3. 累加所有Segment的count</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j) {
                Segment&lt;K,V&gt; seg = segmentAt(segments, j);
                <span class="hljs-keyword">if</span> (seg != <span class="hljs-literal">null</span>) {
                    sum += seg.modCount;
                    <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> seg.count;
                    <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || (size += c) &lt; <span class="hljs-number">0</span>)
                        overflow = <span class="hljs-literal">true</span>;
                }
            }

            <span class="hljs-comment">// 4. modCount未变化，说明期间没有修改，返回</span>
            <span class="hljs-keyword">if</span> (sum == last)
                <span class="hljs-keyword">break</span>;
            last = sum;
        }
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) {
            <span class="hljs-comment">// 释放所有Segment锁</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)
                segmentAt(segments, j).unlock();
        }
    }
    <span class="hljs-keyword">return</span> overflow ? Integer.MAX_VALUE : size;
}
</code></pre>
<p><strong>策略：</strong></p>
<ul>
<li>先尝试2次无锁统计，通过比较<code>modCount</code>判断是否有修改</li>
<li>如果2次统计结果一致，说明期间无修改，直接返回</li>
<li>否则锁定所有Segment，再次统计</li>
</ul>
<h4 data-id="heading-12">2.1.6 优缺点分析</h4>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 分段锁，并发度高（默认16）</li>
<li>✅ 读操作无锁，性能好</li>
<li>✅ 写操作只锁单个Segment，不影响其他Segment</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ Segment粒度较粗，并发度受限于Segment数量</li>
<li>❌ 扩容时需要锁定Segment</li>
<li>❌ 结构复杂，内存占用较大</li>
</ul>
<hr/>
<h3 data-id="heading-13">2.2 JDK 1.8 CAS + synchronized实现原理</h3>
<h4 data-id="heading-14">2.2.1 数据结构变化</h4>
<p>JDK 1.8完全重构，<strong>取消Segment</strong>，改为<strong>Node数组 + 链表/红黑树</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">ConcurrentHashMap
    |
    +-- Node<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span>
            |
            +-- Node<span class="hljs-selector-attr">[0]</span> -&gt; Node -&gt; Node (链表)
            |
            +-- Node<span class="hljs-selector-attr">[1]</span> -&gt; TreeNode (红黑树)
            |                 / \
            |                /   \
            |           TreeNode TreeNode
            |
            +-- Node<span class="hljs-selector-attr">[2]</span> -&gt; ForwardingNode (扩容标记)
</code></pre>
<p><strong>核心数据结构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt; {
    <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt;[] table;  <span class="hljs-comment">// Node数组</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;  <span class="hljs-comment">// 扩容时的新表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> baseCount;  <span class="hljs-comment">// 元素数量基数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> sizeCtl;  <span class="hljs-comment">// 控制标识符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> CounterCell[] counterCells;  <span class="hljs-comment">// 计数数组</span>

    <span class="hljs-comment">// Node节点（链表）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash;
        <span class="hljs-keyword">final</span> K key;
        <span class="hljs-keyword">volatile</span> V val;  <span class="hljs-comment">// volatile保证可见性</span>
        <span class="hljs-keyword">volatile</span> Node&lt;K,V&gt; next;
    }

    <span class="hljs-comment">// TreeNode（红黑树）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
        TreeNode&lt;K,V&gt; parent;
        TreeNode&lt;K,V&gt; left;
        TreeNode&lt;K,V&gt; right;
        TreeNode&lt;K,V&gt; prev;
        <span class="hljs-type">boolean</span> red;
    }

    <span class="hljs-comment">// ForwardingNode（扩容标记节点）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardingNode</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt; {
        <span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] nextTable;
        ForwardingNode(Node&lt;K,V&gt;[] tab) {
            <span class="hljs-built_in">super</span>(MOVED, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// hash = MOVED = -1</span>
            <span class="hljs-built_in">this</span>.nextTable = tab;
        }
    }
}
</code></pre>
<p><strong>关键变化：</strong></p>
<ul>
<li><strong>Node数组</strong>：取代Segment数组，直接存储Node</li>
<li><strong>TreeNode</strong>：链表长度≥8且数组长度≥64时，转为红黑树</li>
<li><strong>ForwardingNode</strong>：标记正在迁移的桶，hash值为-1</li>
</ul>
<h4 data-id="heading-15">2.2.2 put操作详细流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">return</span> putVal(key, value, <span class="hljs-literal">false</span>);
}

<span class="hljs-keyword">final</span> V <span class="hljs-title function_">putVal</span><span class="hljs-params">(K key, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> {
    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();

    <span class="hljs-comment">// 1. 计算hash（扰动函数）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> spread(key.hashCode());
    <span class="hljs-type">int</span> <span class="hljs-variable">binCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> n, i, fh;

        <span class="hljs-comment">// 情况1: table未初始化</span>
        <span class="hljs-keyword">if</span> (tab == <span class="hljs-literal">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)
            tab = initTable();

        <span class="hljs-comment">// 情况2: 桶为空，CAS插入（无锁）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; hash)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>,
                         <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="hljs-literal">null</span>)))
                <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// CAS成功，插入完成</span>
        }

        <span class="hljs-comment">// 情况3: 正在扩容（hash == MOVED）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);  <span class="hljs-comment">// 帮助扩容</span>

        <span class="hljs-comment">// 情况4: hash冲突，synchronized锁定桶</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-type">V</span> <span class="hljs-variable">oldVal</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// 锁定链表/树的头节点</span>
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) {  <span class="hljs-comment">// 双重检查</span>
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 链表</span>
                        binCount = <span class="hljs-number">1</span>;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) {
                            K ek;
                            <span class="hljs-comment">// 找到相同key，替换value</span>
                            <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;
                                ((ek = e.key) == key ||
                                 (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))) {
                                oldVal = e.val;
                                <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                    e.val = value;
                                <span class="hljs-keyword">break</span>;
                            }
                            Node&lt;K,V&gt; pred = e;
                            <span class="hljs-comment">// 到达链表尾部，插入新节点</span>
                            <span class="hljs-keyword">if</span> ((e = e.next) == <span class="hljs-literal">null</span>) {
                                pred.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(hash, key,
                                                          value, <span class="hljs-literal">null</span>);
                                <span class="hljs-keyword">break</span>;
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) {  <span class="hljs-comment">// 红黑树</span>
                        Node&lt;K,V&gt; p;
                        binCount = <span class="hljs-number">2</span>;
                        <span class="hljs-keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,
                                                       value)) != <span class="hljs-literal">null</span>) {
                            oldVal = p.val;
                            <span class="hljs-keyword">if</span> (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }  <span class="hljs-comment">// 释放synchronized锁</span>

            <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 链表长度 &gt;= 8，尝试树化</span>
                <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i);
                <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-literal">null</span>)
                    <span class="hljs-keyword">return</span> oldVal;
                <span class="hljs-keyword">break</span>;
            }
        }
    }

    <span class="hljs-comment">// 增加计数</span>
    addCount(<span class="hljs-number">1L</span>, binCount);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>流程图：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c69b728f5be43718222afb43c84e796~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766827239&amp;x-signature=FOA7KKkZWmPXNHFgQ%2BGa379lN2k%3D" alt="concurrenthashmap-put-flow.svg" loading="lazy"/></p>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>桶为空</strong>：直接CAS插入，无需加锁</li>
<li><strong>正在扩容</strong>：帮助扩容，协作完成</li>
<li><strong>hash冲突</strong>：synchronized锁定<strong>头节点</strong>，粒度极细</li>
<li><strong>树化条件</strong>：链表长度≥8 <strong>且</strong> 数组长度≥64</li>
</ul>
<h4 data-id="heading-16">2.2.3 get操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> {
    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="hljs-type">int</span> n, eh; K ek;

    <span class="hljs-comment">// 1. 计算hash</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> spread(key.hashCode());

    <span class="hljs-comment">// 2. table不为空 且 桶不为空</span>
    <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;
        (e = tabAt(tab, (n - <span class="hljs-number">1</span>) &amp; h)) != <span class="hljs-literal">null</span>) {

        <span class="hljs-comment">// 3. 检查头节点</span>
        <span class="hljs-keyword">if</span> ((eh = e.hash) == h) {
            <span class="hljs-keyword">if</span> ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))
                <span class="hljs-keyword">return</span> e.val;
        }
        <span class="hljs-comment">// 4. hash &lt; 0: 红黑树或ForwardingNode</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eh &lt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> (p = e.find(h, key)) != <span class="hljs-literal">null</span> ? p.val : <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// 5. 遍历链表</span>
        <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e.hash == h &amp;&amp;
                ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek))))
                <span class="hljs-keyword">return</span> e.val;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>无锁读取</strong>：完全不加锁，依赖volatile保证可见性</li>
<li><strong>ForwardingNode处理</strong>：扩容时通过<code>find()</code>方法在新表中查找</li>
<li><strong>性能极高</strong>：并发读不会阻塞</li>
</ul>
<h4 data-id="heading-17">2.2.4 扩容机制详解</h4>
<p><strong>多线程协作扩容</strong>是JDK 1.8的亮点，核心思想：</p>
<ul>
<li>将扩容任务拆分为多个小任务</li>
<li>多个线程并发迁移不同区间的数据</li>
<li>使用<code>ForwardingNode</code>标记已迁移的桶</li>
</ul>
<p><strong>关键变量：</strong></p>
<ul>
<li><code>sizeCtl</code>：控制标识符
<ul>
<li><code>-1</code>：正在初始化</li>
<li><code>-(1 + nThreads)</code>：正在扩容，nThreads为参与扩容的线程数</li>
<li><code>&gt; 0</code>：下次扩容阈值</li>
</ul>
</li>
<li><code>transferIndex</code>：下一个待迁移的桶索引</li>
<li><code>stride</code>：每个线程处理的桶数量（最小16）</li>
</ul>
<p><strong>扩容流程：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> tab.length, stride;

    <span class="hljs-comment">// 1. 计算每个线程处理的桶数（stride）</span>
    <span class="hljs-keyword">if</span> ((stride = (NCPU &gt; <span class="hljs-number">1</span>) ? (n &gt;&gt;&gt; <span class="hljs-number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)
        stride = MIN_TRANSFER_STRIDE;

    <span class="hljs-comment">// 2. 初始化新表</span>
    <span class="hljs-keyword">if</span> (nextTab == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="hljs-number">1</span>];  <span class="hljs-comment">// 2倍扩容</span>
            nextTab = nt;
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            sizeCtl = Integer.MAX_VALUE;
            <span class="hljs-keyword">return</span>;
        }
        nextTable = nextTab;
        transferIndex = n;  <span class="hljs-comment">// 从后往前迁移</span>
    }

    <span class="hljs-type">int</span> <span class="hljs-variable">nextn</span> <span class="hljs-operator">=</span> nextTab.length;
    ForwardingNode&lt;K,V&gt; fwd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForwardingNode</span>&lt;K,V&gt;(nextTab);
    <span class="hljs-type">boolean</span> <span class="hljs-variable">advance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-variable">finishing</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 3. 循环处理每个桶</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, bound = <span class="hljs-number">0</span>;;) {
        Node&lt;K,V&gt; f; <span class="hljs-type">int</span> fh;

        <span class="hljs-comment">// 3.1 领取任务：CAS获取[bound, i]区间</span>
        <span class="hljs-keyword">while</span> (advance) {
            <span class="hljs-type">int</span> nextIndex, nextBound;
            <span class="hljs-keyword">if</span> (--i &gt;= bound || finishing)
                advance = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="hljs-number">0</span>) {
                i = -<span class="hljs-number">1</span>;
                advance = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (U.compareAndSwapInt
                     (<span class="hljs-built_in">this</span>, TRANSFERINDEX, nextIndex,
                      nextBound = (nextIndex &gt; stride ?
                                   nextIndex - stride : <span class="hljs-number">0</span>))) {
                bound = nextBound;
                i = nextIndex - <span class="hljs-number">1</span>;
                advance = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// 3.2 完成检查</span>
        <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span> || i &gt;= n || i + n &gt;= nextn) {
            <span class="hljs-type">int</span> sc;
            <span class="hljs-keyword">if</span> (finishing) {
                nextTable = <span class="hljs-literal">null</span>;
                table = nextTab;
                sizeCtl = (n &lt;&lt; <span class="hljs-number">1</span>) - (n &gt;&gt;&gt; <span class="hljs-number">1</span>);  <span class="hljs-comment">// 0.75 * 2n</span>
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-comment">// 当前线程完成，扩容线程数-1</span>
            <span class="hljs-keyword">if</span> (U.compareAndSwapInt(<span class="hljs-built_in">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="hljs-number">1</span>)) {
                <span class="hljs-keyword">if</span> ((sc - <span class="hljs-number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)
                    <span class="hljs-keyword">return</span>;
                finishing = advance = <span class="hljs-literal">true</span>;
                i = n;
            }
        }

        <span class="hljs-comment">// 3.3 桶为空，放置ForwardingNode</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i)) == <span class="hljs-literal">null</span>)
            advance = casTabAt(tab, i, <span class="hljs-literal">null</span>, fwd);

        <span class="hljs-comment">// 3.4 已经处理过（ForwardingNode）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fh = f.hash) == MOVED)
            advance = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 3.5 迁移数据</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// 锁定旧桶</span>
                <span class="hljs-keyword">if</span> (tabAt(tab, i) == f) {
                    Node&lt;K,V&gt; ln, hn;
                    <span class="hljs-keyword">if</span> (fh &gt;= <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 链表</span>
                        <span class="hljs-comment">// 根据hash &amp; n 分为高位和低位链表</span>
                        <span class="hljs-type">int</span> <span class="hljs-variable">runBit</span> <span class="hljs-operator">=</span> fh &amp; n;
                        Node&lt;K,V&gt; lastRun = f;
                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="hljs-literal">null</span>; p = p.next) {
                            <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> p.hash &amp; n;
                            <span class="hljs-keyword">if</span> (b != runBit) {
                                runBit = b;
                                lastRun = p;
                            }
                        }
                        <span class="hljs-keyword">if</span> (runBit == <span class="hljs-number">0</span>) {
                            ln = lastRun;
                            hn = <span class="hljs-literal">null</span>;
                        }
                        <span class="hljs-keyword">else</span> {
                            hn = lastRun;
                            ln = <span class="hljs-literal">null</span>;
                        }

                        <span class="hljs-keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) {
                            <span class="hljs-type">int</span> <span class="hljs-variable">ph</span> <span class="hljs-operator">=</span> p.hash; <span class="hljs-type">K</span> <span class="hljs-variable">pk</span> <span class="hljs-operator">=</span> p.key; <span class="hljs-type">V</span> <span class="hljs-variable">pv</span> <span class="hljs-operator">=</span> p.val;
                            <span class="hljs-keyword">if</span> ((ph &amp; n) == <span class="hljs-number">0</span>)
                                ln = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, ln);
                            <span class="hljs-keyword">else</span>
                                hn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, hn);
                        }

                        <span class="hljs-comment">// 低位链表放在原位置 i</span>
                        setTabAt(nextTab, i, ln);
                        <span class="hljs-comment">// 高位链表放在 i + n</span>
                        setTabAt(nextTab, i + n, hn);
                        <span class="hljs-comment">// 旧表该位置放ForwardingNode</span>
                        setTabAt(tab, i, fwd);
                        advance = <span class="hljs-literal">true</span>;
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> TreeBin) {  <span class="hljs-comment">// 红黑树</span>
                        <span class="hljs-comment">// 树的迁移逻辑（省略）</span>
                        ...
                    }
                }
            }
        }
    }
}
</code></pre>
<p><strong>扩容流程图：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d524c07c84415f8e5ee366db93ccb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Sh6YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766827239&amp;x-signature=syyvRCDAs%2FqgY%2FkFZE%2B5oRApr9I%3D" alt="concurrenthashmap-resize-flow.svg" loading="lazy"/></p>
<p><strong>关键点：</strong></p>
<ul>
<li><strong>任务分配</strong>：CAS获取待迁移区间，避免重复</li>
<li><strong>ForwardingNode</strong>：标记已迁移，get时重定向到新表</li>
<li><strong>并发安全</strong>：迁移时锁定旧桶，不影响其他桶</li>
<li><strong>高效协作</strong>：put遇到扩容时会<code>helpTransfer()</code>帮忙</li>
</ul>
<h4 data-id="heading-18">2.2.5 size()方法</h4>
<p>JDK 1.8使用<strong>LongAdder思想</strong>实现高性能计数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();
    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :
            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
            (<span class="hljs-type">int</span>)n);
}

<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> {
    CounterCell[] as = counterCells; CounterCell a;
    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;
    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 累加所有CounterCell</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) {
            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)
                sum += a.value;
        }
    }
    <span class="hljs-keyword">return</span> sum;
}

<span class="hljs-comment">// 增加计数</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCount</span><span class="hljs-params">(<span class="hljs-type">long</span> x, <span class="hljs-type">int</span> check)</span> {
    CounterCell[] as; <span class="hljs-type">long</span> b, s;

    <span class="hljs-comment">// 尝试CAS更新baseCount</span>
    <span class="hljs-keyword">if</span> ((as = counterCells) != <span class="hljs-literal">null</span> ||
        !U.compareAndSwapLong(<span class="hljs-built_in">this</span>, BASECOUNT, b = baseCount, s = b + x)) {

        CounterCell a; <span class="hljs-type">long</span> v; <span class="hljs-type">int</span> m;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">uncontended</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// CAS失败，更新CounterCell</span>
        <span class="hljs-keyword">if</span> (as == <span class="hljs-literal">null</span> || (m = as.length - <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> ||
            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="hljs-literal">null</span> ||
            !(uncontended =
              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {
            fullAddCount(x, uncontended);  <span class="hljs-comment">// 扩容CounterCell数组</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (check &lt;= <span class="hljs-number">1</span>)
            <span class="hljs-keyword">return</span>;
        s = sumCount();
    }

    <span class="hljs-comment">// 检查是否需要扩容</span>
    <span class="hljs-keyword">if</span> (check &gt;= <span class="hljs-number">0</span>) {
        ...
    }
}
</code></pre>
<p><strong>计数原理：</strong></p>
<ul>
<li><strong>baseCount</strong>：基础计数</li>
<li><strong>CounterCell[]</strong>：分段计数数组，减少CAS冲突</li>
<li><strong>总数 = baseCount + Σ(counterCells[i].value)</strong></li>
</ul>
<p><strong>优点</strong>：</p>
<ul>
<li>高并发下性能优秀，避免单点CAS竞争</li>
<li>size()直接求和，无需加锁</li>
</ul>
<h4 data-id="heading-19">2.2.6 为什么放弃分段锁？</h4>













































<table><thead><tr><th>对比项</th><th>JDK 1.7 Segment</th><th>JDK 1.8 CAS + synchronized</th></tr></thead><tbody><tr><td><strong>锁粒度</strong></td><td>Segment级别（粗）</td><td>Node级别（细）</td></tr><tr><td><strong>并发度</strong></td><td>Segment数量（默认16）</td><td>数组长度（动态）</td></tr><tr><td><strong>扩容</strong></td><td>单Segment扩容</td><td>全表扩容，多线程协作</td></tr><tr><td><strong>结构复杂度</strong></td><td>三层结构（Segment-HashEntry-链表）</td><td>二层结构（Node-链表/树）</td></tr><tr><td><strong>内存占用</strong></td><td>较大（Segment开销）</td><td>较小</td></tr><tr><td><strong>读性能</strong></td><td>高（volatile）</td><td>高（volatile）</td></tr><tr><td><strong>写性能</strong></td><td>中（ReentrantLock）</td><td>高（CAS + synchronized优化）</td></tr></tbody></table>
<p><strong>放弃原因：</strong></p>
<ol>
<li><strong>Segment粒度过粗</strong>：并发度受限，最多16个线程并发写</li>
<li><strong>synchronized优化</strong>：JDK 1.6后synchronized性能大幅提升（锁消除、锁粗化、偏向锁、轻量级锁）</li>
<li><strong>CAS无锁更快</strong>：桶为空时CAS直接插入，性能更高</li>
<li><strong>扩容更高效</strong>：多线程协作扩容，比单Segment扩容快</li>
</ol>
<hr/>
<h3 data-id="heading-20">2.3 与其他线程安全Map对比</h3>





















































































<table><thead><tr><th>特性</th><th>HashMap</th><th>Hashtable</th><th>synchronizedMap</th><th>ConcurrentHashMap 1.7</th><th>ConcurrentHashMap 1.8</th></tr></thead><tbody><tr><td><strong>线程安全</strong></td><td>❌ 否</td><td>✅ 是</td><td>✅ 是</td><td>✅ 是</td><td>✅ 是</td></tr><tr><td><strong>锁粒度</strong></td><td>-</td><td>全表锁</td><td>全表锁</td><td>Segment锁</td><td>Node锁</td></tr><tr><td><strong>并发度</strong></td><td>-</td><td>1</td><td>1</td><td>16（默认）</td><td>数组长度</td></tr><tr><td><strong>key允许null</strong></td><td>✅ 是</td><td>❌ 否</td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>value允许null</strong></td><td>✅ 是</td><td>❌ 否</td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>迭代器</strong></td><td>fail-fast</td><td>fail-fast</td><td>fail-fast</td><td>fail-safe</td><td>fail-safe</td></tr><tr><td><strong>性能（单线程）</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>性能（并发）</strong></td><td>-</td><td>⭐</td><td>⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>适用场景</strong></td><td>单线程</td><td>低并发</td><td>低并发</td><td>中高并发</td><td>高并发</td></tr></tbody></table>
<p><strong>性能对比（10线程并发put 100万次）：</strong></p>



































<table><thead><tr><th>实现</th><th>耗时</th><th>吞吐量</th></tr></thead><tbody><tr><td>HashMap</td><td>不安全</td><td>-</td></tr><tr><td>Hashtable</td><td>8500ms</td><td>11.7万/s</td></tr><tr><td>synchronizedMap</td><td>8200ms</td><td>12.2万/s</td></tr><tr><td>ConcurrentHashMap 1.7</td><td>2800ms</td><td>35.7万/s</td></tr><tr><td>ConcurrentHashMap 1.8</td><td>1500ms</td><td>66.7万/s</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">三、实战场景应用</h2>
<h3 data-id="heading-22">3.1 场景1：高并发本地缓存实现</h3>
<h4 data-id="heading-23">3.1.1 业务背景</h4>
<p>电商平台的商品基础信息（如类目、品牌）变化频率低，但查询频繁，适合使用本地缓存减轻数据库压力。</p>
<p><strong>需求：</strong></p>
<ul>
<li>读多写少（读写比 100:1）</li>
<li>支持高并发访问</li>
<li>数据定期刷新</li>
<li>支持手动失效</li>
</ul>
<h4 data-id="heading-24">3.1.2 技术方案</h4>
<p>使用<code>ConcurrentHashMap</code>作为缓存容器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;
<span class="hljs-keyword">import</span> java.util.function.Function;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-comment">/**
 * 本地缓存工具类
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalCache</span>&lt;K, V&gt; {
    <span class="hljs-comment">// 缓存容器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;K, CacheValue&lt;V&gt;&gt; cache;

    <span class="hljs-comment">// 定时刷新任务</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ScheduledExecutorService scheduler;

    <span class="hljs-comment">// 过期时间（毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> expireTime;

    <span class="hljs-comment">// 缓存值包装类</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheValue</span>&lt;V&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> V value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> createTime;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheValue</span><span class="hljs-params">(V value)</span> {
            <span class="hljs-built_in">this</span>.value = value;
            <span class="hljs-built_in">this</span>.createTime = System.currentTimeMillis();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - createTime &gt; expireTime;
        }

        <span class="hljs-keyword">public</span> V <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> value;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LocalCache</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-built_in">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);
        <span class="hljs-built_in">this</span>.expireTime = expireTime;
        <span class="hljs-built_in">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);

        <span class="hljs-comment">// 启动定期清理过期数据任务</span>
        startCleanupTask();
    }

    <span class="hljs-comment">/**
     * 获取缓存，不存在则加载
     */</span>
    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key, Function&lt;K, V&gt; loader)</span> {
        CacheValue&lt;V&gt; cacheValue = cache.get(key);

        <span class="hljs-comment">// 缓存存在且未过期</span>
        <span class="hljs-keyword">if</span> (cacheValue != <span class="hljs-literal">null</span> &amp;&amp; !cacheValue.isExpired(expireTime)) {
            <span class="hljs-keyword">return</span> cacheValue.getValue();
        }

        <span class="hljs-comment">// 缓存不存在或已过期，重新加载</span>
        <span class="hljs-comment">// 使用computeIfAbsent保证只加载一次</span>
        <span class="hljs-keyword">return</span> cache.compute(key, (k, oldValue) -&gt; {
            <span class="hljs-comment">// 双重检查：其他线程可能已经加载</span>
            <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-literal">null</span> &amp;&amp; !oldValue.isExpired(expireTime)) {
                <span class="hljs-keyword">return</span> oldValue;
            }

            <span class="hljs-comment">// 加载数据</span>
            <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> loader.apply(k);
            <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 不缓存null</span>
            }

            log.info(<span class="hljs-string">"缓存加载: key={}"</span>, k);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheValue</span>&lt;&gt;(value);
        }).getValue();
    }

    <span class="hljs-comment">/**
     * 主动设置缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            cache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheValue</span>&lt;&gt;(value));
        }
    }

    <span class="hljs-comment">/**
     * 使缓存失效
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">(K key)</span> {
        cache.remove(key);
        log.info(<span class="hljs-string">"缓存失效: key={}"</span>, key);
    }

    <span class="hljs-comment">/**
     * 清空所有缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
        log.info(<span class="hljs-string">"缓存已清空"</span>);
    }

    <span class="hljs-comment">/**
     * 获取缓存大小
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> cache.size();
    }

    <span class="hljs-comment">/**
     * 启动定期清理任务
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startCleanupTask</span><span class="hljs-params">()</span> {
        scheduler.scheduleAtFixedRate(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

                <span class="hljs-comment">// 遍历清理过期数据</span>
                <span class="hljs-keyword">for</span> (K key : cache.keySet()) {
                    CacheValue&lt;V&gt; value = cache.get(key);
                    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; value.isExpired(expireTime)) {
                        cache.remove(key);
                        cleanCount++;
                    }
                }

                <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
                    log.info(<span class="hljs-string">"清理过期缓存: count={}, size={}"</span>, cleanCount, cache.size());
                }
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"清理缓存异常"</span>, e);
            }
        }, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);  <span class="hljs-comment">// 每分钟清理一次</span>
    }

    <span class="hljs-comment">/**
     * 关闭缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        scheduler.shutdown();
        cache.clear();
    }
}
</code></pre>
<h4 data-id="heading-25">3.1.3 使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// 商品类目缓存，过期时间10分钟</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LocalCache&lt;Long, Category&gt; categoryCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalCache</span>&lt;&gt;(<span class="hljs-number">1000</span>, <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CategoryMapper categoryMapper;

    <span class="hljs-comment">/**
     * 查询类目（带缓存）
     */</span>
    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">(Long categoryId)</span> {
        <span class="hljs-keyword">return</span> categoryCache.get(categoryId, id -&gt; {
            <span class="hljs-comment">// 缓存不存在时，从数据库加载</span>
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> categoryMapper.selectById(id);
            log.info(<span class="hljs-string">"从数据库加载类目: id={}"</span>, id);
            <span class="hljs-keyword">return</span> category;
        });
    }

    <span class="hljs-comment">/**
     * 更新类目（失效缓存）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateCategory</span><span class="hljs-params">(Category category)</span> {
        categoryMapper.updateById(category);
        <span class="hljs-comment">// 更新后立即失效缓存</span>
        categoryCache.invalidate(category.getId());
    }

    <span class="hljs-comment">/**
     * 预热缓存
     */</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUpCache</span><span class="hljs-params">()</span> {
        List&lt;Category&gt; categories = categoryMapper.selectAll();
        <span class="hljs-keyword">for</span> (Category category : categories) {
            categoryCache.put(category.getId(), category);
        }
        log.info(<span class="hljs-string">"类目缓存预热完成: size={}"</span>, categoryCache.size());
    }
}
</code></pre>
<h4 data-id="heading-26">3.1.4 为什么不用Guava Cache？</h4>
<p><strong>场景对比：</strong></p>








































<table><thead><tr><th>场景</th><th>ConcurrentHashMap</th><th>Guava Cache</th></tr></thead><tbody><tr><td><strong>简单缓存，手动控制</strong></td><td>✅ 推荐</td><td>❌ 过度设计</td></tr><tr><td><strong>需要自动过期</strong></td><td>⚠️ 需手动实现</td><td>✅ 推荐</td></tr><tr><td><strong>需要LRU淘汰</strong></td><td>❌ 不支持</td><td>✅ 推荐</td></tr><tr><td><strong>需要缓存统计</strong></td><td>❌ 不支持</td><td>✅ 推荐</td></tr><tr><td><strong>最大容量限制</strong></td><td>⚠️ 需手动实现</td><td>✅ 推荐</td></tr><tr><td><strong>性能要求极高</strong></td><td>✅ 更轻量</td><td>⚠️ 略重</td></tr></tbody></table>
<p><strong>推荐使用Guava Cache的改进版本：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceWithGuava</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;Long, Category&gt; categoryCache = CacheBuilder.newBuilder()
        .maximumSize(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 最大容量</span>
        .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)  <span class="hljs-comment">// 写入10分钟后过期</span>
        .recordStats()  <span class="hljs-comment">// 记录统计信息</span>
        .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Long, Category&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">load</span><span class="hljs-params">(Long id)</span> {
                <span class="hljs-keyword">return</span> categoryMapper.selectById(id);
            }
        });

    <span class="hljs-keyword">public</span> Category <span class="hljs-title function_">getCategory</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> categoryCache.get(id);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            log.error(<span class="hljs-string">"加载缓存失败"</span>, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-27">3.1.5 性能测试数据</h4>
<p><strong>测试场景</strong>：100个线程并发查询1000个商品类目</p>





























<table><thead><tr><th>实现</th><th>数据库查询次数</th><th>平均响应时间</th><th>QPS</th></tr></thead><tbody><tr><td><strong>无缓存</strong></td><td>100,000</td><td>50ms</td><td>2000</td></tr><tr><td><strong>ConcurrentHashMap缓存</strong></td><td>1,000</td><td>0.5ms</td><td>200,000</td></tr><tr><td><strong>Guava Cache</strong></td><td>1,000</td><td>0.6ms</td><td>166,667</td></tr></tbody></table>
<p><strong>结论</strong>：本地缓存性能提升<strong>100倍</strong>，数据库压力降低<strong>99%</strong></p>
<hr/>
<h3 data-id="heading-28">3.2 场景2：统计在线用户数</h3>
<h4 data-id="heading-29">3.2.1 业务背景</h4>
<p>需要实时统计当前在线用户数，用户登录时添加，退出或超时时移除。</p>
<h4 data-id="heading-30">3.2.2 错误方案：AtomicLong</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误方案</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnlineUserCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">onlineCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogin</span><span class="hljs-params">(Long userId)</span> {
        onlineCount.incrementAndGet();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogout</span><span class="hljs-params">(Long userId)</span> {
        onlineCount.decrementAndGet();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> onlineCount.get();
    }
}
</code></pre>
<p><strong>问题</strong>：</p>
<ol>
<li>❌ 无法判断用户是否真的在线（重复登录会重复计数）</li>
<li>❌ 无法获取在线用户列表</li>
<li>❌ 无法区分用户登录和退出</li>
</ol>
<h4 data-id="heading-31">3.2.3 正确方案：ConcurrentHashMap</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-comment">/**
 * 在线用户管理
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnlineUserManager</span> {
    <span class="hljs-comment">// 在线用户Map: userId -&gt; Session</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, UserSession&gt; onlineUsers =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">10000</span>);

    <span class="hljs-comment">// 定时清理超时用户</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span>
        Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);

    <span class="hljs-comment">// 超时时间（30分钟）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TIMEOUT_MILLIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSession</span> {
        <span class="hljs-keyword">private</span> Long userId;
        <span class="hljs-keyword">private</span> String sessionId;
        <span class="hljs-keyword">private</span> String ip;
        <span class="hljs-keyword">private</span> LocalDateTime loginTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> lastActiveTime;  <span class="hljs-comment">// volatile保证可见性</span>

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserSession</span><span class="hljs-params">(Long userId, String sessionId, String ip)</span> {
            <span class="hljs-built_in">this</span>.userId = userId;
            <span class="hljs-built_in">this</span>.sessionId = sessionId;
            <span class="hljs-built_in">this</span>.ip = ip;
            <span class="hljs-built_in">this</span>.loginTime = LocalDateTime.now();
            <span class="hljs-built_in">this</span>.lastActiveTime = System.currentTimeMillis();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTimeout</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - lastActiveTime &gt; TIMEOUT_MILLIS;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateActiveTime</span><span class="hljs-params">()</span> {
            <span class="hljs-built_in">this</span>.lastActiveTime = System.currentTimeMillis();
        }
    }

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 启动定期清理超时用户</span>
        scheduler.scheduleAtFixedRate(() -&gt; {
            <span class="hljs-keyword">try</span> {
                cleanTimeoutUsers();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"清理超时用户失败"</span>, e);
            }
        }, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES);
    }

    <span class="hljs-comment">/**
     * 用户登录
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogin</span><span class="hljs-params">(Long userId, String sessionId, String ip)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserSession</span>(userId, sessionId, ip);

        <span class="hljs-comment">// putIfAbsent: 只有不存在时才添加</span>
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">oldSession</span> <span class="hljs-operator">=</span> onlineUsers.putIfAbsent(userId, session);

        <span class="hljs-keyword">if</span> (oldSession != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 用户已在线，更新session（踢出旧登录）</span>
            onlineUsers.put(userId, session);
            log.info(<span class="hljs-string">"用户重新登录: userId={}, oldSessionId={}, newSessionId={}"</span>,
                userId, oldSession.getSessionId(), sessionId);
        } <span class="hljs-keyword">else</span> {
            log.info(<span class="hljs-string">"用户登录: userId={}, sessionId={}, onlineCount={}"</span>,
                userId, sessionId, onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * 用户登出
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userLogout</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> onlineUsers.remove(userId);
        <span class="hljs-keyword">if</span> (removed != <span class="hljs-literal">null</span>) {
            log.info(<span class="hljs-string">"用户登出: userId={}, sessionId={}, onlineCount={}"</span>,
                userId, removed.getSessionId(), onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * 更新用户活跃时间（心跳）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserActiveTime</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.updateActiveTime();
        }
    }

    <span class="hljs-comment">/**
     * 判断用户是否在线
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOnline</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> onlineUsers.containsKey(userId);
    }

    <span class="hljs-comment">/**
     * 获取在线用户数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> onlineUsers.size();
    }

    <span class="hljs-comment">/**
     * 获取所有在线用户
     */</span>
    <span class="hljs-keyword">public</span> List&lt;UserSession&gt; <span class="hljs-title function_">getOnlineUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(onlineUsers.values());
    }

    <span class="hljs-comment">/**
     * 清理超时用户
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanTimeoutUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (Long userId : onlineUsers.keySet()) {
            <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);

            <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span> &amp;&amp; session.isTimeout()) {
                <span class="hljs-comment">// 超时，移除用户</span>
                <span class="hljs-keyword">if</span> (onlineUsers.remove(userId, session)) {  <span class="hljs-comment">// CAS删除</span>
                    cleanCount++;
                    log.info(<span class="hljs-string">"清理超时用户: userId={}, sessionId={}"</span>,
                        userId, session.getSessionId());
                }
            }
        }

        <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"清理超时用户完成: cleanCount={}, onlineCount={}"</span>,
                cleanCount, onlineUsers.size());
        }
    }

    <span class="hljs-comment">/**
     * 获取用户在线时长（分钟）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getOnlineDuration</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">UserSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> onlineUsers.get(userId);
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() -
            session.getLoginTime().atZone(ZoneId.systemDefault())
                .toInstant().toEpochMilli();
        <span class="hljs-keyword">return</span> duration / <span class="hljs-number">60000</span>;
    }

    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        scheduler.shutdown();
        onlineUsers.clear();
    }
}
</code></pre>
<h4 data-id="heading-32">3.2.4 使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OnlineUserManager onlineUserManager;

    <span class="hljs-comment">/**
     * 用户登录
     */</span>
    <span class="hljs-meta">@PostMapping("/login")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginRequest request,
                                HttpServletRequest httpRequest)</span> {
        <span class="hljs-comment">// 验证用户名密码...</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> authenticate(request);

        <span class="hljs-comment">// 添加到在线用户</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> httpRequest.getSession().getId();
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> httpRequest.getRemoteAddr();
        onlineUserManager.userLogin(userId, sessionId, ip);

        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * 用户登出
     */</span>
    <span class="hljs-meta">@PostMapping("/logout")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">logout</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader("userId")</span> Long userId)</span> {
        onlineUserManager.userLogout(userId);
        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * 心跳接口（定期调用，如每5分钟）
     */</span>
    <span class="hljs-meta">@PostMapping("/heartbeat")</span>
    <span class="hljs-keyword">public</span> Response&lt;Void&gt; <span class="hljs-title function_">heartbeat</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader("userId")</span> Long userId)</span> {
        onlineUserManager.updateUserActiveTime(userId);
        <span class="hljs-keyword">return</span> Response.success();
    }

    <span class="hljs-comment">/**
     * 获取在线用户数
     */</span>
    <span class="hljs-meta">@GetMapping("/online-count")</span>
    <span class="hljs-keyword">public</span> Response&lt;Integer&gt; <span class="hljs-title function_">getOnlineCount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> onlineUserManager.getOnlineCount();
        <span class="hljs-keyword">return</span> Response.success(count);
    }

    <span class="hljs-comment">/**
     * 获取在线用户列表（管理员）
     */</span>
    <span class="hljs-meta">@GetMapping("/online-users")</span>
    <span class="hljs-keyword">public</span> Response&lt;List&lt;UserSession&gt;&gt; <span class="hljs-title function_">getOnlineUsers</span><span class="hljs-params">()</span> {
        List&lt;UserSession&gt; users = onlineUserManager.getOnlineUsers();
        <span class="hljs-keyword">return</span> Response.success(users);
    }
}
</code></pre>
<h4 data-id="heading-33">3.2.5 性能对比</h4>
<p><strong>测试场景</strong>：10000个用户并发登录/登出</p>



































<table><thead><tr><th>指标</th><th>AtomicLong方案</th><th>ConcurrentHashMap方案</th></tr></thead><tbody><tr><td><strong>准确性</strong></td><td>❌ 不准确（重复计数）</td><td>✅ 准确</td></tr><tr><td><strong>功能性</strong></td><td>❌ 只能计数</td><td>✅ 可查询用户、判断在线、超时清理</td></tr><tr><td><strong>登录耗时</strong></td><td>0.01ms</td><td>0.05ms</td></tr><tr><td><strong>查询耗时</strong></td><td>0.001ms</td><td>0.01ms</td></tr><tr><td><strong>内存占用</strong></td><td>8 bytes</td><td>~10MB（1万用户）</td></tr></tbody></table>
<p><strong>结论</strong>：ConcurrentHashMap功能更强大，性能损失可接受</p>
<hr/>
<h2 data-id="heading-34">四、生产案例与故障排查</h2>
<h3 data-id="heading-35">4.1 案例1：本地缓存未设上限导致OOM</h3>
<h4 data-id="heading-36">4.1.1 故障现象</h4>
<p>某电商平台商品服务在运行一周后突然出现：</p>
<ul>
<li>Java进程OOM: <code>java.lang.OutOfMemoryError: Java heap space</code></li>
<li>频繁Full GC，每次GC后老年代回收很少</li>
<li>服务响应变慢，最终不可用</li>
</ul>
<h4 data-id="heading-37">4.1.2 排查过程</h4>
<p><strong>Step 1: 获取堆dump</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 找到进程ID</span>
jps -l

<span class="hljs-comment"># 2. 生成堆dump</span>
jmap -dump:live,format=b,file=heap.hprof &lt;pid&gt;

<span class="hljs-comment"># 3. 使用MAT分析</span>
<span class="hljs-comment"># Eclipse Memory Analyzer Tool</span>
</code></pre>
<p><strong>Step 2: MAT分析</strong></p>
<p>打开<code>heap.hprof</code>，查看Dominator Tree：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">Class Name                           Objects   Shallow Heap   Retained Heap
-----------------------------------------------------------------------------</span>
ConcurrentHashMap                        1         48 bytes    3.2 GB !!!
  |- Node[]                              1       800 MB        3.2 GB
<span class="hljs-code">      |- Product (自定义类)          500,000     80 MB         2.4 GB
</span></code></pre>
<p>发现：</p>
<ul>
<li><code>ConcurrentHashMap</code>占用<strong>3.2GB</strong>内存</li>
<li>存储了<strong>50万个</strong>Product对象</li>
<li>占用了堆内存的<strong>80%</strong></li>
</ul>
<p><strong>Step 3: 查看代码</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// ❌ 没有容量限制的缓存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Product&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productCache.get(productId);
        <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
            product = productMapper.selectById(productId);
            <span class="hljs-comment">// ❌ 只put不remove，持续增长</span>
            productCache.put(productId, product);
        }
        <span class="hljs-keyword">return</span> product;
    }
}
</code></pre>
<h4 data-id="heading-38">4.1.3 问题分析</h4>
<p><strong>根本原因：</strong></p>
<ol>
<li>❌ <strong>只put不remove</strong>：每次查询新商品都会缓存，从不删除</li>
<li>❌ <strong>没有过期策略</strong>：旧数据永远不会过期</li>
<li>❌ <strong>没有容量限制</strong>：缓存无限增长</li>
</ol>
<p><strong>增长趋势：</strong></p>
<ul>
<li>商品总数：100万</li>
<li>每天访问不同商品：5万</li>
<li>7天后缓存商品数：35万</li>
<li>按每个Product 5KB计算：35万 * 5KB = 1.75GB</li>
</ul>
<h4 data-id="heading-39">4.1.4 解决方案</h4>
<p><strong>方案A：使用Guava Cache（推荐）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-comment">// ✅ 使用Guava Cache，自动过期和容量限制</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;Long, Product&gt; productCache = CacheBuilder.newBuilder()
        .maximumSize(<span class="hljs-number">10000</span>)  <span class="hljs-comment">// 最大缓存10000个商品</span>
        .expireAfterWrite(<span class="hljs-number">1</span>, TimeUnit.HOURS)  <span class="hljs-comment">// 1小时后过期</span>
        .recordStats()  <span class="hljs-comment">// 记录缓存统计</span>
        .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;Long, Product&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">load</span><span class="hljs-params">(Long id)</span> {
                <span class="hljs-keyword">return</span> productMapper.selectById(id);
            }
        });

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> productCache.get(productId);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            log.error(<span class="hljs-string">"加载商品缓存失败: productId={}"</span>, productId, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// 查看缓存统计</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logCacheStats</span><span class="hljs-params">()</span> {
        <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> productCache.stats();
        log.info(<span class="hljs-string">"商品缓存统计: hitRate={}, size={}, evictionCount={}"</span>,
            stats.hitRate(), productCache.size(), stats.evictionCount());
    }
}
</code></pre>
<p><strong>方案B：ConcurrentHashMap + 定期清理 + LRU</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceWithLRU</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 1小时</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, CacheEntry&lt;Product&gt;&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// LRU队列（访问顺序）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedDeque&lt;Long&gt; lruQueue =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedDeque</span>&lt;&gt;();

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheEntry</span>&lt;T&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> T value;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> createTime;

        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExpired</span><span class="hljs-params">(<span class="hljs-type">long</span> expireTime)</span> {
            <span class="hljs-keyword">return</span> System.currentTimeMillis() - createTime &gt; expireTime;
        }
    }

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        CacheEntry&lt;Product&gt; entry = productCache.get(productId);

        <span class="hljs-comment">// 缓存命中且未过期</span>
        <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span> &amp;&amp; !entry.isExpired(EXPIRE_TIME)) {
            <span class="hljs-comment">// 更新LRU</span>
            lruQueue.remove(productId);
            lruQueue.offerLast(productId);
            <span class="hljs-keyword">return</span> entry.getValue();
        }

        <span class="hljs-comment">// 缓存不存在或已过期，加载数据</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            put(productId, product);
        }

        <span class="hljs-keyword">return</span> product;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Long key, Product value)</span> {
        <span class="hljs-comment">// 容量检查，超过则移除最久未使用的</span>
        <span class="hljs-keyword">if</span> (productCache.size() &gt;= MAX_SIZE) {
            <span class="hljs-type">Long</span> <span class="hljs-variable">oldest</span> <span class="hljs-operator">=</span> lruQueue.pollFirst();
            <span class="hljs-keyword">if</span> (oldest != <span class="hljs-literal">null</span>) {
                productCache.remove(oldest);
            }
        }

        productCache.put(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheEntry</span>&lt;&gt;(value, System.currentTimeMillis()));
        lruQueue.offerLast(key);
    }

    <span class="hljs-comment">// 定期清理过期数据</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 60000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanExpired</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cleanCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (Long key : productCache.keySet()) {
            CacheEntry&lt;Product&gt; entry = productCache.get(key);
            <span class="hljs-keyword">if</span> (entry != <span class="hljs-literal">null</span> &amp;&amp; entry.isExpired(EXPIRE_TIME)) {
                productCache.remove(key);
                lruQueue.remove(key);
                cleanCount++;
            }
        }
        <span class="hljs-keyword">if</span> (cleanCount &gt; <span class="hljs-number">0</span>) {
            log.info(<span class="hljs-string">"清理过期缓存: count={}, size={}"</span>, cleanCount, productCache.size());
        }
    }
}
</code></pre>
<p><strong>方案C：限制最大容量（简单版）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceSimple</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Product&gt; productCache =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-keyword">return</span> productCache.computeIfAbsent(productId, id -&gt; {
            <span class="hljs-comment">// 容量检查</span>
            <span class="hljs-keyword">if</span> (productCache.size() &gt;= MAX_SIZE) {
                log.warn(<span class="hljs-string">"缓存已满，拒绝新增: size={}"</span>, productCache.size());
                <span class="hljs-keyword">return</span> productMapper.selectById(id);  <span class="hljs-comment">// 不缓存，直接返回</span>
            }

            <span class="hljs-keyword">return</span> productMapper.selectById(id);
        });
    }
}
</code></pre>
<h4 data-id="heading-40">4.1.5 最佳实践</h4>
<p><strong>本地缓存使用规范：</strong></p>
<ol>
<li>✅ <strong>必须设置容量上限</strong>（maximumSize）</li>
<li>✅ <strong>必须设置过期时间</strong>（expireAfterWrite/expireAfterAccess）</li>
<li>✅ <strong>优先使用Guava Cache</strong>，而非裸用ConcurrentHashMap</li>
<li>✅ <strong>定期清理过期数据</strong></li>
<li>✅ <strong>监控缓存命中率</strong>和容量</li>
<li>✅ <strong>压测验证内存占用</strong></li>
</ol>
<hr/>
<h3 data-id="heading-41">4.2 案例2：ConcurrentHashMap的size()方法性能问题</h3>
<h4 data-id="heading-42">4.2.1 业务场景</h4>
<p>某监控系统需要频繁调用<code>size()</code>统计缓存大小，用于告警：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(fixedRate = 1000)</span>  <span class="hljs-comment">// 每秒执行一次</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorCacheSize</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> cache.size();
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">100000</span>) {
        alertService.send(<span class="hljs-string">"缓存容量告警: "</span> + size);
    }
}
</code></pre>
<h4 data-id="heading-43">4.2.2 性能问题</h4>
<p><strong>问题分析：</strong></p>
<p><code>ConcurrentHashMap</code>的<code>size()</code>方法需要遍历<strong>所有Node</strong>进行累加：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();
    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :
            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
            (<span class="hljs-type">int</span>)n);
}

<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> {
    CounterCell[] as = counterCells; CounterCell a;
    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;
    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 遍历所有CounterCell累加</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) {
            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)
                sum += a.value;
        }
    }
    <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>虽然JDK 1.8使用<code>CounterCell</code>数组分段计数，但仍需<strong>遍历数组</strong>，数据量大时有性能开销。</p>
<p><strong>性能测试：</strong></p>






























<table><thead><tr><th>缓存大小</th><th>size()耗时</th><th>每秒调用1000次影响</th></tr></thead><tbody><tr><td>1万</td><td>0.01ms</td><td>可忽略</td></tr><tr><td>10万</td><td>0.05ms</td><td>50ms/s</td></tr><tr><td>100万</td><td>0.2ms</td><td>200ms/s</td></tr><tr><td>1000万</td><td>1ms</td><td>1000ms/s（1秒）</td></tr></tbody></table>
<p>当缓存达到<strong>百万级</strong>时，频繁调用<code>size()</code>会显著影响性能。</p>
<h4 data-id="heading-44">4.2.3 解决方案</h4>
<p><strong>使用AtomicLong单独计数</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredCache</span>&lt;K, V&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;K, V&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// ✅ 单独维护计数器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> cache.put(key, value);
        <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
            count.incrementAndGet();  <span class="hljs-comment">// 新增</span>
        }
        <span class="hljs-keyword">return</span> oldValue;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">putIfAbsent</span><span class="hljs-params">(K key, V value)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> cache.putIfAbsent(key, value);
        <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
            count.incrementAndGet();  <span class="hljs-comment">// 新增</span>
        }
        <span class="hljs-keyword">return</span> oldValue;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">remove</span><span class="hljs-params">(K key)</span> {
        <span class="hljs-type">V</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> cache.remove(key);
        <span class="hljs-keyword">if</span> (removed != <span class="hljs-literal">null</span>) {
            count.decrementAndGet();  <span class="hljs-comment">// 删除</span>
        }
        <span class="hljs-keyword">return</span> removed;
    }

    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(K key)</span> {
        <span class="hljs-keyword">return</span> cache.get(key);
    }

    <span class="hljs-comment">/**
     * 快速获取大小（O(1)）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count.get();
    }

    <span class="hljs-comment">/**
     * 精确大小（需要时调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">actualSize</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> cache.size();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
        count.set(<span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-45">4.2.4 性能对比</h4>























<table><thead><tr><th>方案</th><th>获取大小耗时</th><th>100万数据</th><th>1000万数据</th></tr></thead><tbody><tr><td><code>cache.size()</code></td><td>遍历累加</td><td>0.2ms</td><td>1ms</td></tr><tr><td><code>count.get()</code></td><td><strong>O(1)</strong></td><td><strong>0.001ms</strong></td><td><strong>0.001ms</strong></td></tr></tbody></table>
<p><strong>性能提升：200倍</strong></p>
<h4 data-id="heading-46">4.2.5 注意事项</h4>
<p><strong>为什么不能完全替代size()？</strong></p>
<ul>
<li><code>AtomicLong</code>计数可能不精确（并发remove时）</li>
<li>需要在所有修改方法中同步更新计数</li>
<li>适用于<strong>读多写少</strong>的场景</li>
</ul>
<p><strong>推荐使用场景：</strong></p>
<ul>
<li>✅ 监控告警（允许轻微误差）</li>
<li>✅ 统计大盘数据</li>
<li>❌ 需要精确计数的业务逻辑</li>
</ul>
<hr/>
<h2 data-id="heading-47">五、常见问题与避坑指南</h2>
<h3 data-id="heading-48">5.1 ConcurrentHashMap为什么key和value不允许null？</h3>
<p><strong>原因：二义性问题</strong></p>
<p>在并发环境下，如果允许null会产生歧义：</p>
<pre><code class="hljs language-java" lang="java">ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-comment">// 假设允许null value</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key"</span>);
<span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 问题：无法区分以下两种情况</span>
    <span class="hljs-comment">// 1. key不存在</span>
    <span class="hljs-comment">// 2. key存在，但value为null</span>
}

<span class="hljs-comment">// HashMap可以用containsKey()判断，但ConcurrentHashMap不行</span>
<span class="hljs-keyword">if</span> (map.containsKey(<span class="hljs-string">"key"</span>)) {
    <span class="hljs-comment">// 在containsKey()和get()之间，其他线程可能remove了key</span>
    <span class="hljs-comment">// 导致判断失效</span>
}
</code></pre>
<p><strong>HashMap为什么可以？</strong></p>
<ul>
<li>HashMap是非线程安全的，单线程环境下可以用<code>containsKey()</code>准确判断</li>
<li>ConcurrentHashMap在并发环境下，<code>containsKey()</code>和<code>get()</code>之间状态可能变化</li>
</ul>
<p><strong>源码验证：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || value == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();  <span class="hljs-comment">// 直接抛异常</span>
    ...
}
</code></pre>
<hr/>
<h3 data-id="heading-49">5.2 ConcurrentHashMap是强一致性的吗？</h3>
<p><strong>答案：不是，是弱一致性</strong></p>
<p><strong>弱一致性表现：</strong></p>
<ol>
<li>
<p><strong>size()方法</strong>：返回的是<strong>近似值</strong>，可能不准确</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1</span>
map.put(<span class="hljs-string">"k1"</span>, <span class="hljs-string">"v1"</span>);

<span class="hljs-comment">// 线程2（同时）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();  <span class="hljs-comment">// 可能看不到线程1的put</span>
</code></pre>
</li>
<li>
<p><strong>迭代器</strong>：返回的是<strong>某一时刻的快照</strong>，不保证实时性</p>
<pre><code class="hljs language-java" lang="java">Iterator&lt;String&gt; it = map.keySet().iterator();
<span class="hljs-keyword">while</span> (it.hasNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> it.next();
    <span class="hljs-comment">// 迭代过程中，其他线程的put/remove不一定能看到</span>
}
</code></pre>
</li>
<li>
<p><strong>聚合操作</strong>：如<code>putAll()</code>, <code>clear()</code>，不是原子的</p>
<pre><code class="hljs language-java" lang="java">map.putAll(otherMap);  <span class="hljs-comment">// 不是原子操作，中间状态可见</span>
</code></pre>
</li>
</ol>
<p><strong>为什么不是强一致？</strong></p>
<ul>
<li><strong>性能优先</strong>：强一致需要全局锁，性能损失大</li>
<li><strong>实际需求</strong>：大多数场景下弱一致性足够</li>
</ul>
<p><strong>需要强一致性怎么办？</strong></p>
<ul>
<li>使用<code>Collections.synchronizedMap()</code></li>
<li>或在外部加锁</li>
</ul>
<hr/>
<h3 data-id="heading-50">5.3 为什么链表长度阈值是8，树退化阈值是6？</h3>
<p><strong>树化阈值为8的原因：</strong></p>
<p>根据<strong>泊松分布</strong>，hash碰撞达到8个节点的概率极低：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">0:    0.60653066</span>
<span class="hljs-section">1:    0.30326533</span>
<span class="hljs-section">2:    0.07581633</span>
<span class="hljs-section">3:    0.01263606</span>
<span class="hljs-section">4:    0.00157952</span>
<span class="hljs-section">5:    0.00015795</span>
<span class="hljs-section">6:    0.00001316</span>
<span class="hljs-section">7:    0.00000094</span>
<span class="hljs-section">8:    0.00000006  // 千万分之一</span>
</code></pre>
<p>即使hash算法一般，链表长度也很难达到8，因此8是一个合理的阈值。</p>
<p><strong>为什么不是7或9？</strong></p>
<ul>
<li><strong>性能平衡</strong>：链表遍历O(n)，红黑树O(logn)，当n=8时性能差异显著</li>
<li><strong>内存开销</strong>：TreeNode占用空间是Node的<strong>2倍</strong>，过早树化浪费内存</li>
</ul>
<p><strong>树退化阈值为6的原因：</strong></p>
<p><strong>防止频繁树化/退化</strong>：</p>
<ul>
<li>如果阈值都是8，在7-8之间反复增删会导致频繁树化和退化</li>
<li>设置为6提供了一个<strong>缓冲区间</strong>[6, 8]，避免抖动</li>
</ul>

<pre><code class="hljs language-rust" lang="rust">链表长度变化:
  <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span>  (如果阈值都是<span class="hljs-number">8</span>)
  频繁树化 ↔ 退化（性能差）

  <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span>（树化） <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">6</span>（退化） <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">7</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-number">8</span>（树化）
  缓冲区间[<span class="hljs-number">6</span>,<span class="hljs-number">8</span>]，减少转换次数
</code></pre>
<hr/>
<h3 data-id="heading-51">5.4 ConcurrentHashMap的并发度是什么？如何设置？</h3>
<p><strong>并发度（concurrencyLevel）：</strong></p>
<ul>
<li>
<p><strong>JDK 1.7</strong>：Segment数组长度，默认16</p>
<ul>
<li>表示最多<strong>16个线程</strong>可以同时修改（每个Segment一个）</li>
<li>初始化时指定：<code>new ConcurrentHashMap&lt;&gt;(16, 0.75f, 16)</code></li>
</ul>
</li>
<li>
<p><strong>JDK 1.8</strong>：已废弃，并发度动态等于<strong>数组长度</strong></p>
<ul>
<li>数组扩容时并发度自动翻倍</li>
<li>理论上可以有<strong>数组长度</strong>个线程同时修改不同桶</li>
</ul>
</li>
</ul>
<p><strong>如何设置？</strong></p>
<p>JDK 1.8中不需要设置，只需指定<code>initialCapacity</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐方式</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);

<span class="hljs-comment">// initialCapacity建议设置为预期元素数量 / 0.75</span>
<span class="hljs-type">int</span> <span class="hljs-variable">expectedSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">initialCapacity</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (expectedSize / <span class="hljs-number">0.75</span>) + <span class="hljs-number">1</span>;
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);
</code></pre>
<hr/>
<h3 data-id="heading-52">5.5 迭代ConcurrentHashMap时能修改吗？</h3>
<p><strong>答案：可以，但要小心</strong></p>
<p><strong>ConcurrentHashMap的迭代器是fail-safe的：</strong></p>
<pre><code class="hljs language-java" lang="java">ConcurrentHashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
map.put(<span class="hljs-string">"k1"</span>, <span class="hljs-string">"v1"</span>);
map.put(<span class="hljs-string">"k2"</span>, <span class="hljs-string">"v2"</span>);

<span class="hljs-comment">// ✅ 迭代时可以修改，不会抛异常</span>
<span class="hljs-keyword">for</span> (String key : map.keySet()) {
    map.put(<span class="hljs-string">"k3"</span>, <span class="hljs-string">"v3"</span>);  <span class="hljs-comment">// 允许</span>
    map.remove(<span class="hljs-string">"k2"</span>);     <span class="hljs-comment">// 允许</span>
}

<span class="hljs-comment">// HashMap会抛ConcurrentModificationException</span>
HashMap&lt;String, String&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String key : hashMap.keySet()) {
    hashMap.put(<span class="hljs-string">"k3"</span>, <span class="hljs-string">"v3"</span>);  <span class="hljs-comment">// ❌ 抛异常</span>
}
</code></pre>
<p><strong>注意事项：</strong></p>
<ol>
<li><strong>新增的元素可能看不到</strong>：迭代器返回的是某一时刻的快照</li>
<li><strong>删除的元素可能还能看到</strong>：迭代器已经缓存</li>
<li><strong>不保证迭代顺序</strong></li>
</ol>
<p><strong>安全的迭代方式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：先复制，再迭代</span>
List&lt;String&gt; keys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(map.keySet());
<span class="hljs-keyword">for</span> (String key : keys) {
    map.remove(key);  <span class="hljs-comment">// 安全</span>
}

<span class="hljs-comment">// 方式2：使用Iterator.remove()</span>
Iterator&lt;String&gt; it = map.keySet().iterator();
<span class="hljs-keyword">while</span> (it.hasNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> it.next();
    it.remove();  <span class="hljs-comment">// 安全</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-53">5.6 compute/computeIfAbsent的线程安全问题</h3>
<p><strong>compute系列方法是原子的：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ computeIfAbsent是原子操作</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; expensiveCompute());

<span class="hljs-comment">// ❌ 错误：非原子，可能多次计算</span>
<span class="hljs-keyword">if</span> (map.get(<span class="hljs-string">"key"</span>) == <span class="hljs-literal">null</span>) {
    map.put(<span class="hljs-string">"key"</span>, expensiveCompute());  <span class="hljs-comment">// 可能被多个线程执行</span>
}
</code></pre>
<p><strong>源码分析：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">computeIfAbsent</span><span class="hljs-params">(K key, Function&lt;? <span class="hljs-built_in">super</span> K, ? extends V&gt; mappingFunction)</span> {
    ...
    <span class="hljs-keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) {
        ...
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((f = tabAt(tab, i = (n - <span class="hljs-number">1</span>) &amp; h)) == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 桶为空，CAS插入</span>
            Node&lt;K,V&gt; r = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReservationNode</span>&lt;K,V&gt;();
            <span class="hljs-keyword">synchronized</span> (r) {  <span class="hljs-comment">// 临时节点加锁</span>
                <span class="hljs-keyword">if</span> (casTabAt(tab, i, <span class="hljs-literal">null</span>, r)) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-type">V</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> mappingFunction.apply(key);  <span class="hljs-comment">// 只计算一次</span>
                        ...
                    }
                }
            }
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">synchronized</span> (f) {  <span class="hljs-comment">// 锁定桶</span>
                ...
                <span class="hljs-keyword">if</span> (binCount != <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)
                        treeifyBin(tab, i);
                    <span class="hljs-keyword">if</span> (oldVal != <span class="hljs-literal">null</span>)
                        <span class="hljs-keyword">return</span> oldVal;
                    <span class="hljs-keyword">break</span>;
                }
            }
        }
    }
    ...
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>mappingFunction.apply()</code>只会被<strong>一个线程执行</strong></li>
<li>其他线程会等待第一个线程完成</li>
</ul>
<p><strong>⚠️ 注意死锁风险：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 可能死锁</span>
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; {
    <span class="hljs-keyword">return</span> map.computeIfAbsent(<span class="hljs-string">"key2"</span>, k2 -&gt; <span class="hljs-string">"value"</span>);  <span class="hljs-comment">// 嵌套锁</span>
});
</code></pre>
<p><strong>正确用法：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 避免嵌套</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; computeValue());
</code></pre>
<hr/>
<h3 data-id="heading-54">5.7 putIfAbsent vs computeIfAbsent的区别</h3>






























<table><thead><tr><th>对比项</th><th>putIfAbsent</th><th>computeIfAbsent</th></tr></thead><tbody><tr><td><strong>参数</strong></td><td><code>putIfAbsent(K key, V value)</code></td><td><code>computeIfAbsent(K key, Function&lt;K, V&gt; f)</code></td></tr><tr><td><strong>计算时机</strong></td><td><strong>立即计算</strong>value</td><td><strong>延迟计算</strong>，key不存在时才计算</td></tr><tr><td><strong>性能</strong></td><td>浪费计算（value已计算好）</td><td><strong>懒加载</strong>，性能更好</td></tr><tr><td><strong>适用场景</strong></td><td>value已准备好</td><td>value计算昂贵</td></tr></tbody></table>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景1：value已准备好 → putIfAbsent</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-string">"computed-value"</span>;
map.putIfAbsent(<span class="hljs-string">"key"</span>, value);

<span class="hljs-comment">// 场景2：value需要计算 → computeIfAbsent（推荐）</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; {
    <span class="hljs-comment">// 只有key不存在时才执行</span>
    <span class="hljs-keyword">return</span> expensiveCompute();
});

<span class="hljs-comment">// ❌ 错误用法：提前计算浪费</span>
<span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> expensiveCompute();  <span class="hljs-comment">// key存在时白算了</span>
map.putIfAbsent(<span class="hljs-string">"key"</span>, value);
</code></pre>
<hr/>
<h3 data-id="heading-55">5.8 如何正确统计ConcurrentHashMap的元素数量？</h3>
<p><strong>方法1：size()（推荐）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();  <span class="hljs-comment">// O(counterCells.length)</span>
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 实现简单</li>
<li>✅ 性能尚可（遍历counterCells数组）</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>❌ 返回<strong>近似值</strong>，不保证精确</li>
<li>❌ 数据量大时有性能开销</li>
</ul>
<p><strong>方法2：AtomicLong计数（精确）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> {
    <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> map.put(key, value);
    <span class="hljs-keyword">if</span> (oldValue == <span class="hljs-literal">null</span>) {
        count.incrementAndGet();
    }
    <span class="hljs-keyword">return</span> oldValue;
}

<span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> count.get();  <span class="hljs-comment">// O(1)</span>
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ O(1)性能</li>
<li>✅ 实时精确</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>❌ 需要在所有修改方法中同步更新</li>
<li>❌ 代码侵入性强</li>
</ul>
<p><strong>方法3：mappingCount()（JDK 1.8推荐）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> map.mappingCount();  <span class="hljs-comment">// 返回long，避免溢出</span>
</code></pre>
<p><strong>区别：</strong></p>
<ul>
<li><code>size()</code>返回<code>int</code>，最大<code>Integer.MAX_VALUE</code></li>
<li><code>mappingCount()</code>返回<code>long</code>，支持更大容量</li>
</ul>
<p><strong>推荐：</strong></p>
<ul>
<li>普通场景：<code>size()</code></li>
<li>超大容量：<code>mappingCount()</code></li>
<li>性能敏感：<code>AtomicLong</code></li>
</ul>
<hr/>
<h2 data-id="heading-56">六、最佳实践与总结</h2>
<h3 data-id="heading-57">6.1 什么场景使用ConcurrentHashMap？</h3>
<p><strong>适用场景：</strong></p>
<ol>
<li>✅ <strong>高并发读写</strong>：多线程频繁读写共享Map</li>
<li>✅ <strong>读多写少</strong>：如配置缓存、用户session</li>
<li>✅ <strong>无需强一致性</strong>：允许读到稍旧的数据</li>
<li>✅ <strong>需要高性能</strong>：Hashtable性能不满足需求</li>
</ol>
<p><strong>不适用场景：</strong></p>
<ol>
<li>❌ <strong>单线程</strong>：HashMap性能更好</li>
<li>❌ <strong>需要强一致性</strong>：使用<code>Collections.synchronizedMap()</code></li>
<li>❌ <strong>需要排序</strong>：使用<code>ConcurrentSkipListMap</code></li>
<li>❌ <strong>key/value允许null</strong>：使用<code>Collections.synchronizedMap(new HashMap&lt;&gt;())</code></li>
</ol>
<hr/>
<h3 data-id="heading-58">6.2 如何正确使用ConcurrentHashMap？</h3>
<p><strong>1. 选择合适的初始容量</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 推荐：预估元素数量，避免扩容</span>
<span class="hljs-type">int</span> <span class="hljs-variable">expectedSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;
<span class="hljs-type">int</span> <span class="hljs-variable">initialCapacity</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (expectedSize / <span class="hljs-number">0.75</span>) + <span class="hljs-number">1</span>;
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(initialCapacity);

<span class="hljs-comment">// ❌ 不推荐：默认容量16，频繁扩容</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
</code></pre>
<p><strong>2. 使用compute系列方法保证原子性</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 原子操作</span>
map.computeIfAbsent(<span class="hljs-string">"key"</span>, k -&gt; computeValue());

<span class="hljs-comment">// ❌ 非原子</span>
<span class="hljs-keyword">if</span> (!map.containsKey(<span class="hljs-string">"key"</span>)) {
    map.put(<span class="hljs-string">"key"</span>, computeValue());
}
</code></pre>
<p><strong>3. 避免在compute中嵌套修改</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 可能死锁</span>
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; map.get(<span class="hljs-string">"key2"</span>));

<span class="hljs-comment">// ✅ 先获取，再计算</span>
<span class="hljs-type">String</span> <span class="hljs-variable">key2Value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key2"</span>);
map.computeIfAbsent(<span class="hljs-string">"key1"</span>, k -&gt; process(key2Value));
</code></pre>
<p><strong>4. 使用mappingCount()替代size()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 支持long，避免溢出</span>
<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> map.mappingCount();

<span class="hljs-comment">// ⚠️ 返回int，可能溢出</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
</code></pre>
<hr/>
<h3 data-id="heading-59">6.3 性能优化建议</h3>
<p><strong>1. 合理设置初始容量和加载因子</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景：预期10000个元素，读多写少</span>
ConcurrentHashMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(
    <span class="hljs-number">16384</span>,  <span class="hljs-comment">// initialCapacity: 10000 / 0.75 ≈ 13333，向上取2的幂次 = 16384</span>
    <span class="hljs-number">0.75f</span>   <span class="hljs-comment">// loadFactor: 默认0.75即可</span>
);
</code></pre>
<p><strong>2. 避免频繁size()调用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 每次都调用size()</span>
<span class="hljs-keyword">for</span> (...) {
    <span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">10000</span>) {
        ...
    }
}

<span class="hljs-comment">// ✅ 缓存size()结果</span>
<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> map.size();
<span class="hljs-keyword">for</span> (...) {
    <span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">10000</span>) {
        ...
    }
}
</code></pre>
<p><strong>3. 批量操作使用putAll()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 逐个put</span>
<span class="hljs-keyword">for</span> (Entry&lt;K, V&gt; entry : entries) {
    map.put(entry.getKey(), entry.getValue());
}

<span class="hljs-comment">// ✅ 批量putAll</span>
map.putAll(otherMap);
</code></pre>
<hr/>
<h3 data-id="heading-60">6.4 常见错误用法</h3>
<p><strong>错误1：当作强一致性容器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：以为是原子操作</span>
<span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">100</span>) {
    map.remove(oldestKey);  <span class="hljs-comment">// size()和remove()之间，size可能已变化</span>
}

<span class="hljs-comment">// ✅ 正确：单独维护计数</span>
<span class="hljs-keyword">if</span> (count.get() &gt; <span class="hljs-number">100</span>) {
    removeOldest();
}
</code></pre>
<p><strong>错误2：依赖迭代顺序</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：ConcurrentHashMap不保证顺序</span>
<span class="hljs-keyword">for</span> (String key : map.keySet()) {
    <span class="hljs-comment">// 期望按插入顺序...</span>
}

<span class="hljs-comment">// ✅ 正确：使用ConcurrentSkipListMap（有序）</span>
ConcurrentNavigableMap&lt;K, V&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentSkipListMap</span>&lt;&gt;();
</code></pre>
<p><strong>错误3：忘记处理null</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：忘记判null</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">"key"</span>);
value.toString();  <span class="hljs-comment">// NPE</span>

<span class="hljs-comment">// ✅ 正确：判空或使用getOrDefault</span>
<span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.getOrDefault(<span class="hljs-string">"key"</span>, defaultValue);
</code></pre>
<hr/>
<h3 data-id="heading-61">6.5 线程安全容器选型指南</h3>









































<table><thead><tr><th>需求</th><th>推荐容器</th></tr></thead><tbody><tr><td><strong>高并发读写Map</strong></td><td><code>ConcurrentHashMap</code></td></tr><tr><td><strong>有序Map</strong></td><td><code>ConcurrentSkipListMap</code></td></tr><tr><td><strong>高并发List</strong></td><td><code>CopyOnWriteArrayList</code>（读多写少）</td></tr><tr><td><strong>高并发Set</strong></td><td><code>ConcurrentHashMap.newKeySet()</code></td></tr><tr><td><strong>高并发Queue</strong></td><td><code>ConcurrentLinkedQueue</code>（无界）<br/><code>LinkedBlockingQueue</code>（有界）</td></tr><tr><td><strong>延迟队列</strong></td><td><code>DelayQueue</code></td></tr><tr><td><strong>优先级队列</strong></td><td><code>PriorityBlockingQueue</code></td></tr><tr><td><strong>强一致性Map</strong></td><td><code>Collections.synchronizedMap()</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-62">总结</h2>
<p><code>ConcurrentHashMap</code>是Java并发包中最重要的容器之一，经历了从**分段锁（JDK 1.7）<strong>到</strong>CAS + synchronized（JDK 1.8）**的演进，在保证线程安全的同时实现了极高的并发性能。</p>
<p><strong>核心要点回顾：</strong></p>
<ol>
<li><strong>设计目标</strong>：高并发、高性能、线程安全、弱一致性</li>
<li><strong>JDK 1.7</strong>：Segment分段锁，并发度受限于Segment数量（默认16）</li>
<li><strong>JDK 1.8</strong>：Node数组 + 链表/红黑树，CAS + synchronized，并发度等于数组长度</li>
<li><strong>关键机制</strong>：
<ul>
<li>桶为空：CAS插入（无锁）</li>
<li>正在扩容：协助扩容（多线程协作）</li>
<li>hash冲突：synchronized锁头节点（细粒度锁）</li>
</ul>
</li>
<li><strong>扩容优化</strong>：多线程协作迁移，ForwardingNode标记已迁移桶</li>
<li><strong>计数优化</strong>：baseCount + CounterCell[]，LongAdder思想</li>
</ol>
<p><strong>最佳实践：</strong></p>
<ul>
<li>✅ 预估容量，避免频繁扩容</li>
<li>✅ 使用compute系列方法保证原子性</li>
<li>✅ 使用mappingCount()替代size()</li>
<li>✅ 适用于读多写少、弱一致性场景</li>
<li>❌ 不要在compute中嵌套修改</li>
<li>❌ 不要依赖迭代顺序</li>
<li>❌ 不要频繁调用size()</li>
</ul>
<p><code>ConcurrentHashMap</code>是并发编程的基础组件，深入理解其原理和正确使用方式，对构建高性能并发系统至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[09 Go Eino AI应用开发实战 | Hertz Web 框架搭建]]></title>    <link>https://juejin.cn/post/7585474459776630820</link>    <guid>https://juejin.cn/post/7585474459776630820</guid>    <pubDate>2025-12-20T09:43:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776630820" data-draft-id="7585390679398858758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="09 Go Eino AI应用开发实战 | Hertz Web 框架搭建"/> <meta itemprop="keywords" content="后端,人工智能,Go"/> <meta itemprop="datePublished" content="2025-12-20T09:43:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            09 Go Eino AI应用开发实战 | Hertz Web 框架搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:43:30.000Z" title="Sat Dec 20 2025 09:43:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>声明：本AI应用开发系列教程首发在同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5DYsyMKh9cDJdVvs_Mn9_Q" target="_blank" title="https://mp.weixin.qq.com/s/5DYsyMKh9cDJdVvs_Mn9_Q" ref="nofollow noopener noreferrer">王中阳</a>，未经授权禁止转载。</p>
</blockquote>
<p>Hertz Web 框架作为 AI Interview Agent 平台的核心支柱，提供高性能的 HTTP 路由、中间件编排和请求处理能力。本指南涵盖 Hertz 在项目架构中的完整设置和配置。</p>
<h2 data-id="heading-0">框架初始化</h2>
<p>Hertz 服务器在主应用程序入口点初始化，通过包含配置加载、数据库连接和中间件注册的完整设置序列 [main.go#L101-L175]。</p>
<p>服务器初始化遵循以下关键模式：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 使用配置中的主机和端口初始化 Hertz 服务器</span>
s := server.Default(server.WithHostPorts(fmt.Sprintf(<span class="hljs-string">"%s:%d"</span>, cfg.Host, cfg.Port)))
</code></pre>
<h2 data-id="heading-1">中间件架构</h2>
<p>Hertz 实现了分层中间件架构来处理横切关注点：</p>
<h3 data-id="heading-2">恢复中间件</h3>
<p>恢复中间件捕获 panic 并防止服务器崩溃，提供结构化错误响应 [recovery.go#L15-L35]：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Recovery</span><span class="hljs-params">()</span></span> app.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, c *app.RequestContext)</span></span> {
        <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
                stack := debug.Stack()
                log.Printf(<span class="hljs-string">"[PANIC] Recovered: %v\n%s"</span>, r, stack)
                <span class="hljs-comment">// 返回结构化错误响应</span>
            }
        }()
        c.Next(ctx)
    }
}
</code></pre>
<h3 data-id="heading-3">CORS 配置</h3>
<p>全局 CORS 中间件通过全面的头部配置处理跨域请求 [main.go#L113-L127]：</p>






























<table><thead><tr><th>Header</th><th>Value</th><th>Purpose</th></tr></thead><tbody><tr><td>Access-Control-Allow-Origin</td><td>*</td><td>允许所有来源</td></tr><tr><td>Access-Control-Allow-Methods</td><td>GET, POST, PUT, DELETE, OPTIONS</td><td>允许的 HTTP 方法</td></tr><tr><td>Access-Control-Allow-Headers</td><td>Content-Type, Authorization, X-Requested-With, Cache-Control, X-Auth-Token</td><td>允许的请求头</td></tr><tr><td>Access-Control-Max-Age</td><td>86400</td><td>预检请求缓存 24 小时</td></tr></tbody></table>
<h3 data-id="heading-4">JWT 认证</h3>
<p>JWT 中间件提供基于令牌的认证，支持可配置的路由跳过 [jwt.go#L37-L79]。绕过认证的公共路由包括：</p>
<ul>
<li><code>/api/user/login</code></li>
<li><code>/api/user/register</code></li>
<li><code>/api/user/logout</code></li>
<li><code>/api/user/wechat/login</code></li>
<li><code>/api/user/wechat/callback</code></li>
<li><code>/api/demo/create/model</code></li>
</ul>
<h2 data-id="heading-5">路由注册系统</h2>
<p>Hertz 使用基于 IDL 定义的自动生成路由注册系统 [register.go#L11-L16]。路由层次遵循结构化模式：</p>
<pre><code class="hljs language-bash" lang="bash">/
├── /api/
    ├── /interview/
    │   ├── /records (GET)
    │   └── /stream/
    │       └── /start (POST)
    ├── /mianshi/
    │   ├── /answer-record (GET)
    │   ├── /evaluation (GET)
    │   ├── /records (GET)
    │   ├── /answer/
    │   │   └── /submit (POST)
    │   ├── /interview/
    │   │   └── /end (POST)
    │   ├── /session/
    │   │   └── /info (GET)
    │   └── /stream/
    │       └── /start (POST)
    ├── /prediction/
    │   ├── /:<span class="hljs-built_in">id</span> (GET)
    │   ├── /list (GET)
    │   └── /start (POST)
    ├── /resume/
    │   ├── /default (GET)
    │   ├── /list (GET)
    │   ├── /:resume_id (GET, PUT, DELETE)
    │   ├── /set-default (POST)
    │   └── /upload (POST)
    └── /user/
        ├── /login (POST)
        ├── /register (POST)
        ├── /profile (GET, PUT)
        ├── /create/model (POST)
        ├── /model/
        │   ├── /check (GET)
        │   ├── /list (GET)
        │   ├── /delete/:<span class="hljs-built_in">id</span> (DELETE)
        │   ├── /details/:<span class="hljs-built_in">id</span> (GET)
        │   └── /update/:<span class="hljs-built_in">id</span> (PUT)
        └── /wechat/
            ├── /login (GET)
            └── /callback (GET)
</code></pre>
<p>路由注册是使用 Hertz 生成器从 IDL 定义自动生成的。手动修改生成的文件将在更新时被覆盖。</p>
<h2 data-id="heading-6">配置集成</h2>
<p>Hertz 配置与应用程序的集中式配置系统集成 [config.go#L75-L83]：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> HertzConfig <span class="hljs-keyword">struct</span> {
    Host         <span class="hljs-type">string</span>        <span class="hljs-string">`yaml:"host"`</span>
    Port         <span class="hljs-type">int</span>           <span class="hljs-string">`yaml:"port"`</span>
    ReadTimeout  time.Duration <span class="hljs-string">`yaml:"read_timeout"`</span>
    WriteTimeout time.Duration <span class="hljs-string">`yaml:"write_timeout"`</span>
    IdleTimeout  time.Duration <span class="hljs-string">`yaml:"idle_timeout"`</span>
}
</code></pre>
<p>服务器使用环境变量扩展，允许通过 YAML 文件中的 <code>${VAR_NAME}</code> 语法进行灵活配置。</p>
<h2 data-id="heading-7">优雅关闭</h2>
<p>Hertz 实现了带有适当资源清理的优雅关闭 [main.go#L147-L175]：</p>
<ol>
<li><strong>信号处理</strong>：监听 SIGINT 和 SIGTERM 信号</li>
<li><strong>消费者关闭</strong>：停止消息队列消费者</li>
<li><strong>队列清理</strong>：关闭消息队列连接</li>
<li><strong>服务器关闭</strong>：在 5 秒超时内优雅关闭 HTTP 连接</li>
</ol>
<p>优雅关闭序列确保所有进行中的请求完成，同时阻止新请求，在重启期间维护数据完整性。</p>
<h2 data-id="heading-8">性能考虑</h2>
<p>Hertz 设置包括多项性能优化：</p>
<ul>
<li><strong>连接池</strong>：通过数据库和 Redis 连接设置配置</li>
<li><strong>请求超时</strong>：可配置的读取、写入和空闲超时防止资源泄漏</li>
<li><strong>中间件顺序</strong>：关键中间件（恢复、CORS）置于认证之前以获得最佳性能</li>
<li><strong>静态文件处理</strong>：通过 Hertz 内置的静态文件功能高效提供</li>
</ul>
<h2 data-id="heading-9">集成点</h2>
<p>Hertz 与其他系统组件无缝集成：</p>
<ul>
<li><strong>消息队列</strong>：基于 Redis 的异步处理队列</li>
<li><strong>数据库</strong>：GORM 集成用于数据持久化</li>
<li><strong>AI 服务</strong>：Eino 框架集成用于 AI Agent 编排</li>
<li><strong>文件存储</strong>：简历上传和管理能力</li>
</ul>
<p>框架的模块化设计允许轻松扩展和维护，同时为 AI Interview Agent 平台保持高性能和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redisson分布式锁实现原理]]></title>    <link>https://juejin.cn/post/7585463195201339442</link>    <guid>https://juejin.cn/post/7585463195201339442</guid>    <pubDate>2025-12-20T08:01:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585463195201339442" data-draft-id="7585446706327388169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redisson分布式锁实现原理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-20T08:01:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sir761"/> <meta itemprop="url" content="https://juejin.cn/user/1285746184422272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redisson分布式锁实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285746184422272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sir761
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:01:18.000Z" title="Sat Dec 20 2025 08:01:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说到redis的分布式锁容易想到了setNx，好处是实现简单，但是会有一些问题比如误删锁问题、锁不可重入问题。所以Redisson并没有通过setNx命令来实现加锁，而是自己实现了一套完成的加锁的逻辑</p>
<h3 data-id="heading-0">加锁与解锁</h3>
<p>RLock继承了Java的lock接口，RedissonLock继承自RedissonBaseLock（抽象类），而RedissonBaseLock又实现了RLock。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//调用getLock时候就是new了一个RedissonLock</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>我们重点看lock方法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> void lock() {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">this</span>.lock(-<span class="hljs-number">1L</span>, (TimeUnit)<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException var2) {
        <span class="hljs-keyword">throw</span> new IllegalStateException();
    }
}
​
<span class="hljs-keyword">private</span> void lock(long leaseTime, TimeUnit unit, boolean interruptibly) throws InterruptedException {
    long threadId = Thread.currentThread().getId();
    <span class="hljs-comment">//调用了tryAcquire获取锁，这里传入了-1L代表没有指定锁的释放时间，正常情况下如果不释放是永久持有。</span>
    <span class="hljs-built_in">Long</span> ttl = <span class="hljs-keyword">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
    <span class="hljs-comment">//以下代码先忽略</span>
    <span class="hljs-comment">//.....</span>
}
​
<span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> tryAcquire(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    <span class="hljs-comment">//这里调用get，等待future返回。</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">Long</span>)<span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">this</span>.tryAcquireAsync0(waitTime, leaseTime, unit, threadId));
}
​
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync0(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    <span class="hljs-comment">//使用了线程池去获取锁</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getServiceManager().execute(() -&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tryAcquireAsync(waitTime, leaseTime, unit, threadId);
    });
}
<span class="hljs-comment">//重点方法来了</span>
<span class="hljs-keyword">private</span> RFuture&lt;<span class="hljs-built_in">Long</span>&gt; tryAcquireAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId) {
    RFuture ttlRemainingFuture;
    <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
        <span class="hljs-comment">//如果这里leaseTime不为0说明用户设置了锁的租约时间直接传入。</span>
        ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//如果这里leaseTime为0说明用户没有限制锁的租约时间，但是这里仍然会传30秒的持有时间</span>
        ttlRemainingFuture = <span class="hljs-keyword">this</span>.tryLockInnerAsync(waitTime, <span class="hljs-keyword">this</span>.internalLockLeaseTime, TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);
    }
​
    CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; s = <span class="hljs-keyword">this</span>.handleNoSync(threadId, ttlRemainingFuture);
    RFuture&lt;<span class="hljs-built_in">Long</span>&gt; ttlRemainingFuture = new CompletableFutureWrapper(s);
    CompletionStage&lt;<span class="hljs-built_in">Long</span>&gt; f = ttlRemainingFuture.thenApply((ttlRemaining) -&gt; {
        <span class="hljs-comment">//如果为空说明lua获取锁脚本获得了锁</span>
        <span class="hljs-keyword">if</span> (ttlRemaining == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">//判断是否开启看门狗机制。</span>
            <span class="hljs-keyword">if</span> (leaseTime &gt; <span class="hljs-number">0L</span>) {
                <span class="hljs-keyword">this</span>.internalLockLeaseTime = unit.toMillis(leaseTime);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.scheduleExpirationRenewal(threadId);
            }
        }
​
        <span class="hljs-keyword">return</span> ttlRemaining;
    });
    <span class="hljs-keyword">return</span> new CompletableFutureWrapper(f);
}
&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-keyword">this</span>.getRawName(), LongCodec.INSTANCE, command, 
    <span class="hljs-string">"if ((redis.call('exists', KEYS[1]) == 0) or (redis.call('hexists', KEYS[1], ARGV[2]) == 1)) then "</span> +
        <span class="hljs-string">"redis.call('hincrby', KEYS[1], ARGV[2], 1); "</span> +
        <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[1]); "</span>+
        <span class="hljs-string">"return nil; "</span>+ 
    <span class="hljs-string">"end;"</span>+
    <span class="hljs-comment">//返回锁的过期时间。</span>
    <span class="hljs-string">"return redis.call('pttl', KEYS[1]);"</span>, 
    Collections.singletonList(<span class="hljs-keyword">this</span>.getRawName()), new Object[]{unit.toMillis(leaseTime), <span class="hljs-keyword">this</span>.getLockName(threadId)});
}
</code></pre>
<p>获取锁的整个逻辑是：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7303c1cfaf4549c39ec9472e6462b533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=QQsH%2FZidVMS0dKLq54qchV%2F1e0E%3D" alt="分布式锁获取过程.drawio-1764576921173-4.png" loading="lazy"/>
首先，如果用户调用获取锁时候没有限制租约时间，redisson会自动给tryLockInnerAsync加上一个30秒的租约时间，并调用scheduleExpirationRenewal进行看门狗机制</p>
<p>tryLockInnerAsync是执行了一个lua脚本，首先redisson他采用的是hash来存放这个锁，key是锁的名字，field由UUID和线程id组成（UUID是区分不同客户端，防止不同客户端但是线程名恰好相同），value是锁的重入次数。这样就避免了锁的误删，重入和死锁问题了。lua的大致流程为：</p>
<ol>
<li>先判断当前锁是否被持有或者持有者是否是当前线程，如果是的话重入次数加1，并设置/重置整个锁 Key 的过期时间（防止死锁）然后返回。</li>
<li>如果上面if不成立说明锁被<strong>别人</strong>持有了，则返回当前锁剩余的存活时间（TTL）。客户端拿到这个时间后，会等待这么久再重试。</li>
</ol>
<p>回到刚刚我们忽略的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">boolean</span> interruptibly)</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();
    <span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
    <span class="hljs-comment">//如果这里ttl不为空说明锁被人占有了。</span>
    <span class="hljs-keyword">if</span> (ttl != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">//此时使用pub/sub订阅这个管道</span>
        CompletableFuture&lt;RedissonLockEntry&gt; future = <span class="hljs-built_in">this</span>.subscribe(threadId);
        <span class="hljs-built_in">this</span>.pubSub.timeout(future);
        <span class="hljs-comment">//内部维护了一个Semaphore用于控制本地线程的阻塞和唤醒</span>
        RedissonLockEntry entry;
        <span class="hljs-keyword">if</span> (interruptibly) {
            entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.getInterrupted(future);
        } <span class="hljs-keyword">else</span> {
            entry = (RedissonLockEntry)<span class="hljs-built_in">this</span>.commandExecutor.get(future);
        }
​
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//死循环直到获取锁或者被中断</span>
            <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">//先乐观查询一次</span>
                ttl = <span class="hljs-built_in">this</span>.tryAcquire(-<span class="hljs-number">1L</span>, leaseTime, unit, threadId);
                <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span>;
                }
               <span class="hljs-comment">//仍然没有获取到锁则进入阻塞阶段</span>
                <span class="hljs-keyword">if</span> (ttl &gt;= <span class="hljs-number">0L</span>) {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">//通过ttl时间判断锁还有多久释放，从而判断阻塞多久，避免cpu空转带来性能消耗，精准在锁释放时候唤醒</span>
                        <span class="hljs-comment">//当有人释放锁了,redisson监听到了之后调用entry.getLatch().release(),或者到达ttl了都会使线程被唤醒</span>
                        entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                    } <span class="hljs-keyword">catch</span> (InterruptedException var14) {
                        <span class="hljs-type">InterruptedException</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> var14;
                        <span class="hljs-keyword">if</span> (interruptibly) {
                            <span class="hljs-keyword">throw</span> e;
                        }
                        <span class="hljs-comment">//出现异常了，重新抢锁</span>
                        entry.getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interruptibly) {
                    entry.getLatch().acquire();
                } <span class="hljs-keyword">else</span> {
                    entry.getLatch().acquireUninterruptibly();
                }
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">//最后终止订阅。</span>
            <span class="hljs-built_in">this</span>.unsubscribe(entry, threadId);
        }
    }
}
</code></pre>
<p>解锁的逻辑：</p>
<p>跟加锁逻辑一样都是异步转换同步。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().generateId();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getServiceManager().execute(() -&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.unlockAsync0(threadId, requestId);
    });
}
​
<span class="hljs-keyword">private</span> RFuture&lt;Void&gt; <span class="hljs-title function_">unlockAsync0</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
    CompletionStage&lt;Boolean&gt; future = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId);
    <span class="hljs-comment">//处理异常</span>
    CompletionStage&lt;Void&gt; f = future.handle((res, e) -&gt; {
        <span class="hljs-built_in">this</span>.cancelExpirationRenewal(threadId, res);
        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> CompletionException) {
                <span class="hljs-keyword">throw</span> (CompletionException)e;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(e);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">IllegalMonitorStateException</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<span class="hljs-string">"attempt to unlock lock, not locked by current thread by node id: "</span> + <span class="hljs-built_in">this</span>.id + <span class="hljs-string">" thread-id: "</span> + threadId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionException</span>(cause);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(f);
}
​
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId)</span> {
    <span class="hljs-keyword">if</span> (requestId == <span class="hljs-literal">null</span>) {
        requestId = <span class="hljs-built_in">this</span>.getServiceManager().generateId();
    }
​
    <span class="hljs-type">MasterSlaveServersConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServiceManager().getConfig();
    <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ((<span class="hljs-type">long</span>)config.getTimeout() + config.getRetryDelay().calcDelay(config.getRetryAttempts()).toMillis()) * (<span class="hljs-type">long</span>)config.getRetryAttempts();
    timeout = Math.max(timeout, <span class="hljs-number">1L</span>);
    <span class="hljs-comment">//异步释放锁</span>
    RFuture&lt;Boolean&gt; r = <span class="hljs-built_in">this</span>.unlockInnerAsync(threadId, requestId, (<span class="hljs-type">int</span>)timeout);
    CompletionStage&lt;Boolean&gt; ff = r.thenApply((v) -&gt; {
        <span class="hljs-type">CommandAsyncExecutor</span> <span class="hljs-variable">ce</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.commandExecutor;
        <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
            ce = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandBatchService</span>(<span class="hljs-built_in">this</span>.commandExecutor);
        }
​
        ((CommandAsyncExecutor)ce).writeAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.DEL, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{<span class="hljs-built_in">this</span>.getUnlockLatchName(<span class="hljs-built_in">this</span>.id)});
        <span class="hljs-keyword">if</span> (ce <span class="hljs-keyword">instanceof</span> CommandBatchService) {
            ((CommandBatchService)ce).executeAsync();
        }
​
        <span class="hljs-keyword">return</span> v;
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFutureWrapper</span>(ff);
}
​
<span class="hljs-keyword">protected</span> RFuture&lt;Boolean&gt; <span class="hljs-title function_">unlockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> threadId, String requestId, <span class="hljs-type">int</span> timeout)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.evalWriteSyncedNoRetryAsync(<span class="hljs-built_in">this</span>.getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,
<span class="hljs-comment">//防重检查（幂等性）</span>
<span class="hljs-string">"local val = redis.call('get', KEYS[3]);"</span>+
<span class="hljs-string">"if val ~= false then "</span>+
    <span class="hljs-string">"return tonumber(val);"</span>+
<span class="hljs-string">"end;"</span>+
<span class="hljs-comment">//判断是否持有锁</span>
<span class="hljs-string">"if (redis.call('hexists', KEYS[1], ARGV[3]) == 0) then "</span>+
    <span class="hljs-string">"return nil;"</span>+
<span class="hljs-string">"end; "</span>+
<span class="hljs-comment">//扣减重入次数</span>
<span class="hljs-string">"local counter = redis.call('hincrby', KEYS[1], ARGV[3], -1); "</span>+
<span class="hljs-comment">//判断是“重入释放”还是“彻底释放”</span>
<span class="hljs-string">"if (counter &gt; 0) then "</span>+
    <span class="hljs-comment">//重入次数减1</span>
    <span class="hljs-string">"redis.call('pexpire', KEYS[1], ARGV[2]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 0, 'px', ARGV[5]); "</span>+
<span class="hljs-string">"return 0; "</span>+
<span class="hljs-string">"else "</span>+
    <span class="hljs-comment">//彻底释放锁</span>
    <span class="hljs-string">"redis.call('del', KEYS[1]); "</span>+
    <span class="hljs-comment">//发送队列消息</span>
    <span class="hljs-string">"redis.call(ARGV[4], KEYS[2], ARGV[1]); "</span>+
    <span class="hljs-string">"redis.call('set', KEYS[3], 1, 'px', ARGV[5]); "</span>+
    <span class="hljs-string">"return 1; "</span>+
<span class="hljs-string">"end; "</span>,
Arrays.asList(<span class="hljs-built_in">this</span>.getRawName(), <span class="hljs-built_in">this</span>.getChannelName(), <span class="hljs-built_in">this</span>.getUnlockLatchName(requestId)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{LockPubSub.UNLOCK_MESSAGE, <span class="hljs-built_in">this</span>.internalLockLeaseTime, <span class="hljs-built_in">this</span>.getLockName(threadId), <span class="hljs-built_in">this</span>.getSubscribeService().getPublishCommand(), timeout});
}
</code></pre>
<p>lua的流程为：</p>
<p>先去查一下 KEYS[3]（查看解锁请求的结果缓存）是否存在。如果存在，说明<strong>这个请求之前已经处理过了</strong>（可能是网络波动导致客户端以为超时了，重发了请求）。直接返回之前缓存的结果（0 或 1），不需要再执行后面的逻辑。这保证了<strong>幂等性</strong>。</p>
<ol start="0">
<li>检查 Hash KEYS[1] 中是否存在当前线程 ARGV[3]。如果不存在（== 0），说明当前线程根本没有持有这把锁。返回 nil（Java 客户端会抛出 IllegalMonitorStateException）。</li>
<li>将该线程的加锁计数器减 1，counter 是减完之后剩下的次数。</li>
<li>如果counter &gt; 0，说明锁重入了。pexpire：刷新锁的过期时间（看门狗时间），只要锁还没彻底释放，就得给它续命。set KEYS[3] 0：记录本次请求结果为 0（表示未完全释放）。返回 0，代表还未释放锁。</li>
<li>如果counter&lt;=0，说明锁此时可以释放了，这里会先删除这个锁对应的key，然后调用<code>redis.call(ARGV[4], KEYS[2], ARGV[1]);</code>这里ARGC[4]其实通常是publish发送消息，之所以不写死是因为集群下可以用spublish加快性能。这里发送消息是为了前文提到的，告诉监听者锁已经释放。set KEYS[3] 1：缓存本次请求结果为 1，并将1返回，代表锁成功释放了</li>
</ol>
<p>这里之所以要多出一个KEY[3]是为了<strong>做幂等</strong>。KEY[3]命名一般为{锁前缀}:{锁名}:{requestId}，每次请求时候都会带上不同的requestId，vlaue是requestId请求的解锁结果</p>
<p>存在一种可能，客户端重入了2次锁，客户端第一次调用unlock时候，redis正常执行了解锁逻辑，并扣减了1次锁记录，但是由于网络波动，响应丢失了，此时客户端会重新发起一次请求，导致重复扣减。为了解决这个问题，就利用key[3]，判断一下相同的请求id是否有记录如果是就代表确实发送了响应丢失，直接将上次的数据返回，避免重复解锁。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eedf6a2fdad34405a4e6a6423c17e22a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=KTTnPGHIo7Up7jT%2F0NvTi7QGW1I%3D" alt="Redisson锁数据结构.drawio.png" loading="lazy"/></p>
<h3 data-id="heading-1">公平锁</h3>
<p>以上锁是默认非公平锁，所有线程都去争抢锁，而公平锁则是进入队列等待，防止饥饿问题。</p>
<p>当我们getFairLock时候其实是new了一个RedissonFairLock</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">RLock</span> <span class="hljs-title function_">getFairLock</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonFairLock</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">commandExecutor</span>, name);
}
</code></pre>
<p>RedissonFairLock继承自RedissonLock也就是说加锁的流程都是大致相同的。RedissonFairLock重写了tryLockInnerAsync方法</p>
<pre><code class="hljs language-ini" lang="ini">&lt;T&gt; RFuture&lt;T&gt; tryLockInnerAsync(long waitTime, long leaseTime, TimeUnit unit, long threadId, RedisStrictCommand&lt;T&gt; command) {
    long <span class="hljs-attr">wait</span> = this.threadWaitTime<span class="hljs-comment">;</span>
    if (waitTime &gt; 0L) {
        <span class="hljs-attr">wait</span> = unit.toMillis(waitTime)<span class="hljs-comment">;</span>
    }
​
    long <span class="hljs-attr">currentTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_NULL_BOOLEAN) {
        return this.commandExecutor.syncedEvalNoRetry(
            this.getRawName(),
            LongCodec.INSTANCE,
            command,
            // Lua脚本 - 用于获取锁
            "while true do " +
            "    local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
            "    if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
            "</span>        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
            "    if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[3]</span>) then " +
            "        redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
            "        redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    else " +
            "        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
            "    redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "    for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
            "        redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[4]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1) then " +
            "    redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "return 1<span class="hljs-comment">;",</span>
            Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
            new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), currentTime, wait}
        )<span class="hljs-comment">;</span>
    } else if (<span class="hljs-attr">command</span> == RedisCommands.EVAL_LONG) {
        return this.commandExecutor.syncedEvalNoRetry(
            this.getRawName(),
            LongCodec.INSTANCE,
            command,
            // Lua脚本 - 用于尝试获取锁并返回TTL
            "while true do " +
            "    local <span class="hljs-attr">firstThreadId2</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>)<span class="hljs-comment">; " +</span>
            "    if <span class="hljs-attr">firstThreadId2</span> == <span class="hljs-literal">false</span> then <span class="hljs-string">" +
            "</span>        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2)<span class="hljs-comment">; " +</span>
            "    if timeout ~= false and tonumber(timeout) &lt;= tonumber(ARGV<span class="hljs-section">[4]</span>) then " +
            "        redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, firstThreadId2)<span class="hljs-comment">; " +</span>
            "        redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    else " +
            "        break<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if (redis.call('exists', KEYS<span class="hljs-section">[1]</span>) == 0) and ((redis.call('exists', KEYS<span class="hljs-section">[2]</span>) == 0) or (redis.call('lindex', KEYS<span class="hljs-section">[2]</span>, 0) == ARGV<span class="hljs-section">[2]</span>)) then " +
            "    redis.call('lpop', KEYS<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    redis.call('zrem', KEYS<span class="hljs-section">[3]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "    local <span class="hljs-attr">keys</span> = redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "    for <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">#keys, 1 do " +</span>
            "        redis.call('zincrby', KEYS<span class="hljs-section">[3]</span>, -tonumber(ARGV<span class="hljs-section">[3]</span>), keys<span class="hljs-section">[i]</span>)<span class="hljs-comment">; " +</span>
            "    end<span class="hljs-comment">; " +</span>
            "    redis.call('hset', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "if redis.call('hexists', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
            "    redis.call('hincrby', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[2]</span>, 1)<span class="hljs-comment">; " +</span>
            "    redis.call('pexpire', KEYS<span class="hljs-section">[1]</span>, ARGV<span class="hljs-section">[1]</span>)<span class="hljs-comment">; " +</span>
            "    return nil<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">timeout</span> = redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>])<span class="hljs-comment">; " +</span>
            "if timeout ~= false then " +
            "    local <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
            "    return math.max(0, ttl)<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">lastThreadId</span> = redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>)<span class="hljs-comment">; " +</span>
            "local ttl<span class="hljs-comment">; " +</span>
            "if lastThreadId ~= false and lastThreadId ~= ARGV<span class="hljs-section">[2]</span> and redis.call('zscore', KEYS<span class="hljs-section">[3]</span>, lastThreadId) ~= false then " +
            "    <span class="hljs-attr">ttl</span> = tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
            "else " +
            "    <span class="hljs-attr">ttl</span> = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "local <span class="hljs-attr">timeout</span> = ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>])<span class="hljs-comment">; " +</span>
            "if redis.call('zadd', KEYS<span class="hljs-section">[3]</span>, timeout, ARGV<span class="hljs-section">[2]</span>) == 1 then " +
            "    redis.call('rpush', KEYS<span class="hljs-section">[2]</span>, ARGV<span class="hljs-section">[2]</span>)<span class="hljs-comment">; " +</span>
            "end<span class="hljs-comment">; " +</span>
            "return ttl<span class="hljs-comment">;",</span>
            Arrays.asList(this.getRawName(), this.threadsQueueName, this.timeoutSetName),
            new Object<span class="hljs-section">[]</span>{unit.toMillis(leaseTime), this.getLockName(threadId), wait, currentTime}
        )<span class="hljs-comment">;</span>
    } else {
        throw new IllegalArgumentException()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这里有俩段lua脚本，第一段对应的是无参的tryLock（）方法，进行一次快速尝试，如果获取不到锁直接返回。第二段对应的是tryLock(waitTime)/lock这俩个阻塞等锁的方法。这里我们重点看第二段lua脚本，第一个lua脚本和第二个类似：</p>
<pre><code class="hljs language-java" lang="java">--循环的判断是否有waitTime已经超过的节点，如果有就剔除掉，防止占用着队列
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">do</span> 
    --查询等待队列头节点是什么
    <span class="hljs-type">local</span> <span class="hljs-variable">firstThreadId2</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>); 
    --如果等待队列为空则跳出循环
    <span class="hljs-keyword">if</span> firstThreadId2 == <span class="hljs-literal">false</span> then 
        <span class="hljs-keyword">break</span>; 
    end; 
    --不为空，判断一下是否超过了超时时间，如果是就删除掉，没有就跳出循环
    <span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
    <span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> and <span class="hljs-title function_">tonumber</span><span class="hljs-params">(timeout)</span> &lt;= tonumber(ARGV[<span class="hljs-number">4</span>]) then 
        redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], firstThreadId2); 
        redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
    <span class="hljs-keyword">else</span> 
        <span class="hljs-keyword">break</span>; 
    end; 
end; 
--判断一下锁是否没有被其他线程持有并且等待队列不存在（等待队列为空）或者对头是此线程，如果是则进入抢锁。
<span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span>) and ((redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">2</span>]) == <span class="hljs-number">0</span>) or (redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], <span class="hljs-number">0</span>) == ARGV[<span class="hljs-number">2</span>])) then 
    --将自己从队列移除
    redis.call(<span class="hljs-string">'lpop'</span>, KEYS[<span class="hljs-number">2</span>]); 
    redis.call(<span class="hljs-string">'zrem'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
    <span class="hljs-type">local</span> <span class="hljs-variable">keys</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zrange'</span>, KEYS[<span class="hljs-number">3</span>], <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>); 
    --循环整个队列，更新所有节点的超时时间（减少等待预算）
    <span class="hljs-type">for</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, #keys, <span class="hljs-number">1</span> <span class="hljs-keyword">do</span> 
        redis.call(<span class="hljs-string">'zincrby'</span>, KEYS[<span class="hljs-number">3</span>], -tonumber(ARGV[<span class="hljs-number">3</span>]), keys[i]); 
    end; 
    --真正的加锁逻辑，加锁后直接返回。
    redis.call(<span class="hljs-string">'hset'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
    --返回nil说明抢锁成功
    <span class="hljs-keyword">return</span> nil; 
end; 
--前面判断为<span class="hljs-literal">false</span>，说明锁被持有了，判断一下锁是否被本线程持有，如果是重入加<span class="hljs-number">1</span>并返回
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
    redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>); 
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]); 
    <span class="hljs-keyword">return</span> nil; 
end; 
--走到这里说明锁被其他人持有了，此时判断一下本线程是否已经在排队了
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], ARGV[<span class="hljs-number">2</span>]); 
<span class="hljs-keyword">if</span> timeout ~= <span class="hljs-literal">false</span> then 
    --如果在排队了，则返回锁的剩余持有时间
    <span class="hljs-type">local</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
    <span class="hljs-keyword">return</span> math.max(<span class="hljs-number">0</span>, ttl); 
end; 
--走到这里说明没有入队，先查看一下队尾节点
<span class="hljs-type">local</span> <span class="hljs-variable">lastThreadId</span> <span class="hljs-operator">=</span> redis.call(<span class="hljs-string">'lindex'</span>, KEYS[<span class="hljs-number">2</span>], -<span class="hljs-number">1</span>); 
local ttl; 
--如果队尾节点存在（锁被持有，有线程等待抢锁）则ttl是钱一个人的超时时间-当前时间。
<span class="hljs-keyword">if</span> lastThreadId ~= <span class="hljs-literal">false</span> and lastThreadId ~= ARGV[<span class="hljs-number">2</span>] and redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId) ~= <span class="hljs-literal">false</span> <span class="hljs-type">then</span> 
    <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> tonumber(redis.call(<span class="hljs-string">'zscore'</span>, KEYS[<span class="hljs-number">3</span>], lastThreadId)) - tonumber(ARGV[<span class="hljs-number">4</span>]); 
<span class="hljs-keyword">else</span> 
    --如果队尾节点不存在（锁被持有，且没有线程等待抢锁）则ttl就是锁的过期时间
    ttl = redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>]); 
end; 
<span class="hljs-type">local</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> ttl + tonumber(ARGV[<span class="hljs-number">3</span>]) + tonumber(ARGV[<span class="hljs-number">4</span>]); 
--然后入队，将计算好的超时时间放入Zset，并将本线程放入队尾。
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'zadd'</span>, KEYS[<span class="hljs-number">3</span>], timeout, ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> then 
    redis.call(<span class="hljs-string">'rpush'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">2</span>]); 
end; 
--返回告诉客户端，还需要时间为ttl，使用Semaphore去阻塞。（唤醒过程和前文提到过的一样）
<span class="hljs-keyword">return</span> ttl;
</code></pre>
<p>此过程中用到了Zset，List，我们直到List用于存放资源争抢者，那Zset又是干嘛的？</p>
<p>List 虽然能完美实现 FIFO（先进先出），但它有2个致命弱点：</p>
<ul>
<li><strong>不好判断过期时间</strong>：List 只能告诉你谁排第一，但不能告诉你他还是不是活的（有没有超时），如果非要利用List存储过期时间就得通过value去分割，不仅需要占用cpu资源而且不好判断如何分割，万一用户命名不规范导致分割错误，此时需要Zset，它存储了每个人的“死亡时间”，用来在每次操作前清理 List 里的僵尸节点。member是uuid+线程id，score是过期时间</li>
<li><strong>不好判断是否当前线程在队列中</strong>：List需要O(n)判断，时间慢，通过Zset的dict数据结构O(1)判断。</li>
</ul>
<p>此外，由于每一个节点有可能是lock（）这种无等待时间，会阻塞到一直获取锁，在Zset中难道我们要将Zset的过期分数设置很大或者设置为-1代表没有过期时间吗？那如果客户端宕机了，该节点不就占用这个Zset和list的节点，且谁也清除不掉，导致内存泄露。且轮到它作为头节点时候，又不会抢锁，导致全部都在死等。</p>
<p>旧版本的redisson是默认给5秒过期时间，每次5秒后就刷新一下，如果客户端宕机了就不会刷新，这个节点会被清除掉。但是当竞争激烈的时候5秒获取不到锁时候大量的线程醒过来同时去更新过期时间，这个惊群效应会导致性能急剧下降，后续新版本改为了5分钟。</p>
<p>如图，比起非公平锁多了俩个数据结构</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fcdc19af5dd40fcb4c907beb88fa65c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyNzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766822478&amp;x-signature=fCOelRfQZtVqpd7k%2FW%2BCSTzULqE%3D" alt="分布式公平锁获取过程.drawio.png" loading="lazy"/></p>
<p>若有错误欢迎指出，将及时改正。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比]]></title>    <link>https://juejin.cn/post/7585474459776335908</link>    <guid>https://juejin.cn/post/7585474459776335908</guid>    <pubDate>2025-12-20T08:22:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776335908" data-draft-id="7585474459776319524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-20T08:22:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kibana：使用 ES|QL 构建地图，对国家或地区的指标进行对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:22:04.000Z" title="Sat Dec 20 2025 08:22:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Fu%2Fnathan_reese" title="https://discuss.elastic.co/u/nathan_reese" target="_blank" ref="nofollow noopener noreferrer">Nathan_Reese</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856719b33e094553a77f3f6a06f3920a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=sIwkFyIrQn5FbGU4%2Ful7xVJkdLg%3D" alt="" loading="lazy"/></p>
<p>Kibana 地图 教程 “<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fmaps-getting-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/maps-getting-started.html" target="_blank" ref="nofollow noopener noreferrer">构建地图，用于按国家或地区对比指标</a>” 使用 Elasticsearch 的 DSL 查询 来创建地图。最近新增的 ES|QL 函数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Flookup-join" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/lookup-join" target="_blank" ref="nofollow noopener noreferrer">LOOKUP JOIN</a>（ 8.18 ）和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fspatial-functions%23esql-st_geotile" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/spatial-functions#esql-st_geotile" target="_blank" ref="nofollow noopener noreferrer">ST_GEOTILE</a>（ 9.2 ）使得可以使用 ES|QL 重新创建该教程中的地图。</p>
<p>下面是使用 ES|QL 重新创建该教程地图的步骤。随后，这些步骤还超出了原始教程的能力范围，并按国家人口对分级设色图层进行归一化处理。</p>
<h2 data-id="heading-0">前提条件</h2>
<ul>
<li>如果你还没有 Kibana，请使用我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Felasticsearch-service%2Fsignup%3Fbaymax%3Ddocs-body%26elektra%3Ddocs" title="https://www.elastic.co/cloud/elasticsearch-service/signup?baymax=docs-body&amp;elektra=docs" target="_blank" ref="nofollow noopener noreferrer">免费试用</a> 进行设置。</li>
<li>本教程需要 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fguide%2Fen%2Fkibana%2F8.19%2Fget-started.html" title="https://www.elastic.co/guide/en/kibana/8.19/get-started.html" target="_blank" ref="nofollow noopener noreferrer">web logs 示例数据集</a>。</li>
<li>你必须具备创建地图和创建索引的正确权限。</li>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ee18d03841d4a7b96cdced29f035bb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6L9%2BwGiBlMHJT3I5WumIGOqBYNM%3D" alt="" loading="lazy"/></li>
</ul>
<h2 data-id="heading-1">步骤 1：创建 地图</h2>
<ul>
<li>前往 Dashboards。</li>
<li>点击 Create dashboard。</li>
<li>将时间范围设置为 Last 7 days。</li>
<li>点击 Add 按钮并选择 New panel，最后点击 Maps。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75fc5d68a38a40f792bc5d21960ce2fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mJiW3kgJ8oYBKljJb4IvqZq81ls%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/299c6ca01e7841c8b6e1531d07ad0624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=scm067o%2BWSNTSko5PB19C0sNp5Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdad565309644328b1aaf0a42913a686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=PtY7x5OTT9xrruWB1E2nPc8dI6I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bf44c4e950944ca850b10893148010d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=lw1aRSNzzIR4M%2FTiDrYGyyi4L3I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77d62ab1b5054e3c8e88a8af9ef37d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nkla1tjbPRClZk0W0d0D4OzLjvI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59530e10ed7425189a9495e511ae321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Ff2hpwV1S%2FqsEW9kp%2BWcWaYKlyA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">步骤 2. 添加一个 choropleth 图层</h2>
<p>你将添加的第一个图层是一个 choropleth 图层，用于按 web 日志流量为世界各国着色。较深的颜色表示 web 日志流量较多的国家，较浅的颜色表示流量较少的国家。</p>
<h3 data-id="heading-3">索引世界国家</h3>
<ul>
<li>下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fmaps.elastic.co%2F%23file%2Fworld_countries" title="https://maps.elastic.co/#file/world_countries" target="_blank" ref="nofollow noopener noreferrer">世界国家 GeoJSON</a> 文件</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfefe39ae1fd487aa0309dddf21cd827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=eACxlm%2BKon4ew2isg3ZK3iirlJw%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Kibana maps 中，点击 Add layer</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6248b5f4f086401e9d30e61074397de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=1PagyFqjZttoljj5MD9LPscOGsw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920a2f78b8384cf8b662807c1b109b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BbCKB6%2FzjuUt5rIvcVSHa4%2BnWGc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2521840315d547edb220d8935431def9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Zl4BlgIF%2F0OOIPL0i6Ld6kN6U5M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3077a8304ea04d90a34dcae0b504e448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=mp%2BmwWXkFNUkH%2FNE%2FiBrxviIURM%3D" alt="" loading="lazy"/></p>
<ul>
<li>选择 Upload file</li>
<li>在文件选择器中选择世界国家 GeoJSON 文件</li>
<li>将 Index name 设置为 world_countries</li>
<li>打开 Advanced 部分</li>
<li>将 Index settings 设置为 { "index.mode": "lookup" }。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af35066cef874968a8f2ad7341c735bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=HzesTFW6kVSrmxME6gU7qTWCows%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">添加 choropleth 图层</h3>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edb88e6558f4c88852224e928da565f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6a5vS%2Bc2eTHqlcillFK5yzGRL7A%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2412b1d2aa71444a9fe534fd845acb2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=3ZPwYpEy%2BYvjLfGovf6N8EaRIv0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf38ada7d0845a5ba800dbe73770a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=OC6es0DwoXsYv4FNwA1XpZUzQqY%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Add and continue</li>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Total Requests by Destination。</li>
<li>将 Opacity 设置为 50%。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe3b047e63e48edb6d1ea0fe2ad2d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=v9G2LV%2FfNUpVGK7PEYlowcM4eBY%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中
<ul>
<li>将 Fill color 设置为 By value by count。选择 “grey to black” 颜色渐变。</li>
<li>将 Border color 设置为 “white”。4.</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc5319e4c22433494754567f7f74405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=YUzd07oNYRMnCTSqkJaV%2F%2FSTvv4%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fce6da60d5fe4a64802c857e2a2d6112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=12N4r%2FY7slCp05qi3N%2FK5r1b9Pg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">步骤 3. 为 Elasticsearch 数据添加图层</h2>
<p>为了避免一次向用户展示过多数据，你将为 Elasticsearch 数据添加两个图层。第一个图层在用户放大地图时显示单个文档。第二个图层在用户缩小地图时显示聚合数据。</p>
<h3 data-id="heading-6">为单个文档添加图层</h3>
<p>此图层将 web 日志文档显示为点。<br/>
该图层仅在用户放大时可见。</p>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7195fa36fd744d3f9855a4cfabb3d640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=gCo1jOY35J0wBj%2F0qorOOgWXYEg%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> KEEP geo.coordinates, agent, bytes, clientip, 
<span class="hljs-number">3.</span>         host, machine.os, request, response, <span class="hljs-type">timestamp</span> 
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10000</span>

`AI写代码
</code></pre>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
<li>点击 Add and continue</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/730d8242b0514cb289a6009e5edb2f45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=IAa4srQhlXSDFk3eyMxnM4nDgSg%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Actual Requests。</li>
<li>将 Visibility 设置为范围 [9, 24]。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28785535c8a4fe0b901ed166e835728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=xnY1P%2BvT0tWOUUKOA3qxCy1F7KQ%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中，设置：
<ul>
<li>将 Fill color 设置为 #2200FF。</li>
<li>将 Border width 设置为 0。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07660b51c74440f857eebcc605b9587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=h578EnyVh%2FZ%2BDvoqvQreP4Q%2BsZc%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff4d39c9221d44e1937a90308283b291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=Dndj%2B%2F0T6IvXTXHZviJj8%2B2liSE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">为聚合数据添加图层</h3>
<p>你将创建一个聚合数据图层，并仅在地图缩小时显示。较深的颜色表示 web 日志流量更多的网格，较浅的颜色表示流量较少的网格。较大的圆表示传输总字节更多的网格，较小的圆表示字节较少的网格。</p>
<ul>
<li>点击 Add layer</li>
<li>选择 ES|QL</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26353c3fa7834282888e2f26d36aec0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=hQR3rEIMLEI%2B%2Fc8HzcqE6AB1CcI%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 ES|QL statement 设置为</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`

1.  FROM kibana_sample_data_logs  
2.  | EVAL <span class="hljs-attr">geotile</span> = ST_GEOTILE(geo.coordinates, <span class="hljs-number">6</span>) 
3.  | STATS <span class="hljs-attr">count</span> = COUNT(geotile), 
<span class="hljs-attr">4.          sumOfBytes</span> = SUM(bytes), 
<span class="hljs-attr">5.          centroid</span> = ST_CENTROID_AGG(geo.coordinates) BY geotile

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cbfb4a468c4d9abb7b2c0a87b50320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=tdOEyoqo1YDlLEb0j2xE4do33WE%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
<li>点击 Add 并继续</li>
<li>在 Layer settings 中，设置：
<ul>
<li>将 Name 设置为 Total Requests and Bytes。</li>
<li>将 Visibility 设置为范围 [0, 9]。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8adbe05ff81480795b4230f56b6ccb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=WzfyNO%2FWRy9KFKGGdTFvd1fJPrM%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中，设置：
<ul>
<li>将 Fill color 设置为 By value by count</li>
<li>将 Border width 设置为 0。</li>
<li>将 Symbol size 设置为 By value by sumOfBytes。将最小尺寸设置为 7，最大尺寸设置为 25。</li>
<li>将 Label 设置为 By value by count</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d9989a1d94426993b7a16386386185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=nHcJDNQlFi7P%2F37bsJfSi7MIkSM%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。你的地图现在应该看起来像</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c273d329e9454d77883ac49f767a6d30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=MRF3qen00nX22RKWkyljk9T4jDs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">步骤 4. 按国家人口标准化 choropleth 图层</h2>
<p>第 2 步创建的 choropleth 图层按 web 日志流量为世界各国着色。由于各国人口不同，直接比较各国的计数并不公平。人口较多的国家可能有更多的 web 流量，而人口较少的国家流量较少。相反，你希望按人口调整后的 web 日志流量为世界各国着色。</p>
<p>ES|QL 可以通过考虑每个国家的总人口来对 web 日志计数进行标准化。我们将可视化每 100,000 人的 web 日志计数，而不是原始计数。现在，我们可以比较各国的标准化计数。</p>
<h3 data-id="heading-9">索引世界国家人口</h3>
<ul>
<li>下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnreese%2Fnotes%2Fraw%2Frefs%2Fheads%2Fmaster%2Fpopulations_2024.csv" title="https://github.com/nreese/notes/raw/refs/heads/master/populations_2024.csv" target="_blank" ref="nofollow noopener noreferrer">populations_2024.csv</a>文件。该文件来源于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdata.worldbank.org%2Findicator%2FSP.POP.TOTL" title="https://data.worldbank.org/indicator/SP.POP.TOTL" target="_blank" ref="nofollow noopener noreferrer">World Bank Group</a>。 下载完毕后，我们必须重新命名文件后缀为 .csv 而不是 .txt。</li>
<li>在 Kibana 中，通过全局搜索字段进入 File upload。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9427dce25b2d40b19f23333325109477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=%2BP%2BpcFz4ng8SyOshN81%2FchfaYb8%3D" alt="" loading="lazy"/></p>
<ul>
<li>在文件选择器中选择 populations_2024.csv</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbbce9d5ad5b44ac99a3384511c1f9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=6sZSjkloapPqJNPnUNct35TZXns%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d887ff51a0748e0918add6e011f0ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=9D%2BXR09h0e10Ujy40zE2pZ1lNDs%3D" alt="" loading="lazy"/></p>
<ul>
<li>将 New index name 设置为 populations</li>
<li>点击 Import</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d0645d5615f44ae8348b930b15be4d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=set59wxYd4DcSCXa8dEOARYIEw8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">向 world_countries 索引添加人口字段</h3>
<p>使用 enrich processor 将人口数据添加到世界国家集合中。</p>
<ul>
<li>通过导航菜单或全局搜索字段进入 Developer tools。</li>
<li>创建一个 match enrichment policy</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT /_enrich/policy/population_lookup
2.  {
3.    <span class="hljs-string">"match"</span>: {
4.      <span class="hljs-string">"indices"</span>: <span class="hljs-string">"populations"</span>,
5.      <span class="hljs-string">"match_field"</span>: <span class="hljs-string">"iso3"</span>,
6.      <span class="hljs-string">"enrich_fields"</span>: [ <span class="hljs-string">"population_2024"</span>]
7.    }
8.  }

`AI写代码
</code></pre>
<ul>
<li>要初始化该策略，运行：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`POST /_enrich/policy/population_lookup/_execute`AI写代码
</code></pre>
<ul>
<li>要创建一个 ingest pipeline，运行：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">`

1.  PUT _ingest/pipeline/add_population_to_world_countries
2.  {
3.    <span class="hljs-string">"processors"</span>: [
4.      {
5.        <span class="hljs-string">"enrich"</span>: {
6.          <span class="hljs-string">"field"</span>: <span class="hljs-string">"iso3"</span>,
7.          <span class="hljs-string">"policy_name"</span>: <span class="hljs-string">"population_lookup"</span>,
8.          <span class="hljs-string">"target_field"</span>: <span class="hljs-string">"population"</span>,
9.          <span class="hljs-string">"ignore_missing"</span>: <span class="hljs-literal">true</span>,
10.          <span class="hljs-string">"ignore_failure"</span>: <span class="hljs-literal">true</span>
11.        }
12.      }
13.    ]
14.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<ul>
<li>要向 world_countries 添加人口数据，运行：</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">`POST world_countries/_update_by_query?<span class="hljs-attr">pipeline</span>=add_population_to_world_countries`AI写代码
</code></pre>
<ul>
<li>在 Discover 中查看 world_countries 索引。每一行现在都包含 population.population_2024 列。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a16b1b69204dffb9ac4dcb4a15e6d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=93zdsqE99lKpjSnBXp4yIFDaQEg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">在 ES|QL statement 中按人口标准化计数</h3>
<ul>
<li>点击 Total Requests by Destination 图层的 edit 按钮。</li>
<li>将 ES|QL statement 替换为</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  <span class="hljs-keyword">FROM</span> kibana_sample_data_logs 
<span class="hljs-number">2</span>.  | STATS count = COUNT() <span class="hljs-keyword">BY</span> geo.dest 
<span class="hljs-number">3</span>.  | RENAME geo.dest <span class="hljs-keyword">AS</span> iso2.keyword 
<span class="hljs-number">4</span>.  | LOOKUP <span class="hljs-keyword">JOIN</span> world_countries <span class="hljs-keyword">ON</span> iso2.keyword 
<span class="hljs-number">5</span>.  | RENAME iso2.keyword <span class="hljs-keyword">AS</span> geo.dest 
<span class="hljs-number">6</span>.  | KEEP count, geometry, geo.dest, population.population_2024 
<span class="hljs-number">7</span>.  | EVAL normalized_count = TO_DOUBLE(count) / population.population_2024 * <span class="hljs-number">100000</span>

`AI写代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e63741079f2141bd9030ad4edfa290ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=DBwGweAj8s76pmqMlOXkGeEk2k0%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 ES|QL 编辑器中点击 Run query</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e69d74f8de451280b14ae6d8c7ddce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=XzvV31MVsr8bO%2FhyYtP9RaNfOd4%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Layer style 中将 Fill color 设置为 By value by normalized_count。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b8e174129f42f3a2aa1ac6a42dec6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=KQKsChdXQl1oDPyjGegXlVlsE60%3D" alt="" loading="lazy"/></p>
<ul>
<li>点击 Keep changes。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad2ef7cbb0945448f6f5439bb833c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823724&amp;x-signature=vIleNIwrAzdRPRsF88yAeHBtg2A%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>：你可能已经猜到，为什么不使用 lookup 设置导入 populations CSV 来对地图查询执行第二次 LOOKUP JOIN。那是可行的！但要注意，每增加一次 join 都会有性能开销。</p>
</blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscuss.elastic.co%2Ft%2Fdec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql%2F383243" title="https://discuss.elastic.co/t/dec-14th-2025-en-build-a-map-to-compare-metrics-by-country-or-region-with-es-ql/383243" target="_blank" ref="nofollow noopener noreferrer">discuss.elastic.co/t/dec-14th-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脚手架开发工具——root-check]]></title>    <link>https://juejin.cn/post/7585474459776237604</link>    <guid>https://juejin.cn/post/7585474459776237604</guid>    <pubDate>2025-12-20T08:02:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776237604" data-draft-id="7585463195201306674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脚手架开发工具——root-check"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:02:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="code_YuJun"/> <meta itemprop="url" content="https://juejin.cn/user/3615612462441358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脚手架开发工具——root-check
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3615612462441358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    code_YuJun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:02:32.000Z" title="Sat Dec 20 2025 08:02:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><code>root-check</code> 是一个 <strong>Node.js 工具包</strong>，核心作用是<strong>检测当前 Node.js 进程是否以 <code>root</code>（超级管理员）权限运行</strong>，并在检测到 <code>root</code> 权限时，自动降级为指定的普通用户权限运行，以此提升应用的安全性。</p>
<h3 data-id="heading-1">检测 root 权限</h3>
<p>它会判断当前进程的 <code>uid</code>（用户 ID）是否为 <code>0</code>（Unix/Linux 系统中 <code>root</code> 用户的 <code>uid</code> 固定为 <code>0</code>），以此识别是否为 <code>root</code> 权限运行。</p>
<h3 data-id="heading-2">自动降级权限</h3>
<p>如果检测到当前是 <code>root</code> 权限，它会尝试切换到一个<strong>非 root 普通用户</strong>的权限来运行后续代码。</p>
<ul>
<li>默认会尝试切换到 <code>nobody</code> 用户（Unix/Linux 系统中内置的无特权用户）。</li>
<li>也可以手动指定要切换的用户（通过用户名或 <code>uid</code>）。</li>
</ul>
<h3 data-id="heading-3">解决的核心问题</h3>
<p>在 Unix/Linux 系统中，以 <code>root</code> 权限运行 Node.js 应用存在<strong>极高的安全风险</strong>：一旦应用存在漏洞被攻击，攻击者将直接获得系统的最高权限，可能导致服务器被完全控制。<code>root-check</code> 的存在就是为了<strong>避免这种风险</strong>，强制应用以低权限运行，即使被攻击，影响范围也会被大幅限制。</p>
<h3 data-id="heading-4">适用场景</h3>
<ul>
<li>命令行工具（CLI）开发：很多 Node.js 命令行工具（如前端的构建工具、脚手架）会用到这个包，防止用户以 <code>root</code> 权限执行命令带来风险。</li>
<li>服务端应用：Node.js 编写的后端服务，部署时需要避免 root 权限运行，可通过此包自动降级。</li>
</ul>
<h3 data-id="heading-5">基本使用示例</h3>
<pre><code class="hljs language-js" lang="js">npm install root-check --save
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> rootCheck = <span class="hljs-built_in">require</span>(<span class="hljs-string">'root-check'</span>).<span class="hljs-property">default</span>;
<span class="hljs-comment">// 自动降级为 nobody 用户（如果当前是 root 权限）</span>
<span class="hljs-title function_">rootCheck</span>();
<span class="hljs-comment">// 或者手动指定要切换的用户</span>
<span class="hljs-comment">// rootCheck('www-data'); // 切换到 www-data 用户</span>
</code></pre>
<h3 data-id="heading-6">注意事项</h3>
<ul>
<li><strong>仅支持 Unix/Linux 系统</strong>：Windows 系统没有 <code>root</code>/<code>uid</code> 的概念，该包在 Windows 上会直接失效（无副作用）。</li>
<li><strong>降级失败会抛出错误</strong>：如果当前是 root 权限，但无法切换到目标用户（比如目标用户不存在），<code>rootCheck</code> 会抛出异常，需要手动捕获处理。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3条件渲染中v-if系列指令如何合理使用与规避错误？]]></title>    <link>https://juejin.cn/post/7585485284152295459</link>    <guid>https://juejin.cn/post/7585485284152295459</guid>    <pubDate>2025-12-20T08:13:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485284152295459" data-draft-id="7585452404113129487" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3条件渲染中v-if系列指令如何合理使用与规避错误？    "/> <meta itemprop="keywords" content="前端,Trae,AI编程"/> <meta itemprop="datePublished" content="2025-12-20T08:13:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kknone"/> <meta itemprop="url" content="https://juejin.cn/user/1366025597879930"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3条件渲染中v-if系列指令如何合理使用与规避错误？    
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1366025597879930/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kknone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:13:19.000Z" title="Sat Dec 20 2025 08:13:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、Vue3条件渲染的核心概念</h3>
<p>在Vue3中，<strong>条件渲染</strong>是指根据<strong>响应式数据的真假</strong>，决定是否在页面上渲染某个元素或组件。而<code>v-if</code>、<code>v-else</code>、<code>v-else-if</code>
这组指令，就是实现条件渲染的“核心工具”——它们像一套“逻辑开关”，帮你精准控制DOM的显示与隐藏。</p>
<h3 data-id="heading-1">二、v-if系列指令的语法与用法</h3>
<p>我们先逐个拆解每个指令的作用，再通过<strong>实际案例</strong>串起来用。</p>
<h4 data-id="heading-2">2.1 v-if：基础条件判断</h4>
<p><code>v-if</code>是最基础的条件指令，它的语法很简单：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"条件表达式"</span>&gt;</span>要渲染的内容<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
</code></pre>
<ul>
<li><strong>条件表达式</strong>：可以是任何返回<code>true</code>或<code>false</code>的JavaScript表达式（比如<code>isLogin</code>、<code>score &gt;= 90</code>）。</li>
<li><strong>惰性渲染</strong>：<code>v-if</code>是“懒”的——如果初始条件不满足（比如<code>isLogin = false</code>），元素<strong>不会被渲染到DOM中</strong>（连DOM节点都不会生成）；只有当条件变为
<code>true</code>时，才会“从零开始”创建元素及其子组件。</li>
</ul>
<p>举个例子：判断用户是否登录，显示不同的内容：</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const isLogin = ref(false) // 初始未登录
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 登录后显示 --&gt;
    &lt;p v-if="isLogin"&gt;欢迎回来，用户！&lt;/p&gt;
    &lt;!-- 未登录显示 --&gt;
    &lt;button v-if="!isLogin" @click="isLogin = true"&gt;点击登录&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>当点击按钮时，<code>isLogin</code>变为<code>true</code>，未登录的按钮会被销毁，同时渲染“欢迎”文本——这就是<code>v-if</code>的“销毁/重建”逻辑。</p>
<details>
<summary>往期文章归档</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F218c3a59282c3b757447ee08a01937bb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/218c3a59282c3b757447ee08a01937bb/" ref="nofollow noopener noreferrer">Vue3动态样式控制：ref、reactive、watch与computed的应用场景与区别是什么？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1bab953e41f66ac53de099fa9fe76483%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1bab953e41f66ac53de099fa9fe76483/" ref="nofollow noopener noreferrer">Vue3中动态样式数组的后项覆盖规则如何与计算属性结合实现复杂状态样式管理？</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc85e1fe16a7ae45e965b4e2df4d9d2f4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c85e1fe16a7ae45e965b4e2df4d9d2f4/" ref="nofollow noopener noreferrer">Vue浅响应式如何解决深层响应式的性能问题？适用场景有哪些？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbe04b02d2723994632de0d4ca22a3391%2F" target="_blank" title="https://blog.cmdragon.cn/posts/be04b02d2723994632de0d4ca22a3391/" ref="nofollow noopener noreferrer">Vue 3组合式API中ref与reactive的核心响应式差异及使用最佳实践是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa0af08dd60a37b9a890a9957f2cbfc9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a0af08dd60a37b9a890a9957f2cbfc9f/" ref="nofollow noopener noreferrer">Vue3响应式系统中，对象新增属性、数组改索引、原始值代理的问题如何解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbc287e1e36287afd90750fd907eca85e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bc287e1e36287afd90750fd907eca85e/" ref="nofollow noopener noreferrer">Vue 3中watch侦听器的正确使用姿势你掌握了吗？深度监听、与watchEffect的差异及常见报错解析 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F654b9447ef1ba7ec1126a1bc26a4726d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/654b9447ef1ba7ec1126a1bc26a4726d/" ref="nofollow noopener noreferrer">Vue响应式声明的API差异、底层原理与常见陷阱你都搞懂了吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc405a8d9950af5b7c63b56c348ac36b6%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c405a8d9950af5b7c63b56c348ac36b6/" ref="nofollow noopener noreferrer">为什么Vue 3需要ref函数？它的响应式原理与正确用法是什么？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa7e9abb9691a81e4404d9facabe0f7c3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a7e9abb9691a81e4404d9facabe0f7c3/" ref="nofollow noopener noreferrer">Vue 3中reactive函数如何通过Proxy实现响应式？使用时要避开哪些误区？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbd995ea45161727597fb85b62566c43d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bd995ea45161727597fb85b62566c43d/" ref="nofollow noopener noreferrer">Vue3响应式系统的底层原理与实践要点你真的懂吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F53e3f270a80675df662c6857a3332c0f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/53e3f270a80675df662c6857a3332c0f/" ref="nofollow noopener noreferrer">Vue 3模板如何通过编译三阶段实现从声明式语法到高效渲染的跨越 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fddbce4f2a23aa72c96b1c0473900321e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ddbce4f2a23aa72c96b1c0473900321e/" ref="nofollow noopener noreferrer">快速入门Vue模板引用：从收DOM“快递”到调子组件方法，你玩明白了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F23a2d5a334e15575277814c16e45df50%2F" target="_blank" title="https://blog.cmdragon.cn/posts/23a2d5a334e15575277814c16e45df50/" ref="nofollow noopener noreferrer">快速入门Vue模板里的JS表达式有啥不能碰？计算属性为啥比方法更能打？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6be38de6382e31d282659b689c5b17f0%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6be38de6382e31d282659b689c5b17f0/" ref="nofollow noopener noreferrer">快速入门Vue的v-model表单绑定：语法糖、动态值、修饰符的小技巧你都掌握了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F60ce517684f4a418f453d66aa805606c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/60ce517684f4a418f453d66aa805606c/" ref="nofollow noopener noreferrer">快速入门Vue3事件处理的挑战题：v-on、修饰符、自定义事件你能通关吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe4ae7d5e4a9205bb11b2baccb230c637%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e4ae7d5e4a9205bb11b2baccb230c637/" ref="nofollow noopener noreferrer">快速入门Vue3的v-指令：数据和DOM的“翻译官”到底有多少本事？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F999ce4fb32259ff4fbf4bf7bcb851654%2F" target="_blank" title="https://blog.cmdragon.cn/posts/999ce4fb32259ff4fbf4bf7bcb851654/" ref="nofollow noopener noreferrer">快速入门Vue3，插值、动态绑定和避坑技巧你都搞懂了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fa6997d81b49cd232b87e1cf603888ad1%2F" target="_blank" title="https://blog.cmdragon.cn/posts/a6997d81b49cd232b87e1cf603888ad1/" ref="nofollow noopener noreferrer">想让PostgreSQL快到飞起？先找健康密码还是先换引擎？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F1fee7afbb9abd4540b8aa9c141d6845d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/1fee7afbb9abd4540b8aa9c141d6845d/" ref="nofollow noopener noreferrer">想让PostgreSQL查询快到飞起？分区表、物化视图、并行查询这三招灵不灵？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F79c590fbd87ece535b11a71c9667884f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/79c590fbd87ece535b11a71c9667884f/" ref="nofollow noopener noreferrer">子查询总拖慢查询？把它变成连接就能解决？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F748cdac2536008199abf8a8a2cd0ec85%2F" target="_blank" title="https://blog.cmdragon.cn/posts/748cdac2536008199abf8a8a2cd0ec85/" ref="nofollow noopener noreferrer">PostgreSQL全表扫描慢到崩溃？建索引+改查询+更统计信息三招能破？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F32ca943703226d317d4276a8fb53b0dd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/32ca943703226d317d4276a8fb53b0dd/" ref="nofollow noopener noreferrer">复杂查询总拖后腿？PostgreSQL多列索引+覆盖索引的神仙技巧你get没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fca93f1d53aa910e7ba5ffd8df611c12b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ca93f1d53aa910e7ba5ffd8df611c12b/" ref="nofollow noopener noreferrer">只给表子集建索引？用函数结果建索引？PostgreSQL这俩操作凭啥能省空间又加速？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ff507856ebfddd592448813c510a53669%2F" target="_blank" title="https://blog.cmdragon.cn/posts/f507856ebfddd592448813c510a53669/" ref="nofollow noopener noreferrer">B-tree索引像字典查词一样工作？那哪些数据库查询它能加速，哪些不能？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb2213bfcb5b88a862f2138404c03d596%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b2213bfcb5b88a862f2138404c03d596/" ref="nofollow noopener noreferrer">想抓PostgreSQL里的慢SQL？pg_stat_statements基础黑匣子和pg_stat_monitor时间窗，谁能帮你更准揪出性能小偷？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F26614eb7da6c476dde41d367ad888d2f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/26614eb7da6c476dde41d367ad888d2f/" ref="nofollow noopener noreferrer">PostgreSQL的“时光机”MVCC和锁机制是怎么搞定高并发的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F69f99bc6972a860d559c74aad7280da4%2F" target="_blank" title="https://blog.cmdragon.cn/posts/69f99bc6972a860d559c74aad7280da4/" ref="nofollow noopener noreferrer">PostgreSQL性能暴涨的关键？内存IO并发参数居然要这么设置？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F7b7053f392147a8b3b1a16bebeb08d0a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/7b7053f392147a8b3b1a16bebeb08d0a/" ref="nofollow noopener noreferrer">大表查询慢到翻遍整个书架？PostgreSQL分区表教你怎么“分类”才高效</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc856e3cb073822349f3bf2d29995dcfc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c856e3cb073822349f3bf2d29995dcfc/" ref="nofollow noopener noreferrer">PostgreSQL 查询慢？是不是忘了优化 GROUP BY、ORDER BY 和窗口函数？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fc096347d18e67b7431faacd2c4757093%2F" target="_blank" title="https://blog.cmdragon.cn/posts/c096347d18e67b7431faacd2c4757093/" ref="nofollow noopener noreferrer">PostgreSQL里的子查询和CTE居然在性能上“掐架”？到底该站哪边？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F2eca89463454fd4250d7b66243b9fe5a%2F" target="_blank" title="https://blog.cmdragon.cn/posts/2eca89463454fd4250d7b66243b9fe5a/" ref="nofollow noopener noreferrer">PostgreSQL选Join策略有啥小九九？Nested Loop/Merge/Hash谁是它的菜？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F068ecb772a87d7df20a8c9fb4b233f8e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/068ecb772a87d7df20a8c9fb4b233f8e/" ref="nofollow noopener noreferrer">PostgreSQL新手SQL总翻车？这7个性能陷阱你踩过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd498f63cd0a2d5a77e445c688a8b88db%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d498f63cd0a2d5a77e445c688a8b88db/" ref="nofollow noopener noreferrer">PostgreSQL索引选B-Tree还是GiST？“瑞士军刀”和“多面手”的差别你居然还不知道？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F9101b75bdec6faea9b35d54f14e37f36%2F" target="_blank" title="https://blog.cmdragon.cn/posts/9101b75bdec6faea9b35d54f14e37f36/" ref="nofollow noopener noreferrer">想知道数据库怎么给查询“算成本选路线”？EXPLAIN能帮你看明白？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd527f8ebb6e3dae2c7dfe4c8d8979444%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d527f8ebb6e3dae2c7dfe4c8d8979444/" ref="nofollow noopener noreferrer">PostgreSQL处理SQL居然像做蛋糕？解析到执行的4步里藏着多少查询优化的小心机？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6bfdae84f313cf7ad0bb7045c4392347%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6bfdae84f313cf7ad0bb7045c4392347/" ref="nofollow noopener noreferrer">PostgreSQL备份不是复制文件？物理vs逻辑咋选？误删还能精准恢复到1分钟前？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fde3672803de34dbad244d0a8d48b0eb5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/de3672803de34dbad244d0a8d48b0eb5/" ref="nofollow noopener noreferrer">转账不翻车、并发不干扰，PostgreSQL的ACID特性到底有啥魔法？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fe463e8a2668abdf00a228c9b79324ded%2F" target="_blank" title="https://blog.cmdragon.cn/posts/e463e8a2668abdf00a228c9b79324ded/" ref="nofollow noopener noreferrer">银行转账不白扣钱、电商下单不超卖，PostgreSQL事务的诀窍是啥？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F5c967e595058c4a1fc4474a68e64031d%2F" target="_blank" title="https://blog.cmdragon.cn/posts/5c967e595058c4a1fc4474a68e64031d/" ref="nofollow noopener noreferrer">PostgreSQL里的PL/pgSQL到底是啥？能让SQL从“说目标”变“讲步骤”？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F325047855e3e23b5ef82f7d2db134fbd%2F" target="_blank" title="https://blog.cmdragon.cn/posts/325047855e3e23b5ef82f7d2db134fbd/" ref="nofollow noopener noreferrer">PostgreSQL视图不存数据？那它怎么简化查询还能递归生成序列和控制权限？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fd2dba50bb6e4df7b27e735245a06a2a2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/d2dba50bb6e4df7b27e735245a06a2a2/" ref="nofollow noopener noreferrer">PostgreSQL索引这么玩，才能让你的查询真的“飞”起来？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F849ae5bab0f8c66e94c2f6ad1bb798e3%2F" target="_blank" title="https://blog.cmdragon.cn/posts/849ae5bab0f8c66e94c2f6ad1bb798e3/" ref="nofollow noopener noreferrer">PostgreSQL的表关系和约束，咋帮你搞定用户订单不混乱、学生选课不重复？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fef4800975ffa84f1ca51976a70a1585b%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ef4800975ffa84f1ca51976a70a1585b/" ref="nofollow noopener noreferrer">PostgreSQL查询的筛子、排序、聚合、分组？你会用它们搞定数据吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fbf54711525c507c5eacfa7b0151c39d2%2F" target="_blank" title="https://blog.cmdragon.cn/posts/bf54711525c507c5eacfa7b0151c39d2/" ref="nofollow noopener noreferrer">PostgreSQL数据类型怎么选才高效不踩坑？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F887809b3e0375f5956873cd442f516d8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/887809b3e0375f5956873cd442f516d8/" ref="nofollow noopener noreferrer">想解锁PostgreSQL查询从基础到进阶的核心知识点？你都get了吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F934be1203725e8be9d6f6e9104e5abcc%2F" target="_blank" title="https://blog.cmdragon.cn/posts/934be1203725e8be9d6f6e9104e5abcc/" ref="nofollow noopener noreferrer">PostgreSQL DELETE居然有这些操作？返回数据、连表删你试过没？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0f0622e9b7402b599e618150d0596ffe%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0f0622e9b7402b599e618150d0596ffe/" ref="nofollow noopener noreferrer">PostgreSQL UPDATE语句怎么玩？从改邮箱到批量更新的避坑技巧你都会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F0e3bf7efc030b024ea67ee855a00f2de%2F" target="_blank" title="https://blog.cmdragon.cn/posts/0e3bf7efc030b024ea67ee855a00f2de/" ref="nofollow noopener noreferrer">PostgreSQL插入数据还在逐条敲？批量、冲突处理、返回自增ID的技巧你会吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb6cd3c86da6aac26ed829e472d34078e%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b6cd3c86da6aac26ed829e472d34078e/" ref="nofollow noopener noreferrer">PostgreSQL的“仓库-房间-货架”游戏，你能建出电商数据库和表吗？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fba1f545a3410144552fbdbfcf31b5265%2F" target="_blank" title="https://blog.cmdragon.cn/posts/ba1f545a3410144552fbdbfcf31b5265/" ref="nofollow noopener noreferrer">PostgreSQL 17安装总翻车？Windows/macOS/Linux避坑指南帮你搞定？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fb5474d1480509c5072085abc80b3dd9f%2F" target="_blank" title="https://blog.cmdragon.cn/posts/b5474d1480509c5072085abc80b3dd9f/" ref="nofollow noopener noreferrer">能当关系型数据库还能玩对象特性，能拆复杂查询还能自动管库存，PostgreSQL凭什么这么香？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Fcc098d8836e787baa8a4d92e4d56d5c5%2F" target="_blank" title="https://blog.cmdragon.cn/posts/cc098d8836e787baa8a4d92e4d56d5c5/" ref="nofollow noopener noreferrer">给接口加新字段又不搞崩老客户端？FastAPI的多版本API靠哪三招实现？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F46d05151c5bd31cf37a7bcf0b8f5b0b8%2F" target="_blank" title="https://blog.cmdragon.cn/posts/46d05151c5bd31cf37a7bcf0b8f5b0b8/" ref="nofollow noopener noreferrer">流量突增要搞崩FastAPI？熔断测试是怎么防系统雪崩的？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F65ce343cc5df9faf3a8e2eeaab42ae45%2F" target="_blank" title="https://blog.cmdragon.cn/posts/65ce343cc5df9faf3a8e2eeaab42ae45/" ref="nofollow noopener noreferrer">FastAPI秒杀库存总变负数？Redis分布式锁能帮你守住底线吗 - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Feed6cd8985d9be0a4b092a7da38b3e0c%2F" target="_blank" title="https://blog.cmdragon.cn/posts/eed6cd8985d9be0a4b092a7da38b3e0c/" ref="nofollow noopener noreferrer">FastAPI的CI流水线怎么自动测端点，还能让Allure报告美到犯规？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2F6157d87338ce894d18c013c3c4777abb%2F" target="_blank" title="https://blog.cmdragon.cn/posts/6157d87338ce894d18c013c3c4777abb/" ref="nofollow noopener noreferrer">如何用GitHub Actions为FastAPI项目打造自动化测试流水线？ - cmdragon's Blog</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmdragon.cn%2Fposts%2Ffc4ef84559e04693a620d0714cb30787%2F" target="_blank" title="https://blog.cmdragon.cn/posts/fc4ef84559e04693a620d0714cb30787/" ref="nofollow noopener noreferrer">如何用Git Hook和CI流水线为FastAPI项目保驾护航？ - cmdragon's Blog</a></li>
</ul>
</details>
<details>
<summary>免费好用的热门在线工具</summary>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fraid-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/raid-calculator" ref="nofollow noopener noreferrer">RAID 计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fphotoshop-online" target="_blank" title="https://tools.cmdragon.cn/zh/apps/photoshop-online" ref="nofollow noopener noreferrer">在线PS - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmermaid-live-editor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/mermaid-live-editor" ref="nofollow noopener noreferrer">Mermaid 在线编辑器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmath-solver-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/math-solver-calculator" ref="nofollow noopener noreferrer">数学求解计算器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsmart-teleprompter" target="_blank" title="https://tools.cmdragon.cn/zh/apps/smart-teleprompter" ref="nofollow noopener noreferrer">智能提词器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fmagic-resume" target="_blank" title="https://tools.cmdragon.cn/zh/apps/magic-resume" ref="nofollow noopener noreferrer">魔法简历 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-puzzle-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-puzzle-tool" ref="nofollow noopener noreferrer">Image Puzzle Tool - 图片拼图工具 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsubtitle-downloader" target="_blank" title="https://tools.cmdragon.cn/zh/apps/subtitle-downloader" ref="nofollow noopener noreferrer">字幕下载工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flyrics-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lyrics-generator" ref="nofollow noopener noreferrer">歌词生成工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcloud-drive-search" target="_blank" title="https://tools.cmdragon.cn/zh/apps/cloud-drive-search" ref="nofollow noopener noreferrer">网盘资源聚合搜索 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fascii-art-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ascii-art-generator" ref="nofollow noopener noreferrer">ASCII字符画生成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fjwt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/jwt-tool" ref="nofollow noopener noreferrer">JSON Web Tokens 工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbcrypt-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/bcrypt-tool" ref="nofollow noopener noreferrer">Bcrypt 密码工具 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-composer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-composer" ref="nofollow noopener noreferrer">GIF 合成器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fgif-decomposer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/gif-decomposer" ref="nofollow noopener noreferrer">GIF 分解器 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-steganography" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-steganography" ref="nofollow noopener noreferrer">文本隐写术 - 应用商店 | By cmdragon</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh" target="_blank" title="https://tools.cmdragon.cn/zh" ref="nofollow noopener noreferrer">CMDragon 在线工具 - 高级AI工具箱与开发者套件 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%3Fcategory%3Dtrending" target="_blank" title="https://tools.cmdragon.cn/zh/apps?category=trending" ref="nofollow noopener noreferrer">应用商店 - 发现1000+提升效率与开发的AI工具和实用程序 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fchangelog" target="_blank" title="https://tools.cmdragon.cn/zh/changelog" ref="nofollow noopener noreferrer">CMDragon 更新日志 - 最新更新、功能与改进 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fsponsor" target="_blank" title="https://tools.cmdragon.cn/zh/sponsor" ref="nofollow noopener noreferrer">支持我们 - 成为赞助者 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-image-ai" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-image-ai" ref="nofollow noopener noreferrer">AI文本生成图像 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftemp-email" target="_blank" title="https://tools.cmdragon.cn/zh/apps/temp-email" ref="nofollow noopener noreferrer">临时邮箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fqrcode-parser" target="_blank" title="https://tools.cmdragon.cn/zh/apps/qrcode-parser" ref="nofollow noopener noreferrer">二维码解析器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-to-mindmap" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-to-mindmap" ref="nofollow noopener noreferrer">文本转思维导图 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fregex-visualizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/regex-visualizer" ref="nofollow noopener noreferrer">正则表达式可视化工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsteganography-tool" target="_blank" title="https://tools.cmdragon.cn/zh/apps/steganography-tool" ref="nofollow noopener noreferrer">文件隐写工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fiptv-explorer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/iptv-explorer" ref="nofollow noopener noreferrer">IPTV 频道探索器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsnapdrop" target="_blank" title="https://tools.cmdragon.cn/zh/apps/snapdrop" ref="nofollow noopener noreferrer">快传 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Flucky-draw" target="_blank" title="https://tools.cmdragon.cn/zh/apps/lucky-draw" ref="nofollow noopener noreferrer">随机抽奖工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fanime-scene-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/anime-scene-finder" ref="nofollow noopener noreferrer">动漫场景查找器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftime-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/time-toolkit" ref="nofollow noopener noreferrer">时间工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fspeed-test" target="_blank" title="https://tools.cmdragon.cn/zh/apps/speed-test" ref="nofollow noopener noreferrer">网速测试 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-remover" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-remover" ref="nofollow noopener noreferrer">AI 智能抠图工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fbackground-replacer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/background-replacer" ref="nofollow noopener noreferrer">背景替换工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fartistic-qrcode" target="_blank" title="https://tools.cmdragon.cn/zh/apps/artistic-qrcode" ref="nofollow noopener noreferrer">艺术二维码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fopen-graph-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/open-graph-generator" ref="nofollow noopener noreferrer">Open Graph 元标签生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-comparison" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-comparison" ref="nofollow noopener noreferrer">图像对比工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-compressor" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-compressor" ref="nofollow noopener noreferrer">图片压缩专业版 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fpassword-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/password-generator" ref="nofollow noopener noreferrer">密码生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fsvg-optimizer" target="_blank" title="https://tools.cmdragon.cn/zh/apps/svg-optimizer" ref="nofollow noopener noreferrer">SVG优化器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcolor-palette" target="_blank" title="https://tools.cmdragon.cn/zh/apps/color-palette" ref="nofollow noopener noreferrer">调色板生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fonline-metronome" target="_blank" title="https://tools.cmdragon.cn/zh/apps/online-metronome" ref="nofollow noopener noreferrer">在线节拍器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcss-grid-layout" target="_blank" title="https://tools.cmdragon.cn/zh/apps/css-grid-layout" ref="nofollow noopener noreferrer">CSS网格布局生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Femail-validator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/email-validator" ref="nofollow noopener noreferrer">邮箱验证工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fcalligraphy-practice" target="_blank" title="https://tools.cmdragon.cn/zh/apps/calligraphy-practice" ref="nofollow noopener noreferrer">书法练习字帖 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffinance-calculator-suite" target="_blank" title="https://tools.cmdragon.cn/zh/apps/finance-calculator-suite" ref="nofollow noopener noreferrer">金融计算器套件 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fchinese-kinship-calculator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/chinese-kinship-calculator" ref="nofollow noopener noreferrer">中国亲戚关系计算器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fprotobuf-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/protobuf-toolkit" ref="nofollow noopener noreferrer">Protocol Buffer 工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-geolocation" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-geolocation" ref="nofollow noopener noreferrer">IP归属地查询 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fimage-upscaler" target="_blank" title="https://tools.cmdragon.cn/zh/apps/image-upscaler" ref="nofollow noopener noreferrer">图片无损放大 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ftext-compare" target="_blank" title="https://tools.cmdragon.cn/zh/apps/text-compare" ref="nofollow noopener noreferrer">文本比较工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fip-batch-lookup" target="_blank" title="https://tools.cmdragon.cn/zh/apps/ip-batch-lookup" ref="nofollow noopener noreferrer">IP批量查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdomain-finder" target="_blank" title="https://tools.cmdragon.cn/zh/apps/domain-finder" ref="nofollow noopener noreferrer">域名查询工具 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Fdns-toolkit" target="_blank" title="https://tools.cmdragon.cn/zh/apps/dns-toolkit" ref="nofollow noopener noreferrer">DNS工具箱 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fzh%2Fapps%2Ffavicon-generator" target="_blank" title="https://tools.cmdragon.cn/zh/apps/favicon-generator" ref="nofollow noopener noreferrer">网站图标生成器 - 应用商店 | 免费好用的在线工具</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.cmdragon.cn%2Fsitemap_index.xml" target="_blank" title="https://tools.cmdragon.cn/sitemap_index.xml" ref="nofollow noopener noreferrer">XML Sitemap</a></li>
</ul>
</details>
<h4 data-id="heading-3">2.2 v-else：补充默认分支</h4>
<p>如果<code>v-if</code>的条件不满足，你可以用<code>v-else</code>添加一个“默认选项”。但要注意：<br/>
<strong><code>v-else</code>必须紧跟在<code>v-if</code>或<code>v-else-if</code>的后面，中间不能有其他兄弟元素</strong>（否则Vue无法识别它属于哪个条件）。</p>
<p>修改上面的例子，用<code>v-else</code>简化未登录的情况：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLogin"</span>&gt;</span>欢迎回来，用户！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 直接跟在v-if后面，无需写条件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-else</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"isLogin = true"</span>&gt;</span>点击登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2.3 v-else-if：多分支条件判断</h4>
<p>当需要判断<strong>多个条件</strong>时，用<code>v-else-if</code>连接。它的语法是：</p>
<pre><code class="hljs language-html" lang="html">
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"条件1"</span>&gt;</span>内容1<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"条件2"</span>&gt;</span>内容2<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"条件3"</span>&gt;</span>内容3<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">元素</span> <span class="hljs-attr">v-else</span>&gt;</span>默认内容<span class="hljs-tag">&lt;/<span class="hljs-name">元素</span>&gt;</span>
</code></pre>
<p><strong>关键规则</strong>：Vue会按<strong>指令的顺序依次判断</strong>，满足第一个条件就停止（所以条件的顺序很重要！）。</p>
<p>比如根据分数显示等级（最常见的多分支场景）：</p>
<pre><code class="hljs language-vue" lang="vue">
&lt;script setup&gt;
  import {ref} from 'vue'

  const score = ref(85) // 响应式分数，初始85分
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="score-level"&gt;
    &lt;h3&gt;你的分数：{{ score }}&lt;/h3&gt;
    &lt;!-- 顺序：从高到低 --&gt;
    &lt;p v-if="score &gt;= 90" class="excellent"&gt;等级：优秀（≥90）&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 80" class="good"&gt;等级：良好（80-89）&lt;/p&gt;
    &lt;p v-else-if="score &gt;= 60" class="pass"&gt;等级：及格（60-79）&lt;/p&gt;
    &lt;p v-else class="fail"&gt;等级：不及格（&lt;60）&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
  .excellent {
    color: #4CAF50;
  }

  .good {
    color: #2196F3;
  }

  .pass {
    color: #FFC107;
  }

  .fail {
    color: #F44336;
  }
&lt;/style&gt;
</code></pre>
<p>运行这个组件，修改<code>score</code>的值（比如改成<code>95</code>或<code>50</code>），会看到等级自动切换——这就是多分支条件渲染的实际效果。</p>
<h3 data-id="heading-5">三、条件渲染的流程逻辑（附流程图）</h3>
<p>为了更直观理解<code>v-if</code>系列的执行顺序，我们画一个<strong>判断流程图</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始] --&gt; B{检查v-if条件}
    B --&gt;|满足| C[渲染v-if内容，结束]
    B --&gt;|不满足| D{检查下一个v-else-if条件}
    D --&gt;|满足| E[渲染对应内容，结束]
    D --&gt;|不满足| F{还有v-else-if吗?}
    F --&gt;|是| D
    F --&gt;|否| G[渲染v-else内容，结束]
</code></pre>
<p>简单来说：<strong>按顺序“闯关”，满足条件就“通关”，否则继续，直到最后一个v-else</strong>。</p>
<h3 data-id="heading-6">四、课后Quiz：巩固你的理解</h3>
<h4 data-id="heading-7">Quiz 1：v-if和v-show有什么区别？</h4>
<p><strong>问题</strong>：同样是“隐藏元素”，<code>v-if</code>和<code>v-show</code>的核心差异是什么？分别适合什么场景？</p>
<p><strong>答案解析</strong>（参考Vue官网）：</p>
<ul>
<li><code>v-if</code>：<strong>销毁/重建DOM</strong>——条件不满足时，元素从DOM中消失；条件满足时，重新创建。适合<strong>条件很少变化</strong>的场景（比如权限判断），因为初始渲染更省性能。</li>
<li><code>v-show</code>：<strong>修改CSS显示</strong>——无论条件如何，元素都会渲染到DOM，只是用<code>display: none</code>隐藏。适合<strong>条件频繁切换</strong>的场景（比如
tabs 切换），因为切换时无需销毁重建，更高效。</li>
</ul>
<h4 data-id="heading-8">Quiz 2：为什么v-else必须紧跟v-if？</h4>
<p><strong>问题</strong>：如果写<code>v-if</code>之后隔了一个<code>div</code>再写<code>v-else</code>，会报错吗？为什么？</p>
<p><strong>答案解析</strong>：<br/>
会报错！错误信息是“v-else has no adjacent v-if”。<br/>
原因：Vue需要明确<code>v-else</code>对应的“上级条件”——它必须与最近的<code>v-if/v-else-if</code><strong>直接相邻</strong>（中间不能有其他兄弟元素）。如果隔开，Vue无法识别两者的关联。</p>
<h3 data-id="heading-9">五、常见报错与解决方案</h3>
<p>在使用<code>v-if</code>系列时，新手常遇到以下问题，我们逐一解决：</p>
<h4 data-id="heading-10">1. 报错：“v-else/v-else-if has no adjacent v-if”</h4>
<ul>
<li><strong>原因</strong>：<code>v-else</code>或<code>v-else-if</code>没有紧跟对应的<code>v-if</code>（中间有其他元素）。<br/>
比如：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isShow"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>无关内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-comment">&lt;!-- 中间的p元素导致错误 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
</li>
<li><strong>解决</strong>：删除中间的无关元素，让<code>v-else</code>直接紧跟<code>v-if</code>。</li>
<li><strong>预防</strong>：写<code>v-else</code>前，先检查前面的元素是否是<code>v-if</code>或<code>v-else-if</code>。</li>
</ul>
<h4 data-id="heading-11">2. 报错：“条件变化时，v-if内容不更新”</h4>
<ul>
<li><strong>原因</strong>：条件变量不是<strong>响应式</strong>的（比如用<code>let isShow = false</code>而不是<code>ref(false)</code>），Vue无法追踪其变化。</li>
<li><strong>解决</strong>：用<code>ref</code>（基本类型）或<code>reactive</code>（对象/数组）包裹条件变量：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误写法</span>
<span class="hljs-keyword">let</span> isShow = <span class="hljs-literal">false</span> 
<span class="hljs-comment">// 正确写法</span>
<span class="hljs-keyword">const</span> isShow = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
</code></pre>
</li>
<li><strong>预防</strong>：所有需要“随数据变化而更新”的变量，都用Vue的响应式API（<code>ref</code>/<code>reactive</code>）定义。</li>
</ul>
<h4 data-id="heading-12">3. 逻辑错误：v-else-if顺序导致条件失效</h4>
<ul>
<li><strong>例子</strong>：先写<code>v-else-if="score &gt;= 60"</code>，再写<code>v-else-if="score &gt;= 80"</code>——此时<code>80分</code>会被第一个条件拦截，永远到不了第二个。</li>
<li><strong>原因</strong>：Vue按指令顺序判断，满足第一个条件就停止。</li>
<li><strong>解决</strong>：将<strong>更严格的条件</strong>放在前面（比如先<code>&gt;=90</code>，再<code>&gt;=80</code>，最后<code>&gt;=60</code>）。</li>
</ul>
<h3 data-id="heading-13">参考链接</h3>
<p>Vue官网条件渲染文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Fconditional.html" target="_blank" title="https://vuejs.org/guide/essentials/conditional.html" ref="nofollow noopener noreferrer">vuejs.org/guide/essen…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025-12-20 vue3中 eslint9+和prettier配置]]></title>    <link>https://juejin.cn/post/7585468725332197430</link>    <guid>https://juejin.cn/post/7585468725332197430</guid>    <pubDate>2025-12-20T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585468725332197430" data-draft-id="7585474459776090148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025-12-20    vue3中 eslint9+和prettier配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-20T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_Swilder"/> <meta itemprop="url" content="https://juejin.cn/user/3927901716878829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025-12-20    vue3中 eslint9+和prettier配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927901716878829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_Swilder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T08:19:05.000Z" title="Sat Dec 20 2025 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>eslint 9+相较8版本使用<code>eslint.config.js</code>和扁平化配置方式。</p>
</blockquote>
<h3 data-id="heading-0">1.在项目根目录下安装所需的开发依赖包</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">核心代码检查与格式化工具</span>
pnpm add -D eslint prettier
<span class="hljs-meta prompt_">
# </span><span class="bash">Vue.js 语法支持</span>
pnpm add -D eslint-plugin-vue
<span class="hljs-meta prompt_">
# </span><span class="bash">Prettier 与 ESLint 集成</span>
pnpm add -D eslint-config-prettier eslint-plugin-prettier
</code></pre>
<h3 data-id="heading-1">💅 2. <code>prettier</code>配置</h3>
<p>在<code>vscode</code>中安装插件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1742bb6496d4f07b32be2c2963d0580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=%2B2%2BlEqI6zH04b3JliMIuAzgjdfY%3D" alt="image.png" loading="lazy"/></p>
<p>根目录下新建配置文件 <code>.prettierrc</code></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"semi"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"singleQuote"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tabWidth"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"trailingComma"</span>: <span class="hljs-string">"es5"</span>,
  <span class="hljs-string">"printWidth"</span>: <span class="hljs-number">100</span>,
  <span class="hljs-string">"arrowParens"</span>: <span class="hljs-string">"avoid"</span>,
  <span class="hljs-string">"htmlWhitespaceSensitivity"</span>: <span class="hljs-string">"ignore"</span>
}
</code></pre>
<h3 data-id="heading-2">3.<code>eslint</code>配置并将<code>prettier</code>规则作为<code>eslint</code>一部分，对不符合要求的报错</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> eslintPluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>
<span class="hljs-keyword">import</span> vueEslintParser <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-eslint-parser'</span>
<span class="hljs-keyword">import</span> eslintPluginPrettierRecommended <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier/recommended'</span>
<span class="hljs-comment">// console.log(eslintPluginPrettierRecommended)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  <span class="hljs-comment">// 全局配置：指定环境、解析器选项</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.js'</span>, <span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'vite.config.js'</span>, <span class="hljs-string">'node_modules/'</span>, <span class="hljs-string">'dist/'</span>, <span class="hljs-string">'public/'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      <span class="hljs-attr">globals</span>: {
        <span class="hljs-attr">browser</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 浏览器环境全局变量</span>
        <span class="hljs-attr">node</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Node.js 环境全局变量</span>
        <span class="hljs-attr">es2021</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// ES2021 语法支持</span>
      }
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-string">'no-console'</span>: <span class="hljs-string">'warn'</span>,
      <span class="hljs-string">'no-debugger'</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-string">'no-unused-vars'</span>: [<span class="hljs-string">'warn'</span>, { <span class="hljs-attr">varsIgnorePattern</span>: <span class="hljs-string">'^_'</span> }]
    }
  },

  <span class="hljs-comment">// Vue 单文件组件专属配置</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-comment">// 使用 vue-eslint-parser 解析 .vue 文件</span>
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parser</span>: vueEslintParser,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">parser</span>: <span class="hljs-string">'espree'</span>, <span class="hljs-comment">// 解析 &lt;script&gt; 块内的 JavaScript</span>
        <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-string">'latest'</span>,
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
      }
    },
    <span class="hljs-attr">plugins</span>: {
      <span class="hljs-attr">vue</span>: eslintPluginVue
    },
    <span class="hljs-attr">rules</span>: {
      <span class="hljs-comment">// 启用 Vue 官方推荐规则</span>
      ...eslintPluginVue.<span class="hljs-property">configs</span>[<span class="hljs-string">'flat/recommended'</span>].<span class="hljs-property">rules</span>,
      <span class="hljs-comment">// 自定义 Vue 规则</span>
      <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span> <span class="hljs-comment">// 关闭组件名必须多单词的要求</span>
    }
  },
  <span class="hljs-comment">//prettier配置</span>
  eslintPluginPrettierRecommended
]
</code></pre>
<p>此时运行</p>
<pre><code class="hljs language-shell" lang="shell">npm run lint
</code></pre>
<p>可以对不符合规则的代码检查，包含不符合<code>eslint</code>规则的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c23319426b4f6d86115eea28bbe3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=5ietbj%2FFYai2fzTxhmmDQi%2Bv82I%3D" alt="image.png" loading="lazy"/></p>
<p>4.配置vscode插件<code>eslint</code>和<code>Prettier ESlint</code>，设置默认格式化工具为<code>Prettier ESlint</code>，让<code>eslint</code>直接报错<code>prettier</code>中的配置，有时修改了<code>.prettierrc</code>中的配置需要重启<code>Prettier ESlint</code>插件才能生效。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5991155e944d43e8a514563f1cf7d674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=WlILNcFyOppEaY4XsUO1tfyjRZM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca06d152bbfe4152be64ba9accbe17ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJfU3dpbGRlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766823740&amp;x-signature=H4K5RzLd9rlKbrhHdippKxV6dfM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>对于<code>.eslintignore</code>文件缺失时<code>eslint</code>会使用<code>.gitignore</code>文件</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>