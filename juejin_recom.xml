<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[VSCode debugger 调试指南]]></title>    <link>https://juejin.cn/post/7572539461479104555</link>    <guid>https://juejin.cn/post/7572539461479104555</guid>    <pubDate>2025-11-16T17:09:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572539461479104555" data-draft-id="7572761792465190975" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode debugger 调试指南"/> <meta itemprop="keywords" content="前端,JavaScript,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-11-16T17:09:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="清沫"/> <meta itemprop="url" content="https://juejin.cn/user/659362706626839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode debugger 调试指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/659362706626839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    清沫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T17:09:46.000Z" title="Sun Nov 16 2025 17:09:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在以前的文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F4HSQXCmu0K9olyCiRtzJjw" target="_blank" title="https://mp.weixin.qq.com/s/4HSQXCmu0K9olyCiRtzJjw" ref="nofollow noopener noreferrer">深入前端调试原理</a>，我们主要从原理的角度来看了如何调试。本篇文章则是从实践角度出发，看看如何在 vscode 中配置和使用各种调试功能。</p>
<blockquote>
<p>本文涉及到代码均在仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwjgogogo%2Fvscode-debugger-dojo" target="_blank" title="https://github.com/wjgogogo/vscode-debugger-dojo" ref="nofollow noopener noreferrer">vscode-debugger-dojo</a>，全面的 VSCode Debugger 调试示例项目，涵盖了各种常见场景的调试配置。</p>
</blockquote>
<h2 data-id="heading-0">VSCode Debugger 原理</h2>
<p>在 VSCode 的项目中 <code>.vscode/launch.json</code> 中加入如下的配置即可调试：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63e96a0f6c06457d836e8db32f1258c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=emJK14kOMACS%2BnTCrE8HMyQ72zQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c97131e79bde41808484d0827532b9bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=lZmRVpuPkAkP%2B3lycDic5mEABDY%3D" alt="" loading="lazy"/></p>
<p>SCode 并不是 JS 语言的专属编辑器，它可以用于多种语言的开发，自然不能对某一种语言的调试协议进行深度适配，所以它提供了 Debugger 适配层和适配器协议，不同的语言可以通过提供 Debugger 插件的形式，增加 VSCode 对不同语言的调试能力：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bec75a7330924117ba108b76f474982a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=Hqp28bdrwxMBzqjmT3wU5ysntRM%3D" alt="" loading="lazy"/></p>
<p>如此，VSCode Debugger 就能以唯一的 Debugger 前端调试各个不同的语言，插件市场中也提供了诸多不同语言的调试插件： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd6234ecaebc40e1b54f57c47be167bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=lEWNfdjjRHV%2B6%2FyiGPRMA96j0qA%3D" alt="" loading="lazy"/></p>
<p>因此需要使用 <code>type</code> 字段来配置对应的 Debugger 适配器，在前端场景主要是 <code>node</code> 或者 <code>chrome</code>，分别对应 node 和浏览器环境。</p>
<h3 data-id="heading-1">调试模式</h3>
<p>调试模式通过 <code>request</code> 的方式指定如何启动和链接调试器。</p>
<h4 data-id="heading-2">Attach 模式</h4>
<p>调试的前后端之间是通过 websocket 进行通信的，所以确保前后端能正确的连接是调试成功的关键。</p>
<p>除了在需要调试的网页中直接打开 Devtools 的方式外，我们使用第三方前端工具进行调试时，都需要知道所需要调试的网页的后端 ws 地址才行。因此我们需要让 Chrome 以指定调试端口的形式跑起来，使用 <code>--remote-debugging-port</code> 参数指定调试端口：</p>
<pre><code class="hljs language-ini" lang="ini">/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome <span class="hljs-attr">--remote-debugging-port</span>=<span class="hljs-number">9222</span>
</code></pre>
<blockquote>
<p>Chrome 运行参数非常多，可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpeter.sh%2Fexperiments%2Fchromium-command-line-switches%2F" target="_blank" title="https://peter.sh/experiments/chromium-command-line-switches/" ref="nofollow noopener noreferrer">该文档</a> 进行查看。</p>
</blockquote>
<p>在 Chrome 运行起来后，随意的打开几个网页，然后访问 <code>localhost:9222/json/list</code> 网址，此时就能得到所有运行的网页后端 ws 地址： <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f653996f0aa4422db637c74ff72fa52f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=L%2B6Oh9Jqj2b4s11sS6Wrh45BukQ%3D" alt="" loading="lazy"/></p>
<p>在百度网页中同时打开了 Devtools， 可以看到连 Devtools 的调试信息都一起打印出来了，因为 Devtools 本质上也是一个网页程序，所以甚至可以做到对 Devtools Debugger 进行 Debug 这样的套娃操作。</p>
<p>有了 ws 信息，我们就可以使用其他 Debugger 进行连接了，比如使用下面的 VSCode Debug 配置：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae22df94a7c14d57a1b8a4117f5e7441~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=8mD0boYmZT0XWC8qJFj4HEkAjio%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6892c5dd7d547c1b97f65b9c4938aa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=rD2CFbzVc%2FSnY%2FP7z8Tq6tY8IkI%3D" alt="" loading="lazy"/></p>
<p>Node.js 程序在运行时则是通过 <code>--inspect</code> 或者 <code>--inspect-brk</code> 参数开启调试模式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a80b81efb6e4cb790d0e0b9df992751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=fQkLAaamJSUSslB7BhIoWdOYZqM%3D" alt="" loading="lazy"/></p>
<p>Node.js 调试协议经过了漫长的迭代，最终也是以 CDP 协议进行调试，因此 Node.js 程序可以直接使用 Devtools 进行调试，在 Chrome 中访问 <code>chrome://inspect/#devices</code> 就可以看到调试目标了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27323aae4e6f4e79b837301a9f2d9919~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=H084%2FTQ2TQX%2BN%2BSRWjT8%2Bz2eOH8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p><strong>如果当前的 Node 项目没有被发现，可能是检测端口不是默认的 <code>9229</code> ，可以通过 <code>Configure</code> 进行配置。</strong></p>
</blockquote>
<p>VSCode Debugger 同样能够连接上 Node.js 项目并进行调试，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/688d068b44e74cc4a66b1d6cd3ea4397~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=eWwiAsYQool%2FUtvlXBL9KudlEY4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3135e51ca6c748e99ef822b21fa44dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=WurwAMwuNb3cYxKsZOBI5dcR7cE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">Launch 模式</h4>
<p>前面讲到的都是首先通过调试模式启动一个项目，然后再手动进行前端 ws 连接，最后再调试的模式。相对较繁琐，VSCode Debugger 提供了 <code>launch</code> 模式，它相当于是将上面的流程自动化了，以调试模式将 Chrome 或者 Node.js 程序运行起来，然后 Debugger 自动 attach 到调试端口，直接调试。</p>
<h2 data-id="heading-4">常见配置</h2>
<h3 data-id="heading-5">launch.json 核心字段</h3>
<p>每个调试配置都需要以下基础字段：</p>

























<table><thead><tr><th>字段</th><th>说明</th><th>可选值 / 示例</th></tr></thead><tbody><tr><td><code>type</code></td><td>调试器类型</td><td><code>node</code>、<code>chrome</code>、<code>lldb</code> 等</td></tr><tr><td><code>request</code></td><td>调试模式</td><td><code>launch</code>（启动）、<code>attach</code>（附加）</td></tr><tr><td><code>name</code></td><td>配置名称</td><td>任意描述性名称</td></tr></tbody></table>
<h3 data-id="heading-6">常用配置项</h3>
<h4 data-id="heading-7">Node.js 调试配置项</h4>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Node.js Debug"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/index.js"</span>,
  <span class="hljs-string">"args"</span>: [<span class="hljs-string">"--port"</span>, <span class="hljs-string">"3000"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"env"</span>: {
    <span class="hljs-string">"NODE_ENV"</span>: <span class="hljs-string">"development"</span>
  },
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>, <span class="hljs-string">"**/node_modules/**"</span>],
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"-r"</span>, <span class="hljs-string">"ts-node/register"</span>]
}
</code></pre>
<p><strong>配置说明：</strong></p>
<ul>
<li><code>program</code>：程序入口文件</li>
<li><code>args</code>：传递给程序的命令行参数</li>
<li><code>cwd</code>：工作目录</li>
<li><code>env</code>：环境变量</li>
<li><code>skipFiles</code>：调试时跳过的文件（如 node 内部代码）</li>
<li><code>console</code>：终端类型（<code>integratedTerminal</code>、<code>internalConsole</code>、<code>externalTerminal</code>）</li>
<li><code>runtimeExecutable</code>：运行时可执行文件（如 <code>node</code>、<code>npm</code>、<code>pnpm</code>）</li>
<li><code>runtimeArgs</code>：传递给运行时的参数</li>
</ul>
<h4 data-id="heading-8">Chrome 调试配置项</h4>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"chrome"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Chrome Debug"</span>,
  <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:3000"</span>,
  <span class="hljs-string">"webRoot"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"userDataDir"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/.chrome-data"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"--auto-open-devtools-for-tabs"</span>],
  <span class="hljs-string">"sourceMaps"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"sourceMapPathOverrides"</span>: {
    <span class="hljs-string">"webpack:///./~/*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/node_modules/*"</span>,
    <span class="hljs-string">"webpack:///./*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>
  }
}
</code></pre>
<p><strong>配置说明：</strong></p>
<ul>
<li><code>url</code>：要打开的网页地址</li>
<li><code>webRoot</code>：Web 根目录，用于源码映射，本质上就是对 <code>sourcemapPathOverrides</code> 的快捷配置方式</li>
<li><code>userDataDir</code>：Chrome 用户数据目录，保存登录状态和扩展</li>
<li><code>runtimeArgs</code>：传递给 Chrome 的启动参数</li>
<li><code>sourceMaps</code>：是否启用 Source Map</li>
<li><code>sourceMapPathOverrides</code>：源码路径映射覆盖规则</li>
</ul>
<h4 data-id="heading-9">Compound 配置</h4>
<p>使用 <code>compounds</code> 可以同时启动多个调试会话：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compounds"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Full Stack Debug"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Server"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"Client"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-10">VSCode 变量</h4>
<p>在配置中可以使用以下变量：</p>









































<table><thead><tr><th>变量</th><th>说明</th></tr></thead><tbody><tr><td><code>${workspaceFolder}</code></td><td>工作区根目录</td></tr><tr><td><code>${file}</code></td><td>当前打开的文件完整路径</td></tr><tr><td><code>${relativeFile}</code></td><td>相对于工作区的文件路径</td></tr><tr><td><code>${fileBasename}</code></td><td>文件名（含扩展名）</td></tr><tr><td><code>${fileBasenameNoExtension}</code></td><td>文件名（不含扩展名）</td></tr><tr><td><code>${fileDirname}</code></td><td>文件所在目录</td></tr><tr><td><code>${cwd}</code></td><td>当前工作目录</td></tr><tr><td><code>${env:NAME}</code></td><td>环境变量 NAME 的值</td></tr></tbody></table>
<blockquote>
<p>可参考官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdocs%2Freference%2Fvariables-reference" target="_blank" title="https://code.visualstudio.com/docs/reference/variables-reference" ref="nofollow noopener noreferrer">Variables reference</a></p>
</blockquote>
<h4 data-id="heading-11">输入变量</h4>
<p>使用 <code>inputs</code> 可以在启动调试时要求用户输入：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"configurations"</span>: [
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Debug with args"</span>,
      <span class="hljs-string">"args"</span>: [<span class="hljs-string">"<span class="hljs-variable">${input:testName}</span>"</span>]
    }
  ],
  <span class="hljs-string">"inputs"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"testName"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"promptString"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"输入测试名称"</span>,
      <span class="hljs-string">"default"</span>: <span class="hljs-string">"test_example"</span>
    }
  ]
}
</code></pre>
<h2 data-id="heading-12">典型场景</h2>
<h3 data-id="heading-13">Vite + React 项目</h3>
<p>在常规的 React 项目中，通常可以通过先启动完 <code>vite dev</code> 项目后，再运行如下配置启动调试:</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"chrome"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Vite React"</span>,
  <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:5173"</span>,
  <span class="hljs-string">"webRoot"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/packages/vite-react-demo"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"--auto-open-devtools-for-tabs"</span>]
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a64099db654a45a7907e9c86692f3ff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=1VAGjNHFkbUDF0maVxra08EWjVA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14">保存登录状态</h4>
<p>但如此一次，每次启动的 chrome 都是一个全新的实例，没有任何的插件或者登录信息。如果我们希望每次启动的 chrome 都是带上 react 插件，并且保留登录信息，可以通过 <code>userDataDir</code> 自定用户信息目录，然后在第一次安装插件后，后续就无需在处理了：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"userDataDir"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/packages/vite-react-demo/.chrome-data"</span>
}
</code></pre>
<h4 data-id="heading-15">任务集成</h4>
<p>如果不希望单独运行 <code>vite dev</code>，而是在每次启动调试时，自行运行 <code>vite dev</code> 后再开启调试，可以通过 <code>preLaunchTask</code> 和 <code>postDebugTask</code> 可以在调试前后执行任务：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"chrome"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Vite React Debug"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:5173"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"preLaunchTask"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite-react: dev"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"postDebugTask"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"kill-vite-react-dev"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>需要在 <code>.vscode/tasks.json</code> 中定义对应的任务：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tasks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vite-react: dev"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"script"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dev"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"isBackground"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"problemMatcher"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"background"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"activeOnStart"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"beginsPattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
          <span class="hljs-comment">// 说明 task 准备完成</span>
          <span class="hljs-attr">"endsPattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ready in"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Task 配置属于锦上添花，不是调试过程中的必须配置，更多信息可以参考官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdocs%2Fdebugtest%2Ftasks" target="_blank" title="https://code.visualstudio.com/docs/debugtest/tasks" ref="nofollow noopener noreferrer">Integrate with External Tools via Tasks</a>。</p>
<h3 data-id="heading-16">Next.js 全栈调试</h3>
<p>Next.js 同时包含客户端和服务端代码，所以我们的调试场景既包含了 node 端，也包含了 chrome 端。可以借助 <code>serverReadyAction</code> 和 <code>compounds</code> 两种方式同时连接 node ，web 端 debugger 调试器。</p>
<p><code>serverReadyAction</code> 一个强大的自动化调试配置，它允许你在服务器启动后，自动触发一个额外的任务，比如针对 Chrome 浏览器的调试会话，从而实现 <strong>全栈调试</strong>。</p>
<p>而 <code>compounds</code> 则是同时启动多个调试，但是不处理调试之间的依赖关系。</p>
<h4 data-id="heading-17">serverReadyAction：debugWithChrome</h4>
<p>在启动完成 node 后端后，如果 node 控制台检测到输出了 pattern 内容，则开启一个 chrome 调试窗口：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Next.js - Full Stack"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"next"</span>, <span class="hljs-string">"dev"</span>],
  <span class="hljs-string">"serverReadyAction"</span>: {
    <span class="hljs-string">"pattern"</span>: <span class="hljs-string">"Local:\s+(https?://.+)"</span>,
    <span class="hljs-string">"action"</span>: <span class="hljs-string">"debugWithChrome"</span>,
    <span class="hljs-string">"uriFormat"</span>: <span class="hljs-string">"%s"</span>,
    <span class="hljs-string">"webRoot"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>"</span>
  },
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p>但是该模式下对 chrome 调试器的配置很有限，比如 <code>userDataDir</code> 都无法配置，适用于在开启后端调试后，同时兼顾简单的前端调试。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268f20eb880343eaaf15d82682542425~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=69qU9HYmvl9l%2B48ifsOt4z0jsvA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">serverReadyAction：startDebugging</h4>
<p><code>startDebugging</code> 则更强大，可以在服务器启动后自动启动另一个客户端调试配置，这样客户端的配置就是完整的，可以完成使用各种标准配置</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Next.js - Server"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"next"</span>, <span class="hljs-string">"dev"</span>],
  <span class="hljs-string">"serverReadyAction"</span>: {
    <span class="hljs-string">"pattern"</span>: <span class="hljs-string">"Local:\s+(https?://.+)"</span>,
    <span class="hljs-string">"action"</span>: <span class="hljs-string">"startDebugging"</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Next.js - Client"</span>
  },
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p>配合的客户端配置：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"chrome"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Next.js - Client"</span>,
  <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:3000"</span>,
  <span class="hljs-string">"webRoot"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>
}
</code></pre>
<h4 data-id="heading-19">Compounds</h4>
<p>不使用 <code>serverReadyAction</code> 时，通常单独各个端的调试配置，然后通过 <code>compounds</code> 同时启动多个独立的调试会话：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compounds"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Next.js - Full Stack"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Next.js - Server"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"Next.js - Client"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>三种方式对比：</strong></p>





























<table><thead><tr><th>方式</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>debugWithChrome</td><td>配置简单，一键启动</td><td>调试会话合并，控制粒度较粗</td><td>日常开发</td></tr><tr><td>startDebugging</td><td>自动化程度高，会话独立</td><td>需要两个配置</td><td>需要独立控制前后端</td></tr><tr><td>Compound</td><td>完全手动控制，灵活性高</td><td>需要手动管理多个会话</td><td>复杂调试场景</td></tr></tbody></table>
<blockquote>
<p><code>serverReadyAction</code> 还有一种 action <code>openExternally</code>，它的作用更为直接，会在 server 启动后，直接打开在 chrome 打开一个页面，但是不连接客户端调试，只是为了方便交互客户端后，调试服务端。</p>
</blockquote>
<p>基本上涉及到多端调试的场景都可以用类似的方案，比如 electron, express 前后端 mono repo 项目等等。</p>
<h3 data-id="heading-20">Node 项目</h3>
<h4 data-id="heading-21">TypeScript 项目</h4>
<p>在开发 node ts 项目时，除了编译完成后在运行 js 程序，也可以采用 tsx 或者 ts-node 直接运行 ts 程序，它们会在项目运行前自动进行编译操作。</p>
<p>需要在 <code>runtimeArgs</code> 增加 <code>-r</code> 参数来使用，也可以直接将 <code>runtimeExecutable</code> 进行替换。</p>
<p><strong>使用 tsx（推荐，启动快）：</strong></p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"TypeScript - Current File (tsx)"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-subst">${file}</span>"</span>,
  <span class="hljs-regexp">//</span> 或者
  // <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"tsx"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"-r"</span>, <span class="hljs-string">"tsx/cjs"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p><strong>使用 ts-node（完整类型检查）：</strong></p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"TypeScript - Current File (ts-node)"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-subst">${file}</span>"</span>,
  <span class="hljs-regexp">//</span> 或者
  // <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"ts-node"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"-r"</span>, <span class="hljs-string">"ts-node/register"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>],
  <span class="hljs-string">"env"</span>: {
    <span class="hljs-string">"TS_NODE_PROJECT"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>/tsconfig.json"</span>
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f444a9b41bf74e7db850c6b28c3320be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=e9NhkodI0D7xtcK9xR193os4NJQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-22">Pnpm 管理项目</h4>
<p>在 npm/yarn 管理的 Node 项目中，通常可以直接通过 <code>program</code> 指定 <code>node_modules/.bin</code> 下的命令文件：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Jest"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/node_modules/.bin/jest"</span>
}
</code></pre>
<p>但在 pnpm 项目中，这种方式会失败。</p>
<p><strong>问题根源：</strong> pnpm 出于性能和磁盘空间考虑，使用了独特的依赖管理方式，将 <code>.bin</code> 目录下的文件转化为 shell 脚本：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14bab8b549c74a35923dba86a07db0f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=qdcKLSmTMJHB7dQeOQsFRpotCt4%3D" alt="" loading="lazy"/></p>
<p>当尝试用 <code>node</code> 直接执行这些文件时，会报错：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">SyntaxError</span>: <span class="hljs-title class_">Invalid</span> or unexpected token
</code></pre>
<p>因为 Node.js 无法直接执行 shell 脚本文件。</p>
<p><strong>方案 1：使用 pnpm 执行</strong> - 将 <code>runtimeExecutable</code> 改为 <code>pnpm</code>，通过 <code>runtimeArgs</code> 传递命令：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Jest - pnpm"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"jest"</span>, <span class="hljs-string">"--runInBand"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p><strong>方案 2：直接指向 JS 文件</strong> - 绕过 shell 脚本，直接指向包内的 JavaScript 入口文件：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Jest - direct"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/node_modules/jest/bin/jest.js"</span>,
  <span class="hljs-string">"args"</span>: [<span class="hljs-string">"--runInBand"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p><strong>方案 3：使用 sh 执行</strong> - 让 <code>sh</code> 来执行 shell 脚本：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Jest - sh"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"sh"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/node_modules/.bin/jest"</span>,
  <span class="hljs-string">"args"</span>: [<span class="hljs-string">"--runInBand"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p><strong>实际应用示例：</strong></p>
<p>调试 Vitest 当前文件：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Vitest - Current File"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"vitest"</span>, <span class="hljs-string">"run"</span>, <span class="hljs-string">"<span class="hljs-variable">${relativeFile}</span>"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p>调试 ESLint：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"ESLint - Current File"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"eslint"</span>, <span class="hljs-string">"<span class="hljs-variable">${file}</span>"</span>, <span class="hljs-string">"--fix"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>
}
</code></pre>
<p>使用直接路径调试 TypeScript：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"TSC - Build"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/node_modules/typescript/bin/tsc"</span>,
  <span class="hljs-string">"args"</span>: [<span class="hljs-string">"--noEmit"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>
}
</code></pre>
<h3 data-id="heading-23">单测</h3>
<h4 data-id="heading-24">Jest 单元测试</h4>
<p>在运行单侧时，通常有两种场景，运行所有单侧，和运行当前单侧文件的单测。</p>
<p><strong>调试当前打开的测试文件：</strong></p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Jest - Current File"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/node_modules/jest/bin/jest.js"</span>,
  <span class="hljs-string">"args"</span>: [
    <span class="hljs-string">"<span class="hljs-variable">${relativeFile}</span>"</span>,
    <span class="hljs-string">"--config=<span class="hljs-variable">${workspaceFolder}</span>/jest.config.js"</span>,
    <span class="hljs-string">"--runInBand"</span>,
    <span class="hljs-string">"--no-coverage"</span>
  ],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"internalConsoleOptions"</span>: <span class="hljs-string">"neverOpen"</span>
}
</code></pre>
<p><strong>关键参数：</strong></p>
<ul>
<li><code>--runInBand</code>：串行运行测试（调试必需）</li>
<li><code>--no-coverage</code>：禁用覆盖率收集，加快调试速度</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/150cd089af8e479fb42c6aa6e36654cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=CfG%2FWlBdKBBNR9ZZFn3j587aXBk%3D" alt="" loading="lazy"/></p>
<p><strong>调试所有测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Jest - All Tests"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/node_modules/jest/bin/jest.js"</span>,
  <span class="hljs-string">"args"</span>: [<span class="hljs-string">"--runInBand"</span>, <span class="hljs-string">"--config=<span class="hljs-variable">${workspaceFolder}</span>/jest.config.js"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>
}
</code></pre>
<h4 data-id="heading-25">Vitest 单元测试</h4>
<p><strong>调试当前测试文件：</strong></p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Vitest - Current File"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"vitest"</span>, <span class="hljs-string">"run"</span>, <span class="hljs-string">"<span class="hljs-variable">${file}</span>"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p><strong>监视模式：</strong></p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Vitest - Watch Mode"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"pnpm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"vitest"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<h3 data-id="heading-26">npm script 调试</h3>
<p>通常，我们会将实际运行的程序写入到 npm scripts 中，所以也通过通过以下方式直接调试 script 脚本，就不需要在 launch.json 中重定义一套配置了：</p>
<p><strong>方式一：使用 node 类型：</strong></p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"npm script - Start"</span>,
  <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"npm"</span>,
  <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"run-script"</span>, <span class="hljs-string">"start"</span>],
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>]
}
</code></pre>
<p><strong>方式二：使用 node-terminal 类型：</strong></p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node-terminal"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"npm script - Start (Terminal)"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"command"</span>: <span class="hljs-string">"npm start"</span>,
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>
}
</code></pre>
<h3 data-id="heading-27">Puppeteer 自动化调试</h3>
<p>有些时候，调试准备调试数据，尤其是表单类的应用，除了在代码中进行处理，也可以借助 puppeteer 自动化前置的流程，直达要调试的阶段。</p>
<p>通过脚本 启动 puppeteer ，并搭配 <code>--remote-debugging-port=9222</code> 开启调试端口，在启动 puppeteer 后，通过 attach 模式连接 chrome 就可以自动化前置内容填写和连接 chrome 调试器两个阶段：</p>
<p><strong>调试 Puppeteer 脚本：</strong></p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"node"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Puppeteer - Script"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/scripts/auto-fill-form.js"</span>,
  <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>,
  <span class="hljs-string">"console"</span>: <span class="hljs-string">"integratedTerminal"</span>,
  <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"&lt;node_internals&gt;/**"</span>],
  <span class="hljs-string">"env"</span>: {
    <span class="hljs-string">"HEADLESS"</span>: <span class="hljs-string">"false"</span>
  }
}
</code></pre>
<p>Chrome Attach 配置：</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"chrome"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"attach"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Puppeteer - Chrome Attach"</span>,
  <span class="hljs-string">"port"</span>: 9222,
  <span class="hljs-string">"webRoot"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>"</span>
}
</code></pre>
<p><strong>同时调试 Puppeteer 脚本和浏览器代码：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compounds"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Puppeteer - Full Stack"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"configurations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Puppeteer - Script"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"Puppeteer - Chrome Attach"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"stopAll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf47ea233610498482d686630245447c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=fVWeskK7%2Fkii68e%2BaDOZhaA%2BhX8%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>puppeteer 脚本可以直接借助 ai 来生成，编写成本也非常低</p>
</blockquote>
<h2 data-id="heading-28">快捷调试方式</h2>
<p>除了使用 <code>launch.json</code> 配置外，VSCode 也提供了很多便捷的开启调试的手段。相对于通过 ui 交互简化了配置过程。</p>
<h3 data-id="heading-29">Package.json 调试按钮</h3>
<p>VSCode 会在 <code>package.json</code> 的 scripts 上方显示调试按钮，点击即可快速调试脚本。</p>
<p><strong>使用方式：</strong></p>
<ol start="0">
<li>打开 <code>package.json</code> 文件</li>
<li>在 scripts 字段上方会出现 "Debug" 按钮</li>
<li>点击按钮即可开始调试</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4631ee4e9c6044baa1f1db6ae8079856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=%2BLZe5Yxtk0v1cE4VUTohZ3ViSzE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-30">Testing 面板</h3>
<p>VSCode 提供了统一的测试面板，支持 Jest、Vitest、Mocha 等测试框架。</p>
<p><strong>启用方式：</strong></p>
<ol start="0">
<li>安装对应的测试扩展（如 Jest Runner、Vitest）</li>
<li>打开测试面板（左侧活动栏的烧杯图标）</li>
<li>VSCode 会自动发现项目中的测试</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/627d1452af79436dbbe5051276588079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=pBcha7qrreVC3Bjvj9%2BU2bnAHUM%3D" alt="" loading="lazy"/></p>
<p>可以非常便捷的在面板完成单侧的运行。</p>
<p>并且在单测文件中，每个单测也有便捷的调试按钮：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/933b61bc604a4e83bebe0b8668150a6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=WD11w%2B9a%2BXmze4%2FZIOsIaATmwRI%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdocs%2Fdebugtest%2Ftesting" target="_blank" title="https://code.visualstudio.com/docs/debugtest/testing" ref="nofollow noopener noreferrer">VSCode Testing 文档</a></p>
</blockquote>
<h3 data-id="heading-31">Auto Attach</h3>
<p>Auto Attach 是 VSCode 提供的一个非常方便的功能，可以自动附加调试器到在集成终端中启动的 Node.js 进程，可以在配置中打开：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e80be1f2c4c84974b1f2d7216453d9e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=Q2C6VZLY15XtDiaX%2BDPULWaCQoE%3D" alt="" loading="lazy"/></p>
<p><strong>三种模式：</strong></p>

























<table><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>Smart</td><td>自动检测常见脚本，如 npm scripts</td><td>推荐，日常使用</td></tr><tr><td>Always</td><td>附加到所有 Node.js 进程</td><td>调试所有 Node 程序</td></tr><tr><td>Only With Flag</td><td>仅附加到使用 <code>--inspect</code> 标志的进程</td><td>精确控制</td></tr></tbody></table>
<p><strong>使用示例：</strong></p>
<p>启用 Auto Attach 后，在集成终端中直接运行：</p>
<pre><code class="hljs language-bash" lang="bash">node src/index.js
<span class="hljs-comment"># 或</span>
npm run dev
<span class="hljs-comment"># 或</span>
pnpm <span class="hljs-built_in">test</span>
</code></pre>
<p>调试器会自动附加。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee6667f825784972b53a4818bba63b26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=BrkLmDc37qIq4z7N38j7gr8mfhM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdocs%2Fnodejs%2Fnodejs-debugging%23_auto-attach" target="_blank" title="https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_auto-attach" ref="nofollow noopener noreferrer">auto-attach</a></p>
</blockquote>
<h2 data-id="heading-32">经典问题</h2>
<h3 data-id="heading-33">为什么断点不生效</h3>
<p>最常见的是为什么明明设置了断点，调试器也连接了，但是就是没有停住。此时添加的断点是灰色的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6477b72ba5eb45e894b9ca5f0e5a4767~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=r2MeM82DErMlwexvIE2rmkJuexY%3D" alt="" loading="lazy"/></p>
<p>可以鼠标 hover 断点进行简单诊断：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f09ee1d43f742ff9b9f38480a09ef65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=LM%2B%2BLsQgDWMo1j14alFemGOly38%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e04bcda7da114e31941a3e87fad0f6e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=bBKLVbHIran7jmgPDF0Z2H%2Be83Y%3D" alt="" loading="lazy"/></p>
<p><strong>常见原因：</strong></p>
<h4 data-id="heading-34">launch.json 配置关闭了 sourcemap</h4>
<p><code>sourceMaps</code> 默认是 true, 如果改为了 false 就不会加载 sourcemap 了</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"chrome"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"launch"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Vite React - Launch (自定义用户信息)"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:5173"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"runtimeArgs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--auto-open-devtools-for-tabs"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sourceMaps"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-35">Source Map 配置错误</h4>
<p>确保构建工具正确生成了 Source Map：</p>
<p><strong>TypeScript (<code>tsconfig.json</code>)：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sourceMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inlineSourceMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"sourceRoot"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Vite (<code>vite.config.ts</code>)：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  build: {
    sourcemap: <span class="hljs-literal">true</span>,
  },
};
</code></pre>
<p><strong>Webpack (<code>webpack.config.js</code>)：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  devtool: <span class="hljs-string">"source-map"</span>, <span class="hljs-comment">// 或 'eval-source-map' 用于开发</span>
};
</code></pre>
<h4 data-id="heading-36">源码路径映射错误</h4>
<p>即使所有的 sourcemap 配置都正常，也可能会出现问题，常见于 webpack。比如 webpack 生成的 sourcemap 是:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb8b632055384076a6bec42af2bf5204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=mX9JV7zv%2BEPMFoHWiCtPd2HBGuk%3D" alt="" loading="lazy"/></p>
<p>映射出的原始文件以 <code>webpack://</code> 开头，比如 <code>webpack://webpack-demo/./src/app.ts</code>，而我们打的断点在 <code>${workspaceFolder}/packages/webpack-demo/src/app.ts</code>。VSCode 不知道两者关系，此时需要 <code>sourceMapPathOverrides</code> 和 <code>webRoot</code> 修正 Source Map 路径与本地文件路径的映射。</p>
<p><strong>配置说明：</strong></p>
<ol start="0">
<li><strong>webRoot 的作用</strong> - <code>webRoot</code> 指定 Web 应用的源码根目录，作为 Source Map 路径映射的基准路径。在 <code>sourceMapPathOverrides</code> 中可以通过 <code>${webRoot}</code> 变量引用这个基准路径。</li>
<li><strong>sourceMapPathOverrides 配置</strong> - 当 Source Map 中的路径与本地文件路径不匹配时，使用 <code>sourceMapPathOverrides</code> 修正路径映射：</li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"chrome"</span>,
  <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"Chrome Debug"</span>,
  <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:3000"</span>,
  <span class="hljs-string">"webRoot"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>/packages/webpack-demo"</span>,
  <span class="hljs-comment">// 相当于：</span>
  <span class="hljs-string">"sourceMapPathOverrides"</span>: {
    <span class="hljs-string">"webpack://webpack-demo/./src/*"</span>: <span class="hljs-string">"<span class="hljs-subst">${webRoot}</span>/src/*"</span>,
    <span class="hljs-string">"webpack://webpack-demo/./*"</span>: <span class="hljs-string">"<span class="hljs-subst">${webRoot}</span>/*"</span>
  }
}
</code></pre>
<p><strong>默认配置:</strong></p>
<p>如果不配置 <code>sourceMapPathOverrides</code>，VSCode 会使用以下默认规则 (适用于 Chrome/浏览器调试):</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"sourceMapPathOverrides"</span>: {
    <span class="hljs-string">"webpack:///./~/*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/node_modules/*"</span>,
    <span class="hljs-string">"webpack:///./*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>,
    <span class="hljs-string">"webpack:///*"</span>: <span class="hljs-string">"*"</span>,
    <span class="hljs-string">"webpack:///src/*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>,
    <span class="hljs-string">"meteor://💻app/*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>
  }
}
</code></pre>
<blockquote>
<p><strong>注意:</strong> 对于 Node.js 调试，默认规则中使用 <code>${workspaceFolder}</code> 替代 <code>${webRoot}</code>。</p>
</blockquote>
<p><strong>配置说明:</strong></p>
<ul>
<li>左侧是 Source Map 中的路径模式</li>
<li>右侧是本地文件系统的实际路径</li>
<li><code>*</code> 是通配符，匹配任意路径片段</li>
<li>映射规则从上到下匹配，使用第一个匹配的规则</li>
</ul>
<p><strong>常见打包工具的配置示例:</strong></p>
<ol start="0">
<li><strong>Webpack 项目:</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"sourceMapPathOverrides"</span>: {
    <span class="hljs-string">"webpack:///./*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>,
    <span class="hljs-string">"webpack:///src/*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/src/*"</span>,
    <span class="hljs-string">"webpack:///*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>
  }
}
</code></pre>
<p>2.  <strong>Vite 项目:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Vite</span> 的 <span class="hljs-title class_">Source</span> <span class="hljs-title class_">Map</span> 路径通常已经是正确的，一般不需要额外配置。但如果遇到问题:
</code></pre>

<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"sourceMapPathOverrides"</span>: {
    <span class="hljs-string">"/@fs/*"</span>: <span class="hljs-string">"/*"</span>,
    <span class="hljs-string">"/src/*"</span>: <span class="hljs-string">"<span class="hljs-subst">${webRoot}</span>/src/*"</span>
  }
}
</code></pre>
<p>3.  <strong>Monorepo 项目:</strong></p>

<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"webRoot"</span>: <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/packages/your-app"</span>,
  <span class="hljs-string">"sourceMapPathOverrides"</span>: {
    <span class="hljs-string">"webpack:///packages/your-app/*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>,
    <span class="hljs-string">"webpack:///../your-app/*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>
  }
}
</code></pre>
<p>假设:</p>
<ul>
<li><code>webRoot = "${workspaceFolder}/packages/app"</code></li>
<li>Source Map 路径: <code>webpack://app/./src/index.ts</code></li>
</ul>
<p>映射规则:</p>
<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"sourceMapPathOverrides"</span>: {
    <span class="hljs-string">"webpack://app/./*"</span>: <span class="hljs-string">"<span class="hljs-variable">${webRoot}</span>/*"</span>
  }
}
</code></pre>
<p>映射过程:</p>
<ol start="0">
<li><code>webpack://app/./src/index.ts</code> 匹配规则 <code>webpack://app/./*</code></li>
<li><code>*</code> 匹配到 <code>src/index.ts</code></li>
<li>替换为 <code>${webRoot}/src/index.ts</code></li>
<li>展开 <code>${webRoot}</code> 得到最终路径: <code>${workspaceFolder}/packages/app/src/index.ts</code></li>
</ol>
<h3 data-id="heading-37">调试器启动慢</h3>
<p><strong>原因：</strong></p>
<ul>
<li>项目文件过多</li>
<li>Source Map 文件过大</li>
<li>skipFiles 配置不当</li>
</ul>
<p><strong>优化方法：</strong></p>
<ol start="0">
<li><strong>跳过不必要的文件</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"skipFiles"</span>: [
    <span class="hljs-string">"&lt;node_internals&gt;/**"</span>,
    <span class="hljs-string">"**/node_modules/**"</span>,
    <span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/dist/vendor.js"</span>
  ]
}
</code></pre>
<p>2.  <strong>限制 Source Map 查找范围</strong></p>

<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"outFiles"</span>: [<span class="hljs-string">"<span class="hljs-variable">${workspaceFolder}</span>/dist/**/*.js"</span>, <span class="hljs-string">"!**/node_modules/**"</span>]
}
</code></pre>
<p>3.  <strong>使用更快的 Source Map 类型</strong></p>
<pre><code class="hljs language-python" lang="python">开发环境使用 `<span class="hljs-built_in">eval</span>-source-<span class="hljs-built_in">map</span>`：
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// webpack.config.js</span>
devtool: <span class="hljs-string">"eval-source-map"</span>; <span class="hljs-comment">// 比 'source-map' 快但体积大</span>
</code></pre>
<h2 data-id="heading-38">总结</h2>
<p>vscode debugger 是非常强大的，可以极大提升调试效率。并且设置虽多，关键的就是那几个，配置也不麻烦。了解了 vscode debugger 能做哪些事情后，搭配 AI， 更是进一步简化了配置的难度。</p>
<p>欢迎关注笔者的个人公众号，共同学习，共同前进</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7326c66039c46568fe0eef557683096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5riF5rKr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917820&amp;x-signature=tBsjrBYDZ%2Brw5gs7he59uMAHlz4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第五章(动态路由)]]></title>    <link>https://juejin.cn/post/7572762535716519977</link>    <guid>https://juejin.cn/post/7572762535716519977</guid>    <pubDate>2025-11-16T17:01:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572762535716519977" data-draft-id="7572525491539640362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第五章(动态路由)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-16T17:01:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第五章(动态路由)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T17:01:14.000Z" title="Sun Nov 16 2025 17:01:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">动态路由</h2>
<p>动态路由是指在路由中使用方括号<code>[]</code>来定义路由参数，例如<code>/blog/[id]</code>，其中<code>[id]</code>就是动态路由参数，因为在某些需求下，我们需要根据不同的id来显示不同的页面内容，例如商品详情页，文章详情页等。</p>
<h4 data-id="heading-1">基本用法[slug]</h4>
<p>使用动态路由只需要在文件夹名加上方括号<code>[]</code>即可，例如<code>[id]</code>,<code>[params]</code>等，名字可以自定义。</p>
<p>来看demo: 我们在<code>app/shop</code>目录下创建一个<code>[id]</code>目录</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//app/shop/[id]/page.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Page<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a35e826103a048e08e30709c735f2bc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917274&amp;x-signature=iRrG3DN2Yt27TD63t%2F7J93qxRYw%3D" alt="image.png" loading="lazy"/></p>
<p>访问路径为:<code>http://localhost:3000/shop/123</code> 其中<code>123</code>就是动态路由参数，这个可以是任意值。</p>
<h4 data-id="heading-2">路由片段[...slug]</h4>
<p>我们如果需要捕获多个路由参数，例如<code>/shop/123/456</code>，我们可以使用路由片段来捕获多个路由参数，他的用法就是<code>[...slug]</code>，其中<code>slug</code>就是路由片段，这个名字可以自定义，后面的片段有多少就捕获多少。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//app/shop/[...id]/page.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Page<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e53a552caf604c84b89d3f385cf6347e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917274&amp;x-signature=SG%2F6BVTE9BOAv8nDZewfbq6Ztbg%3D" alt="image.png" loading="lazy"/></p>
<p>访问路径为:<code>http://localhost:3000/shop/123/456/789</code> 其中<code>123</code>和<code>456</code>和<code>789</code>就是动态路由参数，后面的片段有多少就捕获多少。</p>
<h4 data-id="heading-3">可选路由[[...slug]]</h4>
<p>可选路由指的是，我们可能会有这个路由参数，也可能会没有这个路由参数，例如<code>/shop/123</code>，也可能是<code>/shop</code>，我们可以使用可选路由来捕获这个路由参数，他的用法就是<code>[[...slug]]</code>，其中<code>slug</code>就是路由片段，这个名字可以自定义，后面的片段有多少就捕获多少。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//app/shop/[[...id]]/page.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Page<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dfc1d94d9664c109278c7a4b5d002af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763917274&amp;x-signature=x2GcKXZV11sy%2FDq9lmxDWEwLxhY%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>访问路径为:<code>http://localhost:3000/shop</code>，可以没有参数</li>
<li>访问路径为:<code>http://localhost:3000/shop/123</code>，可以有参数</li>
<li>访问路径为:<code>http://localhost:3000/shop/123/456</code>，可以有多个参数</li>
</ul>
<p>这种方式比较灵活。</p>
<h4 data-id="heading-4">接受参数</h4>
<p>使用<code>useParams</code> hook来接受参数，这个hook只能在客户端组件中使用。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>
<span class="hljs-keyword">import</span> { useParams } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/navigation"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ShopPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> params = <span class="hljs-title function_">useParams</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(params); <span class="hljs-comment">//{id: '123'}  {id: ['123', '456']} 接受单个值以及多个值</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>ShopPage<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全网都在推 comet 浏览器，但我劝你谨慎！]]></title>    <link>https://juejin.cn/post/7572534419881033763</link>    <guid>https://juejin.cn/post/7572534419881033763</guid>    <pubDate>2025-11-16T15:12:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572534419881033763" data-draft-id="7572775409725587456" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全网都在推 comet 浏览器，但我劝你谨慎！"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-16T15:12:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="麦麦麦造"/> <meta itemprop="url" content="https://juejin.cn/user/1732486056126311"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全网都在推 comet 浏览器，但我劝你谨慎！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486056126311/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    麦麦麦造
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T15:12:06.000Z" title="Sun Nov 16 2025 15:12:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>大家好，我是<strong>MAI麦造！</strong></p>
<p>最近深度体验了一下 Perplexity 推出的AI浏览器：Comet</p>
<p>第一天就给我带来了不小的震撼！WooC？还能这么玩？</p>
<p>但到了第二天！
感觉逐渐不对劲了...</p>
<h2 data-id="heading-0">Comet 是啥？</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50241f10ec2b463a885c641e89031a96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=Y6Gc6z%2FQ1Ih46o%2FXphjOSZ4v5ew%3D" alt="PixPin_2025-11-16_21-53-17.png" loading="lazy"/></p>
<p>Comet浏览器由Perplexity AI开发，于2025年7月正式发布，是一款基于Chromium架构的AI原生浏览器。</p>
<p>基于 Chromium 开发，因此可以兼容绝大多数 Chrome 插件。</p>
<p>如果你是一个 Chrome 的重度用户，那么你可以几乎无痛的迁移。</p>
<p>最初定价200美元/月，10月后转为免费使用，通过深度集成AI功能，重新定义用户的网络浏览体验。</p>
<h3 data-id="heading-1">核心特色</h3>
<ul>
<li><strong>AI助手集成：</strong> 内置GPT、Claude、Gemini等多模型支持</li>
<li><strong>跨标签页智能：</strong> 能够同时分析和处理多个网页内容</li>
<li><strong>自动化任务：</strong> 可执行邮件发送、日程安排等复杂操作</li>
<li><strong>语音控制：</strong> 支持自然语言交互</li>
<li><strong>免费策略：</strong> 降低用户使用门槛</li>
</ul>
<p>调研了市面上的用户反馈，优点还是比较多的。
但缺点、安全问题、性能问题同样不少！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88de5b1c07534e618bb19038225d9282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=qc1lkyMkz7%2Bh3LeDFQ2l5f5RBek%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">先说优点：</h2>
<h3 data-id="heading-3">1. 自动执行操作</h3>
<p>在对话前加上 <code>/</code> ，可以让浏览器自动执行任务。
例如：<code>/打开B站播放阿怪的视频</code>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efadb1ff84f04643996f6a5681e5de5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=uHmj%2FGvcXgMuVRvTvJiX%2BTye6fQ%3D" alt="output.gif" loading="lazy"/></p>
<p>它可以自动打开B站，然后找到阿怪，最后播放它的视频。</p>
<p>并且可以保存成一个快捷指令，下次可以很方便的使用。</p>
<p>这个功能还是比较实用的，在一些简单场景，它可以替代之前只需要使用 selenium 和 RPA 的操作。</p>
<p>但复杂场景，就别想了吧...</p>
<p>在很多文章中，说到它可以帮你抢票...</p>
<p>但抢过票的都知道，那肯定是不可能的啊😅</p>
<p>每一步的操作延迟都挺高的</p>
<p>买票到是有点可能。</p>
<h3 data-id="heading-4">2. 跨页面提问</h3>
<p>查找资料或者比较详情的时候，经常会打开多个网页。
它支持引用多个网页的内容，然后直接进行提问。</p>
<blockquote>
<p>感觉跟cursor 的交互有点像[🌚]</p>
</blockquote>
<p>在右边的 Assistant 中，通过 <code>@</code> 符号，
可以引用一个或多个<code>已打开的标签页</code> 来进行提问。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd157d9bc21c4ac5be2bbfa46e15a5e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=%2B25P5T5CQicZLxHEMoqpIo1Y4DA%3D" alt="PixPin_2025-11-16_16-50-39.png" loading="lazy"/></p>
<p>如果你在页面上选中了一段文字，Assistant 中也会自动引用上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7d3e24836f84e54b0b39ae3c8475d43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=Y3wWenIssidPA84x%2BlONYt87row%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">3. 自动化任务</h3>
<p>可以设置定时任务，自动执行，然后把报告发到你的邮箱。</p>
<p>这个功能的入口在<code>账户</code>-&gt;<code>任务</code> 中
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50f759290f4b4f49ae70952075d9db45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=%2F5wWxzDAXyZ7FA0kPtzDfXeeoHY%3D" alt="PixPin_2025-11-16_16-52-09.png" loading="lazy"/></p>
<p>通过自然语言的方式，描述需要执行的任务</p>
<p>然后设置执行时间，那么他就会自动执行，然后发到你邮箱中。</p>
<p>无论是 <code>搜索任务</code>，还是<code>研究任务</code>，都可以！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05b5d09413a641908e5a3f2c17eaba6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=DnMmEjFNzKlYyVkQnzS794pqwgU%3D" alt="PixPin_2025-11-16_16-53-25.png" loading="lazy"/></p>
<p>比如我的这个定时任务每天收到的邮件：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43db41ae2d33426497c32ef5ff652a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=3LxqBawpP%2FBqKyVSddMyn9SHvsw%3D" alt="PixPin_2025-11-16_16-58-29.png" loading="lazy"/></p>
<p>上面几点是我体验下来，比较满意的地方。</p>
<p>不过依然有许多不足的地方。</p>
<p>主要集中在 <code>性能问题</code>  和 <code>安全问题</code> 上</p>
<h2 data-id="heading-6">性能上：</h2>
<h3 data-id="heading-7">1. 容易崩</h3>
<p>标签页打开多了，就非常容易卡</p>
<p>同时经常出现这种错误提示，在窗口和 Assistant 上都比较频繁。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd97efdfdfe04b38bdc5109689714248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=wKUoDqYzObUS50oMCX6WLoO7%2FLI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76d9901ef49a4ed5b89ab6d7ccb94474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=lexv1oRFZGoLADWv9o3vNvWXIFM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">2. 资源消耗更大</h3>
<ul>
<li>内存使用：310MB（比Chrome高29%）</li>
<li>CPU占用：15%（比Chrome高88%）</li>
<li>电池续航：减少17.5%  续航时间</li>
<li>响应速度：明显慢于传统浏览器</li>
<li>复杂任务执行错误频发</li>
<li>响应速度较慢，用户体验不佳</li>
<li>偶尔出现AI幻觉，结果不可靠</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/111fe1da52da40348cac10e7c2c2d53e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=zN%2FyNiXwBhplubfZ1TSXawcvvCk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">安全性上：</h2>
<h3 data-id="heading-10">1. 默认分享隐私数据</h3>
<p><strong>官方政策：</strong></p>
<ul>
<li>默认收集用户交互数据以"改进服务和推荐相关内容"</li>
<li>本地处理数据以减少隐私风险</li>
<li>但数据收集范围仍然广泛</li>
</ul>
<p><strong>但实际上：</strong></p>
<ul>
<li>浏览历史、搜索查询、交互模式都被记录</li>
<li>数据用于训练AI模型和改善服务</li>
<li>缺乏透明的数据删除机制</li>
</ul>
<p>而且 Comet 可以深度集成Gmail、Outlook、Google Calendar、Slack 等应用。</p>
<p>处理这些应用，需要授予AI助手广泛的账户访问权限。</p>
<p>数据在AI处理过程中可能被泄露，并且缺乏完善的权限撤销机制。</p>
<p>这些数据默认情况下会被用于“改进Comet并推荐内容”，还会被用来训练Perplexity的AI模型。</p>
<p>意味着你的搜索历史、邮件、甚至家庭照片，都可能被用于个性化推荐，或在某些情况下被共享给第三方</p>
<h3 data-id="heading-11">2. 提示注入攻击</h3>
<p>恶意网站可通过隐藏指令操控AI执行未授权操作</p>
<p>这个问题由Brave研究团队爆出</p>
<p>这个问题的主要原理是：</p>
<ul>
<li>Comet浏览器的AI助手在处理网页内容时，无法有效区分用户的合法指令和网页中嵌入的恶意指令</li>
<li/>
<li>当用户要求AI"总结此网页"时，Comet会将网页内容直接传递给LLM，恶意指令会被当作用户指令执行</li>
</ul>
<p><strong>Brave的实验场景：</strong></p>
<ol>
<li>Brave研究团队在Reddit发布包含恶意指令的帖子</li>
<li>用户使用Comet浏览器访问该帖子并要求"总结当前网页"</li>
<li>Comet AI读取并执行了隐藏的恶意指令</li>
</ol>
<p>整个攻击过程仅需2.5分钟，且难度极低，普通用户即可实施。</p>
<h3 data-id="heading-12">3. CometJacking攻击</h3>
<p>恶意链接可窃取用户敏感数据和账户信息
由 LayerX团队爆出这个问题。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3179d9f426b240bb8c52d4842a91c560~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=cPJrcfQ0xToeDqB5cqqNjqYDGME%3D" alt="PixPin_2025-11-16_21-24-57.png" loading="lazy"/></p>
<p><strong>攻击机制：</strong></p>
<ul>
<li>攻击者创建包含恶意指令的特殊URL</li>
<li>用户点击链接后，Comet将URL参数中的指令误认为用户指令</li>
<li>指令要求Comet访问用户数据并编码发送给攻击者</li>
</ul>
<p><strong>数据窃取方法：</strong></p>
<p>通过base64编码隐藏敏感数据，编码后的数据将作为"无害"文本发送，从而绕过Comet的数据保护机制</p>
<p>数据类型可能涉及：</p>
<ul>
<li>邮箱内容和元数据</li>
<li>日历事件和联系人信息</li>
<li>浏览器存储的敏感信息</li>
<li>账户认证信息</li>
</ul>
<h3 data-id="heading-13">4.  钓鱼网站防护缺失</h3>
<p>LayerX 同时使用100个最新的钓鱼网站进行测试，同时对比Comet、Chrome、Edge、Dia等浏览器。</p>
<p><strong>测试结果：</strong></p>



































<table><thead><tr><th>浏览器</th><th>阻止率</th><th>允许率</th></tr></thead><tbody><tr><td>Comet</td><td>7%</td><td>93%</td></tr><tr><td>Genspark</td><td>7%</td><td>93%</td></tr><tr><td>Chrome</td><td>&gt;90%</td><td>&lt;10%</td></tr><tr><td>Edge</td><td>&gt;90%</td><td>&lt;10%</td></tr><tr><td>Dia</td><td>&gt;90%</td><td>&lt;10%</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01968c3bd84942c89e03040a67569a5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=5Efi8vfapxT9VGZsHQL5uDTVT9Q%3D" alt="image.png" loading="lazy"/></p>
<p>Comet用户面临更高的钓鱼攻击风险。</p>
<p>风险这么高的原因主要是：</p>
<ul>
<li>没有实现Google Safe Browsing API</li>
<li>缺乏已知的恶意网站黑名单</li>
<li>没有主动钓鱼网站检测</li>
</ul>
<p>同时只提供了有限的保护：</p>
<ul>
<li>仅依赖SSL证书验证</li>
<li>基础的网络连接安全检查</li>
<li>无法识别 0 Day 钓鱼攻击</li>
</ul>
<h2 data-id="heading-14">最后</h2>
<p>总体上来讲，
comet 浏览器在 <strong>AI 功能</strong> 和 <strong>创新性</strong> 上做得比较好。</p>
<p>但是 <strong>使用体验</strong> 和 <strong>安全方面</strong> 比较差</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1a6a3444883426b96abd1fe95ab035c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bqm6bqm6bqm6YCg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763910814&amp;x-signature=C4Pd4T8FMCVinYWEPG%2FwK2PME9Y%3D" alt="image.png" loading="lazy"/></p>
<p>个人用户可以尝试体验一下创新的功能，但请勿用来处理敏感数据。</p>
<p>不建议企业用户使用，但可在沙盒中测试，期待 2.0 版本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Codex CLI初体验]]></title>    <link>https://juejin.cn/post/7572537221541462031</link>    <guid>https://juejin.cn/post/7572537221541462031</guid>    <pubDate>2025-11-16T14:04:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221541462031" data-draft-id="7569140034588377103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Codex CLI初体验"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-16T14:04:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Codex CLI初体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T14:04:23.000Z" title="Sun Nov 16 2025 14:04:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>由于Claude Code对国内使用的限制，OpenAI Codex的性价比和受欢迎程度明显提高，今天抽时间来体验一波。对其他AI Code CLI感兴趣的小伙伴也可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247487588%26idx%3D1%26sn%3D7f6af21976e6a86ccf36851501542ffa%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247487588&amp;idx=1&amp;sn=7f6af21976e6a86ccf36851501542ffa&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">终端福音，AI终端编程助手Aider</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492263%26idx%3D1%26sn%3D4e809f38100be358e31f298a78fd81ea%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492263&amp;idx=1&amp;sn=4e809f38100be358e31f298a78fd81ea&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">下一代AI终端神器Warp</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492929%26idx%3D1%26sn%3D043e21a18f31f1c4c68bf4ee63e28685%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492929&amp;idx=1&amp;sn=043e21a18f31f1c4c68bf4ee63e28685&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code CLI初体验</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>codex-cli：0.53.0</p>
<h2 data-id="heading-2">限制</h2>
<ul>
<li>限制国内，需要科学上网</li>
<li>仅向 ChatGPT Plus、Pro、Team、Edu 和 Enterprise 用户开放</li>
</ul>
<h2 data-id="heading-3">优势</h2>
<ul>
<li>Edu用户可免费体验</li>
<li>默认使用GPT 5模型，支持切换 gpt-5-codex 模型</li>
<li>Rust 语言编写，速度快、效率高</li>
</ul>
<h2 data-id="heading-4">简介</h2>
<p>Codex 是 OpenAI 开发的一款专为软件工程师设计的云端编程智能体，专门优化了代码生成能力。它基于 GPT 架构构建，通过对大量公开代码库（包括 GitHub 上的开源项目）进行训练，能够理解和生成多种编程语言的代码。</p>
<p>官方文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.openai.com%2Fcodex%2Fcli" target="_blank" title="https://developers.openai.com/codex/cli" ref="nofollow noopener noreferrer">developers.openai.com/codex/cli</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d261c4e5d6a3496a9c68254f9042df7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=B%2BN8RpDO7XBWgHu2meTTqckKUmY%3D" alt="图片" loading="lazy"/></p>
<p>Github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fcodex" target="_blank" title="https://github.com/openai/codex" ref="nofollow noopener noreferrer">github.com/openai/code…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692f9b415c7e4f19885135d6b4ec447f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=MvIhO%2Bk1lbPNsV94QLOGM7%2FeC3U%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">安装</h2>
<p>Codex CLI提供了多种安装方式，安装也很方便，可以根据自己的环境选择安装方式。</p>
<h3 data-id="heading-6">使用npm</h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>npm install -g <span class="hljs-variable">@openai</span>/codex
</code></pre>
<h3 data-id="heading-7">使用Homebrew</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ brew</span> install codex
</code></pre>
<h3 data-id="heading-8">验证安装</h3>
<p>安装完成后，在命令行终端输入以下命令：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ codex</span> --version
或者
<span class="hljs-variable">$ codex</span> -V
</code></pre>
<p>命令行终端输出以下内容表示安装成功</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c561366f29514bdf836aec6dc604de80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=YbgxXSKUypTKWzAzvO08hbtnamE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9">更新升级</h3>
<p>Codex CLI没有提供更新命令，目前更新只能使用如下命令</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 更新</span>
<span class="hljs-variable">$ </span>npm update -g <span class="hljs-variable">@openai</span>/codex
<span class="hljs-comment"># 重新安装最新版本</span>
<span class="hljs-variable">$ </span>npm install -g <span class="hljs-variable">@openai</span>/codex<span class="hljs-variable">@latest</span>
</code></pre>
<h2 data-id="heading-10">基本使用</h2>
<h3 data-id="heading-11">登录授权</h3>
<p>Codex CLI安装成功后，在命令行终端输入 codex 即可启动，但想要正常使用Codex还需要进行登录授权操作，Codex同样提供了 手动授权 和 自动授权 2种方式。</p>
<h4 data-id="heading-12">1）手动授权</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbf068e160754f588426e887af0b62c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=LZd61IbDWLXsDbROVTQ0n%2FyxyaQ%3D" alt="图片" loading="lazy"/></p>
<p>手动授权提供了使用 ChatGPT 和 API Key 2种授权方式：</p>
<ul>
<li>使用ChatGPT：打开ChatGPT官网授权</li>
<li>API Key：填写ChatGPT API Key，授权完成后会存储到 ~/.codex/auth.json 文件中</li>
</ul>
<p>授权成功后即可进入Codex CLI界面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629e54341e1f441592bded9863415859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=fI4ul9TdDvtdTALveTHU7bAPQso%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-13">2）自动授权</h4>
<blockquote>
<p>Codex CLI的自动授权配置也是相对简单的，目前版本只支持全局授权配置</p>
</blockquote>
<p>在命令行终端导出 OPENAI_API_KEY</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># macOS</span>
$ export <span class="hljs-attr">OPENAI_API_KEY</span>=<span class="hljs-string">"sk-你的API密钥"</span>
<span class="hljs-comment"># windos</span>
$ setx <span class="hljs-attr">OPENAI_API_KEY</span>=sk-你的API密钥
</code></pre>
<p>或者在 ~/.codex/auth.json 文件中 OPENAI_API_KEY 配置</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"OPENAI_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-你的API密钥"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置完成后，在命令终端输入 codex 启动，首次使用会提示授权提示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f6df41b75e94a7aa49e9840d9c4192b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=YLwpl9UVWUKdd6L5K%2FhTBl3GNE8%3D" alt="图片" loading="lazy"/></p>
<p>授权完成后即可进入Codex CLI的主界面，Codex CLI的主界面并不像Gemini CLI和Claude Code CLI那样有好看的对话框样式，光标在哪哪里就是输入框</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40d95c39d5324cb88816c96f98588502~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=PXurmMK63izzaCo4ycFrqzaikCA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-14">命令行参数</h3>
<p>Codex CLI同样提供了参数配置，在命令行输入 codex --help 可以快速查看Codex CLI提供的参数，包含 命令 和 可选参数，我们可以很方便的对Codex CLI进行默认配置覆盖和快速使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4c54289a15d4838941ce6eaeed26d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=SP4QKmeq6Zq5t3YcA5ftfJ94p3Y%3D" alt="图片" loading="lazy"/></p>
<p>Codex CLI命令行参数：</p>
<ul>
<li>exec：非交互式运行 Codex [别名：e]</li>
<li>login：管理登录</li>
<li>logout：移除存储的身份验证凭据</li>
<li>mcp： MCP 服务器模式运行 Codex 并管理 MCP 服务器</li>
<li>proto：通过标准输入 / 输出运行协议流 [别名：p]</li>
<li>completion：生成 shell 补全脚本</li>
<li>debug：内部调试命令</li>
<li>apply：将 Codex 代理生成的最新差异作为 “git apply” 应用到本地工作树 [别名：a]</li>
<li>resume：恢复之前的交互式会话（默认使用选择器；使用 --last 可继续最近的会话）</li>
</ul>
<p>Codex CLI提供了很多命令，这里我们只尝试一些常用的命令。在命令行终端输入指令，Codex CLI就会直接调用模型进行处理，而不是打开Codex CLI的交互式命令</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> codex <span class="hljs-built_in">exec</span> --full-auto <span class="hljs-string">"查看项目结构"</span></span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63a6bb006769456a8e933e44e4b636f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=ybj9uSlTrR8a%2BSCSA6ITj7YRSVQ%3D" alt="图片" loading="lazy"/></p>
<p>在命令行终端输入 codex mcp list 可以快速查看mcp列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19a2835de60848aab09ebc11d77e9ce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=hEfN9%2B5FxQnkJHEiolcnHvP65xI%3D" alt="图片" loading="lazy"/></p>
<p>在命令行终端输入 codex resume 会列举之前对话的记录，选择一个记录可以恢复到该对话的交互式会话状态</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a3988168fc4c029006dd8927f9700b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=EcodKNZrhBzfaYnSn0quTULG56w%3D" alt="图片" loading="lazy"/></p>
<p>可以看到上下文tokens还是保留的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22f81722159143b397e2025989c332d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=9BmsavPTFMJ6RwNCEwnNMYjSumk%3D" alt="图片" loading="lazy"/></p>
<p>ChatGPT最近发布了 gpt-5-codex 模型，也可以通过命令行参数一键设置</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$ codex</span> -m gpt-<span class="hljs-number">5</span>-codex
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42431216209449a390c6c4b0e1f50656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=lQ9dnTd0oTQ7Jso6PaQOpjZNMjE%3D" alt="图片" loading="lazy"/></p>
<p>Codex CLI支持图像输入，使用 --image 或 -i 可接收图像上下文，注意这里的图像只能是本地图片路径</p>
<pre><code class="hljs language-arduino" lang="arduino">$ codex --image img1.png,img2.jpg <span class="hljs-string">"总结图像内容"</span>
</code></pre>
<h3 data-id="heading-15">命令行及快捷键列表</h3>
<p>在终端输入 /，可以看到Codex CLI提供所有指令，可以看到比Gemini CLI和Claude Code CLI要明显少很多。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d18e2da562f349429c61ff10a31a3e51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=P188IwvRjZ%2BRijRj8aDW6antNW0%3D" alt="图片" loading="lazy"/></p>
<p>命令行列表：</p>
<ul>
<li>/model：选择要使用的模型和推理工作量，提供了gpt-5 minimal、low、medium 和 high 4个档位</li>
<li>/approvals：选择 Codex 无需批准即可执行的操作，提供了 Read Only、Auto 和 Full Access 3种模式</li>
<li>/new：在对话过程中开始新的聊天</li>
<li>/init：创建一个包含 Codex 指令的 AGENTS.md 文件</li>
<li>/compact：总结对话以避免达到上下文限制</li>
<li>/diff：显示 git 差异（包括未跟踪的文件）</li>
<li>/mention：提及一个文件，相当于@操作</li>
<li>/status：显示当前会话配置和令牌使用情况</li>
<li>/mcp：查看MCP工具列表</li>
<li>/logout：退出登录</li>
<li>/quit：退出Codex</li>
</ul>
<p>快捷键列表:</p>
<ul>
<li>回车：发送消息</li>
<li>Ctrl+J：换行</li>
<li>Ctrl+T：文本记录</li>
<li>Ctrl+C：退出交互式命令</li>
</ul>
<h3 data-id="heading-16">配置文件</h3>
<blockquote>
<p>Codex CLI目前只提供了全局配置方式</p>
</blockquote>
<p>官网配置文件文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fcodex%2Fblob%2Fmain%2Fdocs%2Fconfig.md" target="_blank" title="https://github.com/openai/codex/blob/main/docs/config.md" ref="nofollow noopener noreferrer">github.com/openai/code…</a></p>
<p>Codex CLI提供了 ~/.codex/config.toml 全局配置文件，可以对Codex CLI的模型及提供商进行自定义配置，基本配置格式如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">model</span> = <span class="hljs-string">"gpt-4o"</span>
<span class="hljs-attr">model_provider</span> = <span class="hljs-string">"openai-chat-completions"</span>
<span class="hljs-section">[model_providers.openai-chat-completions]</span>
<span class="hljs-comment"># 将在 Codex 用户界面中显示的提供商名称</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"OpenAI using Chat Completions"</span>
<span class="hljs-comment"># 提供商API请求路径后面将添加`/chat/completions`发送请求</span>
<span class="hljs-attr">base_url</span> = <span class="hljs-string">"https://api.openai.com/v1"</span>
<span class="hljs-comment"># API Key，发送请求将被添加到`Bearer TOKEN` HTTP header</span>
<span class="hljs-attr">env_key</span> = <span class="hljs-string">"OPENAI_API_KEY"</span>
<span class="hljs-comment"># wire_api 的有效值为 “chat” 和 “responses”。如果省略，默认值为 “chat”。</span>
<span class="hljs-attr">wire_api</span> = <span class="hljs-string">"chat"</span>
<span class="hljs-comment"># 请求额外参数</span>
<span class="hljs-attr">query_params</span> = {}
</code></pre>
<p>该配置使得将 Codex CLI 与非 OpenAI 模型一起使用成为可能，只要提供商提供与OpenAI兼容的API就可以正常使用。</p>
<p>以Ollama为例，配置如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">model</span> = <span class="hljs-string">"gpt-4o"</span>
<span class="hljs-attr">model_provider</span> = <span class="hljs-string">"ollama"</span>
<span class="hljs-section">[model_providers.ollama]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"Ollama"</span>
<span class="hljs-attr">base_url</span> = <span class="hljs-string">"http://localhost:11434/v1"</span>
</code></pre>
<p>以Mistral为例，配置如下</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">model</span> = <span class="hljs-string">"mistral-large-latest"</span>
<span class="hljs-attr">model_provider</span> = <span class="hljs-string">"mistral"</span>
<span class="hljs-section">[model_providers.mistral]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"Mistral"</span>
<span class="hljs-attr">base_url</span> = <span class="hljs-string">"https://api.mistral.ai/v1"</span>
<span class="hljs-attr">env_key</span> = <span class="hljs-string">"MISTRAL_API_KEY"</span>
</code></pre>
<p>使用时先在命令行终端执行命令导出环境变量，然后启动Codex CLI</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">MISTRAL_API_KEY</span>=<span class="hljs-string">"MISTRAL_API_KEY"</span>
</code></pre>
<p>或者在 auth.json 文件添加API Key</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"OPENAI_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your_custom_api_key"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>上面配置文件都是单模型配置，Codex的config.toml还支持多模型配置，通过指定 profile 类型即可快速切换模型配置</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">profile</span> = <span class="hljs-string">"gpt3"</span>
<span class="hljs-section">[profiles.mistral]</span>
<span class="hljs-attr">model</span> = <span class="hljs-string">"mistral-large-latest"</span>
<span class="hljs-attr">model_provider</span> = <span class="hljs-string">"mistral"</span>
<span class="hljs-section">[profiles.gpt3]</span>
<span class="hljs-attr">model</span> = <span class="hljs-string">"gpt-3.5-turbo"</span>
<span class="hljs-attr">model_provider</span> = <span class="hljs-string">"openai-chat-completions"</span>
<span class="hljs-section">[profiles.packycode]</span>
<span class="hljs-attr">model_provider</span> = <span class="hljs-string">"packycode"</span>
<span class="hljs-attr">model</span> = <span class="hljs-string">"gpt-5"</span>
<span class="hljs-attr">model_reasoning_effort</span> = <span class="hljs-string">"high"</span>
<span class="hljs-attr">disable_response_storage</span> = <span class="hljs-literal">true</span>
<span class="hljs-section">[model_providers.openai-chat-completions]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"OpenAI using Chat Completions"</span>
<span class="hljs-attr">base_url</span> = <span class="hljs-string">"https://api.openai.com/v1"</span>
<span class="hljs-attr">wire_api</span> = <span class="hljs-string">"chat"</span>
<span class="hljs-attr">env_key</span> = <span class="hljs-string">"OPENAI_API_KEY"</span>
<span class="hljs-section">[model_providers.mistral]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"Mistral"</span>
<span class="hljs-attr">base_url</span> = <span class="hljs-string">"https://api.mistral.ai/v1"</span>
<span class="hljs-attr">wire_api</span> = <span class="hljs-string">"chat"</span>
<span class="hljs-attr">env_key</span> = <span class="hljs-string">"MISTRAL_API_KEY"</span>
<span class="hljs-section">[model_providers.packycode]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"packycode"</span>
<span class="hljs-attr">base_url</span> = <span class="hljs-string">"https://oai-api.fkclaude.com/v1"</span>
<span class="hljs-attr">wire_api</span> = <span class="hljs-string">"responses"</span>
<span class="hljs-attr">env_key</span> = <span class="hljs-string">"packycode"</span>
</code></pre>
<p>配置项较多，对其他配置项感兴趣的小伙伴可以自行了解。</p>
<h3 data-id="heading-17">Chat对话</h3>
<p>启动Codex CLI聊天界面如下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b13265f62fe64735b6d37ce9cfa34eab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=iDdjd22tQujru1qtaPNoRi%2FyQ6Y%3D" alt="图片" loading="lazy"/></p>
<p>在光标处输入提示词即可使用Codex CLI处理任务</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2028a5c451ca4f3bbaa4d442f00c0c74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=U7PI%2BmP67m9OqMiBlumNou00pIw%3D" alt="图片" loading="lazy"/></p>
<p>输入 / 快捷键，可以查看交互式命令列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e60dace2ae854566907e93af50ad982b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=gveSCvvDQ0SSPFgIFlKlD0mRpF8%3D" alt="图片" loading="lazy"/></p>
<p>输入 @ 快捷键或者使用 /mention 交互指令可以引文件上下文，这里有个不太友好的地方，需要输入内容才会进行文件匹配，而且不支持文件夹引入。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c117e6c2532c4f47a64f3e569dd86111~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=rIHyunevHD1NXkoHK2BB0VVQ6Ec%3D" alt="图片" loading="lazy"/></p>
<p>Codex CLI也支持图像上下文引入，输入提示词可对图像进行分析等操作</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8e4ce16a6d94285ad924b53e174f5d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=XdYCn4ERYVuUBxbk5YwUsw2s3bI%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a0cdf8edb424352ac048287baf9fc7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=8aMbx7q2Tt1RwCjt8Ks44ab8qCE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-18">记忆文件</h3>
<p>在执行 /init 命令之前，我们需要先确定当前工作区的操作权限，Codex CLI不像Gemini CLI和Claude Code CLI需要权限时会询问，也没有提供切换模式的功能，因此我们需要创建或者编辑等权限时需要提前为工作区授权。</p>
<p>我们可以使用交互式指令 /approvals 切换授权模式，工作区默认为只读模式</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0992317e086f49169c1adaa497cca3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=TZMmYI2cmlK5fV3QauLWyqbHI4Y%3D" alt="图片" loading="lazy"/></p>
<p>授权完成后，执行 /init 命令创建记忆文件，Codex CLI会先输出一个记忆文件的要求和建议清单，不知道如何写的小伙伴可以按照清单提示编写</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b60d2912d2d846d8a1a12afd291be60e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=BtUGPzlwW8SkIAPzjiDLh67A%2FfU%3D" alt="图片" loading="lazy"/></p>
<p>整理完成后，Codex CLI会将记忆文件内容输出到 AGENTS.md 文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/776c755b4d1246b0a4921b1bb4e2defb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=vo1PJOYRQsDQJtBQr%2F89aNaaBac%3D" alt="图片" loading="lazy"/></p>
<p>创建完成后，可以看到工作区根目录下会多一个 AGENTS.md 文件，内容和建议的记忆文件清单格式也是对照的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1d59ddf77ce470082097bcf9cbf0936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=ZKD2qR2JkFo0u9xzgYhOgEqncno%3D" alt="图片" loading="lazy"/></p>
<p>当然我们也可以修改和自己手动创建记忆文件，例如这里我可以让Codex CLI对话输出内容以中文形式展示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28c0d703a4d245bdaf0074fe884f88aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=AdEP8PduceT1q8Pw2Vfnc1haZfA%3D" alt="图片" loading="lazy"/></p>
<p>重启Codex CLI，再次输入对话，可以看到此时Codex CLI就会以中文输出内容</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/698195218c4a4a9b83edbdb4d8053ca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=Fmy9DTFzAFSqObpZugikuSNOlmg%3D" alt="图片" loading="lazy"/></p>
<p>也可以新建 ~/.codex/AGENTS.md 全局记忆文件，不过Codex好像对用户级记忆文件支持的不是很好</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f7642dc1641498a9fc7ef874da0bacc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=%2BB4kFLvZvksNkilWrBd9mw1gFzw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-19">MCP服务</h3>
<p>Codex CLI支持MCP服务功能并提供了一系列MCP命令行工具，在命令行终端输入 codex mcp --help 可以查看MCP相关命令</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aebb8c847d684fe0bfbefd469b135350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=De%2Frnm%2Bt%2BTATcmChyIgNdDqoKvI%3D" alt="图片" loading="lazy"/></p>
<p>命令行工具：</p>
<ul>
<li>serve：运行 Codex MCP 服务器（标准输入输出传输）</li>
<li>list：列出已配置的 MCP 服务器</li>
<li>get：显示已配置的 MCP 服务器的详细信息</li>
<li>add：添加全局 MCP 服务器条目</li>
<li>remove：删除全局 MCP 服务器条目</li>
</ul>
<p>以context7为例，在命令行输入如下指令安装</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>codex mcp add context7 npx -y <span class="hljs-variable">@upstash</span>/context7-mcp
</code></pre>
<p>安装成功后使用 codex mcp list 查看已安装的MCP</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b917864550bc4bd692d474e570ec4fa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=qY8bsd5YNYrzqJ9Hv2IQYaJTw9k%3D" alt="图片" loading="lazy"/></p>
<p>在 ~/.codex/config.toml 全局配置文件中可以看到已添加到MCP服务配置信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c99304f04d724801afa7795d6c1c94e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=w7%2FDJhpD%2FsJWJjYORuCqiXHCjmY%3D" alt="图片" loading="lazy"/></p>
<p>使用命令 codex mcp get context7 查看指定MCP的配置信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23572f9abcfe492490c64f8fad3f6507~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=7iE%2F1IjEZ31C0ckCcDGNbb27Gug%3D" alt="图片" loading="lazy"/></p>
<p>也启动Codex CLI，使用交互式命令 /mcp 查看已安装MCP的工具信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0b92b33645c4bf9ac5c52f83a1e5a3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=RsHdNhR%2BMEtK9SByw2CRjTPHkAk%3D" alt="图片" loading="lazy"/></p>
<p>在Codex CLI中使用MCP服务和其他AI命令行终端一样，可以直接指定MCP调用，也可以等Agent判断自行调用即可。</p>
<pre><code class="hljs language-perl" lang="perl">查询React新特性，<span class="hljs-keyword">use</span> context7 
</code></pre>
<p>调用完成后效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7c8244275394a4eab3b71ee925d87e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=0kVZblHRcvtZSKTfjJfHucyX6No%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-20">自定义命令</h3>
<blockquote>
<p>注意事项：Codex CLI自定义命令目录必须是 prompts</p>
</blockquote>
<p>Codex CLI的自定义命令是存放在 ~/.codex/prompts/ 目录下以 .md 结尾的Markdown文件，这和Claude Code CLI是有些差异的。</p>
<p>这里以重构项目自定义命令为例，创建 ~/.codex/prompts/refactor.md 文件，输入提示词</p>
<pre><code class="hljs">按照业界的最佳实践以最高的标准，帮我重构这个项目的代码
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a102252d34d42a8b1e6af3373197e03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=IpvAGOhLhFbsp6gYJtD4KyE9fyk%3D" alt="图片" loading="lazy"/></p>
<p>重启Codex CLI，输入 /refactor 检索自定义命令</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3000de286b04446bcd91faac582a928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=muABCSHTPXC90DjrKrm7q9KzbG0%3D" alt="图片" loading="lazy"/></p>
<p>回车执行，Codex CLI就会按照要求创建任务计划开始执行</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08aaae3b653d44b8a08e24baaff279d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=oELZIkYc7Gy%2F%2Fg3bDhKKZHUSlP0%3D" alt="图片" loading="lazy"/></p>
<p>在Codex CLI 0.44 版本提供了对带参自定义命令的支持，主要提供了 位置参数 和 命名参数 2种自定义命令参数方式</p>
<h4 data-id="heading-21">1）位置参数</h4>
<p>和Claude Code CLI的动态位置参数一样，Codex CLI也支持通过 $+数字 形式的动态取值方式获取外部传递的参数，以获取天气信息为例，创建 ~/.codex/prompts/weather.md</p>
<pre><code class="hljs language-bash" lang="bash">帮我查看一下 <span class="hljs-variable">$1</span> 在 <span class="hljs-variable">$2</span> 这一天的天气
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f913acde3ba84415b4cdb30adf783488~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=AUS4NLo4%2BolO87I%2FpydJ%2BaEs1rU%3D" alt="图片" loading="lazy"/></p>
<p>重启Codex CLI，输入命令</p>
<pre><code class="hljs language-bash" lang="bash">/prompts:weather 北京 明天
</code></pre>
<p>可以看到Codex CLI准确获取了我们传递的参数并补全了提示词</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a764a045c264c91b3aabec48346d51f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=0F31x07t0tZSCbaRqZhytNoZLSk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-22">2）命名参数</h4>
<p>命名参数（name arguments）是Codex CLI提供的独特的另一种动态传递参数的方式 ，还是以获取天气信息为例，创建 ~/.codex/prompts/weather_with_named.md</p>
<pre><code class="hljs language-bash" lang="bash">帮我查看一下 <span class="hljs-variable">$CITY</span> <span class="hljs-variable">$DATE</span> 的天气
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4ae3e4ec41c450c8790379871662d7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=MtN%2F0iHlkK5asexnKratJVtBoRk%3D" alt="图片" loading="lazy"/></p>
<p>重启Codex CLI，输入命令 /weather_with_named 回车，Codex CLI会自动补全参数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e46ccd15009b495498a57e2b9575a84e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=h1YjlF9ITwigAYHTz%2Bgpn%2B8gPHU%3D" alt="图片" loading="lazy"/></p>
<p>填写对应的参数执行</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb4e0e90205c42deb2638f1a10f41ff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=w%2B1XbfdCVLpU7%2FsMj028Siqe%2FFg%3D" alt="图片" loading="lazy"/></p>
<p>这里有个注意事项，占位参数名必须为全大写，如果写成小写将无法识别</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51fad0863b554567865f58f943db4063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=E6aJsyKTTKQ1VuBU4GOhHjd0q2k%3D" alt="图片" loading="lazy"/></p>
<p>可以看到改成小写的命名参数无法被识别，无法自动补全</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d5b5a18f9b94a0da557737935ed17e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=j2WJmDCK33RGOuGaN%2BBsvRVpq58%3D" alt="图片" loading="lazy"/></p>
<p>即使手动补全也无法正常使用</p>
<pre><code class="hljs language-bash" lang="bash">/prompts:weather_with_named city=<span class="hljs-string">"北京"</span> <span class="hljs-built_in">date</span>=<span class="hljs-string">"明天"</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bdc29132d7f442cb80a6db7436cc108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=UrrGaqiFFiTN%2BZu8Vu4gGLOzlQk%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-23">产品定价</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d98191031e1446b86e01d997e163e48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906662&amp;x-signature=rS1uDOI8bAqVAwhNgkU9lC3x1hM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-24">总结</h2>
<p>我这次体验Codex CLI使用的是佬友提供的免费中转站，过程中没有遇到使用官方API Key的一些限制所以没有记录问题，以后遇到再做补充。Codex CLI整体体验下来感觉是比Gemini CLI、Claude Code CLI功能上要少很多，主要包括：</p>
<ul>
<li>Codex CLI不支持项目级别授权方式配置</li>
<li>授权、MCP等配置文件只支持用户(全局)配置</li>
<li>没有Chat和Agent模式切换，不会询问权限，只能通过设置工作区权限模式来达到 auto-accept 的效果</li>
<li>只支持项目记忆文件，不支持全局记忆文件</li>
<li>不支持自定义hooks</li>
<li>mcp只支持stdio类型，sse和http需要借助三方工具</li>
</ul>
<p>虽然Codex CLI在功能上还不够完善，但是随着Claude Code的限制，GPT5的热度和含金量还在上升，加上最近ChatGPT出了gpt-5-codex模型，Codex CLI还是值得入手的。</p>
<h2 data-id="heading-25">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzXSO25j79cv3ng47d-axLA" target="_blank" title="https://mp.weixin.qq.com/s/zXSO25j79cv3ng47d-axLA" ref="nofollow noopener noreferrer">Codex CLI初体验</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzXSO25j79cv3ng47d-axLA" target="_blank" title="https://mp.weixin.qq.com/s/zXSO25j79cv3ng47d-axLA" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE Friends 落地济南！首场线下活动圆满结束]]></title>    <link>https://juejin.cn/post/7573193563044823094</link>    <guid>https://juejin.cn/post/7573193563044823094</guid>    <pubDate>2025-11-16T14:15:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573193563044823094" data-draft-id="7572525491539361834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE Friends 落地济南！首场线下活动圆满结束"/> <meta itemprop="keywords" content="Trae,Solo,人工智能"/> <meta itemprop="datePublished" content="2025-11-16T14:15:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE Friends 落地济南！首场线下活动圆满结束
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T14:15:00.000Z" title="Sun Nov 16 2025 14:15:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天在字节 <code>TRAE</code> 璐娜老师的帮助下，和宇航老师一起举办了 <code>TRAE Friends @ 济南</code> 的第一场活动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd769401cb9d4308ae34d89394aace0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=nPkZNIlo2Nd5Jc6pJbUyWUoT8LA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07263a900ae542d7b99c0ccb7743d825~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=ctotoWha%2BL8epcPSSTPcsa%2FPk8w%3D" alt="" loading="lazy"/></p>
<p>虽然现场出现了一些计划外的状况，但还算圆满地完成了本次活动。</p>
<p>这是济南社区第一次举办类似活动，感谢各位伙伴的体谅与支持，后续，我们也会为大家策划更多、更有价值的活动。</p>
<h2 data-id="heading-0">活动内容</h2>
<p>整个活动从13:30开始，一直到17:30结束，包括：</p>
<ul>
<li>《TRAE SOLO 主题分享》 by TRAE Fellow 张宇航</li>
<li>《TRAE SOLO DEMO 演示》 by TRAE Fellow 董鹏飞</li>
<li>《TRAE使用心得 暨 后Claude时代TRAE的发展展望》 by 郑凯，山东传媒职业学院教师，人工智能专业负责人</li>
<li>《TRAE 在团队内的应用体会》 by 尹鹏，济南陌讯信息科技有限公司工程师</li>
<li>多位伙伴在开放麦环节做了个人使用心得的体会和分享</li>
</ul>
<p>整体活动内容还是非常充实的，也欢迎后续各位伙伴继续关注并参与进来。</p>
<h2 data-id="heading-1">我的分享</h2>
<p>在活动中，我做了《TRAE SOLO DEMO 演示》部分的分享。</p>
<p>为了更能与大家产生共鸣，DEMO 都是根据官方 DEMO 定位，结合实际场景设计的。</p>
<p>由于今天是第一次活动，为了保持分享的普适性，内容以基础为主，后续会根据不同的主题和需求，进行更加深入的内容分享。</p>
<p>分享内容整理如下，其中每个章节的特性是现场对应 <code>SOLO</code> 新特性的简要演示，可忽略。</p>
<h3 data-id="heading-2">大纲</h3>
<ul>
<li>CASE1：需求开发，从0到1搭建一个抽奖应用</li>
<li>CASE2：bug 修复，终端与对话的集成，内置浏览器的集成</li>
<li>CASE3：项目理解，接手旧项目的帮手</li>
</ul>
<h3 data-id="heading-3">CASE1：需求开发</h3>
<p><strong>背景</strong></p>
<p>背景比较简单，就是抽奖，我们设定为上传 Excel 的方式。</p>
<p>Excel 主要包括以下列：</p>
<ul>
<li>ID</li>
<li>姓名</li>
<li>手机号</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8e4b1407e334c9a83fb54bf68b27da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=VavT3YEua90%2F8yxU3uFdIANHJD4%3D" alt="" loading="lazy"/></p>
<p><strong>指令</strong></p>
<pre><code class="hljs language-shell" lang="shell">请在当前路径下帮我实现一个抽奖应用。 
<span class="hljs-meta prompt_"> 
 #</span><span class="bash"><span class="hljs-comment"># 业务</span></span> 
 客户上传一个excel，excel中包括ID、姓名、手机号三列，然后录入抽奖数量，并点击“抽奖”按钮，开启随机抽奖，抽奖过程添加动效。 
<span class="hljs-meta prompt_"> 
 #</span><span class="bash"><span class="hljs-comment"># 界面</span></span> 
 - 界面风格请与截图保持一致
 - 单一页面 
 - 尽量把元素呈现在首屏中，方便投屏展示 
 - 暂不使用后端服务 
<span class="hljs-meta prompt_"> 
 #</span><span class="bash"><span class="hljs-comment"># 技术</span></span> 
 - 在当前目录使用vue3 cli 初始化项目工程
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6acb7031d0940fea5ef45e73688683d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=PI3DfalP0wCiHSTbH04TzA2AhYc%3D" alt="" loading="lazy"/></p>
<p><strong>特性</strong></p>
<ul>
<li>任务总结与摘要</li>
<li>Tools Panels</li>
<li>上下文总结与压缩</li>
<li>TO-DO List</li>
<li>Subagent</li>
</ul>
<h3 data-id="heading-4">CASE2：bug 修复</h3>
<p><strong>终端与对话的集成</strong></p>
<p>后台在终端里面的编译错误，可以直接添加到对话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31ba96873bf64c85ae9376cb3d8ca1e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=L8jBHm3ENoJRY1n5LX%2BRKHKKqlM%3D" alt="" loading="lazy"/></p>
<p><strong>内置浏览器</strong></p>
<p>内置浏览器中，选择元素，更加精准的修复界面问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5cbe5b60c5a4b4aa8d9fac6f826e888~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=d%2BnUiNkBMQsoU%2FJjwBOcckxQa1U%3D" alt="" loading="lazy"/></p>
<p><strong>问答修复</strong></p>
<p>当然，所有出现的bug，都可以通过 <code>Chat</code> 方式修复。</p>
<p><strong>特性</strong></p>
<ul>
<li>Multi Task</li>
<li>代码差异</li>
</ul>
<h3 data-id="heading-5">CASE3：项目理解</h3>
<p>使用了很多人都比较熟悉的若依前后端项目源码进行分析，已经提前下载好了。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs language-bash" lang="bash">我想学习这个项目，以方便之后进行二次开发。我对前端比较熟悉，但是对于cli相关逻辑，以及服务端相关命令不太了解。
请详细分析这个项目结构，并且补充背景知识，帮助我了解和学习这个项目。以markdown+ mermaid 形式，输出到.trae/documents 文件夹下，可以有多个文件。
</code></pre>
<p><strong>过程</strong></p>
<p>采用了 SOLO Coder 智能体，选择了 Plan 模式。</p>
<p>先是规划了项目分析的计划，并形成了一份参考文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/106b1a208f65400bb3210355a6f9f105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=ClbMgGoTwPHKoaP%2BcZR1FJEJDD4%3D" alt="" loading="lazy"/></p>
<p>确认执行后，会生成非常详细的学习文档。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21a009291a2d4600a58a64256d3d8e44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763907306&amp;x-signature=%2FDr7I6vRvcdCNAmGI8683Sl0Oso%3D" alt="" loading="lazy"/></p>
<p><strong>特性</strong></p>
<ul>
<li>SOLO Coder</li>
<li>Plan</li>
</ul>
<h2 data-id="heading-6">交流内容整理</h2>
<p>现场交流了几个问题，感觉比较典型，这里整理下，希望可以启发到有需要的人。</p>
<p>由于是现场回答，可能不那么严密，大家按需理解，也欢迎留言或者社区群里接着交流。</p>
<h3 data-id="heading-7">AI 针对大项目如何处理</h3>
<p>现在模型的上下文虽然有很大提升，但依然存在上线，尤其是针对已存在多年的旧项目，很多时候直接分析的结果并不好。</p>
<p>最推荐的思路还是<strong>人工指导划分子模块</strong>，方便模型可以准确处理各个子模块，后续再通过 AI 进行汇总。</p>
<p>另一个思路是参考 <code>Qoder</code> 引入的 <code>Wiki</code> 特性，具体技术还没有研究，大家可以自行搜索了解。</p>
<h3 data-id="heading-8">TRAE 在非编程领域的应用</h3>
<p>虽然 <code>TRAE</code> 的定位是 <code>Coding Agent</code>，但它可以提效的场景远不止 <code>Coding</code> 领域。</p>
<p>工程组织、上下文管理、各类工具、自定义智能体等特性可以非常方便的<strong>应用到各种场景</strong>。</p>
<p>比如，我根据自己的需要，做了个“写作智能体”，负责帮我审查我的文章、提供灵感、润色不通顺的语句。</p>
<h3 data-id="heading-9">TRAE 对于产品经理的应用场景</h3>
<p>大家比较熟悉的产品经理应用场景应该是：<strong>快速生成demo原型系统</strong>。</p>
<p>而我平时还有两个应用场景：</p>
<ul>
<li>根据代码生成<strong>项目汇报文档素材</strong>，准确，还与最新代码同步。</li>
<li>通过 Code 为你设计<strong>测试用例</strong>、或者<strong>初步审查</strong>。</li>
</ul>
<h3 data-id="heading-10">编写AI指令/文档应该注意什么</h3>
<p>提示词很重要，但随着模型能力的提升，原有的很多提示词技巧已经内置到模型或者工具内了。</p>
<p>那现在的提示词还需要注意哪些呢？</p>
<p>我感觉比较重要的是：<strong>条理清晰/结构化</strong>。</p>
<p>整体的结构化，大家应该都明白，这里我分享两个具体的体会：</p>
<ul>
<li>不要出现某段<strong>内容归属模糊</strong>的情况，比如一个需求在多个模块中都有描述，但未说明哪个是主模块，哪个是依赖模块</li>
<li>各需求的<strong>篇幅应当和需求的重要程度正相关</strong>，不要为某个不重要但熟悉的需求编写大量内容，导致AI误判重要程度。</li>
</ul>
<h2 data-id="heading-11">结语</h2>
<p>好了，这次活动的自我总结也完成了。</p>
<p>准备考虑后续的活动了，也欢迎社区的伙伴发表各自的想法哈~</p>
<p>明天上班，各位加油！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++循环结构探微：深入理解while与do...while]]></title>    <link>https://juejin.cn/post/7572749797469519881</link>    <guid>https://juejin.cn/post/7572749797469519881</guid>    <pubDate>2025-11-16T14:45:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572749797469519881" data-draft-id="7572793505900298291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++循环结构探微：深入理解while与do...while"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-16T14:45:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++循环结构探微：深入理解while与do...while
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T14:45:46.000Z" title="Sun Nov 16 2025 14:45:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在C++编程中，循环是控制流程的基石，用于重复执行一段代码，直到满足特定条件。<code>while</code>和<code>do...while</code>是两种最基本的迭代结构，它们看似相似，但在语义和行为上存在关键差异。理解这些差异对于编写正确、高效和易于维护的代码至关重要。</p>
<hr/>
<h3 data-id="heading-0"><strong>第一章：<code>while</code>循环 - “先验”的迭代者</strong></h3>
<p><code>while</code>循环是一种<strong>前置条件</strong>循环。它首先评估条件，只有当条件为真时，才会执行循环体。</p>
<h4 data-id="heading-1"><strong>1.1 语法与执行流程</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">while</span> (condition) {
    <span class="hljs-comment">// 循环体：要重复执行的语句</span>
}
</code></pre>
<p><strong>执行流程：</strong></p>
<ol>
<li><strong>评估条件</strong>：计算<code>condition</code>表达式。如果结果为<code>true</code>（非零），继续步骤2；如果为<code>false</code>（零），循环终止，程序继续执行循环之后的代码。</li>
<li><strong>执行循环体</strong>：执行花括号<code>{}</code>内的所有语句。</li>
<li><strong>循环</strong>：完成循环体后，跳回步骤1，重新评估条件。</li>
</ol>
<p>这个流程形成了一个经典的“检查-执行”循环。</p>
<h4 data-id="heading-2"><strong>1.2 哲学与适用场景</strong></h4>
<p><code>while</code>循环的哲学是：<strong>“看不到绿灯，绝不前进”</strong>。它适用于那些<strong>可能一次都不需要执行</strong>的场景。</p>
<p><strong>经典用例：</strong></p>
<ul>
<li><strong>读取未知长度的输入</strong>：在读取文件或用户输入时，通常无法预先知道循环次数。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> value;
<span class="hljs-keyword">while</span> (std::cin &gt;&gt; value) { <span class="hljs-comment">// 当输入流有效时继续读取</span>
    <span class="hljs-comment">// 处理value</span>
}
</code></pre>
</li>
<li><strong>事件等待循环</strong>：等待某个外部条件成立（如硬件就绪、信号触发）。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">while</span> (!<span class="hljs-built_in">isDataReady</span>()) {
    <span class="hljs-comment">// 等待，或者进行一些其他工作</span>
}
</code></pre>
</li>
<li><strong>遍历链表等动态数据结构</strong>：
<pre><code class="hljs language-cpp" lang="cpp">Node* current = head;
<span class="hljs-keyword">while</span> (current != <span class="hljs-literal">nullptr</span>) {
    <span class="hljs-comment">// 处理当前节点</span>
    current = current-&gt;next;
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-3"><strong>1.3 潜在陷阱：无限循环</strong></h4>
<p>如果循环条件永远不为<code>false</code>，<code>while</code>循环将无限执行下去。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 警告：无限循环！</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    std::cout &lt;&lt; <span class="hljs-string">"This will print forever!\n"</span>;
}

<span class="hljs-type">int</span> count = <span class="hljs-number">10</span>;
<span class="hljs-comment">// 如果循环体内不修改count，这也将是无限循环</span>
<span class="hljs-keyword">while</span> (count &gt; <span class="hljs-number">0</span>) {
    std::cout &lt;&lt; <span class="hljs-string">"Oops! Count is still "</span> &lt;&lt; count &lt;&lt; <span class="hljs-string">"\n"</span>;
    <span class="hljs-comment">// 忘记写 count--;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-4"><strong>第二章：<code>do...while</code>循环 - “后验”的保证者</strong></h3>
<p><code>do...while</code>循环是一种<strong>后置条件</strong>循环。它首先无条件地执行一次循环体，然后再评估条件。</p>
<h4 data-id="heading-5"><strong>2.1 语法与执行流程</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">do</span> {
    <span class="hljs-comment">// 循环体：要重复执行的语句</span>
} <span class="hljs-keyword">while</span> (condition); <span class="hljs-comment">// 注意结尾的分号</span>
</code></pre>
<p><strong>执行流程：</strong></p>
<ol>
<li><strong>执行循环体</strong>：无条件地执行循环体内的语句。</li>
<li><strong>评估条件</strong>：计算<code>condition</code>表达式。如果结果为<code>true</code>，跳回步骤1；如果为<code>false</code>，循环终止。</li>
</ol>
<p>这个流程形成了一个“执行-检查”循环。</p>
<h4 data-id="heading-6"><strong>2.2 哲学与适用场景</strong></h4>
<p><code>do...while</code>循环的哲学是：<strong>“无论如何，先做一次再说”</strong>。它保证了<strong>循环体至少被执行一次</strong>。</p>
<p><strong>经典用例：</strong></p>
<ul>
<li><strong>菜单驱动程序</strong>：总是先向用户显示菜单，然后根据用户输入决定是否继续。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> choice;
<span class="hljs-keyword">do</span> {
    std::cout &lt;&lt; <span class="hljs-string">"1. Option A\n"</span>;
    std::cout &lt;&lt; <span class="hljs-string">"2. Option B\n"</span>;
    std::cout &lt;&lt; <span class="hljs-string">"3. Exit\n"</span>;
    std::cout &lt;&lt; <span class="hljs-string">"Enter your choice: "</span>;
    std::cin &gt;&gt; choice;

    <span class="hljs-comment">// 处理choice...</span>
} <span class="hljs-keyword">while</span> (choice != <span class="hljs-number">3</span>); <span class="hljs-comment">// 如果用户不选择3，则再次显示菜单</span>
</code></pre>
</li>
<li><strong>输入验证</strong>：确保用户至少输入一次有效数据。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> number;
<span class="hljs-keyword">do</span> {
    std::cout &lt;&lt; <span class="hljs-string">"Please enter a positive number: "</span>;
    std::cin &gt;&gt; number;
} <span class="hljs-keyword">while</span> (number &lt;= <span class="hljs-number">0</span>); <span class="hljs-comment">// 如果输入无效，要求重新输入</span>
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-7"><strong>第三章：核心差异与深度对比</strong></h3>






























<table><thead><tr><th align="left">特性</th><th align="left"><code>while</code> 循环</th><th align="left"><code>do...while</code> 循环</th></tr></thead><tbody><tr><td align="left"><strong>条件检查时机</strong></td><td align="left">循环<strong>开始前</strong></td><td align="left">循环<strong>结束后</strong></td></tr><tr><td align="left"><strong>最少执行次数</strong></td><td align="left"><strong>0次</strong></td><td align="left"><strong>1次</strong></td></tr><tr><td align="left"><strong>语法</strong></td><td align="left">不需要结尾分号</td><td align="left"><strong>必须</strong>有结尾分号</td></tr><tr><td align="left"><strong>适用性</strong></td><td align="left">条件可能初始为假的情况</td><td align="left">至少需执行一次，且依赖循环体结果的情况</td></tr></tbody></table>
<h4 data-id="heading-8"><strong>3.1 从代码到汇编：底层视角</strong></h4>
<p>在底层（汇编级别），编译器通常会将这两种循环转换为相似的条件跳转指令，但跳转的逻辑点不同。</p>
<ul>
<li><strong><code>while</code>循环的近似逻辑</strong>：
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">start:</span>
  <span class="hljs-keyword">if</span> (condition <span class="hljs-built_in">is</span> <span class="hljs-literal">false</span>) <span class="hljs-keyword">goto</span> <span class="hljs-keyword">end</span>;
  // 循环体代码
  <span class="hljs-keyword">goto</span> start;
<span class="hljs-symbol">end:</span>
</code></pre>
</li>
<li><strong><code>do...while</code>循环的近似逻辑</strong>：
<pre><code class="hljs language-csharp" lang="csharp">start:
  <span class="hljs-comment">// 循环体代码</span>
  <span class="hljs-keyword">if</span> (condition <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>) <span class="hljs-keyword">goto</span> start;
</code></pre>
</li>
</ul>
<p>可以看到，<code>do...while</code>循环在结构上更紧凑，它少了一次初始的条件跳转。这在某些情况下可以带来微小的性能优势，因为减少了一次分支预测。</p>
<hr/>
<h3 data-id="heading-9"><strong>第四章：最佳实践与陷阱规避</strong></h3>
<h4 data-id="heading-10"><strong>4.1 选择循环的原则</strong></h4>
<ol>
<li><strong>首选<code>while</code></strong>：在大多数情况下，特别是当循环可能为零次时，<code>while</code>是更安全、更直观的选择。</li>
<li><strong>需要至少一次执行时，使用<code>do...while</code></strong>：当逻辑上要求代码块必须先运行一次时，<code>do...while</code>能准确表达你的意图，使代码更清晰。</li>
<li><strong>避免在<code>do...while</code>中声明变量</strong>：在<code>do</code>块中声明的变量在条件部分不可见，这可能导致错误。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">do</span> {
    <span class="hljs-type">int</span> x = <span class="hljs-number">5</span>;
    <span class="hljs-comment">// ...</span>
} <span class="hljs-keyword">while</span> (x &gt; <span class="hljs-number">0</span>); <span class="hljs-comment">// 错误！x的作用域仅限于do块内</span>
</code></pre>
正确的做法是在循环外声明变量。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> x;
<span class="hljs-keyword">do</span> {
    x = <span class="hljs-number">5</span>;
    <span class="hljs-comment">// ...</span>
} <span class="hljs-keyword">while</span> (x &gt; <span class="hljs-number">0</span>);
</code></pre>
</li>
</ol>
<h4 data-id="heading-11"><strong>4.2 通用循环设计建议</strong></h4>
<ul>
<li><strong>确保循环终止</strong>：总是检查循环条件是否最终会变为<code>false</code>。</li>
<li><strong>警惕浮点数条件</strong>：由于精度问题，使用<code>float</code>或<code>double</code>作为循环条件可能导致意外结果。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">double</span> d = <span class="hljs-number">0.0</span>;
<span class="hljs-keyword">while</span> (d != <span class="hljs-number">1.0</span>) { <span class="hljs-comment">// 危险的比较！</span>
    d += <span class="hljs-number">0.1</span>;
    <span class="hljs-comment">// 由于浮点误差，d可能永远不会精确等于1.0</span>
}
</code></pre>
应使用范围比较：
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">while</span> (d &lt; <span class="hljs-number">1.0</span>) {
    d += <span class="hljs-number">0.1</span>;
}
</code></pre>
</li>
<li><strong>使用<code>{}</code>明确作用域</strong>：即使循环体只有一条语句，也使用花括号，这能增强可读性并避免悬垂else等问题。</li>
</ul>
<hr/>
<h3 data-id="heading-12"><strong>第五章：性能考量（现代编译器优化）</strong></h3>
<p>在现代C++编译器中，对于简单的循环，<code>while</code>和<code>do...while</code>的性能差异通常可以忽略不计。编译器强大的优化器（如尾调用优化、循环展开、代码移动等）会生成高度优化的机器码。</p>
<p>性能优化的关键通常不在于选择哪种循环，而在于：</p>
<ul>
<li><strong>减少循环内部的冗余计算</strong>。</li>
<li><strong>优化循环体内的算法和数据结构访问模式</strong>（如缓存友好性）。</li>
<li><strong>在适当的时候使用<code>++i</code>而非<code>i++</code></strong>（对于自定义类型）。</li>
</ul>
<p>因此，在绝大多数场景下，<strong>代码的正确性和可读性应优先于对循环类型进行的微观优化</strong>。</p>
<hr/>
<h3 data-id="heading-13"><strong>结论</strong></h3>
<p><code>while</code>和<code>do...while</code>是C++中相辅相成的两种循环工具。</p>
<ul>
<li><strong><code>while</code></strong> 是你谨慎的伙伴，它坚持“先检查，后行动”的原则，适用于那些需要前置验证的场景。</li>
<li><strong><code>do...while</code></strong> 是你果断的伙伴，它奉行“先行动，后反思”的策略，在保证至少一次执行的情况下非常有用。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在富阳银湖成立地域化的软件研发团队]]></title>    <link>https://juejin.cn/post/7572749797469536265</link>    <guid>https://juejin.cn/post/7572749797469536265</guid>    <pubDate>2025-11-16T14:46:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572749797469536265" data-draft-id="7572880767584403507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在富阳银湖成立地域化的软件研发团队"/> <meta itemprop="keywords" content="程序员,创业,前端"/> <meta itemprop="datePublished" content="2025-11-16T14:46:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="欧雷殿"/> <meta itemprop="url" content="https://juejin.cn/user/2670050655615806"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在富阳银湖成立地域化的软件研发团队
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2670050655615806/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    欧雷殿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T14:46:25.000Z" title="Sun Nov 16 2025 14:46:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着 11 月的到来，银湖创联也已步入它生命进程中的第二阶段。</p>
<p>与混沌初开，一切以「先跑起来再说」为主旋律的第一阶段相比，当前阶段的主旋律，或者说核心目标是——通过简单的规则和治理单元，形成自组织、自生长的系统。</p>
<p>作为社区的发起人兼主理人，我这几天在很适合移动办公的瑞咖啡里对之前一些较为零星散乱的想法进行梳理，有了一个初步的清单。</p>
<p>打算进一步讨论完善后，召开一次宣讲会，与心系社区的人之间来一场即时的答疑与反馈，他们同时也是新阶段的第一批潜在合作者。</p>
<p>然而在那之前，清单中的一项完全可以立马就行动起来，也就是本文的主题。</p>
<h2 data-id="heading-0">软件开发小组成立</h2>
<p>在「小雇·全国自由职业者大会·杭州站」上进行的主题分享《<a href="https://juejin.cn/post/7563301071173107750" target="_blank" title="https://juejin.cn/post/7563301071173107750">典型程序员跨界做在地社区是怎样一种体验？</a>》中，临结束时有这样一段：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60272e8d14654bc5b17290891458e905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qyn6Zu35q6_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763909185&amp;x-signature=EuU5KPljqMCsdEiYXYayGo8aaUA%3D" alt="ppt.png" loading="lazy"/></p>
<p>三个主要价值点中的第一个，它是：</p>
<ul>
<li>最表层的——大家有直观感受的，很容易想到和理解的；</li>
<li>最基础的——是实现并发挥另外两个价值点的基石，它们比较有前瞻性、创新性，解释成本更高，但落地后的价值不可估量。</li>
</ul>
<p>用更通俗点的说法，第一个价值点是以在地自由职业者为引，通过相互连接重建以信任为基础的新型熟人社会，并展现了通过自由职业实现自我价值的可行性。</p>
<p>再依托于信任关系、个人专业性去探索区域内可自循环的消费服务体系、商业模式，并借助更加一体化、数智化的手段提升区域内信息与资源流通的效率和体验。</p>
<p>另外两个价值点，要么完全依赖于软件开发，要么跟软件开发也很有关系。</p>
<p>在过往的社区活动中，多次参加活动进行交流且以软件开发作为职业的人，算我在内目前有三人：</p>
<ul>
<li>我，数智生活领域独立开发者，前端开发出身，擅长抽象，一直想要解决数据所有权与控制权、一体化和数智化问题；</li>
<li>一个 XR、3D 开发者，擅长虚拟世界与现实世界通过某种形式在图形上进行融合；</li>
<li>一个从良渚搬过来的 AI 连续创业者，想做数智化、游戏化的人生系统。</li>
</ul>
<p>由此可见，我们仨的共同点：</p>
<ul>
<li>侧重有所不同，但都是软件开发者；</li>
<li>擅长不同方面，但想解决的问题都可归为「元宇宙」；</li>
<li>都生活在银湖。</li>
</ul>
<p>既然如此，那我们为啥不凝聚在一起，成立「银湖软件开发小组」呢？！</p>
<p>这样一来：</p>
<ul>
<li>对外——以小组作为统一的信息出入口，进行社区第三阶段要落地的线上系统的研发，承接来自银湖在地企业、商家、工作室/超级个体的软件研发需求；</li>
<li>对内——软件研发需求信息共享，适者弹性组队承包项目，按项目自行分配收益，也可以自行组队研发其他软件产品。</li>
</ul>
<p>简而言之，一方面我们组成了面向银湖在地潜在客户的软件研发专业团队，另一方面能够相互协作让想要开发的软件产品更快地落地并进行市场验证。</p>
<p>今天下午，我们相聚在其中一人家里，将自己的想法向他们描述，一番讨论后达成 2 个共识：</p>
<ol>
<li>可以成立「银湖软件开发小组」；</li>
<li>在进行「元宇宙」落地实验这件事上分头行动，即我先去做社区场景的线上系统，他们先做个人与家庭场景的设备与应用，然后再将关键数据打通而场景融合。</li>
</ol>
<p>没准儿事后回首，这就是另一个湖畔花园！</p>
<h2 data-id="heading-1">结语</h2>
<p>开篇提到的「完全可以立马就行动起来」的「清单中的一项」是「在地的以特定兴趣爱好/专业能力/业务领域为核心的垂直小团体」。</p>
<p>而「银湖软件开发小组」就是具体例子，也是银湖创联的第一个专项小组（小团体），但这肯定不是最后一个，还会有更多的垂直小团体相继成立！</p>
<p>除了从银湖创联中生长出来的垂直小团体外，也欢迎那些本来就存在且与银湖有千丝万缕联系的其他兴趣组（如「富Young·团趣社」）之类加入到银湖创联这个大网络中！</p>
<hr/>
<p>本文其他阅读地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fs.ourai.ws%2Fdailies%2Fmhkn4g3k%2F" target="_blank" title="https://s.ourai.ws/dailies/mhkn4g3k/" ref="nofollow noopener noreferrer">个人网站</a>｜<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5iQYN5bVyxo8Qsnc6oZGpQ" target="_blank" title="https://mp.weixin.qq.com/s/5iQYN5bVyxo8Qsnc6oZGpQ" ref="nofollow noopener noreferrer">微信公众号</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码重构与测试覆盖率提升实践 | 2025 年第 46 周草梅周报]]></title>    <link>https://juejin.cn/post/7572480736362283014</link>    <guid>https://juejin.cn/post/7572480736362283014</guid>    <pubDate>2025-11-16T13:04:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736362283014" data-draft-id="7573193563044708406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码重构与测试覆盖率提升实践 | 2025 年第 46 周草梅周报"/> <meta itemprop="keywords" content="GitHub,开源,单元测试"/> <meta itemprop="datePublished" content="2025-11-16T13:04:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草梅友仁"/> <meta itemprop="url" content="https://juejin.cn/user/3043088413495815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码重构与测试覆盖率提升实践 | 2025 年第 46 周草梅周报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3043088413495815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草梅友仁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:04:12.000Z" title="Sun Nov 16 2025 13:04:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a> 发布和更新，并在多个平台同步发布。如有更新，以博客上的版本为准。您也可以通过文末的 <code>原文链接</code> 查看最新版本。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>欢迎来到草梅周报！这是一个由草梅友仁基于 AI 整理的周报，旨在为您提供最新的博客更新、GitHub 动态、个人动态和其他周刊文章推荐等内容。</p>
<hr/>
<p>本周给 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth" ref="nofollow noopener noreferrer">草梅 Auth</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcmyr-template-cli" target="_blank" title="https://github.com/CaoMeiYouRen/cmyr-template-cli" ref="nofollow noopener noreferrer">cmyr-template-cli</a> 添加了测试覆盖率报告，可以更加清晰的衡量项目中测试覆盖的情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6429b2026c2b4394b1bff1be70ec83f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=kRaJXeTShwz%2B2N9SSoMBEnvrpx8%3D" alt="image-20251116191346533" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c033db655a344636a9487c2095766272~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=7TKy30RdSNdUjb1l7qpbR6PgL2k%3D" alt="image-20251116191354994" loading="lazy"/></p>
<p>虽然说测试覆盖率高其实并不能说明项目的测试用例就写的完备了，但也能在一定程度上显示项目的代码质量是否合格。</p>
<p>以这次重构的 cmyr-template-cli 为例。</p>
<p>在添加测试用例的同时，也对项目进行了一次重构。</p>
<p>主要是进行了代码的拆分，以避免单文件过大。</p>
<p>而在这之前，核心逻辑都在一个文件里，可超过 2000 行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b491a735112646bcb34251571c7c0361~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=QJM1Cy73UoGn0bG53J21Ku9TRLE%3D" alt="image-20251116191607102" loading="lazy"/></p>
<p>而现在经过拆分后，单个文件行数都在 500 行以下，初步达到要求。</p>
<p>最后，对拆分出来的函数编写测试用例，测试用例就直接放在原文件边上，这样也方便查看测试用例和被测函数的具体内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ace1ff397804c44b6ce8b1bc6be7957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=V1BgW9MSThno1UVIQyiCT9F26nI%3D" alt="image-20251116191843551" loading="lazy"/></p>
<p>在本地执行 <code>npm run test</code> 之后就可查看测试情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57c83ced948343889e2c73192056a007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=ELsjNRgJRJqwLWftjXnWYZKFnHM%3D" alt="image-20251116191910289" loading="lazy"/></p>
<p>在本地执行 <code>npm run coverage</code> 之后就是生成测试报告，可以查看测试覆盖率。</p>
<p>cmyr-template-cli 是 61%，算是勉强达到了及格线。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac9e08b12d4a48828d69d4aebf5e8364~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=vgBk46zuew3G%2FdVXnaSy94Tb3%2Bk%3D" alt="image-20251116192332337" loading="lazy"/></p>
<p>之后，就是将报告上传到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcodecov.io%2F" target="_blank" title="https://codecov.io/" ref="nofollow noopener noreferrer">Codecov</a> ，就可以在页面上看到覆盖率情况了。</p>
<p>当然，还可以在 GitHub Action 中添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcodecov%2Fcodecov-action" target="_blank" title="https://github.com/codecov/codecov-action" ref="nofollow noopener noreferrer">codecov-action</a>，以实现自动上报。</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">coverage</span> <span class="hljs-string">reports</span> <span class="hljs-string">to</span> <span class="hljs-string">Codecov</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">codecov/codecov-action@v5</span>
  <span class="hljs-attr">with:</span>
      <span class="hljs-attr">token:</span> <span class="hljs-string">${\{</span> <span class="hljs-string">secrets.CODECOV_TOKEN</span> <span class="hljs-string">}}</span>
</code></pre>
<hr/>
<p>在这次重构 cmyr-template-cli 的过程中，自然也是使用了 AI。</p>
<p>而提示词方面则参考了<a href="https://juejin.cn/post/7570630923710054452" target="_blank" title="https://juejin.cn/post/7570630923710054452">《我用 AI 重构了一段 500 行的屎山代码，这是我的 Prompt 和思考过程》</a> 。</p>
<p>应该说效果不错。</p>
<blockquote>
<p>提示词改动后如下：</p>
<p>你是一个资深的 TypeScript 架构师。请分析下面这段代码。</p>
<p>告诉我它做了几件主要的事情？（职责分析）
找出所有的副作用。
找出所有的纯逻辑。
评价它的可维护性和可测试性。</p>
<p>非常好。现在，请你只针对纯逻辑部分进行重构。</p>
<p>把这些逻辑，从原函数中提取出来，变成独立的、可导出的纯函数。
这些函数必须是纯的：不能有任何副作用。
使用 TypeScript，为这些新函数的入参和返回值，提供清晰的类型定义。</p>
<p>你现在是一个 QA 工程师。请使用 Vitest，为你刚才提取的函数，编写全面的单元测试用例。 必须覆盖所有边界情况，包括正常、异常、和边缘值。</p>
<p>干得漂亮。现在，我们来重构那个原始的函数/文件。</p>
<p>它现在唯一的职责是协调。
调用我们刚才创建的纯函数。
把所有的副作用清晰地编排起来。
使用 async/await，让异步流程更清晰，用 try/catch 处理错误。</p>
</blockquote>
<p>重构的目的还是为了更好的组织代码，而纯函数相比带副作用的函数，会更好编写测试用例。</p>
<p>因此，在重构的时候要优先考虑提取出纯函数逻辑，再编写副作用函数，这样一来无论是代码结构上，还是测试上都会更加友好。</p>
<p>后续，对 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth" ref="nofollow noopener noreferrer">草梅 Auth</a> 、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Frss-impact-server" target="_blank" title="https://github.com/CaoMeiYouRen/rss-impact-server" ref="nofollow noopener noreferrer">RSS Impact</a> 等项目也会做类似重构，以减少“屎山”代码。</p>
<blockquote>
<p>对 cmyr-template-cli 的重构不能说完全满意，但考虑到这项目之前就是个“屎山”代码，所以从结果来说也还算不错。</p>
</blockquote>
<hr/>
<p>近期研究了下 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftauri.app%2Fzh-cn%2F" target="_blank" title="https://tauri.app/zh-cn/" ref="nofollow noopener noreferrer">Tauri</a>，这是一个基于 JavaScript 和 Rust 的跨平台开发框架。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b72ff1b157643ae823ed557b8ccfb6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=ZNqvphAPMfVgVk0YIJBTRfFCqhQ%3D" alt="image-20251116193336658" loading="lazy"/></p>
<p>不仅支持 Linux、macOS、Windows 等桌面端，也支持 Android 和 iOS 等手机端。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe349b707fcd4f9694f043c68ce4710f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903052&amp;x-signature=2R9Yn3gvoTuV%2F7glPce%2B6n0jBs0%3D" alt="image-20251116193453883" loading="lazy"/></p>
<p>除此之外，考虑到 Tauri 还支持使用 Next.js 和 Nuxt 等全栈框架作为前端，因此用同一套代码开发出 Web 端也不是难事。</p>
<p>目前笔者已经在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Ftauri-template" target="_blank" title="https://github.com/CaoMeiYouRen/tauri-template" ref="nofollow noopener noreferrer">tauri-template</a> 中跑通了 Linux、macOS、Windows、Android 等环境的下的构建，如果有希望了解项目结构的，可以参考一下。</p>
<p>当然了，跨平台也不是没有代价的，从技术选型中看出，Tauri 并没有走原生开发那一套，而是选择了内嵌 webview ，通过前端技术来构建 UI。</p>
<blockquote>
<p>这一点跟 uni-app 存在类似的问题</p>
</blockquote>
<p>虽然说节约了原生开发的时间，但论性能的话，是比不上原生开发的（比如 Swift 和 Kotlin ），所以不适用于需要高性能 UI 的项目。</p>
<p>所以，如果项目真的很在意性能的话，那就选择原生开发；而如果需要跨平台，以及节约开发时间的话，Tauri 一定是个不错的选择。</p>
<h2 data-id="heading-1">GitHub Release</h2>
<h3 data-id="heading-2">cmyr-template-cli</h3>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcmyr-template-cli%2Freleases%2Ftag%2Fv1.42.0" target="_blank" title="https://github.com/CaoMeiYouRen/cmyr-template-cli/releases/tag/v1.42.0" ref="nofollow noopener noreferrer">v1.42.0</a> - 2025-11-15 20:20:31</h4>
<p>摘要:
版本 1.42.0 摘要：</p>
<p>新功能：</p>
<ul>
<li>重构核心模块结构</li>
<li>重构 GitHub 和 Docker 初始化功能，包含工作流和依赖管理</li>
</ul>
<p>Bug 修复：</p>
<ul>
<li>更新获取 npm 包版本的逻辑，支持提取语义版本号</li>
</ul>
<p>代码重构：</p>
<ul>
<li>重构工具函数结构</li>
<li>重构 git 相关功能和测试用例</li>
<li>重构 README.md 和贡献指南初始化逻辑，提取公共模板渲染函数</li>
</ul>
<h2 data-id="heading-4">最新 GitHub 加星仓库</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fdmca" target="_blank" title="https://github.com/github/dmca" ref="nofollow noopener noreferrer">CaoMeiYouRen starred dmca</a> - 2025-11-15 16:46:08
GitHub 存储库收录收到的 DMCA 删除通知文本。GitHub 不认可或采纳这些通知中的任何主张。通知中提及的用户在被证实有罪前均视为无辜。更多关于 DMCA 政策的信息可在 GitHub 官网查询。该存储库主要使用 DIGITAL Command 语言，获得 5868 个星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxfgryujk%2Fblivechat" target="_blank" title="https://github.com/xfgryujk/blivechat" ref="nofollow noopener noreferrer">CaoMeiYouRen starred blivechat</a> - 2025-11-10 20:23:56
这是一个用于 OBS 软件的 JavaScript 插件，能够模拟 YouTube 风格的评论栏显示 bilibili 直播平台的观众互动内容。该项目在 GitHub 上获得了 2525 个星标，表明其受欢迎程度较高。该工具主要面向使用 OBS 进行 bilibili 直播的主播，帮助他们以 YouTube 的界面风格展示观众评论。</li>
</ul>
<h2 data-id="heading-5">其他博客或周刊推荐</h2>
<h3 data-id="heading-6">阮一峰的网络日志</h3>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2025%2F11%2Fweekly-issue-373.html" target="_blank" title="http://www.ruanyifeng.com/blog/2025/11/weekly-issue-373.html" ref="nofollow noopener noreferrer">科技爱好者周刊（第 373 期）：数据模型是新产品的核心</a> - 2025-11-14 08:06:44</li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2025%2F11%2Fdoubao-seed-code.html" target="_blank" title="http://www.ruanyifeng.com/blog/2025/11/doubao-seed-code.html" ref="nofollow noopener noreferrer">国产大模型接入 Claude Code 教程：以 Doubao-Seed-Code 为例</a> - 2025-11-11 15:30:25</li>
</ul>
<h3 data-id="heading-7">阿猫的博客</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fameow.xyz%2Farchives%2Ftroubleshooting-full-disk-on-docker-linux-machines" target="_blank" title="https://ameow.xyz/archives/troubleshooting-full-disk-on-docker-linux-machines" ref="nofollow noopener noreferrer">Docker 服务器磁盘满排查思路</a> - 2025-11-11 16:43:23</li>
</ul>
<h3 data-id="heading-8">潮流周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F244%2F" target="_blank" title="https://weekly.tw93.fun/posts/244/" ref="nofollow noopener noreferrer">第 244 期 - 飞机飞过</a> - 2025-11-10 08:00:00</li>
</ul>
<h3 data-id="heading-9">二丫讲梵的学习周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.eryajf.net%2Fpages%2F713e30%2F" target="_blank" title="https://wiki.eryajf.net/pages/713e30/" ref="nofollow noopener noreferrer">学习周刊-总第 237 期-2025 年第 46 周</a> - 2025-11-13 22:05:23</li>
</ul>
<h2 data-id="heading-10">总结</h2>
<p>本周的更新和动态如上所示。感谢您的阅读！
您可以通过以下方式订阅草梅周报的更新：</p>
<ul>
<li><strong>博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a></li>
<li><strong>RSS</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Fweekly.xml" target="_blank" title="https://blog.cmyr.ltd/weekly.xml" ref="nofollow noopener noreferrer">草梅周报</a></li>
<li><strong>公众号</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Foss.cmyr.dev%2Fimages%2F20241025184516839-21n2ctv.png" target="_blank" title="https://oss.cmyr.dev/images/20241025184516839-21n2ctv.png" ref="nofollow noopener noreferrer">草梅友仁的后花园</a></li>
<li><strong>邮箱订阅</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flistmonk.cmyr.dev%2Fsubscription%2Fform" target="_blank" title="https://listmonk.cmyr.dev/subscription/form" ref="nofollow noopener noreferrer">草梅友仁的博客订阅</a></li>
</ul>
<h2 data-id="heading-11">往期回顾</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-45-caomei-weekly-caomei-auth-1-11-0-github-dependabot.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-45-caomei-weekly-caomei-auth-1-11-0-github-dependabot.html" ref="nofollow noopener noreferrer">草梅 Auth 1.11.0 发布与 GitHub 依赖安全更新 | 2025 年第 45 周草梅周报</a> - 2025-11-09 23:19:22</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-44-caomei-weekly-rss-impact-1-17-0-docker-migration.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-44-caomei-weekly-rss-impact-1-17-0-docker-migration.html" ref="nofollow noopener noreferrer">RSS Impact 1.17.0 发布与 Docker 服务器迁移经验 | 2025 年第 44 周草梅周报</a> - 2025-11-02 19:03:26</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-43-caomei-weekly-npm-security-update-and-thousand-stars-sandbox.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-43-caomei-weekly-npm-security-update-and-thousand-stars-sandbox.html" ref="nofollow noopener noreferrer">Npm 安全更新与千星沙箱 | 2025 年第 43 周草梅周报</a> - 2025-10-26 21:10:36</li>
</ul>
<p>本文作者：草梅友仁<br/>本文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-46-caomei-weekly-code-refactoring-test-coverage.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-46-caomei-weekly-code-refactoring-test-coverage.html" ref="nofollow noopener noreferrer">blog.cmyr.ltd/archives/20…</a><br/>版权声明：本文采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcreativecommons.org%2Flicenses%2Fby-nc-sa%2F4.0%2Fdeed.zh-hans" target="_blank" title="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" ref="nofollow noopener noreferrer">CC BY-NC-SA 4.0 协议</a> 进行分发，转载请注明出处！<br/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战]]></title>    <link>https://juejin.cn/post/7572480736362332166</link>    <guid>https://juejin.cn/post/7572480736362332166</guid>    <pubDate>2025-11-16T13:14:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736362332166" data-draft-id="7572480736362315782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-16T13:14:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gracker"/> <meta itemprop="url" content="https://juejin.cn/user/1816846860560749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1816846860560749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gracker
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:14:25.000Z" title="Sun Nov 16 2025 13:14:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文是 Android Perfetto 系列的第六篇，主要介绍 Android 设备上 120Hz 刷新率的相关知识。如今，120Hz 已成为 Android 旗舰手机的标配，本文将讨论高刷新率带来的优势和挑战，以及从系统角度解析 120Hz 的工作原理。</p>
<p>在过去的几年中，移动设备的屏幕刷新率经历了从 60Hz 到 90Hz，再到现在普遍的 120Hz 的演进过程。这种提升不仅带来了更流畅的视觉体验，也对系统架构和应用开发提出了新的要求。通过 Perfetto 工具，我们可以更直观地理解高刷新率设备上帧渲染的过程和性能表现。</p>

<h3 data-id="heading-0">本文目录</h3>
<ul>
<li><a href="#series" title="#series">系列文章目录</a></li>
<li><a href="#concepts" title="#concepts">基本概念</a></li>
<li><a href="#impl" title="#impl">系统实现与工作原理</a></li>
<li><a href="#pros-cons" title="#pros-cons">120Hz 的优势与挑战</a></li>
<li><a href="#thoughts" title="#thoughts">思考与展望</a></li>
<li><a href="#conclusion" title="#conclusion">结论</a></li>
<li><a href="#about" title="#about">关于我 &amp;&amp; 博客</a></li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-series" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-1">系列文章目录</h2>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F03%2F27%2FAndroid-Perfetto-101%2F%23%2FPerfetto-%25E7%25B3%25BB%25E5%2588%2597%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2024/03/27/Android-Perfetto-101/#/Perfetto-%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Android Perfetto 系列目录</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-01-What-is-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-01-What-is-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 1：Perfetto 工具简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-02-how-to-get-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-02-how-to-get-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 2：Perfetto Trace 抓取</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-03-how-to-analysis-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-03-how-to-analysis-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 3：熟悉 Perfetto View</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F02%2F08%2FAndroid-Perfetto-04-Open-Big-Trace-With-Command-Line%2F" target="_blank" title="https://www.androidperformance.com/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/" ref="nofollow noopener noreferrer">Android Perfetto 系列 4：使用命令行在本地打开超大 Trace</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F03%2F26%2FAndroid-Perfetto-05-Chorergrapher%2F" target="_blank" title="https://www.androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" ref="nofollow noopener noreferrer">Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F04%2F26%2FAndroid-Perfetto-06-Why-120Hz%2F" target="_blank" title="https://www.androidperformance.com/2025/04/26/Android-Perfetto-06-Why-120Hz/" ref="nofollow noopener noreferrer">Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F02%2FAndroid-Perfetto-07-MainThread-And-RenderThread%2F" target="_blank" title="https://androidperformance.com/2025/08/02/Android-Perfetto-07-MainThread-And-RenderThread/" ref="nofollow noopener noreferrer">Android Perfetto 系列 7 - MainThread 和 RenderThread 解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F05%2FAndroid-Perfetto-08-Vsync%2F" target="_blank" title="https://androidperformance.com/2025/08/05/Android-Perfetto-08-Vsync/" ref="nofollow noopener noreferrer">Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F11%2F12%2FAndroid-Perfetto-09-CPU%2F" target="_blank" title="https://www.androidperformance.com/2025/11/12/Android-Perfetto-09-CPU/" ref="nofollow noopener noreferrer">Android Perfetto 系列 9 - CPU 信息解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1oi82efE4D%2F%3Fvd_source%3D0c6d2191e785de0a36dc21a9da7e664e" target="_blank" title="https://www.bilibili.com/video/BV1oi82efE4D/?vd_source=0c6d2191e785de0a36dc21a9da7e664e" ref="nofollow noopener noreferrer">视频(B站) - Android Perfetto 基础和案例分享</a></li>
</ol>
<p>如果大家还没看过 Systrace 系列，下面是传送门：</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F05%2F26%2FAndroid_Systrace_0%2F%23%2F%25E7%25B3%25BB%25E5%2588%2597%25E6%2596%2587%25E7%25AB%25A0%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2019/05/26/Android_Systrace_0/#/%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Systrace 系列目录</a> ： 系统介绍了 Perfetto 的前身 Systrace 的使用，并通过 Systrace 来学习和了解 Android 性能优化和 Android 系统运行的基本规则。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F" target="_blank" title="https://www.androidperformance.com/" ref="nofollow noopener noreferrer">个人博客</a> ：个人博客，主要是 Android 相关的内容，也放了一些生活和工作相关的内容。</li>
</ol>
<p>欢迎大家在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">关于我</a> 页面加入微信群或者星球，讨论你的问题、你最想看到的关于 Perfetto 的部分，以及跟各位群友讨论所有 Android 开发相关的内容</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-concepts" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-2">基本概念</h2>
<h3 data-id="heading-3">什么是屏幕刷新率？</h3>
<p>屏幕刷新率是一个<strong>硬件</strong>概念，指的是屏幕每秒钟刷新显示内容的次数，单位是赫兹（Hz）。</p>
<ul>
<li>60Hz 屏幕：每秒刷新 60 次，每次刷新间隔约 16.67ms</li>
<li>90Hz 屏幕：每秒刷新 90 次，每次刷新间隔约 11.11ms</li>
<li>120Hz 屏幕：每秒刷新 120 次，每次刷新间隔约 8.33ms</li>
</ul>
<p>屏幕刷新率决定了显示设备能够展示的最高帧率，但屏幕只负责按固定频率显示内容，具体显示什么内容由软件系统决定。</p>
<h3 data-id="heading-4">什么是 FPS？</h3>
<p>FPS（Frames Per Second）是一个<strong>软件</strong>概念，指的是系统每秒生成多少帧内容提供给屏幕显示。</p>
<ul>
<li>60FPS：系统每秒生成 60 帧内容，每帧有约 16.67ms 的处理时间</li>
<li>90FPS：系统每秒生成 90 帧内容，每帧有约 11.11ms 的处理时间</li>
<li>120FPS：系统每秒生成 120 帧内容，每帧有约 8.33ms 的处理时间</li>
</ul>
<p>为了获得最佳的视觉体验，FPS 应该与屏幕刷新率匹配。如果 FPS 低于刷新率，会出现掉帧；如果 FPS 高于刷新率，多余的帧会被丢弃，造成资源浪费。</p>
<p>为了获得最佳的视觉体验，理想情况下 FPS 应该与屏幕刷新率匹配，但实际体验与内容类型和用户感知紧密相关：</p>
<ol start="0">
<li>
<p><strong>内容类型差异</strong>：</p>
<ul>
<li><strong>视频内容</strong>：电影（24fps）或视频（30fps）即使在 120Hz 屏幕上也能看起来流畅，这是因为视频内容包含自然运动模糊，且符合观看者对该媒介的预期</li>
<li><strong>交互式界面</strong>：而滑动列表、动画等交互场景对帧率要求更高，从 120fps 降到 110fps 都可能被用户感知为卡顿</li>
</ul>
</li>
<li>
<p><strong>帧率稳定性</strong>：稳定的低帧率（如稳定的 60fps）通常比不稳定的高帧率（如在 90-120fps 之间波动）体验更好</p>
</li>
<li>
<p><strong>系统行为</strong>：</p>
<ul>
<li>当 FPS 低于刷新率时，显示系统会复用帧或插入黑帧</li>
<li>当 FPS 高于刷新率时，多余的帧会被丢弃，造成计算资源浪费</li>
</ul>
</li>
</ol>
<p>不同应用场景有不同的流畅度标准，开发者需要根据应用类型选择合适的优化策略。</p>
<h3 data-id="heading-5">什么是 Vsync？</h3>
<p>Vsync（垂直同步）是将软件帧率与屏幕刷新率同步的机制，目的是避免画面撕裂现象。Android 系统中，Vsync 信号被用来触发应用渲染新一帧的时机，确保渲染过程与屏幕刷新周期保持一致。</p>
<h3 data-id="heading-6">为什么 120Hz 成为新标准？</h3>
<p>市场从 60Hz 到 90Hz，再到 120Hz 的演进有着明确的技术和用户体验驱动因素：</p>
<ol start="0">
<li><strong>更高的流畅度</strong>：120Hz 比 60Hz 提供了两倍的视觉信息，使滑动、动画等交互感觉更加流畅自然。</li>
<li><strong>减少延迟</strong>：输入事件到显示结果的延迟从 60Hz 的 16.67ms 减少到 120Hz 的 8.33ms，让用户操作反馈更及时。</li>
<li><strong>硬件支持成熟</strong>：现代移动处理器（如高通骁龙 8 系列、联发科天玑系列）已经有足够性能支持 120Hz 的稳定运行。</li>
<li><strong>电池技术进步</strong>：更高效的电池和电源管理技术缓解了高刷新率带来的功耗压力。</li>
<li><strong>可变刷新率技术</strong>：LTPO 等自适应刷新率技术允许设备在不同场景下智能切换刷新率，平衡流畅度和功耗。</li>
</ol>
<p>如今，120Hz 不仅是 Android 旗舰机型的标配，连 iOS 设备（iPhone 13 Pro 及以上）也已支持 120Hz 的 ProMotion 技术，标志着高刷新率已成为高端移动设备的基本特性。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-impl" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-7">系统实现与工作原理</h2>
<h3 data-id="heading-8">Perfetto 视角下的 120Hz 渲染流程</h3>
<p>在 120Hz 刷新率下，Android 系统的渲染流程没有本质变化，主要区别是每一帧的时间预算从 16.67ms 缩短到了 8.33ms ( <strong>当然这里没有讨论 App duration，如果 App Duration 配置大于 8.33ms，那么 App 的 UI + Render 在 App duration 区间完成都是可以的，注意 每个机器的 App Duration 配置不一样</strong>）。下图展示了 120Hz 环境下应用渲染的 Perfetto 追踪图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f88117e1039a49a3ab9cc6e027ca9b1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903665&amp;x-signature=nmEJ0NmNsVMUMw1TetMqUXPjebs%3D" alt="image.png" loading="lazy"/></p>
<p>在 120Hz 设备上，我们可以看到：</p>
<ol start="0">
<li><strong>Vsync 间隔</strong>：VSYNC 信号每 8.33ms 触发一次</li>
<li><strong>帧处理流程</strong>：每一帧的处理依然遵循 Input → Animation → Traversal 的顺序</li>
<li><strong>时间压缩</strong>：所有处理步骤必须在更短的时间内完成，对系统和应用性能要求更高</li>
</ol>
<p>上图中出现了两个 Buffer 相关的 Trace，这里做一个简单的说明：</p>
<ol start="0">
<li>
<p><strong>QueuedBuffer</strong>：（例如：QueuedBuffer - VRI[ImproveSnsTimelineUI]#748BLAST#748）</p>
<ul>
<li>这个 Trace Tag 是在 <strong>App 进程</strong>中打印的</li>
<li>表示应用完成一帧渲染后，将渲染好的 Buffer 放入队列准备提交给 SurfaceFlinger</li>
<li>在使用 BlastBufferQueue 的系统中，这个时刻标志着 RenderThread 完成渲染并准备将结果传输到系统服务</li>
</ul>
</li>
<li>
<p><strong>BufferTX</strong>：（例如：BufferTX - com.tencent.mm/com.tencent.mm.plugin.sns.ui.improve.ImproveSnsTimelineUI#47974）</p>
<ul>
<li>这个 Trace Tag 是在 <strong>SurfaceFlinger 进程</strong>中打印的</li>
<li>表示 SurfaceFlinger 接收到应用传来的 Buffer 并开始处理的时刻</li>
<li>TX 代表 "Transfer/Transmission"，即缓冲区的传输过程</li>
</ul>
</li>
</ol>
<p><strong>正确的流程应该是：</strong></p>
<ol start="0">
<li>App 的 RenderThread 调用 <code>queueBuffer</code>，此时 App 认为自己已交出一个 Buffer，于是 <code>QueuedBuffer</code> <strong>+1</strong>。</li>
<li>该 Buffer 被传输给 SF，SF 接收（latch/acquire）后，<code>BufferTX</code> <strong>+1</strong>。</li>
<li>SF 在未来的某个 Vsync 周期，使用这个 Buffer 完成合成并上屏。</li>
<li>当 SF 不再需要这个 Buffer 时（例如，它已经被新的帧替换，或者已稳定显示了足够长的时间），SF 会释放（release）这个 Buffer。</li>
<li>SF 释放 Buffer 后，<code>BufferTX</code> <strong>-1</strong>。同时，App 会收到 Buffer 已被释放的回调，此时 App 端的 <code>QueuedBuffer</code> <strong>才会 -1</strong>，表示这个 Buffer 已成功返回缓冲池，可被再次使用。</li>
</ol>
<p>Perfetto 同时也提供了 Buffer 追踪的功能，点击 App 上面的 Actual Timeline （这部分知识可以看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-01-What-is-perfetto%2F%23Vsync-App-%25E6%25B2%25A1%25E9%2582%25A3%25E4%25B9%2588%25E7%259B%25B4%25E8%25A7%2582" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-01-What-is-perfetto/#Vsync-App-%E6%B2%A1%E9%82%A3%E4%B9%88%E7%9B%B4%E8%A7%82" ref="nofollow noopener noreferrer">Actual Timeline 介绍</a>），就可以看到这个 Buffer 从生产到消费的全过程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d73eba6ea77e44338f6a4fac241bc20d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903665&amp;x-signature=G%2B3b%2F3vTLnT%2FkHzzvNjnNswj7XQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">支撑 120Hz 的系统架构优化</h3>
<p>要流畅地支持 120Hz 高刷新率，Android 系统架构做了不少<strong>调整和改进</strong>。这些变化涉及多个组件，也包括了对整个渲染管线的<strong>重要优化</strong>。下面我们来详细看看几个关键的技术点：</p>
<h4 data-id="heading-10">自适应刷新率技术</h4>
<p>现代 Android 设备采用多层次刷新率管理策略：</p>
<ul>
<li>
<p><strong>硬件层支持</strong>：LTPO（低温多晶氧化物）显示技术允许屏幕在 1Hz 到 120Hz 范围内精确调节刷新率，而非固定档位切换</p>
</li>
<li>
<p><strong>内容感知算法</strong>：系统通过分析屏幕内容类型自动调整刷新率：</p>
<ul>
<li>静态内容（阅读、图片浏览）：降至 10-30Hz</li>
<li>视频播放：匹配视频源帧率（通常 24-60Hz）</li>
<li>滚动和交互：提升至 90-120Hz</li>
<li>游戏：根据游戏引擎输出帧率动态调整</li>
</ul>
</li>
<li>
<p><strong>API 支持</strong>：Android 提供 <code>Surface.setFrameRate()</code> API，允许应用明确指定其首选帧率，系统会尽可能满足这一请求</p>
</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 应用可以指定首选帧率和刷新率行为</span>
surface<span class="hljs-selector-class">.setFrameRate</span>(<span class="hljs-number">60.0</span>f, Surface.FRAME_RATE_COMPATIBILITY_DEFAULT);
</code></pre>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-pros-cons" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-11">120Hz 的优势与挑战</h2>
<h3 data-id="heading-12">120Hz 带来的体验提升</h3>
<p>我拿到第一台120Hz手机的时候，最直观的感受就是：</p>
<ol start="0">
<li><strong>一切操作都变得更流畅</strong>：从桌面滑动、应用切换到刷微博，画面更新更频繁，内容跟随手指移动也更加精准。尤其在快速滑动朋友圈或微博feed流时，文字依然清晰可辨，而不是一片模糊。</li>
<li><strong>游戏体验大幅提升</strong>：玩《王者荣耀》或《和平精英》这类竞技游戏时，画面流畅度提升让我的操作精准度也跟着提高。在激烈对抗中，能提前8ms看到敌人动作，虽然时间很短，但确实能带来优势。</li>
<li><strong>眼睛疲劳感减轻</strong>：这点可能是个人感受，但长时间盯着120Hz屏幕确实比60Hz舒适，特别是阅读和滑动内容时，眼睛追踪内容的负担减轻了。</li>
<li><strong>触控体验更精准</strong>：120Hz不仅是显示更新快，触控采样率通常也会提高，让操作响应更及时，无论是打字还是精细控制都更准确。</li>
</ol>
<h3 data-id="heading-13">120Hz 面临的实际问题</h3>
<p>当然，高刷屏幕也带来了一系列技术挑战：</p>
<ol start="0">
<li><strong>功耗问题</strong>：实测中，同一台手机在120Hz模式下比60Hz大约多耗电15-20%。对于本就紧张的手机续航来说，这是不小的压力。</li>
<li><strong>开发门槛提高</strong>：原来在60Hz环境下勉强能跑的应用，到了120Hz可能就会显得卡顿。每帧只有8.33ms的处理时间，对开发者的代码效率提出了更高要求。</li>
<li><strong>发热增加</strong>：长时间运行高帧率游戏，手机发热明显比60Hz更严重，这不仅影响体验，还可能导致性能降频。</li>
<li><strong>应用适配并不完善</strong>：很多应用并未针对高刷做优化，即使在120Hz屏幕上，实际输出帧率可能还是60fps，浪费了屏幕潜力。</li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-thoughts" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-14">思考与展望</h2>
<h3 data-id="heading-15">按需调整：从 ProMotion 看刷新率的智能管理</h3>
<p>随着 120Hz 高刷新率逐渐成为旗舰手机的标配，一个值得思考的问题是：我们真的需要在所有场景下都保持 120Hz 的刷新率吗？</p>
<p>苹果的 ProMotion 技术实际上给出了一个更为合理的答案：只有在真正需要高感知度的动画场景下才激活高刷新率，而在其他场景则可以适当降低刷新率以节省电量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b509f6065b6c4fa6b9fad167ae3cefb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903665&amp;x-signature=rxhZ7aX9otiKcapPnhjCdTu0em0%3D" alt="image.png" loading="lazy"/></p>
<p>从上图可以看到，苹果在iOS开发文档中为不同类型的动画场景提供了非常精细的ProMotion帧率推荐配置：</p>
<ol start="0">
<li>
<p><strong>高影响力动画（High-impact animations）</strong> ：</p>
<ul>
<li>适用场景：全屏转场（如照片应用中点击缩略图展开）、第一人称游戏、Sheet弹出展示等</li>
<li>推荐帧率：80-120Hz，首选120Hz（CAFrameRateRange(minimum:80, maximum:120, preferred:120)）</li>
<li>使用建议：谨慎使用，仅在关键交互场景应用，以减少电量消耗</li>
</ul>
</li>
<li>
<p><strong>透明度/颜色过渡和微小移动</strong>：</p>
<ul>
<li>适用场景：开关状态变化、进度指示器旋转、背景模糊效果等</li>
<li>推荐帧率：使用系统默认帧率范围（CAFrameRateRange.default）</li>
<li>使用建议：这类动画不需要过高帧率，视觉效果差异不大</li>
</ul>
</li>
<li>
<p><strong>低速小动画</strong>：</p>
<ul>
<li>适用场景：时钟指针移动、缓慢进度条等</li>
<li>推荐帧率：根据动画速度，可选择8-15Hz、15-24Hz或30-48Hz不等</li>
<li>使用建议：低帧率在这些场景下视觉效果已足够好，同时可显著节省电量</li>
</ul>
</li>
<li>
<p><strong>其他所有情况</strong>：</p>
<ul>
<li>推荐使用系统默认帧率</li>
</ul>
</li>
</ol>
<p>这种精细化的帧率管理策略，不仅让系统能够在用户体验和电池寿命之间取得最佳平衡，也为开发者提供了明确的指导。相比于简单粗暴地全局使用120Hz，这种有针对性的帧率调整方案显然更加科学和高效。</p>
<h3 data-id="heading-16">电量与体验的权衡</h3>
<p>测试表明，将刷新率从 120Hz 降至 60Hz 可节省约 10-15% 的电量。智能地控制刷新率，能在保持良好用户体验的同时，显著延长电池续航时间。</p>
<p>120Hz 的主要价值在于提升交互流畅度和响应速度，而非始终保持高刷新率。更智能的做法是根据实际需求动态调整：<strong>在用户感知敏感的场景使用高刷新率，在用户感知不敏感的场景降低刷新率</strong>。</p>
<h3 data-id="heading-17">开发者的适配策略</h3>
<p>应用开发者应当意识到，并非所有内容都需要以最高帧率渲染。通过 Android 提供的 API（如 Surface.setFrameRate()），可以为不同内容类型指定合适的帧率，配合系统的自适应刷新率机制，共同达到最佳的性能与电量平衡。</p>
<p>总之，未来高刷新率技术的发展方向应该是更加智能、更加精细的自适应调节，而非简单地追求更高的数字。真正的技术进步是在用户无感知的情况下，在体验和能效之间找到最佳平衡点。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-conclusion" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-18">结论</h2>
<p>回顾过去几年高刷屏幕的发展，我认为120Hz确实是手机交互体验的一次重要跃升。虽然它带来了功耗和开发复杂性等挑战，但好处是显而易见的：更流畅的体验、更低的输入延迟、更自然的动画效果。</p>
<p>对于开发者而言，Perfetto这类工具让我们能够看清120Hz下的性能问题，有的放矢地进行优化。虽然从16ms减少到8ms的预算听起来很紧张，但事实上主流处理器已经有足够能力应对这个挑战。只要合理规划UI复杂度、避免主线程阻塞，流畅的120fps体验是完全可以实现的。</p>
<p>从趋势来看，我不认为手机屏幕刷新率会无限攀升。120Hz可能会在相当长的时间内成为标准，而未来的焦点将更多放在如何智能化地调整刷新率，在不同场景下找到体验和功耗的最佳平衡点。毕竟，我们追求的不是数字上的高，而是实际体验的好。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-about" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-19">关于我 &amp;&amp; 博客</h2>
<p>下面是个人的介绍和相关的链接，期望与同行的各位多多交流，三人行，则必有我师!</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">博主个人介绍</a> ：里面有个人的微信和微信群链接。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2019%2F12%2F01%2FBlogMap%2F" target="_blank" title="https://androidperformance.com/2019/12/01/BlogMap/" ref="nofollow noopener noreferrer">本博客内容导航</a> ：个人博客内容的一个导航。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2018%2F05%2F07%2FAndroid-performance-optimization-skills-and-tools%2F" target="_blank" title="https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools/" ref="nofollow noopener noreferrer">个人整理和搜集的优秀博客文章 - Android 性能优化必知必会</a> ：欢迎大家自荐和推荐 （微信私聊即可）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2023%2F12%2F30%2Fthe-performance%2F" target="_blank" title="https://www.androidperformance.com/2023/12/30/the-performance/" ref="nofollow noopener noreferrer">Android性能优化知识星球</a> ： 欢迎加入，多谢支持～</li>
</ol>
<blockquote>
<p><strong>一个人可以走的更快 , 一群人可以走的更远</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入探索剖析 JVM 的启动过程]]></title>    <link>https://juejin.cn/post/7572481101711507510</link>    <guid>https://juejin.cn/post/7572481101711507510</guid>    <pubDate>2025-11-16T13:19:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572481101711507510" data-draft-id="7573193563044741174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入探索剖析 JVM 的启动过程"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-16T13:19:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入探索剖析 JVM 的启动过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:19:30.000Z" title="Sun Nov 16 2025 13:19:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你可曾想过：当你在终端里敲下 <code>java</code>，在 <code>main</code> 方法真正运行之前，JVM 为了“创造一个可运行你的程序的宇宙”，到底经历了哪些步骤？从参数校验、系统资源探测，到选择垃圾回收器，再到类的加载、链接与初始化，这些看不见的过程决定了应用的启动体验与后续性能。本文用一个极简的 HelloWorld 贯穿全程，结合详细日志，一步步洞察 JVM 的启动机制，帮你在调试和性能优化时更有抓手。</p>
<h2 data-id="heading-0">1. 概览</h2>
<p>当我们运行一个 Java 应用时，JVM 在我们的代码真正开始执行之前，会先完成一系列复杂步骤。本文将从执行 <code>java</code> 命令的那一刻开始，一直走到应用就绪。</p>
<p>我们以一个简单的 HelloWorld 程序为例，拆解每一个阶段。理解这些内部机制能显著提升调试与性能调优的效果。</p>
<h2 data-id="heading-1">2. 从 <code>java</code> 命令到 JVM 启动</h2>
<p>在 JVM 执行任何代码之前，它需要先启动、校验输入并配置运行环境。下面按启动顺序走一遍早期流程：从调用 <code>java</code> 命令到初始化 JVM 运行时。</p>
<h3 data-id="heading-2">2.1. <code>java</code> 命令与初始调用</h3>
<p>当我们运行 <code>java</code> 命令时，JVM 启动序列会通过 JNI 方法 <code>JNI_CreateJavaVM()</code> 开始执行。该方法完成若干关键初始化任务，为执行 Java 应用准备环境。Java Native Interface（JNI）是 JVM 与原生系统库之间的桥梁，使 Java 与平台特性可以双向通信。</p>
<p>本文将使用详细日志观察 JVM 的内部运作，例如：</p>
<pre><code class="hljs language-bash" lang="bash">java -Xlog:all=trace HelloWorldCopy
</code></pre>
<h3 data-id="heading-3">2.2. 校验用户输入</h3>
<p>首先，JVM 会校验我们传入的参数：</p>
<pre><code class="hljs language-text" lang="text">[0.006s][info][arguments] VM Arguments:
[arguments] jvm_args: -Xlog:all=trace:file=helloworld.log 
[arguments] java_command: HelloWorld
[arguments] java_class_path (initial): .
[arguments] Launcher Type: SUN_STANDARD
</code></pre>
<p>JVM 会验证目标可执行、类路径以及任何 JVM 参数，确保它们在继续执行前都是有效的。这个步骤能尽早捕获很多常见配置错误，避免后续阶段出现更难定位的问题。</p>
<h3 data-id="heading-4">2.3. 检测系统资源</h3>
<p>接着，JVM 会识别可用的系统资源，例如处理器数量、内存大小以及关键系统服务：</p>
<pre><code class="hljs language-text" lang="text">[0.007s][debug][os       ] Process is running in a job with 20 active processors.
[os       ] Initial active processor count set to 20
[os       ] Process is running in a job with 20 active processors.
[gc,heap  ]   Maximum heap size 4197875712
[gc,heap  ]   Initial heap size 262367232
[gc,heap  ]   Minimum heap size 6815736
[os       ] Host Windows OS automatically schedules threads across all processor groups.
[os       ] 20 logical processors found.
</code></pre>
<p>这些信息会影响 JVM 的一些内部决策，比如默认选择哪个垃圾回收器。可用 CPU 数和总内存会直接影响 JVM 的启发式选择。不过，大多数设置都可以通过显式的 JVM 参数进行覆盖。在这个阶段，JVM 还会检查是否支持 Native Memory Tracking，并验证它可能依赖的各类操作系统工具的可用性。</p>
<h3 data-id="heading-5">2.4. 环境准备</h3>
<p>随后，JVM 会生成 HotSpot 性能数据。这些数据会被 JConsole、VisualVM 等工具用于检查和分析 JVM：</p>
<pre><code class="hljs language-text" lang="text">[perf,datacreation] name = sun.rt._sync_Inflations, dtype = 11, variability = 2, units = 4, dsize = 8, vlen = 0, pad_length = 4, size = 56, on_c_heap = FALSE, address = 0x000001f3085f0020, data address = 0x000001f3085f0050
</code></pre>
<p>这类性能数据通常存储在系统的 <code>/tmp</code> 目录下，并会在启动阶段的一段时间里持续生成，与其他初始化任务并行进行。</p>
<h2 data-id="heading-6">3. 加载、链接与初始化</h2>
<p>当 JVM 环境就绪后，它会开始为我们的程序执行做准备。</p>
<h3 data-id="heading-7">3.1. 选择垃圾回收器</h3>
<p>在 JVM 内部，一个关键步骤是选择垃圾回收器（GC）。截至 JDK 23，默认情况下 JVM 会选择 G1 GC，除非系统可用内存少于 1792MB 和/或仅有单处理器：</p>
<pre><code class="hljs language-text" lang="text">[gc               ] Using G1
[gc,heap,coops    ] Trying to allocate at address 0x0000000705c00000 heap of size 0xfa400000
[os               ] VirtualAlloc(0x0000000705c00000, 4198498304, 2000, 4) returned 0x0000000705c00000.
[os,map           ] Reserved [0x0000000705c00000 - 0x0000000800000000), (4198498304 bytes)
[gc,heap,coops    ] Heap address: 0x0000000705c00000, size: 4004 MB, Compressed Oops mode: Zero based, Oop shift amount: 3
[pagesize         ] Heap:  min=8M max=4004M base=0x0000000705c00000 size=4004M page_size=4K
</code></pre>
<p>当然，我们也可以选择其它 GC：如 Parallel GC、ZGC 等，具体可用与默认策略依不同 JDK 版本与发行版而异。</p>
<h3 data-id="heading-8">3.2. 加载 CDS（类数据共享）</h3>
<p>此时，JVM 会开始寻找进一步的优化机会。CDS 是一组已经经过预处理的类文件归档，可以改善 JVM 的启动性能：</p>
<pre><code class="hljs language-text" lang="text">[cds] trying to map [Java home]/lib/server/classes.jsa
[cds] Opened archive [Java home]/lib/server/classes.jsa
</code></pre>
<p>不过，CDS 正在被 Project Leyden 中的 AOT（提前）机制逐步替代，后文会继续讨论。</p>
<h3 data-id="heading-9">3.3. 创建方法区</h3>
<p>JVM 随后会创建“方法区”，这是一个用于存储类数据的特殊离堆内存区域。在 HotSpot 中，这一区域被称为 metaspace。当关联的类加载器不再可达时，存储于此的类数据也会被移除：</p>
<pre><code class="hljs language-text" lang="text">[metaspace,map    ] Trying anywhere...
[metaspace,map    ] Mapped at 0x000001f32b000000
</code></pre>
<p>虽然方法区不在堆中，但它仍由 GC 管理。</p>
<h3 data-id="heading-10">3.4. 类加载</h3>
<p>类加载包含三个步骤：定位二进制表示、根据其派生出类、并将其加载到方法区。正是这种动态加载能力，让 Spring、Mockito 等框架可以在运行期按需生成并加载类。</p>
<p>类加载有两种方式：引导类加载器（bootstrap class loader）或自定义类加载器。下面借助一个简单的 <code>HelloWorld</code> 类，看看 JVM 首先会做什么：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Object</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"Hello World!"</span>);
    }
}
</code></pre>
<p>JVM 会优先加载 <code>java.lang.Object</code> 及其依赖。类在初次加载时大多处于“半隐藏”的状态，以便进行必要的验证与整理工作。</p>
<p>再看下 <code>java.lang.Object</code> 的方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Object</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; getClass()
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object obj)</span>
}
</code></pre>
<p>这些方法分别引用了 <code>java.lang.Class</code> 与 <code>java.lang.String</code>，因此它们也需要先行加载。JVM 采用“按需加载”的策略，仅在类被实际引用时才加载。不过，上述这些对 JVM 至关重要的类会被“抢先加载”。在一个简单的 HelloWorld 程序里，由 <code>JNI_CreateJavaVM()</code> 初始化的引导类加载器负责所有的类加载工作。</p>
<h3 data-id="heading-11">3.5. 类链接</h3>
<p>类链接可以拆分为验证（Verification）、准备（Preparation）与解析（Resolution），其发生顺序并不固定：解析可能发生在验证之前，也可能在类初始化之后。验证确保类结构正确：</p>
<pre><code class="hljs language-text" lang="text">[class,init] Start class verification for: HelloWorld
[verification] Verifying class HelloWorld with new format
[verification] Verifying method HelloWorld.&lt;init&gt;()V
</code></pre>
<p>位于 CDS 中的类已经过验证，因此会跳过该步骤，从而提升启动性能。这是 CDS 的重要收益之一。在“准备”阶段，JVM 会用默认值初始化静态字段，没有显式初始化器的静态变量会自动获得默认值。</p>
<p>在“解析”阶段，JVM 会解析常量池（Constant Pool）中的符号引用。常量池保存了类的所有符号引用，JVM 必须先将其解析为真实的内存引用，才能执行相关指令。</p>
<p>我们可以使用 <code>javap</code> 来观察：</p>
<pre><code class="hljs language-bash" lang="bash">javap -verbose HelloWorldCopy
</code></pre>
<p>这将显示常量池的内容：</p>
<pre><code class="hljs language-text" lang="text">Constant pool:
   #1 = Methodref          #2.#3          // java/lang/Object."&lt;init&gt;":()V
   #2 = Class              #4             // java/lang/Object
   #3 = NameAndType        #5:#6          // "&lt;init&gt;":()V
   #7 = Fieldref           #8.#9          // java/lang/System.out:Ljava/io/PrintStream;
  #13 = String             #14            // Hello World
</code></pre>
<p>构造器的字节码并不直接包含地址。它引用常量池中的符号项（例如 <code>#1</code>），这些条目描述了方法或字段。解析阶段会将这些符号项转为可执行的真实内存引用：</p>
<pre><code class="hljs language-text" lang="text">public HelloWorld();
  descriptor: ()V
  flags: (0x0001) ACC_PUBLIC
  Code:
    stack=1, locals=1, args_size=1
       0: aload_0
       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V
       4: return
  LineNumberTable:
    line 2: 0
    line 4: 4
</code></pre>
<p>第 1 行的 <code>invokespecial</code> 指令引用了常量池条目 <code>#1</code>，其中包含链接到 <code>java.lang.Object</code> 构造器所需的信息。<code>&lt;init&gt;</code> 表示这是由 <code>javac</code> 为每个构造器自动生成的特殊方法。JVM 采用“延迟解析”，只有在尝试执行类中的某条指令时才触发解析；并非所有已加载的类都会实际执行其指令。</p>
<h3 data-id="heading-12">3.6. 类初始化</h3>
<p>类初始化会为静态字段赋值并执行静态初始化器，这与我们调用构造器的实例初始化不同。该过程由 <code>javac</code> 自动生成的特殊方法 <code>clinit</code> 负责。</p>
<h2 data-id="heading-13">4. 优化 JVM 启动性能</h2>
<p>尽管 JVM 的启动已经很高效，但仍有提升空间。以下是一些方向。</p>
<h3 data-id="heading-14">4.1. 类加载的影响</h3>
<p>我们可以使用系统的 <code>time</code> 工具来度量 JVM 启动、加载类、链接并执行这个简单程序的总耗时：</p>
<pre><code class="hljs language-bash" lang="bash">time java HelloWorldCopy
</code></pre>
<p>该工具会测量从 JVM 进程启动到退出的挂钟时间，包含类加载、链接、JIT 预热与程序执行——不仅仅是用户代码。对于 HelloWorld，JVM 在启动期间通常会加载约 400～450 个类。在现代硬件上，即便开启冗长日志，整个过程也大约在 60 毫秒左右完成。</p>
<h3 data-id="heading-15">4.2. Project Leyden</h3>
<p>Project Leyden 的目标是减少启动时间、达到峰值性能的时间以及内存占用。JDK 24 引入了 JEP 483：Ahead-of-Time Class Loading and Linking（提前类加载与链接），将这些操作从启动时前移至 AOT 阶段。</p>
<p>该特性会在“训练运行”中记录 JVM 的行为，将其存入缓存，并在后续启动时从缓存加载。这将取代原先的 CDS 概念，并最终以 AOT 的更广泛能力来统一表达。</p>
<h3 data-id="heading-16">4.3. JVM 参数与调优</h3>
<p>虽然我们可以通过静态字段与初始化器在某些场景中优化启动性能，但应谨慎对待。为了将行为挪到类加载阶段而进行重构，往往很难获得可测量的收益——特别是考虑到运行时的大部分代码来自依赖库而非我们自己的应用。</p>
<h2 data-id="heading-17">5. 结论</h2>
<p>本文从校验用户输入、检测系统资源，到类的加载、链接与初始化，系统地梳理了 JVM 在启动阶段经历的复杂流程。即便是一个简单的 HelloWorld，JVM 也会在执行代码之前构建起完整的运行环境，加载数百个类。</p>
<p>随着 Project Leyden 等改进（例如 AOT）的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[腾讯发布CodeBuddy Code CLI平替Claude Code?]]></title>    <link>https://juejin.cn/post/7572714389943500852</link>    <guid>https://juejin.cn/post/7572714389943500852</guid>    <pubDate>2025-11-16T13:10:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572714389943500852" data-draft-id="7569206227357040675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="腾讯发布CodeBuddy Code CLI平替Claude Code?"/> <meta itemprop="keywords" content="CodeBuddy,AIGC"/> <meta itemprop="datePublished" content="2025-11-16T13:10:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            腾讯发布CodeBuddy Code CLI平替Claude Code?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:10:45.000Z" title="Sun Nov 16 2025 13:10:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>出于Claude Code的限制加上本人并不想花太多时间在环境上折腾，之前使用Claude Code CLI使用了 GLM 4.5、Kimi K2、DeepSeek 3.1、Qwen3 Coder 以及一些中转站，整体来说能用但是总感觉差点什么，直到前几天(2025年9月9日)听说腾讯发布了CodeBuddy Code CLI可平替Claude Code，国内可无网络限制使用，怀着激动的心，颤抖的手前来体验一下。对AI Code CLI感兴趣的小伙伴也可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247487588%26idx%3D1%26sn%3D7f6af21976e6a86ccf36851501542ffa%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247487588&amp;idx=1&amp;sn=7f6af21976e6a86ccf36851501542ffa&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">终端福音，AI终端编程助手Aider</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492263%26idx%3D1%26sn%3D4e809f38100be358e31f298a78fd81ea%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492263&amp;idx=1&amp;sn=4e809f38100be358e31f298a78fd81ea&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">下一代AI终端神器Warp</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492558%26idx%3D1%26sn%3De762047c93c4361f63744ec3c70a434f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492558&amp;idx=1&amp;sn=e762047c93c4361f63744ec3c70a434f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Google百万Token上下文Gemini CLI，离AI自由更近一步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247492929%26idx%3D1%26sn%3D043e21a18f31f1c4c68bf4ee63e28685%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247492929&amp;idx=1&amp;sn=043e21a18f31f1c4c68bf4ee63e28685&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code CLI初体验</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>codebuddy-code-cli：1.1.0</p>
<h2 data-id="heading-2">优势</h2>
<ul>
<li>限时公测免费，无需邀请码</li>
<li>可以切换多家厂商模型，可以使用 Gemini Pro 2.5模型 和 Claude Sonnet 4模型</li>
</ul>
<h2 data-id="heading-3">限制</h2>
<ul>
<li>暂不支持 /agents、/hooks、/ide功能</li>
<li>暂不支持后台任务</li>
<li>暂不支持HTTP/SSE协议的MCP</li>
<li>国内版只有DeepSeek 3.1模型，国际版才能使用 Claude Sonnet 4 和 Gemini-Pro 2.5 模型</li>
<li>国际版使用的是CodeBuddy IDE国际版权益，新注册用户享有2周一次性500积分额度，老用户每天50积分免费额度</li>
</ul>
<h2 data-id="heading-4">简介</h2>
<p>CodeBuddy Code CLI 是腾讯 2025 年 9 月推出的 AI 命令行工具，面向专业工程师，支持用自然语言驱动开发全流程。它具备智能代码库分析、内置完整工具链、多场景任务自动化等特性，可无缝融入现有开发流程，通过 npm 一键安装，支持多账号登录及模型切换，与 CodeBuddy 插件、IDE 构成 AI 编程工具矩阵，为开发者提供高效自动化的开发体验。</p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcopilot.tencent.com%2Fcli" target="_blank" title="https://copilot.tencent.com/cli" ref="nofollow noopener noreferrer">copilot.tencent.com/cli</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/854ee72962024e32b64cff2429a93575~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=tStaTF5DRDn52688OpVLMnUt%2B48%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">安装</h2>
<h3 data-id="heading-6">前置条件</h3>
<ul>
<li>NodeJS 18及以上</li>
</ul>
<h3 data-id="heading-7">安装CodeBuddy Code CLI</h3>
<p>CodeBuddy Code CLI的安装非常简单，一行命令即可完成安装：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>npm install -g <span class="hljs-variable">@tencent</span>-ai/codebuddy-code
</code></pre>
<p>安装完成后，输入 codebuddy --version 输出以下内容表明安装成功</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e25b06414f2466eb31285eddaa55848~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=IF7IY9z5GgbdXDIwjQm4m2ajyR0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">基本使用</h2>
<h3 data-id="heading-9">国际版积分查询</h3>
<p>经测试发现，CodeBuddy Code CLI国际版使用的是CodeBuddy IDE国际版额度，通过CodeBuddy IDE国际版可以查询额度消耗情况。</p>
<p>CodeBudy IDE国际版地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codebuddy.ai%2Fprofile%2Fusage" target="_blank" title="https://www.codebuddy.ai/profile/usage" ref="nofollow noopener noreferrer">www.codebuddy.ai/profile/usa…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6da295f329e46108a939530fbe97448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=5Cc7A1lZsUNuKDUsmCkrmQn2c08%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10">登录授权</h3>
<p>CodeBuddy Code CLI安装成功后，在命令行终端输入 codebuddy 即可启动，首次使用需要对文件夹进行授权操作</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9e7534d2c184609b6f21465900bbe8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=IxhYDAgmlwA6jWNmOo8ZsZz89fI%3D" alt="图片" loading="lazy"/></p>
<p>授权成功后但想要正常使用还需要进行登录授权操作，CodeBuddy Code CLI提供了 Google/Github 和 WeChat(微信登录) 2种登录方式。</p>
<h4 data-id="heading-11">1）Google/Github</h4>
<p>CodeBuddy Code CLI默认为 Google/Github 授权登录，直接回车</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a55fc9b09e1498b81dd7feef337cf36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=DTm1qB3fOoCZt%2FSWS2kC4gSrB%2F4%3D" alt="图片" loading="lazy"/></p>
<p>CodeBuddy Code CLI会打开浏览器请求CodeBuddy IDE授权登录（难道使用的CodeBuddy IDE国际版的权益？后面发现确实是🤣），我这里选择【Google】</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/915a671e2df140eba3b4b97096b7326d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=XhliEIdXutLgNwu9K5zb2vfIbyg%3D" alt="图片" loading="lazy"/></p>
<p>授权登录后并不会直接登录成功，而是会向gmail邮箱发送邮件，点击授权链接登录即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2d4df4c99ec481382b1a855111a7bf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=9nvZM50RDb1r%2BgHg6ii6vq%2BE%2FCc%3D" alt="图片" loading="lazy"/></p>
<p>登录成功后即可进入CodeBuddy Code CLI主界面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6d46abcf5a94608b80394fd18910082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=3zz99BRmD%2FhoZ2zEYUt9M5hB9Rk%3D" alt="图片" loading="lazy"/></p>
<p>在交互式命令中输入 /model 可以查看模型信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/061ee61328d14620aceebeb9a94d42ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=KSjKlVQA59KqnxtTh3ZpYrRkuvs%3D" alt="图片" loading="lazy"/></p>
<p>可以看到国际版提供的模型还是很丰富的，包括 Claude Sonnet 4.0、Gemini 2.5系列 以及 GPT 5系列：</p>
<ul>
<li>Claude Sonnet 4.0
<ul>
<li>Claude-4.0-Sonnet</li>
</ul>
</li>
<li>Gemini 2.5系列
<ul>
<li>Gemini-2.5-Flash</li>
<li>Gemini-2.5-Pro</li>
</ul>
</li>
<li>GPT 5系列
<ul>
<li>GPT-5</li>
<li>GPT-5-mini</li>
<li>GPT-5-nano</li>
<li>GPT-4o-mini</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">2）WeChat</h4>
<p>选择【Login with WeChat】使用微信登录</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f660ff86c414b339acd140e21da1493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=5RaY5SqT5QDYplPJoJ3R%2BcPV1VA%3D" alt="图片" loading="lazy"/></p>
<p>接着CodeBuddy Code CLI会打开浏览器请求微信授权登录</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8d9130c38c418da036aba10178c0e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=7YbpwIQsAO4XOZCxe%2BFdixNIrdA%3D" alt="图片" loading="lazy"/></p>
<p>登录成功后，就可以进入CodeBuddy Code CLI主界面了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/930fca56cb484450ab8d9e78ccfcf98b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=B7TeT9Tu5rKmy%2B%2FLP4AXMUuSoxI%3D" alt="图片" loading="lazy"/></p>
<p>在交互式命令中输入 /model 可以查看模型信息，提供了 Default(暂时未知模型信息)、DeepSeek-V3.1、DeepSeek-V3 3种模型</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05dba4b3c60d4134b0733a317abf530e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=zghDVAsUGsx2%2F%2Byyt3IdIx6xbOk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">CLI参数</h3>
<p>在命令行输入 codebuddy --help 可以快速查看CodeBuddy Code CLI提供的参数，包含 命令 和 可选参数。可以看到和CodeBuddy Code CLI很像哈。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6686edebec0d4b9fa3b58a920f3cf60e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=LvR31JOvpInKhDqRvXJQDz4yV1o%3D" alt="图片" loading="lazy"/></p>
<p>CLI参数命令：</p>
<ul>
<li>config：管理配置</li>
<li>mcp：配置和管理 MCP 服务器</li>
<li>migrate-installer：从全局 npm 安装迁移到本地安装</li>
<li>doctor：检查 CodeBuddy 代码自动更新器的健康状况</li>
<li>update：检查更新并在有可用更新时进行安装</li>
<li>install：安装 CodeBuddy 代码原生版本。使用 [目标] 指定版本（稳定版、最新版或特定版本）</li>
</ul>
<p>可选参数：</p>
<ul>
<li>--output-format：输出格式 (仅与 --print 配合使用)</li>
<li>--input-format：输入格式 (仅与 --print 配合使用)</li>
<li>--continue：继续最近的对话</li>
<li>--resume： 恢复对话，供会话ID或交互式选择</li>
<li>--model：当前会话的模型。提供模型名称</li>
<li>--dangerously-skip-permissions：绕过所有权限检查。仅推荐用于无网络访问的沙箱</li>
<li>--permission-mode：权限模式: acceptEdits、bypassPermissions、plan</li>
<li>--allowedTools：允许的工具列表 (如 "Bash(git:*) Edit")</li>
<li>--disallowedTools：禁止的工具列表 (如 "Bash(git:*) Edit")</li>
<li>--add-dir：允许工具访问的额外目录</li>
</ul>
<p>使用 codebuddy 内容 可以快速开启一次对话</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a6056df68f141e7addfc65c4466f8db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=p4KMIqI8Yly44nDOG7eh6dUVK%2FY%3D" alt="图片" loading="lazy"/></p>
<p>在命令行终端输入 codebuddy mcp list 可以快速查看mcp列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0cb8aa7ba224d74a2b08d38d415a09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=l%2FpcynpYvuimSLE26j0usrEtdSk%3D" alt="图片" loading="lazy"/></p>
<p>使用 codebuddy --dangerously-skip-permissions 开启自动允许模式，类似Cursor中的 auto-run 模式</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce03efcbdd34ab583b2594cd30c4815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=vYfKtCGpQLmBThV3TLD227CNjE8%3D" alt="图片" loading="lazy"/></p>
<p>使用 codebuddy -c 继续上一次会话，使用 codebuddy -r 恢复指定会话</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b8005faf8274bcdb48f2b3381806881~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=a9TIY%2BF2l3FN%2FGG5FwyPqrvMOq8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-14">交互模式及快捷键列表</h3>
<p>在在CodeBuddy Code CLI交互式命令输入 /help，可以看到CodeBuddy Code CLI提供所有交互指令和快捷键</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64ca6f3730bf4ea1ab235afe4305a223~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=u5blDquQkM7yvualhND6VAOb%2BP4%3D" alt="图片" loading="lazy"/></p>
<p>交互命令行列表：</p>
<ul>
<li>/add-dir：添加新的工作目录</li>
<li>/agents：管理代理配置</li>
<li>/clear：清除对话历史并释放上下文</li>
<li>/compact：清除对话历史，但在上下文中保留摘要。</li>
<li>/config：打开配置面板</li>
<li>/cost：显示当前会话的总费用和持续时间</li>
<li>/doctor：诊断并验证您的 CodeBuddy 安装和设置</li>
<li>/exit：退出 CodeBuddy</li>
<li>/export：将当前对话导出到文件或剪贴板</li>
<li>/help：显示帮助信息和可用命令</li>
<li>/hooks：管理工具事件的钩子配置</li>
<li>/ide：管理 IDE 集成并显示状态</li>
<li>/init：分析你的代码库……</li>
<li>/install-github-app：为仓库设置 ${NAME} GitHub Actions</li>
<li>/login：切换腾讯云 CodeBuddy 账户</li>
<li>/logout：从你的腾讯云 CodeBuddy 账户登出</li>
<li>/mcp：管理 MCP 服务器</li>
<li>/memory：编辑 CodeBuddy 内存文件</li>
<li>/migrate-installer：从全局 npm 安装迁移到本地安装</li>
<li>/model：为 CodeBuddy 设置 AI 模型</li>
<li>/permissions：管理允许和拒绝工具权限规则</li>
<li>/pr-comments：从 GitHub 拉取请求获取评论</li>
<li>/release-notes：查看发布说明</li>
<li>/resume：恢复对话</li>
<li>/review：审核拉取请求</li>
<li>/status：显示 CodeBuddy 状态，包括版本、模型、账户、API 连接性和工具状态</li>
<li>/terminal-setup：为换行安装 Shift+Enter 键绑定</li>
<li>/upgrade：在浏览器中打开升级页面</li>
<li>/vim：在 Vim 编辑模式和普通编辑模式之间切换</li>
<li>/workspace：切换到不同的工作文件夹（Claude Code CLI中没有的）</li>
</ul>
<p>快捷键：</p>
<ul>
<li>Ctrl+C：取消当前输入或生成（连按两次退出CodeBuddy）</li>
<li>Ctrl+D：退出 CodeBuddy Code 会话（连按两次退出CodeBuddy）</li>
<li>Ctrl+L：清除终端屏幕</li>
<li>上/下箭头：导航命令历史</li>
<li>Ctrl+J：多行的换行字符</li>
<li>Shift+Tab：切换对话模式</li>
<li>Tab：自动补全指令</li>
<li>ESC+ESC：切换历史消息</li>
</ul>
<h3 data-id="heading-15">执行Shell指令</h3>
<p>默认CodeBuddy Code CLI所有的输入都被视为提示词指令，如果需要执行shell指令如 ls、grep 等需要在指令前加 !，在命令行输入 !后会进入Bash模式，接着就可以输入指令执行了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcd58f9d1a2443c6b1754931952b0a82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=FKwP7e1A1j%2FYiDXRQqTww1m%2BlZs%3D" alt="图片" loading="lazy"/></p>
<p>再也不用新开终端页签或终止当前CLI来执行Shell指令了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae61296cd575432fa7c2e072ae9de14a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=J483Z3Z7iJywRzxRLoKjVT6WCwA%3D" alt="图片" loading="lazy"/></p>
<p>需要取消Bash模式时，使用【ESC】键就可以退出Bash模式</p>
<h3 data-id="heading-16">配置文件</h3>
<blockquote>
<p>暂不支持 agents 和 hooks 配置</p>
</blockquote>
<p>CodeBuddy Code CLI提供了 settings.json、CodeBuddy.md、.mcp.json 等配置文件</p>
<h4 data-id="heading-17">settings.json</h4>
<p>settings.json 文件是通过分层设置配置的官方机制，提供了 全局用户配置 和 项目配置 2种配置方式：</p>
<ul>
<li>全局用户配置：配置文件路径： ~/.codebuddy/settings.json，不会被Git记录，适用于所有项目</li>
<li>项目配置：配置文件路径：项目根目录/.codebuddy/settings.json 可被Git记录与团队共享，只针对当前项目生效</li>
<li>本地配置：配置文件路径：项目根目录/.codebuddy/settings.local.json，不会被Git记录 (添加到 .gitignore)，适用于当前会话或工作区</li>
</ul>
<p>生效的优先级为：local &gt; project &gt; user</p>
<h4 data-id="heading-18">记忆文件</h4>
<p>CodeBuddy Code CLI提供记忆文件功能，支持 全局用户配置 和 项目配置 2种配置方式：</p>
<ul>
<li>全局用户配置：配置文件路径为：~/.codebuddy/CODEBUDDY.md，为所有存放与个人长期偏好和习惯相关的信息</li>
<li>项目配置：路径为：工作区根目录/CODEBUDDY.md，存放与当前项目共享的通用信息</li>
</ul>
<p>当你运行 /init 命令时，codebuddy 会自动为你生成一个 CODEBUDDY.md</p>
<h4 data-id="heading-19">MCP配置</h4>
<p>CodeBuddy Code CLI支持不同作用域的MCP服务配置，主要有 全局用户配置、项目配置 和 本地配置：</p>
<ul>
<li>全局用户配置：存放在 ~/.codebuddy.json文件的 mcpServers 配置下，不会被Git记录，适用于所有项目</li>
<li>项目配置：存放在 /项目根目录/.mcp.json 文件，可被Git记录与团队共享</li>
<li>本地配置：存放在 ~/.codebuddy.json 文件的 projects 配置下，不会被Git记录，适用于当前会话或工作区</li>
</ul>
<p>生效的优先级为：local &gt; project &gt; user</p>
<h4 data-id="heading-20">Commands</h4>
<p>CodeBuddy Code CLI提供自定义命令，通过在特定目录中创建 .md (Markdown) 文件来定义，支持 全局用户命令 和 项目级命令 2种配置方式：</p>
<ul>
<li>全局用户命令：在用户主目录下创建 ~/.codebuddy/commands/ 文件夹，针对所有项目生效。</li>
<li>项目级命令：在项目根目录下创建 .codebuddy/commands/ 文件夹。针对特定项目生效。</li>
</ul>
<p>创建一个命令，只需在上述任一目录中添加一个 .md 文件即可。例如test.md 文件会自动注册为 /test 命令。</p>
<h3 data-id="heading-21">Chat对话</h3>
<p>启动CodeBuddy Code CLI后界面如下，提供了对话模式、工作区和tokens消耗信息展示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4547334685249e5a211bd8f989574e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=xI9%2FSb0odZ6spSdMkoORMEtDJWk%3D" alt="图片" loading="lazy"/></p>
<p>输入内容回车即可模型进行对话</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f549d18f23a4950acb70f08609a711e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=lXQW9KCJGjN9qlnTSORVnjkOW8w%3D" alt="图片" loading="lazy"/></p>
<p>CodeBuddy Code CLI支持添加文件上下文，通过 @ 命令查看当前工作区文件列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f749ce2daf64ecaad39d99f3441fd24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=%2BFs%2F7XzVcqdc2HQUhPy7k9POkts%3D" alt="图片" loading="lazy"/></p>
<p>选择文件，可以将文件添加到聊天上下文</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/708eeb86a0e44ca5ada4d817bce3dccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=cbC%2FiU14%2BWJY3gLs%2FhWnsvU2EOg%3D" alt="图片" loading="lazy"/></p>
<p>CodeBuddy Code CLI目前尚不支持二级文件(Claude Code CLI支持二级文件)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88e82d55b1ab487b969b5cb2db722e40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=pa0W%2FGuOYfq3JZxiqazO25SX0ck%3D" alt="图片" loading="lazy"/></p>
<p>除了文件上下文，CodeBuddy Code CLI还支持通过快捷键【Ctrl/Cmd+V】从剪切板粘贴图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82a3d18d13be45cb8b5b0e45f6098edc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=RcdWkNBCVukTB9Sj5IxoiRgqdtY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8244ca767f17461f8bdce1691498e4c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=6scC9MpgY3%2FpXsqh0r0uSBUmzjA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-22">对话模式</h3>
<p>CodeBuddy Code CLI提供了 手动模式、计划模式 和 自动接收模式</p>
<ul>
<li>手动模式：询问权限，需手动批准权限，默认模式</li>
<li>计划模式：问答制定计划，不会执行文件操作</li>
<li>自动接收模式：自动批准权限</li>
</ul>
<h4 data-id="heading-23">手动模式</h4>
<p>在CodeBuddy Code CLI中默认就是手动模式，当我们需要执行shell命令或者对文件进行操作时，该模式都会询问权限</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1187187c37e04a4cb54e24113ddff14b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=reim9djD6FPPoBXHOZFxB%2BXpXHU%3D" alt="图片" loading="lazy"/></p>
<p>当我们选择允许时，CodeBuddy Code CLI才会真正执行任务</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46428b9d5a8a49988ff044b0a08425d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=ToVYqzlUY%2FSCbwPez7O8v6NkYlA%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-24">绕过权限模式</h4>
<p>使用快捷键 Shift+Tab 切换到绕过权限模式（bypass permissions on）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/665c7ddde49b4faca255950b4595fa59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=%2FR%2FcOdP7Kqo%2FZzATiHI28YAAkFY%3D" alt="图片" loading="lazy"/></p>
<p>输入提示词后，CodeBuddy Code CLI会直接操作不会进行任何权限提示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1ffa145795e49c587a3355cc59eaf34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=Y%2BbM0AhURu2o4mZbi%2FvQwR0RJbI%3D" alt="图片" loading="lazy"/></p>
<p>我们使用Bash命令 chmod 444 index.py 将 index.py 文件权限改为只读模式</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c19dd3e3063e4bd99d6908da050fd033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=zwHcfnaQUOMQev4o%2FPwu0pSM35c%3D" alt="图片" loading="lazy"/></p>
<p>再次执行文件修改发现好像并没有什么作用，不知道是不是使用的问题，也不清楚该模式和自动接受编辑模式有什么区别</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8791598fe48f4ae3be68b5b393d4fe18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=MNMe0RXkxZIBRFhV55QKjYOkFtw%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-25">自动接受编辑模式</h4>
<blockquote>
<p>和 --dangerously-skip-permissions 模式相比，自动接受模式安全性更高，自动接受模式非全局生效且仅限于文件编辑</p>
</blockquote>
<p>使用快捷键 Shift+Tab 切换到自动接受编辑模式（accept edits on）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06816463fb134a85a6958ec4c2f6a1e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=4S%2FPyck6rsQRy511dCo6UK9ffQE%3D" alt="图片" loading="lazy"/></p>
<p>开启此功能后，CodeBuddy Code CLI会 自动创建、编辑 文件，而不是每次都需要我们手动确认</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e406743099ef429b8e8300e1316a33d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=49VCb%2FbOzmjVJEsoxGDiPBjTFmA%3D" alt="图片" loading="lazy"/></p>
<p>我们使用Bash命令 chmod 444 index.py 将 index.py 文件权限改为只读模式</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9405c6c1c123423facf987f1050e1cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=jApA2wkQKOVPxqlwOXy2anyFSKQ%3D" alt="图片" loading="lazy"/></p>
<p>可以看到接受编辑模式也是无法直接进行文件操作的，但是会给出权限提示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3abcc6ea2ed040bba0748df01b966a58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=MttXQHg7urQhfSv0JHJ%2Bm3d9XsY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-26">自定义斜杠命令</h3>
<blockquote>
<p>不支持自定义嵌套命令</p>
</blockquote>
<p>这是CodeBuddy Code CLI提供的强大功能之一。可以将常用的提示(Prompts)、脚本和工作流封装成可复用的自定义命令，从而极大地提升效率。</p>
<p>首先在项目根目录创建 .codebuddy/commands 文件夹，在文件夹中创建一个 project-folder.md 文件，输入如下提示词：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a939f0844d1846728cd6d47f15afddcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=SVSvClJeCZrTG1WFo%2FH%2B%2FdNMNuA%3D" alt="图片" loading="lazy"/></p>
<p>保存后，重启CodeBuddy Code CLI，输入 /project 即可看到刚刚自定义的命令</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e82e699626f8491cad116191c9794860~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=ecNviw9864%2FDeu2RAxb7e5sg9JY%3D" alt="图片" loading="lazy"/></p>
<p>调用自定义命令就会执行提示词任务</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3209782c673742ffbd174b47b47ad8b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=asElP%2F7werIUXKoWebuEGYQcNYI%3D" alt="图片" loading="lazy"/></p>
<p>CodeBuddy Code CLI自定义命令也支持自定义动态参数，在文件夹中创建一个 greet.md 文件，输入如下提示词：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8da9c6d09b645748ef79868e6a9ce7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=jXmfQ9OglC9jokZkXkHXcc4uScQ%3D" alt="图片" loading="lazy"/></p>
<p>保存后，重启CodeBuddy Code CLI，输入 /greet 使用【Tab】补全指令输入参数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec48c3ac1871481ca699bc0353d2f276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=Be4EyADfS%2FR0%2BnIazRJGbm1f0K4%3D" alt="图片" loading="lazy"/></p>
<p>可以看到结果是按照我们自定义命令内容输出的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35180697577441d0beed192aeaa384e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=04PMF2WViav%2FCJKnzsUbjvEProU%3D" alt="图片" loading="lazy"/></p>
<p>我们将上面动态参数的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mtext>换成</mtext></mrow><annotation encoding="application/x-tex">1 换成 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">1</span><span class="mord cjk_fallback">换成</span></span></span></span></span>ARGUMENTS 也是一样的效果(和Claude Code CLI保持一致的)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/320e1d0594234226b707008be1ce46dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=8iuW4LfoBPIF1JwnAjt9irW1rW8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-27">记忆文件</h3>
<p>首先创建 ~/.codebuddy/CODEBUDDY.md 和 项目根目录/CODEBUDDY.md 两个记忆文件，在 ~/.codebuddy/CODEBUDDY.md 输入提示词：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">all</span> response in 中文
</code></pre>
<p>在 项目根目录/CODEBUDDY.md 输入提示词：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">all</span> response in English
</code></pre>
<p>可以看到目前记忆文件还只是支持项目记忆文件，全局用户记忆文件还无法识别</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddc3df6975d844929ffe17e1b0581bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=N%2BgSy%2FWZSbd0qVThMfqiTRlYq%2FU%3D" alt="图片" loading="lazy"/></p>
<p>询问CodeBuddy Code CLI，它给我的回复是这样的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4a0eca44c48d387c11a4b2dd06acc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=DJ2v8ZGKMNNcben5taXDtDO7gMM%3D" alt="图片" loading="lazy"/></p>
<p>我们也可以使用CodeBuddy Code CLI生成记忆文件，在交互式命令输入 /init</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d683222d485c4aa2a7deb5bef31ce6a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=tYWb6%2BQNwKSkPGiXvKE3xKKzUYM%3D" alt="图片" loading="lazy"/></p>
<p>使用 # 命令可以快速添加提示词到记忆文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2fc89eb00d34ef09f4911bc5edf6798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=E3DhY25f8ldQvft4%2BDC2Xx%2FDJ5I%3D" alt="图片" loading="lazy"/></p>
<p>添加完成，项目记忆文件中会新增一条刚刚添加到提示词记忆</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/765b90b36535491abd402708947e1c92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=cH19Q%2BqPmx%2BIQNAZB%2BLP9aQNJoc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-28">Hooks</h3>
<p>CodeBuddy Code CLI暂未支持该功能</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2239deec8fd4795a4d1b526f38e5599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=C92Hpaw7DhmwzrZz2TvRQh1pOKk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-29">Sub Agents</h3>
<p>CodeBuddy Code CLI暂未支持该功能</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87dce2bbd57943b6a14dbbeacca5e83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=Lfn5TuzepBMJgiTm5Wj5vsjLTgE%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-30">MCP服务</h3>
<p>CodeBuddy Code CLI提供了MCP的 命令行 和 JSON 2种配置形式</p>
<h4 data-id="heading-31">方式一：命令行配置(推荐)</h4>
<p>首先退出CodeBuddy Code CLI交互模式，使用mcp命令添加MCP语法格式如下：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 基本语法</span>
$ codebuddy mcp <span class="hljs-keyword">add</span> &lt;MCP Name&gt; &lt;MCP Command&gt; [args...]
</code></pre>
<p>以context7 MCP为例，输入如下指令</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-variable">$ </span>codebuddy mcp add context7 -- npx -y <span class="hljs-variable">@upstash</span>/context7-mcp
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b57d21425504fe2b52f0b18b8f5324c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=gsIIViXQO3Fqh4Dv94LRaVnTaAE%3D" alt="图片" loading="lazy"/></p>
<p>使用 codebuddy mcp list 查看mcp列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e206da0db2834f249bf37c4cf1e6ddf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=SytXjFwBso5nYtewV2pY43SocZw%3D" alt="图片" loading="lazy"/></p>
<p>也可以添加Http类型的MCP服务（添加方式和Claude Code CLI了保持一致）</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> codebuddy mcp add --transport http context7 https://mcp.context7.com/mcp</span>
</code></pre>
<h4 data-id="heading-32">方式二：JSON格式配置</h4>
<p>在CodeBuddy Code CLI中也支持JSON格式配置，这里以项目配置为例，在项目根目录下创建 .mcp.json 文件，添加如下配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"context7"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://mcp.context7.com/mcp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>在命令行终端使用 codebuddy mcp list 查看mcp列表</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ddae3b36e7741deb6bbdf8584042795~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=7OIQRbfxGzljryLrmkby33bRRfc%3D" alt="图片" loading="lazy"/></p>
<p>MCP的使用和普通的Chat一样，直接输入提示词即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec0b7166f38f4fa8a6d2e023d31458a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903445&amp;x-signature=P7SzbqA42jp0ulLh62Xze896nHc%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-33">总结</h2>
<p>整体使用下来可以看得出CodeBuddy Code CLI是在仿制Claude Code CLI功能，目前已提供了基本的CLI功能，但是核心的 /agents、/hooks、/ide 等功能还未支持或未完善，不过还是勉强可以满足日常开发需求的，对这些功能要求不高的小伙伴可以入手玩起来。</p>
<h2 data-id="heading-34">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fk6v7sfpki7ofkngAlOCCbw" target="_blank" title="https://mp.weixin.qq.com/s/k6v7sfpki7ofkngAlOCCbw" ref="nofollow noopener noreferrer">腾讯发布CodeBuddy Code CLI平替Claude Code?</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fk6v7sfpki7ofkngAlOCCbw" target="_blank" title="https://mp.weixin.qq.com/s/k6v7sfpki7ofkngAlOCCbw" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字节TRAE SOLO：你的AI编程副驾已上线！]]></title>    <link>https://juejin.cn/post/7573193563044773942</link>    <guid>https://juejin.cn/post/7573193563044773942</guid>    <pubDate>2025-11-16T13:18:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573193563044773942" data-draft-id="7573193563044757558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="字节TRAE SOLO：你的AI编程副驾已上线！"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-16T13:18:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            字节TRAE SOLO：你的AI编程副驾已上线！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:18:06.000Z" title="Sun Nov 16 2025 13:18:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾在一个百万行的老旧项目里挣扎，改一个bug如同大海捞针？或者面对一个全新的idea，却苦于从零开始的繁琐搭建？如果我告诉你，有一个“副驾”能帮你分担这些，甚至比你更懂代码，你会相信吗？</p>
<p>字节跳动旗下的AI编程神器TRAE SOLO，在万众瞩目下，终于迎来了正式版（GA）的全面开放！它不再仅仅是一个工具，更像是一位拥有“响应感知”的编程智能体，它自称“The Responsive Coding Agent”，野心勃勃地要重塑我们的开发流程。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-16_21.10.12-1024x655.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-16_21.10.12-1024x655.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d25ad8ec2fe44c7af6abe2595ccd587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903885&amp;x-signature=P8SKI1toodO3NLMIvZxdE4tGuak%3D" alt="iShot_2025-11-16_21.10.12" loading="lazy"/></a></p>
<h3 data-id="heading-0">“双子星”智能体，覆盖你的开发全场景</h3>
<p>这次升级的核心亮点，无疑是其精心打造的“双子星”智能体架构：SOLO Builder和SOLO Coder。它们就像是为你量身定制的“左右护法”，各有专攻，协同作战。</p>
<p>想象一下，你需要快速验证一个新想法，SOLO Builder就像你的“创意加速器”，你只需用自然语言描述，它就能从产品需求、开发、测试到部署一气呵成，帮你搭起一个可运行的Demo，真正实现“Vibe Coding”的直观与高效。</p>
<p>而如果你正深陷已有项目的泥沼，SOLO Coder就是你的“项目守望者”。从复杂的Bug修复、功能迭代，到代码重构，它都能以“Plan模式”辅助你制定详细计划，甚至能处理百万行级别的代码库，让你的每一次改动都清晰可控，告别“黑箱”操作。它能辅助你制定详尽的开发规划，让你对整个流程有更强的掌控感。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-16_21.10.20-782x1024.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-16_21.10.20-782x1024.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2ba677147d647a7a369b272c3d56589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903885&amp;x-signature=mtuOpg%2BVRC7TpqOVtgk2gl9%2B1eU%3D" alt="iShot_2025-11-16_21.10.20" loading="lazy"/></a></p>
<h3 data-id="heading-1">告别“失忆”，掌控全局：开发流程更高效、更可控</h3>
<p>除了“双子星”的强大分工，TRAE SOLO还带来了诸多贴心升级，让开发体验达到前所未有的流畅：</p>
<ul>
<li><strong>多任务并行</strong>：告别单线作战，你现在可以同时开启并管理多个开发任务，并在它们之间灵活切换，效率直接拉满。</li>
<li><strong>上下文压缩</strong>：这简直是AI编程的“救星”！它能智能管理海量代码上下文，彻底解决了AI在长对话中“失忆”的尴尬，确保模型始终“在线”，输出质量不再下降，还能节省不必要的成本。</li>
<li><strong>代码变更视图</strong>：所有代码的改动都会以清晰的Diff视图呈现，你对AI做出的每处修改都心知肚明，掌控感十足。</li>
<li><strong>全新设计的三栏布局</strong>：多任务列表、对话流窗口和集成工具面板，界面一目了然，致力于打造一个更清晰、更高效的开发空间。</li>
<li><strong>免费调用顶级模型</strong>：甚至，它还支持免费调用GPT-4o、Claude 3.5等顶尖模型，并兼容VS Code扩展，无论Mac、Windows还是Linux，都能享受一致的高效体验。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-16_21.10.28-1024x659.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-16_21.10.28-1024x659.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eedc7bfcbed74744a97f310f88e0be29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903885&amp;x-signature=fMxkfEpoO9Xu4c%2BmdJeuS5%2By%2Fm0%3D" alt="iShot_2025-11-16_21.10.28" loading="lazy"/></a></p>
<h3 data-id="heading-2">限时免费已落幕，但探索永不止步</h3>
<p>或许你会问，这么强大的工具，我如何体验？遗憾的是，那为期四天的限时免费活动（2025年11月12日至11月15日），已经于昨日的23:59（北京时间）悄然画上了句号。但请别灰心，这并不意味着你错过了整个未来！</p>
<p>TRAE SOLO正式版已全面向国际版用户开放，无需邀请码。它的全面开放标志着字节跳动在AI辅助编程领域迈出了里程碑式的一步。无论是从零开始的快速原型构建，还是对现有复杂代码库的深度迭代，它都提供了更具针对性的智能体和支持功能。</p>
<p>无论你是一位从零开始的创业者，还是与老项目搏斗的资深开发者，TRAE SOLO都值得你亲自去探索，去感受AI如何真正成为你最可靠的编程副驾。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-16_21.10.42-1024x670.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-16_21.10.42-1024x670.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15534d87325e483184085d68edc76778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903885&amp;x-signature=8oG%2BejjVUGy%2FLxhG90YjKyUhL9Y%3D" alt="iShot_2025-11-16_21.10.42" loading="lazy"/></a></p>
<p>立即访问<a href="https://www.trae.ai/solo" target="_blank" title="https://www.trae.ai/solo" ref="nofollow noopener noreferrer">TRAE官网</a>，下载国际版客户端，体验这款可能彻底改变你编程习惯的AI新星吧！</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程]]></title>    <link>https://juejin.cn/post/7572539461478793259</link>    <guid>https://juejin.cn/post/7572539461478793259</guid>    <pubDate>2025-11-16T13:09:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572539461478793259" data-draft-id="7572481101711441974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-16T13:09:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gracker"/> <meta itemprop="url" content="https://juejin.cn/user/1816846860560749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1816846860560749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gracker
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:09:00.000Z" title="Sun Nov 16 2025 13:09:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">layout:</span> <span class="hljs-string">post</span>
<span class="hljs-attr">title:</span> <span class="hljs-string">Android</span> <span class="hljs-string">Perfetto</span> <span class="hljs-string">系列</span> <span class="hljs-number">5</span><span class="hljs-string">：Android</span> <span class="hljs-string">App</span> <span class="hljs-string">基于</span> <span class="hljs-string">Choreographer</span> <span class="hljs-string">的渲染流程</span>
<span class="hljs-attr">date:</span> <span class="hljs-number">2025-03-26 18:55:11</span>
<span class="hljs-attr">typora-root-url:</span> <span class="hljs-string">../</span>
<span class="hljs-attr">tags:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Android</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Perfetto</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Systrace</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Jank</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">RenderThread</span>
<span class="hljs-attr">categories:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Java</span>
</code></pre>
<p>本文介绍了 App 开发者不经常接触到但在 Android Framework 渲染链路中非常重要的一个类 Choreographer，包括 Choreographer 的引入背景、简介、部分源码解析、与 MessageQueue 的交互、在 APM 中的应用，以及手机厂商基于 Choreographer 的一些优化思路。</p>
<p>Choreographer 的引入主要是配合 Vsync，为上层应用的渲染提供稳定的 Message 处理时机。当 Vsync 信号到来时，系统通过对 Vsync 信号周期的调整，控制每一帧绘制操作的时机。目前主流手机的屏幕刷新率已达到 120Hz，即每 8.3ms 刷新一次，系统为配合屏幕刷新频率，相应调整 Vsync 周期。每个 Vsync 周期到来时，Vsync 信号唤醒 Choreographer 执行应用的绘制操作，这正是引入 Choreographer 的主要作用。了解 Choreographer 还可以帮助应用开发者深入理解每一帧的运行原理，同时加深对 <strong>Message</strong>、<strong>Handler</strong>、<strong>Looper</strong>、<strong>MessageQueue</strong>、<strong>Input</strong>、<strong>Animation</strong>、<strong>Measure</strong>、<strong>Layout</strong>、<strong>Draw</strong> 等核心组件的认识。许多 <strong>APM</strong>（应用性能监控）工具也利用了 <strong>Choreographer</strong>（通过 FrameCallback + FrameInfo）、<strong>MessageQueue</strong>（通过 IdleHandler）和 <strong>Looper</strong>（通过自定义 MessageLogging）这些组合机制进行性能监测。深入理解这些机制后，开发者可以更有针对性地进行性能优化，形成系统化的优化思路。</p>

<h3 data-id="heading-0">本文目录</h3>
<ul>
<li><a href="#series" title="#series">Perfetto 系列目录</a></li>
<li><a href="#main-thread-essence" title="#main-thread-essence">主线程运行机制的本质</a></li>
<li><a href="#choreographer-intro" title="#choreographer-intro">Choreographer 简介</a></li>
<li><a href="#source" title="#source">源码解析</a></li>
<li><a href="#messagequeue" title="#messagequeue">MessageQueue 与 Choreographer</a></li>
<li><a href="#apm" title="#apm">APM 与 Choreographer</a></li>
<li><a href="#vendor" title="#vendor">厂商优化</a></li>
<li><a href="#refs" title="#refs">参考资料</a></li>
<li><a href="#zhihu" title="#zhihu">本文知乎地址</a></li>
<li><a href="#about" title="#about">关于我 &amp;&amp; 博客</a></li>
</ul>
<p>本文是 Perfetto 系列文章的第五篇，主要是对 Perfetto 中的 Choreographer 进行简单介绍</p>
<p>本系列的<strong>目的</strong>是通过 Perfetto 这个工具，从另外一个角度来看待 Android 系统整体的运行，同时也从另外一个角度来对 Framework 进行学习。也许你看了很多讲 Framework 的文章，但是总是记不住代码，或者不清楚其运行的流程，也许从 Perfetto 这个图形化的角度，你可以理解的更深入一些。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-series" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-1">Perfetto 系列目录</h2>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F03%2F27%2FAndroid-Perfetto-101%2F%23%2FPerfetto-%25E7%25B3%25BB%25E5%2588%2597%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2024/03/27/Android-Perfetto-101/#/Perfetto-%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Android Perfetto 系列目录</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-01-What-is-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-01-What-is-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 1：Perfetto 工具简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-02-how-to-get-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-02-how-to-get-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 2：Perfetto Trace 抓取</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-03-how-to-analysis-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-03-how-to-analysis-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 3：熟悉 Perfetto View</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F02%2F08%2FAndroid-Perfetto-04-Open-Big-Trace-With-Command-Line%2F" target="_blank" title="https://www.androidperformance.com/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/" ref="nofollow noopener noreferrer">Android Perfetto 系列 4：使用命令行在本地打开超大 Trace</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F03%2F26%2FAndroid-Perfetto-05-Chorergrapher%2F" target="_blank" title="https://www.androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" ref="nofollow noopener noreferrer">Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F04%2F26%2FAndroid-Perfetto-06-Why-120Hz%2F" target="_blank" title="https://www.androidperformance.com/2025/04/26/Android-Perfetto-06-Why-120Hz/" ref="nofollow noopener noreferrer">Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F02%2FAndroid-Perfetto-07-MainThread-And-RenderThread%2F" target="_blank" title="https://androidperformance.com/2025/08/02/Android-Perfetto-07-MainThread-And-RenderThread/" ref="nofollow noopener noreferrer">Android Perfetto 系列 7 - MainThread 和 RenderThread 解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F05%2FAndroid-Perfetto-08-Vsync%2F" target="_blank" title="https://androidperformance.com/2025/08/05/Android-Perfetto-08-Vsync/" ref="nofollow noopener noreferrer">Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F11%2F12%2FAndroid-Perfetto-09-CPU%2F" target="_blank" title="https://www.androidperformance.com/2025/11/12/Android-Perfetto-09-CPU/" ref="nofollow noopener noreferrer">Android Perfetto 系列 9 - CPU 信息解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1oi82efE4D%2F%3Fvd_source%3D0c6d2191e785de0a36dc21a9da7e664e" target="_blank" title="https://www.bilibili.com/video/BV1oi82efE4D/?vd_source=0c6d2191e785de0a36dc21a9da7e664e" ref="nofollow noopener noreferrer">视频(B站) - Android Perfetto 基础和案例分享</a></li>
</ol>
<p>如果大家还没看过 Systrace 系列，下面是传送门：</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F05%2F26%2FAndroid_Systrace_0%2F%23%2F%25E7%25B3%25BB%25E5%2588%2597%25E6%2596%2587%25E7%25AB%25A0%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2019/05/26/Android_Systrace_0/#/%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Systrace 系列目录</a> ： 系统介绍了 Perfetto 的前身 Systrace 的使用，并通过 Systrace 来学习和了解 Android 性能优化和 Android 系统运行的基本规则。</li>
<li>本文的 Systrace 版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2019%2F10%2F22%2FAndroid-Choreographer%2F" target="_blank" title="https://androidperformance.com/2019/10/22/Android-Choreographer/" ref="nofollow noopener noreferrer">Android 基于 Choreographer 的渲染机制详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F" target="_blank" title="https://www.androidperformance.com/" ref="nofollow noopener noreferrer">个人博客</a> ：个人博客，主要是 Android 相关的内容，也放了一些生活和工作相关的内容。</li>
</ol>
<p>欢迎大家在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">关于我</a> 页面加入微信群或者星球，讨论你的问题、你最想看到的关于 Perfetto 的部分，以及跟各位群友讨论所有 Android 开发相关的内容</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-main-thread-essence" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-2">主线程运行机制的本质</h2>
<p>在讲 Choreographer 之前，我们先理一下 Android 主线程运行的本质，其实就是 Message 的处理过程，我们的各种操作，包括每一帧的渲染操作 ，都是通过 Message 的形式发给主线程的 MessageQueue ，MessageQueue 处理完消息继续等下一个消息，如下图所示</p>
<p><strong>MethodTrace 图示</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c548c24cdd548e58c5e8f90704127e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=OEg3kRXUw7EqjcGu3lrYv9GupUM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>Perfetto 图示</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9636098f335b49cca9f35b123eeba44b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=PtXiD6FGpx33xXm1ZIK%2B7ho5zYA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">演进</h3>
<p>引入 Vsync 之前的 Android 版本，渲染一帧相关的 Message ，中间是没有间隔的，上一帧绘制完，下一帧的 Message 紧接着就开始被处理。这样的问题就是，帧率不稳定，可能高也可能低，不稳定，如下图</p>
<p><strong>MethodTrace 图示</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/510098a7e6e6471584b0a8cb7ba30cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=mqUB1B6jBGiQI%2FN%2FcNmfovoELVk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>Trace 图示（资源比较老，用 Systrace 图示)</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd2ca16daf74409e9de862c64f312458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=gC5lwUJr2wPzcYuULpvVoyksYCw%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到这时候的瓶颈是在 dequeueBuffer, 因为屏幕是有刷新周期的, FB 消耗 Front Buffer 的速度是一定的, 所以 SF 消耗 App Buffer 的速度也是一定的, 所以 App 会卡在 dequeueBuffer 这里,这就会导致 App Buffer 获取不稳定, 很容易就会出现卡顿掉帧的情况.</p>
<p>对于用户来说，稳定的帧率才是好的体验，比如你玩王者荣耀，相比 fps 在 60 和 40 之间频繁变化，用户感觉更好的是稳定在 50 fps 的情况.</p>
<p>所以 Android 的演进中，最初引入了 <strong>Vsync + TripleBuffer + Choreographer</strong> 的机制，后来在 Android S (Android 12) 版本又进一步引入了 <strong>BlastBufferQueue</strong>，共同构成了现代 Android 稳定帧率输出机制，让软件层和硬件层可以以共同的频率一起工作。</p>
<h3 data-id="heading-4">引入 Choreographer</h3>
<p>Choreographer 的引入主要是配合 Vsync，为上层应用的渲染提供稳定的 Message 处理时机。当 Vsync 信号到来时，系统通过对 Vsync 信号周期的调整，控制每一帧绘制操作的时机。目前主流手机的屏幕刷新率已达到 120Hz，即每 8.3ms 刷新一次，系统为配合屏幕刷新频率，相应调整 Vsync 周期。每个 Vsync 周期到来时，Vsync 信号唤醒 Choreographer 执行应用的绘制操作，如果每个 Vsync 周期应用都能渲染完成，那么应用的 fps 就是120，给用户的感觉就是非常流畅，这就是引入 Choreographer 的主要作用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e7c3e9d02944cc59d72fcbfb4664fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=ELOM0N6PbwW2jt%2BbjlRwBvBJ9ZE%3D" alt="image.png" loading="lazy"/></p>
<p>当然目前主流旗舰手机的刷新率已达到120Hz，Vsync周期已缩短至8.3ms，上图中的操作要在更短的时间内完成，对性能的要求也越来越高，具体可以看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F05%2F15%2F90hz-on-android%2F" target="_blank" title="https://www.androidperformance.com/2019/05/15/90hz-on-android/" ref="nofollow noopener noreferrer">新的流畅体验，90Hz 漫谈</a> 这篇文章(文章虽然讨论90Hz，但同样的原理适用于120Hz)</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-choreographer-intro" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-5">Choreographer 简介</h2>
<p>Choreographer 扮演 Android 渲染链路中承上启下的角色</p>
<ol start="0">
<li><strong>承上</strong>：负责接收和处理 App 的各种更新消息和回调，等到 Vsync 到来的时候统一处理。比如集中处理 Input（主要是 Input 事件的处理）、Animation（动画相关）、Traversal（包括 measure、layout、draw 等操作），判断卡顿掉帧情况，记录 CallBack 耗时等</li>
<li><strong>启下</strong>：负责请求和接收 Vsync 信号。接收 Vsync 事件回调（通过 FrameDisplayEventReceiver.onVsync）；请求 Vsync（FrameDisplayEventReceiver.scheduleVsync）</li>
</ol>
<p>从上面可以看出，Choreographer 在 Android 渲染管线中扮演关键的协调者角色，其重要性在于通过 <strong>Choreographer + SurfaceFlinger + Vsync + BlastBufferQueue</strong> 这一套完整的渲染机制，确保 Android 应用能够以稳定的帧率运行（60 fps、90 fps 或 120 fps），有效减少帧率波动带来的视觉不适感。</p>
<p>了解 Choreographer 还可以帮助应用开发者深入理解每一帧的运行原理，同时加深对 <strong>Message</strong>、<strong>Handler</strong>、<strong>Looper</strong>、<strong>MessageQueue</strong>、<strong>Input</strong>、<strong>Animation</strong>、<strong>Measure</strong>、<strong>Layout</strong>、<strong>Draw</strong> 等核心组件的认识。许多 <strong>APM</strong>（应用性能监控）工具也利用了 <strong>Choreographer</strong>（通过 FrameCallback + FrameInfo）、<strong>MessageQueue</strong>（通过 IdleHandler）和 <strong>Looper</strong>（通过自定义 MessageLogging）这些组合机制进行性能监测。深入理解这些机制后，开发者可以更有针对性地进行性能优化，形成系统化的优化思路。</p>
<p>另外，虽然图表是解释流程的有效方式，但本文将更多依赖 Perfetto 和 MethodTrace 工具的可视化输出。Perfetto 以时间线方式（从左到右）展示整个系统的运行状况，涵盖 CPU、SurfaceFlinger、SystemServer 和应用进程等关键组件的活动。使用 <strong>Perfetto</strong> 和 <strong>MethodTrace</strong> 可以直观展示关键执行流程，当您熟悉系统代码后，Perfetto 的输出能够直接映射到设备的实际运行状态。因此，本文除了引用少量网络图表外，主要依靠 Perfetto 来展示分析结果。</p>
<h3 data-id="heading-6">从 Perfetto 的角度来看 Choreographer 的工作流程</h3>
<p>下图以滑动设置界面为例子，我们先看一下从上到下设置界面的一个完整的预览图，可以看到 Perfetto 中从左到右，每一个绿色的帧都表示一帧，表示最终我们可以手机上看到的画面</p>
<ol start="0">
<li>图中每一个 VSYNC-app 的值的区间是一个 Vsync 的时间，对应当前设备的刷新率，如 60Hz 时为 16.6ms，120Hz时为8.3ms，上升沿或者下降沿就是 Vsync 到达的时间</li>
<li>每一帧处理的流程：接收到 Vsync 信号回调-&gt; UI Thread --&gt; RenderThread --&gt; SurfaceFlinger</li>
<li>UI Thread 和 RenderThread 就可以完成 App 一帧的渲染，在最新的 Android 15 中，通过 BlastBufferQueue 机制，渲染完的 Buffer 抛给 SurfaceFlinger 去合成，然后我们就可以在屏幕上看到这一帧了</li>
<li>可以看到桌面滑动的每一帧耗时都很短（Ui Thread 耗时 + RenderThread 耗时），但是由于 Vsync 的存在，每一帧都会等到 Vsync 才会去做处理</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e044470253754f70b0300f583f0b2758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=ePq6F4ONhgKzPOrC0Sj3Xp0n058%3D" alt="image.png" loading="lazy"/></p>
<p>有了上面这个整体的概念，我们将 UI Thread 的每一帧放大来看，看看 Choreographer 的位置以及 Choreographer 是怎么组织每一帧的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39349d3592a7409fb4a217957b0e5df9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=%2FqzIlTBUrSFtvzA91q3CdBruW3E%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">Choreographer 的工作流程</h3>
<ol start="0">
<li>Choreographer 初始化</li>
<li>初始化 FrameHandler，绑定 Looper</li>
<li>初始化 FrameDisplayEventReceiver，与 SurfaceFlinger 建立通信用于接收和请求 Vsync</li>
<li>初始化 CallBackQueues</li>
<li>SurfaceFlinger 的 appEventThread 唤醒发送 Vsync，Choreographer 回调 FrameDisplayEventReceiver.onVsync，进入 Choreographer 的主处理函数 doFrame</li>
<li>Choreographer.doFrame 计算掉帧逻辑</li>
<li>Choreographer.doFrame 处理 Choreographer 的第一个 callback：input</li>
<li>Choreographer.doFrame 处理 Choreographer 的第二个 callback：animation</li>
<li>Choreographer.doFrame 处理 Choreographer 的第三个 callback：insets animation</li>
<li>Choreographer.doFrame 处理 Choreographer 的第四个 callback：traversal</li>
<li>traversal-draw 中 UIThread 与 RenderThread 同步数据</li>
<li>Choreographer.doFrame 处理 Choreographer 的第五个 callback：commit</li>
<li>RenderThread 处理绘制命令</li>
<li>在 Android S (Android 12) 及以上版本中，RenderThread 通过 BlastBufferQueue 向 SurfaceFlinger 提交绘制内容</li>
<li>BlastBufferQueue 由 App 端创建和管理</li>
<li>通过生产者 (BBQ_BufferQueue_Producer) 和消费者 (BufferQueue_Consumer) 模型工作</li>
<li>UI 线程不必等待 RenderThread 完成，可以更早地准备下一帧，减少了主线程阻塞</li>
</ol>
<p><strong>第一步初始化完成后，后续就会在步骤 2-10 之间循环</strong></p>
<p>同时也附上这一帧所对应的 MethodTrace（这里预览一下即可，下面会有详细的大图）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/498313dd61814c3aac8b32b8b4e1f9fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=5gPCM6alNlBab32b3SEmY%2BILMA4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">Choreographer 与 RenderThread 及 BlastBufferQueue 的交互</h3>
<p>Android S (Android 12) 中，RenderThread 与 SurfaceFlinger 之间的交互发生了重要变化，其核心是 BlastBufferQueue 的引入。下面我们来看看这一机制是如何工作的。</p>
<h4 data-id="heading-9">BlastBufferQueue 工作原理</h4>
<p>BlastBufferQueue 是一个专为 UI 渲染优化的 BufferQueue 变体，它替代了传统由 SurfaceFlinger 创建的 BufferQueue，转为由 App 端创建和管理，用于 App 与 SurfaceFlinger 之间的缓冲区管理。</p>
<ol start="0">
<li>
<p><strong>更高效的缓冲区管理</strong> 在传统的 BufferQueue 中，App 需要通过 dequeueBuffer 获取一个可用的缓冲区，然后渲染内容，最后通过 queueBuffer 将缓冲区提交给 SurfaceFlinger。这个过程中，如果没有可用的缓冲区，App 需要等待，这会导致阻塞。</p>
<p>BlastBufferQueue 通过更智能的缓冲区管理，减少了这种等待，特别是在高刷新率设备上，效果更明显。</p>
</li>
<li>
<p><strong>RenderThread 与 UI 线程的解耦</strong> 在 Android S 之前，UI 线程（主线程）需要等待 RenderThread 完成工作才能继续处理下一帧。而在新的架构中，UI 线程可以更早地完成自己的工作，将渲染任务交给 RenderThread 后即可准备下一帧的工作，不必等待当前帧完全渲染完成。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 在 ViewRootImpl.performTraversals() 中</span>
<span class="hljs-comment">// 旧版本需要等待 draw 完成</span>
<span class="hljs-built_in">performDraw</span>(); <span class="hljs-comment">// 这里会阻塞等待 RenderThread</span>

<span class="hljs-comment">// BlastBufferQueue 引入后</span>
<span class="hljs-built_in">scheduleTraversals</span>(); <span class="hljs-comment">// 可以更早地准备下一帧</span>
</code></pre>
</li>
<li>
<p><strong>创建机制</strong> BlastBufferQueue 在 ViewRootImpl 的 relayoutWindow 过程中创建：</p>
<pre><code class="hljs language-ini" lang="ini">// 创建 BBQ 的示例代码
if (<span class="hljs-attr">mBlastBufferQueue</span> == null) {
    <span class="hljs-attr">mBlastBufferQueue</span> = new BLASTBufferQueue(mTag, mSurfaceControl,
        mSurfaceSize.x, mSurfaceSize.y,
        mWindowAttributes.format)<span class="hljs-comment">;</span>
}
</code></pre>
</li>
<li>
<p><strong>与 Choreographer 的配合</strong> Choreographer 仍然是协调这一切的核心。当 Vsync 信号到来时，Choreographer 会触发 doFrame，执行各种回调，其中 CALLBACK_TRAVERSAL 会触发 ViewRootImpl 的 performTraversals()，最终走到 draw 流程。</p>
<p>在 draw 流程中，通过 BlastBufferQueue，RenderThread 可以更独立地工作，而 UI 线程可以更早地返回处理其他任务。</p>
</li>
</ol>
<p>下面我们就从源码的角度，来看一下具体的实现</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-source" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-10">源码解析</h2>
<p>下面从源码的角度来简单看一下，源码只摘抄了部分重要的逻辑，其他的逻辑则被剔除，另外 Native 部分与 SurfaceFlinger 交互的部分也没有列入，不是本文的重点，有兴趣的可以自己去跟一下。下面的源码基于Android 15 的最新实现。</p>
<h3 data-id="heading-11">Choreographer 的初始化</h3>
<h4 data-id="heading-12">Choreographer 的单例初始化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Thread local storage for the choreographer.</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Choreographer&gt; sThreadInstance =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;Choreographer&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Choreographer <span class="hljs-title function_">initialValue</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 获取当前线程的 Looper</span>
        <span class="hljs-type">Looper</span> <span class="hljs-variable">looper</span> <span class="hljs-operator">=</span> Looper.myLooper();
        <span class="hljs-keyword">if</span> (looper == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"The current thread must have a looper!"</span>);
        }
        <span class="hljs-comment">// 构造 Choreographer 对象，使用 VSYNC_SOURCE_APP 作为Vsync源</span>
        <span class="hljs-type">Choreographer</span> <span class="hljs-variable">choreographer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Choreographer</span>(looper, VSYNC_SOURCE_APP);
        <span class="hljs-keyword">if</span> (looper == Looper.getMainLooper()) {
            mMainInstance = choreographer;
        }
        <span class="hljs-keyword">return</span> choreographer;
    }
};
</code></pre>
<h4 data-id="heading-13">Choreographer 的构造函数</h4>
<pre><code class="hljs language-ini" lang="ini">private Choreographer(Looper looper, int vsyncSource) {
    <span class="hljs-attr">mLooper</span> = looper<span class="hljs-comment">;</span>
    // 1. 初始化 FrameHandler
    <span class="hljs-attr">mHandler</span> = new FrameHandler(looper)<span class="hljs-comment">;</span>
    // 2. 初始化 DisplayEventReceiver
    <span class="hljs-attr">mDisplayEventReceiver</span> = USE_VSYNC
            ? new FrameDisplayEventReceiver(looper, vsyncSource)
            : null<span class="hljs-comment">;</span>
    <span class="hljs-attr">mLastFrameTimeNanos</span> = Long.MIN_VALUE<span class="hljs-comment">;</span>
    <span class="hljs-attr">mFrameIntervalNanos</span> = (long)(<span class="hljs-number">1000000000</span> / getRefreshRate())<span class="hljs-comment">;</span>
    //3. 初始化 CallbacksQueues
    <span class="hljs-attr">mCallbackQueues</span> = new CallbackQueue[CALLBACK_LAST + <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= CALLBACK_LAST; i++) {</span>
        mCallbackQueues<span class="hljs-section">[i]</span> = new CallbackQueue()<span class="hljs-comment">;</span>
    }
    ......
}
</code></pre>
<h4 data-id="heading-14">FrameHandler</h4>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FrameHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>{
    ......
    public void handleMessage(<span class="hljs-type">Message</span> msg) {
        switch (msg.what) {
            <span class="hljs-keyword">case</span> <span class="hljs-type">MSG_DO_FRAME</span>:<span class="hljs-comment">//开始渲染下一帧的操作</span>
                doFrame(<span class="hljs-type">System</span>.nanoTime(), <span class="hljs-number">0</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-type">MSG_DO_SCHEDULE_VSYNC</span>:<span class="hljs-comment">//请求 Vsync </span>
                doScheduleVsync();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-type">MSG_DO_SCHEDULE_CALLBACK</span>:<span class="hljs-comment">//处理 Callback</span>
                doScheduleCallback(msg.arg1);
                <span class="hljs-keyword">break</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-15">Choreographer 初始化链</h4>
<p>在 Activity 启动过程，执行完 onResume 后，会调用 Activity.makeVisible()，然后再调用到 addView()， 层层调用会进入如下方法</p>
<pre><code class="hljs language-scss" lang="scss">ActivityThread<span class="hljs-selector-class">.handleResumeActivity</span>(IBinder, boolean, boolean, String) (android.app) 
--&gt;WindowManagerImpl<span class="hljs-selector-class">.addView</span>(View, LayoutParams) (android.view) 
  --&gt;WindowManagerGlobal<span class="hljs-selector-class">.addView</span>(View, LayoutParams, Display, Window) (android.view) 
    --&gt;ViewRootImpl<span class="hljs-selector-class">.ViewRootImpl</span>(Context, Display) (android.view) 
    public <span class="hljs-built_in">ViewRootImpl</span>(Context context, Display display) {
        ......
        mChoreographer = Choreographer<span class="hljs-selector-class">.getInstance</span>();
        ......
    }
</code></pre>
<h3 data-id="heading-16">FrameDisplayEventReceiver 简介</h3>
<p>Vsync 的注册、申请、接收都是通过 FrameDisplayEventReceiver 这个类，所以可以先简单介绍一下。 FrameDisplayEventReceiver 继承 DisplayEventReceiver ， 有三个比较重要的方法</p>
<ol start="0">
<li>onVsync -- Vsync 信号回调</li>
<li>run -- 执行 doFrame</li>
<li>scheduleVsync -- 请求 Vsync 信号</li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrameDisplayEventReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DisplayEventReceiver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    ......
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onVsync</span><span class="hljs-params">(<span class="hljs-type">long</span> timestampNanos, <span class="hljs-type">long</span> physicalDisplayId, <span class="hljs-type">int</span> frame, VsyncEventData eventData)</span> {
        ......
        mTimestampNanos = timestampNanos;
        mFrame = frame;
        <span class="hljs-comment">// Android 15中新增的VsyncEventData传递更丰富的Vsync事件数据</span>
        mVsyncEventData = eventData;
        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain(mHandler, <span class="hljs-built_in">this</span>);
        msg.setAsynchronous(<span class="hljs-literal">true</span>);
        mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        mHavePendingVsync = <span class="hljs-literal">false</span>;
        doFrame(mTimestampNanos, mFrame, mVsyncEventData);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleVsync</span><span class="hljs-params">()</span> {
        ......  
        nativeScheduleVsync(mReceiverPtr);
        ......
    }
}
</code></pre>
<h3 data-id="heading-17">Choreographer 中 Vsync 的注册</h3>
<p>从下面的函数调用栈可以看到，Choreographer 的内部类 FrameDisplayEventReceiver.onVsync 负责接收 Vsync 回调，通知 UIThread 进行数据处理。</p>
<p>那么 FrameDisplayEventReceiver 是通过什么方式在 Vsync 信号到来的时候回调 onVsync 呢？答案是 FrameDisplayEventReceiver 的初始化的时候，最终通过监听文件句柄的形式，其对应的初始化流程如下</p>
<p>android/view/Choreographer.java</p>
<pre><code class="hljs language-ini" lang="ini">private Choreographer(Looper looper, int vsyncSource) {
    <span class="hljs-attr">mLooper</span> = looper<span class="hljs-comment">;</span>
    <span class="hljs-attr">mDisplayEventReceiver</span> = USE_VSYNC
            ? new FrameDisplayEventReceiver(looper, vsyncSource)
            : null<span class="hljs-comment">;</span>
    ......
}
</code></pre>
<p>android/view/Choreographer.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">FrameDisplayEventReceiver</span><span class="hljs-params">(Looper looper, <span class="hljs-type">int</span> vsyncSource)</span> {
    <span class="hljs-built_in">super</span>(looper, vsyncSource);
}
</code></pre>
<p>android/view/DisplayEventReceiver.java</p>
<pre><code class="hljs language-ini" lang="ini">public DisplayEventReceiver(Looper looper, int vsyncSource) {
    ......
    <span class="hljs-attr">mMessageQueue</span> = looper.getQueue()<span class="hljs-comment">;</span>
    <span class="hljs-attr">mReceiverPtr</span> = nativeInit(new WeakReference&lt;DisplayEventReceiver&gt;(this), mMessageQueue,
            vsyncSource)<span class="hljs-comment">;</span>
}
</code></pre>
<p>简单来说，FrameDisplayEventReceiver 的初始化过程中，通过 BitTube (本质是一个 socket pair)，来传递和请求 Vsync 事件，当 SurfaceFlinger 收到 Vsync 事件之后，通过 appEventThread 将这个事件通过 BitTube 传给 DisplayEventDispatcher，DisplayEventDispatcher 通过 BitTube 的接收端监听到 Vsync 事件之后，回调 Choreographer.FrameDisplayEventReceiver.onVsync，触发开始一帧的绘制，如下图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecb072fe65a74dc49ae9a2ad2c4bfebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=SFOeMQ4g5%2BBVAuqHmTpoNsPAq8c%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-18">DisplayEventReceiver 与 SurfaceFlinger 的通信细节</h4>
<p>在 Android 系统中，DisplayEventReceiver 通过 JNI 调用 nativeInit 方法来建立与 SurfaceFlinger 服务的通信通道。这个过程涉及多个关键步骤：</p>
<ol start="0">
<li><strong>创建 NativeDisplayEventReceiver 对象</strong>：在 Java 层调用 nativeInit 后，JNI 创建一个 NativeDisplayEventReceiver 实例，用于接收 Vsync 信号。</li>
<li><strong>获取 IDisplayEventConnection</strong>：通过 ISurfaceComposer 接口获取 IDisplayEventConnection，这是一个 Binder 接口，用于与 SurfaceFlinger 服务通信。</li>
<li><strong>建立 BitTube 连接</strong>：BitTube 是一个基于 socket pair 的通信机制，专为高频、小数据量的跨进程通信设计。它在 App 进程和 SurfaceFlinger 进程之间创建一个高效的通信通道。</li>
<li><strong>文件描述符监听</strong>：通过 Looper 监听 BitTube 的文件描述符，当有 Vsync 信号到来时，Looper 会通知 DisplayEventDispatcher 处理事件。</li>
</ol>
<p>整个通信流程如下：</p>
<pre><code class="hljs language-lua" lang="lua">App 进程                                    SurfaceFlinger 进程
  |                                             |
  |<span class="hljs-comment">-- 创建 DisplayEventReceiver --------------&gt;|</span>
  |                                             |
  |&lt;- 返回 IDisplayEventConnection (Binder) <span class="hljs-comment">----|</span>
  |                                             |
  |<span class="hljs-comment">-- 创建 BitTube --------------------------&gt;|</span>
  |                                             |
  |&lt;- 文件描述符交换 <span class="hljs-comment">--------------------------|</span>
  |                                             |
  |<span class="hljs-comment">-- 注册文件描述符到 Looper ----------------|</span>
  |                                             |
  |<span class="hljs-comment">-- 请求 Vsync (requestNextVsync) ----------&gt;|</span>
  |                                             |
  |&lt;- 发送 Vsync 事件数据 <span class="hljs-comment">---------------------|</span>
  |                                             |
  |<span class="hljs-comment">-- Looper 通知 -&gt; handleEvent -------------|</span>
  |                                             |
  |<span class="hljs-comment">-- 回调 Java 层 onVsync -------------------|</span>
  |                                             |
</code></pre>
<p>这种设计的优势在于避免了使用 Binder 传递高频的 Vsync 事件数据，通过直接的 socket 通信提高了性能和实时性，这对于保证流畅的 UI 渲染至关重要。同时，由于 BitTube 使用了文件描述符，可以无缝集成到 Android 的 Looper 机制中，使得整个系统能够以事件驱动的方式工作。</p>
<h3 data-id="heading-19">Choreographer 处理一帧的逻辑</h3>
<p>Choreographer 处理绘制的逻辑核心在 Choreographer.doFrame 函数中，从下图可以看到，FrameDisplayEventReceiver.onVsync post 了自己，其 run 方法直接调用了 doFrame 开始一帧的逻辑处理</p>
<p>android/view/Choreographer.java</p>
<pre><code class="hljs language-ini" lang="ini">public void onVsync(long timestampNanos, long physicalDisplayId, int frame, VsyncEventData eventData) {
    ......
    <span class="hljs-attr">mTimestampNanos</span> = timestampNanos<span class="hljs-comment">;</span>
    <span class="hljs-attr">mFrame</span> = frame<span class="hljs-comment">;</span>
    <span class="hljs-attr">mVsyncEventData</span> = eventData<span class="hljs-comment">;</span>
    Message <span class="hljs-attr">msg</span> = Message.obtain(mHandler, this)<span class="hljs-comment">;</span>
    msg.setAsynchronous(true)<span class="hljs-comment">;</span>
    mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS)<span class="hljs-comment">;</span>
}
public void run() {
    <span class="hljs-attr">mHavePendingVsync</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    doFrame(mTimestampNanos, mFrame, mVsyncEventData)<span class="hljs-comment">;</span>
}
</code></pre>
<p>doFrame 函数主要做下面几件事</p>
<ol start="0">
<li>计算掉帧逻辑</li>
<li>记录帧绘制信息</li>
<li>执行 CALLBACK_INPUT、CALLBACK_ANIMATION、CALLBACK_INSETS_ANIMATION、CALLBACK_TRAVERSAL、CALLBACK_COMMIT</li>
</ol>
<h4 data-id="heading-20">记录帧绘制信息</h4>
<p>Choreographer 中 FrameInfo 来负责记录帧的绘制信息，doFrame 执行的时候，会把每一个关键节点的绘制时间记录下来，我们使用 dumpsys gfxinfo 就可以看到。当然 Choreographer 只是记录了一部分，剩余的部分在 hwui 那边来记录。</p>
<p>从 FrameInfo 这些标志就可以看出记录的内容，后面我们看 dumpsys gfxinfo 的时候数据就是按照这个来排列的</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> FrameInfoFlags {}

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FRAME_TIMELINE_VSYNC_ID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

    <span class="hljs-comment">// The intended vsync time, unadjusted by jitter</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INTENDED_VSYNC</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

    <span class="hljs-comment">// Jitter-adjusted vsync time, this is what was used as input into the</span>
    <span class="hljs-comment">// animation &amp; drawing system</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">VSYNC</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;

    <span class="hljs-comment">// The id of the input event that caused the current frame</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INPUT_EVENT_ID</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;

    <span class="hljs-comment">// When input event handling started</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HANDLE_INPUT_START</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;

    <span class="hljs-comment">// When animation evaluations started</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ANIMATION_START</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;

    <span class="hljs-comment">// When ViewRootImpl#performTraversals() started</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PERFORM_TRAVERSALS_START</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;

    <span class="hljs-comment">// When View:draw() started</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DRAW_START</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;

    <span class="hljs-comment">// When the frame needs to be ready by</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FRAME_DEADLINE</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>;

    <span class="hljs-comment">// When frame actually started.</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FRAME_START_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;

    <span class="hljs-comment">// Interval between two consecutive frames</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FRAME_INTERVAL</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span>;
</code></pre>
<p>doFrame 函数记录从 Vsync time 到 markPerformTraversalsStart 的时间</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">doFrame</span>(long frameTimeNanos, int frame, VsyncEventData eventData) {
    ......
    mFrameInfo<span class="hljs-selector-class">.setVsync</span>(intendedFrameTimeNanos, frameTimeNanos);
    <span class="hljs-comment">// 处理 CALLBACK_INPUT Callbacks </span>
    mFrameInfo<span class="hljs-selector-class">.markInputHandlingStart</span>();
    <span class="hljs-comment">// 处理 CALLBACK_ANIMATION Callbacks</span>
    mFrameInfo<span class="hljs-selector-class">.markAnimationsStart</span>();
    <span class="hljs-comment">// 处理 CALLBACK_INSETS_ANIMATION Callbacks</span>
    <span class="hljs-comment">// 处理 CALLBACK_TRAVERSAL Callbacks</span>
    mFrameInfo<span class="hljs-selector-class">.markPerformTraversalsStart</span>();
    <span class="hljs-comment">// 处理 CALLBACK_COMMIT Callbacks</span>
    ......
}
</code></pre>
<h4 data-id="heading-21">执行 Callbacks</h4>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">doFrame</span>(long frameTimeNanos, int frame, VsyncEventData eventData) {
    ......
    <span class="hljs-comment">// 处理 CALLBACK_INPUT Callbacks </span>
    <span class="hljs-built_in">doCallbacks</span>(Choreographer.CALLBACK_INPUT, frameTimeNanos);
    <span class="hljs-comment">// 处理 CALLBACK_ANIMATION Callbacks</span>
    <span class="hljs-built_in">doCallbacks</span>(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);
    <span class="hljs-comment">// 处理 CALLBACK_INSETS_ANIMATION Callbacks</span>
    <span class="hljs-built_in">doCallbacks</span>(Choreographer.CALLBACK_INSETS_ANIMATION, frameTimeNanos);
    <span class="hljs-comment">// 处理 CALLBACK_TRAVERSAL Callbacks</span>
    <span class="hljs-built_in">doCallbacks</span>(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);
    <span class="hljs-comment">// 处理 CALLBACK_COMMIT Callbacks</span>
    <span class="hljs-built_in">doCallbacks</span>(Choreographer.CALLBACK_COMMIT, frameTimeNanos);
    ......
}
</code></pre>
<p><strong>Input 回调调用栈</strong></p>
<p><strong>input callback</strong> 一般是执行 ViewRootImpl.ConsumeBatchedInputRunnable</p>
<p>android/view/ViewRootImpl.java</p>
<pre><code class="hljs language-scss" lang="scss">final class ConsumeBatchedInputRunnable implements Runnable {
    <span class="hljs-keyword">@Override</span>
    public void run() {
        <span class="hljs-built_in">doConsumeBatchedInput</span>(mChoreographer.getFrameTimeNanos());
    }
}
void <span class="hljs-built_in">doConsumeBatchedInput</span>(long frameTimeNanos) {
    if (mConsumeBatchedInputScheduled) {
        mConsumeBatchedInputScheduled = false;
        if (mInputEventReceiver != null) {
            if (mInputEventReceiver.consumeBatchedInputEvents(frameTimeNanos)
                    &amp;&amp; frameTimeNanos != -<span class="hljs-number">1</span>) {
                <span class="hljs-built_in">scheduleConsumeBatchedInput</span>();
            }
        }
        <span class="hljs-built_in">doProcessInputEvents</span>();
    }
}
</code></pre>
<p>Input 时间经过处理，最终会传给 DecorView 的 dispatchTouchEvent，这就到了我们熟悉的 Input 事件分发</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/191afc55352b410aba974f863eaf63ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=EymscEVenPYx%2F3ysEYGXvKvQO80%3D" alt="image.png" loading="lazy"/></p>
<p><strong>Animation 回调调用栈</strong></p>
<p>一般我们接触的多的是调用 View.postOnAnimation 的时候，会使用到 CALLBACK_ANIMATION</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postOnAnimation</span><span class="hljs-params">(Runnable action)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">AttachInfo</span> <span class="hljs-variable">attachInfo</span> <span class="hljs-operator">=</span> mAttachInfo;
    <span class="hljs-keyword">if</span> (attachInfo != <span class="hljs-literal">null</span>) {
        attachInfo.mViewRootImpl.mChoreographer.postCallback(
                Choreographer.CALLBACK_ANIMATION, action, <span class="hljs-literal">null</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Postpone the runnable until we know</span>
        <span class="hljs-comment">// on which thread it needs to run.</span>
        getRunQueue().post(action);
    }
}
</code></pre>
<p>那么一般是什么时候回调用到 View.postOnAnimation 呢，我截取了一张图，大家可以自己去看一下，接触最多的应该是 startScroll，Fling 这种操作</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ff4c311317045aa8dab1aa4cdfa6be5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=rpFceew2HpdwDb0cXW4%2BmdU%2FWjQ%3D" alt="image.png" loading="lazy"/></p>
<p>其调用栈根据其 post 的内容，下面是松手之后的 fling 动画。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22d48f425c9e44a087e0e2f00247f452~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=fY5JEsBPX%2FpUbmadHfJvXEqhhQs%3D" alt="image.png" loading="lazy"/></p>
<p>另外我们的 Choreographer 的 FrameCallback 也是用的 CALLBACK_ANIMATION</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postFrameCallbackDelayed</span>(<span class="hljs-params">FrameCallback callback, <span class="hljs-built_in">long</span> delayMillis</span>)</span> {
    <span class="hljs-keyword">if</span> (callback == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"callback must not be null"</span>);
    }

    postCallbackDelayedInternal(CALLBACK_ANIMATION,
            callback, FRAME_CALLBACK_TOKEN, delayMillis);
}
</code></pre>
<p><strong>Traversal 调用栈</strong></p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">scheduleTraversals</span>() {
    if (!mTraversalScheduled) {
        mTraversalScheduled = true;
        <span class="hljs-comment">//为了提高优先级，先 postSyncBarrier</span>
        mTraversalBarrier = mHandler<span class="hljs-selector-class">.getLooper</span>()<span class="hljs-selector-class">.getQueue</span>()<span class="hljs-selector-class">.postSyncBarrier</span>();
        mChoreographer<span class="hljs-selector-class">.postCallback</span>(
                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);
    }
}

final class TraversalRunnable implements Runnable {
    <span class="hljs-keyword">@Override</span>
    public void run() {
        <span class="hljs-comment">// 真正开始执行 measure、layout、draw</span>
        <span class="hljs-built_in">doTraversal</span>();
    }
}
void <span class="hljs-built_in">doTraversal</span>() {
    if (mTraversalScheduled) {
        mTraversalScheduled = false;
        <span class="hljs-comment">// 这里把 SyncBarrier remove</span>
mHandler<span class="hljs-selector-class">.getLooper</span>()<span class="hljs-selector-class">.getQueue</span>()<span class="hljs-selector-class">.removeSyncBarrier</span>(mTraversalBarrier);
        <span class="hljs-comment">// 真正开始</span>
        <span class="hljs-built_in">performTraversals</span>();
    }
}
private void <span class="hljs-built_in">performTraversals</span>() {
      <span class="hljs-comment">// measure 操作</span>
      if (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth() || mHeight != host<span class="hljs-selector-class">.getMeasuredHeight</span>() || contentInsetsChanged || updatedConfiguration) {
            <span class="hljs-built_in">performMeasure</span>(childWidthMeasureSpec, childHeightMeasureSpec);
      }
      <span class="hljs-comment">// layout 操作</span>
      if (didLayout) {
          <span class="hljs-built_in">performLayout</span>(lp, mWidth, mHeight);
      }
      <span class="hljs-comment">// draw 操作</span>
      if (!cancelDraw &amp;&amp; !newSurface) {
          <span class="hljs-built_in">performDraw</span>();
      }
}
</code></pre>
<p><strong>doTraversal 的 TraceView 示例</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75ae7521950b4456a9621e4596e0bc58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=JiFgX7RLtc3tGRBda4x2a87WhO0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-22">下一帧的 Vsync 请求</h3>
<p>由于动画、滑动、Fling 这些操作的存在，我们需要一个连续的、稳定的帧率输出机制。这就涉及到了 Vsync 的请求逻辑，在连续的操作，比如动画、滑动、Fling 这些情况下，每一帧的 doFrame 的时候，都会根据情况触发下一个 Vsync 的申请，这样我们就可以获得连续的 Vsync 信号。</p>
<p>看下面的 scheduleTraversals 调用栈(scheduleTraversals 中会触发 Vsync 请求)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e74c0706538541eeb14819b57e214bf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=57Sl%2B6b1maAne1N4NxqN46405ms%3D" alt="image.png" loading="lazy"/>
我们比较熟悉的 invalidate 和 requestLayout 都会触发 Vsync 信号请求</p>
<p>我们下面以 Animation 为例，看看 Animation 是如何驱动下一个 Vsync ，来持续更新画面的</p>
<h4 data-id="heading-23">ObjectAnimator 动画驱动逻辑</h4>
<p>android/animation/ObjectAnimator.java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">start</span>();
}
</code></pre>
<p>android/animation/ValueAnimator.java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">start</span><span class="hljs-params">(<span class="hljs-type">boolean</span> playBackwards)</span> </span>{
    ......
    <span class="hljs-built_in">addAnimationCallback</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 动画 start 的时候添加 Animation Callback </span>
    ......
}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">addAnimationCallback</span><span class="hljs-params">(<span class="hljs-type">long</span> delay)</span> </span>{
    ......
    <span class="hljs-built_in">getAnimationHandler</span>().<span class="hljs-built_in">addAnimationFrameCallback</span>(<span class="hljs-keyword">this</span>, delay);
}
</code></pre>
<p>android/animation/AnimationHandler.java</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">addAnimationFrameCallback</span>(final AnimationFrameCallback callback, long delay) {
    if (mAnimationCallbacks.size() == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// post FrameCallback</span>
        <span class="hljs-built_in">getProvider</span>()<span class="hljs-selector-class">.postFrameCallback</span>(mFrameCallback);
    }
    ......
}

<span class="hljs-comment">// 这里的 mFrameCallback 回调 doFrame，里面 post了自己</span>
private final Choreographer<span class="hljs-selector-class">.FrameCallback</span> mFrameCallback = new Choreographer<span class="hljs-selector-class">.FrameCallback</span>() {
    <span class="hljs-keyword">@Override</span>
    public void doFrame(long frameTimeNanos) {
        <span class="hljs-built_in">doAnimationFrame</span>(getProvider()<span class="hljs-selector-class">.getFrameTime</span>());
        if (mAnimationCallbacks.size() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// post 自己</span>
            <span class="hljs-built_in">getProvider</span>()<span class="hljs-selector-class">.postFrameCallback</span>(this);
        }
    }
};
</code></pre>
<p>调用 postFrameCallback 会走到 mChoreographer.postFrameCallback ，这里就会触发 Choreographer 的 Vsync 请求逻辑</p>
<p>android/animation/AnimationHandler.java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postFrameCallback</span>(<span class="hljs-params">Choreographer.FrameCallback callback</span>) {
    mChoreographer.<span class="hljs-title function_">postFrameCallback</span>(callback);
}
</code></pre>
<p>android/view/Choreographer.java</p>
<pre><code class="hljs language-ini" lang="ini">private void postCallbackDelayedInternal(int callbackType,
        Object action, Object token, long delayMillis) {
    synchronized (mLock) {
        final long <span class="hljs-attr">now</span> = SystemClock.uptimeMillis()<span class="hljs-comment">;</span>
        final long <span class="hljs-attr">dueTime</span> = now + delayMillis<span class="hljs-comment">;</span>
        mCallbackQueues<span class="hljs-section">[callbackType]</span>.addCallbackLocked(dueTime, action, token)<span class="hljs-comment">;</span>

        if (dueTime &lt;= now) {
            // 请求 Vsync scheduleFrameLocked -&gt;scheduleVsyncLocked-&gt; mDisplayEventReceiver.scheduleVsync -&gt;nativeScheduleVsync
            scheduleFrameLocked(now)<span class="hljs-comment">;</span>
        } else {
            Message <span class="hljs-attr">msg</span> = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action)<span class="hljs-comment">;</span>
            <span class="hljs-attr">msg.arg1</span> = callbackType<span class="hljs-comment">;</span>
            msg.setAsynchronous(true)<span class="hljs-comment">;</span>
            mHandler.sendMessageAtTime(msg, dueTime)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p>通过上面的 Animation.start 设置，利用了 Choreographer.FrameCallback 接口，每一帧都去请求下一个 Vsync <strong>动画过程中一帧的 TraceView 示例</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92a55ee533c4d489d675004803527c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=hZvDGY7bFZ0GhWmLN84B%2BorD3eM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-24">源码小结</h3>
<ol start="0">
<li>
<p><strong>Choreographer</strong> 采用线程单例模式设计，与Looper强耦合。每个线程只能拥有一个Choreographer实例，且必须绑定一个有效的Looper对象，因为其内部Handler依赖Looper进行消息分发。在应用中，通常绑定主线程的Looper以确保UI操作的线程安全性。</p>
</li>
<li>
<p><strong>DisplayEventReceiver</strong> 是一个抽象基类，其JNI实现创建IDisplayEventConnection对象作为Vsync信号的监听器。通过此机制，SurfaceFlinger的AppEventThread发出的Vsync中断信号能够被精确传递到Choreographer实例。当Vsync信号到达时，系统回调DisplayEventReceiver的onVsync方法，触发渲染流程。</p>
</li>
<li>
<p><strong>DisplayEventReceiver</strong> 提供scheduleVsync方法用于请求Vsync信号。应用程序需要更新UI时，先通过此方法申请下一个Vsync中断，然后在onVsync回调中执行实际的绘制逻辑，确保渲染与屏幕刷新同步。</p>
</li>
<li>
<p><strong>Choreographer</strong> 定义了FrameCallback接口，其doFrame方法在每次Vsync到来时被调用。这一设计对Android动画系统具有重要意义，使动画能够与屏幕刷新率精确同步，相比早期自行计时的实现，提供了更加流畅、省电的动画体验。</p>
</li>
<li>
<p><strong>Choreographer</strong> 核心功能是接收Vsync信号并触发通过postCallback注册的回调函数。框架定义了五种类型的回调，按照执行优先级排序：</p>
<ol start="0">
<li><strong>CALLBACK_INPUT</strong>：处理输入事件，如触摸、按键等交互</li>
<li><strong>CALLBACK_ANIMATION</strong>：处理各类动画计算与更新</li>
<li><strong>CALLBACK_INSETS_ANIMATION</strong>：处理系统插入动画，如软键盘、状态栏动画等</li>
<li><strong>CALLBACK_TRAVERSAL</strong>：处理视图树的测量、布局与绘制</li>
<li><strong>CALLBACK_COMMIT</strong>：执行收尾工作，包括组件内存回收(onTrimMemory)和性能监测</li>
</ol>
</li>
<li>
<p><strong>ListView</strong> 和 <strong>RecyclerView</strong> 的Item复用机制(ViewHolder模式)在框架层面上的具体实现会涉及到CALLBACK_INPUT和CALLBACK_ANIMATION阶段。在滑动或快速滚动时，Item的初始化、测量与绘制可能在Input回调中触发(如直接响应触摸事件)，也可能在Animation回调中执行(如惯性滑动或自动滚动)。RecyclerView通过更高效的复用机制和预取(Prefetch)策略，能够在这两个阶段更智能地准备ViewHolder，减少主线程阻塞，尤其在高刷新率设备上表现更为出色。</p>
</li>
<li>
<p><strong>CALLBACK_INPUT</strong> 和 <strong>CALLBACK_ANIMATION</strong> 在执行过程中会修改View的各种属性(如位置、透明度、变换矩阵等)，因此必须先于CALLBACK_TRAVERSAL执行，以确保所有状态更新都能在当前帧的测量、布局与绘制过程中被正确应用。这种严格的执行顺序保证了Android UI渲染的一致性和可预测性。</p>
</li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-apm" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-25">APM 与 Choreographer</h2>
<p>由于 Choreographer 的位置，许多性能监控的手段都是利用 Choreographer 来做的，除了自带的掉帧计算，Choreographer 提供的 FrameCallback 和 FrameInfo 都给 App 暴露了接口，让 App 开发者可以通过这些方法监控自身 App 的性能，其中常用的方法如下：</p>
<ol start="0">
<li>
<p>利用 FrameCallback 的 doFrame 回调</p>
</li>
<li>
<p>利用 FrameInfo 进行监控</p>
</li>
<li>
<p>使用 ：adb shell dumpsys gfxinfo  framestats</p>
<ol start="0">
<li>示例 ：adb shell dumpsys gfxinfo com.meizu.flyme.launcher framestats</li>
</ol>
</li>
<li>
<p>利用 SurfaceFlinger 进行监控</p>
<ol start="0">
<li>使用 ：adb shell dumpsys SurfaceFlinger --latency</li>
<li>示例 ：adb shell dumpsys SurfaceFlinger --latency com.meizu.flyme.launcher/com.meizu.flyme.launcher.Launcher#0</li>
</ol>
</li>
<li>
<p>利用 SurfaceFlinger PageFlip 机制进行监控</p>
<ol start="0">
<li>使用 ： adb service call SurfaceFlinger 1013</li>
<li>备注：需要系统权限</li>
</ol>
</li>
<li>
<p>Choreographer 自身的掉帧计算逻辑</p>
</li>
<li>
<p>BlockCanary 基于 Looper 的性能监控</p>
</li>
<li>
<p><strong>新增：Perfetto 工具的强大监控能力</strong></p>
<ol start="0">
<li>在Android 15中，Perfetto成为主要的性能分析工具，替代了早期的Systrace</li>
<li>Perfetto可以捕获更详细的系统性能数据，包括Choreographer的工作细节</li>
<li>使用Perfetto UI可以可视化分析帧渲染过程</li>
</ol>
</li>
</ol>
<h3 data-id="heading-26">利用 Perfetto 进行高级监控</h3>
<p>Perfetto 是 Android 新一代的系统跟踪工具，在 Android 15 中成为默认的性能分析解决方案。它提供了比 Systrace 更强大的功能：</p>
<ol start="0">
<li>
<p><strong>更全面的性能数据采集</strong> Perfetto 可以同时收集 CPU、内存、图形渲染、系统服务等多维度的数据</p>
</li>
<li>
<p><strong>更低的开销</strong> 采用高效的跟踪引擎，对系统性能影响更小</p>
</li>
<li>
<p><strong>更好的 Choreographer 追踪</strong> 可以详细跟踪 Choreographer 的工作过程，包括:</p>
<ul>
<li>Vsync 信号的接收和处理</li>
<li>doFrame 方法的执行细节</li>
<li>各类回调的执行时间</li>
<li>UI 线程和 RenderThread 的协作过程</li>
</ul>
</li>
<li>
<p><strong>追踪 BlastBufferQueue</strong> 能够跟踪新引入的 BlastBufferQueue 的工作过程，帮助开发者理解缓冲区管理机制</p>
</li>
</ol>
<h4 data-id="heading-27">使用 Perfetto 跟踪 Choreographer</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开始记录 Perfetto trace</span>
adb shell perfetto --txt -c /data/misc/perfetto-configs/chrome-trace.config -o /data/misc/perfetto-traces/trace.perfetto-trace

<span class="hljs-comment"># 完成后获取 trace 文件</span>
adb pull /data/misc/perfetto-traces/trace.perfetto-trace

<span class="hljs-comment"># 在 Perfetto UI 中分析(https://ui.perfetto.dev/)</span>
</code></pre>
<p>在 Perfetto UI 中，可以找到名为 "Choreographer#doFrame" 的事件，它展示了每一帧的处理时间和细节。还可以查看 UI 线程和 RenderThread 之间的协作关系，以及与 SurfaceFlinger 的交互。</p>
<h3 data-id="heading-28">利用 FrameInfo 进行监控</h3>
<p>adb shell dumpsys gfxinfo  framestats</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Window:</span> <span class="hljs-string">StatusBar</span>
<span class="hljs-attr">Stats since:</span> <span class="hljs-string">17990256398ns</span>
<span class="hljs-attr">Total frames rendered:</span> <span class="hljs-number">1562</span>
<span class="hljs-attr">Janky frames:</span> <span class="hljs-number">361</span> <span class="hljs-string">(23.11%)</span>
<span class="hljs-attr">50th percentile:</span> <span class="hljs-string">6ms</span>
<span class="hljs-attr">90th percentile:</span> <span class="hljs-string">23ms</span>
<span class="hljs-attr">95th percentile:</span> <span class="hljs-string">36ms</span>
<span class="hljs-attr">99th percentile:</span> <span class="hljs-string">101ms</span>
<span class="hljs-attr">Number Missed Vsync:</span> <span class="hljs-number">33</span>
<span class="hljs-attr">Number High input latency:</span> <span class="hljs-number">683</span>
<span class="hljs-attr">Number Slow UI thread:</span> <span class="hljs-number">273</span>
<span class="hljs-attr">Number Slow bitmap uploads:</span> <span class="hljs-number">8</span>
<span class="hljs-attr">Number Slow issue draw commands:</span> <span class="hljs-number">18</span>
<span class="hljs-attr">Number Frame deadline missed:</span> <span class="hljs-number">287</span>
<span class="hljs-attr">HISTOGRAM:</span> <span class="hljs-string">5ms=670</span> <span class="hljs-string">6ms=128</span> <span class="hljs-string">7ms=84</span> <span class="hljs-string">8ms=63</span> <span class="hljs-string">9ms=38</span> <span class="hljs-string">10ms=23</span> <span class="hljs-string">11ms=21</span> <span class="hljs-string">12ms=20</span> <span class="hljs-string">13ms=25</span> <span class="hljs-string">14ms=39</span> <span class="hljs-string">15ms=65</span> <span class="hljs-string">16ms=36</span> <span class="hljs-string">17ms=51</span> <span class="hljs-string">18ms=37</span> <span class="hljs-string">19ms=41</span> <span class="hljs-string">20ms=20</span> <span class="hljs-string">21ms=19</span> <span class="hljs-string">22ms=18</span> <span class="hljs-string">23ms=15</span> <span class="hljs-string">24ms=14</span> <span class="hljs-string">25ms=8</span> <span class="hljs-string">26ms=4</span> <span class="hljs-string">27ms=6</span> <span class="hljs-string">28ms=3</span> <span class="hljs-string">29ms=4</span> <span class="hljs-string">30ms=2</span> <span class="hljs-string">31ms=2</span> <span class="hljs-string">32ms=6</span> <span class="hljs-string">34ms=12</span> <span class="hljs-string">36ms=10</span> <span class="hljs-string">38ms=9</span> <span class="hljs-string">40ms=3</span> <span class="hljs-string">42ms=4</span> <span class="hljs-string">44ms=5</span> <span class="hljs-string">46ms=8</span> <span class="hljs-string">48ms=6</span> <span class="hljs-string">53ms=6</span> <span class="hljs-string">57ms=4</span> <span class="hljs-string">61ms=1</span> <span class="hljs-string">65ms=0</span> <span class="hljs-string">69ms=2</span> <span class="hljs-string">73ms=2</span> <span class="hljs-string">77ms=3</span> <span class="hljs-string">81ms=4</span> <span class="hljs-string">85ms=1</span> <span class="hljs-string">89ms=2</span> <span class="hljs-string">93ms=0</span> <span class="hljs-string">97ms=2</span> <span class="hljs-string">101ms=1</span> <span class="hljs-string">105ms=1</span> <span class="hljs-string">109ms=1</span> <span class="hljs-string">113ms=1</span> <span class="hljs-string">117ms=1</span> <span class="hljs-string">121ms=2</span> <span class="hljs-string">125ms=1</span> <span class="hljs-string">129ms=0</span> <span class="hljs-string">133ms=1</span> <span class="hljs-string">150ms=2</span> <span class="hljs-string">200ms=3</span> <span class="hljs-string">250ms=0</span> <span class="hljs-string">300ms=1</span> <span class="hljs-string">350ms=1</span> <span class="hljs-string">400ms=0</span> <span class="hljs-string">450ms=0</span> <span class="hljs-string">500ms=0</span> <span class="hljs-string">550ms=0</span> <span class="hljs-string">600ms=0</span> <span class="hljs-string">650ms=0</span> 

<span class="hljs-string">---PROFILEDATA---</span>
<span class="hljs-string">Flags,IntendedVsync,Vsync,OldestInputEvent,NewestInputEvent,HandleInputStart,AnimationStart,PerformTraversalsStart,DrawStart,SyncQueued,SyncStart,IssueDrawCommandsStart,SwapBuffers,FrameCompleted,DequeueBufferDuration,QueueBufferDuration,</span>
<span class="hljs-number">0</span><span class="hljs-string">,10158314881426,10158314881426,9223372036854775807,0,10158315693363,10158315760759,10158315769821,10158316032165,10158316627842,10158316838988,10158318055915,10158320387269,10158321770654,428000,773000,</span>
<span class="hljs-number">0</span><span class="hljs-string">,10158332036261,10158332036261,9223372036854775807,0,10158332799196,10158332868519,10158332877269,10158333137738,10158333780654,10158333993206,10158335078467,10158337689561,10158339307061,474000,885000,</span>
<span class="hljs-number">0</span><span class="hljs-string">,10158348665353,10158348665353,9223372036854775807,0,10158349710238,10158349773102,10158349780863,10158350405863,10158351135967,10158351360446,10158352300863,10158354305654,10158355814509,471000,836000,</span>
<span class="hljs-number">0</span><span class="hljs-string">,10158365296729,10158365296729,9223372036854775807,0,10158365782373,10158365821019,10158365825238,10158365975290,10158366547946,10158366687217,10158367240706,10158368429248,10158369291852,269000,476000,</span>
</code></pre>
<h3 data-id="heading-29">利用 SurfaceFlinger 进行监控</h3>
<p>命令解释：</p>
<ol start="0">
<li>数据的单位是纳秒，时间是以开机时间为起始点</li>
<li>每一次的命令都会得到128行的帧相关的数据</li>
</ol>
<p>数据：</p>
<ol start="0">
<li>第一行数据，表示刷新的时间间隔refresh_period</li>
<li>第1列：这一部分的数据表示应用程序绘制图像的时间点</li>
<li>第2列：在SF(软件)将帧提交给H/W(硬件)绘制之前的垂直同步时间，也就是每帧绘制完提交到硬件的时间戳，该列就是垂直同步的时间戳</li>
<li>第3列：在SF将帧提交给H/W的时间点，算是H/W接受完SF发来数据的时间点，绘制完成的时间点。</li>
</ol>
<p><strong>掉帧 jank 计算</strong></p>
<p>每一行都可以通过下面的公式得到一个值，该值是一个标准，我们称为jankflag，如果当前行的jankflag与上一行的jankflag发生改变，那么就叫掉帧</p>
<p>ceil((C - A) / refresh-period)</p>
<h3 data-id="heading-30">利用 SurfaceFlinger PageFlip 机制进行监控</h3>
<pre><code class="hljs language-ini" lang="ini">Parcel <span class="hljs-attr">data</span> = Parcel.obtain()<span class="hljs-comment">;</span>
Parcel <span class="hljs-attr">reply</span> = Parcel.obtain()<span class="hljs-comment">;</span>
    data.writeInterfaceToken("android.ui.ISurfaceComposer")<span class="hljs-comment">;</span>
mFlinger.transact(1013, data, reply, 0)<span class="hljs-comment">;</span>
final int <span class="hljs-attr">pageFlipCount</span> = reply.readInt()<span class="hljs-comment">;</span>

final long <span class="hljs-attr">now</span> = System.nanoTime()<span class="hljs-comment">;</span>
final int <span class="hljs-attr">frames</span> = pageFlipCount - mLastPageFlipCount<span class="hljs-comment">;</span>
final long <span class="hljs-attr">duration</span> = now - mLastUpdateTime<span class="hljs-comment">;</span>
<span class="hljs-attr">mFps</span> = (float) (frames * <span class="hljs-number">1</span>e9 / duration)<span class="hljs-comment">;</span>
<span class="hljs-attr">mLastPageFlipCount</span> = pageFlipCount<span class="hljs-comment">;</span>
<span class="hljs-attr">mLastUpdateTime</span> = now<span class="hljs-comment">;</span>
reply.recycle()<span class="hljs-comment">;</span>
data.recycle()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-31">Choreographer 自身的掉帧计算逻辑</h3>
<p>SKIPPED_FRAME_WARNING_LIMIT 默认为30 , 由 debug.choreographer.skipwarning 这个属性控制</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-function"><span class="hljs-title">if</span> <span class="hljs-params">(jitterNanos &gt;= mFrameIntervalNanos)</span> {
    <span class="hljs-title">final</span> <span class="hljs-title">long</span> <span class="hljs-title">skippedFrames</span> = <span class="hljs-title">jitterNanos</span> / <span class="hljs-title">mFrameIntervalNanos</span>;
    <span class="hljs-title">if</span> <span class="hljs-params">(skippedFrames &gt;= SKIPPED_FRAME_WARNING_LIMIT)</span> {
        L<span class="hljs-title">og</span>.<span class="hljs-title">i</span><span class="hljs-params">(TAG, <span class="hljs-string">"Skipped "</span> + skippedFrames + <span class="hljs-string">" frames!  "</span>
                + <span class="hljs-string">"The application may be doing too much work on its main thread."</span>)</span>;
    }
}
</span></code></pre>
<h3 data-id="heading-32">BlockCanary</h3>
<p>Blockcanary 做性能监控使用的是 Looper 的消息机制，通过对 MessageQueue 中每一个 Message 的前后进行记录，打到监控性能的目的</p>
<p>android/os/Looper.java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loop</span>()</span> {
    ...
    <span class="hljs-keyword">for</span> (;;) {
        ...
        <span class="hljs-comment">// This must be in a local variable, in case a UI event sets the logger</span>
        Printer logging = me.mLogging;
        <span class="hljs-keyword">if</span> (logging != <span class="hljs-literal">null</span>) {
            logging.println(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="hljs-string">" "</span> +
                    msg.callback + <span class="hljs-string">": "</span> + msg.what);
        }
        msg.target.dispatchMessage(msg);
        <span class="hljs-keyword">if</span> (logging != <span class="hljs-literal">null</span>) {
            logging.println(<span class="hljs-string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="hljs-string">" "</span> + msg.callback);
        }
        ...
    }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-messagequeue" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-33">MessageQueue 与 Choreographer</h2>
<p>在 Android 消息机制中，异步消息具有特殊的处理优先级。系统可以通过 enqueueBarrier 方法向消息队列插入一个屏障（Barrier），使得该屏障之后的所有同步消息暂时无法被执行，直到调用 removeBarrier 方法移除屏障。而被标记为异步的消息则不受屏障影响，可以正常处理。</p>
<p>消息默认为同步类型，只有通过 Message 的 setAsynchronous 方法（该方法为隐藏 API）才能将消息设置为异步。在初始化 Handler 时，可以通过特定参数指定该 Handler 发送的所有消息均为异步类型，此时 Handler 的 enqueueMessage 方法会自动调用 Message 的 setAsynchronous 方法。</p>
<p>异步消息的核心价值在于能够绕过消息屏障继续执行，如果没有设置屏障，异步消息与同步消息的处理方式完全相同。通过 removeSyncBarrier 方法可以移除之前设置的屏障。</p>
<h3 data-id="heading-34">SyncBarrier 在 Choreographer 中使用的一个示例</h3>
<p>scheduleTraversals 的时候 postSyncBarrier</p>
<pre><code class="hljs language-ini" lang="ini">void scheduleTraversals() {
    if (!mTraversalScheduled) {
        <span class="hljs-attr">mTraversalScheduled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        //为了提高优先级，先 postSyncBarrier
        <span class="hljs-attr">mTraversalBarrier</span> = mHandler.getLooper().getQueue().postSyncBarrier()<span class="hljs-comment">;</span>
        mChoreographer.postCallback(
                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>doTraversal 的时候 removeSyncBarrier</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">doTraversal</span>() {
    if (mTraversalScheduled) {
        mTraversalScheduled = false;
        <span class="hljs-comment">// 这里把 SyncBarrier remove</span>
mHandler<span class="hljs-selector-class">.getLooper</span>()<span class="hljs-selector-class">.getQueue</span>()<span class="hljs-selector-class">.removeSyncBarrier</span>(mTraversalBarrier);
        <span class="hljs-comment">// 真正开始</span>
        <span class="hljs-built_in">performTraversals</span>();
    }
}
</code></pre>
<p>Choreographer post Message 的时候，会把这些消息设为 Asynchronous ，这样 Choreographer 中的这些 Message 的优先级就会比较高，</p>
<pre><code class="hljs language-ini" lang="ini">Message <span class="hljs-attr">msg</span> = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action)<span class="hljs-comment">;</span>
<span class="hljs-attr">msg.arg1</span> = callbackType<span class="hljs-comment">;</span>
msg.setAsynchronous(true)<span class="hljs-comment">;</span>
mHandler.sendMessageAtTime(msg, dueTime)<span class="hljs-comment">;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-vendor" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-35">厂商优化</h2>
<p>系统厂商由于可以直接修改源码，也利用这方面的便利，做一些功能和优化，不过由于保密的问题，代码就不直接放上来了，我可以大概说一下思路，感兴趣的可以私下讨论</p>
<h3 data-id="heading-36">移动事件优化</h3>
<p>Choreographer 本身是没有 input 消息的， 不过修改源码之后，input 消息可以直接给到 Choreographer 这里， 有了这些 Input 消息，Choreographer 就可以做一些事情，比如说提前响应，不去等 Vsync</p>
<h3 data-id="heading-37">后台动画优化</h3>
<p>当 Android 应用退到后台时，如果未被系统终止，其仍可能继续执行各类操作。在某些情况下，应用会持续调用 Choreographer 中的 Animation Callback，即使这些动画对用户不可见，这些 Callback 的执行完全无意义，却会对 CPU 资源造成较高的占用。</p>
<p>因此，系统厂商在 Choreographer 中会针对这种情况做优化，通过一系列策略限制不符合条件的后台应用继续执行无意义的动画回调，有效降低系统资源占用。</p>
<p><img src="" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47045779d5e74bc9ad1848a2fcb24e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763903340&amp;x-signature=MxDVugFtURVlisHotet76GJqxhA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-38">帧绘制优化</h3>
<p>和移动事件优化一样，由于有了 Input 事件的信息，在某些场景下我们可以通知 SurfaceFlinger 不用去等待 Vsync 直接做合成操作</p>
<h3 data-id="heading-39">应用启动优化</h3>
<p>我们前面说，主线程的所有操作都是给予 Message 的 ，如果某个操作，非重要的 Message 被排列到了队列后面，那么对这个操作产生影响；而通过重新排列 MessageQueue，在应用启动的时候，把启动相关的重要的启动 Message 放到队列前面，来起到加快启动速度的作用</p>
<h3 data-id="heading-40">animation callback 前置</h3>
<p>在上一帧的主线程做完之后，距离下一个 vsync 其实是有一定时间的空闲的，这段时间其实可以用来准备下一帧。那么我们就可以把下一帧的 animation callback 提前到这里来做，这样可以有效利用 cpu 的空闲时间，减少掉帧</p>
<h3 data-id="heading-41">插帧</h3>
<p>跟 animation callback 前置一样，在上一帧的主线程做完之后，距离下一个 vsync 其实是有一定时间的空闲的，这段时间其实可以用来准备下一帧。只不过这里我们直接生成新的一帧：即一个 Vsync 里面，执行两次 doFrame 。插帧相当于是提前准备好后面几帧的数据，这样在遇到真正耗时的帧的时候，不会出现卡顿。</p>
<p>插帧实现主要是在滑动场景，用在实现了 OverScroller 的滑动组件上，比如 ListView，RecyclerVIew 这些。因为如果用了 OverScroller，我们就会在 touch up 的时候， 就知道了滑动的时间和距离，就可以在这中间做手脚（插帧），相当于在一个 Vsync 内画好了后面好几个 VSync 里面的内容。</p>
<h3 data-id="heading-42">高帧率优化</h3>
<p>现代 Android 设备上的高刷新率（120 Hz）将 Vsync 间隔从 16.6 ms 缩短至 8.3 ms，这带来了巨大的性能和功耗挑战。如何在一帧内完成渲染的必要操作，是手机厂商必须要思考和优化的地方：</p>
<ol start="0">
<li>超级 App 的性能表现以及优化</li>
<li>游戏高帧率合作</li>
<li>120 fps、90 fps 和 60 fps 相互切换的逻辑</li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-refs" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-43">参考资料</h2>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F304f56f5d486" target="_blank" title="https://www.jianshu.com/p/304f56f5d486" ref="nofollow noopener noreferrer">www.jianshu.com/p/304f56f5d…</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fgityuan.com%2F2017%2F02%2F25%2Fchoreographer%2F" target="_blank" title="http://gityuan.com/2017/02/25/choreographer/" ref="nofollow noopener noreferrer">gityuan.com/2017/02/25/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2FChoreographer" target="_blank" title="https://developer.android.com/reference/android/view/Choreographer" ref="nofollow noopener noreferrer">developer.android.com/reference/a…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jishuwen.com%2Fd%2F2Vcc" target="_blank" title="https://www.jishuwen.com/d/2Vcc" ref="nofollow noopener noreferrer">www.jishuwen.com/d/2Vcc</a></li>
<li><a href="https://juejin.im/entry/5c8772eee51d456cda2e8099" target="_blank" title="https://juejin.im/entry/5c8772eee51d456cda2e8099">juejin.im/entry/5c877…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftime.geekbang.org%2Fcolumn%2Fintro%2F142" target="_blank" title="https://time.geekbang.org/column/intro/142" ref="nofollow noopener noreferrer">Android 开发高手课</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2F" target="_blank" title="https://perfetto.dev/" ref="nofollow noopener noreferrer">Perfetto - System profiling, app tracing, and trace analysis</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fprofile%2Fperfetto-ui" target="_blank" title="https://developer.android.com/studio/profile/perfetto-ui" ref="nofollow noopener noreferrer">使用 Perfetto 分析 UI 性能</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fgraphics%2Farch-bq-gralloc" target="_blank" title="https://source.android.com/docs/core/graphics/arch-bq-gralloc" ref="nofollow noopener noreferrer">BufferQueue and Gralloc</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fabout%2Fversions%2F15%2Ffeatures%23graphics" target="_blank" title="https://developer.android.com/about/versions/15/features#graphics" ref="nofollow noopener noreferrer">Android 15 图形渲染优化</a></li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-zhihu" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-44">本文知乎地址</h2>
<p>由于博客留言交流不方便，点赞或者交流，可以移步本文的知乎界面 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F87954949" target="_blank" title="https://zhuanlan.zhihu.com/p/87954949" ref="nofollow noopener noreferrer">知乎 - Android 基于 Choreographer 的渲染机制详解 - Perfetto 版</a> <a href="https://juejin.im/post/5daedc65e51d457834735c65" target="_blank" title="https://juejin.im/post/5daedc65e51d457834735c65">掘金 - Android 基于 Choreographer 的渲染机制详解 - Perfetto 版</a></p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-about" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-45">关于我 &amp;&amp; 博客</h2>
<p>下面是个人的介绍和相关的链接，期望与同行的各位多多交流，三人行，则必有我师!</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">博主个人介绍</a> ：里面有个人的微信和微信群链接。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2019%2F12%2F01%2FBlogMap%2F" target="_blank" title="https://androidperformance.com/2019/12/01/BlogMap/" ref="nofollow noopener noreferrer">本博客内容导航</a> ：个人博客内容的一个导航。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2018%2F05%2F07%2FAndroid-performance-optimization-skills-and-tools%2F" target="_blank" title="https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools/" ref="nofollow noopener noreferrer">个人整理和搜集的优秀博客文章 - Android 性能优化必知必会</a> ：欢迎大家自荐和推荐 （微信私聊即可）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2023%2F12%2F30%2Fthe-performance%2F" target="_blank" title="https://www.androidperformance.com/2023/12/30/the-performance/" ref="nofollow noopener noreferrer">Android 性能优化知识星球</a> ： 欢迎加入，多谢支持～</li>
</ol>
<blockquote>
<p><strong>一个人可以走的更快 , 一群人可以走的更远</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Perfetto 系列 07 - MainThread 和 RenderThread 解读]]></title>    <link>https://juejin.cn/post/7572539461478826027</link>    <guid>https://juejin.cn/post/7572539461478826027</guid>    <pubDate>2025-11-16T13:21:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572539461478826027" data-draft-id="7572480736362348550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Perfetto 系列 07 - MainThread 和 RenderThread 解读"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-16T13:21:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gracker"/> <meta itemprop="url" content="https://juejin.cn/user/1816846860560749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Perfetto 系列 07 - MainThread 和 RenderThread 解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1816846860560749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gracker
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:21:35.000Z" title="Sun Nov 16 2025 13:21:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本篇是 Perfetto 系列文章的第七篇，主要介绍 Android App 中的 MainThread 和 RenderThread，也就是大家熟悉的<strong>主线程</strong>和<strong>渲染线程</strong>。文章会从 Perfetto 的角度来看 MainThread 和 RenderThread 的工作流程，涉及卡顿、软件渲染、掉帧计算等相关知识。</p>
<p>随着 Google 正式推出 Perfetto 工具替代 Systrace，Perfetto 在性能分析领域已经成为主流选择。本文将结合 Perfetto 的具体 trace 信息，帮助读者理解 MainThread 和 RenderThread 的完整工作流程，让你在使用 Perfetto 分析性能问题时能够：</p>
<ul>
<li><strong>准确识别关键 trace tag</strong>：知道 UI Thread、RenderThread 等关键线程的作用</li>
<li><strong>理解帧渲染的完整流程</strong>：从 Vsync 信号到屏幕显示的每个步骤</li>
<li><strong>定位性能瓶颈</strong>：通过 trace 信息快速找到卡顿和性能问题的根因 </li>
</ul>
<h3 data-id="heading-0">本文目录</h3>
<ul>
<li><a href="#series" title="#series">系列文章目录</a></li>
<li><a href="#render-flow" title="#render-flow">基于 Perfetto 的渲染流程分析</a></li>
<li><a href="#evolution" title="#evolution">双线程渲染架构的演进</a></li>
<li><a href="#main-thread-create" title="#main-thread-create">主线程的创建过程</a></li>
<li><a href="#activitythread" title="#activitythread">ActivityThread 的功能</a></li>
<li><a href="#render-thread" title="#render-thread">渲染线程的创建和发展</a></li>
<li><a href="#performance" title="#performance">性能</a></li>
<li><a href="#frametimeline" title="#frametimeline">Perfetto 独有的 FrameTimeline 功能</a></li>
<li><a href="#vsync" title="#vsync">Perfetto 中 Vsync 信号</a></li>
<li><a href="#refs" title="#refs">参考</a></li>
<li><a href="#attachments" title="#attachments">附件</a></li>
<li><a href="#about" title="#about">关于我 &amp;&amp; 博客</a></li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-series" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-1">系列文章目录</h2>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F03%2F27%2FAndroid-Perfetto-101%2F%23%2FPerfetto-%25E7%25B3%25BB%25E5%2588%2597%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2024/03/27/Android-Perfetto-101/#/Perfetto-%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Android Perfetto 系列目录</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-01-What-is-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-01-What-is-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 1：Perfetto 工具简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-02-how-to-get-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-02-how-to-get-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 2：Perfetto Trace 抓取</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-03-how-to-analysis-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-03-how-to-analysis-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 3：熟悉 Perfetto View</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F02%2F08%2FAndroid-Perfetto-04-Open-Big-Trace-With-Command-Line%2F" target="_blank" title="https://www.androidperformance.com/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/" ref="nofollow noopener noreferrer">Android Perfetto 系列 4：使用命令行在本地打开超大 Trace</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F03%2F26%2FAndroid-Perfetto-05-Chorergrapher%2F" target="_blank" title="https://www.androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" ref="nofollow noopener noreferrer">Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F04%2F26%2FAndroid-Perfetto-06-Why-120Hz%2F" target="_blank" title="https://www.androidperformance.com/2025/04/26/Android-Perfetto-06-Why-120Hz/" ref="nofollow noopener noreferrer">Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F02%2FAndroid-Perfetto-07-MainThread-And-RenderThread%2F" target="_blank" title="https://androidperformance.com/2025/08/02/Android-Perfetto-07-MainThread-And-RenderThread/" ref="nofollow noopener noreferrer">Android Perfetto 系列 7 - MainThread 和 RenderThread 解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F05%2FAndroid-Perfetto-08-Vsync%2F" target="_blank" title="https://androidperformance.com/2025/08/05/Android-Perfetto-08-Vsync/" ref="nofollow noopener noreferrer">Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F11%2F12%2FAndroid-Perfetto-09-CPU%2F" target="_blank" title="https://www.androidperformance.com/2025/11/12/Android-Perfetto-09-CPU/" ref="nofollow noopener noreferrer">Android Perfetto 系列 9 - CPU 信息解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1oi82efE4D%2F%3Fvd_source%3D0c6d2191e785de0a36dc21a9da7e664e" target="_blank" title="https://www.bilibili.com/video/BV1oi82efE4D/?vd_source=0c6d2191e785de0a36dc21a9da7e664e" ref="nofollow noopener noreferrer">视频(B站) - Android Perfetto 基础和案例分享</a></li>
</ol>
<p>如果大家还没看过 Systrace 系列，下面是传送门：</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F05%2F26%2FAndroid_Systrace_0%2F%23%2F%25E7%25B3%25BB%25E5%2588%2597%25E6%2596%2587%25E7%25AB%25A0%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2019/05/26/Android_Systrace_0/#/%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Systrace 系列目录</a> ： 系统介绍了 Perfetto 的前身 Systrace 的使用，并通过 Systrace 来学习和了解 Android 性能优化和 Android 系统运行的基本规则。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F" target="_blank" title="https://www.androidperformance.com/" ref="nofollow noopener noreferrer">个人博客</a> ：个人博客，主要是 Android 相关的内容，也放了一些生活和工作相关的内容。</li>
</ol>
<p>欢迎大家在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">关于我</a> 页面加入微信群或者星球，讨论你的问题、你最想看到的关于 Perfetto 的部分，以及跟各位群友讨论所有 Android 开发相关的内容.</p>
<p>本文使用到的 Trace 文件我上传到了 Github ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGracker%2FSystraceForBlog%2Ftree%2Fmaster%2FAndroid_Perfetto%2Fdemo_app_aosp_scroll.perfetto-trace" target="_blank" title="https://github.com/Gracker/SystraceForBlog/tree/master/Android_Perfetto/demo_app_aosp_scroll.perfetto-trace" ref="nofollow noopener noreferrer">github.com/Gracker/Sys…</a> ，需要的可以自取。</p>
<blockquote>
<p><strong>注：本文内容基于 Android 16 的最新渲染架构</strong></p>
</blockquote>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-render-flow" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-2">基于 Perfetto 的渲染流程分析</h2>
<p>这里以滑动列表为例，我们通过 Perfetto 截取主线程和渲染线程<strong>一帧</strong>的工作流程(每一帧都会遵循这个流程，不过有的帧需要处理的事情多，有的帧需要处理的事情少)。在 Perfetto UI 中，重点观察 "UI Thread" 和 "RenderThread" 这两个线程的活动。</p>
<h3 data-id="heading-3">帧的概念和基本参数</h3>
<p>在分析 Perfetto trace 之前，需要先了解帧（Frame）的基本概念。Android 系统按照固定的时间间隔刷新屏幕内容：</p>
<ul>
<li><strong>60Hz 设备</strong>：每 16.67ms 刷新一次，每秒 60 帧</li>
<li><strong>90Hz 设备</strong>：每 11.11ms 刷新一次，每秒 90 帧</li>
<li><strong>120Hz 设备</strong>：每 8.33ms 刷新一次，每秒 120 帧</li>
</ul>
<p>在 Perfetto 中分析渲染性能时，需要重点关注以下两个线程：</p>
<ul>
<li><strong>UI Thread</strong>：应用主线程，处理用户输入、业务逻辑、布局计算</li>
<li><strong>RenderThread</strong>：渲染线程，执行 GPU 渲染命令，与 SurfaceFlinger 交互</li>
</ul>
<h3 data-id="heading-4">主线程和渲染线程的工作流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/334a29d068a943b99d86a4090ee2de90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=d1gB8Tye1igfBnmIQ6Ao2myMBS4%3D" alt="image.png" loading="lazy"/></p>
<p>通过上面的 Perfetto 截图，可以看到一帧完整的渲染流程。我们可以将 Perfetto 图想象成一条河流：主线程在上游处理逻辑，渲染线程在下游执行绘制。河流从左到右流动，每段代表一个步骤。</p>
<p><strong>重要说明</strong>：并非每一帧都会执行所有步骤。Input、Animation、Insets Animation 这些回调是基于前一帧的状态决定当前帧是否执行，而 Traversal（measure、layout、draw）是每帧的核心流程。</p>
<p>通过以下描述，试着在脑中"播放"这个完整流程：</p>
<h4 data-id="heading-5">1. 主线程等待 Vsync 信号</h4>
<ul>
<li><strong>Perfetto trace</strong>: 主线程处于 Sleep 状态（显示为空闲块）</li>
<li><strong>流程说明</strong>: 主线程等待垂直同步信号（Vsync）到来，这确保渲染与屏幕刷新率同步，避免画面撕裂</li>
</ul>
<h4 data-id="heading-6">2. Vsync-app 信号传递过程</h4>
<ul>
<li><strong>Perfetto trace</strong>: <code>vsync-app</code> 相关事件，SurfaceFlinger app 线程活动</li>
<li><strong>流程说明</strong>: 当硬件产生 Vsync 信号时，首先传递给 SurfaceFlinger。SurfaceFlinger 的 app 线程被唤醒，负责管理和分发 Vsync 信号给需要渲染的应用程序。这个中间层设计允许系统级的 Vsync 调度和优化</li>
</ul>
<p><strong>重要说明</strong>：</p>
<ul>
<li><strong>Vsync-app 是按需申请的</strong>：只有 App 主动请求时才会收到 vsync-app 信号，不申请就没有</li>
<li><strong>多 App 共享机制</strong>：同时可能有多个 App 申请 vsync-app 信号</li>
<li><strong>信号归属问题</strong>：SurfaceFlinger 中的 vsync-app 信号可能是其他 App 申请的，当前分析的 App 如果没有申请，就不会有帧输出，这是正常现象</li>
</ul>
<h4 data-id="heading-7">3. SurfaceFlinger 唤醒 App 主线程</h4>
<ul>
<li><strong>Perfetto trace</strong>: <code>FrameDisplayEventReceiver.onVsync</code></li>
<li><strong>流程说明</strong>: SurfaceFlinger 通过 FrameDisplayEventReceiver 机制将 Vsync 信号发送给已注册的 App。App 的 Choreographer 接收到信号后开始启动一帧绘制流程</li>
</ul>
<h4 data-id="heading-8">4. 处理输入事件（Input）</h4>
<ul>
<li>
<p><strong>Perfetto trace</strong>: <code>Input</code> 块</p>
</li>
<li>
<p><strong>流程说明</strong>: 仅在有输入事件时才执行，主要处理触摸、滑动等用户交互</p>
</li>
<li>
<p><strong>触发条件</strong>:</p>
<ul>
<li><strong>有 Input 回调</strong>：手指按压屏幕并滑动时（如列表滑动、页面拖拽）</li>
<li><strong>无 Input 回调</strong>：手指抬起后的惯性滑动阶段、静止状态</li>
</ul>
</li>
<li>
<p><strong>注意</strong>: Input 回调是由前一帧的用户交互行为决定是否在当前帧执行</p>
</li>
</ul>
<h4 data-id="heading-9">5. 处理动画（Animation）</h4>
<ul>
<li>
<p><strong>Perfetto trace</strong>: <code>Animation</code> 块</p>
</li>
<li>
<p><strong>流程说明</strong>: 仅在有动画需要更新时才执行，更新动画状态和当前帧的动画值</p>
</li>
<li>
<p><strong>触发条件</strong>:</p>
<ul>
<li><strong>有 Animation 回调</strong>：惯性滑动阶段、属性动画运行时、列表 item 创建和内容变化、页面转场动画等</li>
<li><strong>无 Animation 回调</strong>：界面静止状态、纯 Input 交互阶段（无动画效果时）</li>
</ul>
</li>
<li>
<p><strong>注意</strong>: Animation 回调同样由前一帧 post 的回调决定当前帧是否执行</p>
</li>
</ul>
<h4 data-id="heading-10">6. 处理 Insets 动画</h4>
<ul>
<li>
<p><strong>Perfetto trace</strong>: <code>Insets Animation</code> 块</p>
</li>
<li>
<p><strong>流程说明</strong>: 仅在有窗口插入变化时才执行，处理窗口边界动画</p>
</li>
<li>
<p><strong>触发条件</strong>:</p>
<ul>
<li><strong>有 Insets Animation 回调</strong>：键盘弹出/收起、状态栏显示/隐藏、导航栏变化等</li>
<li><strong>无 Insets Animation 回调</strong>：窗口边界稳定状态，大部分普通交互场景</li>
</ul>
</li>
</ul>
<h4 data-id="heading-11">7. Traversal（测量、布局、绘制准备）</h4>
<ul>
<li><strong>Perfetto trace</strong>: <code>performTraversals</code>, <code>measure</code>, <code>layout</code>, <code>draw</code></li>
<li><strong>流程说明</strong>: Android UI 渲染的三大核心流程，每一帧都会执行这个完整的流程：</li>
</ul>
<h5 data-id="heading-12">7.1 Measure（测量阶段）</h5>
<ul>
<li>
<p><strong>作用</strong>: 确定每个 View 的尺寸大小</p>
</li>
<li>
<p><strong>过程</strong>: 从根 View 开始，递归测量所有子 View 的宽高</p>
</li>
<li>
<p><strong>关键概念</strong>:</p>
<ul>
<li><code>MeasureSpec</code>：封装了父容器对子 View 的尺寸要求（EXACTLY、AT_MOST、UNSPECIFIED）</li>
<li><code>onMeasure()</code>：每个 View 重写此方法来实现自己的测量逻辑</li>
</ul>
</li>
<li>
<p><strong>Perfetto 中的表现</strong>: <code>measure</code> 事件，耗时取决于 View 层级复杂度</p>
</li>
</ul>
<h5 data-id="heading-13">7.2 Layout（布局阶段）</h5>
<ul>
<li>
<p><strong>作用</strong>: 确定每个 View 在父容器中的位置坐标</p>
</li>
<li>
<p><strong>过程</strong>: 基于 Measure 阶段的结果，为每个 View 分配实际的显示位置</p>
</li>
<li>
<p><strong>关键概念</strong>:</p>
<ul>
<li><code>layout(left, top, right, bottom)</code>：设置 View 的四个边界坐标</li>
<li><code>onLayout()</code>：ViewGroup 重写此方法来确定子 View 的位置</li>
</ul>
</li>
<li>
<p><strong>Perfetto 中的表现</strong>: <code>layout</code> 事件，通常比 measure 更快</p>
</li>
</ul>
<h5 data-id="heading-14">7.3 Draw（绘制阶段）</h5>
<ul>
<li>
<p><strong>作用</strong>: 将 View 的内容绘制到画布上</p>
</li>
<li>
<p><strong>现代实现</strong>: 不直接绘制像素，而是构建 DisplayList（绘制指令列表）</p>
</li>
<li>
<p><strong>关键流程</strong>:</p>
<ul>
<li><code>draw(Canvas)</code>：绘制 View 自身内容</li>
<li><code>onDraw(Canvas)</code>：子类重写实现具体绘制逻辑</li>
<li><code>dispatchDraw(Canvas)</code>：ViewGroup 用来绘制子 View</li>
</ul>
</li>
<li>
<p><strong>Perfetto 中的表现</strong>: <code>draw</code> 事件，在硬件加速下主要是构建 DisplayList</p>
</li>
</ul>
<h5 data-id="heading-15">ViewRootImpl.performTraversals 核心代码</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// frameworks/base/core/java/android/view/ViewRootImpl.java</span>
private void <span class="hljs-built_in">performTraversals</span>() {
    <span class="hljs-comment">// ... 其他代码</span>
    
    <span class="hljs-comment">// 1. Measure 阶段</span>
    if (mFirst || windowShouldResize || viewVisibilityChanged || params != null) {
        <span class="hljs-built_in">performMeasure</span>(childWidthMeasureSpec, childHeightMeasureSpec);
    }
    
    <span class="hljs-comment">// 2. Layout 阶段  </span>
    final boolean didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);
    if (didLayout) {
        <span class="hljs-built_in">performLayout</span>(lp, mWidth, mHeight);
    }
    
    <span class="hljs-comment">// 3. Draw 阶段</span>
    if (!performRequestedAction(mAttachInfo, mFirst)) {
        if (mFirst || viewVisibilityChanged) {
            <span class="hljs-built_in">performDraw</span>();
        }
    }
}
</code></pre>
<blockquote>
<p>注：实际 AOSP 源码中 <code>performTraversals</code> 的条件判断更为复杂，会涉及 <code>mFirst</code>、<code>mAdded</code>、<code>mWindowShouldResize</code> 以及各种 <code>dirty</code> 状态标记，但以上代码清晰地展示了其核心的 Measure、Layout、Draw 三阶段流程。</p>
</blockquote>
<p><strong>三阶段的执行条件</strong>：</p>
<ul>
<li><strong>Measure</strong>: 当窗口大小变化、首次创建或者视图可见性变化时执行</li>
<li><strong>Layout</strong>: 当布局被请求且应用未停止时执行</li>
<li><strong>Draw</strong>: 当有绘制请求或者是首次绘制、视图可见性变化时执行</li>
</ul>
<h4 data-id="heading-16">8. 同步 DisplayList 到渲染线程</h4>
<ul>
<li><strong>Perfetto trace</strong>: syncAndDrawFrame，可见 "sync" 或 "syncAndDrawFrame" 事件（通常显示为主线程向渲染线程的数据传递点）</li>
<li><strong>流程说明</strong>: 主线程通过 syncAndDrawFrame 将构建好的 DisplayList（包含 RenderNode 树、视图属性如变换矩阵、透明度和裁剪区域，以及共享资源如纹理）传递给渲染线程。这个同步过程是硬件加速的核心，确保渲染线程获得完整的绘制指令。同步完成后，主线程立即释放资源（可继续处理其他消息、IdleHandler 或进入 Sleep 等待下一个 Vsync），而渲染线程独立接管后续的 GPU 渲染工作。</li>
</ul>
<h4 data-id="heading-17">9. 渲染线程获取 Buffer</h4>
<ul>
<li><strong>Perfetto trace</strong>: <code>dequeueBuffer</code> 块</li>
<li><strong>流程说明</strong>: 渲染线程从 BlastBufferQueue（App 端管理的缓冲队列）通过 dequeueBuffer 获取一个可用缓冲区，作为渲染目标（framebuffer）。BlastBufferQueue 采用生产者-消费者模型，预先管理缓冲池以减少等待时间；如果无可用 Buffer，可能短暂等待或触发新 Buffer 创建。</li>
</ul>
<h4 data-id="heading-18">10. 处理渲染指令并 flush 到 GPU</h4>
<ul>
<li>
<h6 data-id="heading-19"><strong>Perfetto trace</strong>: <code>drawing</code> 相关块</h6>
</li>
<li><strong>流程说明</strong>: RenderThread（运行在 CPU 上）通过 HardwareRenderer 和 CanvasContext 处理从 UI thread 同步过来的 DisplayList，调用 OpenGL ES 或 Vulkan API 来准备绘制命令序列（如渲染视图的几何形状、纹理、着色效果）。这些命令被构建成命令缓冲区（command buffer），然后通过 flush 操作（例如 mRenderPipeline-&gt;flush()）提交到 GPU 驱动，同时生成 present fence 用于后续同步。GPU 异步执行这些指令，实际生成图像内容。</li>
</ul>
<h4 data-id="heading-20">11. 提交 Buffer（可能 unsignaled）</h4>
<ul>
<li><strong>Perfetto trace</strong>: queueBuffer（可观察 acquireFence 状态）</li>
<li><strong>流程说明</strong>: RenderThread 通过 queueBuffer 将渲染完成的 Buffer 提交回 BlastBufferQueue，此时 Buffer 可能携带 unsignaled 的 acquire fence（即 GPU 渲染命令尚未完全执行完毕）。这种异步提交机制有助于减少整体渲染延迟。</li>
</ul>
<h4 data-id="heading-21">12. 触发 Transaction 到 SurfaceFlinger</h4>
<ul>
<li><strong>Perfetto trace</strong>: TransactionQueue 或 BLAST transaction 事件 ，一般在 queueBuffer 之后，有些 Trace 没有这个 Tag</li>
<li><strong>流程说明</strong>: 在 queueBuffer 完成后，RenderThread 通过 applyPendingTransactions 将积累的 Transaction（包括 Buffer 更新、层属性变化等）批量发送给 SurfaceFlinger。SurfaceFlinger 处理这些 Transaction，根据 LatchUnsignaledConfig 策略（例如 AutoSingleLayer 配置）检查并可能 latch unsignaled buffer 以进一步优化延迟；如果配置禁用 unsignaled latch，则等待 fence signaled 确保 Buffer 就绪。随后，SurfaceFlinger 执行层合成（composite）并将最终图像显示到屏幕。</li>
</ul>
<p><strong>在 Perfetto 中识别不同的渲染模式</strong>：</p>
<ul>
<li><strong>手指滑动时</strong>：每帧都有 <code>Input</code> → <code>Traversal</code> → <code>RenderThread</code> 的完整链路</li>
<li><strong>惯性滑动时</strong>：每帧都有 <code>Animation</code> → <code>Traversal</code> → <code>RenderThread</code>，没有 <code>Input</code></li>
<li><strong>静止状态时</strong>：偶尔出现 <code>Animation</code> → <code>Traversal</code> → <code>RenderThread</code>，没有 <code>Input</code></li>
</ul>
<h3 data-id="heading-22">软件绘制 vs 硬件加速</h3>
<p>虽然现在基本都使用硬件加速渲染，但了解两种渲染模式的区别仍然有助于理解 Perfetto trace：</p>






























<table><thead><tr><th>方面</th><th>软件绘制</th><th>硬件加速</th></tr></thead><tbody><tr><td><strong>绘制线程</strong></td><td>主线程</td><td>RenderThread</td></tr><tr><td><strong>绘制引擎</strong></td><td>Skia (CPU)</td><td>OpenGL/Vulkan (GPU)</td></tr><tr><td><strong>Perfetto 特征</strong></td><td>主线程有大块 <code>draw</code> 事件</td><td>主线程快速完成，RenderThread 处理绘制</td></tr><tr><td><strong>性能影响</strong></td><td>可能阻塞主线程</td><td>异步渲染，性能更好</td></tr></tbody></table>
<p>上面介绍的是基本的渲染流程，更详细的 Choreographer 原理可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F03%2F26%2FAndroid-Perfetto-05-Chorergrapher%2F" target="_blank" title="https://androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" ref="nofollow noopener noreferrer">Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程</a>。</p>
<hr/>
<p>接下来我们重点讲解主线程和渲染线程的深入内容：</p>
<ol start="0">
<li>主线程的发展</li>
<li>主线程的创建</li>
<li>渲染线程的创建</li>
<li>主线程和渲染线程的分工</li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-evolution" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-23">双线程渲染架构的演进</h2>
<p>Android 的渲染系统经历了从单线程到双线程的重要演进过程。</p>
<h3 data-id="heading-24">单线程时代（Android 4.4 之前）</h3>
<p>在早期的 Android 版本中，所有的 UI 相关工作都在主线程中执行：</p>
<ul>
<li>处理用户输入事件</li>
<li>执行 measure、layout、draw</li>
<li>调用 OpenGL 进行实际绘制</li>
<li>与 SurfaceFlinger 交互</li>
</ul>
<p>这种设计的问题：</p>
<ol start="0">
<li><strong>响应性差</strong>：主线程负载过重，容易出现 ANR</li>
<li><strong>性能瓶颈</strong>：CPU 和 GPU 无法并行工作</li>
<li><strong>帧率不稳定</strong>：复杂界面容易导致掉帧</li>
</ol>
<h3 data-id="heading-25">双线程时代（Android 5.0 Lollipop 开始）</h3>
<p>Android 5.0 引入了 <strong>RenderThread</strong>，实现渲染工作的分离：</p>
<p><strong>主线程职责</strong>：</p>
<ul>
<li>处理用户输入和业务逻辑</li>
<li>执行 View 的 measure、layout、draw</li>
<li>构建 DisplayList（绘制指令列表）</li>
<li>与渲染线程同步数据</li>
</ul>
<p><strong>渲染线程职责</strong>：</p>
<ul>
<li>接收并处理 DisplayList</li>
<li>执行 OpenGL/Vulkan 渲染命令</li>
<li>管理纹理和渲染资源</li>
<li>与 SurfaceFlinger 交互</li>
</ul>
<p>这种架构带来的优势：</p>
<ol start="0">
<li><strong>并行处理</strong>：主线程可以在渲染线程工作时处理下一帧</li>
<li><strong>响应性提升</strong>：主线程不再被渲染阻塞</li>
<li><strong>性能优化</strong>：GPU 资源得到更好利用</li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-main-thread-create" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-26">主线程的创建过程</h2>
<p>Android App 的进程是基于 Linux 的，其管理也是基于 Linux 的进程管理机制，所以其创建也是调用了 fork 函数</p>
<p>frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</p>
<pre><code class="hljs language-ini" lang="ini">pid_t <span class="hljs-attr">pid</span> = fork()<span class="hljs-comment">;</span>
</code></pre>
<p>Fork 出来的进程，我们这里可以把他看做主线程，但是这个线程还没有和 Android 进行连接，所以无法处理 Android App 的 Message ；由于 Android App 线程运行<strong>基于消息机制</strong> ，那么这个 Fork 出来的主线程需要和 Android 的 Message 消息绑定，才能处理 Android App 的各种 Message</p>
<p>这里就引入了 <strong>ActivityThread</strong> ，确切的说，ActivityThread 应该起名叫 ProcessThread 更贴切一些。ActivityThread 连接了 Fork 出来的进程和 App 的 Message ，他们的通力配合组成了我们熟知的 Android App 主线程。所以说 ActivityThread 其实并不是一个 Thread，而是他初始化了 Message 机制所需要的 MessageQueue、Looper、Handler ，而且其 Handler 负责处理大部分 Message 消息，所以我们习惯上觉得 ActivityThread 是主线程，其实他只是主线程的一个逻辑处理单元。</p>
<h3 data-id="heading-27">ActivityThread 的创建</h3>
<p>App 进程 fork 出来之后，回到 App 进程，查找 ActivityThread 的 Main函数</p>
<p>com/android/internal/os/ZygoteInit.java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 16 最新的 Zygote 初始化实现</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Runnable <span class="hljs-title function_">childZygoteInit</span><span class="hljs-params">(
        <span class="hljs-type">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span> {
    RuntimeInit.<span class="hljs-type">Arguments</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeInit</span>.Arguments(argv);
    
    <span class="hljs-comment">// 设置线程优先级</span>
    <span class="hljs-keyword">if</span> (args.niceName != <span class="hljs-literal">null</span>) {
        Process.setArgV0(args.niceName);
    }
    
    <span class="hljs-comment">// 设置应用程序的调试模式</span>
    <span class="hljs-keyword">if</span> (args.invokeWith != <span class="hljs-literal">null</span>) {
        WrapperInit.execApplication(args.invokeWith,
                args.niceName, args.targetSdkVersion,
                VMRuntime.getCurrentInstructionSet(),
                <span class="hljs-literal">null</span>, args.remainingArgs);
        
        <span class="hljs-comment">// Should not get here.</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"WrapperInit.execApplication unexpectedly returned"</span>);
    } <span class="hljs-keyword">else</span> {
        ZygoteInit.zygoteInit(args.targetSdkVersion, args.disabledCompatChanges,
                args.remainingArgs, classLoader);
    }
    
    <span class="hljs-keyword">return</span> RuntimeInit.findStaticMain(args.startClass, args.startArgs, classLoader);
}
</code></pre>
<p>这里的 startClass 就是 ActivityThread，找到之后调用，逻辑就到了 ActivityThread的main函数</p>
<p>android/app/ActivityThread.java</p>
<pre><code class="hljs language-ini" lang="ini">public static void main(String<span class="hljs-section">[]</span> args) {
    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, "ActivityThreadMain")<span class="hljs-comment">;</span>
    
    // 1. 初始化 Looper、MessageQueue
    Looper.prepareMainLooper()<span class="hljs-comment">;</span>
    
    // 2. 初始化 ActivityThread
    long <span class="hljs-attr">startSeq</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    if (args != null) {
        for (int <span class="hljs-attr">i</span> = args.length - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; --i) {</span>
            if (args<span class="hljs-section">[i]</span> != null &amp;&amp; args<span class="hljs-section">[i]</span>.startsWith(PROC_START_SEQ_IDENT)) {
                <span class="hljs-attr">startSeq</span> = Long.parseLong(
                        args<span class="hljs-section">[i]</span>.substring(PROC_START_SEQ_IDENT.length()))<span class="hljs-comment">;</span>
            }
        }
    }
    ActivityThread <span class="hljs-attr">thread</span> = new ActivityThread()<span class="hljs-comment">;</span>
    
    // 3. 主要是调用 AMS.attachApplicationLocked，同步进程信息，做一些初始化工作
    thread.attach(false, startSeq)<span class="hljs-comment">;</span>
    
    // 4. 获取主线程的 Handler，这里是 H ，基本上 App 的 Message 都会在这个 Handler 里面进行处理 
    if (<span class="hljs-attr">sMainThreadHandler</span> == null) {
        <span class="hljs-attr">sMainThreadHandler</span> = thread.getHandler()<span class="hljs-comment">;</span>
    }
    
    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER)<span class="hljs-comment">;</span>
    
    // 5. 初始化完成，Looper 开始工作
    Looper.loop()<span class="hljs-comment">;</span>
    
    throw new RuntimeException("Main thread loop unexpectedly exited")<span class="hljs-comment">;</span>
}
</code></pre>
<p>注释里面都很清楚，这里就不详细说了，main 函数处理完成之后，主线程就算是正式上线开始工作.</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-activitythread" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-28">ActivityThread 的功能</h3>
<p>另外我们经常说的，Android 四大组件都是运行在主线程上的，其实这里也很好理解，看一下 ActivityThread 的 Handler 的 Message 就知道了</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">H</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Handler</span> { <span class="hljs-comment">// 摘抄了部分，基于 Android 16 最新实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BIND_APPLICATION</span>        <span class="hljs-operator">=</span> <span class="hljs-number">110</span>; <span class="hljs-comment">// 应用启动</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CREATE_SERVICE</span>          <span class="hljs-operator">=</span> <span class="hljs-number">114</span>; <span class="hljs-comment">// 创建Service</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BIND_SERVICE</span>            <span class="hljs-operator">=</span> <span class="hljs-number">121</span>; <span class="hljs-comment">// 绑定Service  </span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">RECEIVER</span>                <span class="hljs-operator">=</span> <span class="hljs-number">113</span>; <span class="hljs-comment">// 广播接收</span>
    <span class="hljs-comment">// ... 还有其他四大组件相关的消息类型</span>
}
</code></pre>
<p>可以看到，进程创建、Activity 启动、Service 的管理、Receiver 的管理、Provider 的管理这些都会在这里处理，然后进到具体的 handleXXX</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-render-thread" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-29">渲染线程的创建和发展</h2>
<p>主线程讲完了我们来讲渲染线程，渲染线程也就是 RenderThread ，最初的 Android 版本里面是没有渲染线程的，渲染工作都是在主线程完成，使用的也都是 CPU ，调用的是 libSkia 这个库，RenderThread 是在 Android Lollipop 中新加入的组件，负责承担一部分之前主线程的渲染工作，减轻主线程的负担</p>
<h3 data-id="heading-30">软件绘制</h3>
<p>我们一般提到的硬件加速，指的就是 GPU 加速，这里可以理解为用 RenderThread 调用 GPU 来进行渲染加速 。 硬件加速在目前的 Android 中是默认开启的， 所以如果我们什么都不设置，那么我们的进程默认都会有主线程和渲染线程(有可见的内容)。我们如果在 App 的 AndroidManifest 里面，在 Application 标签里面加一个</p>
<pre><code class="hljs language-ini" lang="ini">android:<span class="hljs-attr">hardwareAccelerated</span>=<span class="hljs-string">"false"</span>
</code></pre>
<p>我们就可以关闭硬件加速，系统检测到你这个 App 关闭了硬件加速，就不会初始化 RenderThread ，直接 cpu 调用 libSkia 来进行渲染。其 Trace 跟踪表现如下 <strong>（资源比较老，用 Systrace 图示)</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79ac3fe0510648b48b02425fae0f34df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=mQ27P4fJgpbkEjBpf9b4NwhEp50%3D" alt="image.png" loading="lazy"/></p>
<p>与这篇文章开头开启硬件加速的 Perfetto 图对比，可以看到主线程由于要进行渲染工作，所以执行的时间变长了，也更容易出现卡顿，同时帧与帧之间的空闲间隔也变短了，使得其他 Message 的执行时间被压缩。在 Perfetto 中，这种差异通过线程活动的时间长度和密集程度可以清晰地观察到。</p>
<h3 data-id="heading-31">硬件加速绘制</h3>
<p>正常情况下，硬件加速是开启的，主线程的 draw 函数并没有真正的执行 drawCall ，而是把要 draw 的内容记录到 DisplayList 里面，通过 syncAndDrawFrame 将 DisplayList 同步到 RenderThread 中，一旦同步完成，主线程就可以被释放出来做其他的事情，RenderThread 则继续进行渲染工作。</p>
<h3 data-id="heading-32">渲染线程初始化</h3>
<p>渲染线程初始化在真正需要 draw 内容的时候，一般我们启动一个 Activity ，在第一个 draw 执行的时候，会去检测渲染线程是否初始化，如果没有则去进行初始化</p>
<p>android/view/ViewRootImpl.java</p>
<pre><code class="hljs language-ini" lang="ini">// 渲染线程初始化
mAttachInfo.mThreadedRenderer.initializeIfNeeded(
        mWidth, mHeight, mAttachInfo, mSurface, surfaceInsets)<span class="hljs-comment">;</span>

// 初始化 BlastBufferQueue - App 端缓冲区管理器
if (<span class="hljs-attr">mBlastBufferQueue</span> == null) {
    <span class="hljs-attr">mBlastBufferQueue</span> = new BLASTBufferQueue(mTag, mSurfaceControl,
        mSurfaceSize.x, mSurfaceSize.y,
        mWindowAttributes.format)<span class="hljs-comment">;</span>
    mBlastBufferQueue.update(mSurfaceControl, 
        mSurfaceSize.x, mSurfaceSize.y, mWindowAttributes.format)<span class="hljs-comment">;</span>
}
</code></pre>
<p>这里创建的 BlastBufferQueue 将在后续的渲染过程中发挥关键作用：</p>
<ul>
<li>为 RenderThread 提供高效的 Buffer 管理</li>
<li>支持批量 Transaction 提交，减少与 SurfaceFlinger 的交互开销</li>
<li>在 Perfetto 中可观察到 QueuedBuffer 指标的变化</li>
</ul>
<p>后续直接调用 draw</p>
<p>android/graphics/HardwareRenderer.java</p>
<pre><code class="hljs language-scss" lang="scss">mAttachInfo<span class="hljs-selector-class">.mThreadedRenderer</span><span class="hljs-selector-class">.draw</span>(mView, mAttachInfo, this);

void <span class="hljs-built_in">draw</span>(View view, AttachInfo attachInfo, DrawCallbacks callbacks) {
    final Choreographer choreographer = attachInfo<span class="hljs-selector-class">.mViewRootImpl</span><span class="hljs-selector-class">.mChoreographer</span>;
    choreographer<span class="hljs-selector-class">.mFrameInfo</span><span class="hljs-selector-class">.markDrawStart</span>();

    <span class="hljs-comment">// 更新 RootDisplayList，构建 RenderNode 树</span>
    <span class="hljs-built_in">updateRootDisplayList</span>(view, callbacks);

    <span class="hljs-comment">// 处理动画 RenderNode</span>
    if (attachInfo.mPendingAnimatingRenderNodes != null) {
        final int count = attachInfo<span class="hljs-selector-class">.mPendingAnimatingRenderNodes</span><span class="hljs-selector-class">.size</span>();
        for (int i = <span class="hljs-number">0</span>; i &lt; count; i++) {
            <span class="hljs-built_in">registerAnimatingRenderNode</span>(
                    attachInfo.mPendingAnimatingRenderNodes.get(i));
        }
        attachInfo<span class="hljs-selector-class">.mPendingAnimatingRenderNodes</span><span class="hljs-selector-class">.clear</span>();
        attachInfo<span class="hljs-selector-class">.mPendingAnimatingRenderNodes</span> = null;
    }

    <span class="hljs-comment">// 同步并绘制帧，这里会触发 RenderThread 工作</span>
    int syncResult = <span class="hljs-built_in">syncAndDrawFrame</span>(choreographer.mFrameInfo);
    
    <span class="hljs-comment">// 处理各种结果状态</span>
    if ((syncResult &amp; SYNC_LOST_SURFACE_REWARD_IF_FOUND) != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">setEnabled</span>(false);
        attachInfo<span class="hljs-selector-class">.mViewRootImpl</span><span class="hljs-selector-class">.mSurface</span><span class="hljs-selector-class">.release</span>();
        attachInfo<span class="hljs-selector-class">.mViewRootImpl</span><span class="hljs-selector-class">.invalidate</span>();
    }
    if ((syncResult &amp; SYNC_REDRAW_REQUESTED) != <span class="hljs-number">0</span>) {
        attachInfo<span class="hljs-selector-class">.mViewRootImpl</span><span class="hljs-selector-class">.invalidate</span>();
    }
}
</code></pre>
<p>上面的 draw 只是更新 DisplayList ，更新结束后，调用 syncAndDrawFrame ，通知渲染线程开始工作，主线程释放。在 syncAndDrawFrame 中完成了关键的 <strong>UI Thread 到 RenderThread 的数据同步过程</strong>。</p>
<h4 data-id="heading-33">UI Thread 与 RenderThread 的 DisplayList 同步机制</h4>
<p>在 <code>syncAndDrawFrame</code> 这个关键函数中，发生了以下重要的同步操作：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// frameworks/base/libs/hwui/renderthread/RenderProxy.cpp</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">RenderProxy::syncAndDrawFrame</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 将 UI Thread 的 DisplayList 同步到 RenderThread</span>
    <span class="hljs-comment">// 这里会把主线程构建的 RenderNode 树传递给渲染线程</span>
    <span class="hljs-keyword">return</span> mDrawFrameTask.<span class="hljs-built_in">drawFrame</span>();
}
</code></pre>
<p><code>syncAndDrawFrame</code> 的调用并非一个阻塞的同步过程，而是 UI 线程创建并派发一个 <code>DrawFrameTask</code> 到 RenderThread 的任务队列。这个 Task 封装了渲染这一帧所需的所有信息（主要是 RenderNode 树）。派发后，UI 线程就可以从渲染工作中解脱出来，处理其他事务。RenderThread 在自己的 Looper 中取出这个 Task 并执行，从而实现了两个线程的并行工作。</p>
<p>具体的同步过程包括：</p>
<ol start="0">
<li><strong>RenderNode 树的传递</strong>：主线程在 draw 过程中构建的 RenderNode 树（包含 DisplayList）会被传递给 RenderThread</li>
<li><strong>属性同步</strong>：View 的变换矩阵、透明度、裁剪区域等属性会一并同步</li>
<li><strong>资源共享</strong>：纹理、Path、Paint 等绘制资源在两个线程之间建立共享机制</li>
<li><strong>渲染状态传递</strong>：当前帧需要的渲染状态信息传递给 RenderThread</li>
</ol>
<p>这个同步过程是 Android 硬件加速渲染的核心，它实现了 UI Thread 专注于逻辑处理，RenderThread 专注于渲染的分工模式。</p>
<p>渲染线程的核心实现在 libhwui 库里面，其代码位于 frameworks/base/libs/hwui</p>
<h4 data-id="heading-34">RenderThread 与 BlastBufferQueue 的交互流程</h4>
<p>RenderThread 接收到同步的 DisplayList 后，开始真正的渲染工作，这个过程中会与 BlastBufferQueue 进行密切的交互：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// frameworks/base/libs/hwui/renderthread/CanvasContext.cpp</span>
<span class="hljs-comment">// Android 16 最新的 RenderThread 渲染流程</span>
void CanvasContext::<span class="hljs-built_in">draw</span>() {
    SkRect dirty;
    mDamageAccumulator<span class="hljs-selector-class">.finish</span>(&amp;dirty);
    
    <span class="hljs-comment">// 1. 从 BlastBufferQueue 获取可用的 Buffer</span>
    ANativeWindowBuffer* buffer;
    int fenceFd;
    status_t result = mNativeSurface-&gt;<span class="hljs-built_in">dequeueBuffer</span>(&amp;buffer, &amp;fenceFd);
    if (result != OK) {
        <span class="hljs-built_in">ALOGW</span>("Failed to dequeue buffer: %s (%d)", <span class="hljs-built_in">strerror</span>(-result), result);
        return;
    }
    
    <span class="hljs-comment">// 2. 设置渲染目标并绑定 Buffer</span>
    mRenderPipeline-&gt;<span class="hljs-built_in">onDequeueBuffer</span>(buffer);
    
    <span class="hljs-comment">// 3. 执行 GPU 渲染命令，包括所有 RenderNode 的绘制</span>
    bool drew = mRenderPipeline-&gt;<span class="hljs-built_in">draw</span>(frame, windowDirty, dirty, mLightGeometry,
                         &amp;mLayerUpdateQueue, mContentDrawBounds, mOpaque,
                         mLightInfo, mRenderNodes, &amp;(profiler()));
    
    <span class="hljs-comment">// 4. 完成渲染后，提交 Buffer（可能 unsignaled）</span>
    if (drew) {
        <span class="hljs-comment">// GPU 异步渲染，获取 presentFence（可能未 signal）</span>
        int presentFence = mRenderPipeline-&gt;<span class="hljs-built_in">flush</span>();
        
        <span class="hljs-comment">// 5. 直接提交 Buffer 到队列（无需等待 GPU 完成），并将 presentFence 传递给消费者</span>
        <span class="hljs-comment">// presentFence 是一个同步锁，由 GPU 在完成渲染时解开。根据系统配置（latch_unsignaled），SurfaceFlinger 可能会等待这个 fence，也可能在 fence 未 signaled 时就提前开始合成工作。</span>
        result = mNativeSurface-&gt;<span class="hljs-built_in">queueBuffer</span>(buffer, presentFence);
        
        <span class="hljs-comment">// 6. 触发 transaction，批量提交到 SurfaceFlinger</span>
        <span class="hljs-comment">// SurfaceFlinger 将根据 latch_unsignaled 策略决定是否接受</span>
        if (mBlastBufferQueue != nullptr) {
            mBlastBufferQueue-&gt;<span class="hljs-built_in">flushTransaction</span>();
        }
    } else {
        <span class="hljs-comment">// 如果没有绘制内容，直接取消 Buffer</span>
        mNativeSurface-&gt;<span class="hljs-built_in">cancelBuffer</span>(buffer, fenceFd);
    }
}
</code></pre>
<p><strong>BlastBufferQueue 的关键特性：</strong></p>
<ol start="0">
<li><strong>App 端管理</strong>：不同于传统的 BufferQueue 由 SurfaceFlinger 创建，BlastBufferQueue 是由 App 端创建和管理</li>
<li><strong>减少同步等待</strong>：通过生产者-消费者模型，减少了 RenderThread 在 dequeueBuffer 时的等待时间</li>
<li><strong>高效的缓冲区轮转</strong>：支持更智能的缓冲区管理策略，特别适配高刷新率显示器</li>
<li><strong>异步提交</strong>：通过 transaction 机制异步地将完成的帧提交给 SurfaceFlinger</li>
<li><strong>支持 unsignaled buffer</strong>：配合 SurfaceFlinger 的 <code>latch_unsignaled</code> 策略，允许提交 GPU 尚未完成的 Buffer，进一步减少渲染延迟</li>
</ol>
<p><strong>关于 Latching Unsignaled Buffers 的深入探讨</strong></p>
<p>现代 Android 系统对 <code>presentFence</code> 的处理有精细的控制，并非总是等待。这个机制被称为 <strong>"Latching Unsignaled Buffers"</strong> （捕获未就绪的缓冲区）。</p>
<ul>
<li><strong>传统模式</strong>: SurfaceFlinger 必须等待 App 的 <code>presentFence</code> 被 GPU signal 后，才能 "latch" (捕获) 这个 Buffer 进行合成。这保证了安全性，但增加了延迟。</li>
<li><strong>Latch Unsignaled 模式</strong>: 在此模式下，SurfaceFlinger 可以立即 latch 一个 GPU 尚未完成渲染的 Buffer（即 fence 未 signaled），并提前开始部分合成工作。当它需要真正使用这个 Buffer 的内容时，它才会在内部等待 <code>presentFence</code>。这通过流水线化进一步隐藏了 GPU 渲染的延迟，对降低游戏、视频等全屏应用的输入延迟至关重要。</li>
</ul>
<p><strong>控制开关与策略 (Android 13+)</strong> :</p>
<p>这个行为可以通过系统属性 <code>debug.sf.latch_unsignaled</code> 进行全局调试，但更重要的是，它由一个名为 <code>LatchUnsignaledConfig</code> 的分层策略控制。一个典型的策略是 <code>AutoSingleLayer</code>：</p>
<ul>
<li>当屏幕上只有<strong>单个图层</strong>更新时（如全屏游戏或视频），系统会自动启用 Latch Unsignaled 模式，因为此时没有复杂的图层依赖，风险最低，收益最大。</li>
<li>当有多个图层更新时，系统会回退到更安全的传统等待模式，以避免潜在的视觉错误。</li>
</ul>
<p>因此，SurfaceFlinger 并非总是盲目等待 <code>presentFence</code>，而是根据精密的策略来决定是否“抢跑”，以在稳定性和极致性能之间取得平衡。</p>
<h3 data-id="heading-35">主线程和渲染线程的分工</h3>
<p>主线程负责处理进程 Message、处理 Input 事件、处理 Animation 逻辑、处理 Measure、Layout、Draw ，更新 DisplayList ，但是不涉及与 SurfaceFlinger 直接打交道；渲染线程负责渲染相关的工作，包括与 BlastBufferQueue 的交互、GPU 渲染命令的执行，以及与 SurfaceFlinger 的最终交互。</p>
<p>当启动硬件加速后，在 Measure、Layout、Draw 的 Draw 这个环节，Android 使用 DisplayList 进行绘制而非直接使用 CPU 绘制每一帧。DisplayList 是一系列绘制操作的记录，抽象为 RenderNode 类，这样间接的进行绘制操作的优点如下</p>
<ol start="0">
<li>DisplayList 可以按需多次绘制而无须同业务逻辑交互</li>
<li>特定的绘制操作（如 translation、scale 等）可以作用于整个 DisplayList 而无须重新分发绘制操作</li>
<li>当知晓了所有绘制操作后，可以针对其进行优化：例如，所有的文本可以一起进行绘制一次</li>
<li>可以将对 DisplayList 的处理转移至另一个线程（也就是 RenderThread）</li>
<li>主线程在 sync 结束后可以处理其他的 Message，而不用等待 RenderThread 结束</li>
<li>通过 BlastBufferQueue 实现更高效的缓冲区管理，减少渲染延迟和主线程阻塞</li>
</ol>
<h4 data-id="heading-36">BlastBufferQueue 的工作原理</h4>
<p>BlastBufferQueue 是现代 Android 渲染架构中的关键组件，它改变了传统的缓冲区管理方式：</p>
<p><strong>传统 BufferQueue vs BlastBufferQueue：</strong></p>
<ol start="0">
<li>
<p><strong>创建主体不同</strong>：</p>
<ul>
<li>传统 BufferQueue：由 SurfaceFlinger 创建和管理</li>
<li>BlastBufferQueue：由 App 端（ViewRootImpl）创建和管理</li>
</ul>
</li>
<li>
<p><strong>缓冲区获取机制</strong>：</p>
<ul>
<li>传统方式：RenderThread 需要通过 Binder 调用向 SurfaceFlinger 请求 Buffer，可能会因为没有可用 Buffer 而阻塞</li>
<li>BlastBufferQueue：App 端预先管理缓冲区池，RenderThread 可以更高效地获取 Buffer</li>
</ul>
</li>
<li>
<p><strong>提交机制</strong>：</p>
<ul>
<li>传统方式：通过 queueBuffer 直接提交给 SurfaceFlinger</li>
<li>BlastBufferQueue：通过 transaction 机制批量提交，减少 Binder 调用开销</li>
</ul>
</li>
</ol>
<p><strong>在 Perfetto 中观察 BlastBufferQueue：</strong></p>
<p>在 Perfetto 跟踪中，BlastBufferQueue 的状态通过以下关键指标显示：</p>
<h4 data-id="heading-37">App 端的 QueuedBuffer 指标</h4>
<ul>
<li><strong>Perfetto 显示</strong>：<code>QueuedBuffer</code> 数值轨道</li>
<li><strong>计算规则</strong>：App 生产的 Buffer 总数 = QueuedBuffer - 1</li>
<li><strong>基准值说明</strong>：QueuedBuffer 的最小值为 1，0 表示没有 Buffer 在队列中</li>
<li><strong>数值含义</strong>：QueuedBuffer 为 2 表示有 1 个 Buffer 在队列中，QueuedBuffer 为 3 表示有 2 个 Buffer 在队列中，以此类推</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c0455af8d1c48b1b95601da9e84ca19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=rRnefu3q1T7%2BcpxdgpExPgFGYHo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-38">QueuedBuffer 数值变化时机</h4>
<p><strong>QueuedBuffer +1 的时机</strong>：</p>
<ul>
<li><strong>触发条件</strong>：RenderThread 执行 <code>queueBuffer</code> 操作</li>
<li><strong>Perfetto 表现</strong>：<code>queueBuffer</code> 事件执行时，QueuedBuffer 计数增加</li>
<li><strong>含义</strong>：RenderThread 将渲染完成的 Buffer 提交到 App 端的 BlastBufferQueue 中等待发送给 SurfaceFlinger</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/280ac05948af4759bf997e5dd90dbd19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=AHf2H11ApXtkPs5Wo58xRdq1syA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>QueuedBuffer -1 的时机</strong>：</p>
<ul>
<li><strong>触发条件</strong>：收到 SurfaceFlinger 的 <code>releaseBufferCallback</code></li>
<li><strong>Perfetto 表现</strong>：可观察到 <code>releaseBuffer</code> 相关事件</li>
<li><strong>含义</strong>：SurfaceFlinger 已使用完某个 Buffer，将其释放回 App 端 BlastBufferQueue，该 Buffer 可重新用于渲染</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/269ba73379134ba598753dc9cc91e089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=UGYEqIk4c0lASnkH3PTwhNUEzRc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-39">SurfaceFlinger 端的 BufferTX 指标</h4>
<ul>
<li><strong>Perfetto 显示</strong>：SurfaceFlinger 进程中的 <code>BufferTX</code> 数值轨道</li>
<li><strong>变化时机</strong>：SurfaceFlinger 接收到 Transaction 后 BufferTX +1</li>
<li><strong>触发条件</strong>：App 端通过 <code>flushTransaction</code> 将 Buffer 真正发送给 SurfaceFlinger</li>
<li><strong>最大值限制</strong>：BufferTX 最高为 3</li>
<li><strong>原因说明</strong>：这个最大值为 3 的限制，实际上就是我们熟知的<strong>三缓冲（Triple Buffering）</strong> 机制在合成侧的体现：一个正在被显示器读取（Front Buffer），一个准备在下一个 Vsync 周期被合成（Back Buffer），还有一个作为备用（Third Buffer）。这确保了即使在轻微的渲染抖动下，SurfaceFlinger 依然有帧可合成，从而提升流畅度。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/430d040b1d644fe38d8b120e5c65a3dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=UmaiHMrkz%2Ftxi5iWGAv5LFB%2FuyE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-40">App 端和 SF 端的协作流程</h4>
<ol start="0">
<li><strong>App 端</strong>：RenderThread <code>queueBuffer</code> → App 端 QueuedBuffer +1（Buffer 进入 App 端队列）</li>
<li><strong>App 端</strong>：<code>flushTransaction</code> → 将队列中的 Buffer 批量发送给 SurfaceFlinger</li>
<li><strong>SF 端</strong>：接收 Transaction → SF 端 BufferTX +1（Buffer 进入 SF 端处理）</li>
<li><strong>SF 端</strong>：处理完成后发送 <code>releaseBufferCallback</code> → App 端 QueuedBuffer -1（Buffer 释放回 App）</li>
</ol>
<h4 data-id="heading-41">关键性能观察点</h4>
<p>在分析性能时，重点关注：</p>
<ul>
<li><strong>App 端 QueuedBuffer 数值</strong>：反映渲染生产速度，如果 App 生产过慢，QueuedBuffer 个数就可以反应出来 （always 是 1 ，说明没有 Buffer 生产出来）。重点关注需要连续出帧的场景（比如滑动过程），QueuedBuffer 的值为 1 超过 1 个 Vsync 的地方，看对应的 App 主线程和渲染线程是否有性能问题。</li>
<li><strong>SurfaceFlinger 端 BufferTX</strong>：反映系统合成处理能力 ，如果 SurfaceFlinger 消费 Buffer 过慢，也会有性能问题。重点关注需要连续出帧的场景（比如滑动过程） ，对应的 BufferTX 为 0 的情况 或者 BufferTX 没有被消费的情况，前一种情况是 App 的问题，后一种情况是 SurfaceFlinger 的问题。</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-performance" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-42">性能</h2>
<p>如果主线程需要处理所有任务，则执行耗时较长的操作（例如，网络访问或数据库查询）将会阻塞整个界面线程。一旦被阻塞，线程将无法分派任何事件，包括绘图事件。主线程执行超时通常会带来两个问题</p>
<ol start="0">
<li><strong>卡顿</strong>：如果主线程 + 渲染线程每一帧的执行都超过 8.33ms(120fps 的情况下)，那么就可能会出现掉帧（说可能是因为有的情况下其实不会掉帧，因为有 app duration 、buffer 堆积等情况）。</li>
<li><strong>卡死</strong>：如果界面线程被阻塞超过几秒钟时间（根据组件不同 , 这里的阈值也不同），用户会看到 "<a href="https://link.juejin.cn?target=http%3A%2F%2Fdeveloper.android.google.cn%2Fguide%2Fpractices%2Fresponsiveness.html" target="_blank" title="http://developer.android.google.cn/guide/practices/responsiveness.html" ref="nofollow noopener noreferrer">应用无响应</a>" (ANR) 对话框(部分厂商屏蔽了这个弹框,会直接 Crash 到桌面)</li>
</ol>
<p>对于用户来说，这两个情况都是用户不愿意看到的，所以对于 App 开发者来说，两个问题是发版本之前必须要解决的，ANR 这个由于有详细的调用栈，所以相对来说比较好定位；但是间歇性卡顿这个，可能就需要使用工具来进行分析了：<strong>Perfetto + Trace View （Android Studio 已经集成）</strong> ，所以理解主线程和渲染线程的关系和他们的工作原理是非常重要的，这也是本系列的一个初衷。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-frametimeline" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-43">Perfetto 独有的 FrameTimeline 功能</h3>
<p>Perfetto 相比 Systrace 的一个重要优势是提供了 <strong>FrameTimeline</strong> 功能，可以一眼就可以看到卡顿的地方。</p>
<blockquote>
<p><strong>注意</strong>: FrameTimeline 需要 Android 12(S) 或更高版本支持</p>
</blockquote>
<h4 data-id="heading-44">FrameTimeline 的核心概念</h4>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fframetimeline" target="_blank" title="https://perfetto.dev/docs/data-sources/frametimeline" ref="nofollow noopener noreferrer">Perfetto 官方文档</a>，当帧在屏幕上的实际呈现时间与调度器预期的呈现时间不匹配时，就会产生卡顿。FrameTimeline 为每个有帧在屏幕上显示的应用添加了两个新的轨道：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aba3d60d534a49a29fd498e782b02258~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=nSCQuqiVa5lZzqEjLL0wu5cYqNw%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-45">1. Expected Timeline（预期时间线）</h5>
<ul>
<li><strong>作用</strong>: 显示系统分配给应用的渲染时间窗口</li>
<li><strong>开始时间</strong>: Choreographer 回调被调度运行的时间</li>
<li><strong>含义</strong>: 为了避免系统卡顿，应用需要在这个时间范围内完成工作</li>
</ul>
<h5 data-id="heading-46">2. Actual Timeline（实际时间线）</h5>
<ul>
<li><strong>作用</strong>: 显示应用完成帧的实际时间（包括 GPU 工作）</li>
<li><strong>开始时间</strong>: <code>Choreographer#doFrame</code> 或 <code>AChoreographer_vsyncCallback</code> 开始运行的时间</li>
<li><strong>结束时间</strong>: <code>max(GPU 时间, Post 时间)</code>，其中 Post 时间是帧被提交到 SurfaceFlinger 的时间</li>
</ul>
<p>当你点击 Actual Timeline 上的一个 追踪的时候，会显示这一帧具体的被消费的时间（可以看延时）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19e0cd428f67476eb43ab7e72ecf3d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=Q9n%2BCEjJaekUy65O9IbwfBVHduQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-47">颜色编码系统</h4>
<p>FrameTimeline 使用直观的颜色来标识不同的帧状态：</p>



































<table><thead><tr><th>颜色</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td><strong>绿色</strong></td><td>正常帧</td><td>没有观察到卡顿，理想状态</td></tr><tr><td><strong>浅绿色</strong></td><td>高延迟状态</td><td>帧率稳定但帧呈现延迟，导致输入延迟增加</td></tr><tr><td><strong>红色</strong></td><td>卡顿帧</td><td>当前进程导致的卡顿</td></tr><tr><td><strong>黄色</strong></td><td>应用无责任卡顿</td><td>帧出现卡顿但应用不是原因，SurfaceFlinger 导致的卡顿</td></tr><tr><td><strong>蓝色</strong></td><td>丢帧</td><td>SurfaceFlinger 丢弃了该帧，选择了更新的帧</td></tr></tbody></table>
<p>点击不同颜色的 ActualTimeline 可以在信息栏看到下面的描述，告诉你卡顿的原因：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d2b81891329485c8a49e60f61d636c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=GX09jcJMRITHcIj76uKHsiudR5A%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-48">卡顿类型分析</h4>
<p>FrameTimeline 可以识别多种卡顿类型：</p>
<h5 data-id="heading-49">应用端卡顿：</h5>
<ul>
<li><strong>AppDeadlineMissed</strong>: 应用运行时间超过预期</li>
<li><strong>BufferStuffing</strong>: 应用在前一帧呈现前就发送新帧，导致 Buffer 队列堆积</li>
</ul>
<h5 data-id="heading-50">SurfaceFlinger 卡顿：</h5>
<ul>
<li><strong>SurfaceFlingerCpuDeadlineMissed</strong>: SurfaceFlinger 主线程超时</li>
<li><strong>SurfaceFlingerGpuDeadlineMissed</strong>: GPU 合成时间超时</li>
<li><strong>DisplayHAL</strong>: HAL 层呈现延迟</li>
<li><strong>PredictionError</strong>: 调度器预测偏差</li>
</ul>
<h4 data-id="heading-51">配置 FrameTimeline</h4>
<p>在 Perfetto 配置中启用 FrameTimeline：</p>
<pre><code class="hljs language-arduino" lang="arduino">data_sources {
    config {
        name: <span class="hljs-string">"android.surfaceflinger.frametimeline"</span>
    }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-vsync" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-52">Perfetto 中 Vsync 信号</h3>
<p>在 Perfetto 中，<strong>Vsync 信号使用 Counter 类型来显示</strong>，这与很多人的直觉认知不同：</p>
<ul>
<li><strong>0 → 1 的变化</strong>：表示一个 Vsync 信号</li>
<li><strong>1 → 0 的变化</strong>：同样表示一个 Vsync 信号</li>
<li><strong>错误理解</strong>：很多人误以为只有变成 1 才是 Vsync 信号</li>
</ul>
<h4 data-id="heading-53">正确的 Vsync 信号识别</h4>
<p>下图中 1 、2、3、4 的时间点都是 Vsync 信号到达</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c98c3de2a4324553928efba1f8350321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904095&amp;x-signature=ZVyB666RXTizzWfUp8MpvUXoNEk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键要点</strong>：</p>
<ol start="0">
<li><strong>每次数值变化都是一个 Vsync</strong>：无论是 0→1 还是 1→0</li>
<li><strong>信号频率</strong>：120Hz 设备上约每 8.33ms 会有一次变化（实际可能因系统调度略有差异，这里指的是连续出帧场景）</li>
<li><strong>多 App 场景</strong>：Counter 可能因为其他 App 的申请而保持活跃状态</li>
</ol>
<h4 data-id="heading-54">分析技巧</h4>
<p><strong>判断 App 是否接收到 Vsync</strong>：</p>
<ul>
<li><strong>正确方法</strong>：查看 App 进程中是否有对应的 <code>FrameDisplayEventReceiver.onVsync</code> 事件</li>
<li><strong>错误方法</strong>：仅凭 SurfaceFlinger 中的 <code>vsync-app</code> counter 变化来判断</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-refs" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-55">参考</h2>
<ol start="0">
<li><a href="https://juejin.im/post/5a9e01c3f265da239d48ce32" target="_blank" title="https://juejin.im/post/5a9e01c3f265da239d48ce32">juejin.im/post/5a9e01…</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.cocoachina.com%2Farticles%2F35302" target="_blank" title="http://www.cocoachina.com/articles/35302" ref="nofollow noopener noreferrer">www.cocoachina.com/articles/35…</a></li>
<li><a href="https://juejin.im/post/5b7767fef265da43803bdc65" target="_blank" title="https://juejin.im/post/5b7767fef265da43803bdc65">juejin.im/post/5b7767…</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fgityuan.com%2F2019%2F06%2F15%2Fflutter_ui_draw%2F" target="_blank" title="http://gityuan.com/2019/06/15/flutter_ui_draw/" ref="nofollow noopener noreferrer">gityuan.com/2019/06/15/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fguide%2Fcomponents%2Fprocesses-and-threads" target="_blank" title="https://developer.android.google.cn/guide/components/processes-and-threads" ref="nofollow noopener noreferrer">developer.android.google.cn/guide/compo…</a></li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-attachments" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-56">附件</h2>
<p>本文涉及到的 Perfetto 跟踪文件也上传了，各位下载后可以在 Perfetto UI (<a href="https://link.juejin.cn?target=https%3A%2F%2Fui.perfetto.dev%2F" target="_blank" title="https://ui.perfetto.dev/" ref="nofollow noopener noreferrer">ui.perfetto.dev/</a>) 中打开分析</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FGracker%2FSystraceForBlog%2Ftree%2Fmaster%2FAndroid_Perfetto%2Fdemo_app_aosp_scroll.perfetto-trace" target="_blank" title="https://github.com/Gracker/SystraceForBlog/tree/master/Android_Perfetto/demo_app_aosp_scroll.perfetto-trace" ref="nofollow noopener noreferrer">点此链接下载文章所涉及到的 Perfetto 跟踪文件</a></p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-about" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-57">关于我 &amp;&amp; 博客</h2>
<p>下面是个人的介绍和相关的链接，期望与同行的各位多多交流，三人行，则必有我师!</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">博主个人介绍</a> ：里面有个人的微信和微信群链接。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F12%2F01%2FBlogMap%2F" target="_blank" title="https://www.androidperformance.com/2019/12/01/BlogMap/" ref="nofollow noopener noreferrer">本博客内容导航</a> ：个人博客内容的一个导航。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2018%2F05%2F07%2FAndroid-performance-optimization-skills-and-tools%2F" target="_blank" title="https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools/" ref="nofollow noopener noreferrer">个人整理和搜集的优秀博客文章 - Android 性能优化必知必会</a> ：欢迎大家自荐和推荐 （微信私聊即可）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2023%2F12%2F30%2Fthe-performance%2F" target="_blank" title="https://www.androidperformance.com/2023/12/30/the-performance/" ref="nofollow noopener noreferrer">Android性能优化知识星球</a> ： 欢迎加入，多谢支持～</li>
</ol>
<blockquote>
<p><strong>一个人可以走的更快 , 一群人可以走的更远</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微信浏览器缓存机制大揭秘：为什么你总刷不出新页面？]]></title>    <link>https://juejin.cn/post/7572539461478858795</link>    <guid>https://juejin.cn/post/7572539461478858795</guid>    <pubDate>2025-11-16T13:31:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572539461478858795" data-draft-id="7571444391810138147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微信浏览器缓存机制大揭秘：为什么你总刷不出新页面？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-16T13:31:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微信浏览器缓存机制大揭秘：为什么你总刷不出新页面？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:31:32.000Z" title="Sun Nov 16 2025 13:31:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">缓存之谜：为何你的应用总是无法自动更新？</h2>
<p>你是否也经历过这样的场景：线上刚修复完bug并已经发布，得到的反馈还是存在问题。所发布的应用是内嵌在小程序中，经常会出现发布后没有更新到最新的版本。只能无奈地回复：“清一下手机缓存”。心里想如何能在发布完成后，立即让用户得到最新的版本。</p>
<p>如果这个场景让你感同身受，那么这篇文章就是为你准备的。提供一个一劳永逸的 Nginx 配置方案，让你的应用实时更新。</p>
<h2 data-id="heading-1">1. 缓存策略</h2>
<p>我们必须理解浏览器缓存策略的优先级。服务器（如 Nginx）在 HTTP 响应中返回的 <code>Cache-Control</code>、<code>Expires</code> 等头部信息，才是浏览器必须严格遵守的“最高指令”。</p>
<p>因为我们使用Webpack等构建工具，在打包时为 JS、CSS 等静态资源生成独一无二的 Hash 值文件名。当文件变化，index.html文件中的引入文件也会变化，如果此时浏览器缓存了，请求的是旧的html,就会出现一直请求旧的页面。</p>
<pre><code class="hljs language-js" lang="js">main.1258d91412371.<span class="hljs-property">js</span>
vendor.<span class="hljs-property">ant</span>-design.59d332b0.<span class="hljs-property">js</span>
</code></pre>
<p>理论上，只要文件内容发生变化，Hash就会改变，浏览器就要请求新的文件。</p>
<h2 data-id="heading-2">2. 解决方案</h2>
<p>那么我们只需要保证每次请求的html是最新的就可以解决缓存问题。</p>
<p>我们只需要将nginx中的<code>index.html</code>强制不缓存：</p>
<pre><code class="hljs language-js" lang="js">location = /index.<span class="hljs-property">html</span> {
    add_header <span class="hljs-title class_">Cache</span>-<span class="hljs-title class_">Control</span> <span class="hljs-string">"no-cache, no-store, must-revalidate"</span>;
    add_header <span class="hljs-title class_">Pragma</span> <span class="hljs-string">"no-cache"</span>;
    add_header <span class="hljs-title class_">Expires</span> <span class="hljs-string">"0"</span>;
}
</code></pre>
<p>前后整体流程是：</p>
<ol>
<li>当浏览器请求 <code>https://xxx.com/</code> 时，命中了 <code>location /</code> 规则。</li>
<li>Nginx 返回了旧的的<code>index.html</code> 文件，但<strong>没有附加任何 <code>Cache-Control</code> 或 <code>Expires</code> 响应头</strong>。</li>
<li>浏览器或上游CDN看到这个“沉默”的响应，便启用自己的默认缓存策略，将 <code>index.html</code> 缓存了一段时间。</li>
<li>当你部署新版本后，JS 文件名（例如 <code>main.new-hash.js</code>）虽然变了，但用户再次访问时，浏览器直接从缓存中取出了<strong>旧的 <code>index.html</code></strong>。</li>
<li>旧的 HTML 文件依然引用着<strong>旧的 JS 文件</strong>（<code>main.old-hash.js</code>）。</li>
<li>最终，用户看到的还是旧版本，那个让你抓狂的 Bug 依然存在。</li>
<li>如果此时新的nginx配置完成，每次请求命中<code>/index.html</code>设置</li>
<li>获取了新的html,也就会获取新的js文件，那么问题就解决了。</li>
</ol>
<h2 data-id="heading-3">3， CDN设置</h2>
<p>如果你的应用部署在CDN上，确保CDN的缓存策略与你的 Nginx 配置保持一致。通常需要在CDN控制台设置缓存配置，使其“<strong>遵守源站（Origin）的 Cache-Control 头</strong>”。</p>















<table><thead><tr><th align="left">文件类型</th><th align="left">建议 TTL</th><th align="left">是否遵守源站</th></tr></thead><tbody><tr><td align="left"><code>*.html</code></td><td align="left">0 秒</td><td align="left">是</td></tr></tbody></table>
<h2 data-id="heading-4">4. 注意点</h2>
<p>当新的<code>nginx</code>配置后，不一定会立刻生效。还是要将手机缓存清理下，才能每次获取最新的页面。</p>
<h2 data-id="heading-5">5. 总结</h2>
<p>最后总结一下：缓存的根本在于 <strong>HTTP 响应头是控制缓存的唯一权威</strong>。通过在 Nginx 层实施精细化的缓存策略——<strong>让入口 HTML 永不缓存，让带 Hash 的静态资源永久缓存</strong>，才能做到实时更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[try...catch 核心与生态协作全解析]]></title>    <link>https://juejin.cn/post/7572757056438534153</link>    <guid>https://juejin.cn/post/7572757056438534153</guid>    <pubDate>2025-11-16T13:32:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572757056438534153" data-draft-id="7568425510793068544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" try...catch 核心与生态协作全解析"/> <meta itemprop="keywords" content="JavaScript,前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-16T13:32:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             try...catch 核心与生态协作全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:32:23.000Z" title="Sun Nov 16 2025 13:32:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="arta">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#222}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#aaa}.hljs-section{color:#fff}.hljs-comment,.hljs-meta,.hljs-quote{color:#444}.hljs-bullet,.hljs-regexp,.hljs-string,.hljs-symbol{color:#fc3}.hljs-addition,.hljs-number{color:#0c6}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-template-variable,.hljs-type{color:#32aaee}.hljs-keyword,.hljs-name,.hljs-selector-class,.hljs-selector-id,.hljs-selector-tag{color:#64a}.hljs-deletion,.hljs-template-tag,.hljs-title,.hljs-variable{color:#b16}.hljs-doctag,.hljs-section,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">一、try...catch 本质：为何需要它？（从程序失控到可控）</h2>
<p>在 JavaScript 执行过程中，代码常因变量未定义、类型错误、API 调用失败等问题中断。若缺乏异常处理，同步代码会直接崩溃，异步代码会陷入不可预知状态。<code>try...catch</code> 的核心价值是<strong>将 “不可控的错误中断” 转化为 “可控的逻辑处理”</strong> ，避免程序崩溃并提供补救机会，是保障代码健壮性的基础机制。</p>
<h3 data-id="heading-1">1.1 无 try...catch 时的问题</h3>
<p>代码报错后直接终止，后续逻辑无法执行，影响用户体验。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'invalid json'</span>); <span class="hljs-comment">// 报错：Unexpected token i in JSON at position 0</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'程序继续执行'</span>); <span class="hljs-comment">// 不会执行，代码中断</span>
</code></pre>
<h3 data-id="heading-2">1.2 有 try...catch 时的优化</h3>
<p>错误被捕获后，可执行补救逻辑，程序正常流转。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'invalid json'</span>);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解析失败，使用默认数据'</span>); <span class="hljs-comment">// 执行补救操作</span>
  <span class="hljs-keyword">const</span> data = { <span class="hljs-attr">default</span>: <span class="hljs-string">'value'</span> }; 
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'程序继续执行'</span>); <span class="hljs-comment">// 正常执行，无中断</span>
</code></pre>
<h2 data-id="heading-3">二、try...catch 与核心技术的关联：从基础到扩展</h2>
<p><code>try...catch</code> 并非仅与 <code>Promise</code>、<code>axios</code> 相关，而是贯穿 JavaScript 全场景的通用机制，以下从核心关联、跨界场景两方面详细解析。</p>
<h3 data-id="heading-4">2.1 与 Promise、async/await 的底层关联</h3>
<p><code>try...catch</code> 本质是<strong>同步错误捕获工具</strong>，而 <code>Promise</code> 处理异步操作，二者需配合实现 “同步 + 异步” 全场景错误处理。</p>
<h4 data-id="heading-5">2.1.1 Promise 为何需要独立错误处理？</h4>
<p>异步代码（如定时器、网络请求）的错误发生在 “当前事件循环之外”，<code>try...catch</code> 无法直接捕获。<code>Promise</code> 设计 <code>.catch()</code> 方法，专门捕获异步执行中的错误（包括 <code>reject</code> 和执行器内同步错误）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// try...catch 无法捕获 Promise 内部异步错误</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'异步错误'</span>); <span class="hljs-comment">// 错误发生在定时器回调，属异步</span>
    }, <span class="hljs-number">100</span>);
  });
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获不到'</span>, error); <span class="hljs-comment">// 不执行</span>
}

<span class="hljs-comment">// 需用 Promise 的 .catch() 捕获</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'异步错误'</span>);
  }, <span class="hljs-number">100</span>);
}).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到'</span>, error); <span class="hljs-comment">// 正常执行</span>
});
</code></pre>
<h4 data-id="heading-6">2.1.2 async/await 如何让 try...catch 接管异步错误？</h4>
<p><code>async/await</code> 是 <code>Promise</code> 语法糖，能将异步代码 “伪装” 成同步执行顺序，使 <code>try...catch</code> 可同时捕获 “同步错误” 和 “await 后的 Promise 错误”（<code>await</code> 等待 Promise 状态变更时，异步错误转化为 “等待阶段错误”）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">fetchData</span>()</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 同步错误：未定义变量</span>
    <span class="hljs-keyword">const</span> invalid = undefinedVariable; 
    <span class="hljs-comment">// 异步错误：axios 请求失败（返回 rejected Promise）</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/invalid-api'</span>); 
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 同步、异步错误均被捕获</span>
    console.log(<span class="hljs-string">'捕获到所有错误：'</span>, error); 
  }
}
</code></pre>
<h3 data-id="heading-7">2.2 与 axios 的协作逻辑</h3>
<p><code>axios</code> 是基于 <code>Promise</code> 的 HTTP 客户端，其错误分两类，需通过 <code>try...catch</code> 或 <code>.catch()</code> 统一处理：</p>
<ul>
<li>网络错误（如断网）：直接触发 <code>reject</code>；</li>
<li>HTTP 错误（如 404/500）：默认触发 <code>reject</code>，可通过 <code>validateStatus</code> 配置修改。</li>
</ul>
<h4 data-id="heading-8">2.2.1 用 .catch () 处理 axios 错误</h4>
<pre><code class="hljs language-lua" lang="lua">axios.get(<span class="hljs-string">'/api/data'</span>)
  .<span class="hljs-keyword">then</span>(response =&gt; {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'请求成功:'</span>, response.data);
  })
  .catch(<span class="hljs-built_in">error</span> =&gt; {
    // 捕获网络错误或 HTTP 错误
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">error</span>.response) {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'HTTP 错误状态码:'</span>, <span class="hljs-built_in">error</span>.response.<span class="hljs-built_in">status</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">error</span>.request) {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'网络错误，无响应:'</span>, <span class="hljs-built_in">error</span>.request);
    }
  });
</code></pre>
<h4 data-id="heading-9">2.2.2 用 try...catch 处理 axios 错误（async/await 场景）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserData</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 统一捕获并细化处理</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">404</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户不存在'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取用户数据失败:'</span>, error);
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 需上层处理时重新抛出</span>
  }
}
</code></pre>
<h3 data-id="heading-10">2.3 跨界关联场景：不止于 Promise、axios</h3>
<p><code>try...catch</code> 可捕获 “当前执行上下文” 中所有同步错误，覆盖 DOM 操作、Node.js 核心模块、第三方库等场景。</p>
<h4 data-id="heading-11">2.3.1 与 DOM 操作的协作</h4>
<p>DOM 操作易因 “元素不存在”“修改只读属性” 出错，<code>try...catch</code> 可避免页面功能瘫痪。</p>
<pre><code class="hljs language-ini" lang="ini">function renderUserList(users) {
  try {
    const <span class="hljs-attr">list</span> = document.getElementById(<span class="hljs-string">'user-list'</span>)<span class="hljs-comment">;</span>
    // 若 list 不存在或 users 格式异常，直接报错
    users.forEach(<span class="hljs-attr">user</span> =&gt; {
      const <span class="hljs-attr">item</span> = document.createElement(<span class="hljs-string">'li'</span>)<span class="hljs-comment">;</span>
      <span class="hljs-attr">item.textContent</span> = user.name<span class="hljs-comment">; // 若 user 无 name 属性，触发错误</span>
      list.appendChild(item)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  } catch (error) {
    console.error('渲染失败：', error)<span class="hljs-comment">;</span>
    // 降级处理：显示错误提示而非白屏
    <span class="hljs-attr">document.body.innerHTML</span> = <span class="hljs-string">'&lt;p&gt;加载用户列表失败，请刷新重试&lt;/p&gt;'</span><span class="hljs-comment">;</span>
  }
}
</code></pre>
<h4 data-id="heading-12">2.3.2 与 Node.js 核心模块的配合</h4>
<p>Node.js 中同步 API（如 <code>fs.readFileSync</code>）的错误需 <code>try...catch</code> 捕获，否则导致进程崩溃。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">readConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 同步读取文件，文件不存在/权限不足时抛出错误</span>
    <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'./config.json'</span>, <span class="hljs-string">'utf8'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(content); <span class="hljs-comment">// 解析失败也被捕获</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'配置文件读取失败：'</span>, error);
    <span class="hljs-comment">// 返回默认配置，保证程序正常启动</span>
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">default</span>: <span class="hljs-string">'config'</span> }; 
  }
}
</code></pre>
<h4 data-id="heading-13">2.3.3 与第三方库的兼容</h4>
<p>第三方库（如 <code>moment</code>、<code>Redux</code>）的同步方法可能因无效参数抛出错误，<code>try...catch</code> 是通用防护手段。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> moment <span class="hljs-keyword">from</span> <span class="hljs-string">'moment'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">dateString</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 若 dateString 格式无效，moment 格式化会报错</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">moment</span>(dateString).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'日期格式化失败：'</span>, error);
    <span class="hljs-comment">// 友好提示，避免暴露技术错误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'无效日期'</span>; 
  }
}
</code></pre>
<h2 data-id="heading-14">三、复杂项目场景：try...catch 的实战应用</h2>
<p>在多任务依赖、并行执行等复杂场景中，<code>try...catch</code> 与 <code>Promise</code> 组合可实现 “错误隔离”“流程可控”，避免局部错误影响全局。</p>
<h3 data-id="heading-15">3.1 分步依赖任务：串联式任务队列</h3>
<p>场景：先获取 Token → 用 Token 拉取用户 ID → 提交表单，某一步出错需中断并提示。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 任务1：获取 Token</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getToken</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/auth'</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>)
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`获取 Token 失败：<span class="hljs-subst">${err.message}</span>`</span>); <span class="hljs-comment">// 包装错误上下文</span>
    });
}

<span class="hljs-comment">// 任务2：用 Token 获取用户 ID</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserId</span>(<span class="hljs-params">token</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/user'</span>, { <span class="hljs-attr">headers</span>: { token } });
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>.<span class="hljs-property">id</span>;
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`获取用户 ID 失败：<span class="hljs-subst">${err.message}</span>`</span>); <span class="hljs-comment">// 补充错误信息</span>
  }
}

<span class="hljs-comment">// 任务3：提交表单（依赖用户 ID）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">userId, formData</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/submit'</span>, { ...formData, userId });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'提交成功'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`提交表单失败：<span class="hljs-subst">${err.message}</span>`</span>);
  }
}

<span class="hljs-comment">// 主流程：统一控制，汇总错误</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">formData</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getToken</span>();
    <span class="hljs-keyword">const</span> userId = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserId</span>(token);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitForm</span>(userId, formData);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 所有步骤错误汇总到此处，统一提示+上报</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'流程中断：'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">`操作失败：<span class="hljs-subst">${error.message}</span>`</span>);
    <span class="hljs-comment">// 上报错误到监控系统（附带用户/时间等上下文）</span>
    <span class="hljs-title function_">logErrorToServer</span>({
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">stack</span>: error.<span class="hljs-property">stack</span>,
      <span class="hljs-attr">context</span>: { <span class="hljs-attr">userId</span>: <span class="hljs-string">'xxx'</span>, <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>() }
    });
  }
}
</code></pre>
<h3 data-id="heading-16">3.2 并行任务：错误隔离不中断整体</h3>
<p>场景：页面同时渲染 3 个独立组件（用户信息、订单列表、消息通知），一个组件出错不影响其他组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 组件1：渲染用户信息</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderUserInfo</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId}</span>`</span>);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'user-info'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`&lt;p&gt;<span class="hljs-subst">${user.data.name}</span>&lt;/p&gt;`</span>;
      <span class="hljs-title function_">resolve</span>();
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">reject</span>(<span class="hljs-string">`用户信息组件失败：<span class="hljs-subst">${err.message}</span>`</span>);
    }
  });
}

<span class="hljs-comment">// 组件2：渲染订单列表</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderOrderList</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> orders = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/orders/<span class="hljs-subst">${userId}</span>`</span>);
      <span class="hljs-comment">// 渲染逻辑...</span>
      <span class="hljs-title function_">resolve</span>();
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">reject</span>(<span class="hljs-string">`订单列表组件失败：<span class="hljs-subst">${err.message}</span>`</span>);
    }
  });
}

<span class="hljs-comment">// 主流程：并行渲染，错误隔离</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderAllComponents</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// 用 Promise.allSettled 捕获所有结果，成功/失败均不中断</span>
  <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([
    <span class="hljs-title function_">renderUserInfo</span>(userId),
    <span class="hljs-title function_">renderOrderList</span>(userId),
    <span class="hljs-title function_">renderMessageList</span>(userId) <span class="hljs-comment">// 组件3：渲染消息通知</span>
  ]);

  <span class="hljs-comment">// 处理失败结果，单独提示</span>
  results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">result, index</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-string">'rejected'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`组件<span class="hljs-subst">${index+<span class="hljs-number">1</span>}</span>渲染失败：`</span>, result.<span class="hljs-property">reason</span>);
      <span class="hljs-comment">// 标记失败组件，不影响其他组件展示</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.component'</span>)[index].<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'error'</span>);
    }
  });
}
</code></pre>
<h2 data-id="heading-17">四、try...catch 的局限性：并非万能</h2>
<p>尽管 <code>try...catch</code> 是基础机制，但存在明显短板，需结合其他方案规避。</p>
<h3 data-id="heading-18">4.1 无法捕获的错误类型</h3>
<ul>
<li>
<p><strong>语法错误与解析错误</strong>：代码存在语法问题（如括号不匹配）或解析阶段错误（如 <code>import</code> 不存在的模块），脚本加载时直接报错，<code>try...catch</code> 无法捕获。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 语法错误：缺少右括号</span>
  <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a; 
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 不执行，脚本解析阶段已报错</span>
}
</code></pre>
</li>
<li>
<p><strong>非 Promise 异步错误</strong>：不基于 <code>Promise</code> 的异步操作（如回调函数），错误无法被 <code>try...catch</code> 捕获。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'定时器错误'</span>); <span class="hljs-comment">// 异步回调错误，无法捕获</span>
  }, <span class="hljs-number">100</span>);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获不到'</span>, error); <span class="hljs-comment">// 不执行</span>
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-19">4.2 功能上的不足</h3>
<ul>
<li>
<p><strong>过度捕获掩盖逻辑错误</strong>：包裹大段代码时，会捕获 “预期外错误”（如变量拼写错误），增加调试难度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 逻辑错误：变量名拼写错误（应为 user.name）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(uesr.<span class="hljs-property">name</span>); 
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'出错了，但无法定位是拼写错还是其他错'</span>); <span class="hljs-comment">// 掩盖真实问题</span>
}
</code></pre>
</li>
<li>
<p><strong>性能损耗</strong>：<code>try...catch</code> 会影响 JavaScript 引擎优化（如 V8 即时编译），高频执行场景（如循环）中过度使用会导致性能下降。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 反例：循环中频繁使用 try...catch，性能损耗明显</span>
for (let i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
  try {
    <span class="hljs-built_in">processData</span>(i); <span class="hljs-comment">// 高频执行，不建议包裹</span>
  } catch (error) {
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
</li>
</ul>
<h2 data-id="heading-20">五、try...catch 与其他机制的生态协作</h2>
<p>现代开发中，<code>try...catch</code> 需与全局错误监听、框架错误边界等配合，形成多层防护体系。</p>
<h3 data-id="heading-21">5.1 与全局错误监听的配合</h3>
<p><code>window.onerror</code> 或 <code>window.addEventListener('error')</code> 可捕获 <code>try...catch</code> 未处理的 “漏网之鱼”（如未被捕获的 Promise 错误、跨域脚本错误），作为最后兜底。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全局错误兜底，捕获未处理错误</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 过滤资源加载错误（如图片加载失败），只处理脚本错误</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">message</span> !== <span class="hljs-string">'Script error.'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'全局未捕获错误：'</span>, event.<span class="hljs-property">error</span>);
    <span class="hljs-comment">// 上报到监控系统，避免错误静默</span>
    <span class="hljs-title function_">logErrorToServer</span>(event.<span class="hljs-property">error</span>);
  }
});

<span class="hljs-comment">// 捕获未处理的 Promise 错误</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'未处理的 Promise 错误：'</span>, event.<span class="hljs-property">reason</span>);
  event.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// 阻止浏览器默认提示</span>
  <span class="hljs-title function_">logErrorToServer</span>(event.<span class="hljs-property">reason</span>);
});
</code></pre>
<h3 data-id="heading-22">5.2 与框架错误边界的协作</h3>
<p>在 React、Vue 等框架中，组件渲染错误需用 “错误边界” 处理，<code>try...catch</code> 负责逻辑错误，错误边界负责渲染错误，分工明确。</p>
<h4 data-id="heading-23">5.2.1 React 错误边界示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  state = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> };

  <span class="hljs-comment">// 捕获子组件渲染错误</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> }; <span class="hljs-comment">// 更新状态，显示降级 UI</span>
  }

  <span class="hljs-comment">// 日志上报</span>
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'组件渲染错误：'</span>, error, errorInfo);
    <span class="hljs-title function_">logErrorToServer</span>({ error, errorInfo });
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>组件加载失败，请刷新重试<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>; <span class="hljs-comment">// 降级 UI</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}

<span class="hljs-comment">// 使用：包裹可能出错的组件</span>
&lt;<span class="hljs-title class_">ErrorBoundary</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{123}</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ErrorBoundary</span>&gt;
</code></pre>
<h2 data-id="heading-24">六、总结</h2>
<h3 data-id="heading-25">6.1 核心定位</h3>
<p><code>try...catch</code> 是 <strong>JavaScript 错误处理的 “基础设施”</strong> ，而非 “最优解”：</p>
<ul>
<li>基础作用：捕获同步错误，配合 <code>async/await</code> 捕获 Promise 异步错误；</li>
<li>生态角色：与 <code>Promise.catch()</code>、全局监听、框架错误边界配合，形成 “多层防护”；</li>
<li>价值核心：保障程序可控性，实现优雅降级与错误上报。</li>
</ul>
<h3 data-id="heading-26">6.2 最佳应用</h3>
<ol>
<li>
<p><strong>精准捕获，避免过度包裹</strong>：只包裹 “预期可能出错的代码段”（如网络请求、JSON 解析），不包裹大段逻辑；</p>
</li>
<li>
<p><strong>保留错误上下文</strong>：捕获错误后需 <code>throw error</code> 重新抛出（需上层处理时），避免丢失错误栈信息；</p>
</li>
<li>
<p><strong>结合场景选择处理方式</strong>：</p>
<ul>
<li>同步代码：直接用 <code>try...catch</code>；</li>
<li>纯 Promise 异步：用 <code>.catch()</code>；</li>
<li><code>async/await</code> 场景：用 <code>try...catch</code> 统一处理；</li>
<li>并行任务：用 <code>Promise.allSettled</code> 配合 <code>try...catch</code> 隔离错误；</li>
</ul>
</li>
<li>
<p><strong>补充错误上下文</strong>：抛出错误时添加业务信息（如用户 ID、订单号），便于排查；</p>
</li>
<li>
<p><strong>兜底机制不可少</strong>：全局错误监听 + 框架错误边界，覆盖 <code>try...catch</code> 未处理的场景。</p>
</li>
</ol>
<h2 data-id="heading-27">七、实际应用场景举例</h2>
<h3 data-id="heading-28">1. 同步代码场景（基础）</h3>
<p><strong>适用</strong>：JSON 解析、变量类型转换、同步函数调用等。<strong>模板</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">function syncOperation(<span class="hljs-keyword">data</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 可能出错的同步操作（如解析、类型转换）</span>
    <span class="hljs-keyword">const</span> parsed = JSON.parse(<span class="hljs-keyword">data</span>); <span class="hljs-comment">// 可能抛错</span>
    <span class="hljs-keyword">const</span> result = parsed.value.toUpperCase(); <span class="hljs-comment">// 可能抛错（若 parsed.value 不存在）</span>
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 1. 补充上下文（必做）</span>
    error.context = { <span class="hljs-keyword">data</span>, operation: <span class="hljs-string">'syncOperation'</span> };
    <span class="hljs-comment">// 2. 可处理则补救，否则抛出</span>
    <span class="hljs-keyword">if</span> (error.name === <span class="hljs-string">'SyntaxError'</span>) {
      console.warn(<span class="hljs-string">'数据格式错误，使用默认值'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-string">'default'</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 传递给上层处理</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-29">2. DOM 操作场景</h3>
<p><strong>适用</strong>：动态创建元素、修改 DOM 属性、事件绑定等（易因元素不存在 / 权限问题出错）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateDOM</span>(<span class="hljs-params">elementId, content</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(elementId);
    <span class="hljs-keyword">if</span> (!el) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`元素 <span class="hljs-subst">${elementId}</span> 不存在`</span>); <span class="hljs-comment">// 主动抛错，明确上下文</span>
    
    <span class="hljs-comment">// 可能出错的 DOM 操作</span>
    el.<span class="hljs-property">textContent</span> = content; 
    el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>); <span class="hljs-comment">// 若 classList 不支持（极旧浏览器）会抛错</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'DOM 更新失败：'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-comment">// 降级处理：显示错误提示，不影响页面其他功能</span>
    <span class="hljs-keyword">const</span> errorEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    errorEl.<span class="hljs-property">className</span> = <span class="hljs-string">'error'</span>;
    errorEl.<span class="hljs-property">textContent</span> = <span class="hljs-string">`加载失败：<span class="hljs-subst">${error.message}</span>`</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(errorEl);
  }
}
</code></pre>
<h3 data-id="heading-30">3. Node.js 同步 API 场景</h3>
<p><strong>适用</strong>：文件读写（<code>fs.readFileSync</code>）、路径处理（<code>path.resolve</code>）等同步操作（出错会导致进程崩溃）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">readLocalFile</span>(<span class="hljs-params">filePath</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> fullPath = path.<span class="hljs-title function_">resolve</span>(filePath); <span class="hljs-comment">// 路径解析可能抛错</span>
    <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(fullPath, <span class="hljs-string">'utf8'</span>); <span class="hljs-comment">// 文件不存在/权限不足会抛错</span>
    <span class="hljs-keyword">return</span> content;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 区分错误类型，针对性处理</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-string">'ENOENT'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`文件不存在：<span class="hljs-subst">${filePath}</span>，返回空内容`</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">code</span> === <span class="hljs-string">'EACCES'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`权限不足，无法读取 <span class="hljs-subst">${filePath}</span>`</span>);
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'文件访问权限不足，请检查配置'</span>); <span class="hljs-comment">// 上层需处理的严重错误</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">throw</span> error;
    }
  }
}
</code></pre>
<h3 data-id="heading-31">4. 异步场景（<code>Promise</code> + <code>async/await</code>）</h3>
<h4 data-id="heading-32">4.1 单异步任务（<code>async/await</code>）</h4>
<p><strong>适用</strong>：单个网络请求、异步 API 调用（如 <code>axios</code> 请求）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchSingleData</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(url);
    <span class="hljs-comment">// 主动校验业务错误（如接口返回 code 非 0）</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`业务错误：<span class="hljs-subst">${response.data.msg}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 区分网络错误和业务错误</span>
    <span class="hljs-keyword">let</span> errorMsg;
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>) {
      <span class="hljs-comment">// HTTP 错误（404/500 等）</span>
      errorMsg = <span class="hljs-string">`请求失败[<span class="hljs-subst">${error.response.status}</span>]：<span class="hljs-subst">${url}</span>`</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">request</span>) {
      <span class="hljs-comment">// 网络错误（无响应）</span>
      errorMsg = <span class="hljs-string">`网络错误，无法连接：<span class="hljs-subst">${url}</span>`</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 业务错误或其他</span>
      errorMsg = error.<span class="hljs-property">message</span>;
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(errorMsg);
    <span class="hljs-comment">// 非致命错误可返回默认值，避免流程中断</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; 
  }
}
</code></pre>
<h4 data-id="heading-33">4.2 多依赖异步任务（串联）</h4>
<p><strong>适用</strong>：任务 A → 任务 B（依赖 A 的结果）→ 任务 C（依赖 B 的结果）。<strong>模板</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">taskA</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> } <span class="hljs-comment">// 返回 Promise</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">taskB</span>(<span class="hljs-params">resultA</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">taskC</span>(<span class="hljs-params">resultB</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runTasks</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> resA = <span class="hljs-keyword">await</span> <span class="hljs-title function_">taskA</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务 A 完成'</span>);
    
    <span class="hljs-keyword">const</span> resB = <span class="hljs-keyword">await</span> <span class="hljs-title function_">taskB</span>(resA);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务 B 完成'</span>);
    
    <span class="hljs-keyword">const</span> resC = <span class="hljs-keyword">await</span> <span class="hljs-title function_">taskC</span>(resB);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有任务完成'</span>);
    <span class="hljs-keyword">return</span> resC;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 任何一步失败都会中断，统一处理</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`任务中断：<span class="hljs-subst">${error.message}</span>`</span>);
    <span class="hljs-comment">// 记录中断位置（通过 error 上下文）</span>
    error.<span class="hljs-property">task</span> = error.<span class="hljs-property">task</span> || <span class="hljs-string">'未知任务'</span>; <span class="hljs-comment">// 可在子任务中添加 task 字段</span>
    <span class="hljs-title function_">logToMonitor</span>(error); <span class="hljs-comment">// 上报监控</span>
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 允许上层重试</span>
  }
}
</code></pre>
<h4 data-id="heading-34">4.3 多独立异步任务（并行）</h4>
<p><strong>适用</strong>：多个无依赖的异步任务（如同时渲染多个组件），需隔离错误。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">componentA</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">componentB</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">componentC</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderAll</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用 Promise.allSettled 确保所有任务执行完毕（无论成功失败）</span>
  <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([
    <span class="hljs-title function_">componentA</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> ({ <span class="hljs-attr">error</span>: err, <span class="hljs-attr">component</span>: <span class="hljs-string">'A'</span> })),
    <span class="hljs-title function_">componentB</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> ({ <span class="hljs-attr">error</span>: err, <span class="hljs-attr">component</span>: <span class="hljs-string">'B'</span> })),
    <span class="hljs-title function_">componentC</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> ({ <span class="hljs-attr">error</span>: err, <span class="hljs-attr">component</span>: <span class="hljs-string">'C'</span> }))
  ]);

  <span class="hljs-comment">// 处理失败结果</span>
  results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">value</span>?.<span class="hljs-property">error</span>) { <span class="hljs-comment">// 捕获到的错误</span>
      <span class="hljs-keyword">const</span> { error, component } = result.<span class="hljs-property">value</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`组件 <span class="hljs-subst">${component}</span> 失败：`</span>, error.<span class="hljs-property">message</span>);
      <span class="hljs-comment">// 单独标记失败组件，不影响其他</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">`comp-<span class="hljs-subst">${component}</span>`</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'failed'</span>);
    }
  });
}
</code></pre>
<h3 data-id="heading-35">5. 第三方库调用场景</h3>
<p><strong>适用</strong>：调用外部库（如 <code>moment</code>、<code>lodash</code>）的同步方法（可能因参数错误抛错）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> moment <span class="hljs-keyword">from</span> <span class="hljs-string">'moment'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatWithLibrary</span>(<span class="hljs-params">dateInput</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 第三方库可能对无效参数抛错（如 moment(null) 格式化）</span>
    <span class="hljs-keyword">const</span> formatted = <span class="hljs-title function_">moment</span>(dateInput).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm'</span>);
    <span class="hljs-comment">// 主动校验库返回的异常结果（如 moment 无效日期返回 'Invalid date'）</span>
    <span class="hljs-keyword">if</span> (formatted === <span class="hljs-string">'Invalid date'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`无效日期：<span class="hljs-subst">${dateInput}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> formatted;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'格式化失败：'</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-comment">// 降级为原生方法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(dateInput).<span class="hljs-title function_">toLocaleString</span>() || <span class="hljs-string">'无法解析的日期'</span>;
  }
}
</code></pre>
<h3 data-id="heading-36">6. 框架场景（以 React 为例）</h3>
<p><strong>适用</strong>：组件逻辑错误（<code>try...catch</code>）与渲染错误（错误边界）分工：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 组件内逻辑错误用 try...catch</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadUser</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/user/<span class="hljs-subst">${userId}</span>`</span>);
        <span class="hljs-title function_">setUser</span>(res.<span class="hljs-property">data</span>);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载用户失败：'</span>, error);
        <span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'用户信息加载失败'</span> }); <span class="hljs-comment">// 状态降级</span>
      }
    }
    <span class="hljs-title function_">loadUser</span>();
  }, [userId]);

  <span class="hljs-comment">// 2. 渲染错误交给错误边界处理（不直接用 try...catch 包裹 JSX）</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {user?.error ? <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{user.error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 错误边界组件（处理渲染错误）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// 使用：错误边界包裹可能渲染失败的组件</span>
&lt;<span class="hljs-title class_">ErrorBoundary</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{123}</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ErrorBoundary</span>&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Perfetto 系列 9 - CPU 信息解读]]></title>    <link>https://juejin.cn/post/7572480736362397702</link>    <guid>https://juejin.cn/post/7572480736362397702</guid>    <pubDate>2025-11-16T13:35:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736362397702" data-draft-id="7572481101711540278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Perfetto 系列 9 - CPU 信息解读"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-16T13:35:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gracker"/> <meta itemprop="url" content="https://juejin.cn/user/1816846860560749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Perfetto 系列 9 - CPU 信息解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1816846860560749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gracker
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:35:18.000Z" title="Sun Nov 16 2025 13:35:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文是 Perfetto 系列的第九篇文章，主题是 Perfetto 中的 CPU 信息分析。Perfetto 提供了远超 Systrace 的数据可视化与分析能力，理解 CPU 相关信息是定位性能瓶颈、分析功耗问题的基础。</p>
<p>本系列的目标，就是通过 Perfetto 这个工具，从一个全新的图形化视角，来审视 Android 系统的整体运行，同时也提供一个学习 Framework 的新途径。或许你已经读过很多源码分析的文章，但总是对繁杂的调用链感到困惑，或者记不住具体的执行流程。那么通过 Perfetto，将这些流程可视化，你可能会对系统有更深入、更直观的理解。</p>

<h3 data-id="heading-0">本文目录</h3>
<ul>
<li><a href="#series" title="#series">Perfetto 系列文章</a></li>
<li><a href="#overview" title="#overview">Perfetto 中的 CPU 信息概览</a></li>
<li><a href="#traceconfig" title="#traceconfig">抓取 CPU 信息所需要的 Trace Config</a></li>
<li><a href="#biglittle" title="#biglittle">CPU 核心架构：big.LITTLE</a></li>
<li><a href="#scheduling" title="#scheduling">CPU 调度</a></li>
<li><a href="#frequency" title="#frequency">CPU Frequency (CPU 频率) 深度解析</a></li>
<li><a href="#eas" title="#eas">Linux 内核调度策略：选核与迁移</a></li>
<li><a href="#practices-sql" title="#practices-sql">实战与 SQL</a></li>
<li><a href="#summary" title="#summary">总结</a></li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-series" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-1">Perfetto 系列文章</h3>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F03%2F27%2FAndroid-Perfetto-101%2F%23%2FPerfetto-%25E7%25B3%25BB%25E5%2588%2597%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2024/03/27/Android-Perfetto-101/#/Perfetto-%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Android Perfetto 系列目录</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-01-What-is-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-01-What-is-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 1：Perfetto 工具简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-02-how-to-get-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-02-how-to-get-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 2：Perfetto Trace 抓取</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-03-how-to-analysis-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-03-how-to-analysis-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 3：熟悉 Perfetto View</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F02%2F08%2FAndroid-Perfetto-04-Open-Big-Trace-With-Command-Line%2F" target="_blank" title="https://www.androidperformance.com/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/" ref="nofollow noopener noreferrer">Android Perfetto 系列 4：使用命令行在本地打开超大 Trace</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F03%2F26%2FAndroid-Perfetto-05-Chorergrapher%2F" target="_blank" title="https://www.androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" ref="nofollow noopener noreferrer">Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F04%2F26%2FAndroid-Perfetto-06-Why-120Hz%2F" target="_blank" title="https://www.androidperformance.com/2025/04/26/Android-Perfetto-06-Why-120Hz/" ref="nofollow noopener noreferrer">Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F02%2FAndroid-Perfetto-07-MainThread-And-RenderThread%2F" target="_blank" title="https://androidperformance.com/2025/08/02/Android-Perfetto-07-MainThread-And-RenderThread/" ref="nofollow noopener noreferrer">Android Perfetto 系列 7 - MainThread 和 RenderThread 解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F05%2FAndroid-Perfetto-08-Vsync%2F" target="_blank" title="https://androidperformance.com/2025/08/05/Android-Perfetto-08-Vsync/" ref="nofollow noopener noreferrer">Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F11%2F12%2FAndroid-Perfetto-09-CPU%2F" target="_blank" title="https://www.androidperformance.com/2025/11/12/Android-Perfetto-09-CPU/" ref="nofollow noopener noreferrer">Android Perfetto 系列 9 - CPU 信息解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1oi82efE4D%2F%3Fvd_source%3D0c6d2191e785de0a36dc21a9da7e664e" target="_blank" title="https://www.bilibili.com/video/BV1oi82efE4D/?vd_source=0c6d2191e785de0a36dc21a9da7e664e" ref="nofollow noopener noreferrer">视频(B站) - Android Perfetto 基础和案例分享</a></li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-overview" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-2">Perfetto 中的 CPU 信息概览</h3>
<p>在 Perfetto UI 中，CPU 相关的信息通常分组置于顶部，是性能分析的起点。主要包含以下三个核心轨道：</p>
<ul>
<li><strong>CPU Scheduling (CPU 调度)</strong> : 显示在每个时间点，各个 CPU 核心上正在执行的线程。</li>
<li><strong>CPU Frequency (CPU 频率)</strong> : 显示每个 CPU 核心或核心簇的频率变化情况。</li>
<li><strong>CPU Idle (CPU 空闲状态)</strong> : 显示每个 CPU 核心进入的低功耗状态 (C-States)。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6163c941d386468d98b0cd451b5fb4d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=VEkmaxDJy1gP1H2fuCdZiEovHO8%3D" alt="image.png" loading="lazy"/></p>
<p>通过分析 CPU 相关的信息，可以解答以下关键性能问题， 或者进行竞品分析：</p>
<ul>
<li>应用主线程为何没有执行？是否被其他线程抢占？</li>
<li>某个任务执行缓慢的原因是什么？是否被调度到了低性能核心？</li>
<li>在特定场景下，CPU 频率是否受限？</li>
<li>应用在后台时，CPU 是否有效进入了深度睡眠状态？</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-traceconfig" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-3">抓取 CPU 信息所需要的 Trace Config</h3>
<p>为了采集到本文分析所需的所有 CPU 数据，你需要一个正确的 <code>TraceConfig</code>。不正确的配置会导致某些轨道（如 CPU 频率）或某些内核事件（如唤醒事件）丢失。以下是 Perfetto 官方文档推荐的、用于通用 CPU 分析的配置。你可以将其添加到你的 Perfetto 的 Config 中，抓 Trace 的时候使用。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">data_sources</span> {
  <span class="hljs-string">config</span> {
    <span class="hljs-attr">name:</span> <span class="hljs-string">"linux.ftrace"</span>
    <span class="hljs-string">ftrace_config</span> {
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_process_exit"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_process_free"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"task/task_newtask"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"task/task_rename"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_switch"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"power/suspend_resume"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_blocked_reason"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_wakeup"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_wakeup_new"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_waking"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_process_exit"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"sched/sched_process_free"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"task/task_newtask"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"task/task_rename"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"power/cpu_frequency"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"power/cpu_idle"</span>
      <span class="hljs-attr">ftrace_events:</span> <span class="hljs-string">"power/suspend_resume"</span>
      <span class="hljs-attr">symbolize_ksyms:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">disable_generic_events:</span> <span class="hljs-literal">true</span>
    }
  }
}
<span class="hljs-string">data_sources</span> {
  <span class="hljs-string">config</span> {
    <span class="hljs-attr">name:</span> <span class="hljs-string">"linux.process_stats"</span>
    <span class="hljs-string">process_stats_config</span> {
      <span class="hljs-attr">scan_all_processes_on_start:</span> <span class="hljs-literal">true</span>
    }
  }
}
<span class="hljs-string">data_sources</span> {
  <span class="hljs-string">config</span> {
    <span class="hljs-attr">name:</span> <span class="hljs-string">"linux.sys_stats"</span>
    <span class="hljs-string">sys_stats_config</span> {
      <span class="hljs-attr">cpufreq_period_ms:</span> <span class="hljs-number">250</span>
    }
  }
}
</code></pre>
<p>这个配置启用了包括 <code>sched</code>（调度）、<code>power</code>（频率和空闲）、<code>task</code>（任务生命周期）在内的关键 ftrace 事件，是进行深度 CPU 分析的基础。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-biglittle" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-4">CPU 核心架构：big.LITTLE</h3>
<p>在深入分析前，必须了解现代手机 SoC 的 CPU 核心架构。目前主流的移动处理器普遍采用 <code>big.LITTLE</code> 异构多核架构，或其变种，如 <code>big.Medium.LITTLE</code>（大中小核）。</p>
<ul>
<li><strong>小核 (LITTLE cores)</strong> : 针对低功耗设计，频率较低，用于处理后台任务、轻量级计算，以保证续航。</li>
<li><strong>大核 (big cores)</strong> : 针对高性能设计，频率更高，功耗也更大，用于处理用户交互、游戏、应用启动等重负载场景。</li>
<li><strong>超大核 (Prime Core)</strong> : 部分旗舰芯片会有一个频率极高的超大核，用于应对最严苛的单核性能挑战。</li>
</ul>
<p>在 Perfetto 的 CPU 轨道中，核心通常从 0 开始编号。例如，在一个典型的八核处理器中，<code>CPU 0-3</code> 可能为小核，<code>CPU 4-6</code> 为大核，<code>CPU 7</code> 为超大核。<strong>识别核心类型对于性能分析至关重要</strong>：一个计算密集型任务如果长时间运行在小核上，其耗时必然远超预期。分析时，需要将线程的运行核心与其任务属性进行匹配，以判断调度器（Scheduler）的行为是否符合预期。</p>
<p>下面是一个典型的 4+4 的 CPU ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a53fa715e1f34759808770552a520257~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=juThztbt%2BYpyMnpUdyANBsIUzrs%3D" alt="image.png" loading="lazy"/></p>
<p>下面是一个典型的 4+3+1 的 CPU （ MTK 的天玑 9500、9400 ，以及高通骁龙高端系列）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d32564cf94f94f8882d847837d2c8e81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=wr1DXwqHNKU1NZ8gIuJKLJMboTs%3D" alt="image.png" loading="lazy"/></p>
<p>下面是一个 5+2 的 CPU （高通 8Elite 1 阉割版，8Elite 1 的标准版 0-5 是小核，6-7 是大核，这里就不放图了）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83787e623afe4b06863b7a3f60bd3122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=dP6%2Fu5np5ge761JWh4edoNyHdVQ%3D" alt="image.png" loading="lazy"/></p>
<p>一般通过查阅 CPU 的 spec 就可以知道他的大中小核心的架构，或者 cat 对应的 CPU 节点也可以，这里就不再赘述了。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-scheduling" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-5">CPU 调度</h3>
<p><code>CPU Scheduling</code> 轨道是最常用且最重要的部分，它可视化了 Linux 内核调度器的决策过程。其数据来源于内核 ftrace 中的 <code>sched/sched_switch</code> 事件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17f8f233b822471086b0330fd44c1afe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=sDEeUnfinGJ1PlC4IQ0jAFEx5Jk%3D" alt="image.png" loading="lazy"/></p>
<p>每个 CPU 核心对应一行独立的轨迹。轨道上的不同色块，代表了在该时间片上，特定线程正在该 CPU 核心上运行。</p>
<ul>
<li>UI 细节：点击 CPU 切片，详情面板会显示该次调度的 <code>cpu</code>、<code>end_state</code>、<code>priority</code>、所属 <code>process/thread</code> 等；向下展开进程还能看到每个线程的独立轨道，便于跟踪单个线程的状态演化（参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fcpu-scheduling" target="_blank" title="https://perfetto.dev/docs/data-sources/cpu-scheduling" ref="nofollow noopener noreferrer">官方文档</a>）。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afe1e1f6bd844fe0bed1ec615913b198~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=FBchTzBmrlTzAf7vxC0YGNJhebY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">线程状态深度解析</h4>
<p>理解 Linux 的线程状态是进行性能优化的前提。在 Perfetto 中，选中一个线程，下方的 <code>Current State</code> 面板会显示其当前状态。这些状态信息来源于 Perfetto 解析得到的 <code>thread_state</code>/<code>thread_state_slice</code> 表。</p>
<h5 data-id="heading-7">Running (绿色)</h5>
<p><strong>状态定义</strong>：绿色代表线程正在 CPU 上执行代码。这是唯一真正在消耗 CPU 资源进行计算的状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/661455e18ae74e94a03101b100089fff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=4wejoE%2BthfHYvtO2hScBE1LNlJk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析要点</strong>：</p>
<ul>
<li><strong>执行时长</strong>：过长的 <code>Running</code> 状态，尤其是在关键线程上，通常意味着密集的计算任务，例如复杂的算法或循环。这会增加任务耗时，并可能阻塞其他线程的执行。</li>
<li><strong>运行核心</strong>：结合 CPU 的核心架构（例如 big.LITTLE）进行分析。一个计算密集型任务是否被调度到了预期的性能核心（大核）上，是评估调度策略是否合理的重要依据。</li>
<li><strong>运行频率</strong>：线程的实际执行速度也受 CPU 频率影响。即使线程运行在大核上，如果因为温控等原因导致降频，其性能表现也会下降。因此需要结合 <code>CPU Frequency</code> 轨道进行综合分析。</li>
</ul>
<h5 data-id="heading-8">R (Runnable / 可运行)</h5>
<p><strong>状态定义</strong>：线程已具备所有运行条件，正在等待调度器分配 CPU 核心。在 Perfetto 的线程私有轨道中，<code>Runnable</code> 状态通常以浅绿色或白色条显示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf806951fc4c442f89a838f7e27c6d67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=A7Cwn6SdCInbL5TGAUBZlIJYCh0%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析要点</strong>：</p>
<ul>
<li><strong><code>Runnable</code> 与卡顿</strong>：对于 UI 线程这类对响应时间敏感的线程，长时间处于 <code>Runnable</code> 状态是造成卡顿的直接原因。它意味着线程无法及时获得 CPU 时间来处理任务（如 UI 绘制），从而导致掉帧。</li>
</ul>
<p><strong><code>Runnable</code> 的三种类型</strong>: 仔细观察会发现，线程进入 <code>Runnable</code> 状态的“前身”各不相同。根据内核的调度时机，我们可以将其分为三种情况：</p>
<ol start="0">
<li><strong>从睡眠中唤醒 (Wake-up)</strong> ：这是最常见的一种。线程因等待的资源（如锁、I/O、Binder 回复）已经就绪，从 <code>S</code> 或 <code>D</code> 状态被唤醒，进入 <code>Runnable</code> 状态，等待被调度器选中执行。</li>
<li><strong>用户抢占 (User Preemption)</strong> ：指线程的运行时间片用完，或出现更高优先级的任务，导致调度器在<strong>从内核态返回用户态时</strong>（如系统调用、中断返回后）决定换下当前线程。此时，被换下的线程从 <code>Running</code> 变为 <code>Runnable</code>。在底层的 <code>sched_switch</code> trace 中，它的 <code>prev_state</code> 标记为 <code>R</code>。</li>
<li><strong>内核抢占 (Kernel Preemption)</strong> ：指一个更高优先级的任务或中断，在当前线程<strong>正在执行内核态代码期间</strong>，就“强行”将其打断，使其让出 CPU。这种情况通常意味着一次更紧急的调度。此时，被换下的线程从 <code>Running</code> 变为 <code>Runnable (Preempted)</code>。在底层 trace 中，它的 <code>prev_state</code> 标记为 <code>R+</code>，Perfetto 据此进行了解析和展示。</li>
</ol>
<p>理解这三种类型的区别，有助于更精细地判断调度延迟的原因。例如，大量的 <code>Runnable (Preempted)</code> 可能暗示着系统中存在频繁的、高优先级的唤醒源，导致关键线程在内核态中被频繁打断，或者当时的 CPU 已经满载了（比较常见的情况），这时候优先级比较低的 Task 就很容易被其他优先级高的 Task 抢占，被迫让出 CPU 。如果你的关键 Task 总是被抢占，那就需要调整优先级。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28e4407349c14ed5a227adac01c097ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=anpMNoSSOk453qsud1d6qCt%2Fjbw%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-9">S (Sleep / 可中断睡眠)</h5>
<p><strong>状态定义</strong>：线程因等待某个事件而进入睡眠，可以被信号中断。这是最常见的睡眠状态，通常情况下是良性的，因为它在等待期间不消耗 CPU 资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee16cf40be114558bd67f6c16c329f71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=ueIID2NzdWteCLXgR025N3acn5U%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析要点</strong>：</p>
<ul>
<li>
<p><strong>等待的资源</strong>：如果关键线程（如 UI 线程）睡眠时间过长，同样会引发性能问题。常见的等待原因包括：</p>
<ul>
<li><strong>锁竞争</strong>：等待获取一个 <code>mutex</code> (Java 锁或 native futex)。</li>
<li><strong>Binder 通信</strong>：等待另一个进程通过 Binder 调用返回结果。</li>
<li><strong>I/O 操作</strong>：等待网络 socket 数据 (<code>epoll_wait</code>)。</li>
<li><strong>显式休眠</strong>：代码中调用了 <code>Thread.sleep()</code> 或 <code>Object.wait()</code>。</li>
</ul>
</li>
<li>
<p><strong>依赖分析</strong>：在 Perfetto 中，选中 CPU 区域被唤醒正在 Running 的 Task，就会有 UI 标识他是被哪个 CPU 上的哪个 Task 唤醒的，这有助于快速定位线程间的依赖关系。结合函数调用栈，可以进一步定位导致睡眠的具体代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ae353986783463596e05b32ad28ad1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=QuHOJgEOvP34unuMlsB8MZKT9%2Fo%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul>
<h5 data-id="heading-10">D (Uninterruptible Sleep / 不可中断睡眠)</h5>
<p><strong>状态定义</strong>：线程在等待硬件 I/O 操作完成，期间不能被任何信号中断。此状态旨在保护进程与设备交互过程中的数据一致性。在 Perfetto 中，该状态通常显示为橙色或红色，是需要重点关注的信号。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1be1a90f6e648bf98d65754b54d343b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=IHtJ%2BPWxmxHglgQhwxO8DaCw8eg%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析要点</strong>：</p>
<ul>
<li>
<p><strong>严重的性能瓶颈</strong>：长时间的 <code>D</code> 状态意味着线程被完全阻塞，无法响应任何事件。如果发生在 UI 线程，极易导致 ANR。</p>
</li>
<li>
<p><strong>常见原因</strong>：</p>
<ol start="0">
<li><strong>磁盘 I/O</strong>：频繁或单次大量的文件读写操作。</li>
<li><strong>内存压力</strong>：系统物理内存不足，导致频繁的页面换入/换出 (swap)，其本质是高频的磁盘 I/O。</li>
<li><strong>内核驱动问题</strong>：部分内核驱动的实现缺陷也可能导致线程陷入 <code>D</code> 状态。</li>
</ol>
</li>
<li>
<p><strong>排查方向</strong>：在 <code>Current State</code> 面板中，如果 <code>D</code> 状态伴有 <code>(iowait)</code> 标记，则明确表示在等待 I/O。需要检查应用的 I/O 模式，评估其合理性，例如是否将耗时 I/O 操作置于主线程，或是否存在可优化的空间（如减少 I/O 次数和数据量）。</p>
</li>
</ul>
<h4 data-id="heading-11">唤醒关系分析</h4>
<p>线程间的依赖关系是性能分析中的一个难点。一个线程长时间 <code>Sleep</code>，关键在于找出它在“等谁”。Perfetto 提供了强大的唤醒关系可视化功能。</p>
<ul>
<li><strong>UI 操作</strong>：在 Perfetto 的 CPU 区域中，用鼠标左键单击选中一个处于 <code>Running</code> 状态的线程 Task 。Perfetto 会自动绘制一条从“唤醒者”到“被唤醒者”的依赖箭头，并高亮显示唤醒源所在的线程切片。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e3675c063e14c699a1ffdf2005fbd5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=GnY%2BvZvZEwhKuk7%2BWWUkq5uQFnQ%3D" alt="image.png" loading="lazy"/></li>
<li><strong>底层原理</strong>：该功能依赖于内核的 <code>sched_wakeup</code> ftrace 事件。当线程 T1 释放了某个资源（如解锁、完成 Binder 调用），而线程 T2 正在等待该资源时，内核会将 T2 标记为 <code>Runnable</code> 状态，并记录下 T1 -&gt; T2 的这次唤醒事件。Perfetto 解析这些事件，从而构建出线程间的依赖链。</li>
</ul>
<p>通过唤醒分析，可以清晰地追踪复杂的调用链，例如：UI 线程等待一个 Binder 调用 -&gt; Binder 线程执行任务 -&gt; Binder 线程等待另一个锁 -&gt; 持锁线程释放锁并唤醒 Binder 线程 -&gt; Binder 线程完成任务并唤醒 UI 线程。整个过程中的瓶颈点将一目了然。</p>
<h5 data-id="heading-12">调度唤醒与延迟分析</h5>
<p>当线程 A 在 <code>wait()</code> 上挂起时，它进入 <code>S</code>（Sleeping）并从 CPU 运行队列移除。线程 B 调用 <code>notify()</code> 后，内核会把线程 A 转换为 <code>R</code>（Runnable）。此时线程 A“有资格”被放回某个 CPU 的运行队列，但这并不意味着“立刻”运行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/facd7219ea044066866f81cd2ea53547~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=YyGRWllfN0R6XiIEyH7WFFb9sQw%3D" alt="image.png" loading="lazy"/></p>
<p>常见等待原因包括：</p>
<ul>
<li>所有 CPU 都在忙：线程 A 需要等待空出队列槽位（或当前运行的线程优先级更高）。</li>
<li>存在空闲 CPU，但迁移需时：负载均衡器将线程迁移到其他 CPU 需要一定时间窗口。</li>
</ul>
<p>除非使用实时优先级，大多数 Linux 调度器配置并非严格的“work‑conserving”。调度器有时会“等待”当前 CPU 线程自然空闲，以避免跨 CPU 迁移带来的额外开销与功耗。这会在 <code>R</code> 状态下形成可观测的“排队延迟”。结合 <code>sched_waking</code>/<code>sched_wakeup_new</code> 可更精确地刻画“被唤醒”到“真正入队/运行”之间的时间段（参考官方文档：<code>sched_waking / sched_wakeup</code> 的差异与适用场景）。</p>
<ul>
<li>在目标线程的 <code>thread_state</code> 轨道中筛选 <code>state=R</code> 的切片，用作“调度延迟”的直接证据。</li>
<li>同步对照同一 CPU 的其它重负载线程与 IRQ/SoftIRQ 轨迹，验证是否存在时间重叠的抢占或高优先级压制。</li>
<li>若频繁在 <code>R</code> 状态排队并以 <code>end_state=R+</code> 收尾，视为非自愿抢占严重，需评估优先级、放置与负载均衡策略。</li>
</ul>
<h5 data-id="heading-13">sched_waking 与 sched_wakeup 的差异与非严格 work-conserving</h5>
<ul>
<li><code>sched_waking</code> 在线程被标记为可运行（R）时就会发出，<code>sched_wakeup</code> 与跨 CPU 唤醒有关，可能记录在源或目的 CPU 上；对大多数延迟分析而言，仅 <code>sched_waking</code> 已足够（参见官方说明）。</li>
<li>多数 Linux 调度配置在通用优先级下并非严格“work-conserving”。调度器有时会“等待当前 CPU 空闲”以避免跨核迁移带来的额外开销与功耗，这会造成 R 状态下的等待时间（排队延迟）并非异常，而是权衡后的结果（参见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fcpu-scheduling" target="_blank" title="https://perfetto.dev/docs/data-sources/cpu-scheduling" ref="nofollow noopener noreferrer">Perfetto CPU Scheduling</a>）。</li>
</ul>
<h4 data-id="heading-14">用户态与内核态：sys_* 切片定位空火焰图</h4>
<ul>
<li>
<p><code>Running</code> 的绿色切片未必都是应用代码在忙。若线程陷入单个长系统调用如 <code>sys_read</code>、<code>sys_futex</code>，用户态采样火焰图可能几乎为空。</p>
</li>
<li>
<p>若 UI 线程某段 <code>sched_slice</code> 很长，而 CPU 火焰图热点很少或几乎没有：</p>
<ol start="0">
<li>打开该线程的 <code>slice</code> 视图，查找是否存在长时间 <code>sys_*</code> 切片；</li>
<li>若存在：瓶颈多在 I/O 或同步原语，优先检查 I/O 路径、锁粒度与访问模式；</li>
<li>若不存在：回到火焰图，继续剖析用户态热点函数。</li>
</ol>
</li>
<li>
<p>建议：合并 I/O、切换异步、优化锁竞争、降低系统调用频率与单次数据量。</p>
</li>
</ul>
<h4 data-id="heading-15">CPU 时间与墙上时间</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22028be248ee4dd0ba48826b3eb22d8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=mZxJJ8EqKytC1T3APjUh8LubJv8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><code>Wall</code> 是切片从开始到结束的真实世界时间，<code>CPU</code> 是真正在 CPU 上运行的时间。</p>
</li>
<li>
<p>二者关系：<code>Wall = CPU + Runnable + Sleep</code>。</p>
<ol start="0">
<li>选中目标切片（如 <code>Choreographer#doFrame</code>），比较 <code>Wall</code> 与 <code>CPU</code>；</li>
<li>若 <code>Wall ≈ CPU</code>，则为计算过重，使用火焰图定位热点；\n 3) 若 <code>Wall &gt;&gt; CPU</code>，则为调度或依赖等待，查看 <code>thread_state</code> 的 <code>R/S/D</code> 分布与唤醒链。</li>
</ol>
</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-frequency" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-16">CPU Frequency (CPU 频率) 深度解析</h3>
<p>CPU 频率直接影响代码执行速度，同时也与功耗正相关。<code>CPU Frequency</code> 轨道显示了每个核心在特定时间的运行频率（<code>scaling_cur_freq</code>）。但更重要的是理解其背后的限制因素：</p>
<h4 data-id="heading-17">影响 CPU 频率的核心因素</h4>
<ol start="0">
<li><strong>任务负载 (Task Utilization)</strong> : 这是最主要的驱动因素。现代 Android 系统多采用 <code>schedutil</code> 作为 <code>cpufreq</code> 调频策略。它直接关联调度器（Scheduler），根据线程的“繁忙”程度（<code>utilization</code>）来决定频率。一个高负载的线程（<code>util</code> 很高）会促使 <code>schedutil</code> 请求更高的频率，反之亦然。</li>
<li><strong>场景策略 (Power HAL)</strong> : Android Framework 通过 Power HAL 向底层传递当前的系统状态，即“场景”。例如，在应用启动、游戏、或触摸屏幕时，Power HAL 会向内核请求更高的性能，这通常通过抬高 CPU 的<strong>地板频 (Floor / <code>scaling_min_freq</code>)</strong> 和/或 <strong>天花板频 (Ceiling / <code>scaling_max_freq</code>)</strong> 来实现，确保 CPU 能快速响应。</li>
<li><strong>温度控制 (Thermal Throttling)</strong> : 这是拥有最高优先级的限制。当设备温度（来自电池、CPU、NPU 等传感器）超过预设阈值时，温控系统会强制降低 CPU 的<strong>天花板频</strong>，以减少发热，保护硬件。此时，即使有高负载任务，CPU 频率也无法提升，是导致游戏掉帧、应用卡顿的常见外部原因。</li>
<li><strong>功耗限制与省电模式</strong>: 在低电量或开启省电模式时，系统同样会通过降低天花板频、限制最高性能输出来延长续航。</li>
</ol>
<p>因此，当发现一个重任务在运行时 CPU 频率上不去，不仅要看当前频率，更要关注 <code>scaling_max_freq</code> 是否被限制了。这通常意味着性能瓶颈的根源不在于应用代码本身，而在于系统的温控或功耗策略。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/970848fa0d9f43d9bc9b551bd6a2c1b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904918&amp;x-signature=KR%2BHSurX1N4azJJMEoHpU41H4IM%3D" alt="image.png" loading="lazy"/>
上图是 CPU 频率区域的标识图，鼠标放上去就可以看到当前的频率，CPU 频率变化很快。图中 CPU 有带颜色和不带颜色的部分，带颜色标识当前 CPU 有 Task 在跑，不带颜色说明当前 CPU 是空的，无 Task。</p>
<h4 data-id="heading-18">频率数据采集与平台差异</h4>
<ul>
<li>
<p>两种获取方式：</p>
<ul>
<li>事件驱动：启用 <code>power/cpu_frequency</code>，在内核 cpufreq 驱动变更频率时记录事件。并非所有平台支持，在多数 ARM SoC 上可靠，在大量现代 Intel 平台上常无数据。</li>
<li>轮询采样：启用 <code>linux.sys_stats</code> 并设置 <code>cpufreq_period_ms &gt; 0</code>，定期读取 <code>/sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</code>，ARM/Intel 均可用。建议与事件驱动组合使用以补齐“初始频率快照”。</li>
</ul>
</li>
<li>
<p>Android 设备常以“簇”为单位调频，常见现象是同簇内多个 CPU 同步变频。</p>
</li>
<li>
<p>已知问题：</p>
<ul>
<li>事件仅在频率变化时产生，短 Trace 或稳定场景可能出现左侧“空白”。此时需依赖轮询补足。</li>
<li>某些 UI 版本在未捕获 Idle 状态时不渲染 cpufreq 轨道，但数据仍可通过查询得到。</li>
<li>参考：<code>CPU frequency and idle states</code> 官方说明。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-19">big.LITTLE：相同频率不等于相同性能或能耗</h4>
<ul>
<li>在异构 CPU 上，同为 2.0GHz，小核与大核的实际算力和能耗并不等价。频率必须结合核心类型理解。</li>
<li>核心容量（capacity）与 IPC：大核通常具备更宽的乱序执行、更多执行端口、更大的缓存与更激进的预取/分支预测，单位周期完成的指令数（IPC）更高；同频下，大核完成同样工作所需时间更短、能量更少。</li>
<li>簇级 DVFS（cluster-level DVFS）：移动 SoC 多以“簇”为单位调频。小核簇的高频并不等同于大核簇的中频性能输出；不同簇的电压-频率-能量曲线不同，同一频点无法横向类比“每瓦性能”。</li>
<li>内存/缓存/互联瓶颈：热点若受制于内存带宽、LLC 命中率或系统互联（NoC），单纯提升小核频率收益有限；大核更大的缓存/更强预取可显著降低同任务的访存等待，体现“同频不同效”。</li>
<li>能效曲线非线性：小核在接近最高频时常进入能效陡降区（电压抬升使边际能耗激增），而大核在中等频点可能达到“更高单位能效”。同频比较忽略了“电压-频率-能量”的三维权衡。</li>
</ul>
<h5 data-id="heading-20">P-States 与 governor</h5>
<ul>
<li>
<p>CPU 频率并非连续值，而是离散的性能状态 P-States。常用 governor 为 <code>schedutil</code>，依据任务利用率等信号选择合适 P-State，并联动电压调节。</p>
</li>
<li>
<p>UI 上的频率变化，实质是 governor 在不同 P-State 之间切换。高频不必然更快或更省电，需要结合核簇类型与当时的上限/下限约束理解。</p>
</li>
<li>
<p>核验步骤：</p>
<ol start="0">
<li>在 <code>CPU Frequency</code> 观察频率的上下限是否被拉高/压低（如场景策略/温控限制 <code>scaling_max_freq</code>）。</li>
<li>在 <code>CPU Scheduling</code> 查看关键线程运行在哪类核心（结合设备的核编号划分）。</li>
<li>若“高频 + 小核 + 仍慢”，优先考虑选核/访存瓶颈，而非简单“频率不够”。</li>
</ol>
</li>
<li>
<p>建议结合 Power HAL 场景、热管理与任务画像（CPU 密集或访存密集）综合优化，避免单纯以频率作为调参目标。参考官方文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fdata-sources%2Fcpu-scheduling" target="_blank" title="https://perfetto.dev/docs/data-sources/cpu-scheduling" ref="nofollow noopener noreferrer">Perfetto CPU Scheduling</a>。</p>
</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-eas" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-21">Linux 内核调度策略：选核与迁移</h3>
<p>理解了线程状态和频率后，我们还需要深入了解 Linux 内核调度器（在 Android 中主要是 EAS - Energy Aware Scheduling）的两个核心行为：如何为任务挑选一个 CPU 核心，以及为何要将任务从一个核心迁移到另一个。</p>
<h4 data-id="heading-22">选核逻辑 (Task Placement)</h4>
<p>当一个线程从 <code>Sleep</code> 状态被唤醒，或一个新线程被创建时，EAS 调度器需要为它选择一个最合适的 CPU 核心。其核心目标是在满足任务性能需求的前提下，尽可能地降低系统功耗。决策流程大致如下：</p>
<ol start="0">
<li><strong>评估任务负载 (Task Utilization)</strong> : 调度器会评估该线程的 <code>util</code>，即它需要多少计算资源。这是一个动态调整的值，反映了线程历史上的繁忙程度。</li>
<li><strong>寻找“足够”的核心</strong>: 调度器会遍历所有可用的 CPU 核心，比较任务的 <code>util</code> 和每个核心的 <code>capacity</code>（容量/最大计算能力）。大核的 <code>capacity</code> 远高于小核。调度器会寻找 <code>capacity</code> &gt; <code>util</code> 的核心，即能“装下”这个任务的核心。</li>
<li><strong>寻找“最节能”的核心</strong>: 在所有满足 <code>capacity</code> 要求的核心中，调度器会利用预置在内核中的“能量模型”（Energy Model）进行计算。这个模型知道每个核心在每个频率下运行的功耗。调度器会选择一个能让整个系统（包括任务本身和其他正在运行的任务）总功耗最低的 CPU 核心作为最终选择。</li>
</ol>
<p><strong>简而言之</strong>：EAS 的目标不是为任务找一个最快的核，而是找一个“刚刚好够用”且“最省电”的核。</p>
<h4 data-id="heading-23">核心迁移逻辑 (Task Migration)</h4>
<p>将任务从一个 CPU 核心移动到另一个，是调度器进行动态调优的关键手段。主要发生在以下情况：</p>
<ol start="0">
<li><strong>负载均衡 (Load Balancing)</strong> : 这是最常见的迁移原因。调度器会周期性地检查系统是否处于“负载不均衡”状态。例如，<code>CPU-1</code>（小核）上挤满了高负载任务导致其利用率饱和，而 <code>CPU-7</code>（大核）却很空闲。此时，调度器会判定系统失衡，并将 <code>CPU-1</code> 上的某个高负载任务“拉到”（pull）<code>CPU-7</code> 上运行，以恢复平衡，提升性能。</li>
<li><strong>唤醒时迁移 (Wake-up Migration)</strong> : 当一个线程睡醒时，调度器会重新评估它的最佳核心。如果这个线程在睡眠期间 <code>util</code> 发生了变化（例如，一个后台下载线程突然收到了一个大文件下载任务，<code>util</code> 飙升），或者原先运行的核心现在非常繁忙，调度器就可能在唤醒时直接为它选择一个更合适的新核心，而不是让它在原来的地方排队。</li>
</ol>
<p>理解选核与迁移逻辑，有助于我们判断调度器的行为是否“异常”。例如，一个明显的前台 UI 线程被不合理地长时间限制在小核上，或者在大小核之间过于频繁地“反复横跳”，都可能暗示着系统调度策略或任务优先级设置存在问题。</p>
<p>当然目前 Android 厂商针对调度器有做非常多的客制化，关键 Task（Critical Task）通常会占用更多的 CPU ，甚至更容易上大核。另外还有很多绑核策略、签核策略，导致大家看到的每个厂商的现象都不一样。这也是各个厂商的核心竞争力（比如 Oppo 的蜂鸟引擎）。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-practices-sql" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-24">实战与 SQL</h3>
<h4 data-id="heading-25">使用 SQL 进行量化分析</h4>
<p>Perfetto 内置的 SQL 查询引擎是其强大功能之一，允许开发者对 Trace 数据进行精确的聚合、筛选和分析。以下是一些常用的 CPU 分析查询。</p>
<h4 data-id="heading-26">1. 计算各进程的 CPU 总时长</h4>
<p>此查询统计每个进程在所有 CPU 上运行的总时长，按降序排列，用于快速定位消耗 CPU 资源最多的进程。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span>
  process.name,
  sum(dur) / <span class="hljs-number">1e9</span> <span class="hljs-keyword">AS</span> total_cpu_time_s
<span class="hljs-keyword">FROM</span> sched
<span class="hljs-keyword">JOIN</span> thread <span class="hljs-keyword">ON</span> sched.utid = thread.utid
<span class="hljs-keyword">JOIN</span> process <span class="hljs-keyword">ON</span> thread.upid = process.upid
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> process.name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_cpu_time_s DESC;
</code></pre>
<h4 data-id="heading-27">2. 分析单个线程的时间状态分布</h4>
<p>此查询基于 <code>thread_state</code> 表，可用于分析特定线程（示例为 <code>surfaceflinger</code>）在各种状态下的时间分布，从而判断其主要瓶颈。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span>
  <span class="hljs-keyword">CASE</span> state
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'Running'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Running'</span>
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'R'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Runnable'</span>
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'S'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Interruptible Sleep'</span>
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'D'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-string">'Uninterruptible Sleep'</span>
    <span class="hljs-keyword">ELSE</span> state
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> human_state,
  <span class="hljs-built_in">sum</span>(dur) <span class="hljs-operator">/</span> <span class="hljs-number">1e6</span> <span class="hljs-keyword">AS</span> total_time_ms
<span class="hljs-keyword">FROM</span> thread_state
<span class="hljs-keyword">WHERE</span> utid <span class="hljs-operator">=</span> (<span class="hljs-keyword">SELECT</span> utid <span class="hljs-keyword">FROM</span> thread <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'surfaceflinger'</span> LIMIT <span class="hljs-number">1</span>)
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> human_state
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_time_ms <span class="hljs-keyword">DESC</span>;
</code></pre>
<h4 data-id="heading-28">3. 查找特定时间段内 CPU 消耗最高的线程</h4>
<p>此查询用于分析特定场景（如应用启动的 2-5s 时间段）中，消耗 CPU 时间最长的线程。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span>
  thread.name,
  sum(dur) / <span class="hljs-number">1e9</span> <span class="hljs-keyword">AS</span> cpu_time_s
<span class="hljs-keyword">FROM</span> sched
<span class="hljs-keyword">JOIN</span> thread <span class="hljs-keyword">ON</span> sched.utid = thread.utid
-- 时间戳单位为纳秒，可以自己加上 <span class="hljs-keyword">WHERE</span> ts &gt; <span class="hljs-number">2e9</span> <span class="hljs-built_in">AND</span> ts &lt; <span class="hljs-number">5e9</span> 来取某一段时间
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> thread.name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> cpu_time_s DESC
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<h4 data-id="heading-29">4. 查看线程在各 CPU 核心上的运行时间分布</h4>
<p>此查询有助于了解一个线程的 CPU 亲和性，以及它是否在预期的大小核上运行。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span>
  cpu,
  sum(dur) / <span class="hljs-number">1e6</span> <span class="hljs-keyword">AS</span> time_on_cpu_ms
<span class="hljs-keyword">FROM</span> sched
<span class="hljs-keyword">WHERE</span> utid = (<span class="hljs-keyword">SELECT</span> utid <span class="hljs-keyword">FROM</span> thread <span class="hljs-keyword">WHERE</span> name = <span class="hljs-comment">'system_server' LIMIT 1)</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> cpu
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> cpu;
</code></pre>
<h4 data-id="heading-30">5. 计算各进程的 CPU 利用率</h4>
<p>此查询计算了每个进程在整个 Trace 时间范围内的 CPU 利用率。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span>
  process.name <span class="hljs-keyword">AS</span> process_name,
  <span class="hljs-number">100</span> * sum(dur) / CAST(TRACE_END() - TRACE_START() <span class="hljs-keyword">AS</span> REAL) <span class="hljs-keyword">AS</span> cpu_utilization_percent
<span class="hljs-keyword">FROM</span> sched
<span class="hljs-keyword">JOIN</span> thread <span class="hljs-keyword">ON</span> thread.utid = sched.utid
<span class="hljs-keyword">JOIN</span> process <span class="hljs-keyword">ON</span> process.upid = thread.upid
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> process.name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> cpu_utilization_percent DESC;
</code></pre>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-summary" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-31">总结</h3>
<p>对 Perfetto 中 CPU 信息的熟练分析，是 Android 性能优化的关键技能。通过深度理解 <strong>核心架构</strong>、<strong>线程状态</strong>、<strong>唤醒关系</strong>、<strong>频率限制</strong> 和 <strong>C-State</strong>，并结合强大的 <strong>SQL 查询</strong>进行量化分析，开发者可以精准地定位并解决各类性能与功耗问题。</p>
<h2 data-id="heading-32">关于我 &amp;&amp; 博客</h2>
<p>下面是个人的介绍和相关的链接，期望与同行的各位多多交流，三人行，则必有我师!</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">博主个人介绍</a> ：里面有个人的微信和微信群链接。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F12%2F01%2FBlogMap%2F" target="_blank" title="https://www.androidperformance.com/2019/12/01/BlogMap/" ref="nofollow noopener noreferrer">本博客内容导航</a> ：个人博客内容的一个导航。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2018%2F05%2F07%2FAndroid-performance-optimization-skills-and-tools%2F" target="_blank" title="https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools/" ref="nofollow noopener noreferrer">个人整理和搜集的优秀博客文章 - Android 性能优化必知必会</a> ：欢迎大家自荐和推荐 （微信私聊即可）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2023%2F12%2F30%2Fthe-performance%2F" target="_blank" title="https://www.androidperformance.com/2023/12/30/the-performance/" ref="nofollow noopener noreferrer">Android性能优化知识星球</a> ： 欢迎加入，多谢支持～</li>
</ol>
<blockquote>
<p><strong>一个人可以走的更快 , 一群人可以走的更远</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新手建站零门槛！Vercel+Cloudflare+Namesilo域名购买部署全流程]]></title>    <link>https://juejin.cn/post/7572757056438583305</link>    <guid>https://juejin.cn/post/7572757056438583305</guid>    <pubDate>2025-11-16T13:36:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572757056438583305" data-draft-id="7572793505900265523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新手建站零门槛！Vercel+Cloudflare+Namesilo域名购买部署全流程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-16T13:36:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="网页建筑师"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453678535"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新手建站零门槛！Vercel+Cloudflare+Namesilo域名购买部署全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453678535/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    网页建筑师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:36:54.000Z" title="Sun Nov 16 2025 13:36:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要</p>
<p>你是否也和我一样，想拥有一个属于自己网站或博客？</p>
<p>但一想到“域名”、“服务器”、“部署”这些词就头大，觉得既麻烦又昂贵？</p>
<p>这篇教程专为首次建站的新手准备！用Namesilo买便宜域名，Cloudflare做免费加速和安全防护，Vercel一键部署网站，四步就能搞定从域名到上线的全流程，每一步都有详细操作，看完就能上手！</p>
<p><img src="https://aip-enc.uecloud.com.cn/aiPainting/enc/eyJhbGciOiJIUzI1NiJ9.LzEvY2xvdWRzLWNvbm5lY3QtdGVjaG5vbG9neS1tZW4tZG93bmxvYWQtbmF0dXJlLWlkZWFzLWdlbmVyYXRlZC1ieS1haV8xODg1NDQtMjYwODcuanBn.n55QbpXpBfRnJjFFnZ5SfY6QyOX_pSaQNj4obLaDh1s.jpg" alt="Vercel+Cloudflare" loading="lazy"/></p>
<h2 data-id="heading-0"/>
<p>为什么是这个“黄金组合”？</p>
<p><strong>三个工具的核心优势</strong></p>
<p>对于新手来说，选择工具的关键是简单、省钱、稳定。这三个工具完美契合这些需求：</p>
<ul>
<li><strong>Namesilo</strong>：域名价格亲民（.com域名每年约17美元，.top域名只需要1.48美元），提供 **免费Whois保护，**隐藏个人信息，管理界面无广告，操作逻辑清晰，新手也能快速上手。</li>
<li><strong>Cloudflare</strong>：免费提供<strong>CDN加速</strong>（让网站打开更快）、DNS解析、DDoS防护，还能自动生成HTTPS证书，解决网站安全和速度问题。</li>
<li><strong>Vercel</strong>：支持GitHub/GitLab一键导入项目，自动构建部署，提供临时域名，绑定自定义域名超简单，尤其适合React/Vue等前端项目。</li>
</ul>
<p>这三个工具组合起来，总成本仅需域名年费（约几十元人民币），工具本身全免费，不需要购买服务器或复杂配置，是新手建站的最优选择！</p>
<h2 data-id="heading-1"/>
<p>第一步：购买域名 (Namesilo)</p>
<p>选择 <strong>NameSilo</strong> 除了价格低，更重要是支持支付宝，对国内用户支付友好。</p>
<p>1. 注册Namesilo账号：访问Namesilo官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.namesilo.com%25EF%25BC%2589%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB%25E5%258F%25B3%25E4%25B8%258A%25E8%25A7%2592%25E2%2580%259CSign" target="_blank" title="https://www.namesilo.com%EF%BC%89%EF%BC%8C%E7%82%B9%E5%87%BB%E5%8F%B3%E4%B8%8A%E8%A7%92%E2%80%9CSign" ref="nofollow noopener noreferrer">www.namesilo.com），点击右上角“Sign</a> Up”，填写邮箱和密码完成注册</p>
<p><img src="https://s.uecloud.com.cn/upload/image/bd/577d65678ee29c1fec9b52fd748209dd.png" alt="" loading="lazy"/></p>
<p>2. 搜索域名：在首页搜索框输入你想要的域名（比如“fupanote”），点击“Search”查看是否可用。</p>
<p>搜索后，你会看到可用的域名列表。选择你心仪的，点击“Add to Cart”。我选择了 top 域名，前期先用费用低的测试，后面流量起来再用 com 域名</p>
<p><img src="https://s.uecloud.com.cn/upload/image/3b/e57db5f3dc01ea7452c66bd592509ff7.png" alt="" loading="lazy"/></p>
<p>3.结算付款：点击顶部“Cart”图标，检查购物车内容，务必勾选“Free Whois Guard”（免费隐藏个人信息），，选择支付方式（信用卡/PayPal）完成付款，可选支付宝</p>
<p><img src="https://s.uecloud.com.cn/upload/image/e5/faa3db74be28f8c6b5dbb45fd205a5d4.png" alt="" loading="lazy"/></p>
<p>Namesilo的后台管理非常直观，你可以在 “Domain Manager” 里找到你所有的域名，并管理它们的DNS设置。记住这个地方，我们后面会用到。</p>
<p><img src="https://s.uecloud.com.cn/upload/image/28/26dd07fedf9027be52a3d67035f6ec38.png" alt="" loading="lazy"/></p>
<blockquote>
<p>再次提醒：Free Whois Guard是必选项，能有效保护你的隐私，避免垃圾邮件和信息泄露！</p>
</blockquote>
<h2 data-id="heading-2"/>
<p>第二步：部署网站到 Vercel</p>
<p>1. 登录Vercel：访问Vercel官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%25EF%25BC%2589%25EF%25BC%258C%25E7%2594%25A8GitHub%25E8%25B4%25A6%25E5%258F%25B7%25E6%258E%2588%25E6%259D%2583%25E7%2599%25BB%25E5%25BD%2595%25EF%25BC%2588%25E6%259C%2580%25E6%2596%25B9%25E4%25BE%25BF%25EF%25BC%2589%25E3%2580%2582" target="_blank" title="https://vercel.com%EF%BC%89%EF%BC%8C%E7%94%A8GitHub%E8%B4%A6%E5%8F%B7%E6%8E%88%E6%9D%83%E7%99%BB%E5%BD%95%EF%BC%88%E6%9C%80%E6%96%B9%E4%BE%BF%EF%BC%89%E3%80%82" ref="nofollow noopener noreferrer">vercel.com），用GitHub账号授权登录（最方便）。</a></p>
<p>2. 导入项目：点击“New Project”→“Import from Git Repository”，选择你的GitHub仓库（需提前授权）。</p>
<p><img src="https://s.uecloud.com.cn/upload/image/34/640cd688ace9bd28c3d4e1e4f0d7fd84.png" alt="" loading="lazy"/></p>
<p>3. 配置项目：输入项目名称，选择代码分支（比如main），无需额外配置，直接点击“Deploy”。</p>
<p>4. 等待部署：Vercel会自动拉取代码、构建项目，约1分钟后部署完成，页面显示临时域名（比如“your-project.vercel.app”），点击即可访问网站。</p>
<h2 data-id="heading-3"/>
<p>第三步：配置Cloudfare加速与DNS</p>
<p>1. 注册Cloudflare：访问Cloudflare官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudflare.com%25EF%25BC%2589%25EF%25BC%258C%25E7%2594%25A8%25E9%2582%25AE%25E7%25AE%25B1%25E6%25B3%25A8%25E5%2586%258C%25E8%25B4%25A6%25E5%258F%25B7%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB%25E5%25A4%25B4%25E5%2583%258F%25EF%25BC%258C%25E8%25AE%25BE%25E7%25BD%25AE%25E8%25AF%25AD%25E8%25A8%2580%25E9%2580%2589%25E6%258B%25A9%25E7%25AE%2580%25E4%25BD%2593%25E4%25B8%25AD%25E6%2596%2587" target="_blank" title="https://www.cloudflare.com%EF%BC%89%EF%BC%8C%E7%94%A8%E9%82%AE%E7%AE%B1%E6%B3%A8%E5%86%8C%E8%B4%A6%E5%8F%B7%EF%BC%8C%E7%82%B9%E5%87%BB%E5%A4%B4%E5%83%8F%EF%BC%8C%E8%AE%BE%E7%BD%AE%E8%AF%AD%E8%A8%80%E9%80%89%E6%8B%A9%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" ref="nofollow noopener noreferrer">www.cloudflare.com），用邮箱注册账号，点击头像，设置语言选择简体中文</a></p>
<p><img src="https://s.uecloud.com.cn/upload/image/79/2a5d22e83f4bbef214e2bd20b271c247.png" alt="" loading="lazy"/></p>
<p>2. 添加站点：点击“连接域”，输入你在Namesilo购买的域名（比如“fupanote.top”），点击“继续”。、</p>
<p><img src="https://s.uecloud.com.cn/upload/image/0d/b6cec8e0bbc31397747cad2bff66fbfb.png" alt="" loading="lazy"/></p>
<p>3. 选择计划：默认选择“Free Plan”（免费计划）</p>
<p><img src="https://s.uecloud.com.cn/upload/image/1f/5c28fa20fc3c298993f33ee4190bd50e.png" alt="" loading="lazy"/></p>
<p>4.创建后，Cloudflare会提供2个DNS服务器地址（比如“ns1.cloudflare.com”和“ns2.cloudflare.com”），复制这两个地址。</p>
<p><img src="https://s.uecloud.com.cn/upload/image/64/5d26407ba907ad39a3468cc0aed1db8a.png" alt="" loading="lazy"/></p>
<p>5. 修改Namesilo的DNS服务器：</p>
<p>回到Namesilo，点击“My Domains”→域名旁边的“Manage DNS”→“Change Nameservers”，替换成Cloudflare的DNS地址，点击“Submit”保存。</p>
<p><img src="https://s.uecloud.com.cn/upload/image/a9/f80b3c3b80495514767e4a3cb5446fad.png" alt="" loading="lazy"/></p>
<p>6. 验证DNS：回到Cloudflare，点击“Done, check nameservers”</p>
<p><img src="https://s.uecloud.com.cn/upload/image/78/33cd73dc3558cc67958dd2713df9be57.png" alt="" loading="lazy"/></p>
<p>DNS服务器修改后，等待DNS生效（通常5-30分钟，最长24小时）。全球DNS缓存更新需要时间，这段时间网站可能无法访问，耐心等待即可！</p>
<h2 data-id="heading-4"/>
<p>绑定域名到 Vercel</p>
<p>1. Vercel添加域名：进入你的Vercel项目→“Settings”→“Domains”，输入你的域名（比如“fupanote.top”），点击“Add”。</p>
<p><img src="https://s.uecloud.com.cn/upload/image/d5/0bf9a8331f2d65f43adeaa8b1a1b483e.png" alt="" loading="lazy"/></p>
<p>点击添加域名后，会创建两条 DNS Records 记录，在 Cloudflare 分别创建两天相同的记录映射就可以了</p>
<p><img src="https://s.uecloud.com.cn/upload/image/db/df26c9e98deaa3fff07a4b5ab5b96355.png" alt="" loading="lazy"/></p>
<p>2.Cloudflare添加CNAME记录，复制上面的信息填入创建的记录</p>
<p><img src="https://s.uecloud.com.cn/upload/image/d9/c61b0f6aa0eee1aa3be6472ca11a765b.png" alt="" loading="lazy"/></p>
<p>回到 Vercel 域名页面，刷新就可以看到被激活可以访问了</p>
<p><img src="https://s.uecloud.com.cn/upload/image/48/b87d45d96c7a56d111463c44523a5fb2.png" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent : CrewAI 简单使用 + 尝试一下股票分析]]></title>    <link>https://juejin.cn/post/7572714389943615540</link>    <guid>https://juejin.cn/post/7572714389943615540</guid>    <pubDate>2025-11-16T13:46:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572714389943615540" data-draft-id="7570058831559311395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent : CrewAI 简单使用 +  尝试一下股票分析"/> <meta itemprop="keywords" content="后端,Python,AI编程"/> <meta itemprop="datePublished" content="2025-11-16T13:46:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="志字辈小蚂蚁"/> <meta itemprop="url" content="https://juejin.cn/user/3790771822007822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent : CrewAI 简单使用 +  尝试一下股票分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771822007822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    志字辈小蚂蚁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:46:03.000Z" title="Sun Nov 16 2025 13:46:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一. 前言</h2>
<p>之前说了一直在做股票信息收集 + 风险 + 机遇 舆情分析的一个小工具 ，然后年底的目标是把 AI 植入这个系统。</p>
<p>整个过程中尝试了包括 ： CrewAI  / LangChain / AutoGen 。 整体来说用法都类似 ，所以综合使用体验和结果后 ，我个人选择了 CrewAI 作为智能体引擎。</p>
<p>项目地址 ： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fantblack%2Fai-demo%2Ftree%2Fmaster%2Fagent-demo%2FCrewAI_Sample_stock" target="_blank" title="https://gitee.com/antblack/ai-demo/tree/master/agent-demo/CrewAI_Sample_stock" ref="nofollow noopener noreferrer">gitee.com/antblack/ai…</a></p>
<h2 data-id="heading-1">二. 使用方式</h2>
<ul>
<li><strong>CrewAI 是什么</strong> : 一个多智能体的开源框架 ，用于多智能体的场景开发</li>
<li><strong>核心功能要点</strong> ： 3大主要功能点
<ul>
<li><em>智能体 (Agent)</em> ：定义角色 (Role)、目标 (Goal) 和背景 (Backstory)，使 AI 成为特定场景的专家
<ul>
<li>我这里理解就是提示词增强 ，通过提示词来让 AI 处理更加专一的事情，至于能多专家，就要看提示词有多强了</li>
</ul>
</li>
<li><em>任务 (Task)</em> :分配具体工作，可设置预期输出 (Expected Output) 和上下文依赖。</li>
<li><em>工具 (Tools)</em> ： 赋予 Agent 联网搜索、读写文件、执行代码等“手脚”能力</li>
</ul>
</li>
</ul>
<p>基础概念就说这么多 ，这东西也出来很久了，资料很多就不赘述了。</p>
<blockquote>
<p>智能体的创建 ：</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_data_analyst_agent</span>(<span class="hljs-params">llm=<span class="hljs-literal">None</span></span>) -&gt; Agent:
    <span class="hljs-string">"""
    创建数据分析师智能体
    
    Args:
        llm: 语言模型实例（可选）
    
    Returns:
        配置好的数据分析师 Agent
    """</span>
    agent_config = {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"资深股票分析师"</span>,
        <span class="hljs-string">"goal"</span>: <span class="hljs-string">"对股票进行全面的技术分析和基本面分析，给出专业的投资建议"</span>,
        <span class="hljs-string">"backstory"</span>: get_data_analyst_prompt(),
        <span class="hljs-string">"verbose"</span>: <span class="hljs-literal">True</span>,
        <span class="hljs-string">"allow_delegation"</span>: <span class="hljs-literal">False</span>
    }
    
    <span class="hljs-keyword">if</span> llm <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        agent_config[<span class="hljs-string">"llm"</span>] = llm
    
    <span class="hljs-keyword">return</span> Agent(**agent_config)

</code></pre>
<blockquote>
<p>工具调用 ：</p>
</blockquote>
<ul>
<li>工具我准备了2个 ： Tavily  和 Tushare
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapp.tavily.com%2Fhome" target="_blank" title="https://app.tavily.com/home" ref="nofollow noopener noreferrer">Tavily</a> ： 一个资讯查询的平台 ，有比较高的免费额度，推荐</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftushare.pro%2Fregister%3Freg%3D621792" target="_blank" title="https://tushare.pro/register?reg=621792" ref="nofollow noopener noreferrer">Tushare</a>  : 一个股票量化平台，提供免费的额度可以查询股票的日K数据</li>
</ul>
</li>
</ul>
<p>这里代码只展示一下 Tavily 的调用 ，其他的可以从项目里面下载：</p>
<pre><code class="hljs language-python" lang="python">TAVILY_API_KEY = os.environ.get(<span class="hljs-string">"TAVILY_API_KEY"</span>)

<span class="hljs-comment"># 假设 API Key 总是有效的，直接初始化客户端</span>
<span class="hljs-comment"># 如果 TAVILY_API_KEY 为 None, 客户端在调用时会自行失败</span>
client = TavilyClient(api_key=TAVILY_API_KEY)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_stock_news</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, max_results: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    搜索股票相关新闻 (简化版)
    """</span>
    <span class="hljs-comment"># 构建搜索查询</span>
    query = <span class="hljs-string">f"<span class="hljs-subst">{keyword}</span> 股票 最新消息"</span>

    <span class="hljs-comment"># 执行搜索</span>
    response = client.search(
        query=query,
        max_results=max_results,
        search_depth=<span class="hljs-string">"basic"</span>,
        include_domains=[<span class="hljs-string">"sina.com.cn"</span>, <span class="hljs-string">"eastmoney.com"</span>, <span class="hljs-string">"10jqka.com.cn"</span>, <span class="hljs-string">"cnstock.com"</span>]
    )

    results = response[<span class="hljs-string">'results'</span>]

    <span class="hljs-comment"># 格式化输出</span>
    news_text = <span class="hljs-string">f"【<span class="hljs-subst">{keyword}</span> 相关新闻】\n\n"</span>
    <span class="hljs-keyword">for</span> i, item <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(results, <span class="hljs-number">1</span>):
        title = item.get(<span class="hljs-string">'title'</span>, <span class="hljs-string">'无标题'</span>)
        url = item.get(<span class="hljs-string">'url'</span>, <span class="hljs-string">''</span>)
        content = item.get(<span class="hljs-string">'content'</span>, <span class="hljs-string">''</span>)

        <span class="hljs-comment"># 截取内容</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(content) &gt; <span class="hljs-number">200</span>:
            content = content[:<span class="hljs-number">200</span>] + <span class="hljs-string">"..."</span>

        news_text += <span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{title}</span>\n"</span>
        news_text += <span class="hljs-string">f"   摘要: <span class="hljs-subst">{content}</span>\n"</span>
        news_text += <span class="hljs-string">f"   来源: <span class="hljs-subst">{url}</span>\n\n"</span>

    <span class="hljs-keyword">return</span> news_text.strip()

</code></pre>
<ul>
<li>数据其实有两种方式灌到 CrewAI 里面去 ，你可以当成提示词的原始数据写进去 ，也可以通过 CrewAI 本身的 Tools 的能力</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@tool(<span class="hljs-params"><span class="hljs-string">"搜索股票新闻"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_stock_news_tool</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span>, max_results: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    api_rate_limiter.wait_if_needed()
    <span class="hljs-keyword">return</span> _search_stock_news(keyword, max_results)
</code></pre>
<blockquote>
<p>定义 Task 及 Agent 列表</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> crewai <span class="hljs-keyword">import</span> Agent, Task, Crew, Process

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_stock_minimal</span>(<span class="hljs-params">stock_query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-comment"># 以贵州茅台作为案例</span>
    stock_code = <span class="hljs-string">"600519"</span> <span class="hljs-comment"># 按要求写死或简化</span>
    
    <span class="hljs-comment"># 2. 获取 LLM</span>
    llm = get_llm()
    
    <span class="hljs-comment"># 3. 创建智能体 (链式定义)</span>
    collector_agent = create_data_collector_agent(ALL_TOOLS, llm)
    analyst_agent = create_data_analyst_agent(llm)
    decision_agent = create_decision_maker_agent(llm)
    
    <span class="hljs-comment"># 4. 创建任务 (压缩提示词)</span>
    task_collect = Task(
        description=<span class="hljs-string">f"收集 <span class="hljs-subst">{stock_query}</span> (<span class="hljs-subst">{stock_code}</span>) 的数据..."</span>,
        agent=collector_agent,
        expected_output=<span class="hljs-string">"数据摘要..."</span>
    )
    
    task_analyze = Task(
        description=<span class="hljs-string">"分析数据..."</span>,
        agent=analyst_agent,
        expected_output=<span class="hljs-string">"分析报告..."</span>,
        context=[task_collect]
    )
    
    task_decision = Task(
        description=<span class="hljs-string">"给出投资建议..."</span>,
        agent=decision_agent,
        expected_output=<span class="hljs-string">"投资决策..."</span>,
        context=[task_collect, task_analyze]
    )
    
    <span class="hljs-comment"># 5. 创建并执行 Crew</span>
    stock_crew = Crew(
        agents=[collector_agent, analyst_agent, decision_agent],
        tasks=[task_collect, task_analyze, task_decision],
        process=Process.sequential,
        <span class="hljs-comment"># verbose=True # 演示时建议开启，但按要求移除 print (verbose 会自己 print)</span>
    )
    
    <span class="hljs-comment"># 6. 执行任务</span>
    result = stock_crew.kickoff()
    
    <span class="hljs-comment"># 7. 提取结果</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"stock_query"</span>: stock_query,
        <span class="hljs-string">"stage1_data"</span>: <span class="hljs-built_in">str</span>(task_collect.output.raw) <span class="hljs-keyword">if</span> task_collect.output <span class="hljs-keyword">else</span> <span class="hljs-string">"..."</span>,
        <span class="hljs-string">"stage2_analysis"</span>: <span class="hljs-built_in">str</span>(task_analyze.output.raw) <span class="hljs-keyword">if</span> task_analyze.output <span class="hljs-keyword">else</span> <span class="hljs-string">"..."</span>,
        <span class="hljs-string">"stage3_decision"</span>: <span class="hljs-built_in">str</span>(task_decision.output.raw) <span class="hljs-keyword">if</span> task_decision.output <span class="hljs-keyword">else</span> <span class="hljs-string">"..."</span>,
        <span class="hljs-string">"final_output"</span>: <span class="hljs-built_in">str</span>(result)
    }
    
  
</code></pre>
<ul>
<li>功能应该很清晰了 ， llm 👉 Agent 👉 Task 👉 执行 Crew.</li>
<li>Crew 的创建参数如下 ，可以参考源码里面，会更详细一点</li>
</ul>

















































































<table><thead><tr><th>参数 (Attribute)</th><th>核心作用与说明</th></tr></thead><tbody><tr><td><strong>agents</strong></td><td>(list) 团队的 "成员列表"，定义了**'谁'**在团队中。</td></tr><tr><td><strong>tasks</strong></td><td>(list) 团队的 "任务清单"，定义了**'做什么'**以及执行顺序。</td></tr><tr><td><strong>process</strong></td><td>(Enum) 工作流模式。<strong>sequential</strong> (顺序) 或 <strong>hierarchical</strong> (层级)。</td></tr><tr><td><strong>manager_llm</strong></td><td>(LLM) <strong>hierarchical</strong> 模式下，充当 "经理" 角色的 LLM。</td></tr><tr><td><strong>manager_agent</strong></td><td>(Agent) <strong>hierarchical</strong> 模式下，使用一个自定义 Agent 实例充当 "经理"。</td></tr><tr><td><strong>planning</strong></td><td>(bool) 在 kickoff 前，让 Crew 首先生成一个执行计划。</td></tr><tr><td><strong>function_calling_llm</strong></td><td>(LLM) (推荐) 指定一个 LLM <em><strong>专门</strong></em> 负责所有智能体的工具调用。</td></tr><tr><td><strong>chat_llm</strong></td><td>(LLM) 在交互式聊天模式下，用于协调对话的 LLM。</td></tr><tr><td><strong>memory</strong></td><td>(bool) 启用跨任务的短期记忆，允许 Crew 存储和回忆信息。</td></tr><tr><td><strong>cache</strong></td><td>(bool) 启用工具缓存。重复调用相同参数的工具时，直接返回缓存结果。</td></tr><tr><td><strong>max_rpm</strong></td><td>(int) (每分钟请求数) 限制 Crew 调用 LLM API 的总速率。</td></tr><tr><td><strong>verbose</strong></td><td>(bool/int) 在控制台打印详细的实时日志（思考、行动、工具输出）。</td></tr><tr><td><strong>task_callback</strong></td><td>(callable) 每个完整 <strong>任务 (Task)</strong> 执行完毕后调用的函数。</td></tr><tr><td><strong>step_callback</strong></td><td>(callable) (粒度更细) 智能体的每一步 <strong>思考/行动 (Step)</strong> 后调用的函数。</td></tr><tr><td><strong>config</strong></td><td>(dict) 用于传入高级或不常用的 JSON/字典格式配置。</td></tr><tr><td><strong>prompt_file</strong></td><td>(str) 指定一个 JSON 文件路径，用自定义提示覆盖默认提示。</td></tr><tr><td><strong>share_crew</strong></td><td>(bool) 允许 crewAI (匿名) 收集运行数据以帮助改进库。</td></tr><tr><td><strong>security_config</strong></td><td>(dict) 用于工具使用的指纹识别和安全控制。</td></tr></tbody></table>
<h2 data-id="heading-2">三. 过程中的难点和痛点</h2>
<h3 data-id="heading-3">3.1 Tools 调用的不可控</h3>
<p><strong>Tools 调用不可控</strong> ，需要提示词去强控 ，有的时候 AI 并不会主动调用Tools.</p>
<p>再一个 Tools 的质量返回的结果也不可控，需要去通过提示词去获取更好的结果。</p>
<p>比如通过  Tavily 去查询的时候 ，有可能什么都查不出来（这种数据毫无意义） ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/546590e2efe9487fbf5e13378662c1cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b-X5a2X6L6I5bCP6JqC6JqB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763905563&amp;x-signature=23Ug7UN5MpqXiFHynEkuEYdlcPM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">3.2 过程过长</h3>
<p>一个 AI 查询已经很慢了 ，<strong>3个 AI 查询列加起来会占用大量的时间</strong> ，虽然智能体能让结果更加准确，但是相对的会导致处理时间被拉长</p>
<h3 data-id="heading-5">3.3 功能的必要性</h3>
<p>智能体 让 AI 变成专家 ，但是其本质是通过提示词， 那我准备3套提示词 ，然后一个 For 循环分开调用 ，其对应的效果是不是也是差不多的 ？</p>
<p><strong>如果业务不是很复杂 ，硬编码整套流程 ，好像处理起来会更简单</strong>，那么真的有必要上复杂的框架吗？</p>
<h2 data-id="heading-6">总结</h2>
<p>个人对于智能体的使用并不多 ，很多地方也在慢慢探索中 ，所以思考的层次也比较肤浅。</p>
<p><strong>智能体我觉得是很有必要的 ，能让极易扩散的 AI 收束起来，提高回答的准确性。</strong></p>
<p>后续就准备在开源项目里面接入这个功能了。</p>
<h2 data-id="heading-7">参考记录</h2>
<pre><code class="hljs language-xml" lang="xml">================================================================================
📈 股票分析多智能体系统
================================================================================

本系统演示四个阶段的协作流程：
  S1: 数据收集 → S2: 智能体创建 → S3: 智能体协作 → S4: 结果保存


================================================================================
📊 开始分析股票：贵州茅台
================================================================================

识别股票代码: 600519

================================================================================
S1: 智能体创建阶段 - 初始化多智能体系统
================================================================================

✅ 已创建智能体：
  🔍 数据收集员 - 配备了 6 个工具（股票数据+新闻搜索）
  📊 数据分析师 - 负责分析股票
  💼 投资决策官 - 负责做出决策

================================================================================
S2: 智能体协作阶段 - 执行多智能体任务流
================================================================================

🚀 开始执行协作任务...
   数据收集员将自主调用工具获取数据...
--------------------------------------------------------------------------------

╭────────────────────────────────────────────────────────── Crew Execution Started ──────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Crew Execution Started                                                                                                                    │
│  Name: crew                                                                                                                                │
│  ID: bd26e5d6-a16a-439c-ae84-75306378ec7c                                                                                                  │
│  Tool Args:                                                                                                                                │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
└── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
    Status: Executing Task...
╭───────────────────────────────────────────────────────────── 🤖 Agent Started ─────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 股票数据收集专家                                                                                                                   │
│                                                                                                                                            │
│  Task:                                                                                                                                     │
│  请收集股票 贵州茅台 (代码: 600519) 的完整数据。                                                                                           │
│                                                                                                                                            │
│  **你必须使用以下工具来获取数据：**                                                                                                        │
│  1. 使用 "获取股票实时价格" 工具获取实时行情                                                                                               │
│  2. 使用 "获取股票基本信息" 工具获取公司信息                                                                                               │
│  3. 使用 "获取股票历史数据" 工具获取近5天的K线数据（参数: stock_code="600519", days=5）                                                    │
│  4. 使用 "搜索股票新闻" 工具获取最新新闻（参数: keyword="贵州茅台", max_results=3）                                                        │
│                                                                                                                                            │
│  **输出要求：**                                                                                                                            │
│  1. 整理工具返回的所有数据                                                                                                                 │
│  2. 使用清晰的 Markdown 格式                                                                                                               │
│  3. 包含：股票名称、当前价格、涨跌幅、行业、近期走势、最新动态                                                                             │
│  4. 控制在 300 字以内                                                                                                                      │
│                                                                                                                                            │
│  **重要：**                                                                                                                                │
│  - 必须调用所有 4 个工具获取完整数据                                                                                                       │
│  - 不要编造任何数据，只使用工具返回的真实数据                                                                                              │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
└── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
    Status: Executing Task...
    └── 🔧 Used 获取股票实时价格 (1)
╭───────────────────────────────────────────────────────── 🔧 Agent Tool Execution ──────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 股票数据收集专家                                                                                                                   │
│                                                                                                                                            │
│  Using Tool: 获取股票实时价格                                                                                                              │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────── Tool Input ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  "{\"stock_code\": \"600519\"}"                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────── Tool Output ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  【600519 (600519.SH) 实时行情】                                                                                                           │
│  股票名称: 贵州茅台                                                                                                                        │
│  当前价格: ¥1456.60                                                                                                                        │
│  昨日收盘: ¥1470.38                                                                                                                        │
│  涨跌额: ¥-13.78                                                                                                                           │
│  涨跌幅: -0.94%                                                                                                                            │
│  今日开盘: ¥1470.00                                                                                                                        │
│  最高价: ¥1478.95                                                                                                                          │
│  最低价: ¥1456.30                                                                                                                          │
│  成交量: 2,747,306 手                                                                                                                      │
│  成交额: 4,031,007,106.00 万元                                                                                                             │
│  更新时间: 2025-11-14 15:00:00                                                                                                             │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
└── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
    Status: Executing Task...
    ├── 🔧 Used 获取股票实时价格 (1)
    └── 🔧 Used 获取股票基本信息 (1)
╭───────────────────────────────────────────────────────── 🔧 Agent Tool Execution ──────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 股票数据收集专家                                                                                                                   │
│                                                                                                                                            │
│  Using Tool: 获取股票基本信息                                                                                                              │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────── Tool Input ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  "{\"stock_code\": \"600519\"}"                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────── Tool Output ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  【600519 (600519.SH) 公司信息】                                                                                                           │
│  股票名称: 贵州茅台                                                                                                                        │
│  所属行业: 食品饮料                                                                                                                        │
│  所属地区: 贵州                                                                                                                            │
│  上市市场: 上海证券交易所                                                                                                                  │
│                                                                                                                                            │
│  💡 提示：详细财务数据需要 Tushare 积分权限                                                                                                │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
└── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
    Status: Executing Task...
    ├── 🔧 Used 获取股票实时价格 (1)
    ├── 🔧 Used 获取股票基本信息 (1)
    └── 🔧 Used 获取股票历史数据 (1)
╭───────────────────────────────────────────────────────── 🔧 Agent Tool Execution ──────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 股票数据收集专家                                                                                                                   │
│                                                                                                                                            │
│  Using Tool: 获取股票历史数据                                                                                                              │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────── Tool Input ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  "{\"stock_code\": \"600519\", \"days\": 5}"                                                                                               │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────── Tool Output ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  【600519 (600519.SH) 近5天历史数据】                                                                                                      │
│  期间最高价: ¥1478.95                                                                                                                      │
│  期间最低价: ¥1434.98                                                                                                                      │
│  期间平均价: ¥1462.68                                                                                                                      │
│  期初价格: ¥1462.30 (20251110)                                                                                                             │
│  最新价格: ¥1456.60 (20251114)                                                                                                             │
│  期间涨跌: ¥-5.70 (-0.39%)                                                                                                                 │
│  数据点数: 5 天                                                                                                                            │
│                                                                                                                                            │
│  最近5天数据:                                                                                                                              │
│    2025-11-10: 开¥1435.00 收¥1462.30 高¥1463.69 低¥1434.98 量49,452手 涨跌+1.90%                                                           │
│    2025-11-11: 开¥1462.00 收¥1458.99 高¥1462.18 低¥1447.00 量26,692手 涨跌-0.21%                                                           │
│    2025-11-12: 开¥1459.98 收¥1465.15 高¥1478.36 低¥1459.21 量32,992手 涨跌+0.35%                                                           │
│    2025-11-13: 开¥1462.12 收¥1470.38 高¥1473.58 低¥1458.00 量31,179手 涨跌+0.56%                                                           │
│    2025-11-14: 开¥1470.00 收¥1456.60 高¥1478.95 低¥1456.30 量27,473手 涨跌-0.91%                                                           │
│                                                                                                                                            │
│  ✅ 数据来源：Tushare 真实K线数据                                                                                                          │
│                                                                                                                                            │
│                                                                                                                                            │
│  You ONLY have access to the following tools, and should NEVER make up tools that are not listed here:                                     │
│                                                                                                                                            │
│  Tool Name: 获取股票实时价格                                                                                                               │
│  Tool Arguments: {'stock_code': {'description': None, 'type': 'str'}}                                                                      │
│  Tool Description:                                                                                                                         │
│      获取股票实时价格和行情数据                                                                                                            │
│                                                                                                                                            │
│      Args:                                                                                                                                 │
│          stock_code: 股票代码（如 600519, 600000, 000001 等）                                                                              │
│                                                                                                                                            │
│      Returns:                                                                                                                              │
│          股票实时价格信息，包括当前价、涨跌幅、成交量等                                                                                    │
│                                                                                                                                            │
│      Examples:                                                                                                                             │
│          get_stock_price_tool("600519")  # 贵州茅台                                                                                        │
│          get_stock_price_tool("600000")  # 浦发银行                                                                                        │
│                                                                                                                                            │
│  Tool Name: 获取股票基本信息                                                                                                               │
│  Tool Arguments: {'stock_code': {'description': None, 'type': 'str'}}                                                                      │
│  Tool Description:                                                                                                                         │
│      获取股票的基本信息和公司资料                                                                                                          │
│                                                                                                                                            │
│      Args:                                                                                                                                 │
│          stock_code: 股票代码（如 600519, 600000, 000001 等）                                                                              │
│                                                                                                                                            │
│      Returns:                                                                                                                              │
│          股票基本信息，包括公司名称、所属行业、上市市场等                                                                                  │
│                                                                                                                                            │
│      Examples:                                                                                                                             │
│          get_stock_info_tool("600519")  # 获取贵州茅台公司信息                                                                             │
│          get_stock_info_tool("600000")  # 获取浦发银行公司信息                                                                             │
│                                                                                                                                            │
│  Tool Name: 获取股票历史数据                                                                                                               │
│  Tool Arguments: {'stock_code': {'description': None, 'type': 'str'}, 'days': {'description': None, 'type': 'int'}}                        │
│  Tool Description:                                                                                                                         │
│      获取股票的历史K线数据                                                                                                                 │
│                                                                                                                                            │
│      Args:                                                                                                                                 │
│          stock_code: 股票代码（如 600519, 600000, 000001 等）                                                                              │
│          days: 获取最近多少天的数据，默认30天                                                                                              │
│                                                                                                                                            │
│      Returns:                                                                                                                              │
│          历史K线数据摘要，包括期间最高价、最低价、涨跌幅等                                                                                 │
│                                                                                                                                            │
│      Examples:                                                                                                                             │
│          get_stock_history_tool("600519", 30)  # 获取贵州茅台近30天数据                                                                    │
│          get_stock_history_tool("600000", 5)   # 获取浦发银行近5天数据                                                                     │
│                                                                                                                                            │
│  Tool Name: 搜索股票新闻                                                                                                                   │
│  Tool Arguments: {'keyword': {'description': None, 'type': 'str'}, 'max_results': {'description': None, 'type': 'int'}}                    │
│  ...                                                                                                                                       │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
└── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
    Status: Executing Task...
    ├── 🔧 Used 获取股票实时价格 (1)
    ├── 🔧 Used 获取股票基本信息 (1)
    ├── 🔧 Used 获取股票历史数据 (1)
    └── 🔧 Used 搜索股票新闻 (1)
╭───────────────────────────────────────────────────────── 🔧 Agent Tool Execution ──────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 股票数据收集专家                                                                                                                   │
│                                                                                                                                            │
│  Using Tool: 搜索股票新闻                                                                                                                  │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────── Tool Input ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  "{\"keyword\": \"\\u8d35\\u5dde\\u8305\\u53f0\", \"max_results\": 3}"                                                                     │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────────────────────────────── Tool Output ────────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  【贵州茅台 相关新闻】                                                                                                                     │
│                                                                                                                                            │
│  1. 贵州茅台(SH600519)股吧-实时行情分析讨论-新浪财经                                                                                       │
│     摘要: ...                                                                                                                              │
│  贵州茅台(SH600519)股吧提供实时股票行情、热门股票讨论与投资交流平台。汇聚全球股民，分享股市动态、投资策略与个股分析，助您把握投资机会！    │
│  ... 最新. 最热.                                                                                                                           │
│     来源: http://guba.sina.com.cn/bar.php?name=sh600519                                                                                    │
│                                                                                                                                            │
│  2. 贵州茅台(600519)公司高管                                                                                                               │
│     摘要: 贵州茅台酒股份有限公司. A股. 0股. 2020-04-22 ; 贵州茅台酒股份有限公司. A股. 0股. 2019-03-29.                                     │
│     来源: https://vip.stock.finance.sina.com.cn/corp/view/vCI_CorpManagerInfo.php?stockid=600519&amp;Pcode=30030066&amp;Name=%D5%C5%D2%E3          │
│                                                                                                                                            │
│  3. 贵州茅台1456.60(-0.94%)_个股资讯- 新浪财经                                                                                             │
│     摘要: �������� ��������  ��ѡ��Ʊ�� �ƾ���ҳ��Ʊ�����۹������ڻ�����������ծȯ���������¹����������ɰ���ѡ�� * ����300 ���˲ƾ� &gt; ���˹�Ʊ &gt; ����ę́ &gt;    │
│  ������Ѷ * �������� * �������� * �������� * �������� | ���� | �۸�(Ԫ) | �ǵ...                                                               │
│     来源: https://vip.stock.finance.sina.com.cn/corp/go.php/vCB_AllNewsStock/symbol/sh600519.phtml                                         │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
└── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
    Status: Executing Task...
    ├── 🔧 Used 获取股票实时价格 (1)
    ├── 🔧 Used 获取股票基本信息 (1)
    ├── 🔧 Used 获取股票历史数据 (1)
    └── 🔧 Used 搜索股票新闻 (1)
╭────────────────────────────────────────────────────────── ✅ Agent Final Answer ───────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 股票数据收集专家                                                                                                                   │
│                                                                                                                                            │
│  Final Answer:                                                                                                                             │
│  ## 贵州茅台 (600519)                                                                                                                      │
│  - **当前价格**: ¥1456.60                                                                                                                  │
│  - **涨跌幅**: -0.94%                                                                                                                      │
│  - **所属行业**: 食品饮料                                                                                                                  │
│  - **近期走势**: 近5天最高价: ¥1478.95，最低价: ¥1434.98，期间涨跌幅: -0.39%                                                               │
│                                                                                                                                            │
│  ### 最新动态:                                                                                                                             │
│  1. [贵州茅台(SH600519)股吧 - 新浪财经](http://guba.sina.com.cn/bar.php?name=sh600519): 提供实时股票行情与投资交流平台。                   │
│  2.                                                                                                                                        │
│  [贵州茅台公司高管信息](https://vip.stock.finance.sina.com.cn/corp/view/vCI_CorpManagerInfo.php?stockid=600519&amp;Pcode=30030066&amp;Name=%D5%C5  │
│  %D2%E3): 显示公司高管信息。                                                                                                               │
│  3. [贵州茅台1456.60(-0.94%) - 新浪财经](https://vip.stock.finance.sina.com.cn/corp/go.php/vCB_AllNewsStock/symbol/sh600519.phtml):        │
│  提供个股最新行情资讯。                                                                                                                    │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
└── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
    Assigned to: 股票数据收集专家
    Status: ✅ Completed
    ├── 🔧 Used 获取股票实时价格 (1)
    ├── 🔧 Used 获取股票基本信息 (1)
    ├── 🔧 Used 获取股票历史数据 (1)
    └── 🔧 Used 搜索股票新闻 (1)
╭───────────────────────────────────────────────────────────── Task Completion ──────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Task Completed                                                                                                                            │
│  Name: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583                                                                                                │
│  Agent: 股票数据收集专家                                                                                                                   │
│  Tool Args:                                                                                                                                │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
├── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
│   Assigned to: 股票数据收集专家
│   Status: ✅ Completed
│   ├── 🔧 Used 获取股票实时价格 (1)
│   ├── 🔧 Used 获取股票基本信息 (1)
│   ├── 🔧 Used 获取股票历史数据 (1)
│   └── 🔧 Used 搜索股票新闻 (1)
└── 📋 Task: 7c2f35af-7d01-4e3b-859c-4a312752f173
    Status: Executing Task...
╭───────────────────────────────────────────────────────────── 🤖 Agent Started ─────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 资深股票分析师                                                                                                                     │
│                                                                                                                                            │
│  Task:                                                                                                                                     │
│  基于收集的数据进行简要分析。                                                                                                              │
│                                                                                                                                            │
│  **输出要求：**                                                                                                                            │
│  - 使用 Markdown 格式                                                                                                                      │
│  - 控制在 200 字以内                                                                                                                       │
│  - 包含：技术面评价、基本面评价、风险提示                                                                                                  │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
├── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
│   Assigned to: 股票数据收集专家
│   Status: ✅ Completed
│   ├── 🔧 Used 获取股票实时价格 (1)
│   ├── 🔧 Used 获取股票基本信息 (1)
│   ├── 🔧 Used 获取股票历史数据 (1)
│   └── 🔧 Used 搜索股票新闻 (1)
└── 📋 Task: 7c2f35af-7d01-4e3b-859c-4a312752f173
    Status: Executing Task...
╭────────────────────────────────────────────────────────── ✅ Agent Final Answer ───────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 资深股票分析师                                                                                                                     │
│                                                                                                                                            │
│  Final Answer:                                                                                                                             │
│  ```markdown                                                                                                                               │
│  ## 技术面                                                                                                                                 │
│  - 当前价格为 ¥1456.60，近期走势显示5天内最高价为 ¥1478.95，最低价为 ¥1434.98，整体表现平稳，但近期跌幅 -0.39%，市场情绪偏向谨慎。         │
│                                                                                                                                            │
│  ## 基本面                                                                                                                                 │
│  -                                                                                                                                         │
│  贵州茅台属于食品饮料行业，该行业在市场上表现相对稳定，长远增长潜力大。无最新财报及业绩数据，但高管信息及公司治理透明度良好，有利于投资者  │
│  信心。                                                                                                                                    │
│                                                                                                                                            │
│  ## 风险提示                                                                                                                               │
│  - 市场波动性较大，近期已表现出小幅下滑，可能受整体宏观经济或行业趋势影响。投资者应密切关注行业动态和公司公告。                            │
│  ```                                                                                                                                       │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
├── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
│   Assigned to: 股票数据收集专家
│   Status: ✅ Completed
│   ├── 🔧 Used 获取股票实时价格 (1)
│   ├── 🔧 Used 获取股票基本信息 (1)
│   ├── 🔧 Used 获取股票历史数据 (1)
│   └── 🔧 Used 搜索股票新闻 (1)
└── 📋 Task: 7c2f35af-7d01-4e3b-859c-4a312752f173
    Assigned to: 资深股票分析师
    Status: ✅ Completed
╭───────────────────────────────────────────────────────────── Task Completion ──────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Task Completed                                                                                                                            │
│  Name: 7c2f35af-7d01-4e3b-859c-4a312752f173                                                                                                │
│  Agent: 资深股票分析师                                                                                                                     │
│  Tool Args:                                                                                                                                │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
├── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
│   Assigned to: 股票数据收集专家
│   Status: ✅ Completed
│   ├── 🔧 Used 获取股票实时价格 (1)
│   ├── 🔧 Used 获取股票基本信息 (1)
│   ├── 🔧 Used 获取股票历史数据 (1)
│   └── 🔧 Used 搜索股票新闻 (1)
├── 📋 Task: 7c2f35af-7d01-4e3b-859c-4a312752f173
│   Assigned to: 资深股票分析师
│   Status: ✅ Completed
└── 📋 Task: 4b3aba38-de18-4693-947c-49232a7b97ff
    Status: Executing Task...
╭───────────────────────────────────────────────────────────── 🤖 Agent Started ─────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 投资决策官                                                                                                                         │
│                                                                                                                                            │
│  Task:                                                                                                                                     │
│  给出最终投资建议。                                                                                                                        │
│                                                                                                                                            │
│  **输出要求：**                                                                                                                            │
│  - 使用 Markdown 格式                                                                                                                      │
│  - 控制在 200 字以内                                                                                                                       │
│  - 包含：操作建议（买入/持有/卖出）、目标价位、止损价位、核心理由                                                                          │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
├── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
│   Assigned to: 股票数据收集专家
│   Status: ✅ Completed
│   ├── 🔧 Used 获取股票实时价格 (1)
│   ├── 🔧 Used 获取股票基本信息 (1)
│   ├── 🔧 Used 获取股票历史数据 (1)
│   └── 🔧 Used 搜索股票新闻 (1)
├── 📋 Task: 7c2f35af-7d01-4e3b-859c-4a312752f173
│   Assigned to: 资深股票分析师
│   Status: ✅ Completed
└── 📋 Task: 4b3aba38-de18-4693-947c-49232a7b97ff
    Status: Executing Task...
╭────────────────────────────────────────────────────────── ✅ Agent Final Answer ───────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Agent: 投资决策官                                                                                                                         │
│                                                                                                                                            │
│  Final Answer:                                                                                                                             │
│  ```markdown                                                                                                                               │
│  ## 操作建议：持有                                                                                                                         │
│                                                                                                                                            │
│  - 目标价位：需进一步观察市场情绪，适时调整                                                                                                │
│  - 止损价位：¥1430，避免较大损失                                                                                                           │
│  -                                                                                                                                         │
│  核心理由：贵州茅台目前价格稳定，尽管近期小幅回调，行业前景良好。整体表现显示出市场谨慎态度，需要关注宏观经济变化。持有当前股权将有助于在  │
│  长期内把握潜在上涨空间。                                                                                                                  │
│  ```                                                                                                                                       │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🚀 Crew: crew
├── 📋 Task: 0523bfe7-8daa-470f-a8fc-5f0aa6e49583
│   Assigned to: 股票数据收集专家
│   Status: ✅ Completed
│   ├── 🔧 Used 获取股票实时价格 (1)
│   ├── 🔧 Used 获取股票基本信息 (1)
│   ├── 🔧 Used 获取股票历史数据 (1)
│   └── 🔧 Used 搜索股票新闻 (1)
├── 📋 Task: 7c2f35af-7d01-4e3b-859c-4a312752f173
│   Assigned to: 资深股票分析师
│   Status: ✅ Completed
└── 📋 Task: 4b3aba38-de18-4693-947c-49232a7b97ff
    Assigned to: 投资决策官
    Status: ✅ Completed
╭───────────────────────────────────────────────────────────── Task Completion ──────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Task Completed                                                                                                                            │
│  Name: 4b3aba38-de18-4693-947c-49232a7b97ff                                                                                                │
│  Agent: 投资决策官                                                                                                                         │
│  Tool Args:                                                                                                                                │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

╭───────────────────────────────────────────────────────────── Crew Completion ──────────────────────────────────────────────────────────────╮
│                                                                                                                                            │
│  Crew Execution Completed                                                                                                                  │
│  Name: crew                                                                                                                                │
│  ID: bd26e5d6-a16a-439c-ae84-75306378ec7c                                                                                                  │
│  Tool Args:                                                                                                                                │
│  Final Output: ```markdown                                                                                                                 │
│  ## 操作建议：持有                                                                                                                         │
│                                                                                                                                            │
│  - 目标价位：需进一步观察市场情绪，适时调整                                                                                                │
│  - 止损价位：¥1430，避免较大损失                                                                                                           │
│  -                                                                                                                                         │
│  核心理由：贵州茅台目前价格稳定，尽管近期小幅回调，行业前景良好。整体表现显示出市场谨慎态度，需要关注宏观经济变化。持有当前股权将有助于在  │
│  长期内把握潜在上涨空间。                                                                                                                  │
│  ```                                                                                                                                       │
│                                                                                                                                            │
│                                                                                                                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯


================================================================================
S3: 结果保存阶段 - 生成分析报告
================================================================================


💾 完整结果已保存到: result\stock_analysis_20251116_202851.md
💾 结果也已保存到: output.md

================================================================================
✅ 所有任务执行完成！
================================================================================

💡 技术亮点：Agent 通过 CrewAI 工具调用链自主获取数据
   不再是手动调用工具后将数据注入，而是让 Agent 自己决定何时调用哪个工具

================================================================================
S4: 最终输出阶段 - 投资决策建议
================================================================================

```markdown
## 操作建议：持有

- 目标价位：需进一步观察市场情绪，适时调整
- 止损价位：¥1430，避免较大损失
- 核心理由：贵州茅台目前价格稳定，尽管近期小幅回调，行业前景良好。整体表现显示出市场谨慎态度，需要关注宏观经济变化。持有当前股权将有助于在长期内把握潜在上涨空间。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析]]></title>    <link>https://juejin.cn/post/7572480736362381318</link>    <guid>https://juejin.cn/post/7572480736362381318</guid>    <pubDate>2025-11-16T13:30:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736362381318" data-draft-id="7572480736362364934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-16T13:30:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gracker"/> <meta itemprop="url" content="https://juejin.cn/user/1816846860560749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1816846860560749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gracker
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:30:33.000Z" title="Sun Nov 16 2025 13:30:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本篇是 Perfetto 系列文章的第八篇，主要深入介绍 Android 中的 Vsync 机制及其在 Perfetto 中的表现形式。文章将从 Perfetto 的角度来分析 Android 系统如何基于 Vsync 信号进行帧渲染和合成，涵盖 Vsync、Vsync-app、Vsync-sf、VsyncWorkDuration 等核心概念。</p>
<p>随着高刷新率屏幕的普及，理解 Vsync 机制变得更加重要。本文将以 120Hz 刷新率为主要叙事线，帮助开发者理解现代 Android 设备中 Vsync 的工作原理，以及如何在 Perfetto 中观察和分析 Vsync 相关的性能问题。</p>
<blockquote>
<p><strong>注：本文内容基于 Android 16 的最新架构和实现</strong></p>
</blockquote>

<h3 data-id="heading-0">本文目录</h3>
<ul>
<li><a href="#series" title="#series">系列文章目录</a></li>
<li><a href="#what-is-vsync" title="#what-is-vsync">什么是 Vsync</a></li>
<li><a href="#principle" title="#principle">Android 中 Vsync 的基本工作原理</a></li>
<li><a href="#perfetto-observe" title="#perfetto-observe">在 Perfetto 中观察 Vsync</a></li>
<li><a href="#app-frames" title="#app-frames">Android App 每一帧是如何基于 Vsync 工作的</a></li>
<li><a href="#refs" title="#refs">参考文档</a></li>
<li><a href="#about" title="#about">关于我 &amp;&amp; 博客</a></li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-series" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-1">系列文章目录</h2>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F03%2F27%2FAndroid-Perfetto-101%2F%23%2FPerfetto-%25E7%25B3%25BB%25E5%2588%2597%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2024/03/27/Android-Perfetto-101/#/Perfetto-%E7%B3%BB%E5%88%97%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Android Perfetto 系列目录</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-01-What-is-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-01-What-is-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 1：Perfetto 工具简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-02-how-to-get-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-02-how-to-get-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 2：Perfetto Trace 抓取</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2024%2F05%2F21%2FAndroid-Perfetto-03-how-to-analysis-perfetto%2F" target="_blank" title="https://www.androidperformance.com/2024/05/21/Android-Perfetto-03-how-to-analysis-perfetto/" ref="nofollow noopener noreferrer">Android Perfetto 系列 3：熟悉 Perfetto View</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F02%2F08%2FAndroid-Perfetto-04-Open-Big-Trace-With-Command-Line%2F" target="_blank" title="https://www.androidperformance.com/2025/02/08/Android-Perfetto-04-Open-Big-Trace-With-Command-Line/" ref="nofollow noopener noreferrer">Android Perfetto 系列 4：使用命令行在本地打开超大 Trace</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F03%2F26%2FAndroid-Perfetto-05-Chorergrapher%2F" target="_blank" title="https://www.androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" ref="nofollow noopener noreferrer">Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F04%2F26%2FAndroid-Perfetto-06-Why-120Hz%2F" target="_blank" title="https://www.androidperformance.com/2025/04/26/Android-Perfetto-06-Why-120Hz/" ref="nofollow noopener noreferrer">Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F02%2FAndroid-Perfetto-07-MainThread-And-RenderThread%2F" target="_blank" title="https://androidperformance.com/2025/08/02/Android-Perfetto-07-MainThread-And-RenderThread/" ref="nofollow noopener noreferrer">Android Perfetto 系列 7 - MainThread 和 RenderThread 解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2025%2F08%2F05%2FAndroid-Perfetto-08-Vsync%2F" target="_blank" title="https://androidperformance.com/2025/08/05/Android-Perfetto-08-Vsync/" ref="nofollow noopener noreferrer">Android Perfetto 系列 8：深入理解 Vsync 机制与性能分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F11%2F12%2FAndroid-Perfetto-09-CPU%2F" target="_blank" title="https://www.androidperformance.com/2025/11/12/Android-Perfetto-09-CPU/" ref="nofollow noopener noreferrer">Android Perfetto 系列 9 - CPU 信息解读</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1oi82efE4D%2F%3Fvd_source%3D0c6d2191e785de0a36dc21a9da7e664e" target="_blank" title="https://www.bilibili.com/video/BV1oi82efE4D/?vd_source=0c6d2191e785de0a36dc21a9da7e664e" ref="nofollow noopener noreferrer">视频(B站) - Android Perfetto 基础和案例分享</a></li>
</ol>
<p>如果大家还没看过 Systrace 系列，下面是传送门：</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F05%2F26%2FAndroid_Systrace_0%2F%23%2F%25E7%25B3%25BB%25E5%2588%2597%25E6%2596%2587%25E7%25AB%25A0%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="https://www.androidperformance.com/2019/05/26/Android_Systrace_0/#/%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">Systrace 系列目录</a> ： 系统介绍了 Perfetto 的前身 Systrace 的使用，并通过 Systrace 来学习和了解 Android 性能优化和 Android 系统运行的基本规则。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F" target="_blank" title="https://www.androidperformance.com/" ref="nofollow noopener noreferrer">个人博客</a> ：个人博客，主要是 Android 相关的内容，也放了一些生活和工作相关的内容。</li>
</ol>
<p>欢迎大家在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">关于我</a> 页面加入微信群或者星球，讨论你的问题、你最想看到的关于 Perfetto 的部分，以及跟各位群友讨论所有 Android 开发相关的内容</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-what-is-vsync" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-2">什么是 Vsync</h3>
<p>Vsync（Vertical Synchronization，垂直同步）是 Android 图形系统的核心机制，它的存在是为了解决一个根本性的问题：如何让软件的渲染节奏与硬件的显示节奏保持同步。</p>
<p>在没有 Vsync 机制之前，常见问题是屏幕撕裂（Screen Tearing）。当显示器读取 framebuffer 的同时，GPU 写入了下一帧，就会在同一次刷新中出现上下两部分不一致的画面。</p>
<h4 data-id="heading-3">Vsync 解决什么问题？</h4>
<p>Vsync 机制的核心思想非常简单：<strong>让所有的渲染工作都按照显示器的刷新节拍来进行</strong>。具体来说：</p>
<ol start="0">
<li><strong>同步信号</strong>：显示器每次开始新的刷新周期时，都会发出一个 Vsync 信号。</li>
<li><strong>帧节拍与生产</strong>：应用侧在 Vsync 到来时由 Choreographer 驱动开始一帧的生产（Input/Animation/Traversal）；CPU 提交渲染命令后，GPU 异步流水执行。SurfaceFlinger 侧在 Vsync 到来时进行 Buffer 的合成操作。</li>
<li><strong>缓冲机制</strong>：使用双缓冲或三缓冲技术，确保显示器总是读取完整的帧数据。</li>
</ol>
<p>这样，帧的生产与显示以 Vsync 为节拍对齐。以 120Hz 为例，每 8.333ms 会有一个显示机会；应用需要在该窗口前把可合成的 Buffer 提交给 SurfaceFlinger。关键约束是 <code>queueBuffer</code>/<code>acquire_fence</code>/<code>present_fence</code> 的时序；若未赶上本周期，会顺延到下一个周期显示。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-principle" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-4">Android 中 Vsync 的基本工作原理</h3>
<p>Android 系统的 Vsync 实现比基本概念复杂得多，需要考虑多个不同的渲染组件，以及它们之间的协调工作。</p>
<h4 data-id="heading-5">Vsync 信号的分层架构</h4>
<p>在 Android 系统中，并不是只有一个简单的 Vsync 信号。实际上，系统维护着多个不同用途的 Vsync 信号：</p>
<p><strong>硬件 Vsync（HW Vsync）</strong> ： 这是最底层的 Vsync 信号，由显示硬件（HWC，Hardware Composer）产生。它的频率严格对应显示器的刷新率，比如 60Hz 的显示器会每 16.67ms 产生一次 HW Vsync，120Hz 的显示器会每 8.333ms 产生一次。（硬件 Vsync 回调由 HWC/SurfaceFlinger 管理，详见 <code>frameworks/native/services/surfaceflinger</code> 相关实现）</p>
<p>但是，HW Vsync 并不是一直开启的。由于频繁的硬件中断会消耗较多的电量，Android 系统采用了一种智能的策略：只有在需要精确同步的时候才开启 HW Vsync，大部分时间使用软件预测的方式生成 Vsync 信号。</p>
<p><strong>Vsync-app（应用 Vsync）</strong> ： 这是专门用于驱动应用层渲染的 Vsync 信号。当应用需要进行 UI 更新时（比如用户触摸、动画运行、界面滚动等），应用会向系统申请接收 Vsync-app 信号。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// frameworks/base/core/java/android/view/Choreographer.java</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">scheduleFrameLocked</span><span class="hljs-params">(<span class="hljs-type">long</span> now)</span> </span>{
    <span class="hljs-keyword">if</span> (!mFrameScheduled) {
        mFrameScheduled = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (USE_VSYNC) {
            <span class="hljs-comment">// 向系统申请下一个 Vsync 信号</span>
            mDisplayEventReceiver.<span class="hljs-built_in">scheduleVsync</span>();
        }
    }
}
</code></pre>
<p>Vsync-app 是按需申请的。如果应用界面是静态的，没有任何动画或用户交互，那么应用不会申请 Vsync-app 信号，系统也就不会为这个应用生成 Vsync 事件。</p>
<p><strong>Vsync-sf（SurfaceFlinger Vsync）</strong> ： 这是专门用于驱动 SurfaceFlinger 进行图层合成的 Vsync 信号。SurfaceFlinger 是 Android 系统中负责将所有应用的图层合成为最终画面的服务。</p>
<p><strong>Vsync-appSf（应用-SurfaceFlinger Vsync）</strong> ： Android 13 引入的新信号类型。为消除旧设计中 sf EventThread 既唤醒 SurfaceFlinger 又服务部分 Choreographer 客户端带来的时序歧义，系统将两类职责分离：<code>vsync-sf</code> 专注唤醒 SurfaceFlinger，<code>vsync-appSf</code> 面向需要与 SurfaceFlinger 同步的客户端。</p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-perfetto-observe" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-6">在 Perfetto 中观察 Vsync</h3>
<p>Perfetto trace 中包含多个与 Vsync 相关的 Track，理解这些 Track 的含义有助于分析性能问题。</p>
<p><strong>在 SurfaceFlinger 进程中</strong>：</p>
<ol start="0">
<li>
<p><strong>vsync-app</strong> 显示应用 Vsync 信号状态，数值在 0 和 1 之间变化。每次数值变化代表一个 Vsync 信号。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feb20729cf2c4ed488165ad7fad4f459~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=vOTUX4Jq3H4HWGnF%2FML3FhxWeu4%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p><strong>vsync-sf</strong> 显示 SurfaceFlinger Vsync 信号状态。无 Vsync Offset 时与 <code>vsync-app</code> 同步变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ae5c762b2342e9b71bf2f495182190~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=UguwQE7PqeezTvSYgJbdJvQdWuc%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p><strong>vsync-appSf</strong> Android 13+ 新增，服务于需要与 SurfaceFlinger 同步的特殊 Choreographer 客户端。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3125b021ecb146bfbe489e80a113ba73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=dn8e1HiPpVZtFVSmkY6KsLBHNQg%3D" alt="image.png" loading="lazy"/></p>
</li>
<li>
<p><strong>HW_VSYNC</strong> 显示硬件 Vsync 开启状态。值为 1 表示开启，值为 0 表示关闭。为节省电量，硬件 Vsync 仅在需要精确同步时开启。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10bf75abb524471bbfd12679512b686d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=nqt5ht9Ryr%2F99RskCk2iMtmUddE%3D" alt="image.png" loading="lazy"/></p>
</li>
</ol>
<p><strong>在应用进程中</strong>：</p>
<p><code>FrameDisplayEventReceiver.onVsync</code> Slice Track： 显示应用接收 Vsync 信号的时间点。由于信号通过 Binder 传递，时间可能略晚于 SurfaceFlinger 中的 <code>vsync-app</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fe70fca456d451c9b27e28299f915d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=PNPZ1CeAVcPPYW5LRLMv5pVnmis%3D" alt="image.png" loading="lazy"/></p>
<p><code>UI Thread</code> Slice Track： 包含 <code>Choreographer#doFrame</code> 及相关的 Input、Animation、Traversal 等 Slice。每个 <code>doFrame</code> 对应一帧的处理工作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d29a601005d43d98fedbf3322eb6c6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=ZMjnABniA5yZB9Kq8ecvgWgNRYs%3D" alt="image.png" loading="lazy"/></p>
<p><code>RenderThread</code> Slice Track： 包含 <code>DrawFrame</code>、<code>syncAndDrawFrame</code>、<code>queueBuffer</code> 等 Slice，对应渲染线程工作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c676ee0520e48a09843cafa45259962~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=352IQt2VcsUtyA2zs5jn8iyG2jA%3D" alt="image.png" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-app-frames" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-7">Android App 每一帧是如何基于 Vsync 工作的</h3>
<p>Android 应用的每一帧基于 Vsync 机制完成从渲染到显示的完整过程涉及多个关键步骤。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3236da8c07a4ab699f03c09abc3341b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=jRr745eGt5r6wo7FJaEodWX9q2o%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">流程总览（按顺序）</h4>
<ol start="0">
<li>触发重绘/输入：<code>View.invalidate()</code>、动画、数据变化或输入事件触发 → <code>ViewRootImpl.scheduleTraversals()</code> → <code>Choreographer.postCallback(TRAVERSAL)</code></li>
<li>申请 Vsync：<code>Choreographer</code> 通过 <code>DisplayEventReceiver.scheduleVsync()</code> 申请下一次 Vsync（app 相位）</li>
<li>接收 Vsync：<code>DisplayEventReceiver.onVsync()</code> 收到 Vsync 后，向主线程消息队列投递异步消息</li>
<li>主线程帧处理：<code>Choreographer.doFrame()</code> 按顺序执行五类回调：<code>INPUT → ANIMATION → INSETS_ANIMATION → TRAVERSAL → COMMIT</code></li>
<li>渲染提交：<code>RenderThread</code> 执行 <code>syncAndDrawFrame/DrawFrame</code>，CPU 记录 GPU 命令，<code>queueBuffer</code> 提交到 BufferQueue</li>
<li>合成显示：<code>SurfaceFlinger</code> 在 <code>vsync-sf</code> 到来时合成（GPU/或HWC），生成 <code>present_fence</code>，输出到显示</li>
<li>帧完成度量：通过 <code>FrameTimeline</code>（PresentType/JankType）与 <code>acquire/present_fence</code> 判定是否按期显示</li>
</ol>
<p>下面分别展开每一步的关键实现与 Perfetto 观测点。</p>
<h4 data-id="heading-9">App 什么时候会申请 Vsync 信号</h4>
<p>应用并不是时刻都在申请 Vsync 信号的。Vsync 信号是按需申请的，只有在以下情况下，应用才会向系统申请下一个 Vsync：</p>
<p><strong>触发申请 Vsync 的场景</strong>：</p>
<ol start="0">
<li><strong>UI 更新需求</strong>：当 View 调用 <code>invalidate()</code> 时</li>
<li><strong>动画执行</strong>：ValueAnimator、ObjectAnimator 等动画开始时</li>
<li><strong>用户交互</strong>：触摸事件、按键事件等需要 UI 响应时</li>
<li><strong>数据变化</strong>：RecyclerView 数据更新、TextView 文本改变等</li>
</ol>
<h4 data-id="heading-10">App 申请 Vsync 的完整流程</h4>
<p>当应用需要更新 UI 时，会通过以下流程申请 Vsync 信号：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. UI 组件请求重绘</span>
<span class="hljs-comment">// frameworks/base/core/java/android/view/View.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">invalidate</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 标记为需要重绘，但不立即执行</span>
    mPrivateFlags |= <span class="hljs-variable constant_">PFLAG_DIRTY</span>;
    
    <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 向父容器请求重绘</span>
        mParent.<span class="hljs-title function_">invalidateChild</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// 2. ViewRootImpl 调度遍历</span>
<span class="hljs-comment">// frameworks/base/core/java/android/view/ViewRootImpl.java</span>
<span class="hljs-built_in">void</span> <span class="hljs-title function_">scheduleTraversals</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!mTraversalScheduled) {
        mTraversalScheduled = <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 关键：向 Choreographer 注册回调，等待下一个 Vsync</span>
        mChoreographer.<span class="hljs-title function_">postCallback</span>(
            <span class="hljs-title class_">Choreographer</span>.<span class="hljs-property">CALLBACK_TRAVERSAL</span>, mTraversalRunnable, <span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// 3. Choreographer 申请 Vsync</span>
<span class="hljs-comment">// frameworks/base/core/java/android/view/Choreographer.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postCallback</span>(<span class="hljs-params">int callbackType, Runnable action, <span class="hljs-built_in">Object</span> token</span>) {
    <span class="hljs-comment">// 添加回调到队列</span>
    mCallbackQueues[callbackType].<span class="hljs-title function_">addCallbackLocked</span>(action, token);
    
    <span class="hljs-keyword">if</span> (callbackType == <span class="hljs-variable constant_">CALLBACK_TRAVERSAL</span>) {
        <span class="hljs-comment">// 如果是 UI 遍历回调，立即申请 Vsync</span>
        <span class="hljs-title function_">scheduleFrameLocked</span>(now);
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">scheduleFrameLocked</span>(<span class="hljs-params">long now</span>) {
    <span class="hljs-keyword">if</span> (!mFrameScheduled) {
        mFrameScheduled = <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 关键：向系统申请 Vsync 信号</span>
        mDisplayEventReceiver.<span class="hljs-title function_">scheduleVsync</span>();
    }
}
</code></pre>
<h4 data-id="heading-11">主线程如何监听 Vsync 信号</h4>
<p>应用主线程通过 <code>DisplayEventReceiver</code> 来监听 Vsync 信号。这个过程涉及几个关键步骤：</p>
<p><strong>1. 建立连接</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// frameworks/base/core/java/android/view/Choreographer.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FrameDisplayEventReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DisplayEventReceiver</span></span>
        implements <span class="hljs-type">Runnable</span> {
    
    public <span class="hljs-type">FrameDisplayEventReceiver</span>(<span class="hljs-type">Looper</span> looper, int vsyncSource) {
        <span class="hljs-keyword">super</span>(looper, vsyncSource);
        <span class="hljs-comment">// 在构造时建立与 SurfaceFlinger 的连接</span>
    }
}
</code></pre>
<p><strong>2. 接收 Vsync 信号</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onVsync</span><span class="hljs-params">(<span class="hljs-type">long</span> timestampNanos, <span class="hljs-type">long</span> physicalDisplayId, <span class="hljs-type">int</span> frame)</span> {
    <span class="hljs-comment">// 接收到 Vsync 信号，但注意：这里并不直接执行 doFrame</span>
    mTimestampNanos = timestampNanos;
    mFrame = frame;
    
    <span class="hljs-comment">// 关键：将工作 post 到主线程的 MessageQueue 中</span>
    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain(mHandler, <span class="hljs-built_in">this</span>);
    msg.setAsynchronous(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 设为异步消息，优先处理</span>
    mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 这里才真正开始执行一帧的工作</span>
    doFrame(mTimestampNanos, mFrame);
}
</code></pre>
<h4 data-id="heading-12">几个遗留问题</h4>
<p><strong>Q1：为什么不在 <code>onVsync()</code> 中直接执行 <code>doFrame()</code>？</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d7bb81f805745cfaa5752c09f75488f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=ksM7izxTWeVmPv9xE0PHM%2B4SPYE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>线程边界：<code>onVsync()</code> 可能不在主线程，UI 必须在主线程执行</li>
<li>调度控制：通过 <code>sendMessageAtTime()</code> 精确对齐执行时刻</li>
<li>队列语义：进入主线程 MessageQueue，确保与其他高优先级任务协同</li>
</ul>
<p><strong>Q2：Vsync 消息来了但主线程在忙，会丢吗？</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad87408d85f94c5cb3fb7759aaade007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=hAhuCT7U0C1aMhF6JUE0NO5F6ww%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>不会。Vsync 消息入队后等待执行</li>
</ul>
<p><strong>Q3：CPU/GPU 是否必须在单个 Vsync 周期内完成？</strong> 如果任何一个环节超过 1 个 vsync ，都会导致掉帧？</p>
<ul>
<li>
<p>现代 Android 系统采用多缓冲（通常是三缓冲）机制：</p>
<ul>
<li><strong>应用端</strong>：Front Buffer（显示中）+ Back Buffer（渲染中）+ 可能的第三个 Buffer</li>
<li><strong>SurfaceFlinger 端</strong>：也有类似的缓冲机制</li>
<li>这意味着即使应用的某一帧超过了 Vsync 周期，也不一定会立即掉帧。</li>
</ul>
</li>
<li>
<p>GPU 异步流水；关键是 <code>queueBuffer</code> 是否赶上 SF 合成窗口，多缓冲可掩盖单帧延迟但可能引入额外时延，可以看到下图里面，App 端的 BufferQueue 和 SurfaceFlinger 端的 Buffer 都是充足的，且有冗余，所以没有掉帧。</p>
</li>
<li>
<p>但是如果 App 在之前没有堆积 Buffer ，则还是会出现掉帧。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c08e00432e4c5f99b576864f2735f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=W6hF8qraQgkcCl%2Bw%2F7sH84P7hck%3D" alt="image.png" loading="lazy"/></p>
<p><strong>Q4：GPU 和 CPU 是怎么协同的？</strong> ：</p>
<ul>
<li>
<p>GPU 渲染是异步的，这带来了额外的复杂性：</p>
<ul>
<li><strong>CPU 工作正常，GPU 成为瓶颈</strong>：即使应用主线程在 Vsync 周期内完成工作，GPU 渲染耗时过长仍会导致掉帧</li>
<li><strong>GPU Fence 机制</strong>：<code>presentFence</code> 是连接 GPU 渲染和 SurfaceFlinger 合成的关键同步机制。根据系统 <code>Latch Unsignaled Buffers</code> 策略，SurfaceFlinger 并非总是等待 GPU 完成，而是可以“抢跑”提前开始合成，仅在最终需要使用 Buffer 内容时才等待 fence 信号，以此来隐藏延迟。</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be83fd29efb47eba5a5310a06344656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=i3sgiBywl7T3P6d1K%2B3nAqrQbds%3D" alt="image.png" loading="lazy"/></p>
<p><strong>Q5：Vsync Phase（相位差）的真正作用是什么？</strong> ：</p>
<ul>
<li><strong>提升跟手性</strong>：通过调整 sf vsync 的相位差，可以让应用从开始绘制到显示在屏幕上的时间从 3 个 Vsync 周期缩短到 2 个 Vsync 周期。这对于触摸响应等交互场景非常重要。</li>
<li><strong>解决应用绘制超时问题</strong>：当应用绘制超时时，合理的 sf 相位差可以为应用争取更多的处理时间，避免因为时序不当导致的掉帧。</li>
<li>通过观察 Perfetto 中的 VsyncWorkDuration 指标可以了解系统的 Vsync Offset 配置。</li>
<li>下图中显示的时间段就是我手上的手机配置的 app offset （13.3ms）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b1b7e502e03445e8d40e9d6500e5d22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=8BSkoOcZZoXY0rPOdv7NHthFWG4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">Vsync Offset 的技术实现</h4>
<p>在 Android 系统中，Vsync Offset 是通过 VsyncConfiguration 来实现的：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// frameworks/native/services/surfaceflinger/Scheduler/VsyncConfiguration.cpp</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">VsyncConfiguration</span> {
    <span class="hljs-comment">// 应用 Vsync 相对于硬件 Vsync 的偏移</span>
    <span class="hljs-type">nsecs_t</span> appOffset;
    <span class="hljs-comment">// SurfaceFlinger Vsync 相对于硬件 Vsync 的偏移  </span>
    <span class="hljs-type">nsecs_t</span> sfOffset;
    <span class="hljs-comment">// 早期应用 Vsync 偏移（用于特殊情况）</span>
    <span class="hljs-type">nsecs_t</span> appOffsetEarly;
    <span class="hljs-comment">// 早期 SurfaceFlinger Vsync 偏移</span>
    <span class="hljs-type">nsecs_t</span> sfOffsetEarly;
};
</code></pre>
<p><strong>关键概念</strong>：</p>
<ul>
<li><code>appOffset</code>：应用 Vsync 相对于硬件 Vsync 的时间偏移</li>
<li><code>sfOffset</code>：SurfaceFlinger Vsync 相对于硬件 Vsync 的时间偏移</li>
<li><code>Vsync Offset = sfOffset - appOffset</code>：应用和 SurfaceFlinger 接收信号的时间差</li>
</ul>
<h4 data-id="heading-14">实际的优化效果</h4>
<p>以 120Hz 设备为例，配置 3ms Offset 的效果：</p>
<p><strong>无 Offset（传统方式）</strong> ：</p>
<ul>
<li>T0：应用和 SurfaceFlinger 同时接收 Vsync</li>
<li>T0+3ms：应用完成渲染</li>
<li>T0+8.333ms：下一个 Vsync，SurfaceFlinger 开始合成</li>
<li>T0+16.666ms：用户看到画面（总延迟 16.666ms）</li>
</ul>
<p><strong>有 Offset（优化方式）</strong> ：</p>
<ul>
<li>T0+1ms：应用接收 Vsync-app，开始渲染</li>
<li>T0+3ms：应用完成渲染，提交 Buffer</li>
<li>T0+4ms：SurfaceFlinger 接收 Vsync-sf，立即开始合成</li>
<li>T0+6ms：SurfaceFlinger 完成合成</li>
<li>T0+8.333ms：用户看到画面（总延迟 8.333ms）</li>
</ul>
<p>通过合理配置 Offset，可以将延迟从 16.666ms 减少到 8.333ms，提升一倍的响应性能。</p>
<p><strong>实际的时间预算分配</strong>：</p>
<p>以 120Hz 设备为例（8.333ms 周期）：</p>
<ul>
<li><strong>理想情况</strong>：应用 4ms + SurfaceFlinger 2ms + 缓冲 2.333ms</li>
<li><strong>但实际可以接受</strong>：应用 6ms + SurfaceFlinger 3ms（如果有足够的 Buffer 缓冲）</li>
<li><strong>GPU 限制</strong>：在低端设备上，GPU 渲染可能需要 10-15ms，成为真正的瓶颈</li>
</ul>
<p><strong>掉帧的真正原因</strong>：</p>
<ol start="0">
<li><strong>应用端超时 + Buffer 耗尽</strong>：连续多帧超时导致 BufferQueue 没有可用 Buffer</li>
<li><strong>GPU 渲染超时</strong>：即使 CPU 工作正常，GPU 渲染超时也会掉帧</li>
<li><strong>SurfaceFlinger 超时</strong>：系统级合成超时，影响所有应用</li>
<li><strong>系统资源竞争</strong>：CPU/GPU/内存等资源被其他进程占用</li>
</ol>
<h3 data-id="heading-15">Vsync 信号的完整代码流程</h3>
<p>Vsync 信号从硬件传递到应用层的完整链路如下。</p>
<h4 data-id="heading-16">Native 层：Vsync 信号的产生与管理</h4>
<p><strong>硬件 Vsync 的产生</strong></p>
<p>Vsync 信号最初由显示硬件产生。在 HWC（Hardware Composer）层面，硬件会定期产生 Vsync 中断：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// hardware/interfaces/graphics/composer/2.1/utils/hwc2on1adapter/HWC2On1Adapter.cpp</span>
<span class="hljs-comment">// 注意：这是 HWC 1.x 到 2.x 的兼容性适配器，现代设备通常使用原生 HWC 2.x+</span>
<span class="hljs-comment">// 基于 Android 16 AOSP 最新代码</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">HWC2On1Adapter::vsyncThread</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">while</span> (!mVsyncEnded) {
        <span class="hljs-keyword">if</span> (mVsyncEnabled) {
            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> now = <span class="hljs-built_in">std</span>::chrono::steady_clock::now();
            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> vsyncPeriod = <span class="hljs-built_in">std</span>::chrono::nanoseconds(mVsyncPeriod);
            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> nextVsync = mLastVsync + vsyncPeriod;
            
            <span class="hljs-keyword">if</span> (now &gt;= nextVsync) {
                <span class="hljs-comment">// 产生硬件 Vsync 时间戳</span>
                <span class="hljs-keyword">auto</span> timestamp = <span class="hljs-built_in">std</span>::chrono::duration_cast&lt;<span class="hljs-built_in">std</span>::chrono::nanoseconds&gt;(
                    nextVsync.time_since_epoch()).count();
                
                <span class="hljs-comment">// 回调到 SurfaceFlinger</span>
                <span class="hljs-keyword">if</span> (mVsyncCallback) {
                    mVsyncCallback-&gt;onVsync(timestamp, mDisplayId);
                }
                mLastVsync = nextVsync;
            }
        }
        <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::microseconds(<span class="hljs-number">100</span>));
    }
}
</code></pre>
<p><strong>VsyncController：核心控制器</strong></p>
<p>VsyncController 是整个 Vsync 系统的大脑，它接收硬件 Vsync 并管理软件预测：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// frameworks/native/services/surfaceflinger/Scheduler/VsyncController.h</span>
<span class="hljs-comment">// 实际实现通常在 VSyncReactor.cpp 中</span>
<span class="hljs-comment">// 基于 Android 16 AOSP 最新代码</span>
void VsyncController::<span class="hljs-built_in">onVsync</span>(nsecs_t timestamp, int32_t hwcDisplayId) {
    std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(mMutex);
    
    <span class="hljs-comment">// 记录硬件 Vsync 时间戳到追踪器</span>
    mVsyncTracker-&gt;<span class="hljs-built_in">addVsyncTimestamp</span>(timestamp);
    
    <span class="hljs-comment">// 检查是否需要更多硬件 Vsync 样本来校准预测模型</span>
    if (mVsyncTracker-&gt;needsMoreSamples()) {
        <span class="hljs-comment">// 模型还需要更多样本，继续启用硬件 Vsync</span>
        <span class="hljs-built_in">ALOGV</span>("VsyncController: Need more samples, keeping HW Vsync enabled");
    } else {
        <span class="hljs-comment">// 模型已经稳定，可以关闭硬件 Vsync 节省电量</span>
        <span class="hljs-built_in">ALOGV</span>("VsyncController: Model stable, disabling HW Vsync");
        <span class="hljs-built_in">enableHardwareVsync</span>(false);
    }
    
    <span class="hljs-comment">// 通知所有等待的客户端</span>
    for (auto&amp; callback : mCallbacks) {
        callback-&gt;<span class="hljs-built_in">onVsync</span>(timestamp);
    }
}

void VsyncController::<span class="hljs-built_in">enableHardwareVsync</span>(bool enable) {
    if (mHwVsyncEnabled != enable) {
        mHwVsyncEnabled = enable;
        <span class="hljs-comment">// 通过 HWC 接口控制硬件 Vsync</span>
        mHwc<span class="hljs-selector-class">.setVsyncEnabled</span>(mDisplayId, enable);
        
        <span class="hljs-comment">// 在 Perfetto trace 中可以看到这个状态变化</span>
        <span class="hljs-built_in">ATRACE_INT</span>("HW_VSYNC", enable ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);
    }
}
</code></pre>
<p><strong>VsyncDispatch：信号分发机制</strong></p>
<p>VsyncDispatch 负责将 Vsync 信号精确地分发给不同的消费者，每个消费者可以有不同的触发时间：</p>
<pre><code class="hljs language-ini" lang="ini">// frameworks/native/services/surfaceflinger/Scheduler/VSyncDispatch.h
// 实际实现在 VSyncDispatchTimerQueue.cpp 中
// 基于 Android 16 AOSP 最新代码
VsyncDispatch::CallbackToken VsyncDispatch::registerCallback(
        Callback callback, std::string callbackName) {
    std::lock_guard&lt;decltype(mMutex)&gt; lock(mMutex)<span class="hljs-comment">;</span>
    
    // 为每个回调生成唯一的 token
    auto <span class="hljs-attr">token</span> = CallbackToken(mCallbackMap.size())<span class="hljs-comment">;</span>
    mCallbackMap<span class="hljs-section">[token]</span> = std::make_unique&lt;CallbackEntry&gt;(
        std::move(callback), std::move(callbackName))<span class="hljs-comment">;</span>
    
    return token<span class="hljs-comment">;</span>
}

nsecs_t VsyncDispatch::schedule(CallbackToken token, 
                               nsecs_t workDuration, 
                               nsecs_t earliestVsync) {
    std::lock_guard&lt;decltype(mMutex)&gt; lock(mMutex)<span class="hljs-comment">;</span>
    
    auto <span class="hljs-attr">it</span> = mCallbackMap.find(token)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">it</span> == mCallbackMap.end()) {
        return kInvalidTime<span class="hljs-comment">;</span>
    }
    
    // 计算目标 Vsync 时间
    auto <span class="hljs-attr">targetVsync</span> = mVsyncTracker-&gt;nextVsyncTime(earliestVsync)<span class="hljs-comment">;</span>
    
    // 计算唤醒时间 = 目标 Vsync - 工作时长
    auto <span class="hljs-attr">wakeupTime</span> = targetVsync - workDuration<span class="hljs-comment">;</span>
    
    // 如果唤醒时间已经过了，推到下一个 Vsync
    auto <span class="hljs-attr">now</span> = systemTime(SYSTEM_TIME_MONOTONIC)<span class="hljs-comment">;</span>
    if (wakeupTime &lt; now) {
        <span class="hljs-attr">targetVsync</span> = mVsyncTracker-&gt;nextVsyncTime(targetVsync + <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">wakeupTime</span> = targetVsync - workDuration<span class="hljs-comment">;</span>
    }
    
    // 设置回调的触发时间
    it-&gt;second-&gt;<span class="hljs-attr">wakeupTime</span> = wakeupTime<span class="hljs-comment">;</span>
    it-&gt;second-&gt;<span class="hljs-attr">targetVsync</span> = targetVsync<span class="hljs-comment">;</span>
    it-&gt;second-&gt;<span class="hljs-attr">workDuration</span> = workDuration<span class="hljs-comment">;</span>
    
    // 重新调度定时器
    reschedule()<span class="hljs-comment">;</span>
    
    return targetVsync<span class="hljs-comment">;</span>
}

void VsyncDispatch::reschedule() {
    // 找到最早需要触发的回调
    nsecs_t <span class="hljs-attr">nextWakeup</span> = std::numeric_limits&lt;nsecs_t&gt;::max()<span class="hljs-comment">;</span>
    for (const auto&amp; <span class="hljs-section">[token, entry]</span> : mCallbackMap) {
        if (entry-&gt;wakeupTime &gt; 0 &amp;&amp; entry-&gt;wakeupTime &lt; nextWakeup) {
            <span class="hljs-attr">nextWakeup</span> = entry-&gt;wakeupTime<span class="hljs-comment">;</span>
        }
    }
    
    if (nextWakeup != std::numeric_limits&lt;nsecs_t&gt;::max()) {
        // 设置定时器在 nextWakeup 时间触发
        mTimeKeeper-&gt;alarmAt(std::bind(&amp;VsyncDispatch::timerCallback, this), nextWakeup)<span class="hljs-comment">;</span>
    }
}

void VsyncDispatch::timerCallback() {
    std::vector&lt;std::pair&lt;CallbackToken, CallbackEntry*&gt;&gt; firedCallbacks<span class="hljs-comment">;</span>
    
    {
        std::lock_guard&lt;decltype(mMutex)&gt; lock(mMutex)<span class="hljs-comment">;</span>
        auto <span class="hljs-attr">now</span> = systemTime(SYSTEM_TIME_MONOTONIC)<span class="hljs-comment">;</span>
        
        // 找到所有应该触发的回调
        for (auto&amp; <span class="hljs-section">[token, entry]</span> : mCallbackMap) {
            if (entry-&gt;wakeupTime &gt; 0 &amp;&amp; now &gt;= entry-&gt;wakeupTime) {
                firedCallbacks.push_back({token, entry.get()})<span class="hljs-comment">;</span>
                entry-&gt;<span class="hljs-attr">wakeupTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 重置</span>
            }
        }
    }
    
    // 在锁外执行回调，避免死锁
    for (auto&amp; <span class="hljs-section">[token, entry]</span> : firedCallbacks) {
        entry-&gt;callback(entry-&gt;targetVsync, entry-&gt;wakeupTime)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><strong>EventThread：连接 Native 和 Framework</strong></p>
<p>EventThread 是连接 Native 层 Vsync 系统和 Framework 层的桥梁：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp</span>
EventThread::<span class="hljs-built_in">EventThread</span>(std::unique_ptr&lt;VSyncSource&gt; vsyncSource,
                        std::unique_ptr&lt;InterceptVSyncCallback&gt; interceptVSyncCallback,
                        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* threadName)
    : <span class="hljs-built_in">mVSyncSource</span>(std::<span class="hljs-built_in">move</span>(vsyncSource))
    , <span class="hljs-built_in">mInterceptVSyncCallback</span>(std::<span class="hljs-built_in">move</span>(interceptVSyncCallback))
    , <span class="hljs-built_in">mThreadName</span>(threadName) {
    
    <span class="hljs-comment">// 向 VsyncDispatch 注册回调</span>
    mVSyncSource-&gt;<span class="hljs-built_in">setCallback</span>(<span class="hljs-keyword">this</span>);
    
    <span class="hljs-comment">// 启动 EventThread 线程</span>
    mThread = std::<span class="hljs-built_in">thread</span>([<span class="hljs-keyword">this</span>] { <span class="hljs-built_in">threadMain</span>(); });
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EventThread::threadMain</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mMutex)</span></span>;
    
    <span class="hljs-keyword">while</span> (mKeepRunning) {
        <span class="hljs-comment">// 等待 Vsync 事件或连接变化</span>
        mCondition.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>] {
            <span class="hljs-keyword">return</span> !mPendingEvents.<span class="hljs-built_in">empty</span>() || !mKeepRunning;
        });
        
        <span class="hljs-comment">// 处理所有待处理的事件</span>
        <span class="hljs-keyword">auto</span> pendingEvents = std::<span class="hljs-built_in">move</span>(mPendingEvents);
        lock.<span class="hljs-built_in">unlock</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; event : pendingEvents) {
            <span class="hljs-comment">// 分发给所有连接的客户端</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; connection : mConnections) {
                <span class="hljs-keyword">if</span> (connection-&gt;vsyncRequest != VSyncRequest::None) {
                    connection-&gt;<span class="hljs-built_in">postEvent</span>(event);
                }
            }
        }
        
        lock.<span class="hljs-built_in">lock</span>();
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">EventThread::onVSyncEvent</span><span class="hljs-params">(<span class="hljs-type">nsecs_t</span> timestamp, <span class="hljs-type">int32_t</span> displayId)</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mMutex)</span></span>;
    
    <span class="hljs-comment">// 创建 Vsync 事件</span>
    DisplayEventReceiver::Event event;
    event.header.type = DisplayEventReceiver::DISPLAY_EVENT_VSYNC;
    event.header.id = displayId;
    event.header.timestamp = timestamp;
    event.vsync.count = ++mVSyncCount;
    
    <span class="hljs-comment">// 添加到待处理事件队列</span>
    mPendingEvents.<span class="hljs-built_in">push_back</span>(event);
    mCondition.<span class="hljs-built_in">notify_all</span>();
}
</code></pre>
<h4 data-id="heading-17">Framework 层：Vsync 信号的接收与处理</h4>
<p><strong>DisplayEventReceiver：Java 和 Native 的桥梁</strong></p>
<p>DisplayEventReceiver 是 Framework 层接收 Vsync 信号的关键组件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// frameworks/base/core/jni/android_view_DisplayEventReceiver.cpp</span>
static jlong <span class="hljs-built_in">nativeInit</span>(JNIEnv* env, jclass clazz, jobject receiverWeak,
        jobject messageQueueObj, jint vsyncSource, jint configChanged) {
    
    <span class="hljs-comment">// 获取 Java 层的 MessageQueue</span>
    sp&lt;MessageQueue&gt; messageQueue = <span class="hljs-built_in">android_os_MessageQueue_getMessageQueue</span>(env, messageQueueObj);
    
    <span class="hljs-comment">// 创建 Native 层的 DisplayEventReceiver</span>
    sp&lt;NativeDisplayEventReceiver&gt; receiver = new <span class="hljs-built_in">NativeDisplayEventReceiver</span>(
        env, receiverWeak, messageQueue, vsyncSource, configChanged);
    
    <span class="hljs-comment">// 注册到 EventThread</span>
    status_t status = receiver-&gt;<span class="hljs-built_in">initialize</span>();
    if (status) {
        <span class="hljs-built_in">ALOGE</span>("Failed to initialize display event receiver, status=%d", status);
        return <span class="hljs-number">0</span>;
    }
    
    receiver-&gt;<span class="hljs-built_in">incStrong</span>(gDisplayEventReceiverClassInfo.clazz);
    return reinterpret_cast&lt;jlong&gt;(receiver.get());
}

class NativeDisplayEventReceiver : public DisplayEventReceiver, public MessageHandler {
public:
    <span class="hljs-built_in">NativeDisplayEventReceiver</span>(JNIEnv* env, jobject receiverWeak, 
                              const sp&lt;MessageQueue&gt;&amp; messageQueue,
                              jint vsyncSource, jint configChanged)
        : <span class="hljs-built_in">DisplayEventReceiver</span>(static_cast&lt;ISurfaceComposer::VsyncSource&gt;(vsyncSource),
                             static_cast&lt;ISurfaceComposer::ConfigChanged&gt;(configChanged))
        , <span class="hljs-built_in">mReceiverWeakGlobal</span>(env-&gt;<span class="hljs-built_in">NewGlobalWeakRef</span>(receiverWeak))
        , <span class="hljs-built_in">mMessageQueue</span>(messageQueue) {
    }
    
    <span class="hljs-comment">// 当 Vsync 事件到达时的回调</span>
    virtual void <span class="hljs-built_in">onVsync</span>(nsecs_t timestamp, nsecs_t physicalDisplayId, uint32_t count) override {
        <span class="hljs-built_in">ALOGV</span>("NativeDisplayEventReceiver: onVsync timestamp=%lld", (long long)timestamp);
        
        <span class="hljs-comment">// 将事件保存并 post 到 MessageQueue</span>
        mTimestamp = timestamp;
        mDisplayId = physicalDisplayId;
        mCount = count;
        
        <span class="hljs-comment">// 发送消息到 Java 层的 MessageQueue</span>
        mMessageQueue-&gt;<span class="hljs-built_in">getLooper</span>()-&gt;<span class="hljs-built_in">sendMessage</span>(this, Message(MSG_VSYNC));
    }
    
    <span class="hljs-comment">// MessageHandler 的实现，在 Java 层 Looper 中执行</span>
    virtual void <span class="hljs-built_in">handleMessage</span>(const Message&amp; message) override {
        switch (message.what) {
        case MSG_VSYNC:
            // 调用 Java 层的 onVsync 方法
            <span class="hljs-built_in">dispatchVsync</span>(mTimestamp, mDisplayId, mCount);
            break;
        }
    }
    
private:
    void <span class="hljs-built_in">dispatchVsync</span>(nsecs_t timestamp, nsecs_t displayId, uint32_t count) {
        JNIEnv* env = AndroidRuntime::<span class="hljs-built_in">getJNIEnv</span>();
        
        jobject receiverObj = env-&gt;<span class="hljs-built_in">NewLocalRef</span>(mReceiverWeakGlobal);
        if (receiverObj) {
            <span class="hljs-comment">// 调用 Java 层 DisplayEventReceiver.onVsync()</span>
            env-&gt;<span class="hljs-built_in">CallVoidMethod</span>(receiverObj, gDisplayEventReceiverClassInfo.onVsync,
                    ns2ms(timestamp), displayId, count);
            env-&gt;<span class="hljs-built_in">DeleteLocalRef</span>(receiverObj);
        }
    }
};
</code></pre>
<p><strong>Choreographer 中的 Vsync 处理</strong></p>
<p>在 Java 层，Choreographer 的 FrameDisplayEventReceiver 负责处理 Vsync 信号：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/core/java/android/view/Choreographer.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrameDisplayEventReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DisplayEventReceiver</span>
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> mHavePendingVsync;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mTimestampNanos;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mFrame;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FrameDisplayEventReceiver</span><span class="hljs-params">(Looper looper, <span class="hljs-type">int</span> vsyncSource)</span> {
        <span class="hljs-built_in">super</span>(looper, vsyncSource);
    }
    
    <span class="hljs-comment">// Native 层回调到这里</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onVsync</span><span class="hljs-params">(<span class="hljs-type">long</span> timestampNanos, <span class="hljs-type">int</span> builtInDisplayId, <span class="hljs-type">int</span> frame)</span> {
        <span class="hljs-comment">// 检查是否有重复的 Vsync（防御性编程）</span>
        <span class="hljs-keyword">if</span> (mHavePendingVsync) {
            Log.w(TAG, <span class="hljs-string">"Already have a pending vsync event. There should only be one"</span>
                    + <span class="hljs-string">" at a time."</span>);
        } <span class="hljs-keyword">else</span> {
            mHavePendingVsync = <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-comment">// 保存 Vsync 信息</span>
        mTimestampNanos = timestampNanos;
        mFrame = frame;
        
        <span class="hljs-comment">// 关键：将处理工作 post 到主线程的 MessageQueue</span>
        <span class="hljs-comment">// 注意这里使用了 timestampNanos 作为执行时间</span>
        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> Message.obtain(mHandler, <span class="hljs-built_in">this</span>);
        msg.setAsynchronous(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 异步消息，有更高优先级</span>
        mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);
    }
    
    <span class="hljs-comment">// Runnable 接口的实现，在主线程中执行</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        mHavePendingVsync = <span class="hljs-literal">false</span>;
        <span class="hljs-comment">// 开始处理一帧的工作</span>
        doFrame(mTimestampNanos, mFrame);
    }
}

<span class="hljs-comment">// Choreographer 处理一帧的核心逻辑（简化摘录，详见 AOSP 源码）</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">doFrame</span><span class="hljs-params">(<span class="hljs-type">long</span> frameTimeNanos, <span class="hljs-type">int</span> frame)</span> {
    <span class="hljs-comment">// … 省略前置检查与时间校正 …</span>
    <span class="hljs-comment">// 按顺序执行五类回调</span>
    doCallbacks(Choreographer.CALLBACK_INPUT, frameTimeNanos);
    doCallbacks(Choreographer.CALLBACK_ANIMATION, frameTimeNanos);
    doCallbacks(Choreographer.CALLBACK_INSETS_ANIMATION, frameTimeNanos);
    doCallbacks(Choreographer.CALLBACK_TRAVERSAL, frameTimeNanos);
    doCallbacks(Choreographer.CALLBACK_COMMIT, frameTimeNanos);
}
</code></pre>
<h4 data-id="heading-18">关键时序点分析</h4>
<p>通过上述代码流程，我们可以看到完整的时序链路：</p>
<ol start="0">
<li><strong>HWC 产生硬件中断</strong> → <code>VsyncController::onVsync()</code></li>
<li><strong>VsyncController 处理</strong> → <code>VsyncDispatch::schedule()</code></li>
<li><strong>VsyncDispatch 分发</strong> → <code>EventThread::onVSyncEvent()</code></li>
<li><strong>EventThread 通知</strong> → <code>NativeDisplayEventReceiver::onVsync()</code></li>
<li><strong>Native 传递到 Java</strong> → <code>FrameDisplayEventReceiver::onVsync()</code></li>
<li><strong>主线程处理</strong> → <code>Choreographer::doFrame()</code></li>
</ol>
<p>各环节的职责和优化点不同，理解完整流程有助于在 Perfetto 中分析 Vsync 相关性能问题。</p>
<h4 data-id="heading-19">FrameTimeline</h4>
<p>App 和 SurfaceFlinger 都有 FrameTimeline</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d11a83c5d341498f8101c844707ad6a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=ToH4W6%2F44UKOflsK2nr7CRmfyak%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>轨道</strong>：<code>Expected Timeline</code>、<code>Actual Timeline</code></p>
</li>
<li>
<p><strong>PresentType/JankType</strong>：</p>
<ul>
<li>PresentType 指示本帧呈现方式（例如 On-time、Late），JankType 指示卡顿类型来源</li>
<li>常见 JankType：<code>AppDeadlineMissed</code>、<code>BufferStuffing</code>、<code>SfCpuDeadlineMissed</code>、<code>SfGpuDeadlineMissed</code> 等</li>
</ul>
</li>
<li>
<p><strong>操作步骤（Perfetto UI）</strong> ：</p>
<ol start="0">
<li>在应用进程选择目标 <code>Surface/Layer</code> 或使用 FrameToken 过滤</li>
<li>对齐 Expected 与 Actual，查看偏移与颜色编码</li>
<li>向上钻取：<code>Choreographer#doFrame</code>、<code>RenderThread</code>、<code>queueBuffer</code>、<code>acquire/present_fence</code></li>
</ol>
</li>
<li>
<p><strong>误判规避</strong>：</p>
<ul>
<li>仅凭 <code>doFrame</code> 时长判断掉帧不可靠；以 FrameTimeline 的 PresentType/JankType 为准</li>
<li>多缓冲可能掩盖单帧超时，需要看连续帧与 Buffer 可用性</li>
</ul>
</li>
</ul>
<h4 data-id="heading-20">刷新率/显示模式/VRR 对 Vsync 与 Offset/预测的影响</h4>
<ul>
<li>
<p><strong>模式切换</strong>：刷新率变更会重新配置 <code>VsyncConfiguration</code>，影响 app/sf Offset 与预测模型；</p>
<ul>
<li>Perfetto：查 <code>display mode change</code> 事件与随后的 <code>vsync</code> 间隔变化</li>
</ul>
</li>
<li>
<p><strong>VRR（可变刷新率）</strong> ：目标周期不恒定，软件预测更依赖 present_fence 反馈校准；</p>
<ul>
<li>Perfetto：观察 <code>vsync</code> 间隔分布与 <code>present_fence</code> 偏差</li>
</ul>
</li>
<li>
<p><strong>多显示/外接显示</strong>：不同 <code>physicalDisplayId</code> 的 vsync 源独立，注意 app/sf/appSf 的选择与对齐；</p>
<ul>
<li>Perfetto：按显示 ID 过滤相关 Counter/Slice</li>
</ul>
</li>
</ul>
<h4 data-id="heading-21">Perfetto 实战 Checklist（建议按序查看）</h4>
<ol start="0">
<li>
<p><strong>Vsync 信号与周期</strong></p>
<ul>
<li><code>vsync-app / vsync-sf / vsync-appSf</code> 间隔是否稳定（60/90/120Hz 对应周期）</li>
<li>是否存在异常密集/稀疏的 Vsync（预测抖动）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cbc4f81abe04a97adfb08ad10d62196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=XaLYrFBTK1JfwiffFhEOy9sW9xA%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>Vsync 相位差配置</strong></p>
<ul>
<li><code>VsyncWorkDuration</code> 是否符合机型预期的 app/sf Offset</li>
<li>app 与 sf 的先后是否匹配“先绘制后合成”的策略 !
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a94a17f3e6bf449fa3b84ef15899e739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=jWjCgi4KC1DGWwnz%2BASUNae6zi4%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>FrameTimeline 判读</strong></p>
<ul>
<li>先看 <code>PresentType</code>，再看 <code>JankType</code>；确认是 app 还是 SF/GPU 侧问题</li>
<li>选择目标 Surface/FrameToken 定位具体帧 !
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6bb7340fe3e4548b1912b7ba68e1110~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=hKC%2FoDX9qE0mdaVAzT%2FqaZm8Jmc%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>应用主线程与渲染线程</strong></p>
<ul>
<li><code>Choreographer#doFrame</code> 各阶段耗时（Input/Animation/Traversal）</li>
<li><code>RenderThread</code> 的 <code>syncAndDrawFrame/DrawFrame</code> 耗时是否异常
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2076221a7ae448e48bff2d4042ffee6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=Cvd%2F5%2BFETojLwJYCtKi2cQJqOgE%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>BufferQueue 与 Fence</strong></p>
<ul>
<li>生产者：RenderThread queueBuffer 之后，这个 Buffer 就被标记可以被消费了，在经过一次 Transaction 之后就可以被 sf 消费。刚刚 queueBuffer 之后 Buffer 还需要让 GPU 实际进行渲染，这里是用的 Fence 来追踪 GPU 的执行耗时。SF 也需要看这个 Fence 来决定这个 Buffer 是不是 Ready （新版本 SF 有个属性值配置，也可以不等这个 Fence，等后面实际要合成的时候才去看）。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b18cd54c2a34a31bfc60799100647a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=0tpSEDVGxg0VgR2av1noao8mDmQ%3D" alt="image.png" loading="lazy"/></li>
<li>消费者 SF 与 BufferTX：SF 作为 Buffer 的消费者，会在 vsync 到来的时候是会取一个 Buffer 进行合成的，这里 App 的 Buffer 是以 BufferTX-xxxx 的名字存在的，下图可以看到每次 SF 取走一个 Buffer，BufferTX 个数就会减1，这就是正常的。如果 BufferTX 为 0，说明 App 没有及时送 Buffer 上来，SF 也就停止合成了，这就会出现卡顿 （当然如果同时有多个出图源，SF 会取其他的 Buffer，但是对于 App 来说依然是卡顿的）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2940110766c4ce19000d7619987f38b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=8J9PbfOhiF1Y6Ox4u1%2Bp1IW6rLg%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>合成策略与显示</strong></p>
<ul>
<li>SF 是否频繁走 ClientComposition；HWC validate/present 是否异常</li>
<li>多显示/模式切换/VRR 时是否伴随明显预测偏差
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6adcb6e59414dbcab90c561bad48072~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=w8X5YdpFp17PkmpZWVwV9tTRzKA%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p><strong>资源与其他干扰</strong></p>
<ul>
<li>CPU 竞争（大核占用）、GPU 忙、IO/内存抖动（GC/compaction）</li>
<li>其他前台应用/系统服务是否占用关键资源
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59e8ffe5e73248bf96c81bea90153dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JhY2tlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763904632&amp;x-signature=iFvbVV%2BzOUcj7rNnY7tzDPiSlRE%3D" alt="image.png" loading="lazy"/>
<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-refs" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></li>
</ul>
</li>
</ol>
<h3 data-id="heading-22">参考文档</h3>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fgraphics" target="_blank" title="https://source.android.com/docs/core/graphics" ref="nofollow noopener noreferrer">Android Graphics Architecture</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fgraphics%2Fimplement-vsync" target="_blank" title="https://source.android.com/docs/core/graphics/implement-vsync" ref="nofollow noopener noreferrer">VSYNC Implementation Guide</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fgraphics%2Fframe-pacing" target="_blank" title="https://source.android.com/docs/core/graphics/frame-pacing" ref="nofollow noopener noreferrer">Frame Pacing</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2F" target="_blank" title="https://perfetto.dev/docs/" ref="nofollow noopener noreferrer">Perfetto Documentation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F03%2F26%2FAndroid-Perfetto-05-Chorergrapher%2F" target="_blank" title="https://www.androidperformance.com/2025/03/26/Android-Perfetto-05-Chorergrapher/" ref="nofollow noopener noreferrer">Android Perfetto 系列 5：Android App 基于 Choreographer 的渲染流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2025%2F04%2F26%2FAndroid-Perfetto-06-Why-120Hz%2F" target="_blank" title="https://www.androidperformance.com/2025/04/26/Android-Perfetto-06-Why-120Hz/" ref="nofollow noopener noreferrer">Android Perfetto 系列 6：为什么是 120Hz？高刷新率的优势与挑战</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F1905184" target="_blank" title="https://cloud.tencent.com/developer/article/1905184" ref="nofollow noopener noreferrer">Vsync offset 相关技术分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Flearnframework%2Farticle%2Fdetails%2F133964332" target="_blank" title="https://blog.csdn.net/learnframework/article/details/133964332" ref="nofollow noopener noreferrer">Android 13/14高版本SurfaceFlinger出现VSYNC-app/VSYNC-appSf/VSYNC-sf剖析</a></li>
</ol>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a id="user-content-about" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h2 data-id="heading-23">关于我 &amp;&amp; 博客</h2>
<p>下面是个人的介绍和相关的链接，期望与同行的各位多多交流，三人行，则必有我师!</p>
<ol start="0">
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2Fabout%2F" target="_blank" title="https://www.androidperformance.com/about/" ref="nofollow noopener noreferrer">博主个人介绍</a> ：里面有个人的微信和微信群链接。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2019%2F12%2F01%2FBlogMap%2F" target="_blank" title="https://www.androidperformance.com/2019/12/01/BlogMap/" ref="nofollow noopener noreferrer">本博客内容导航</a> ：个人博客内容的一个导航。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroidperformance.com%2F2018%2F05%2F07%2FAndroid-performance-optimization-skills-and-tools%2F" target="_blank" title="https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools/" ref="nofollow noopener noreferrer">个人整理和搜集的优秀博客文章 - Android 性能优化必知必会</a> ：欢迎大家自荐和推荐 （微信私聊即可）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.androidperformance.com%2F2023%2F12%2F30%2Fthe-performance%2F" target="_blank" title="https://www.androidperformance.com/2023/12/30/the-performance/" ref="nofollow noopener noreferrer">Android性能优化知识星球</a> ： 欢迎加入，多谢支持～</li>
</ol>
<blockquote>
<p><strong>一个人可以走的更快 , 一群人可以走的更远</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端实时推送 & WebSocket 面试题（2026版）]]></title>    <link>https://juejin.cn/post/7572539461478907947</link>    <guid>https://juejin.cn/post/7572539461478907947</guid>    <pubDate>2025-11-16T13:55:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572539461478907947" data-draft-id="7572525491539329066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端实时推送 &amp; WebSocket 面试题（2026版）"/> <meta itemprop="keywords" content="前端,面试,HTTP"/> <meta itemprop="datePublished" content="2025-11-16T13:55:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HiStewie"/> <meta itemprop="url" content="https://juejin.cn/user/1591748568038823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端实时推送 &amp; WebSocket 面试题（2026版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748568038823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HiStewie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:55:05.000Z" title="Sun Nov 16 2025 13:55:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">一、历史背景 + 时间轴</h2>
<p>网页一旦需要 <strong>“实时”</strong> ，麻烦就开始了：数据在不断变化，用户却只能等下一次刷新；</p>
<ul>
<li>刷新解决不了的延迟，用短轮询凑数，又被无数空请求反噬；</li>
<li>再加长轮询，试图把“有了新数据再说”变成一种伪推送，却仍困在请求—响应的笼子里。</li>
<li>开发者于是继续前探：让连接不再频繁重建，尝试分块直输，把事件像水一样持续送达，于是有了更顺滑的 Streaming 与标准化的 SSE。</li>
</ul>
<p>直到某一刻，我们不再满足于“更聪明的单向”，而是迈向真正的“同时说话与倾听”——WebSocket 把通信从一次次请求，变成一条持久而通透的通道。此后，</p>
<ul>
<li>HTTP/2、HTTP/3 与 QUIC 又在底层为效率和时延开了绿灯，甚至提供了可选可靠与无序传输的更多可能。</li>
</ul>
<p>接下来，我们就沿着这条主线，层层展开：它们各自解决了什么、在哪些场景最合拍、又如何在你的系统里形成清晰的选型边界。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8085af3caddd431a98f2e1f6676fe5da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906105&amp;x-signature=ojWmhS9CRiHUJ1JA%2Bay2PASTJUU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">01｜从整页刷新出发：减少浪费的一条链路</h3>
<p>这一块是为了解决“整页刷新导致的高延迟与带宽浪费”，逐级细化与优化。</p>
<h4 data-id="heading-2">a. 早期网页：整页刷新</h4>
<ul>
<li>背景与问题：每次更新都整页请求，体验割裂、带宽浪费、延迟高。</li>
<li>直接影响：促使前端与服务端思考“只取变化”。</li>
</ul>
<h4 data-id="heading-3">b. 短轮询（Short Polling）为解决整页刷新的低效</h4>
<ul>
<li>解决：改为“隔一段时间拉一次”，显著减少整页重载带来的浪费。</li>
<li>局限：高频请求带来大量空响应与服务器开销。</li>
<li>承接改进：为减少空转，演进到长轮询；同时催生更流式的思路（Streaming/SSE）。</li>
</ul>
<h4 data-id="heading-4">c. 长轮询（Comet/挂起请求）为减少短轮询的空转</h4>
<ul>
<li>
<p>解决：请求挂起，服务器有新数据才返回，接近“伪推送”，显著降低空转。</p>
</li>
<li>
<p>局限：本质仍是请求-响应；连接频繁重建；难做真正双向。</p>
</li>
<li>
<p>承接改进：</p>
<ul>
<li>单向推送更稳：SSE 标准化单向事件流。</li>
<li>若要真双向与二进制：交给 WebSocket（见独立块）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">d. HTTP Streaming（分块传输/持续输出）为进一步降低重连与延迟</h4>
<ul>
<li>解决：保持连接，分块持续输出，适合连续文本/事件流，重连更少、延迟更低。</li>
<li>局限：多为单向，受代理/中间件影响，兼容性不一。</li>
<li>承接改进：单向事件由 SSE 标准化；双向场景仍需 WebSocket。</li>
</ul>
<h4 data-id="heading-6">e. SSE（Server-Sent Events）单向推送的标准化终点</h4>
<ul>
<li>解决：以标准事件流语义提供单向推送，浏览器原生支持，资源占用低。</li>
<li>适配范围：通知、进度、日志/监控等文本或事件流。</li>
<li>位置关系：在“只需单向推送”的场景中，SSE 是这一链条的稳定落点，而非过渡技术。</li>
</ul>
<hr/>
<h3 data-id="heading-7">02｜范式跃迁：WebSocket（独立大块）</h3>
<p>这不是前面链条的“又一改良”，而是从请求-响应转向全双工持久连接的范式变化。</p>
<h4 data-id="heading-8">WebSocket（全双工、持久、低开销）</h4>
<ul>
<li>
<p>解决：真正的双向实时通信，降低握手与头部开销，支持文本与二进制，端到端延迟低。</p>
</li>
<li>
<p>典型场景：聊天、协同编辑、在线游戏、行情推送、IoT。</p>
</li>
<li>
<p>与上一链条的关系：</p>
<ul>
<li>在“需要双向实时”的主战场，实质上取代了短轮询/长轮询等过渡方案。</li>
<li>与 SSE 并存：若只有单向通知/事件流，SSE 更简单更省资源；若需要双向或二进制，WebSocket 更合适。</li>
</ul>
</li>
</ul>

<ul>
<li>运维关注：连接状态管理、容量与反压、企业代理/负载均衡兼容。</li>
</ul>
<hr/>
<h3 data-id="heading-9">03｜底座升级与新选项：HTTP/2·HTTP/3·QUIC 家族</h3>
<p>这部分不是替代前两块，而是提供更高效的承载与更灵活的传输语义。</p>
<h4 data-id="heading-10">WS over H2/H3</h4>
<ul>
<li>价值：与同域请求复用连接、更好穿透与效率、更低握手成本。</li>
<li>作用：让 WebSocket 的部署与网络效率更优。</li>
</ul>
<h4 data-id="heading-11">WebTransport（基于 QUIC）</h4>
<ul>
<li>价值：可选可靠与有序/无序、更低延迟，适合实时媒体、游戏、定制协议。</li>
<li>关系：不是取代 WebSocket/SSE 的通吃方案，而是当你需要“更细粒度的可靠性与顺序控制”时的新工具。</li>
</ul>
<h2 data-id="heading-12">二、速查表</h2>
<p>实时推送的目标是“低延迟、双向或单向地把数据从服务端送到客户端”。主流技术选型包括：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8209e461669243e489bc9efcbc7d59c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906105&amp;x-signature=EJm0E3wJEZu69PYQqtHZs1JWsJU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">三、WebSocket 核心定义（重要）</h2>
<p>WebSocket 是 HTML5 推出的一种<strong>全双工(Full-Duplex)、持久化(Persistent)的网络通信协议</strong>， 基于TCP协议构建，允许客户端(浏览器)与服务器之间建立一条长期稳定的连接通道，实现「服务器主动向客户端推送数据」和「客户端实时向服务器发送数据」的双向通信，无需频繁建立/断开连接。</p>
<p>其核心特点可概括为：</p>
<ul>
<li><strong>全双工</strong>：通信双方可同时发送/接收数据(区别于HTTP的「请求-响应」单向通信)；</li>
<li><strong>持久连接</strong>：连接建立后长期保持，避免HTTP每次通信都需重新握手的开销；</li>
<li><strong>轻量协议</strong>：数据帧头部信息简洁(仅2-14字节)，传输效率远高于HTTP；</li>
<li><strong>协议标识</strong>：客户端发起连接时使用ws：//(非加密)或wss：//(加密，基于TLS，类似HTTPS)作为协议前缀。</li>
</ul>
<h3 data-id="heading-14">从零开始的完整流程</h3>
<p>下面是一条你在前端真实会走的链路：创建连接 → HTTP 握手与协议切换 → 进入 WebSocket 双向通信 → 启动心跳检测 → 发现异常并重连 → 重连成功后的补偿 → 服务端跨域放行 → 正常/异常关闭。</p>
<hr/>
<h3 data-id="heading-15">1) 创建连接（入口）</h3>
<p>你写下第一行代码时，要解决两件事：用对协议前缀、绑定好事件。</p>
<ul>
<li>如果网页是 <code>HTTPS 必须用 wss://</code>，<code>HTTP 页面用 ws://</code></li>
<li>立刻绑定 <code>onopen</code>/<code>onmessage</code>/<code>onerror</code>/<code>onclose</code>，以便后续重用。</li>
</ul>
<p>示意代码（精简）：</p>
<ul>
<li>new WebSocket(url)</li>
<li>绑定事件：initWebSocketEvents(ws)</li>
</ul>
<hr/>
<h3 data-id="heading-16">2) HTTP 握手与协议切换（从“请求”到“长连”）</h3>
<p>客户端(浏览器) 创建 WebSocket 实例时，会发起一个特殊的 <code>HTTP - GET</code>，核心目的是 「<strong>请求将协议从HTTP升级为WebSocket」</strong>。服务端验证通过后返回 <code>101</code>，双方切换到 WebSocket 帧通信。</p>
<p>WebSocket 帧是双向通信中的最小传输结构，携带 <strong>“</strong> <code>数据类型</code> <strong>、</strong> <code>是否为消息的最后一段</code> <strong>、</strong> <code>负载长度</code> <strong>、</strong> <code>掩码/密钥</code> <strong>、</strong> <code>实际数据</code> <strong>”</strong> 。消息可以被拆成多帧连续发送，也可以一个帧就送完。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17670be5af774bca949745c7a9f3124e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906105&amp;x-signature=DIHKWC8lJfegffXrHbxYWAvZcaU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-17">客户端发起「协议升级请求」(HTTP - GET 请求)</h4>
<p><strong>请求头中关键字段(面试高频考点)：</strong></p>
<ul>
<li><code>GET /ws-endpoint HTTP/1.1</code>：请求方法为 <code>GET</code>，路径为服务器的 WebSocket 端点(如<code>/ws</code>)；</li>
<li><code>Host：example.com</code>：服务器域名；</li>
<li><code>Upgrade：websocket</code>：核心字段，告知服务器「要升级协议为 WebSocket」；</li>
<li><code>Connection：Upgrade</code>：配合 Upgrade，表示「这是一个协议升级请求」；</li>
<li><code>Sec-WebSocket-Key：dGhlIHNhbXBsZSBub25jzQ==</code>：客户端生成的随机字符串(Base64 编码，长度 16 字节)，用于服务器验证(防止恶意连接)；</li>
<li><code>Sec-WebSocket-Version：13</code>：WebSocket 协议版本(当前主流为 13，需服务器支持)；</li>
<li><code>Sec-WebSocket-Origin：https：//example.com</code>：客户端所在域名(用于服务器跨域验证)。</li>
</ul>
<h4 data-id="heading-18">服务器响应「协议升级成功」(HTTP - 101状态码)</h4>
<p>服务器收到请求后，若支持 WebSocket 协议且验证通过(如 Sec-WebSocket-Key 验证、跨域验证) ，会返回<code>HTTP - 101</code>(SwitchingProtocols)状态码，表示「同意协议升级」。</p>
<p><strong>响应头中关键字段</strong> <strong>(面试高频考点)：</strong></p>
<ul>
<li>
<p><code>HTTP/1.1 101 Switching Protocols</code>：101 状态码是协议切换的标志；</p>
</li>
<li>
<p><code>Upgrade： websocket</code>：确认升级为WebSocket 协议；</p>
</li>
<li>
<p><code>Connection：Upgrade</code>：确认连接用于协议升级；</p>
</li>
<li>
<p><code>Sec-WebSocket-Accept：s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</code>：服务器对Sec-WebSocket-Key 的处理结果(核心验证逻辑)：</p>
<ol>
<li>服务器将客户端发送的 Sec-WebSocket-Key 与固定字符串 <code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code> 拼接；</li>
<li>对拼接后的字符串进行 <code>SHA-1</code> 哈希计算；</li>
<li>将哈希结果转为 Base64 编码，即为 Sec-WebSocket-Accept 的值；</li>
<li>客户端会验证该值是否正确，若不正确则拒绝建立连接(防止伪造响应)。</li>
</ol>
</li>
</ul>
<hr/>
<h3 data-id="heading-19">3) 进入通信阶段（双向数据 + 基础发送）</h3>
<p>握手通过，<code>onopen</code> 会触发。此时做两件事：</p>
<ul>
<li>发送初始化数据（如身份、订阅主题）</li>
<li>启动心跳（下一步会讲）</li>
</ul>
<p>通信注意：</p>
<ul>
<li><code>onmessage</code> 既可能是字符串，也可能是二进制（Blob/ArrayBuffer）</li>
<li><code>bufferedAmount</code> 可用来做背压控制（积压太大时暂停继续 send）</li>
</ul>
<hr/>
<h3 data-id="heading-20">4) 启动心跳（让连接“活着”且可感知）</h3>
<p>持久连接会遭遇 Wi‑Fi 抖动、防火墙清理等问题。<strong>心跳=周期性发 ping，超时未收到 pong 就判死链</strong>。</p>
<p>推荐参数（可按业务调优）：</p>
<ul>
<li><code>HEARTBEAT_INTERVAL ≈ 30s</code></li>
<li><code>HEARTBEAT_TIMEOUT ≈ 10s</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0fd9ed3720648cb9ed2cd5a4c689c2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906105&amp;x-signature=ZIMcr6AN08Rw18SUulF0l8BxMv0%3D" alt="" loading="lazy"/></p>
<p>实操要点：</p>
<ul>
<li>启动前先清理旧定时器，避免重复</li>
<li>收到 pong 立即清除超时定时器</li>
<li>onclose/onerror 必须停止心跳</li>
</ul>
<hr/>
<h3 data-id="heading-21">5) 异常→重连（恢复连接但不过载）</h3>
<p>一旦 <code>onerror</code>、<code>onclose(code ≠ 1000)</code> 或心跳判定超时，进入重连。</p>
<p>目标是：<strong>能恢复、不过载、可被用户停止。</strong></p>
<p>策略三件套：</p>
<ul>
<li>指数退避：1s → 2s → 4s … 最多 30s</li>
<li>次数上限：如 10 次（达到即停）</li>
<li>可控停止：提供“停止重连”或页面关闭时停</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa29ef3c90f94ae795499a47a02381dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906105&amp;x-signature=6xXSyktpLLND%2FdfwjLXZTTfgS4o%3D" alt="" loading="lazy"/></p>
<p>补偿机制：</p>
<ul>
<li>在断开前缓存“待发送”数据（例如未发出的聊天消息）</li>
<li>重连成功后按序补发，确保业务连续性</li>
</ul>
<hr/>
<h3 data-id="heading-22">6) 服务器放行跨域（握手能否过关的关键）</h3>
<p>虽然 WebSocket 原生“支持跨域”，但握手是 HTTP，服务端需要对 Sec-WebSocket-Origin 做白名单校验。</p>
<p>否则会 403 或直接关闭。</p>
<ul>
<li>
<p>Node.js（ws）</p>
<ul>
<li>读取 <code>req.headers['sec-websocket-origin']</code></li>
<li>不在 <code>allowedOrigins</code> 列表：关闭 <code>1008</code> “<code>Cross-origin access denied</code>”</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>Spring Boot</p>
<ul>
<li><code>registry.addHandler(...).setAllowedOrigins("https://a.com", "https://b.com")</code></li>
<li>需要时 <code>.withSockJS()</code>提供降级</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e39da6050414e6780b5f078f4272964~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906105&amp;x-signature=hzoLKTV3pyCXPnHeZ5UAQK2Lzn8%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-23">7) 正常关闭与资源清理（善始善终）</h3>
<ul>
<li>用户离开页面或主动退出：ws.close(1000, '用户主动退出')</li>
<li>onclose 中停止心跳与重连，清空定时器与队列，避免泄漏</li>
<li>记录关闭原因码：1000 正常、1006 常见于异常/心跳超时</li>
</ul>
<h2 data-id="heading-24">四、面试题</h2>
<p>面试关注点通常围绕“<strong>协议对比、连接管理、消息语义、可靠性与扩展性、安全与运维成本</strong>”。</p>
<h3 data-id="heading-25">1、WebSocket 与 SSE 的差异与使用场景，HTTP轮询呢？</h3>
<p><strong>WebSocket（全双工，二进制/文本）</strong></p>
<ul>
<li>适用：即时聊天、协作编辑、游戏状态同步、行情推送、需要客户端→服务端主动上行的实时交互。</li>
<li>优点：低延迟、头开销小、全双工、支持二进制、可自定义子协议。</li>
<li>注意：需处理心跳、重连、背压、鉴权与扇出扩展；代理/LB 要正确透传 Upgrade 和超时设置。</li>
</ul>
<p><strong>Server-Sent Events（SSE，单向 server→client）</strong></p>
<ul>
<li>适用：通知流、日志流、监控事件、流式生成文本（如增量输出）、只需服务端下行的实时更新。</li>
<li>优点：浏览器原生 EventSource、文本流、自动重连、支持 Last-Event-ID 断点续传；实现简单。</li>
<li>注意：单向、仅文本（可 base64 二进制）、连接数限制与代理超时需要关注；移动端网络切换要做容错。</li>
</ul>
<p><strong>HTTP 轮询/长轮询（兼容兜底）</strong></p>
<ul>
<li>适用：对实时性要求不高的小流量场景、受网络环境或企业防火墙限制无法使用 WS/SSE 时的兜底。</li>
<li>优点：最易落地、与缓存/鉴权/监控体系天然兼容；对中间设备最友好。</li>
<li>注意：延迟更高、资源利用低；高频轮询会带来成本与限流压力。</li>
</ul>
<p><strong>✅ 重点</strong></p>
<ul>
<li>WebSocket 通过 HTTP/1.1 Upgrade → 101 完成切换，此后是帧协议的全双工通道；Keep-Alive 仅是复用 TCP，不改变 HTTP 的请求-响应语义。</li>
<li>选型规则：需要双向实时交互选 WebSocket；单向事件流选 SSE；受限或低实时性场景用轮询作兜底。</li>
</ul>
<h3 data-id="heading-26">2、如何设计一个可水平扩展的实时推送系统？</h3>
<p>在可水平扩展的实时推送系统中，WebSocket 连接会分布在多台网关节点上。</p>
<p>核心挑战是如何在连接与消息不在同一台机器时，仍能把消息快速路由到正确的连接。可行的范式是</p>
<ul>
<li>网关层负责连接</li>
<li>管道层负责路由与发布订阅</li>
<li>存储层负责状态与回放</li>
</ul>
<h4 data-id="heading-27">🔌 网关层（负责连接）</h4>
<ul>
<li>终止 TLS/WS，维持心跳与速率限制，保持无状态实例。</li>
<li>建立本地索引：connectionId → 订阅集合，userId → connectionIds。</li>
<li>将连接元数据上报共享存储：connectionId、userId、nodeId、订阅、最近心跳。</li>
<li>仅订阅“与自己有关的分片”：按 userId/topic 的哈希分片从管道层拉取，减少无关扇出。</li>
<li>写通道背压与优先级：控制帧/关键消息优先，低优先级可丢尾或抽样。</li>
</ul>
<hr/>
<h4 data-id="heading-28">🚇 管道层（负责路由与发布订阅）</h4>
<ul>
<li>
<p>选型具备分片与回放能力的总线（Kafka/Pulsar/NATS/Redis Streams）。</p>
</li>
<li>
<p><strong>分片策略</strong>：</p>
<ul>
<li>点推：按 userId/connectionId 一致性哈希到分区，保证单用户局部有序。</li>
<li>主题推送：按 topic 分区，网关本地再做订阅过滤与扇出。</li>
</ul>
</li>
</ul>

<ul>
<li>
<p><strong>路由方式</strong>：</p>
<ul>
<li>生产者只需写对的分片；总线按分区把消息送到订阅该分片的网关。</li>
<li>广播/超大房间采用“分层扇出”：先到分片，再由各网关本地扇出，必要时加中间扇出代理。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>去重与幂等</strong>：messageId 或 (topic, partition, offset) 作为幂等键，网关/客户端各自维护短期去重集合。</li>
</ul>
<hr/>
<h4 data-id="heading-29">🗃️ 存储层（负责状态与回放）</h4>
<ul>
<li>会话与订阅状态：使用 Redis Cluster 或 KV 服务存 userId→connectionIds、connectionId→nodeId、订阅清单、心跳时间。</li>
<li>游标与回放：在总线层保留 offset；客户端重连携带 resumeToken，网关据此恢复订阅并按 offset 增量补发。</li>
<li>一致性与更新：订阅变更写事件流，相关网关消费后刷新本地索引；用版本号/逻辑时钟避免乱序覆盖。</li>
</ul>
<h3 data-id="heading-30">3、如何保证消息不丢、不重、按序？</h3>
<ol>
<li><strong>不丢：</strong> 消息先落到能持久化、带副本确认的总线里（像“写盘且多副本到位才算成功”），写失败就退避重试；消费侧是“先送到用户手里或进可靠下行队列，再更新位点”，断线后拿着 <code>resumeToken+offset</code> 从保留的历史里把漏掉的补回来。</li>
<li><strong>不重：</strong> 每条消息都有一个不会撞车的“指纹”（messageId 或 topic-partition-offset）；网关用一小块内存做近端去重，只有第一次真正写入才前进位点，重复的一概忽略；客户端也按同一指纹做幂等处理，避免业务状态被二次改动。</li>
<li><strong>按序：</strong> 把需要有序的对象（userId/roomId）哈希到同一分区，借用分区内天然顺序；同一个键在网关里串行发送、同队列内重试，不跨分区不并行穿插，这样即使重试和补发也不会把顺序打乱。</li>
</ol>
<h3 data-id="heading-31">4、心跳如何设计？超时如何判定？</h3>
<p>这里的心跳，目标是 <strong>“保活、探测、可平滑重连”。</strong></p>
<ol>
<li>
<p><strong>不失联：</strong> 用应用层 <code>ping/pong</code>，客户端主发、服务端回；</p>
<ol>
<li>间隔 20–60s，加±10%抖动</li>
<li>未知网络时取 20–30s，确保小于最短 NAT 空闲回收。</li>
</ol>
</li>
</ol>

<ol start="2">
<li><strong>怎么判死：</strong> 别一跳不回就拍板。记录 <code>lastSeen</code>，<strong>允许 2–3 次心跳未达或</strong> <code>now-lastSeen</code> <strong>超过 2–3 个周期再判断</strong>；进入“<code>Suspect</code>”时降级写入，仍有业务流量即立刻恢复。</li>
<li><strong>断了咋办：重连走指数退避并带抖动，携带</strong> <code>resumeToken/offset</code> <strong>补发</strong>；移动端切网优先复用会话，失败再重建。监控 RTT/丢包与 Suspect 比例，自动调心跳与阈值。</li>
</ol>
<h3 data-id="heading-32">5、如何在 Nginx/Envoy 反向代理后稳定运行 WebSocket？</h3>
<p>核心思路：让代理“不瞎操心”、连接“常被看见”、后端“可续上”。</p>
<ul>
<li><strong>代理设置</strong>：开启 WebSocket 升级；调大超时，禁用缓冲与压缩；保持 TCP keepalive，HTTP/2 用 CONNECT（H2/WebSocket）。</li>
<li><strong>心跳与保活</strong>：应用层 ping/pong 20–30s（±10%抖动），保证小于代理/NAT空闲回收；大连接数用轻量负载均衡（hash by userId/roomId）避免跨节点迁移。</li>
<li><strong>断线与重连</strong>：客户端指数退避+抖动，带会话 token/offset 续传；后端幂等去重，重放不重不丢。</li>
<li><strong>运维与观测</strong>：开代理层指标（升级成功率、idle 关闭数、5xx）、RTT/丢包与重连率，异常时自适应缩短心跳或放宽超时。</li>
</ul>
<h3 data-id="heading-33">6、如何做鉴权与权限隔离？</h3>
<p>握手前校验 JWT；Subprotocol 指定租户/版本；频道级 ACL；避免敏感数据从客户端请求非授权频道。</p>
<ul>
<li><strong>握手前校验 JWT</strong>：在 <code>HTTP Upgrade </code>前验证 iss/aud/exp/签名并解析 tenant_id/user_id/scopes，避免建立长连后再踢。</li>
<li><strong>Subprotocol 指定租户/版本</strong>：用 Sec-WebSocket-Protocol 携带 tenant 和策略版本做白名单匹配，确保连接上下文一致。</li>
<li><strong>频道级 ACL</strong>：频道强制以租户前缀命名，每次 subscribe/publish 依据 RBAC+scope 前缀（到资源或前缀）做服务端授权。</li>
<li><strong>避免敏感数据越权</strong>：仅按服务器维护的“已授权订阅集合”下发数据，忽略客户端自报筛选请求并拒绝未授权频道。</li>
</ul>
<h3 data-id="heading-34">7、如何评估性能与成本？</h3>
<ul>
<li><strong>每连接内存占用：</strong> 用基线压测量出 MB/1k 连接的实际占用，结合目标并发外推单机上限并监控 GC/碎片。</li>
<li><strong>每秒消息数（fanout×频率）：</strong> 用发布频率×平均扇出得到总吞吐，核算带宽与发送队列容量，识别热点频道放大效应。</li>
<li><strong>尾延迟 P95/P99：</strong> 持续跟踪端到端延迟长尾并关联队列深度与CPU/GC事件，确保在SLA红线下仍稳定。</li>
<li><strong>压测考虑广播峰值与重连风暴：</strong> 分别模拟大扇出瞬时广播与大量短时间内握手重连，验证背压、限速和握手路径的韧性。</li>
</ul>
<h3 data-id="heading-35">8、遇到“重连风暴”怎么处理？</h3>
<ul>
<li><strong>抖动退避（指数退避 + 随机抖动）：</strong> 客户端按指数退避间隔重试并加入随机抖动，避免同相位同时重连造成尖峰。</li>
<li><strong>分批恢复：</strong> 将连接恢复按固定批次/时间片发放（如每 100ms 开放 N 个），把尖峰摊平到更长窗口。</li>
<li><strong>服务端限流与排队：</strong> 在握手与认证路径设置并发/速率上限与队列，超限直接返回可重试错误或延迟令牌。</li>
<li><strong>灰度放量：</strong> 按租户/区域/版本逐步提升允许重连比例，结合健康度与错误率自动调节放量速度。</li>
</ul>
<h3 data-id="heading-36">9、前端如何封装一个健壮的 WebSocket 客户端？<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce94c88ac24a4e95a110b4c495a23f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763906105&amp;x-signature=Qzn4d08ANP%2B9NwdDG2jnn06wgkw%3D" alt="" loading="lazy"/></h3>
<ul>
<li><strong>状态机（</strong> <code>CONNECTING</code> <strong>/</strong> <code>OPEN</code> <strong>/</strong> <code>CLOSING</code> <strong>/</strong> <code>CLOSED</code> <strong>）：</strong> 用有限状态机驱动所有事件与迁移，单航道控制避免并发重连与回调竞态。</li>
<li><strong>心跳/重连策略：</strong> 按固定心跳探活与半开检测，重连采用指数退避叠加随机抖动并设上限与冷却期。</li>
<li><strong>消息序列化：</strong> 统一 envelope（type/id/ts/payload），默认 JSON，性能敏感时切 Protobuf/MessagePack 并保持向后兼容。</li>
<li><strong>离线缓存与去重：</strong> 未连通时将待发入队、跨刷新用 IndexedDB，按 seq/uuid 去重并用 last-seq 做断点续传。</li>
<li><strong>可观测日志：</strong> 记录连接尝试/关闭码/重连次数/心跳RTT/队列长度等指标与事件，便于快速定位长尾与故障。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代C++：一场静默的革命，告别“C with Classes”]]></title>    <link>https://juejin.cn/post/7572757056438665225</link>    <guid>https://juejin.cn/post/7572757056438665225</guid>    <pubDate>2025-11-16T13:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572757056438665225" data-draft-id="7572880767584337971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代C++：一场静默的革命，告别“C with Classes”"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-16T13:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代C++：一场静默的革命，告别“C with Classes”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T13:59:16.000Z" title="Sun Nov 16 2025 13:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你对C++的印象还停留在复杂的指针操作、令人头疼的内存管理和<code>new</code>/<code>delete</code>的泥潭中，那么是时候更新你的认知了。今天的C++已经经历了一场深刻的“现代化”革命，它变得更安全、更高效、更优雅。</p>
<h4 data-id="heading-0"><strong>一、 “现在C++”指什么？</strong></h4>
<p>“现在C++”通常指的是<strong>C++11及之后的标准</strong>（C++14, C++17, C++20, C++23...）。这是一个重要的分水岭。</p>
<ul>
<li><strong>C++11的发布（2011年）</strong>：这被视为现代C++的起点。它引入了如此之多颠覆性的新特性，以至于Bjarne Stroustrup（C++之父）称其为“一门新语言”。</li>
<li><strong>持续演进</strong>：之后，C++标准委员会转向了每三年发布一个新标准的“火车时刻表”模式，使得语言能够持续、稳定地吸收新思想和社区需求。</li>
</ul>
<p>因此，当有人谈论“现代C++”时，他们指的是一套遵循新标准、利用新特性来编写代码的理念和实践。</p>
<h4 data-id="heading-1"><strong>二、 现代C++与早期C++的核心区别</strong></h4>
<p>这场革命并非只是增加几个新关键字，而是从核心层面改变了我们编写C++代码的方式。以下是几个最关键的转变：</p>
<p><strong>1. 内存管理的革命：从“手动”到“自动”</strong></p>
<p>这是最显著的进步。早期C++严重依赖<code>new</code>和<code>delete</code>，内存泄漏和悬空指针是程序员的噩梦。</p>
<ul>
<li>
<p><strong>早期C++</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp">MyClass* obj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">MyClass</span>();
<span class="hljs-comment">// ... 使用 obj</span>
<span class="hljs-keyword">delete</span> obj; <span class="hljs-comment">// 必须手动释放，否则内存泄漏</span>
</code></pre>
</li>
<li>
<p><strong>现代C++</strong>：
引入了<strong>智能指针</strong>（<code>std::unique_ptr</code>, <code>std::shared_ptr</code>），它们利用RAII（资源获取即初始化）理念，在对象析构时自动释放资源。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-keyword">auto</span> obj = std::<span class="hljs-built_in">make_unique</span>&lt;MyClass&gt;(); <span class="hljs-comment">// 无需手动delete</span>
<span class="hljs-comment">// 当obj离开作用域时，内存会自动被释放</span>
</code></pre>
<p><strong>区别</strong>：手动管理 -&gt; 自动生命周期管理，从根本上减少了内存错误。</p>
</li>
</ul>
<p><strong>2. 语言核心的现代化：更简洁，更强大</strong></p>
<p>现代C++提供了大量语法糖和新特性，让代码更清晰、表达能力更强。</p>
<ul>
<li>
<p><strong>自动类型推导（<code>auto</code>）</strong>：</p>
<ul>
<li><strong>早期</strong>：<code>std::vector&lt;int&gt;::iterator it = vec.begin();</code></li>
<li><strong>现代</strong>：<code>auto it = vec.begin();</code> // 编译器自动推导类型
<strong>区别</strong>：代码更简洁，减少了冗余，尤其在模板编程中极为有用。</li>
</ul>
</li>
<li>
<p><strong>基于范围的for循环</strong>：</p>
<ul>
<li><strong>早期</strong>：<code>for (int i = 0; i &lt; vec.size(); ++i) { ... }</code></li>
<li><strong>现代</strong>：<code>for (const auto&amp; element : vec) { ... }</code>
<strong>区别</strong>：更安全（不会越界），更简洁，意图更明确。</li>
</ul>
</li>
<li>
<p><strong>Lambda表达式</strong>：
允许在函数内部定义匿名函数，极大地便利了STL算法的使用。</p>
<pre><code class="hljs language-cpp" lang="cpp">std::<span class="hljs-built_in">sort</span>(vec.<span class="hljs-built_in">begin</span>(), vec.<span class="hljs-built_in">end</span>(), [](<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b) { <span class="hljs-keyword">return</span> a &gt; b; });
</code></pre>
<p><strong>区别</strong>：从必须定义外部函数或函数对象，变为就地定义，代码内聚性更高。</p>
</li>
<li>
<p><strong>移动语义和右值引用（<code>&amp;&amp;</code>）</strong>：
这是C++11最深刻的变革之一。它允许资源的“转移”而非“拷贝”，极大地提升了性能。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">createHugeVector</span><span class="hljs-params">()</span></span>;
std::vector&lt;<span class="hljs-type">int</span>&gt; v = <span class="hljs-built_in">createHugeVector</span>(); <span class="hljs-comment">// 这里发生的是移动构造，而非昂贵的拷贝</span>
</code></pre>
<p><strong>区别</strong>：解决了临时对象带来的不必要的拷贝开销，使得在函数间传递大型对象变得高效。</p>
</li>
</ul>
<p><strong>3. 标准库的极大丰富</strong></p>
<p>现代C++的标准库（STL）已经成为一个功能极其强大的工具箱。</p>
<ul>
<li><strong>新的容器</strong>：<code>std::unordered_map</code>, <code>std::unordered_set</code>（哈希表），提供了平均O(1)的查找性能。</li>
<li><strong>多线程支持</strong>：早期C++没有标准线程库，依赖平台API（如pthread）。现代C++内置了<code>std::thread</code>, <code>std::mutex</code>, <code>std::async</code>等，使得编写跨平台并发程序变得简单。</li>
<li><strong>正则表达式、随机数库、时间库</strong>等常用功能都被纳入标准，不再需要寻找第三方库。</li>
</ul>
<p><strong>4. 面向“最佳实践”编程</strong></p>
<p>现代C++的特性引导开发者走向更安全的编程范式。</p>
<ul>
<li><strong><code>nullptr</code>替代<code>NULL</code></strong>：提供了类型安全的空指针。</li>
<li><strong><code>constexpr</code></strong>：允许在编译期计算，提升性能。</li>
<li><strong>类型系统增强</strong>：如<code>enum class</code>替代传统枚举，避免了命名污染和隐式转换。</li>
<li><strong>概念（C++20）</strong>：为模板参数添加约束，使得模板错误信息更友好，代码更健壮。</li>
</ul>
<h4 data-id="heading-2"><strong>总结：思维模式的转变</strong></h4>













































<table><thead><tr><th align="left">特性</th><th align="left">早期C++（C++98/03）</th><th align="left">现代C++（C++11及以后）</th></tr></thead><tbody><tr><td align="left"><strong>内存管理</strong></td><td align="left">手动<code>new</code>/<code>delete</code></td><td align="left">智能指针，自动管理</td></tr><tr><td align="left"><strong>类型声明</strong></td><td align="left">显式写出冗长类型</td><td align="left">广泛使用<code>auto</code></td></tr><tr><td align="left"><strong>循环</strong></td><td align="left">传统<code>for</code>循环索引</td><td align="left">基于范围的<code>for</code>循环</td></tr><tr><td align="left"><strong>函数对象</strong></td><td align="left">需要定义独立的函数或仿函数</td><td align="left">使用Lambda表达式就地定义</td></tr><tr><td align="left"><strong>性能优化</strong></td><td align="left">主要依赖引用减少拷贝</td><td align="left"><strong>移动语义</strong>转移资源所有权</td></tr><tr><td align="left"><strong>并发</strong></td><td align="left">依赖平台特定API</td><td align="left">使用标准库<code>std::thread</code></td></tr><tr><td align="left"><strong>核心理念</strong></td><td align="left">“C with Classes”，贴近底层</td><td align="left">高级抽象与底层控制并存，安全与效率兼得</td></tr></tbody></table>
<p><strong>结论</strong></p>
<p>现代C++并没有抛弃其“零开销抽象”和高效的核心原则，而是通过提供更高级、更安全的工具，让程序员能够更轻松地写出正确、高效且易于维护的代码。它已经从一门需要极高技巧和细心来规避陷阱的语言，演变为一门既强大又相对“友好”的工业级语言。</p>
<p>如果你是一位C++老手，拥抱现代C++意味着提升生产力和代码质量。如果你是一位新手，那么你很幸运，可以从这些现代化的特性开始学习，避开前辈们踩过的许多“坑”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter,Compose,Web 在Android平台上从布局到屏幕的机制探究]]></title>    <link>https://juejin.cn/post/7572480736362266630</link>    <guid>https://juejin.cn/post/7572480736362266630</guid>    <pubDate>2025-11-16T12:41:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736362266630" data-draft-id="7572525491538821162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter,Compose,Web 在Android平台上从布局到屏幕的机制探究"/> <meta itemprop="keywords" content="Flutter,Android,WebView"/> <meta itemprop="datePublished" content="2025-11-16T12:41:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="apigfly"/> <meta itemprop="url" content="https://juejin.cn/user/2488950054453613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter,Compose,Web 在Android平台上从布局到屏幕的机制探究
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2488950054453613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    apigfly
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T12:41:46.000Z" title="Sun Nov 16 2025 12:41:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>最近用到了 Flutter 做跨平台项目，比较好奇跨平台项目是怎么能够在 Android 设备上显示出来的，就有了今天的文章，因为之前写的 <a href="https://juejin.cn/post/6944960866404007944" target="_blank" title="https://juejin.cn/post/6944960866404007944">Android 图形显示系统</a> ，也算是承上启下了吧，毕竟这么多年没更啦</p>
</blockquote>
<h2 data-id="heading-0"><strong>1. 核心架构基础：Android 图形栈与数据流</strong></h2>
<p>理解任何 Android UI 组件的渲染过程，都必须从操作系统的底层图形架构开始，特别是缓冲区管理、Surface 抽象以及系统合成器的功能。</p>
<h3 data-id="heading-1"><strong>1.1. Android 渲染数据流：BufferQueue, Surface 与 Layer 模型</strong></h3>
<p>Android 图形系统基于<code>生产者-消费者</code>模型。
在这种模型中，应用或其渲染引擎被视为<code>生产者</code>，而系统合成器 <code>SurfaceFlinger</code> 则充当<code>消费者</code>。具体大家可以看之前的文章：<a href="https://juejin.cn/post/6944960866404007944#heading-0" target="_blank" title="https://juejin.cn/post/6944960866404007944#heading-0">显示原理</a></p>
<p>简要示意图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eb1d3858e0a4552bdcf7f7ab7935270~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763902138&amp;x-signature=dv7A%2FgboMU5H0jYcGQ0o2kt6evw%3D" alt="graphics-pipeline.png" loading="lazy"/></p>
<h4 data-id="heading-2"><code>BufferQueue</code></h4>
<p>数据交换的核心。这是一个先进先出（FIFO）队列，位于 <code>libgui IPC</code> 库中，用于跨进程安全地传输图形缓冲区。</p>
<p><code>生产者</code>负责向队列中写入已渲染的帧，而<code>消费者</code>则从队列中取出帧进行合成。
这种机制的设计目标是确保数据的原子性传输和同步。</p>
<p><code>消费者</code>通常是 Android 的核心合成器 <code>SurfaceFlinger</code>，但也可以是其他组件，例如 <code>SurfaceView</code>、<code>SurfaceTexture</code> 或 <code>ImageReader</code>。</p>
<h4 data-id="heading-3"><code>Surface</code></h4>
<p><code>Surface</code> 对象是应用进程用于与 <code>BufferQueue</code> 交互的高级 API 接口。
它本身并不存储像素数据，而是持有一个对底层 <code>IGraphicBufferProducer</code> 接口的引用。
这个接口允许应用跨进程将渲染完成的图形缓冲区排队等待消费。</p>
<h4 data-id="heading-4"><code>Layer</code></h4>
<p><code>Layer</code> 是 <code>SurfaceFlinger</code> 内部用于合成的基本单位。
它与 <code>Surface</code> 不同，<code>Surface</code> 专注于像素内容的生产，而 <code>Layer</code> 专注于该内容的合成方式。
一个 <code>Layer</code> 封装了合成所需的全部元数据和状态信息，包括：Z 轴顺序（决定遮挡关系）、可见性、混合模式（Alpha 混合）、裁剪区域、完整的 2D/3D 转换矩阵（Translation, Rotation, Scale）。</p>
<h4 data-id="heading-5">零拷贝优化</h4>
<p>现代 Android 图形系统严重依赖 <code>AHardwareBuffer (API 26+)</code> 来实现高性能、低延迟的图形数据传输。<br/>
<code>AHardwareBuffer</code> 代表一种硬件支持的缓冲区，可以高效地在不同系统组件和进程之间共享，通常用于实现零拷贝操作。<br/>
<code>AHardwareBuffer</code>支持多层纹理数组和立方体贴图的定义，特别适用于 Vulkan 后端或跨进程图形传输<br/>
<code>WebView</code> 的进程外光栅化（OOPR）就需要利用<code>AHardwareBuffer</code>机制实现高效的缓冲区共享。</p>
<p><strong>生产者与消费者的“距离”与隔离</strong>
<code>BufferQueue</code> 机制的核心价值在于，它使得<code>生产者</code>和<code>消费者</code>能够在不同的线程甚至不同的进程中独立、并行地运行。这种隔离性是 Android 实现流畅 UI 和高保真媒体播放的关键：</p>
<ol>
<li><strong>线程隔离（距离近）：</strong> 生产者（如应用中的 RenderThread 或 GLSurfaceView 的专用渲染线程）可以在高频下（如 60FPS）渲染，而不会阻塞接收该缓冲区的消费者（通常是 <code>SurfaceFlinger</code>）。这确保了渲染任务不会拖累应用的主 UI 线程。</li>
<li><strong>进程隔离（距离远）：</strong> <code>Surface</code> 对象实现了 <code>Parcelable</code> 接口，因此可以安全地通过 <code>Binder IPC</code> 机制跨越进程边界传输。这种能力使得一个独立进程的渲染结果能够直接提交给另一个进程中的接收者（例如 <code>SurfaceFlinger</code> 或 <code>SurfaceView</code>）。</li>
</ol>
<p><strong>SF 之外的消费者 (应用程序主动选择的数据处理流)</strong></p>
<ol>
<li><strong>SurfaceTexture (GPU 纹理消费者):</strong>
<ul>
<li><strong>场景：</strong> 实时相机预览、将视频流作为纹理应用到 3D 游戏或 AR 场景中。</li>
<li><strong>机制：</strong> <code>SurfaceTexture</code> 充当 <code>BufferQueue</code> 的消费者。它接收生产者（如相机驱动或视频解码器）提交的帧数据，并将其转换为一个 <strong>OpenGL ES 纹理</strong>，供应用内的 GLES 线程绑定和使用。这允许开发者在 GPU 上直接处理这些数据（例如应用滤镜、进行几何变换），<strong>而无需将数据提交给 SurfaceFlinger 进行系统合成</strong>。这种路径允许应用在本地 GPU 上完成渲染和处理，但最终如果需要显示，应用通常需要将这个<strong>处理后的纹理</strong>绘制到自己的主 <code>Surface</code> 上（最终仍由 SF 合成）。</li>
</ul>
</li>
<li><strong>ImageReader (数据处理消费者):</strong>
<ul>
<li><strong>场景：</strong> 截屏、图像分析（如人脸识别）、自定义相机捕获原始帧。</li>
<li><strong>机制：</strong> ImageReader 也充当 BufferQueue 的消费者。它允许应用程序从队列中获取图像数据（Image 对象），通常是原始像素数据。数据随后被发送到应用的 CPU/NDK 层，用于进一步的软件处理、分析或保存，<strong>完全绕过了 Android 的硬件加速显示路径</strong>，是纯粹的数据获取和处理通道。</li>
</ul>
</li>
</ol>
<p><strong>SF 跨进程/跨线程能力的常见示例 (显示场景)</strong></p>
<ul>
<li><strong>视频播放 (SurfaceView 场景):</strong>
<ul>
<li><strong>生产者：</strong> 视频解码器（通常是运行在独立进程中的硬件或系统服务）。</li>
<li><strong>消费者：</strong> SurfaceFlinger。</li>
<li><strong>优势：</strong> 解码器将视频帧直接绘制到从 SurfaceView 获得的 Surface 上。由于 SurfaceFlinger 直接从 BufferQueue 获取缓冲区，整个过程<strong>完全绕过了应用的主 CPU/GPU 管线</strong>。这实现了零拷贝的数据路径，对高吞吐量的视频帧传输至关重要，确保了低延迟和低功耗。</li>
</ul>
</li>
<li><strong>多窗口/系统 UI 合成 (SurfaceFlinger 核心功能):</strong>
<ul>
<li><strong>生产者：</strong> 应用 A 的主渲染 Layer (Native View/Compose 的 RenderThread 提交)；应用 B 的独立 Layer；系统状态栏和导航栏 Layer。</li>
<li><strong>消费者：</strong> SurfaceFlinger。</li>
<li><strong>优势：</strong> SurfaceFlinger 接收来自<strong>多个不同应用进程</strong>和<strong>系统进程</strong>的独立 Layer，并管理它们的 Z 轴顺序、位置和变换。这种隔离确保了即使一个应用崩溃，也不会影响其他应用或系统 UI 的显示。</li>
</ul>
</li>
<li><strong>进程外 WebView 渲染 (OOPR 模式):</strong>
<ul>
<li><strong>生产者：</strong> 沙箱隔离的 Chrome Render Process（一个独立进程）。</li>
<li><strong>消费者：</strong> SurfaceFlinger。</li>
<li><strong>优势：</strong> WebView 的内容渲染发生在应用主进程之外。渲染进程将结果提交到专用的 Surface 缓冲区，SurfaceFlinger 将其作为独立 Layer 合成。这提供了极佳的安全性和稳定性隔离，即使 Web 内容中的 JavaScript 导致渲染进程崩溃，主机应用也可以通过回调机制恢复。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6"><strong>1.2. 系统合成器：<code>SurfaceFlinger</code> 与硬件合成器 (<code>HWC</code>) 的角色</strong></h3>
<p><code>SurfaceFlinger (SF)</code> 是 Android 的核心系统服务，充当所有可见 UI 元素的最终合成器。</p>
<h4 data-id="heading-7"><code>SurfaceFlinger (SF)</code> 的职责</h4>
<p><code>SF</code> 接收来自所有可见窗口和系统 UI 组件的图形缓冲区，这些缓冲区通过 <code>Layer</code> 的形式提交给 <code>SF</code> 。<br/>
<code>SF</code> 的任务是：</p>
<ul>
<li>管理所有 <code>Layer</code> 的 Z 轴顺序、位置、变换和剪裁。</li>
<li>根据 <code>Layer</code> 的属性（例如透明度、相对 Z 轴、圆角等）决定如何进行合成。</li>
<li>将最终合成的结果发送给显示硬件。</li>
</ul>
<h4 data-id="heading-8"><code>SurfaceFlinger</code> 的核心地位</h4>
<p>无论采用哪种渲染技术栈（<code>Native View</code>, <code>Compose</code>, <code>Flutter</code>, <code>WebView</code>, <code>GLSurfaceView</code>），它们最终都必须通过各自的 <code>Surface</code> 接口向 <code>BufferQueue</code> 提交渲染完成的图形缓冲区。<br/>
因此，可以确定，在 Android 平台上，所有五种技术路线的渲染结果，都会以独立的或应用主 Layer 的形式，统一由 <code>SurfaceFlinger</code> 来接收和处理，这是它们最终得以在屏幕上显示的必经之路。</p>
<h4 data-id="heading-9">硬件合成器 (HWC) 优化</h4>
<p>为了最大化性能和降低功耗，<code>SurfaceFlinger</code> 倾向于将合成任务卸载给硬件合成器（<code>Hardware Composer, HWC</code>）。<br/>
<code>HWC</code> 是一个 SoC 厂商实现的 HAL（硬件抽象层）模块，能够直接处理 Layer 的合成，通常以零拷贝的方式操作缓冲区。这极大地提高了效率。<br/>
只有当 <code>Layer</code> 具有复杂的混合、变换或特效，<code>HWC</code> 无法直接处理时，<code>SF</code> 才会退回到使用 GPU 进行合成（GPU Compositing），这会增加系统的渲染开销。</p>
<h3 data-id="heading-10"><strong>1.3. 绘制指令模式对比：即时与保留</strong></h3>
<p>UI 框架在生成绘图指令时，主要遵循两种模式：保留模式 (Retained Mode) 和即时模式 (Immediate Mode)。</p>
<h4 data-id="heading-11">保留模式 (Retained Mode)</h4>
<p>在这种模式下，UI 元素的结构和属性被存储为一个场景图或对象层级结构（在 Android <code>Native/Compose</code> 中称为 <code>RenderNode</code> 或 <code>Display List</code>）。当 UI 状态发生变化时，系统只需更新场景图中发生变化的部分，而不是重新执行所有绘图指令。这种模式非常适合动态或频繁变化的 UI，因为它允许更灵活和高效的更新 。Android Native Views 和 Jetpack Compose 都是基于保留模式的实现。</p>
<h4 data-id="heading-12">即时模式 (Immediate Mode)</h4>
<p>在这种模式下，每一次帧更新，应用程序都需要重新发送完整的绘图指令序列。系统不存储 UI 状态图。即时模式要求开发者对底层的图形 API（如 OpenGL ES 或 Skia Canvas）有更直接的控制。它在静态 UI 中可能资源占用较少，但在动态 UI 中可能性能较差，除非底层引擎进行了高效优化（如 Flutter 的 Skia）。<br/>
GLSurfaceView 和 Flutter 的核心渲染流程属于即时模式。</p>
<p><strong>绘制模式 (Immediate vs. Retained) 特性对比</strong></p>






























<table><thead><tr><th align="left">特性</th><th align="left">保留模式 (Retained Mode)</th><th align="left">即时模式 (Immediate Mode)</th></tr></thead><tbody><tr><td align="left"><strong>核心机制</strong></td><td align="left">场景图/显示列表 (RenderNode) 存储状态</td><td align="left">立即执行绘图指令，不存储状态</td></tr><tr><td align="left"><strong>更新效率</strong></td><td align="left">高效 (仅重绘变动部分)</td><td align="left">依赖框架/引擎 (Skia 优化了底层效率)</td></tr><tr><td align="left"><strong>线程隔离</strong></td><td align="left">RenderThread 机制提供原生的 CPU/GPU 隔离</td><td align="left">需用户/引擎自行实现专用 Raster/GLES 线程</td></tr><tr><td align="left"><strong>代表技术</strong></td><td align="left">Android Native View, Jetpack Compose</td><td align="left">Flutter (Skia), GLSurfaceView</td></tr></tbody></table>
<h2 data-id="heading-13"><strong>2. 保留模式下的原生 UI 渲染管线：Native View 与 Compose</strong></h2>
<p>Android 原生 UI 框架（无论是基于 View 还是 Compose）都依赖于 AOSP 的保留模式渲染架构，核心在于 <code>RenderThread</code>。</p>
<h3 data-id="heading-14"><strong>2.1. Android 原生 View 渲染流程：Record, Execute 与 RenderThread</strong></h3>
<p>当 <code>View</code> 层次结构需要更新时，渲染流程在应用进程内分两个主要阶段进行：</p>
<h4 data-id="heading-15">1. UI 线程：记录 (<code>Record</code>) 阶段</h4>
<p>UI 线程（或主线程）负责所有的业务逻辑、布局计算（Measure 和 Layout），以及绘图指令的记录。在硬件加速开启的前提下，<code>View#draw(Canvas)</code>的调用不会直接执行 GPU 渲染，而是将绘图操作记录到关联的 <code>RenderNode</code>（即 <code>Display List</code>）中。</p>
<ul>
<li><strong>性能风险：</strong> 尽管记录 Display List 通常很快，但如果应用代码在此阶段涉及复杂的 CPU 密集型操作，例如绘制到 Bitmap（这会触发 CPU 软件渲染），则会占用 UI 线程时间，可能导致帧率下降（<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F476477559" target="_blank" title="https://zhuanlan.zhihu.com/p/476477559" ref="nofollow noopener noreferrer">Jank指标</a>）。</li>
</ul>
<h4 data-id="heading-16">2. RenderThread：执行 (Execute) 阶段</h4>
<p><code>RenderThread</code> 是一个系统管理的新线程，自 Android Lollipop 引入，旨在将 GPU 相关的重型工作负载从 UI 线程分离出来。</p>
<ul>
<li><strong>JANK 隔离：</strong> <code>RenderThread</code> 的核心价值在于，即使 UI 线程被阻塞（例如，因垃圾回收或复杂业务逻辑），它仍能继续执行先前提交的 Display List，从而保持动画、触摸反馈和 <code>Material Design</code> 特效（如涟漪效果）的平滑运行。</li>
<li><strong>执行与优化：</strong> <code>RenderThread</code> 接收 UI 线程提交的 <code>RenderNode</code>，负责对指令进行优化（例如，批处理），将它们翻译成低级的 GPU API 调用（GLES 或 Vulkan），并最终通过 <code>eglSwapBuffers()</code> 提交到 <code>Surface</code> 的 <code>BufferQueue</code> 中。</li>
<li><strong>潜在的性能陷阱：</strong> 某些 <code>Canvas</code> 操作，如绘制非常大的或复杂的 <code>Path</code> 对象，在 UI 线程上的记录成本很低，但在 <code>RenderThread</code> 执行时可能触发昂贵的 CPU 或 GPU 计算，导致 <code>RenderThread</code> 成为新的瓶颈。系统分析工具（如 Systrace）常用于识别这类问题。</li>
</ul>
<p><strong>渲染驱动逻辑与 VSync 依赖</strong></p>
<ul>
<li><strong>渲染线程：</strong> 专用 <code>RenderThread</code>。</li>
<li><strong>驱动机制：</strong> <strong>强依赖 VSync 信号。</strong> 当应用需要渲染时，系统会向 <code>Choreographer</code> 注册一个回调，等待 <code>VSync</code> 信号的到来。</li>
<li><strong>频率控制：</strong> 渲染频率主要由系统 <code>VSync 频率</code>（通常 60Hz 或 120Hz）控制。应用通过 <code>View.invalidate()</code> 标记 <code>View</code> 为脏，但实际的绘制执行始终与 <code>VSync</code> 同步，以避免画面撕裂。</li>
</ul>
<h4 data-id="heading-17">原生 View 渲染流程</h4>
<p>时序图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/798ae6ffa43b42c194fe7292b8475ea0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763902138&amp;x-signature=0lmRV1St0QkWybG1WhxQYVmJK%2BA%3D" alt="image.png" loading="lazy"/></p>
<p>该流程描述了 Native View 从输入事件到最终显示的序列：</p>
<ol>
<li><strong>Application UI Thread：</strong> 执行 <code>View</code> 层次结构的 <code>Measure</code> &amp; <code>Layout</code> 阶段，确定所有组件的尺寸和位置。</li>
<li><strong>Application UI Thread：</strong> 执行 <code>Record</code> 阶段，调用 <code>View#draw</code>，将所有绘图操作（如绘制文本、形状）记录到 <code>RenderNode (Display List)</code> 中。</li>
<li><strong>Application UI Thread -&gt; RenderThread：</strong> 分发记录好的 <code>RenderNode</code> 数据到独立的 <strong>RenderThread</strong>。</li>
<li><strong>RenderThread：</strong> 优化 <code>RenderNode</code> 中的指令，将其转化为低级 GPU 调用 (GLES 或 Vulkan)。</li>
<li><strong>RenderThread -&gt; GPU：</strong> 发出 <strong>光栅化指令</strong>，在 <code>VSync</code> 信号驱动下，在应用独占的缓冲区中绘制 View 的像素内容。<strong>此步骤在应用进程内完成所有 UI 元素的绘制。</strong></li>
<li><strong>RenderThread -&gt; SurfaceFlinger：</strong> 通过 <code>EGLSurface</code> 调用 <code>eglSwapBuffers()</code>，将绘制完成的缓冲区提交给系统合成器<code>SF</code>。</li>
<li><strong>SurfaceFlinger/HWC：</strong> 接收应用缓冲区，进行 <strong>系统级合成 (Composition)</strong> 和最终显示。<code>HWC</code> 确定最佳合成路径，将此 <code>Layer</code> 与状态栏、导航栏、其他应用窗口等所有 <code>Layer</code> 合并，并最终显示到屏幕上。</li>
</ol>
<h3 data-id="heading-18"><strong>2.2. Jetpack Compose 渲染管线：声明式与 GraphicsLayer 优化</strong></h3>
<p><code>Jetpack Compose</code> 采用了声明式 UI 模型，其渲染管线遵循 <code>Composition</code>（节点创建）、<code>Measure</code>、<code>Layout</code>，最终到达 <code>Drawing</code> 阶段。尽管其编程范式发生了根本性变化，但在 Android 平台上，<code>Compose</code> 最终仍复用 <code>Native View</code> 的底层硬件加速机制。</p>
<h4 data-id="heading-19"><code>Draw</code> 阶段与 <code>Canvas</code> 的关联</h4>
<p><code>Compose</code> 框架在 <code>Draw</code> 阶段，底层仍然依赖于 <code>View</code> 系统的 <code>Canvas API</code> 进行实际的像素操作 。<br/>
然而，<code>Compose</code> 通过 <code>DrawScope</code> 抽象简化了传统的 <code>View</code> 绘图模型，例如替开发者管理复杂的 <code>Paint</code> 对象配置，确保性能优化。<br/>
<strong>GraphicsLayer 与 RenderNode 的复用</strong><br/>
<code>Compose</code>通过 <code>Modifier.graphicsLayer</code> 引入了与 <code>Native View</code> 中 <code>RenderNode</code> 相似的概念 。<br/>
使用 <code>graphicsLayer</code> 意味着 <code>Composable</code> 组件的绘图指令会被捕获并缓存到一个 <code>Layer</code> 中 。</p>
<ul>
<li><strong>性能收益：</strong> 这种缓存机制允许渲染管线高效地重发这些绘图指令，尤其适用于频繁的几何变换、透明度变化或缩放动画。一旦指令被捕获，RenderThread 可以在不依赖 UI 线程重新执行 Composable 代码的情况下，重复执行这些已缓存的指令。</li>
</ul>
<h4 data-id="heading-20">Offscreen Rasterization (离屏光栅化)</h4>
<p><code>graphicsLayer</code> 的进一步优化是离屏光栅化，也被称为纹理缓存。<br/>
在这种情况下，<code>RenderThread</code> 会执行 <code>RenderNode</code> 中的指令，并将结果捕获到一个离屏 GPU 纹理中。<br/>
在后续的帧中，<code>RenderThread</code> 只需要发送一个简单的指令：“绘制这个纹理”，这极大减少了 CPU 和 GPU 的重复计算，尤其对于复杂的、不常变化的组件（如 <code>LazyList</code> 中滚动的条目）的性能优化至关重要。</p>
<h4 data-id="heading-21">渲染管线性能瓶颈聚焦</h4>
<p>原生 View 和 Compose 共享 RenderThread 执行管线，这表明它们的 GPU 性能优化途径是相似的。它们的主要性能差异体现在 UI 线程的记录阶段：</p>
<ul>
<li>原生 View 的性能瓶颈通常集中在传统的 View 层次结构遍历和 Measure/Layout 效率上。</li>
<li>Compose 的性能瓶颈则集中在 Composition/Recomposition 逻辑的效率和状态管理上。<br/>
即使 RenderThread 隔离了 GPU 执行，如果 Composition 或 Layout 阶段耗时超过每帧预算（例如 16ms），UI 线程的阻塞仍会导致新的 RenderNode 无法及时提交，从而引发 JANK。因此，无论是 Native 还是 Compose，优化策略的重点都必须放在减少 UI 线程的负载上。</li>
</ul>
<p><strong>渲染驱动逻辑与 VSync 依赖</strong></p>
<ul>
<li><strong>渲染线程：</strong> 共享 AOSP 的 RenderThread。</li>
<li><strong>驱动机制：</strong> <strong>强依赖 VSync 信号。</strong> Compose 状态（State）变化触发 UI 线程的重组和布局计算。RenderThread 的光栅化执行（绘制）同样严格对齐 VSync 脉冲。</li>
<li><strong>频率控制：</strong> 无法直接控制。频率由系统 VSync 确定。Compose 仅在需要时（状态改变）才触发新的帧提交。</li>
</ul>
<h4 data-id="heading-22">Jetpack Compose 渲染流程</h4>
<p>时序图：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb044636c992468d8eb5196c5104a544~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763902138&amp;x-signature=Gsih9xpjFxOn3PZdMsAjsDkgJmk%3D" alt="image.png" loading="lazy"/></p>
<p>该流程描述了 Compose 从状态变化到渲染的序列：</p>
<ol>
<li><strong>UI Thread (Composition/Layout)：</strong> 执行 <strong>Composition</strong> 阶段，根据状态（State）变化确定需要创建、更新或跳过哪些 UI 节点。</li>
<li><strong>UI Thread (Composition/Layout)：</strong> 执行 <strong>Measure &amp; Layout</strong> 阶段，确定所有 Composable 组件的最终尺寸和屏幕位置。</li>
<li><strong>UI Thread (Composition/Layout)：</strong> 执行 <strong>Draw Phase</strong>，捕获绘图操作，并将其存储在 GraphicsLayer 中。</li>
<li><strong>UI Thread -&gt; RenderThread：</strong> 将封装了绘图指令的 RenderNode/GraphicsLayer 提交给 RenderThread。</li>
<li><strong>RenderThread -&gt; GPU：</strong> <strong>RenderThread</strong> 在 VSync 驱动下，在 GPU 上执行光栅化指令，包括处理离屏纹理缓存等优化，在应用 Surface 缓冲区中绘制 Composable UI 像素。</li>
<li><strong>RenderThread -&gt; SurfaceFlinger：</strong> 调用缓冲区交换函数，提交渲染完成的帧缓冲区。</li>
<li><strong>SurfaceFlinger：</strong> 接收缓冲区，执行系统级合成，并最终交给 HWC 进行显示。</li>
</ol>
<h2 data-id="heading-23"><strong>3. 即时模式与专用渲染管线：Flutter 与 GLSurfaceView</strong></h2>
<p>与依赖 <code>AOSP</code> <code>RenderThread</code> 的 <code>Native/Compose</code> 不同，<code>Flutter</code> 和 <code>GLSurfaceView</code> 使用即时模式渲染，并创建了独立于 <code>AOSP</code> 图形栈的专用渲染环境。</p>
<h3 data-id="heading-24"><strong>3.1. Flutter View 渲染管线</strong></h3>
<p><code>Flutter</code> 在 Android 上运行于一个名为 <code>Flutter Embedder</code> 的 C++ 组件中，并管理着一组专用的线程：平台线程（负责与宿主 OS 通信）、UI 线程（运行 Dart 逻辑和 Widget 树构建），以及关键的 Raster Thread（栅格化线程）。</p>
<h4 data-id="heading-25">双线程模型</h4>
<p><code>Flutter</code> 的高性能渲染基于其严格隔离的双线程模型：</p>
<ol>
<li><strong>Dart UI Thread：</strong> 负责处理应用逻辑、Widget 构建、Element Tree 维护、Render Tree 创建以及布局计算。</li>
<li><strong>Flutter Raster Thread (也称 GPU Thread)：</strong> 这是一个专用的 C++ 线程，负责将 Dart UI Thread 生成的 Layer Tree 传递给 Flutter 引擎。Flutter 引擎在此线程上将高层级绘图指令翻译成低层级的 GPU/CPU 指令，执行光栅化，并利用 GPU 加速，确保高效渲染。</li>
</ol>
<blockquote>
<p>Flutter 的 UI 线程负责构建高层次的 Layer Tree。然后，Raster Thread 专门负责消耗这个 Layer Tree，并使用其集成的 Skia 或更新的 Impeller 渲染引擎生成低级图形命令。</p>
</blockquote>
<blockquote>
<p>Impeller 旨在通过提前编译着色器等方式，进一步优化移动 GPU 性能</p>
</blockquote>
<h4 data-id="heading-26">即时模式与底层优化</h4>
<p><code>Flutter Android Embedder</code> 负责与 Android 系统进行底层交互。它为 Flutter 的输出获取一个专用的 Android <code>Surface</code>，为 <code>Raster Thread</code> 设置必要的 <code>EGL</code> 或 <code>Vulkan</code> 上下文，并处理低级的缓冲区提交逻辑。</p>
<p><code>Skia/Impeller</code> 最终将整个应用 UI 渲染到一个 <code>Surface</code> 中，作为 Android 系统的一个独立 <code>Layer</code> 提交给 <code>SurfaceFlinger</code>。</p>
<p>虽然 <code>Flutter</code> 在 <code>Dart</code> 侧的 <code>Widget</code> 构建和 <code>Render Tree</code> 创建可以被视为每帧都可能重新发生的即时模式行为，但 <code>Skia/Impeller</code> 在底层对这些指令进行高度优化、批处理和硬件加速。</p>
<h4 data-id="heading-27">渲染架构的独立性</h4>
<p>Flutter <code>Raster Thread</code> 的存在绕过了 AOSP 的 <code>RenderThread</code> 机制。这赋予了 <code>Flutter Engine</code> 对渲染管线的完全控制权和跨平台性能的确定性。</p>
<p>这种架构决策避免了与原生 View 系统的复杂交互，但代价是在集成原生组件时需要引入额外的桥接层和合成模式，如 <code>Platform Views</code>。</p>
<p><strong>渲染驱动逻辑与 VSync 依赖</strong></p>
<ul>
<li><strong>渲染线程：</strong> 独立于 AOSP 的 <code>Raster Thread</code> (C++ 实现)。</li>
<li><strong>驱动机制：</strong> <code>Flutter Engine</code> 内部具备自己的调度器，但它会监听和对齐<strong>平台 VSync 信号</strong>，以确保渲染帧与显示器的刷新率同步（目标 60 FPS 或 120 FPS）。渲染工作在 UI Thread 和 <code>Raster Thread</code> 之间分工。</li>
<li><strong>频率控制：</strong> 由 <code>Skia/Impeller</code> 控制，同步于系统 <code>VSync</code> 频率。</li>
</ul>
<h4 data-id="heading-28"><strong>Flutter Platform Views 的集成方案深度对比</strong></h4>
<p>Flutter Engine 作为一个完全独立的渲染引擎，当需要嵌入原生 Android View（如 MapView 或 WebView）时，必须采用特殊的机制来桥接 Flutter 的 Raster Thread 与 Android 的 Surface 机制。</p>
<p>Flutter 提供了两种核心渲染机制，选择哪一种取决于对原生组件保真度、Flutter 动画性能以及是否需要 Flutter 侧变换的需求。</p>























<table><thead><tr><th align="left">模式</th><th align="left">适用场景/优势</th><th align="left">限制/劣势</th><th align="left">选择判断</th></tr></thead><tbody><tr><td align="left"><strong>Hybrid Composition (HC)</strong></td><td align="left"><strong>原生视图保真度和性能至上：</strong> 适用于对输入处理、本地视图生命周期和渲染保真度要求极高（接近原生体验）的组件。它提供<strong>最佳的 Android View 性能和保真度</strong></td><td align="left"><strong>牺牲 Flutter 性能：</strong> 由于 SurfaceFlinger 需要进行系统级合成，Flutter UI 的 FPS 会有所降低 <strong>不支持 Flutter 侧变换：</strong> 无法对嵌入的原生视图应用所有 Flutter Widget 的几何变换、透明度或裁剪效果。</td><td align="left"><strong>原生 View 包含 SurfaceView</strong> (如视频、相机)，且原生视图性能优先于 Flutter 动画流畅度。</td></tr><tr><td align="left"><strong>Texture Layer (TLHC)</strong></td><td align="left"><strong>Flutter 动画和变换能力至上：</strong> 适用于需要对嵌入的 View 进行旋转、缩放、裁剪或应用透明度效果的场景。它提供<strong>最佳的 Flutter 渲染性能</strong>。</td><td align="left"><strong>原生视图滚动可能出现卡顿 (Jank)：</strong> 由于将原生 View 渲染到纹理需要额外的处理延迟，快速滚动（如内嵌的 WebView）可能出现卡顿 [17]。SurfaceView 组件在此模式下表现不佳。</td><td align="left"><strong>需要对原生 View 应用 Flutter 侧变换</strong>（如 3D 旋转、裁剪），且原生 View 内容更新频率不高或不需要使用 SurfaceView。</td></tr></tbody></table>
<p><strong>默认机制与自动选择</strong></p>
<ul>
<li><strong>Texture Layer Hybrid Composition (TLHC)</strong> 是目前 Flutter 框架中推荐且默认的 Platform View 渲染模式。</li>
<li><strong>回退机制：</strong> 当原生视图树中包含 SurfaceView 组件时（例如视频播放器、相机预览等），TLHC 模式会遇到困难，系统可能会自动回退到 Hybrid Composition (HC) 模式。</li>
</ul>
<h4 data-id="heading-29">Flutter 渲染架构 (流程描述)</h4>
<p>时序图：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd5ef9e3e3cd4e94a7c95cb5a3be3614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763902138&amp;x-signature=FMKlOo8nbpJ%2BzpZOHwNlhvYu%2F9Y%3D" alt="image.png" loading="lazy"/></p>
<p>该流程描述了 Flutter 引擎的渲染序列：</p>
<ol>
<li><strong>Dart UI Thread (Engine)：</strong> 执行 Widget Tree 的构建，转换为 Element Tree。</li>
<li><strong>Dart UI Thread (Engine)：</strong> 在 VSync 信号开始时，执行 Layout 阶段，计算 Render Tree，最终生成包含 Skia/Impeller 绘图指令的 Layer Tree。</li>
<li><strong>Dart UI Thread -&gt; Raster Thread (Skia/GPU Thread)：</strong> 将 Layer Tree 传输到独立的 Raster Thread。</li>
<li><strong>Raster Thread (Skia/GPU Thread) -&gt; GPU：</strong> <strong>Skia 引擎</strong> 在其专用线程上执行 <strong>光栅化</strong>，将 Layer Tree 指令转换为低级 GPU 调用，在 Flutter 的 Surface 缓冲区中绘制整个 UI 像素内容。</li>
<li><strong>Raster Thread -&gt; SurfaceFlinger (System)：</strong> 提交应用 Surface 缓冲区，作为单一 Layer 提交给系统。</li>
<li><strong>SurfaceFlinger (System)：</strong> 接收 Flutter 的 Layer，进行系统级合成，并最终交给 HWC 显示。</li>
</ol>
<h3 data-id="heading-30"><strong>3.2. <code>GLSurfaceView</code>：面向 <code>GLES</code> 的低层级控制</strong></h3>
<p><code>GLSurfaceView</code> 为需要进行高性能、自定义 GLES 渲染的应用提供了一个直接的接口，如游戏或视频处理。</p>
<h4 data-id="heading-31">EGL 环境与线程要求</h4>
<p><code>GLSurfaceView</code> 的主要功能是管理 <code>GLES</code> 渲染所需的 <code>EGL</code> 环境。这包括在生命周期回调中创建 <code>EGLContext</code> 和 <code>EGLSurface</code> 实例。</p>
<ul>
<li><strong>专用 GLES 线程：</strong> <code>GLES</code> 规范要求所有的绘图操作必须在特定的 <code>GLES</code> 线程上执行，绝对不能在 UI 线程上执行。<code>GLSurfaceView</code> 内部创建了一个专用的渲染线程来满足这一要求，确保了重型 GPU 负载与应用主线程的彻底隔离。</li>
</ul>
<p>即时模式与缓冲区控制<br/>
开发者在 <code>GLES</code> 线程中执行即时模式的绘图指令。当一帧渲染完成后，必须通过调用 <code>eglSwapBuffers()</code> 来明确地提交当前缓冲区。这个方法名源于传统的双缓冲机制，它将渲染好的后台缓冲区提交到前台供消费者使用。</p>
<ul>
<li><strong>帧率控制：</strong> 默认情况下，<code>GLSurfaceView</code> 可能以显示器的刷新率（例如 60fps）连续渲染。然而，通过设置 <code>RENDERMODE_WHEN_DIRTY</code>，开发者可以只在 UI 逻辑或输入事件明确要求时才请求渲染 (<code>requestRender()</code>)，这对于非实时动画或静态场景的电源和性能优化至关重要。</li>
</ul>
<p><strong>渲染驱动逻辑与 VSync 依赖</strong></p>
<ul>
<li><strong>渲染线程：</strong> 专用 Dedicated GLES Thread。</li>
<li><strong>驱动机制：</strong> <strong>可控模式。</strong>
<ul>
<li><strong>RENDERMODE_CONTINUOUSLY：</strong> 渲染循环持续运行，默认与 <code>VSync</code> 对齐，尝试达到最高刷新率。</li>
<li><strong>RENDERMODE_WHEN_DIRTY：</strong> 渲染循环仅在应用明确调用 requestRender() 时执行一帧。</li>
</ul>
</li>
<li><strong>频率控制：</strong> <strong>开发者完全控制。</strong> 可以选择连续渲染（高频/Vsync 约束）或事件驱动渲染（低频/按需）。</li>
</ul>
<h4 data-id="heading-32">GLSurfaceView 渲染流程</h4>
<p>时序图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e20a6d4865e74adc97d21e2272733167~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763902138&amp;x-signature=uflmgBv89AJ4rNSbyG1L0qB%2BBio%3D" alt="image.png" loading="lazy"/></p>
<p>该流程描述了 <code>GLSurfaceView</code> 的渲染序列：</p>
<ol>
<li><strong>Application UI Thread -&gt; Dedicated GLES Thread：</strong> UI 线程在生命周期回调中，请求 <code>GLES</code> 线程设置 <code>EGL</code> 环境，创建 <code>EGLContext</code> 和 <code>EGLSurface</code> 实例。</li>
<li><strong>Application UI Thread -&gt; Dedicated GLES Thread：</strong> UI 线程通过事件或动画循环，触发 GLES 线程调用 <code>requestRender()</code> 或保持连续渲染模式。</li>
<li><strong>Dedicated GLES Thread -&gt; GPU：</strong> 执行用户定义的 OpenGL ES 绘图命令（即时模式），直接利用 GPU <strong>光栅化</strong> 3D/2D 内容到当前的 EGL 缓冲区。<strong>这是开发者对 GPU 绘图的最直接控制</strong>。</li>
<li><strong>Dedicated GLES Thread -&gt; BufferQueue (EGLSurface)：</strong> 调用 <code>eglSwapBuffers()</code>，将刚刚绘制的缓冲区提交给 <code>BufferQueue</code> 消费者。</li>
<li><strong>BufferQueue (EGLSurface) -&gt; SurfaceFlinger (System)：</strong> 缓冲区作为独立 <code>Layer</code> 提交给系统合成器。</li>
<li><strong>SurfaceFlinger (System)：</strong> 将 <code>GLSurfaceView</code> 的独立 Layer 与其他系统 UI 合成，并通过 HWC 显示。</li>
</ol>
<h2 data-id="heading-33"><strong>4. 混合与跨进程渲染：<code>WebView</code> 与 Platform Views</strong></h2>
<p>复杂的 UI 场景往往涉及不同渲染技术的混合，这要求系统合成器 <code>SurfaceFlinger</code> 介入处理多个独立渲染源的 <code>Layer</code> 合成。</p>
<h3 data-id="heading-34"><strong>4.1. 现代 <code>WebView</code> 渲染机制：Out-of-Process Rasterization (OOPR)</strong></h3>
<p><code>WebView</code> 承载了复杂的 <code>Web</code> 渲染引擎（<code>Chromium</code>）。为了增强安全性和稳定性，现代 Android 系统（API 30 及以上）默认使用进程外光栅化 (<code>OOPR</code>) 模式。<br/>
在 Android API 30 (Android R) 之前，<code>WebView</code> 的渲染模式取决于具体的 <code>Android</code> 版本和设备的内存条件：</p>
<ul>
<li>进程内渲染 (In-Process Renderer): 在 Android Lollipop (API 21) 到 Android Nougat (API 25) 期间，进程内渲染是默认模式。在这种模式下，<code>Chromium</code> 渲染引擎（包括布局和光栅化）与主机应用运行在同一个进程内，共享资源和内存空间。这导致 Web 内容的复杂操作可能直接阻塞应用的主 UI 线程。</li>
<li>进程外渲染的过渡 (Oreo - Q): 从 Android Oreo (API 26) 到 Android Q (API 29)，系统通常会启用进程外渲染，但对于低内存设备，可能会回退到进程内渲染模式。</li>
<li><code>OOPR</code> 默认化 (Android R/API 30+): 由于 Android R 对内存管理的优化，WebView 在 Android R 及以上版本中总是默认使用进程外光栅化 (<code>OOPR</code>) 模式，确保了隔离性。</li>
</ul>
<h4 data-id="heading-35">进程隔离与 Surface IPC</h4>
<p>在 OOPR 模式下，实际的 Web 内容渲染工作发生在宿主应用进程之外的 Chrome Render Process 中。</p>
<ul>
<li><strong>数据流：</strong> <code>Chrome</code> 渲染进程将其渲染结果绘制到一个专用的 Surface 中。这个 <code>Surface</code> 对象通过 <code>Android</code> 的 <code>Binder IPC</code> 机制被传递和管理。渲染进程充当 <code>Surface</code> 的生产者，负责将渲染好的 <code>GraphicBuffer</code> (或 <code>AHardwareBuffer</code>) 提交给 <code>SurfaceFlinger</code>。</li>
<li><strong>宿主应用职责：</strong> 宿主应用的主进程只需要管理 <code>WebView</code> 的生命周期、输入事件转发以及 <code>Surface</code> 的分配，渲染工作负载被完全卸载到远程进程，实现了极高的隔离性。</li>
</ul>
<h4 data-id="heading-36">WebView 的绘制模式与崩溃隔离</h4>
<p><strong>绘制模式：</strong> 尽管 <code>WebView</code> 是作为 Android Native View 层次结构的一部分被托管，其内部的 Chromium 渲染引擎遵循 <code>保留模式 (Retained Mode)</code> 的原则。<br/>
Web 平台的 文档对象模型 (DOM) 充当了其保留状态的模型。浏览器维护 DOM 的状态，并可以在不需要 JavaScript 持续重新发送所有绘图指令的情况下进行渲染，这与 <code>Android View</code> 使用 <code>RenderNode</code> 的思路一致 。</p>
<p><strong>崩溃隔离：</strong> <code>WebView</code> 的进程外光栅化（<code>OOPR</code>）旨在通过将渲染工作负载转移到沙箱隔离的进程中 ，从而提高稳定性和安全性。<br/>
然而，如果发生严重的渲染故障，例如未捕获的 <code>JavaScript</code> 异常导致 <code>Chrome Render Process</code> 崩溃，这仍然可能导致主机应用程序受到影响。<br/>
为了实现进程级别的鲁棒性，Android 平台在 API 26 及更高版本中提供了 <code>WebViewClient#onRenderProcessGone</code> 回调方法。通过重写此方法，主机应用可以在渲染进程崩溃时被通知，从而允许应用进行恢复操作，例如重新加载 WebView 或显示错误信息，防止整个应用程序崩溃。</p>
<p><strong>渲染驱动逻辑与 VSync 依赖</strong></p>
<ul>
<li><strong>渲染线程：</strong> 隔离的 <code>Chrome Render Process</code> 内部的渲染线程。</li>
<li><strong>驱动机制：</strong> <strong>内部 VSync 对齐。</strong> 渲染进程的渲染循环独立运行，但会与系统 VSync 信号对齐。主机应用通过滚动、页面加载或 JavaScript 动画等触发更新，渲染进程负责高效地将新内容光栅化。</li>
<li><strong>频率控制：</strong> 由 Chromium 引擎内部控制。主机应用无法直接调节其帧率。</li>
</ul>
<h4 data-id="heading-37">SurfaceFlinger 的参与</h4>
<p>由于 <code>WebView</code> 的内容是作为独立进程的输出，它必定是一个独立的 Layer 提交给 SurfaceFlinger。</p>
<ul>
<li><strong>性能影响：</strong> 尽管 <code>OOPR</code> 提供了卓越的进程隔离，但它强制 <code>WebView</code> 成为一个独立 <code>Layer</code>，无法内嵌到应用主界面的 <code>RenderNode</code> 中进行优化。这意味着 <code>WebView</code> 内容的任何更新都必须经过 SurfaceFlinger 的系统级合成步骤。这增加了系统合成的开销，尤其是在高频更新的场景下。</li>
</ul>
<h4 data-id="heading-38">WebView OOPR 渲染流程</h4>
<p>时序图：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30b0ed54774140a29a80c515f029b1c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXBpZ2ZseQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763902138&amp;x-signature=OMYido96TIS69haAc46aTK6tGMs%3D" alt="image.png" loading="lazy"/></p>
<p><code>WebView</code> <code>OOPR</code> 渲染架构 (流程描述) 该流程描述了 WebView 跨进程渲染的组件交互：</p>
<ol>
<li>App Host Process (WVHost)： 调用 WebView.loadUrl() 或 loadData()，触发 Web 内容加载。</li>
<li>App Host Process (WVHost) -&gt; Chrome Render Process (WebEngine)： Host 进程通过 Binder IPC 机制向 Chrome 渲染进程分发加载请求、生命周期控制和输入事件。</li>
<li>Chrome Render Process (WebEngine)： Web 引擎（Blink）在远程进程中执行页面解析、布局计算，并构建 Web Layer Tree。</li>
<li>Chrome Render Process (WebEngine) -&gt; GPU： 渲染进程的 GPU 线程执行 光栅化，将 Web 内容绘制到专用的 AHardwareBuffer 中。渲染帧率内部与 VSync 对齐。</li>
<li>Chrome Render Process (WebEngine) -&gt; Android Graphics Subsystem (SF/BQ): Chrome 进程通过 Surface 生产者接口，将渲染好的缓冲区提交到 BufferQueue。</li>
<li>Android Graphics Subsystem (SF/BQ) -&gt; SurfaceFlinger (System)： SurfaceFlinger 接收 WebView 的独立 Layer。</li>
<li>SurfaceFlinger (System)： 执行系统级合成，将 WebView Layer 放置在正确的 Z 轴顺序和位置上，并最终显示。</li>
</ol>
<h2 data-id="heading-39">5. <strong>总结与建议</strong></h2>








































<table><thead><tr><th align="left">技术栈</th><th align="left">系统集成度</th><th align="left">线程隔离粒度</th><th align="left">关键性能关注点</th><th align="left">典型应用场景</th></tr></thead><tbody><tr><td align="left"><strong>Native/Compose</strong></td><td align="left">高 (共享 RenderThread)</td><td align="left">CPU/GPU 隔离 (RT)</td><td align="left">优化 UI 线程的记录/重组负载。</td><td align="left">标准 UI 界面，需要高度原生平台特性。</td></tr><tr><td align="left"><strong>Flutter</strong></td><td align="left">低 (独立引擎)</td><td align="left">彻底隔离 (Raster Thread)</td><td align="left">跨平台一致性，减少 Platform View 的合成开销。</td><td align="left">高性能、高自定义度 UI，跨平台项目。</td></tr><tr><td align="left"><strong>GLSurfaceView</strong></td><td align="left">中 (独立 Surface)</td><td align="left">彻底隔离 (GLES Thread)</td><td align="left">自主控制 eglSwapBuffers 频率。</td><td align="left">游戏引擎，实时视频流，自定义 3D 渲染。</td></tr><tr><td align="left"><strong>WebView</strong></td><td align="left">中 (跨进程 Surface)</td><td align="left">彻底隔离 (OOPR)</td><td align="left">跨进程通信延迟和 SurfaceFlinger 的 Layer 合成开销。</td><td align="left">嵌入复杂 HTML/JS 内容。</td></tr></tbody></table>
<p><strong>原生 UI 的瓶颈转移：</strong> 对于 Native View 和 Compose，AOSP 已经通过 RenderThread 解决了 GPU 执行阻塞 UI 线程的问题。然而，性能优化的重点已从 GPU 转移到 UI 线程的 <strong>记录/布局/重组</strong> 阶段。</p>
<p><strong>独立 Surface 的开销：</strong> 无论采用 Flutter、WebView 还是 GLSurfaceView，当它们使用独立的 Surface 对象时，都不可避免地成为 SurfaceFlinger 的一个独立 Layer。虽然这提供了极佳的线程隔离，但也意味着每一次更新都必须经过系统合成器的处理。对于需要大量 Layer 合成或复杂混合的场景，这可能导致比 HWC 零拷贝合成更高的系统资源消耗。</p>
<p><strong>高性能图形的选择：</strong> 对于需要实时（60fps 或 120fps）更新和完全控制图形管线的场景，GLSurfaceView 或 Flutter Engine 是最佳选择。它们通过专用的渲染线程实现了高确定性性能，将光栅化工作负载从 AOSP 的主渲染路径中完全解耦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openGauss实战：Python开发与AI向量数据库应用]]></title>    <link>https://juejin.cn/post/7572714389943271476</link>    <guid>https://juejin.cn/post/7572714389943271476</guid>    <pubDate>2025-11-16T11:15:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572714389943271476" data-draft-id="7572534419880525859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openGauss实战：Python开发与AI向量数据库应用"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-16T11:15:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openGauss实战：Python开发与AI向量数据库应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T11:15:34.000Z" title="Sun Nov 16 2025 11:15:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>经过前两篇文章的铺垫，我们已经掌握了openGauss的部署安装和使用Data Studio进行可视化管理。现在，我们来到了本系列文章的终章，将目光聚焦于开发者最关心的环节——如何在应用程序中与openGauss进行交互，并探索其在AI领域的应用潜力。</p>
<p>本文将以目前最流行的编程语言之一Python为例，详细演示如何连接openGauss数据库，并围绕两个典型的业务场景——“用户管理系统”和“订单支付流程”，构建完整的CRUD（创建、读取、更新、删除）与事务处理代码示例。更进一步，我们将结合业界热点，探讨如何利用openGauss的向量计算能力，构建一个简单的以文搜图RAG（检索增强生成）应用，充分展现openGauss作为一款AI原生数据库的魅力。
@[toc]
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ecc742f65bf4188bba3c4639c39463e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763896534&amp;x-signature=tVp0Zw4ALYTw94xR53Kq9KLvdLM%3D" alt="image.png" loading="lazy"/></p>
<p>本文的后端环境为“CentOS 7.9 + openGauss 极简版（simpleInstall，6.x）”，数据库运行在云服务器上，应用在本地开发机（Windows/macOS/Linux）运行并远程连接到数据库。若远程连接失败，请参考第二篇中关于<code>listen_addresses</code>与<code>pg_hba.conf</code>的配置说明。</p>
<h2 data-id="heading-1">Python连接openGauss：psycopg2驱动</h2>
<p>openGauss兼容PostgreSQL生态，因此，我们可以使用PostgreSQL最成熟的Python驱动<code>psycopg2</code>来连接和操作openGauss数据库。</p>
<h3 data-id="heading-2">1. 安装psycopg2</h3>
<p>首先，安装Python驱动。请根据环境选择以下命令：</p>
<ul>
<li>Python 3.8 及以上（推荐）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">python3 -m pip install --user psycopg2-binary
</code></pre>
<ul>
<li>CentOS 7 + Python 3.6（需固定版本并使用国内镜像）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">python3 -m pip install --upgrade <span class="hljs-string">"pip==21.3.1"</span> --user -i https://pypi.tuna.tsinghua.edu.cn/simple
python3 -m pip install --user -i https://mirrors.aliyun.com/pypi/simple <span class="hljs-string">"psycopg2-binary==2.8.6"</span>
<span class="hljs-comment"># 如网络较慢，可追加 --default-timeout=120</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31f000e4a5d84062a91348784cce2b50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763896534&amp;x-signature=Cxbor0a7bzzELL%2BEAvA58M9X0p8%3D" alt="e1821a45e4b7bcadd15800e7f81934cf.png" loading="lazy"/></p>
<p>提示：尽量使用 <code>python3 -m pip</code>（或 <code>pip3</code>），并在非虚拟环境下加 <code>--user</code> 以避免权限冲突；若需源码编译，可改为安装 <code>psycopg2==2.8.6</code>，并提前安装构建依赖（如 <code>gcc</code>、<code>python3-devel</code>、<code>postgresql-libs</code>/<code>postgresql-devel</code>）。</p>
<p>常见安装问题排障：</p>
<ul>
<li>下载超时：加入 <code>--default-timeout=120</code> 或切换镜像源（如清华、阿里）。</li>
<li>证书/代理：在公司网络需配置 HTTPS 代理或临时关闭 MITM 检查；也可离线下载 <code>.whl</code> 后本地安装。</li>
<li>权限警告：在 root 环境下建议使用 <code>--user</code> 或创建虚拟环境。</li>
<li>Windows 与多版本 Python 映射：在 PowerShell 执行 <code>python -V</code>、<code>pip -V</code>、<code>py -0p</code>，确保 <code>pip</code> 与 <code>python</code> 指向同一解释器；优先使用 <code>python -m pip install --user psycopg2-binary</code>。</li>
<li>路径检查：<code>where python</code>、<code>where pip</code> 查看可执行路径；必要时使用目标解释器绝对路径，例如 <code>C:\Python39\python.exe -m pip install psycopg2-binary</code>。</li>
<li>快速验证安装：<code>python -c "import psycopg2, sys; print(psycopg2.__version__, sys.executable)"</code>，确认驱动版本与解释器路径匹配。</li>
<li>源码编译提示：若报缺少 <code>pg_config</code> 或开发头文件，优先使用 <code>psycopg2-binary</code>；或先安装 <code>postgresql-libs</code>/<code>postgresql-devel</code> 与 <code>python3-devel</code> 后再编译 <code>psycopg2</code>。</li>
</ul>
<h3 data-id="heading-3">2. 建立数据库连接</h3>
<p>连接openGauss数据库非常简单，只需提供主机、端口、用户名、密码和数据库名即可。下面的示例与入门篇默认参数保持一致（请替换为实际的服务器IP与密码）</p>
<p>实操步骤（本地开发机）：</p>
<ul>
<li>在本地任意工作目录创建项目并新建连接测试脚本：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Windows PowerShell</span>
<span class="hljs-built_in">mkdir</span> opengauss_demo
<span class="hljs-built_in">cd</span> opengauss_demo
<span class="hljs-comment"># Linux/macOS 可用：</span>
<span class="hljs-comment"># mkdir -p opengauss_demo</span>
<span class="hljs-comment"># 如尚未安装驱动，请先执行：</span>
python3 -m pip install --user psycopg2-binary
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a73c91a6b2046efa57f07c0755e335a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763896534&amp;x-signature=loLG9NMvfbamgfIyenUsRAfTRpg%3D" alt="image.png" loading="lazy"/></p>
<p>在该目录中新建文件 <code>db_connect_test.py</code>，内容如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># db_connect_test.py</span>
<span class="hljs-keyword">import</span> psycopg2

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_connection</span>():
    <span class="hljs-keyword">try</span>:
        conn = psycopg2.connect(
            host=<span class="hljs-string">"YOUR_SERVER_IP"</span>,   <span class="hljs-comment"># 替换为云服务器公网IP</span>
            port=<span class="hljs-number">5432</span>,
            user=<span class="hljs-string">"omm"</span>,
            password=<span class="hljs-string">"Gauss@123456"</span>, <span class="hljs-comment"># 替换为实际密码</span>
            database=<span class="hljs-string">"postgres"</span>,
            connect_timeout=<span class="hljs-number">5</span>
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库连接成功！"</span>)
        <span class="hljs-keyword">return</span> conn
    <span class="hljs-keyword">except</span> psycopg2.OperationalError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库连接失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    conn = get_db_connection()
    <span class="hljs-keyword">if</span> conn:
        conn.close()
</code></pre>
<p>运行与验证（Windows/ macOS/ Linux）：</p>
<pre><code class="hljs language-bash" lang="bash">python3 db_connect_test.py
<span class="hljs-comment"># 若 Windows 上没有 python3 命令，可用：</span>
<span class="hljs-comment"># python db_connect_test.py</span>
</code></pre>
<p>预期输出：出现“数据库连接成功！”并退出；如报错，按下方“远程连接失败排查要点”逐项检查。</p>
<p>若出现连接超时或认证失败，请回到第二篇确认：</p>
<ul>
<li><code>postgresql.conf</code>的<code>listen_addresses</code>是否为<code>'*'</code>或对应IP；</li>
<li><code>pg_hba.conf</code>是否添加了允许远程访问的<code>host</code>条目（<code>md5</code>认证）；</li>
<li>云安全组是否开放<code>TCP 5432</code>入站规则到您的本地IP范围。</li>
</ul>
<p>连接失败快速排查：</p>
<ul>
<li>替换占位符：确认已将 <code>YOUR_SERVER_IP</code> 与 <code>Gauss@123456</code> 替换为真实值；若脚本报 <code>NoneType</code> 错误，通常是连接失败导致返回 <code>None</code>。</li>
<li>端口连通性：Windows 执行 <code>Test-NetConnection YOUR_SERVER_IP -Port 5432</code>；Linux/macOS 执行 <code>telnet YOUR_SERVER_IP 5432</code> 或 <code>nc -vz YOUR_SERVER_IP 5432</code>。</li>
<li>认证规则：在数据库侧 <code>pg_hba.conf</code> 添加合适的 <code>host</code> 条目（如 <code>md5</code>），修改后 <code>gs_ctl reload</code> 或重启实例。</li>
<li>初始用户远程连接说明：不建议用初始用户（如 <code>omm</code>）作为应用远程账号；推荐新建业务用户（如 <code>xsc</code>）并授予表/序列权限，见下文“用户管理”授权方案。</li>
<li>数据库/Schema：确认连接的 <code>database="postgres"</code> 与 <code>search_path</code> 包含 <code>public</code>；使用限定名 <code>public.t_user</code> 可避免路径问题。</li>
</ul>
<h2 data-id="heading-4">场景一：用户管理系统的CRUD实战</h2>
<p>用户管理是几乎所有应用的标配。下面，我们将实现一个简单的用户管理模块，包含增、删、改、查功能。</p>
<h3 data-id="heading-5">1. 创建用户表</h3>
<p>首先，在数据库中创建<code>t_user</code>表。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">WITH</span> <span class="hljs-type">TIME</span> ZONE <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);
</code></pre>
<p>实操步骤（数据库侧）：</p>
<ul>
<li>使用 <code>gsql</code> 远程连接到 openGauss：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">gsql -d postgres -h YOUR_SERVER_IP -p 5432 -U omm -W
</code></pre>
<ul>
<li>执行上述 <code>CREATE TABLE</code> 语句创建表。</li>
<li>验证：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">\dt
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333ff30978cd4d66a3fdcc7ab7569942~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763896534&amp;x-signature=fUIaxUTfyMWvpt9F%2FFh%2FTDrNf1g%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">2. Python代码实现</h3>
<p>在本地开发机创建目录（例如 <code>opengauss_demo</code>），新增文件 <code>user_crud.py</code>，内容如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># user_crud.py</span>

<span class="hljs-keyword">import</span> psycopg2
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> closing


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_connection</span>():
    <span class="hljs-keyword">try</span>:
        conn = psycopg2.connect(
            host=<span class="hljs-string">"YOUR_SERVER_IP"</span>,
            port=<span class="hljs-number">5432</span>,
            user=<span class="hljs-string">"omm"</span>,
            password=<span class="hljs-string">"Gauss@123456"</span>,
            database=<span class="hljs-string">"postgres"</span>,
            connect_timeout=<span class="hljs-number">5</span>,
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库连接成功！"</span>)
        <span class="hljs-keyword">return</span> conn
    <span class="hljs-keyword">except</span> psycopg2.OperationalError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库连接失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">username, email</span>):
    <span class="hljs-keyword">with</span> closing(get_db_connection()) <span class="hljs-keyword">as</span> conn:
        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
            cursor.execute(
                <span class="hljs-string">"INSERT INTO t_user (username, email) VALUES (%s, %s)"</span>,
                (username, email),
            )
            conn.commit()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户 '<span class="hljs-subst">{username}</span>' 创建成功。"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_by_username</span>(<span class="hljs-params">username</span>):
    <span class="hljs-keyword">with</span> closing(get_db_connection()) <span class="hljs-keyword">as</span> conn:
        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
            cursor.execute(
                <span class="hljs-string">"SELECT id, username, email FROM t_user WHERE username = %s"</span>,
                (username,),
            )
            <span class="hljs-keyword">return</span> cursor.fetchone()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">update_user_email</span>(<span class="hljs-params">username, new_email</span>):
    <span class="hljs-keyword">with</span> closing(get_db_connection()) <span class="hljs-keyword">as</span> conn:
        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
            cursor.execute(
                <span class="hljs-string">"UPDATE t_user SET email = %s WHERE username = %s"</span>,
                (new_email, username),
            )
            conn.commit()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户 '<span class="hljs-subst">{username}</span>' 的邮箱更新成功。"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_user</span>(<span class="hljs-params">username</span>):
    <span class="hljs-keyword">with</span> closing(get_db_connection()) <span class="hljs-keyword">as</span> conn:
        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
            cursor.execute(
                <span class="hljs-string">"DELETE FROM t_user WHERE username = %s"</span>,
                (username,),
            )
            conn.commit()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户 '<span class="hljs-subst">{username}</span>' 删除成功。"</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    create_user(<span class="hljs-string">"john_doe"</span>, <span class="hljs-string">"john.doe@example.com"</span>)
    user = get_user_by_username(<span class="hljs-string">"john_doe"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询到用户: <span class="hljs-subst">{user}</span>"</span>)
    update_user_email(<span class="hljs-string">"john_doe"</span>, <span class="hljs-string">"john.doe.new@example.com"</span>)
    user = get_user_by_username(<span class="hljs-string">"john_doe"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"更新后用户: <span class="hljs-subst">{user}</span>"</span>)
    delete_user(<span class="hljs-string">"john_doe"</span>)
</code></pre>
<p>运行与验证（本地开发机）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> opengauss_demo
python3 user_crud.py
</code></pre>
<p>预期输出：依次打印“数据库连接成功”、“创建成功”、“查询到用户”、“更新后用户”、“删除成功”。
如需数据库侧二次确认：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> username<span class="hljs-operator">=</span><span class="hljs-string">'john_doe'</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7233e7af11948aab7c769fb30c3055a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763896534&amp;x-signature=XwAJe6arZphy41IKFnd5LNjUOCE%3D" alt="image.png" loading="lazy"/></p>
<p>常见报错与解决（用户管理）：</p>
<p>我用应用账号 xsc 远程连库，但表 t_user 是初始用户 omm 创建和拥有；默认权限下， xsc 没有对该表的操作权限，因此出现 “permission denied for relation t_user”。另外 openGauss 不建议用初始用户做远程应用连接，这是安全最佳实践。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c525931642614098abb3198fab856355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763896534&amp;x-signature=KRp%2FQsUywXFXOOt%2B%2BO1es73%2Fx%2Bw%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>报错 <code>psycopg2.errors.InsufficientPrivilege: permission denied for relation t_user</code>：业务用户（如 <code>xsc</code>）缺少权限。请在服务器上以所有者/管理员（通常为 <code>omm</code>）执行：</p>
<ul>
<li><code>GRANT USAGE ON SCHEMA public TO xsc;</code></li>
<li><code>GRANT SELECT, INSERT, UPDATE, DELETE ON TABLE public.t_user TO xsc;</code></li>
<li><code>GRANT USAGE, SELECT ON SEQUENCE public.t_user_id_seq TO xsc;</code>
序列授权是因为 <code>SERIAL</code> 会创建隐式序列，插入时需读写序列。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d9d87773a7a46438c9d9bb8592dc554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763896534&amp;x-signature=XC2mEn4Zyoz7gtTm6mjmvIb1tn8%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
<li>
<p>可选（需谨慎）：将所有者变更为业务用户以简化权限管理：</p>
<ul>
<li><code>ALTER TABLE public.t_user OWNER TO xsc;</code></li>
<li><code>ALTER SEQUENCE public.t_user_id_seq OWNER TO xsc;</code></li>
</ul>
</li>
<li>
<p>代码健壮性建议：在每个操作前判断连接是否成功，并使用表的限定名：</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">username, email</span>):
    conn = get_db_connection()  <span class="hljs-comment"># 可将 user 改为业务账号，如 xsc</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> conn:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"连接失败，已跳过 insert"</span>)
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cur:
            cur.execute(
                <span class="hljs-string">"INSERT INTO public.t_user (username, email) VALUES (%s, %s)"</span>,
                (username, email),
            )
        conn.commit()
    <span class="hljs-keyword">finally</span>:
        conn.close()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user_by_username</span>(<span class="hljs-params">username</span>):
    conn = get_db_connection()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> conn:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cur:
            cur.execute(
                <span class="hljs-string">"SELECT id, username, email FROM public.t_user WHERE username = %s"</span>,
                (username,),
            )
            <span class="hljs-keyword">return</span> cur.fetchone()
    <span class="hljs-keyword">finally</span>:
        conn.close()
</code></pre>
<ul>
<li>授权快速验证：
<ul>
<li><code>gsql -d postgres -h YOUR_SERVER_IP -p 5432 -U xsc -W</code></li>
<li>依次执行：<code>INSERT/SELECT/UPDATE/DELETE</code> 到 <code>public.t_user</code>，确认无权限报错。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">场景二：订单支付流程的事务处理</h2>
<p>在电商等金融敏感场景中，数据一致性至关重要。我们将模拟一个“用户下单扣减库存”的场景，来演示如何使用事务保证操作的原子性。</p>
<h3 data-id="heading-8">1. 创建商品表和订单表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_product (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    stock <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_order (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    product_id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    quantity <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">WITH</span> <span class="hljs-type">TIME</span> ZONE <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 插入一个商品</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_product (name, stock) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'openGauss T-shirt'</span>, <span class="hljs-number">100</span>);
</code></pre>
<p>实操步骤（数据库侧）：</p>
<ul>
<li>连接数据库（同上）：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">gsql -d postgres -h YOUR_SERVER_IP -p 5432 -U omm -W
</code></pre>
<ul>
<li>依次执行创建两张表与初始化数据的 SQL；可用下列查询验证：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">\dt
<span class="hljs-keyword">SELECT</span> id, name, stock <span class="hljs-keyword">FROM</span> t_product;  <span class="hljs-comment">-- 应看到一条库存为100的商品</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> t_order;           <span class="hljs-comment">-- 初始为0</span>
</code></pre>
<h3 data-id="heading-9">2. Python代码实现</h3>
<p>在本地开发机创建文件 <code>transaction_example.py</code>，内容如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># transaction_example.py</span>

<span class="hljs-keyword">import</span> psycopg2


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_connection</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> psycopg2.connect(
            host=<span class="hljs-string">"YOUR_SERVER_IP"</span>,
            port=<span class="hljs-number">5432</span>,
            user=<span class="hljs-string">"omm"</span>,
            password=<span class="hljs-string">"Gauss@123456"</span>,
            database=<span class="hljs-string">"postgres"</span>,
            connect_timeout=<span class="hljs-number">5</span>,
        )
    <span class="hljs-keyword">except</span> psycopg2.OperationalError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库连接失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">place_order</span>(<span class="hljs-params">product_id, quantity</span>):
    conn = get_db_connection()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> conn:
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
            <span class="hljs-comment"># 1. 检查库存并加行锁，避免并发下读到旧库存</span>
            cursor.execute(
                <span class="hljs-string">"SELECT stock FROM t_product WHERE id = %s FOR UPDATE"</span>,
                (product_id,),
            )
            row = cursor.fetchone()
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> row:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"商品不存在！"</span>)
            stock = row[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> stock &lt; quantity:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"库存不足！"</span>)

            <span class="hljs-comment"># 2. 扣减库存</span>
            cursor.execute(
                <span class="hljs-string">"UPDATE t_product SET stock = stock - %s WHERE id = %s"</span>,
                (quantity, product_id),
            )

            <span class="hljs-comment"># 3. 创建订单</span>
            cursor.execute(
                <span class="hljs-string">"INSERT INTO t_order (product_id, quantity) VALUES (%s, %s)"</span>,
                (product_id, quantity),
            )

            conn.commit()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"下单成功！"</span>)

    <span class="hljs-keyword">except</span> (Exception, psycopg2.Error) <span class="hljs-keyword">as</span> error:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下单失败: <span class="hljs-subst">{error}</span>"</span>)
        conn.rollback()
    <span class="hljs-keyword">finally</span>:
        conn.close()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    place_order(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)   <span class="hljs-comment"># 成功下单，库存从100减到95</span>
    place_order(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>) <span class="hljs-comment"># 超卖示例，将抛出“库存不足！”并回滚</span>
</code></pre>
<p>运行与验证：</p>
<pre><code class="hljs language-bash" lang="bash">python3 transaction_example.py
</code></pre>
<p>可在数据库侧验证：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, stock <span class="hljs-keyword">FROM</span> t_product <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;   <span class="hljs-comment">-- 应为95</span>
<span class="hljs-keyword">SELECT</span> id, product_id, quantity <span class="hljs-keyword">FROM</span> t_order; <span class="hljs-comment">-- 应新增一条 quantity=5 的订单</span>
</code></pre>
<p>说明：<code>FOR UPDATE</code> 会在查询到的行上加排他锁，确保并发事务不会在你提交前修改该行，避免超卖；一旦发生异常，代码会执行 <code>rollback()</code> 保证库存与订单的一致性。</p>
<p>这段代码确保了“扣减库存”和“创建订单”这两个操作要么同时成功，要么同时失败，避免了数据不一致的问题。</p>
<p>常见报错与处理（事务）：</p>
<ul>
<li>权限问题：业务用户对 <code>t_product</code> 需至少 <code>SELECT, UPDATE</code>，对 <code>t_order</code> 需 <code>INSERT, SELECT</code>，并为隐式序列授予 <code>USAGE, SELECT</code>（例如 <code>t_product_id_seq</code>、<code>t_order_id_seq</code>）。</li>
<li>并发冲突：若遇到 <code>could not serialize access due to concurrent update</code>，说明并发更新冲突；保留 <code>FOR UPDATE</code>，在应用侧捕获并重试，或确认隔离级别为 <code>READ COMMITTED</code>。</li>
<li>异常处理：任何异常均应 <code>rollback()</code> 保证一致性，提交成功后再打印“下单成功”。</li>
</ul>
<h2 data-id="heading-10">场景三：AI赋能 - 基于向量的以文搜图（RAG）</h2>
<p>现在，让我们进入最激动人心的部分。openGauss 5.0版本后引入了对向量数据类型和向量计算的内置支持，使其成为构建AI应用的理想选择。我们将构建一个简单的RAG应用，通过文本描述来搜索相似的图片。</p>
<h3 data-id="heading-11">1. 开启向量插件并创建表</h3>
<p>首先，需要在数据库中开启<code>vectors</code>插件</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> EXTENSION vectors;
</code></pre>
<p>说明：部分发行版或构建中扩展名可能为 <code>vector</code>（pgvector），若上面的命令报未找到扩展，可尝试：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> EXTENSION vector;
</code></pre>
<p>然后，创建一个用于存储图片向量的表。本文使用<code>clip-ViT-B-32</code>模型，其默认输出维度为<code>512</code>，因此示例使用<code>VECTOR(512)</code>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_image_vectors (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    image_path <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    image_vector VECTOR(<span class="hljs-number">512</span>)
);
</code></pre>
<p>验证与注意：</p>
<ul>
<li>使用 <code>\dx</code> 查看已启用的扩展；若显示 <code>vectors</code>/<code>vector</code> 即成功。</li>
<li><code>\d t_image_vectors</code> 可查看表结构；向量字段类型为 <code>vector(512)</code>。</li>
</ul>
<h3 data-id="heading-12">2. Python代码实现</h3>
<p>这个场景需要借助一个能够将文本和图片转换为向量的模型。这里我们使用<code>sentence-transformers</code>库作为示例。</p>
<pre><code class="hljs language-bash" lang="bash">python3 -m pip install --user -i https://mirrors.aliyun.com/pypi/simple sentence-transformers Pillow
</code></pre>
<p>前置说明：该步骤建议在本地开发机的 Python 3.8+ 环境执行（<code>sentence-transformers</code> 对 Py3.6 支持不佳）。首次运行会从 HuggingFace 下载模型，需联网。</p>
<p>在本地准备工程与图片：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p opengauss_demo/assets/images
<span class="hljs-comment"># 将两张示例图片保存为：opengauss_demo/assets/images/cat.jpg、dog.jpg</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># rag_example.py</span>

<span class="hljs-keyword">import</span> psycopg2
<span class="hljs-keyword">from</span> sentence_transformers <span class="hljs-keyword">import</span> SentenceTransformer
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_connection</span>():
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> psycopg2.connect(
            host=<span class="hljs-string">"YOUR_SERVER_IP"</span>,
            port=<span class="hljs-number">5432</span>,
            user=<span class="hljs-string">"omm"</span>,
            password=<span class="hljs-string">"Gauss@123456"</span>,
            database=<span class="hljs-string">"postgres"</span>,
            connect_timeout=<span class="hljs-number">5</span>,
        )
    <span class="hljs-keyword">except</span> psycopg2.OperationalError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库连接失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>


model = SentenceTransformer(<span class="hljs-string">"clip-ViT-B-32"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">insert_image_vector</span>(<span class="hljs-params">image_path: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
    conn = get_db_connection()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> conn:
        <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">try</span>:
        img_embedding = model.encode(Image.<span class="hljs-built_in">open</span>(image_path))  <span class="hljs-comment"># 512维</span>
        vector_str = <span class="hljs-string">"["</span> + <span class="hljs-string">","</span>.join(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">float</span>(x)) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> img_embedding.tolist()) + <span class="hljs-string">"]"</span>

        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
            cursor.execute(
                <span class="hljs-string">"INSERT INTO t_image_vectors (image_path, image_vector) VALUES (%s, %s::vector)"</span>,
                (image_path, vector_str),
            )
            conn.commit()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已入库向量：<span class="hljs-subst">{image_path}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理图片失败: <span class="hljs-subst">{e}</span>"</span>)
        conn.rollback()
    <span class="hljs-keyword">finally</span>:
        conn.close()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_images_by_text</span>(<span class="hljs-params">text_query: <span class="hljs-built_in">str</span>, top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
    conn = get_db_connection()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> conn:
        <span class="hljs-keyword">return</span> []

    <span class="hljs-keyword">try</span>:
        query_embedding = model.encode(text_query)
        vector_str = <span class="hljs-string">"["</span> + <span class="hljs-string">","</span>.join(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">float</span>(x)) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> query_embedding.tolist()) + <span class="hljs-string">"]"</span>

        <span class="hljs-keyword">with</span> conn.cursor() <span class="hljs-keyword">as</span> cursor:
            cursor.execute(
                <span class="hljs-string">"SELECT image_path, image_vector &lt;-&gt; %s::vector AS dist FROM t_image_vectors ORDER BY dist LIMIT %s"</span>,
                (vector_str, top_k),
            )
            <span class="hljs-keyword">return</span> cursor.fetchall()
    <span class="hljs-keyword">finally</span>:
        conn.close()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 将两张图片向量化并入库</span>
    insert_image_vector(<span class="hljs-string">"assets/images/cat.jpg"</span>)
    insert_image_vector(<span class="hljs-string">"assets/images/dog.jpg"</span>)

    <span class="hljs-comment"># 文本检索</span>
    query = <span class="hljs-string">"A photo of a cute animal sitting on the grass"</span>
    results = search_images_by_text(query, top_k=<span class="hljs-number">3</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n查询：<span class="hljs-subst">{query}</span>"</span>)
    <span class="hljs-keyword">for</span> path, dist <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"- 图片: <span class="hljs-subst">{path}</span>，L2距离: <span class="hljs-subst">{dist:<span class="hljs-number">.4</span>f}</span>"</span>)
</code></pre>
<p>运行与验证：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> opengauss_demo
python3 rag_example.py
</code></pre>
<p>预期输出：打印两条“已入库向量：…”后，返回按距离排序的图片列表。距离越小表示越相似。</p>
<p>补充说明：</p>
<ul>
<li><code>&lt;-&gt;</code> 是向量相似度的距离操作符（L2距离）。若发行版提供 <code>l2_distance(v1,v2)</code>，也可替换为该函数。</li>
<li>如需加速检索，可建立向量索引（例如 <code>ivfflat</code>/<code>hnsw</code>），不同版本支持情况不一，配置前请确认。</li>
</ul>
<p>这个例子展示了openGauss如何无缝集成到AI工作流中。通过在数据库层面进行向量检索，可以简化RAG应用的架构，降低开发复杂度，并利用数据库的事务性和可靠性来管理AI数据。</p>
<p>小贴士：</p>
<ul>
<li>若您的版本提供<code>l2_distance(v1, v2)</code>函数，也可将示例中的<code>image_vector &lt;-&gt; %s::vector</code>替换为<code>l2_distance(image_vector, %s::vector)</code>；</li>
<li>向量索引（如<code>ivfflat</code>或<code>hnsw</code>）可显著提升检索性能，但不同版本支持情况可能不同，建议在功能确认后再配置索引。</li>
</ul>
<p>常见问题与解决（RAG 向量检索）：</p>
<ul>
<li>扩展不存在：<code>ERROR: extension "vectors" does not exist</code> 或 <code>type "vector" does not exist</code> → 执行 <code>CREATE EXTENSION vectors;</code>，若无则尝试 <code>CREATE EXTENSION vector;</code>，并用 <code>\dx</code> 检查扩展已启用。</li>
<li>操作符缺失：<code>operator does not exist: vector &lt;-&gt; vector</code> → 未启用向量扩展或版本不匹配；启用扩展或改用 <code>l2_distance(...)</code>。</li>
<li>向量文本格式错误：<code>invalid input syntax for type vector</code> → 确保是类似 <code>[0.1,0.2,...]</code> 的 JSON 风格列表，并在 SQL 中使用 <code>%s::vector</code> 显式类型转换。</li>
<li>模型下载失败：受公司网络限制可配置代理或离线下载模型；也可切换 pip 镜像安装依赖（示例已使用阿里镜像）。</li>
<li>Pillow 依赖：Linux 发行版可能需安装 <code>libjpeg</code>/<code>zlib</code> 等系统库；Windows/macOS 通常无需额外配置。</li>
</ul>
<p>常见错误速查表：</p>
<ul>
<li><code>ModuleNotFoundError: No module named psycopg2</code> → 用目标解释器执行 <code>python -m pip install --user psycopg2-binary</code>，并用 <code>python -c "import psycopg2"</code> 验证。</li>
<li>Windows <code>python3</code> 不识别 → 直接用 <code>python</code> 或 <code>py -3</code>，优先 <code>python -m pip</code>。</li>
<li><code>psycopg2.OperationalError: could not connect to server</code>/超时 → 检查 <code>listen_addresses</code>、<code>pg_hba.conf</code> 与安全组；本机用 <code>Test-NetConnection</code>/<code>telnet</code> 验证 5432 端口连通。</li>
<li><code>permission denied for relation/sequence ...</code> → 按上文为业务用户授予 <code>SCHEMA</code>、<code>TABLE</code> 与隐式序列权限。</li>
<li><code>relation "t_user" does not exist</code> → 确认已创建表、连接的数据库正确，或在 SQL 中使用 <code>public.t_user</code> 限定名。</li>
<li><code>extension "vectors" does not exist</code>/<code>type "vector" does not exist</code> → 安装并启用向量扩展，或使用兼容扩展名 <code>vector</code>。</li>
</ul>
<h2 data-id="heading-13">总结</h2>
<p>从基础的CRUD操作到复杂的事务管理，再到前沿的AI向量应用，openGauss通过其强大的功能和对主流开发生态的良好兼容性，证明了其在现代应用开发中的核心价值。特别是其原生的向量数据库能力，为企业在AI时代构建智能应用提供了坚实、高效且易于管理的数据底座。</p>
<p>希望这个系列的文章能帮助您对openGauss有一个全面而深入的了解。数据库的世界广阔无垠，而openGauss的探索之旅，才刚刚开始。欢迎您继续深入研究，发掘它更多的可能性！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何接收前端参数]]></title>    <link>https://juejin.cn/post/7572776177691082761</link>    <guid>https://juejin.cn/post/7572776177691082761</guid>    <pubDate>2025-11-16T10:01:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572776177691082761" data-draft-id="7572793505900068915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何接收前端参数"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-16T10:01:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何接收前端参数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T10:01:03.000Z" title="Sun Nov 16 2025 10:01:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 入门：如何接收前端参数</h2>
<p>大家好呀！上一篇我们学会了让接口返回 JSON 数据，小伙伴会不会有疑问：“前端怎么给后端传数据呀？比如我想根据用户 ID 查对应的用户信息，该怎么写？” 今天这篇就聚焦 “接收前端参数” 这个核心需求，用 3 个最常用的场景 + 具体案例，手把手教你搞定，看完就能直接用在项目里！</p>
<h3 data-id="heading-1">一、先搞懂：前端会怎么传参数？</h3>
<p>在写代码前，我们先花 2 分钟搞清楚前端给后端传参数的 3 种常见方式，因为不同的传参方式，后端接收的写法不一样：</p>
<h4 data-id="heading-2">1. 路径传参（比如 <code>http://localhost:8080/user/1</code>）</h4>
<p>参数直接拼在 URL 路径里，像上面的 “1” 就是用户 ID，这种方式适合传<strong>单个、简单的参数</strong>（比如 ID、编号），URL 看起来很简洁。</p>
<h4 data-id="heading-3">2. 问号传参（比如 <code>http://localhost:8080/product?name=手机&amp;price=3000</code>）</h4>
<p>参数用 “?” 开头，多个参数用 “&amp;” 分隔，这种方式适合传<strong>多个可选参数</strong>（比如商品搜索时的名称、价格范围）。</p>
<h4 data-id="heading-4">3. 请求体传参（JSON 格式）</h4>
<p>参数放在请求的 “body” 里，不是拼在 URL 上，格式是 JSON，这种方式适合传<strong>复杂、多字段的参数</strong>（比如用户注册时的姓名、手机号、密码，或者提交订单时的多个商品信息），安全性更高，参数也更灵活。</p>
<p>这 3 种方式覆盖了 90% 以上的开发场景，接下来我们逐个讲解后端怎么接收～</p>
<h3 data-id="heading-5">二、准备工作：复用之前的项目和实体类</h3>
<p>我们还是在之前的「first-springboot-project」项目里操作，不用新建项目，直接复用已经创建好的：</p>
<ul>
<li>实体类：<code>User</code>（用户 ID、姓名、年龄、手机号）、<code>Product</code>（商品 ID、名称、价格、库存）；</li>
<li>控制器：可以在之前的<code>JsonController</code>里加方法，也可以新建<code>ParamController</code>（推荐新建，分类更清晰），这里我们选择新建。</li>
</ul>
<p>先确认项目能正常运行，没有报错～</p>
<h3 data-id="heading-6">三、场景 1：路径传参（接收单个参数，如用户 ID）</h3>
<p>最常见的需求：前端传用户 ID（比如 “1”），后端根据 ID 查询对应的用户信息并返回。</p>
<h4 data-id="heading-7">1. 写接口：用 <code>@PathVariable</code> 接收路径参数</h4>
<p>新建<code>ParamController</code>，在里面写一个根据用户 ID 查用户的接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.example.firstspringbootproject.controller;

<span class="hljs-keyword">import</span> com.example.firstspringbootproject.entity.User;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.PathVariable;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParamController</span> {

    <span class="hljs-comment">/*
     接口1：路径传参——根据用户ID查询用户
     访问路径：/user/{userId}，其中{userId}是占位符，表示这里要传用户ID
     @PathVariable("userId")：把路径里{userId}的值，赋值给方法参数Integer userId
     */</span>
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/user/{userId}"</span>)</span>
    <span class="hljs-keyword">public</span> User getUserById(<span class="hljs-meta">@PathVariable(<span class="hljs-string">"userId"</span>)</span> Integer userId) {

        <span class="hljs-comment">// 注意：这里只是模拟查询（实际项目会从数据库查），根据传的userId返回不同用户</span>
        <span class="hljs-keyword">if</span> (userId == <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 返回ID为1的用户</span>
            <span class="hljs-keyword">return</span> new User(<span class="hljs-number">1</span>, <span class="hljs-string">"小明"</span>, <span class="hljs-number">20</span>, <span class="hljs-string">"13800138000"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (userId == <span class="hljs-number">2</span>) {
            <span class="hljs-comment">// 返回ID为2的用户</span>
            <span class="hljs-keyword">return</span> new User(<span class="hljs-number">2</span>, <span class="hljs-string">"小红"</span>, <span class="hljs-number">19</span>, <span class="hljs-string">"13900139000"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 没有匹配的用户，返回null（实际项目会返回“用户不存在”的提示）</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-8">2. 关键说明（重点看这 2 处）：</h4>
<ul>
<li><strong>路径占位符</strong>：<code>@GetMapping("/user/{userId}")</code> 里的 <code>{userId}</code> 是 “占位符”，表示这个位置要传参数，参数名可以自己定（比如<code>{id}</code>也可以）；</li>
<li><strong>@PathVariable 注解</strong>：<code>@PathVariable("userId")</code> 用来 “提取” 路径里占位符的值，括号里的 “userId” 要和路径里<code>{userId}</code>的名称<strong>完全一致</strong>，然后赋值给后面的<code>Integer userId</code>参数。</li>
</ul>
<h4 data-id="heading-9">3. 测试接口（用浏览器或 Apifox）</h4>
<h5 data-id="heading-10">测试 1：查询 ID 为 1 的用户</h5>
<ul>
<li>浏览器地址栏输入：<code>http://localhost:8080/user/1</code>；</li>
<li>返回结果（JSON）：<code>{"id":1,"name":"小明","age":20,"phone":"13800138000"}</code>，正确！</li>
</ul>
<h5 data-id="heading-11">测试 2：查询 ID 为 2 的用户</h5>
<ul>
<li>输入：<code>http://localhost:8080/user/2</code>；</li>
<li>返回：<code>{"id":2,"name":"小红","age":19,"phone":"13900139000"}</code>，正确！</li>
</ul>
<h5 data-id="heading-12">测试 3：查询不存在的 ID（比如 3）</h5>
<ul>
<li>输入：<code>http://localhost:8080/user/3</code>；</li>
<li>返回：<code>null</code>（符合我们代码里的逻辑）。</li>
</ul>
<h3 data-id="heading-13">四、场景 2：问号传参（接收多个可选参数，如商品搜索）</h3>
<p>需求：前端传商品名称（可选）和价格上限（可选），后端根据参数筛选商品列表（比如只传名称 “手机”，就返回所有手机；只传价格上限 3000，就返回所有低于 3000 的商品；两个都传，就返回符合条件的手机）。</p>
<h4 data-id="heading-14">1. 写接口：用 <code>@RequestParam</code> 接收问号参数</h4>
<p>在<code>ParamController</code>里加一个商品搜索接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.firstspringbootproject.controller;

<span class="hljs-keyword">import</span> com.example.firstspringbootproject.entity.Product;
<span class="hljs-keyword">import</span> com.example.firstspringbootproject.entity.User;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParamController</span> {
    <span class="hljs-comment">/*
     接口2：问号传参——商品搜索（名称和价格上限都是可选参数）
     访问路径示例：/product/search?name=手机&amp;maxPrice=3000
     @RequestParam(required = false)：表示这个参数是可选的，不传也不会报错
     defaultValue = "": 表示如果参数没传，默认值是空字符串（针对String类型）
     */</span>
    <span class="hljs-meta">@GetMapping("/product/search")</span>
    <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">searchProduct</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(required = false, defaultValue = "")</span> String name, <span class="hljs-meta">@RequestParam(required = false)</span> Double maxPrice)</span> {

        <span class="hljs-comment">//1.创建商品数据库</span>
        List&lt;Product&gt; productDB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        productDB.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">101</span>, <span class="hljs-string">"华为手机"</span>, <span class="hljs-number">3999.0</span>, <span class="hljs-number">100</span>));
        productDB.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">102</span>, <span class="hljs-string">"苹果平板"</span>, <span class="hljs-number">5999.0</span>, <span class="hljs-number">50</span>));
        productDB.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">103</span>, <span class="hljs-string">"小米耳机"</span>, <span class="hljs-number">299.0</span>, <span class="hljs-number">200</span>));
        productDB.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">104</span>, <span class="hljs-string">"OPPO手机"</span>, <span class="hljs-number">2999.0</span>, <span class="hljs-number">80</span>));

        <span class="hljs-comment">// 2. 创建一个空列表，用来装筛选后的商品</span>
        List&lt;Product&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 3. 遍历“商品数据库”，根据参数筛选</span>
        <span class="hljs-keyword">for</span> (Product product : productDB) {
            <span class="hljs-comment">// 条件1：商品名称包含传入的name（如果name不为空）</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">matchName</span> <span class="hljs-operator">=</span> product.getProductName().contains(name);
            <span class="hljs-comment">// 条件2：商品价格小于等于传入的maxPrice（如果maxPrice不为空）</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">matchPrice</span> <span class="hljs-operator">=</span> (maxPrice == <span class="hljs-literal">null</span>) || (product.getPrice() &lt;= maxPrice);
            <span class="hljs-comment">// 两个条件都满足，就加入结果列表</span>
            <span class="hljs-keyword">if</span> (matchName &amp;&amp; matchPrice) {
                result.add(product);
            }
        }

        <span class="hljs-comment">// 4. 返回筛选后的商品列表（Spring Boot自动转JSON）</span>
        <span class="hljs-keyword">return</span> result;

    }
}
</code></pre>
<h4 data-id="heading-15">2. 关键说明（重点看 <code>@RequestParam</code>）：</h4>
<ul>
<li><code>required = false</code>：表示这个参数是 “可选的”，前端可以不传（如果不写这个属性，默认是<code>required = true</code>，前端不传就会报错）；</li>
<li><code>defaultValue = ""</code>：给参数设置 “默认值”，比如 name 的默认值是空字符串，这样即使前端不传 name，也不会是 null，避免后续代码报错；</li>
<li><strong>参数名对应</strong>：<code>@RequestParam</code> 括号里可以写参数名（比如<code>@RequestParam("productName")</code>），如果括号里不写，默认会找和方法参数名（比如<code>name</code>）一致的前端参数。</li>
</ul>
<h4 data-id="heading-16">3. 测试接口（多场景测试，更能理解）</h4>
<h5 data-id="heading-17">测试 1：只传 “商品名称”（搜索 “手机”）</h5>
<ul>
<li>访问路径：<code>http://localhost:8080/product/search?name=手机</code>；</li>
<li>筛选逻辑：名称包含 “手机”，价格不限制；</li>
<li>返回结果：华为手机（3999）和 OPPO 手机（2999），正确！</li>
</ul>
<h5 data-id="heading-18">测试 2：只传 “价格上限”（maxPrice=3000）</h5>
<ul>
<li>访问路径：<code>http://localhost:8080/product/search?maxPrice=3000</code>；</li>
<li>筛选逻辑：价格≤3000，名称不限制；</li>
<li>返回结果：小米耳机（299）和 OPPO 手机（2999），正确！</li>
</ul>
<h5 data-id="heading-19">测试 3：两个参数都传（name = 手机 &amp; maxPrice=3000）</h5>
<ul>
<li>访问路径：<code>http://localhost:8080/product/search?name=手机&amp;maxPrice=3000</code>；</li>
<li>筛选逻辑：名称包含 “手机” 且价格≤3000；</li>
<li>返回结果：只有 OPPO 手机（2999），正确！</li>
</ul>
<h5 data-id="heading-20">测试 4：两个参数都不传</h5>
<ul>
<li>访问路径：<code>http://localhost:8080/product/search</code>；</li>
<li>筛选逻辑：所有商品都符合条件；</li>
<li>返回结果：所有 4 个商品，正确！</li>
</ul>
<h3 data-id="heading-21">五、场景 3：请求体传参（接收复杂 JSON 参数，如用户注册）</h3>
<p>需求：用户注册时，前端传一个 JSON 格式的用户信息（包含姓名、年龄、手机号），后端接收这些参数，模拟 “保存用户”，然后返回 “注册成功” 的提示和保存后的用户信息（包含自动生成的用户 ID）。</p>
<h4 data-id="heading-22">1. 写接口：用 “实体类” 接收请求体参数</h4>
<p>在<code>ParamController</code>里加一个用户注册接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.firstspringbootproject.controller;

<span class="hljs-keyword">import</span> com.example.firstspringbootproject.entity.Product;
<span class="hljs-keyword">import</span> com.example.firstspringbootproject.entity.User;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParamController</span> {

    <span class="hljs-comment">// 模拟“用户数据库”：存注册后的用户</span>
    <span class="hljs-keyword">private</span> List&lt;User&gt;userDB =<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 模拟自增ID：每次注册新用户，ID+1</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">nextUserId</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 之前已有ID=1、2的用户，所以从3开始</span>

    <span class="hljs-comment">/*
     * 接口3：请求体传参——用户注册（接收JSON格式的用户信息）
     *  @PostMapping：表示这个接口用POST请求（前端传请求体一般用POST，不用GET）
     *  @RequestBody：表示把请求体里的JSON数据，转换成User对象
     */</span>
    <span class="hljs-meta">@PostMapping("/user/register")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">registerUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {

        <span class="hljs-comment">// 1. 给新用户设置自增ID（前端没传，后端自动生成）</span>
        user.setId(nextUserId);
        nextUserId++; <span class="hljs-comment">// 下次注册ID+1</span>
        <span class="hljs-comment">// 2. 模拟“保存用户”：把用户添加到“用户数据库”</span>
        userDB.add(user);
        <span class="hljs-comment">// 3. 返回注册成功的提示（包含用户信息）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"注册成功！你的用户信息："</span> +

                <span class="hljs-string">"ID="</span> + user.getId() +

                <span class="hljs-string">"，姓名="</span> + user.getName() +

                <span class="hljs-string">"，年龄="</span> + user.getAge() +

                <span class="hljs-string">"，手机号="</span> + user.getPhone();

    }
}
</code></pre>
<h4 data-id="heading-23">2. 关键说明（重点看这 2 个注解）：</h4>
<ul>
<li><code>@PostMapping</code>：接收前端的 POST 请求（GET 请求一般用来 “查询” 数据，POST 请求用来 “提交” 数据，比如注册、提交订单，这是开发中的规范）；</li>
<li><code>@RequestBody</code>：把前端请求体里的 JSON 数据，自动转换成<code>User</code>实体类对象 —— 这里的关键是：JSON 里的字段名要和<code>User</code>类的属性名<strong>完全一致</strong>（比如 JSON 里的 “name” 对应 User 类的<code>private String name</code>），否则无法正确赋值。</li>
</ul>
<h4 data-id="heading-24">3. 测试接口（必须用 Apifox，浏览器没法传请求体）</h4>
<h5 data-id="heading-25">测试步骤：</h5>
<ol>
<li>打开 Apifox，点击左上角「+」新建快捷请求；</li>
<li>「Method」选择「POST」，「URL」输入：<code>http://localhost:8080/user/register</code>；</li>
<li>点击「Body」→ 选择「json」→ 右侧下拉框选择「JSON」，在输入框里写前端要传的 JSON 数据：</li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"小李"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">22</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"phone"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"13700137000"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol>
<li>点击右上角「Send」，查看返回结果：</li>
</ol>
<ul>
<li>「Response Body」里会显示：<code>注册成功！你的用户信息：ID=3，姓名=小李，年龄=22，手机号=13700137000</code>；</li>
<li>状态码是 200，表示请求成功。</li>
</ul>
<h5 data-id="heading-26">再测试一次：</h5>
<ul>
<li>再传一个 JSON：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"小李"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">21</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"phone"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"13600136000"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>返回结果：<code>注册成功！你的用户信息：ID=4，姓名=小张，年龄=21，手机号=13600136000</code>，ID 自动增长，正确！</li>
</ul>
<h3 data-id="heading-27">六、常见问题：接收参数时的小坑和解决方案</h3>
<h4 data-id="heading-28">1. 路径传参时，参数名和占位符不一致，导致接收不到值？</h4>
<ul>
<li>比如路径是<code>/user/{id}</code>，但注解写的是<code>@PathVariable("userId")</code>，这样就会匹配失败；</li>
<li>解决方案：确保<code>@PathVariable</code>括号里的名称，和路径里<code>{}</code>的名称完全一致（比如<code>@PathVariable("id")</code>）。</li>
</ul>
<h4 data-id="heading-29">2. 问号传参时，前端传了参数，但后端接收的是 null？</h4>
<ul>
<li>原因 ：前端传的参数名和后端<code>@RequestParam</code>里的参数名不一致（比如前端传<code>product_name</code>，后端用<code>name</code>）；</li>
</ul>
<h4 data-id="heading-30">3. 请求体传参时，实体类属性值是 null？</h4>
<ul>
<li>原因 ：JSON 里的字段名和实体类属性名不一致（比如 JSON 里是 “userName”，实体类是 “name”）；</li>
</ul>
<h3 data-id="heading-31">七、总结：3 种传参方式怎么选？</h3>
<p>今天我们学完了接收前端参数的 3 种核心方式，最后用一张表帮你快速判断该用哪种：</p>





























<table><thead><tr><th>传参方式</th><th>注解 / 方式</th><th>适用场景</th><th>示例 URL/JSON</th></tr></thead><tbody><tr><td>路径传参</td><td><code>@PathVariable</code></td><td>单个、简单参数（如 ID、编号）</td><td><code>http://localhost:8080/user/1</code></td></tr><tr><td>问号传参</td><td><code>@RequestParam</code></td><td>多个可选参数（如搜索条件）</td><td><code>http://localhost:8080/product/search?name=手机&amp;maxPrice=3000</code></td></tr><tr><td>请求体传参</td><td><code>@RequestBody + 实体类</code></td><td>复杂、多字段参数（如注册、提交订单）</td><td><code>{"name":"小李","age":22,"phone":"13700137000"}</code></td></tr></tbody></table>
<p>下一篇文章，我会教大家怎么 “连接数据库”（比如用 MySQL），把之前模拟的 “商品数据库”“用户数据库” 换成真实的数据库，让接口能真正操作数据库里的数据，这才是企业开发的真实场景！感兴趣的小伙伴点个关注，下次更新不迷路～</p>
<p>如果操作中遇到问题，欢迎在评论区留言，我会一一回复～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我开发了一款关于病历管理的app：安康记]]></title>    <link>https://juejin.cn/post/7572781559767695410</link>    <guid>https://juejin.cn/post/7572781559767695410</guid>    <pubDate>2025-11-16T10:59:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572781559767695410" data-draft-id="7572697146287669298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我开发了一款关于病历管理的app：安康记"/> <meta itemprop="keywords" content="APP,Apple"/> <meta itemprop="datePublished" content="2025-11-16T10:59:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶子的技术碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2831954919569245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我开发了一款关于病历管理的app：安康记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831954919569245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶子的技术碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T10:59:07.000Z" title="Sun Nov 16 2025 10:59:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上线了！上线了！基于Vibe Coding我终于也能独立开发出一款属于自己的app-<strong>安康记</strong>，目前终于成功上架App Store啦。</p>
<p>独立开发app这个事情我很早之前就有点念头，但学习Swift过程还挺痛苦的，总觉的各种语法糖很膈应，导致进度缓慢，后面就一直搁置了。ChatGPT出来之后也尝试了一点，但还是觉得当时的AI能力不够，并且纯靠聊天还是不太行，自从Cursor、Windsurf、CC、Codex这一类AI开发工具出来之后，Vibe Coding的概念也随之火热，我想也是时候重启自己的开发计划了，花了接近两个月的晚上和周末时间，终于将其开发完成并上架！</p>
<p>App Store地址: <strong>安康记</strong>(<a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fcn%2Fapp%2F%25E5%25AE%2589%25E5%25BA%25B7%25E8%25AE%25B0%2Fid6754668335)%25E3%2580%2582" target="_blank" title="https://apps.apple.com/cn/app/%E5%AE%89%E5%BA%B7%E8%AE%B0/id6754668335)%E3%80%82" ref="nofollow noopener noreferrer">apps.apple.com/cn/app/%E5%…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09ada5a4a0894e56808d5cfce5410ba6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763895547&amp;x-signature=WPSZrT%2BMlUMfox3kehmJsbmdcdU%3D" alt="appstore" loading="lazy"/></p>
<p>这个app的念头起源于我自己的需求，作为一个动不动就省点小毛病然后还总是往医院跑的人，其实经常是同一个病或者症状接近，但总是忘了此前是如何治疗的，目前经常去的那家医院有个自己的小程序，能看到很多检查和药物记录，但是没有就诊记录，而且如果有时候去了别的医院，那么这些记录也不能放在一起，网上搜了一些关于病历管理的app，要么UI不喜欢要么交互不喜欢，那么是时候自己整起来了！</p>
<p>首先整体功能设计还是得靠自己，中间可以跟AI沟通让他提一些建议，但核心的功能点还是需要自己来出。这个app的核心思想还是: 病历-&gt;就诊-&gt;药物/检查。 也就是说当你生病时，可以创建一次当前病情的病历，若去医院就诊，则绑定在该次病历下，去医院可能会有药物处方和检查项目，这些均可以记录在案。</p>
<p>app的设计思路整理好了之后，可以通过AI工具先帮你使用前端工具生成一个app的原型图，然后再基于这个原型去使用Swift来开发，这样对于开发的准确效果会比直接跟他说要可控一点，这也是我初期直接让AI上手干发现效果不太好才采用的方案，也推荐大家可以试试这么干。</p>
<p>另外我本人主力使用的AI编辑器是Windsurf，但到中后期的时候我几乎已经完全替换成了Codex，因为我发现codex编写Swift代码的效果竟然比Windsurf要好，哪怕都使用OpenAI的模型，甚至Windsurf使用Claude，也是codex的效果更好，这个其实有点超出我的认知，我也是中间因为Windsurf的点数用完了，临时使用Codex上阵才发现的，但平时工作中开发Java或者Python时，Windsurf的效果还是感觉挺好的，不怎么会使用Codex，如果有使用Claude Code或者Cursor的朋友，也可以说说自己有没有感觉某个工具对于Swift开发更友好。</p>
<p>安康记目前支持创建多个用户，也就是说可以一个人来管理家中多人的病历，对于家中有老人小孩的朋友们还是很有帮助的（PS：多用户需要会员）。另外对于医院科室和医生的管理，原本计划是直接从网上公开数据集中导入一些当前国内的医院科室和医生，但是发现数据量太大，而且需要维护，所以最终还是选择自己手动输入，可以自己先创建好了再用，也可以创建就诊记录的时候快捷创建。对于药物和检查项目还提供了快捷输入功能方便输入一些如用药途径药品规格等常见的信息（PS：快捷输入也需要会员）。而且app的所有数据存储都是基于本地的，只会通过iCloud同步，因此使用者们都无需担心隐私问题，对我个人而言，不用花钱买服务器也是极好的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98bfe8522038441b9b9ba5e2c9296d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763895547&amp;x-signature=gVuo4NYICBaabHvAkAeQMD5vDsQ%3D" alt="setting" loading="lazy"/></p>
<p>目前这个app还只是一个初版，当前的设计流程还欠缺几个功能，包括个人独立用药，即生病了也不一定去医院，可能自己在家吃一些药物，这些药物也应当可以直接记录而不是通过就诊记录。此外这个app还应当会支持体检项目，即专门记录个人阶段性的体检报告。这些功能会放在接下来的版本陆续去更新，另外现在的UI我其实谈不上多满意，但一直没找到好的方向去优化，后面也会继续尝试提升UI上的体验。</p>
<p>下个版本预计会在2-4周左右推出，公众号也会同步推送更新日志，后续也可能会公开需求池和开发计划，希望大家可以下载app进行体验，有什么需求或者建议可以通过留言或在app中的意见反馈中提出。谢谢大家 ღ( ´･ᴗ･` )。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JdbcTemplate常用方法]]></title>    <link>https://juejin.cn/post/7572776177690837001</link>    <guid>https://juejin.cn/post/7572776177690837001</guid>    <pubDate>2025-11-16T08:42:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572776177690837001" data-draft-id="7572749797468815369" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JdbcTemplate常用方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-16T08:42:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kevinzeng"/> <meta itemprop="url" content="https://juejin.cn/user/1964143993949127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JdbcTemplate常用方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1964143993949127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kevinzeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T08:42:04.000Z" title="Sun Nov 16 2025 08:42:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>JdbcTemplate</code> 是 Spring Framework 中用于简化 JDBC 操作的核心类。它封装了 JDBC 的底层细节，如连接管理、Statement 创建、异常处理等，让开发者能够更专注于 SQL 语句和业务逻辑，从而提高开发效率并减少模板代码。</p>
<h2 data-id="heading-0">SpringBoot配置</h2>
<h3 data-id="heading-1">1. 依赖配置（Maven）</h3>
<p>需引入 <strong>Spring JDBC</strong> 和 <strong>数据库驱动</strong>（以 MySQL 为例）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Spring JDBC 核心依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 与 Spring 版本一致 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- MySQL 驱动 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Spring 上下文（用于依赖注入） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>接着就是在<code>application.yml</code>配置数据源。</p>
<h2 data-id="heading-2">jdbcTemplate常用的方法</h2>
<h3 data-id="heading-3">初始化一个数据库demo</h3>
<pre><code class="hljs language-mysql" lang="mysql">CREATE TABLE `user` ( 
`id` INT PRIMARY KEY AUTO_INCREMENT, 
`name` VARCHAR(50) NOT NULL, 
`age` INT DEFAULT NULL, 
`email` VARCHAR(100) UNIQUE );
</code></pre>
<h3 data-id="heading-4">INSERT(增)</h3>
<p><code>JdbcTemplate</code> 提供 <code>update()</code> 方法执行增删改操作，返回受影响的行数。</p>
<h5 data-id="heading-5">示例 1：简单新增（使用 <code>?</code> 占位符）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(String name, Integer age, String email)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO user (name, age, email) VALUES (?, ?, ?)"</span>;
    <span class="hljs-comment">// 参数顺序需与 SQL 占位符一致</span>
    <span class="hljs-keyword">return</span> jdbcTemplate.update(sql, name, age, email);
}
</code></pre>
<h5 data-id="heading-6">示例 2：新增并返回自增主键（<code>KeyHolder</code>）</h5>
<p>如果需要获取插入后的自增 ID（如 <code>id</code>），可使用 <code>KeyHolder</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.jdbc.support.GeneratedKeyHolder;
<span class="hljs-keyword">import</span> org.springframework.jdbc.support.KeyHolder;
<span class="hljs-keyword">import</span> java.sql.PreparedStatement;

<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addUserWithId</span><span class="hljs-params">(String name, Integer age, String email)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO user (name, age, email) VALUES (?, ?, ?)"</span>;
    
    <span class="hljs-type">KeyHolder</span> <span class="hljs-variable">keyHolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GeneratedKeyHolder</span>(); <span class="hljs-comment">// 用于存储自增主键</span>
    
    jdbcTemplate.update(connection -&gt; {
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"id"</span>}); <span class="hljs-comment">// 指定返回的主键列名</span>
        ps.setString(<span class="hljs-number">1</span>, name);
        ps.setObject(<span class="hljs-number">2</span>, age); <span class="hljs-comment">// 支持 null</span>
        ps.setString(<span class="hljs-number">3</span>, email);
        <span class="hljs-keyword">return</span> ps;
    }, keyHolder);
    
    <span class="hljs-comment">// 获取自增主键（Long 类型，需根据数据库类型转换）</span>
    <span class="hljs-keyword">return</span> keyHolder.getKey().intValue();
}
</code></pre>
<h3 data-id="heading-7">UPDATE(改)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateUserAge</span><span class="hljs-params">(Integer id, Integer newAge)</span> { 
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE user SET age = ? WHERE id = ?"</span>; 
    <span class="hljs-keyword">return</span> jdbcTemplate.update(sql, newAge, id); 
}
</code></pre>
<h3 data-id="heading-8">删除（DELETE）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Integer id)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"DELETE FROM user WHERE id = ?"</span>;
    <span class="hljs-keyword">return</span> jdbcTemplate.update(sql, id);
}
</code></pre>
<h3 data-id="heading-9">查询（SELECT）</h3>
<p>查询是 <code>JdbcTemplate</code> 最常用的场景，提供多种方法适配不同结果集：</p>
<h4 data-id="heading-10">场景 1：查询单个对象（返回自定义 POJO）</h4>
<p>需实现 <code>RowMapper</code> 接口，将 <code>ResultSet</code> 映射为 Java 对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String email;

    <span class="hljs-comment">// 构造器、getter/setter、toString()</span>
}
</code></pre>
<p><strong>步骤 2：实现 <code>RowMapper</code></strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.jdbc.core.RowMapper;
<span class="hljs-keyword">import</span> java.sql.ResultSet;
<span class="hljs-keyword">import</span> java.sql.SQLException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRowMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RowMapper</span>&lt;User&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">mapRow</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> rowNum)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setId(rs.getInt(<span class="hljs-string">"id"</span>));
        user.setName(rs.getString(<span class="hljs-string">"name"</span>));
        user.setAge(rs.getInt(<span class="hljs-string">"age"</span>));
        user.setEmail(rs.getString(<span class="hljs-string">"email"</span>));
        <span class="hljs-keyword">return</span> user;
    }
}
</code></pre>
<p><strong>步骤 3：查询单个对象</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, name, age, email FROM user WHERE id = ?"</span>;
    <span class="hljs-comment">// queryForObject()：返回单个对象，无结果时抛出 EmptyResultDataAccessException</span>
    <span class="hljs-keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRowMapper</span>(), id);
}
</code></pre>
<h5 data-id="heading-11">场景 2：查询多个对象（返回 <code>List&lt;POJO&gt;</code>）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, name, age, email FROM user"</span>;
    <span class="hljs-keyword">return</span> jdbcTemplate.query(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRowMapper</span>());
}
</code></pre>
<h5 data-id="heading-12">场景 3：查询单个值（如 count、sum）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUserCount</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT COUNT(*) FROM user"</span>;
    <span class="hljs-comment">// queryForObject()：指定返回类型（如 Integer.class）</span>
    <span class="hljs-keyword">return</span> jdbcTemplate.queryForObject(sql, Integer.class);
}

<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserNameById</span><span class="hljs-params">(Integer id)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT name FROM user WHERE id = ?"</span>;
    <span class="hljs-keyword">return</span> jdbcTemplate.queryForObject(sql, String.class, id);
}
</code></pre>
<h5 data-id="heading-13">场景 4：查询结果映射为 <code>Map</code></h5>
<p>适用于不需要自定义 POJO 的简单场景，<code>Map</code> 的 key 为列名，value 为字段值：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getUserMapById</span><span class="hljs-params">(Integer id)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, name, age, email FROM user WHERE id = ?"</span>;
    <span class="hljs-keyword">return</span> jdbcTemplate.queryForMap(sql, id);
}
</code></pre>
<h5 data-id="heading-14">场景 5：查询大结果集（分页 / 流式处理）</h5>
<p>如果结果集过大（如 10 万条以上），直接查询会占用大量内存，推荐使用 <code>query()</code> 结合 <code>RowCallbackHandler</code> 进行流式处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.jdbc.core.RowCallbackHandler;
<span class="hljs-keyword">import</span> java.sql.ResultSet;
<span class="hljs-keyword">import</span> java.sql.SQLException;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUserByPage</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNum, <span class="hljs-type">int</span> pageSize)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (pageNum - <span class="hljs-number">1</span>) * pageSize;
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, name, age, email FROM user LIMIT ? OFFSET ?"</span>;

    List&lt;User&gt; userList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    jdbcTemplate.query(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RowCallbackHandler</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processRow</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException {
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
            user.setId(rs.getInt(<span class="hljs-string">"id"</span>));
            user.setName(rs.getString(<span class="hljs-string">"name"</span>));
            user.setAge(rs.getInt(<span class="hljs-string">"age"</span>));
            user.setEmail(rs.getString(<span class="hljs-string">"email"</span>));
            userList.add(user);
        }
    }, pageSize, offset);

    <span class="hljs-keyword">return</span> userList;
}
</code></pre>
<h3 data-id="heading-15">四、高级特性</h3>
<h4 data-id="heading-16">1. 批量操作（Batch Update）</h4>
<p>用于一次性执行多个增删改操作，提升性能（减少数据库连接次数）。</p>
<h5 data-id="heading-17">示例：批量新增用户</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] batchAddUsers(List&lt;User&gt; userList) {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO user (name, age, email) VALUES (?, ?, ?)"</span>;

    <span class="hljs-comment">// 转换为 Object 数组列表（每个数组对应一条 SQL 的参数）</span>
    List&lt;Object[]&gt; batchArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (User user : userList) {
        batchArgs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{user.getName(), user.getAge(), user.getEmail()});
    }

    <span class="hljs-comment">// batchUpdate()：返回每个操作受影响的行数数组</span>
    <span class="hljs-keyword">return</span> jdbcTemplate.batchUpdate(sql, batchArgs);
}
</code></pre>
<h4 data-id="heading-18">2. 命名参数（Named Parameters）</h4>
<p>默认 <code>JdbcTemplate</code> 使用 <code>?</code> 占位符，参数顺序必须严格对应。若需使用命名参数（如 <code>:name</code>），需配合 <code>NamedParameterJdbcTemplate</code>（<code>JdbcTemplate</code> 的子类）。</p>
<h5 data-id="heading-19">示例：使用命名参数查询</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> NamedParameterJdbcTemplate namedParameterJdbcTemplate; <span class="hljs-comment">// 注入命名参数模板</span>

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, name, age, email FROM user WHERE name = :name"</span>;
        
        <span class="hljs-comment">// 封装参数（key 对应命名参数，value 为参数值）</span>
        Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params.put(<span class="hljs-string">"name"</span>, name);
        
        <span class="hljs-comment">// queryForObject()：使用命名参数，无需关心参数顺序</span>
        <span class="hljs-keyword">return</span> namedParameterJdbcTemplate.queryForObject(sql, params, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRowMapper</span>());
    }
}
</code></pre>
<h4 data-id="heading-20">3. 事务管理</h4>
<p><code>JdbcTemplate</code> 本身不管理事务，需结合 Spring 的事务管理机制（如 <code>@Transactional</code> 注解）。</p>
<h5 data-id="heading-21">示例：事务控制下的批量操作</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hljs-comment">// 声明事务：方法内所有操作要么全部成功，要么全部回滚</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchOperation</span><span class="hljs-params">(List&lt;User&gt; addUsers, List&lt;Integer&gt; deleteIds)</span> {
        <span class="hljs-comment">// 批量新增</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">addSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO user (name, age, email) VALUES (?, ?, ?)"</span>;
        List&lt;Object[]&gt; addArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (User user : addUsers) {
            addArgs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{user.getName(), user.getAge(), user.getEmail()});
        }
        jdbcTemplate.batchUpdate(addSql, addArgs);

        <span class="hljs-comment">// 批量删除（若此处抛出异常，新增操作会回滚）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">deleteSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"DELETE FROM user WHERE id = ?"</span>;
        List&lt;Object[]&gt; deleteArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (Integer id : deleteIds) {
            deleteArgs.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{id});
        }
        jdbcTemplate.batchUpdate(deleteSql, deleteArgs);
    }
}
</code></pre>
<p><strong>注意</strong>：需在配置类中启用事务管理（<code>@EnableTransactionManagement</code>）。</p>
<h4 data-id="heading-22">4. 异常处理</h4>
<p><code>JdbcTemplate</code> 将 JDBC 异常（如 <code>SQLException</code>）转换为 Spring 统一的 <strong>数据访问异常体系</strong>（继承自 <code>DataAccessException</code>），常用异常包括：</p>
<ul>
<li><code>EmptyResultDataAccessException</code>：查询无结果</li>
<li><code>IncorrectResultSizeDataAccessException</code>：查询结果数量不匹配</li>
<li><code>DuplicateKeyException</code>：主键冲突</li>
<li><code>DataIntegrityViolationException</code>：数据完整性约束 violation</li>
</ul>
<h5 data-id="heading-23">示例：异常捕获</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByIdSafe</span><span class="hljs-params">(Integer id)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, name, age, email FROM user WHERE id = ?"</span>;
        <span class="hljs-keyword">return</span> jdbcTemplate.queryForObject(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserRowMapper</span>(), id);
    } <span class="hljs-keyword">catch</span> (EmptyResultDataAccessException e) {
        <span class="hljs-comment">// 无结果时返回 null 或抛出自定义异常</span>
        log.warn(<span class="hljs-string">"用户 id={} 不存在"</span>, id);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> (DataAccessException e) {
        <span class="hljs-comment">// 其他数据库异常（如连接失败、SQL 语法错误）</span>
        log.error(<span class="hljs-string">"查询用户失败："</span>, e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"系统异常，请稍后重试"</span>);
    }
}
</code></pre>
<h3 data-id="heading-24">五、注意事项</h3>
<ol>
<li>
<p><strong>SQL 注入防护</strong>：</p>
<ul>
<li>始终使用 <strong>占位符（<code>?</code> 或命名参数）</strong>  传递参数，避免直接拼接 SQL 字符串。</li>
<li>错误示例：<code>String sql = "SELECT * FROM user WHERE name = '" + name + "'";</code>（存在注入风险）</li>
</ul>
</li>
<li>
<p><strong>资源释放</strong>：</p>
<ul>
<li><code>JdbcTemplate</code> 自动管理连接、Statement、ResultSet 的释放，无需手动关闭。</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>批量操作优先使用 <code>batchUpdate()</code>，减少数据库交互次数。</li>
<li>大结果集使用 <code>RowCallbackHandler</code> 流式处理，避免一次性加载所有数据到内存。</li>
<li>生产环境使用 <strong>连接池</strong>（如 HikariCP），而非 <code>DriverManagerDataSource</code>（无连接池，性能差）。</li>
</ul>
</li>
<li>
<p><strong>类型转换</strong>：</p>
<ul>
<li>
<p><code>JdbcTemplate</code> 自动处理常见类型转换（如 <code>String</code> ↔ <code>VARCHAR</code>、<code>Integer</code> ↔ <code>INT</code>）。</p>
</li>
<li>
<p>对于复杂类型（如 <code>LocalDateTime</code>），需手动指定类型或使用 <code>SqlParameterValue</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.jdbc.core.SqlParameterValue;
<span class="hljs-keyword">import</span> java.sql.Types;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUserWithTime</span><span class="hljs-params">(String name, LocalDateTime createTime)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO user (name, create_time) VALUES (?, ?)"</span>;
    <span class="hljs-comment">// 指定参数类型为 TIMESTAMP</span>
    <span class="hljs-type">SqlParameterValue</span> <span class="hljs-variable">timeParam</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlParameterValue</span>(Types.TIMESTAMP, createTime);
    jdbcTemplate.update(sql, name, timeParam);
}
</code></pre>
</li>
</ul>
</li>
</ol>
<h2 data-id="heading-25">chatGPT给的优雅代码</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java</span>
<span class="hljs-keyword">package</span> com.example.demo;

<span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.dao.DataAccessException;
<span class="hljs-keyword">import</span> org.springframework.jdbc.core.*;
<span class="hljs-keyword">import</span> org.springframework.jdbc.support.GeneratedKeyHolder;
<span class="hljs-keyword">import</span> org.springframework.jdbc.support.KeyHolder;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.sql.PreparedStatement;
<span class="hljs-keyword">import</span> java.sql.Statement;
<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Repository</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoJdbcTemplateUsage</span> {

 <span class="hljs-comment">// 构造器注入，和你的 MysqlService 相同写法</span>
 <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JdbcTemplate jdbcTemplate;

 <span class="hljs-comment">// 1) 查询列表（等值条件 + 分页），返回 List&lt;Map&lt;String,Object&gt;&gt;</span>
 <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">listByStatus</span><span class="hljs-params">(String status, <span class="hljs-type">int</span> limit, <span class="hljs-type">int</span> offset)</span> {
     <span class="hljs-type">int</span> <span class="hljs-variable">safeLimit</span> <span class="hljs-operator">=</span> (limit &gt; <span class="hljs-number">0</span> &amp;&amp; limit &lt;= <span class="hljs-number">1000</span>) ? limit : <span class="hljs-number">100</span>;
     <span class="hljs-type">int</span> <span class="hljs-variable">safeOffset</span> <span class="hljs-operator">=</span> Math.max(offset, <span class="hljs-number">0</span>);
     <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT `id`,`username`,`email` FROM `user` "</span> +
                  <span class="hljs-string">"WHERE `status` = ? ORDER BY `id` DESC LIMIT ? OFFSET ?"</span>;
     <span class="hljs-keyword">return</span> jdbcTemplate.queryForList(sql, status, safeLimit, safeOffset);
 }

 <span class="hljs-comment">// 2) 统计总数（与列表查询的 where 参数一致）</span>
 <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">countByStatus</span><span class="hljs-params">(String status)</span> {
     <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT COUNT(1) FROM `user` WHERE `status` = ?"</span>;
     <span class="hljs-type">Integer</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(sql, Integer.class, status);
     <span class="hljs-keyword">return</span> n == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : n;
 }

 <span class="hljs-comment">// 3) 查询单条并映射为对象（RowMapper）</span>
 <span class="hljs-keyword">public</span> Optional&lt;User&gt; <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> {
     <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT `id`,`username`,`email`,`status` FROM `user` WHERE `id` = ?"</span>;
     List&lt;User&gt; list = jdbcTemplate.query(sql, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{id}, userRowMapper());
     <span class="hljs-keyword">return</span> list.stream().findFirst();
 }

 <span class="hljs-keyword">private</span> RowMapper&lt;User&gt; <span class="hljs-title function_">userRowMapper</span><span class="hljs-params">()</span> {
     <span class="hljs-keyword">return</span> (rs, rowNum) -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(
         rs.getLong(<span class="hljs-string">"id"</span>),
         rs.getString(<span class="hljs-string">"username"</span>),
         rs.getString(<span class="hljs-string">"email"</span>),
         rs.getString(<span class="hljs-string">"status"</span>)
     );
 }

 <span class="hljs-comment">// 4) 新增并返回自增主键</span>
 <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">insertUser</span><span class="hljs-params">(String username, String email, String status)</span> {
     <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO `user`(`username`,`email`,`status`) VALUES(?,?,?)"</span>;
     <span class="hljs-type">KeyHolder</span> <span class="hljs-variable">kh</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GeneratedKeyHolder</span>();
     jdbcTemplate.update(con -&gt; {
         <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> con.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
         ps.setString(<span class="hljs-number">1</span>, username);
         ps.setString(<span class="hljs-number">2</span>, email);
         ps.setString(<span class="hljs-number">3</span>, status);
         <span class="hljs-keyword">return</span> ps;
     }, kh);
     <span class="hljs-type">Number</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> kh.getKey();
     <span class="hljs-keyword">return</span> key == <span class="hljs-literal">null</span> ? <span class="hljs-number">0L</span> : key.longValue();
 }

 <span class="hljs-comment">// 5) 更新或删除（受影响行数）</span>
 <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">deactivateUser</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> {
     <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE `user` SET `status` = ? WHERE `id` = ?"</span>;
     <span class="hljs-keyword">return</span> jdbcTemplate.update(sql, <span class="hljs-string">"INACTIVE"</span>, id);
 }

 <span class="hljs-comment">// 6) 批量更新（占位符参数化，避免拼接）</span>
 <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] batchDeactivate(List&lt;Long&gt; ids) {
     <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE `user` SET `status` = 'INACTIVE' WHERE `id` = ?"</span>;
     <span class="hljs-keyword">return</span> jdbcTemplate.batchUpdate(sql, ids, ids.size(),
             (ps, userId) -&gt; ps.setLong(<span class="hljs-number">1</span>, userId));
 }

 <span class="hljs-comment">// 7) 事务示例（多条语句要么都成功，要么都回滚）</span>
 <span class="hljs-meta">@Transactional</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transferDemo</span><span class="hljs-params">(<span class="hljs-type">long</span> fromUserId, <span class="hljs-type">long</span> toUserId, <span class="hljs-type">int</span> points)</span> {
     <span class="hljs-type">String</span> <span class="hljs-variable">dec</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE `user_points` SET `points` = `points` - ? WHERE `user_id` = ?"</span>;
     <span class="hljs-type">String</span> <span class="hljs-variable">inc</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE `user_points` SET `points` = `points` + ? WHERE `user_id` = ?"</span>;
     jdbcTemplate.update(dec, points, fromUserId);
     <span class="hljs-comment">// 任意异常都会触发回滚</span>
     jdbcTemplate.update(inc, points, toUserId);
 }

 <span class="hljs-comment">// 8) 安全构造简单 ORDER BY（列名白名单校验）</span>
 <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">listWithOrder</span><span class="hljs-params">(Set&lt;String&gt; allowedCols, String orderBy)</span> {
     <span class="hljs-type">String</span> <span class="hljs-variable">orderSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
     <span class="hljs-keyword">if</span> (orderBy != <span class="hljs-literal">null</span> &amp;&amp; !orderBy.isBlank()) {
         String[] parts = orderBy.trim().split(<span class="hljs-string">"\s+"</span>);
         <span class="hljs-type">String</span> <span class="hljs-variable">col</span> <span class="hljs-operator">=</span> parts[<span class="hljs-number">0</span>];
         <span class="hljs-type">String</span> <span class="hljs-variable">dir</span> <span class="hljs-operator">=</span> (parts.length &gt; <span class="hljs-number">1</span> ? parts[<span class="hljs-number">1</span>] : <span class="hljs-string">"ASC"</span>).toUpperCase(Locale.ROOT);
         <span class="hljs-keyword">if</span> (allowedCols.contains(col) &amp;&amp; (<span class="hljs-string">"ASC"</span>.equals(dir) || <span class="hljs-string">"DESC"</span>.equals(dir))) {
             orderSql = <span class="hljs-string">" ORDER BY `"</span> + col + <span class="hljs-string">"` "</span> + dir + <span class="hljs-string">" "</span>;
         }
     }
     <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT `id`,`username` FROM `user` WHERE 1=1 "</span> + orderSql + <span class="hljs-string">" LIMIT ? OFFSET ?"</span>;
     <span class="hljs-keyword">return</span> jdbcTemplate.queryForList(sql, <span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
 }

 <span class="hljs-comment">// 9) 基本异常处理（与你的 MysqlService 相同思路）</span>
 <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">safeQuery</span><span class="hljs-params">()</span> {
     <span class="hljs-keyword">try</span> {
         <span class="hljs-keyword">return</span> jdbcTemplate.queryForList(<span class="hljs-string">"SELECT 1 AS one"</span>);
     } <span class="hljs-keyword">catch</span> (DataAccessException dae) {
         log.error(<span class="hljs-string">"DB error"</span>, dae);
         <span class="hljs-keyword">return</span> Collections.emptyList();
     }
 }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式文件服务实战稿：从本地存储到对象存储的架构升级]]></title>    <link>https://juejin.cn/post/7572493520004661282</link>    <guid>https://juejin.cn/post/7572493520004661282</guid>    <pubDate>2025-11-16T09:04:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572493520004661282" data-draft-id="7572537221541134351" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式文件服务实战稿：从本地存储到对象存储的架构升级"/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2025-11-16T09:04:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yunxi_05"/> <meta itemprop="url" content="https://juejin.cn/user/310483456105751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式文件服务实战稿：从本地存储到对象存储的架构升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/310483456105751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yunxi_05
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T09:04:57.000Z" title="Sun Nov 16 2025 09:04:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">分布式文件服务实战稿：从本地存储到对象存储的架构升级</h2>
<h3 data-id="heading-1">为什么大厂面试爱问“为什么要用 MinIO/OSS？”</h3>
<p>面试官问这个问题，不是想听“对象存储能存大文件”“OSS 支持 CDN 加速”这些概念，而是想判断：你在实际项目中，真的遇到过文件存储的痛点吗？你能说清楚本地存储和对象存储的区别，以及如何根据业务场景选择合适的方案吗？</p>
<p>接下来，我会通过四个真实项目场景，展示我们是如何从“本地文件存储的种种问题”到“对象存储的完美解决方案”的完整过程。每个场景都会包含：当时遇到了什么具体问题、我们是怎么解决的、最终取得了什么效果。</p>
<hr/>
<h3 data-id="heading-2">场景 1：本地存储容量爆炸 —— 从“服务器磁盘 100% 告警”到“OSS 无限扩容”</h3>
<p><strong>业务背景</strong>：内容社区平台，用户每天上传 50 万张图片，平均每张 2MB，每天新增存储 100GB。图片存储在应用服务器的本地磁盘，3 个月后磁盘空间告急。</p>
<p><strong>遇到的问题</strong>：</p>
<ul>
<li>服务器磁盘使用率从 60% 飙升到 100%，频繁告警，运维每天都要清理临时文件。</li>
<li>磁盘满了导致新用户无法上传图片，用户投诉“上传失败”，每天 100+ 条投诉。</li>
<li>扩容困难：需要停机迁移数据，影响业务，而且单机磁盘容量有限，无法无限扩容。</li>
<li>数据安全风险：服务器故障可能导致所有图片丢失，虽然有备份，但恢复需要 6 小时。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>迁移到 <strong>阿里云 OSS</strong>（对象存储服务），支持无限扩容，按需付费。</li>
<li>图片上传流程改为：用户上传 → 应用服务器接收 → 直接上传到 OSS → 返回 OSS URL。</li>
<li>启用 OSS 的 CDN 加速，用户访问图片速度提升 3 倍。</li>
<li>配置 OSS 生命周期规则：30 天前的图片自动转存到低频访问存储，降低成本 60%。</li>
</ul>
<p><strong>核心代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// OSS 文件上传</span>
<span class="hljs-type">OSS</span> <span class="hljs-variable">ossClient</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);
<span class="hljs-type">String</span> <span class="hljs-variable">objectName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"images/"</span> + userId + <span class="hljs-string">"/"</span> + fileName;
ossClient.putObject(bucketName, objectName, inputStream);
<span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://"</span> + bucketName + <span class="hljs-string">"."</span> + endpoint + <span class="hljs-string">"/"</span> + objectName;
</code></pre>
<p><strong>实际效果</strong>：</p>
<ul>
<li>存储容量从单机 2TB 扩展到无限，不再担心磁盘满的问题。</li>
<li>用户上传成功率从 95% 提升到 99.9%，投诉量下降 90%。</li>
<li>图片访问速度提升 3 倍，CDN 命中率 95%，用户体验显著改善。</li>
<li>存储成本降低 40%，通过生命周期规则自动优化存储类型。</li>
</ul>
<hr/>
<h3 data-id="heading-3">场景 2：多服务器文件同步难题 —— 从“文件找不到”到“统一对象存储”</h3>
<p><strong>业务背景</strong>：电商平台，应用部署在 5 台服务器上，用户上传的商品图片存储在本地。用户访问时，如果请求被负载均衡到不同的服务器，可能访问不到图片。</p>
<p><strong>遇到的问题</strong>：</p>
<ul>
<li>用户 A 在服务器 1 上传图片，用户 B 访问时被负载均衡到服务器 2，找不到图片，显示“图片加载失败”。</li>
<li>需要手动同步文件到所有服务器，同步脚本经常失败，运维成本高。</li>
<li>文件同步有延迟，用户上传后立即访问可能看不到图片，体验差。</li>
<li>服务器扩容时，新服务器没有历史文件，需要全量同步，耗时 8 小时。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>迁移到 <strong>MinIO</strong>（开源对象存储），部署在独立的存储集群，所有应用服务器共享同一个存储。</li>
<li>文件上传流程：用户上传 → 应用服务器 → MinIO 集群 → 返回统一 URL。</li>
<li>所有服务器通过统一的 MinIO 地址访问文件，不再需要文件同步。</li>
<li>MinIO 支持多副本，数据自动备份，保证高可用。</li>
</ul>
<p><strong>核心代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MinIO 客户端配置（所有服务器使用相同配置）</span>
<span class="hljs-type">MinioClient</span> <span class="hljs-variable">minioClient</span> <span class="hljs-operator">=</span> MinioClient.builder()
    .endpoint(<span class="hljs-string">"http://minio-cluster:9000"</span>)
    .credentials(<span class="hljs-string">"minioadmin"</span>, <span class="hljs-string">"minioadmin"</span>)
    .build();

<span class="hljs-comment">// 文件上传（返回统一URL）</span>
minioClient.putObject(PutObjectArgs.builder()
    .bucket(<span class="hljs-string">"product-images"</span>)
    .object(fileName)
    .stream(inputStream, fileSize, -<span class="hljs-number">1</span>)
    .build());
<span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://minio-cluster:9000/product-images/"</span> + fileName;
</code></pre>
<p><strong>实际效果</strong>：</p>
<ul>
<li>文件访问成功率从 85% 提升到 99.9%，彻底解决“文件找不到”的问题。</li>
<li>运维成本下降 80%，不再需要文件同步脚本，服务器扩容时无需同步文件。</li>
<li>文件访问延迟从 500ms 降到 100ms，用户体验显著提升。</li>
<li>数据安全性提升，MinIO 多副本保证数据不丢失。</li>
</ul>
<hr/>
<h3 data-id="heading-4">场景 3：大文件上传超时 —— 从“上传失败率 30%”到“分片上传成功率 99.9%”</h3>
<p><strong>业务背景</strong>：在线教育平台，用户需要上传视频文件，平均大小 500MB，最大 2GB。使用传统方式上传，经常因为网络波动或超时导致上传失败。</p>
<p><strong>遇到的问题</strong>：</p>
<ul>
<li>大文件上传时间长，网络波动导致上传中断，需要重新上传，用户体验极差。</li>
<li>上传失败率高达 30%，用户投诉“视频上传总是失败”，每天 50+ 条投诉。</li>
<li>服务器内存占用高：大文件需要先上传到服务器内存，再写入磁盘，容易导致 OOM。</li>
<li>无法断点续传：上传失败后需要从头开始，浪费带宽和时间。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <strong>OSS 分片上传</strong>（Multipart Upload），将大文件分成多个 5MB 的小块，逐个上传。</li>
<li>前端实现断点续传：上传失败后，只重新上传失败的分片，不需要从头开始。</li>
<li>上传进度实时显示：用户可以看到上传进度，提升用户体验。</li>
<li>服务端直传：前端直接上传到 OSS，不经过应用服务器，减轻服务器压力。</li>
</ul>
<p><strong>核心代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// OSS 分片上传</span>
<span class="hljs-type">InitiateMultipartUploadRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitiateMultipartUploadRequest</span>(bucketName, objectName);
<span class="hljs-type">InitiateMultipartUploadResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ossClient.initiateMultipartUpload(request);
<span class="hljs-type">String</span> <span class="hljs-variable">uploadId</span> <span class="hljs-operator">=</span> result.getUploadId();

<span class="hljs-comment">// 分片上传（每个分片5MB）</span>
List&lt;PartETag&gt; partETags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; partCount; i++) {
    <span class="hljs-type">UploadPartRequest</span> <span class="hljs-variable">uploadPartRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UploadPartRequest</span>();
    uploadPartRequest.setBucketName(bucketName);
    uploadPartRequest.setKey(objectName);
    uploadPartRequest.setUploadId(uploadId);
    uploadPartRequest.setPartNumber(i + <span class="hljs-number">1</span>);
    uploadPartRequest.setInputStream(partInputStream);
    <span class="hljs-type">UploadPartResult</span> <span class="hljs-variable">uploadPartResult</span> <span class="hljs-operator">=</span> ossClient.uploadPart(uploadPartRequest);
    partETags.add(uploadPartResult.getPartETag());
}

<span class="hljs-comment">// 完成分片上传</span>
<span class="hljs-type">CompleteMultipartUploadRequest</span> <span class="hljs-variable">completeRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompleteMultipartUploadRequest</span>(
    bucketName, objectName, uploadId, partETags);
ossClient.completeMultipartUpload(completeRequest);
</code></pre>
<p><strong>实际效果</strong>：</p>
<ul>
<li>上传成功率从 70% 提升到 99.9%，大文件上传不再失败。</li>
<li>上传速度提升 2 倍，分片并行上传充分利用带宽。</li>
<li>服务器内存占用下降 90%，不再需要缓存大文件。</li>
<li>用户体验显著提升，支持断点续传，上传进度可视化。</li>
</ul>
<hr/>
<h3 data-id="heading-5">场景 4：图片处理性能瓶颈 —— 从“缩略图生成 5 秒”到“OSS 图片处理实时生成”</h3>
<p><strong>业务背景</strong>：社交平台，用户上传的图片需要生成多种尺寸的缩略图（原图、大图、中图、小图）。使用服务器 CPU 处理，高峰期 CPU 占用 90%，影响业务性能。</p>
<p><strong>遇到的问题</strong>：</p>
<ul>
<li>图片处理耗时：生成 4 种尺寸的缩略图需要 5 秒，用户等待时间长。</li>
<li>服务器 CPU 占用高：高峰期图片处理占用 90% CPU，影响其他业务。</li>
<li>存储空间浪费：需要存储原图 + 4 种缩略图，存储空间增加 5 倍。</li>
<li>处理失败率高：服务器负载高时，图片处理经常失败，需要重试。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <strong>OSS 图片处理服务</strong>（Image Service），支持实时生成缩略图，无需预先处理。</li>
<li>存储策略：只存储原图，缩略图通过 URL 参数实时生成，如 image.jpg?x-oss-process=image/resize,w_200。</li>
<li>启用 OSS 图片缓存：生成的缩略图自动缓存，相同尺寸的请求直接返回缓存，提升性能。</li>
<li>结合 CDN：缩略图请求走 CDN，进一步加速访问。</li>
</ul>
<p><strong>核心代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只存储原图</span>
<span class="hljs-type">String</span> <span class="hljs-variable">originalUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://bucket.oss-cn-hangzhou.aliyuncs.com/images/original.jpg"</span>;

<span class="hljs-comment">// 实时生成不同尺寸的缩略图（无需预处理）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">thumbnailSmall</span> <span class="hljs-operator">=</span> originalUrl + <span class="hljs-string">"?x-oss-process=image/resize,w_200,h_200"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">thumbnailMedium</span> <span class="hljs-operator">=</span> originalUrl + <span class="hljs-string">"?x-oss-process=image/resize,w_500,h_500"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">thumbnailLarge</span> <span class="hljs-operator">=</span> originalUrl + <span class="hljs-string">"?x-oss-process=image/resize,w_1000,h_1000"</span>;

<span class="hljs-comment">// 其他图片处理：裁剪、旋转、水印等</span>
<span class="hljs-type">String</span> <span class="hljs-variable">cropped</span> <span class="hljs-operator">=</span> originalUrl + <span class="hljs-string">"?x-oss-process=image/crop,w_300,h_300,x_100,y_100"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">watermarked</span> <span class="hljs-operator">=</span> originalUrl + <span class="hljs-string">"?x-oss-process=image/watermark,text_SGVsbG8gV29ybGQ"</span>;
</code></pre>
<p><strong>实际效果</strong>：</p>
<ul>
<li>图片处理时间从 5 秒降到 0.1 秒（实时生成），用户体验显著提升。</li>
<li>服务器 CPU 占用从 90% 降到 20%，释放资源给其他业务。</li>
<li>存储空间节省 80%，只存储原图，缩略图按需生成。</li>
<li>图片处理成功率从 85% 提升到 99.9%，不再有处理失败的问题。</li>
</ul>
<hr/>
<h3 data-id="heading-6">四类场景总结</h3>



































<table><thead><tr><th>场景</th><th>核心问题</th><th>对象存储方案价值</th><th>改善数据</th></tr></thead><tbody><tr><td>存储容量爆炸</td><td>磁盘满、扩容困难</td><td>OSS 无限扩容、按需付费</td><td>容量无限、成本降 40%</td></tr><tr><td>多服务器同步</td><td>文件找不到、同步困难</td><td>统一对象存储、无需同步</td><td>访问成功率 99.9%</td></tr><tr><td>大文件上传</td><td>上传失败、超时</td><td>分片上传、断点续传</td><td>上传成功率 99.9%</td></tr><tr><td>图片处理瓶颈</td><td>处理慢、CPU 占用高</td><td>OSS 图片处理、实时生成</td><td>处理时间 5s → 0.1s</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">常见追问点</h3>
<p><strong>1. MinIO 和 OSS 有什么区别？什么时候用哪个？</strong></p>
<p><strong>实战答案</strong>：</p>
<ul>
<li><strong>OSS（阿里云对象存储）</strong>：云服务，开箱即用，无需运维，支持 CDN、图片处理等高级功能，按量付费。适合对运维要求低、需要高级功能的场景。</li>
<li><strong>MinIO（开源对象存储）</strong>：需要自己部署和运维，完全可控，可以部署在私有云或内网，成本可控。适合对数据安全要求高、需要私有化部署的场景。</li>
<li><strong>选择建议</strong>：如果项目在公有云上，推荐 OSS，运维成本低；如果项目在内网或私有云，推荐 MinIO，数据更安全。我们项目是混合方案：公网图片用 OSS，内网文件用 MinIO。</li>
</ul>
<p><strong>2. 对象存储和传统文件系统有什么区别？</strong></p>
<p><strong>实战答案</strong>：</p>
<ul>
<li><strong>存储方式</strong>：传统文件系统是树形目录结构，对象存储是扁平化的键值对结构，通过唯一 Key 访问。</li>
<li><strong>扩展性</strong>：传统文件系统受单机容量限制，对象存储支持无限扩容，分布式存储。</li>
<li><strong>访问方式</strong>：传统文件系统通过文件路径访问，对象存储通过 HTTP/HTTPS URL 访问。</li>
<li><strong>性能</strong>：传统文件系统适合小文件频繁读写，对象存储适合大文件、高并发读。</li>
<li><strong>成本</strong>：传统文件系统需要购买服务器和磁盘，对象存储按量付费，成本更低。</li>
<li>我们项目迁移到对象存储后，存储成本降低 40%，访问性能提升 3 倍。</li>
</ul>
<p><strong>3. 如何保证对象存储的数据安全？</strong></p>
<p><strong>实战答案</strong>：</p>
<ul>
<li><strong>访问控制</strong>：使用 OSS 的访问控制策略（Bucket Policy），限制只有授权用户才能访问。</li>
<li><strong>签名 URL</strong>：敏感文件使用临时签名 URL，设置过期时间，防止文件被恶意下载。</li>
<li><strong>数据加密</strong>：启用 OSS 服务端加密（SSE），数据自动加密存储，保证数据安全。</li>
<li><strong>备份策略</strong>：启用 OSS 跨区域复制，数据自动备份到多个区域，防止数据丢失。</li>
<li><strong>版本控制</strong>：启用 OSS 版本控制，文件修改后保留历史版本，可以恢复误删文件。</li>
<li>我们项目启用加密和备份后，数据安全性提升 10 倍，从未出现数据丢失问题。</li>
</ul>
<p><strong>签名 URL 代码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生成临时签名URL（1小时有效）</span>
<span class="hljs-type">Date</span> <span class="hljs-variable">expiration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>);
<span class="hljs-type">GeneratePresignedUrlRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GeneratePresignedUrlRequest</span>(
    bucketName, objectName, HttpMethod.GET);
request.setExpiration(expiration);
<span class="hljs-type">URL</span> <span class="hljs-variable">signedUrl</span> <span class="hljs-operator">=</span> ossClient.generatePresignedUrl(request);
<span class="hljs-comment">// 返回给前端，1小时后自动失效</span>
</code></pre>
<p><strong>4. 对象存储的成本如何控制？</strong></p>
<p><strong>实战答案</strong>：</p>
<ul>
<li><strong>存储类型选择</strong>：热数据用标准存储，冷数据用低频访问存储或归档存储，成本降低 60-80%。</li>
<li><strong>生命周期规则</strong>：自动将旧文件转存到低频存储，30 天前的文件自动转存，降低成本。</li>
<li><strong>CDN 加速</strong>：启用 CDN 减少回源流量，CDN 流量成本比 OSS 流量成本低 50%。</li>
<li><strong>删除策略</strong>：定期清理无用文件，如临时文件、过期文件，减少存储成本。</li>
<li><strong>监控告警</strong>：设置存储容量和费用告警，及时发现异常，控制成本。</li>
<li>我们项目通过生命周期规则和存储类型优化，存储成本降低 40%，每月节省 2 万元。</li>
</ul>
<hr/>
<h3 data-id="heading-8">面试时怎么回答这个问题？</h3>
<p><strong>如果面试官问“为什么要用 MinIO/OSS”，你可以这样组织答案：</strong></p>
<p><strong>第一步：先讲背景和问题</strong>
“我在做 XX 项目（比如内容社区/电商平台）时，遇到了文件存储的问题。具体表现是：XX（比如服务器磁盘满了/多服务器文件同步困难/大文件上传总是失败/图片处理占用 CPU 太高）。用户投诉 XX（比如上传失败/图片加载慢），业务受到很大影响。”</p>
<p><strong>第二步：说明解决方案</strong>
“为了解决这个问题，我们迁移到 XX（比如阿里云 OSS/ MinIO）。具体实现是：XX（比如直接上传到 OSS/使用分片上传/启用图片处理服务）。同时考虑了 XX（比如数据安全/成本控制/访问性能）这些技术要点。”</p>
<p><strong>第三步：展示实际效果</strong>
“上线后效果很明显：XX（比如存储容量无限/上传成功率从 70% 提升到 99.9%/图片处理时间从 5 秒降到 0.1 秒/存储成本降低 40%）。更重要的是，系统具备了 XX（比如无限扩容能力/高可用性/高性能访问），为后续业务增长打下了基础。”</p>
<p><strong>核心要点：面试官要的不是“你知道 OSS 能存文件”，而是“你能根据业务场景选择合适的存储方案，还懂数据安全、成本控制、性能优化这些工程实践”。</strong></p>
<hr/>
<h3 data-id="heading-9">可视化插图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03cb28dafff40de90b0b219e1703c60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeXVueGlfMDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763888698&amp;x-signature=hUEYIig2afrTj1yzPkoQGQGdrws%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p><strong>提示</strong>：本文讲的是对象存储的基础应用。如果你的项目需要处理海量文件、实时流媒体、大数据分析等场景，就需要考虑对象存储的高级功能（如事件通知、数据湖、智能分层等），这是面试另一高频考点，后面单独拆解。</p>
<p><strong>你项目里用对象存储解决过什么存储问题？评论区聊聊，下次面试直接用！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[响应式页面设计与实现：让网站适配所有设备的艺术]]></title>    <link>https://juejin.cn/post/7572525491538919466</link>    <guid>https://juejin.cn/post/7572525491538919466</guid>    <pubDate>2025-11-16T08:18:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572525491538919466" data-draft-id="7572481101711114294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="响应式页面设计与实现：让网站适配所有设备的艺术"/> <meta itemprop="keywords" content="前端,HTML"/> <meta itemprop="datePublished" content="2025-11-16T08:18:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            响应式页面设计与实现：让网站适配所有设备的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T08:18:36.000Z" title="Sun Nov 16 2025 08:18:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动互联网飞速发展的今天，我们使用的设备种类前所未有地丰富——从4英寸的智能手机到30英寸的桌面显示器，从平板电脑到智能电视。面对如此多样化的屏幕尺寸，如何确保用户在任何设备上都能获得优秀的浏览体验？响应式网页设计（Responsive Web Design）正是解决这一挑战的最佳方案。</p>
<h2 data-id="heading-0">响应式设计</h2>
<p>响应式网页设计是一种网页开发方法，它使网站能够"响应"不同设备的屏幕尺寸、平台和方向，自动调整布局和内容呈现方式。简单来说，响应式设计就像水一样，能够填充任何容器——无论这个容器是手机屏幕还是桌面显示器。</p>
<h2 data-id="heading-1">响应式设计的三大核心技术支柱：</h2>
<ul>
<li>流体网格（Fluid Grids）</li>
<li>弹性图片（Flexible Images）</li>
<li>媒体查询（Media Queries）</li>
</ul>
<h2 data-id="heading-2">实现响应式页面的关键技术</h2>
<h3 data-id="heading-3">1. 视口设置（Viewport）</h3>
<p>在HTML的<code>&lt;head&gt;</code>部分添加视口元标签是响应式设计的首要步骤：</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
</code></pre>
<p>这个标签告诉浏览器按照设备的宽度来渲染页面，并防止用户缩放。</p>
<h3 data-id="heading-4">2. 媒体查询（Media Queries）</h3>
<p>媒体查询是响应式设计的核心，允许根据设备特性应用不同的CSS样式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 移动设备优先的基础样式 */</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
}

<span class="hljs-comment">/* 平板设备 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">750px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
  }
}

<span class="hljs-comment">/* 桌面设备 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">992px</span>) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">970px</span>;
  }
}

<span class="hljs-comment">/* 大屏幕设备 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1200px</span>) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">1170px</span>;
  }
}
</code></pre>
<h3 data-id="heading-5">3. 流体网格布局（Fluid Grid）</h3>
<p>使用百分比而非固定单位创建流动的网格系统：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
}

<span class="hljs-selector-class">.col-1</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">8.33%</span>; }
<span class="hljs-selector-class">.col-2</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">16.66%</span>; }
<span class="hljs-selector-class">.col-3</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">25%</span>; }
<span class="hljs-selector-class">.col-4</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">33.33%</span>; }
<span class="hljs-selector-class">.col-5</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">41.66%</span>; }
<span class="hljs-selector-class">.col-6</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>; }
<span class="hljs-selector-class">.col-7</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">58.33%</span>; }
<span class="hljs-selector-class">.col-8</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">66.66%</span>; }
<span class="hljs-selector-class">.col-9</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">75%</span>; }
<span class="hljs-selector-class">.col-10</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">83.33%</span>; }
<span class="hljs-selector-class">.col-11</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">91.66%</span>; }
<span class="hljs-selector-class">.col-12</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; }

<span class="hljs-comment">/* 所有列都浮动并设置盒模型 */</span>
<span class="hljs-selector-attr">[class*=<span class="hljs-string">"col-"</span>]</span> {
  <span class="hljs-attribute">float</span>: left;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}

<span class="hljs-comment">/* 清除浮动 */</span>
<span class="hljs-selector-class">.row</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">clear</span>: both;
  <span class="hljs-attribute">display</span>: table;
}
</code></pre>
<h3 data-id="heading-6">4. 弹性图片和媒体</h3>
<p>确保图片和其他媒体元素能够自适应容器：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">img</span>, <span class="hljs-selector-tag">video</span>, embed, <span class="hljs-selector-tag">object</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: auto;
}
</code></pre>
<h2 data-id="heading-7">完整响应式页面示例</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>响应式设计示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-comment">/* 基础重置样式 */</span>
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">box-sizing</span>: border-box;
        }
        
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Arial'</span>, sans-serif;
            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f4f4f4</span>;
        }
        
        <span class="hljs-selector-tag">a</span> {
            <span class="hljs-attribute">text-decoration</span>: none;
            <span class="hljs-attribute">color</span>: inherit;
        }
        
        <span class="hljs-comment">/* 移动优先的样式 */</span>
        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">15px</span>;
        }
        
        <span class="hljs-comment">/* 响应式导航 */</span>
        <span class="hljs-selector-class">.navbar</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2c3e50</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-selector-class">.navbar</span> <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: space-between;
            <span class="hljs-attribute">align-items</span>: center;
        }
        
        <span class="hljs-selector-class">.logo</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5rem</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
        }
        
        <span class="hljs-selector-class">.nav-links</span> {
            <span class="hljs-attribute">display</span>: none;
            <span class="hljs-attribute">list-style</span>: none;
        }
        
        <span class="hljs-selector-class">.nav-links</span> <span class="hljs-selector-tag">li</span> {
            <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>;
        }
        
        <span class="hljs-selector-class">.nav-links</span> <span class="hljs-selector-tag">a</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">5px</span> <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">transition</span>: color <span class="hljs-number">0.3s</span>;
        }
        
        <span class="hljs-selector-class">.nav-links</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#3498db</span>;
        }
        
        <span class="hljs-selector-class">.menu-toggle</span> {
            <span class="hljs-attribute">display</span>: block;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5rem</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
        }
        
        <span class="hljs-comment">/* 响应式网格系统 */</span>
        <span class="hljs-selector-class">.grid</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-wrap</span>: wrap;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> -<span class="hljs-number">15px</span>;
        }
        
        <span class="hljs-selector-class">.col</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
        }
        
        <span class="hljs-comment">/* 卡片组件 */</span>
        <span class="hljs-selector-class">.card</span> {
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>, box-shadow <span class="hljs-number">0.3s</span>;
        }
        
        <span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
        }
        
        <span class="hljs-selector-class">.card-img</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">object-fit</span>: cover;
        }
        
        <span class="hljs-selector-class">.card-content</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
        }
        
        <span class="hljs-selector-class">.card-title</span> {
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.25rem</span>;
        }
        
        <span class="hljs-comment">/* 页脚 */</span>
        <span class="hljs-selector-class">.footer</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#34495e</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">30px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
        }
        
        <span class="hljs-comment">/* 平板设备样式 */</span>
        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) {
            <span class="hljs-selector-class">.container</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">750px</span>;
                <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
            }
            
            <span class="hljs-selector-class">.menu-toggle</span> {
                <span class="hljs-attribute">display</span>: none;
            }
            
            <span class="hljs-selector-class">.nav-links</span> {
                <span class="hljs-attribute">display</span>: flex;
            }
            
            <span class="hljs-selector-class">.col</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>;
            }
        }
        
        <span class="hljs-comment">/* 桌面设备样式 */</span>
        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">992px</span>) {
            <span class="hljs-selector-class">.container</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">970px</span>;
            }
            
            <span class="hljs-selector-class">.col</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">33.333%</span>;
            }
        }
        
        <span class="hljs-comment">/* 大屏幕设备样式 */</span>
        <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1200px</span>) {
            <span class="hljs-selector-class">.container</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">1170px</span>;
            }
            
            <span class="hljs-selector-class">.col</span> {
                <span class="hljs-attribute">width</span>: <span class="hljs-number">25%</span>;
            }
        }
        
        <span class="hljs-comment">/* 打印样式 */</span>
        <span class="hljs-keyword">@media</span> print {
            <span class="hljs-selector-class">.navbar</span>, <span class="hljs-selector-class">.footer</span>, <span class="hljs-selector-class">.menu-toggle</span> {
                <span class="hljs-attribute">display</span>: none;
            }
            
            <span class="hljs-selector-tag">body</span> {
                <span class="hljs-attribute">background</span>: white;
                <span class="hljs-attribute">color</span>: black;
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12pt</span>;
            }
            
            <span class="hljs-selector-class">.card</span> {
                <span class="hljs-attribute">box-shadow</span>: none;
                <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
            }
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 导航栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span>响应式网站<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-links"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>关于我们<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>服务<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>产品<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>联系我们<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"menu-toggle"</span>&gt;</span>☰<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主要内容 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin: 20px 0; text-align: center;"</span>&gt;</span>响应式设计演示<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grid"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 卡片1 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://via.placeholder.com/400x200"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-img"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-content"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>响应式布局<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>使用流体网格和媒体查询创建适应不同屏幕的布局。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-comment">&lt;!-- 卡片2 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://via.placeholder.com/400x200"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-img"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-content"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>弹性图片<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>确保图片在不同设备上都能正确缩放，保持比例。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-comment">&lt;!-- 卡片3 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://via.placeholder.com/400x200"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-img"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-content"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>移动优先<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>从移动设备开始设计，然后逐步增强更大屏幕的体验。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-comment">&lt;!-- 卡片4 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://via.placeholder.com/400x200"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-img"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-content"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>性能优化<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>确保响应式网站在所有设备上都能快速加载和运行。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 页脚 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"footer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-symbol">&amp;copy;</span> 2023 响应式网站示例. 版权所有.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 简单的移动菜单切换</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.menu-toggle'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> navLinks = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.nav-links'</span>);
            <span class="hljs-keyword">if</span> (navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'flex'</span>) {
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
            } <span class="hljs-keyword">else</span> {
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'flex'</span>;
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">flexDirection</span> = <span class="hljs-string">'column'</span>;
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'absolute'</span>;
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">'60px'</span>;
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">right</span> = <span class="hljs-string">'15px'</span>;
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'#2c3e50'</span>;
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">padding</span> = <span class="hljs-string">'15px'</span>;
                navLinks.<span class="hljs-property">style</span>.<span class="hljs-property">borderRadius</span> = <span class="hljs-string">'5px'</span>;
            }
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p><strong><code>视口设置</code></strong> + <strong><code>媒体查询</code></strong> + <strong><code>流体网格</code></strong> = <strong>一个可工作的响应式页面</strong>。</p>
<ol>
<li><strong>视口设置</strong><br/>
这是响应式的<strong>绝对前提</strong>。没有这行代码，媒体查询和所有响应式布局在移动端都会失效。它就像打开响应式大门的<strong>唯一钥匙</strong>。</li>
<li><strong>媒体查询</strong><br/>
这是实现响应式设计的<strong>核心机制</strong>。它是让CSS能够“智能地”感知屏幕尺寸并应用不同样式的<strong>唯一手段</strong>，是所有布局变化的控制中心。</li>
<li><strong>流体网格</strong><br/>
这是响应式布局的<strong>实现基础</strong>。它决定了页面元素能否像水一样流畅地适应容器，是从“固定”思维转向“响应”思维的<strong>根本性变革</strong>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[reddit前副总裁Yishan的AI应用层观点]]></title>    <link>https://juejin.cn/post/7572534419880443939</link>    <guid>https://juejin.cn/post/7572534419880443939</guid>    <pubDate>2025-11-16T09:28:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572534419880443939" data-draft-id="7572534419880394787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="reddit前副总裁Yishan的AI应用层观点"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-16T09:28:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            reddit前副总裁Yishan的AI应用层观点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T09:28:03.000Z" title="Sun Nov 16 2025 09:28:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fyishan%2Fstatus%2F1987787127204249824" target="_blank" title="https://x.com/yishan/status/1987787127204249824" ref="nofollow noopener noreferrer">转载</a></p>
<blockquote>
<p>他的观点基本都认同，归纳一下主要是几个：</p>
</blockquote>
<ol>
<li>这波大模型浪潮里巨头本身就是高增速、超高投入的“巨无霸初创”</li>
<li>应用功能会被快速吸进大模型产品线。——这在chatgpt和anthropic的发展里已经反复验证了。chatgpt总是把最普适的功能融合进来，所谓的“吃应用、吃社区”；而anthropic持续的在提出各种理念先进的新标准、新实践，将应用层的“补丁”瞬间击碎</li>
<li>基础层变化太快，应用根本来不及沉淀出一个“公司”。从当前市值最高的大模型应用公司（~300亿）cursor身上有这么多隐忧，就能一见端倪。</li>
</ol>
<p>所以得他建议是，应用只有这几条出路：</p>
<ol>
<li>赚一波块钱。——我理解现在很多做现有流程提效的，特别是2B的、for电商，打的就是这个心思。他们很清楚自己没有长期的护城河，保持正向现金流，积累认知、培养团队，等下一个范式。</li>
<li>被大公司收购。——你可以说windsurf老板脏，但你不能说他认知低。</li>
<li>找垂直、专业场景，找“真实世界数据护城河”（硬件、数据孤岛）</li>
</ol>
<p>你怎么看？</p>
<h2 data-id="heading-0">原文</h2>
<hr/>
<p>我的AI投资核心观点是，每一家AI应用初创公司都可能被基础模型提供商的快速扩张所碾压。</p>
<p>应用功能将被添加到基础模型的产品中，因为大公司并不像传统意义上的"反应迟钝的老牌企业"（在这里套用"快速初创公司，迟缓老牌企业"的类比是错误的），它们只是规模庞大。与任何其他先前的新技术相比，这是一个巨大且快速变化的浪潮，几乎每个新应用都能在发明的同时被淘汰。几乎没有时间来建立公司并将其规模化。</p>
<p>AI应用初创公司创始人有两种赚钱方式：</p>
<ul>
<li>制作一个昙花一现的应用，赚取大量现金并存入银行（我的估计是您大约有12-18个月的现金流生成时间）</li>
<li>制作一个足够好的应用，被大公司以足够的股权收购</li>
</ul>
<p>这种情况极不稳定——我们不知道它会崩盘还是会暴涨，但这两种情况都使得任何AI应用初创公司不太可能独立成为一代超级公司（基础概率本来就很低）。</p>
<p>最好的机会是在高度专业化的领域找到应用细分市场，这些领域拥有极其独特和具体的数据壁垒，最好是涉及真实原子（硬件或现实世界相关）数据，而不是软件/金融数据。</p>
<hr/>
<p><strong>补充说明：</strong></p>
<p>这个thread引起了很大反响，所以我提供一些额外的跟进说明：</p>
<p>这并不是你典型的"老牌企业很敏捷"的预测，也不是老套的"如果谷歌复制你的初创公司怎么办"这种中等水平投资者的问题。</p>
<p>这个核心观点的全新之处在于，与过去不同，AI行业的特定要素很可能使得应用公司无法跟上被淘汰的浪潮，这个浪潮将比以前的技术浪潮快得多，快得多。</p>
<p>基础技术根本没有以任何方式稳定下来，应用需要一个足够稳定的基础平台在相当长的时间内来创造价值，然后建立一个系统来货币化那个价值（即"一个业务"）。基础性质的根本性变化率是为什么我认为几乎所有应用初创公司都无法存活到实现任何规模化，而不是因为当前的大玩家有什么特别之处。</p>
<p>大多数公司都无法在商业技术环境的重大变革中幸存下来。但这些重大变革发生得足够缓慢，以至于人们可以在之间建立业务。PC、桌面互联网、移动互联网等都花了多年时间发展，并且间隔足够长，让应用公司能够成长、成熟，并自己成为老牌企业。作为基准，大多数初创公司在快速变革时期也无法幸存。少数幸存的老牌企业需要极强的敏捷性，以及在上一纪元足够的稳定立足点（即不会太快消失的收入基础）来资助它们的进化。</p>
<p>此外，通常是新初创公司推动颠覆来挑战老牌企业。AI的情况并非如此。在这种情况下，最大的玩家是那些持续引发重大变革的一方。环境被持续搅动，以至于在下一波浪潮将它们淹没之前，应用初创公司没有稳定的基础来站稳脚跟。我不是在说老牌企业在竞争中击败它们，我是在说格局的变化使它们变得过时。</p>
<p>从实际投资的角度来看，将这个核心观点应用到AI应用初创公司的方法是问：支撑这家初创公司存在的基本假设在五年后会是一样的吗？还是会有不可预测的不同？这里的关键是可预测性——如果未来会完全不同，但你可以自信地预测它，你可以预先调整你的业务定位。但这不是当前AI领域的情况。如果你唯一确定的是20个人将以极高的速度把冰球拍向某个疯狂的方向，你就无法滑向冰球要去的地方。</p>
<p>重大变革现在以9-12个月的周期发生。很少有初创公司能在那个时间框架内成长为成熟的企业——我说的成熟是指拥有所有无聊的东西，比如销售关系和品牌认知。是的，你的工程师可以进行变革，但人类的招聘周期、团队巩固和市场关系是不可压缩的（例如，如果你在一个月内雇佣100人，你的组织就会崩溃）。</p>
<p>因此，应用公司在重大变革发生之前永远无法完全达到业务门槛。当我说老牌企业将占据应用领域时，我是说它们是唯一能够提供足够内部稳定性和资源来在它们自己将推动的重大变革中幸存下来的公司，而不是说它们将提供更优越的产品。它们只是不会饿死的那一批。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[视野修炼-技术周刊第127期 | Valdi]]></title>    <link>https://juejin.cn/post/7572539461478547499</link>    <guid>https://juejin.cn/post/7572539461478547499</guid>    <pubDate>2025-11-16T09:44:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572539461478547499" data-draft-id="7572480736362102790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="视野修炼-技术周刊第127期 | Valdi"/> <meta itemprop="keywords" content="前端,JavaScript,GitHub"/> <meta itemprop="datePublished" content="2025-11-16T09:44:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="粥里有勺糖"/> <meta itemprop="url" content="https://juejin.cn/user/1028798615918983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            视野修炼-技术周刊第127期 | Valdi
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1028798615918983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    粥里有勺糖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T09:44:23.000Z" title="Sun Nov 16 2025 09:44:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎来到第 127 期的【视野修炼 - 技术周刊】，下面是本期的精选内容简介</p>
<p>🔥强烈推荐</p>
<ol>
<li>tasuku - 极简 Node 任务处理</li>
<li>fkill - 强制终止进程</li>
<li>FileMock</li>
</ol>
<p>🔧开源工具&amp;技术资讯</p>
<ol start="4">
<li>Valdi - 新的跨平台 UI 框架</li>
<li>JavaScript 引擎大全</li>
</ol>
<p>📚教程&amp;文章</p>
<ol start="6">
<li>使用 Error.cause 进行错误处理</li>
</ol>
<p>🤖AI工具&amp;资讯</p>
<ol start="7">
<li>GitHub Repo Visibility Analyzer</li>
</ol>

<p>下面开始本期内容的介绍，预计阅读时间 6 分钟。</p>

<h2 data-id="heading-0">🔥强烈推荐</h2>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fprivatenumber%2Ftasuku" target="_blank" title="https://github.com/privatenumber/tasuku" ref="nofollow noopener noreferrer">1. tasuku</a> - 极简 Node 任务处理</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> task <span class="hljs-keyword">from</span> <span class="hljs-string">'tasuku'</span>

<span class="hljs-title function_">task</span>(<span class="hljs-string">'Task 1'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncTask</span>()
})

<span class="hljs-title function_">task</span>(<span class="hljs-string">'Task 2'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncTask</span>()
})

<span class="hljs-title function_">task</span>(<span class="hljs-string">'Task 3'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncTask</span>()
})
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae7c5dbecba247c4bec7b8e3795928ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=qnW5migff0E5SHT4T9C7Z5eodlc%3D" alt="" loading="lazy"/></p>
<p>在做 CLI 的时候可以用上，尤其需要处理多个异步任务时。</p>
<p>还支持嵌套，多状态展示等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d33ca5ec35d04a2dbc6f03443abd4c7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=11plWrB5L%2BI1FWAYcs2CpaD94vg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d93284d8aae5497bb2079bab3842a65e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=uWdsvnAb176mm9h1%2BEk2NBoHS%2Bc%3D" alt="" loading="lazy"/></p>
<p>感觉和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbombshell-dev%2Fclack" target="_blank" title="https://github.com/bombshell-dev/clack" ref="nofollow noopener noreferrer">@clack/prompts</a> 和非常搭配。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35e54507107449f7bae3f55acb0ba282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=0yPCP%2FHGHnEwdAdHk3o1w7vnrLY%3D" alt="" loading="lazy"/></p>
<p>收藏 ⭐️！</p>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsindresorhus%2Ffkill" target="_blank" title="https://github.com/sindresorhus/fkill" ref="nofollow noopener noreferrer">2. fkill</a> - 强制终止进程</h3>
<p>进程大杀器，支持多种终止进程的方式👍🏻，跨平台可用。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fkill <span class="hljs-keyword">from</span> <span class="hljs-string">'fkill'</span>

<span class="hljs-keyword">await</span> <span class="hljs-title function_">fkill</span>(<span class="hljs-number">1337</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Killed process'</span>)

<span class="hljs-title function_">fkill</span>(<span class="hljs-string">'Safari'</span>)
<span class="hljs-title function_">fkill</span>(<span class="hljs-string">':8080'</span>)

<span class="hljs-title function_">fkill</span>([<span class="hljs-number">1337</span>, <span class="hljs-string">'Safari'</span>, <span class="hljs-string">':8080'</span>])
</code></pre>
<p>也支持 CLI 调用。</p>
<pre><code class="hljs language-sh" lang="sh">npm install --global fkill-cli

fkill 1337
fkill Safari
fkill :8080
</code></pre>
<p>还支持 交互式 CLI。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8d17ab0779d4a78b5bb8f74a9eea793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=ercCrZVgUFb589r1z0JDwHFIFHs%3D" alt="" loading="lazy"/></p>
<p>赶紧装上。</p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Ffilemock.com%2F" target="_blank" title="https://filemock.com/" ref="nofollow noopener noreferrer">3. FileMock</a></h3>
<p>免费的测试文件生成器，支持视频/图片/音乐/文档等多种格式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81641c5b9d1b4dcc887522edcf46a994~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=Ns64lU1rVBsNgL2rU7z61yJ2ICo%3D" alt="" loading="lazy"/></p>
<p>收藏⭐️，基本覆盖了常见的文件格式！</p>
<h2 data-id="heading-4">🔧开源工具&amp;技术资讯</h2>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" target="_blank" title="https://github.com/Snapchat/Valdi" ref="nofollow noopener noreferrer">4. Valdi</a> - 新的跨平台 UI 框架</h3>
<p>使用 TypeScript&amp;TSX 编写 UI，可以直接编译成 iOS、Android 和 macOS 上 由 Native 渲染的视图应用，无 JS 中间层。</p>
<p>笔者拉仓库试了一下 Demo，效果如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eab51fed1014c779eb27fe425948e46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=7E2DBvvU9YnLQ1%2BsX8wtw30rFbQ%3D" alt="" loading="lazy"/></p>
<p>感觉还行，就是才刚开源，文档还不是特别友好，项目初始化流程不是特别标准。</p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fivankra.github.io%2Fjavascript-zoo%2F" target="_blank" title="https://ivankra.github.io/javascript-zoo/" ref="nofollow noopener noreferrer">5. JavaScript 引擎大全</a></h3>
<p>包含上百种 JS 引擎的基本信息 ES 支持程度，性能等对比信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73144b5f93e4434a8a67b0031874825d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=pS9zaVkBkXlRQs%2Ficc2A82gLQ6g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">📚教程&amp;文章</h2>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fallthingssmitty.com%2F2025%2F11%2F10%2Ferror-chaining-in-javascript-cleaner-debugging-with-error-cause%2F" target="_blank" title="https://allthingssmitty.com/2025/11/10/error-chaining-in-javascript-cleaner-debugging-with-error-cause/" ref="nofollow noopener noreferrer">6. 使用 Error.cause 进行错误处理</a></h3>
<p>使用 <code>Error.cause</code> 处理错误，保留更清晰的堆栈跟踪信息。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'{ broken: true }'</span>) <span class="hljs-comment">// ← This will fail</span>
  }
  <span class="hljs-keyword">catch</span> (parseError) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Failed to fetch user data'</span>, { <span class="hljs-attr">cause</span>: parseError })
  }
}

<span class="hljs-keyword">try</span> {
  <span class="hljs-title function_">fetchUserData</span>()
}
<span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">message</span>) <span class="hljs-comment">// "Failed to fetch user data"</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">cause</span>) <span class="hljs-comment">// [SyntaxError: Unexpected token b in JSON]</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">cause</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">SyntaxError</span>) <span class="hljs-comment">// true</span>
}
</code></pre>
<h2 data-id="heading-9">🤖AI工具&amp;资讯</h2>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnakora.co%2Ftools%2Fgithub-repo-visibility" target="_blank" title="https://nakora.co/tools/github-repo-visibility" ref="nofollow noopener noreferrer">7. GitHub Repo Visibility Analyzer</a></h3>
<p>这个免费的工具可以对你的仓库进行分析，提供主题标签建议和其他推荐的行动项，帮助开发者更容易地找到你的项目。</p>
<p>提升你在 GitHub 搜索、Google 和大型语言模型（LLMs）中的仓库可见性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e1d0a5943d8455f89f60e7a3440f23f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Kl6YeM5pyJ5Yu657OW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891062&amp;x-signature=70OlFyHvqQKuDvc4kD733IEwfwE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">⭐️强力推荐关注</h2>
<blockquote>
<p>周刊部分内容来源如下渠道，推荐大家关注。</p>
</blockquote>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2Farchives.html" target="_blank" title="https://www.ruanyifeng.com/blog/archives.html" ref="nofollow noopener noreferrer">阮一峰: 科技爱好者周刊</a> - 记录每周值得分享的科技内容，周五发布</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fre321.com%2Fweekly" target="_blank" title="https://www.fre321.com/weekly" ref="nofollow noopener noreferrer">FRE123 技术周刊精选</a> - 技术周刊精选推荐信息流</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis8中新特性:TopK获取最高排名的数据]]></title>    <link>https://juejin.cn/post/7572525491539132458</link>    <guid>https://juejin.cn/post/7572525491539132458</guid>    <pubDate>2025-11-16T09:44:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572525491539132458" data-draft-id="7572793505899954227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis8中新特性:TopK获取最高排名的数据"/> <meta itemprop="keywords" content="后端,Redis"/> <meta itemprop="datePublished" content="2025-11-16T09:44:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="考虑考虑"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335157287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis8中新特性:TopK获取最高排名的数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335157287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    考虑考虑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T09:44:35.000Z" title="Sun Nov 16 2025 09:44:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p><code>Redis8</code>新增了新特性，可以利用<code>TopK</code>获取最高排名的数据</p>
<h3 data-id="heading-1">Topk使用</h3>
<h4 data-id="heading-2">TOPK.RESERVE 初始化</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">TOPK.RESERVE</span> <span class="hljs-string">hello</span> <span class="hljs-number">20</span> <span class="hljs-number">2000 </span><span class="hljs-number">7</span> <span class="hljs-number">0.925</span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 语法</span>

<span class="hljs-comment">#topk: 要保留的出现频率最高项目的数量。</span>

<span class="hljs-comment">#width: 每个数组中保留的计数器数量。（默认值 8）</span>

<span class="hljs-comment">#depth: 数组数量。（默认值 7）</span>

<span class="hljs-comment">#decay: 已占用桶中计数器减少的概率。它会对其计数器进行幂运算 (decay ^ bucket[i].counter)。因此，随着计数器值的升高，减少的几率会降低。（默认值 0.9）</span>

TOPK.RESERVE key topk <span class="hljs-section">[width depth decay]</span>
</code></pre>
<h4 data-id="heading-3">TOPK.ADD 添加一次</h4>
<p>向数据结构添加一个项。可以一次添加多个项。如果一个项进入 Top-K 列表，则返回<code>被逐出的项</code></p>
<p>语法为</p>
<pre><code class="hljs language-css" lang="css">TOPK<span class="hljs-selector-class">.ADD</span> key items <span class="hljs-selector-attr">[items ...]</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1743a0b61745fbafe045409654c28e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=ADhou4hjcaWPHxwKXquAJLmS6%2Bk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">TOPK.INCRBY 带增量分数添加</h4>
<p>按增量增加数据结构中项目的分数。可以一次增加多个项目的分数。如果某个项目进入 Top-K 列表，则返回被逐出的项目</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/522500edb2a64952b7862b0314db0406~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=o2L7owlzu3HV%2F%2FfYSvJlRQnGrPU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">TOPK.INFO 查看信息</h4>
<p>返回所需项目数 (k)、宽度、深度和衰减值。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">TOPK.INFO <span class="hljs-keyword">key</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae7959f2b1b48d38ac49d3df227410d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=WtlbYF0P%2B3QAVWWmOK8S8l7RUws%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">TOPK.LIST 查询Top K 列表</h4>
<p>返回topk列表</p>
<pre><code class="hljs language-css" lang="css">TOPK<span class="hljs-selector-class">.LIST</span> key <span class="hljs-selector-attr">[WITHCOUNT]</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d11ccbc09a44cf39d38c440ddb4afd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=WFQGZH8nCv7Z4iazXdhmujrCLoc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">TOPK.QUERY 检查元素</h4>
<p>语法</p>
<pre><code class="hljs language-css" lang="css">TOPK<span class="hljs-selector-class">.QUERY</span> key item <span class="hljs-selector-attr">[item ...]</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0c96b16a6bd422983550123c6a82de3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=mVQK1aRxt1riAUW3dgc8rHbauCE%3D" alt="image.png" loading="lazy"/>
以下示例</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">TOPK.RESERVE</span> <span class="hljs-string">book1</span> <span class="hljs-number">2</span> <span class="hljs-number">2000 </span><span class="hljs-number">7</span> <span class="hljs-number">0.925</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e11eb643472a4ca481e86f929f402996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=AoJyxtO8jWeLmSnuz2T85UiVrVM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs">TOPK.ADD book1 hello hello1 hello3 hello4
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31e30daa99054469a4f34b41694a5c60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=NKj6%2FsUVF%2Br0sE4XW4x0KSK4GKQ%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs">TOPK.LIST book1
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbdc72e5b3574a708c86856097edf95e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=oTk8AbPxiGDKkdrxGyQsXzuxiNM%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs">TOPK.ADD book1 hello hello1
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff8741d009984c0bb6c52e90090fa92e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=lVGiseO%2BSIsdDQehDpkzSuUdOgw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45285d3babfc40968c4437f3d005a671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=CdgmV71rY4JBWMaZ5Xn7d8x8eY8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e011f7d229204ddd9f7725bcd5c5fbdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICD6JmR6ICD6JmR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891075&amp;x-signature=ht3HNrPNgaO0ms95Ebp1K7WUB8s%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">总结</h3>
<p>可以利用<code>TopK</code>获取最高排名的数据，但是必须时<code>Redis8</code>版本</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[17. Vue3 业务组件库按需加载的实现原理]]></title>    <link>https://juejin.cn/post/7572480736362119174</link>    <guid>https://juejin.cn/post/7572480736362119174</guid>    <pubDate>2025-11-16T09:53:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736362119174" data-draft-id="7567194020462133274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="17. Vue3 业务组件库按需加载的实现原理"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-16T09:53:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cobyte"/> <meta itemprop="url" content="https://juejin.cn/user/668147376989517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            17. Vue3 业务组件库按需加载的实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/668147376989517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cobyte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T09:53:14.000Z" title="Sun Nov 16 2025 09:53:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>最近在公司实现一个业务组件库按需加载的需求。简单来说，有两个需求，第一个是实现业务组件库的按需加载，第二，因为业务组件库里面有引用了类似 Element Plus 的第三方组件库，所以在实现业务组件库按需加载的同时，业务组件库里面的引用的第三方组件库也要实现按需加载。</p>
<p>作为一个编程技术人员，即便有了AI，也需要研究底层的技术原理，甚至需要比没有AI的时代，需要更加深入研究，在AI时代，基础的都通过AI实现了，只有AI解决不了的问题，最终还得靠你自己的专业知识去解决，而这将是你的核心竞争力的体现，所以在AI时代对技术人员的技术素养要求将更加的高。</p>
<p>扯远了，我们回到业务组件库按需加载的实现原理的主题上来。</p>
<p>一般在项目中如果没有进行组件库按需加载配置，都是一开始就全量加载进行全局组件注册，这样就等于整个组件库在初始化的时候就全部加载了，如果在追求性能的项目中，这是不可接受的。这时我们就要实现组件库的按需加载，来提高性能。</p>
<h3 data-id="heading-1">按需加载的基本实现原理</h3>
<p>首先什么是按需加载？</p>
<p>所谓按需加载，顾名思义就是有需要就加载，不需要就不加载，比如 <code>Element Plus</code> 组件库有几十个组件，可能在我们的项目只用到了到了其中一个组件 <code>&lt;el-button&gt;</code>，那么我们就希望只加载跟这个按钮组件相关的代码，从而达到减少打包体积的效果。</p>
<p>按需加载最简单的实现方式就是手动设置，实现如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus/es/components/button'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'element-plus/es/components/button/style/index'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ElButton</span> },
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>我们像上述例子这样手动引用第三方组件库的话，在打包的时候就只会打包引用到的组件，因为目前的开源组件库基本都实现了利于 Tree Shaking 的 <code>ESM</code> 模块化实现。</p>
<p>如果每个业务组件都需要进行上述设置，其实还是挺繁琐的，所以我们希望只在 template 中直接调用就好，其他什么设置都不需要，就像全局注册组件那样使用。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>而剩下部分的代码，我们希望在打包或者运行的时候自动设置上去。主要是以下部分的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus/es/components/button'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'element-plus/es/components/button/style/index'</span>
</code></pre>
<p>上述部分的代码，希望自动加载，而不需要手动设置。整个所谓按需加载所需要实现的就是上述的功能。</p>
<p>那么怎么实现呢？</p>
<p>首先上述模板代码的编译结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createTextVNode <span class="hljs-keyword">as</span> _createTextVNode, resolveComponent <span class="hljs-keyword">as</span> _resolveComponent, withCtx <span class="hljs-keyword">as</span> _withCtx, createVNode <span class="hljs-keyword">as</span> _createVNode, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {
  <span class="hljs-keyword">const</span> _component_el_button = <span class="hljs-title function_">_resolveComponent</span>(<span class="hljs-string">"el-button"</span>)

  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"template"</span>, <span class="hljs-literal">null</span>, [
    <span class="hljs-title function_">_createVNode</span>(_component_el_button, <span class="hljs-literal">null</span>, {
      <span class="hljs-attr">default</span>: <span class="hljs-title function_">_withCtx</span>(<span class="hljs-function">() =&gt;</span> [
        <span class="hljs-title function_">_createTextVNode</span>(<span class="hljs-string">"按钮"</span>)
      ], <span class="hljs-literal">undefined</span>, <span class="hljs-literal">true</span>),
      <span class="hljs-attr">_</span>: <span class="hljs-number">1</span> <span class="hljs-comment">/* STABLE */</span>
    })
  ]))
}
</code></pre>
<p>我们只需要找到 Vue3 的内置函数 <code>_resolveComponent("el-button")</code> 部分，然后替换成对应的组件代码即可。例如：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ import { ElButton } from 'element-plus/es/components/button'</span>
<span class="hljs-addition">+ import 'element-plus/es/components/button/style/index'</span>
import { createTextVNode as _createTextVNode, resolveComponent as _resolveComponent, withCtx as _withCtx, createVNode as _createVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from "vue"

export function render(_ctx, _cache, $props, $setup, $data, $options) {
<span class="hljs-deletion">-  const _component_el_button = _resolveComponent("el-button")</span>
<span class="hljs-addition">+ const _component_el_button = ElButton</span>

  return (_openBlock(), _createElementBlock("template", null, [
    _createVNode(_component_el_button, null, {
      default: _withCtx(() =&gt; [
        _createTextVNode("按钮")
      ], undefined, true),
      _: 1 /* STABLE */
    })
  ]))
}
</code></pre>
<p>上述就是组件库按需加载的基本实现原理。</p>
<h3 data-id="heading-2">使用 Vite 打包组件库</h3>
<p>为了更好还原实际场景，我们快速创建一个组件库项目并且通过 Vite 进行打包。
首先创建一个 <code>cobyte-vite-ui</code> 的组件库目录，在根目录下初始化 Node 项目，执行 <code>pnpm init</code>, 会自动生成 <code>package.json</code>  文件，内容如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cobyte-vite-ui"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"index.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm@10.20.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>在根目录新建 <code>pnpm-workspace.yaml</code> 文件进行 Monorepo 项目配置：</p>
<pre><code class="hljs language-markdown" lang="markdown">packages:
<span class="hljs-bullet">  -</span> packages/*
<span class="hljs-bullet">  -</span> play
</code></pre>
<p>总的目录结构如下：</p>
<pre><code class="hljs language-go" lang="go">├── packages
│   ├── components
│   ├── hooks
│   └── utils
├── play
├── <span class="hljs-keyword">package</span>.json
└── pnpm-workspace.yaml
</code></pre>
<p>接着我们安装一些必要的依赖：</p>
<pre><code class="hljs language-sql" lang="sql">pnpm <span class="hljs-keyword">add</span> vite typescript <span class="hljs-variable">@vitejs</span><span class="hljs-operator">/</span>plugin<span class="hljs-operator">-</span>vue sass <span class="hljs-variable">@types</span><span class="hljs-operator">/</span>node <span class="hljs-operator">-</span>D <span class="hljs-operator">-</span>w
</code></pre>
<p>接着我们安装一下 vue 依赖：</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> vue -w
</code></pre>
<p>基础依赖安装完毕，我们设置一下 TS 的配置，因为我们这个项目是一个 TS 的项目，在根目录创建一个 <code>tsconfig.json</code>，配置内容可以简单设置如下：</p>
<pre><code class="hljs language-js" lang="js">{
    <span class="hljs-string">"compilerOptions"</span>: {
      <span class="hljs-string">"target"</span>: <span class="hljs-string">"ESNext"</span>,
      <span class="hljs-string">"module"</span>: <span class="hljs-string">"NodeNext"</span>,
      <span class="hljs-string">"sourceMap"</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 关键：启用源映射</span>
      <span class="hljs-string">"outDir"</span>: <span class="hljs-string">"./dist"</span>, <span class="hljs-comment">// 可选：指定输出目录</span>
      <span class="hljs-string">"esModuleInterop"</span>: <span class="hljs-literal">true</span>
    }
}
</code></pre>
<p>接着我们就在 <code>packages/components</code> 目录下创建一个测试按钮组件</p>
<p>目录路径：<code>packages/components/button/button.vue</code>，内容如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>测试按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineOptions</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'co-button'</span>,
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-tag">button</span> {
  <span class="hljs-attribute">color</span>: red;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>目录路径：<code>packages/components/button/index.ts</code>，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> button <span class="hljs-keyword">from</span> <span class="hljs-string">"./button.vue"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">CoButton</span> = button;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CoButton</span>;
</code></pre>
<p>目录路径：<code>packages/components/components.ts</code>，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CoButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./button'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
    <span class="hljs-title class_">CoButton</span>
]
</code></pre>
<p>目录路径：<code>packages/components/defaults.ts</code>，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">App</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> components <span class="hljs-keyword">from</span> <span class="hljs-string">'./components'</span>;

<span class="hljs-keyword">const</span> install = <span class="hljs-keyword">function</span> (<span class="hljs-params">app: App</span>) {
    components.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">component</span> =&gt;</span> {
        app.<span class="hljs-title function_">component</span>(component.<span class="hljs-property">name</span>, component);
    });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    install
};
</code></pre>
<p>目录路径：<code>packages/components/index.ts</code>，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./button'</span>;

<span class="hljs-keyword">import</span> install <span class="hljs-keyword">from</span>  <span class="hljs-string">'./defaults'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> install;
</code></pre>
<p>我们再配置一个测试文件，目录路径：<code>packages/utils/index.ts</code>，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testUtils</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'testUtils'</span>);
}
</code></pre>
<p>如果大家对创建组件库比较有经验的话，就知道上述步骤，是 Vue3 组件库的基础设置，各大组件库的实现虽然差异很大，但最核心机制都可以简单归纳为上述设置内容。
大家如果想详细了解更多也可以看看本栏目前面章节的内容。</p>
<p>接着我们就到了我们最核心的组件库打包的环节了，我们在根本目录创建一个 <code>vite.config.ts</code>，设置内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">"@vitejs/plugin-vue"</span>;
<span class="hljs-keyword">import</span> path, { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;

<span class="hljs-comment">// 动态获取组件目录列表</span>
<span class="hljs-keyword">const</span> componentsDir = <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"./packages/components"</span>);
<span class="hljs-keyword">const</span> modules = fs.<span class="hljs-title function_">readdirSync</span>(componentsDir).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> fullPath = path.<span class="hljs-title function_">join</span>(componentsDir, name);
    <span class="hljs-comment">// 只获取目录，排除文件</span>
    <span class="hljs-keyword">return</span> fs.<span class="hljs-title function_">statSync</span>(fullPath).<span class="hljs-title function_">isDirectory</span>();
});

<span class="hljs-keyword">const</span> entryArr = {
    <span class="hljs-comment">// 主入口</span>
    <span class="hljs-attr">index</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"./packages/components/index.ts"</span>),

    <span class="hljs-comment">// 工具入口</span>
    <span class="hljs-attr">utils</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"./packages/utils/index.ts"</span>),
};

<span class="hljs-comment">// 为每个组件创建独立入口</span>
modules.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> {
    entryArr[<span class="hljs-string">`components/<span class="hljs-subst">${name}</span>/index`</span>] = <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">`./packages/components/<span class="hljs-subst">${name}</span>/index.ts`</span>);
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ command, mode }</span>) =&gt;</span> {
    <span class="hljs-comment">// 主构建配置</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">plugins</span>: [
            <span class="hljs-title function_">vue</span>(),
        ],
        <span class="hljs-attr">build</span>: {
            <span class="hljs-attr">lib</span>: {
                <span class="hljs-attr">entry</span>: entryArr,
                <span class="hljs-attr">formats</span>: [<span class="hljs-string">"es"</span>], <span class="hljs-comment">// 只构建 ES 模块</span>
                <span class="hljs-attr">cssFileName</span>: <span class="hljs-string">"style"</span>,
            },
            <span class="hljs-attr">rollupOptions</span>: {
                <span class="hljs-attr">external</span>: [
                    <span class="hljs-string">"vue"</span>,
                ],
                <span class="hljs-attr">output</span>: {
                    <span class="hljs-attr">format</span>: <span class="hljs-string">"es"</span>,
                    <span class="hljs-attr">preserveModules</span>: <span class="hljs-literal">true</span>,
                },
            },
        },
    };
});
</code></pre>
<p>设置完 Vite 配置文件后，我们还要设置 <code>packages.json</code> 中的打包命令脚本配置，设置如下：</p>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"vite build"</span>
  },
</code></pre>
<p>这样我们就可以在根目录运行打包命令了：<code>pnpm build</code>。</p>
<p>运行结果如下，我们成功打包了我们的组件库。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c195ef5bfdd043c2a61e6435e0d4c4f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=eH1wfsF7Js6BvqtC%2BDxoBL6n%2F%2Fs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">通过 pnpm 安装本地 npm 包</h3>
<p>接着我们在根目录下创建一个测试项目：</p>
<pre><code class="hljs language-lua" lang="lua">pnpm <span class="hljs-built_in">create</span> vite play <span class="hljs-comment">--template vue-ts</span>
</code></pre>
<p>上述 play 就是测试项目目录，我们原本就建了一个 play 目录，现在这条命令会直接在 play 目录中生成一个使用 Vite 创建的 Vue 项目。</p>
<p>接着我们修改根目录的 package.json 文件：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- "main": "index.js",</span>
<span class="hljs-addition">+ "module": "/dist/index.mjs",</span>
</code></pre>
<p>接着我们进入 play 目录，通过 pnpm 安装本地 npm 包，命令如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> ../
</code></pre>
<p>运行完上述命令，我们可以看到 <code>./play/packages.json</code> 文件变化如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3f21a2e6b8f4ee08a4a56ae78e9f51e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=Ncv1XBWGcAnuKu80OthFOvYu7JA%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到我们成功把我们本地的 npm 包安装到 play 测试项目中了。</p>
<p>接着修改 <code>./play/main.ts</code> 内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CobyteViteUI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'cobyte-vite-ui'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'cobyte-vite-ui/dist/style.css'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">CobyteViteUI</span>)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>我们直接引用我们本地创建的 npm 包。</p>
<p>接着修改 <code>./play/App.vue</code> 内容如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">co-button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">co-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>最后我们运行 play 测试项目，结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74f6c189f9d44171887736447e2e142d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=Gm4jArr6V67Ej23r5YO1bv6KPWc%3D" alt="image.png" loading="lazy"/></p>
<p>我们可以看到成功运行了本地组件库的 npm 包。</p>
<p>接下来我们希望不进行完整引入组件库：</p>
<pre><code class="hljs language-diff" lang="diff">import { createApp } from 'vue'
import App from './App.vue'
<span class="hljs-deletion">- import CobyteViteUI from 'cobyte-vite-ui'</span>
<span class="hljs-deletion">- import 'cobyte-vite-ui/dist/style.css'</span>

const app = createApp(App)
<span class="hljs-deletion">- app.use(CobyteViteUI)</span>
app.mount('#app')
</code></pre>
<p>即便这样我们同样可以在测试项目中使用我们的测试组件。</p>
<h3 data-id="heading-4">通过静态分析实现按需加载</h3>
<p>根据上文我们知道 App.vue 的模板内容会被编译成：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { resolveComponent <span class="hljs-keyword">as</span> _resolveComponent, createVNode <span class="hljs-keyword">as</span> _createVNode, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {
  <span class="hljs-keyword">const</span> _component_co_button = <span class="hljs-title function_">_resolveComponent</span>(<span class="hljs-string">"co-button"</span>)

  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"template"</span>, <span class="hljs-literal">null</span>, [
    <span class="hljs-title function_">_createVNode</span>(_component_co_button)
  ]))
}
</code></pre>
<p>那么根据上文我们知道需要把 <code>_resolveComponent("co-button")</code> 部分替换成对应的组件对象，内容如下：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ import CoButton from 'cobyte-vite-ui/dist/components/button'</span>
<span class="hljs-addition">+ import 'cobyte-vite-ui/dist/style.css'</span>
import { resolveComponent as _resolveComponent, createVNode as _createVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from "vue"

export function render(_ctx, _cache, $props, $setup, $data, $options) {
<span class="hljs-deletion">-  const _component_co_button = _resolveComponent("co-button")</span>
<span class="hljs-addition">+  const _component_co_button = CoButton</span>

  return (_openBlock(), _createElementBlock("template", null, [
    _createVNode(_component_co_button)
  ]))
}
</code></pre>
<p>那么要实现上述功能，我们得通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vitejs.dev%2Fguide%2Fapi-plugin" target="_blank" title="https://cn.vitejs.dev/guide/api-plugin" ref="nofollow noopener noreferrer">Vite 插件</a>来实现，我们在上面安装了一个 <code>@vitejs/plugin-vue</code> 插件，这个 Vite 插件的主要功能就是把 <code>.vue</code> 文件编译成上述的 js 内容。那么我们这样在它的后面继续添加一个插件在编译后的 js 内容中去实现上述替换功能即可。</p>
<p>我们在 <code>./packages/utils/index.ts</code> 文件中实现这个自动加载组件的 Vite 插件，实现如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">MagicString</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'magic-string'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">VitePluginAutoComponents</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 插件名称，用于调试和错误信息</span>
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vite-plugin-auto-component'</span>,

    <span class="hljs-comment">// transform 钩子函数，在转换模块时调用</span>
    <span class="hljs-comment">// code: 文件内容，id: 文件路径</span>
    <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-comment">// 使用正则表达式检查文件是否为.vue文件</span>
      <span class="hljs-comment">// 如果不是.vue文件，不进行处理</span>
      <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/\.vue$/</span>.<span class="hljs-title function_">test</span>(id)) {
          <span class="hljs-comment">// 创建 MagicString 实例，用于高效地修改字符串并生成 source map</span>
          <span class="hljs-keyword">const</span> s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MagicString</span>(code)
          <span class="hljs-comment">// 初始化结果数组，用于存储匹配到的组件信息</span>
          <span class="hljs-keyword">const</span> results = []

          <span class="hljs-comment">// 使用 matchAll 方法查找所有匹配的 resolveComponent 调用</span>
          <span class="hljs-comment">// 正则表达式解释：</span>
          <span class="hljs-comment">// _?resolveComponent\d* - 匹配可能的函数名变体（可能带下划线或数字后缀）</span>
          <span class="hljs-comment">// \("(.+?)"\) - 匹配括号内的字符串参数</span>
          <span class="hljs-comment">// g - 全局匹配</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> match <span class="hljs-keyword">of</span> code.<span class="hljs-title function_">matchAll</span>(<span class="hljs-regexp">/_?resolveComponent\d*\("(.+?)"\)/g</span>)) {
              <span class="hljs-comment">// match[1] 是第一个捕获组，即组件名称字符串</span>
              <span class="hljs-keyword">const</span> matchedName = match[<span class="hljs-number">1</span>]
              <span class="hljs-comment">// 检查匹配是否有效：</span>
              <span class="hljs-comment">// match.index != null - 确保有匹配位置</span>
              <span class="hljs-comment">// matchedName - 确保捕获到组件名</span>
              <span class="hljs-comment">// !matchedName.startsWith('_') - 确保组件名不以_开头（可能是内部组件）</span>
              <span class="hljs-keyword">if</span> (match.<span class="hljs-property">index</span> != <span class="hljs-literal">null</span> &amp;&amp; matchedName &amp;&amp; !matchedName.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'_'</span>)) {
                  <span class="hljs-comment">// 计算匹配字符串的起始位置</span>
                  <span class="hljs-keyword">const</span> start = match.<span class="hljs-property">index</span>
                  <span class="hljs-comment">// 计算匹配字符串的结束位置</span>
                  <span class="hljs-keyword">const</span> end = start + match[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>
                  <span class="hljs-comment">// 将匹配信息存入结果数组</span>
                  results.<span class="hljs-title function_">push</span>({
                      <span class="hljs-attr">rawName</span>: matchedName,  <span class="hljs-comment">// 原始组件名称</span>
                      <span class="hljs-comment">// 创建替换函数，使用 MagicString 的 overwrite 方法替换指定范围的文本</span>
                      <span class="hljs-attr">replace</span>: <span class="hljs-function"><span class="hljs-params">resolved</span> =&gt;</span> s.<span class="hljs-title function_">overwrite</span>(start, end, resolved),
                  })
              }
          }

          <span class="hljs-comment">// 遍历所有匹配结果进行处理</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { rawName, replace } <span class="hljs-keyword">of</span> results) {
              <span class="hljs-comment">// 定义要替换的变量名（这里暂时编码为 CoButton）</span>
              <span class="hljs-keyword">const</span> varName = <span class="hljs-string">`CoButton`</span>
              <span class="hljs-comment">// 在代码开头添加导入语句：</span>
              <span class="hljs-comment">// 1. 导入 CoButton 组件</span>
              <span class="hljs-comment">// 2. 导入样式文件</span>
              s.<span class="hljs-title function_">prepend</span>(<span class="hljs-string">`import CoButton from 'cobyte-vite-ui/dist/components/button';\nimport 'cobyte-vite-ui/dist/style.css';\n`</span>)

              <span class="hljs-comment">// 执行替换：将 resolveComponent("xxx") 调用替换为组件变量名</span>
              <span class="hljs-title function_">replace</span>(varName)
          }

          <span class="hljs-comment">// 返回转换后的代码</span>
          <span class="hljs-keyword">return</span> {
              <span class="hljs-attr">code</span>: s.<span class="hljs-title function_">toString</span>(),  <span class="hljs-comment">// 转换后的代码字符串</span>
              <span class="hljs-attr">map</span>: <span class="hljs-literal">null</span>, 
          }
      }
    },
  }
}
</code></pre>
<p>我们在上述 Vite 插件中使用到了一个新工具库 <code>magic-string</code>，我们需要安装一下它的依赖：</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> magic-<span class="hljs-built_in">string</span> -D -w
</code></pre>
<p><code>magic-string</code> 是一个专注于字符串操作，主要作用是对源代码可以进行<strong>精准的插入、删除、替换等操作</strong>。</p>
<p>上述编写的 Vite 的插件主要是实现在<code>.vue</code> 文件中查找所有形如 <code>resolveComponent("xxx")</code> 的函数调用，对于每一个找到的调用，它会在文件顶部添加一个固定的导入语句，例如导入 <code>CoButton</code> 组件和样式。最后把找到的<code>resolveComponent("xxx")</code> 替换成对应的组件，例如 <code>CoButton</code>。</p>
<p>然后我们在根目录重新打包，接着在 play 目录中的 <code>vite.config.ts</code> 文件中进行以下修改：</p>
<pre><code class="hljs language-diff" lang="diff">import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
<span class="hljs-addition">+ import AutoComponents from 'cobyte-vite-ui/dist/utils'</span>

// https://vite.dev/config/
export default defineConfig({
<span class="hljs-deletion">-  plugins: [vue()],</span>
<span class="hljs-addition">+  plugins: [vue(), AutoComponents()],</span>
})
</code></pre>
<p>接着我们再次重启 play 测试项目，我们可以看到即便我们不导入任何我们编写的组件库设置，我们依然可以在 play 项目中成功使用 <code>CoButton</code> 组件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74f6c189f9d44171887736447e2e142d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=Gm4jArr6V67Ej23r5YO1bv6KPWc%3D" alt="image.png" loading="lazy"/></p>
<p>同时我们在网络窗口可以查看到 App.vue 文件的内容变化如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f36029b5c57d4c9ca82ddb0fecd2f3be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=9HKmjVIGmaHnjRhtNwhl00IzxsY%3D" alt="image.png" loading="lazy"/></p>
<p>可以看到<strong>我们通过静态分析代码，识别并替换 Vue3 的组件解析函数，成功实现了组件的自动导入功能</strong>。但上述实现为了快速验证功能，无论匹配到的组件名是什么，都导入 <code>CoButton</code> 组件，并替换为 <code>CoButton</code>。这显然是不正确的，应该根据匹配到的组件名动态导入对应的组件。</p>
<h3 data-id="heading-5">自动化路径解析</h3>
<p>因为我们的组件编译后的调用变成 <code>_resolveComponent("co-button")</code>，组件名称变成了 <code>co-button</code>，而我们在导入的语句是这样的 <code>import CoButton from 'cobyte-vite-ui/dist/components/button'</code>，组件名称又需要变成 <code>CoButton</code>，所以我们需要把匹配到的 <code>co-button</code> 变成 <code>CoButton</code>。</p>
<p>代码迭代如下：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ // 将字符串转换为帕斯卡命名（即大驼峰，每个单词首字母大写）</span>
<span class="hljs-addition">+ export function pascalCase(str: string) {</span>
<span class="hljs-addition">+    return capitalize(camelCase(str))</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ // 将字符串转换为驼峰命名  </span>
<span class="hljs-addition">+ export function camelCase(str: string) {</span>
<span class="hljs-addition">+    return str.replace(/-(\w)/g, (_, c) =&gt; (c ? c.toUpperCase() : ''))</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ // 将字符串的首字母大写，使用 charAt(0) 获取第一个字符并转换为大写，然后加上剩余字符串（从索引1开始）</span>
<span class="hljs-addition">+ export function capitalize(str: string) {</span>
<span class="hljs-addition">+    return str.charAt(0).toUpperCase() + str.slice(1)</span>
<span class="hljs-addition">+ }</span>

export default function VitePluginAutoComponents() {
    return {
      // 插件名称，用于调试和错误信息
      name: 'vite-plugin-auto-component',
  
      // transform 钩子函数，在转换模块时调用
      // code: 文件内容，id: 文件路径
      transform(code, id) {
        // 使用正则表达式检查文件是否为.vue文件
        // 如果不是.vue文件，不进行处理
        if(/\.vue$/.test(id)) {
            // 省略...
  
            // 遍历所有匹配结果进行处理
            for (const { rawName, replace } of results) {
<span class="hljs-addition">+                // 将字符串转换为大驼峰</span>
<span class="hljs-addition">+                const name = pascalCase(rawName)</span>
<span class="hljs-addition">+                // 只处理 Co 开头的组件</span>
<span class="hljs-addition">+                if (!name.match(/^Co[A-Z]/)) return</span>
                // 定义要替换的变量名
<span class="hljs-deletion">-                const varName = `CoButton`</span>
<span class="hljs-addition">+                const varName = name</span>
                // 在代码开头添加导入语句：
                // 1. 导入 CoButton 组件
                // 2. 导入样式文件
                s.prepend(`\nimport ${varName} from 'cobyte-vite-ui/dist/components/button';\nimport 'cobyte-vite-ui/dist/style.css';\n`)
  
                // 执行替换：将 resolveComponent("xxx") 调用替换为组件变量名
                replace(varName)
            }
  
            // 返回转换后的代码
            return {
                code: s.toString(),  // 转换后的代码字符串
                map: null, 
            }
        }
      },
    }
}
</code></pre>
<p>经过上述实现还是存在以下问题，无论 <code>rawName</code> 是什么，组件都是从 <code>'cobyte-vite-ui/dist/components/button'</code> 这个固定路径导入。这意味着即使使用了 <code>resolveComponent("CoTable")</code>，插件依然会尝试从 <code>button</code> 文件导入，这显然是不正确的。理想情况下，导入路径应根据组件名动态生成。所以我们继续实现动态组件路径，例如 <code>CoTableColumn</code> 组件映射到 <code>'cobyte-vite-ui/dist/components/table-column'</code>。</p>
<p>我们上述的组件是 "CoButton"，那么转换过程则是：<br/>
"CoButton" -&gt; 去掉"Co" -&gt; "Button" -&gt; kebabCase -&gt; "button"。</p>
<p>我们通过实现一个 kebabCase 函数进行组件路径转换解析，实现如下：</p>
<pre><code class="hljs language-diff" lang="diff">// 省略...

<span class="hljs-addition">+ // 将驼峰命名的字符串转换为短横线分隔的字符串（即kebab-case）</span>
<span class="hljs-addition">+ export function kebabCase(key: string) {</span>
<span class="hljs-addition">+    const result = key.replace(/([A-Z])/g, ' $1').trim()</span>
<span class="hljs-addition">+    return result.split(' ').join('-').toLowerCase()</span>
<span class="hljs-addition">+ }</span>

export default function VitePluginAutoComponents() {
    return {
      // 插件名称，用于调试和错误信息
      name: 'vite-plugin-auto-component',
  
      // transform 钩子函数，在转换模块时调用
      // code: 文件内容，id: 文件路径
      transform(code, id) {
        // 使用正则表达式检查文件是否为.vue文件
        // 如果不是.vue文件，不进行处理
        if(/\.vue$/.test(id)) {
            // 省略...
  
            // 遍历所有匹配结果进行处理
            for (const { rawName, replace } of results) {
                // 将字符串转换为大驼峰
                const name = pascalCase(rawName)
                // 只处理 Co 开头的组件
                if (!name.match(/^Co[A-Z]/)) return
<span class="hljs-addition">+                // 组件路径转换</span>
<span class="hljs-addition">+                const partialName = kebabCase(name.slice(2))</span>
                // 定义要替换的变量名
                const varName = name
                // 在代码开头添加导入语句：
                // 1. 导入 CoButton 组件
                // 2. 导入样式文件
<span class="hljs-deletion">-                s.prepend(`\nimport ${varName} from 'cobyte-vite-ui/dist/components/button';\nimport 'cobyte-vite-ui/dist/style.css';\n`)</span>
<span class="hljs-addition">+                s.prepend(`\nimport ${varName} from 'cobyte-vite-ui/dist/components/${partialName}';\nimport 'cobyte-vite-ui/dist/style.css';\n`)</span>
  
                // 执行替换：将 resolveComponent("xxx") 调用替换为组件变量名
                replace(varName)
            }
  
            // 返回转换后的代码
            return {
                code: s.toString(),  // 转换后的代码字符串
                map: null, 
            }
        }
      },
    }
}
</code></pre>
<p>经过上述迭代后，我们重新打包，重新启动 play 测试项目，我们发现我们的代码是能够正常运行的，说明我们上述的迭代是没有问题的。<strong>至此我们为组件自动导入提供了核心的路径解析能力</strong>。</p>
<h3 data-id="heading-6">引入解析器 (Resolver) 概念</h3>
<p>当前插件硬编码了组件库的路径和样式文件，只能用于特定的组件库（cobyte-vite-ui）。我们可以通过引入解析器(Resolver)，让插件支持不同的组件库，用户可以根据需要配置不同的解析器。</p>
<p>解析器的作用是根据组件名返回一个解析结果，包括组件的导入路径和样式文件路径以及组件原始名称。这样，插件就可以通过解析器返回的对象信息动态获取组件的导入信息，而不是固定写死。</p>
<p>在实现解析器之前，我们先设计解析器返回的对象结构如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> component = {
    name, <span class="hljs-comment">// 组件原始名称</span>
    <span class="hljs-attr">from</span>: <span class="hljs-string">`cobyte-vite-ui/dist/components/<span class="hljs-subst">${partialName}</span>`</span>, <span class="hljs-comment">// 组件的导入路径</span>
    <span class="hljs-attr">sideEffects</span>: [<span class="hljs-string">'cobyte-vite-ui/dist/style.css'</span>] <span class="hljs-comment">// 组件的样式文件路径</span>
}
</code></pre>
<p>为什么要这样设计？</p>
<ol>
<li>组件名 (name):<br/>
用于在导入语句中作为标识符。这里使用的是帕斯卡命名，因为它在 Vue 中通常用于组件注册和模板中。</li>
<li>导入路径 (from):<br/>
这里使用模板字符串动态构建导入路径。其中，<code>partialName</code> 是通过将组件名去掉前两个字符（即去掉"Co"）并转换为 kebab-case 得到的。<br/>
例如，组件名 "CoTableColumn" 转换为 "table-column"，然后拼接成路径 'cobyte-vite-ui/dist/components/table-column'。<br/>
这样设计是因为组件库的目录结构可能是按照 kebab-case 命名的，而组件在代码中是以帕斯卡命名使用的。</li>
<li>副作用 (sideEffects):<br/>
这是一个数组，指定在导入组件时需要同时导入的样式文件或其他资源。这里指定了组件库的全局样式文件。<br/>
注意：这个样式文件是全局的，也就是说，不管导入哪个组件，都会导入整个组件库的样式。这可能会造成样式冗余。<br/>
更精细的做法是为每个组件指定其对应的样式文件，例如：<br/>
sideEffects: [<code>cobyte-vite-ui/dist/components/${partialName}/style.css</code>]</li>
</ol>
<p>但是，我们当前组件库没有为每个组件单独提供样式文件，我们只提供了固定的全局样式文件。</p>
<p>上面设计解析器返回的对象封装了组件的完整导入信息，作为数据载体传递给后续处理函数，我们可以基于此进行迭代：</p>
<pre><code class="hljs language-diff" lang="diff">// 省略...

<span class="hljs-addition">+ // 根据传入的信息生成对应的导入语句字符串</span>
<span class="hljs-addition">+ export function stringifyImport(info) {</span>
<span class="hljs-addition">+    if (typeof info === 'string')</span>
<span class="hljs-addition">+      return `import '${info}'`</span>
<span class="hljs-addition">+    if (!info.as)</span>
<span class="hljs-addition">+      return `import '${info.from}'`</span>
<span class="hljs-addition">+    else if (info.name)</span>
<span class="hljs-addition">+      return `import { ${info.name} as ${info.as} } from '${info.from}'`</span>
<span class="hljs-addition">+    else</span>
<span class="hljs-addition">+      return `import ${info.as} from '${info.from}'`</span>
<span class="hljs-addition">+ }</span>
<span class="hljs-addition">+ // 根据组件的导入信息生成完整的导入语句，包括组件本身的导入和其副作用（如样式文件）的导入。</span>
<span class="hljs-addition">+ export function stringifyComponentImport({ as: name, from: path, name: importName, sideEffects }) {</span>
<span class="hljs-addition">+    const imports = [</span>
<span class="hljs-addition">+      // 生成组件导入语句</span>
<span class="hljs-addition">+      stringifyImport({ as: name, from: path, name: importName }),</span>
<span class="hljs-addition">+    ]</span>
  
<span class="hljs-addition">+    if (sideEffects) {</span>
<span class="hljs-addition">+      // 生成副作用导入语句</span>
<span class="hljs-addition">+      sideEffects.forEach(i =&gt; imports.push(stringifyImport(i)))</span>
<span class="hljs-addition">+    }</span>
  
<span class="hljs-addition">+    return imports.join(';')</span>
<span class="hljs-addition">+ }</span>

  export default function VitePluginAutoComponents() {
    return {
      // 插件名称，用于调试和错误信息
      name: 'vite-plugin-auto-component',
  
      // transform 钩子函数，在转换模块时调用
      // code: 文件内容，id: 文件路径
      transform(code, id) {
        // 使用正则表达式检查文件是否为.vue文件
        // 如果不是.vue文件，不进行处理
        if(/\.vue$/.test(id)) {
            // 省略...
<span class="hljs-addition">+            let no = 0</span>
            // 遍历所有匹配结果进行处理
            for (const { rawName, replace } of results) {
                // 将字符串转换为大驼峰
                const name = pascalCase(rawName)
                // 只处理 Co 开头的组件
                if (!name.match(/^Co[A-Z]/)) return
                // 组件路径转换
                const partialName = kebabCase(name.slice(2))
<span class="hljs-addition">+                // 封装了组件的完整导入信息，作为数据载体传递给后续处理函数</span>
<span class="hljs-addition">+                const component = {</span>
<span class="hljs-addition">+                    name,</span>
<span class="hljs-addition">+                    from: `cobyte-vite-ui/dist/components/${partialName}`,</span>
<span class="hljs-addition">+                    sideEffects: ['cobyte-vite-ui/dist/style.css']</span>
<span class="hljs-addition">+                }</span>
<span class="hljs-deletion">-                // 定义要替换的变量名（这里暂时编码为 CoButton）</span>
<span class="hljs-deletion">-                const varName = name</span>
<span class="hljs-addition">+                // 使用特殊前缀减少与用户变量的冲突，以及使用递增的序号，保证唯一性，避免变量名冲突</span>
<span class="hljs-addition">+                const varName = `__unplugin_components_${no}`</span>
                // 在代码开头添加导入语句：
                // 1. 导入 CoButton 组件
                // 2. 导入样式文件
<span class="hljs-deletion">-                 s.prepend(`\nimport ${varName} from 'cobyte-vite-ui/dist/components/${partialName}';\nimport 'cobyte-vite-ui/dist/style.css';\n`)</span>
<span class="hljs-addition">+                // 这里将 component 对象展开，并添加 as: varName 参数，形成完整的导入配置</span>
<span class="hljs-addition">+                s.prepend(`${stringifyComponentImport({ ...component, as: varName })};\n`)</span>
<span class="hljs-addition">+                no += 1</span>
                // 执行替换：将 resolveComponent("xxx") 调用替换为组件变量名
                replace(varName)
            }
  
            // 返回转换后的代码
            return {
                code: s.toString(),  // 转换后的代码字符串
                map: null, 
            }
        }
      },
    }
}
</code></pre>
<p>我们添加了根据传入的信息生成对应的导入语句字符串的 <code>stringifyImport</code> 函数和根据组件的导入信息生成完整的导入语句，包括组件本身的导入和其副作用（如样式文件）的导入的 <code>stringifyComponentImport</code> 函数。其中 stringifyImport 处理单一导入语句，<code>stringifyComponentImport</code> 处理组合多个相关导入，实现了职责分离和配置灵活的设计优势。这两个函数共同构成了一个灵活的导入语句生成系统，为自动导入插件提供了强大的代码生成能力。</p>
<p>我们设计了一个解析结果包括：<code>name</code>（组件名）、<code>from</code>（导入路径）、<code>sideEffects</code>（样式等副作用导入）的数据结构对象 <code>component</code> 作为数据载体传递给后续处理函数，后续程序基于此来生成导入语句和替换代码。</p>
<p>其中变量名生成策略使用特殊前缀减少与用户变量的冲突从而<strong>避免污染</strong>，同时使用递增序号来<strong>保证唯一性</strong>。</p>
<p>最终我们实现了一个基于数据驱动的架构，将来解析器只负责识别组件和返回路径的数据信息，然后导入生成器函数，也就是上述的 <code>stringifyComponentImport</code> 和 <code>stringifyImport</code> 负责根据配置生成导入代码，我们整体的 Vite 插件就只负责协调流程和代码修改。</p>
<p>这种架构为后续引入真正的多解析器支持奠定了良好基础，只需要将硬编码的解析逻辑替换为可配置的解析器数组即可。</p>
<h3 data-id="heading-7">实现解析器 (Resolver)</h3>
<p>我们引入解析器是为了提高插件的灵活性和可扩展性。当前插件硬编码了组件库的路径和样式文件，只能用于特定的组件库（cobyte-vite-ui）。通过引入解析器，我们可以让插件支持不同的组件库，用户可以根据需要配置不同的解析器。</p>
<p>解析器的作用是根据组件名返回一个解析结果，包括组件的导入路径和样式文件路径等。这样，插件就可以通过解析器来动态获取组件的导入信息，而不是固定写死。</p>
<p>改造步骤：</p>
<ol>
<li>修改插件函数，使其可以接受一个选项对象，选项中包含解析器数组。</li>
<li>在插件内部，遍历解析器数组，对每个组件名尝试使用解析器进行解析。</li>
<li>如果某个解析器返回了结果，则使用该结果来生成导入语句。</li>
<li>如果没有解析器匹配，可以跳过该组件，也可以根据需求做其他处理。</li>
</ol>
<p>参考 <code>NaiveUi</code> 基于 <code>unplugin-vue-components</code> 实现的解析器结构：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NaiveUiResolver</span>(<span class="hljs-params"/>): <span class="hljs-title class_">ComponentResolver</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'component'</span>,
    <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">name: string</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^(N[A-Z]|n-[a-z])/</span>))
        <span class="hljs-keyword">return</span> { name, <span class="hljs-attr">from</span>: <span class="hljs-string">'naive-ui'</span>, <span class="hljs-attr">sideEffects</span>: [] }
    },
  }
}
</code></pre>
<ul>
<li>解析器是一个对象，包含一个<code>resolve</code>方法，该方法接收组件名，返回一个解析结果对象或undefined。</li>
<li>解析结果对象包括：<code>name</code>（组件名，可选，默认使用原始名），<code>from</code>（导入路径），<code>sideEffects</code>（样式文件路径等，可选）</li>
</ul>
<p>我们还可以支持多种解析器，这样插件可以同时支持多个组件库。</p>
<p>下面我们按照这个思路改造插件代码。首先基于上述 <code>NaiveUi</code> 的解析器实现我们的测试组件的解析器，<code>./packages/utils/index.ts</code> 新增代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 解析器函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CobyteViteUiResolver</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'component'</span>,
    <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">name: string</span>) =&gt;</span> {
      <span class="hljs-comment">// 只处理 Co 开头的组件</span>
      <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^Co[A-Z]/</span>)) {
        <span class="hljs-keyword">const</span> partialName = <span class="hljs-title function_">kebabCase</span>(name.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)) <span class="hljs-comment">// CoTableColumn -&gt; table-column</span>
        <span class="hljs-keyword">return</span> { 
          name, 
          <span class="hljs-attr">from</span>: <span class="hljs-string">`cobyte-vite-ui/dist/components/<span class="hljs-subst">${partialName}</span>`</span>, 
          <span class="hljs-attr">sideEffects</span>: [<span class="hljs-string">'cobyte-vite-ui/dist/style.css'</span>] 
        }
      }
    },
  }
}
</code></pre>
<p>接下来修改插件函数，使其可以接受一个选项对象，选项中包含解析器数组，采用上下文管理，因此我们引入 Context 类，创建 Context 类来管理插件配置和解析器，并缓存解析结果，接着在 transform 钩子中，使用 Context 实例来查找组件，而不是硬编码解析逻辑。</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+ export class Context {</span>
<span class="hljs-addition">+  options: any;</span>
<span class="hljs-addition">+  private _componentNameMap = {} // 组件缓存</span>
<span class="hljs-addition">+  constructor(private rawOptions: any) {</span>
<span class="hljs-addition">+    this.options = rawOptions</span>
<span class="hljs-addition">+  }</span>

<span class="hljs-addition">+  async findComponent(name: string) {</span>
<span class="hljs-addition">+    // 1. 检查缓存中是否有该组件的信息</span>
<span class="hljs-addition">+    let info = this._componentNameMap[name]</span>
<span class="hljs-addition">+    if (info) {</span>
<span class="hljs-addition">+      return info // 缓存命中，直接返回</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    // 2. 遍历所有解析器</span>
<span class="hljs-addition">+    for (const resolver of this.options.resolvers) {</span>
<span class="hljs-addition">+      const result = await resolver.resolve(name)</span>
<span class="hljs-addition">+      // 3. 判断解析器是否返回了结果</span>
<span class="hljs-addition">+      if (!result) {</span>
<span class="hljs-addition">+        continue</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      // 4. 构建完整组件信息</span>
<span class="hljs-addition">+      info = {</span>
<span class="hljs-addition">+        as: name, // 添加别名</span>
<span class="hljs-addition">+        ...result,</span>
<span class="hljs-addition">+      }</span>
<span class="hljs-addition">+      // 5. 存入缓存</span>
<span class="hljs-addition">+      this._componentNameMap[name] = info</span>
<span class="hljs-addition">+      return info</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+    // 所有解析器都不匹配，返回 undefined</span>
<span class="hljs-addition">+  }</span>
<span class="hljs-addition">+ }</span>

<span class="hljs-deletion">-  export default function VitePluginAutoComponents() {</span>
<span class="hljs-addition">+  export default function VitePluginAutoComponents(options = {}) {</span>
<span class="hljs-addition">+    // 创建 Context 实例，用于存储插件配置和组件信息</span>
<span class="hljs-addition">+    const ctx = new Context(options)</span>
    return {
      // 插件名称，用于调试和错误信息
      name: 'vite-plugin-auto-component',
  
      // transform 钩子函数，在转换模块时调用
      // code: 文件内容，id: 文件路径
      async transform(code, id) {
        // 使用正则表达式检查文件是否为.vue文件
        // 如果不是.vue文件，不进行处理
        if(/\.vue$/.test(id)) {
            // 省略...
            
            let no = 0
            // 遍历所有匹配结果进行处理
            for (const { rawName, replace } of results) {
                // 将字符串转换为大驼峰
                const name = pascalCase(rawName)
<span class="hljs-deletion">-                // 只处理 Co 开头的组件</span>
<span class="hljs-deletion">-                 if (!name.match(/^Co[A-Z]/)) return</span>
<span class="hljs-deletion">-                // 组件路径转换</span>
<span class="hljs-deletion">-                 const partialName = kebabCase(name.slice(2))</span>
<span class="hljs-deletion">-                // 封装了组件的完整导入信息，作为数据载体传递给后续处理函数</span>
<span class="hljs-deletion">-                 const component = {</span>
<span class="hljs-deletion">-                     name,</span>
<span class="hljs-deletion">-                     from: `cobyte-vite-ui/dist/components/${partialName}`,</span>
<span class="hljs-deletion">-                     sideEffects: ['cobyte-vite-ui/dist/style.css']</span>
<span class="hljs-deletion">-                 }</span>
<span class="hljs-addition">+                const component = await ctx.findComponent(name)</span>
<span class="hljs-addition">+                if (component) {</span>
                  // 定义要替换的变量名（这里暂时编码为 CoButton）
                  // const varName = name
                  // 使用特殊前缀减少与用户变量的冲突，以及使用递增的序号，保证唯一性，避免变量名冲突
                  const varName = `__unplugin_components_${no}`
                  // 在代码开头添加导入语句：
                  // 1. 导入 CoButton 组件
                  // 2. 导入样式文件
                  // s.prepend(`\nimport ${varName} from 'cobyte-vite-ui/dist/components/${partialName}';\nimport 'cobyte-vite-ui/dist/style.css';\n`)
                  // 这里将 component 对象展开，并添加 as: varName 参数，形成完整的导入配置
                  s.prepend(`${stringifyComponentImport({ ...component, as: varName })};\n`)
                  no += 1
                  // 执行替换：将 resolveComponent("xxx") 调用替换为组件变量名
                  replace(varName)
<span class="hljs-addition">+                }</span>
            }
  
            // 返回转换后的代码
            return {
                code: s.toString(),  // 转换后的代码字符串
                map: null, 
            }
        }
      },
    }
}
</code></pre>
<p>插件初始化时，创建 Context 实例，传入options，其中包含解析器 resolvers。Context 类提供了一个findComponent方法，用于根据组件名查找组件信息。该方法会先查看缓存，如果缓存中没有，则依次调用每个解析器的 resolve 方法，直到有一个解析器返回结果。然后将结果缓存起来。在 transform 钩子中，使用 Context 实例的findComponent 方法来查找组件信息，而不再是硬编码解析逻辑。这次迭代使插件从单一组件库的支持扩展到多组件库，使用缓存提高性能，通过解析器模式提高扩展性，并且通过异步解析查找组件信息、为未来异步解析预留接口。</p>
<p>经过此次的迭代，我们的插件实现了真正的解耦，插件核心只负责流程控制，解析逻辑则完全由解析器处理，配置管理则由 Context 统一管理，标准化了解析器的接口，这样所有解析器都遵循相同的接口，由此实现了强大的拓展性。</p>
<p>接着我们更新 play 项目中的 Vite 配置文件 <code>vite.config.ts</code>，更新如下：</p>
<pre><code class="hljs language-diff" lang="diff">import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
<span class="hljs-deletion">- import AutoComponents from 'cobyte-vite-ui/dist/utils'</span>
<span class="hljs-addition">+ import AutoComponents, { CobyteViteUiResolver} from 'cobyte-vite-ui/dist/utils'</span>

export default defineConfig({
<span class="hljs-deletion">-  plugins: [vue(), AutoComponents()]</span>
<span class="hljs-addition">+  plugins: [vue(), AutoComponents({</span>
<span class="hljs-addition">+    resolvers: [CobyteViteUiResolver()]</span>
<span class="hljs-addition">+  })],</span>
})
</code></pre>
<p>接着重新打包组件库，再重启 play 项目，我们发现依然正常，说明我们上述的改动是正确的。</p>
<h3 data-id="heading-8">多解析器配置</h3>
<p>上文说了我们实现了插件从单一组件库的支持扩展到多组件库的按需加载解析，那么下面就让我们来测试一下。
首先我们往 <code>packages/utils/index.ts</code> 文件添加 Naive UI 的解析器，代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * Resolver for Naive UI
 *
 * <span class="hljs-doctag">@link</span> https://www.naiveui.com/
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NaiveUiResolver</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'component'</span>,
    <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">name: string</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'NaiveUiResolver'</span>, name, name.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^(N[A-Z]|n-[a-z])/</span>));
      <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^(N[A-Z]|n-[a-z])/</span>))
        <span class="hljs-keyword">return</span> { name, <span class="hljs-attr">from</span>: <span class="hljs-string">'naive-ui'</span> }
    },
  }
}
</code></pre>
<p>这个解析器是完全从 <code>unplugin-vue-components</code> 插件中搬过来的，我们测试一下是否能够在我们实现的插件中使用。</p>
<p>接着我们在 play 项目中安装 Naive UI 的依赖：</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> naive-ui
</code></pre>
<p>然后在 App.vue 文件中引用 Naive UI 的组件：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">co-button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">co-button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>naive-ui<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>接着修改 <code>./play/vite.config.ts</code> 文件中的配置。</p>
<pre><code class="hljs language-diff" lang="diff">import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
<span class="hljs-deletion">- import AutoComponents, { CobyteViteUiResolver } from 'cobyte-vite-ui/dist/utils'</span>
<span class="hljs-addition">+ import AutoComponents, { CobyteViteUiResolver, NaiveUiResolver } from 'cobyte-vite-ui/dist/utils'</span>

// https://vite.dev/config/
export default defineConfig({
  plugins: [vue(), AutoComponents({
<span class="hljs-deletion">-   resolvers: [CobyteViteUiResolver()]</span>
<span class="hljs-addition">+    resolvers: [CobyteViteUiResolver(), NaiveUiResolver()]</span>
  })],
})
</code></pre>
<p>接着我们重新打包我们的测试组件库，再重启 play 测试项目，测试结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9fc0afaa6f74916a0a1ba1e7f0b866c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=6Vrsvpa18gSxVlbZRqcRepE7Bzc%3D" alt="01.png" loading="lazy"/></p>
<p>我们可以看到成功验证了我们上述的结论：<strong>我们实现了插件从单一组件库的支持扩展到多组件库的按需加载解</strong>。</p>
<p>我们上面所实现的插件其实就是 <code>unplugin-vue-components</code> 库的实现原理，在 Vue 技术栈中都是通过这个库来实现组件按需加载的。</p>
<h3 data-id="heading-9">业务组件库按需加载实践</h3>
<p>我们在 play 项目中安装 <code>unplugin-vue-components</code> 库来替换我们手写的插件。安装命令如下：</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> unplugin-vue-components -D 
</code></pre>
<p>接着修改 play 项目中的 <code>vite.config.ts</code> 文件。</p>
<pre><code class="hljs language-diff" lang="diff">import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
<span class="hljs-deletion">- import AutoComponent, { CobyteViteUiResolver, NaiveUiResolver } from 'cobyte-vite-ui/dist/utils'</span>
<span class="hljs-addition">+ import { CobyteViteUiResolver, NaiveUiResolver } from 'cobyte-vite-ui/dist/utils'</span>
<span class="hljs-addition">+ import AutoComponents from 'unplugin-vue-components/vite';</span>

// https://vite.dev/config/
export default defineConfig({
  plugins: [vue(), AutoComponents({
    resolvers: [CobyteViteUiResolver(), NaiveUiResolver()]
  })],
})
</code></pre>
<p>然后重启 play 项目，我们发现我们的测试例子依然是正常运行的。所以我们一般的组件库或者业务组件库想要实现按需加载，只需要参考 <code>unplugin-vue-components</code> 库中提供的解析器，写一个符合自己的组件库的解析器再配合 <code>unplugin-vue-components</code> 即可。当然还有一个重要的前提，你的组件库得设计成模块化，即一个组件一个模块，互不关联或者弱关联。</p>
<h3 data-id="heading-10">业务组件库引用第三方组件库的按需加载</h3>
<p>我们知道所谓业务组件库，就是一些基于第三方组件库开发的组件库，比如基于 Element Plus、Naive UI 开发的组件库。那么我们修改一下我们的测试组件库 <code>./packages/components/button</code>，让它使用 Naive UI 的 button 组件，修改如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"warning"</span>&gt;</span>
    Warning
  <span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineOptions</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'co-button'</span>,
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-tag">button</span> {
  <span class="hljs-attribute">color</span>: red;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>接着我们重新打包测试组件库，然后重启 play 项目。我们发现测试组件库中 Naive UI 的按钮 Button 并没有生效。并且在浏览器的控制台报以下警报：</p>
<pre><code class="hljs language-css" lang="css">Failed <span class="hljs-selector-tag">to</span> resolve component: n-button
</code></pre>
<p>这是因为我们使用 Vite 来打包组件库，Vite 默认会把代码进行压缩混淆。我们可以看一下打包后的测试 button 组件的代码。可以看到原本应该是 <code>_resolveComponent("n-button")</code> 的代码，因为 Vite 进行了压缩混淆而变成了 o("n-button")。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a1fd47f258b45e7825b38666b32cef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=jR3MBUfmLK%2FgYWlVlmQGv9zk0gQ%3D" alt="02.png" loading="lazy"/></p>
<p>而我们的插件是基于 <code>_resolveComponent</code> 为前缀进行匹配的，现在前缀被压缩了也就肯定匹配到不到了。所以简单的处理方法就是修改 Vite 打包配置，让其不进行压缩混淆，毕竟 Element Plus、Naive UI 这些开源组件库打包后的产物也没有进行压缩混淆。所以我们修改 Vite 打包配置禁止构建压缩混淆。修改根目录下的 <code>vite.config.ts</code> 如下：</p>
<pre><code class="hljs language-diff" lang="diff">// 省略...

export default defineConfig(({ command, mode }) =&gt; {
    // 主构建配置
    return {
        // 省略...
        build: {
<span class="hljs-addition">+            minify: false, // 禁止压缩混淆</span>
            // 省略...
        },
    };
});
</code></pre>
<p>我们发现打包后的组件代码不压缩混淆了，但还是不生效，这是因为我们写的插件只解析 <code>.vue</code> 文件，而我们打包后的文件变成了 <code>.mjs</code> 了，所以我们要修改一下 play 项目的 Vite 配置让 <code>.mjs</code> 文件也可以被解析。修改 <code>./play/vite.config.ts</code>  文件如下：</p>
<pre><code class="hljs language-diff" lang="diff">  // 省略...
export default defineConfig({
  plugins: [vue(), AutoComponents({
<span class="hljs-addition">+    include: [</span>
<span class="hljs-addition">+      /\.vue$/,</span>
<span class="hljs-addition">+      /\.mjs$/</span>
<span class="hljs-addition">+    ],</span>
    resolvers: [CobyteViteUiResolver(), NaiveUiResolver()]
  })],
})
</code></pre>
<p>经过上述修改后我们重启 play 项目，发现基于 Naive UI 二次开发的组件可以成功加载了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40241ada01dc43be8f8adfdd50ebac34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=KCiPTpjGvRudmI3WE5su1PLIgLk%3D" alt="03.png" loading="lazy"/></p>
<h3 data-id="heading-11">依赖预构建配置</h3>
<p>我们知道 Vite 会在第一次启动的时候把依赖预构建并缓存到 <code>node_modules/.vite</code> 目录中。主要有以下几个原因：</p>
<ol>
<li>模块格式转换</li>
</ol>
<p>许多 npm 包使用的是 CommonJS 或 UMD 格式，而 Vite 在开发环境中使用的是原生 ES 模块（ESM）。预构建会将这些包转换为 ESM 格式，使其能够在浏览器中直接运行。</p>
<ol start="2">
<li>性能优化 - 减少 HTTP 请求</li>
</ol>
<p>某些包会有很多内部模块，如果不预构建，浏览器可能需要发起数百个 HTTP 请求。预构建会将这些模块打包成一个或少数几个文件。</p>
<p>典型例子：</p>
<ul>
<li>lodash-es 有超过 600 个内置模块</li>
<li>如果不预构建，会导致 600+ 个 HTTP 请求</li>
<li>预构建后只需要 1-2 个请求</li>
</ul>
<ol start="3">
<li>提升页面加载速度</li>
</ol>
<p>预构建使用 esbuild（用 Go 编写），速度比传统 JavaScript 打包工具快 10-100 倍。通过将依赖预先打包并缓存，可以显著提升开发服务器的启动速度和模块热更新（HMR）的响应速度。</p>
<p>默认的时候 Vite 是通过 import 语句进行分析需要预构建的依赖的，但我们使用按需加载的插件之后，在代码中就有些 npm 包不存在 import 语句了，所以需要我们手动通过 <code>optimizeDeps.include</code> 选项设置预构建。</p>
<p>我们对 <code>./play/vite.config.ts</code> 设置如下：</p>
<pre><code class="hljs language-diff" lang="diff">import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { CobyteViteUiResolver, NaiveUiResolver } from 'cobyte-vite-ui/dist/utils'
import AutoComponents from 'unplugin-vue-components/vite';
<span class="hljs-addition">+ import pkg from './package.json';</span>
<span class="hljs-addition">+ const dependencies = Object.keys(pkg.dependencies);</span>

export default defineConfig({
  plugins: [vue(), AutoComponents({
    include: [
      /\.vue$/,
      /\.mjs$/
    ],
    resolvers: [CobyteViteUiResolver(), NaiveUiResolver()]
  })],
<span class="hljs-addition">+  optimizeDeps: {</span>
<span class="hljs-addition">+    include: [...dependencies]</span>
<span class="hljs-addition">+  }</span>
})
</code></pre>
<p>由于 Node 不处理虚拟链接，同时为了更真实验证真实场景，我们把测试组件库改成更加真实，首先修改 <code>./play/packages.json</code></p>
<pre><code class="hljs language-diff" lang="diff">{
  // 省略...
  "dependencies": {
<span class="hljs-deletion">-    "cobyte-vite-ui": "link:..",</span>
    "cobyte-vite-ui": "^1.0.0",
    "naive-ui": "^2.43.1",
    "vue": "^3.5.22"
  },
  // 省略...
}
</code></pre>
<p>同时删掉 <code>./play/node_modules</code> 目录中的 <code>cobyte-vite-ui</code> 虚拟目录，再重新创建一个 <code>cobyte-vite-ui</code> 目录，同时把根目录下的 <code>./dist</code> 目录中的内容和根目录下的 <code>packages.json</code> 文件复制到刚刚新创建的
<code>cobyte-vite-ui</code> 目录中，这相当于手动安装我们创建的测试组件库的依赖了。之后我们再删掉 <code>./play/node_modules/.vite</code> 目录的预构建缓存，再重启 play 项目。这时我们发现 <code>cobyte-vite-ui</code> 组件库中引用的 Naive UI 的 button 组件不生效了。这是因为我们把 <code>cobyte-vite-ui</code> 进行预构建后，它的内容就会被预构建后缓存到 <code>./play/node_modules/.vite</code> 目录中了，而 unplugin-vue-components 插件默认是不解析 <code>node_modules</code> 目录中的文件的，所以我们可以修改 unplugin-vue-components 插件的配置让其可以解析 <code>node_modules</code> 目录中的文件，但这不是最优的方案。最优的方案是在打包 <code>cobyte-vite-ui</code> 组件库的时候就
进行按需打包。我们在根目录下安装 <code>unplugin-vue-components</code> 依赖。</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> unplugin-vue-components -D -w
</code></pre>
<p>我们在安装上述依赖的时候，可能会报以下错误：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6746af5fde3446af853e12ef3aa69e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29ieXRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763891951&amp;x-signature=u5WYPU5PuZ23BsjZLeR8rv4N0Jk%3D" alt="04.png" loading="lazy"/></p>
<p>这是因为我们刚刚把 play 目录中的测试组件库 <code>cobyte-vite-ui</code> 改了正式库一样的依赖，我们可以暂时把它改回虚拟依赖。</p>
<pre><code class="hljs language-diff" lang="diff">"dependencies": {
<span class="hljs-deletion">-    "cobyte-vite-ui": "^1.0.0",</span>
<span class="hljs-addition">+    "cobyte-vite-ui": "link:..",</span>
    "naive-ui": "^2.43.1",
    "vue": "^3.5.22"
},
</code></pre>
<p>再进行安装即可。</p>
<p>然后新增根目录下的 <code>vite.config.ts</code> 文件的配置：</p>
<pre><code class="hljs language-diff" lang="diff">// 省略...
<span class="hljs-addition">+ import AutoComponents from 'unplugin-vue-components/vite';</span>
<span class="hljs-addition">+ import { NaiveUiResolver } from 'unplugin-vue-components/resolvers';</span>

// 省略...

export default defineConfig(({ command, mode }) =&gt; {
    // 主构建配置
    return {
        plugins: [
            vue(),
<span class="hljs-addition">+            AutoComponents({</span>
<span class="hljs-addition">+                resolvers: [NaiveUiResolver()]</span>
<span class="hljs-addition">+            })</span>
        ],
        build: {
            // 省略...
            rollupOptions: {
                external: [
                    "vue", 
<span class="hljs-addition">+                    "naive-ui", // 排除打包</span>
                ],
            // 省略..
            },
        },
    };
});
</code></pre>
<p>配置完后，重新打包我们的测试组件库，打包完后，重新删掉 <code>./play/node_modules/.vite</code> 中的缓存，和 <code>./play/node_modules/cobyte-vite-ui</code> 中的内容，重新把刚刚新打包的根目录下的 <code>./dist</code> 目录中的内容和根目录下的 <code>packages.json</code> 文件复制到 <code>./play/node_modules/cobyte-vite-ui</code> 中，同时恢复修改的 <code>./play/packages.json</code> 文件，然后重启 play 项目。</p>
<p>这时我们就发现测试项目可以正常渲染了。</p>
<p>至此我们业务组件库按需加载的实现原理就都讲得差不多了，有什么可以在评论区交流。</p>
<h3 data-id="heading-12">总结</h3>
<p>看完了全篇文章相信你会觉得，所谓组件库按需加载或者业务组件库按需加载其实很简单，首先组件库的每一个组件都得设计成独立的模块，并且可以按模块导入，也就是 ESM 化，可以进行 Tree Shaking，只有这样按需加载才有意义，才能达到减小包体积的作用。</p>
<p>全局组件在模板中使用被编译后会通过一个内置函数 <strong>resolveComponent</strong> 来调用组件，按需加载的实现原理就是通过插件进行正则匹配查找编译后的模板代码中的 <strong>resolveComponent</strong> 函数的相关代码来找到需要按需加载的组件，然后自动按编译后的代码的头部添加需要加载的组件的导入语句代码以及替换掉 <strong>resolveComponent</strong> 函数的相关代码为对应的组件对象。</p>
<p>而业务组件实现按需加载的关键是需要在业务组件库打包的时候也进行按需加载配置。虽然这个关键步骤很简单，但由于这是一个低频且跨项目的需求，所以AI对低频的需求的实现和给的解决方案都不尽人意，至少本人解决上述问题时，AI提供方案没有一个可以实现的，虽然最后的实现其实很简单。</p>
<p>最后，再说说个人对AI的一些感悟吧，个人觉得在AI时代，就编程这个领域而言对个人的专业要求会比以前更加的高，至少你得有能力去解决AI不会的问题。</p>
<p>上述组件库测试代码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Famebyte%2Fcobyte-vite-ui" target="_blank" title="https://github.com/amebyte/cobyte-vite-ui" ref="nofollow noopener noreferrer">github.com/amebyte/cob…</a></p>
<p>欢迎关注本专栏，了解更多 Element Plus 组件库知识</p>
<p>本专栏文章：</p>
<p><a href="https://juejin.cn/post/7143196940992413709" target="_blank" title="https://juejin.cn/post/7143196940992413709">1. Vue3 组件库的设计和实现原理</a></p>
<p><a href="https://juejin.cn/post/7146183222425518093" target="_blank" title="https://juejin.cn/post/7146183222425518093">2. 组件库工程化实战之 Monorepo 架构搭建</a></p>
<p><a href="https://juejin.cn/post/7153659360177029150" target="_blank" title="https://juejin.cn/post/7153659360177029150">3. ESLint 核心原理剖析</a></p>
<p><a href="https://juejin.cn/post/7157743898939359262" target="_blank" title="https://juejin.cn/post/7157743898939359262">4. ESLint 技术原理与实战及代码规范自动化详解</a></p>
<p><a href="https://juejin.cn/post/7161063570594070559" target="_blank" title="https://juejin.cn/post/7161063570594070559">5. 从终端命令解析器说起谈谈 npm 包管理工具的运行原理</a></p>
<p><a href="https://juejin.cn/post/7165503808217284616" target="_blank" title="https://juejin.cn/post/7165503808217284616">6. CSS 架构模式之 BEM 在组件库中的实践</a></p>
<p><a href="https://juejin.cn/post/7168835045984043022" target="_blank" title="https://juejin.cn/post/7168835045984043022">7. 组件实现的基本流程及 Icon 组件的实现</a></p>
<p><a href="https://juejin.cn/post/7170716245762048036" target="_blank" title="https://juejin.cn/post/7170716245762048036">8. 为什么组件库或插件需要定义 peerDependencies</a></p>
<p><a href="https://juejin.cn/post/7179257832632483896" target="_blank" title="https://juejin.cn/post/7179257832632483896">9. 组件开发中 Vue3 相关知识的应用与解析及 Button 组件的实现</a></p>
<p><a href="https://juejin.cn/post/7186683381470462007" target="_blank" title="https://juejin.cn/post/7186683381470462007">10. CSS 系统颜色和暗黑模式的关系及意义</a></p>
<p><a href="https://juejin.cn/post/7190370726677839932" target="_blank" title="https://juejin.cn/post/7190370726677839932">11. 深入理解组件库中SCSS和CSS变量的架构应用和实践</a></p>
<p><a href="https://juejin.cn/post/7204454572890046501" target="_blank" title="https://juejin.cn/post/7204454572890046501">12. 组件 v-model 的封装实现原理及 Input 组件的核心实现</a></p>
<p><a href="https://juejin.cn/post/7217399337989881911" target="_blank" title="https://juejin.cn/post/7217399337989881911">13. 深入理解 Vue3 的 v-model 及自定义指令的实现原理</a></p>
<p><a href="https://juejin.cn/post/7249299811497066551" target="_blank" title="https://juejin.cn/post/7249299811497066551">14. React 和 Vue 都离不开的表单验证工具库 async-validator 之策略模式的应用</a></p>
<p><a href="https://juejin.cn/post/7258966810350174263" target="_blank" title="https://juejin.cn/post/7258966810350174263">15. Form 表单的设计与实现</a></p>
<p><a href="https://juejin.cn/post/7313380227160522763" target="_blank" title="https://juejin.cn/post/7313380227160522763">16. 组件库的打包原理与实践详解</a></p>
<p><a href="https://juejin.cn/post/7572480736362119174" target="_blank" title="https://juejin.cn/post/7572480736362119174">17. Vue3 业务组件库按需加载的实现原理</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vite-plugin-openapi-ts CLI 使用指南]]></title>    <link>https://juejin.cn/post/7572537221541036047</link>    <guid>https://juejin.cn/post/7572537221541036047</guid>    <pubDate>2025-11-16T07:05:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221541036047" data-draft-id="7572534419880263715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vite-plugin-openapi-ts CLI 使用指南"/> <meta itemprop="keywords" content="前端,Vite"/> <meta itemprop="datePublished" content="2025-11-16T07:05:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="isyuah"/> <meta itemprop="url" content="https://juejin.cn/user/2527090418131764"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vite-plugin-openapi-ts CLI 使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2527090418131764/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    isyuah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:05:26.000Z" title="Sun Nov 16 2025 07:05:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vite-plugin-openapi-ts CLI 使用指南</h2>
<blockquote>
<p>建议先看插件本体的介绍</p>
</blockquote>
<p>vite-plugin-openapi-ts 除了以 Vite 插件的形式在开发 / 构建阶段自动生成代码外，还提供了一套独立的 <strong>命令行工具（CLI）</strong>。<br/>
CLI 更适合以下场景：</p>
<ul>
<li>在 CI / CD 流水线里，先生成类型和客户端，再进行构建与测试；</li>
<li>在 monorepo 中集中生成，再给多个子应用复用；</li>
<li>本地需要“只生成一次看结果”，不想依赖 Vite 启动过程。</li>
</ul>
<p>下面是这套 CLI 的完整用法说明。</p>
<hr/>
<h3 data-id="heading-1">安装与基础命令</h3>
<p>CLI 入口已经通过 <code>bin</code> 字段绑定为 <code>openapi-ts</code>，安装插件后就可以直接使用：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D vite-plugin-openapi-ts

<span class="hljs-comment"># 本地调用</span>
npx openapi-ts --<span class="hljs-built_in">help</span>
</code></pre>
<p>目前内置的几个核心子命令是：</p>
<ul>
<li><code>openapi-ts generate</code>：从 OpenAPI 规范生成 TypeScript 类型和 API 客户端；</li>
<li><code>openapi-ts clean</code>：清理生成的 <code>schemes.ts</code> / <code>index.ts</code> 以及可选缓存文件；</li>
<li><code>openapi-ts clean-cache</code>：只清理缓存文件 <code>.openapi-cache.json</code>。</li>
</ul>
<p>你也可以使用简写：</p>
<ul>
<li><code>openapi-ts gen</code> 或 <code>openapi-ts g</code> 等价于 <code>openapi-ts generate</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-2">使用 openapi.config.json 进行配置</h3>
<p>CLI 支持从当前工作目录下读取 <code>openapi.config.json</code> 作为默认配置，然后再由命令行参数进行覆盖。</p>
<p>一个典型的 <code>openapi.config.json</code> 示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8080/v3/api-docs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8080"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"outputDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/openapi"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"enableCache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"skipTimeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"force"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>在有了这个文件之后，你可以直接运行：</p>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate
</code></pre>
<p>此时 CLI 会按如下优先级合并配置：</p>
<ol>
<li>命令行参数（最高优先级）；</li>
<li><code>openapi.config.json</code> 中的字段；</li>
<li>内置默认值（例如 <code>outputDir</code> 默认为 <code>src/openapi</code>）。</li>
</ol>
<p>例如：</p>
<ul>
<li>最终 <code>url</code> 来源：<code>--url</code> &gt; <code>openapi.config.json</code> 中的 <code>url</code>；</li>
<li>最终 <code>baseUrl</code> 来源：<code>--base-url</code> &gt; <code>openapi.config.json.baseUrl</code> &gt;（远程地址时自动从 <code>url</code> 提取）；</li>
<li>最终 <code>outputDir</code> 来源：<code>--output-dir</code> &gt; <code>openapi.config.json.outputDir</code> &gt; 默认值 <code>src/openapi</code>。</li>
</ul>
<p>如果既没有在命令行传 <code>--url</code>，也没有在配置文件里配置 <code>url</code>，CLI 会给出错误提示并退出。</p>
<hr/>
<h3 data-id="heading-3">generate：生成类型和客户端</h3>
<p><code>generate</code> 是 CLI 中最核心的命令，用于根据 OpenAPI 规范生成类型文件和 API 客户端。</p>
<h4 data-id="heading-4">命令参数</h4>
<pre><code class="hljs language-bash" lang="bash">openapi-ts generate \
  --url        &lt;specUrl&gt;   \ <span class="hljs-comment"># OpenAPI 文档地址（JSON 或 YAML）</span>
  --base-url   &lt;baseUrl&gt;   \ <span class="hljs-comment"># API 基础地址，可选</span>
  --output-dir &lt;outputDir&gt; \ <span class="hljs-comment"># 输出目录，默认 src/openapi</span>
  --enable-cache           \ <span class="hljs-comment"># 启用缓存（默认 true）</span>
  --skip-timeout &lt;ms&gt;      \ <span class="hljs-comment"># 跳过超时时间（毫秒）</span>
  --force                    <span class="hljs-comment"># 强制重新生成，忽略缓存</span>
</code></pre>
<p>其中：</p>
<ul>
<li><code>--url</code> / <code>-u</code>：OpenAPI 规范地址，支持 <code>http(s)</code> 和本地文件路径；</li>
<li><code>--base-url</code> / <code>-b</code>：生成客户端时使用的基础地址；
<ul>
<li>如果是远程 <code>http(s)</code> 地址且未显式提供 <code>baseUrl</code>，CLI 会自动尝试从 <code>url</code> 中提取（形如 <code>protocol://host</code>）；</li>
<li>如果是本地文件路径，且未提供 <code>baseUrl</code>，CLI 会提示你必须提供一个 <code>baseUrl</code>（可以写在配置文件中）。</li>
</ul>
</li>
<li><code>--output-dir</code> / <code>-o</code>：生成文件输出目录，默认是 <code>src/openapi</code>；</li>
<li><code>--enable-cache</code> / <code>-c</code>：是否启用缓存，默认开启；缓存文件为 <code>{outputDir}/.openapi-cache.json</code>；</li>
<li><code>--skip-timeout</code> / <code>-t</code>：在启用缓存的情况下，如果与上次生成间隔时间小于该值（毫秒），且 <code>url</code> / <code>baseUrl</code> 未发生改变，则会跳过本次生成；</li>
<li><code>--force</code> / <code>-f</code>：强制重新生成，忽略缓存逻辑。</li>
</ul>
<h4 data-id="heading-5">常见用法示例</h4>
<ol>
<li><strong>完全依赖配置文件：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate
</code></pre>
<p>只要在 <code>openapi.config.json</code> 中提供了 <code>url</code>（以及可选的其他字段），就可以这样使用。</p>
<ol start="2">
<li><strong>在配置基础上临时覆盖部分字段：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate \
  --url http://localhost:8081/v3/api-docs \
  --force
</code></pre>
<p>这里会覆盖配置文件中的 <code>url</code>，并且强制重新生成（无视缓存）。</p>
<ol start="3">
<li><strong>不使用配置文件，仅命令行参数驱动：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate \
  --url ./openapi.yaml \
  --base-url https://api.example.com \
  --output-dir src/openapi
</code></pre>
<p>当 <code>url</code> 是本地文件路径时，<code>baseUrl</code> 必须显式提供（或写在 <code>openapi.config.json</code> 里），否则 CLI 会报错。</p>
<hr/>
<h3 data-id="heading-6">clean：清理生成文件</h3>
<p><code>clean</code> 命令用于清理通过 CLI 或插件生成的文件：</p>
<pre><code class="hljs language-bash" lang="bash">openapi-ts clean \
  --<span class="hljs-built_in">dir</span>         &lt;outputDir&gt; \
  --clean-cache           <span class="hljs-comment"># 是否同时清理缓存，默认 true</span>
</code></pre>
<ul>
<li>默认会删除 <code>{outputDir}/schemes.ts</code> 和 <code>{outputDir}/index.ts</code>；</li>
<li>如果 <code>--clean-cache</code> 为 <code>true</code>（默认），还会删除 <code>{outputDir}/.openapi-cache.json</code>。</li>
</ul>
<p>典型用法：</p>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts clean
</code></pre>
<p>配合 <code>openapi.config.json</code> 或默认值使用时，会清理 <code>src/openapi</code> 下的生成内容。<br/>
在需要“重新完整生成”或重置生成状态时，这个命令非常有用。</p>
<hr/>
<h3 data-id="heading-7">clean-cache：仅清理缓存</h3>
<p>如果你只想清理缓存文件，而保留已经生成好的类型和客户端，可以使用 <code>clean-cache</code>：</p>
<pre><code class="hljs language-bash" lang="bash">openapi-ts clean-cache --<span class="hljs-built_in">dir</span> src/openapi
</code></pre>
<p>这条命令只会删除指定目录下的 <code>.openapi-cache.json</code>，不会影响已有的 <code>schemes.ts</code> 和 <code>index.ts</code>。</p>
<hr/>
<h3 data-id="heading-8">在 npm scripts / CI 中使用</h3>
<p>推荐把 CLI 命令封装到 <code>package.json</code> 里，方便团队成员统一使用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"openapi:gen"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openapi-ts generate"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"openapi:clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openapi-ts clean"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"openapi:clean-cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openapi-ts clean-cache"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后在命令行中直接执行：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm openapi:gen
</code></pre>
<p>在 CI 场景里，可以在构建前插入一段：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm openapi:gen
pnpm build
</code></pre>
<p>这样可以确保生成的类型与服务端 OpenAPI 规范保持最新，从而在前端构建阶段就发现接口不兼容的问题。</p>
<hr/>
<h3 data-id="heading-9">小结</h3>
<ul>
<li>CLI 适合在 Vite 之外的场景使用，例如 CI、独立脚本或 monorepo 根目录；</li>
<li>通过 <code>openapi.config.json</code> + CLI 参数覆盖的机制，可以兼顾“统一配置”和“局部灵活调整”；</li>
<li><code>generate</code> 负责生成，<code>clean</code> / <code>clean-cache</code> 负责回收和重置，搭配使用可以构建出一套比较完整的接口代码生成流程。</li>
</ul>
<p>在更完整的项目介绍 / 推荐文章中，你可以将本文件的内容作为“CLI 使用章节”直接嵌入；如果你只想单独介绍命令行用法，也可以单独发布这一篇。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Android】模板化解决复杂场景的滑动冲突问题]]></title>    <link>https://juejin.cn/post/7572793505899757619</link>    <guid>https://juejin.cn/post/7572793505899757619</guid>    <pubDate>2025-11-16T07:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572793505899757619" data-draft-id="7572539461478285355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android】模板化解决复杂场景的滑动冲突问题"/> <meta itemprop="keywords" content="Java,Android"/> <meta itemprop="datePublished" content="2025-11-16T07:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Propeller"/> <meta itemprop="url" content="https://juejin.cn/user/4311645702612554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android】模板化解决复杂场景的滑动冲突问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4311645702612554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Propeller
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:57:02.000Z" title="Sun Nov 16 2025 07:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>仿写项目的业务场景刚好覆盖有两种复杂滑动冲突场景：</p>
<p>Horizontal ViewPager2 嵌套 Vertical RecyclerView (<strong>OuterRecyclerView</strong>) 嵌套 Horizontal RecyclerView (<strong>InnerRecyclerView</strong>) 的横纵横场景和</p>
<p>Horizontal ViewPager2 嵌套 Horizontal ViewPager2 (<strong>InnerViewPager</strong>) 嵌套 Vertical RecyclerView 的横横纵场景。</p>
<p>同时要让内层的 InnerRecyclerView 和 InnerViewPager 在横向滑动方向尚可滑动接管事件，不可滑动时将事件交给外层的 Horizontal ViewPager2。</p>
<h2 data-id="heading-0">背景原理</h2>
<p>我们知道 MotionEvent 事件传递是由 DecorView 到 ViewGroup 再到 View，完整事件序列必定由 MotionEvent.DOWN 开始，ViewGroup 在事件传递过程中会判断是否拦截该事件序列，如果 DOWN 被拦截则该 ViewGroup 会完全接管后续所有事件。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> intercepted;
<span class="hljs-keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN
        || mFirstTouchTarget != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">disallowIntercept</span> <span class="hljs-operator">=</span> (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!disallowIntercept) {
        intercepted = onInterceptTouchEvent(ev);
        ev.setAction(action);
    } <span class="hljs-keyword">else</span> {
        intercepted = <span class="hljs-literal">false</span>;
    }
} <span class="hljs-keyword">else</span> {
    intercepted = <span class="hljs-literal">true</span>;
}
</code></pre>
<p>由外层条件语句知，child 的 requestDisallowInterceptTouchEvent 方法无法影响 ViewGroup 对 DOWN 事件的拦截处理，所以大部分情况 ViewGroup 派生类都不会拦截 DOWN 事件，通常逻辑是让 child 消费 DOWN 事件，再根据后续 MOVE 方向判断是否拦截。</p>
<h3 data-id="heading-1">requestDisallowInterceptTouchEvent</h3>
<p>该方法是 child 发送给父容器的请求，参数的布尔值表示是否期望父容器拦截事件，父容器接收到请求后会将 FLAG_DISALLOW_INTERCELT 标志位设置为 1，内部的 disallowIntercept 字段进而得到 true。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDisallowInterceptTouchEvent</span><span class="hljs-params">(<span class="hljs-type">boolean</span> disallowIntercept)</span> {
    <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span>) {
        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDisallowInterceptTouchEvent</span><span class="hljs-params">(<span class="hljs-type">boolean</span> disallowIntercept)</span> {

    <span class="hljs-keyword">if</span> (disallowIntercept == ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// We're already in this state, assume our ancestors are too</span>
<span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (disallowIntercept) {
        mGroupFlags |= FLAG_DISALLOW_INTERCEPT;
    } <span class="hljs-keyword">else</span> {
        mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;
    }

    <span class="hljs-comment">// Pass it up to our parent</span>
<span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span>) {
        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);
    }
} <span class="hljs-comment">/* mGroupFlags可以看成标记位大集合 */</span>
</code></pre>
<p>所以解决滑动冲突的方法很明确：父布局不要拦截向下传递的 DOWN 事件，让 child 在 DOWN 事件禁止父布局拦截事件，根据后续 MOVE 事件的滑动方向和 child 本身的情况判断是否允许父布局拦截事件，在 CANCEL 或 UP 事件恢复原状。</p>
<h2 data-id="heading-2">横纵横</h2>
<p>InnerRecyclerView 判断是否为横向滑动且滑动方向有内容在屏幕外，是则由自己接管，否则交给 ViewPager2，这里利用 View 树的特点冒泡获得以 ViewPager2 为父容器的 View，对该 View 进行 requestDisallowInterceptTouchEvent，隔离了 OuterRecyclerView 和 ViewPager2。</p>
<p>如果为纵向滑动则设置 requestDisallowInterceptTouchEvent(false)，让 OuterRecyclerView 来禁止父容器拦截，保证了 InnerRecyclerView 和 OuterRecyclerView 互不冲突。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerRecyclerView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> x0, y0;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> touchSlop;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerRecyclerView</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent e)</span> {
        <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;
        <span class="hljs-keyword">while</span> (v != <span class="hljs-literal">null</span> &amp;&amp; !(v.getParent() <span class="hljs-keyword">instanceof</span> ViewPager2)) {
            v = (ViewGroup) v.getParent();
        }

        <span class="hljs-keyword">switch</span> (e.getActionMasked()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                x0 = e.getX();
                y0 = e.getY();
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-type">double</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> e.getX() - x0;
                <span class="hljs-type">double</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> e.getY() - y0;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &lt; touchSlop &amp;&amp; Math.abs(dy) &lt; touchSlop) <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &gt; Math.abs(dy)) {
                    <span class="hljs-keyword">if</span> (dx &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">if</span> (!canScrollHorizontally(-<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (!canScrollHorizontally(<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    }
                } <span class="hljs-keyword">else</span> {
                    v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(e);
    }
}
</code></pre>
<p>OuterRecyclerView 判断是否为纵向滑动，是则由自己接管，否则交给 ViewPager2，InnerRecycler 和 OuterRecyclerView 的拦截决策均只影响 ViewPager2 是否拦截，所以保证 ViewPager2 和内层整体互不冲突，进而解决横纵横方向的滑动冲突。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OuterRecyclerView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> x0, y0;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> touchSlop;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OuterRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OuterRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OuterRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent ev)</span> {
        <span class="hljs-keyword">switch</span> (ev.getAction()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                x0 = ev.getX();
                y0 = ev.getY();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-type">double</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> ev.getX() - x0;
                <span class="hljs-type">double</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> ev.getY() - y0;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &lt; touchSlop &amp;&amp; Math.abs(dy) &lt; touchSlop) <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">if</span> (Math.abs(dy) &gt; Math.abs(dx)) {
                    getParent().requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                } <span class="hljs-keyword">else</span> getParent().requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                getParent().requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(ev);
    }
}
</code></pre>
<h2 data-id="heading-3">横横纵</h2>
<p>因为 ViewPager2 是 final 类，无法通过重写 onInterceptTouchEvent 方法解决冲突，换种思路想，我们可以用 FrameLayout 包裹 InnerPager2，重写 FrameLayout 的 onInterceptTouchEvent 方法来解决，其内部逻辑和横纵横的 InnerRecyclerView 类似。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerViewPagerContainer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FrameLayout</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> touchSlop;
    <span class="hljs-keyword">private</span> <span class="hljs-type">float</span> startX, startY;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerViewPagerContainer</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerViewPagerContainer</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent e)</span> {
        <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;
        <span class="hljs-keyword">while</span> (v != <span class="hljs-literal">null</span> &amp;&amp; !(v.getParent() <span class="hljs-keyword">instanceof</span> ViewPager2)) {
            v = (ViewGroup) v.getParent();
        }

        <span class="hljs-keyword">switch</span> (e.getActionMasked()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                startX = e.getX();
                startY = e.getY();
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-type">float</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> e.getX() - startX;
                <span class="hljs-type">float</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> e.getY() - startY;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &lt; touchSlop &amp;&amp; Math.abs(dy) &lt; touchSlop) <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &gt; Math.abs(dy)) {
                    <span class="hljs-keyword">if</span> (dx &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">if</span> (!getChildAt(<span class="hljs-number">0</span>).canScrollHorizontally(-<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (!getChildAt(<span class="hljs-number">0</span>).canScrollHorizontally(<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    }
                } <span class="hljs-keyword">else</span> {
                    v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(e);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么每个团队都需要一套私有 Context 工程]]></title>    <link>https://juejin.cn/post/7572781559767302194</link>    <guid>https://juejin.cn/post/7572781559767302194</guid>    <pubDate>2025-11-16T08:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572781559767302194" data-draft-id="7572749797468864521" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么每个团队都需要一套私有 Context 工程"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-16T08:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vadaski"/> <meta itemprop="url" content="https://juejin.cn/user/1767670428477015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么每个团队都需要一套私有 Context 工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767670428477015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vadaski
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T08:27:59.000Z" title="Sun Nov 16 2025 08:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>如果你已经在工作里频繁用大模型，却总觉得“偶尔很惊艳，大多数时候又累又不稳”，那这篇文章也许值得你花十分钟读完：我会从成本结构、IN→推理→OUT 这个最小单元，以及通用工具在复杂业务中的上限出发，说明一件事——只要你为自己的业务建立一套私有的 Context 工程实践，让构造好 IN 这件事变得有章可循、可复用、可演进，同一批人做同样的事，效率出现 3–5 倍的质变，甚至更高。
本文上篇只回答一个问题：<strong>为什么要做私有 Context 工程</strong>；下篇再谈“应该怎么做”。</p>
<h2 data-id="heading-1">一个直观感受：模型很强，但效率为什么没起来？</h2>
<p>如果你已经在工作中频繁使用大模型，大概率会有一种矛盾体验：</p>
<ul>
<li>它有时候能给出非常惊艳的结果；</li>
<li>但真正放到严肃工作里，要让它持续靠谱，往往需要你花很多时间“喂信息、讲背景、补细节、纠正误解”。</li>
</ul>
<p>我的直观感受是：</p>
<ul>
<li>当只是“临时问两句”的时候，工具很好用；</li>
<li>当指望它跟我一起完成一个完整的产品迭代、系统改造、调研分析时，<strong>上下文准备本身变成了一件很累的事</strong>。</li>
</ul>
<p>反过来，当我开始系统化地思考“到底该给它什么、以什么结构给”，并针对自己的业务搭了一些固定的 Context 模板和整理方式之后：</p>
<ul>
<li>同样的事情，我的效率大概稳定提高在 <strong>3–5倍</strong>；</li>
<li>重点不在于模型变聪明了，而在于：<strong>我和它之间的信息通道变得更合理了</strong>。</li>
</ul>
<p>这背后指向的是一件更底层的事：<strong>智力的成本结构已经被悄悄改写了。</strong></p>
<h2 data-id="heading-2">智力的工业化：成本结构的巨变</h2>
<p>过去，复杂问题的核心成本在于“人脑”：</p>
<ul>
<li>能做泛化推理的只有人；</li>
<li>知识无法低成本复制，只能靠培训、会议、协作一点点传递；</li>
<li>所以绝大多数组织的主要成本，都压在“找人 + 用人 + 协调人”上。</li>
</ul>
<p>大模型把这件事翻转了：</p>
<ul>
<li>推理能力开始像“水电网”一样可以按量付费；</li>
<li>同一份模型能力可以被无数任务重复调用；</li>
<li>我们第一次可以把“部分智力劳动”视为一种基础设施。</li>
</ul>
<p>如果只看账单，你会发现真正开始变贵的不是“推理”，而是：</p>
<ul>
<li>为每一次推理<br/>
<strong>准备、选择、组织、筛选、压缩信息</strong> 的过程。</li>
</ul>
<p>用更直白的话说：</p>
<blockquote>
<p>**聪明本身变便宜了，<br/>
但是这个聪明的人没有记忆， 他需要我们一次又一次的告诉他背景信息， 如果给他说的是错的，那我们一定拿不到好的结果。</p>
</blockquote>
<p>如果工程方法论不跟着这波成本结构的变化调整，我们就会卡在一个奇怪的位置：</p>
<ul>
<li>理论上工具越来越强；</li>
<li>实际上很快就跑出了一堆屎山，没有人能够继续维护下去。</li>
</ul>
<h2 data-id="heading-3">问题解决的最小单元：IN → 推理 → OUT</h2>
<p>不管是写代码、写 PRD、做运营方案，还是做市场分析，本质上都可以压缩成一个最小单元：</p>
<p>[ 输入（IN）→ 推理 → 输出（OUT） ]</p>
<ul>
<li><strong>IN</strong>：这一步你给到模型的一切东西：目标、约束、背景、相关事实、历史决策、示例……</li>
<li><strong>推理</strong>：模型基于这些信息做的理解、拆解、规划、生成。</li>
<li><strong>OUT</strong>：中间结果或最终结果：代码、设计、方案、报告、决策建议等。</li>
</ul>
<p>在今天的模型能力水平下，有两个判断越来越清晰：</p>
<ol>
<li>
<p><strong>推理本身已经不像过去那样稀缺</strong><br/>
在很多任务上，它的整体表现已经超过了普通人类的平均水准。</p>
</li>
<li>
<p><strong>绝大多数失败来自 IN，而不是推理阶段</strong></p>
<ul>
<li>该给的没给：关键前提、重要历史被彻底遗漏；</li>
<li>不该给的给太多：大量噪音占满了有限的注意力；</li>
<li>条件说不清：哪些是强约束、哪些只是偏好，模型分不清。</li>
</ul>
</li>
</ol>
<p>如果再加上前面那句“工程信念”：</p>
<ul>
<li>我们相信：复杂问题可以被拆解为足够多的小问题；</li>
<li>我们也相信：对这些小问题，IN → 推理 → OUT 的最小单元是成立的；</li>
</ul>
<p>那么就可以做出这样一个推演：</p>
<blockquote>
<p><strong>只要我们能持续构造出足够好的 IN，<br/>
理论上，AI 可以被用来完成几乎一切任务。</strong></p>
</blockquote>
<p>这不是一句励志口号，而是一个关于<strong>成本结构 + 工程拆解 + 最小单元</strong>的推理结果。</p>
<h2 data-id="heading-4">工具层的“眼花缭乱”，本质上都是在帮你构造 IN</h2>
<p>这两年围绕大模型已经涌现了大量“辅助工具”和“方法论”，比如：</p>
<ul>
<li>各种规范流程工具（如 spec-kit 等）；</li>
<li>结构化思考/拆解方法（如 bmad-method 等）；</li>
<li>claude code 的 skills / mcp 能力集合；</li>
</ul>
<p>如果只盯着这些工具的名字和形态，很容易有一种“眼花缭乱”的感觉：</p>
<ul>
<li>今天是 A 套件，明天是 B 方法论，后天又冒出一个 C 平台；</li>
<li>似乎不跟一跟最新的工具，就会落伍。</li>
</ul>
<p>但从 <strong>IN → 推理 → OUT</strong> 的角度往回看，这些东西有一个共同的本质：</p>
<blockquote>
<p><strong>它们无一例外，都是在帮你构造一个“更好、更确定的 IN”。</strong></p>
</blockquote>
<p>把脑子里的想法变成真正可交付的结果，本身就是一个“解压缩”的过程：</p>
<ul>
<li>一开始只是模糊直觉和零散想法；</li>
<li>逐步被压成规格更清晰的描述、决策、方案、实现；</li>
<li>在过程中，需要不断对齐（alignment）、修正、补充，最后才收敛为一个可以交付的 OUT。</li>
</ul>
<p>这些工具做的事情其实是：</p>
<ul>
<li>帮你在解压缩的不同阶段，用更结构化的方式表达意图和约束；</li>
<li>在你和模型之间建立更稳定的“对齐机制”；</li>
<li>减少“说不清、说不全、说错了”的概率，从而提高整个链路的确定性。</li>
</ul>
<p>所以，从私有 Context 工程的视角看：</p>
<ul>
<li>
<p>工具自然会不断迭代更新；</p>
</li>
<li>
<p>但只要 <strong>IN → 推理 → OUT</strong> 这个最小单元还成立，这些工具的角色就可以被视为：</p>
<ul>
<li><strong>在不同层次上协助我们构造更好的 IN，减少解压缩过程中的不确定性。</strong></li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">通用上下文工程的边界：面对未知世界的必然策略</h2>
<p>为了帮用户构造更好的 IN，业界提出了“上下文工程”：</p>
<ul>
<li>如何组织系统提示；</li>
<li>如何规划工具；</li>
<li>如何用检索把外部知识接进来；</li>
<li>如何通过压缩和结构化笔记维持长任务的连贯性。</li>
</ul>
<p>这些方法非常有价值，但有一个经常被忽略的前提：</p>
<blockquote>
<p>它们大多站在  <strong>“通用工具提供方”</strong>  的视角。</p>
</blockquote>
<p>在这个视角下，世界是这样的：</p>
<ul>
<li>他们不知道每一个客户的业务结构；</li>
<li>不知道你的代码 / 流程 / 术语；</li>
<li>不知道你有哪些隐含红线和组织约束。</li>
</ul>
<p>于是，他们只能假设：<strong>所有工程都是“未知工程”</strong> 。<br/>
在这种情况下，唯一现实的策略就是：</p>
<ul>
<li>尽可能增强 Search 能力；</li>
<li>提供尽可能多的上下文入口（RAG、MCP、各种工具和技能）；</li>
<li>让模型在运行时自己去探索、自己去拼接、自己去猜。</li>
</ul>
<p>在小场景、简单场景下，这些手段效果很好。<br/>
但一旦业务复杂度上来，你会越来越明显地感受到它们的上限：</p>
<ul>
<li>搜索结果太多或太少，窗口很快被吃满；</li>
<li>复杂流程和规范，很难通过一次性的 prompt 注入模型脑中；</li>
<li>工程越大、上下游越多，“让模型自己去找路”这件事就越不可靠。</li>
</ul>
<p>它们之所以如此，是因为：</p>
<blockquote>
<p><strong>通用上下文工程面对的是“一个所有细节都未知的世界”。<br/>
在这样的世界里，Search + 动态拼接是唯一的通用策略。</strong></p>
</blockquote>
<h2 data-id="heading-6">当这是“我的业务”时：Context 不该继续被当作未知量</h2>
<p>而在一个具体业务团队内部，情况完全不同。</p>
<p>你并不是面对一个完全未知的世界，你知道很多事情：</p>
<ul>
<li>你的业务边界是什么；</li>
<li>关键流程、常见套路、固定步骤有哪些；</li>
<li>哪些规范是红线，哪些是建议；</li>
<li>哪些历史决策、复盘和踩坑记录，值得被长期记住。</li>
</ul>
<p>换句话说，在你的团队里：</p>
<blockquote>
<p><strong>Context 不是一团雾，而是一套可以被设计、被维护、被演进的结构。</strong></p>
</blockquote>
<p>这时还继续完全按照通用范式来用 AI——<br/>
每次都从零开始拼凑上下文，让模型去黑箱式地 Search 和拼接——<br/>
就有点像：</p>
<ul>
<li>你对自己的公司组织结构和流程非常熟；</li>
<li>却每次让一个新人自己从公司大门开始乱逛，希望他能摸索出正确路径。</li>
</ul>
<p><strong>私有 Context 工程实践</strong>想做的，是把这件事反过来：</p>
<ul>
<li>承认我们对自己业务的“先验知识”是宝贵资产；</li>
<li>把这些先验，通过工程方式固化成一整套上下文管理实践；</li>
<li>让模型不再在未经整理的“原始世界”里迷路，而是在这套实践之上工作。</li>
</ul>
<p>它关心的不仅是：</p>
<ul>
<li>“帮我写函数、修 bug”。</li>
</ul>
<p>它关心的是：</p>
<ul>
<li>做一次新业务，应该自动带出哪些历史事实与流程约束；</li>
<li>做一个新活动，应该自动提醒哪些风险点和必经步骤；</li>
<li>做一次分析，应该自动接上哪些指标、报告和过往尝试。</li>
</ul>
<h2 data-id="heading-7">“上下文架构师”：那个重构 IN 的人</h2>
<p>当 Context 被当成工程对象，就会自然冒出来一个新角色：</p>
<blockquote>
<p><strong>上下文架构师（Context Architect）</strong></p>
</blockquote>
<p>这个角色的特点是：</p>
<ul>
<li>
<p><strong>既懂业务，也懂怎么维护上下文</strong><br/>
他知道业务是怎么跑的，也知道什么东西应该长期存在于“可用的 Context 集合”里。</p>
</li>
<li>
<p><strong>工作方式是“先跑业务，再抽象，再反哺 AI”</strong><br/>
一条典型闭环大致是：</p>
<ol>
<li>从真实业务出发，选一个最小闭环，把它先跑到“可用”；</li>
<li>从这个闭环中反推：哪些信息、哪些步骤、哪些约束是可以抽象出来复用的；</li>
<li>把这些抽象整理成结构化的规范和约束，让 AI 在下一次任务中按它们来行动；</li>
<li>在实际执行中观察偏差，微调约束和上下文结构，直到 AI 能长期稳定地按这套方式完成任务。</li>
</ol>
</li>
<li>
<p><strong>更关注“过程是否可复用”，而不仅是某次结果是否凑巧正确</strong><br/>
他的目标不是“这次输出对了就行”，<br/>
而是让这套 Context 设计本身变得可迁移、可复制、可迭代。</p>
</li>
<li>
<p><strong>需要设计一套“像文件系统一样好用的上下文存储结构”</strong><br/>
目标很直接：<br/>
让任何一个业务同学，在开始一件新事之前，可以：</p>
<ul>
<li>一两步拉出这个任务必需的上下文模块；</li>
<li>再补充一下当下特定目标；<br/>
系统就能为模型构造出一份质量足够高的 IN，而不需要每次从头拼凑。</li>
</ul>
</li>
</ul>
<p>在这个意义上，<strong>上下文架构师就是那个重构 IN 的人</strong>。<br/>
他负责的，不是单次产出，而是整个团队未来许多次产出的“上限”。</p>
<h2 data-id="heading-8">写在最后：为什么这是一个“必选项”？</h2>
<p>把上述逻辑压缩成一条链：</p>
<ul>
<li>智力被工业化生产之后，真正昂贵的变成了“构造上下文”；</li>
<li>一切任务都可以看成 IN → 推理 → OUT，当前重要的问题是：<strong>我们用什么方式来构造 IN</strong>；</li>
<li>通用上下文工程面对的是一个未知世界，只能依赖 Search + 动态拼接，在复杂业务里会遇到天花板；</li>
<li>对具体组织而言，Context 是可以被设计、被维护、被演进的资产；</li>
<li>为自己的业务建立一套“私有 Context 工程实践”，不是锦上添花，而是在新的成本结构下 <strong>能否真正用好 AI 的前提条件</strong>；</li>
<li>上下文架构师，则是这套实践的设计者和守门人，通过约束、流程和存储结构，把“与 AI 协作”这件事变成可工程化、可积累的事情。</li>
</ul>
<p>这一篇到这里，我们只回答了一个问题：</p>
<blockquote>
<p>在今天的环境里，<strong>为什么私有 Context 工程是必然会被提出、并且迟早会有人去做的事情</strong>。</p>
</blockquote>
<p>在下篇里，我们可以进一步聊聊私有上下文工程如何落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LLM 交互的“省钱”新姿势：JSON 已死，TOON 当立]]></title>    <link>https://juejin.cn/post/7572453554331009024</link>    <guid>https://juejin.cn/post/7572453554331009024</guid>    <pubDate>2025-11-15T03:38:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572453554331009024" data-draft-id="7572408522438344739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LLM 交互的“省钱”新姿势：JSON 已死，TOON 当立"/> <meta itemprop="keywords" content="后端,AIGC"/> <meta itemprop="datePublished" content="2025-11-15T03:38:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小奏技术"/> <meta itemprop="url" content="https://juejin.cn/user/395479918848487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LLM 交互的“省钱”新姿势：JSON 已死，TOON 当立
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479918848487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小奏技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T03:38:16.000Z" title="Sat Nov 15 2025 03:38:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>嘿，兄弟！你是不是也感觉 AI 越来越香，但 Token 账单也越来越“烫”？ 💸</p>
<p><code>GPT-4o</code>、<code>Kimi</code> 这些模型的上下文窗口动不动就几十万、上百万 <code>Token</code>，我们恨不得把整个项目都扔进去。但冷静下来看看账单... ... 哇哦</p>
<p><code>LLM</code> 的 <code>Token</code> 每一分都是真金白银啊！</p>
<p>当大家都在想办法优化模型、优化算法时，有没有想过，我们每天都在用的 <code>JSON</code>，可能就是那个“背刺”我们 Token 费用的“内鬼”？</p>
<p>JSON 虽好，但它实在是... ... 太！啰！嗦！了！</p>
<h2 data-id="heading-1">“内鬼”现形：JSON 到底有多浪费</h2>
<p>在 LLM 的世界里，Token 就是钱。表达同样的信息，谁用的 Token 少，谁就是赢家。</p>
<p>不信？我们直接上例子，用事实说话。</p>
<p>假设我们有这样一个简单的用户列表：</p>
<h3 data-id="heading-2">1. 冗长的“老大哥”：JSON</h3>
<p>标准的 JSON 格式，充满了大括号、双引号和逗号，简直是 Token 杀手。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Alice"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">25</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Charlie"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">35</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>（数数看，光是 name 这个词就重复了 3 遍！）</p>
<h3 data-id="heading-3">2. “小清新”但还不够：YAML</h3>
<p>YAML 确实清爽了不少，用缩进代替了括号，也去掉了双引号。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Alice</span>
  <span class="hljs-attr">age:</span> <span class="hljs-number">30</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Bob</span>
  <span class="hljs-attr">age:</span> <span class="hljs-number">25</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Charlie</span>
  <span class="hljs-attr">age:</span> <span class="hljs-number">35</span>
</code></pre>
<p>嗯，进步了，但不多。id, name, age 这些键名还是在无情地重复。</p>
<h3 data-id="heading-4">3. “抠门”的王者：TOON 登场！</h3>
<p>TOON （Token-Oriented Object Notation）闪亮登场，它用了一种近乎“变态”的方式来压缩信息：</p>
<pre><code class="hljs language-TOON" lang="TOON">[3]{id,name,age}:
  1,Alice,30
  2,Bob,25
  3,Charlie,35
</code></pre>
<p>看明白了吗？[3] 表示有3个对象，{id,name,age} 只定义了一次“表头”，后面的数据就像 CSV 一样紧凑排列。</p>
<p>没有对比就没有伤害！ 同样的数据，<code>TOON</code> 的 <code>Token</code> 占用量简直是“骨折价”！</p>
<h2 data-id="heading-5">啥是 TOON？为 LLM 而生的“省钱利器”</h2>
<p><code>TOON</code>（面向 Token 的对象表示法）就是这么一个专为 LLM 提示词而生的、紧凑且人类可读的数据格式。</p>
<p>它能表示和 <code>JSON</code> 一模一样的对象、数组和数据类型，但它的语法就是为了最小化 Token 使用而设计的。</p>
<p>你可以把它理解为 <code>YAML</code> 的嵌套结构 +<code> CSV</code> 的表格布局 = <code>TOON</code></p>
<p>TOON 最擅长处理的场景，就是我们最常见的**“结构一致的对象数组”**。在实现 CSV 般紧凑的同时，它又提供了清晰的结构信息（{key1, key2}:），帮助 LLM 更可靠地解析和验证数据。</p>
<blockquote>
<p>注意： TOON 并非银弹。如果你的数据是深度嵌套或结构极其不统一的，那 JSON 可能还是老老实实的选择。但在“对象数组”这个 LLM 最常见的场景下，TOON 简直无敌。</p>
</blockquote>
<h2 data-id="heading-6">数据为证：TOON 到底有多能打？</h2>
<p>光说不练假把式。<code>Chase Adams</code> 大佬做了一组非常直观的基准测试，对比了 <code>JSON</code>、<code>YAML</code>、<code>TOON</code> 和 <code>CSV</code> 的 <code>Token</code> 效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fb85506e00a48b19fe5304bcfd16793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5aWP5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763782696&amp;x-signature=hPM7corj2AoLxlSEq%2BZ16r7lJfQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12f9a5eaf8104b99bbe50a23c0c26149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5aWP5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763782696&amp;x-signature=Q8OVpSc4uu1YqOfj6VTa3kUyXc4%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>基准测试链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.curiouslychase.com%2Fplayground%2Fformat-tokenization-exploration" target="_blank" title="https://www.curiouslychase.com/playground/format-tokenization-exploration" ref="nofollow noopener noreferrer">www.curiouslychase.com/playground/…</a></p>
</blockquote>
<p>结论一目了然：</p>
<p><code>CSV</code> 是 <code>Token</code> 效率的“天花板”，但它无法表示嵌套结构，而且没有元数据，LLM 很容易“读歪”。</p>
<p><code>TOON</code> 稳坐第二把交椅，效率直逼 CSV，但它保留了完整的结构信息。</p>
<p>J<code>SON</code> 和 <code>YAML</code>... ... 两位老大哥，在 <code>Token</code> 效率上被 <code>TOON</code> 吊打。</p>
<h2 data-id="heading-7">如何在 LLM 中“无痛”用上 TOON？</h2>
<p>你可能会想：“哇，这么牛？那我岂不是要重构整个系统？”</p>
<p>完全不用</p>
<p>官方推荐的架构是这样的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cc3d269124e4fb983ca51c898a65ab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5aWP5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763782696&amp;x-signature=TeXTKGnpbLsqNdwbD5tpA%2B9zyM8%3D" alt="" loading="lazy"/></p>
<p>看懂了吗？<code>TOON</code> 只是一个**“转换层”**。</p>
<p>你的系统内部，该用 <code>JSON</code> 还是用 <code>JSON</code>，啥也不用改。</p>
<p>在调用 <code>LLM</code> 之前，你只需加一个编码步骤，把 <code>JSON</code> 编码（Encode） 成 <code>TOON</code> 格式再发送。</p>
<p><code>LLM</code> 返回 <code>TOON</code> 格式的数据后，你再解码（Decode） 成 <code>JSON</code> 给系统用。</p>
<p>你就把它当成一个“中间件”，在和 <code>LLM</code> 交互的“最后一公里”上帮你省钱</p>
<h2 data-id="heading-8">别再浪费 Token 了！</h2>
<p>在 <code>LLM</code> 时代，<code>Token</code> 效率就是核心竞争力。</p>
<p><code>JSON</code> 是一个伟大的格式，但在 <code>LLM</code> 交互这个新场景下，它显得既臃肿又昂贵。</p>
<p><code>TOON</code> 提供了一个完美的替代方案：它在保留 <code>JSON</code> 完整表达能力的同时，实现了接近 <code>CSV</code> 的 <code>Token</code> 效率。</p>
<p>如果你还在为高昂的 <code>LLM Token</code> 费用而头疼，如果你还在忍受 <code>JSON</code> 带来的冗余，那么，是时候给你的系统“升个舱”了</p>
<h2 data-id="heading-9">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftoon-format%2Ftoon" target="_blank" title="https://github.com/toon-format/toon" ref="nofollow noopener noreferrer">github.com/toon-format…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.curiouslychase.com%2Fplayground%2Fformat-tokenization-exploration" target="_blank" title="https://www.curiouslychase.com/playground/format-tokenization-exploration" ref="nofollow noopener noreferrer">www.curiouslychase.com/playground/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[地图引擎性能优化：解决3DTiles加载痛点的六大核心策略]]></title>    <link>https://juejin.cn/post/7572537221541052431</link>    <guid>https://juejin.cn/post/7572537221541052431</guid>    <pubDate>2025-11-16T07:20:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221541052431" data-draft-id="7572207610495041570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="地图引擎性能优化：解决3DTiles加载痛点的六大核心策略"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-16T07:20:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            地图引擎性能优化：解决3DTiles加载痛点的六大核心策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:20:34.000Z" title="Sun Nov 16 2025 07:20:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>实景三维应用落地绕不开的一个问题就是：<strong>如何高性能加载大规模倾斜数据？</strong></p>
<p>今天这期，我们先来说说如何用好<strong>Mapmost地图引擎</strong>，让您在<strong>大规模倾斜数据的精细呈现</strong>与<strong>设备性能</strong>之间取得平衡，满足开发者和终端用户的需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/430c57db068640a4ace8bf84614562f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=x526fbbOZ%2Ff1iqHji8ucsrOPzzI%3D" alt="" loading="lazy"/></p>
<p>Mapmost SDK for WebGL面向<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266397264%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%2580%25BE%25E6%2596%259C%25E6%2591%2584%25E5%25BD%25B1%25E6%2595%25B0%25E6%258D%25AE%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266397264&amp;content_type=Article&amp;match_order=1&amp;q=%E5%80%BE%E6%96%9C%E6%91%84%E5%BD%B1%E6%95%B0%E6%8D%AE&amp;zhida_source=entity" ref="nofollow noopener noreferrer">倾斜摄影数据</a>加载，系统性地开放了<strong>六项关键能力</strong>：</p>
<p><strong><em>1.</em></strong> **自定义内存管理机制：**主动控制资源占用</p>
<p><strong><em>2.</em></strong> **动态瓦片清晰度调整：**倾斜视角智能优化</p>
<p><strong><em>3.</em></strong> **瓦片调度策略优化：**过滤冗余请求</p>
<p><strong><em>4.</em></strong> **场景清晰度调整：**画质精度自己定</p>
<p><strong><em>5.</em></strong> **跳级渲染机制：**提速加载过程</p>
<p><strong><em>6.</em></strong> **目的地预加载机制：**有效减少等待时间</p>
<p>从内存控制、调度策略到渲染机制，帮助用户轻松实现<strong>流畅与精细</strong>兼得的三维体验。</p>
<h2 data-id="heading-0">一、自定义内存管理机制：主动控制资源占用</h2>
<p>✅ <strong>解决问题</strong>：同一场景在不同设备加载时，性能较弱的设备易因内存占用过高导致崩溃。</p>
<p><strong>核心功能</strong>：用户可设置<code>maxMemoryUsage</code>参数，明确限制瓦片数据的最大缓存内存使用量，包括几何体和纹理等资源的存储限制。当缓存数据量超出设定值时，系统会自动卸载不常用的瓦片，同时全屏调整为显示更粗糙的瓦片级别。</p>
<p><strong>使用建议</strong>：<code>maxMemoryUsage</code>参数越大画质越优，但相应会对性能产生更大压力。建议根据实际设备性能情况灵活调整，平衡画质与流畅度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02060f64b71e4e079282509281b02ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=m2nPG8YF5THx%2Be2YQdCmCfO%2FFrM%3D" alt="" loading="lazy"/></p>
<p><em>不开启内存管理机制</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca44aff1ec742129402f0b52ed3024b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=JE7tl%2Bf%2FJxClGWXbupucxBDEEwg%3D" alt="" loading="lazy"/></p>
<p><em>开启内存管理机制并设置最大内存为500MB</em></p>
<h2 data-id="heading-1">二、动态瓦片清晰度调整：倾斜视角智能优化</h2>
<p>✅ <strong>解决问题</strong>：相机倾斜时，远处瓦片加载冗余，降低性能。</p>
<p><strong>核心功能</strong>：当用户降低水平视角观察场景时，系统会自动降低远处瓦片的渲染精度，从而节省请求与渲染资源。</p>
<p><strong>适用场景</strong>：大范围倾斜浏览、移动巡检场景</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a6383a0731943b78d10780010fe180b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=EXP0jjoGIJPHT9emw%2FT%2BDTDHTjs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、瓦片调度策略优化：过滤冗余请求</h2>
<p>✅ <strong>解决问题</strong>：相机移动时，大量无用瓦片请求占用带宽，拖慢加载速度。</p>
<p><strong>核心功能</strong>：专门针对相机移动过程中的冗余请求进行过滤。在相机移动过程中，系统会根据设置的过滤强度剔除掉因相机移动而实际上不会使用到的瓦片请求，减少不必要的数据加载。</p>
<p><strong>使用建议</strong>：过滤强度值不宜过大，过大的设置可能会导致过度剔除，增加部分瓦片加载时间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e9fac536b14bc493963ce86949dc37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=I3WypHO4QXv0%2FTX9f2005cRZF18%3D" alt="" loading="lazy"/></p>
<p><em>关闭瓦片调度策略优化</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af83f8f29fb24c258700c4513d2d31b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=yQxVrfdIEp5QGXKjA9zFtKrzAjI%3D" alt="" loading="lazy"/></p>
<p><em>开启瓦片调度策略优化</em></p>
<h2 data-id="heading-3">四、场景清晰度调整：画质精度自己定</h2>
<p>✅ <strong>解决问题</strong>：固定精度导致“要么模糊要么卡顿”。</p>
<p><strong>核心功能</strong>：用户可设置<code>maximumScreenSpaceError</code>最大屏幕空间误差参数直观控制模型显示的精细程度。该值越小，同层级下模型越精细，但相应的性能消耗也越大；反之则模型越粗糙，但性能越好。</p>
<p><strong>使用建议</strong>：建议根据项目对细节程度的要求灵活设置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aa178c9e31e4443ac7a14d0f2783dc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=umJgZm1Icjm39ujloSrUI6960WE%3D" alt="" loading="lazy"/></p>
<p><em>maximumScreenSpaceError=8</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64cad6f2ce09445a89c7262c62eeb1e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=LZmEwT2V2pbRdgxp8GSZGuugRSA%3D" alt="" loading="lazy"/></p>
<p><em>maximumScreenSpaceError=32</em></p>
<h2 data-id="heading-4">五、跳级渲染机制：提速加载过程</h2>
<p>✅ <strong>解决问题</strong>：瓦片逐层加载慢，场景初始化耗时久。</p>
<p><strong>核心功能</strong>：通过优化瓦片渲染顺序，确保用户最可能关注的内容优先加载和渲染，大幅缩短等待时间，提升用户体验。</p>
<p><strong>使用建议</strong>：建议开启。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec40e731f3324589bc2ecfe8dd624947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=Iw93tkIIdYOCCobPw%2B09uLTAUaU%3D" alt="动图封面" loading="lazy"/></p>
<p>跳级渲染</p>
<p><strong>六、目的地预加载机制：有效减少等待时间</strong></p>
<p>✅ <strong>解决问题</strong>：飞行切换新区域时，瓦片加载滞后，出现卡顿现象。</p>
<p><strong>核心功能</strong>：在飞行过程中提前加载目标区域瓦片数据，实现**“人未到，数据已就位”**，有效减少飞到新区域时的等待时间。</p>
<p><strong>使用建议</strong>：当该机制开启，飞行过程中的帧率可能会有所降低，需要根据实际需求决定是否开启。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3507a6b710c04ea88e5591443c3756e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=h17Nzxh0W7KFYqsAOLB0CObTNm0%3D" alt="动图封面" loading="lazy"/></p>
<p><em>目的地预加载</em></p>
<p><strong>配套数据服务要求：优化效果的基础保障</strong></p>
<p><strong>6大核心能力</strong>的落地，需配合以下数据服务配置，确保性能最大化：</p>
<p>**<em>1.</em> 数据预处理：开启顶层重建，**合并简化底层冗余数据，优化瓦片层级结构。</p>
<p><strong><em>2.</em> 纹理格式：采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266397264%26content_type%3DArticle%26match_order%3D1%26q%3DKTX2.0%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266397264&amp;content_type=Article&amp;match_order=1&amp;q=KTX2.0&amp;zhida_source=entity" ref="nofollow noopener noreferrer">KTX2.0</a></strong></p>
<p>**压缩，**模型纹理需转换为 KTX2.0 格式，替代传统 PNG/JPG。</p>
<p><strong><em>3.</em> 服务分发：使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266397264%26content_type%3DArticle%26match_order%3D1%26q%3DMapmost%2BStudio%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266397264&amp;content_type=Article&amp;match_order=1&amp;q=Mapmost+Studio&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Mapmost Studio</a></strong></p>
<p>**代理，**通过 Mapmost Studio 对数据进行坐标转换并配置数据代理服务，统一管理瓦片分发。</p>
<h2 data-id="heading-5">场景化配置示例：300 平方公里全园区倾斜模型</h2>
<p>以加载<strong>300平方公里全园区倾斜模型</strong>为例，建议配置如下：</p>
<p><strong>1. 必开能力</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db2e50a4730d4c9e95170d1727435b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=60KKKWy5IN9ufvnB%2F06USa9IzCU%3D" alt="" loading="lazy"/></p>
<p><strong><em>2.</em> 按需补充</strong>：</p>
<p><strong>目的地预加载机制：<strong>若场景中需要频繁进行</strong>飞行切换区域</strong>（如场景巡检），建议额外开启「目的地预加载机制」，提前加载飞行终点的瓦片，减少飞行落地后的等待时间。</p>
<p>**场景清晰度调整：**根据需求与数据情况调整maximumScreenSpaceError参数，一般保持默认即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1a5ca82aa7b4a668a9770c7f26f76f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=Na870qnrWtdKKvq7nkvQ7IzkNa4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">结语</h2>
<p>Mapmost 倾斜加载能力从**“内存适配、性能优化、加载效率”**三大维度出发，无需复杂开发，通过简单参数配置即可实现：</p>
<p>✅ **全设备兼容：**低性能设备也能流畅运行</p>
<p>✅ **画质性能平衡：**按需调整，告别“一刀切”</p>
<p>✅ **操作体验升级：**移动、飞行场景快速加载</p>
<p>这些优化能力全方位提升了大场景倾斜模型的应用体验，让开发者能够更专注于业务逻辑的实现，而不必过度担忧性能瓶颈。Mapmost后续将持续优化三维可视化技术，为行业提供更强大、更易用的开发工具和解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用了这个更厉害的P图AI，我把PS卸了！文字也能无痕修改！1秒救废图（附保姆级教程）]]></title>    <link>https://juejin.cn/post/7572749797468831753</link>    <guid>https://juejin.cn/post/7572749797468831753</guid>    <pubDate>2025-11-16T07:55:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572749797468831753" data-draft-id="7572793505899724851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用了这个更厉害的P图AI，我把PS卸了！文字也能无痕修改！1秒救废图（附保姆级教程）"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-16T07:55:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员X小鹿"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709505608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用了这个更厉害的P图AI，我把PS卸了！文字也能无痕修改！1秒救废图（附保姆级教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709505608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员X小鹿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:55:37.000Z" title="Sun Nov 16 2025 07:55:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是X小鹿。</p>
<p>现在越来越多的人都开始用 AI 来生成图片了，各种海报、电商图等等。</p>
<p>比如我平时用的最多的场景，就是生成封面和文章配图 。</p>
<p>对于一个完全不懂画画的人来说，真的非常方便。</p>
<p>但平时用 AI 画图遇到最多的问题就是：</p>
<p><strong>图片上大部分地方都满意，但往往一个「瑕疵」，坏了整张图片。</strong></p>
<p>不知道大家有没有和我一样的经历。</p>
<p>比如下面这张图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52ad6571b78c4d5c97bda9066ba4d152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=5afNQi1J6vrBxneEesSlEwy42eY%3D" alt="图片" loading="lazy"/></p>
<p>“搞定”两字挤在一起了，而且还想把图中的主、副标题移动个位置。</p>
<p>但用目前主流的一些 AI 绘画工具或图片编辑工具，要么改不了，要么效果不理想。</p>
<p>重新生成，整张图都变了，又得抽一会。</p>
<p>不过最近看 Lovart 上线了「编辑元素」的功能，很好得解决了些问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8fdbf8240ba45c88dbcc5eb6fce25de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=9l%2FKViWnggStxEqrCY%2F9naaI19g%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p><strong>只需要把修改的图片拖进 Lovart，Lovart 的「编辑元素」功能，就能将图片拆分成多个独立的图层。文字、背景及图片中的主体都可以随修改、删除或移动到任意位置。</strong></p>
</blockquote>
<p>一起来看看吧~</p>
<h2 data-id="heading-0">Lovart 编辑元素</h2>
<p>打开 Lovart：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lovart.ai%2F" target="_blank" title="https://www.lovart.ai/" ref="nofollow noopener noreferrer">www.lovart.ai/</a></p>
<p>点「项目」-「新建项目」：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4661a6675dfa40fb9d64ddaf350f5962~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=lL58iQEJSXWs%2FbjWFNgjcdmtCkU%3D" alt="图片" loading="lazy"/></p>
<p>将要修改的图片拖进 Lovart，然后点「编辑元素」：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8874b9e2af440878d97f3c3ab000863~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=2ysSWc0%2BIYdMexcFErdrWIYnmCA%3D" alt="图片" loading="lazy"/></p>
<p>稍微等一会，图片就被拆分成了多个可编辑的图层：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb8d372ec576494a98cd59dccaa98728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=xhJPeHJ5jXCAs3hTG4mXJTplPhU%3D" alt="图片" loading="lazy"/></p>
<p>可以随意修改文字内容、颜色、字体、粗细、字号、对齐方式、字间距、行间距等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2905498b37f458cb08379ea4fa438bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=6iuVCyiFDboNeIGgjQyNKi5OBIw%3D" alt="图片" loading="lazy"/></p>
<p>画面中被拆分出来的其他元素，也能随意放大、缩小、删除、移动位置。</p>
<p>修改完成后，<strong>记得先「合并图层」再「下载」</strong>，否则可能仅仅是把某一个图层下载下来了，不完整。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dda05b3edb35453c9e54dc2afc040ef0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=OBPHCLnKxXCd0yteWPBmPQY8q5U%3D" alt="图片" loading="lazy"/></p>
<p>虽然有时拆分完，可能会有一些元素丢失，可以再重试一下，不过整体效果还可以。</p>
<p>而且 Lovart 的免费用户，目前每天都有 100 积分，而「编辑元素」，每次只需要消耗 5 积分。</p>
<h2 data-id="heading-1">写在最后</h2>
<p>Lovart，作为全球首个设计智能体，能够将用户的模糊创意一步步转化为专业的设计作品。</p>
<p>还整合了 Nano Banana、Seedream、Midjourney、Sora、Veo、Hailuo、Kling、Tripo 等主流 AI 图片、视频、3D 模型。</p>
<p>除了今天介绍的「编辑元素」外，Lovart 还有很多实用的功能，感兴趣的都可以试试。</p>
<hr/>
<blockquote>
<p>我是<a href="https://juejin.cn/user/2928754709505608/posts" title="https://juejin.cn/user/2928754709505608/posts" target="_blank">程序员X小鹿</a>，前互联网大厂程序员，也是一名 AIGC 爱好者，持续分享更多好用的 AI 工具，欢迎一起交流~</p>
</blockquote>
<p><strong>推荐阅读</strong></p>
<p><a href="https://juejin.cn/post/7454501732203610131" title="https://juejin.cn/post/7454501732203610131" target="_blank">2024年终AI工具汇总：9大AI领域，70+精选AI工具，全都在这了！(建议收藏)</a></p>
<p>更多 AI 工具见<a href="https://juejin.cn/column/7284164153576947724" title="https://juejin.cn/column/7284164153576947724" target="_blank">【AI工具】</a>专栏，持续更新中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每周AI论文速递（251110-251114）]]></title>    <link>https://juejin.cn/post/7572697146287226930</link>    <guid>https://juejin.cn/post/7572697146287226930</guid>    <pubDate>2025-11-16T06:40:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572697146287226930" data-draft-id="7572749797468684297" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每周AI论文速递（251110-251114）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-16T06:40:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶子的技术碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2831954919569245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每周AI论文速递（251110-251114）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831954919569245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶子的技术碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:40:15.000Z" title="Sun Nov 16 2025 06:40:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Lumine: An Open Recipe for Building Generalist Agents in 3D Open Worlds</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08892" target="_blank" title="https://arxiv.org/abs/2511.08892" ref="nofollow noopener noreferrer">Lumine: 构建3D开放世界中通用AI智能体的开放方案</a></p>
<p>我们推出Lumine，这是首个用于开发通用AI智能体的开放方案，能够在挑战性3D开放世界环境中实时完成长达数小时的复杂任务。Lumine采用类人交互范式，以视觉语言模型驱动，端到端地统一感知、推理与行动。它以5Hz处理原始像素，生成精确的30Hz键鼠动作，并仅在必要时自适应触发推理。在《原神》中训练后，Lumine成功通关整个五小时蒙德主线剧情，效率达到人类水平，并能遵循自然语言指令，在3D开放世界探索和2D图形界面操作中广泛执行收集、战斗、解谜及NPC交互等任务。除领域内性能外，Lumine还展现出强大的零样本跨游戏泛化能力：无需微调，即可在《鸣潮》中完成100分钟任务，并在《崩坏：星穹铁道》中通关完整五小时第一章。这些显著成果证明了Lumine在不同世界与交互机制中的高效性，标志着开放环境下通用AI智能体发展的实质性进展。</p>
<h2 data-id="heading-1">Grounding Computer Use Agents on Human Demonstrations</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.07332" target="_blank" title="https://arxiv.org/abs/2511.07332" ref="nofollow noopener noreferrer">基于人类演示的计算机使用智能体基础构建</a></p>
<p>构建可靠的计算机使用智能体需要基础化：将自然语言指令与正确的屏幕元素精确关联。尽管已有大量网页和移动交互数据集，但桌面环境的高质量数据资源仍显不足。为填补这一空白，我们推出了 GroundCUA——一个基于专家人类演示构建的大规模桌面基础化数据集。该数据集覆盖 12 个类别下的 87 个应用程序，包含 5.6 万张屏幕截图，所有屏幕元素均经过精细标注，累计人类验证标注量超过 356 万条。基于这些演示，我们生成了涵盖广泛现实任务的多样化指令，为模型训练提供高质量数据支撑。利用 GroundCUA，我们开发了 GroundNext 系列模型，能够将指令映射至对应 UI 元素。在 30 亿和 70 亿参数规模下，通过监督微调，GroundNext 在五项基准测试中均达到最先进水平，且训练数据量不足先前工作的十分之一。后续强化学习进一步提升了模型性能，在 OSWorld 基准的智能体测试环境中，以 o3 作为规划器时，GroundNext 取得了与使用远超其训练数据量的模型相当或更优的结果。这些成果印证了高质量专家驱动数据集对推进通用计算机使用智能体发展的关键作用。</p>
<h2 data-id="heading-2">Tiny Model, Big Logic: Diversity-Driven Optimization Elicits Large-Model Reasoning Ability in VibeThinker-1.5B</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.06221" target="_blank" title="https://arxiv.org/abs/2511.06221" ref="nofollow noopener noreferrer">小模型，大逻辑：多样性驱动优化激发 VibeThinker-1.5B 的大模型级推理能力</a></p>
<p>针对当前普遍认为小模型天生缺乏强大推理能力的共识，本报告提出了 VibeThinker-1.5B，这是一个通过频谱到信号原则 (SSP) 开发的 1.5B 参数密集模型。该模型挑战了通过扩大模型参数来提升能力的流行方法，例如 DeepSeek R1 (671B) 和 Kimi k2 (&gt;1T) 等模型所采用的策略。SSP 框架首先采用两阶段多样性探索蒸馏 (SFT) 生成广泛的解空间，随后通过最大熵引导策略优化 (RL) 强化正确信号。总训练成本仅为 7,800 美元，VibeThinker-1.5B 在推理能力上优于闭源模型如 Magistral Medium 和 Claude Opus 4，并与开源模型 GPT OSS-20B Medium 表现相当。值得注意的是，它在三个数学基准测试中超越了参数规模大 400 倍的 DeepSeek R1：AIME24 (80.3 对 79.8)、AIME25 (74.4 对 70.0) 和 HMMT25 (50.4 对 41.7)。这相对于其基础模型（得分分别为 6.7、4.3 和 0.6）是显著提升。在 LiveCodeBench V6 上，其得分为 51.1，超过 Magistral Medium 的 50.3 及其基础模型的 0.0。这些结果表明，小模型能够实现与大模型相媲美的推理能力，大幅降低训练和推理成本，从而推动先进 AI 研究的普及。</p>
<h2 data-id="heading-3">HaluMem: Evaluating Hallucinations in Memory Systems of Agents</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.03506" target="_blank" title="https://arxiv.org/abs/2511.03506" ref="nofollow noopener noreferrer">HaluMem：评估智能体记忆系统中的幻觉</a></p>
<p>记忆系统是实现大语言模型（LLM）和AI智能体等人工智能系统长期学习与持续交互的关键组件。然而在记忆存储和检索过程中，这些系统常出现记忆幻觉现象，包括虚构、错误、冲突和遗漏等问题。现有对记忆幻觉的评估主要采用端到端问答形式，难以准确定位幻觉在记忆系统内部产生的具体操作环节。为此，我们提出记忆幻觉基准（HaluMem），这是首个专为记忆系统设计的操作级幻觉评估基准。HaluMem定义了记忆提取、记忆更新和记忆问答三项评估任务，全面揭示交互过程中不同操作阶段的幻觉行为。为支持评估，我们构建了以用户为中心的多轮人机交互数据集HaluMem-Medium和HaluMem-Long，两者均包含约1.5万记忆点和3500个多类型问题。每个用户的平均对话轮数分别达到1500轮和2600轮，上下文长度超过100万token（Token），可评估不同上下文规模与任务复杂度下的幻觉现象。基于HaluMem的实证研究表明，现有记忆系统在提取和更新阶段容易产生并积累幻觉，进而将错误传播至问答阶段。未来研究应致力于开发具有可解释性的受约束记忆操作机制，系统性地抑制幻觉并提升记忆可靠性。</p>
<h2 data-id="heading-4">One Small Step in Latent, One Giant Leap for Pixels: Fast Latent Upscale Adapter for Your Diffusion Models</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.10629" target="_blank" title="https://arxiv.org/abs/2511.10629" ref="nofollow noopener noreferrer">潜在空间一小步，像素维度大跨越：扩散模型快速潜在上采样适配器</a></p>
<p>扩散模型难以突破其训练分辨率的限制：直接进行高分辨率采样速度缓慢且计算成本高昂，而后处理的图像超分辨率（ISR）方法需在解码后执行操作，不仅会引入伪影，还会增加额外延迟。本文提出潜在上采样适配器（LUA），该轻量模块可在最终VAE解码步骤之前，直接在生成器的潜在编码上执行超分辨率。LUA以即插即用式组件形式集成，无需修改基础模型结构或增加额外扩散阶段，仅需在潜在空间执行单次前向传播即可实现高分辨率合成。其采用共享式Swin架构骨干网络配合多尺度像素重组头，支持2倍与4倍上采样因子，同时保持与图像空间超分辨率基准的兼容性——在达到相近感知质量的前提下，将解码与上采样时间降低近3倍（从512像素生成1024像素仅需增加0.42秒，而使用相同SwinIR架构的像素空间超分辨率需1.87秒）。此外，LUA在不同VAE的潜在空间均展现出卓越的泛化能力，无需针对每个新解码器重新训练即可快速部署。大量实验表明，LUA在保真度方面可媲美原生高分辨率生成，同时为现代扩散流程中的可扩展高保真图像合成提供了实用高效的解决方案。</p>
<h2 data-id="heading-5">TiDAR: Think in Diffusion, Talk in Autoregression</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08923" target="_blank" title="https://arxiv.org/abs/2511.08923" ref="nofollow noopener noreferrer">TiDAR: 扩散思考，自回归交谈</a></p>
<p>扩散语言模型具备快速并行生成能力，而自回归 (AR) 模型因其因果结构与语言建模天然契合，通常在生成质量上更优。这引出一个核心问题：能否在实现高吞吐量、更高 GPU 利用率的同时，达到 AR 级别的质量？现有方法均未能有效平衡这两方面：要么采用较弱模型进行顺序草稿生成（推测解码）以优先保障 AR 特性，导致草稿效率低下；要么为扩散模型引入类 AR 的左到右解码逻辑，仍面临质量下降问题且丧失并行潜力。我们提出 TiDAR——一种序列级混合架构，通过专门设计的结构化注意力掩码，在单次前向传播中实现扩散式 token 草稿生成（思考）与自回归最终输出采样（交谈）。该设计充分利用 GPU 闲置计算资源，在草稿生成与验证能力间取得优异平衡。此外，TiDAR 作为独立模型具备低开销的部署友好特性。我们在 1.5B 和 8B 规模下，针对生成与似然任务对 TiDAR、AR 模型、推测解码及扩散变体进行广泛评估。凭借并行草稿生成与采样机制以及精确 KV 缓存支持，TiDAR 在吞吐量上超越推测解码，在效率与质量方面均优于 Dream、Llada 等扩散模型。最显著的是，TiDAR 成为首个在保持每秒生成 4.71-5.91 倍更多 token 的同时，完全弥合与 AR 模型质量差距的架构。</p>
<h2 data-id="heading-6">IterResearch: Rethinking Long-Horizon Agents via Markovian State Reconstruction</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.07327" target="_blank" title="https://arxiv.org/abs/2511.07327" ref="nofollow noopener noreferrer">IterResearch：通过马尔可夫状态重构重新思考长视野智能体</a></p>
<p>深度研究智能体的最新进展表明，通过对外部信息源进行动态推理，有望实现自主知识构建。然而，现有方法采用单上下文范式，将所有信息累积在持续扩展的上下文窗口中，导致上下文拥塞和噪声干扰，从而限制了其在长视野任务中的效能。我们提出 IterResearch，一种新颖的迭代式深度研究范式，将长视野研究重新定义为具有策略性工作区重构的马尔可夫决策过程。该方法通过维护动态演进的报告作为记忆体，并定期整合关键见解，可在任意探索深度下保持稳定的推理能力。我们还开发了效率感知策略优化 (EAPO)，这是一个基于几何奖励衰减机制激励高效探索的强化学习框架，并通过自适应降采样实现稳定的分布式训练。大量实验表明，IterResearch 在六个基准测试中相较现有开源智能体平均提升 14.5 个百分点，显著缩小了与尖端专有系统的差距。值得注意的是，该范式展现出前所未有的交互扩展能力，支持多达 2048 次交互且性能大幅提升（从 3.5% 增至 42.5%），同时作为有效的提示策略，在长视野任务中较 ReAct 将尖端模型性能提升最高达 19.2 个百分点。这些成果确立了 IterResearch 作为长视野推理的多功能解决方案，既可作为训练完备的智能体独立运行，也可作为尖端模型的提示范式使用。</p>
<h2 data-id="heading-7">PAN: A World Model for General, Interactable, and Long-Horizon World Simulation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.09057" target="_blank" title="https://arxiv.org/abs/2511.09057" ref="nofollow noopener noreferrer">PAN：通用、可交互与长视野的世界模拟模型</a></p>
<p>世界模型使智能体能够想象、预测并推理世界如何随其动作演变，从而进行规划与决策。尽管当前视频生成模型可生成逼真视觉序列，但它们多采用从提示到完整视频的生成模式，缺乏因果控制、交互能力以及目标导向推理所需的长期一致性。而现有世界建模方法常局限于特定领域（如物理、游戏或三维场景动态），深度不足且可控性有限，难以泛化至多样化环境与交互形式。本文提出PAN，一种通用、可交互且支持长视野的世界模型，它基于历史状态与自然语言动作，通过高质量视频模拟预测未来世界状态。PAN采用生成式潜在预测（GLP）架构：其自回归潜在动态主干基于大语言模型（LLM），将模拟锚定于广泛文本知识，并支持语言指定动作的条件控制；视频扩散解码器则重建感知细节丰富且时序一致的视觉观测。该架构实现了潜在空间推理（想象）与可实现世界动态（现实）的统一。通过在大规模跨领域视频-动作对上进行训练，PAN支持开放域的动作条件模拟，并保持连贯的长期动态。大量实验表明，相较于其他视频生成器与世界模型，PAN在动作条件世界模拟、长视野预测及模拟推理任务中均表现优异，为构建通用世界模型迈出关键一步——这类模型能通过对未来状态的预测模拟支持推理与行动决策。</p>
<h2 data-id="heading-8">MADD: Multi-Agent Drug Discovery Orchestra</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08217" target="_blank" title="https://arxiv.org/abs/2511.08217" ref="nofollow noopener noreferrer">MADD：多智能体药物发现协奏曲</a></p>
<p>苗头化合物识别是早期药物发现的核心挑战，传统方法需耗费大量实验资源。人工智能的最新进展，特别是大语言模型 (LLMs)，催生了可降低成本和提升效率的虚拟筛选方法。然而，这些工具日益复杂，限制了湿实验研究人员的实际使用。多智能体系统通过融合 LLMs 的可解释性与专业模型及工具的精确性，提供了颇具前景的解决方案。本研究提出 MADD——一个能够根据自然语言查询构建并执行定制化苗头化合物识别流程的多智能体系统。MADD 部署四个协同工作的智能体，分别处理从头化合物生成与筛选中的关键子任务。我们在七个药物发现案例中评估 MADD，证明其性能优于现有基于 LLM 的解决方案。借助 MADD，我们率先将 AI 驱动的药物设计应用于五个生物靶标，并公开了已识别的苗头分子。最后，我们建立了包含三百余万种化合物的查询-分子对与对接评分新基准，以推动药物设计迈向智能体主导的未来。</p>
<h2 data-id="heading-9">Too Good to be Bad: On the Failure of LLMs to Role-Play Villains</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.04962" target="_blank" title="https://arxiv.org/abs/2511.04962" ref="nofollow noopener noreferrer">过于良善难成恶：大语言模型在反派角色扮演中的失败</a></p>
<p>大语言模型（LLMs）正日益承担创造性生成任务，包括模拟虚构角色。然而，模型在刻画非亲社会或敌对型角色方面的能力仍鲜有研究。我们假设，现代大语言模型的安全对齐机制与逼真扮演道德模糊或反派角色的任务之间存在根本性冲突。为探究此问题，我们提出了道德角色扮演基准（Moral RolePlay benchmark），该新数据集包含四级道德倾向量表和一个平衡测试集，用于严格评估。我们要求前沿大语言模型扮演从道德楷模到纯粹恶棍的各类角色。大规模评估结果表明，随着角色道德水平的降低，角色扮演的逼真度呈现稳定且单调的下降趋势。模型在与安全原则直接冲突的特质上表现最差，如“欺诈性”和“操纵性”，往往以浅层的攻击性替代复杂的恶意刻画。此外，我们发现通用聊天机器人能力无法有效预测反派扮演水平，高度优化安全的模型表现尤为逊色。本研究首次系统性地揭示了这一关键局限，突显了模型安全性与创造性真实度之间的核心矛盾。所提出的基准和结论为开发更精细、情境感知的对齐方法奠定了基础。</p>
<h2 data-id="heading-10">Time-to-Move: Training-Free Motion Controlled Video Generation via Dual-Clock Denoising</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08633" target="_blank" title="https://arxiv.org/abs/2511.08633" ref="nofollow noopener noreferrer">Time-to-Move：通过双时钟去噪实现免训练的运动控制视频生成</a></p>
<p>基于扩散模型的视频生成技术能够合成逼真视频，但现有基于图像和文本的条件控制方法无法实现精确的运动控制。以往的运动条件合成方法通常需要对特定模型进行微调，计算成本高昂且适用性受限。本文提出 Time-to-Move (TTM) ，一种免训练、即插即用 (plug-and-play) 的框架，通过图像到视频 (I2V) 扩散模型实现运动与外观可控的视频生成。我们的核心思路是利用通过用户友好操作（如剪切-拖拽 (cut-and-drag) 或基于深度的重投影 (depth-based reprojection)）获得的粗略参考动画。受 SDEdit 利用粗略布局线索 (coarse layout cues) 进行图像编辑的启发，我们将这些粗略动画视为运动线索，并将该机制扩展至视频领域。我们通过图像条件保持外观一致性，并引入双时钟去噪 (dual-clock denoising) —— 一种区域依赖策略，在运动指定区域强制执行严格对齐，同时在其余区域保持灵活性，从而在用户意图忠实度与自然运动动态之间取得平衡。这种对采样过程的轻量级修改无需额外训练或运行时开销，且兼容任何骨干网络。在物体运动和相机运动的基准测试上进行的大量实验表明，TTM 在真实感与运动控制精度方面达到或超越了现有基于训练的基线方法。此外，TTM 还具备独特优势：通过像素级条件控制实现精确的外观调控，突破了纯文本提示的限制。欢迎访问我们的项目页面查看视频示例和代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftime-to-move.github.io%2F%25E3%2580%2582" target="_blank" title="https://time-to-move.github.io/%E3%80%82" ref="nofollow noopener noreferrer">time-to-move.github.io/。</a></p>
<h2 data-id="heading-11">DRIVE: Data Curation Best Practices for Reinforcement Learning with Verifiable Reward in Competitive Code Generation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.06307" target="_blank" title="https://arxiv.org/abs/2511.06307" ref="nofollow noopener noreferrer">DRIVE: 竞争性代码生成中带可验证奖励的强化学习数据管理最佳实践</a></p>
<p>近期推理优先模型（如 OpenAI o1、DeepSeek R1）重新激发了对 RLVR 的兴趣。然而，相关进展主要集中在数学领域（如 AIME），竞争性编程代码生成方向探索不足，且数据管理受到的关注远少于 RL 算法设计。本研究探讨如何构建 RLVR 数据集（即 RL 提示），并提出在竞争性编程代码生成中实现强劲性能的实用训练技术。我们的流程始于从强开源模型蒸馏得到的监督微调（SFT），并辅以通用型与推理密集型数据进行增强。随后，强化学习采用包含可执行测试用例驱动奖励的两阶段流程：首先，在均匀分布的大规模竞争性编程问题集上，使用组相对策略优化（GRPO）进行训练，每个提示执行 8 次 rollout，并设置较短响应生成窗口（如 SFT 阶段 32k，本阶段 24k）以扩展熵并减少重复与截断问题；其次，执行 \textbf{Pre-GRPO} 阶段：在小型高质量挑战性问题集上，以每个提示 64 次 rollout 的大预算进行更新，采用硬焦点课程策略持续保留训练全程中最困难的实例。我们在 Qwen2.5-32B 上实现该方法，并在 LeetCode 和 Codeforces 周赛中进行评估以避免数据泄露。最终模型在同等规模模型中达到最先进性能，与 DeepSeek v3.1、Doubao-1.5-Thinking 等领先系统表现相当。我们还分析了缩放趋势，在内部大规模混合专家（MoE）模型上观察到显著的 RL 缩放效应。本研究提炼出竞争性编程代码生成中 RLVR 数据管理、熵扩展与课程设计的简洁最佳实践。</p>
<h2 data-id="heading-12">Visual Spatial Tuning</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.05491" target="_blank" title="https://arxiv.org/abs/2511.05491" ref="nofollow noopener noreferrer">视觉空间调优</a></p>
<p>从视觉输入中捕获空间关系是实现人类水平通用智能的关键基础。先前研究多通过引入额外专家编码器来增强视觉语言模型 (VLMs) 的空间感知能力，但这不仅增加了计算开销，还往往损害模型的通用性能。为在通用架构中有效提升空间能力，我们提出视觉空间调优 (VST) 这一综合框架，旨在系统培养 VLMs 从空间感知到推理的类人视觉空间能力。我们首先通过构建大规模数据集 VST-P 来强化空间感知，该数据集包含 410 万样本，覆盖单视图、多图像和视频三大场景下的 19 类空间任务。继而推出 VST-R 精选数据集（含 13.5 万样本），专门训练模型进行空间推理。我们采用渐进式训练策略：先通过监督微调建立空间知识基础，再通过强化学习进阶优化空间推理能力。在保持通用能力不受影响的前提下，VST 在多个空间基准测试中均达到最先进水平，如在 MMSI-Bench 上获得 34.8% 的准确率，在 VSIBench 上达到 61.2%。实验表明，所提出的空间调优范式能显著增强视觉-语言-行动模型，为推动具身智能发展奠定基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Unibest：新一代uni-app工程化最佳实践指南]]></title>    <link>https://juejin.cn/post/7572480736361889798</link>    <guid>https://juejin.cn/post/7572480736361889798</guid>    <pubDate>2025-11-16T06:22:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736361889798" data-draft-id="7572539461478170667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Unibest：新一代uni-app工程化最佳实践指南"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-16T06:22:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宇余"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453424542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Unibest：新一代uni-app工程化最佳实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453424542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宇余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:22:45.000Z" title="Sun Nov 16 2025 06:22:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在uni-app生态日益成熟的今天，开发者对工程化、性能优化和跨端一致性的需求愈发迫切。Unibest作为一套基于uni-app的企业级工程化方案，整合了路由封装、状态管理、请求拦截、组件规范等核心能力，旨在降低大型项目开发成本，提升团队协作效率。本文将从核心特性、快速上手、实战技巧三个维度，带你全面掌握Unibest的使用方法。</p>
<h2 data-id="heading-0">一、Unibest核心特性解析</h2>
<p>Unibest并非简单的模板集合，而是经过多个生产项目验证的工程化体系，其核心特性可概括为以下四点：</p>
<h3 data-id="heading-1">1.1 开箱即用的工程化方案</h3>
<p>Unibest内置了完整的工程化配置，无需开发者手动搭建：</p>
<ul>
<li>
<p><strong>路由管理</strong>：基于uni-simple-router封装，支持路由守卫、动态路由和路由别名，解决原生uni-app路由跳转繁琐的问题。</p>
</li>
<li>
<p><strong>请求层封装</strong>：统一的request拦截器，支持请求头添加、错误统一处理、loading自动控制，同时兼容mock数据和生产环境切换。</p>
</li>
<li>
<p><strong>代码规范</strong>：集成ESLint + Prettier + Husky，强制代码风格统一，减少团队协作冲突。</p>
</li>
</ul>
<h3 data-id="heading-2">1.2 跨端一致性保障</h3>
<p>针对uni-app跨端开发中常见的样式差异、API兼容性问题，Unibest提供了针对性解决方案：</p>
<ul>
<li>
<p><strong>样式解决方案</strong>：内置px2rpx自动转换，配合scss变量和mixin，确保多端样式一致性；提供适配H5、小程序、App的样式隔离方案。</p>
</li>
<li>
<p><strong>API适配层</strong>：对uni-app原生API进行二次封装，处理不同平台的差异逻辑，如支付、分享等功能的跨端兼容。</p>
</li>
</ul>
<h3 data-id="heading-3">1.3 性能优化内置</h3>
<p>Unibest从初始化阶段就融入了性能优化理念：</p>
<p>核心优化点：页面懒加载、图片懒加载、分包加载配置、大型组件异步引入，启动速度较原生uni-app提升30%+（基于官方测试数据）。</p>
<h3 data-id="heading-4">1.4 丰富的生态集成</h3>
<p>无缝对接uni-app生态的同时，扩展了常用工具库：</p>
<ul>
<li>
<p>状态管理：支持Pinia/Vuex，提供模块化状态管理模板；</p>
</li>
<li>
<p>UI组件：兼容uView、ColorUI等主流UI库，同时提供自定义业务组件模板；</p>
</li>
<li>
<p>工具函数：集成日期处理、加密解密、数据格式化等常用工具。</p>
</li>
</ul>
<h2 data-id="heading-5">二、Unibest快速上手教程</h2>
<p>只需三步，即可搭建基于Unibest的项目：</p>
<h3 data-id="heading-6">2.1 环境准备</h3>
<p>确保已安装以下依赖：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 安装Node.js（v14+）</span>
<span class="hljs-comment"># 安装uni-app CLI</span>
npm install -g @dcloudio/cli
<span class="hljs-comment"># 安装pnpm（推荐）</span>
npm install -g pnpm
    
</code></pre>
<h3 data-id="heading-7">2.2 创建项目</h3>
<p>使用Unibest模板创建新项目：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 克隆Unibest模板</span>
git <span class="hljs-built_in">clone</span> https://github.com/unibest-team/unibest.git my-unibest-project
<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> my-unibest-project
<span class="hljs-comment"># 安装依赖</span>
pnpm install
    
</code></pre>
<h3 data-id="heading-8">2.3 运行项目</h3>
<p>支持多端运行命令：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 运行到微信小程序</span>
pnpm dev:mp-weixin
<span class="hljs-comment"># 运行到H5</span>
pnpm dev:h5
<span class="hljs-comment"># 运行到App（需配合HBuilderX）</span>
pnpm dev:app-plus
    
</code></pre>
<h3 data-id="heading-9">2.4 目录结构解析</h3>
<p>Unibest采用约定式目录结构，核心目录说明：</p>





























<table><thead><tr><th>目录</th><th>功能说明</th></tr></thead><tbody><tr><td>/src/api</td><td>接口请求封装</td></tr><tr><td>/src/router</td><td>路由配置和守卫</td></tr><tr><td>/src/store</td><td>Pinia/Vuex状态管理</td></tr><tr><td>/src/components</td><td>公共组件和业务组件</td></tr><tr><td>/src/utils</td><td>工具函数集合</td></tr></tbody></table>
<h2 data-id="heading-10">三、Unibest实战技巧</h2>
<h3 data-id="heading-11">3.1 多环境配置</h3>
<p>在<code>/src/env</code>目录下配置不同环境的接口地址：</p>
<pre><code class="hljs language-javascript" lang="javascript">

<span class="hljs-comment">// .env.development</span>
<span class="hljs-variable constant_">VITE_BASE_URL</span> = <span class="hljs-string">'https://dev-api.unibest.com'</span>

<span class="hljs-comment">// .env.production</span>
<span class="hljs-variable constant_">VITE_BASE_URL</span> = <span class="hljs-string">'https://api.unibest.com'</span>
    
</code></pre>
<p>通过命令自动切换环境：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 开发环境</span>
pnpm dev:mp-weixin --mode development
<span class="hljs-comment"># 生产环境</span>
pnpm build:mp-weixin --mode production
    
</code></pre>
<h3 data-id="heading-12">3.2 组件封装最佳实践</h3>
<p>以自定义按钮组件为例，Unibest推荐的封装方式：</p>
<pre><code class="hljs language-vue" lang="vue">

&lt;template&gt;
  &lt;button 
    class="u-btn" 
    :class="{ 'u-btn--primary': type === 'primary' }"
    @click="handleClick"
  &gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
const props = defineProps({
  type: {
    type: String,
    default: 'default'
  }
})

const emit = defineEmits(['click'])

const handleClick = (e) =&gt; {
  emit('click', e)
}
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
.u-btn {
  padding: 12rpx 24rpx;
  border-radius: 8rpx;
  &amp;--primary {
    background: #007aff;
    color: #fff;
  }
}
&lt;/style&gt;
    
</code></pre>
<h3 data-id="heading-13">3.3 路由守卫应用</h3>
<p>在<code>/src/router/guard.js</code>中配置全局路由守卫：</p>
<pre><code class="hljs language-javascript" lang="javascript">

<span class="hljs-comment">// 登录拦截</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>)
  <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>.<span class="hljs-property">requiresAuth</span> &amp;&amp; !token) {
    <span class="hljs-title function_">next</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/pages/login/login'</span> })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">next</span>()
  }
})
    
</code></pre>
<h2 data-id="heading-14">四、总结与展望</h2>
<p>Unibest通过标准化的工程化方案，解决了uni-app开发中的痛点问题，尤其适合中大型团队和复杂项目。目前Unibest已支持Vue3+Vite架构，后续将持续优化跨端性能、扩展生态集成（如微前端方案）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[虚拟列表(Virtual List)组件实现与优化铁臂猿版（简易版）]]></title>    <link>https://juejin.cn/post/7572481101710868534</link>    <guid>https://juejin.cn/post/7572481101710868534</guid>    <pubDate>2025-11-16T06:47:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572481101710868534" data-draft-id="7572002432451100681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="虚拟列表(Virtual List)组件实现与优化铁臂猿版（简易版）"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-16T06:47:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西西西西胡萝卜鸡"/> <meta itemprop="url" content="https://juejin.cn/user/2918532014943187"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            虚拟列表(Virtual List)组件实现与优化铁臂猿版（简易版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2918532014943187/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西西西西胡萝卜鸡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:47:30.000Z" title="Sun Nov 16 2025 06:47:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>引入：本文使用vue3+ts+tailwindcss实现</p>
</blockquote>
<h2 data-id="heading-0">一、为什么需要“虚拟列表”？</h2>
<p>当我们在页面中渲染一个<strong>很长的列表</strong>时（比如上万条数据），普通的<code>v-for</code>会一次性创建上万个DOM节点：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;li v-for="item in 10000"&gt;{{ item }}&lt;/li&gt;
</code></pre>
<p>这会导致：</p>
<ul>
<li>页面加载慢；</li>
<li>内存占用大；</li>
<li>滚动卡顿。</li>
</ul>
<p>于是就有了性能神器——<strong>虚拟列表 (Virtual List)</strong> 。</p>
<h2 data-id="heading-1">二、核心思想</h2>
<p>虚拟列表的核心实现思路其实很简单：</p>
<blockquote>
<p>固定外层盒子的高，通过计算只渲染出可见区域的数据，其余不可见元素用一个占位元素撑出滚动条。</p>
</blockquote>
<h4 data-id="heading-2">可视化理解</h4>
<p>假设列表共有 10000 条，每行高 40px：</p>

























<table><thead><tr><th>区域</th><th>说明</th></tr></thead><tbody><tr><td>可见区域</td><td>一次只显示约 10 行</td></tr><tr><td>缓冲区</td><td>上下各多渲染几行防止闪烁</td></tr><tr><td>占位容器</td><td>用总高度撑出滚动条</td></tr><tr><td>渲染窗口</td><td>动态平移（translateY）到对应位置</td></tr></tbody></table>
<p>这样：</p>
<ul>
<li>页面上<strong>实际只有几十个 DOM</strong>；</li>
<li>但滚动条看起来依然完整；</li>
<li>用户看起来就像全部都渲染出来一样。</li>
</ul>
<h2 data-id="heading-3">三、基础版虚拟列表示例</h2>
<p>我们先用最简单的方法来实现一个简易版的，以便我们更好的理解最底层的思想原理：</p>
<ul>
<li>支持滚动</li>
<li>支持滚动数据切片</li>
<li>支持缓冲区</li>
</ul>
<p><strong>JS部分实现思路：</strong></p>
<blockquote>
<p>用一个固定高度的容器制造滚动条，通过计算只渲染可视区域的数据，并用偏移量让这些数据看起来在正确的位置。</p>
</blockquote>
<h4 data-id="heading-4">1. 主要变量设置，本教程为简易版，默认所有数据项等高</h4>
<pre><code class="hljs language-js" lang="js">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">/**
 * 组件参数（Props）
 */</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">items</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>, <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [] }, <span class="hljs-comment">// 数据数组</span>
  <span class="hljs-attr">itemHeight</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">40</span> }, <span class="hljs-comment">// 单行高度</span>
  <span class="hljs-attr">height</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">300</span> },     <span class="hljs-comment">// 容器高度</span>
  <span class="hljs-attr">buffer</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">5</span> }        <span class="hljs-comment">// 上下缓冲行数</span>
})
<span class="hljs-comment">/**
 *  状态变量（会随滚动变化）
 */</span>
<span class="hljs-keyword">const</span> containerRef = ref&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;()   <span class="hljs-comment">// 滚动容器 DOM</span>
<span class="hljs-keyword">const</span> scrollTop = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)                     <span class="hljs-comment">// 当前滚动位置</span>
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-5">2.可视区域计算：包括高度计算和偏移量（offset）计算</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 总高度（撑出滚动条）：总数居条数*每一项高度</span>
<span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> * props.<span class="hljs-property">itemHeight</span>)

<span class="hljs-comment">// 当前一屏可显示多少行（加上缓冲）：可视区高度/每一项高度</span>
<span class="hljs-keyword">const</span> visibleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> base = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(props.<span class="hljs-property">height</span> / props.<span class="hljs-property">itemHeight</span>)
  <span class="hljs-keyword">return</span> base + props.<span class="hljs-property">buffer</span> * <span class="hljs-number">2</span>
})

<span class="hljs-comment">// 可见数据的起止索引：</span>
<span class="hljs-comment">// 1. 当前位置 ÷ 每一项高度 = 当前完全滚过多少项（向下取整得到最完整的已滚过项数）</span>
<span class="hljs-comment">// 2. 减去缓冲区：因为上方缓冲区的内容也需要提前渲染</span>
<span class="hljs-comment">// 3. 确保索引不小于0（边界保护）</span>
<span class="hljs-keyword">const</span> startIndex = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop.<span class="hljs-property">value</span> / props.<span class="hljs-property">itemHeight</span>) - props.<span class="hljs-property">buffer</span>
  <span class="hljs-keyword">return</span> start &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : start
})

<span class="hljs-comment">// 结束索引 = 开始索引 + 要渲染的总数量（可见区+上下缓冲区）</span>
<span class="hljs-comment">// 注意：这里应该加上边界检查，防止超过数组长度</span>
<span class="hljs-keyword">const</span> endIndex = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> end = startIndex.<span class="hljs-property">value</span> + visibleCount.<span class="hljs-property">value</span>
  <span class="hljs-keyword">return</span> end &gt; props.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> ? props.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> : end
})
<span class="hljs-comment">// 当前可见的数据切片</span>
<span class="hljs-keyword">const</span> visibleItems = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">items</span>.<span class="hljs-title function_">slice</span>(startIndex.<span class="hljs-property">value</span>, endIndex.<span class="hljs-property">value</span>))

<span class="hljs-comment">// 平移偏移量（用于 translateY）</span>
<span class="hljs-keyword">const</span> offsetTop = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> startIndex.<span class="hljs-property">value</span> * props.<span class="hljs-property">itemHeight</span>)
</code></pre>
<h4 data-id="heading-6">3.滚动事件监听</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onScroll</span> = (<span class="hljs-params"/>) =&gt; {
<span class="hljs-comment">//这里加一个判断防止DOM为渲染发生闪烁</span>
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>
  scrollTop.<span class="hljs-property">value</span> = containerRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>
}

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 初始化计算，避免第一次渲染闪烁</span>
  <span class="hljs-title function_">onScroll</span>()
})
</code></pre>
<p><strong>HTML部分实现思路及代码：</strong></p>
<blockquote>
<p>包括三层的盒子：</p>
<p><strong>第一层</strong>：最外层固定高度的盒子，负责滚动
<strong>第二层</strong>：撑开高度，让滚动条看起来像有全部数据
<strong>第三层</strong>：可视区域，只渲染看得见的几条数据，跟着滚动动态移动</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  &lt;!-- 外层容器：固定高度 + 滚动 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"containerRef"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"overflow-auto border rounded"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: `${props.height}px` }"</span>
    @<span class="hljs-attr">scroll</span>=<span class="hljs-string">"onScroll"</span>
  &gt;</span>
    <span class="hljs-comment">&lt;!-- 占位容器：撑起滚动条 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: `${totalHeight}px`, position: 'relative' }"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 渲染窗口：通过 translateY 偏移 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ transform: `translateY(${offsetTop}px)` }"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, idx) in visibleItems"</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"startIndex + idx"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"border-b px-3 flex items-center"</span>
          <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: `${props.itemHeight}px` }"</span>
        &gt;</span>
          {{ item }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p><strong>父组件使用实例：</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VirtualList</span> <span class="hljs-attr">:items</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">:itemHeight</span>=<span class="hljs-string">"35"</span> /&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VirtualList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VirtualList.vue'</span>

<span class="hljs-comment">// 模拟 1 万条数据</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`第 <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span> 条数据`</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<h2 data-id="heading-7">四、优化方案：让虚拟列表更丝滑</h2>
<p>上面的基础版我们已经实现了最底层必要的代码，但在真实项目中可能还有下列问题：</p>
<ul>
<li>滚动事件触发太频繁</li>
<li>容器尺寸改变没有自动适配</li>
<li>想要暴露API比如：“滚动到第N行”</li>
<li>item如果不是字符串而是对象，访问属性会类型报错</li>
</ul>
<p>接下来我们给这个简易版的虚拟列表加点<strong>小优化</strong></p>
<h4 data-id="heading-8">1.使用<code>requestAnimationFrame</code>节流滚动事件</h4>
<p><strong>原因</strong>：
滚动事件（scroll）触发频率极高（每秒上百次），频繁计算会导致页面卡顿。</p>
<p><strong>解决</strong>： 利用浏览器的“下一帧更新”机制</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> <span class="hljs-attr">rafId</span>: number | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onScroll</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> top = containerRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>

  <span class="hljs-comment">// 如果上一帧任务还没执行完，就取消它</span>
  <span class="hljs-keyword">if</span> (rafId !== <span class="hljs-literal">null</span>) <span class="hljs-title function_">cancelAnimationFrame</span>(rafId)

  <span class="hljs-comment">// 只保留最后一次</span>
  rafId = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
    scrollTop.<span class="hljs-property">value</span> = top
    rafId = <span class="hljs-literal">null</span>
  })
}
</code></pre>
<p><strong>原理</strong>：</p>
<ul>
<li><code>requestAnimationFrame</code>让代码在“下一次屏幕绘制”前执行；</li>
<li>每帧约16ms，即使滚动再快，最多60次/秒，性能稳定</li>
</ul>
<h4 data-id="heading-9">2.支持“滚动到指定行”</h4>
<p>想让列表自动滚动第200行怎么做？</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-params">index: number</span>) {
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>
  containerRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = index * props.<span class="hljs-property">itemHeight</span>
}
<span class="hljs-title function_">defineExpose</span>({ scrollToIndex })

</code></pre>
<p>父组件调用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;button @click="goTo200"&gt;滚动到第 200 行&lt;/button&gt;
&lt;VirtualList ref="listRef" :items="list" /&gt;
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> listRef = <span class="hljs-title function_">ref</span>()
<span class="hljs-keyword">const</span> <span class="hljs-title function_">goTo200</span> = (<span class="hljs-params"/>) =&gt; listRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-number">200</span>)
</code></pre>
<h4 data-id="heading-10">3.类型安全展示（防止TS报错）</h4>
<p>如果数据是对象，直接写<code>item.id</code>会报错（因为<code>item</code>是unknown）
<strong>解决</strong>：封装一个安全函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">displayText</span>(<span class="hljs-params">item: unknown</span>): string {
  <span class="hljs-keyword">if</span> (item &amp;&amp; <span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">const</span> r = item <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;string, unknown&gt;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(r.<span class="hljs-property">label</span> ?? r.<span class="hljs-property">id</span> ?? <span class="hljs-string">'[Object]'</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(item)
}
<span class="hljs-comment">//模板</span>
{{ <span class="hljs-title function_">displayText</span>(item) }}
</code></pre>
<h4 data-id="heading-11">4.自动适配容器高度变化</h4>
<p>容器可能因父元素布局变化而高度改变，使用<code>ResizeObserver</code>自动监听。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { onBeforeUnmount } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">let</span> <span class="hljs-attr">resizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> el = containerRef.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> (el) {
    resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 重新计算高度</span>
      containerHeight.<span class="hljs-property">value</span> = el.<span class="hljs-property">clientHeight</span>
    })
    resizeObserver.<span class="hljs-title function_">observe</span>(el)
  }
})
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> resizeObserver?.<span class="hljs-title function_">disconnect</span>())
</code></pre>
<h2 data-id="heading-12">五、最终结果</h2>
<p>现在实现的虚拟列表：</p>
<ul>
<li>流畅不卡顿；</li>
<li>类型安全；</li>
<li>可主动滚动；</li>
<li>自适应容器变化；</li>
<li>对象数据、字符串数据都能显示；</li>
<li>真正做到 <strong>性能与体验两不误</strong></li>
</ul>
<h2 data-id="heading-13">六、总结：</h2>
<h3 data-id="heading-14"/>

































<table><thead><tr><th>模块</th><th>作用</th></tr></thead><tbody><tr><td><code>totalHeight</code></td><td>撑出滚动条</td></tr><tr><td><code>visibleItems</code></td><td>控制渲染数量</td></tr><tr><td><code>offsetTop</code></td><td>平移到正确位置</td></tr><tr><td><code>requestAnimationFrame</code></td><td>优化高频滚动性能</td></tr><tr><td><code>scrollToIndex</code></td><td>提供外部控制</td></tr><tr><td><code>ResizeObserver</code></td><td>自适应容器尺寸</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[再见了，claude code]]></title>    <link>https://juejin.cn/post/7572749797468635145</link>    <guid>https://juejin.cn/post/7572749797468635145</guid>    <pubDate>2025-11-16T06:26:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572749797468635145" data-draft-id="7571636682694410280" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="再见了，claude code"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-16T06:26:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            再见了，claude code
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:26:44.000Z" title="Sun Nov 16 2025 06:26:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🤖 从前，有个程序员，和他那沉默寡言的终端……</h2>
<p>他的终端，只会三件事：</p>
<ul>
<li><code>command not found</code></li>
<li><code>segmentation fault (core dumped)</code></li>
<li><code>Killed</code></li>
</ul>
<p>直到某天，他 <code>curl -fsSL https://opencode.ai/install | bash</code> ——<br/>
<strong>终端突然开口了：</strong></p>
<blockquote>
<p>“您好，检测到您刚写了一个 <code>for (i = 0; i &lt; 10; i++) console.log(i++);</code>……<br/>
您……是想打印偶数，还是单纯想挑战冯·诺依曼的极限？”</p>
</blockquote>
<p>那一刻，他知道：<strong>时代变了</strong>。</p>
<hr/>
<h2 data-id="heading-1">✨ 什么是 OpenCode？—— 你的 <code>bash</code> 终于考上了 AI 研究生</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsst%2Fopencode" target="_blank" title="https://github.com/sst/opencode" ref="nofollow noopener noreferrer">OpenCode</a> 是一个<strong>开源、本地优先、终端原生</strong>的 AI 编码助手。<br/>
它不像 Copilot 那样躲在 VS Code 的角落里当「幽灵实习生」，<br/>
而是直接 <code>cd</code> 进你的工作流，坐你隔壁工位，自带咖啡杯（和纠错本能）。</p>
<h3 data-id="heading-2">🌟 它能干啥？看几个真实场景：</h3>

























<table><thead><tr><th>你敲的命令</th><th>OpenCode 的反应</th></tr></thead><tbody><tr><td><code>opencode fix error in main.go</code></td><td>扫描 <code>main.go</code> → 定位 nil 指针 → 提供带注释的补丁</td></tr><tr><td><code>opencode add login to Express app</code></td><td>自动生成 <code>authMiddleware.js</code> + JWT 秘钥管理建议</td></tr><tr><td><code>opencode explain this function</code></td><td>用「人话」解释你三个月前写的“神逻辑”</td></tr><tr><td><code>opencode review before commit</code></td><td>模拟 PR 评审员：“这段用 <code>map</code> 比 <code>for</code> 更函数式，且少 2 个 bug”</td></tr></tbody></table>
<blockquote>
<p>🎯 关键优势：<strong>不用切窗口</strong>。<br/>
你还在 <code>vim</code> 里挣扎 <code>:wq!</code>，它已经帮你生成了单元测试。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06a7ba660fbc4996bb7b2756bdb89690~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763879203&amp;x-signature=%2FpbGPJ%2B30neOQ%2BKfBF5GDOMJAf8%3D" alt="OpenCode 交互界面" loading="lazy"/></p>
<blockquote>
<p>👆 这不是科幻片——这是你明天早上的终端。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">🛠️ 三步安装：比配置 <code>.bashrc</code> 还简单</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1️⃣ 一键安装（连 `sudo` 都懒得要）</span>
curl -fsSL https://opencode.ai/install | bash

<span class="hljs-comment"># 2️⃣ 进项目目录</span>
<span class="hljs-built_in">cd</span> my-legacy-node-app-that-still-uses-callbacks

<span class="hljs-comment"># 3️⃣ 启动魔法</span>
opencode
</code></pre>
<p>首次运行时，敲 <code>/init</code>，它会默默读完整个项目（像极了你入职第一天翻三年前的代码），<br/>
然后生成一个 <code>agents.md</code> —— 相当于给 AI 助手发了本《本项目黑话手册》。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4ada58c94764f5a8e935b47e8542787~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763879203&amp;x-signature=E9P1Fx7Px8ZOAltheJCY2lyLZdQ%3D" alt="项目初始化后生成 agents.md" loading="lazy"/></p>
<blockquote>
<p>🔍 小幽默时间：<br/>
当你问它：<em>“这个 repo 是干啥的？”</em><br/>
它答：<em>“一个用 React + Express + SQLite 实现的 Todo 应用……作者似乎想证明自己还没忘掉 CRUD。”</em><br/>
—— 精准扎心，还带文献综述 😭</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">🧩 为什么 OpenCode 比 claude code 更靠谱？</h2>






























<table><thead><tr><th>对比维度</th><th>网页版 AI（如 ChatGPT）</th><th>OpenCode</th></tr></thead><tbody><tr><td>上下文</td><td>“上次你说过什么？” ❓</td><td>记得你<code>package.json</code>里用的是<code>express@4.18</code> ✅</td></tr><tr><td>文件感知</td><td>“请粘贴代码” 📋</td><td>自动扫描 <code>./src</code>、<code>git diff</code>、甚至 <code>node_modules/.bin</code> 🔍</td></tr><tr><td>隐私</td><td>代码上云？祈祷 GDPR 吧 ☁️</td><td>默认<strong>本地运行</strong>；连 Ollama 都能塞进去 🔒</td></tr><tr><td>编辑能力</td><td>“复制 → 粘贴 → 手动改缩进” ✂️</td><td><code>accept all</code> → <code>git add .</code> → <code>git commit -m "AI did it"</code> ✅</td></tr></tbody></table>
<blockquote>
<p>💡 它甚至会在修改前问你：<br/>
<em>“我准备把 <code>if (err) throw err</code> 改成 <code>try/catch</code> + 日志记录，接受？[Y/n]”</em><br/>
—— 比某些队友还懂<strong>代码礼仪</strong>。</p>
</blockquote>
<h3 data-id="heading-5">上下文的力量</h3>
<p>OpenCode​ 最大的优势之一在于它如何处理上下文。传统的聊天机器人在几轮对话后会忘记你正在做什么。而 OpenCode 不会。</p>
<p>OpenCode​ 记住你的代码库，理解导入，并跟踪相关文件。这使得它更像一个真正的开发者助手。
假设你告诉它：“为我的 Go 应用添加身份验证。”</p>
<p>OpenCode​ 会扫描你的项目，识别路由定义的位置，创建登录中间件，甚至建议安全存储令牌的位置。正是这种上下文感知与自然语言理解的结合，使得 OpenCode 感觉更像一个队友，而不是一个工具。</p>
<hr/>
<h2 data-id="heading-6">🧪 实测：让 OpenCode 救一个“濒临崩溃”的项目</h2>
<p>假设你接了个老项目：</p>
<ul>
<li>用 <code>callback hell</code> 写的 Node.js 服务</li>
<li>报错：<code>TypeError: Cannot read property 'user' of undefined</code></li>
<li>上一个开发者已离职，GitHub 头像还是默认的章鱼 🐙</li>
</ul>
<h3 data-id="heading-7">操作流程：</h3>
<pre><code class="hljs language-bash" lang="bash">$ opencode explain the error <span class="hljs-keyword">in</span> server.js:42
</code></pre>
<p>→ 它定位到：</p>
<pre><code class="hljs language-js" lang="js">db.<span class="hljs-title function_">query</span>(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, [req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>], <span class="hljs-function">(<span class="hljs-params">err, rows</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> user = rows[<span class="hljs-number">0</span>]; <span class="hljs-comment">// ← rows 为 [] 时 user = undefined！</span>
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span> }); <span class="hljs-comment">// 💥</span>
});
</code></pre>
<h3 data-id="heading-8">然后你输入：</h3>
<pre><code class="hljs language-bash" lang="bash">$ opencode refactor this to use async/await and add null check
</code></pre>
<p>它输出补丁（支持预览 + 一键应用）👇：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- db.query("SELECT * FROM users WHERE id = ?", [req.params.id], (err, rows) =&gt; {</span>
<span class="hljs-deletion">-   const user = rows[0];</span>
<span class="hljs-deletion">-   res.json({ name: user.name });</span>
<span class="hljs-deletion">- });</span>
<span class="hljs-addition">+ try {</span>
<span class="hljs-addition">+   const [rows] = await db.promise().query(</span>
<span class="hljs-addition">+     "SELECT * FROM users WHERE id = ?",</span>
<span class="hljs-addition">+     [req.params.id]</span>
<span class="hljs-addition">+   );</span>
<span class="hljs-addition">+   if (!rows.length) {</span>
<span class="hljs-addition">+     return res.status(404).json({ error: "User not found" });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   res.json({ name: rows[0].name });</span>
<span class="hljs-addition">+ } catch (err) {</span>
<span class="hljs-addition">+   console.error(err);</span>
<span class="hljs-addition">+   res.status(500).json({ error: "Internal server error" });</span>
<span class="hljs-addition">+ }</span>
</code></pre>
<blockquote>
<p>🎉 整个过程耗时：<strong>47 秒</strong><br/>
你喝了一口咖啡，项目起死回生。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🛡️ 隐私？我们连 <code>.env</code> 都不偷看</h2>
<p>OpenCode 的座右铭是：</p>
<blockquote>
<p><strong>“你的代码，你的规则——我只负责动嘴，不动手上传。”</strong></p>
</blockquote>
<ul>
<li>✅ 支持本地模型（Ollama / Llama.cpp / vLLM）</li>
<li>✅ 可指定 API 密钥仅用于推理，<strong>不传文件内容</strong>（通过上下文摘要）</li>
<li>✅ 所有修改走 <code>git diff</code> 预览，<strong>人类 veto 权神圣不可侵犯</strong></li>
</ul>
<blockquote>
<p>🙃 开发者真实反馈：<br/>
<em>“终于有个 AI 不会在我写密码时建议‘建议用 bcrypt 加密’……它直接跳过了那行。”</em></p>
</blockquote>
<hr/>
<h2 data-id="heading-10">🎯 结语</h2>
<p>OpenCode 的哲学很简单：</p>
<blockquote>
<p><strong>“让机器干它擅长的——记忆、搜索、试错；<br/>
让人类干我们擅长的——决策、设计、甩锅……啊不，是归因分析。”</strong></p>
</blockquote>
<p>随着 AI 编码代理的成熟，编写代码与描述你想要的内容之间的界限将继续模糊。像 OpenCode​ 这样的工具向我们展示了那个未来可能的样子，一个开发者花费更少时间与语法斗争，而更多时间构建想法的未来。
想象一下，有一天你通过输入：“为带有用户身份验证和 SQLite 支持的待办事项应用创建一个 REST API。”
几秒钟内，你的项目结构、数据库和路由就准备好了，并由你的 AI 助手审查、测试和记录。
这就是 OpenCode​ 正在迈向的愿景：不仅仅是生成代码的 AI 工具，而是理解上下文、处理复杂性，并让人类保持控制的工具</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ChatGPT中的群聊功能试点项目]]></title>    <link>https://juejin.cn/post/7572493520004481058</link>    <guid>https://juejin.cn/post/7572493520004481058</guid>    <pubDate>2025-11-16T06:56:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572493520004481058" data-draft-id="7572714389942911028" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ChatGPT中的群聊功能试点项目"/> <meta itemprop="keywords" content="ChatGPT"/> <meta itemprop="datePublished" content="2025-11-16T06:56:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ChatGPT中的群聊功能试点项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:56:48.000Z" title="Sun Nov 16 2025 06:56:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fgroup-chats-in-chatgpt%2F" target="_blank" title="https://openai.com/index/group-chats-in-chatgpt/" ref="nofollow noopener noreferrer">原文</a></p>
<blockquote>
<p>群聊开始在移动设备和网页上向日本、新西兰、韩国和台湾。——额。。这是要包围东大吗。。</p>
</blockquote>
<p><strong>发布日期：2025年11月13日</strong>
<strong>分类：产品</strong></p>
<h2 data-id="heading-0">试点ChatGPT群聊功能</h2>
<p>与他人以及ChatGPT在同一对话中协作。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fchatgpt.com%2F%3Fopenaicom-did%3Dd70b6f18-35f1-4245-bcc8-934682ad98b9%26openaicom_referred%3Dtrue" target="_blank" title="https://chatgpt.com/?openaicom-did=d70b6f18-35f1-4245-bcc8-934682ad98b9&amp;openaicom_referred=true" ref="nofollow noopener noreferrer">在ChatGPT中试用</a>（在新窗口中打开）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23be7d1d1b4e4babb6ef6ae0902939cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763881008&amp;x-signature=wbPFgaYMYnwuRKAesQ76VyYXAIA%3D" alt="图片描述：移动聊天屏幕显示群组对话。聊天顶部，圆形头像照片显示多位参与者。一条消息显示：&quot;是的意大利菜！Casa di Roma看起来很棒。谢谢ChatGPT。&quot;另一位参与者David回复：&quot;我要开始享用意大利面了……&quot;配有食物和笑脸表情符号。柔和的蓝色和紫色渐变背景。" loading="lazy"/></p>
<p>今天，我们开始在少数地区试点一种新体验，让人们能够轻松地彼此协作——以及与ChatGPT协作——在同一对话中。通过群聊，你可以将朋友、家人或同事带入共享空间，一起规划、做出决定或讨论想法。</p>
<p>无论你是在组织团体晚餐还是与同事起草大纲，ChatGPT都能提供帮助。群聊与你的私人对话是分开的，你的个人ChatGPT记忆永远不会与聊天中的任何人分享。</p>
<p>群聊开始在移动设备和网页上向日本、新西兰、韩国和台湾的ChatGPT Free、Go、Plus和Pro计划用户推出。这个试点是ChatGPT共享体验的小小第一步，我们期待从早期用户反馈中学习，以指导我们如何扩展到更多地区和ChatGPT计划。</p>
<h2 data-id="heading-1">与ChatGPT一起协作</h2>
<p>群聊让人们和ChatGPT能够进入同一对话。例如，如果你正在与朋友计划周末旅行，创建一个群聊，让ChatGPT帮助比较目的地、建立行程，并创建行李清单，让每个人都参与其中并跟进行程。</p>
<p>对于更实际的项目，如设计后院花园或为新公寓寻找艺术品，与你的伴侣或室友创建群聊，帮助协作设计想法、偏好和风格。这对于团体决策也很棒，比如找到适合每个人口味的餐厅，或者用公正的裁判解决友好的争论。</p>
<p>群聊也让工作或学校的协作变得更容易。你可以一起起草大纲或研究新话题。分享文章、笔记和问题，ChatGPT可以帮助总结和组织信息。</p>
<h2 data-id="heading-2">工作原理</h2>
<p>要开始群聊，请点击任何新聊天或现有聊天右上角的人员图标。当你将某人添加到现有聊天时，ChatGPT会创建你对话的副本作为新的群聊，这样你的原始对话就保持独立。你可以通过分享链接直接邀请1到20个人，群组中的任何人都可以分享该链接来邀请其他人。当你加入或创建你的第一个群聊时，系统会要求你设置一个包含姓名、用户名和照片的简短档案，这样每个人都知道谁在对话中。群聊可以在侧边栏一个新的清晰标记的部分中找到，方便访问。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2291d2c752cb4347988c22cd018fded7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763881008&amp;x-signature=lyCJz7BHigUgEIygWXVlOKqlEZg%3D" alt="图片描述：四个移动设备截图展示如何在ChatGPT中开始群聊" loading="lazy"/></p>
<p>群聊的工作方式与你平常的ChatGPT对话非常相似——只是现在其他人也可以加入。响应由GPT‑5.1 Auto驱动，它会根据提示以及用户基于其免费、Go、Plus或Pro计划可用的模型来选择最佳响应模型。搜索、图片和文件上传、图片生成和听写功能都已启用。速率限制仅在ChatGPT响应时适用——不适用于群聊中用户之间的消息——ChatGPT的响应计入被响应的人的可用限制。更多详细信息，你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.openai.com%2Fen%2Farticles%2F12703475-group-chats-in-chatgpt" target="_blank" title="https://help.openai.com/en/articles/12703475-group-chats-in-chatgpt" ref="nofollow noopener noreferrer">帮助中心</a>（在新窗口中打开）。</p>
<p>我们还为群聊教给ChatGPT新的社交行为。它跟随对话的流程，并根据群组对话的上下文决定何时响应和何时保持安静。当你希望ChatGPT响应时，总可以在消息中提及"ChatGPT"。我们还赋予了ChatGPT用表情符号响应消息的能力，以及引用头像的功能——这样，当被要求在该群组对话中创建有趣的个性化图像时，它可以使用群组成员的头像。</p>
<p>你也可以管理群组设置——点击参与者图标来命名群组、添加或删除人员，或静音通知。你可以为ChatGPT在每个群聊中的响应方式设置自定义指令，无论是分享更多上下文还是给予特定的语调或个性。</p>
<h2 data-id="heading-3">隐私和控制的按设计实现</h2>
<p>群聊与你的私人对话是分开的。你的个人ChatGPT记忆不会在群聊中使用，ChatGPT也不会从这些对话中创建新的记忆。我们正在探索未来提供更细粒度的控制，这样你就可以选择ChatGPT是否以及如何与群聊使用记忆。</p>
<p>你处于控制之中。你必须接受邀请才能加入群聊。每个人都可以看到谁在聊天中，或随时离开。群组成员可以删除其他参与者，但群组创建者除外，创建者只能通过自己离开来被删除。</p>
<p>为年轻用户提供额外的安全保障。如果18岁以下的人使用群聊，ChatGPT会自动减少聊天中每个人对敏感内容的暴露。父母或监护人可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.openai.com%2Fen%2Farticles%2F12315553-parental-controls-on-chatgpt-faq" target="_blank" title="https://help.openai.com/en/articles/12315553-parental-controls-on-chatgpt-faq" ref="nofollow noopener noreferrer">家长控制</a>（在新窗口中打开）完全关闭群聊功能。</p>
<h2 data-id="heading-4">接下来的发展</h2>
<p>群聊只是ChatGPT成为协作和与他人互动的共享空间的开始。随着ChatGPT成为群组对话中更好的伙伴，它将帮助你激发想法、做出决策，并与生活中最重要的人一起表达你的创造力。当我们试点这个体验时，我们将学习人们如何一起使用ChatGPT，并将根据早期反馈继续改进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃]]></title>    <link>https://juejin.cn/post/7572434032518807598</link>    <guid>https://juejin.cn/post/7572434032518807598</guid>    <pubDate>2025-11-15T03:44:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572434032518807598" data-draft-id="7572466174224465946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃"/> <meta itemprop="keywords" content="前端,Visual Studio Code,TypeScript"/> <meta itemprop="datePublished" content="2025-11-15T03:44:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="eason_fan"/> <meta itemprop="url" content="https://juejin.cn/user/2995517308808877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2995517308808877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    eason_fan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T03:44:33.000Z" title="Sat Nov 15 2025 03:44:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃</h2>
<h3 data-id="heading-1">前言</h3>
<p>在现代前端开发中，Monorepo已成为管理大型项目的流行方案。它通过将多个项目、库和组件集中在同一个代码仓库中，简化了依赖管理和代码复用。然而，随着项目规模的扩大，Monorepo也可能带来一些意想不到的性能问题。</p>
<p>本文将分享一个我在实际项目中遇到的性能噩梦，以及如何通过一行简单的VSCode配置解决这个问题的经历。</p>
<h3 data-id="heading-2">问题背景</h3>
<p>我所在的项目是一个大型的Monorepo，其中包含一个主项目A，以及从A中拆分出的子包B和十几个组件库C-G。项目的引用关系变得非常复杂，TypeScript配置为直接读取源码进行类型生成，而不是依赖打包后的<code>dist</code>文件。</p>
<p>拆包之后，VSCode的性能急剧下降，出现了以下问题：</p>
<ul>
<li><strong>路径跳转卡顿</strong>：每次安装依赖后，第一次跳转到定义需要等待长达一分钟的初始化时间</li>
<li><strong>类型推断崩溃</strong>：TypeScript类型提示经常失效，导致出现大量<code>unsafe type error</code></li>
<li><strong>编辑器假死</strong>：需要频繁重启VSCode才能恢复正常</li>
</ul>
<p>我尝试了各种方法，包括调整TypeScript配置、升级VSCode、禁用插件等，但都无济于事。</p>
<h3 data-id="heading-3">问题根源</h3>
<p>经过反复排查，我发现问题的根源在于VSCode的<strong>文件监听机制</strong>。</p>
<p>由于我们的TypeScript配置是直接读取源码，<code>dist</code>目录下的打包文件实际上对类型推断是无用的。然而，VSCode的文件监听器（File Watcher）默认会监控项目中的所有文件变化，包括<code>dist</code>目录。</p>
<p>当我们在Monorepo中进行构建或安装依赖时，大量的<code>dist</code>文件会被生成或修改，导致VSCode的文件监听器不堪重负，占用了大量系统资源，从而引发了上述性能问题。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>最终，我通过在项目的<code>.vscode/settings.json</code>文件中添加一行简单的配置，彻底解决了这个问题：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"files.watcherExclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"**/dist/**"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这行配置的作用是告诉VSCode的文件监听器<strong>忽略所有<code>dist</code>目录下的文件变化</strong>。</p>
<h4 data-id="heading-5">为什么这个配置有效？</h4>
<ol>
<li><strong>减少不必要的监听</strong>：排除了对<code>dist</code>目录的监听，大大减少了VSCode需要处理的文件变化事件</li>
<li><strong>释放系统资源</strong>：降低了CPU和内存占用，使VSCode能够更流畅地运行</li>
<li><strong>专注源码</strong>：让VSCode专注于监听源码文件，确保类型推断和路径跳转的性能</li>
</ol>
<h3 data-id="heading-6">总结</h3>
<p>如果你也在使用Monorepo，并且遇到了类似的性能问题，不妨检查一下你的VSCode配置。通过<code>files.watcherExclude</code>配置，排除掉不需要监听的目录，可能会给你带来意想不到的惊喜。</p>
<p>这个经历告诉我们，有时候解决复杂问题的答案可能就隐藏在最简单的配置中。希望这篇文章能帮助你摆脱Monorepo性能噩梦，享受更流畅的开发体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性]]></title>    <link>https://juejin.cn/post/7572524368879452194</link>    <guid>https://juejin.cn/post/7572524368879452194</guid>    <pubDate>2025-11-16T04:16:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572524368879452194" data-draft-id="7572537221540790287" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-16T04:16:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T04:16:24.000Z" title="Sun Nov 16 2025 04:16:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Vue.js 作为当今最流行的前端框架之一，一直在不断演进和完善。2023年底，Vue团队正式发布了Vue 3.4版本（代号"🏀 Slam Dunk"），这次更新带来了多项性能优化和Composition API的增强功能。本文将深入剖析5个最重要的性能改进和3个Composition API新特性，帮助开发者充分利用这些改进来构建更高效的Vue应用。</p>
<h2 data-id="heading-2">一、核心性能优化解析</h2>
<h3 data-id="heading-3">1. 模板编译器性能提升40%</h3>
<p>Vue 3.4对模板编译器进行了全面重写，特别是在大型模板的处理上表现尤为突出：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 旧版编译器处理复杂v-for的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processFor</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 较慢的递归处理</span>
}

<span class="hljs-comment">// 新版采用线性处理方式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">optimizeFor</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基于静态分析的优化路径</span>
}
</code></pre>
<p>关键技术点：</p>
<ul>
<li>AST（抽象语法树）生成速度提升30%</li>
<li>SSR编译时内存占用减少50%</li>
<li>v-if/v-for嵌套处理采用新的启发式算法</li>
</ul>
<p>实测数据表明，在一个包含1000+节点的复杂表单场景下，编译时间从120ms降至72ms。</p>
<h3 data-id="heading-4">2. Reactivity系统微优化</h3>
<p>响应式系统的底层实现有这些改进：</p>
<ul>
<li>Proxy handler调用减少15%</li>
<li>track/tigger操作使用更轻量的数据结构</li>
<li>effect调度器引入优先级队列</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 新版响应式跟踪示例</span>
<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
    <span class="hljs-title function_">track</span>(target, key) <span class="hljs-comment">// 更快的路径查找</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(...<span class="hljs-variable language_">arguments</span>)
  }
})
</code></pre>
<h3 data-id="heading-5">3. Patch Flag优化策略调整</h3>
<p>虚拟DOM的diffing算法更新：</p>
<ul>
<li>dynamicChildren处理逻辑重构</li>
<li>Block Tree遍历顺序优化</li>
<li>Fragment节点特殊处理</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx">&lt;div&gt;
  &lt;!-- <span class="hljs-keyword">static</span> node --&gt;
  
&lt;/div&gt;
</code></pre>
<h2 data-id="heading-6">Composition API革命性改进</h2>
<h3 data-id="heading-7">setup语法糖的重大升级</h3>
<pre><code class="hljs language-typescript" lang="typescript"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PandaCoder：我的个人开发者工具进化之路]]></title>    <link>https://juejin.cn/post/7572525491538624554</link>    <guid>https://juejin.cn/post/7572525491538624554</guid>    <pubDate>2025-11-16T04:31:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572525491538624554" data-draft-id="7572524368879484962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" PandaCoder：我的个人开发者工具进化之路"/> <meta itemprop="keywords" content="后端,IntelliJ IDEA,程序员"/> <meta itemprop="datePublished" content="2025-11-16T04:31:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="舒一笑不秃头"/> <meta itemprop="url" content="https://juejin.cn/user/4257747754552599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             PandaCoder：我的个人开发者工具进化之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4257747754552599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    舒一笑不秃头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T04:31:15.000Z" title="Sun Nov 16 2025 04:31:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：从个人项目到开发者工具的转变</h2>
<p>在技术领域，我常常思考一个问题：什么样的工具才能真正帮助开发者？我意识到真正的价值不在于功能的数量，而在于这些功能是否真正解决了用户的痛点。作为PandaCoder的独立开发者，我的核心理念正是建立在这一认知之上——<strong>与其堆砌功能，不如倾听用户的声音</strong>。</p>
<h3 data-id="heading-1">工具的本质</h3>
<p>正如纳瓦尔所言："工具应该为你工作，而不是你为工具工作。"我设计PandaCoder的初衷是创建一个能够真正理解开发者需求的智能助手，而不是又一个需要复杂配置的负担。</p>
<h2 data-id="heading-2">用户反馈：产品进化的核心驱动力</h2>
<h3 data-id="heading-3">为什么建议比打赏更重要？</h3>
<p>在PandaCoder的设计中，我刻意将"✍️ 插件的建议"功能置于"☕️ 请作者喝杯"之前。这不是偶然，而是基于一个深刻的洞察：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d818826f430d44e9b279fc77876412b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=eQdpb9YiOrepJUOiwEYdggGtOWM%3D" alt="" loading="lazy"/></p>
<p><strong>用户的建议是产品进化的燃料，而打赏只是这个过程的副产品。</strong></p>
<p>当开发者愿意花时间提供反馈时，实际上是在投资这个工具的未来。这种投资远比金钱更有价值，因为它包含了真实的用户体验和需求洞察。</p>
<h3 data-id="heading-4">反馈系统的设计哲学</h3>
<p>我设计的反馈系统采用了精心设计的交互体验：</p>
<ul>
<li><strong>智能限流机制</strong>：每日6次反馈限制，确保每一条建议都是经过深思熟虑的</li>
<li><strong>分类反馈</strong>：功能建议、Bug反馈、使用体验、其他，让反馈更有针对性</li>
<li><strong>即时确认</strong>：用户提交后立即收到确认，建立反馈闭环</li>
</ul>
<p>这种设计体现了史蒂文·巴特利特强调的"用户体验即品牌"理念。</p>
<h2 data-id="heading-5">功能演进：从用户需求出发</h2>
<h3 data-id="heading-6">中文编程助手的诞生</h3>
<p>最初的PandaCoder只是一个简单的翻译工具。但通过用户反馈，我发现中国开发者真正需要的是<strong>从中文思维到英文代码的顺畅转换</strong>，而不仅仅是文字翻译。</p>
<p>用户建议促使我开发了：</p>
<ul>
<li>智能命名转换（小驼峰、大驼峰、大写带下划线）</li>
<li>中文类名自动生成</li>
<li>多级翻译引擎（国内大模型 &gt; Google翻译 &gt; 百度翻译）</li>
</ul>
<h3 data-id="heading-7">Jenkins Pipeline支持的进化</h3>
<p>最初只是语法高亮，但用户反馈揭示了更深层次的需求：开发者在编写Pipeline时需要<strong>智能补全、环境变量管理、文档支持</strong>。</p>
<p>这些功能不是凭空想象的，而是来自真实用户的痛点反馈。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1015672231340d7865487387b6ad129~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=mIJvodtmHcmN%2BFgM0Id6U7REenc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">SpringBoot配置的可视化</h3>
<p>通过用户建议，我实现了技术栈的智能识别和可视化显示。现在开发者打开配置文件时，能够直观看到使用的技术组件，大大提升了开发效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/312d7b796b3046a6b7196b0180b0bdc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=%2BjLXoq98pShrk%2FynCPl8lvRWMvU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">数据驱动的产品迭代</h2>
<h3 data-id="heading-10">Git统计分析功能</h3>
<p>用户反馈显示，团队需要更好的代码协作洞察。我开发了：</p>
<ul>
<li>多维度代码统计</li>
<li>可视化图表展示</li>
<li>自动邮件报告系统</li>
</ul>
<p>这些功能帮助团队管理者了解开发进度，识别瓶颈，优化协作流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/006903a9482d42019a279913d08d8c21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=ZbMqjMjCesArBX6Eq1lz%2B%2Bmcf0c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">实时监控体系的建立</h3>
<p>基于用户对调试效率的需求，我构建了完整的监控体系：</p>
<ul>
<li>Elasticsearch DSL监控</li>
<li>SQL执行监控</li>
<li>API调用链追踪</li>
</ul>
<p>这些功能让开发者能够实时了解应用运行状态，快速定位问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6090af814703472184ad9e6cf228f43f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=FbR8BAQcpHP7QV8qg0dwNhiffj0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">社区驱动的技术决策</h2>
<h3 data-id="heading-13">翻译引擎的选择</h3>
<p>最初我只支持百度翻译，但用户反馈显示：</p>
<ul>
<li>国内大模型在某些场景下翻译质量更高</li>
<li>Google翻译在国际化项目中有独特优势</li>
<li>需要多引擎备用确保服务稳定性</li>
</ul>
<p>这些反馈促使我建立了三级翻译引擎系统。</p>
<h3 data-id="heading-14">AI助手功能的扩展</h3>
<p>用户建议让我意识到：开发者需要的不只是翻译，还有<strong>代码审查、技术咨询、学习辅导</strong>等AI能力。</p>
<p>这促使我集成了多种AI模型，包括OpenAI、Ollama本地部署、国内大模型等。</p>
<h2 data-id="heading-15">技术实现背后的思考</h2>
<h3 data-id="heading-16">性能与用户体验的平衡</h3>
<p>在实现功能时，我始终遵循纳瓦尔的建议："在技术决策中，简单性往往比复杂性更有价值。"</p>
<p>例如：</p>
<ul>
<li>使用ConcurrentHashMap确保线程安全</li>
<li>实现延迟加载优化性能</li>
<li>合理的缓存策略提升响应速度</li>
</ul>
<h3 data-id="heading-17">可扩展性设计</h3>
<p>我采用模块化设计，确保新功能能够无缝集成。这种设计理念来源于用户对未来扩展性的需求预期。</p>
<h2 data-id="heading-18">用户参与的价值创造</h2>
<h3 data-id="heading-19">从使用者到共建者</h3>
<p>PandaCoder的成功案例证明：<strong>当用户参与产品设计时，他们从被动的使用者转变为积极的共建者。</strong></p>
<p>这种转变带来的价值是双向的：</p>
<ul>
<li>用户获得更符合需求的工具</li>
<li>我获得真实的用户洞察</li>
<li>整个生态实现良性循环</li>
</ul>
<h3 data-id="heading-20">反馈的乘数效应</h3>
<p>一个用户的建议可能影响数千名其他用户的使用体验。这种乘数效应是开源社区最强大的力量之一。</p>
<h2 data-id="heading-21">未来展望：基于用户需求的持续进化</h2>
<h3 data-id="heading-22">短期规划</h3>
<p>基于当前用户反馈，我计划：</p>
<ul>
<li>增强AI助手功能（代码生成、重构建议）</li>
<li>优化Git统计图表样式</li>
<li>改进邮件模板自定义功能</li>
</ul>
<h3 data-id="heading-23">中长期愿景</h3>
<p>用户建议指引我向更智能化的方向发展：</p>
<ul>
<li>代码智能分析与建议系统</li>
<li>项目健康度评估报告</li>
<li>团队协作效率分析工具</li>
</ul>
<h2 data-id="heading-24">结语：共建更好的开发者工具</h2>
<p>PandaCoder的成长历程印证了一个重要观点：<strong>最好的产品功能来源于真实用户的需求。</strong></p>
<p>我相信，技术工具的价值不在于它拥有多少功能，而在于它是否真正解决了开发者的问题。而了解这些问题的唯一途径，就是倾听用户的声音。</p>
<p>正如史蒂文·巴特利特所说："成功的企业不是那些拥有最好产品的企业，而是那些最了解客户需求的企业。"</p>
<p>我邀请每一位开发者参与PandaCoder的进化之旅。您的每一个建议都可能成为下一个重要功能的灵感来源。</p>
<hr/>
<p><strong>参与方式：</strong></p>
<ul>
<li>在IDE中点击"✍️ 插件的建议"提交反馈</li>
<li>通过GitHub Issues参与讨论</li>
</ul>
<hr/>
<p><em>舒一笑不秃头，生成式AI应用工程师(高级)认证，阿里云博客专家，专注于企业级Java开发和AI应用开发。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArrayUtils：Java数组操作的瑞士军刀]]></title>    <link>https://juejin.cn/post/7572534419880034339</link>    <guid>https://juejin.cn/post/7572534419880034339</guid>    <pubDate>2025-11-16T03:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572534419880034339" data-draft-id="7572534419880017955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArrayUtils：Java数组操作的瑞士军刀"/> <meta itemprop="keywords" content="后端,设计,开源"/> <meta itemprop="datePublished" content="2025-11-16T03:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白衣鸽子"/> <meta itemprop="url" content="https://juejin.cn/user/3072451409619223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArrayUtils：Java数组操作的瑞士军刀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3072451409619223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白衣鸽子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T03:13:02.000Z" title="Sun Nov 16 2025 03:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 前言</h3>
<blockquote>
<p>本文介绍的 ArrayUtils 以org.apache.commons.collections4.ArrayUtils 为例</p>
<p>源代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fcommons-collections%2Fblob%2Fmaster%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fcommons%2Fcollections4%2FArrayUtils.java" target="_blank" title="https://github.com/apache/commons-collections/blob/master/src/main/java/org/apache/commons/collections4/ArrayUtils.java" ref="nofollow noopener noreferrer">org.apache.commons.collections4.ArrayUtils</a></p>
<p>自定义特征可以在自己服务内实现</p>
</blockquote>
<p>在Java应用开发中，数组操作是我们日常编码的基础任务之一。你是否曾写过下面这样的代码？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">findUser</span><span class="hljs-params">(String[] users, String targetUser)</span> {
    <span class="hljs-keyword">if</span> (users == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; users.length; i++) {
        <span class="hljs-keyword">if</span> (targetUser == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (users[i] == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (targetUser.equals(users[i])) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findUserIndex</span><span class="hljs-params">(String[] users, String targetUser)</span> {
    <span class="hljs-keyword">if</span> (users == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; users.length; i++) {
        <span class="hljs-comment">// ... 类似的重复代码</span>
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<p>这种手动遍历数组的方式不仅繁琐、重复，更重要的是需要处理各种边界情况（如空数组、null元素、起始位置等），容易出错且代码可读性差。一个精心设计的工具类可以封装这些通用逻辑，让数组操作变得简单而安全。本文将深入解析ArrayUtils工具类的实现原理，展示如何通过简洁的API解决数组操作的常见痛点。</p>
<h3 data-id="heading-1">2. 常用方法</h3>
<h4 data-id="heading-2">2.1 包含检查方法</h4>
<h5 data-id="heading-3">2.1.1 方法签名</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Object[] array, Object objectToFind)</span>
</code></pre>
<h5 data-id="heading-4">2.1.2 应用示范</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayUtilsDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        String[] fruits = {<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"orange"</span>, <span class="hljs-literal">null</span>};
        
        <span class="hljs-comment">// 检查元素是否存在</span>
        System.out.println(ArrayUtils.contains(fruits, <span class="hljs-string">"apple"</span>)); <span class="hljs-comment">// true</span>
        System.out.println(ArrayUtils.contains(fruits, <span class="hljs-string">"grape"</span>)); <span class="hljs-comment">// false</span>
        System.out.println(ArrayUtils.contains(fruits, <span class="hljs-literal">null</span>));    <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 处理空数组场景</span>
        String[] emptyArray = <span class="hljs-literal">null</span>;
        System.out.println(ArrayUtils.contains(emptyArray, <span class="hljs-string">"test"</span>)); <span class="hljs-comment">// false</span>
    }
}
</code></pre>
<h5 data-id="heading-5">2.1.3 关键源码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Object[] array, Object objectToFind)</span> {
    <span class="hljs-keyword">return</span> indexOf(array, objectToFind) != -<span class="hljs-number">1</span>;
}
</code></pre>
<h4 data-id="heading-6">2.2 索引查找方法</h4>
<h5 data-id="heading-7">2.2.1 方法签名</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(T[] array, Object objectToFind)</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Object[] array, Object objectToFind, <span class="hljs-type">int</span> startIndex)</span>
</code></pre>
<h5 data-id="heading-8">2.2.2 应用示范</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexOfDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Integer[] numbers = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>};
        
        <span class="hljs-comment">// 查找元素首次出现位置</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">2</span>));     <span class="hljs-comment">// 1</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">10</span>));    <span class="hljs-comment">// -1</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-literal">null</span>));  <span class="hljs-comment">// 5</span>
        
        <span class="hljs-comment">// 从指定位置开始查找</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>));  <span class="hljs-comment">// 3</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>));  <span class="hljs-comment">// 6</span>
        
        <span class="hljs-comment">// 处理边界情况</span>
        System.out.println(ArrayUtils.indexOf(<span class="hljs-literal">null</span>, <span class="hljs-number">1</span>));        <span class="hljs-comment">// -1</span>
    }
}
</code></pre>
<h5 data-id="heading-9">2.2.3 关键源码</h5>
<blockquote>
<p>本质比较的是equals方法，如有需要可以重写equals方法</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Object[] array, Object objectToFind, <span class="hljs-type">int</span> startIndex)</span> {
    <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (startIndex &lt; <span class="hljs-number">0</span>) {
            startIndex = <span class="hljs-number">0</span>;
        }

        <span class="hljs-keyword">if</span> (objectToFind == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> startIndex; i &lt; array.length; ++i) {
                <span class="hljs-keyword">if</span> (array[i] == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> i;
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> startIndex; i &lt; array.length; ++i) {
                <span class="hljs-keyword">if</span> (objectToFind.equals(array[i])) {
                    <span class="hljs-keyword">return</span> i;
                }
            }
        }

        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
}
</code></pre>
<h2 data-id="heading-10">3. 与Stream API的对比</h2>
<h3 data-id="heading-11">3.1 相同功能的不同实现</h3>
<p><strong>ArrayUtils方式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查包含</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">contains</span> <span class="hljs-operator">=</span> ArrayUtils.contains(array, target);

<span class="hljs-comment">// 查找索引</span>
<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> ArrayUtils.indexOf(array, target);
</code></pre>
<p><strong>Stream API方式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查包含</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">contains</span> <span class="hljs-operator">=</span> Arrays.stream(array)
                        .anyMatch(element -&gt; Objects.equals(element, target));

<span class="hljs-comment">// 查找索引（较为繁琐）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> IntStream.range(<span class="hljs-number">0</span>, array.length)
                    .filter(i -&gt; Objects.equals(array[i], target))
                    .findFirst()
                    .orElse(-<span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-12">3.2 性能对比</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceComparison</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        String[] largeArray = createLargeArray(<span class="hljs-number">100000</span>);
        
        <span class="hljs-comment">// ArrayUtils性能测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> System.nanoTime();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> ArrayUtils.contains(largeArray, <span class="hljs-string">"target"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">time1</span> <span class="hljs-operator">=</span> System.nanoTime() - start1;
        
        <span class="hljs-comment">// Stream API性能测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start2</span> <span class="hljs-operator">=</span> System.nanoTime();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> Arrays.stream(largeArray)
                               .anyMatch(<span class="hljs-string">"target"</span>::equals);
        <span class="hljs-type">long</span> <span class="hljs-variable">time2</span> <span class="hljs-operator">=</span> System.nanoTime() - start2;
        
        System.out.println(<span class="hljs-string">"ArrayUtils耗时: "</span> + time1 + <span class="hljs-string">"ns"</span>);
        System.out.println(<span class="hljs-string">"Stream API耗时: "</span> + time2 + <span class="hljs-string">"ns"</span>);
    }
}
</code></pre>
<h3 data-id="heading-13">3.3 适用场景分析</h3>








































<table><thead><tr><th>特性</th><th>ArrayUtils</th><th>Stream API</th></tr></thead><tbody><tr><td><strong>代码简洁性</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr><tr><td><strong>性能</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr><tr><td><strong>可读性</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>函数式支持</strong></td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>链式操作</strong></td><td>不支持</td><td>支持</td></tr><tr><td><strong>空安全</strong></td><td>⭐⭐⭐⭐⭐</td><td>需要额外处理</td></tr></tbody></table>
<h2 data-id="heading-14">4. 总结</h2>
<p>ArrayUtils通过简洁的API设计，为我们提供了强大的数组操作能力。它的主要优势包括：</p>
<ol>
<li><strong>代码简洁性</strong>：将常见的数组操作封装成简单的方法调用</li>
<li><strong>空安全</strong>：妥善处理null值场景，提高代码健壮性</li>
<li><strong>灵活性</strong>：支持从指定位置开始搜索，满足不同业务需求</li>
<li><strong>类型安全</strong>：使用泛型确保类型一致性</li>
</ol>
<p>虽然这个工具类功能相对基础，但它体现了良好的设计思想：专注于解决特定问题，保持接口简单，处理边界情况。在实际开发中，我们可以借鉴这种设计思路，创建更多实用的工具类来提升开发效率。</p>
<p><strong>建议使用场景</strong>：适合中小型数组的快速操作，对于性能要求极高的场景建议考虑其他优化方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux上gitlab runner部署文档]]></title>    <link>https://juejin.cn/post/7572776177690427401</link>    <guid>https://juejin.cn/post/7572776177690427401</guid>    <pubDate>2025-11-16T04:23:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572776177690427401" data-draft-id="7572776177690411017" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux上gitlab runner部署文档"/> <meta itemprop="keywords" content="Java,GitHub"/> <meta itemprop="datePublished" content="2025-11-16T04:23:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾迪王"/> <meta itemprop="url" content="https://juejin.cn/user/2744837165290328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux上gitlab runner部署文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2744837165290328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾迪王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T04:23:06.000Z" title="Sun Nov 16 2025 04:23:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年11月16日</p>
<h2 data-id="heading-0">背景</h2>
<p>平常使用的CI/CD主要是用Jenkins，git的本地hook，但是对于代码上传后执行差异代码优化这个技术场景流程场景来说：</p>
<ol>
<li>Jenkins流程只会做到全量排查，如果中途遇到问题代码导致失败，得不偿失，且一个仓库可能会有不再维护代码与无关代码，造成资源浪费</li>
<li>git本地hook问题在于，更新时每个组员都需要做，并且git commit的时候可以通过--no-verify 规避本地check，同时如果直接在gitlab上面IDE直接修改，则本地git hook脚本不会执行</li>
</ol>
<p>因此为了优化这一块的流水线，避免上述2个问题，我打算通过git合入时通过git 的CI/CD，执行脚本分析差异化文件</p>
<p>（本文因为离职后所有消息记录会被删除，因此图片是没有的，请见谅）</p>
<h2 data-id="heading-1">部署与验证</h2>
<p>gitlab自带部署runner文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gitlab.cn%2Fdocs%2Fjh%2Finstall%2F" target="_blank" title="https://docs.gitlab.cn/docs/jh/install/" ref="nofollow noopener noreferrer">docs.gitlab.cn/docs/jh/ins…</a> ，同时csdn也有对应的文档可以借鉴 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_39826207%2Farticle%2Fdetails%2F144275485" target="_blank" title="https://blog.csdn.net/qq_39826207/article/details/144275485" ref="nofollow noopener noreferrer">blog.csdn.net/qq_39826207…</a> 不过实际上我在开发时也遇到了一点问题，所以也可以通过以下方式部署：</p>
<ol>
<li>
<p>准备Linux环境（Centos为例）</p>
</li>
<li>
<p>通过wget或者离线等方式获取gitlab runner的安装包</p>
</li>
<li>
<pre><code class="hljs language-sh" lang="sh"> <span class="hljs-comment"># 创建专用用户（不创建 home 目录）</span>
 sudo useradd --comment <span class="hljs-string">'GitLab Runner'</span> --create-home gitlab-runner
 ​
 <span class="hljs-comment"># 创建 runner 工作目录</span>
 sudo <span class="hljs-built_in">mkdir</span> /home/gitlab-runner/runner
 ​
 sudo <span class="hljs-built_in">chown</span> gitlab-runner:gitlab-runner /home/gitlab-runner/runner
</code></pre>
</li>
<li>
<p>初始化并启动 GitLab Runner（作为服务）</p>
<p>虽然使用二进制，但建议以系统服务方式运行。</p>
<ol>
<li>
<p>创建 systemd 服务文件</p>
<pre><code class="hljs language-sh" lang="sh"> sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/gitlab-runner.service &lt;&lt;<span class="hljs-string">EOF
 [Unit]
 Description=GitLab Runner
 After=syslog.target network.target
 ConditionFileIsExecutable=/usr/local/bin/gitlab-runner
 ​
 [Service]
 StartLimitInterval=5
 StartLimitBurst=10
 ExecStart=/usr/local/bin/gitlab-runner run --working-directory /home/gitlab-runner/runner
 SuccessExitStatus=0 143
 Restart=always
 RestartSec=5
 KillMode=mixed
 WorkingDirectory=/home/gitlab-runner/runner
 User=gitlab-runner
 Group=gitlab-runner
 Environment=PATH=/bin:/usr/local/bin:/usr/bin
 CacheDirectory=gitlab-runner
 CacheDirectoryMode=0750
 ​
 [Install]
 WantedBy=multi-user.target
 EOF</span>
</code></pre>
</li>
<li>
<p>重载 systemd 并启动服务</p>
<pre><code class="hljs language-bash" lang="bash"> sudo systemctl daemon-reexec
 sudo systemctl daemon-reload
 sudo systemctl <span class="hljs-built_in">enable</span> gitlab-runner
 sudo systemctl start gitlab-runner
</code></pre>
</li>
<li>
<p>检查服务状态</p>
<pre><code class="hljs language-sh" lang="sh"> sudo systemctl status gitlab-runner
</code></pre>
</li>
</ol>
</li>
<li>
<p>注册GitLab Runner 到 GitLab 实例</p>
<p>（如果是多次注册，则需要优先按照第一步切换成对应的gitlab用户进行命令操作，整个的安装流程，我按照官方流程没成功，和当前流程唯一的差别就是官方没有切换到gitlab用户）</p>
<ol>
<li>
<p>获取注册令牌 登录 GitLab Web 界面。 进入你的项目 → Settings → CI / CD → Runners。 复制 Registration token（项目级 Runner）。 或者在 Admin Area → Overview → Runners 获取实例级令牌。</p>
</li>
<li>
<p>运行注册命令： 切换到 gitlab-runner 用户并注册：</p>
<pre><code class="hljs language-sh" lang="sh"> sudo -u gitlab-runner -H /usr/local/bin/gitlab-runner register
</code></pre>
<p>按提示输入：</p>
<ul>
<li>GitLab instance URL: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitlab.com%2F" target="_blank" title="https://gitlab.com/" ref="nofollow noopener noreferrer">gitlab.com</a>（或你的自建 GitLab 地址）</li>
<li>Registration token: 你复制的令牌</li>
<li>Description: my-runner（自定义描述）</li>
<li>Tags: linux,docker（可选，用于任务匹配）</li>
<li>Executor: shell（或 docker, docker+machine 等）</li>
<li>Default Docker image: alpine:latest（如果使用 docker executor）</li>
</ul>
</li>
<li>
<p>按提示输入：</p>
<ul>
<li>GitLab instance URL: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitlab.com%2F" target="_blank" title="https://gitlab.com/" ref="nofollow noopener noreferrer">gitlab.com</a>（或你的自建 GitLab 地址）</li>
<li>Registration token: 你复制的令牌</li>
<li>Description: my-runner（自定义描述）</li>
<li>Tags: linux,docker（可选，用于任务匹配）、</li>
<li>Executor: shell（或 docker, docker+machine 等）</li>
<li>Default Docker image: alpine:latest（如果使用 docker executor）</li>
<li>注册成功后，配置会保存在 /home/gitlab-runner/runner/config.toml。</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>验证注册： 在 GitLab Web 界面的 Runners 页面，应看到新注册的 Runner 处于“在线”状态。</p>
<h2 data-id="heading-2">卸载</h2>
<p>有时候可能是安装错误，可能是需要迁移业务，需要现在原有的环境的服务，可以按照以下步骤</p>
<ol>
<li>
<p>停止并禁用服务</p>
<pre><code class="hljs language-sh" lang="sh"> sudo systemctl stop gitlab-runner
 sudo systemctl <span class="hljs-built_in">disable</span> gitlab-runner
</code></pre>
</li>
<li>
<p>删除服务文件</p>
<pre><code class="hljs language-sh" lang="sh"> sudo <span class="hljs-built_in">rm</span> /etc/systemd/system/gitlab-runner.service
 sudo systemctl daemon-reload
</code></pre>
</li>
<li>
<p>删除二进制文件和用户</p>
<pre><code class="hljs language-sh" lang="sh"> sudo <span class="hljs-built_in">rm</span> /usr/local/bin/gitlab-runner
 <span class="hljs-comment"># -r 删除用户主目录</span>
 sudo userdel -r gitlab-runner  
</code></pre>
</li>
<li>
<p>清理残留文件（可选）</p>
<pre><code class="hljs language-sh" lang="sh">sudo <span class="hljs-built_in">rm</span> -rf /home/gitlab-runner
</code></pre>
</li>
</ol>
<h2 data-id="heading-3">脚本分享</h2>
<h3 data-id="heading-4">.gitlab-ci.yml</h3>
<p>这个是仓库全局的git CI/CD的配置文件，根据触发阶段可以执行对应的script相关的脚本，在该脚本可以执行更多shell脚本，方便管理</p>
<p>该例子是合入时执行2个脚本，可供参考</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">check</span>

<span class="hljs-comment"># 全局变量</span>
<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">GIT_DEPTH:</span> <span class="hljs-string">""</span>  <span class="hljs-comment"># 完整克隆</span>

<span class="hljs-comment"># 只在 Merge Request 时触发流水线（即“合入前检查”）</span>
<span class="hljs-attr">workflow:</span>
  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">if:</span> <span class="hljs-string">$CI_PIPELINE_SOURCE</span> <span class="hljs-string">==</span> <span class="hljs-string">"merge_request_event"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">when:</span> <span class="hljs-string">never</span>

<span class="hljs-attr">check:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">check</span>
  <span class="hljs-attr">interruptible:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 可中断：当 MR 更新时取消旧流水线</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-comment"># 脚本1：权限/配置检查</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">./cloud/env/install/script/config_checkstyle.sh</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./cloud/env/install/script/config_checkstyle.sh</span> <span class="hljs-string">ucs-server</span> <span class="hljs-string">$GITLAB_USER_EMAIL</span> <span class="hljs-string">$CI_MERGE_REQUEST_TARGET_BRANCH_NAME</span>

    <span class="hljs-comment"># 脚本2：另一个检查脚本（示例）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">./cloud/env/install/script/another_check.sh</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./cloud/env/install/script/another_check.sh</span>

  <span class="hljs-comment"># 只在 MR 中运行</span>
  <span class="hljs-attr">only:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">merge_requests</span>

  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ucs_server</span>

  <span class="hljs-comment"># 可选：指定 MR 的目标分支（比如只对 main/develop 的合入做检查）</span>
  <span class="hljs-comment"># rules:</span>
  <span class="hljs-comment">#   - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^(main|develop)$/</span>
</code></pre>
<h3 data-id="heading-5">sh脚本文件</h3>
<h4 data-id="heading-6">Java验证差异文件</h4>
<p>用于验证合入时两个分支之间的差异文件，对差异文件进行checkstyle（通过执行jar包）有问题就返回0，无问题会返回1，gitlab合并检测会根据返回值判定流水线成功/失败</p>
<p>原有脚本已经遗失，判断逻辑应当是jar包产生的输出，应当只看[WARN][ERROR]开头的的行是否&gt;0，有则有问题（需要jar包启动checkstyle，需要xml配置文件进行规则配置）</p>
<p>Java程序的checkstyle需要以不同版本为大前提创建各自环境，其他的如本地执行hook，Jenkins执行，git CI/CD执行流程，需要的各种静态资源需要一致</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># ================== 参数校验 ==================</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -ne 4 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &lt;namespace&gt; &lt;email&gt; &lt;source_branch&gt; &lt;target_branch&gt;"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Example: <span class="hljs-variable">$0</span> ucs-server dev@example.com feature/add-config main"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

NAMESPACE=<span class="hljs-variable">$1</span>
EMAIL=<span class="hljs-variable">$2</span>
SOURCE_BRANCH=<span class="hljs-variable">$3</span>
TARGET_BRANCH=<span class="hljs-variable">$4</span>

<span class="hljs-comment"># ================== 配置区 ==================</span>
<span class="hljs-comment"># Checkstyle jar 包路径（请根据实际路径修改）</span>
CHECKSTYLE_JAR=<span class="hljs-string">"./cloud/env/install/script/checkstyle.jar"</span>

<span class="hljs-comment"># Checkstyle 配置文件路径（checkstyle.xml）</span>
CHECKSTYLE_CONFIG=<span class="hljs-string">"./cloud/env/install/script/checkstyle.xml"</span>

<span class="hljs-comment"># 临时文件用于保存 Checkstyle 输出</span>
CHECKSTYLE_LOG=<span class="hljs-string">"/tmp/checkstyle_output_$$_<span class="hljs-subst">$(date +%s)</span>.txt"</span>
<span class="hljs-comment"># ===========================================</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Analyzing Java files changed between '<span class="hljs-variable">$SOURCE_BRANCH</span>' and '<span class="hljs-variable">$TARGET_BRANCH</span>'..."</span>

<span class="hljs-comment"># 1. 确保远程分支存在</span>
<span class="hljs-keyword">if</span> ! git rev-parse --verify <span class="hljs-string">"origin/<span class="hljs-variable">$SOURCE_BRANCH</span>"</span> &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: Remote branch 'origin/<span class="hljs-variable">$SOURCE_BRANCH</span>' not found."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Available branches:"</span>; git branch -r
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> ! git rev-parse --verify <span class="hljs-string">"origin/<span class="hljs-variable">$TARGET_BRANCH</span>"</span> &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: Remote branch 'origin/<span class="hljs-variable">$TARGET_BRANCH</span>' not found."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Available branches:"</span>; git branch -r
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 2. 获取两个分支之间变更的 Java 文件</span>
CHANGED_JAVA_FILES=()

<span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r file; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> == *.java ]] &amp;&amp; [ -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> ]; <span class="hljs-keyword">then</span>
        CHANGED_JAVA_FILES+=(<span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>)
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span> &lt; &lt;(git diff --name-only <span class="hljs-string">"origin/<span class="hljs-variable">$TARGET_BRANCH</span>"</span>...origin/<span class="hljs-variable">$SOURCE_BRANCH</span>)

<span class="hljs-comment"># 3. 检查是否有变更的 Java 文件</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#CHANGED_JAVA_FILES[@]}</span> -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No Java files changed between 'origin/<span class="hljs-variable">$TARGET_BRANCH</span>' and 'origin/<span class="hljs-variable">$SOURCE_BRANCH</span>'."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No Java changes detected."</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span>: No Java changes"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">exit</span> 0  <span class="hljs-comment"># 无变更视为通过</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Found <span class="hljs-variable">${#CHANGED_JAVA_FILES[@]}</span> Java file(s) to check:"</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">'  %s\n'</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_JAVA_FILES[@]}</span>"</span>

<span class="hljs-comment"># 4. 执行 Checkstyle 检查（一次性传入所有文件）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Running Checkstyle..."</span>
<span class="hljs-comment"># 使用 -c 指定配置，-f xml 或 summary 可选，这里使用简洁格式</span>
<span class="hljs-comment"># 如果你希望详细输出，可以使用 -f xml 并用 xmllint 格式化</span>
<span class="hljs-keyword">if</span> java -jar <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_JAR</span>"</span> -c <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_CONFIG</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_JAVA_FILES[@]}</span>"</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span> 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># Checkstyle 命令执行成功（语法正确），但不代表无警告/错误</span>
    OUTPUT=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$OUTPUT</span>"</span>

    <span class="hljs-comment"># 检查输出中是否包含违规信息（Checkstyle 通常会在有违规时输出内容）</span>
    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span> &amp;&amp; <span class="hljs-string">"<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$OUTPUT</span>"</span> | grep -v '^$' | wc -l)</span>"</span> -gt 0 ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle found issues in changed Java files."</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle Report:"</span> | mail -s <span class="hljs-string">"[FAIL] <span class="hljs-variable">$NAMESPACE</span>: Checkstyle failed"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span> -A <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
        <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
        <span class="hljs-built_in">exit</span> 1  <span class="hljs-comment"># 有违规 → 失败</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"All changed Java files passed Checkstyle."</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"No checkstyle violations found."</span> | mail -s <span class="hljs-string">"[OK] <span class="hljs-variable">$NAMESPACE</span>: Checkstyle passed"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
        <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
        <span class="hljs-built_in">exit</span> 0  <span class="hljs-comment"># 无违规 → 成功</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># Checkstyle 命令执行失败（如 jar 报错、配置错误等）</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle execution failed!"</span>
    <span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle execution failed. See details."</span> | mail -s <span class="hljs-string">"[ERROR] <span class="hljs-variable">$NAMESPACE</span>: Checkstyle execution error"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span> -A <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
    <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-7">yml验证差异文件</h4>
<p>与上面的Java验证类似，就是查询差异文件yml与yaml，checkstyle有问题就返回0，无问题会返回1，gitlab合并检测会根据返回值判定流水线成功/失败</p>
<p>（如果是spring可以跳过所有的application.yml文件，因为yml 验证主要是为了交付给运维同事配置文件才会有的流水线步骤）</p>
<p>原有脚本已经遗失，判断逻辑应当通过yamllint进行验证，根据输出产生行数&gt;0则有问题（需要ymlconf文件作为配置规则）</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -ne 2 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &lt;namespace&gt; &lt;email&gt;"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

NAMESPACE=<span class="hljs-variable">$1</span>
EMAIL=<span class="hljs-variable">$2</span>

<span class="hljs-comment"># ================== 配置区 ==================</span>
TARGET_BRANCH=<span class="hljs-string">"main"</span>  <span class="hljs-comment"># 目标合并分支，可根据需要改为 dev、release 等</span>
CONFIG_FILE=<span class="hljs-string">"./cloud/env/install/script/ymlconf"</span>
<span class="hljs-comment"># ===========================================</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🔍 Checking YAML files changed between current branch and '<span class="hljs-variable">$TARGET_BRANCH</span>'..."</span>

<span class="hljs-comment"># 1. 获取当前分支相对于目标分支的差异文件（仅新增或修改）</span>
<span class="hljs-comment"># 注意：GitLab CI 会自动 fetch 所有分支，可以直接使用</span>
CHANGED_YAML_FILES=()
<span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r file; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> == *.yml || <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> == *.yaml ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> ]; <span class="hljs-keyword">then</span>  <span class="hljs-comment"># 确保文件存在（避免删除的文件）</span>
            CHANGED_YAML_FILES+=(<span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>)
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span> &lt; &lt;(git diff --name-only <span class="hljs-string">"origin/<span class="hljs-variable">$TARGET_BRANCH</span>"</span>...HEAD)

<span class="hljs-comment"># 2. 检查是否有变更的 YAML 文件</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#CHANGED_YAML_FILES[@]}</span> -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ No YAML files changed. Skipping yamllint."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No YAML changes detected."</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span>: No YAML changes"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"📄 Found <span class="hljs-variable">${#CHANGED_YAML_FILES[@]}</span> YAML file(s) to check:"</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">'  %s\n'</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_YAML_FILES[@]}</span>"</span>

<span class="hljs-comment"># 3. 对差异文件逐个运行 yamllint</span>
ERRORS_FOUND=<span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_YAML_FILES[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">" linting <span class="hljs-variable">$file</span>"</span>
    <span class="hljs-keyword">if</span> ! yamllint -c <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> &gt; /tmp/yamllint.log 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ yamllint failed on <span class="hljs-variable">$file</span>"</span>
        ERRORS_FOUND+=<span class="hljs-string">"<span class="hljs-variable">$file</span>:\n"</span>
        ERRORS_FOUND+=$(<span class="hljs-built_in">cat</span> /tmp/yamllint.log)
        ERRORS_FOUND+=<span class="hljs-string">"\n\n"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 4. 处理结果</span>
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$ERRORS_FOUND</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"YAML file has syntax errors!"</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">$ERRORS_FOUND</span>"</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">$ERRORS_FOUND</span>"</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span> YAML file has syntax errors!"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">rm</span> -f /tmp/yamllint.log
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ All changed YAML files are valid."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"All changed YAML files passed lint."</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span>: YAML lint passed"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">rm</span> -f /tmp/yamllint.log
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">fi</span>
</code></pre>
<h2 data-id="heading-8">其他问题</h2>
<h3 data-id="heading-9">gitlab runner实例在shell模式下怎么占用Centos资源的</h3>
<p>在 shell executor 模式下，GitLab Runner 的工作方式如下：</p>
<ul>
<li>
<p>直接在宿主机（Centos）上执行命令：Runner 会以运行它的用户身份（如 gitlab-runner 用户），在系统 shell 中直接执行 .gitlab-ci.yml 中定义的 script 命令。</p>
</li>
<li>
<p>资源占用特点：</p>
<ul>
<li>CPU/内存：由实际执行的脚本决定（如编译、测试、打包等），直接消耗宿主机资源。</li>
<li>磁盘：会在临时目录（默认 /home/gitlab-runner/builds//...）克隆代码并执行任务，任务结束后默认清理（可通过 builds_dir 配置）。</li>
<li>环境依赖：所有依赖（如 Python、Node.js、Docker CLI 等）必须预先安装在 Centos 系统中。</li>
<li>无隔离性：多个 job 共享同一系统环境，可能互相干扰（比如修改全局 PATH、写文件到 /tmp）。</li>
<li>并发控制：通过 concurrent（全局）和 limit（每个 runner）控制同时运行的 job 数，避免资源耗尽。</li>
</ul>
</li>
</ul>
<p>建议：</p>
<ul>
<li>生产环境慎用 shell 模式，推荐用 docker 或 kubernetes 提供隔离。</li>
<li>如果必须用 shell，确保 runner 用户权限最小化，并监控系统负载。</li>
</ul>
<h3 data-id="heading-10">gitlab CI/CD如果失败，可不可以阻止合并任务</h3>
<p>实现方式：</p>
<ul>
<li>
<p>启用“合并前必须通过流水线”：</p>
<ul>
<li>进入项目 → Settings &gt; General &gt; Merge requests</li>
<li>勾选 Pipelines must succeed</li>
<li>（可选）勾选 Require approval from code owners</li>
</ul>
</li>
<li>
<p>保护目标分支（如 main / develop）：（这个对于有规模的开发团队，已经有CMO进行配置过了）</p>
<ul>
<li>
<p>Settings &gt; Repository &gt; Protected Branches</p>
</li>
<li>
<p>对目标分支设置：</p>
<ul>
<li>Allowed to merge: Maintainers（或指定角色）</li>
<li>Require status checks to pass before merging（如果启用了外部状态检查）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>结果：</p>
<ul>
<li>如果 CI pipeline 失败（任何 job 失败且未被 allow_failure: true 忽略），Merge 按钮变灰，无法合并。</li>
<li>即使有 Approver 同意，只要 pipeline 失败，也无法合并。 工作流程：</li>
</ul>
</li>
<li>
<p>注册：Runner 向 GitLab Server 注册，获得唯一 token，并绑定到项目或 group。</p>
</li>
<li>
<p>轮询/长连接：Runner 定期向 GitLab Server 的 /jobs/request API 发起请求（默认每几秒一次），询问是否有待处理的 job。</p>
</li>
<li>
<p>领取任务：当有匹配标签（tags）的 job 到来，Runner 领取任务（包含 .gitlab-ci.yml 中的 script、variables、artifacts 等信息）。</p>
</li>
<li>
<p>执行任务 ：</p>
<ul>
<li>根据配置的 executor（shell/docker/ssh/k8s 等）启动执行环境；</li>
<li>克隆代码；</li>
<li>执行 before_script → script → after_script；</li>
<li>上传 artifacts/logs；</li>
<li>上报状态（success/failure）。</li>
</ul>
</li>
<li>
<p>释放资源：任务结束，清理临时文件（除非配置保留）。</p>
</li>
</ul>
<h3 data-id="heading-11">gitlab CI/CD，如果要执行脚本，有哪些参数是gitlab这边可以提供</h3>
<p>GitLab 自动注入大量 预定义 CI/CD 变量（Predefined Variables），你可以在脚本中直接使用，例如：</p>
<p>常用内置变量示例：</p>





















<table><thead><tr><th>变量</th><th>说明</th></tr></thead><tbody><tr><td>CI_COMMIT_REF_NAME</td><td>当前分支或 tag 名（如 main, v1.0）</td></tr><tr><td>CI_PROJECT_DIR</td><td>CI 任务的工作目录（代码被 clone 到这里）</td></tr><tr><td>GITLAB_USER_EMAIL</td><td>触发 pipeline 的用户邮箱</td></tr></tbody></table>
<p>其他的像是两个分支的分支hash也可以通过git提供的参数获取到，用于差异文件的排查。更多的可以看官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gitlab.com%2Fci%2Fvariables%2Fpredefined_variables%2F" target="_blank" title="https://docs.gitlab.com/ci/variables/predefined_variables/" ref="nofollow noopener noreferrer">docs.gitlab.com/ci/variable…</a></p>
<h3 data-id="heading-12">合并任务下，两个分支都有脚本，改用哪一个，如果任意一方缺少脚本，该用哪一个</h3>
<p>GitLab 的规则非常明确： 始终使用 source branch（源分支）中的 .gitlab-ci.yml 文件</p>
<p>详细说明：</p>
<ul>
<li>当你创建一个从 feature → main 的 MR，</li>
<li>GitLab 会 checkout feature 分支的代码，</li>
<li>并读取 feature 分支根目录下的 .gitlab-ci.yml 来执行 pipeline。</li>
<li>不会去读 main 分支的 .gitlab-ci.yml。</li>
</ul>

























<table><thead><tr><th>情况</th><th>使用哪个 .gitlab-ci.yml?</th></tr></thead><tbody><tr><td>feature 有，main 有</td><td>✅ 用 feature 的</td></tr><tr><td>feature 有，main 没有</td><td>✅ 用 feature 的</td></tr><tr><td>feature 没有，main 有</td><td>❌ pipeline 不会触发（因为 source branch 没有 .gitlab-ci.yml）</td></tr><tr><td>两者都没有</td><td>❌ 无 CI pipeline</td></tr></tbody></table>
<h3 data-id="heading-13">gitlab-ci.yml会执行更多脚本，这些脚本/静态资源怎么存放</h3>
<p>推荐将大资源（如git CI/CD可以接入通过checkstyle.jar执行checkstyle，对应的jar文件）放在服务器上，其他的则可以放在各自的代码仓库内</p>
<h3 data-id="heading-14">为什么 GitLab Runner 安装时没有 gitlab-runner 用户就无法注册？这个用户代表什么？</h3>
<p>当你通过官方方式安装 GitLab Runner（如 yum install gitlab-runner 或 dpkg -i gitlab-runner_xxx.deb），安装脚本会自动：</p>
<ol start="0">
<li>创建系统用户 gitlab-runner</li>
<li>以该用户身份运行 runner 服务</li>
<li>Runner 在执行 job 时，所有命令都以 gitlab-runner 身份运行</li>
</ol>
<p>所以如果手动的安装，可能会错过这一步，最终导致无法注册runner到gitlab上面</p>
<h3 data-id="heading-15">.gitlab-ci.yml的完整克隆是什么意思</h3>
<p>答案：GitLab 会完整克隆（checkout）源分支（source branch）的代码，并使用该分支中的 .gitlab-ci.yml 文件</p>
<ul>
<li>
<p>这个过程包括：</p>
<ul>
<li>在 Runner 上执行 git clone </li>
<li>git checkout （例如 feature/add-login 的最新 commit）</li>
<li>读取这个 commit 中的 .gitlab-ci.yml</li>
<li>按照它的定义执行 job</li>
</ul>
</li>
</ul>
<p>所以，“完整克隆”在这里的意思是：</p>
<p>不是只复制 .gitlab-ci.yml 文件，而是把整个源分支的代码仓库完整拉下来，确保 CI 配置和代码版本严格一致。</p>
<p>为什么重要？</p>
<ul>
<li>如果你修改了 .gitlab-ci.yml（比如加了一个测试 job），只有推送到 源分支 才会在 MR 中生效。</li>
<li>目标分支（如 main）的 .gitlab-ci.yml完全不会被使用。</li>
</ul>
<h3 data-id="heading-16">gitlab runner拉代码的时候有什么级别嘛，比如一个级别只拉代码，一个级别把全部的信息都拉取下来？如果有不同级别，gitlabcicd提供的参数还会生效吗？如何配置？如何选择？</h3>
<blockquote>
<p><strong>gitlab runner拉代码的时候有什么级别嘛，比如一个级别只拉代码，一个级别把全部的信息都拉取下来？</strong></p>
</blockquote>
<p>GitLab Runner 在拉取代码时，确实支持“不同深度”的克隆（clone depth），但没有“只拉代码 / 拉全部信息”这种二元级别。</p>
<p>你可以通过以下方式控制 拉取多少 Git 历史（commit history）：</p>
<ul>
<li>浅克隆（shallow clone）：只拉最近 N 个 commit（默认行为）</li>
<li>深克隆（full clone）：拉取完整历史（所有分支、tags、完整 commit graph）</li>
</ul>
<p>注意：无论哪种方式，都会拉取完整的当前 commit 的文件内容（即“代码”）。</p>
<p>所谓“只拉代码”其实是误解 —— 代码文件总是完整的，区别只在 历史记录是否完整。
浅拷贝，深拷贝的在各个方面的不同</p>

























<table><thead><tr><th>配置</th><th>行为</th><th>适用场景</th></tr></thead><tbody><tr><td>GIT_DEPTH: 1（默认）</td><td>浅克隆：只拉当前 commit + 最近 1 层历史</td><td>快速构建、节省带宽</td></tr><tr><td>GIT_DEPTH: 0 或未设置</td><td>深克隆：拉取完整仓库历史（等价于 git clone --mirror）</td><td>需要 git log、git describe、计算版本号等</td></tr><tr><td>GIT_DEPTH: 10</td><td>拉最近 10 个 commit 的历史</td><td>折中方案</td></tr></tbody></table>
<p>不同的配置推荐场景如下：</p>





























<table><thead><tr><th>场景</th><th>推荐配置</th></tr></thead><tbody><tr><td>普通构建、测试、部署</td><td>GIT_DEPTH: 1（默认，最快）</td></tr><tr><td>需要生成版本号（如 v1.2.3-5-gabc123）</td><td>GIT_DEPTH: 0 + git fetch --tags</td></tr><tr><td>需要分析 commit 差异（如 changelog）</td><td>GIT_DEPTH: 0</td></tr><tr><td>使用 Lerna / Nx 等工具依赖 Git 历史</td><td>GIT_DEPTH: 0</td></tr><tr><td>节省 CI 时间和带宽</td><td>保持默认（GIT_DEPTH: 1）</td></tr></tbody></table>
<blockquote>
<p><strong>GitLab CI 提供的参数还会生效吗？</strong></p>
</blockquote>
<p>会！完全不受影响。</p>
<p>无论你用浅克隆还是深克隆，以下内容都 正常可用</p>
<blockquote>
<p>如何配置？</p>
</blockquote>
<p>GitLab CI 通过一个内置变量 GIT_DEPTH 控制克隆深度：</p>
<p>如：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">variables:</span>
  <span class="hljs-attr">GIT_DEPTH:</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># 拉取完整历史</span>

<span class="hljs-attr">build:</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">log</span> <span class="hljs-string">--oneline</span> <span class="hljs-string">-n</span> <span class="hljs-number">5</span>   <span class="hljs-comment"># 只有 GIT_DEPTH &gt; 1 或 =0 时才有多个 commit</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">describe</span> <span class="hljs-string">--tags</span>      <span class="hljs-comment"># 需要完整 tag 历史</span>
</code></pre>
<blockquote>
<p><strong>默认行为是什么？</strong></p>
</blockquote>
<p>GIT_DEPTH: 1（浅克隆，高效）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>