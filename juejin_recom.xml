<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理]]></title>    <link>https://juejin.cn/post/7585798113547829298</link>    <guid>https://juejin.cn/post/7585798113547829298</guid>    <pubDate>2025-12-22T02:14:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113547829298" data-draft-id="7450771973871091724" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理"/> <meta itemprop="keywords" content="Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T02:14:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:42.000Z" title="Mon Dec 22 2025 02:14:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    41
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在继续搭建 <strong>NestJS</strong> 和 <strong>Hono.js</strong> 的通用框架之前，可以先回顾一下前几篇文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7576555431943503882" target="_blank" title="https://juejin.cn/post/7576555431943503882">深入 NestJS 底层概念（1）：依赖注入和面向切面编程 AOP</a></li>
<li><a href="https://juejin.cn/post/7580564126403362866" target="_blank" title="https://juejin.cn/post/7580564126403362866">NestJS / Hono.js 一起学！Hono 的设计思想</a></li>
<li><a href="https://juejin.cn/post/7581448482544713754" target="_blank" title="https://juejin.cn/post/7581448482544713754">NestJS / Hono.js 一起学！开发前必备</a></li>
<li><a href="https://juejin.cn/post/7583727768543199268" target="_blank" title="https://juejin.cn/post/7583727768543199268">NestJS / Hono.js 一起学！字节团队如何配置多环境攻略</a></li>
</ul>
<p>本篇文章主要实现 <strong>NestJS 与 Hono.js</strong> 的以下功能：</p>
<ol>
<li><strong>打印日志 &amp; 收集日志</strong></li>
<li><strong>统一返回前端的数据格式</strong></li>
<li><strong>统一错误处理</strong></li>
</ol>
<p>这些功能在很多 NestJS 教程中都有覆盖，但我们会在此基础上做一些增强：</p>
<ul>
<li>
<p><strong>日志打印增加 <code>traceId</code> 功能</strong></p>
<ul>
<li>在 Node.js 高并发场景下，<strong>每个请求的 traceId 必须独立</strong>，因为它是<strong>单线程异步</strong>模型，如果我们像写传统同步代码那样直接定义一个全局变量来存 <code>traceId</code>，就会发生严重的“串号”现象。</li>
</ul>
</li>
</ul>
<p><strong>案例：</strong></p>
<p>假设我们有一个 Web 服务，同时收到两个用户请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> traceId; <span class="hljs-comment">// 全局变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">user</span>) {
  traceId = <span class="hljs-string">`trace-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>; <span class="hljs-comment">// 给当前请求生成 traceId</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 开始处理 <span class="hljs-subst">${user}</span> 的请求`</span>);

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 异步操作，可能晚于其他请求执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 完成处理 <span class="hljs-subst">${user}</span> 的请求`</span>);
  }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟两个用户几乎同时发起请求</span>
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Bob'</span>);
</code></pre>
<p><strong>可能的输出（串号）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">trace-532</span>] 开始处理 Alice 的请求
[<span class="hljs-meta">trace-764</span>] 开始处理 Bob 的请求
[<span class="hljs-meta">trace-764</span>] 完成处理 Alice 的请求   ← 错误，日志 traceId 被覆盖，因为全局目前的 traceId 已经是 trace<span class="hljs-number">-764</span> 了
[<span class="hljs-meta">trace-764</span>] 完成处理 Bob 的请求
</code></pre>
<p>以上的问题有些笨办法可以处理，但我们最终会借助 node.js AsyncLocalStorage（在 nest.js 有对应模块，简单实现，在 hono.js 中我们自己封装一个类似功能的模块。）</p>
<p>还有一个必须了解的，这个 traceId 是服务端必须有的，因为我们的处理一个用户请求会经过很多中间件很多不同的模块处理，如何判断经过这么多模块的某个请求是同一个请求，就要用这个 traceId 来记录。</p>
<ul>
<li>
<p><strong>统一返回前端的数据格式</strong>，例如，我们希望所有接口返回：</p>
<pre><code class="hljs language-css" lang="css">```
{
  "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">0</span>,
  <span class="hljs-string">"data"</span>: {...},
  "message": <span class="hljs-string">"success"</span>
}
```
</code></pre>
<ul>
<li><strong>可选配置</strong>：某些路由可以跳过统一格式返回。</li>
</ul>
</li>
</ul>
<hr/>
<p>接下来，我们将先从 nest.js 框架开始，逐步实现这些功能。</p>
<h2 data-id="heading-1">nest.js 配置</h2>
<h3 data-id="heading-2">链路日志追踪功能</h3>
<p>这套系统的灵魂在于 <code>nestjs-cls</code> 和 <code>Winston</code> 的结合。</p>
<p>为什么要这么做？</p>
<p>在 Node.js 异步环境中，传统的全局变量无法区分哪个日志属于哪个用户请求。</p>
<ul>
<li><strong>ClsModule (上下文存储)</strong> ：就像给每个进站的乘客（请求）发一个专属的“透明信封”。这个信封里装着 <code>traceId</code>。</li>
<li><strong>Winston (记录员)</strong> ：当程序需要记录日志时，记录员会从这个“信封”里掏出 <code>traceId</code> 盖在日志条目上。</li>
</ul>
<p>这样，即便服务器同时处理 1000 个请求，你只需要在日志里搜索特定的 <code>traceId</code>，就能看到该请求从“进入”到“报错”的所有心路历程。</p>
<hr/>
<h3 data-id="heading-3">代码功能深度拆解</h3>
<p>我们将代码逻辑分为三个核心模块来理解：</p>
<h4 data-id="heading-4">第一部分：CLS 上下文初始化 (AppModule)</h4>
<p>这是全链路追踪的起点。在根 module 配置，也就是 app.module.ts中增加：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">// 之前文章讲的环境变量配置模块</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局可用，无需在每个模块导入</span>
      <span class="hljs-attr">load</span>: [initConfig], <span class="hljs-comment">// 使用自定义加载器</span>
    }),
    <span class="hljs-comment">// 1. 初始化 CLS 上下文，并自动生成 traceId</span>
    <span class="hljs-title class_">ClsModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">global</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">middleware</span>: {
        <span class="hljs-attr">mount</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">generateId</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">idGenerator</span>: <span class="hljs-function">(<span class="hljs-params">req: <span class="hljs-built_in">any</span></span>) =&gt;</span>
          (req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>) ?? <span class="hljs-title function_">randomUUID</span>(), <span class="hljs-comment">// 优先使用 header 中的 ID</span>
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>这里我们简单说下 ClsModule 实现的基本原理：</p>
<p>我们分三步来实现：</p>
<ul>
<li>第一步：封装 ALS 工具类</li>
</ul>
<p>这是我们的“储物柜”管理器。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'async_hooks'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsService</span> {
  <span class="hljs-comment">// 1. 创建一个物理存储对象</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;();

  <span class="hljs-comment">// 2. 启动上下文（包裹请求）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">run</span>(store, callback);
  }

  <span class="hljs-comment">// 3. 存储数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">if</span> (store) store.<span class="hljs-title function_">set</span>(key, value);
  }

  <span class="hljs-comment">// 4. 获取数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">return</span> store?.<span class="hljs-title function_">get</span>(key);
  }
}
</code></pre>
<ul>
<li>编写中间件 (Middleware)</li>
</ul>
<p>在 NestJS 中，中间件是请求进来的第一站，我们在这里“开启”储物柜。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.middleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cls.service'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res: <span class="hljs-built_in">any</span>, next: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-comment">// 关键点：将后续所有的逻辑（next）都运行在 MyClsService.run 的回调里</span>
    <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> traceId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] || <span class="hljs-title function_">randomUUID</span>();
      <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'traceId'</span>, traceId); <span class="hljs-comment">// 存入 traceId</span>
      <span class="hljs-title function_">next</span>();
    });
  }
}
</code></pre>
<p>这个中间件添加之后，意味着所有的请求都会有一个 traceId 值，那在其它地方如何调用呢？请看</p>
<ul>
<li>第三步：在任何地方使用</li>
</ul>
<p>由于 <code>AsyncLocalStorage</code> 跟踪的是异步调用栈，你不再需要通过参数传递 <code>traceId</code>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// any.service.ts</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnyService</span> {
  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 像变魔术一样，直接拿！</span>
    <span class="hljs-keyword">const</span> traceId = <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'traceId'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[当前任务] TraceID 是: <span class="hljs-subst">${traceId}</span>`</span>);
  }
}
</code></pre>
<p>我们接着讲日志功能，</p>
<h3 data-id="heading-5">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<h3 data-id="heading-6">第三部分：异步注入 (WinstonModule.forRootAsync)</h3>
<p>这是 NestJS 的高级用法，确保日志配置是在获取到系统配置（ConfigService）之后才生成的。</p>
<p>在 app.module.ts 中增加 winston配置</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WinstonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { winstonConfigFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/logger'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
     <span class="hljs-comment">// ... 其它配置</span>
    <span class="hljs-comment">// 2. 注入 Winston</span>
    <span class="hljs-comment">// 3. 使用 forRootAsync 异步加载配置</span>
    <span class="hljs-title class_">WinstonModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>], <span class="hljs-comment">// 导入 ConfigModule 以便使用 ConfigService</span>
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>], <span class="hljs-comment">// 注入 ConfigService</span>
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">configService: ConfigService</span>) =&gt;</span> {
        <span class="hljs-comment">// 调用我们抽离出去的配置函数</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">winstonConfigFactory</span>(configService);
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>其中  winstonConfigFactory 的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> winston, { transports, format } <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { utilities <span class="hljs-keyword">as</span> nestWinstonModuleUtilities } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsServiceManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>, <span class="hljs-variable constant_">DIR_NAME</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/config/constants'</span>;

<span class="hljs-comment">// 保持之前的 format 定义不变</span>
<span class="hljs-keyword">const</span> appendRequestId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> cls = <span class="hljs-title class_">ClsServiceManager</span>.<span class="hljs-title function_">getClsService</span>();
  <span class="hljs-keyword">const</span> traceId = cls?.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'traceId'</span>);
  <span class="hljs-keyword">if</span> (traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">// 核心修改：导出一个 Factory 函数，而不是静态对象</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">winstonConfigFactory</span> = (<span class="hljs-params">configService: ConfigService</span>) =&gt; {
  <span class="hljs-comment">// 1. 从 ConfigService 获取配置，提供默认值</span>
  <span class="hljs-keyword">const</span> logDir = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-variable constant_">DIR_NAME</span>, <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>);
  <span class="hljs-keyword">const</span> isProduction = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'NODE_ENV'</span>) === <span class="hljs-string">'production'</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">transports</span>: isProduction
      ? [
          <span class="hljs-comment">// 2. 定义 DailyRotateFile (使用动态路径)</span>
          <span class="hljs-comment">// 错误日志按天滚动，保留 14 天，每个文件最大 20MB</span>
          <span class="hljs-comment">// 仍然把错误打印到控制台（k8s / docker 日志）</span>
          <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(),
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">info: any</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> trace = info.<span class="hljs-property">traceId</span> ? <span class="hljs-string">` [trace:<span class="hljs-subst">${info.traceId}</span>]`</span> : <span class="hljs-string">''</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${info.timestamp}</span> <span class="hljs-subst">${info.level}</span><span class="hljs-subst">${trace}</span>: <span class="hljs-subst">${info.message}</span>`</span>;
              }),
            ),
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">dirname</span>: logDir, <span class="hljs-comment">// &lt;--- 这里使用了配置中的路径</span>
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              <span class="hljs-title function_">appendRequestId</span>(),
              format.<span class="hljs-title function_">timestamp</span>(),
              format.<span class="hljs-title function_">json</span>(),
            ),
          }),
        ]
      : [
          <span class="hljs-comment">// 3. 定义 Console Transport</span>
          <span class="hljs-comment">// 开发环境通常只需要 Console，也可以按需加 File</span>
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'info'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">timestamp</span>(),
              nestWinstonModuleUtilities.<span class="hljs-property">format</span>.<span class="hljs-title function_">nestLike</span>(<span class="hljs-string">'MyApp'</span>, {
                <span class="hljs-attr">colors</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">prettyPrint</span>: <span class="hljs-literal">true</span>,
              }),
            ),
          }),
        ],
  };
};
</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<p>为了让这套系统更完美，在实际应用中，你可以这样使用：</p>
<h3 data-id="heading-7">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>这里使用 <code>this.logger.log</code> 的时候，你不需要手动去取 ID，因为我们在 <code>winstonConfigFactory</code> 里的 <code>appendRequestId</code> 已经自动处理了。所以会自带 traceId 属性在日志里。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">AppService</span>.<span class="hljs-property">name</span>);

  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一条带有 traceId 的业务日志！'</span>); 
    <span class="hljs-comment">// 输出结果会自动带上: {"traceId":"...", "message":"...", "timestamp":"..."}</span>
  }
}
</code></pre>
<p>接下来实现第二个功能，将返回前端的格式统一</p>
<h3 data-id="heading-8">统一返回格式</h3>
<p>统一格式，在 nest.js 中有拦截器实现（hono.js就没有拦截器的概念），很简单：</p>
<h4 data-id="heading-9">nest.js 统一返回格式：用拦截器实现标准响应结构</h4>
<p>在前后端分离的业务架构中，<strong>统一接口返回格式</strong>已成为标配：<br/>
无论后端返回什么，都应该在一层标准的格式中输出，例如：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {...},
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"xxx"</span>
}
</code></pre>
<p>这样做有几个直接收益：</p>
<ol>
<li>前端更容易做异常和展示逻辑，不需要每个接口单独处理。</li>
<li>服务端可以统一标记 traceId，方便链路排查问题。</li>
<li>协议一致后，可快速扩展错误码体系。</li>
</ol>
<p>在 nest.js 中，我们可以使用 <strong>Interceptors（拦截器）</strong> 来完成这一目标。下面是一段完整的拦截器代码。</p>
<h4 data-id="heading-10">拦截器核心代码示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">CallHandler</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorCodes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StandardResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">data</span>: T;
  traceId?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardResponseInterceptor</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span>&lt;
  T,
  <span class="hljs-title class_">StandardResponse</span>&lt;T&gt;
&gt; {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> cls: ClsService</span>) {}

  <span class="hljs-title function_">intercept</span>(<span class="hljs-params">context: ExecutionContext, next: CallHandler</span>) {
    <span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">getType</span>() !== <span class="hljs-string">'http'</span>) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> handler = context.<span class="hljs-title function_">getHandler</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'skip_transform'</span>, handler)) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();

    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> ({
        <span class="hljs-attr">code</span>: <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SUCCESS</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'OK'</span>,
        data,
        traceId,
      })),
    );
  }
}
</code></pre>
<p>说明：</p>
<ul>
<li>ClsService 用于获取当前请求的 traceId</li>
<li>map() 包裹所有返回内容</li>
<li>拦截器只在 HTTP 请求上执行（GraphQL、Microservice 可以忽略）</li>
<li>可通过自定义 Decorator 跳过包装</li>
</ul>
<h4 data-id="heading-11">如何注册拦截器（全局启用）</h4>
<p>在 <code>main.ts</code> 中：</p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardResponseInterceptor</span>(app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>)));
</code></pre>
<p>这样所有路由默认都统一格式输出。</p>
<h4 data-id="heading-12">某些接口不想被统一格式怎么办？</h4>
<p>例如导出文件等特殊接口，不希望包裹。</p>
<p>你可以加自定义装饰器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">SkipTransform</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title class_">SetMetadata</span>(<span class="hljs-string">'skip_transform'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'upload'</span>)
<span class="hljs-meta">@SkipTransform</span>()
<span class="hljs-title function_">getCaptcha</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> someRawBinary;
}
</code></pre>
<p>当前路由会跳过统一包裹。</p>
<h4 data-id="heading-13">实际效果展示</h4>
<p>原本控制器返回：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Tom'</span> };
}
</code></pre>
<p>最终前端收到：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h2 data-id="heading-14">通用错误处理</h2>
<p>在后端系统中，错误处理往往经历三个阶段：</p>
<ol>
<li>能跑（框架兜底）</li>
<li>能返回（让前端知道错哪里）</li>
<li>能排障（日志链路、定位效率）</li>
</ol>
<p>nestjs 的 <code>ExceptionFilter</code> 为第三阶段提供了完整治理能力。本节通过自定义 <code>AllExceptionsFilter</code>，从“拦截错误”开始，一层层增强错误输出、业务语义、日志能力和 traceId 支持。</p>
<h3 data-id="heading-15">第一层：拦截所有异常，而不是依赖框架默认行为</h3>
<p>默认情况下，框架会尝试处理异常，但格式、内容和处理方式不可控。<br/>
通过 <code>@Catch()</code> 拦截全场景错误，我们将接管所有异常通道：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllExceptionsFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-built_in">unknown</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
</code></pre>
<p>借助 <code>ArgumentsHost</code>，我们拿到 HTTP 请求上下文，后续就能构造专属响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
<span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;();
<span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
</code></pre>
<p>此时的目标是“掌控入口”。</p>
<h3 data-id="heading-16">第二层：区分 HTTP 状态码，让协议正确表达成功或失败</h3>
<p>框架层能力拦截之后，下一层诉求是协议语义正确。<br/>
对客户端返回的 HTTP Status 必须准确，否则代理、浏览器、监控系统均无法判断请求情况：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> httpStatus =
  exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>
    ? exception.<span class="hljs-title function_">getStatus</span>()
    : <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">INTERNAL_SERVER_ERROR</span>;
</code></pre>
<p>简单讲：</p>
<ul>
<li>可预期的业务错误维持 4xx</li>
<li>其它错误不想让前端知道具体错误，直接返回  <code>INTERNAL_SERVER_ERROR</code>。</li>
</ul>
<p>这实现了“系统对外的协议治理”。</p>
<h3 data-id="heading-17">第三层：建立业务错误码体系，与协议语义解耦</h3>
<p>HTTP Status 永远不适合作为业务判断依据。<br/>
因此体系化项目会分离“协议错误码”和“业务错误码”。这一步实现业务语义治理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">businessCode</span>: <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">400</span> &amp;&amp; httpStatus &lt; <span class="hljs-number">500</span>) {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">BUSINESS_ERROR</span>;
} <span class="hljs-keyword">else</span> {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SYSTEM_ERROR</span>;
}
</code></pre>
<p>从此，前端不再需要看 400/500 决策，而是看业务码 1000/5000 做逻辑分支(如果需要有业务错误码的话，一般可以不加业务状态码)。</p>
<h3 data-id="heading-18">第四层：控制返回给用户的 message，不泄漏内部实现</h3>
<p>继续向下走，我们需要控制“用户可见信息”。</p>
<p>对于 <code>HttpException</code>，返回异常信息安全可控；<br/>
而普通异常有堆栈、内部错误，不可直给客户端：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">userMessage</span>: <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>) {
  <span class="hljs-keyword">const</span> exceptionResponse = exception.<span class="hljs-title function_">getResponse</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  userMessage = exceptionResponse.<span class="hljs-property">message</span> || exception.<span class="hljs-property">message</span>;
} <span class="hljs-keyword">else</span> {
  userMessage = <span class="hljs-string">'Server Internal Error'</span>;
}
</code></pre>
<h3 data-id="heading-19">第五层：注入 traceId，将错误纳入链路追踪体系</h3>
<p>协议治理与安全治理之后，我们需要可观测性。<br/>
依赖 <code>ClsService</code> 获取 traceId，使任意异常都能与一次请求绑定：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();
</code></pre>
<p>这让后续日志检索有了线索，从“出错”变为“定位在哪个请求出错”。</p>
<hr/>
<h3 data-id="heading-20">第六层：构造统一错误返回体，让前端接收结构稳定</h3>
<p>业务响应格式统一之后，客户端解析与 UI 逻辑才能标准化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: businessCode,
  <span class="hljs-attr">message</span>: userMessage,
  traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
    <span class="hljs-attr">method</span>: request.<span class="hljs-property">method</span>,
    httpStatus,
  },
};
</code></pre>
<p>这一层，从“不固定字段”变为“返回契约统一”。</p>
<hr/>
<h3 data-id="heading-21">第七层：按严重程度结构化日志，结合 traceId 可查可追</h3>
<p>有了 traceId 后，日志才具备上下文意义。<br/>
对非预期错误记录堆栈并升为 <code>error</code>，对客户端调用错误降级为 <code>warn</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: (exception <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">stack</span>,
    traceId,
  });
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    traceId,
  });
}
</code></pre>
<p>此处是“日志治理 + 可观测性治理”。</p>
<hr/>
<h3 data-id="heading-22">第八层：保持 HTTP 状态原样返回，确保协议链路正常识别</h3>
<p>最终输出必须保留协议语义，否则监控、负载均衡、浏览器都将错误判断请求：</p>
<pre><code class="hljs language-typescript" lang="typescript">response.<span class="hljs-title function_">status</span>(httpStatus).<span class="hljs-title function_">json</span>(finalClientResponse);
</code></pre>
<p>接下来就可以在 main.ts 中使用这个全局错误管理器了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AllExceptionsFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/filters/http-exception.filter'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">NestExpressApplication</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">LoggerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">NestExpressApplication</span>&gt;(<span class="hljs-title class_">AppModule</span>, {
    <span class="hljs-attr">bufferLogs</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 先缓存日志，直到 Logger 替换完成</span>
  });

  <span class="hljs-keyword">const</span> configService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ConfigService</span>);

  <span class="hljs-comment">// 1. 替换 Nest 默认 Logger 为 Winston</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">logger</span>: <span class="hljs-title class_">LoggerService</span> = app.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">WINSTON_MODULE_NEST_PROVIDER</span>);

  app.<span class="hljs-title function_">useLogger</span>(logger);

  <span class="hljs-comment">// 获取 CLS 服务实例</span>
  <span class="hljs-keyword">const</span> clsService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>);

  <span class="hljs-comment">// 4. 注册全局异常过滤器：捕获所有异常并打印日志 + 返回统一结构</span>
  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(clsService, logger));

  <span class="hljs-keyword">const</span> port = configService.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'port'</span>) ?? <span class="hljs-number">3000</span>;

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    logger.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server on :<span class="hljs-subst">${port}</span>`</span>);
  });
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h2 data-id="heading-23">honojs 配置</h2>
<h3 data-id="heading-24">第一部分：链路日志追踪功能</h3>
<p>首先我们封装记录 traceId 的功能，我们通过编写一个中间件来实现，这个中间件是所有请求过来，经过的第一步，这样所有请求就带了 traceId，具体实现如下：</p>
<p>首先我们要创建一个 AsyncLocalStorage 实例，让后续的中间件调用其 run 方法，为每个请求创建独立的上下文。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:async_hooks"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestContext</span> {
  <span class="hljs-attr">traceId</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 初始化全局存储</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">RequestContext</span>&gt;();

<span class="hljs-comment">// 封装一个获取 traceId 的快捷方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getTraceId = (): <span class="hljs-built_in">string</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> store = ctx.<span class="hljs-title function_">getStore</span>();
  <span class="hljs-keyword">return</span> store?.<span class="hljs-property">traceId</span>;
};

</code></pre>
<p>以下是 middleware 的实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/factory"</span>;
<span class="hljs-keyword">import</span> { ctx } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>; <span class="hljs-comment">// 导入您的 ctx</span>

<span class="hljs-comment">// 确保在 Node.js 环境下使用</span>
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> traceMiddleware = <span class="hljs-title function_">createMiddleware</span>(<span class="hljs-keyword">async</span> (c, next) =&gt; {
  <span class="hljs-comment">// 1. 生成唯一的 Trace ID</span>
    <span class="hljs-keyword">const</span> traceId = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">header</span>(<span class="hljs-string">"x-request-id"</span>) || <span class="hljs-title function_">randomUUID</span>();

  <span class="hljs-comment">// 2. 将 Trace ID 存储在 AsyncLocalStorage 中，并运行后续的处理链</span>
  <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">run</span>({ traceId }, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 3. (可选) 记录请求开始日志</span>
    <span class="hljs-comment">// logger.info(`Request started: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">// });</span>

    <span class="hljs-comment">// 4. 继续处理链</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-comment">// 5. (可选) 设置响应头</span>
    c.<span class="hljs-property">res</span>.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"X-Trace-ID"</span>, traceId);

    <span class="hljs-comment">// // 6. (可选) 记录请求结束日志</span>
    <span class="hljs-comment">// logger.info(`Request finished: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">//   status: c.res.status,</span>
    <span class="hljs-comment">// });</span>
  });
});
</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>主要代码就是 ctx.run({ traceId }, async () =&gt; { xxx }), 将后所有内容，包含在 AsyncLocalStorage 上下文中，也就是 traceId 会伴随整个请求的生命周期。</p>
<h3 data-id="heading-25">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<p>以上的功能，我们封装到一个 logger.ts 中，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { format, transports, createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"winston"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"winston-daily-rotate-file"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PROD_ENV</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../constant"</span>;

<span class="hljs-comment">// 1. 自定义 Format：自动从 ALS 获取 Trace ID</span>
<span class="hljs-keyword">const</span> appendTraceId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-comment">// 使用 ctx.getStore() 获得</span>
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
  <span class="hljs-keyword">if</span> (!traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">/// 2. 基础配置</span>
<span class="hljs-keyword">const</span> logFormat = format.<span class="hljs-title function_">combine</span>(
  <span class="hljs-title function_">appendTraceId</span>(),
  format.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> }),
  format.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }), <span class="hljs-comment">// 自动捕获 error stack</span>
  format.<span class="hljs-title function_">json</span>()
);

<span class="hljs-keyword">const</span> devTransport = <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-string">"info"</span>,
  <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
    format.<span class="hljs-title function_">colorize</span>(),
    format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
      <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
      <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
    })
  ),
});

<span class="hljs-comment">// 导出 Logger 实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> logger = <span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>:
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-variable constant_">PROD_ENV</span>
      ? <span class="hljs-comment">// 生产环境 Transports</span>
        [
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">filename</span>: <span class="hljs-string">"logs/error-%DATE%.log"</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">"YYYY-MM-DD"</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">"20m"</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">"14d"</span>,
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">colorize</span>(),
              format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
                <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
                <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
              })
            ),
          }),
        ]
      : <span class="hljs-comment">// 开发环境 Transport</span>
        [devTransport],
});

</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<h3 data-id="heading-26">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>如下，我们就可以在路由中使用 logger 功能，就会自带 traceId 了</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Hono</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./common/logger"</span>;
<span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/users"</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理 /users 请求"</span>);

  <span class="hljs-keyword">const</span> list = [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> }];

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`查询用户数量=<span class="hljs-subst">${list.length}</span>`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, { list });
});
</code></pre>
<p>访问结果输出（示例）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">开始处理</span> <span class="hljs-string">/users</span> <span class="hljs-string">请求</span>
<span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">查询用户数量=1</span>
</code></pre>
<h3 data-id="heading-27">在 hono.js 中封装统一返回格式</h3>
<p>与 nest.js 不同，hono.js 没有 <strong>Interceptor</strong> 的概念，因此无法在框架层自动包装所有路由的返回值。hono 更偏向极简设计：框架提供 Context（<code>c</code>）与响应方法（如 <code>c.json()</code>），开发者通过 middleware 或工具函数扩展能力。</p>
<p>在这种模式下，一个常见策略是：<strong>在 utils 层封装一个标准响应函数</strong>，每当路由处理完成业务逻辑后，调用该函数输出标准格式。示例如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/response.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">CODES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/codes"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUCCESS_MESSAGE</span> = <span class="hljs-string">"OK"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> standardResponse = &lt;T&gt;(
  <span class="hljs-attr">c</span>: <span class="hljs-title class_">Context</span>,
  <span class="hljs-attr">data</span>: T,
  <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span> = <span class="hljs-number">200</span>
): <span class="hljs-function"><span class="hljs-params">Response</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-variable constant_">CODES</span>.<span class="hljs-property">SUCCESS</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-variable constant_">SUCCESS_MESSAGE</span>,
    data,
    traceId,
  };
  
   <span class="hljs-comment">// 使用 c.json() 返回 Response</span>
  <span class="hljs-comment">// c.json() 负责设置 Content-Type: application/json</span>
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalResponse, httpStatus);
};
</code></pre>
<p>这一函数实现了几个能力：</p>
<ol>
<li><strong>统一业务结构</strong>：code / message / data 统一格式化。</li>
<li><strong>链路可观测性</strong>：自动从 ALS 中获取 traceId，可跨路由跟踪调用链路。</li>
<li><strong>控制协议行为</strong>：可指定 HTTP status，而不影响业务 code。</li>
<li><strong>无框架侵入性</strong>：不需要全局 patch，路由自由决定是否使用。</li>
</ol>
<p>实际使用方式非常直接：在路由处理函数中调用该函数包裹输出即可：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/response"</span>;

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/user"</span>, <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> };
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, user);
});
</code></pre>
<p>输出结构：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h3 data-id="heading-28">错误处理</h3>
<p>hono.js 并没有 nest.js 中那样的 exception（异常）处理器，但 hono 官方提供了两个方法来处理全局异常。</p>
<ul>
<li>Error Handling 回调函数</li>
<li>Not Found 回调函数</li>
</ul>
<p>其中 <code>app.onError</code> 允许我们处理未捕获的错误并返回自定义响应。例如</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();
app.<span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err, c</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${err}</span>`</span>);
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">text</span>(<span class="hljs-string">"Custom Error Message"</span>, <span class="hljs-number">500</span>);
});
</code></pre>
<p>接下来我们实现一个生产级别的全局错误处理函数，代替上面的 onError 中的函数：</p>
<h4 data-id="heading-29">阶段一：只实现兜底，确保不会爆栈到框架</h4>
<p>目标：任何异常都返回 500，避免框架直接输出默认错误页面。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(
    {
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Internal Server Error"</span>,
    },
    <span class="hljs-number">500</span>,
  );
};
</code></pre>
<p>此阶段的函数虽然简陋，但实现了基本“拦截能力”。技术人员可以理解到：不允许异常直接泄漏给框架。</p>
<h4 data-id="heading-30">阶段二：支持错误分类（业务可控错误 vs 系统错误）</h4>
<p>需求出现：业务层需要显式抛出 4xx，不应该全部变成 500。因此我们引入 Hono 的 HTTPException。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> httpStatus = <span class="hljs-number">500</span>;
  <span class="hljs-keyword">let</span> message = <span class="hljs-string">"Internal Server Error"</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    message = exception.<span class="hljs-property">message</span>;
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ message }, httpStatus);
};
</code></pre>
<p>团队到此能看到两个差异：</p>
<ul>
<li>不再一刀切地用 500</li>
<li>支持框架级错误语义</li>
</ul>
<h4 data-id="heading-31">阶段三：支持普通 Error，并提取堆栈</h4>
<p>当后端代码抛出 Error 对象时，我们不希望把内部堆栈暴露给客户端，但日志需要保留：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  httpStatus = <span class="hljs-number">500</span>;
  message = exception.<span class="hljs-property">message</span>;
  stack = exception.<span class="hljs-property">stack</span>;
}
</code></pre>
<p>与第二阶段结合后，代码局部已经具备三类来源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
  <span class="hljs-comment">// 合法业务错误</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  <span class="hljs-comment">// 非预期系统错误</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 字符串或其他类型，兜底转字符串</span>
}
</code></pre>
<p>这一阶段解决“所有类型异常都能进入统一通路”。</p>
<h4 data-id="heading-32">阶段四：对外 Message 安全脱敏</h4>
<p>生产会提出安全要求：500 段错误不能暴露内部 message。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> userMessage =
  httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;
</code></pre>
<h4 data-id="heading-33">阶段五：加入 Trace ID，实现可观测能力</h4>
<p>在前几阶段之后，团队开始发现：仅凭日志很难定位请求调用链。因此引入 Trace ID：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;

<span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
</code></pre>
<p>并将其放入响应，用于 API 与日志上下游联动。</p>
<h4 data-id="heading-34">阶段六：构建统一响应协议</h4>
<p>现在错误信息、trace 信息都有了，我们需要形成一致返回结构，便于前端或 API 网关解析：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">message</span>: userMessage,
  <span class="hljs-attr">traceId</span>: traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
    <span class="hljs-attr">httpStatus</span>: httpStatus,
  },
};
</code></pre>
<p>这样可以回复格式统一的响应。</p>
<h4 data-id="heading-35">阶段七：结构化日志分级输出</h4>
<p>生产要求日志可检索、可告警，因此需要按状态区分 error 与 warn，并携带堆栈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: exceptionStack,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
} <span class="hljs-keyword">else</span> {
  logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
}
</code></pre>
<p>团队能看到：</p>
<ul>
<li>500+ 是告警级别</li>
<li>4xx 只是用户请求问题，不污染告警系统</li>
</ul>
<h4 data-id="heading-36">阶段八：最终闭环，按状态返回响应</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
</code></pre>
<p>请求闭环如下：</p>
<ol>
<li>识别异常</li>
<li>分类</li>
<li>安全脱敏</li>
<li>绑定 Trace</li>
<li>构建协议</li>
<li>结构化日志</li>
<li>返回状态码与响应体</li>
</ol>
<p>最终成果（合并段落）即为我们起初提供的完整生产代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"../logger"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Internal Server Error"</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionStack</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = <span class="hljs-title class_">String</span>(exception);
  }

  <span class="hljs-keyword">const</span> userMessage =
    httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;

  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalClientResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">message</span>: userMessage,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">error</span>: {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
      <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
      <span class="hljs-attr">httpStatus</span>: httpStatus,
    },
  };

  <span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">stack</span>: exceptionStack,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  } <span class="hljs-keyword">else</span> {
    logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
};
</code></pre>
<p>接下来我们来处理全局捕获的 404 回调，也就是自定义 Not Found Response, 个人感觉生产环境就简单返回 404 状态码就足够了，所以函数定义如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">notFoundHandler</span> = (<span class="hljs-params">c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Resource not found"</span> }, <span class="hljs-number">404</span>);
};
</code></pre>
<h2 data-id="heading-37">欢迎一起交流</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！]]></title>    <link>https://juejin.cn/post/7585948869844287523</link>    <guid>https://juejin.cn/post/7585948869844287523</guid>    <pubDate>2025-12-22T00:54:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844287523" data-draft-id="7585948869844271139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T00:54:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:54:24.000Z" title="Mon Dec 22 2025 00:54:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49ea03c767b44e8971a96bba6e0b289~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=BDEBBkHTzIu7CbRLN77rG5Cq0zw%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，原小道消息<code>PinK</code>将于<code>18号</code>公测，但是白天一整天迟迟未见。</p>
<p><strong>终于</strong>在晚上<code>19</code>点左右<code>PinK 0.0.1-alpha.1</code>版发布了！不过<code>alpha</code>测试仅对部分开发者开放：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e45ee02bfa545a4a847e9a79b92d084~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=TQX7g853na1zJ3jnU7BZ84gyneQ%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<p><strong>论坛</strong>瞬间炸开了锅，一码难求。</p>
<p><strong>笔者</strong>为了宠粉，鼓起勇气直接私信了产品经理，幸运地拿到了想要的码，连夜进行了测评。</p>
<p><strong>先</strong>看看简单的介绍：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9631f1e91524ae09a3378ef42718ccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=NVlWZSkh2MqZps0HRyK9OJHxZYU%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<p><strong>言归正传</strong>，小伙伴们跟随笔者，一起来体验下<code>PinK(Cocos4.0)</code>以及用它生成飞机大战实战全过程！</p>
<h2 data-id="heading-1">1. 安装和激活</h2>
<p><strong>下载</strong>完成后，直接解压运行<code>PinK.exe</code>，据说是基于<code>VSCode</code>开发，意味着坐拥<code>VSCode</code>所有插件！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2acc244dbb974779be7a1c65d10540bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=C9dv3tWEMwo5tfv5xFj5jB6lBmE%3D" alt="" loading="lazy"/></p>
<p><strong>首次</strong>打开需要填入我们拿到的码进行激活，粉红色的椰子头格外耀眼，符合主题<code>PinK</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333980f11a834aa5aaa9154bba1fcdb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Z55a%2B88PBlIRjVvQ3N%2BdyRtIL3E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">2. 界面</h2>
<p><strong>完整界面</strong>如下，非常熟悉了，大家看看都有啥！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2645cc7e25946e28b5e225c43ae3b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=fGRTVg%2B4uwkl8%2B5IXBAV%2BTMQHB0%3D" alt="" loading="lazy"/></p>
<p><strong>左上角</strong>一排图标分别是<code>Scene</code>(场景)、<code>Hierarchy</code>(层级管理器)、<code>Inspector</code>(属性检查器)、<code>Asset</code>(资源管理器)等等<code>Creator</code>常用的面板，不过目前测试点击无效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6e89f4f33e46279b7857599d188db1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=SZxz0AlceJ7xccg6ujL1f26ret0%3D" alt="" loading="lazy"/></p>
<p><strong>正上方</strong>的就是和<code>Creator</code>一样的运行工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6572a69682bb46c996a670b29acbc13e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=LKzyRb5Tthr%2FNgzWvSbYusq1GvI%3D" alt="" loading="lazy"/></p>
<p><strong>右上角</strong>也是一排工具按钮，不怎么见过，不介绍了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31b2c1236cf457fbb0ba78a93f5a29c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0BgflRrpbVa4QL01UUrNaYxzhOA%3D" alt="" loading="lazy"/></p>
<p><strong>其余剩下</strong>的部分就是与<code>VSCode</code>一致的，左侧资源管理器，右侧是我们的<code>AI</code>聊天面板。</p>
<h2 data-id="heading-3">3.安装SDK</h2>
<p><strong>使用之前</strong>要在<code>PinK</code>里面安装<code>cocos-sdk</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32b3fe92dcf34505bbf2977522b3d96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=4VM1cKcHbeRhK79H7tYr46H18gI%3D" alt="" loading="lazy"/></p>
<p><strong>总大小</strong>接近<code>5G</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8322c40aee74e12a986e81f1e2c0ec8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=vGMUUTEm4DlWdJvBiQxpIFp%2BN0s%3D" alt="" loading="lazy"/></p>
<p><strong>里面</strong>包括我们熟悉的引擎源码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cafbd1d9c24db69f1efd4baf404f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=OEQPPlgbDv5Y9bKnaCnDIUjLdWU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">4.PinK飞机大战实战</h2>
<p><strong>前面</strong>有关注笔者的小伙伴，笔者通过<code>DeepSeek</code>和生图软件去简单粗暴地开发一款飞机大战游戏，收获了非常多的点赞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca49bb8fd6224dd6af23ec92d53232b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Wwa%2Bm6SGyp9Xf%2FPuIzdRHzazfpc%3D" alt="" loading="lazy"/></p>
<p><strong>里面</strong>明确指出<code>AI</code>并不能通过<code>Chat</code>全自动利用<code>Creator</code>完成开发，还是要扎实掌握许多基本功，即使通过<code>AI</code>操作<code>Scene</code>文件和<code>Pfefab</code>文件，目前都还是比较难。</p>
<p><strong>下面</strong>我们用<code>PinK</code>实战对比，看看有什么不同。</p>
<h3 data-id="heading-5">1.创建工程</h3>
<p><strong>首先</strong>通过<code>Create Project</code>按钮创建我们的工程<code>PinkTest</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/138fc7bfe5084c7daf4e078332fbb76d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=8%2BvDYmLFkmfwwfsmC3MAgkws8nc%3D" alt="" loading="lazy"/></p>
<p><strong>创建</strong>完成后会自动生成我们熟悉的工程目录结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/379f0b06a83b43a984d97f19aefd094e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=BupbDMpD463qNwazfCq%2B3DQM9PQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.选择模型</h3>
<p><strong>目前</strong>测试阶段，<code>PinK</code>自掏腰包内置<code>Gemini3</code>，给予好评。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84a43d54c454087b030d1b02db7eda7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=doE%2FC15P7p9Z7ycoxGMtwA3Uwpw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.实战开始</h3>
<p><strong>二话</strong>不说，笔者先来个下马威：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31c26b13ce2c4e46812ab1bc34a1b5cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=GWxnONwEN3bPcX0KxPL%2BLFxsl40%3D" alt="" loading="lazy"/></p>
<p><strong>PinK</strong>反手就丢给我3个<code>md</code>文件，分别是：</p>
<ul>
<li><strong><code>GD.md</code></strong> : 游戏设计文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b8e84305294e44b78c20ded438d3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=pdwoOP9K7rHRWj74o9102uxxCJ4%3D" alt="" loading="lazy"/></li>
<li><strong><code>ART.md</code></strong> : 美术需求文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2bc4ca0212418a95e26e3a433a688d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=lyTo20gjvRDS3HbBQ9HfvkX4lCw%3D" alt="" loading="lazy"/></li>
<li><strong><code>TECH.md</code></strong> : 技术需求文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/441ffa45eaca4bfeba54dc19b5e03bd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=s3Z8OFJbSOSE3tw3Q5WRVuHmRo0%3D" alt="" loading="lazy"/></li>
</ul>
<p><strong>整体流程</strong>就靠上面<code>3</code>个文档驱动,生成完成后等待老板下发指令开工。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b93cc3f3105342e4ae10bc484b8026f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=h%2Fru26054r4M08x5HkVpTupZn4g%3D" alt="" loading="lazy"/></p>
<p><strong>由于</strong>笔者没有配置<code>API Key</code>，没办法直接生成所需的美术资源，一直卡在生成图片阶段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee92f5accaed4cbcbd13438b8c961f71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0ZY8iGDvlVi6LM9uRibnAZuEoYI%3D" alt="" loading="lazy"/></p>
<p><strong>只能</strong>重新让他先做好游戏，后续我再根据美术需求补充资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee736293b67f4fdf8e9980c10e6c5d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=N6tUVnbBLzS2h7m0xxhyQrZTHt8%3D" alt="" loading="lazy"/></p>
<p><strong>开启</strong><code>Auto Approve</code>之后，笔者就去洗漱了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d47812016f447fea6f1565376a510dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Vp6%2FsIBuryXN4GMK5alL9jl4Zj4%3D" alt="" loading="lazy"/></p>
<p><strong>回来</strong>时，他告诉我已经做好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a538c872e70a4d8783ec8cfa0dd39cc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=VeR58EjOvjBNYaPZekLGPhfQULE%3D" alt="" loading="lazy"/></p>
<p><strong>把</strong>我们上次生成的资源改成指定的名字放在指定目录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b37c44ef25644ee980fda940f8e37ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=N%2BKXov5l1ef1tby4cwmL09LnphA%3D" alt="" loading="lazy"/></p>
<p><strong>PinK神</strong>启动！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83fc5fe136ce476bbff264c5c0653d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0WmgHlhB2RcwKqC24kehoMG8L1M%3D" alt="" loading="lazy"/></p>
<p><strong>果不其然</strong>，事情并没有那么简单，运行之后一片空白。乍眼一看脚本还有报错。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bb77d26742046ce9965a7b4cb177697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=8q6VVuIr%2FqkEjc41%2Bv8QbmjWZqk%3D" alt="" loading="lazy"/></p>
<p><strong>笔者</strong>好奇地打开<code>Creator</code>看看生成的场景和节点长什么样，节点也没有生成(<strong>到后面发现其实是笔者搞错了场景</strong>)。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df5acb74dc6d4caabdbe3af581d62e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Ts0ab3twTkGk0SnC3BFZQrPJNDU%3D" alt="" loading="lazy"/></p>
<p><strong>于是</strong>我让他修复一下报错和挂载<code>GameManager</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9472eb89eda4a938a74ac90a0580620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=d9IJxkIM8kHetF9z9rbgpZbIQ6M%3D" alt="" loading="lazy"/></p>
<p><strong>打开</strong><code>Main</code>场景可以看到，节点已生成，代码也挂载好了(妥妥解决了痛点)。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7591f356852a4b1a977db7c09063654e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=os1WzRcQ1cmfQU936G9FIthIKD4%3D" alt="" loading="lazy"/></p>
<p><strong>最后</strong>让他运行游戏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68a43ac8d3d0478aba0c43655584076f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=y8A%2BX%2FVoEklVlxfC0yI7DqTm2dw%3D" alt="" loading="lazy"/></p>
<p><strong>在控制台</strong>可以清晰看到<code>Cocos Creator v4.0.0</code>字样，这是不是就说明<code>PinK</code>就是<code>Cocos4.0</code>?</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bed7892f534240bd97c6c08980c16299~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=l%2FwZrktYRrmlnVqtPEuiDHygXvk%3D" alt="" loading="lazy"/></p>
<p><strong>这次</strong>他自动打开了内置的简单浏览器，但是游戏画面还是没有出来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aac4b2b23f94a43a98ee821e2bfc6aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=RaH0y6AnxThPbjg7coyRoWEBJW8%3D" alt="" loading="lazy"/></p>
<p><strong>查看报错</strong>可以知道图片的导入格式不对。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/417de1c775db4ffdbefa7bb0af16a546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=R7zZQk7gw7ZX7Sjb8ndMyrXzf%2F8%3D" alt="" loading="lazy"/></p>
<p><strong>把</strong>报错信息复制过去，并且告诉他格式不对。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83dd69c0c0f54eb6b2238f5a866c189c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Ix76YYckAKbTQml9LC3lf2r9k1M%3D" alt="" loading="lazy"/></p>
<p><strong>然后</strong>他就自动调整格式了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef459388835e48a4b067e3e3d7ddfcf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=SNSNg9fu4XrDh%2FusF2cMgfxksCw%3D" alt="" loading="lazy"/></p>
<p><strong>最后运行</strong>，画面终于出来了，泪流满面，就是图片有点太大了，不太协调。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331804b18f9a43a586fd269cf4b1f74e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=3rkVdHntQ524Y6e9udziCHnImEA%3D" alt="" loading="lazy"/></p>
<p><strong>让他</strong>调小一点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94be9cd40845457fbd63489bc1bf3559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=JFVpFkDHU%2BUGzrpIMdtZ7%2BV1%2BrQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4.效果演示</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b8dedf74711414396f986c98ccc705f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=nPwt6IkztU907ZYc1FDxBxAj1ME%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">5.体验感受</h2>
<ul>
<li><strong>全程</strong>零代码、零编辑场景，全自动生成游戏(有引擎的)，虽然游戏简单，后面会尝试生成更复杂的游戏，欢迎关注。</li>
<li><strong>PinK</strong>并不只是代码编辑器，全程可以不需要写代码和打开<strong>Creator</strong>(笔者好奇自己打开)，根据界面布局推断，<strong>Creator</strong>的功能终将全部移植到<strong>PinK</strong>。</li>
<li><strong>由于</strong>只是<code>alpha</code>测试，看群里反馈的问题,<code>BUG</code>也不少，笔者觉得可以理解，需要点时间让它飞一会。</li>
<li><strong>此外PinK</strong>上手有点难度，一开始看会比较懵，不知道从哪里开始动手。</li>
<li><strong>笔者</strong>尝试用<code>PinK</code>打开旧的项目(Creator3.8.7)，也存在一些问题，都反馈到群里了。</li>
</ul>
<h2 data-id="heading-10">结语</h2>
<p><strong>总的</strong>来说，<code>PinK</code>让笔者眼前一亮，持看好态度，个人看法，轻喷！</p>
<p><strong>小伙伴们</strong>看完后觉得如何？还想笔者测评哪些内容？欢迎来评论区发表看法！</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南]]></title>    <link>https://juejin.cn/post/7586506307726491658</link>    <guid>https://juejin.cn/post/7586506307726491658</guid>    <pubDate>2025-12-22T11:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307726491658" data-draft-id="7586482860103827483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2025-12-22T11:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hboot"/> <meta itemprop="url" content="https://juejin.cn/user/2084329777543191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2084329777543191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hboot
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:25:34.000Z" title="Mon Dec 22 2025 11:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    33
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>TypeScript</code>现在的普及度已经很高了，虽然它是一种静态类型定义，但它的庞大已足够我们要向对待一门语言一样对待它了，去深入学习，以便更好的利用它的能力。</p>
<p>当然了，我们首先要明确为什么需要它，而不是把它当作一种负担：</p>
<ul>
<li>编译时类型检查，避免了运行时才检查的数据类型错误，导致系统奔溃。</li>
<li>提升开发效率，IDE基于类型系统提供了精准的代码补全、接口提示。减少了查询文档、查询API的成本。</li>
<li>增强了代码可读性，通过类型注解帮助成员快速理解函数输入、输出，降低了协作成本。</li>
</ul>
<h2 data-id="heading-0">类型系统基石</h2>
<p>像一门语言有基本的语法一样，<code>TypeScript</code>也有基本的类型定义，这些基本类型对应<code>JavaScript</code>中的基本数据类型，包括<code>number</code>、<code>string</code>、<code>boolean</code>、<code>null</code>、<code>undefined</code>、<code>symbol</code>、<code>bigint</code>、<code>object</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hboot"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">18</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`hello, <span class="hljs-subst">${name}</span>`</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">symbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"key"</span>);
</code></pre>
<h3 data-id="heading-1">空类型、任意类型、未知类型</h3>
<p><code>void</code>表示空类型，<code>any</code>表示任意类型，<code>unknown</code>表示未知类型。</p>
<ul>
<li><code>void</code> 常用于函数无返回值时的返回类型声明；</li>
<li><code>any</code> 表示任意类型，失去了类型检查的能力，非必要不要用；</li>
<li><code>unknown</code> 表示未知类型，可以用来代替<code>any</code>，但是它不能直接用，必须通过类型断言或类型守卫明确具体类型才能操作。</li>
<li><code>never</code> 表示没有任何类型，变量和函数返回不会存在任何实际值。它是所有类型的字类型，可以赋值给任意类型。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">noReturn</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
}

<span class="hljs-keyword">let</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">any</span> = <span class="hljs-string">"admin"</span>;
<span class="hljs-comment">// 可以任意赋值</span>
name = <span class="hljs-number">123</span>;
<span class="hljs-comment">// 甚至是当作函数调用,这导致开发不易发现，运行时才报错</span>
<span class="hljs-title function_">name</span>():

<span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-number">18</span>;
<span class="hljs-comment">// 类型为未知，无法直接操作</span>
age += <span class="hljs-number">10</span>;
<span class="hljs-comment">// 通过类型守卫，明确类型为 number</span>
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">'number'</span>) { 
    age += <span class="hljs-number">10</span>;
}
</code></pre>
<h2 data-id="heading-2">复合类型</h2>
<p>复合类型就是基础类型的组合，包括数组、对象、元组、枚举、类。</p>
<h3 data-id="heading-3">数组</h3>
<p>数组的类型定义<code>T[]</code>或<code>Array&lt;T&gt;</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 数组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">names</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>];
<span class="hljs-keyword">let</span> <span class="hljs-attr">names</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>];
</code></pre>
<h3 data-id="heading-4">对象</h3>
<p>对象类型定义对象的属性名、属性类型。属性支持可选、只读、索引签名。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 对象</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> } = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'hboot'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
}
</code></pre>
<h3 data-id="heading-5">元组</h3>
<p>元组是明确了数组长度以及元素类型的。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 元组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">userInfo</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>] = [<span class="hljs-string">'hboot'</span>, <span class="hljs-number">18</span>];
</code></pre>
<h3 data-id="heading-6">枚举</h3>
<p>枚举用于定义一组有特殊含义的常量，比如状态码、类型标识等。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 枚举</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
    <span class="hljs-title class_">Success</span> = <span class="hljs-number">200</span>,
    <span class="hljs-title class_">Fail</span> = <span class="hljs-number">500</span>
}
</code></pre>
<p>未赋值时，枚举值从 0 开始递增。如果自定义了开始值，则后面的值递增。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
  <span class="hljs-title class_">Success</span>, <span class="hljs-comment">// 0</span>
  <span class="hljs-title class_">Fail</span> <span class="hljs-comment">// 1</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
  <span class="hljs-title class_">Success</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">// 1</span>
  <span class="hljs-title class_">Fail</span> <span class="hljs-comment">// 2</span>
}
</code></pre>
<p>可以通过<code>const enum</code>修饰枚举定义，在编译时仅保留常量值，减少代码体积。</p>
<h3 data-id="heading-7">类<code>Class</code></h3>
<p>类<code>class</code>是面向对象编程的核心。es6中已经增强了对类的支持，可以通过类定义对象，明确属性、方法。类不仅可以用来创建实例，也可以作为类型注解描述实例类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
</code></pre>
<p>类的定义包括实例属性、实例方法、静态属性、静态方法，同时还支持通过访问修饰符控制成员可见。</p>
<p>子类可以通过<code>extends</code>继承父类的非<code>private</code>成员，重写父类方法。<strong>仅能继承一个父类。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">WangWang</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"WangWang"</span>;
  }
}
</code></pre>
<p>类可以通过<code>implements</code>实现接口，用于约束类的实现，包括属性、方法，仅约束结构，不提供实现。<strong>可实现多个接口</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WangWang"</span>);
  }
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
</code></pre>
<p>通过<code>abstract</code>关键字可以声明抽象类，抽象类不能被实例化。它只定义了字段、方法结构，未实现具体逻辑，它仅可被子类继承，并需要实现它定义的所有抽象成员。</p>
<h2 data-id="heading-8">高级类型</h2>
<p>基础类型可以满足绝大多数业务，但面对复杂业务需要类型复用、条件判断、属性筛选则需要高级类型。</p>
<h3 data-id="heading-9">复用类型</h3>
<p>为了复用类型，可以通过<code>type</code> \ <code>interface</code>定义类型。<code>type</code>可以定义任意类型，包括基础类型、复合类型、联合类型等，比较灵活；<code>interface</code> 只能定义对象类型,但是可以<code>继承</code>和<code>同名合并</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// type</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Age</span> = <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-title class_">Age</span>;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">'success'</span> | <span class="hljs-number">200</span>;

<span class="hljs-comment">// interface</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SuperUser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> { 
    <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><code>interface</code> 不同于类<code>class</code>,它可以继承多个接口。</p>
<h3 data-id="heading-10">联合/交叉类型</h3>
<p>联合类型通过<code>|</code>表示变量可以是任意其中一种类型；交叉类型通过<code>&amp;</code>表示变量必须同时满足多个类型。</p>
<p>联合类型使用时需要类型守卫明确类型后才能操作,如果变量已经赋值，则会自动推导出类型；</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Age</span> = <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-title class_">Age</span> = <span class="hljs-number">18</span>;
age+=<span class="hljs-number">2</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">agePlus</span>(<span class="hljs-params">age: Age</span>){ 
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">'number'</span>){ 
        age+=<span class="hljs-number">2</span>;
    }
    <span class="hljs-keyword">return</span> age;
}
</code></pre>
<p>交叉类型常用合并对象类型，需要满足所有类型条件。<strong>如果无法满足所有类型条件，则该类型为<code>never</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Address</span> = { 
    <span class="hljs-attr">address</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserAddress</span> = <span class="hljs-title class_">User</span> &amp; <span class="hljs-title class_">Address</span>;
</code></pre>
<h3 data-id="heading-11">泛型</h3>
<p>泛型是将类型参数化，可以不指定具体类型来定义函数、类、接口。在使用时在传入具体类型，它可以高度抽象定义类型，保障类型复用和类型安全。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 函数泛型</span>
<span class="hljs-keyword">function</span> getData&lt;T&gt;(<span class="hljs-attr">data</span>: T): T {
    <span class="hljs-keyword">return</span> data;
}

<span class="hljs-comment">// 接口泛型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IData</span>&lt;T&gt; {
    <span class="hljs-attr">data</span>: T;
}

<span class="hljs-comment">// 类泛型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>&lt;T&gt; {
    <span class="hljs-attr">data</span>: T[] = [];
}
</code></pre>
<p>因为不知道具体类型，就无法获知这个类型有什么属性，可以调用什么方法。为了使用某个属性或者某个方法，我们使用泛型约束来指定这个类型必须有哪些属性或者方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> getData&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt;(<span class="hljs-attr">data</span>: T): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> data.<span class="hljs-property">name</span>;
}
</code></pre>
<p>在调用具有泛型的类型时，需要传递具体类型，有时候这个泛型我们知道在很多情况下就是某一个类型，避免重复传入，我们可以指定泛型的默认类型，从而在使用时不再需要传入。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">function</span> getData&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">User</span>&gt;(<span class="hljs-attr">data</span>: T): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">name</span>;
}
</code></pre>
<p>泛型约束和默认类型不需要同时出现，也可以定义其一，根据需求使用。</p>
<h2 data-id="heading-12">类型运算</h2>
<p>除了定义具体类型，还可以通过类型运算从一个类型得到一个新的类型。也可以称之为推导，从一个类型推导为另一个类型。类型运算也是导致一些复杂类型产生的因素。</p>
<h3 data-id="heading-13">类型守卫</h3>
<p>类型守卫是在运行时判断数据类型，它可以精准到具体类型，用于类型收窄，包括<code>unknown</code>、联合类型、类继承。关键字包括<code>typeof</code> <code>instanceof</code> <code>in</code> <code>is</code></p>
<p><strong><code>typeof</code> 用于判断基础类型。但是无法判断 <code>null</code>，<code>typeof null</code> 返回 <code>'object'</code>，可通过<code>value!==null</code> 进行判断。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">agePlus</span>(<span class="hljs-params">age: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">"number"</span>) {
    age += <span class="hljs-number">2</span>;
  }
  <span class="hljs-keyword">return</span> age;
}
</code></pre>
<p><strong><code>instanceof</code> 判断是否为某个类实例。</strong></p>
<pre><code class="hljs language-ts" lang="ts">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">WangWang</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"WangWang"</span>;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">MiaoMiao</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"MiaoMiao"</span>;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">animal: Animal</span>) {
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Dog</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>:<span class="hljs-subst">${animal.WangWang()}</span>`</span>;
  }
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cat</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>:<span class="hljs-subst">${animal.MiaoMiao()}</span>`</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>`</span>;
}
</code></pre>
<p><strong><code>in</code> 适用于对象类型定义，用于判断是否包含某个属性</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">d</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAttr</span>(<span class="hljs-params">animal: Dog | Cat</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> animal) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">a</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">"d"</span> <span class="hljs-keyword">in</span> animal) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">c</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown"</span>;
}
</code></pre>
<p><strong><code>is</code> 用于精准明确是什么类型，但是判断逻辑是我们自己写的，这就要求我们判断逻辑要精确，否则可能导致运行时错误。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">d</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 内部逻辑自定义判断是否为某个类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDog</span>(<span class="hljs-params">animal: Dog | Cat</span>): animal is <span class="hljs-title class_">Dog</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> animal;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAttr</span>(<span class="hljs-params">animal: Dog | Cat</span>) {
  <span class="hljs-comment">// 调用时如果为true，则推导为Dog</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDog</span>(animal)) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">a</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">c</span>;
  }
}
</code></pre>
<h3 data-id="heading-14">类型断言</h3>
<p>类型断言是将一个类型临时转为另一个类型，仅在编译阶段告诉TypeScript是什么类型，不能改变变量的实际类型。</p>
<p>类型断言需要开发者明确保证断言类型正确，否则可能会导致运行时异常。对于不确定的类型，因该优先使用<code>类型守卫</code>.</p>
<p><strong>使用<code>as</code>断言类型，可以转<code>unknown</code>类型、父类型转子类型场景。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-number">34</span>;
<span class="hljs-comment">// 可以断言类型为string，从而调用字符串的方法。</span>
<span class="hljs-comment">// 但是在运行时会报错</span>
(age <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>).<span class="hljs-title function_">toUpperCase</span>();
</code></pre>
<p>还可以通过<code>as const</code>断言为只读常量，常用于固定值的类型约束。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 类型为 string</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span>;

<span class="hljs-comment">// 类型为字面量 "hboot" 类型</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
</code></pre>
<p><strong>使用<code>!</code>断言非空，常用于访问某个可选属性时，断言非空</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">c</span>: <span class="hljs-number">20</span>,
};
<span class="hljs-comment">// 未断言时调用报错属性 d 可能未定义</span>
<span class="hljs-comment">// cat.d.toUpperCase();</span>

<span class="hljs-comment">// 断言非空后则不会再提时报错，但是运行时报错 </span>
cat.<span class="hljs-property">d</span>!.<span class="hljs-title function_">toUpperCase</span>();
</code></pre>
<blockquote>
<p>所以，断言要谨慎使用、避免滥用，确保断言的类型是是实际数据类型的兼容类型。</p>
</blockquote>
<p><strong>还可以通过双层断言将一个明确的类型断言为另一个类型。</strong></p>
<p>这个操作很危险，实例中将<code>string</code>类型断言为<code>Cat</code>对象类型去访问属性<code>c</code>,编译通过，运行时爆炸。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">let</span> name = <span class="hljs-string">"hboot"</span>;

(name <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Cat</span>).<span class="hljs-property">c</span>;
</code></pre>
<h3 data-id="heading-15">运算符</h3>
<p>运算符可以从一个类型的到另一个类型。<code>类型安全</code>，类型运算的操作有很多</p>
<p><strong><code>keyof</code> 得到对象类型的所有字段<code>key</code>类型构成的联合类型。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-comment">// 得到 Cat 的所有字段 key 类型 联合类型 "d" | "c"</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Keys</span> = keyof <span class="hljs-title class_">Cat</span>;

<span class="hljs-comment">// 如果字段是索引签名，则返回索引签名的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">unknown</span>;
};
<span class="hljs-comment">// 得到的是索引签名类型 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Keys</span> = keyof <span class="hljs-title class_">Cat</span>;
</code></pre>
<p><strong><code>typeof</code> 之前再类型守卫里已经介绍过了，它可以返回变量的类型（基本类型）。</strong></p>
<p><strong>索引访问（IndexedAccessType）获取类型,比如我们要获取对象类型里某个字段的类型，就可以使用索引获取。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 获取字段类型为 string，但由于字段是可选 ？，</span>
<span class="hljs-comment">// 所以返回的是 string | undefined</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[<span class="hljs-string">"d"</span>];
</code></pre>
<p>也可以通过联合类型获取到多个字段的类型，结果为一个联合类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[<span class="hljs-string">"d"</span>|<span class="hljs-string">"c"</span>]

<span class="hljs-comment">// 如果想要获取所有字段类型,可以通过keyof 获取到所有key的联合类型</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[keyof <span class="hljs-title class_">Cat</span>]
</code></pre>
<p>索引最重要的一点是可以对数组、元组元素的类型索引获取.</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> names = [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>];
<span class="hljs-comment">// 索引第一个元素的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = names[<span class="hljs-number">0</span>];

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Names</span> = <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;;
<span class="hljs-comment">// 索引数组元素的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = <span class="hljs-title class_">Names</span>[<span class="hljs-built_in">number</span>];
</code></pre>
<p>还可以搭配<code>typeof</code> 对变量的类型进行索引获取。</p>
<p><strong>条件类型（ConditionalType），通过输入的类型，决定输出类型</strong>，通过<code>extends</code>关键字和三元表达式来标识。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-built_in">string</span> : <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 输入泛型参数返回类型，</span>
<span class="hljs-comment">// 输出类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Admin</span> = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">string</span>&gt;;
<span class="hljs-comment">// 输出类型为 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">unknown</span>&gt;;
</code></pre>
<p>也可以声明一个函数书写更复杂的判断逻辑。既然通过<code>extends</code>关键字以及泛型参数，那么也可以增加泛型约束、泛型默认值。</p>
<p><strong>映射类型（MappedType）,从一个类型创建一个新类型</strong>,建立在索引签名语法之上,通过对对象的字段键值、字段类型进行转换操作。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ToFunction</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-function">() =&gt;</span> T[K];
};

<span class="hljs-comment">// 从基本类型转换成函数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CatFunction</span> = <span class="hljs-title class_">ToFunction</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 *  type CatFunction = {
 *    name?: (() =&gt; string | undefined) | undefined;
 *    age: () =&gt; number;
 *  }
 */</span>
</code></pre>
<p><strong>文本类型（LiteralType）</strong>，通过扩展字符串生成文本类型，表现同字符串字面值相同。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = <span class="hljs-string">"hboot"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GoodName</span> = <span class="hljs-string">`Good, <span class="hljs-subst">${Name}</span>`</span>;
</code></pre>
<p>利用文本类型扩展，可以结合映射类型，改变键值，得到一个全新的类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToFunction</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> <span class="hljs-string">`on_<span class="hljs-subst">${<span class="hljs-built_in">string</span> &amp; K}</span>`</span>]: <span class="hljs-function">() =&gt;</span> T[K];
};

<span class="hljs-comment">// 就会得到不同键值、不同类型的新对象类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CatFunction</span> = <span class="hljs-title class_">ToFunction</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 *  type CatFunction = {
 *    on_name?: (() =&gt; string | undefined) | undefined;
 *    on_age: () =&gt; number;
 *  }
 */</span>
</code></pre>
<p><strong><code>infer</code> 类型推断</strong>，通常用于泛型参数推导；函数返回值类型推导</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Array</span>&lt;infer U&gt; ? U : T;

<span class="hljs-comment">// 条件类型推导 得到数组元素类型 string</span>
<span class="hljs-keyword">type</span> str = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">string</span>[]&gt;;
<span class="hljs-comment">// 非数组类型，返回原类型 { name: string }</span>
<span class="hljs-keyword">type</span> info = <span class="hljs-title class_">Name</span>&lt;{ <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt;;
</code></pre>
<h3 data-id="heading-16">内置工具函数</h3>
<p>除了上述我们要手动去实现逻辑从而创建新的类型外，提供了内置函数可以直接使用，这些工具提供一些常用的类型转换逻辑。</p>
<p><strong><code>Partial&lt;T&gt;</code> 得到一个新类型，定义类型所有的字段都是可选的，与之相反的是<code>Required&lt;T&gt;</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 *   age?: number;
 * }
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">RequiredCat</span> = <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 * type RequiredCat = {
 *   name: string;
 *   age: number;
 * }
 */</span>
</code></pre>
<p><strong><code>Pick&lt;T,Keys&gt;</code> 从一个类型中选择某些字段得到一个新类型，<code>Omit&lt;T,Keys&gt;</code>从一个类型中删除某些字段得到一个新类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Cat</span>, <span class="hljs-string">'name'</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 * }
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">Cat</span>, <span class="hljs-string">'age'</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 * }
 */</span>
</code></pre>
<p><strong><code>Readonly&lt;T&gt;</code> 得到一个新类型，定义类型所有的字段都是只读的,初始化后不可以修改</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyCat</span> = <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">ReadonlyCat</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"hboot"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
};

<span class="hljs-comment">// 报错，不可以修改再赋值，属性是只读的</span>
<span class="hljs-comment">// cat.age = 20;</span>
</code></pre>
<p>它没有与之相反定义的工具，怎么处理让所有只读属性都变为可编辑的呢？还记得上面讲过的<strong>映射类型</strong>吗？</p>
<p>在映射类型中通过使用<code>-</code>符号将所有字段的<code>readonly</code>修饰符都移除掉</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MutableType</span>&lt;T&gt; = {
  -<span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof T]: T[K];
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">MutableType</span>&lt;<span class="hljs-title class_">ReadonlyCat</span>&gt; = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"hboot"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
};

<span class="hljs-comment">// 通过映射类型 -readonly 移除掉属性的只读修饰符</span>
cat.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>;
</code></pre>
<p><strong><code>Record&lt;Keys,T&gt;</code> 可以创建一个由<code>Keys</code>组成的属性对应类型为<code>T</code>的对象类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Animal</span> = <span class="hljs-title class_">Record</span>&lt;
  <span class="hljs-string">"dog"</span> | <span class="hljs-string">"cat"</span>,
  {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  }
&gt;;

<span class="hljs-comment">/**
 * type Animal = {
 *   dog: {
 *     name: string;
 *     age: number;
 *   };
 *   cat: {
 *     name: string;
 *     age: number;
 *  }; 
 * }
 */</span>
</code></pre>
<p><strong><code>Exclude&lt;U,T&gt;</code>从指定联合类型<code>U</code>排除某个满足 <code>T</code>类型的成员，得到新类型；与之相反的是<code>Extract&lt;U,T&gt;</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Type</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-string">"name"</span> | <span class="hljs-string">"age"</span> | <span class="hljs-number">32</span>, <span class="hljs-built_in">number</span> | <span class="hljs-string">"name"</span>&gt;;

<span class="hljs-comment">/**
 * type Type = "age"
 */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Type</span> = <span class="hljs-title class_">Extract</span>&lt;<span class="hljs-string">"name"</span> | <span class="hljs-string">"age"</span> | <span class="hljs-number">32</span>, <span class="hljs-built_in">number</span> | <span class="hljs-string">"name"</span>&gt;;
<span class="hljs-comment">/**
 * type Type = "name" | 32
 */</span>
</code></pre>
<p><strong><code>NonNullable&lt;Type&gt;</code>排除<code>null</code>和<code>undefined</code>的成员，得到新类型</strong></p>
<p><strong><code>Parameters&lt;Type&gt;</code> 从函数类型提取函数的参数类型，得到一个元组类型</strong>,非函数类型定义得到<code>never</code>类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">Fun</span>&gt;;
<span class="hljs-comment">/**
 * type Params = [name: string, age: number]
 */</span>
</code></pre>
<p><strong><code>ConstructorParameters&lt;Type&gt;</code> 从构造函数类型提取构造函数的参数类型，得到一个元组类型或数组类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FunConstructorParams</span> = <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-title class_">FunctionConstructor</span>&gt;;
<span class="hljs-comment">/**
 * type FunConstructorParams = string[]
 */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ErrorConstructorParams</span> = <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-title class_">ErrorConstructor</span>&gt;;
<span class="hljs-comment">/**
 * type ErrorConstructorParams =  [message?: string, options?: ErrorOptions]
 */</span>
</code></pre>
<p><strong><code>ReturnType&lt;Type&gt;</code> 从函数类型提取函数的返回值类型</strong>,对于非函数类型会得到<code>any</code>.</p>
<p><strong><code>Awaited</code> 用来获取异步函数的返回值类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span> }&gt;;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunType</span> = <span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">Fun</span>&gt;&gt;;
<span class="hljs-comment">/**
 * type FunType = {
 *   data: string;
 * }
 */</span>
</code></pre>
<p><strong><code>InstanceType&lt;Type&gt;</code> 从构造函数类型提取构造函数的实例类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-keyword">new</span> () =&gt; { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> };

<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunType</span> = <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-title class_">Fun</span>&gt;;
<span class="hljs-comment">/**
 * type FunType = {
 *   name: string;
 * }
 */</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">AnimalType</span> = <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Animal</span>&gt;;
<span class="hljs-comment">/**
 * type AnimalType = Animal
 */</span>
</code></pre>
<p><strong><code>NoInfer&lt;T&gt;</code>阻止从该处推导泛型参数类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> compare&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt;(<span class="hljs-attr">a</span>: T[], b?: <span class="hljs-title class_">NoInfer</span>&lt;T&gt;) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b);
}

<span class="hljs-comment">// 锁定了泛型 T 类型是 "admin" | "test" , 所以传入参数 "hboot" 会提示报错</span>
<span class="hljs-comment">// 如果没有 NoInfer 则不会报错，推断类型 string</span>
<span class="hljs-title function_">compare</span>([<span class="hljs-string">"admin"</span>, <span class="hljs-string">"test"</span>], <span class="hljs-string">"hboot"</span>);

</code></pre>
<p><strong><code>ThisParameterType&lt;T&gt;</code> 提取函数类型中的<code>this</code>参数的类型</strong>，如果没有<code>this</code>参数则返回<code>unknown</code></p>
<p><strong><code>OmitThisParameter&lt;Type&gt;</code> 移除函数类型中的<code>this</code>参数，得到一个新的函数类型</strong>，如果没有<code>this</code>参数或不是函数类型则返回类型本身。</p>
<p><strong><code>ThisType&lt;Type&gt;</code> 用于指定方法上下文中的<code>this</code>类型，不会返回新类型</strong>,指定后在方法中就可以通过<code>this</code>访问到指定属性。但是需要开启<code>noImplicitThis</code>（tsconfig.json）标志才可以使用。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span>;
} &amp; <span class="hljs-title class_">ThisType</span>&lt;<span class="hljs-title class_">Animal</span>&gt;;

<span class="hljs-keyword">const</span> <span class="hljs-attr">dog</span>: <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 通过this 可以访问到 name 属性</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
};
</code></pre>
<p><strong>文本类型工具，用于处理文本，包括:</strong></p>
<ul>
<li><code>Uppercase&lt;StringType&gt;</code>  将字符串转换为大写</li>
<li><code>Lowercase&lt;StringType&gt;</code> 将字符串转换为小写</li>
<li><code>Capitalize&lt;StringType&gt;</code> 将字符串的第一个字符转换为大写</li>
<li><code>Uncapitalize&lt;StringType&gt;</code> 将字符串的开头字符转换为小写</li>
</ul>
<h2 data-id="heading-17">命名空间</h2>
<p>通过关键字<code>namespace</code> 定义空间名，用于分组相关的类型和值，避免命名冲突。并可通过<code>export</code>导出供外部使用</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Hboot</span> {
  <span class="hljs-comment">//外部无法访问</span>
  <span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

  <span class="hljs-comment">// 外部可以访问</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> name;
  }
}

<span class="hljs-title class_">Hboot</span>.<span class="hljs-title function_">getName</span>();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回顾计算属性的缓存与监听的触发返回结果]]></title>    <link>https://juejin.cn/post/7586879894207922239</link>    <guid>https://juejin.cn/post/7586879894207922239</guid>    <pubDate>2025-12-23T09:13:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207922239" data-draft-id="7533501485156368418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回顾计算属性的缓存与监听的触发返回结果"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T09:13:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回顾计算属性的缓存与监听的触发返回结果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:13:55.000Z" title="Tue Dec 23 2025 09:13:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>网上的给出的区别有很多，今天只是简单来回归下其中的一些流程和区别的关键点。</p>
<p><strong>以下面的代码为例进行思考：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"calc"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">"n1"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"数字1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">"n2"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"数字2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>和：{{ sum }} 平均值：{{ avg }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{color: tipColor}"</span>&gt;</span>{{ tip }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">n1</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">n2</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">tip</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">tipColor</span>: <span class="hljs-string">'#333'</span> }
    },
    <span class="hljs-attr">computed</span>: {
      <span class="hljs-title function_">sum</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">n1</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">n2</span> },
      <span class="hljs-title function_">avg</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sum</span> / <span class="hljs-number">2</span> }
    },
    <span class="hljs-attr">watch</span>: {
      <span class="hljs-title function_">name</span>(<span class="hljs-params">v</span>) {
        <span class="hljs-keyword">if</span> (!v.<span class="hljs-title function_">trim</span>()) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'不能为空'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'red'</span> }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v.<span class="hljs-property">length</span> &lt; <span class="hljs-number">3</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'不少于3位'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'orange'</span> }
        <span class="hljs-keyword">else</span> { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'可用'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'green'</span> }
      }
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.calc</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>; <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto; }
  <span class="hljs-selector-tag">input</span> { <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">8px</span> <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">6px</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>关于 watch 和 computed 的使用我们很多，这里我们不一一介绍，<strong>但是请记住：监听是不需要 return 的，计算属性是百分百必须要有的。</strong></p>
<h2 data-id="heading-1">1、监听和计算属性的区别</h2>
<h4 data-id="heading-2"><strong>最关键的区别：</strong></h4>
<p><strong>1、监听是没有缓存的，计算属性是有缓存的</strong></p>
<p><strong>2、监听是不需要有返回值的，但是机损属性是必须要有返回值的。（极限情况下不return基本没意义）</strong></p>
<p><strong>其他的区别：</strong></p>






























<table><thead><tr><th><strong>对比维度</strong></th><th><strong>计算属性（computed）</strong></th><th><strong>监听器（watch）</strong></th></tr></thead><tbody><tr><td><strong>核心用途</strong></td><td>基于已有数据<strong>推导 / 计算新数据</strong>（数据转换 / 组合）</td><td>监听已有数据的<strong>变化</strong>，执行异步操作或复杂逻辑（无新数据产出，侧重 “副作用”）</td></tr><tr><td><strong>依赖关系</strong></td><td>只能依赖 Vue 实例中的响应式数据（<code>data</code>/<code>props</code>/ 其他 <code>computed</code>），自动感知依赖变化</td><td>可监听单个响应式数据、对象属性、数组，甚至通过 <code>deep: true</code>监听对象深层变化，支持手动指定监听目标</td></tr><tr><td><strong>使用场景</strong></td><td>1. 简单数据拼接（如全名：<code>firstName + lastName</code>）2. 数据格式化（如时间戳转日期字符串）3. 依赖多数据的计算（如总价：<code>price * count</code>）4. 需缓存的重复计算场景</td><td>1. 异步操作（如监听输入框变化，延迟请求接口获取联想数据）2. 复杂逻辑处理（如监听用户状态变化，同步更新权限菜单）3. 监听对象深层变化（如监听表单对象，统一处理提交前校验）4. 数据变化后的联动操作（非数据推导类）</td></tr><tr><td><strong>是否支持异步</strong></td><td>不支持异步操作：若在 <code>computed</code>中使用异步（如定时器、接口请求），无法正确返回推导结果，会得到 <code>undefined</code></td><td>支持异步操作：这是 <code>watch</code>的核心优势之一，可在监听函数中执行任意异步逻辑</td></tr></tbody></table>
<h2 data-id="heading-3">2： 监听和计算属性的基本触发流程：</h2>
<h3 data-id="heading-4">核心逻辑：<code>set</code> → <code>Dep</code> → <code>Watcher</code> → <code>watch</code>/<code>computed</code> 联动流程</h3>
<p>无论是 <code>watch</code> 还是 <code>computed</code>，底层联动流程的核心一致，<strong>仅在</strong> <code>Watcher</code> <strong>执行逻辑上有差异</strong>，完整流程如下：</p>
<h3 data-id="heading-5">第一步：初始化阶段 —— 依赖收集（<code>get</code> 拦截器 + <code>Dep</code> + <code>Watcher</code> 绑定）</h3>
<ol>
<li><code>computed</code> ****<strong>的依赖收集</strong>：</li>
</ol>

<ol>
<li>组件初始化时，会为每个计算属性创建一个「计算属性 <code>Watcher</code>」；
1.  执行计算属性的 <code>get</code> 方法，访问依赖的响应式数据（如 <code>this.num1</code>）；
1.  触发该数据的 <code>get</code> 拦截器，<code>get</code> 拦截器会将当前「计算属性 <code>Watcher</code>」添加到该数据的 <code>Dep</code> 依赖列表中；
1.  所有依赖数据都完成 <code>Watcher</code> 绑定，最终缓存计算属性的初始结果。</li>
</ol>

<ol start="2">
<li><code>watch</code> ****<strong>的依赖收集</strong>：</li>
</ol>

<ol>
<li>
<ol>
<li>组件初始化时，会为每个 <code>watch</code> 监听目标创建一个「普通 <code>Watcher</code>」；</li>
<li>主动读取一次监听目标数据（如 <code>this.username</code>），触发该数据的 <code>get</code> 拦截器；</li>
<li><code>get</code> 拦截器将当前「普通 <code>Watcher</code>」添加到该数据的 <code>Dep</code> 依赖列表中；</li>
<li>若开启 <code>deep: true</code>，会递归遍历对象 / 数组的内部属性，完成深层依赖收集。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-6">第二步：更新阶段 ——<code>set</code> 拦截器触发 <code>Watcher</code> 执行</h3>
<p>当修改响应式数据时（如 <code>this.num1 = 10</code>），触发底层联动：</p>
<ol>
<li>数据被修改，触发该数据的 <code>set</code> 拦截器；</li>
<li><code>set</code> 拦截器调用对应 <code>Dep</code> 的 <code>notify()</code> 方法（派发更新通知）；</li>
<li><code>Dep</code> 遍历自身的依赖列表，通知所有绑定的 <code>Watcher</code>「数据已更新」；</li>
<li>不同类型的 <code>Watcher</code> 接收通知后，执行差异化操作（这是 <code>watch</code> 和 <code>computed</code> 表现不同的核心原因）：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>普通</strong> <code>Watcher</code> <strong>（对应</strong> <code>watch</code> <strong>）</strong> ：收到通知后，<strong>立即执行</strong> <code>watch</code> <strong>的回调函数</strong>，传入 <code>newVal</code> 和 <code>oldVal</code>，执行异步 / 复杂逻辑；</li>
<li><strong>计算属性</strong> <code>Watcher</code> <strong>（对应</strong> <code>computed</code> <strong>）</strong> ：收到通知后，<strong>仅将自身标记为「脏状态」（缓存失效）</strong> ，不立即执行计算逻辑，等待下次访问计算属性时，才重新执行 <code>get</code> 方法计算新结果并更新缓存。</li>
</ul>
</li>
</ul>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-attr">watch</span>: {
    <span class="hljs-title function_">num</span>(<span class="hljs-params">newVal, oldVal</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`【watch】：num从<span class="hljs-subst">${oldVal}</span>变为<span class="hljs-subst">${newVal}</span>，我立即执行回调`</span>);
    }
  },
</code></pre>
<p>当 set 触发 watcher 后，watcher 就会立即触发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">num</span>(<span class="hljs-params">newVal, oldVal</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`【watch】：num从<span class="hljs-subst">${oldVal}</span>变为<span class="hljs-subst">${newVal}</span>，我立即执行回调`</span>);
    }
</code></pre>
<p><strong>什么叫</strong> <strong>收到通知后，</strong> <strong>仅将自身标记为「脏状态」（缓存失效）</strong> <strong>，不立即执行计算逻辑，等待下次访问计算属性时，才重新执行</strong> <code>get</code> <strong>方法计算新结果并更新缓存。</strong></p>
<p><strong>举个例子：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这里就是「访问计算属性」：模板渲染时会读取 numDouble 的值 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"num &lt; 2"</span>&gt;</span>两倍数：{{ numDouble }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">num</span>: <span class="hljs-number">1</span> };
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"计算属性执行计算"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
    },
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = <span class="hljs-number">5</span>; <span class="hljs-comment">// 2秒后，v-if不成立</span>
  }, <span class="hljs-number">2000</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 4秒后，v-if再次成立</span>
  }, <span class="hljs-number">4000</span>);
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

// 控制台只会打印2次“计算属性执行
</code></pre>
<p><strong>为什么只打印 2 次：</strong></p>
<p><strong>原因就是我们的计算属性在 2s 后没有执行</strong></p>
<p><strong>1、 当初始化时，页面中 v-if 条件是符合的，会执行一次 get 计算得到返回值</strong></p>
<p><strong>2、当经过两秒后、</strong> <strong>v-if 不符合条件，这个时候表明numDouble 是脏数据，会对其进行标记（</strong> <strong>v-if 不符合条件，所以无法对numDouble 进行访问，</strong> <strong>这里也就是我们说的缓存，缓存计算属性的结果值，当脏状态取消时才会进行新的计算</strong> <strong>)</strong></p>
<p><strong>3、当 经过 4 秒后条件再次被满足时，才会有新的计算。</strong></p>
<h2 data-id="heading-7">3： 计算属性为什么不能异步</h2>
<p><strong>举个例子，我们使用延时进行模仿：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这里就是「访问计算属性」：模板渲染时会读取 numDouble 的值 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"num &lt; 2"</span>&gt;</span>两倍数：{{ numDouble }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">num</span>: <span class="hljs-number">1</span> };
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
      }, <span class="hljs-number">1000</span>);
    },
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">numDouble</span>);
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>打印结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e5f59c20b284dd38f6f7325a9e275cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouJ5LiN5Yqo55qE54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086035&amp;x-signature=2Wg17EQIry85cV7xM1hV0RJP8W4%3D" alt="" loading="lazy"/></p>
<p>为什么会打印 underfined 呢，这里有两个原因？</p>
<h3 data-id="heading-8">原因 1：JavaScript 中，任何函数如果没有显式写 <code>return</code> 语句，或 <code>return</code> 后没有跟随具体值，都会默认返回 <code>undefined</code>，这是计算属性返回 <code>undefined</code> 的基础原因。</h3>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-number">11</span>;
        }, <span class="hljs-number">1000</span>);
      }
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">test</span>());
      }, <span class="hljs-number">2000</span>);
</code></pre>
<p>这样写是属于语法的错误。</p>
<h3 data-id="heading-9">原因 2：setTimeout 的异步特性（关键）</h3>
<p>即使你在 <code>setTimeout</code> 回调中写了 <code>return this.num * 2</code>，这个返回值也毫无意义，因为 <code>setTimeout</code>是<strong>异步宏任务</strong>：</p>
<ol>
<li>当 Vue 访问 <code>this.numDouble</code> 时，会立即执行计算属性的函数体；</li>
<li>函数体执行到 <code>setTimeout</code> 时，只会「注册一个异步任务」，然后直接跳过 <code>setTimeout</code> 继续执行；</li>
<li>此时计算属性函数体已经执行完毕（没有显式 <code>return</code>），默认返回 <code>undefined</code>，并被 <code>console.log</code> 打印；</li>
<li>1 秒后，<code>setTimeout</code> 的回调函数才会执行，此时回调中的 <code>return this.num * 2</code> 只是回调函数自身的返回值，无法传递给计算属性，也无法改变之前已经返回的 <code>undefined</code>。</li>
</ol>
<p><strong>简单说：异步回调的返回值，无法成为计算属性的返回值，计算属性会在异步任务注册后，直接默认返回</strong> <code>undefined</code> <strong>。</strong></p>
<h3 data-id="heading-10"><strong>也可以分两步走</strong></h3>
<h3 data-id="heading-11">一、先明确：计算属性的函数体，<strong>只在 “被访问” 时同步执行一次（除非满足重新计算条件）</strong></h3>
<p>当 <code>mounted</code> 中访问 <code>this.numDouble</code>，或者模板渲染访问 <code>numDouble</code> 时，Vue 会<strong>同步、完整地执行一遍</strong> ****<code>numDouble</code> ****<strong>函数体的代码</strong>，但这个执行过程和 <code>setTimeout</code> 内部的回调是完全分离的：</p>
<h4 data-id="heading-12">第一步：计算属性函数体「同步执行」（瞬间完成，不等待异步）</h4>
<p>我们把 <code>numDouble</code> 的执行过程拆解成 “逐行执行”，你就能看清流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 第1步：执行 setTimeout 这行代码</span>
  <span class="hljs-comment">// 作用：向浏览器“注册一个1秒后执行的异步任务”，仅此而已</span>
  <span class="hljs-comment">// 注意：这行代码执行时，不会等待1秒，也不会执行回调函数内部的代码</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 这是回调函数，此时完全没有执行！</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"回调函数开始执行"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 第2步：计算属性函数体执行到末尾</span>
  <span class="hljs-comment">// 没有显式 return，默认返回 undefined</span>
  <span class="hljs-comment">// 此时，numDouble 已经完成了“返回值”的传递，整个函数体执行结束</span>
}
</code></pre>
<p>简单来说就是<code>numDouble</code> 函数体的执行，只做了一件事 ——“安排了一个 1 秒后的任务”，然后就直接返回了 <code>undefined</code>，它不会停下来等 1 秒后回调执行完再返回值。</p>
<h4 data-id="heading-13">第二步：1 秒后，异步回调才执行，但为时已晚</h4>
<ol>
<li>计算属性已经在第一步就返回了 <code>undefined</code>，这个返回值已经被 <code>console.log</code> 打印，也被 Vue 缓存起来了；</li>
<li>1 秒后，浏览器才会执行 <code>setTimeout</code> 的回调函数，此时回调里的 <code>return this.num * 2</code> 只是 “回调函数自己的返回值”—— <strong>这个值没有任何接收者，既不能传给</strong> <code>numDouble</code> <strong>，也不能改变之前已经返回的</strong> <code>undefined</code> <strong>；</strong></li>
<li>更关键的是：回调执行时，<code>numDouble</code> 函数体早就执行完毕了，<strong>两者是完全独立的执行流程</strong>，回调的返回值无法 “回溯” 给已经执行完的计算属性。</li>
</ol>
<h3 data-id="heading-14">简单来讲就是：</h3>
<p><strong>计算属性是要内置返回一个结果的，如果加入异步就会因为执行顺讯返回一个undefined，监听是在事件触发后对写入的回调函数的调用。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当10年架构师拿起AI：不是写不动了，是写得太快了]]></title>    <link>https://juejin.cn/post/7586657335882154011</link>    <guid>https://juejin.cn/post/7586657335882154011</guid>    <pubDate>2025-12-23T09:11:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586657335882154011" data-draft-id="7586836874016292874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当10年架构师拿起AI：不是写不动了，是写得太快了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T09:11:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257538830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当10年架构师拿起AI：不是写不动了，是写得太快了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257538830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:11:15.000Z" title="Tue Dec 23 2025 09:11:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>引言</strong></h2>
<p>过去这一年，AI 编程工具如雨后春笋。作为技术人，我们或许都体验过 AI 编程工具补全代码的“爽感”。但当视角从“个人”拉升到“组织”，作为 CTO 或架构师的你，是否正面临着一种“数据的尴尬”：</p>
<ul>
<li>开发者说好用，但项目交付周期并没有显著缩短？</li>
<li>代码生成量上去了，但 Code Review 和 Debug 的时间却变长了？</li>
<li>想在团队推广 AI 工作流，却发现只有零星几个人在真正使用？</li>
</ul>
<p><strong>“AI 编程提效”</strong> ，究竟是实打实的生产力革命，还是一场属于管理者的集体错觉？</p>
<p>在个人好用与团队可用之间，隔着一道名为“工程化”的鸿沟。架构师的职责，就是填平这道沟。</p>
<p><strong>12 月 25 日（周四）晚 19:00</strong>，圣诞之夜， <strong>《架构师夜生活》邀你共赴一场关于“真相”的年终复盘。我们集结了出行、金融、AI</strong> <strong>智能体</strong> <strong>、低代码领域的四位技术领袖，不聊虚的，只谈 AI 编程在组织级落地的真实数据、踩坑经验与边界规范。</strong></p>
<h2 data-id="heading-1"><strong>直播看点</strong></h2>
<ul>
<li>抛开厂商的宣传 PPT，在真实的业务场景（高并发交易、银行核心系统、<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fweda%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/weda?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">低代码平台</a>）中，AI 到底能提效多少？10% 还是 50%？哪些岗位被严重高估了？</li>
<li>从“个人玩具”到“团队工具”，CTO 们在推行 AI 编程时最容易犯哪些错？如何避免陷入“为了 AI 而 AI”的 KPI 游戏？</li>
<li>当 AI 介入编码，代码规范、Code Review 流程、安全边界该如何重构？架构师如何定义 AI 的“行动边界”，防止它成为生产环境的“定时炸弹”？</li>
</ul>
<h2 data-id="heading-2"><strong>嘉宾阵容</strong></h2>
<p>本次做客直播间的四位嘉宾，有一个共同的特点：<strong>他们既是掌控全局的技术决策者，又是依然活跃在代码一线的“超级个体”。</strong></p>
<p>正因为拥有深厚的架构功底和业务视野，AI 编程在他们手中，不再仅仅是“补全代码”的初级工具，而是得心应手、能指数级放大个人能力的“外脑”。</p>
<p>在当下软件开发领域，有这样一群资深程序员：随着年岁增长，他们或许不再有通宵逐字敲代码的体力，但几十年的业务洞察与架构经验却已化作直觉。AI 编程工具的出现，为他们开启了职业生涯的“第二春”。</p>
<p>编程不再是单纯的体力劳动，而是演变成了“人、机器、业务”三者间的深度协作。有经验的架构师们，能够凭借对业务逻辑的深刻理解，一语中的，将复杂需求抽象为精准指令，指挥 AI 高效产出。这种“经验+AI”的组合，让他们爆发出了甚至<strong>超越壮年时期 3 倍的生产力</strong>。他们不再只是写代码的人，而是懂业务、懂架构、懂沟通的指挥官。</p>
<p><strong>主持人</strong></p>
<p><strong>Dora | 腾讯<strong><strong>云架构</strong></strong>师技术同盟副秘书长</strong></p>
<p>全面负责腾讯云千万级开发者社群的建设与发展。致力于搭建跨行业技术创新平台，连接技术决策者与开发者，推动企业数字化转型。</p>
<p><strong>嘉宾</strong></p>
<p><strong>王晓波 | 腾讯云架构师技术同盟活动组织主席</strong></p>
<p>拥有十余年基础架构与业务架构经验，主导了同程基础架构、私有云系统建设。他在处理海量交易与高可用系统设计方面有着深厚功力，深刻理解技术驱动力的重要性。</p>
<p><strong>鲍丹 | 腾讯云架构师名人堂专家</strong></p>
<p>曾负责邮储银行新一代分布式核心系统实施，是 Dubbo、Sentinel 等知名开源项目的 Committer。精通 Redis-Cluster 等<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fmessage-queue-catalog%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/message-queue-catalog?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">中间件</a>技术，拥有丰富的<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fai-class%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/ai-class?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">人工智能</a>应用落地经验。</p>
<p><strong>白德鑫 | 腾讯云架构师名人堂专家</strong></p>
<p>全面负责 AI 智能体与脑机接口产品的架构与商业化落地。曾任关税宝 CTO 及神策数据架构师，是一位横跨前沿技术与商业管理的复合型专家。</p>
<p><strong>茹炳晟 | 腾讯云架构师技术同盟入会成长主席</strong></p>
<p>业界知名实战派软件质量和研发工程效能专家，具有超过 16 年的软件测试开发经验和技术管理经验，具有丰富的测试框架设计与自动化测试经验。</p>
<h2 data-id="heading-3"><strong>直播信息</strong></h2>
<p>⏰ 直播时间： 12 月 25 日（周四） 19:00 - 22:00</p>
<p>📍 观看方式： 视频号直播（扫描海报二维码预约）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8547d358d06d4316941f3901d29cc529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767085875&amp;x-signature=NDDfDYgK4YRZSIgNzv7SLduVOpw%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>关于《架构师夜生活》</strong></h2>
<p><strong>《架构师夜生活》——技术人的深夜食堂</strong></p>
<p>当夜幕降临，代码的世界才真正苏醒。我们致力为技术人们打造一场有温度的深夜对话。邀请业内知名技术专家和行业 KOL，用最轻松的方式聊最前沿的技术。这里没有枯燥的 PPT，只有真实的故事和犀利的观点。</p>
<p>从架构设计到职业迷茫，从技术选型到管理心经——我们把复杂的技术问题掰开了、揉碎了聊。</p>
<p><strong>12 月 25 日晚 19:00，在这个特殊的夜晚，来直播间，我们一起拆解 AI 编程的真相。</strong></p>
<p><strong>【架构师夜生活】</strong></p>
<p><em>当夜幕降临，代码的世界才真正苏醒。我们致力于为技术人们打造一场有温度的深夜对话。邀请业内知名技术专家和行业 KOL，用最轻松的方式聊最前沿的技术。这里没有 PPT，只有真实的故事。从架构设计到创业感悟，从技术选型到职场成长——复杂的技术问题用最简单的语言解释，让每个技术人都能有所收获。我们相信，最好的技术交流不需要西装革履，只需要一颗好奇的心和一群有趣的灵魂。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[05 Go Eino AI应用开发实战 | Docker 部署指南]]></title>    <link>https://juejin.cn/post/7585474459776565284</link>    <guid>https://juejin.cn/post/7585474459776565284</guid>    <pubDate>2025-12-20T09:32:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585474459776565284" data-draft-id="7585121055037374514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="05 Go Eino AI应用开发实战 | Docker 部署指南"/> <meta itemprop="keywords" content="后端,Go,人工智能"/> <meta itemprop="datePublished" content="2025-12-20T09:32:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            05 Go Eino AI应用开发实战 | Docker 部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-20T09:32:00.000Z" title="Sat Dec 20 2025 09:32:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>本指南提供了使用 Docker 和 Docker Compose 部署 Go-Eino Interview Agent 平台的全面说明。该平台由多个微服务组成，包括 Go 后端、Next.js 前端、MySQL 数据库、Redis 缓存以及用于 AI 功能的可选 Milvus 向量数据库。</p>
</blockquote>
<h2 data-id="heading-0">架构概述</h2>
<p>部署架构采用微服务模式，包含以下核心组件：</p>
<ul>
<li>外部访问</li>
<li>Docker 网络
<ul>
<li>端口 80</li>
<li>端口 80</li>
<li>/api/*</li>
<li>/*</li>
</ul>
</li>
<li>Nginx 反向代理</li>
<li>前端 :3000</li>
<li>后端 :8888</li>
<li>MySQL :3306</li>
<li>Redis :6379</li>
<li>Etcd :2379</li>
<li>用户浏览器</li>
<li>API 客户端</li>
</ul>
<h2 data-id="heading-1">前置条件</h2>
<p>在开始部署之前，请确保已安装以下软件：</p>
<ul>
<li>Docker（版本 20.10 或更高）</li>
<li>Docker Compose（版本 2.0 或更高）</li>
<li>Git 用于克隆仓库</li>
<li>至少 4GB RAM 以获得最佳性能</li>
</ul>
<h2 data-id="heading-2">快速开始</h2>
<p>运行平台最快的方式是使用提供的 Docker Compose 配置：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> &lt;repository-url&gt;
<span class="hljs-built_in">cd</span> go-eino-interview-agent 
<span class="hljs-comment"># 启动所有服务</span>
docker compose -f docker-compose.yml up -d 
<span class="hljs-comment"># 检查服务状态</span>
docker compose ps
</code></pre>
<p>应用程序将在以下地址可用：</p>
<ul>
<li>前端：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost" target="_blank" title="http://localhost" ref="nofollow noopener noreferrer">http://localhost</a></li>
<li>后端 API：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%2Fapi" target="_blank" title="http://localhost/api" ref="nofollow noopener noreferrer">http://localhost/api</a></li>
<li>MySQL：localhost:3307</li>
<li>Redis：localhost:6379</li>
</ul>
<h2 data-id="heading-3">部署配置</h2>
<p>项目为不同的部署场景提供了三种 Docker Compose 配置：</p>

























<table><thead><tr><th>配置</th><th>用途</th><th>主要特性</th></tr></thead><tbody><tr><td>docker-compose.yml</td><td>开发</td><td>包含 Nginx 代理的全栈服务，暴露外部端口</td></tr><tr><td>docker-compose-prod.yml</td><td>生产</td><td>为生产环境优化，内部网络通信</td></tr><tr><td>docker-compose-example.yml</td><td>模板</td><td>包含示例的配置参考</td></tr></tbody></table>
<h3 data-id="heading-4">开发环境部署</h3>
<p>开发配置文件 docker-compose.yml 包含：</p>
<ul>
<li>Nginx 反向代理，监听端口 80</li>
<li>所有服务的外部端口暴露</li>
<li>健康检查用于服务监控</li>
<li>数据持久化的卷挂载</li>
</ul>
<h3 data-id="heading-5">生产环境部署</h3>
<p>生产配置文件 docker-compose-prod.yml 针对以下方面进行了优化：</p>
<ul>
<li>内部网络通信（减少外部暴露）</li>
<li>生产环境变量</li>
<li>优化的构建参数</li>
<li>安全加固</li>
</ul>
<p>对于生产部署，请始终使用环境变量来管理敏感数据，如数据库密码和 API 密钥。切勿将这些值提交到版本控制系统。</p>
<h2 data-id="heading-6">服务配置</h2>
<h3 data-id="heading-7">后端服务</h3>
<p>后端服务 backend/Dockerfile 使用多阶段构建进行优化：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 构建阶段
FROM golang:1.24-alpine AS builder
# ... 构建过程 ... 
# 运行时阶段  
FROM alpine:3.18
# ... 最小运行时镜像 ...
</code></pre>
<p>关键配置：</p>
<ul>
<li>端口：8888</li>
<li>健康检查：/health 端点</li>
<li>用户：非 root 用户（appuser:1001）</li>
<li>时区：Asia/Shanghai</li>
</ul>
<h3 data-id="heading-8">前端服务</h3>
<p>前端服务 frontend/Dockerfile 同样使用多阶段构建：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 构建阶段
FROM node:18-alpine AS builder
# ... Next.js 构建 ... 
# 运行时阶段
FROM node:18-alpine
# ... 生产运行时 ...
</code></pre>
<p>关键配置：</p>
<ul>
<li>端口：3000</li>
<li>构建参数：NEXT_PUBLIC_API_BASE_URL</li>
<li>健康检查：根端点</li>
<li>用户：非 root 用户（appuser:1001）</li>
</ul>
<h3 data-id="heading-9">数据库服务</h3>
<h4 data-id="heading-10">MySQL 配置</h4>
<ul>
<li>版本：8.0</li>
<li>端口：3307（外部），3306（内部）</li>
<li>数据库：interview_agent</li>
<li>健康检查：MySQL ping 命令</li>
<li>持久化：命名卷 mysql-data</li>
</ul>
<h4 data-id="heading-11">Redis 配置</h4>
<ul>
<li>版本：7-alpine</li>
<li>端口：6379</li>
<li>持久化：启用 AOF</li>
<li>健康检查：Redis ping 命令</li>
<li>持久化：命名卷 redis-data</li>
</ul>
<h3 data-id="heading-12">Nginx 配置</h3>
<p>Nginx 反向代理 nginx.conf 提供：</p>
<ul>
<li>API 路由：/api/* → backend:8888</li>
<li>前端路由：/* → frontend:3000</li>
<li>WebSocket 支持：Upgrade 头部</li>
<li>SSE 支持：禁用流式传输的缓冲</li>
<li>健康检查：/health 端点</li>
</ul>
<h2 data-id="heading-13">环境变量</h2>
<h3 data-id="heading-14">必需变量</h3>
<p>在项目根目录创建 .env 文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 数据库配置</span>
DB_PASSWORD=your_secure_password
DB_USER=root
DB_NAME=interview_agent 
<span class="hljs-comment"># Redis 配置  </span>
REDIS_PASSWORD=your_redis_password 
<span class="hljs-comment"># API 配置</span>
NEXT_PUBLIC_API_BASE_URL=http://your-domain:8888/api 
<span class="hljs-comment"># AI 服务（可选）</span>
EMBEDDING_API_KEY=your_embedding_key
EMBEDDING_MODEL=your_model_id
EMBEDDING_BASE_URL=https://api.example.com
MILVUS_ADDRESS=milvus:19530
</code></pre>
<h3 data-id="heading-15">配置文件</h3>
<p>后端使用 config.example.yaml 作为模板。复制并自定义：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cp</span> backend/config.example.yaml backend/config.yaml
</code></pre>
<p>关键配置部分：</p>
<ul>
<li>数据库：MySQL 连接设置</li>
<li>Redis：缓存配置</li>
<li>安全：JWT 密钥和 CORS 设置</li>
<li>AI 服务：OpenAI、Embedding 和 Milvus 设置</li>
</ul>
<h2 data-id="heading-16">部署流程</h2>
<h3 data-id="heading-17">步骤 1：准备工作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆并进入项目</span>
git <span class="hljs-built_in">clone</span> &lt;repository-url&gt;
<span class="hljs-built_in">cd</span> go-eino-interview-agent 
<span class="hljs-comment"># 创建环境文件</span>
<span class="hljs-built_in">cp</span> .env.example .<span class="hljs-built_in">env</span>
<span class="hljs-comment"># 使用你的值编辑 .env </span>
<span class="hljs-comment"># 准备后端配置</span>
<span class="hljs-built_in">cp</span> backend/config.example.yaml backend/config.yaml
<span class="hljs-comment"># 使用你的设置编辑 config.yaml</span>
</code></pre>
<h3 data-id="heading-18">步骤 2：构建和部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建并启动所有服务</span>
docker compose -f docker-compose.yml up -d --build 
<span class="hljs-comment"># 监控部署进度</span>
docker compose logs -f 
<span class="hljs-comment"># 检查服务健康状态</span>
docker compose ps
</code></pre>
<h3 data-id="heading-19">步骤 3：验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试后端健康状态</span>
curl http://localhost/health 
<span class="hljs-comment"># 测试前端访问  </span>
curl -I http://localhost 
<span class="hljs-comment"># 检查数据库连接</span>
docker compose <span class="hljs-built_in">exec</span> backend ./main -check-db
</code></pre>
<h2 data-id="heading-20">故障排除</h2>
<h3 data-id="heading-21">常见问题</h3>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>端口冲突</td><td>在 docker-compose.yml 中更改外部端口</td></tr><tr><td>数据库连接错误</td><td>验证 MySQL 健康状态和凭据</td></tr><tr><td>构建失败</td><td>检查 Docker 守护进程和可用磁盘空间</td></tr><tr><td>权限错误</td><td>确保卷权限正确设置</td></tr></tbody></table>
<h3 data-id="heading-22">健康检查命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查所有服务状态</span>
docker compose ps 
<span class="hljs-comment"># 查看服务日志</span>
docker compose logs backend
docker compose logs frontend
docker compose logs mysql 
<span class="hljs-comment"># 访问服务 Shell</span>
docker compose <span class="hljs-built_in">exec</span> backend sh
docker compose <span class="hljs-built_in">exec</span> mysql mysql -u root -p
</code></pre>
<h2 data-id="heading-23">性能监控</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 监控资源使用</span>
docker stats 
<span class="hljs-comment"># 检查容器健康状态</span>
docker compose <span class="hljs-built_in">exec</span> backend curl localhost:8888/health
docker compose <span class="hljs-built_in">exec</span> frontend curl localhost:3000
</code></pre>
<h2 data-id="heading-24">高级配置</h2>
<h3 data-id="heading-25">Milvus 向量数据库（可选）</h3>
<p>要启用 AI 功能，请在 docker-compose.yml 中取消注释以下服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 取消注释这些服务</span>
<span class="hljs-attr">milvus:</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">milvusdb/milvus:v2.4.0</span>
  <span class="hljs-comment"># ... 配置 ... </span>
<span class="hljs-attr">attu:</span>
  <span class="hljs-attr">image:</span> <span class="hljs-string">zilliz/attu:v2.3.4</span>  
  <span class="hljs-comment"># ... 配置 ...</span>
</code></pre>
<h3 data-id="heading-26">自定义网络</h3>
<p>部署使用自定义桥接网络 app-network 进行服务隔离：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">networks:</span>
  <span class="hljs-attr">app-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<h3 data-id="heading-27">卷管理</h3>
<p>持久化数据存储在命名卷中：</p>

























<table><thead><tr><th>卷</th><th>用途</th></tr></thead><tbody><tr><td>mysql-data</td><td>MySQL 数据库文件</td></tr><tr><td>redis-data</td><td>Redis AOF 文件</td></tr><tr><td>etcd-data</td><td>Etcd 集群数据</td></tr><tr><td>milvus-data</td><td>向量数据库（可选）</td></tr></tbody></table>
<h2 data-id="heading-28">生产最佳实践</h2>
<p>对于生产部署，建议使用密钥管理、外部数据库，并在负载均衡器级别配置适当的 SSL/TLS 终止。</p>
<h3 data-id="heading-29">安全考虑</h3>
<ol>
<li>使用非 root 用户（已配置）</li>
<li>实施密钥管理保护敏感数据</li>
<li>启用 SSL/TLS 终止</li>
<li>定期安全更新基础镜像</li>
<li>网络分段保护敏感服务</li>
</ol>
<h3 data-id="heading-30">性能优化</h3>
<ol>
<li>为容器设置资源限制</li>
<li>数据库访问使用连接池</li>
<li>频繁访问数据采用缓存策略</li>
<li>设置监控和告警</li>
</ol>
<h3 data-id="heading-31">备份策略</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 数据库备份</span>
docker compose <span class="hljs-built_in">exec</span> mysql mysqldump -u root -p interview_agent &gt; backup.sql 
<span class="hljs-comment"># 卷备份</span>
docker run --<span class="hljs-built_in">rm</span> -v mysql-data:/data -v $(<span class="hljs-built_in">pwd</span>):/backup alpine tar czf /backup/mysql-backup.tar.gz -C /data .
</code></pre>
<h2 data-id="heading-32">后续步骤</h2>
<p>成功部署后，你可能想要探索：</p>
<ul>
<li>架构概述 - 了解系统设计</li>
<li>开发环境设置 - 本地开发配置</li>
<li>Kubernetes 部署 - 扩展到生产集群</li>
<li>监控和可观测性 - 生产监控设置</li>
</ul>
<h2 data-id="heading-33">一起学习进步</h2>
<p>对这个项目感兴趣的朋友欢迎关注我，私信我，免费领取学习资料，一起成长进步。</p>
<p>系列教程查看下方专栏即可：</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》]]></title>    <link>https://juejin.cn/post/7586922268022947876</link>    <guid>https://juejin.cn/post/7586922268022947876</guid>    <pubDate>2025-12-23T09:08:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586922268022947876" data-draft-id="7586922268022915108" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》"/> <meta itemprop="keywords" content="前端,面试,LangChain"/> <meta itemprop="datePublished" content="2025-12-23T09:08:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yira"/> <meta itemprop="url" content="https://juejin.cn/user/262123324974122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/262123324974122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yira
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:08:08.000Z" title="Tue Dec 23 2025 09:08:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《闭包、RAG与AI面试官：一个前端程序员的奇幻LangChain之旅》</h2>
<p>在某个风和日丽的下午，小李——一位自诩“能用一行代码解决的问题绝不用两行”的前端工程师——正坐在工位上，盯着屏幕上一行报错发呆。他不是在调试React组件，也不是在修复CSS样式错乱，而是在尝试用AI模型回答一个看似简单却深不见底的问题：“<strong>什么是闭包？</strong> ”</p>
<p>但别误会，这不是一篇枯燥的技术教程。这是一场融合了<strong>LangChain魔法、DeepSeek大模型、提示词工程、工作流编排</strong>以及一点点程序员幽默感的奇妙冒险。我们将从一行<code>import</code>开始，穿越提示词模板、链式调用、序列化流程，最终抵达AI驱动的智能应用新大陆。准备好了吗？系好安全带，我们的LangChain飞船即将升空！</p>
<hr/>
<h3 data-id="heading-1">第一幕：环境变量——AI世界的“启动密钥”</h3>
<p>一切的起点，都始于那句神秘的咒语：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
</code></pre>
<p>对，就是它！这行代码仿佛打开了通往异世界的传送门，把藏在 <code>.env</code> 文件里的 <code>DEEPSEEK_API_KEY</code> 唤醒。没有它，AI就像没插电的机器人——再聪明也动不了。小李深知：<strong>在AI时代，API密钥就是你的魔法杖</strong>。</p>
<blockquote>
<p>小知识：<code>.env</code> 文件通常包含敏感信息（如密钥、数据库密码），绝不能提交到Git！记得把它加入 <code>.gitignore</code>。</p>
</blockquote>
<p>接着，他召唤出了今天的主角之一：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
</code></pre>
<p><code>ChatDeepSeek</code> 是 LangChain 为 DeepSeek 大模型提供的官方适配器。LangChain 的伟大之处在于——它用“适配器模式”帮我们屏蔽了不同大模型（LLM）之间的差异。换句话说，<strong>你不用再为每个模型重写一套调用逻辑</strong>。今天用 DeepSeek，明天换通义千问？只要接口一致，几乎无缝切换。</p>
<p>这省下的时间，足够你多喝三杯咖啡，或者多摸五分钟鱼——而后者，往往是程序员真正的刚需。</p>
<hr/>
<h3 data-id="heading-2">第二幕：提示词——给AI戴上“人设面具”</h3>
<p>小李知道，直接问AI“什么是闭包？”太粗暴了。AI可能会给你一段教科书式的定义，也可能突然开始讲哲学，甚至反问你：“你确定要听真话吗？”</p>
<p>于是，他祭出了 <strong>PromptTemplate</strong> ——LangChain 中的提示词模板神器。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">prompt</span> = PromptTemplate.fromTemplate(`
    你是一个{role},
    请用不超过{limit}字回答以下问题:
    {question}
`)<span class="hljs-comment">;</span>
</code></pre>
<p>看，这不只是提问，这是在<strong>给AI分配角色</strong>！你可以让它扮演“毒舌面试官”、“耐心导师”，甚至是“脱口秀演员”。在这个例子中，小李设定了：</p>
<ul>
<li><code>role: '前端面试官'</code></li>
<li><code>limit: '50'</code></li>
<li><code>question: '什么是闭包'</code></li>
</ul>
<p>然后格式化：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">promptStr</span> = await prompt.<span class="hljs-title function_ invoke__">format</span>({
    <span class="hljs-attr">role</span>:<span class="hljs-string">'前端面试官'</span>,
    <span class="hljs-attr">limit</span>:<span class="hljs-string">'50'</span>,
    <span class="hljs-attr">question</span>:<span class="hljs-string">'什么是闭包'</span>
});
</code></pre>
<p>结果？AI秒回一句精准又犀利的回答：</p>
<blockquote>
<p>“闭包是函数记住并访问其词法作用域的能力，即使在函数外部执行。”</p>
</blockquote>
<p><strong>50字，不多不少，面试官看了直呼内行</strong>。</p>
<blockquote>
<p>提示词工程（Prompt Engineering）的本质，就是“如何优雅地指挥AI”。你不是在写代码，你是在写剧本。而好的提示词，就是让AI入戏的导演手记。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">第三幕：单步调用 vs 链式思维——从“问答机”到“思考者”</h3>
<p>但小李不满足于一次性的问答。他想让AI先详细解释概念，再提炼要点，最后生成学习建议。这怎么办？总不能手动复制粘贴三次吧？</p>
<p>这时候，LangChain 的 <strong>Chain（链）</strong> 概念闪亮登场。</p>
<h4 data-id="heading-4">简单链：Pipe 一下，世界清净了</h4>
<p>最基础的链，用 <code>.pipe()</code> 连接提示词和模型：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">chain</span> = prompt.pipe(model)<span class="hljs-comment">;</span>
const <span class="hljs-attr">response</span> = await chain.invoke({ topic: <span class="hljs-string">'什么是闭包'</span> })<span class="hljs-comment">;</span>
</code></pre>
<p>这里，<code>prompt</code> 是输入模板，<code>model</code> 是语言模型，<code>pipe</code> 把它们串成流水线。输入 <code>{topic}</code>，输出 AI 回答。<strong>简洁、优雅、可复用</strong>。</p>
<p>这就像你点奶茶：选口味（prompt）→ 加糖（参数）→ 出杯（invoke）。全程自动化，无需人工干预。</p>
<h4 data-id="heading-5">复杂链：RunnableSequence——AI的“多工序车间”</h4>
<p>但真实业务往往更复杂。比如小李的需求：</p>
<ol>
<li>先让AI详细解释“闭包”；</li>
<li>再让另一个提示词把解释总结成三个要点；</li>
<li>最后拼接成完整报告。</li>
</ol>
<p>LangChain 提供了 <code>RunnableSequence</code> 来实现这种多步骤流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fullChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
    <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> explainChain.<span class="hljs-title function_">invoke</span>({<span class="hljs-attr">topic</span>: input.<span class="hljs-property">topic</span>}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">text</span>),
    <span class="hljs-function">(<span class="hljs-params">explanation</span>) =&gt;</span> summaryChain.<span class="hljs-title function_">invoke</span>({<span class="hljs-attr">explain</span>: explanation}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-string">`知识点总结: ...`</span>)
]);
</code></pre>
<p>注意：每一步都是异步的，且前一步的输出自动成为后一步的输入。<strong>整个过程像一条装配线，原料进去，成品出来</strong>。</p>
<p>运行结果令人惊喜：</p>
<ul>
<li>第一阶段输出300字内的专业解释；</li>
<li>第二阶段自动生成如“1. 函数携带作用域 2. 延长变量生命周期 3. 可能导致内存泄漏”这样的干货总结；</li>
<li>最终返回结构化文本，可直接用于教学或笔记。</li>
</ul>
<p><strong>这哪是AI？这分明是你的私人学习助理+内容编辑+知识萃取师</strong>！</p>
<hr/>
<h3 data-id="heading-6">第四幕：RAG？一句话说清！——测试AI的“基本功”</h3>
<p>当然，小李也没忘了测试AI的基础能力。他直接问：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">res</span> = await model.invoke(<span class="hljs-string">'用一句话解释什么是RAG?'</span>)<span class="hljs-comment">;</span>
console.log(res.content)<span class="hljs-comment">;</span>
</code></pre>
<p>AI答：“RAG（检索增强生成）是一种结合外部知识库与大语言模型的技术，通过检索相关信息来增强生成内容的准确性。”</p>
<p><strong>一句话，准确、简洁、无废话</strong>。温度（temperature）设为0，确保AI不“放飞自我”。</p>
<blockquote>
<p>温度是什么？简单说，温度越高，AI越“有创意”（也越可能胡说八道）；温度越低，越“严谨”（但也可能死板）。面试场景？当然选0.7左右，既专业又不死板。写诗？那就拉到1.2，让它尽情发挥！</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">第五幕：为什么LangChain是AI应用的“乐高积木”？</h3>
<p>看到这里，你可能想问：<strong>为什么不用原生API直接调用？</strong></p>
<p>答案是：<strong>复杂业务需要工程化</strong>。</p>
<p>想象一下，你要做一个“智能面试系统”：</p>
<ul>
<li>用户输入问题；</li>
<li>AI先判断问题领域（前端/后端/算法）；</li>
<li>然后切换不同角色回答；</li>
<li>再根据用户水平调整解释深度；</li>
<li>最后生成学习路径+相关练习题。</li>
</ul>
<p>如果全用手写Promise链，代码会变成意大利面条，维护成本爆炸。而LangChain的 <strong>Runnable、Chain、Agent、Memory</strong> 等抽象，让你像搭乐高一样组合功能模块。</p>
<p>更重要的是——<strong>每一步都可测试、可替换、可复用</strong>。今天用DeepSeek，明天换Claude？只要接口一致，几乎不用改代码！</p>
<p>LangChain 的哲学是：<strong>不要重复造轮子，而是把轮子组装成车</strong>。</p>
<hr/>
<h3 data-id="heading-8">第六幕：闭包的隐喻——程序员与AI的共生关系</h3>
<p>回到最初的问题：“什么是闭包？”</p>
<p>对小李来说，闭包不仅是JavaScript的一个特性，更是一种隐喻：<strong>函数携带着它诞生时的环境，在陌生的地方依然能访问“家”中的变量</strong>。</p>
<p>而LangChain，就像是那个“环境”——它包裹着大模型的能力，让我们在复杂的AI应用世界中，依然能保持代码的清晰与可控。</p>
<p>我们写的每一行提示词，都是在为AI“注入上下文”；每一个Chain，都是在构建“认知流水线”。<strong>我们不是在取代AI，而是在与AI协同进化</strong>。</p>
<hr/>
<h3 data-id="heading-9">终章：从玩具到生产——LangChain的实战价值</h3>
<p>别以为这只是玩具代码。在真实项目中，LangChain 已被广泛应用于：</p>
<ul>
<li>智能客服（自动问答+意图识别）</li>
<li>文档摘要（上传PDF → 自动生成摘要）</li>
<li>代码助手（自然语言生成SQL/React组件）</li>
<li>教育工具（自动生成习题+解析）</li>
</ul>
<p>而这一切的核心，正是我们今天演示的：<strong>提示词 + 模型 + 链式编排</strong>。</p>
<p>所以，下次当你被问到“什么是闭包”时，不妨笑着回答：</p>
<blockquote>
<p>“闭包，就是一个函数带着它的‘童年回忆’闯荡江湖。而我，用LangChain给AI装上了‘回忆提取器’，让它不仅能答题，还能当老师、做总结、甚至讲段子。”</p>
</blockquote>
<p>技术很酷，但更酷的是——<strong>我们正在用代码，重新定义人与智能的关系</strong>。</p>
<hr/>
<h3 data-id="heading-10">彩蛋：避坑指南 &amp; 最佳实践</h3>
<ol>
<li>
<p><strong>不要在一个文件里重复导入</strong><br/>
你提供的代码片段中有多个 <code>import 'dotenv/config'</code> 和重复的模型初始化。实际项目中应拆分为模块，避免冲突。</p>
</li>
<li>
<p><strong>合理使用 .gitignore</strong><br/>
确保 <code>.env</code> 不被提交！否则你的API密钥将公之于众。</p>
</li>
<li>
<p><strong>温度控制很重要</strong></p>
<ul>
<li><code>temperature: 0</code> → 确定性输出（适合事实问答）</li>
<li><code>temperature: 0.7</code> → 平衡创意与准确（适合创作、解释）</li>
<li><code>temperature: 1.0+</code> → 放飞自我（适合诗歌、故事）</li>
</ul>
</li>
<li>
<p><strong>Chain 可嵌套</strong><br/>
你可以把一个Chain作为另一个Chain的节点，构建树状工作流。</p>
</li>
<li>
<p><strong>监控与日志</strong><br/>
在生产环境中，记得记录每一步的输入输出，便于调试和优化提示词。</p>
</li>
</ol>
<hr/>
<p>Happy Coding，愿你的AI永远不胡说，你的闭包永不泄漏，你的Chain永远畅通无阻！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemServer类 与 system_server进程]]></title>    <link>https://juejin.cn/post/7586902693857247274</link>    <guid>https://juejin.cn/post/7586902693857247274</guid>    <pubDate>2025-12-23T08:44:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586902693857247274" data-draft-id="7586889698242297919" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemServer类 与 system_server进程"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T08:44:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemServer类 与 system_server进程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:44:11.000Z" title="Tue Dec 23 2025 08:44:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li><strong><code>system_server</code></strong>：是一个 <strong>进程名</strong>，指系统中那条最关键的 Java 进程。</li>
<li><strong><code>SystemServer</code></strong>：是一个 <strong>Java 类</strong>（<code>com.android.server.SystemServer</code>），在 <code>system_server</code> 进程里运行，负责在这个进程中 <strong>创建并启动各种系统服务</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-0"><strong>一、各自是什么？</strong></h2>
<h3 data-id="heading-1"><strong>1.</strong> <strong><code>system_server</code></strong> <strong>是什么？</strong></h3>
<ul>
<li>
<p><strong>身份</strong>：Linux 用户空间里的 <strong>一个进程</strong>，进程名是 <code>system_server</code>。</p>
</li>
<li>
<p><strong>来源</strong>：由 <strong>Zygote</strong> 通过 <code>forkSystemServer()</code> fork 出来。</p>
</li>
<li>
<p><strong>作用</strong>：承载绝大部分 <strong>Framework 层 Java 系统服务</strong> 的运行环境。</p>
</li>
<li>
<p><strong>特征</strong>：</p>
<ul>
<li>运行用户：一般是 <strong>system UID</strong>；</li>
<li>在 <code>ps</code> / <code>top</code> / <code>dumpsys</code> / <code>logcat</code> 等工具中，以 <strong>进程实体</strong> 的形式出现；</li>
<li>一旦这个进程崩溃，整个 Android Framework 基本算“挂了”。</li>
</ul>
</li>
</ul>
<p>可以把它理解为： <strong>“系统服务 Java 世界的大房子”</strong> 。</p>
<h3 data-id="heading-2"><strong>2.</strong> <strong><code>SystemServer</code></strong> <strong>是什么？</strong></h3>
<ul>
<li>
<p><strong>身份</strong>：一个 <strong>Java 类</strong>，完整类名为： <strong><code>com.android.server.SystemServer</code></strong>。</p>
</li>
<li>
<p><strong>所在进程</strong>：这段代码在 <strong><code>system_server</code></strong> <strong>进程内部执行</strong>。</p>
</li>
<li>
<p><strong>作用</strong>：在 <code>run()</code> 方法里去：</p>
<ul>
<li>创建各种系统服务对象（如 AMS、PMS、WMS 等）；</li>
<li>调用它们的 <code>onStart()</code> 之类方法；</li>
<li>把它们注册进 <code>ServiceManager</code>；</li>
<li>最后进入主线程消息循环，维持整个系统服务运行。</li>
</ul>
</li>
</ul>
<p>可以把它理解为： <strong>“在 system_server 这个房子里跑起来的主程序/管家”</strong> 。</p>
<h2 data-id="heading-3"><strong>二、两者的关系：谁在谁里面？</strong></h2>
<p>用一句话描述关系：</p>
<blockquote>
<p><strong><code>system_server</code></strong> <strong>= 进程容器，</strong> <strong><code>SystemServer</code></strong> <strong>= 这个进程里跑的入口类。</strong></p>
</blockquote>
<p>更具体一点的启动链（简化版）：</p>
<ol>
<li>
<p><strong>ZygoteInit.main()</strong> （在 zygote 进程里）</p>
<ol>
<li>调用 <code>startSystemServer()</code>；</li>
</ol>
</li>
<li>
<p><strong>startSystemServer()</strong></p>
<ol>
<li>通过 <code>forkSystemServer()</code> → 从 Zygote fork 出一个子进程；</li>
<li>为这个子进程设置进程名为 <strong><code>system_server</code></strong>；</li>
</ol>
</li>
<li>
<p><strong>子进程（也就是 system_server 进程）启动后</strong></p>
<ol>
<li>执行 <code>com.android.internal.os.RuntimeInit</code> 相关初始化；</li>
<li>再调用 <strong><code>com.android.server.</code></strong> <strong><code>SystemServer.main</code></strong> <strong><code>()</code></strong> ；</li>
</ol>
</li>
<li>
<p><strong>SystemServer.main()</strong></p>
<ol>
<li>new 一个 <code>SystemServer</code> 对象，调用 <code>run()</code>；</li>
<li>在里面执行 <code>startBootstrapServices()</code> / <code>startCoreServices()</code> / <code>startOtherServices()</code> 启动各个 service。</li>
</ol>
</li>
</ol>
<p>所以关系图可以理解为：</p>
<ul>
<li><strong>进程级</strong>：<code>zygote</code> → fork → <strong><code>system_server</code></strong> <strong>进程</strong></li>
<li><strong>进程内部代码入口</strong>：<code>SystemServer.main()</code> → <code>SystemServer.run()</code> → 启动各个系统服务</li>
</ul>
<h2 data-id="heading-4"><strong>三、核心区别：视角与关注点的不同</strong></h2>
<ol>
<li><strong>从系统 / 内核视角</strong></li>
</ol>
<ul>
<li>你看到的是：<strong>有一个叫</strong> <strong><code>system_server</code></strong> <strong>的进程</strong>，占用 CPU/内存，是内核调度的对象。</li>
</ul>
<p>崩溃日志里 top line 一般写的是：</p>
<p>Process: system_server</p>
<ul>
<li>相当于“操作系统观”下的实体。</li>
</ul>
<ol start="2">
<li><strong>从 Java / Framework 开发者视角</strong></li>
</ol>
<ul>
<li>
<p>你在源码里看到的是：<strong>有一个</strong> <strong><code>SystemServer</code></strong> <strong>类</strong>，负责系统服务的启动。</p>
</li>
<li>
<p>工作内容主要是：</p>
<ul>
<li>在 <code>SystemServer</code> 里加/改系统服务的创建顺序、参数、依赖；</li>
<li>调整某个服务何时由 <code>SystemServer</code> 拉起。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>从调试/排查问题视角</strong></li>
</ol>
<ul>
<li><strong>进程级问题</strong>（如 OOM、native crash、Watchdog 卡死）： 你关注的是 <strong><code>system_server</code></strong> <strong>tombstone</strong> <strong>、ANR traces、进程优先级、CPU/memory</strong>。</li>
<li><strong>服务启动/依赖顺序问题</strong>（比如某个 Service 没有正常启动、死在启动流程里）： 你更多会去看 <strong><code>SystemServer.startBootstrapServices/startOtherServices</code></strong> <strong>里的代码与日志</strong>。</li>
</ul>
<h2 data-id="heading-5"><strong>四、联系总结（可以记住的一句对照）</strong></h2>
<ul>
<li>
<p><strong><code>system_server</code></strong> <strong>：</strong></p>
<ul>
<li>概念：进程名</li>
<li>角色：承载 Framework Java 服务的 <strong>进程容器</strong></li>
<li>对象：操作系统 / 内核 / 调度</li>
</ul>
</li>
<li>
<p><strong><code>SystemServer</code></strong> <strong>：</strong></p>
<ul>
<li>概念：Java 类</li>
<li>角色：在 <code>system_server</code> 进程里负责 <strong>启动所有系统服务的入口类</strong></li>
<li>对象：Framework 开发 / 系统服务逻辑</li>
</ul>
</li>
</ul>
<p><strong>可以类比成：</strong></p>
<ul>
<li><code>system_server</code> ≈ “整栋大楼（进程）”</li>
<li><code>SystemServer</code> ≈ “负责把楼里各个部门（服务）都组织起来运转的物业/总管程序”</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”]]></title>    <link>https://juejin.cn/post/7586622708999454760</link>    <guid>https://juejin.cn/post/7586622708999454760</guid>    <pubDate>2025-12-23T07:49:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999454760" data-draft-id="7586622708999438376" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”"/> <meta itemprop="keywords" content="机器学习,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:49:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Narrastory"/> <meta itemprop="url" content="https://juejin.cn/user/4355593566170010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355593566170010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Narrastory
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:49:30.000Z" title="Tue Dec 23 2025 07:49:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">拆解指数加权平均：5 分钟看懂机器学习的 “数据平滑神器”</h2>
<p><code>Ming | 2025.12</code></p>
<hr/>
<div align="center">
  <img align="center" src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017af1e2a1eb4ab5a0a43a2d3bdc1880~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=d%2F05QcLxv2ohejCYN1L1hO5gRGU%3D" alt="AI Generated Art" width="90%" loading="lazy"/>
</div>
<p>什么是指数加权平均？简单来说，它是一种用于将序列数据变得更加平滑的经典方法。在机器学习中，我们经常会遇到来自传感器、实验或训练过程的噪声数据，这些数据波动很大，不容易直接观察趋势。指数加权平均就像一个“数据平滑神器”，能够有效过滤短期波动，突出长期趋势，帮助我们更好地理解数据变化。</p>
<p>例如，下面是一个带有噪声的原始序列：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c2ea5dcfc3d4c00b610cc9f2ecbdc86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=3cyqRXdYrytnmcd7fDTGTAz%2BVEA%3D" alt="c1.jpg" loading="lazy"/></p>
<p>在使用不同平滑参数 β 的指数加权平均后，我们可以得到平滑程度各异的序列：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5de4f0e67314e7991481793bef600fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=gAOxfpfh7IH8dR4Y7Ii17P67BtE%3D" alt="c2.jpg" loading="lazy"/></p>
<p>如果是了解过股票交易的朋友，应该对“移动平均线”（Moving Average）这个概念非常熟悉。它常被用于观察股价的趋势，帮助投资者过滤短期市场的“噪声”，把握中长期的走势方向。其实，指数加权平均正是股票技术分析中“指数移动平均线”（Exponential Moving Average, EMA）的核心计算方法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f5b21c8647548a0b4e532990ad1815d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=lQogsUfvPp0Bt7Sh647X10MFEGQ%3D" alt="c5.jpg" loading="lazy"/></p>
<p>指数加权平均的实现非常简单，其本质是对历史数据进行加权组合，且权重随时间指数衰减。</p>
<p>假设我们有一个原始序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_1, a_2, …, a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，我们希望得到一个平滑后的序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>b</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">b_1, b_2, …, b_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
<p>通常我们令初始平滑值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0 = a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，然后从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 开始迭代计算：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>b</mi><mi>n</mi></msub><mo>=</mo><mi>β</mi><msub><mi>b</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>β</mi><mo stretchy="false">)</mo><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">b_{n} = \beta b_{n-1} +(1-\beta)a_{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 是一个介于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 之间的平滑因子。β 越大，曲线越平滑，但也会对最新数据的反应变得“迟钝”；β 越小，平滑后的曲线越接近原始数据，保留的细节也越多。公式可以直观理解为：每一步的平滑值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">b_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是上一时刻平滑值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">b_{n-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span> 与当前观测值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的加权平均。</p>
<p>假设我们有一个长度为 5 的序列：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>a</mi><mo>=</mo><mo stretchy="false">[</mo><mn>10</mn><mo separator="true">,</mo><mn>8</mn><mo separator="true">,</mo><mn>12</mn><mo separator="true">,</mo><mn>9</mn><mo separator="true">,</mo><mn>11</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">a=[10,8,12,9,11]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">12</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">11</span><span class="mclose">]</span></span></span></span></span></div>
<p>并取 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mo>=</mo><mn>0.8</mn></mrow><annotation encoding="application/x-tex">\beta = 0.8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.8</span></span></span></span></span>，初始值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">b_0 = a_0 = 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span></span></span></span></span>。我们一步步来计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">b_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>5</mn></msub></mrow><annotation encoding="application/x-tex">b_5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<ol>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>1</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>10</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>8</mn><mo>=</mo><mn>8</mn><mo>+</mo><mn>1.6</mn><mo>=</mo><mn>9.6</mn></mrow><annotation encoding="application/x-tex">b_1 = 0.8 \times 10 + 0.2 \times 8 = 8 + 1.6 = 9.6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.6</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9.6</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>2</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>9.6</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>12</mn><mo>=</mo><mn>7.68</mn><mo>+</mo><mn>2.4</mn><mo>=</mo><mn>10.08</mn></mrow><annotation encoding="application/x-tex">b_2 = 0.8 \times 9.6 + 0.2 \times 12 = 7.68 + 2.4 = 10.08</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">9.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">12</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">7.68</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2.4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10.08</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>3</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>10.08</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>9</mn><mo>=</mo><mn>8.064</mn><mo>+</mo><mn>1.8</mn><mo>=</mo><mn>9.864</mn></mrow><annotation encoding="application/x-tex">b_3 = 0.8 \times 10.08 + 0.2 \times 9 = 8.064 + 1.8 = 9.864</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">10.08</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">8.064</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.8</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9.864</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>4</mn></msub><mo>=</mo><mn>0.8</mn><mo>×</mo><mn>9.864</mn><mo>+</mo><mn>0.2</mn><mo>×</mo><mn>11</mn><mo>=</mo><mn>7.8912</mn><mo>+</mo><mn>2.2</mn><mo>=</mo><mn>10.0912</mn></mrow><annotation encoding="application/x-tex">b_4 = 0.8 \times 9.864 + 0.2 \times 11 = 7.8912 + 2.2 = 10.0912</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.8</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">9.864</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">11</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">7.8912</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2.2</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10.0912</span></span></span></span></span></li>
</ol>
<p>最终平滑后的序列约为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>b</mi><mo>=</mo><mo stretchy="false">[</mo><mn>9.6</mn><mo separator="true">,</mo><mn>10.08</mn><mo separator="true">,</mo><mn>9.864</mn><mo separator="true">,</mo><mn>10.0912</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">b=[9.6,10.08,9.864,10.0912]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">9.6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">10.08</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9.864</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">10.0912</span><span class="mclose">]</span></span></span></span></span></div>
<p>可以看出，原本波动较大的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>8</mn><mo separator="true">,</mo><mn>12</mn><mo separator="true">,</mo><mn>9</mn><mo separator="true">,</mo><mn>11</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[8, 12, 9, 11]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">12</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">11</span><span class="mclose">]</span></span></span></span></span> 被平滑为一个变化更缓和的序列。</p>
<p>为什么这个公式能让一个曲线变得更加平滑呢？其实很好理解，从“惯性”的角度来看。当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 很大（比如 0.9）时，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">b_{n-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span> 在更新中占据很大比重，当前的新值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">a_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 只占很小的比例，这意味着平滑序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> 具有强烈的“记忆”能力，不会因为某一点的突变而产生剧烈波动。反之，如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 很小（比如 0.1），则平滑序列会更紧密地跟踪原始数据的变化，适应更快，但平滑效果减弱。</p>
<p>不知道到这里你发现没有，上面的式子虽然能很好的平滑序列，但是有一个缺点，就是在序列刚开始的时候容易“失真”。从上面的展开式也可以看出，在序列开始时，我们令<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0 = a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，由于历史数据较少，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的权重 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 较大，若 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo></mrow><annotation encoding="application/x-tex">a_1, a_2, …</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span></span></span></span></span> 差异明显，就会导致平滑序列初期出现“失真”。下面这张图就清晰展示了这个问题：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd8a0a6dd9984587b801b071ec9791fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=Nczhtvds9i134sD98T4vVvE9eck%3D" alt="c3.jpg" loading="lazy"/></p>
<p>蓝色是原始曲线，红色是指数加权平均后的曲线。明显可见，红色曲线在开始阶段比蓝色高出不少，这是因为我们初始设置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">b_0 = a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，而 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 可能恰是一个较大或较小的异常值，影响了后续若干点的平滑结果。</p>
<p>那么如何解决这种失真呢，方法有很多，常用的解决方法之一是<strong>使用序列前若干点的平均值作为初始值</strong>，而不是直接使用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
<p>具体做法是：</p>
<ol>
<li>选取一个合适的初始窗口长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">k=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">k=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span></span></span></span></span>，根据序列总体长度和噪声情况决定）。</li>
<li>计算前 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个原始数据的平均值：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>0</mn></msub><mo>=</mo><mfrac><mn>1</mn><mi>k</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>k</mi></msubsup><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">b_{0} = \frac{1}{k}\sum_{i=1}^{k}a_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.334em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
</ol>
<p>这样做的优点是能够抵消个别异常点对平滑初期的影响，使平滑曲线从一开始就更贴合数据的整体趋势。一般来说，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 不宜过大，否则会引入不必要的滞后；如果数据在开始阶段变化剧烈，也可适当缩小 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>，让平滑过程更快适应当前趋势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da406e11240c4f8ea7fe0b39fc3b3ef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=d2mEb3xH99mi3fkf%2FcougtEuaKI%3D" alt="c4.jpg" loading="lazy"/></p>
<hr/>
<p>接下来，我们用Python来实际操作演示一下指数加权平均的效果。这个例子会用到NumPy和Matplotlib库，我们将一步步生成带噪声的序列，并用不同参数进行平滑处理。</p>
<p>首先，引入必要的库，并定义一个用于生成平滑随机序列的辅助类<code>SmoothRandomSequence</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> random

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SmoothRandomSequence</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, low, high, initial_value=<span class="hljs-literal">None</span>, max_step=<span class="hljs-literal">None</span></span>):
        self.low = low
        self.high = high
        self.range_width = high - low
        <span class="hljs-keyword">if</span> initial_value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.current = random.uniform(low, high)
        <span class="hljs-keyword">else</span>:
            self.current = <span class="hljs-built_in">min</span>(high, <span class="hljs-built_in">max</span>(low, initial_value)) 
        <span class="hljs-keyword">if</span> max_step <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.max_step = self.range_width * <span class="hljs-number">0.1</span>  
        <span class="hljs-keyword">else</span>:
            self.max_step = max_step
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next</span>(<span class="hljs-params">self</span>):
        step = random.uniform(-self.max_step, self.max_step)
        next_value = self.current + step
        <span class="hljs-keyword">if</span> next_value &lt; self.low:
            next_value = self.low + (self.low - next_value) 
        <span class="hljs-keyword">elif</span> next_value &gt; self.high:
            next_value = self.high - (next_value - self.high)  
        next_value = <span class="hljs-built_in">max</span>(self.low, <span class="hljs-built_in">min</span>(self.high, next_value))
        self.current = next_value
        <span class="hljs-keyword">return</span> next_value
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sequence</span>(<span class="hljs-params">self, n</span>):
        sequence = [self.current]
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n - <span class="hljs-number">1</span>):
            sequence.append(self.<span class="hljs-built_in">next</span>())
        <span class="hljs-keyword">return</span> sequence
</code></pre>
<p>这个<code>SmoothRandomSequence</code>类的具体实现细节不重要，你只需要知道它能生成一个在指定范围内波动、变化相对平滑的随机序列，模拟真实场景中带有噪声的数据。</p>
<p>现在，让我们使用这个类来生成一个包含300个数据点的原始序列：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建平滑随机数生成器实例</span>
<span class="hljs-comment"># 设置范围0到60，初始值20，最大步长3</span>
generator = SmoothRandomSequence(low=<span class="hljs-number">0</span>, high=<span class="hljs-number">60</span>, initial_value=<span class="hljs-number">20</span>, max_step=<span class="hljs-number">3</span>)

<span class="hljs-comment"># 生成300个随机数的原始序列</span>
noise_array = np.array(generator.generate_sequence(<span class="hljs-number">300</span>))

<span class="hljs-comment"># 绘图</span>
fig, ax = plt.subplots(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">3</span>))
ax.plot(noise_array)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92011f6bdc2349c18bc1d0e7a2a69f33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=Yx%2Bih1h7KXZxdalMLa9dnsMPbko%3D" alt="c6.jpg" loading="lazy"/></p>
<p>然后写一个名为<code>exponential_weighted_average</code>的函数，这个函数需要传入一个原始numpy序列，beta值和初始窗口大小<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span>就可以返回平滑后的序列，返回的序列类型也是numpy序列</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">exponential_weighted_average</span>(<span class="hljs-params">sequence, beta, initial_window=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    参数:
    sequence: numpy数组，原始序列
    beta: 平滑因子，取值范围0~1
    initial_window: 用于计算初始平均值的窗口大小

    返回:
    平滑后的序列，长度与原始序列相同
    """</span>
    n = <span class="hljs-built_in">len</span>(sequence)
    smoothed = np.zeros(n)

    <span class="hljs-comment"># 计算初始值</span>
    <span class="hljs-keyword">if</span> initial_window <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> initial_window &gt; <span class="hljs-number">0</span>:
        k = <span class="hljs-built_in">min</span>(initial_window, n)
        smoothed[<span class="hljs-number">0</span>] = np.mean(sequence[:k])
    <span class="hljs-keyword">else</span>:
        smoothed[<span class="hljs-number">0</span>] = sequence[<span class="hljs-number">0</span>]

    <span class="hljs-comment"># 迭代计算指数加权平均</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, n):
        smoothed[i] = beta * smoothed[i - <span class="hljs-number">1</span>] + (<span class="hljs-number">1</span> - beta) * sequence[i]

    <span class="hljs-keyword">return</span> smoothed
</code></pre>
<p>最后，我们使用上面定义的<code>exponential_weighted_average</code>函数，来计算并且绘制三种不同<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span>下的平滑后的曲线</p>
<pre><code class="hljs language-python" lang="python">fig, ax = plt.subplots(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">3</span>))

<span class="hljs-comment"># 计算三种不同beta下的平滑结果</span>
array1 = exponential_weighted_average(noise_array,beta = <span class="hljs-number">0.95</span>,initial_window=<span class="hljs-number">4</span>)
array2 = exponential_weighted_average(noise_array,beta = <span class="hljs-number">0.9</span>,initial_window=<span class="hljs-number">4</span>)
array3 = exponential_weighted_average(noise_array,beta = <span class="hljs-number">0.8</span>,initial_window=<span class="hljs-number">4</span>)

<span class="hljs-comment"># 绘制</span>
ax.plot(noise_array)
ax.plot(array1, label=<span class="hljs-string">r"$\beta$=0.95"</span>)
ax.plot(array2, label=<span class="hljs-string">r"$\beta$=0.9"</span>)
ax.plot(array3, label=<span class="hljs-string">r"$\beta$=0.8"</span>)
ax.legend()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4b73f0b350446cf9290896b6eee913e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080970&amp;x-signature=qOnAxiMS2uD%2Bt%2F%2FgqGy39NK0xfg%3D" alt="c7.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[慢 SQL 诊断准确率 99.99%，天翼云基于 Apache Doris MCP 的 AI 智能运维实践]]></title>    <link>https://juejin.cn/post/7586890269699653686</link>    <guid>https://juejin.cn/post/7586890269699653686</guid>    <pubDate>2025-12-23T09:28:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586890269699653686" data-draft-id="7586889698242756671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="慢 SQL 诊断准确率 99.99%，天翼云基于 Apache Doris MCP 的 AI 智能运维实践"/> <meta itemprop="keywords" content="数据库,Apache,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T09:28:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            慢 SQL 诊断准确率 99.99%，天翼云基于 Apache Doris MCP 的 AI 智能运维实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:28:00.000Z" title="Tue Dec 23 2025 09:28:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>天翼云是中国电信旗下一家科技型、平台型、服务型公司，以“云网融合、安全可信、绿色低碳、生态开放”四大优势，为客户提供公有云、私有云、专属云、混合云、边缘云全栈云服务。<strong>天翼云在 Apache Doris 上的应用规模庞大，已在生产环境中落地超 30 个项目，覆盖广泛的业务场景，展现出大规模、多类型场景并行运行的特征</strong>。</p>
<p>而在大规模集群部署的背景下，我们在运维上面临以下几项挑战：</p>
<ul>
<li><strong>故障频发，排查费时费力</strong>：集群数量庞大，场景应用复杂，故障和问题频发（日均 10+）。问题可能出现在不同层面（如硬件、网络、软件等），快速定位及解决问题需要较高技术能力和丰富经验，耗费大量人力和时间。</li>
<li><strong>运维负担重，问题发现滞后</strong>：运维人员需投入大量精力和时间分析集群的健康指标，不仅工作效率低下，且难以发现潜在问题及隐患，集群稳定性堪忧。</li>
<li><strong>监控告警过载</strong>：在管理众多的 Doris 集群时，运维团队常面临告警过载的问题，这使运维人员难以区分真实故障和误报，重要告警可能被忽视。</li>
<li><strong>版本升级风险高</strong>：不同集群可能运行着不同的版本，这使维护一致性和兼容性变得复杂。同时，升级过程的不稳定性可能导致功能失效或数据丢失，严重影响业务连续性。</li>
</ul>
<h2 data-id="heading-0">Apache Doris MCP Server</h2>
<p>在当前大规模生产环境中，运维团队在日常问题处理上资源紧张，人力长期处于捉襟见肘的状态。为应对这一挑战，团队经过持续探索，<strong>逐步明确了通过</strong> <strong>AI</strong> <strong>技术提升运维效率的方向，旨在构建智能运维体系，实现整体效率的提升</strong>。</p>
<p>2024 年下半年，Anthropic 公司发布了 MCP 协议。通过 MCP 协议，AI Agent 可以实现智能工具调用，可根据运维场景自动选择和组合多个监控、诊断、治理工具，形成完整的运维治理工作流。</p>
<p>面对 Data Agent 时代的巨大机遇，各大数据库厂商纷纷推出了自己的 MCP Server 解决方案。然而，通过深入的技术分析和实际测试，我们发现这些解决方案在功能完整性、技术先进性和企业适用性方面存在巨大差异。</p>
<p>Apache Doris MCP Server 以其卓越的技术实力和完整的功能体系，成为了 Data Agent 时代的完美答案。Apache Doris MCP Server 不仅在数量上提供了业界最丰富的 25 个专业工具，更重要的是在质量和深度上实现了全面超越。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaa367024669425c86b611bdccdecbd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=iQbbFIKEhmzxbRuVyWTpKzE2o8k%3D" alt="Apache Doris MCP Server.PNG" loading="lazy"/></p>
<p>Apache Doris MCP  Server 是一个基于 Python 和 FastAPI 构建的后端服务，支持客户端通过已定义的“工具”与其进行交互。该服务主要用于连接 Apache Doris 数据库，并利用大语言模型（LLM）执行多种任务，例如将自然语言查询转换为 SQL（NL2SQL）、执行查询，以及进行元数据管理与分析。</p>
<blockquote>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fdoris-mcp-server" target="_blank" title="https://github.com/apache/doris-mcp-server" ref="nofollow noopener noreferrer">github.com/apache/dori…</a></p>
</blockquote>
<p><strong>在天翼云智能运维体系的搭建中，主要依赖于 Apache Doris MCP 完成，尤其是在任务智能诊断及集群健康诊断这两项主要能力</strong>。接下来将对具体的实现及重难点进行详细介绍。</p>
<h2 data-id="heading-1">基于 Doris + AI 的智能运维体系</h2>
<h3 data-id="heading-2">1. 任务智能诊断</h3>
<p>任务诊断的核心在于如何有效利用人力资源，高效应对大量生产集群持续出现的问题，降低排查门槛，使更多人员甚至客户能具体问题排查及分析的能力。同时，由于客户对 Apache Doris 的使用经验有限，就需要提供工具化手段、缩短问题排查时间、提升整体运维效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a5dd78239f548a29532610613d96f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=SRfl32iR2%2FyNEQzG2pc%2BMNci%2FxA%3D" alt="任务智能诊断.PNG" loading="lazy"/></p>
<p>任务诊断的第一步，是基于策略或 AI 对集群内所有任务（包括运行中和历史任务）进行综合分析，以识别出应优先处理的 Top-N 任务。之所以需要这一筛选，是因为在实际操作中难以逐一排查所有任务，因此该步骤成为保障诊断效率的必经环节。</p>
<p><strong>筛选手段包括 AI 分析和基于 MCP 工具的手段，目前阶段我们主要依赖扩展后的</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1430" target="_blank" title="https://www.selectdb.com/blog/1430" ref="nofollow noopener noreferrer"> Apache Doris MCP 工具</a><strong>，以获取 Top-N 任务</strong>。在识别目标任务后，需要进一步获取与任务分析相关的运行时信息，包括 Profile 信息、任务信息、审计数据及相关监控指标等。根据这些信息，任务诊断分为两个层面的评估：</p>
<ul>
<li><strong>任务整体评估</strong>：对所有入选任务进行整体分析，包括运行时间、CPU 及内存资源消耗、数据扫描情况及其对集群整体的影响，并基于此生成统一的综合评估报告和优化建议。</li>
<li><strong>任务级细化分析</strong>：针对筛选出的 Top-N 任务，进行深入的单任务分析，关注其 Pipeline 运行情况和算子执行情况等更细粒度的信息。基于这些指标，系统将生成更具针对性的优化建议，帮助进一步定位性能瓶颈或运行异常。</li>
</ul>
<h4 data-id="heading-3">1.1 提升 AI 精确度</h4>
<p>虽然 AI 在很多常见场景中已取得广泛成功，但在专业性较强、知识体系复杂的领域，其表现仍显不足。尤其在直接向模型提问时，常常会生成不够准确，甚至偏差或不相关的回答。因此，<strong>提升 AI 在专业场景中的准确性成为首要挑战</strong>。为提升 AI 精确度，我们主要采取两类手段：</p>
<p><strong>A. 提示词（SOP）</strong>：</p>
<p>通过提供清晰且结构化的提示词，可以规范 AI 的分析路径。例如，</p>
<ul>
<li><strong>在提取 Top-N 任务时</strong>，为 AI 提供相应的提示词；在执行整体评估时，通过明确的提示词指引 AI 的分析思路，而非让其自由发挥。</li>
<li><strong>在任务评估时</strong>，要求 AI 针对特定维度进行分析，如运行时间、资源消耗（CPU 和内存）、数据扫描情况及其对集群的影响等。通过结构化的 SOP 限制 AI 的分析框架，使其在指定范围内输出更稳定、可靠的评估内容。</li>
<li><strong>在单任务分析时</strong>，同样采取类似方式，通过提示词引导其从 Pipeline 运行情况和算子执行等细粒度角度进行分析。</li>
</ul>
<p>如下图所示，展示了提供给 AI 的提示词结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f57a42f39eb4003bf6bb52ae7ab39be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=aTTWEJLBdWyusJRFAsU1%2FaL65Mk%3D" alt="任务智能诊断-1.png" loading="lazy"/></p>
<p>然而，单靠 SOP 仍不足以保障准确性，原因是未经训练的 AI 模型通常缺乏专业知识，对领域概念的理解有限，容易生成模棱两可或仅停留在通用层面的回答，这与生产环境需求存在明显差距。因此，需要为 AI 提供专业知识的载体。</p>
<p><strong>B. MCP:</strong></p>
<p>当前较为有效的方式是引入 MCP，其具有两个核心特性：专业性和集成性。</p>
<ul>
<li>专业性体现在可以针对不同领域构建相应的 MCP，提供所需的专业知识与工具能力；</li>
<li>集成性意味着 MCP 能作为能力接口，将外部工具、文档和知识库接入，为 AI 提供可调用的专业支持。通过这两个特性，MCP 有效补充了模型在专业场景中的知识缺失。</li>
</ul>
<p>在本场景中，团队主要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1404" target="_blank" title="https://www.selectdb.com/blog/1404" ref="nofollow noopener noreferrer">Apache Doris 的 MCP</a>，并进行了大量优化，以满足实际需求。例如，增加了用于获取 Profile 的工具、提取 Task 信息的工具及分析审计记录的工具。同时，还将这些工具与自研的 Profile 可视化工具集成到 MCP 中，使其可在 MCP 体系内被调用。<strong>下图展示了 MCP 工具扩展的部分示例</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40dcd14307ff45f3bc9759b3c434a4e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=ZWYMWDTKEtLqbLH1wg72D%2FiXWJE%3D" alt="任务智能诊断-2.png" loading="lazy"/></p>
<h4 data-id="heading-4">1.2 解决超时与渲染问题</h4>
<p>在提升 AI 诊断能力精准度之后，继而发现这一过程仍存在新的挑战。<strong>由于任务本身具有较高复杂度，若将完整诊断流程以一次性方式交由 AI 执行，往往会因上下文长度过长、分析逻辑过于复杂、生成内容体量较大等因素，导致模型处理超时或中断</strong>。因此，仅依赖单轮交互难以稳定支撑完整诊断过程。</p>
<p>为解决这一问题，我们引入了“分治”的思路，<strong>将原本体量庞大、结构复杂的诊断任务拆解为多个规模更小、边界更清晰的子任务，并通过多次与 AI 交互逐步完成整个诊断流程</strong>。首先通过一定策略锚定慢查询和大导入的任务列表，然后对 TopN 的任务做一个整体的评估，最后在对单任务逐个进行分析。</p>
<p>拆分过程需遵循明确的方法，避免随意切分。核心原则是尽量降低子任务之间的关联度，以防上下文依赖过强而增加负担。<strong>分治策略还带来另一项收益——并行化处理</strong>，拆解后的任务可以进行独立诊断，彼此不存在依赖关系，因此能够并行提交多次请求，让 AI 同时处理多个分析任务。此外，列表提取、整体评估和子任务诊断等流程也可拆分为相互独立的步骤，在并行执行后显著缩短整体诊断耗时。</p>
<p>另一方面，AI 生成的诊断结果通常以大段文字呈现，阅读效率较低，不利于快速理解。<strong>因此需要进一步提升结果呈现方式的可读性与表现力</strong>。为此，利用 AI 提供的格式化输出能力，通过提示词要求模型按指定结构返回数据。通过动态渲染工具把任务表格、任务整体评估报告、单任务的报告一并连接起来，结合图表的强表现力合并成一个完整的分析报告。</p>
<p>示例展示了为 AI 定义的输出格式，用于规范 AI 生成报告的结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaaefe6ba7404f34b68989d04ceac5b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=fa6E38kVxER0sGvNQ2CKd4ccESY%3D" alt="任务智能诊断-3.png" loading="lazy"/></p>
<h4 data-id="heading-5">1.3 实践案例</h4>
<p>在前述优化方案实施后，团队对任务诊断分析的实际效果进行了评估。在下方示例中，诊断了三个具体任务，随后进行整体评估，基于这一组任务生成综合报告。</p>
<ol>
<li><strong>TopN 列表</strong>：首先通过 AI 获取当前集群的慢任务列表，即 Top-N 的慢查询任务。</li>
<li><strong>整体评估</strong>：涵盖多个维度，包括任务执行时间的统计分析、资源消耗的总体情况、数据扫描情况以及任务重分布的相关信息。根据这些信息对该批任务运行状况的全局判断。</li>
<li><strong>综合报告</strong>：借助图表展示任务执行时间分布、CPU 和内存使用情况，使诊断结果更加直观易懂。整体评估中还包含总结性结论与优化建议，为后续的优化工作提供指导。</li>
<li><strong>单任务分析</strong>：进一步对单任务深入分析，包括 Top-10 耗时算子、各算子的执行时长与平均时长，以及任务执行过程中的资源消耗和扫描数据量等。这些信息共同构成了单任务级别的执行报告。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb9c797a3cc44c2fafb12e8647a15d25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=LfMo5Y1%2FWhRaxFR40sdQACElaJU%3D" alt="任务智能诊断-4.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5b6eba97ecf412f8f0ca832a3569525~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=I6d6k2Vx%2B6BqwriDmz1U0hAQmok%3D" alt="任务智能诊断-5.png" loading="lazy"/></p>
<h4 data-id="heading-6">1.4 使用收益</h4>
<p>过去如果需要对一个集群的慢 SQL 进行全面分析，即便投入一到两小时也未必能够完成。而在引入  Doris MCP Server + AI 之后，<strong>慢 SQL 的分析结果基本能够在 5 分钟内生成，执行效率提升约为 95.8%，准确率从 80% 提升至于 99.99%</strong>，这一数值同样较为保守，人工排查很多情况下准确率不足 60% ，且花费时间更长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ace44e6515294703a5a951f9a2922a1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=dmUFMpSxq%2BRm%2BuAIg36po%2FMG9XM%3D" alt="任务智能诊断-6.png" loading="lazy"/></p>
<h3 data-id="heading-7">2. 集群健康诊断</h3>
<p>基于 AI 的智能运维体系中，另一项关键任务是集群健康诊断。这项工作旨在应对监控告警过载和问题发现滞后带来的运维负担以及业务稳定性挑战，从而提升运维效率和响应速度。</p>
<p><strong>集群健康的诊断主要分为两种</strong>：</p>
<ul>
<li><strong>被动式监控告警触发</strong>：首先将监控告警输入 AI，AI 通过分析告警和相关处理 SOP，决定对集群的哪些方面进行评估，并提供修复建议。</li>
<li><strong>主动式定期体检</strong>：定期对集群进行体检，包括任务运行情况、集群节点的 CPU/内存使用情况、表健康度以及数据压缩（compaction）等。</li>
</ul>
<p>集群诊断能力同样依赖 MCP 和 SOP，以确保诊断的准确性。在这一环节中，我们进一步扩展了多个 MCP 工具，使 AI 能够更精准地完成专业分析任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a1f2fee9104346ab6029de68ff1cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=QbOWd1jsEP5Lqi44TEJ9OgtC5Cs%3D" alt="集群健康诊断.png" loading="lazy"/></p>
<h4 data-id="heading-8">2.1 集群智能诊断的关键</h4>
<p>如何评估 Apache Doris 中表的健康度？这一过程需要专业知识。表的健康度评估包括多个维度，如分区情况、tablet 状态、版本健康度、副本健康度及 segment 数量等。这与机器健康、存储健康和压缩的评估方法相似，都依赖特定公式将相关指标组合，计算出健康度结果。</p>
<p>以表级健康度为例，尽管流程概述简单，但其内部包含复杂的计算逻辑。</p>
<blockquote>
<p>公式如下： <strong>表健康度 = 分区健康度 * 0.05 + tablet 健康度 * 0.3 + 版本健康度 * 0.25 + 副本健康度 * 0.3 + segment 健康度 * 0.1</strong></p>
</blockquote>
<p>在评估 tablet 健康度时，我们统计表级的分桶总数和最大分桶大小，并计算标准方差，以识别潜在的数据倾斜情况。例如，某些分桶过大而另一些过小时，需要结合方差值进行判断。此外，最大分桶的大小也需关注，因为分桶过大会影响查询效率，而分桶过小则可能导致 segment 数量过多，进而影响查询性能。查询效率与典型的“漏斗模型”密切相关，过多的 segment 会加重查询负担。</p>
<p>进一步分析涉及 segment 健康度的计算逻辑。整体而言，健康度计算依赖专业知识，通过精确计算得出真实反映对象健康状况的评分，从而帮助发现潜在问题。</p>
<p>具体的计算公式可见：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba3782287c594db5bdc3447c937f7150~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=qKo2TfJo4Vr9CrxoGaBYD2DFk%2B0%3D" alt="集群健康诊断-1.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f89fb3eb3eb4e01858399f1d11b5ef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=guCTXk7eLvQIxeZv0D0ii6MD9lY%3D" alt="集群健康诊断-2.png" loading="lazy"/></p>
<h4 data-id="heading-9">2.2 实践案例</h4>
<p>具体可见下方示例：</p>
<ul>
<li>导入任务及热点表分析：包括导入任务数量、写入文件总数、写入总行数以及写入数据的总体大小等指标。可识别哪些表被频繁导入，以及这些表的版本变化趋势。相关信息通过可视化图表进行呈现，以增强诊断结果的表达效果。</li>
<li>表级健康诊断：以表健康度为例，体现了 AI 基于这些信息生成的诊断结果，包含分区健康度、tablet 健康度、版本健康度、副本健康度以及 segment 健康度。基于上述各项指标，汇总计算出该表的整体健康度。</li>
<li>热点表及图表呈现：热点表的效果图，用于呈现热点查询等相关情况。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88975fb2ad9f47219587767905667428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=k%2F9pYPNk9Shz%2FYGDpnCFhQEvsZ8%3D" alt="集群健康诊断-3.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df8342f0d65a499aa75b6e2345ea63df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=ZIiYroigg5kI5DSKkc9cPJwHH0U%3D" alt="集群健康诊断-4.png" loading="lazy"/></p>
<h4 data-id="heading-10">2.3 使用收益</h4>
<p>过去依赖人工进行分析。若对一个集群进行巡检并分析结果，需要检查多项指标并、逐个排查各组件和模块，整个流程需要六个小时才能完成，还需形成诊断结论。在使用 AI 之后，<strong>这一过程的整体耗时大幅缩短，完整的集群诊断基本可在 10 分钟左右完成</strong>，并能够提前发现潜在问题，无需等到故障发生后再进行处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc6a7dd63ae449aaba62144187f0a550~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=kbiwepCvj9lhKdqLcB3T6CVB02E%3D" alt="集群健康诊断-5.png" loading="lazy"/></p>
<h3 data-id="heading-11">版本质量保障</h3>
<p>我们建立了一套自动化质量评估体系，主要用于解决前文提到的版本数量多、发版风险高等问题，避免新版本对生产环境造成影响。该体系的主要思想就是在版本发布之后通过自动化流程把 UT、集成测试、性能测试、用户核心 case 都回归测试，再由 AI 对这些结果进行分析，输出诊断结论及相应的优化建议。</p>
<h4 data-id="heading-12">3.1 具体方案：</h4>
<ul>
<li>构建一体化的 CICD 流水线（编译、打包、部署）。</li>
<li>在 UT 和集成测试集成到 CICD 流水线中，采集数据和异常情况并持久化。</li>
<li>自动化部署到 POC 环境后跑 1T 数据规模的 TPC-H 和 TPC-DS，采集数据并持久化。</li>
<li>针对用户核心场景采用一定调度策略（串行、并行）在 POC 上做回归测试，采集测试的结果数据并持久化。</li>
<li>通过 AI 的能力，智能分析所有数据并输出分析报告。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c14b09a15234bc587373fa14ddd173b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=KEO3BcgAJ6lf3JWWyKO6CmYgsc4%3D" alt="版本质量保障.png" loading="lazy"/></p>
<blockquote>
<p>需要说明的是，真实业务场景通常较为复杂，可能同时涉及数据导入、查询，以及查询之间的串行或并行运行模式。在不同场景下，某些查询组合在并行状态下可能会出现问题，而这些组合关系本身具有一定讲究。因此，未来可以通过引入更多策略，让 AI 根据用户用例自动完成任务调度设计，例如根据已有用户用例自动规划任务组合，以便更有效地暴露潜在问题。</p>
</blockquote>
<p>质量报告的示例中包含多类测试的结论。例如，UT 测试结论以及与历史版本之间的对比结果都会在报告中呈现，测试的结论、性能测试的结果以及相关的测试图表。通过这些测试数据，AI 会生成关于整体质量状况的分析及优化建议。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37c12af8604e4799a95e8bbde769c7ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=WvSVJE6FhUSfNNR8Q1xMRgDVljM%3D" alt="版本质量保障-1.png" loading="lazy"/></p>
<h4 data-id="heading-13">3.2 使用收益</h4>
<p><strong>在版本质量方面</strong>，以前发布新版本时，需执行单元测试、部署至 POC 环境并进行测试等多个步骤，这些流程都需要投入大量人力和时间。此外，测试结果的分析同样需要手工完成，整体资源消耗较大。</p>
<p>在自动化体系建立后，这些流程均可由系统自动执行。尽管完整流程大约需要 5 个小时，但在<strong>此期间几乎不需要人工干预，只需一键触发等待结果</strong>。5 个小时主要是在单元测试、数据导入以及与 POC 环境的集成。如果环境资源充足，编译和单元测试执行速度更快，整体耗时有望进一步降低。</p>
<p><strong>在质量保障方面</strong>，过去的代码合并和 BUG 发现主要依赖人工，可控性较低。引入 AI 后，这些过程得以统一处理，<strong>质量评估准确率可达 80%</strong>。如果用户用例模型更加完善，测试场景更丰富，并允许 AI 自主组合用例进行测试，则潜在问题更可能提前暴露，进一步提升质量保障能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/146b3526c6904744923286fd40f681a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=uoZL4gnf%2FWF7%2FfnydmWs0xzCNsE%3D" alt="版本质量保障-2.png" loading="lazy"/></p>
<h2 data-id="heading-14">未来规划</h2>
<p>当前，基于 AI 的智能运维主要落地在上述三个场景中，未来我们还将进一步推广至更丰富场景中。不仅如此，未来在能力的扩展下，我们还将进行以下工作：</p>
<ul>
<li>智能运维：持续完善和优化智能运维的工具，并通过优化 MCP 和 Doris 内核来提升 AI 诊断的准确率和性能问题。</li>
<li>智能咨询：通过 AI 的能力+专业知识库向用户提供专业的咨询能力。</li>
<li>内核优化：持续完善和优化 Doris 内核的功能和性能。</li>
<li>存算分离：推出 3.x 的版本来解决用户对存算分离的需求包括多 AZ 的容灾、数据共享、湖仓一体等。
长按下方二维码，回复「<strong>1218</strong>」加入 Doris 社区交流群，并<strong>免费领取 Doris x Al 和100+ 企业实践案例集</strong>，获取技术帮助、了解最新动态，并与更多开发者和用户互动。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fdc045240464e04abb85054a60d90c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086879&amp;x-signature=Vpcw0G%2BQS%2BHIqfxMUSbqsAJQYZI%3D" alt="Doris 小助手二维码" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当中断绑核遇上大模型推理：HostBound 问题优化全解析（昇腾深度实战版）]]></title>    <link>https://juejin.cn/post/7586610067569229824</link>    <guid>https://juejin.cn/post/7586610067569229824</guid>    <pubDate>2025-12-23T08:43:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067569229824" data-draft-id="7586687526867140623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当中断绑核遇上大模型推理：HostBound 问题优化全解析（昇腾深度实战版）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T08:43:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="扑克中的黑桃A"/> <meta itemprop="url" content="https://juejin.cn/user/1106580348609019"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当中断绑核遇上大模型推理：HostBound 问题优化全解析（昇腾深度实战版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1106580348609019/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    扑克中的黑桃A
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:43:19.000Z" title="Tue Dec 23 2025 08:43:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a83cd56a850c426eaa9c2018996799d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=XelnrMD3oZ1ryI7t5taPZ0SU9ig%3D" alt="" loading="lazy"/></p>
<hr/>
<p>在大模型推理性能调优的过程中，我们经常会遇到一个令人头疼的现象——<strong>HostBound</strong>。CPU 明明没有满载，但推理速度就是慢，Profiling 一看，全是“空泡”。 调试分析之后有点发现，最终我发现问题是在一个经常被忽略的角落：<strong>IRQ</strong>** 中断机制与中断绑核**。</p>
<p>因此本文结合<strong>昇腾平台</strong>的实际测试，从 IRQ 工作机制、irqbalance 调度策略，到如何通过绑核优化推理性能，完整还原这次 HostBound 问题的排查与优化过程。</p>
<hr/>
<h2 data-id="heading-0">一、背景：从 HostBound 说起</h2>
<p>在大模型推理时，Host 侧算子进入下发队列后，会依次触发两个关键中断事件：</p>
<ul>
<li><code>sq_send_trigger_irq</code>：算子下发触发；</li>
<li><code>cq_update_irq</code>：算子执行完成后上报。</li>
</ul>
<p>这两个中断的发生 CPU 核通常是固定的。 而如果此时业务线程恰好也绑定在相同的 CPU 核上，就会出现频繁的任务打断，导致 CPU 空泡显著增加，形成典型的 <strong>HostBound 问题</strong>。</p>
<p>在默认情况下，如果系统安装并启用了 <code>irqbalance</code> 服务，它会定期（默认 10 秒）重新分配中断，使中断均衡分布在多个 CPU 上。 但对于推理这种极端计算密集型场景，这种“自动平衡”反而可能带来性能抖动甚至劣化。</p>
<hr/>
<h3 data-id="heading-1">为什么在昇腾平台上 HostBound 更明显？</h3>
<p>与 GPU 不同，昇腾 NPU 采用 <strong>Host/NPU 协同执行架构</strong>。在整个模型推理过程中，CPU 承担了以下关键角色：</p>
<ol>
<li><strong>算子编排、调度与 TaskGen（<strong><strong>CANN</strong></strong> Runtime）</strong></li>
<li><strong>向 AscendCL/DevDrv 下发任务，触发 sq_send_trigger_irq</strong></li>
<li><strong>等待 <strong><strong>NPU</strong></strong> 完成 cq_update_irq <strong><strong>回调</strong></strong>，用于同步下一步调度</strong></li>
<li><strong>部分算子的 Host 侧逻辑，如 shape 计算、LayerNorm 前置操作等</strong></li>
</ol>
<p>昇腾框架（CANN + torch-npu）比 GPU 更依赖 CPU 的调度链路，因此 CPU 不仅需要供能（Host Control），还承担巨量 Host 侧同步逻辑。</p>
<p><strong>NPU</strong>** 每执行一次算子 → 至少两次 <strong><strong>IRQ</strong></strong>：**</p>
<ul>
<li><code>sq_send_trigger_irq</code>（下发）</li>
<li><code>cq_update_irq</code>（完成）</li>
</ul>
<p>而大模型推理 <strong>每生成一个 token 会触发数百到上千个算子调度</strong>，即会产生成千上万次中断。</p>
<p>因此，昇腾平台比 GPU 更容易出现一个现象：</p>
<p><strong>CPU 被高频中断打断，导致 HostBound，即使 CPU 利用率不高，也会出现严重空泡。</strong></p>
<hr/>
<h2 data-id="heading-2">二、了解 IRQ 与 irqbalance 的机制</h2>
<h3 data-id="heading-3">1. 什么是硬件中断？</h3>
<p>**中断（Interrupt）**是一种“打断当前程序执行”的机制。 当外设（如 NPU、网卡、定时器）有事件发生时，会通知 CPU 中断当前任务，执行一段专门的“中断服务程序（ISR）”。 这样可以保证 CPU 能及时响应设备请求，而不是傻等。</p>
<p>举个例子，当 NPU 执行完算子后，需要告诉 CPU “我完成了”，这个信号就是一次中断。 如果中断太频繁，CPU 就会被不断“打断”，算子调度效率明显下降。</p>
<hr/>
<h3 data-id="heading-4">2. 中断的注册与维护</h3>
<p>设备驱动加载时会通过 <code>request_irq()</code> 注册中断，系统会分配一个 IRQ ID。 所有中断状态都可以在 <code>/proc/interrupts</code> 中查看，例如：</p>






























































































































<table><thead><tr><th><strong>IRQ</strong>** ID**</th><th><strong>CPU0</strong></th><th><strong>CPU1</strong></th><th><strong>CPU2</strong></th><th><strong>CPU3</strong></th><th><strong>控制器类型</strong></th><th><strong>硬件中断号</strong></th><th><strong>触发方式</strong></th><th><strong>中断源</strong>**/设备**</th></tr></thead><tbody><tr><td>8</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>22</td><td>Level</td><td>vgic</td></tr><tr><td>9</td><td>0</td><td>12</td><td>0</td><td>0</td><td>GICv3</td><td>28</td><td>Level</td><td>kvm guest ptimer</td></tr><tr><td>10</td><td>45</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>29</td><td>Level</td><td>kvm guest vtimer</td></tr><tr><td>11</td><td>256</td><td>0</td><td>0</td><td>432</td><td>GICv3</td><td>30</td><td>Level</td><td>arch_timer</td></tr><tr><td>12</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>140</td><td>Edge</td><td>uart-pl011</td></tr><tr><td>15</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>490</td><td>Level</td><td>HISI0173:00</td></tr><tr><td>16</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>482</td><td>Level</td><td>HISI02A2:00</td></tr><tr><td>17</td><td>0</td><td>0</td><td>0</td><td>0</td><td>GICv3</td><td>25</td><td>Level</td><td>arm-pmu</td></tr><tr><td>19</td><td>0</td><td>0</td><td>0</td><td>0</td><td>ITS-MSI</td><td>0</td><td>Edge</td><td>PCIe PME</td></tr><tr><td>20</td><td>0</td><td>0</td><td>0</td><td>0</td><td>ITS-MSI</td><td>1</td><td>Edge</td><td>aerdrv</td></tr></tbody></table>
<p>从上表我们可以看出系统中不同中断事件的触发情况：</p>
<ul>
<li><strong>IRQ</strong>** ID（中断号）**：表示系统为每个硬件设备或虚拟设备分配的中断标识符。</li>
<li><strong>CPU0-CPU3 列</strong>：表示各个 CPU 核上处理该中断的次数。 例如，<code>arch_timer</code> 中断在 CPU0 上触发了 256 次、CPU3 上触发了 432 次，而其他核几乎没有触发。</li>
<li><strong>控制器类型（<strong><strong>Controller</strong></strong> Type）</strong>：例如 <code>GICv3</code> 或 <code>ITS-MSI</code>，代表不同类型的中断控制器（前者常见于 ARM 架构，后者用于 PCIe 设备等）。</li>
<li><strong>触发方式（Trigger Type）</strong>：<code>Level</code> 表示电平触发，<code>Edge</code> 表示边沿触发。不同触发方式对应不同的中断响应机制。</li>
<li><strong>中断源</strong>**/设备（<strong><strong>Source</strong></strong>）**：表示是谁产生了中断，比如定时器、串口、PCIe 设备等。</li>
</ul>
<p>在实际大模型推理环境中，你可以通过 <code>cat /proc/interrupts</code> 实时观察到某些中断（例如 <code>sq_send_trigger_irq</code>、<code>cq_update_irq</code>）在某几个 CPU 上触发频率极高。 这通常说明这些中断源被固定绑定在特定 CPU 核上，如果你的推理线程也恰好绑定在同一核，就会造成频繁的中断抢占，进而引起 <strong>HostBound 性能瓶颈</strong>。</p>
<p>因此，在性能优化时，理解并分析这张表非常关键。 它能帮助你判断是否存在“中断集中于少数 CPU 核”的情况，为后续的绑核优化提供数据依据。</p>
<hr/>
<h3 data-id="heading-5">3. irqbalance 的执行逻辑</h3>
<p><code>irqbalance</code> 是 Linux 系统中一个非常重要的后台服务，它的主要职责是——<strong>在多核 CPU 系统中自动平衡中断的分布</strong>，防止某个 CPU 因为频繁处理中断而成为瓶颈。</p>
<p>我们可以这样理解： 如果把每次中断看成“系统电话”，那么 <code>irqbalance</code> 就像一个总机调度员，负责把电话均匀分配给不同的“接线员”（CPU 核心），避免某一个人被电话打爆，而其他人却闲着。</p>
<hr/>
<h4 data-id="heading-6">（1）irqbalance 的工作方式</h4>
<p>irqbalance 每隔一段时间（默认 10 秒）会自动执行以下几个步骤：</p>
<ol>
<li><strong>读取中断分布信息</strong> 它会扫描 <code>/proc/interrupts</code> 文件，统计每个中断号（IRQ ID）在各个 CPU 核上的触发次数。 比如发现 IRQ 1021 在 CPU10 上触发了 10 万次，而其他核几乎为 0，这说明中断分布不均。</li>
<li><strong>分析负载与 NUMA 拓扑</strong> irqbalance 并不会“盲目均衡”，它会考虑 NUMA 拓扑结构，尽量让中断分配在<strong>距离设备最近的 CPU 节点</strong>上。 这样可以减少跨 NUMA 节点访问内存的延迟，兼顾“负载平衡”和“访问效率”。</li>
<li><strong>重新分配中断绑定关系</strong> 通过修改 <code>/proc/irq/&lt;IRQ_ID&gt;/smp_affinity</code> 文件中的掩码值，实现把某个中断“绑”到其他 CPU 核上。 例如，如果 smp_affinity 的值是 <code>0x400</code>，表示该中断仅绑定在 CPU10（第 10 个核）上。</li>
<li><strong>周期性重复评估</strong> irqbalance 会不断循环以上步骤——分析 → 决策 → 调整，从而保持系统的中断分布动态平衡。</li>
</ol>
<hr/>
<h4 data-id="heading-7">（2）irqbalance 的策略特点</h4>
<ul>
<li>它关注的是<strong>中断负载均衡</strong>，而非 CPU 使用率。 即使某个 CPU 正在执行高负载任务，只要它的中断次数较少，irqbalance 仍可能把新的中断分配过去。</li>
<li>对于部分“高频设备”或特殊场景（如 NPU、NVMe SSD），这种自动均衡反而可能带来性能抖动。 因为中断被频繁迁移，会导致 CPU Cache 失效、NUMA 远程访问增加，甚至打断关键计算线程。</li>
<li>irqbalance 的评估周期可调节，通过修改服务参数可实现更细粒度的控制，例如：</li>
</ul>
<pre><code class="hljs language-plain" lang="plain">systemctl edit irqbalance
</code></pre>
<pre><code class="hljs language-plain" lang="plain">[Service]
ExecStart=
ExecStart=/usr/sbin/irqbalance --interval=300
</code></pre>
<ul>
<li>这段配置把默认 10 秒的检测周期改成了 300 秒，从而让中断分配更稳定。</li>
</ul>
<hr/>
<h4 data-id="heading-8">（3）irqbalance 的两种典型用法</h4>
<ul>
<li><strong>通用场景</strong>：默认开启 irqbalance，让它自动维护系统中断均衡，适合普通服务器或多任务场景。</li>
<li><strong>性能敏感场景（如大模型推理）</strong>：手动调整 irqbalance 的策略，或者直接关闭自动调度，通过 <code>--banirq</code> 参数屏蔽关键中断，让开发者自行绑定中断与 CPU 核，实现更可控的性能调优。</li>
</ul>
<hr/>
<p><code>irqbalance</code> 的本意是“让中断更公平”，但在性能调优的世界里，“公平”并不总是“高效”。 理解它的调度逻辑，有助于我们在特定场景下做出更合理的决策。 <strong>什么时候让它自动跑，什么时候让它安静下来。</strong></p>
<h4 data-id="heading-9">（4）查看 /proc/interrupts</h4>
<p>实时监控 IRQ 的命令</p>
<pre><code class="hljs language-plain" lang="plain">watch -n 1 cat /proc/interrupts
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f50f02142ab54911b83b0bd161fa7dba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=4FpVMvV6koOrtyKYbjsAK4vKEK4%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">三、大模型推理中的中断问题</h2>
<p>在大模型推理或训练场景中，NPU 与 CPU 间通信极为频繁。 当中断发生在业务线程所在的 CPU 核上时，推理过程会被频繁打断。Profiling 结果通常表现为：</p>
<ul>
<li><strong>Node@launch 时间增加</strong></li>
<li><strong>CPU 空泡率上升</strong></li>
<li><strong>decode 阶段耗时增长明显</strong></li>
</ul>
<p>如果统计 <code>/proc/interrupts</code>，你甚至会看到“一秒内发生两万次中断”的惊人现象。</p>
<h4 data-id="heading-11">中断频率统计代码</h4>
<pre><code class="hljs language-plain" lang="plain">import time

def read_irq(irq_id):
    with open("/proc/interrupts", "r") as f:
        for line in f:
            if line.strip().startswith(str(irq_id)):
                return list(map(int, line.split()[1:5]))  # CPU0~CPU3
    return None

irq_id = 1014   # 这里填你的 sq_send_trigger_irq
interval = 0.5

prev = read_irq(irq_id)
print(f"监控 IRQ {irq_id} 触发频率... Ctrl+C 退出")

while True:
    time.sleep(interval)
    curr = read_irq(irq_id)
    diff = [c - p for c, p in zip(curr, prev)]
    print(f"{diff} 次 / {interval}s")
    prev = curr
</code></pre>
<p>示例运行效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a787aa40f126446598a9a35f9eb07bad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=blaKMQg4QArfOhEnRZhLud0WxvU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12">四、实验验证：中断绑核前后对比</h2>
<p>为了验证中断分布对大模型推理性能的影响，本文在 <strong>昇腾 800I（A2-A+K 架构，8 卡 * 64GB）平台</strong> 上做了一个对比实验，目标是：</p>
<p><strong>通过中断绑核，观察 HostBound 现象是否得到改善。</strong></p>
<hr/>
<h3 data-id="heading-13">1. 实验环境配置</h3>













































<table><thead><tr><th>组件</th><th>版本/说明</th></tr></thead><tbody><tr><td><strong>服务器硬件</strong></td><td>Ascend 800I（A2-A+K）</td></tr><tr><td><strong>操作系统</strong></td><td>openEuler 22.03 LTS</td></tr><tr><td><strong>驱动版本</strong></td><td>25.0.rc1.1（昇腾 DevDrv 驱动）</td></tr><tr><td><strong>CANN（Compute Architecture for Neural Networks）</strong></td><td>8.2.RC1（昇腾算子库与运行时框架）</td></tr><tr><td><strong>PyTorch</strong></td><td>2.1.0</td></tr><tr><td><strong>torch-npu</strong></td><td>2.1.0.post13.dev20250722（昇腾后端模块，实现 PyTorch→NPU 映射）</td></tr><tr><td><strong>MindIE</strong></td><td>2.1.RC1-800I-A2-py311-openeuler24.03-lts（昇腾推理引擎）</td></tr><tr><td><strong>模型</strong></td><td>Qwen2.5-7B</td></tr><tr><td><strong>Python</strong></td><td>3.11.10</td></tr></tbody></table>
<h3 data-id="heading-14">2. 确定中断分布与 NPU 对应关系</h3>
<p>首先，我们要找到每个 NPU 对应的中断号（IRQ ID）。 通过以下命令查看系统中各 NPU 注册的起始中断号：</p>
<pre><code class="hljs language-plain" lang="plain">cat /proc/interrupts | grep devdrv_load_irq | cut -d: -f1
</code></pre>
<p>输出：</p>
<p>1014 1271 1529 1785 2041 2297 2553 2809</p>
<p>这些数字代表了每个 NPU 模块注册的中断起始编号。</p>
<p>接着，通过 <code>npu-smi info</code> 命令可查看设备的 Bus ID 与注册顺序：</p>
<pre><code class="hljs language-plain" lang="plain">npu-smi info
</code></pre>
<p>输出结果中，每个 NPU 的 Bus ID 和注册顺序可以一一对应，例如：</p>


















































<table><thead><tr><th><strong>NPU ID</strong></th><th><strong>Bus ID</strong></th><th><strong>驱动注册顺序</strong></th></tr></thead><tbody><tr><td>4</td><td>0000:01:00.0</td><td>第 1 个注册</td></tr><tr><td>5</td><td>0000:02:00.0</td><td>第 2 个注册</td></tr><tr><td>6</td><td>0000:41:00.0</td><td>第 3 个注册</td></tr><tr><td>7</td><td>0000:42:00.0</td><td>第 4 个注册</td></tr><tr><td>2</td><td>0000:81:00.0</td><td>第 5 个注册</td></tr><tr><td>3</td><td>0000:82:00.0</td><td>第 6 个注册</td></tr><tr><td>0</td><td>0000:C1:00.0</td><td>第 7 个注册</td></tr><tr><td>1</td><td>0000:C2:00.0</td><td>第 8 个注册</td></tr></tbody></table>
<p>通过对比可以推测，<strong>中断号 1014~1271 属于 NPU0</strong>，以此类推。</p>
<hr/>
<h3 data-id="heading-15">3. 查看目标中断的分布情况</h3>
<p>例如，我们关心某个 NPU 对应的 <code>sq_send_trigger_irq</code> 与 <code>cq_update_irq</code> 中断，可在 <code>/proc/interrupts</code> 中查看这些中断的分布：</p>
<pre><code class="hljs language-plain" lang="plain">grep -E "sq_send_trigger_irq|cq_update_irq" /proc/interrupts
</code></pre>
<p>输出结果如下表：</p>






































<table><thead><tr><th><strong>IRQ ID</strong></th><th><strong>CPU6</strong></th><th><strong>CPU7</strong></th><th><strong>CPU8</strong></th><th><strong>CPU9</strong></th><th><strong>CPU10</strong></th><th><strong>控制器</strong></th><th><strong>触发方式</strong></th><th><strong>中断源</strong></th></tr></thead><tbody><tr><td>1032</td><td>2652</td><td>1426098</td><td>0</td><td>0</td><td>195</td><td>ITS-MSI</td><td>Edge</td><td>sq_send_trigger_irq</td></tr><tr><td>1033</td><td>0</td><td>0</td><td>0</td><td>889344</td><td>0</td><td>ITS-MSI</td><td>Edge</td><td>cq_update_irq</td></tr></tbody></table>
<p>从结果中可以看到，这些中断集中在 CPU7 和 CPU9 上触发非常频繁，这意味着这两个核心在推理过程中被大量中断打断。</p>
<hr/>
<h3 data-id="heading-16">4. 中断绑核方法</h3>
<p>为了减少中断对推理任务的影响，我们将频繁触发的中断绑定到不执行推理线程的 CPU 核上。 操作方法如下：</p>
<ol>
<li><strong>关闭 irqbalance 服务</strong>（防止它自动重新分配中断）：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">systemctl stop irqbalance
</code></pre>
<ol>
<li><strong>修改中断的 smp_affinity 值</strong>：</li>
<li>例如，将 IRQ 1032 绑定到 CPU10：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">echo 0x400 &gt; /proc/irq/1032/smp_affinity
</code></pre>
<ol>
<li>（<code>0x400</code> 表示第 10 个 CPU 核）</li>
<li><strong>设置算子执行绑核</strong>（指定 NPU 对应的 CPU 核）：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">export CPU_AFFINITY_CONF=1,npu2:10,npu3:11
</code></pre>
<ol>
<li>这样，NPU2 的算子绑定在 CPU10，而其中断（如 sq_send_trigger_irq）则绑定在其他 CPU 上，确保两者分离。</li>
</ol>
<hr/>
<h3 data-id="heading-17">5. 实验过程与测试脚本</h3>
<p>为了观察中断频率，我们编写了一个简单脚本模拟高频推理请求：</p>
<pre><code class="hljs language-plain" lang="plain">#!/bin/bash
LOOPS=100000
IRQ_ID="1032"

echo "开始高频推理测试，共 $LOOPS 次请求..."
for ((i=1; i&lt;=LOOPS; i++))
do
  curl -s -X POST -d '{"model": "qwen2.5_7B", "messages": [{"role": "user","content": "请介绍一下QwQ？"}], "max_tokens": 32768, "stream": false}' http://127.0.0.1:3125/v1/chat/completions &gt; /dev/null

  if (( $i % 100 == 0 )); then
    echo "已完成 $i 次请求，中断分布如下："
    grep -E "^$IRQ_ID:" /proc/interrupts
    echo "-----------------------------"
  fi
done
</code></pre>
<p>通过该脚本，我们可以实时观察中断在各个 CPU 上的触发次数随推理进程变化的趋势。</p>
<hr/>
<h3 data-id="heading-18">6. 实验结果对比</h3>
<h4 data-id="heading-19">场景一：算子与中断分离（未在同核）</h4>
<ul>
<li>中断绑定在与算子执行线程不同的 CPU 核。</li>
<li>Profiling 结果显示：
<ul>
<li><strong>Node@launch 时间稳定</strong>；</li>
<li><strong>CPU 空泡较少</strong>；</li>
<li><strong>推理耗时正常</strong>。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e94269869c1d4dde9ee4df3ee9801a90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=g5ghvpTQQHh4wfMZP%2FnwVDXmjzU%3D" alt="" loading="lazy"/></p>
<p>正常情况下的 Profiling</p>
<h4 data-id="heading-20">场景二：算子与中断共用同一 CPU 核（在同核）</h4>
<ul>
<li>将中断和算子线程同时绑定在 CPU10 上。</li>
<li>Profiling 结果显示：
<ul>
<li><strong>Node@launch 时间略有延长</strong>；</li>
<li><strong>CPU 空泡显著增多</strong>；</li>
<li><strong>decode 阶段耗时变长</strong>；</li>
<li>单秒中断次数高达 2 万次以上。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a1c154074164d2890a6b69da0cd15e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=CszUkK7fupSZky%2B8zsqihBnpbcw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccaa245325d0422fa5b985db297bcca3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5omR5YWL5Lit55qE6buR5qGDQQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084199&amp;x-signature=x%2FpX%2FBfldIyL4kJHrZMRI4KYG5g%3D" alt="" loading="lazy"/></p>
<p>中断过多时的 Profiling 截图</p>
<p>这说明：当中断和业务线程争抢同一个核心时，即便中断处理只需微秒级时间，也会造成频繁的任务中断和缓存失效，从而让整体推理时间变长。</p>
<hr/>
<h3 data-id="heading-21">7. 结果分析与结论</h3>
<p>通过对比我们可以得出：</p>
<ul>
<li>中断频率高并非主要问题，<strong>关键在于中断与计算任务是否抢占同一 CPU</strong>；</li>
<li>合理的绑核策略（让算子与中断分离）能有效减少 CPU 抢占和 cache 抖动；</li>
<li>禁用 irqbalance 或配置 <code>--banirq</code> 参数，可防止系统在高负载下频繁调整中断分布。</li>
</ul>
<p>最终结论：</p>
<p><strong>中断绑核是一种低成本、高收益的性能优化手段，尤其在大模型推理场景中，可显著缓解 HostBound 问题。</strong></p>
<hr/>
<h2 data-id="heading-22">五、经验建议</h2>
<ol>
<li><strong>识别关键中断源</strong>：重点关注 <code>sq_send_trigger_irq</code> 与 <code>cq_update_irq</code> 等高频 NPU 中断。</li>
<li><strong>业务与中断分核执行</strong>：确保业务线程与频繁中断不在同一 CPU 核。</li>
<li><strong>NUMA 一致性优先</strong>：绑核时尽量保持任务与中断在同一 NUMA 节点内，减少跨节点访问延迟。</li>
<li><strong>irqbalance 可调节而非一刀切</strong>：
<ol>
<li>可通过 <code>--banirq</code> 精准屏蔽特定中断；</li>
<li>或延长评估周期，让其更“稳定”地运行。</li>
</ol>
</li>
</ol>
<hr/>
<h2 data-id="heading-23">六、结语</h2>
<p>这次 HostBound 调优让可以让我们认识到： <strong>中断并非只是底层系统事件，它对高性能计算任务的干扰可能远超想象。</strong></p>
<p>对于大模型推理、训练这类 CPU 与 NPU 高度耦合的场景，理解并合理利用中断绑核，是性能优化中不可忽视的一环。</p>
<p>当性能陷入瓶颈时，不妨看一眼 <code>/proc/interrupts</code> —— 也许真正打断你的，不是程序本身，而是那些“悄无声息的中断”。</p>
<p>注明：昇腾PAE案例库对本文写作亦有帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战复盘：我为什么把 TypeScript 写的 CLI 工具用 Rust 重写了一遍？]]></title>    <link>https://juejin.cn/post/7586879894207889471</link>    <guid>https://juejin.cn/post/7586879894207889471</guid>    <pubDate>2025-12-23T09:10:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207889471" data-draft-id="7586879894207856703" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战复盘：我为什么把 TypeScript 写的 CLI 工具用 Rust 重写了一遍？"/> <meta itemprop="keywords" content="前端,后端,Rust"/> <meta itemprop="datePublished" content="2025-12-23T09:10:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七月丶"/> <meta itemprop="url" content="https://juejin.cn/user/3685218705751325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战复盘：我为什么把 TypeScript 写的 CLI 工具用 Rust 重写了一遍？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218705751325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七月丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:10:24.000Z" title="Tue Dec 23 2025 09:10:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnianyi778%2Fgix-cli" target="_blank" title="https://github.com/nianyi778/gix-cli" ref="nofollow noopener noreferrer">github.com/nianyi778/g…</a></p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>作为一个开发者，我们每天都在和 Git 打交道。为了简化一些繁琐的 Git 流程（比如合并多个 commit、交互式 rebase、清理工作区），我之前用 TypeScript 写了一个名为 <strong>gix</strong> 的 CLI 工具。</p>
<p>它工作得很好，但随着时间的推移，我开始思考：<strong>是不是可以用 Rust 重写它？</strong></p>
<p>这不仅仅是为了蹭 "Rewrite it in Rust" 的热度，更是为了解决 Node.js CLI 工具的一些原生痛点，同时探索 Rust 在命令行工具开发领域的强大能力。</p>
<p>今天就来复盘一下，我是如何将 <code>gix</code> 从 TypeScript 迁移到 Rust，以及在这个过程中踩过的坑和收获的经验。</p>
<h2 data-id="heading-1">为什么要重写？</h2>
<p>TypeScript 版本虽然开发效率高，但作为 CLI 工具，它有几个无法忽视的短板：</p>
<ol>
<li><strong>环境依赖</strong>：用户必须安装 Node.js 才能运行。这对于非前端开发者来说是一个额外的负担。</li>
<li><strong>分发困难</strong>：虽然可以通过 npm 安装，但生成的 <code>node_modules</code> 体积庞大。</li>
<li><strong>启动速度</strong>：Node.js 的运行时启动虽然不慢，但相比于 Rust 编译后的原生二进制，还是有肉眼可见的差距。</li>
</ol>
<p>而 Rust 完美解决了这些问题：</p>
<ul>
<li><strong>零依赖</strong>：编译成单个二进制文件，扔到哪里都能跑。</li>
<li><strong>高性能</strong>：启动瞬间完成，内存占用极低。</li>
<li><strong>类型安全</strong>：比 TypeScript 更严格的类型系统，在编译阶段就能拦截绝大多数错误。</li>
</ul>
<h2 data-id="heading-2">技术栈对比</h2>
<p>在重写过程中，我寻找了 TypeScript 生态中对应库的 Rust 替代品，发现 Rust 的 CLI 生态简直太丰富了：</p>



































<table><thead><tr><th align="left">功能</th><th align="left">TypeScript 方案</th><th align="left">Rust 方案</th><th align="left">体验对比</th></tr></thead><tbody><tr><td align="left"><strong>CLI 框架</strong></td><td align="left"><code>commander</code></td><td align="left"><strong><code>clap</code></strong></td><td align="left"><code>clap</code> 的 Derive 宏简直是魔法，直接通过结构体定义参数，自动生成帮助文档。</td></tr><tr><td align="left"><strong>交互式提示</strong></td><td align="left"><code>inquirer</code></td><td align="left"><strong><code>inquire</code></strong></td><td align="left">类型更安全，API 设计非常直观。</td></tr><tr><td align="left"><strong>终端颜色</strong></td><td align="left"><code>chalk</code></td><td align="left"><strong><code>colored</code></strong></td><td align="left">用法几乎一致，简单易用。</td></tr><tr><td align="left"><strong>Git 执行</strong></td><td align="left"><code>child_process</code></td><td align="left"><strong><code>std::process::Command</code></strong></td><td align="left">Rust 的标准库对进程控制提供了更细粒度的支持。</td></tr></tbody></table>
<h2 data-id="heading-3">核心架构设计</h2>
<h3 data-id="heading-4">1. Monorepo 结构</h3>
<p>为了平滑过渡，我采用了 Monorepo 结构，同时保留了 <code>typescript</code> 和 <code>rust</code> 两个目录。这样老用户可以继续使用 npm 版本，新用户可以尝试 Rust 版本。</p>
<pre><code class="hljs language-text" lang="text">.
├── rust/           # Rust 实现 (新)
│   ├── src/
│   │   ├── commands/   # 独立的命令模块
│   │   └── main.rs     # 入口分发
│   └── Cargo.toml
├── typescript/     # TypeScript 实现 (旧)
└── .github/        # CI/CD 工作流
</code></pre>
<h3 data-id="heading-5">2. 命令模式 (Command Pattern)</h3>
<p>在 Rust 版本中，我利用 <code>clap</code> 的子命令功能，将每个功能（merge, rebase, doctor 等）封装成独立的模块。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// main.rs</span>
<span class="hljs-meta">#[derive(Subcommand)]</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Commands</span> {
    <span class="hljs-comment">/// Merge multiple git commits</span>
    <span class="hljs-title function_ invoke__">Merge</span>(merge::MergeArgs),
    <span class="hljs-comment">/// Rebase current branch onto upstream</span>
    <span class="hljs-title function_ invoke__">Rebase</span>(rebase::RebaseArgs),
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>每个命令模块都遵循统一的接口：定义参数结构体 -&gt; 实现 <code>execute</code> 函数。这种结构非常清晰，添加新命令只需“填空”即可。</p>
<h2 data-id="heading-6">踩坑与亮点</h2>
<h3 data-id="heading-7">1. 交互式 Git 命令的“黑魔法”</h3>
<p>在 CLI 中执行 <code>git rebase -i</code> 或 <code>git commit</code> 时，Git 可能会唤起编辑器（如 Vim）。在 Node.js 中处理这个需要一些技巧，而在 Rust 中，我们需要正确处理 <code>stdio</code>。</p>
<p>如果直接用 <code>.output()</code>，用户是看不到 Vim 界面的。必须使用 <code>.status()</code> 并继承父进程的 stdio：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">exec_git_interactive</span>(args: &amp;[&amp;<span class="hljs-type">str</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"git"</span>)
        .<span class="hljs-title function_ invoke__">args</span>(args)
        <span class="hljs-comment">// 关键：让子进程直接使用当前的终端输入输出</span>
        .<span class="hljs-title function_ invoke__">status</span>()
        .<span class="hljs-title function_ invoke__">map_err</span>(|e| <span class="hljs-built_in">format!</span>(<span class="hljs-string">"❌ Failed to execute git command: {}"</span>, e))?;

    <span class="hljs-keyword">if</span> !status.<span class="hljs-title function_ invoke__">success</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"❌ Git command failed"</span>.<span class="hljs-title function_ invoke__">to_string</span>());
    }
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<h3 data-id="heading-8">2. 严格的开发工作流 (Copilot 辅助)</h3>
<p>为了保证代码质量，我制定了一套严格的 <strong>"Design-Approve-Implement"</strong> 工作流，并写进了 <code>.github/instructions/copilot-instructions.md</code> 给 AI 助手看。</p>
<ol>
<li><strong>Design</strong>: 先写 Markdown 设计文档，定义参数、流程、异常处理。</li>
<li><strong>Approve</strong>: <strong>必须</strong>等待我回复“批准”才能开始写代码。</li>
<li><strong>Implement</strong>: 编写 Rust 代码。</li>
<li><strong>Verify</strong>: 运行 <code>cargo clippy</code> 和 <code>cargo fmt</code>，<strong>必须</strong>等待我回复“测试通过”才能提交。</li>
</ol>
<p>这套流程极大地减少了返工，比如最新的 <code>gix rebase</code> 功能就是完全按照这个流程一次性开发成功的。</p>
<h3 data-id="heading-9">3. 自动化的 CI/CD</h3>
<p>为了省事，我配置了 GitHub Actions 实现全自动发版：</p>
<ul>
<li><strong>TypeScript</strong>: 监听 <code>typescript/package.json</code> 变化，自动发布到 npm。</li>
<li><strong>Rust</strong>: 监听 <code>rust/Cargo.toml</code> 变化，自动打 Tag -&gt; 编译 Release -&gt; 发布到 GitHub Releases。</li>
</ul>
<p>特别是 Rust 的自动打标流程，通过解析 <code>Cargo.toml</code> 版本号，自动判断是否需要创建 Git Tag，实现了“改个版本号就发版”的丝滑体验。</p>
<h2 data-id="heading-10">总结</h2>
<p>从 TypeScript 到 Rust 的重写过程，不仅让 <code>gix</code> 变得更快、更轻，也让我深刻体会到了 Rust 在工程化方面的优势。</p>
<ul>
<li><strong>Clap</strong> 让 CLI 开发变成了一种享受。</li>
<li><strong>Rust 的类型系统</strong> 让我在重构时充满信心，不用担心运行时莫名其妙的 <code>undefined</code>。</li>
<li><strong>Cargo</strong> 的构建和依赖管理体验一流。</li>
</ul>
<p>如果你也在维护 CLI 工具，强烈建议尝试用 Rust 重写一下，绝对会有意想不到的收获！</p>
<hr/>
<p><strong>欢迎 Star 和试用：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnianyi778%2Fgix-cli" target="_blank" title="https://github.com/nianyi778/gix-cli" ref="nofollow noopener noreferrer">github.com/nianyi778/g…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang框架封神榜！GitHub星标TOP8大比拼，选对框架少走3年弯路]]></title>    <link>https://juejin.cn/post/7586902693857591338</link>    <guid>https://juejin.cn/post/7586902693857591338</guid>    <pubDate>2025-12-23T09:30:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586902693857591338" data-draft-id="7586890269699620918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang框架封神榜！GitHub星标TOP8大比拼，选对框架少走3年弯路"/> <meta itemprop="keywords" content="后端,Go,面试"/> <meta itemprop="datePublished" content="2025-12-23T09:30:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang框架封神榜！GitHub星标TOP8大比拼，选对框架少走3年弯路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:30:29.000Z" title="Tue Dec 23 2025 09:30:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>兄弟们，谁懂啊！用Golang开发最纠结的不是语法有多绕，而是框架选到秃头！</p>
</blockquote>
<p>毕竟Go生态里的框架五花八门，有的主打极致性能，有的号称全栈全能，新手看着一堆仓库直接懵圈，老鸟也得纠结半天适配度。</p>
<p>今天不整虚的！直接扒了GitHub上Golang框架的星标数据，整理出<strong>星标TOP8封神榜</strong>，从性能、适用场景到坑点全拆解。更关键的是，文末埋了个争议话题——“Golang框架选轻量还是全栈？”，欢迎各位Goer来Battle！</p>
<h2 data-id="heading-0">先划重点：榜单核心规则</h2>
<ol>
<li>
<p>数据来源：GitHub官方，截止2025年12月23日，星标数量实时变动但排名基本稳定；</p>
</li>
<li>
<p>筛选标准：仅收录主流Web/微服务框架，排除单一功能库（如纯ORM、纯路由库）；</p>
</li>
<li>
<p>排名依据：星标数量从高到低，星标相同则参考活跃贡献者数量；</p>
</li>
<li>
<p>实用导向：每个框架都附“一句话选型建议”，小白直接抄作业。</p>
</li>
</ol>
<h2 data-id="heading-1">Golang框架封神榜（GitHub星标TOP8）</h2>
<h3 data-id="heading-2">No.1 王者宝座：Gin（gin-gonic/gin）—— 星标87.3K+</h3>
<p>【标签】性能王者·轻量之王·新手友好</p>
<p>谁还没听过Gin的大名？Go生态的顶流框架，星标直接甩开第二名近50K，字节跳动、腾讯都在大规模使用，说是“Goer人手必备”毫不夸张。</p>
<p>核心优势：基于定制的HTTP路由器，性能比标准库快40倍，高并发场景下稳如老狗；API设计极简直观，新手写个/ping接口3行代码搞定，中间件生态超丰富，JWT、CORS、日志这些刚需功能直接开箱即用。</p>
<p>坑点预警：没有内置ORM，需要自己集成GORM之类的库；功能比较精简，复杂业务场景需要额外搭组件。</p>
<p>一句话选型：做RESTful API、微服务接口、高并发实时服务，选它准没错！</p>
<p>入门代码（感受下极简）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    r := gin.Default()
    r.GET(<span class="hljs-string">"/ping"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
        c.JSON(<span class="hljs-number">200</span>, gin.H{<span class="hljs-string">"message"</span>: <span class="hljs-string">"pong"</span>})
    })
    r.Run(<span class="hljs-string">":8080"</span>)
}
</code></pre>
<h3 data-id="heading-3">No.2 黑马挑战者：Fiber（go-fiber/fiber）—— 星标38.7K+</h3>
<p>【标签】极致性能·Express平替·内存杀手</p>
<p>近几年异军突起的黑马框架，星标增长速度快到惊人！主打“Go版Express”，API设计和Node.js的Express几乎一模一样，前端转Go的开发者无缝衔接。</p>
<p>核心优势：基于Fasthttp引擎，性能比Gin还猛，零内存分配热路径，处理数十万并发连接毫无压力；内置WebSocket支持，做实时聊天、游戏服务器超合适；内存占用极低，轻量部署无压力。</p>
<p>坑点预警：因为用了非标准库的Fasthttp，和部分标准库生态的包兼容性一般；社区比Gin年轻，部分小众需求的解决方案较少。</p>
<p>一句话选型：做超高并发服务、实时应用、轻量API，或者前端转Go的团队，优先选它！</p>
<h3 data-id="heading-4">No.3 全能老将：Beego（beego/beego）—— 星标32.3K+</h3>
<p>【标签】全栈全能·企业级·MVC架构</p>
<p>Go生态的老牌全栈框架，灵感来自Django，走“一站式解决方案”路线，把ORM、路由、会话管理、缓存、自动化文档全打包了，不用开发者到处找组件搭架子。</p>
<p>核心优势：内置ORM支持多种数据库，不用手写SQL；MVC架构清晰，适合大型团队协作；自带CLI代码生成器，bee new命令一键生成项目骨架，开发效率拉满。</p>
<p>坑点预警：功能太全导致性能不如Gin、Fiber；学习曲线较陡，新手要理解MVC、ORM等一堆概念；近几年更新速度变慢。</p>
<p>一句话选型：做大型企业级Web应用、后台管理系统，需要快速搭建完整技术栈的项目，选它！</p>
<h3 data-id="heading-5">No.4 微服务新星：Go-Zero（zero-micro/go-zero）—— 星标32.2K+</h3>
<p>【标签】微服务神器·高并发·代码生成狂魔</p>
<p>专门为微服务而生的框架，星标和Beego咬得极近，字节跳动内部孵化的框架，自带“大厂基因”，在微服务领域口碑超好。</p>
<p>核心优势：基于Fasthttp，QPS比同类微服务框架高50%，高并发场景下性能拉满；自带goctl代码生成工具，API和RPC代码自动生成，不用手写重复代码；内置熔断、限流、负载均衡，微服务治理刚需功能全搞定。</p>
<p>坑点预警：生态比较封闭，依赖官方工具链，自定义扩展需要了解框架内部实现；文档不够完善，新手入门有点难。</p>
<p>一句话选型：做高并发微服务架构、电商平台、社交App后端，选它！</p>
<h3 data-id="heading-6">No.5 极简先锋：Echo（labstack/echo）—— 星标31.9K+</h3>
<p>【标签】极简主义·性能能打·中间件灵活</p>
<p>和Gin齐名的轻量框架，主打“简约而不简单”，性能和Gin不相上下，都是高并发场景的优质选择。</p>
<p>核心优势：路由引擎优化到位，处理请求延迟极低；中间件机制超灵活，支持动态路由和路由分组；内置Swagger集成，自动生成API文档，团队协作超方便。</p>
<p>坑点预警：学习曲线比Gin稍陡；集成第三方中间件时可能遇到兼容性问题。</p>
<p>一句话选型：想要比Gin更灵活的中间件机制，又不想牺牲性能，选Echo！</p>
<h3 data-id="heading-7">No.6 微服务元老：Go-Kit（go-kit/kit）—— 星标27.5K+</h3>
<p>【标签】微服务标准库·组件化·跨语言友好</p>
<p>Go微服务生态的“元老级”框架，堪称“微服务标准库”，组件化设计理念深入人心，适合复杂的跨语言微服务架构。</p>
<p>核心优势：组件化程度高，服务发现、负载均衡、编解码这些核心组件都可插拔，支持Consul、Etcd等多种注册中心；原生支持HTTP、gRPC、MQTT等多种协议，跨语言协作无压力。</p>
<p>坑点预警：学习曲线巨陡，新手要理解一堆微服务概念；配置复杂，需要手动搭很多组件。</p>
<p>一句话选型：做复杂跨语言微服务架构、对服务治理要求高的企业级应用，选它！</p>
<h3 data-id="heading-8">No.7 云原生新秀：Go-Kratos（go-kratos/kratos）—— 星标25.2K+</h3>
<p>【标签】云原生·大厂背书·全链路治理</p>
<p>B站开源的微服务框架，近几年势头很猛，星标稳定增长，主打“云原生时代的微服务框架”，适配K8s、Docker等容器化部署。</p>
<p>核心优势：全链路治理能力强，包含服务注册发现、熔断限流、监控追踪等功能；支持Protobuf定义API，自动生成代码；云原生友好，部署灵活。</p>
<p>坑点预警：社区规模比Go-Micro、Go-Zero小；部分功能需要结合B站生态的组件。</p>
<p>一句话选型：做云原生微服务、需要全链路治理的项目，尤其是B站生态相关的团队，优先考虑！</p>
<h3 data-id="heading-9">No.8 经典老将：Gorilla Mux（gorilla/mux）—— 星标21.7K+</h3>
<p>【标签】经典路由·稳定可靠·生态兼容</p>
<p>Go生态的经典路由框架，虽然现在被Gin、Fiber抢了风头，但胜在稳定可靠，生态兼容性拉满，很多老项目还在继续使用。</p>
<p>核心优势：路由功能强大，支持正则表达式、路由参数、子路由；完全兼容标准库net/http，和其他标准库生态的包无缝衔接；稳定运行多年，bug极少。</p>
<p>坑点预警：性能不如Gin、Fiber；功能比较基础，很多功能需要自己扩展。</p>
<p>一句话选型：维护老项目、需要兼容大量标准库包、对路由灵活性要求高的场景，选它！</p>
<h2 data-id="heading-10">争议话题引爆：Golang框架，选轻量还是全栈？</h2>
<p>看完成绩单，想必大家心里都有个疑问：到底该选Gin、Fiber这种轻量框架，还是Beego这种全栈框架？</p>
<p>支持轻量派说：轻量框架性能好、灵活度高，按需集成组件，不会有冗余功能，后期维护成本低；</p>
<p>支持全栈派说：全栈框架开箱即用，不用浪费时间搭基础架构，开发效率高，适合快速落地项目，尤其是团队规模小的时候；</p>
<p>我先抛砖引玉：小型项目、追求极致性能、微服务场景，选轻量框架；大型企业级应用、需要快速落地、团队新手多，选全栈框架。</p>
<p>欢迎评论区Battle！说说你用过最顺手的Golang框架，或者你踩过哪些框架的坑？</p>
<h2 data-id="heading-11">最后总结：新手避坑选型指南</h2>
<ol>
<li>
<p>新手入门：优先选Gin，学习成本最低，生态最完善，遇到问题随便搜都有答案；</p>
</li>
<li>
<p>高并发API/微服务：Gin、Fiber二选一，追求极致性能选Fiber，追求生态选Gin；</p>
</li>
<li>
<p>企业级全栈应用：Beego，一站式解决方案，不用到处找组件；</p>
</li>
<li>
<p>复杂微服务架构：Go-Zero（高并发）、Go-Kit（跨语言）、Go-Kratos（云原生）；</p>
</li>
<li>
<p>老项目维护：Gorilla Mux，稳定兼容第一。</p>
</li>
</ol>
<p>框架没有最好的，只有最适合的！选对框架能让开发效率翻倍，少走很多弯路。收藏这篇文章，下次选框架直接对照看～</p>
<p>觉得有用的话，点赞+关注走一波，后续还会分享更多Golang实战干货！</p>
<blockquote>
<p>还有哪些被榜单遗漏的宝藏Go框架，欢迎评论区补充提名！另外，评论区留言“已关注”，我会随机抽3位兄弟，额外赠送《Go实战项目源码合集》！</p>
</blockquote>
<blockquote>
<p>关注公众号【王中阳】回复“Go框架”领干货，加绿泡泡wangzhongyang1993，进实战交流群，咱们一起深耕Go开发～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"API"很重要？——从封闭系统到开放生态]]></title>    <link>https://juejin.cn/post/7586687526867451919</link>    <guid>https://juejin.cn/post/7586687526867451919</guid>    <pubDate>2025-12-23T09:47:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526867451919" data-draft-id="7586687526867369999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么&quot;API&quot;很重要？——从封闭系统到开放生态"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T09:47:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么"API"很重要？——从封闭系统到开放生态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:47:20.000Z" title="Tue Dec 23 2025 09:47:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🔌 为什么"API"很重要？——从封闭系统到开放生态 🌐</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>今天咱们来聊聊API这个"软件世界的连接器"！想象一下，你打开外卖APP，就能看到附近的餐厅、实时配送状态；你用打车APP，就能看到司机位置、预计到达时间——这些功能之所以能实现，全靠API在背后默默工作！</p>
<h3 data-id="heading-1">🤔 核心问题：API的作用是什么？为什么现代软件都依赖API？</h3>
<p>很多人觉得API是"高大上的技术名词"，其实API离我们很近！API就像"软件之间的翻译官"，让不同的软件能够互相交流、共享数据和功能。</p>
<h4 data-id="heading-2">API的本质</h4>
<p>API（Application Programming Interface）是一种<strong>软件接口</strong>，定义了不同软件之间如何互相通信。它就像"餐厅的菜单"，告诉你可以点什么菜（调用什么功能），但不告诉你厨房是怎么做的（内部实现）。</p>
<h4 data-id="heading-3">为什么现代软件都依赖API？</h4>
<ul>
<li>🔗 <strong>连接一切</strong>：让不同的软件、服务、设备能够互相通信</li>
<li>🚀 <strong>快速开发</strong>：直接调用现成的API，不用重复造轮子</li>
<li>💡 <strong>创新生态</strong>：基于API可以构建全新的应用和服务</li>
<li>💰 <strong>商业价值</strong>：通过API可以实现数据和服务的商业化</li>
</ul>
<h3 data-id="heading-4">📜 API的"进化史"：从封闭到开放</h3>
<h4 data-id="heading-5">1. 🔒 早期内部接口："闭门造车"</h4>
<p>20世纪80-90年代，软件都是独立的"孤岛"，每个软件都有自己的内部接口，只供自己使用。</p>
<p>这就像"每个家庭都有自己的语言"，互相之间无法交流。如果你想让两个软件合作，只能重写代码，非常麻烦！</p>
<h4 data-id="heading-6">2. 🌉 公开API萌芽："打开大门"</h4>
<p>2000年后，一些互联网公司开始对外开放API，比如Google Maps API（2005年）、Twitter API（2006年）。</p>
<p>这就像"家庭开始学习通用语言"，不同软件之间可以互相交流了。开发者可以基于这些API构建全新的应用，比如基于Google Maps的导航APP。</p>
<h4 data-id="heading-7">3. 🌐 API生态爆发："互联互通"</h4>
<p>2010年后，API进入爆发期。几乎所有互联网公司都对外开放API，形成了庞大的API生态。</p>
<p>这就像"全球都使用同一种语言"，软件之间可以自由交流、互相调用。我们现在使用的大多数互联网服务，都是通过API连接起来的！</p>
<h3 data-id="heading-8">🔧 技术原理：API的核心技术</h3>
<h4 data-id="heading-9">1. 📋 API设计原则："好用的API是什么样的？"</h4>
<p>一个好的API需要遵循以下原则：</p>
<ul>
<li>🎯 <strong>简洁性</strong>：接口设计简单明了，容易理解和使用</li>
<li>📱 <strong>一致性</strong>：命名规范一致，返回格式统一</li>
<li>🔒 <strong>安全性</strong>：有完善的认证和授权机制</li>
<li>📈 <strong>可扩展性</strong>：支持版本升级，不破坏现有功能</li>
<li>⚡ <strong>高性能</strong>：响应速度快，支持高并发</li>
</ul>
<h4 data-id="heading-10">2. 🌿 RESTful API规范："最流行的API设计风格"</h4>
<p>RESTful API是目前最流行的API设计风格，它基于HTTP协议，使用GET、POST、PUT、DELETE等HTTP方法来表示不同的操作。</p>
<p><strong>RESTful API的核心概念</strong>：</p>
<ul>
<li>📍 <strong>资源</strong>：用URL表示（比如 <code>/users</code> 表示用户资源）</li>
<li>🔧 <strong>操作</strong>：用HTTP方法表示（GET获取，POST创建，PUT更新，DELETE删除）</li>
<li>📦 <strong>数据格式</strong>：通常使用JSON格式</li>
</ul>
<p><strong>代码实例</strong>：用Python调用RESTful API</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># API端点（获取GitHub用户信息）</span>
url = <span class="hljs-string">"https://api.github.com/users/octocat"</span>

<span class="hljs-comment"># 发送GET请求</span>
response = requests.get(url)

<span class="hljs-comment"># 检查响应状态码</span>
<span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
    <span class="hljs-comment"># 解析JSON响应</span>
    user_data = response.json()
    
    <span class="hljs-comment"># 打印用户信息</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ GitHub用户信息："</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户名：<span class="hljs-subst">{user_data[<span class="hljs-string">'login'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"姓名：<span class="hljs-subst">{user_data[<span class="hljs-string">'name'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"仓库数量：<span class="hljs-subst">{user_data[<span class="hljs-string">'public_repos'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"关注者数量：<span class="hljs-subst">{user_data[<span class="hljs-string">'followers'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"个人主页：<span class="hljs-subst">{user_data[<span class="hljs-string">'html_url'</span>]}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 请求失败，状态码：<span class="hljs-subst">{response.status_code}</span>"</span>)
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">✅ GitHub用户信息：
用户名：octocat
姓名：The Octocat
仓库数量：<span class="hljs-number">8</span>
关注者数量：<span class="hljs-number">899000</span>
个人主页：https:<span class="hljs-comment">//github.com/octocat</span>
</code></pre>
<h4 data-id="heading-11">3. 🏰 API网关和管理："API的管家"</h4>
<p>API网关是管理API的"管家"，负责：</p>
<ul>
<li>🔐 <strong>认证授权</strong>：验证API调用者的身份和权限</li>
<li>⚡ <strong>负载均衡</strong>：将请求分发到不同的服务器</li>
<li>📊 <strong>监控统计</strong>：记录API调用情况，分析性能和使用情况</li>
<li>🛡️ <strong>安全防护</strong>：防止API被恶意攻击</li>
<li>📝 <strong>限流熔断</strong>：防止请求过多导致服务器崩溃</li>
</ul>
<h3 data-id="heading-12">📊 趣味对比：无API系统 vs 有API系统</h3>













































<table><thead><tr><th>对比项</th><th>无API系统</th><th>有API系统</th></tr></thead><tbody><tr><td><strong>系统集成</strong></td><td>困难（需要重写代码）</td><td>简单（直接调用API）</td></tr><tr><td><strong>开发速度</strong></td><td>慢（几个月）</td><td>快（几天到几周）</td></tr><tr><td><strong>创新能力</strong></td><td>弱（只能自己开发）</td><td>强（可以基于现有API构建新应用）</td></tr><tr><td><strong>数据共享</strong></td><td>几乎不可能</td><td>轻松实现（通过API共享数据）</td></tr><tr><td><strong>扩展性</strong></td><td>差（无法快速扩展功能）</td><td>好（可以随时添加新API）</td></tr><tr><td><strong>商业价值</strong></td><td>低（只能靠自身功能）</td><td>高（可以通过API实现商业化）</td></tr><tr><td><strong>用户体验</strong></td><td>单一（只能使用自身功能）</td><td>丰富（可以集成多种服务）</td></tr></tbody></table>
<h3 data-id="heading-13">🏢 API的应用场景：无处不在的API</h3>
<p>API已经渗透到我们生活的方方面面，被称为"互联网的基础设施"：</p>








































<table><thead><tr><th>应用场景</th><th>举例</th><th>API的作用</th></tr></thead><tbody><tr><td>🛒 电商平台</td><td>淘宝、京东</td><td>调用支付API、物流API、短信API</td></tr><tr><td>🚕 打车APP</td><td>滴滴、高德打车</td><td>调用地图API、定位API、支付API</td></tr><tr><td>🍔 外卖APP</td><td>美团外卖、饿了么</td><td>调用餐厅API、配送API、支付API</td></tr><tr><td>📱 移动应用</td><td>微信、抖音</td><td>调用登录API、分享API、支付API</td></tr><tr><td>☁️ 云服务</td><td>AWS、阿里云</td><td>提供各种云服务API（计算、存储、数据库）</td></tr><tr><td>📊 数据分析</td><td>百度统计、Google Analytics</td><td>提供数据分析API</td></tr></tbody></table>
<h3 data-id="heading-14">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-15">1. "API就是接口，没什么特别的？"</h4>
<p>不！API不仅是接口，更是一种<strong>服务理念</strong>。它代表了软件的开放程度和生态建设能力。</p>
<h4 data-id="heading-16">2. "API越多越好？"</h4>
<p>不！API的质量比数量更重要。一个设计糟糕的API，可能比没有API更糟糕。</p>
<h4 data-id="heading-17">3. "API只对开发者有用？"</h4>
<p>不！API最终受益的是<strong>普通用户</strong>。我们使用的几乎所有互联网服务，都依赖API在背后工作。</p>
<h4 data-id="heading-18">4. "API是免费的？"</h4>
<p>不一定！很多API是收费的，尤其是高质量、高价值的API。比如Google Maps API、OpenAI API等。</p>
<h3 data-id="heading-19">🔮 未来展望：API的发展趋势</h3>
<h4 data-id="heading-20">1. 🤖 AI驱动的API</h4>
<p>AI将融入API的各个环节，包括智能API设计、自动生成API文档、智能调试和监控等。</p>
<h4 data-id="heading-21">2. 🌐 全球API网络</h4>
<p>API将形成一个全球性的网络，不同国家、不同行业的API可以互相调用，实现真正的"互联互通"。</p>
<h4 data-id="heading-22">3. 🔒 更安全的API</h4>
<p>随着网络安全问题的日益严重，API安全将成为重中之重，包括更强大的认证授权机制、更严格的访问控制等。</p>
<h4 data-id="heading-23">4. 📱 低代码/无代码API</h4>
<p>低代码/无代码平台将让非技术人员也能轻松创建和使用API，进一步降低API的使用门槛。</p>
<h3 data-id="heading-24">🎓 互动小测验：你答对了吗？</h3>



































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>API的全称是什么？</td><td>Application Programming Interface</td><td>✅/❌</td></tr><tr><td>最流行的API设计风格是什么？</td><td>RESTful API</td><td>✅/❌</td></tr><tr><td>全球API数量超过多少？</td><td>2000万个</td><td>✅/❌</td></tr><tr><td>API调用量年增长率是多少？</td><td>超过30%</td><td>✅/❌</td></tr><tr><td>API网关的作用是什么？</td><td>管理和保护API</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-25">🎯 结语：API连接世界</h3>
<p>API就像"软件世界的高速公路"，让不同的软件能够快速、安全地互相通信。没有API，就没有今天丰富多彩的互联网服务；没有API，就没有快速发展的软件生态。</p>
<p>下次使用手机APP时，不妨想想背后有多少API在默默工作——正是这些"看不见的连接器"，让我们的数字生活变得更加便捷和丰富！</p>
<hr/>
<h3 data-id="heading-26">💬 互动话题</h3>
<ol>
<li>你使用过哪些基于API的服务？</li>
<li>你觉得未来API会如何改变我们的生活？</li>
<li>如果你是开发者，你最想调用哪个API？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DataWorks 又又又升级了，这次我们通过 Arrow 列存格式让数据同步速度提升10倍！]]></title>    <link>https://juejin.cn/post/7586973107321339944</link>    <guid>https://juejin.cn/post/7586973107321339944</guid>    <pubDate>2025-12-23T09:49:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586973107321339944" data-draft-id="7586869907065978915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DataWorks 又又又升级了，这次我们通过 Arrow 列存格式让数据同步速度提升10倍！"/> <meta itemprop="keywords" content="人工智能,大数据"/> <meta itemprop="datePublished" content="2025-12-23T09:49:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DataWorks 又又又升级了，这次我们通过 Arrow 列存格式让数据同步速度提升10倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:49:21.000Z" title="Tue Dec 23 2025 09:49:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在大数据时代，数据集成作为企业数据流转的核心枢纽，承担着异构数据源之间高效同步的重要职责。随着数据量的爆炸式增长，传统的行存同步方式在面对大规模列存数据处理时，逐渐显露出性能瓶颈。</p>
<p>为解决这一挑战，DataWorks数据集成推出基于Apache Arrow列存格式的高性能同步能力，实现从“行式传输”到“列式直通”的技术跃迁。通过引入零拷贝、列式内存标准Apache Arrow，DataWorks实现了跨数据源的列存到列存高效同步，性能提升最高达10倍以上，助力企业实现数据流转的“高速通道”。</p>
<h2 data-id="heading-1">技术创新：基于Arrow的列存同步方案</h2>
<h3 data-id="heading-2">Apache Arrow：下一代数据处理的“通用语言”</h3>
<p>Apache Arrow是一项由Apache基金会主导的跨语言、高性能列式内存数据标准，被广泛应用于大数据生态（如Spark、Flink、Presto等）。核心优势在于：</p>
<ul>
<li>
<p>零序列化/反序列化：数据以内存二进制块直接传输，避免格式转换开销</p>
</li>
<li>
<p>零拷贝（Zero-Copy）：跨进程/跨系统共享内存，极大降低CPU与内存消耗</p>
</li>
<li>
<p>CPU缓存友好：列式存储提升缓存命中率，优化计算效率</p>
</li>
<li>
<p>统一类型系统：支持复杂嵌套结构，保障跨平台类型兼容性</p>
</li>
</ul>
<p>简单来说：Arrow让数据“原样流动”，不再“反复翻译”。</p>
<h3 data-id="heading-3">传统架构 vs Arrow架构：从“搬砖”到“高速专列”</h3>
<p>当前大多数数据集成工具仍基于“行存驱动”设计：</p>
<ul>
<li>
<p>Reader读取列存文件 → 解码成单行Record对象；</p>
</li>
<li>
<p>框架传递Record → Writer再将其编码回目标列存格式。</p>
</li>
</ul>
<p>这一过程存在严重性能浪费：</p>
<ul>
<li>
<p>多次类型转换与对象创建（如String → BigDecimal）</p>
</li>
<li>
<p>高频GC压力导致频繁Stop-The-World</p>
</li>
<li>
<p>内存带宽利用率低下</p>
</li>
</ul>
<p>而Arrow则彻底改变了这一流程：Reader直接输出列式Batch → Writer直接消费列式Batch，中间无需任何转换，真正实现“端到端列式流水线”。</p>
<h4 data-id="heading-4">传统行存同步架构：</h4>
<p>面向单行行存的格式设计，每一个Record对象定义了若干个Column，每个Column包含当前行对应该列的列值Value。以MaxCompute(ODPS)列存数据同步到MaxCompute(ODPS)列存为例：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e696fb70eb89405f884643c91229f5be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=6AdfGCyOgPNVjjww1No1xJcygtY%3D" alt="image.png" loading="lazy"/></p>
<p>MaxCompute表数据可能以ORC、Parquet等列存格式存储的数据，同步核心流程分为：</p>
<ol>
<li>通过MaxCompute Tunnel将数据按行读取出来，并转为MaxCompute Record对象；</li>
<li>MaxCompute Reader将MaxCompute Record转换为同步引擎的Record对象，投递给框架；</li>
<li>框架收到Record放入缓存队列;</li>
<li>Writer从框架接收引擎Record，再转换为MaxCompute Record，并通过Tunnel client将数据进行序列化后通过网络传输给Tunnel server。</li>
</ol>
<h4 data-id="heading-5">数据集成Arrow列存同步架构：</h4>
<p>当列存到列存同步场景下，将列存先转为行存格式，再将行存格式转为列存格式，中间多了不必要的转换及序列化操作。通过构建全新的 ArrowTabularRecord 数据结构，DataWorks实现了对Arrow列式数据的原生支持，跳过行式转换环节，实现端到端列存“短路同步”，大幅提升吞吐、降低延迟。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6465ce9b4464c32ad0af4787c681209~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=6TzGH8im9%2B7SSwxQvuRffkqTiKM%3D" alt="image.png" loading="lazy"/></p>
<p>同步引擎基于新的面向Arrow列存格式的ArrowTabularRecord，列存到列存数据流转如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e73b29747ea44cbb5e8cbb687a6e19f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=TD%2FWxq8cu274omqOkNUK2hHsIZk%3D" alt="image.png" loading="lazy"/></p>
<p>同步核心流程如下：</p>
<ol>
<li>
<p>通过MaxCompute Tunnel Arrow API将数据直接按照Arrow列存格式读取出来，并存入ArrowTabularRecord，投递给框架；</p>
</li>
<li>
<p>框架收到Record放入缓存队列;</p>
</li>
<li>
<p>Writer从框架收到引擎ArrowTabularRecord，直接通过Tunnel Arrow API将数据基于Arrow格式，省去做序列化的开销，直接将内存二进制数据传输给Tunnel Server。</p>
</li>
</ol>
<h2 data-id="heading-6">核心能力：全链路列式加速，支持主流数据源</h2>
<p>DataWorks数据集成现已全面支持 <strong>MaxCompute、Hologres、Hive/OSS/HDFS（Parquet/ORC）</strong> 等主流列存数据源的Arrow读写能力，用户仅需在任务配置中添加 "useArrow": true 即可一键启用。</p>
<h3 data-id="heading-7">列存直读直写，显著提升性能</h3>

























<table><thead><tr><th><strong>数据源</strong></th><th><strong>支持能力</strong></th><th><strong>同步性能提升</strong></th></tr></thead><tbody><tr><td><strong>MaxCompute</strong></td><td>通过Tunnel Arrow API直读列存数据</td><td>同步性能提升 <strong>200%</strong></td></tr><tr><td><strong>Hologres</strong></td><td>支持Arrow格式导出，避免JDBC行式瓶颈</td><td>同步性能提升 <strong>95%</strong></td></tr><tr><td><strong>Hive\OSS\HDFS</strong>等分布式文件</td><td>直接读取Parquet/ORC底层Arrow格式数据</td><td>PARQUET同步性能提升<strong>5.55倍</strong>ORC同步性能提升 <strong>9.85倍</strong></td></tr></tbody></table>
<p><strong>示例：Hive ORC → MaxCompute 写入，原需数小时的任务，现可在数十分钟内完成。</strong></p>
<h3 data-id="heading-8">性能压测报告</h3>
<p>我们对多个典型场景进行了端到端性能测试，同步性能显著提升，可实现<strong>从小时级到分钟级</strong>的数据同步周期提升：</p>
<h4 data-id="heading-9">场景一：MaxCompute列存短路同步（Arrow → Arrow）</h4>





























<table><thead><tr><th><strong>并发数</strong></th><th><strong>传统行存</strong></th><th><strong>Arrow列存</strong></th><th><strong>性能提升</strong></th></tr></thead><tbody><tr><td>1</td><td>67.8 MB/s<br/>3740 R/s</td><td>212.6 MB/s<br/>11462 R/s</td><td><strong>+206.5%</strong></td></tr><tr><td>3</td><td>185.6 MB/s<br/>10226 R/s</td><td>569.9 MB/s<br/>30728 R/s</td><td><strong>+200.5%</strong></td></tr><tr><td>8</td><td>462.1 MB/s<br/>25467 R/s</td><td>1321.0 MB/s<br/>71143 R/s</td><td><strong>+197.4%</strong></td></tr></tbody></table>
<h4 data-id="heading-10">场景二：Hologres → MaxCompute 同步</h4>























<table><thead><tr><th><strong>并发数</strong></th><th><strong>传统同步</strong></th><th><strong>Arrow同步</strong></th><th><strong>性能提升</strong></th></tr></thead><tbody><tr><td>4</td><td>439.1 MB/s<br/>216480 R/s</td><td>906.1 MB/s<br/>404270 R/s</td><td><strong>+87%</strong></td></tr><tr><td>8</td><td>773.3 MB/s<br/>381300 R/s</td><td>1669.1 MB/s<br/>745654 R/s</td><td><strong>+95%</strong></td></tr></tbody></table>
<h4 data-id="heading-11">场景三：Parquet/ORC → MaxCompute 同步</h4>























<table><thead><tr><th><strong>并发数</strong></th><th><strong>传统同步</strong></th><th><strong>Arrow同步</strong></th><th><strong>性能提升</strong></th></tr></thead><tbody><tr><td>Parquet</td><td>26.1 MB/s<br/>35631 R/s</td><td>1198.1 MB/s<br/>233587 R/s</td><td><strong>5.55倍</strong></td></tr><tr><td>ORC</td><td>21.4 MB/s<br/>27661 R/s</td><td>3256.3 MB/s<br/>300326 R/s</td><td><strong>9.85倍</strong></td></tr></tbody></table>
<p>备注：Parquet、ORC文件可以在HDFS、OSS等分布式文件系统中</p>
<h2 data-id="heading-12">核心优势：不止于快，更稳、更低成本</h2>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>价值说明</strong></th></tr></thead><tbody><tr><td><strong>高性能</strong></td><td>吞吐量提升最高达10倍，适合宽表、大数据量搬站同步</td></tr><tr><td><strong>低资源消耗</strong></td><td>零拷贝 + 内存复用，降低GC压力，节省计算成本</td></tr><tr><td><strong>高兼容性</strong></td><td>支持MaxCompute、Hologres、Hive等主流列存系统</td></tr><tr><td><strong>易用性</strong></td><td>仅需配置useArrow: true，无需代码改造</td></tr></tbody></table>
<h2 data-id="heading-13">典型应用场景：释放数据流转的无限可能</h2>
<h3 data-id="heading-14">场景一：大数据搬站迁移</h3>
<p><strong>痛点</strong>：从Hive向MaxCompute迁移数百TB数据，耗时较久，影响业务上线 <strong>方案</strong>：启用Arrow同步，列存直传，避免格式转换 <strong>成果</strong>：迁移时间从<strong>小时级同步缩短至分钟级</strong>，效率提升<strong>10倍以上</strong></p>
<h3 data-id="heading-15">场景二：异构数据源融合与湖仓一体化</h3>
<p>支持Hive（湖）与Hologres/MaxCompute（仓）之间的列存高效互通，为<strong>数据湖仓一体架构</strong>提供核心数据流转引擎，实现“一数多用、湖仓协同”。</p>
<h2 data-id="heading-16">如何使用？一步开启Arrow加速</h2>
<h3 data-id="heading-17">整库解决方案</h3>
<p>数据集成已经发布Hive-&gt;MaxCompute整库同步功能，默认会自动根据同步字段类型，渲染开启Arrow高性能同步能力。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc8b5382ecb040a09dfd13c2ed3b489b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088161&amp;x-signature=QFcx7sxCZ4gxwzZDzTqNnOW7I2w%3D" alt="image.png" loading="lazy"/></p>
<p>💡 <strong>无需代码改造，无需理解底层细节，一键开启高性能同步</strong>。</p>
<h3 data-id="heading-18">单表离线同步</h3>
<p>DataWorks数据集成单表离线任务，在reader和writer parameter下添加 useArrow: true 参数，即可开启列式加速（由于是列存格式直读直写，开启前提是需要保证源端和目标端列类型保持一致）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"job"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"steps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"stepType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hive"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"parameter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"useArrow"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"datasource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my_datasource"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"col1"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-string">"col2"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"readMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hdfs"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"table"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Reader"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"reader"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"stepType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"odps"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"parameter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"useArrow"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"truncate"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"datasource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"odps_test"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"column"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"col1"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-string">"col2"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"table"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"table"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Writer"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"writer"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"setting"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"speed"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"concurrent"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-19">未来演进：构建更强大的数据同步生态</h2>
<p>DataWorks将持续深化Arrow能力，打造企业级高性能数据流转平台：</p>
<ul>
<li>
<p><strong>更多数据源支持</strong>：扩展至HDFS、Paimon、ClickHouse、Iceberg等；</p>
</li>
<li>
<p><strong>智能调度优化</strong>：根据数据特征自动选择Arrow或行式模式；</p>
</li>
<li>
<p><strong>生态融合</strong>：为DataWorks数据搬站，提供端到端数据解决方案</p>
</li>
</ul>
<h2 data-id="heading-20">结语：让数据真正高性能“跑”起来</h2>
<p>DataWorks数据集成引入Apache Arrow列存同步能力，列式、零拷贝、内存级传输为同步性能带来显著提升。DataWorks数据集成正以技术创新为引擎，帮助企业打破数据孤岛、消除性能瓶颈，让数据在湖仓之间、系统之间、业务之间高速、稳定、低成本流动。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Xcode 26 Debug view hierarchy 不显示隐藏视图问题]]></title>    <link>https://juejin.cn/post/7586851351469555752</link>    <guid>https://juejin.cn/post/7586851351469555752</guid>    <pubDate>2025-12-23T09:58:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586851351469555752" data-draft-id="7586869907066175523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Xcode 26 Debug view hierarchy 不显示隐藏视图问题"/> <meta itemprop="keywords" content="Xcode"/> <meta itemprop="datePublished" content="2025-12-23T09:58:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiAo_Ju"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681926029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Xcode 26 Debug view hierarchy 不显示隐藏视图问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681926029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiAo_Ju
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:58:13.000Z" title="Tue Dec 23 2025 09:58:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aecb1be6633d45589698f5cb888c0956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlBb19KdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767088693&amp;x-signature=NaD62bgDM8JxZN9n1pGamc2Xipc%3D" alt="Screenshot 2025-12-23 at 17.54.44.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战]]></title>    <link>https://juejin.cn/post/7586622708999634984</link>    <guid>https://juejin.cn/post/7586622708999634984</guid>    <pubDate>2025-12-23T08:05:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999634984" data-draft-id="7586687526866845711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-23T08:05:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武当王丶也"/> <meta itemprop="url" content="https://juejin.cn/user/4424090519351374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4424090519351374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武当王丶也
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:05:45.000Z" title="Tue Dec 23 2025 08:05:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>如何用本地模型打造一个懂你业务的 AI 助手？本文手把手教你从零搭建一个生产级 RAG 对话系统</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8d7fff456046858cf4579c6594f51b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=E%2BeugeJRxjz5Cyy%2Fl%2BpU8WrGVKs%3D" alt="AI Chat" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6145682cd8714d40bb97e3d4390dcfc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=cWaoYgT0qcBSK9tVLxFvAyExkyE%3D" alt="RAG" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/125fb793a9094222b1a36b26703f347b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=N%2FOhgUR25la6GP%2F4yxQpIRHNJsg%3D" alt="Python" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8997801e0da34575a7e719d7fa08e7d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=3vmGVQ29O2e52IhT2WStvS4GVd4%3D" alt="FastAPI" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>最近 AI 大模型火爆出圈，ChatGPT、Claude 等产品让对话式 AI 成为可能。但企业落地时面临一个核心痛点：<strong>通用大模型不懂你的业务数据</strong>。</p>
<p>比如你问："我们公司的请假流程是怎样的？" —— ChatGPT 只能给你通用回答，而无法基于你公司的员工手册来回答。</p>
<p><strong>RAG（检索增强生成）技术正是为此而生</strong>。它让 AI 能够"外挂"知识库，先检索相关文档，再基于检索结果生成答案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a4f36cbcd14835b5d731cd9e375d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=OtgMAT9juTuibyZdbyY0BFcXK%2F8%3D" alt="Gemini_Generated_Image_rdztwkrdztwkrdzt.png" loading="lazy"/></p>
<p>本文将详细介绍如何从零构建一个生产级的 RAG 对话系统 <strong>Ace AI</strong>，涵盖：</p>
<ul>
<li>使用 <strong>Ollama</strong> 本地部署 AI 模型</li>
<li>使用 <strong>Python + FastAPI</strong> 编写后端服务</li>
<li>使用 <strong>ChromaDB</strong> 构建向量知识库</li>
<li>前端对接实现 AI 对话窗口</li>
<li>Docker 容器化部署</li>
</ul>
<p>在线体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a></p>
<p>GitHub 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Face0109%2Face-ai" target="_blank" title="https://github.com/ace0109/ace-ai" ref="nofollow noopener noreferrer">github.com/ace0109/ace…</a> ⭐</p>
<hr/>
<h2 data-id="heading-1">一、RAG 技术原理</h2>
<h3 data-id="heading-2">1.1 什么是 RAG？</h3>
<p>RAG（Retrieval-Augmented Generation，检索增强生成）是一种结合信息检索和文本生成的技术架构：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────┐
│                        RAG 工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户问题                                                       │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ 向量检索    │ ──────► 从知识库中检索最相关的文档片段          │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ 提示词构造  │ ──────► 将检索结果融入 <span class="hljs-keyword">System</span> Prompt          │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ LLM 生成    │ ──────► 基于上下文生成答案                   │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  流式返回给用户                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">1.2 核心组件</h3>



































<table><thead><tr><th>组件</th><th>作用</th><th>技术选型</th></tr></thead><tbody><tr><td><strong>LLM</strong></td><td>对话生成</td><td>Ollama (qwen3-coder)</td></tr><tr><td><strong>Embedding 模型</strong></td><td>文本向量化</td><td>Ollama (nomic-embed-text)</td></tr><tr><td><strong>向量数据库</strong></td><td>存储和检索文档</td><td>ChromaDB</td></tr><tr><td><strong>文本分割器</strong></td><td>文档切分</td><td>LangChain RecursiveCharacterTextSplitter</td></tr><tr><td><strong>后端框架</strong></td><td>API 服务</td><td>FastAPI</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、项目结构</h2>
<pre><code class="hljs language-bash" lang="bash">ace-ai/
├── app/
│   ├── main.py                   <span class="hljs-comment"># FastAPI 应用入口</span>
│   ├── services/
│   │   └── rag.py               <span class="hljs-comment"># RAG 服务实现</span>
│   ├── api/routes/
│   │   ├── chat.py              <span class="hljs-comment"># 聊天接口</span>
│   │   └── documents.py         <span class="hljs-comment"># 文档上传</span>
│   └── core/
│       └── auth.py              <span class="hljs-comment"># API Key 认证</span>
├── data/                         <span class="hljs-comment"># 数据存储</span>
├── chroma_db/                    <span class="hljs-comment"># 向量数据库</span>
└── Dockerfile
</code></pre>
<hr/>
<h2 data-id="heading-5">三、Ollama 部署 AI 模型</h2>
<h3 data-id="heading-6">3.1 安装 Ollama</h3>
<p>Ollama 是一个本地运行大模型的工具，支持 macOS、Linux 和 Windows。</p>
<p><strong>macOS / Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://ollama.com/install.sh | sh
</code></pre>
<p><strong>Windows:</strong> 下载安装包 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">ollama.com</a></p>
<h3 data-id="heading-7">3.2 拉取所需模型</h3>
<p>Ace AI 需要两类模型：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. Chat 模型 - 用于对话生成</span>
ollama pull qwen3-coder:480b-cloud

<span class="hljs-comment"># 2. Embedding 模型 - 用于文本向量化</span>
ollama pull nomic-embed-text
</code></pre>
<h3 data-id="heading-8">3.3 验证 Ollama 服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 Ollama 是否正常运行</span>
curl http://localhost:11434/api/tags

<span class="hljs-comment"># 测试 Chat 模型</span>
curl http://localhost:11434/api/generate -d <span class="hljs-string">'{
  "model": "qwen3-coder:480b-cloud",
  "prompt": "Hello, how are you?"
}'</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、后端服务实现</h2>
<h3 data-id="heading-10">4.1 RAG 服务核心实现</h3>
<p>RAG 服务是整个系统的核心，负责文档向量化、存储和检索。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/services/rag.py</span>

<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> OllamaEmbeddings
<span class="hljs-keyword">from</span> langchain_chroma <span class="hljs-keyword">import</span> Chroma
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">import</span> threading

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGService</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 线程锁，保护向量存储操作</span>
        self._lock = threading.RLock()

        <span class="hljs-comment"># 初始化 Embedding 模型</span>
        self.embeddings = OllamaEmbeddings(
            model=<span class="hljs-string">"nomic-embed-text"</span>,
            base_url=<span class="hljs-string">"http://localhost:11434"</span>,
        )

        <span class="hljs-comment"># 初始化向量数据库</span>
        self.vector_store = Chroma(
            persist_directory=<span class="hljs-string">"./chroma_db"</span>,
            embedding_function=self.embeddings
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_documents</span>(<span class="hljs-params">self, texts, metadatas=<span class="hljs-literal">None</span>, ids=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""将文档存入向量数据库"""</span>
        documents = [
            Document(page_content=text, metadata=metadatas[i] <span class="hljs-keyword">if</span> metadatas <span class="hljs-keyword">else</span> {})
            <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(texts)
        ]
        <span class="hljs-keyword">with</span> self._lock:
            self.vector_store.add_documents(documents, ids=ids)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, query_text: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""根据问题检索最相关的 k 个文档片段"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            <span class="hljs-keyword">return</span> self.vector_store.similarity_search(query_text, k=k)
</code></pre>
<h3 data-id="heading-11">4.2 文档上传处理</h3>
<p>当用户上传文档时，需要经过解析、分块、向量化三个步骤：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/api/routes/documents.py</span>

<span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

<span class="hljs-comment"># 文本分割器配置</span>
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">1000</span>,        <span class="hljs-comment"># 每块最大字符数</span>
    chunk_overlap=<span class="hljs-number">200</span>,      <span class="hljs-comment"># 块之间重叠字符数</span>
    separators=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">"。"</span>, <span class="hljs-string">"！"</span>, <span class="hljs-string">"？"</span>, <span class="hljs-string">"."</span>, <span class="hljs-string">"!"</span>, <span class="hljs-string">"?"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>]
)

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">"/upload"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_document</span>(<span class="hljs-params">file: UploadFile</span>):
    <span class="hljs-comment"># 1. 解析文件内容 (支持 PDF/TXT/MD)</span>
    text = parse_file_content(<span class="hljs-keyword">await</span> file.read(), file.filename)

    <span class="hljs-comment"># 2. 文本分块</span>
    chunks = text_splitter.split_text(text)

    <span class="hljs-comment"># 3. 生成唯一 ID 和元数据</span>
    base_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
    chunk_ids = [<span class="hljs-string">f"<span class="hljs-subst">{base_id}</span>_chunk_<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))]
    metadatas = [
        {
            <span class="hljs-string">"source"</span>: file.filename,
            <span class="hljs-string">"upload_time"</span>: datetime.now(timezone.utc).isoformat(),
            <span class="hljs-string">"chunk_index"</span>: i,
        }
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))
    ]

    <span class="hljs-comment"># 4. 存入向量数据库</span>
    rag_service.add_documents(chunks, metadatas=metadatas, ids=chunk_ids)

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">f"Document uploaded successfully, <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunks)}</span> chunks created"</span>}
</code></pre>
<h3 data-id="heading-12">4.3 聊天接口实现</h3>
<p>聊天接口支持流式响应（SSE），让用户实时看到 AI 的回答：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/api/routes/chat.py</span>

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">""</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_with_ollama</span>(<span class="hljs-params">messageBody: MessageBody</span>):
    <span class="hljs-comment"># 1. 处理会话 (创建新会话或使用已有会话)</span>
    session_id = messageBody.session_id <span class="hljs-keyword">or</span> create_new_session()

    <span class="hljs-comment"># 2. 保存用户消息</span>
    chat_store.add_message(session_id, <span class="hljs-string">"user"</span>, messageBody.message)

    <span class="hljs-comment"># 3. 获取历史消息 (最近 10 条)</span>
    history = chat_store.get_messages(session_id)[-<span class="hljs-number">10</span>:]

    <span class="hljs-comment"># 4. RAG 检索相关文档</span>
    <span class="hljs-keyword">try</span>:
        relevant_docs = rag_service.query(messageBody.message, k=<span class="hljs-number">3</span>)
        context_text = <span class="hljs-string">"\n\n"</span>.join([doc.page_content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> relevant_docs])
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        context_text = <span class="hljs-string">""</span>  <span class="hljs-comment"># 降级：不使用 RAG 上下文</span>

    <span class="hljs-comment"># 5. 构造提示词</span>
    system_prompt = <span class="hljs-string">"用中文回复。"</span>
    <span class="hljs-keyword">if</span> context_text:
        system_prompt += <span class="hljs-string">f"""
请基于以下【已知信息】回答用户的问题。如果没有已知信息，才按照你的知识回答。

【已知信息】:
<span class="hljs-subst">{context_text}</span>
"""</span>

    <span class="hljs-comment"># 6. 流式生成响应</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream_response</span>():
        <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: {{'session_id': '<span class="hljs-subst">{session_id}</span>'}}\n\n"</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.astream(messages):
            <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: <span class="hljs-subst">{json.dumps(chunk)}</span>\n\n"</span>

    <span class="hljs-keyword">return</span> StreamingResponse(stream_response(), media_type=<span class="hljs-string">"text/event-stream"</span>)
</code></pre>
<h3 data-id="heading-13">4.4 API Key 认证</h3>
<p>为了保护 API 安全，实现了基于 API Key 的认证机制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/core/auth.py</span>

<span class="hljs-keyword">import</span> hashlib

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_api_key</span>(<span class="hljs-params">raw_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>]:
    <span class="hljs-string">"""验证 API Key"""</span>
    key_hash = hashlib.sha256(raw_key.encode()).hexdigest()
    cursor.execute(
        <span class="hljs-string">"SELECT id, role, label FROM api_keys WHERE key_hash = ?"</span>,
        (key_hash,)
    )
    <span class="hljs-keyword">return</span> cursor.fetchone()

<span class="hljs-comment"># API 路由认证依赖</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">require_api_key</span>(<span class="hljs-params">request: Request</span>):
    api_key = request.headers.get(<span class="hljs-string">"X-API-Key"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">401</span>, detail=<span class="hljs-string">"API Key required"</span>)

    key_record = verify_api_key(api_key)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> key_record:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">403</span>, detail=<span class="hljs-string">"Invalid API Key"</span>)

    request.state.api_key_record = key_record
    <span class="hljs-keyword">return</span> key_record
</code></pre>
<hr/>
<h2 data-id="heading-14">五、前端对接实现</h2>
<p>前端通过 SSE（Server-Sent Events）接收流式响应：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端调用示例</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message, sessionId</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://localhost:8888/api/chat'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      <span class="hljs-string">'X-API-Key'</span>: <span class="hljs-string">'your-api-key-here'</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ message, <span class="hljs-attr">session_id</span>: sessionId })
  });

  <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);
    <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>));

        <span class="hljs-comment">// 第一个数据包包含 session_id</span>
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">session_id</span>) {
          sessionId = data.<span class="hljs-property">session_id</span>;
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 后续数据包是 AI 的回复内容</span>
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">content</span>) {
          <span class="hljs-title function_">appendToChat</span>(data.<span class="hljs-property">content</span>);  <span class="hljs-comment">// 追加到聊天窗口</span>
        }
      }
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-15">六、Docker 部署</h2>
<h3 data-id="heading-16">6.1 Dockerfile</h3>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 拷贝代码
COPY app app

# 预创建运行时目录
RUN mkdir -p /app/data /app/chroma_db /app/logs

EXPOSE 8888

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8888"]
</code></pre>
<h3 data-id="heading-17">6.2 构建和运行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 构建镜像</span>
docker build -t ace-ai:latest .

<span class="hljs-comment"># 2. 运行容器</span>
docker run -d \
  --name ace-ai \
  --network host \
  -v $(<span class="hljs-built_in">pwd</span>)/data:/app/data \
  -v $(<span class="hljs-built_in">pwd</span>)/chroma_db:/app/chroma_db \
  -v $(<span class="hljs-built_in">pwd</span>)/logs:/app/logs \
  -e TZ=Asia/Shanghai \
  -e OLLAMA_BASE_URL=http://127.0.0.1:11434 \
  --restart unless-stopped \
  ace-ai:latest

<span class="hljs-comment"># 3. 获取超级管理员 API Key</span>
<span class="hljs-built_in">cat</span> data/initial_superadmin_key.txt

<span class="hljs-comment"># 4. 访问 API 文档</span>
open http://localhost:8888/docs
</code></pre>
<hr/>
<h2 data-id="heading-18">七、效果展示</h2>
<h3 data-id="heading-19">7.1 上传文档构建知识库</h3>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:8888/api/documents/upload \
  -H <span class="hljs-string">"X-API-Key: your-api-key"</span> \
  -F <span class="hljs-string">"file=@employee_handbook.pdf"</span>
</code></pre>
<h3 data-id="heading-20">7.2 进行对话</h3>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:8888/api/chat \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"X-API-Key: your-api-key"</span> \
  -d <span class="hljs-string">'{"message": "年假怎么申请？"}'</span>
</code></pre>
<h3 data-id="heading-21">7.3 在线体验</h3>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a> 即可体验完整的 RAG 对话系统。</p>
<hr/>
<h2 data-id="heading-22">八、技术栈</h2>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">后端: Python 3.11 + FastAPI</span>
<span class="hljs-section">向量库: ChromaDB</span>
<span class="hljs-section">LLM: Ollama (qwen3-coder:480b-cloud)</span>
<span class="hljs-section">Embedding: Ollama (nomic-embed-text)</span>
<span class="hljs-section">容器: Docker</span>
</code></pre>
<h3 data-id="heading-23">主要特性</h3>
<ul>
<li><strong>SSE 流式响应</strong>：实时返回 AI 回复</li>
<li><strong>API Key 认证</strong>：保护接口安全</li>
<li><strong>文档解析</strong>：支持 PDF、TXT、Markdown</li>
<li><strong>Docker 部署</strong>：一键启动</li>
</ul>
<hr/>
<h2 data-id="heading-24">九、总结</h2>
<p>本文介绍了如何快速搭建一个基于 RAG 的 AI 对话系统，核心就是：</p>
<ol>
<li><strong>Ollama</strong> 本地运行 LLM</li>
<li><strong>ChromaDB</strong> 存储向量知识库</li>
<li><strong>FastAPI</strong> 提供 API 接口</li>
<li><strong>前端</strong> 通过 SSE 实现流式对话</li>
</ol>
<p><strong>GitHub 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Face0109%2Face-ai" target="_blank" title="https://github.com/ace0109/ace-ai" ref="nofollow noopener noreferrer">github.com/ace0109/ace…</a> ⭐</p>
<p><strong>在线体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a></p>
<p>有问题欢迎在评论区讨论！</p>
<hr/>
<p><strong>参考链接</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">Ollama 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com" target="_blank" title="https://python.langchain.com" ref="nofollow noopener noreferrer">LangChain 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.trychroma.com" target="_blank" title="https://docs.trychroma.com" ref="nofollow noopener noreferrer">ChromaDB 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com" target="_blank" title="https://fastapi.tiangolo.com" ref="nofollow noopener noreferrer">FastAPI 文档</a></li>
</ul>
<blockquote>
<p>本文首发于掘金，转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？]]></title>    <link>https://juejin.cn/post/7586610067569131520</link>    <guid>https://juejin.cn/post/7586610067569131520</guid>    <pubDate>2025-12-23T08:23:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067569131520" data-draft-id="7586687526866829327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-23T08:23:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金詹姆斯"/> <meta itemprop="url" content="https://juejin.cn/user/2289608413155021"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2289608413155021/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金詹姆斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:23:48.000Z" title="Tue Dec 23 2025 08:23:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1、前言</h2>
<p>Python 在当前 <strong>AI 全栈开发</strong> 中扮演着<strong>核心且不可替代</strong>的角色，其重要性体现在从<strong>数据处理、模型训练、API 构建到前端交互和部署运维</strong>的每一个环节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dc5ff91b92a4b9b8a54276d684bcaa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6Km55aeG5pav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083027&amp;x-signature=28C7x3Vk3%2F%2FfWnZhWdot8uLSxh4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2、全栈开发中的“全”在 AI 场景下的新定义</h2>
<p>传统全栈 = 前端 + 后端 + 数据库</p>
<p><strong>AI 全栈</strong> = 数据工程 + 模型开发 + API服务 + 应用集成 + 部署监控</p>
<p><strong>Python 凭借其统一技术栈能力，几乎贯穿整个 AI 全流程：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b7f3e9092754c2ea7ec1b682903771c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6Km55aeG5pav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083027&amp;x-signature=5aaIqO2IsgzAWkQSCzHWhMFC4B0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">3、为什么其他语言难以替代？</h2>
<p><strong>生态完整性</strong></p>
<ul>
<li>几乎所有主流 AI 框架（PyTorch/TensorFlow/JAX）<strong>原生优先支持 Python</strong></li>
<li>Hugging Face、LangChain 等新兴 AI 工具链 <strong>以 Python 为默认接口</strong></li>
<li>连 OpenAI、Anthropic、Google DeepMind 的官方 SDK 都是 <strong>Python-first</strong></li>
</ul>
<p><strong>开发效率碾压</strong></p>
<ul>
<li>用 FastAPI + PyTorch 可在 <strong>10 行代码内</strong> 暴露一个大模型推理接口</li>
<li>Gradio 三行代码生成 Web UI，用于<strong>快速验证</strong> AI 功能</li>
<li>相比 Rust/C++，Python 让开发者聚焦 “<strong>做什么”而非“怎么做内存管理</strong>”</li>
</ul>
<p><strong>社区与人才储备</strong></p>
<ul>
<li>全球超 <strong>75% 的 AI/ML 岗位明确要求 Python</strong></li>
<li>GitHub 上 AI 相关项目 <strong>80%+ 使用 Python</strong></li>
<li>高校 AI 课程普遍以 Python 为教学语言，形成<strong>人才正循环</strong></li>
</ul>
<h2 data-id="heading-3">4、典型 AI 全栈项目中的 Python 实践</h2>
<p>假设你要开发一个 智能客服问答系统 ：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 数据加载（pandas）</span>
df = pd.read_csv(<span class="hljs-string">"faq_data.csv"</span>)

<span class="hljs-comment"># 2. 向量检索（sentence-transformers + FAISS）</span>
<span class="hljs-keyword">from</span> sentence_transformers <span class="hljs-keyword">import</span> SentenceTransformer
model = SentenceTransformer(<span class="hljs-string">'all-MiniLM-L6-v2'</span>)
vectors = model.encode(df[<span class="hljs-string">'question'</span>].tolist())

<span class="hljs-comment"># 3. 构建 RAG（LangChain）</span>
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
qa_chain = RetrievalQA.from_chain_type(llm, retriever=faiss_retriever)

<span class="hljs-comment"># 4. 提供 API（FastAPI）</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/ask"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> qa_chain.run(query)

<span class="hljs-comment"># 5. 快速演示（Gradio）</span>
gr.Interface(fn=ask, inputs=<span class="hljs-string">"text"</span>, outputs=<span class="hljs-string">"text"</span>).launch()
</code></pre>
<h2 data-id="heading-4">5、未来趋势：Python 仍是 AI 全栈的“中枢神经”</h2>
<ul>
<li><strong>多模态 AI</strong>（文本+图像+语音）：Transformers + OpenCV + librosa 全在 Python 生态</li>
<li><strong>AI Agent 开发</strong>：LangChain、AutoGen 等框架完全基于 Python</li>
<li><strong>MLOps 工具链</strong>：MLflow、Weights &amp; Biases、DVC 均提供 Python SDK</li>
</ul>
<h2 data-id="heading-5">6、结论</h2>
<blockquote>
<p><strong>Python 不仅是 AI 开发的语言，更是 AI 全栈开发的“操作系统”</strong></p>
</blockquote>
<blockquote>
<p><strong>成为当前 AI 工程师必须掌握的核心技能。无论你是算法研究员、后端工程师还是创业者，精通 Python 就等于握住了 AI 时代的全栈通行证</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript中的迭代器和生成器]]></title>    <link>https://juejin.cn/post/7586622708999847976</link>    <guid>https://juejin.cn/post/7586622708999847976</guid>    <pubDate>2025-12-23T08:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999847976" data-draft-id="7586617459488882740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript中的迭代器和生成器"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T08:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户31305008627"/> <meta itemprop="url" content="https://juejin.cn/user/2455641727456105"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript中的迭代器和生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455641727456105/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户31305008627
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:35:27.000Z" title="Tue Dec 23 2025 08:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先讲迭代器（Iterator）：就是“能一个个往外拿东西的容器”</h2>
<p>你可以把迭代器想象成自动售货机：</p>
<ul>
<li>你先有一堆商品（比如数组 [1,2,3]），把它们放进售货机里，这个售货机就是迭代器；</li>
<li>你每次按“出货”按钮（调用 <code>next()</code> 方法），它就给你出一个商品，出完一个就少一个；</li>
<li>等商品出完了，再按按钮就会返回 <code>{ value: undefined, done: true }</code>（提示“没货了”）；</li>
<li>而且它只能单向前进，出了2就回不到1了，不能倒着拿。</li>
</ul>
<h3 data-id="heading-1">JavaScript 迭代器的简单例子</h3>
<pre><code class="hljs language-vbscript" lang="vbscript">// <span class="hljs-number">1.</span> 先准备一个数组（一堆商品）
<span class="hljs-keyword">const</span> nums = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

// <span class="hljs-number">2.</span> 把数组变成迭代器（装进售货机）
<span class="hljs-keyword">const</span> it = nums[Symbol.iterator]();

// <span class="hljs-number">3.</span> 按按钮拿东西（调用 <span class="hljs-keyword">next</span>()）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">1</span>, done: <span class="hljs-literal">false</span> }（拿第一个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">2</span>, done: <span class="hljs-literal">false</span> }（拿第二个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">3</span>, done: <span class="hljs-literal">false</span> }（拿第三个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: undefined, done: <span class="hljs-literal">true</span> }（没货了）
</code></pre>
<h3 data-id="heading-2">迭代器的核心特点</h3>
<ol>
<li>必须有一个 <code>next()</code> 方法，调用后返回固定格式：<code>{ value: 具体值, done: 是否迭代完 }</code>；</li>
<li>惰性获取：只有调用 <code>next()</code> 才会返回下一个值，不会一次性把所有值加载到内存；</li>
<li>用完就没：只能往前，不能回头，也不能重复用。</li>
</ol>
<h3 data-id="heading-3">手动实现一个简单迭代器（理解原理）</h3>
<p>就像自己造一个简易售货机：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动实现迭代器：模拟售货机逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createIterator</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录当前拿到第几个</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 核心的 next() 方法</span>
    <span class="hljs-attr">next</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 如果没拿完，返回当前值 + 未完成；否则返回 undefined + 已完成</span>
      <span class="hljs-keyword">if</span> (index &lt; arr.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: arr[index++], <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
      }
    }
  };
}

<span class="hljs-comment">// 使用这个自定义迭代器</span>
<span class="hljs-keyword">const</span> myIt = <span class="hljs-title function_">createIterator</span>([<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 10, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 20, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 30, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: undefined, done: true }</span>
</code></pre>
<h2 data-id="heading-4">再讲生成器：“自动造东西的迭代器”</h2>
<p>生成器是迭代器的升级版，你可以把它想象成现做现卖的小吃摊：</p>
<ul>
<li>迭代器是“先把所有东西准备好再往外拿”（比如先把1、2、3都放进售货机）；</li>
<li>生成器是“你要一个，我才做一个”（比如你要第一个包子，我才包第一个，要第二个才包第二个）；</li>
<li>它不用提前把所有数据存在内存里，而是“按需生成”，特别省内存。</li>
</ul>
<h3 data-id="heading-5">JavaScript 生成器的核心：<code>function*</code> + <code>yield</code></h3>
<p><code>function*</code> 是生成器函数的标识（注意多了个 <code>*</code>），<code>yield</code> 就是“暂停并返回”的意思——比如你去小吃摊买包子，老板包一个给你，然后暂停，等你要下一个再继续包。</p>
<h3 data-id="heading-6">生成器的完整例子（最常用）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义生成器函数（注意 function* 和 yield）</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">makeBuns</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第一个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 包好第一个，返回，暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第二个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>; <span class="hljs-comment">// 继续，包第二个，返回，暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第三个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 继续，包第三个，返回，暂停</span>
}

<span class="hljs-comment">// 调用函数，得到生成器（此时函数不会执行，只是创建生成器）</span>
<span class="hljs-keyword">const</span> bunGen = <span class="hljs-title function_">makeBuns</span>();

<span class="hljs-comment">// 第一次拿：执行到第一个yield，返回 { value: 1, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第一个包子 → { value: 1, done: false }</span>
<span class="hljs-comment">// 第二次拿：从暂停的地方继续，执行到第二个yield</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第二个包子 → { value: 2, done: false }</span>
<span class="hljs-comment">// 第三次拿：继续，执行到第三个yield</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第三个包子 → { value: 3, done: false }</span>
<span class="hljs-comment">// 第四次拿：没包子了，返回 done: true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：{ value: undefined, done: true }</span>
</code></pre>
<h3 data-id="heading-7">生成器的实用场景：按需生成大量数据</h3>
<p>比如要生成 100 万个数字，用数组会占满内存，但生成器只在需要时计算：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成器：按需生成数字，不占内存</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">generateBigNumbers</span>(<span class="hljs-params">max</span>) {
  <span class="hljs-keyword">let</span> num = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (num &lt;= max) {
    <span class="hljs-keyword">yield</span> num++; <span class="hljs-comment">// 要一个，生成一个</span>
  }
}

<span class="hljs-comment">// 生成 100 万个数字的生成器（此时还没生成任何数字）</span>
<span class="hljs-keyword">const</span> bigNumGen = <span class="hljs-title function_">generateBigNumbers</span>(<span class="hljs-number">1000000</span>);

<span class="hljs-comment">// 只拿前3个，后面的不会生成</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 3</span>
</code></pre>
<h2 data-id="heading-8">迭代器 vs 生成器 一句话区分（JS 版本）</h2>
<ul>
<li>迭代器：已有数据的“搬运工”（把现成的东西一个个拿出来，比如数组迭代器）；</li>
<li>生成器：按需生成数据的“生产者”（没有现成数据，要的时候才造，用 <code>function*</code> + <code>yield</code>）；</li>
<li>生成器本质上是一种“自动实现了迭代器接口”的迭代器，写起来比手动迭代器简单 10 倍。</li>
</ul>
<hr/>
<h3 data-id="heading-9">总结</h3>
<ol>
<li>迭代器：像自动售货机，提前装好物，按一次出一个，出完为止，核心是“遍历已有数据”；</li>
<li>生成器：像现做现卖的小吃摊，不用提前备货，要一个做一个，核心是“按需生成数据”，更省内存；</li>
<li>JS 里迭代器靠 <code>next()</code> 方法和 <code>{ value, done }</code> 格式，生成器靠 <code>function*</code> + <code>yield</code>，两者都是“惰性计算”，适合处理大数据。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git：新建功能分支并解决 Merge 冲突]]></title>    <link>https://juejin.cn/post/7586614240532135962</link>    <guid>https://juejin.cn/post/7586614240532135962</guid>    <pubDate>2025-12-23T08:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586614240532135962" data-draft-id="7586836874015834122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git：新建功能分支并解决 Merge 冲突"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-12-23T08:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AntoineGriezmann"/> <meta itemprop="url" content="https://juejin.cn/user/1313259659208356"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git：新建功能分支并解决 Merge 冲突
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1313259659208356/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AntoineGriezmann
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:27:59.000Z" title="Tue Dec 23 2025 08:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在给自己的博客项目增加 <strong>中英文切换（i18n）功能</strong>，顺便走一遍从新建功能分支 -&gt; 开发提交 -&gt; 合并回主分支 -&gt; 解决冲突 -&gt; 推送远端。</p>
<h2 data-id="heading-0">一、新建功能分支（feature/i18n）</h2>
<p>在新建分支之前，我先确保主分支是最新的：</p>
<pre><code class="hljs language-css" lang="css">git checkout <span class="hljs-selector-tag">main</span>
git pull
</code></pre>
<p>然后创建并切换到功能分支：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout -b feature/i18n
</code></pre>
<blockquote>
<p><strong>分支并不是拷贝文件，而是一条独立的时间线。</strong></p>
</blockquote>
<p>接下来，所有和 i18n 相关的开发都会在这个分支上完成。</p>
<h2 data-id="heading-1">二、在新分支人为添加冲突</h2>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- main分支/xxx.vue</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'main分支'</span>)

<span class="hljs-comment">-- feature/i18n分支/xxx.vue</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'feature/i18n分支'</span>)

</code></pre>
<h2 data-id="heading-2">三、在功能分支上开发并提交</h2>
<p>在 <code>feature/i18n</code> 分支上完成阶段性开发后，我进行了正常的提交：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">add</span> .
git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "feat: add basic i18n support"
</code></pre>
<p>第一次把这个分支推到远端时，需要加上 <code>-u</code>：</p>
<pre><code class="hljs language-bash" lang="bash">git push -u origin feature/i18n
</code></pre>
<p>这样可以建立本地分支和远端分支的追踪关系，之后只需要：</p>
<pre><code class="hljs language-perl" lang="perl">git <span class="hljs-keyword">push</span>
</code></pre>
<h2 data-id="heading-3">四、合并回 main 分支，遇到冲突</h2>
<p>功能完成后，我准备把代码合并回 <code>main</code>：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout main
git pull
git merge feature/i18n
</code></pre>
<p>这时 Git 提示出现冲突，例如：</p>
<pre><code class="hljs language-css" lang="css">CONFLICT (<span class="hljs-attribute">content</span>): Merge conflict in xxx.vue
</code></pre>
<h2 data-id="heading-4">五、解决冲突的步骤</h2>
<ol>
<li>打开冲突文件</li>
<li>理解两个分支代码的差异</li>
<li>保留正确的逻辑</li>
<li>保存文件</li>
</ol>
<p>然后执行：</p>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">add</span> .
</code></pre>
<p>这一步非常关键，它的含义是：</p>
<blockquote>
<p><strong>告诉 Git：这些冲突我已经手动解决完了</strong></p>
</blockquote>
<h2 data-id="heading-5">六、完成 merge commit（一个容易踩坑的点）</h2>
<p>解决冲突后，我执行了：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">commit</span>
</code></pre>
<p>这时 Git 打开了编辑器（Vim），让我确认提交信息。</p>
<p>后来我才明白，在 merge 冲突场景下，更推荐直接使用：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">commit</span> <span class="hljs-comment">--no-edit</span>
</code></pre>
<p>它的含义是：</p>
<blockquote>
<p><strong>直接使用 Git 自动生成的 merge 提交信息，不打开编辑器</strong></p>
</blockquote>
<p>这一步完成后，merge commit 只存在于<strong>本地 main 分支</strong>。</p>
<h2 data-id="heading-6">七、提交到远程分支</h2>
<pre><code class="hljs language-perl" lang="perl">git <span class="hljs-keyword">push</span>
</code></pre>
<p>只有执行了 <code>git push</code>：</p>
<ul>
<li>merge commit 才会出现在远端</li>
<li>GitHub 上的 <code>main</code> 分支才会更新</li>
<li>功能才算真正合并完成</li>
</ul>
<h2 data-id="heading-7">八、总结</h2>
<p>这次并没有用到多么高级的 Git 技巧，只是记录从
<strong>分支创建 → 功能开发 → 合并 → 冲突解决 → 推送远端</strong></p>
<blockquote>
<p>本次实践让我第一次把 Git 的分支开发和冲突处理流程真正串联起来。<br/>
把这些过程记录下来，一方面是对自己学习轨迹的梳理，另一方面也希望逐步积累技术表达的能力。<br/>
这篇文章算是一个起点，为后续系统性地撰写技术文章打下基础。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app 项目在 iOS 上架过程中常见的问题与应对方式]]></title>    <link>https://juejin.cn/post/7586861592710823972</link>    <guid>https://juejin.cn/post/7586861592710823972</guid>    <pubDate>2025-12-23T08:36:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586861592710823972" data-draft-id="7586902693857132586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app 项目在 iOS 上架过程中常见的问题与应对方式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T08:36:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app 项目在 iOS 上架过程中常见的问题与应对方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:36:39.000Z" title="Tue Dec 23 2025 08:36:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 uni-app 项目里，开发阶段通常推进得很顺。页面逻辑、接口对接、跨端兼容，一旦跑通，团队很容易形成一种判断：“剩下的就是打包和上架了。”</p>
<p>但真正进入 App Store 上架流程后，很多问题才开始出现，而且这些问题往往和 uni-app 本身关系不大。
它们更像是 <strong>跨端开发与原生发布体系之间的缝隙</strong>。</p>
<hr/>
<h2 data-id="heading-0"><strong>uni-app 解决的是开发效率，不是发布复杂度</strong></h2>
<p>这是我在多个项目中反复确认的一点。
uni-app 帮你减少了重复开发，但并没有替你简化 iOS 的发布规则。</p>
<p>在上架阶段，苹果仍然只关心几件事：</p>
<ul>
<li>应用的身份（Bundle ID）</li>
<li>使用的证书与描述文件</li>
<li>构建产物是否符合规范</li>
<li>上传过程是否完整、可验证</li>
</ul>
<p>这些要求不会因为你使用了 uni-app 而发生变化。</p>
<hr/>
<h2 data-id="heading-1"><strong>云打包生成的 IPA，并不是“天然可上架”的</strong></h2>
<p>不少 uni-app 项目会使用云打包服务，拿到 IPA 后就直接进入上传流程。
但在实际项目中，我见过很多“打包成功但无法上架”的情况。</p>
<p>原因包括：</p>
<ul>
<li>Bundle ID 与账号中已有应用不一致</li>
<li>描述文件类型不符合发布要求</li>
<li>构建产物中仍然带有测试配置</li>
</ul>
<p>这些问题在云打包阶段不一定会被提示，但在上传或审核阶段一定会暴露。</p>
<hr/>
<h2 data-id="heading-2"><strong>上架前，先确认“这个应用在账号里长什么样”</strong></h2>
<p>在 uni-app 项目中，Bundle ID 往往是在开发初期随配置填写的，很少被反复检查。
但在上架前，我通常会先确认 Apple 开发者账号中已经存在的应用标识。</p>
<p>这样做的目的很简单：</p>
<ul>
<li>避免误用历史项目的 Bundle ID</li>
<li>防止测试包与正式包混用</li>
<li>确认当前应用是否需要新建标识</li>
</ul>
<p>在非 macOS 环境下，可以通过 <strong>开心上架（Appuploader）查看账号内的 Bundle ID 列表</strong>，快速了解当前账号状态。这一步并不会改变 uni-app 的打包方式，但能减少后续的反复修改。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d6facd56604f178422fadbfef78a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=x8wPWVlUKhSuP6xBf7CTGLMQhe4%3D" alt="查看bid" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3"><strong>证书问题，在 uni-app 项目里并不会自动消失</strong></h2>
<p>很多开发者在 uni-app 项目中对证书的感知会变弱，因为大部分操作被工具包裹起来了。
但证书依然是 iOS 上架的硬前提。</p>
<p>在一些项目中，我遇到过：</p>
<ul>
<li>云打包正常，但 TestFlight 无法使用</li>
<li>构建换了环境后签名失效</li>
<li>无法确认当前使用的是哪一份证书</li>
</ul>
<p>后来在部分团队里，我们选择把证书管理从“隐式状态”中拆出来。
通过 <strong>开心上架（Appuploader）创建 iOS 证书</strong>，生成可复用的证书文件，用于构建和发布流程。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d233719b58a74457a4a27630cb81897c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=j0xhO6cdIuUsby0bsF4nJcagDBw%3D" alt="创建证书" loading="lazy"/></p>
<p>这种方式的意义不在于“不用 Xcode”，而在于让证书成为 <strong>可被管理的工程资源</strong>。</p>
<hr/>
<h2 data-id="heading-4"><strong>描述文件，是 uni-app 上架中最容易被忽略的一环</strong></h2>
<p>在 uni-app 项目中，描述文件往往是自动生成或自动下载的，很少有人会主动检查它的内容。
但在排查问题时，它经常是关键线索。</p>
<p>我遇到过构建成功、安装正常，却始终无法提交审核的情况。
最终发现是 IPA 中携带的是开发描述文件，而不是 App Store 类型。</p>
<p>在发布前，我更倾向于直接确认描述文件的内部信息。
通过 <strong>开心上架（Appuploader）查看 mobileprovision 文件内容</strong>，可以明确：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d9146df409f409da11c6a1443e7b76b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=2b2MM5JF12tmIdAzv9x70dRIuf8%3D" alt="查看文件" loading="lazy"/></p>
<ul>
<li>描述文件类型</li>
<li>绑定的 Bundle ID</li>
<li>使用的证书是否正确</li>
</ul>
<p>这一步对于 uni-app 项目尤其重要，因为很多错误并不会在打包阶段提示。</p>
<hr/>
<h2 data-id="heading-5"><strong>上传方式，往往决定 uni-app 项目的协作成本</strong></h2>
<p>在单人项目中，用 Xcode 或平台推荐方式上传 IPA 并不困难。
但在多人或跨平台团队中，上传很容易成为瓶颈。</p>
<p>当构建发生在云端，而上传只能依赖某一台 Mac 时，发布节奏就会被人为限制。</p>
<p>在一些项目中，我们使用 <strong>开心上架（Appuploader）的上传方式</strong>，在 Windows 或 Linux 环境中完成 IPA 提交，使 uni-app 的打包结果可以被不同系统的成员接手处理。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13176fb6acfd46b1829aff0341d8f041~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=LurVIXCOD%2FtxisOQOQ7VgHgtriE%3D" alt="ipa上传" loading="lazy"/></p>
<p>这并不会改变苹果的审核流程，但让发布步骤更符合团队协作的现实。</p>
<hr/>
<h2 data-id="heading-6"><strong>uni-app 上架，本质仍然是一次原生发布</strong></h2>
<p>经历过多次完整流程后，我逐渐形成一个共识：
uni-app 并没有绕过 iOS 上架，它只是改变了开发入口。</p>
<p>真正决定上架是否顺利的，仍然是这些原生对象是否清晰：</p>
<ul>
<li>应用标识</li>
<li>证书与描述文件</li>
<li>构建产物</li>
<li>上传路径</li>
</ul>
<p>Xcode、云打包、CI 和开心上架（Appuploader）各自解决不同问题，让这些关键对象在非 macOS 环境中也能被查看、验证和使用。
参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ECS 端口不通，丢包诊断看这里！阿里云 SysOM 智能诊断实战！]]></title>    <link>https://juejin.cn/post/7586879894207479871</link>    <guid>https://juejin.cn/post/7586879894207479871</guid>    <pubDate>2025-12-23T08:37:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207479871" data-draft-id="7586675587148709924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ECS 端口不通，丢包诊断看这里！阿里云 SysOM 智能诊断实战！"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-23T08:37:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ECS 端口不通，丢包诊断看这里！阿里云 SysOM 智能诊断实战！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:37:43.000Z" title="Tue Dec 23 2025 08:37:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：万瑞萍</p>
<h2 data-id="heading-0">背景</h2>
<p>随着云计算的深入应用，企业核心业务加速上云，高质量的网络通信已成为保障业务连续性的关键。作为网络传输的核心指标，数据包丢失直接影响系统稳定性：轻度丢包可能导致通信中断、数据异常，扰乱业务逻辑；严重丢包则可能引发健康检查失败、Ping 不通、服务拒绝等系统性故障，带来连锁运维问题。</p>
<p>某客户在新区域部署分布式集群时，突遇网络丢包，导致节点通信中断，业务部署停滞，资源持续闲置。面对这一紧急情况，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">阿里云云监控 2.0</a> 通过 SysOM 智能诊断功能，在数小时内精准定位故障根源，帮助客户快速恢复业务部署与系统稳定运行，有效避免资源浪费。<br/>
本文将通过这一典型案例，深入解析 SysOM 在丢包故障排查中的实战应用，展示其如何助力企业高效恢复业务连续性。</p>
<h2 data-id="heading-1">通过丢包诊断精准定位问题根源</h2>
<h3 data-id="heading-2">场景一：快速定界问题</h3>
<p>在阿里云 ACK（阿里云 Kubernetes 服务）新区域集群部署过程中，某客户遭遇系统性健康检查异常，导致业务部署流程全面受阻。在排除 iptables 规则配置异常的可能性后，运维团队将故障定位重点转向内核层丢包问题。</p>
<p>该类问题的排查涉及复杂的内核级分析流程，要求运维人员具备扎实的内核源码分析能力。需追踪数据包在内核协议栈中的处理路径，并结合 netfilter 框架各 hook 点的流量特征进行深度监控。这种技术方案不仅对排查人员的内核调试能力提出严苛要求，同时需要投入大量时间资源进行问题复现与验证。</p>
<p>本次故障处置中，我们借助操作系统控制台的能力，成功定位问题根源。典型云原生架构下，承载 ACK Pod 的 ECS 实例集群前端配置了 SLB 负载均衡器，形成标准的云原生部署拓扑（如架构图所示）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b00eea29dc9445589a978a60ae52a26d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=6a1r9%2F0Mm4ev6Ecnw4V7evUyvQg%3D" alt="图片" loading="lazy"/></p>
<p>我们通过 tcpdump 对 ECS 的 eth0 网卡上进行抓包。抓包结果如下，抓包结果显示，源地址为SLB健康检查网段，此时 SLB 持续向本机发送 SYN 包以建立连接。但本机未返回 ACK 包，导致健康检查失败。那么本机为何未能返回 ACK 包？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378d069b10b1499b95e667be838f16a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=IJAt6Kn%2FYvG2QKj9K2XWsg3kRBk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">检查 iptable 规则</h3>
<p>按照常规排查思路，我们首先考虑是否存在 iptables 规则导致请求被过滤的可能性。但通过对正常主机与异常主机的 iptables 配置进行比对核查后发现，两者策略保持完全一致，由此可以判定该因素并非造成当前网络异常的原因。</p>
<h3 data-id="heading-4">排查内核丢包</h3>
<p>排查内核丢包问题时，过去往往需要精通网络内核模块的资深工程师进行深度分析，而如今只需通过阿里云操作系统控制台轻松操作，即可快速实现过去需专业人员才能完成的复杂诊断任务。</p>
<p>使用操作系统控制台对问题实例进行诊断：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/051466780ced44c489d666acd7144fad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=Utq0Vc4Iz4BegLtwNfDjpiHad8c%3D" alt="图片" loading="lazy"/></p>
<p>如图上所示，在云监控控制台选择 ECS 洞察，选择系统诊断（SysOM）、节点诊断、网络诊断、丢包诊断，在第 5 步中选择所需要诊断的实例 ID，最后点击执行诊断。诊断完成以后，点击查看报告，可以看到机器中的丢包情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53b960fcae2e4ae4a7c464dc855e4589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=LHGvubAgkurZ1z%2FlD3hcpchC1V4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f042449095254d759ef2e0ca01d76210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=y58QtfQVGBwslxW5aSvSTZVcsfA%3D" alt="图片" loading="lazy"/></p>
<p>如上图所示，诊断结果显示未发现已知丢包异常记录。由此可判断，内核层丢包可能性已基本排除。</p>
<h3 data-id="heading-5">排查驱动或其他模块</h3>
<p>结合操作系统控制台的诊断信息，目前已基本确认内核并未发生丢包，成功排除了底层协议栈存在异常的可能性。进一步分析显示，eth0 接口已成功接收到 SYN 包，说明网络链路未出现数据丢失；同时，iptables 规则检查无异常，也排除了因配置规则导致问题的可能。在完成上述排查后，我们意识到仍有一个潜在维度尚未覆盖——网络驱动或中间件模块可能存在异常。基于这一假设，我们决定将系统中的钩子（hook）日志打印出来进行分析。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e3e32ae90644878bd19e725141fba54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=pRv%2FBIfR5XGDZm%2BLnTp%2BahbUSXo%3D" alt="图片" loading="lazy"/></p>
<p>从上图可以看出，与正常机器相比，该系统中多出了大量 sched_cls 类型的钩子。经与 ACK 研发团队确认，这些钩子来自某个网络组件。由此我们高度怀疑正是该组件所注入的钩子导致 SYN 包被意外过滤，遂将其卸载。卸载后，健康检查立即恢复正常。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/264285c46f374f3bb75a1132ccc737b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=0MlfYBLhMbgFIO5UqRlZkWe094I%3D" alt="图片" loading="lazy"/></p>
<p>通过操作系统控制台的协助，我们迅速完成了问题的初步定位，排除了内核丢包的可能性，从而能够更快地将排查重点转向其他方向，为后续问题的解决节省了大量时间。</p>
<h3 data-id="heading-6">场景二：精准定位问题</h3>
<p>某客户在新建实例后，发现 1678 端口无法通过 telnet 连通，严重影响其业务运行。该端口是其业务进程对外通信的关键入口，一旦不通，将导致服务无法正常与外部系统交互。</p>
<p>本案例与前述问题较为相似，同样表现为网络不通。在处理此类问题时，我们的标准排查流程是：首先对目标端口或网卡进行抓包，观察数据包的实际流向和交互情况。客户在其机器上执行了 telnet 测试，发现 22 端口可以正常连通，但 1678 端口及其他多个端口均无法访问。进一步检查确认，相关端口均有业务进程正常监听，服务本身运行无异常。按照常规思路，我们首先怀疑是否为 iptables 规则拦截所致。在客户配合下，我们详细检查了该主机的 iptables 配置，确认未设置任何特殊或限制性规则，基本排除了防火墙策略导致的问题。结合上一个案例的经验，我们进一步考虑是否存在网络驱动或内核模块中的钩子（hook）干扰了数据包处理。于是，我们重点排查了系统中是否安装了安全类组件或注入了异常函数钩子。经查，该机器未部署额外的安全软件，也未发现可疑的内核钩子或网络拦截模块。因此，钩子机制导致 SYN 包被过滤的可能性也被排除。问题原因需从其他维度继续深入分析。</p>
<p>既然钩子和 iptables 都没有问题，那是否可能是内核层面出现了丢包？带着这个疑问，我们可以通过操作系统控制台对异常实例进行进一步诊断：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14465ef66a2446a3a7253d639ce400f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=fr37apDDI3o3pr%2FBtidpCBQ%2FJUg%3D" alt="图片" loading="lazy"/></p>
<p>很快，诊断完成后，我们查阅了生成的诊断报告。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5b7219048464049a1870feacc279e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=3HljN99Hh5nkZGl4jtLCuje5gM0%3D" alt="图片" loading="lazy"/></p>
<p>诊断报告中明确提示：需删除 iptables 丢包规则或相关 netfilter 驱动。结论十分清晰——丢包是由 netfilter 机制引起的。既然问题根源指向 netfilter，那么首要排查对象便是其规则配置。考虑到现代 Linux 系统可能同时使用 iptables 和 nftables（后者作为 netfilter 的新一代前端），我们首先检查 nftables 的规则设置：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccf33698f5b8415ba2aec5abcac9ec80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=tuSbURgguNmO92zkT1lQVopoRPY%3D" alt="图片" loading="lazy"/></p>
<p>通过查看 nftables 规则配置，发现其中确实存在一条针对 1678 端口的 drop 规则。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d8babbcc2f4c9daf2766954f3e81df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=RU4IKw8DV5CV6zCCqR09tDXZgII%3D" alt="图片" loading="lazy"/></p>
<p>删除对应的规则并更新配置后，在本机监听 1678 端口，发现连接已恢复正常，问题得以解决。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc276c79bac34fbfa9dd4c1f31249539~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=3hFEIztrZgZuxDQ7ihYSEkWSp5A%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">总结</h2>
<p>在日常系统运维中，丢包问题可能导致业务通信中断、服务异常甚至无法部署。但这类问题并非不可攻克——阿里云操作系统控制台提供了简单、易用且专业的诊断工具。当怀疑系统存在丢包时，可结合控制台按以下步骤进行排查：</p>
<ol>
<li>首先直接使用操作系统控制台的丢包诊断功能，查看报告是否明确指出了问题根源。</li>
<li>若诊断结果显示内核未发生丢包，则检查系统是否安装了额外的安全软件，或与正常环境对比是否存在异常的钩子（hook）。</li>
<li>在确认无非预期驱动或钩子后，进一步核查 iptables 规则配置是否正确。</li>
<li>若仍无法定位丢包点，可借助 funcgraph、BPF 等工具，在可疑的网络路径上打点抓包，精准定位丢包位置。</li>
</ol>
<p>通常，结合操作系统控制台并遵循上述四个步骤，大多数丢包问题都能被有效识别和解决，让复杂的网络故障变得轻松可控。</p>
<p><strong>相关链接：</strong></p>
<p>[1] 《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247579716%26idx%3D1%26sn%3D156337a4bcba7b7ddddda9df4aadca29%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247579716&amp;idx=1&amp;sn=156337a4bcba7b7ddddda9df4aadca29&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一次内存诊断，让资源利用率提升 40%：揭秘隐式内存治理</a>》</p>
<p>[2] 云监控 - ECS 洞察 - SysOM 系统诊断</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcmsnext.console.aliyun.com%2Fnext%2Fregion%2Fcn-shanghai%2Fworkspace%2Fdefault-cms-1808078950770264-cn-shanghai%2Fapp%2Fhost%2Fhost-sysom" target="_blank" title="https://cmsnext.console.aliyun.com/next/region/cn-shanghai/workspace/default-cms-1808078950770264-cn-shanghai/app/host/host-sysom" ref="nofollow noopener noreferrer">cmsnext.console.aliyun.com/next/region…</a></p>
<p>[3] 操作系统控制台实例纳管</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fsystem-management%3Fspm%3Da2c4g.11186623.help-menu-2632541.d_2_0_4.14ef243dMTjYF1%26scm%3D20140722.H_2851198._.OR_help-T_cn~zh-V_1%237895eb3dedfty" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/system-management?spm=a2c4g.11186623.help-menu-2632541.d_2_0_4.14ef243dMTjYF1&amp;scm=20140722.H_2851198._.OR_help-T_cn~zh-V_1#7895eb3dedfty" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p>
<p>[4] 操作系统控制台 Java 内存诊断</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fjava-memory-diagnostics%3Fspm%3Da2c4g.11186623.help-menu-2632541.d_2_0_1_0_0_2.2fd8243d1slu08%26scm%3D20140722.H_2979954._.OR_help-T_cn~zh-V_1" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/java-memory-diagnostics?spm=a2c4g.11186623.help-menu-2632541.d_2_0_1_0_0_2.2fd8243d1slu08&amp;scm=20140722.H_2979954._.OR_help-T_cn~zh-V_1" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p>
<p>[5] 操作系统控制台热点追踪</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fprocess-hotspot-tracking" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/process-hotspot-tracking" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p>
<p>[6] 操作系统控制台热点对比分析</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fhot-spot-comparative-analysis" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/hot-spot-comparative-analysis" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度一站式全业务智能结算中台]]></title>    <link>https://juejin.cn/post/7586657335881990171</link>    <guid>https://juejin.cn/post/7586657335881990171</guid>    <pubDate>2025-12-23T08:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586657335881990171" data-draft-id="7586614240531955738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度一站式全业务智能结算中台"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T08:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度Geek说"/> <meta itemprop="url" content="https://juejin.cn/user/4186596000416094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度一站式全业务智能结算中台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186596000416094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度Geek说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:41:51.000Z" title="Tue Dec 23 2025 08:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>本文深入介绍了百度一站式全业务智能结算中台，其作为公司财务体系核心，支撑多业务线精准分润与资金流转。中台采用通用化、标准化设计，支持广告、补贴、订单等多种结算模式，实现周结与月结灵活管理。通过业务流程标准化、分润模型通用化及账单测算自动化，大幅提升结算效率与准确性，确保数据合规与业务稳健发展。未来，中台将推进全业务线结算立项线上化、数据智能分析，进一步提升数据分析智能化水平，为公司业务发展提供坚实保障。</p>
<h2 data-id="heading-1">01 概述</h2>
<p>结算中台作为公司财务体系的核心组成部分，承担着多业务线分润计算、结算及资金流转的关键职能。采用通用化、标准化的设计理念，结算中台能够高效支撑公司内数十个业务线的分润需求，确保广告收入、订单收入、内容分发的精准结算，为公司的财务健康与业务稳健发展提供坚实保障。结算中台建设的核心目标是: 构建高效、标准化、智能化的结算中台体系，支撑多业务线分润计算与资金流转，确保结算数据准确性、高时效披露及业务快速迭代能力，同时降低运维复杂度，推动全业务线结算线上化管理。</p>
<p>结算中台已对接了百家号业务、搜索业务、智能体业务、小说等多个业务线的结算需求， 支持广告分润、补贴分润、订单分润三种结算模式。不同业务线根据各自的业务场景使用不同的结算模式，确保每个业务的收益分配准确无误。结算中台功能分层如图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e04d3add22ad4c5db523651ee9cd5eb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=OZbjd8leYYfcEKr%2BJott9fiOIfY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">02 基本功能</h2>
<h3 data-id="heading-3"><strong>1. 结算模式</strong></h3>
<p>结算中台支持三种结算模式，以适应不同业务场景的结算需求：</p>
<ul>
<li>
<p><strong><strong>订单结算</strong></strong>：基于直接订单数据，按照订单实际金额与分成策略进行分润计算。</p>
</li>
<li>
<p><strong><strong>补贴结算</strong></strong>：针对特定业务或用户群体，提供额外的收益补贴，以增强业务的市场竞争力。</p>
</li>
<li>
<p><strong><strong>广告结算</strong></strong>：根据分发内容的广告变现与渠道分成比例，精确计算媒体与内容的实际收益。</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>2. 结算能力</strong></h3>
<p>结算中台支持周结与月结两种结算能力：</p>
<ul>
<li>
<p><strong><strong>周结</strong></strong>：适用于需要快速资金回笼的业务场景,比如短剧快速回款以后能够再次用于投流, 确保资金流转的高效性。</p>
</li>
<li>
<p><strong><strong>月结</strong></strong>：作为默认的结算周期，便于公司进行统一的财务管理与账务处理。</p>
</li>
</ul>
<h3 data-id="heading-5"><strong>3. 账单测算自动化</strong></h3>
<p>结算中台支持重点业务账单自动测算，通过预设的分润模型，自动计算每个渠道、每位作者的应得收益，生成测算报告。这一自动化过程显著提升工作效率，减少人为错误，确保结算数据的绝对准确。</p>
<h2 data-id="heading-6">03 需求分析</h2>
<p>在推进公司结算业务时，我们致力于实现统一化、标准化，规范业务流程，并确保数据合规化治理，我们面临着诸多问题与挑战，具体表现如下：</p>
<p><strong>1. 流程与规范缺失</strong></p>
<ul>
<li>
<p>结算流程管理混乱：存在结算需求未备案即已上线的情况，或者备案内容与实际实现不一致，甚至缺乏备案流程。</p>
</li>
<li>
<p><strong>日志规范陈旧</strong>：广告分润场景中，内容日志打点冗余，同时缺少扩展性，导致对新的业务场景无法很好兼容。</p>
</li>
</ul>
<p><strong>2. 烟囱式开发成本高</strong></p>
<ul>
<li>
<p><strong>标准化与统一化需求迫切</strong>：之前，各个结算业务维护各自的结算系统，涉及不同的技术栈和结算模型，线下、线上结算方式并存，导致人工处理环节多，易出错，case多，管理难度大。为提高效率，需实现结算业务的标准化与统一化，并拓展支持多种业务结算模式。</p>
</li>
<li>
<p><strong>分润模型通用化设计</strong>：多数业务结算方式相同，同时账单计算逻辑也相似或者相同，没有必要每个业务设计一套逻辑，需要做通用化设计。</p>
</li>
</ul>
<p><strong>3. 业务迭代中的新诉求</strong></p>
<ul>
<li>
<p><strong>测算系统需求凸显</strong>：在业务快速迭代的过程中，许多业务希望尽快看到结算效果，以推进项目落地。因此，构建高效的测算系统成为迫切需求，以加速业务迭代和决策过程。</p>
</li>
<li>
<p><strong>提升作者体验</strong>：为提升作者等合作伙伴的满意度和忠诚度，结算数据需实现高时效披露，确保他们能及时、准确地获取收益信息。结算账单数据的产出依赖百余条数据源，要保证数据在每天12点前产出,困难重重</p>
</li>
<li>
<p><strong>数据校验与监控机制</strong>：结算数据的准确性和质量直接关系到公司的财务健康和业务发展。因此，需建立完善的数据校验和监控机制，确保结算数据的准确无误和高质量。</p>
</li>
</ul>
<h2 data-id="heading-7">04 技术实现</h2>
<p>根据结算中台建设的核心目标，结合业务痛点，在结算系统建设中，基于通用化、标准化的理念，从以下五个方面来搭建统一的、规范化的结算中台。</p>
<ul>
<li>
<p>业务流程标准化：建设一套标准来定义三类结算模式下每个数据处理环节的实现方式，包括业务处理流程、数据处理过程。</p>
</li>
<li>
<p>分润模型通用化：实现不同的账单计算算法，支持各个业务的各类作者收入分配诉求，并且实现参数配置线上化。</p>
</li>
<li>
<p>技术架构统一：统一整个结算业务的技术栈、部署环境、功能入口和数据出口。</p>
</li>
<li>
<p>建设账单测算能力：模拟线上结算流程的账单测算能力，支持业务快速验证分润模型参数调整带来的作者收入影响效果。</p>
</li>
<li>
<p>建设质量保证体系：建设全流程预警机制，通过日志质检、自动对账、数据异常检测来保障账单产出数据时效性、准确性。</p>
</li>
</ul>
<h3 data-id="heading-8"><strong>1. 业务流程标准化</strong></h3>
<p>不同业务场景，采用了通用化、标准化的设计来满足业务的特异性需求，下面是三大结算模式业务流程简图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0de2e7ada049ccb4cd17e4d97aacdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=jemUOoE7pQr19Yz8X%2F5zNB9YKnE%3D" alt="图片" loading="lazy"/></p>
<p>在广告模式、补贴模式、订单模式结算流程设计中, 从日志打点、线上化、计算逻辑等方向考虑了通用化、标准化设计, 具体如下:</p>
<p><strong>(1) 日志打点统一化</strong></p>
<p>统一日志标准, 针对业务日志规范陈旧问题，要求所有接入的业务方严格按照统一格式打点日志，删除冗余字段, 确保数据的规范性与一致性,同时保证设计能够覆盖所有业务场景，为后续处理奠定坚实基础。</p>
<p>针对某些业务定制化的需求, 在广告模式、补贴模式、订单模式三种结算方式中，在设计日志打点规范时, 会预留一些扩展字段, 使用时以 JSON 形式表示, 不使用时打默认值。</p>
<p><strong>(2) 账单计算线上化</strong></p>
<p>在补贴结算模式中，之前不同业务都有各自的账单格式设计，同时存在离线人工计算账单的非规范化场景，账单无法统一在线计算、存储、监管。新的结算中台的补贴结算模式，将所有离线结算模式，使用统一的账单格式，全部实现线上化结算，实现了业务结算流程规范化。</p>
<p><strong>(3) 账单计算逻辑优化</strong></p>
<p>比如在广告模式中，百家号业务的公域视频、图文、动态场景中，由于收入口径调整，迭代效率要求，不再需要进行广告拼接，所以专门对账单计算流程做了优化调整。不仅满足业务诉求，同时做了通用化设计考虑，保证后续其他业务也可以使用这套流程的同时， 也能兼容旧的业务流程。</p>
<p>广告模式结算流程优化前：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/868c1655e3ce4704ae82d5be9dd06a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=ZAWoUHMIo1XRWGw4HZznFnnq0OQ%3D" alt="图片" loading="lazy"/></p>
<p>广告模式结算流程优化后：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c23b8ef5b2a47cb9345bf7b2ed62d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=S0NI5VZZVc1yfKyq2GM3%2F2MphBM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>2. 分润模型通用化</strong></h3>
<p>不同业务场景，不同结算对象，有不同的结算诉求，不仅要满足业务形态多样化要求，还要具有灵活性。因此抽取业务共性做通用性设计，同时通过可插拔式设计灵活满足个性化需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc83daf04a734f028f0950a15ab96ae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=1ZHo1IP6sICzYAR%2BACTPWzZrTDo%3D" alt="图片" loading="lazy"/></p>
<p><strong>(1) 基于流量变化模型</strong></p>
<p>以合作站点的优质用户投流方为代表的用户，他们在为百度提供海量数据获得收益的同时，也有自己的诉求，那就是自己内容的收益不能受到其他用户内容的影响。自己优质内容不能被其他用户冲淡，当然自己的低质内容也不会去拉低别人的收益水平。</p>
<p>对于此部分用户我们提供“基于流量变现的分润”策略，简单来说就是，某一篇内容的收益仅仅由它自己内容页面挂载的广告消费折算而来，这样就保证了优质用户投流方收益的相对独立，也促使优质用户产出更加多的内容。</p>
<p><strong>(2) 基于内容分发模型</strong></p>
<ul>
<li>
<p>部分作者只关注收益回报: 对百家号的某些作者来说，他们的目的很单纯，他们只关注产出的内容是否获得具有竞争力的收益回报，至于收益怎么来他们并不关心。</p>
</li>
<li>
<p>“基于流量变现”策略不妥此时，我们再使用“基于流量变现”的策略的话，就有些不妥，举个极端里的例子，有一个作者比较倒霉，每次分发都没有广告的渲染，那他是不是颗粒无收？这对作者是很不友好的。</p>
</li>
<li>
<p>“基于内容分发的分润”模型: 基于收益平衡性考虑，我们推出了更加适合百家号用户的“基于内容分发的分润”模型。在这种模型下，只要内容有分发，就一定有收益，而不管本身是否有广告消费。</p>
</li>
<li>
<p>策略平衡考虑: 当然，为了防止海量产出低质内容来刷取利润，在分润模型上，我们同时将内容质量分和运营因子作为分润计算的权重，也就是说作者最终的收益由内容的质量和内容的分发量共同决定，以达到通过调整分润来指导内容产出的目的。</p>
</li>
</ul>
<p><strong>(3) 基于作者标签模型</strong></p>
<p>为了实现对百家号头部优质作者进行激励，促进内容生态良性发展, 会对不同的作者进行打标, 并且使用不同的分润模型, 比如对公域的百家号作者进行打标, 优质作者, 通过动态单价及内容质量权重策略来给到他们更加的分成, 其他的普通作者, 通过内容分发模型来分润。这样不仅保证了优质作者取得高收益，也保证了其他作者也有一定的收益</p>
<p>另外，出于对预算的精确控制，发挥每一笔预算的钱效，优质的作者会占用较大的预算资金池，而普通作者使用占用较少的预算资金池。同时也会对每类资金池进行上下限控制，保证预算不会花超。</p>
<p><strong>(4) 基于运营场景模型</strong></p>
<p>为了实现对百家号作者的精细化运营，比如对一些参与各类短期活动的作者给予一定的阶段性的奖励，可以通过补贴模型来实现。在一些运营活动中，需要控制部分作者的分成上限，分润模型会进行多轮分成计算，如果作者的收益未触顶并且资金池还有余额的情况下，会对余额进行二次分配，给作者再分配一些收益。此类模型主要是为了实现灵活多变的作者分润策略。</p>
<h3 data-id="heading-10"><strong>3. 技术架构统一</strong></h3>
<p>根据业务流程标准化、分润模型通用化的设计原则，建设统一的结算中台。以下是结算中台统一结算业务前后的对比：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca3fc700112c4d2bbe5eef5258710396~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=QTJ1DM1Pq%2BVn1gDsIU7JQ05pPFQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/161bd1c491d941e59b3562cb42e589fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=%2BTUUSxHu1GRLdZlT26vo76IY8fI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-11"><strong>4. 建设账单测算能力</strong></h3>
<p>为各个需要测算能力的业务，设计了一套通用的测算流程，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a87191457fa4385aa66565ea3369e1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=jnvFR%2F6nQfSEWdjvmKRUY%2FjXNNU%3D" alt="图片" loading="lazy"/></p>
<p>针对每个测算业务，设计了独立的测算参数管理后台，用于管理业务相关的分润模型参数，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02ecd74ee4994f808e55937be0721377~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=bTCgw5jfaEIE4wUINrI%2FSgMJ0Mc%3D" alt="图片" loading="lazy"/></p>
<p>测算流程设计</p>
<p>(1) 功能简述: 每个测算业务, 产品需要登录模型参数管理后台,此后台支持对分润模型参数进行创建、查看、编辑、测算、复制、上线、删除，以及查看测算结果等操作, 出于业务流程合规化的要求, 每次模型参数上线前, 需要对变更的参数完成线上备案流程才可以上线，实现分润流程合规线上化。</p>
<p><strong>(2) 流程简述</strong></p>
<ul>
<li>
<p>流程简述概览: 每次测算时， 产品需要先创建一个版本的账单模型测算参数，并发起参数测算，参数状态变成待测算 。</p>
</li>
<li>
<p>离线任务与收益计算: 此后，离线任务会轮询所有的待测算参数，提交Spark任务，调用账单计算模型来计算作者收益，最后生成TDA报告。</p>
</li>
<li>
<p>查看与评估测算报告: 产品在管理平台看到任务状态变成测算完成时, 可以点击 TDA 链接来查看测算报告, 评估是否符合预期。</p>
</li>
<li>
<p>根据预期结果的操作:如果不符合预期，可以编辑参数再次发起测算；如果符合预期，则可以发起备案流程，流程走完后可以提交上线。</p>
</li>
</ul>
<p>(3) 收益明显: 通过账单测算建设, 不仅解决结算需求未备案即已上线或者备案内容与实际实现不一致，甚至缺乏备案流程的业务痛点问题,  而且把业务线下账单计算的流程做到了线上, 做到留痕可追踪。同时也满足了业务高效迭代的诉求, 一次账单测算耗时从半天下降到分钟级, 大大降低了账单测算的人力成本与时间成本。</p>
<h3 data-id="heading-12"><strong>5. 建设质量保障体系</strong></h3>
<p>为了保证业务质量，从以下几方面来建设：</p>
<p>(1) 建设数据预警机制：为保证作者账单数据及时披露, 分润业务涉及的 百余条数据源都签订了 SLA, 每份数据都关联到具体的接口人, 通过如流机器人来监控每个环节的数据到位时间, 并及时发出报警信息, 并推送给具体的接口负责人。对于产出延迟频次高的数据流，会定期拉相关负责人相关复盘，不断优化数据产出时效，保证账单数据在每天如期产出</p>
<p>(2) 数据异常检测机制：对账单数据进行异常波动性检测, 确保数据准确性 ,及时发现并处理潜在异常问题</p>
<p>(3) 自动对账机制：每天自动进行上下游系统间账单明细核对,保证出账数据流转的准确无误。</p>
<p>(4) 日志质检机制：每日例行对日志进行全面质检分析, 及时发现日志打点日志。</p>
<h2 data-id="heading-13">05 中台收益</h2>
<p>结算中台作为公司财务体系的核心，承担多业务线分润计算与资金流转重任。</p>
<p>(1) 通过通用化、标准化设计，高效支撑数十个业务线的精准结算，确保广告、订单、内容分发的业务结算稳定、健康。近一年，结算业务零事故、零损失。</p>
<p>(2) 中台支持多种结算模式与灵活周期管理，实现账单测算自动化，账单测算时间从天级降到小时级。提升效率并减少错误，提升业务需求迭代效率。</p>
<p>(3) 通过业务流程标准化、分润模型通用化、账单测算能力建设及质量保证体系，解决了结算业务规范缺失、业务形态多样等问题。累计解决历史结算case数十个，涉及结算金额达千万级。</p>
<p>未来，结算中台将推进全业务线结算立项线上化、周结与测算能力落地、项目全生命周期管理，并依托大模型能力实现数据智能分析，进一步提升数据分析智能化水平，为公司业务稳健发展提供坚实保障。</p>
<h2 data-id="heading-14">06 未来规划</h2>
<p>1、推进全业务线结算实现立项线上化；</p>
<p>2、推进周结 、测算能力在各业务线上落地；</p>
<p>3、推进项目全生命周期管理，实现项目从上线到下线整体生命周期变化线上化存档，可随时回顾复盘。</p>
<p>4、数据智能分析，依托公司大模型能力，实现通过多轮对话问答来进行数据分析，针对业务问题进行答疑解惑，提升数据分析的智能化水平。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安全保护协议 SSL 和 TLS 的区别]]></title>    <link>https://juejin.cn/post/7586851351469064232</link>    <guid>https://juejin.cn/post/7586851351469064232</guid>    <pubDate>2025-12-23T08:45:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586851351469064232" data-draft-id="7441944462933114917" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安全保护协议 SSL 和 TLS 的区别"/> <meta itemprop="keywords" content="HTTP,后端"/> <meta itemprop="datePublished" content="2025-12-23T08:45:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一线大码"/> <meta itemprop="url" content="https://juejin.cn/user/3280598429340984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安全保护协议 SSL 和 TLS 的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598429340984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一线大码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:45:15.000Z" title="Tue Dec 23 2025 08:45:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SSL（安全套接层）和TLS（传输层安全性）都是用于保护网络通信的协议，但它们之间存在一些重要的区别：</p>
<h3 data-id="heading-0">1. <strong>版本</strong></h3>
<ul>
<li><strong>SSL</strong>：最初由网景公司开发，已有多个版本（如SSL 2.0和SSL 3.0），但由于安全漏洞，现已不再使用。</li>
<li><strong>TLS</strong>：是SSL的后继者，当前版本为TLS 1.3。TLS对SSL进行了改进，提供了更高的安全性和性能。</li>
</ul>
<h3 data-id="heading-1">2. <strong>安全性</strong></h3>
<ul>
<li><strong>SSL</strong>：已经被证明含有多种安全漏洞，因此不再推荐使用。</li>
<li><strong>TLS</strong>：采用了更新的加密算法和更加严格的安全措施，例如支持更强的密码套件和减少握手过程中的潜在风险。</li>
</ul>
<h3 data-id="heading-2">3. <strong>握手过程</strong></h3>
<ul>
<li><strong>SSL</strong>：握手过程相对简单，但由于设计缺陷，容易受到中间人攻击（MITM）等攻击。</li>
<li><strong>TLS</strong>：改进了握手过程，使其更加安全和灵活，允许客户端和服务器协商使用哪些加密算法。</li>
</ul>
<h3 data-id="heading-3">4. <strong>功能</strong></h3>
<ul>
<li><strong>SSL</strong>：功能较为基础，支持有限的身份验证和加密选项。</li>
<li><strong>TLS</strong>：引入了更多的功能，如会话恢复、零RTT（Round Trip Time）数据发送等，提高了性能和用户体验。</li>
</ul>
<h3 data-id="heading-4">5. <strong>兼容性</strong></h3>
<ul>
<li><strong>SSL</strong>：由于其已过时，不再受到支持，现代浏览器和应用程序通常不再支持SSL。</li>
<li><strong>TLS</strong>：目前广泛应用于各种网络协议（如HTTPS、SMTP、IMAP等），并得到广泛支持。</li>
</ul>
<h3 data-id="heading-5">总结</h3>
<p>虽然SSL和TLS都旨在提供安全的网络通信，但由于SSL的安全性不足，TLS已成为现代互联网通信的标准。建议所有应用程序和服务使用TLS而非SSL来确保安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[机器学习 线性回归]]></title>    <link>https://juejin.cn/post/7586614240532217882</link>    <guid>https://juejin.cn/post/7586614240532217882</guid>    <pubDate>2025-12-23T08:48:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586614240532217882" data-draft-id="7586540799220203561" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="机器学习 线性回归"/> <meta itemprop="keywords" content="后端,Python,机器学习"/> <meta itemprop="datePublished" content="2025-12-23T08:48:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            机器学习 线性回归
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:48:46.000Z" title="Tue Dec 23 2025 08:48:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">线性回归</h2>
<p>回归问题：目标是预测连续数值（体重），而不是分类标签</p>
<p>术语：</p>
<ul>
<li>自变量（特征）</li>
<li>因变量（目标）</li>
</ul>
<p>比如，已知身高，求体重，这里，体重是<strong>因变量</strong>，身高是<strong>自变量</strong>。</p>
<ul>
<li>K：斜率（weight 权重）</li>
<li>X：自变量</li>
<li>b：截距（bias 偏置）</li>
</ul>
<p>公式是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>k</mi><mi>X</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">Y = kX + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，这只是<strong>一元线程回归</strong></p>
<blockquote>
<p>我们需要算出来，斜率是多少，截距是多少</p>
</blockquote>
<p><strong>回归方程函数</strong></p>
<p>为什么还有这个公式呢，因为正常情况下不可能只有一个特征。</p>
<p>这 T 表示 k 的转置（把列向量变成行向量，用于点积）</p>
<p>公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msup><mi>k</mi><mi>x</mi></msup><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y = k^x + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<blockquote>
<p>公式的由来</p>
</blockquote>
<p>假设已知有多个特征，如下，所以一元线程回归</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3560342ab444c9bb5d65a8b397c6fe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=%2BdXfWoBXkKej92NwM4aHmS18DrA%3D" alt="image.png" loading="lazy"/></p>
<p>所以变成了如下：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msub><mi>k</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>k</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mo separator="true">⋅</mo><mo separator="true">⋅</mo><mo separator="true">⋅</mo><mo>+</mo><msub><mi>k</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y = k_{1}x_{1} + k_{2}x_{2} + ··· + k_{n}x_{n} + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">+</span><span class="mpunct">⋅⋅⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">+</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<p>如何把 b 截距引进来的，所以要在最开始加一个 w0，表示 截距b，x0 用 1 表示。这样再实现矩阵相乘就可以了。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold-italic">k</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mn>0</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"/></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mi>n</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><mi mathvariant="bold-italic">x</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>0</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"/></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mi>n</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{k} = \begin{bmatrix}
k_0 \\
k_1 \\
k_2 \\
\vdots \\
k_n
\end{bmatrix}, \quad
\boldsymbol{x} = \begin{bmatrix}
x_0 \\
x_1 \\
x_2 \\
\vdots \\
x_n
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.01852em;">k</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:6.66em;vertical-align:-3.08em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M403 1759 V84 H666 V0 H319 V1759 v3000 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.58em;"><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"/></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.08em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M347 1759 V0 H0 V84 H263 V1759 v3000 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:6.66em;vertical-align:-3.08em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M403 1759 V84 H666 V0 H319 V1759 v3000 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.58em;"><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"/></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.08em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M347 1759 V0 H0 V84 H263 V1759 v3000 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>线性回归案例：</p>
<ul>
<li>钢轨伸缩长度与温度</li>
<li>昆虫鸣叫次数与天气</li>
<li>国内GDP与双十一销售额</li>
</ul>
<h4 data-id="heading-1">线性回归API</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression

<span class="hljs-comment"># 案例基于身高，预测体重</span>

<span class="hljs-comment"># 1. 获取数据</span>
x_train = [[<span class="hljs-number">160</span>], [<span class="hljs-number">166</span>], [<span class="hljs-number">172</span>], [<span class="hljs-number">174</span>], [<span class="hljs-number">180</span>]]
y_train = [<span class="hljs-number">56.3</span>, <span class="hljs-number">60.6</span>, <span class="hljs-number">65.1</span>, <span class="hljs-number">68.5</span>, <span class="hljs-number">75</span>]

x_test = [[<span class="hljs-number">176</span>]]

<span class="hljs-comment"># 2. 数据预处理</span>
<span class="hljs-comment"># 3. 特征工程</span>

<span class="hljs-comment"># 4. 模型训练</span>
<span class="hljs-comment"># 创建回归模型</span>
estimator = LinearRegression()
estimator.fit(x_train, y_train)

<span class="hljs-comment"># 5. 模型预测</span>
y_predict = estimator.predict(x_test)
<span class="hljs-built_in">print</span>(y_predict) <span class="hljs-comment"># 70.3047619</span>

<span class="hljs-comment"># 6. 模型评估</span>
<span class="hljs-comment"># 斜率</span>
<span class="hljs-built_in">print</span>(estimator.coef_) <span class="hljs-comment"># 0.92942177</span>
<span class="hljs-comment"># 截距</span>
<span class="hljs-built_in">print</span>(estimator.intercept_) <span class="hljs-comment"># -93.27346938775517</span>
</code></pre>
<p>这里不画拟合回归线。</p>
<h3 data-id="heading-2">损失函数</h3>
<p>上面我们能得知，用API生成一条拟合回归线。</p>
<p>我们一眼能看出红色的直线。但是这个线是怎么求出来的呢？</p>
<p>是通过：<strong>误差 = 预测值 - 真实值，越小越好</strong></p>
<p>所以需要损失函数，<strong>衡量每个样本的预测值与真实值效果的函数</strong>，也叫代价函数、成本函数、目标函数</p>
<p>更好的拟合所有的点，也就是<strong>误差最小，误差和最小</strong></p>
<blockquote>
<p>损失函数计算方式</p>
</blockquote>
<p>我们来计算出来，斜率（权重）和截距（偏置）</p>
<ul>
<li>损失函数：用来描述每个样本值 和 预测值之间的关系的</li>
<li>误差 = 预测值 - 真实值</li>
</ul>
<p>已知：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abcb01225cbc426a9c8b801b062189c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=eHCFmKTvTkxerB9vb0VmxA9yIgI%3D" alt="image.png" loading="lazy"/></p>
<p>拿 点5 举例子</p>
<ol>
<li>kx + b</li>
<li>代入 = 180k + b</li>
<li>再减去真实值 = 180k + b - 75</li>
</ol>
<p>得出公式是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi>x</mi><mo>+</mo><mi>b</mi><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">kx + b - y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>，其中 y 是真实值。</p>
<p>注意下图：w 其实是 k，这里写错了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54a4a9e4d8d34c629ae01f44c638d952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=xRNfbkcXwdhAlWe8NV%2Ft1uDsBbE%3D" alt="image.png" loading="lazy"/></p>
<p>这样计算之后，可能有的结果是正的，有的结果是负的。</p>
<blockquote>
<p>所以又分为三种计算方式</p>
</blockquote>
<ol>
<li>最小二乘：每个样本的误差值的平方和</li>
<li>均方误差：最小二乘 / 样本数</li>
<li>平均绝对值误差：每个样本的误差的绝对值的平均值</li>
</ol>
<h4 data-id="heading-3">最小二乘解法如下</h4>
<p>根据上面的例子</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>L</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>56.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>60.6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>65.1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>68.5</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>75</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数L(k,b) = (160k + b - 56.3)^2 + (166k + b - 60.6)^2 + (172k + b - 65.1)^2 + (174k + b - 68.5)^2 + (180k + b - 75)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">56.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">60.6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">65.1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">68.5</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>为了简便运算，这里先固定 b = -100</p>
<p>于是公式变成了如下：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>L</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>b</mi><mo>=</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>56.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>60.6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>65.1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>68.5</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>75</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数L(k,b = -100) = (160k + (-100) - 56.3)^2 + (166k + (-100) - 60.6)^2 + (172k + (-100) - 65.1)^2 + (174k + (-100) - 68.5)^2 + (180k + (-100) - 75)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">56.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">60.6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">65.1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">68.5</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>我们先计算这一小块</strong></p>
<p>已知：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>56.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(160k + (-100) - 56.3)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">56.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>合并常数项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>−</mo><mn>156.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(160k - 156.3)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>此时我们发现</strong>这就是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>−</mo><msup><mi>b</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(a - b^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mn>2</mn></msup><mo>−</mo><mn>2</mn><mi>a</mi><mi>b</mi><mo>+</mo><msup><mi>b</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">a^2 - 2ab + b^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>这是完全平方公式哈。</p>
<blockquote>
<p>继续计算</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>−</mo><mn>156.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><mo>−</mo><mn>160.6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><mo>−</mo><mn>165.1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><mo>−</mo><mn>168.5</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><mo>−</mo><mn>175</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">= (160k - 156.3)^2 + (166k -160.6)^2 + (172k -165.1)^2 + (174k -168.5)^2 + (180k -175)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">160.6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">165.1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">168.5</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">175</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>160</mn><mi>k</mi><mo>∗</mo><mn>156.3</mn><mo>+</mo><mn>156.</mn><msup><mn>3</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>166</mn><mi>k</mi><mo>∗</mo><mn>160.6</mn><mo>+</mo><mn>160.</mn><msup><mn>6</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>172</mn><mi>k</mi><mo>∗</mo><mn>165.1</mn><mo>+</mo><mn>165.</mn><msup><mn>1</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>174</mn><mi>k</mi><mo>∗</mo><mn>168.5</mn><mo>+</mo><mn>168.</mn><msup><mn>5</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>180</mn><mi>k</mi><mo>∗</mo><mn>175</mn><mo>+</mo><mn>17</mn><msup><mn>5</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">= ((160k)^2 - 2 * 160k * 156.3 + 156.3^2) + ((166k)^2 - 2 * 166k * 160.6 + 160.6^2) + ((172k)^2 - 2 * 172k * 165.1 + 165.1^2) + ((174k)^2 - 2 * 174k * 168.5 + 168.5^2) + ((180k)^2 - 2 * 180k * 175 + 175^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.</span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">160.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">160.</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">165.1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">165.</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">168.5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">168.</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">175</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">17</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<blockquote>
<p>下面我用第一个演示一下，每一个都要计算，有点多</p>
</blockquote>
<p>分别计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>160</mn><mi>k</mi><mo>∗</mo><mn>156.3</mn><mo>+</mo><mn>156.</mn><msup><mn>3</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">((160k)^2 - 2 * 160k * 156.3 + 156.3^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.</span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的平方项、一次项、常数项</p>
<ul>
<li>平方项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>160</mn><mo>∗</mo><mn>160</mn><mo>∗</mo><msup><mi>k</mi><mn>2</mn></msup><mo>=</mo><mn>25600</mn><msup><mi>k</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">160 * 160 * k^2 = 25600k^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord">25600</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>一次项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>2</mn><mo>∗</mo><mn>160</mn><mo>∗</mo><mn>156.3</mn><mo>∗</mo><mi>k</mi><mo>=</mo><mo>−</mo><mn>50016</mn><mi>k</mi></mrow><annotation encoding="application/x-tex">-2 * 160 * 156.3 * k = -50016k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">50016</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span></li>
<li>常数项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>156.3</mn><mo>∗</mo><mn>156.3</mn><mo>=</mo><mn>24</mn><mo separator="true">,</mo><mn>429.69</mn></mrow><annotation encoding="application/x-tex">156.3 * 156.3 = 24,429.69</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">24</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">429.69</span></span></span></span></span></li>
</ul>
<p>所以等于
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mn>25600</mn><mi>k</mi><mo>−</mo><mn>50016</mn><mi>k</mi><mo>+</mo><mn>24429.69</mn></mrow><annotation encoding="application/x-tex">= 25600k - 50016k + 24429.69</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">25600</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">50016</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">24429.69</span></span></span></span></span></p>
<p>但是这里是不能直接这样的，要把所有的项目合起来，平方项、一次项、常数项相加，最后计算。</p>
<p>一共五个数据点计算后</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>25600</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>50016</mn><mi>k</mi><mo>+</mo><mn>24429.69</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>27556</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>53319.2</mn><mi>k</mi><mo>+</mo><mn>25792.36</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>29584</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>56794.4</mn><mi>k</mi><mo>+</mo><mn>27258.01</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>30276</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>58638</mn><mi>k</mi><mo>+</mo><mn>28392.25</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>32400</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>63000</mn><mi>k</mi><mo>+</mo><mn>302625</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
&amp;= 25600k^2 - 50016k + 24429.69 \\
&amp;= 27556k^2 - 53319.2k + 25792.36 \\
&amp;= 29584k^2 - 56794.4k + 27258.01 \\
&amp;= 30276k^2 - 58638k + 28392.25 \\
&amp;= 32400k^2 - 63000k + 302625 \\
\end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.6205em;vertical-align:-3.5603em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0603em;"><span style="top:-6.0603em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:-4.5362em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:-3.0121em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:-1.4879em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:0.0362em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5603em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0603em;"><span style="top:-6.1962em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">25600</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">50016</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">24429.69</span></span></span><span style="top:-4.6721em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">27556</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">53319.2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">25792.36</span></span></span><span style="top:-3.1479em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">29584</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">56794.4</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">27258.01</span></span></span><span style="top:-1.6238em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">30276</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">58638</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">28392.25</span></span></span><span style="top:-0.0997em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">32400</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">63000</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">302625</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5603em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>平方项、一次项、常数项的总结果 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>145</mn><mo separator="true">,</mo><mn>416</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>281</mn><mo separator="true">,</mo><mn>767.6</mn><mi>k</mi><mo>+</mo><mn>408</mn><mo separator="true">,</mo><mn>497.31</mn></mrow><annotation encoding="application/x-tex">145,416k^2 - 281,767.6k + 408,497.31</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord">145</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">416</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">281</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">767.6</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">408</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">497.31</span></span></span></span></span></p>
<blockquote>
<p>计算 K 值</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mo>−</mo><mo stretchy="false">(</mo><mo>−</mo><mn>281</mn><mo separator="true">,</mo><mn>767.6</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><mo>∗</mo><mn>145</mn><mo separator="true">,</mo><mn>416</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0.968832865709413</mn></mrow><annotation encoding="application/x-tex">k = -(-281,767.6) / (2*145,416) = 0.968832865709413</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mopen">(</span><span class="mord">−</span><span class="mord">281</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">767.6</span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">145</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">416</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.968832865709413</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>或者直接：</mtext><mn>281767.6</mn><mi mathvariant="normal">/</mi><mn>2</mn><mi mathvariant="normal">/</mi><mn>145416</mn></mrow><annotation encoding="application/x-tex">或者直接：281767.6 / 2 / 145416</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">或者直接：</span><span class="mord">281767.6/2/145416</span></span></span></span></span></p>
<blockquote>
<p>总结</p>
</blockquote>
<p>缺点：当样本点比较多的时候，值会非常大。</p>
<h4 data-id="heading-4">总结</h4>
<blockquote>
<p>最小二乘</p>
</blockquote>
<p>每个样本的误差值的平方和</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>J</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数J(w,b) = \sum_{i=0}^m(h(x^{(i)}) - y^{(i)})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<blockquote>
<p>均方误差 (Mean-Square Error, MSE)</p>
</blockquote>
<p>每个样本的误差值的平方和的平均值</p>
<p>方块圈住的就是最小二乘</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa8c54c84526439da0389d6077faf727~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=V4QKwpy1fVMkr4zdTiHtOZ9Tfr0%3D" alt="image.png" loading="lazy"/></p>
<p>i 表示具体的第几个样本</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>J</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数J(w,b) = \frac{1}{m}\sum_{i=0}^m(h(x^{(i)}) - y^{(i)})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.233em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<blockquote>
<p>平均绝对值误差 (Mean Absolute Error , MAE)</p>
</blockquote>
<p>每个样本的误差值的绝对值的和的平均值</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>J</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><msubsup><mo>∑</mo><mn>0</mn><mi>m</mi></msubsup><mrow><mo fence="true">∣</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo fence="true">∣</mo></mrow></mrow><annotation encoding="application/x-tex">损失函数J(w,b) = \frac{1}{m}\sum_{0}^m \left| h(x^{(i)}) - y^{(i)} \right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.238em;vertical-align:-0.35em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"/><span style="width:0.333em;height:1.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.333em" height="1.200em" viewbox="0 0 333 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15&#10;c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15&#10;c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span/></span></span></span></span></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"/><span style="width:0.333em;height:1.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.333em" height="1.200em" viewbox="0 0 333 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15&#10;c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15&#10;c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<h3 data-id="heading-5">线性回归问题求解需要什么？</h3>
<p>损失函数越小，越好</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2945c1b1ec394d2daf001a432cc6c3b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=4P39E%2FQwJrfOD5CH66Xj%2BXUWKr0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>损失函数可用来描述输出（预测值）和观测结果（真实值）效果，可衡量模型效果好坏</li>
<li>不同的任务比如分类、回归、聚类问题，一般会采用各自的损失函数</li>
<li>线性回归求解一般需要数据、假设函数、损失函数、损失函数优化方法等部分，相互配合共同完成</li>
</ul>
<h2 data-id="heading-6">复习</h2>
<h3 data-id="heading-7">复习导数</h3>
<p>当函数 𝑦=𝑓(𝑥) 的自变量 𝑥 在一点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>𝑥</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">𝑥_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 上产生一个增量 Δ𝑥 时，函数输出值的增量 Δ𝑦 与自变量增量 Δ𝑥 的比值在 Δ𝑥 趋于0 时的极限 𝐴 如果存在，𝐴 即为在 𝑥 处的导数，记作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><msub><mi>x</mi><mi>o</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f'(x_o)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22040754070f45e0a1f7466d68875a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=YysFsWneAQXrZ%2BJ7%2BVaU%2F4u1MS8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>导数的几何意义</p>
</blockquote>
<p>函数 y=f(x) 在点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">x_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 处的导数的几何意义，就是曲线 y=f(x) 在点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_0,f(x_0))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span></span></span></span></span> 处的切线的斜率，即曲线 y=f(x) 在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_0, f(x_0)) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span></span></span></span></span>处的切线的斜率是f'(x_0)。</p>
<blockquote>
<p>常见函数的导数</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/771b16b94d4246fb8e6d96b66d2df0eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=5n%2Fb9tsW4VAcjk%2Bn5zTNnwaGACE%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>导数的四则运算</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03f14bcd776e43e4a393acfc6a37e6c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=bcHl9h2K67bXt34kYz%2Bg4SuppzA%3D" alt="image.png" loading="lazy"/></p>
<p>直接套公式</p>
<p>第二个我说一下，公式是， (a * b)' = a' * b + a * b'</p>
<p>第四个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup><msup><mo stretchy="false">)</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">(e^{2x})'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>= 带入公式，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mi>x</mi></msup></mrow><annotation encoding="application/x-tex">e^x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6644em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span> 的导还是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mi>x</mi></msup></mrow><annotation encoding="application/x-tex">e^x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6644em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span>，所以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">e^{2x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span> = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">e^{2x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>= 求2x的导，还是 2 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">2e^{2x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p><strong>题</strong></p>
<p>举个例子:计算该函数y = 〖"(" 𝑥^2 "+2x)" 〗^2 的导函数</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5cce1b8f7024ea68b4f64946e89bcc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=2XMYQqILlD2pcUT5VuCl4Z8XgRE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b55969ffb5e64c4caf3b061fd62d5350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=Krjj0dbPLl%2BuTNB%2BO9tur%2BwNEmo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d66475db42894e8baa48ab27428f1696~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=9lJzLyg5SnhrxQWOm8ZYJrZu0Sk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">偏导</h3>
<blockquote>
<p>导数求极值</p>
</blockquote>
<p>导数为0的位置是函数的极值点</p>
<ul>
<li>求函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msup><mi>𝑥</mi><mn>2</mn></msup><mo>−</mo><mn>4</mn><mi>x</mi><mo>+</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">y = 𝑥^2 - 4x + 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span> 的极小值</li>
</ul>
<p>求导法：对x求导，令导数</p>
<ul>
<li>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mtext>：</mtext><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>2</mn><mi>x</mi><mo>−</mo><mn>4</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">0：y' = 2x - 4 = 0 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord">0</span><span class="mord cjk_fallback">：</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></li>
<li>x = 2</li>
<li>将 x = 2 带入，4 - 8 + 5 = 1</li>
<li>所以y极小值 = 1</li>
</ul>
<blockquote>
<p>多变量导数求解</p>
</blockquote>
<p>Z是关于 x 和 y 的函数记成<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">z(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span>，求解 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mo stretchy="false">(</mo><mi>𝑥</mi><mo>−</mo><mn>2</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>𝑦</mi><mo>−</mo><mn>3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">z = (𝑥−2)^2 + (𝑦−3)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 的极小值</p>
<p>这题要同时求 x 和 y 的两个未知数，所以思路是，先把 x 和 y 同时解出来，方式就是 乘法法则</p>
<p>首先先计算x，此时 y - 3² = 0</p>
<ul>
<li>(x - 2)²</li>
<li>(x - 2)' * (x - 2)'</li>
<li>(x - 2)' * (x - 2) + (x - 2) * (x - 2)'</li>
<li>1 * (x - 2) + (x - 2) * 1</li>
<li>(x - 2) + (x - 2)</li>
<li>x - x = 2x，-2-2 = -4</li>
<li>2x - 4</li>
<li>2(x - 2) = 0</li>
<li>两边除以 2 = x - 2 = 0</li>
<li>x = 2</li>
</ul>
<p>计算 y，此时 x - 2² = 0</p>
<ul>
<li>(y - 3)²</li>
<li>(y - 3)'(y - 3) + (y - 3)(y - 3)'</li>
<li>(y - 3) + (y - 3)</li>
<li>2y - 6</li>
<li>2(y - 3)</li>
<li>y - 3 = 0</li>
<li>y = 3</li>
</ul>
<blockquote>
<p>上面的有些复杂</p>
</blockquote>
<p>例子：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mn>2</mn><mi>x</mi><mi>y</mi><mo>−</mo><mn>3</mn><msup><mi>y</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">Z = x^2 + 2xy - 3y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord">3</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>x = 2x + 2y（3y²是常数）</li>
<li>y = 2x - 6y（x2是常数）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02865db3cd11467aa51caeffe8bf32d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=39PB6RCuyHyr%2BC%2Fs8%2FQZnrhHm4w%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4276649c41484c4da717392cf3eaf259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=vHlg%2BaR51kGsoXkB1HpombvUPfc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">向量和矩阵</h3>
<h4 data-id="heading-10">向量运算</h4>
<blockquote>
<p>向量是有大小和方向</p>
</blockquote>
<p>几何意义上表示：向量(1,1), 向量（1,2）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d026f8fd8ed479cbb98909ce3f4189c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=Xu8C43aG33mBxUvKxvFS0kX7ht8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>向量基运算</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da722c622a8f4c9583ec2d3b79f187ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=rkeoC%2FGqzodEJd%2F%2BTLcP%2BztkZD8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>向量矩阵转置 Transpose</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3019e0bfa4c44458b5008157072156bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=RA76%2B7mbrC09zyNcVTq811Uu7Dw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">范数Norm</h4>
<p>范数(norm)是数学中的一种基本概念，具有长度的意义</p>
<ul>
<li>1范数(L1范数)-向量中各个元素绝对值之和</li>
<li>2范数(L2范数)-向量的模长，每个元素平方求和，再开平方根</li>
<li>p-范数：向量中每一个元素p幂求和，在开p次根</li>
</ul>
<blockquote>
<p>L1范数</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo><mtext>‖</mtext><mi>x</mi><msub><mtext>‖</mtext><mn>1</mn></msub><mo>=</mo><mi mathvariant="normal">∣</mi><mn>1</mn><mi mathvariant="normal">∣</mi><mo>+</mo><mi mathvariant="normal">∣</mi><mn>2</mn><mi mathvariant="normal">∣</mi><mo>+</mo><mi mathvariant="normal">∣</mi><mo>−</mo><mn>3</mn><mi mathvariant="normal">∣</mi><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">𝑥^𝑇 = (1,  2,  −3)   ‖x‖_1 = |1| + |2| + |−3| = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">3</span><span class="mclose">)</span><span class="mord">‖</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord">‖</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣1∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣2∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">6</span></span></span></span></span></p>
<blockquote>
<p>L2范数</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mi mathvariant="normal">∣</mi><msub><mi mathvariant="normal">∣</mi><mn>2</mn></msub><mo>=</mo><mn>2</mn><msqrt><mrow><msup><mn>1</mn><mn>12</mn></msup><mo>+</mo><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt><mo>=</mo><mtext>√</mtext><mn>14</mn></mrow><annotation encoding="application/x-tex">𝑥^𝑇=(1, 2, −3) ||x||_2 = 2\sqrt{1^{12} + 2^2 + (-3)^2} = √14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">3</span><span class="mclose">)</span><span class="mord">∣∣</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"/><span class="mord">2</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.2em;"/><span class="mord">√14</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">𝑥^𝑇=(1,2,−3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">3</span><span class="mclose">)</span></span></span></span></span></p>
<p>注意：向量的转置@向量</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mi>x</mi><mo>=</mo><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">𝑥^𝑇x=1^2+2^2+(−3)^2 = 14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">14</span></span></span></span></span></p>
<p>X为向量：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mi>x</mi><mtext>与</mtext><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mi mathvariant="normal">∣</mi><msubsup><mi mathvariant="normal">∣</mi><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">𝑥^𝑇x 与||x||_2^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mord cjk_fallback">与</span><span class="mord">∣∣</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span/></span></span></span></span></span></span></span></span></span> 是一样的</p>
<p>Lp范数：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>x</mi><msub><mi mathvariant="normal">∥</mi><mi>p</mi></msub><mo>=</mo><msup><mrow><mo fence="true">(</mo><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mn>1</mn></msub><msup><mi mathvariant="normal">∣</mi><mi>p</mi></msup><mo>+</mo><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mn>2</mn></msub><msup><mi mathvariant="normal">∣</mi><mi>p</mi></msup><mo>+</mo><mo>⋯</mo><mo>+</mo><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mi>n</mi></msub><msup><mi mathvariant="normal">∣</mi><mi>p</mi></msup><mo fence="true">)</mo></mrow><mfrac><mn>1</mn><mi>p</mi></mfrac></msup></mrow><annotation encoding="application/x-tex">\|x\|_p = \left( |x_1|^p + |x_2|^p + \cdots + |x_n|^p \right)^{\frac{1}{p}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord">∥</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3439em;vertical-align:-0.25em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0939em;"><span style="top:-3.5029em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"/><span class="frac-line mtight" style="border-bottom-width:0.049em;"/></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4829em;"><span/></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"/></span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<h4 data-id="heading-12">矩阵 Matrix 1</h4>
<p>矩阵是数学中的一种基本概念，表达m行n列的数据等</p>
<p>矩阵在机器学习中的表达</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/023f73c776164a298ccecd0df8170cb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=Qzd6nfCcNvLM%2Bw5x4%2BAgZDi%2BO8U%3D" alt="image.png" loading="lazy"/></p>
<p><strong>矩阵加法</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a538e07ac745098dd77e8a9e0c8352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=mGZChg15D78TiEqvtyKXO90XORI%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>总结：用 A 的每一行，都要乘以 B 的每一列。</p>
</blockquote>
<p><strong>矩阵乘法 ：对应行列元素相乘，然后再加和再一起</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52037fa9978943a59e377d685ce38849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=oclqwBU2wnz4DDNR756yQr1Yr64%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f7a939097cb43e1a4f1bae5a3985a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=UgeBQi2E8vuplMHKeKY5qYvqBNo%3D" alt="image.png" loading="lazy"/></p>
<p>术语：</p>
<ul>
<li>方阵：行列数一样</li>
<li>对称方阵：一种特殊的方阵，沿着主对角线，其元素对称 aij = aji</li>
</ul>
<p>可以发现，1，2 的元素是2，2，1 的元素也是 2</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e7bbce217f465188a40aa07694da02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=wme3bXslPjsauXxGKAglODHKhWM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>单位阵：一种特殊的方阵，用符号E或者是I来表示</li>
</ul>
<p>特点：对角线为 1 其他为 0</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51b82a1adbe64b45b1dcbf84dcac19fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=4r68ED2TDon7pKpsvEVM0XBvnFk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">矩阵乘法的性质</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fabd48af1af04b049d754835e21aaace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=vmC4d9WqT7PMiN39O5ytrFLVLzQ%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>矩阵的逆</p>
</blockquote>
<p>例子：通过 A 和 I 求出 B</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9c2f997c6614ec29b6092992fa67199~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=yXYLWUdJAYmT8rutMX0Bk3URpJk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82cf706c89904212bf82d50ce83da61f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=9H7MKHl%2BZJ3XRZXyTvdTP75N4LM%3D" alt="image.png" loading="lazy"/></p>
<p>已知结果是</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/066f556b73a94ae695828469139ed6ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=iHlaRVK1GMkI88jUJD1SQtX0jeM%3D" alt="image.png" loading="lazy"/></p>
<p>等价于如下图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e22863e0824c1198e66f3fd563563e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=HbhMtWYQFnjUZ%2B6svKt3i0STctw%3D" alt="image.png" loading="lazy"/></p>
<p>此时我们可以求解出 ac，bd 等于多少。</p>
<blockquote>
<p>求 C 结果如下：</p>
</blockquote>
<p>a + 2c = 1</p>
<p>3a + 4c = 0</p>
<p>首先根据 a + 2c = 1，可以改成 a = 1 - 2c</p>
<p>将a = 1 - 2c 代入 3a + 4c = 0</p>
<ul>
<li>= 3(1 - 2c) + 4c = 0</li>
<li>= 3 - 6c + 4c = 0</li>
<li>合并同类项</li>
<li>-6c + 4c = -2c</li>
<li>3 - 2c = 0</li>
</ul>
<p>解C：</p>
<ul>
<li>3 - 2c = 0</li>
<li>得知：3 - 2(3/2) = 0</li>
<li>3 - 3 = 0</li>
<li>c = 1.5</li>
</ul>
<blockquote>
<p>求 a 结果如下</p>
</blockquote>
<ul>
<li>a = 1 - 2c</li>
<li>a = 1 - 2 * 1.5</li>
<li>a = -2</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764e2ca786c7461eaf7fd788946e43e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=cWS85G36WlzcYmFafJQXxAk4o0U%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">总结</h4>
<p>矩阵转置的性质</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec867e27d6bc4d2c88871c9ffc905926~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=l8HN1Vckv1xcrBfBLUiEDF1xYRk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">损失函数最小值求法</h2>
<h3 data-id="heading-16">正规方程法</h3>
<p>前面我们要知道，通过最小二乘，可以计算出如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e1b19ec80d746ceb1230cdef0cdb16e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=j9HsPQau3NUZgPn7Z5tmVWcjrgk%3D" alt="image.png" loading="lazy"/></p>
<p>现在我们将来计算 B 的值</p>
<p>例子：</p>
<p>一元线性回归损失函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">J(k,b) = \sum_{i=1}^{m}(h(x^{(i)}) - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>上面的式子还等于 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sum_{i=1}^{m}(kx^{(i)} + b - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>
的极小值</p>
<p>损失函数是关于k、b的函数，对k、b分别求导设置成 0，得到2个方程</p>
<p>这是一个复杂的公式，省略常数实数</p>
<p><strong>对 k 求导</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(kx^{(i)} + b - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})(kx^{(i)} + b - y^{(i)})'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})x^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msup><mo>+</mo><mn>2</mn><mi>b</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mn>2</mn><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">2kx^{(i)^{2}} + 2bx^{(i)} - 2x^{(i)}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0702em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></p>
<p><strong>对 b 求导</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(kx^{(i)} + b - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})(kx^{(i)} + b - y^{(i)})'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo separator="true">⋅</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)}) · 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mn>2</mn><mi>b</mi><mo>−</mo><mn>2</mn><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">2kx^{(i)} + 2b - 2y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<blockquote>
<p>完整答案</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e9f04a48cca4a8cb113bd5a51aec4c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=m%2F56gsRindrup49oFv6cNEkeiN4%3D" alt="image.png" loading="lazy"/></p>
<p>解析来继续变形，对上面的<strong>一式</strong>和<strong>二式</strong></p>
<p>上面的答案完整的都有一个求和，因为样本数量是多个。</p>
<p><strong>K 的求导结果变形</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msup><mo>+</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><mi>b</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sum_{i=1}^{m}2kx^{(i)^2}  + \sum_{i=1}^{m}2bx^{(i)} - \sum_{i=1}^{m}2x^{(i)}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2866em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= 同时除以2<br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msup><mo>+</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mi>b</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k\sum_{i=1}^{m}x^{(i)^2} + \sum_{i=1}^{m}bx^{(i)} - \sum_{i=1}^{m}x^{(i)}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2866em;vertical-align:-0.2997em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<p><strong>B 的求导结果变形</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mn>2</mn><mi>b</mi><mo>−</mo><mn>2</mn><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sum_{i = 1}^{m}2(kx^{(i)} + 2b - 2y^{(i)}) = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><msubsup><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><mi>m</mi></msubsup><mi>b</mi><mo>−</mo><msubsup><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><mi>m</mi></msubsup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k\sum_{i = 0}^{m}x^{(i)} + \sum_{(i = 0)}^{m}b - \sum_{(i = 0)}^{m}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.279em;vertical-align:-0.4747em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4747em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.3627em;vertical-align:-0.4747em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4747em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mi>m</mi><mo>−</mo><msubsup><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><mi>m</mi></msubsup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k\sum_{i = 0}^{m}x^{(i)} + bm - \sum_{(i = 0)}^{m}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">bm</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.3627em;vertical-align:-0.4747em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4747em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<p><strong>数据带入</strong></p>
<p>已知 x 是身高，y 是体重</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfbb7abcf6af4541bd9c6a80c430aff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=%2FFiUaGy0J%2B26CcfGAxYutX284DY%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>对 K 求</p>
</blockquote>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>16</mn><msup><mn>0</mn><mn>2</mn></msup><mo>+</mo><mn>16</mn><msup><mn>6</mn><mn>2</mn></msup><mo>+</mo><mn>17</mn><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>17</mn><msup><mn>4</mn><mn>2</mn></msup><mo>+</mo><mn>18</mn><msup><mn>0</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>160</mn><mo>+</mo><mn>166</mn><mo>+</mo><mn>172</mn><mo>+</mo><mn>174</mn><mo>+</mo><mn>180</mn><mo stretchy="false">)</mo><mtext>–</mtext><mo stretchy="false">(</mo><mn>160</mn><mo>∗</mo><mn>56.3</mn><mo>+</mo><mn>166</mn><mo>∗</mo><mn>60.6</mn><mo>+</mo><mn>172</mn><mo>∗</mo><mn>65.1</mn><mo>+</mo><mn>174</mn><mo>∗</mo><mn>68.5</mn><mo>+</mo><mn>180</mn><mo>∗</mo><mn>75</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k*(160^2+166^2+172^2+174^2+180^2)+b*(160+166+172+174+180)–(160*56.3+166*60.6+172*65.1+174*68.5+180*75)=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">16</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">16</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">17</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">17</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">18</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">166</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">172</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">174</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">180</span><span class="mclose">)</span><span class="mord">–</span><span class="mopen">(</span><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">56.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">166</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">60.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">172</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">65.1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">174</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">68.5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">180</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>145416</mn><mo>∗</mo><mi>k</mi><mo>+</mo><mn>852</mn><mo>∗</mo><mi>b</mi><mo>−</mo><mn>55683.8</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">145416*k + 852*b - 55683.8 = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">145416</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">852</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">55683.8</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<blockquote>
<p>对 b 求</p>
</blockquote>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>160</mn><mo>+</mo><mn>166</mn><mo>+</mo><mn>172</mn><mo>+</mo><mn>174</mn><mo>+</mo><mn>180</mn><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi><mo>∗</mo><mn>5</mn><mo>−</mo><mo stretchy="false">(</mo><mn>56.3</mn><mo>+</mo><mn>60.6</mn><mo>+</mo><mn>65.1</mn><mo>+</mo><mn>68.5</mn><mo>+</mo><mn>75</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k*(160+166+172+174+180)+b*5-(56.3+60.6+65.1+68.5+75)=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">166</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">172</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">174</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">180</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">56.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">60.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">65.1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">68.5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>852</mn><mo>∗</mo><mi>k</mi><mo>+</mo><mn>5</mn><mo>∗</mo><mi>b</mi><mo>−</mo><mn>325.5</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">852*k + 5*b - 325.5 = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">852</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">325.5</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></p>
<blockquote>
<p>根据k、b进行预测：</p>
</blockquote>
<ul>
<li>
<p>k = 0.0397</p>
</li>
<li>
<p>b = 60.7615</p>
</li>
<li>
<p>y = 0.0397*176+60.7615 = 67</p>
</li>
</ul>
<h4 data-id="heading-17">多元线程回归（了解）</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d3888b960034d908d7abd3e80976726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=wM9WlG63fjYTPa6h2O94lTStLus%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fbc9d8fcc754242b276e79442307c3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=n8pIKdqJs%2FTFhhDcohCBBBhbo4A%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/021faf141b7d428eb7476858add440db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=UtSM34CFsKnOBvJVCl28qYC8RNY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01f73d29a02447deba7877c41d914913~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=yO4NrCpWsgk2QIxNoSEHlRt%2F%2Bfo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bac4801587d049ba8425a476ab03ee46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=NFct78Pi%2Br6n6HVcm92WaUf0lWs%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET8 Middleware 核心原理与实战指南]]></title>    <link>https://juejin.cn/post/7586167377383391258</link>    <guid>https://juejin.cn/post/7586167377383391258</guid>    <pubDate>2025-12-22T08:31:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377383391258" data-draft-id="7586263211088494618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET8 Middleware 核心原理与实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T08:31:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幌才_loong"/> <meta itemprop="url" content="https://juejin.cn/user/4256947657515320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET8 Middleware 核心原理与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4256947657515320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幌才_loong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T08:31:31.000Z" title="Mon Dec 22 2025 08:31:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、中间件是什么</h2>
<p>.NET Core 中间件是构成 HTTP 请求处理管道的核心组件，用于接收、处理 HTTP 请求并生成响应。每个中间件都具备特定职责，可自主决定是否将请求传递给下一个中间件，也能在请求处理前后执行自定义逻辑，遵循 “请求入栈、响应出栈” 的洋葱模型。其核心价值在于实现关注点分离，让日志记录、身份验证、跨域处理等功能独立封装，支持灵活组合与插拔，大幅提升系统扩展性与可维护性。</p>
<h2 data-id="heading-1">二、中间件的核心使用方式</h2>
<h3 data-id="heading-2">1. 基础注册与执行逻辑</h3>
<p>中间件通过 <code>IApplicationBuilder</code> 接口链式注册，<code>app.UseXXX</code> 方法的调用顺序即为请求处理顺序（响应时反向执行）。核心调用逻辑通过 <code>next()</code> 方法控制：调用 <code>next()</code> 则将请求传递给下一个中间件，不调用则触发短路机制，直接返回响应。</p>
<h3 data-id="heading-3">2. 核心使用方法详解</h3>
<h4 data-id="heading-4">（1）app.Run：管道终点</h4>
<ul>
<li>特性：无 <code>next</code> 参数，强制短路，始终作为管道最后一个中间件。</li>
<li>使用场景：默认 404 响应、健康检查端点、简单固定响应返回。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.Run(<span class="hljs-keyword">async</span> context =&gt;
{
    context.Response.StatusCode = StatusCodes.Status404NotFound;
    <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">"资源未找到"</span>);
});
</code></pre>
<h4 data-id="heading-5">（2）app.Use：通用中间件</h4>
<ul>
<li>特性：接收 <code>next</code> 参数，可灵活控制是否短路，支持请求前预处理与响应后处理。</li>
<li>使用场景：日志记录、性能监控、请求头修改、异常捕获等通用场景。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.Use(<span class="hljs-keyword">async</span> (context, next) =&gt;
{
    <span class="hljs-comment">// 请求处理前：记录请求信息</span>
    <span class="hljs-keyword">var</span> requestTime = DateTime.UtcNow;
    <span class="hljs-comment">// 传递给下一个中间件</span>
    <span class="hljs-keyword">await</span> next();
    <span class="hljs-comment">// 响应处理后：记录耗时</span>
    <span class="hljs-keyword">var</span> elapsed = DateTime.UtcNow - requestTime;
    Console.WriteLine(<span class="hljs-string">$"请求 <span class="hljs-subst">{context.Request.Path}</span> 耗时：<span class="hljs-subst">{elapsed.TotalMilliseconds}</span>ms"</span>);
});
</code></pre>
<h4 data-id="heading-6">（3）app.UseWhen：条件执行中间件</h4>
<ul>
<li>特性：基于自定义条件触发分支中间件，执行后返回主管道继续处理。</li>
<li>使用场景：特定路径（如 <code>/api</code>）、特定请求头、特定客户端的差异化处理。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.UseWhen(context =&gt; context.Request.Path.StartsWithSegments(<span class="hljs-string">"/api"</span>), apiApp =&gt;
{
    <span class="hljs-comment">// 仅/api路径请求执行：添加API版本头</span>
    apiApp.Use(<span class="hljs-keyword">async</span> (context, next) =&gt;
    {
        context.Response.Headers.Add(<span class="hljs-string">"X-API-Version"</span>, <span class="hljs-string">"2.0"</span>);
        <span class="hljs-keyword">await</span> next();
    });
});
</code></pre>
<h4 data-id="heading-7">（4）app.Map：路径分支中间件</h4>
<ul>
<li>特性：基于路径创建独立管道，分支内处理完毕后不返回主管道。</li>
<li>使用场景：管理员专区、静态文件服务、微服务风格 API 分组。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.Map(<span class="hljs-string">"/admin"</span>, adminApp =&gt;
{
    <span class="hljs-comment">// 独立管道：启用认证授权</span>
    adminApp.UseAuthentication();
    adminApp.UseAuthorization();
    adminApp.Run(<span class="hljs-keyword">async</span> context =&gt;
    {
        <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">"管理员专区"</span>);
    });
});
</code></pre>
<h4 data-id="heading-8">（5）app.UseMiddleware：类中间件</h4>
<ul>
<li>特性：封装为独立类，支持依赖注入，适用于复杂逻辑与复用场景。</li>
<li>实现方式：可继承 <code>IMiddleware</code> 接口，或基于约定实现 <code>InvokeAsync</code> 方法。</li>
<li>使用场景：团队共享组件、复杂业务逻辑处理（如数据加密、权限校验）。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 自定义类中间件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EncryptionMiddleware</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> RequestDelegate _next;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EncryptionMiddleware</span>(<span class="hljs-params">RequestDelegate next</span>)</span> =&gt; _next = next;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params">HttpContext context</span>)</span>
    {
        <span class="hljs-comment">// 加密相关处理</span>
        <span class="hljs-keyword">await</span> _next(context);
    }
}
<span class="hljs-comment">// 注册使用</span>
app.UseMiddleware&lt;EncryptionMiddleware&gt;();
</code></pre>
<h2 data-id="heading-9">三、常用内置中间件实战场景</h2>
<h3 data-id="heading-10">1. 安全类中间件</h3>
<ul>
<li><strong>UseAuthentication</strong>：身份验证，验证用户身份（如 JWT、Cookie 认证），需搭配 <code>AddAuthentication</code> 服务配置。</li>
<li><strong>UseAuthorization</strong>：授权校验，基于角色、策略判断用户是否有权访问资源。</li>
<li><strong>UseCors</strong>：跨域处理，配置允许的来源、方法、请求头，解决前端跨域问题。</li>
</ul>
<h3 data-id="heading-11">2. 性能优化类中间件</h3>
<ul>
<li><strong>UseResponseCompression</strong>：响应压缩，压缩 HTTP 响应体（如 Gzip、Brotli），减少传输体积。</li>
<li><strong>UseOutputCache</strong>：输出缓存（.NET 7+），缓存响应结果，提升重复请求处理速度。</li>
</ul>
<h3 data-id="heading-12">3. 诊断与监控类中间件</h3>
<ul>
<li><strong>UseExceptionHandler</strong>：异常处理，捕获管道中未处理的异常，返回友好错误信息。</li>
<li><strong>MapHealthChecks</strong>：健康检查，提供应用状态端点（如 <code>/health</code>），适配监控系统。</li>
</ul>
<h3 data-id="heading-13">4. 基础功能类中间件</h3>
<ul>
<li><strong>UseHttpsRedirection</strong>：HTTPS 重定向，将 HTTP 请求强制转为 HTTPS，提升传输安全性。</li>
<li><strong>UseStaticFiles</strong>：静态文件服务，提供 CSS、JS、图片等静态资源访问支持。</li>
</ul>
<h2 data-id="heading-14">四、使用注意事项</h2>
<ol>
<li>注册顺序敏感：核心中间件需按 “异常处理→HTTPS 重定向→静态文件→路由→认证授权→终结点” 的顺序注册，避免功能失效。</li>
<li>谨慎使用短路：短路中间件（如认证失败）需明确业务场景，避免正常请求被意外拦截。</li>
<li>类中间件复用：复杂逻辑优先封装为类中间件，通过依赖注入解耦，提升代码可维护性。</li>
<li>环境差异化配置：开发环境可启用 Swagger、详细异常页，生产环境启用 HTTPS、响应压缩等优化。</li>
</ol>
<p>中间件作为.NET Core 的核心设计，通过灵活组合与插拔，让开发者能快速构建高可用、易扩展的 Web 应用。合理选择与配置中间件，既能满足业务需求，又能保障系统性能与安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[八年开源，GSY 用五种技术开发了同一个 Github 客户端，这次轮到 AI + Compose]]></title>    <link>https://juejin.cn/post/7585645111876632603</link>    <guid>https://juejin.cn/post/7585645111876632603</guid>    <pubDate>2025-12-21T23:11:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585645111876632603" data-draft-id="7585645111876616219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="八年开源，GSY 用五种技术开发了同一个 Github 客户端，这次轮到 AI + Compose"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-21T23:11:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            八年开源，GSY 用五种技术开发了同一个 Github 客户端，这次轮到 AI + Compose
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T23:11:10.000Z" title="Sun Dec 21 2025 23:11:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之所以 2025 了 GSYGithubApp 还能迎来 Jetpack Compose 版本的开源，主要还是依赖于 AI 的强大：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77fbbc01e86d41568b8f02745c2ede70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=HYod%2BkDbevJtqti22GAfsF89nMM%3D" alt="" loading="lazy"/></p>
<p>GSY 系列项目做早是从 2016 年开始做的开源，其中大家最为熟悉的应该是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYVideoPlayer" target="_blank" title="https://github.com/CarGuo/GSYVideoPlayer" ref="nofollow noopener noreferrer">GSYVideoPlayer</a> ，它也是维护至今最长的项目，而 GSYGithubApp 系列最早是在 2017 年 11 月开源，至今正好是八年，而近日这个项目也正式开源了 GSYGithubApp 的 Jetpack Compose 版本：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd2568bafbbc4b249059fa52989ed415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=Axg0fzCmKSJ6I%2B5O4h5HGdorRfQ%3D" alt="" loading="lazy"/></p>
<p>GSYGithubApp 诞生之初 Github 的官方客户端还没有出来，而当时因为做开源也有些时间，所以在日常中没有一个应用其实挺不方便，正好那时候刚学 React Native 没多久，<strong>所以 2017 年第一个 GSYGithubApp 就作为练手项目诞生了</strong>，之后陆续随着接触的技术栈变化，开源的版本也越来越多，它们开源的顺序依次是：</p>
<ul>
<li>React Native <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubApp" target="_blank" title="https://github.com/CarGuo/GSYGithubApp" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Weex <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppWeex" target="_blank" title="https://github.com/CarGuo/GSYGithubAppWeex" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Android Kotlin View <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppKotlin" target="_blank" title="https://github.com/CarGuo/GSYGithubAppKotlin" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Flutter <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppFlutter" target="_blank" title="https://github.com/CarGuo/GSYGithubAppFlutter" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Android Jetpack Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75b5a15bdc24cdeb7ca8bdce93243b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=M41mBMSCRoVyuSfXSxTKZ7NXgew%3D" alt="" loading="lazy"/></p>
<p>而其实随着 Github 官方的 App 发布后，GSYGithubApp 存在的意义就变了：<strong>它更多是成为一个完整的技术学习项目，并提供同款技术对比的一个目的</strong>。</p>
<p>另外过去的时候，闲鱼就曾用过 GSYGithubApp 的 React Native 版本和 Flutter 版本做过一些性能对比测试：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b39aade61b46b09b834774c7b9a219~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=we154kIzAhBEOK6vDGVDM5K5JVg%3D" alt="image-20251112111329006" loading="lazy"/></p>
<blockquote>
<p>而之所以选择做 Github 客户端也是因为这个，这能让它成为一个完整的 App 开源项目，Github API 相对稳定并且丰富，流程从登录，用户，仓库，Issue ，输入输出，数据库等都能覆盖，能让开源项目涉及的内容更全面。</p>
</blockquote>
<p>当然，个人经历有限，随着时间推移，其实 GSYGithubApp 在过去挺长的时间里，除了 Flutter 版本外，其他版本都是处于“放（qi）生（keng）”状态，直到 2025 AI 的能力大幅提升之后，它们才又迎来了更新：</p>
<ul>
<li>React Native 版本目前更新到 0.82 ，说实话就算是有 AI ，从 0.61 升级到 0.82 也是一个挺让人“绝望”的体验，详细可见：<a href="https://juejin.cn/post/7534367912388427815" target="_blank" title="https://juejin.cn/post/7534367912388427815">用 AI 把一个五年前的 RN 项目，从 0.61.3 升级到 0.74.0 是一种什么样的体验</a></li>
<li>Android Kotlin View 版本，在 AI 的帮助下，终于成功升级到可以在最新 Android Studio 和 Gradle 环境运行</li>
<li>Weex 版本，嗯，还是处于“放（qi）生（keng）”状态，懂得都懂</li>
</ul>
<p>所以在感受到 AI 强大的辅助能力后，<strong>我就觉得也许可以再来个 Jetpack Compose 版本的 GSYGithubApp 项目，而实际上零零散散开发直到开源，大概也就是两周的时间，其中 80% 以上都是 AI 完成</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad66fb5b1ab949258e3cb16a767abc40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=zNQzi%2Bby%2Fap2Tmg8xszVwAwuepQ%3D" alt="" loading="lazy"/></p>
<p>当然，这个速度主要也是因为需求明确，原型已经有了，给 AI 参考的资料就多了，基本上也算是熟悉的领域，大部分只需给 AI 投喂好资料，初始结构直接让 AI 参考官方的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fandroidify" target="_blank" title="https://github.com/android/androidify" ref="nofollow noopener noreferrer">android/androidify</a> 项目，制定好路线和方向，整体还是相当省心的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b78db26fc02409f82e3efa628092c0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=Jqm0nlqvTfo6%2Bjxrlp5H2Yfw1O4%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ca37519fe274638ad3ee18c13ab9376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=6FvbYxA6hyvIRAbb00%2BxtLaKyHQ%3D" alt="" loading="lazy"/></p>
<p>当然，这里面就不得不提开发过程中给 AI 指定 rules 的必要性，因为 AI 实际上很多时候并不会全局考虑你的项目结构，每次需求对他有限的 Context 来说，大多数时候都只会局限性的考虑问题，这时候在开发过程中根据 AI 的调性配置相应的规则还是很重要的，例如通用的模板和生成规则就很有必要：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb29035ed20145caa18b6a35cdab6c6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=zg73mz9tZP4vPIGuR4W4XKy2ZW8%3D" alt="" loading="lazy"/></p>
<p>这些规则不是说你一开始就要有，而是在 AI 开发过程中，在已经有一定代码的情况下，就可以让 AI 读取现有的结构去生成，还有就是 AI 的脑回路大多数时候只和它训练时的数据绑定，所以有些新的东西，就需要你明说，一些他经常错的东西，就需要你显式的罗列出来：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47baa453c3dd4e36b29141063b2881bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=X3xbCluucH8etdVUldCp13qGfhM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>这里大部分都是使用 Android Studio 的 <code>Gemini for businesses</code> 完成，部分是 Copilot Web Agent 和 Claude 完成，另外，新版的 <a href="https://juejin.cn/post/7579999793320247302" target="_blank" title="https://juejin.cn/post/7579999793320247302">Android Studio Otter 2 Feature</a> Android Studio 的 Agent 模式也开始配备了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fr%2Fstudio-ui%2Fgemini%2Fandroid-knowledge-base" target="_blank" title="https://developer.android.com/r/studio-ui/gemini/android-knowledge-base" ref="nofollow noopener noreferrer">Android 知识库 </a>，从而显著提高准确性并减少错误信息。</p>
<p>这意味着，<strong>Agent 不再仅仅依赖于其训练数据，而是可以在回答用户问题之前主动查阅来自官方来源（例如 Android 开发者文档、Firebase、Google Developers 和 Kotlin 文档）的最新文档</strong>。</p>
</blockquote>
<p>当然，最终代码还是需要人审核，咱也不懂，为什么它增加个多语言的时候，会删掉某个标签，加个 <code>camera</code> 做什么？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6386b29445284e308f8f8d97f4e99371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=RWuSCm5ce5GENQgSj4KdBhZtdTg%3D" alt="" loading="lazy"/></p>
<p>当然，在这个过程里，你还能见到嘴硬的 AI 开始推卸责任，不得不说 AI 的拟人化越来越真实：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ba10312586a4975aef68a1b5568dec0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=Y%2FbvahNofg6lNejtkeHCVtfOFs0%3D" alt="ce1f85625ff3a0afd78e8e419fd014fa" loading="lazy"/></p>
<p>而对于项目的架构，我们也可以通过 AI 来完成，例如 <code>https://deepwiki.com/</code> ，只需要通过 <code>https://deepwiki.com/CarGuo/GSYGithubAppCompose</code> ，我们就可以得到一份项目的架构报告，并且你还可以通过它继续询问相关问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92cb0b8991e540e1ad1182c7b27fc2ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=8pSPcW3c75SjQPDhLmjqwkYcg34%3D" alt="" loading="lazy"/></p>
<p>另外，通过 AI 我们也可以生成对应的结构实现，例如以下就是通过 Gemini 生成的手绘图示例：</p>
<h4 data-id="heading-0">架构图</h4>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────────────┐
│                          GSYGithubAppCompose                            │
│                       (Jetpack Compose + MVVM)                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                ┌───────────────────┼───────────────────┐
                │                   │                   │
        ┌───────▼────────┐   ┌──────▼──────┐    ┌───────▼────────┐
        │  Presentation  │   │    Data     │    │      Core      │
        │     Layer      │   │    Layer    │    │     Layer      │
        └────────────────┘   └─────────────┘    └────────────────┘
                │                   │                   │
        ┌───────▼────────┐   ┌──────▼──────┐    ┌───────▼────────┐
        │   feature/*    │   │    data     │    │  core/network  │
        │                │   │             │    │  core/database │
        │ - welcome      │   │ Repository  │    │  core/common   │
        │ - login        │   │   Pattern   │    │  core/ui       │
        │ - home         │   │             │    └────────────────┘
        │ - dynamic      │   │ - User      │
        │ - trending     │   │ - Event     │
        │ - profile      │   │ - Repo      │
        │ - search       │   └─────────────┘
        │ - detail       │
        │ - code         │
        │ - issue        │
        │ - push         │
        │ - list         │
        │ - notification │
        │ - info         │
        └────────────────┘
</code></pre>
<h4 data-id="heading-1">模块依赖关系图</h4>
<pre><code class="hljs language-bash" lang="bash">                                    ┌─────────┐
                                    │   app   │
                                    └────┬────┘
                                         │
                 ┌───────────────────────┼────────────────────────┐
                 │                       │                        │
          ┌──────▼──────┐         ┌─────▼─────┐          ┌──────▼──────┐
          │  feature/*  │         │    data   │          │   core/ui   │
          │             │         │           │          │             │
          │所有功能模块  │◄────────┤Repository │          │  通用UI组件  │
          │             │         │           │          │             │
          └──────┬──────┘         └─────┬─────┘          └──────┬──────┘
                 │                      │                       │
                 │              ┌───────┼────────┐              │
                 │              │       │        │              │
                 └──────────────┼───────┼────────┼──────────────┘
                                │       │        │
                    ┌───────────▼─┐  ┌──▼────────▼──┐  ┌─────────────┐
                    │core/network │  │core/database │  │core/common  │
                    │             │  │              │  │             │
                    │ Retrofit    │  │    Room      │  │ DataStore   │
                    │ Apollo      │  │    Entity    │  │   Token     │
                    │ Model       │  │    DAO       │  │  Resources  │
                    └─────────────┘  └──────────────┘  └─────────────┘
​
依赖规则：
  app          → feature/*, core/ui, data
  feature/*    → data, core/ui, core/common
  data         → core/network, core/database, core/common
  core/ui      → core/common
  core/network → (独立模块)
  core/database→ (独立模块)
  core/common  → (独立模块)
</code></pre>
<h4 data-id="heading-2">技术架构图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────────┐
│                         技术栈 (Tech Stack)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  UI层                  Jetpack Compose + Material <span class="hljs-number">3</span>                 │
│                        Navigation Compose                           │
│                        Coil (图片加载)                               │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  状态管理              StateFlow + ViewModel                         │
│                        Kotlin Coroutines + <span class="hljs-attribute">Flow</span>                     │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  依赖注入              Hilt (Dagger <span class="hljs-number">2</span>)                               │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  网络层                Retrofit <span class="hljs-number">2</span> + OkHttp                           │
│                        Apollo GraphQL                               │
│                        Gson / Kotlinx Serialization                 │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  数据库层              Room Database                                 │
│                        DataStore (替代 SharedPreferences)            │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  架构模式              MVVM + Repository Pattern                     │
│                        Clean Architecture                           │
│                        Unidirectional Data <span class="hljs-attribute">Flow</span>                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-3">数据流向图</h4>
<pre><code class="hljs language-scss" lang="scss">┌──────────────┐        ┌──────────────┐        ┌──────────────┐
│              │        │              │        │              │
│   Screen     │◄───────┤  ViewModel   │◄───────┤  Repository  │
│  (Compose)   │ State  │   (MVVM)     │  <span class="hljs-attribute">Flow</span>  │   (Data)     │
│              │        │              │        │              │
└──────┬───────┘        └──────┬───────┘        └──────┬───────┘
       │                       │                       │
       │ User Action           │ Business Logic        │ Data Source
       │                       │                       │
       ▼                       ▼                       ▼
┌──────────────┐        ┌──────────────┐        ┌──────────────┐
│              │        │              │        │              │
│   onClick    │───────►│  <span class="hljs-built_in">loadData</span>()  │───────►│  Network /   │
│   onRefresh  │ Event  │  <span class="hljs-built_in">refresh</span>()   │ API    │  Database    │
│              │        │              │ Call   │              │
└──────────────┘        └──────────────┘        └──────────────┘
​
数据流：
<span class="hljs-number">1</span>. 用户操作触发 UI 事件
<span class="hljs-number">2</span>. ViewModel 处理业务逻辑
<span class="hljs-number">3</span>. Repository 协调数据源（网络/数据库）
<span class="hljs-number">4</span>. 数据通过 <span class="hljs-attribute">Flow</span> 返回到 ViewModel
<span class="hljs-number">5</span>. ViewModel 更新 UiState
<span class="hljs-number">6</span>. UI 自动重组显示新状态
</code></pre>
<h4 data-id="heading-4">分层职责</h4>















































<table><thead><tr><th>层级</th><th>模块</th><th>职责</th><th>主要技术</th></tr></thead><tbody><tr><td><strong>表现层</strong></td><td>feature/*</td><td>UI渲染、用户交互、状态展示</td><td>Jetpack Compose、Navigation</td></tr><tr><td><strong>业务层</strong></td><td>data (ViewModel)</td><td>业务逻辑、状态管理、数据编排</td><td>StateFlow、Coroutines</td></tr><tr><td><strong>数据层</strong></td><td>data (Repository)</td><td>数据访问、缓存策略、数据映射</td><td>Repository Pattern</td></tr><tr><td><strong>网络层</strong></td><td>core/network</td><td>API调用、网络请求、数据模型</td><td>Retrofit、Apollo、OkHttp</td></tr><tr><td><strong>存储层</strong></td><td>core/database</td><td>本地缓存、数据持久化</td><td>Room、DataStore</td></tr><tr><td><strong>基础层</strong></td><td>core/common、core/ui</td><td>公共工具、UI组件、资源</td><td>多语言、主题、工具类</td></tr></tbody></table>
<p>可以看到，AI 确实可以大大提高开发的效率，不仅“救活”了已经荒废的老项目，在新项目的迭代上也起到了很大的帮助，这也是为什么 2025 了还能有 GSYGithubAppCompose 的原因。</p>
<p><strong>事实上现在 GSYGithubApp 系列项目存在的意义也就是学习和对比，而 GSYGithubAppCompose 的意义，还提现在 AI 的应用和项目维护上</strong>，如何更好使用 AI 去维护一个项目，这对于程序猿来说，还是有一定的必要的，毕竟 2025 作为开发者，真的离不开 AI。</p>
<p>当然，如果你是 Android 原生开发，还没用上 Compose ，那 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">GSYGithubAppCompose</a> 或者也值得了解下？毕竟如果 Compose 会了，约等于 Compose MultiPlatform 也会了不是么？当然，你也可以说，AI 会就行🤭 。</p>
<h2 data-id="heading-5">最后</h2>
<p>最后，借着 AI 的风，本次也把所有项目的 Logo 形象都统一，从五个 GSYGithubApp ，到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2Fgsy_flutter_book" target="_blank" title="https://github.com/CarGuo/gsy_flutter_book" ref="nofollow noopener noreferrer">gsy_flutter_book</a> 文章合集项目，再到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYVideoPlayer" target="_blank" title="https://github.com/CarGuo/GSYVideoPlayer" ref="nofollow noopener noreferrer">GSYVideoPlayer</a> 播放器和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2Fgsy_flutter_demo" target="_blank" title="https://github.com/CarGuo/gsy_flutter_demo" ref="nofollow noopener noreferrer">gsy_flutter_demo</a> 示例项目，现在全都统一使用这个 logo ，虽然没什么设计感，但是我很满意：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fea239b15b6e41fe96308cd388debdaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=5ITSFN%2BIICm6X9yHMWfzyBnrQG4%3D" alt="" loading="lazy"/></p>
<p>再结合 AI ，一个看起来很颠的视频效果就这么出来了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a840f4a770e473bb2f3d3fddf5164a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=JIyCl1%2FoiA4mzhP5Oom8MrXC6uM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2F" target="_blank" title="https://github.com/CarGuo/" ref="nofollow noopener noreferrer">github.com/CarGuo/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter UI 设计库解耦重构进度，官方解答未来如何适配]]></title>    <link>https://juejin.cn/post/7585751355593850899</link>    <guid>https://juejin.cn/post/7585751355593850899</guid>    <pubDate>2025-12-22T03:34:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593850899" data-draft-id="7585969437032267818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter UI 设计库解耦重构进度，官方解答未来如何适配"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-22T03:34:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter UI 设计库解耦重构进度，官方解答未来如何适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:34:11.000Z" title="Mon Dec 22 2025 03:34:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在目前的 Flutter 架构中，Material（Android ）和 Cupertino（iOS）的 UI 库是与核心框架捆绑在一起的，也就是常见的 "batteries included" 原则，为的是方便开发者开箱即用，但是也导致了 Widgets、Material 和 Cupertino 这三个 lib 紧密耦合。</p>
<p>而今年提出的 decoupling design 重构，就是<strong>计划将这两个设计库从核心框架中解耦，并调整到独立的 Pub 包</strong>，也就是核心框架将只包含基础的 <code>Widgets</code> 库，而特定的设计风格将变为可选的插件 ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7f08af96f354221ab52520890f27380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=r95H8TJV7oMzVG70mcSaJ8gnn8M%3D" alt="" loading="lazy"/></p>
<p>之所以会有这个调整，最主要还是因为在最新的 Material 3 Expressive 和 Liquid Glass 风格发布之后，UI 在 Framework 层的适配成本变高，并且 <strong>Framework 的更新节奏也无法很好适应这种 UI 风格调整</strong>，所以在社区的呼声下，官方正式开始了 decoupling design 计划。</p>
<p>实际上在之前，很多基础组件对特定设计库有不必要的依赖，你以为框架的代码结构是下图 A ，但是在多年维护后，目前已经是下图 B 的情况：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369d602fb81d4fe1b65e446997de2572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=6qAsbJsdiaILfSsykRKpbhEQOnQ%3D" alt="" loading="lazy"/></p>
<p>另外，类似 <code>SelectionArea</code> 组件，它看起来是一个纯 Widget 的基础组件，但为了实现跨平台适配，底层却必须依赖 Material 和 Cupertino 库 ，如果没有，你就会发现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5259133efa5c48faa624e75b8dc5dfa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=npmC5nlW3N6ZY9HEKsRLclLt73Q%3D" alt="" loading="lazy"/></p>
<p>因为在之前的 "batteries included" 原则，实际上控件内部会根据使用的风格或者运行的平台，主动为用户采用对应的主题风格，这样的话好处肯定是开箱即用，但是实际上用户很多时候并不理解这一点，并且最重要的是：</p>
<blockquote>
<p><strong>由于设计库与框架发布周期绑定，新设计的跟进趋势会让适应速度变慢很多，同时紧密的耦合也让 PR 变得复杂，每次调整风险更高，容易引发回归错误</strong> 。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2278e0a4c947a0a189036864f45187~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=4lT3LjEFHBWBGzGN194n4Ek8ni0%3D" alt="" loading="lazy"/></p>
<p>另外，现阶段开发者如果想构建非 Material/Cupertino 的自定义设计系统，往往不得不从头开始，因为现有的基础组件的定制功能开发不足 ，所以 decoupling design 作为现阶段必须经历的产物，最终提上了日程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f849dc87fb8b4a838b4bb5509b028c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=YaEXHekZKeZOlUgDuC8Ed3zKvuY%3D" alt="" loading="lazy"/></p>
<p>当然，实际上解耦和重构设计库是一个非常大的底层调整，其中核心主要涉及了四个领域：</p>
<ul>
<li><strong>System UI</strong> ：需要重新界定设计库与平台之间的界限（例如文本选择、页面过渡） ，这个是最大的成本之一</li>
<li><strong>代码组织</strong> ：在基础 <code>Widgets</code> 库中创建更多的“原始组件抽象” (raw widget abstractions)，类似现在的 <code>RawRadio</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e79ad1ea8cf4bda87832255ae530e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=OKahAaQVVHvPFPi6LwM6n9oIfZc%3D" alt="" loading="lazy"/></li>
<li><strong>主题</strong>：评估并改进主题系统，解决 Material 和 Cupertino 主题缺乏共同 BASE 的问题 ，因为之前 Widgets 完全没有主题体系，所以需要考虑是否引入更通用的 theme abstraction</li>
<li><strong>基础设施适配</strong>：迁移超过 200 个测试，并将相关的 CI 流程从主仓库迁移出去 ，避免交叉导入，建立独立的 CI 流程，让 PR 更便捷过审</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc792c8a50d4f9a90e6478487e2e0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=nq3LVhvrxJxQD%2BAOWsZUX%2BQw2eU%3D" alt="" loading="lazy"/></p>
<p>而对于解耦完成的是假变，整个项目分三个阶段进行：</p>
<ul>
<li>
<p><strong>阶段一 (2025年12月)</strong> ：</p>
<ul>
<li>基础调整，将 Material/Cupertino 中的通用核心逻辑下沉移动到 <code>widgets</code> 库</li>
<li>搭建 Flutter packages 仓库的基础支持</li>
</ul>
</li>
<li>
<p><strong>阶段二 2026年</strong> ：</p>
<ul>
<li>正式解耦，将代码移至新的包中并发布到 Pub</li>
<li>在主框架中标记旧库为“已弃用” (deprecated)</li>
</ul>
</li>
<li>
<p><strong>阶段三 - 2026年晚些时候</strong> ：</p>
<ul>
<li>从核心框架中彻底移除已弃用的 Material 和 Cupertino 库</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb4eda73d66a4a6a84a4bb3385cb4e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=eYX2ZyzSg4ENvbGcvoTvAC9HAWw%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>也就是，2026 年我们就可以拥有全新的 Material 3 Expressive 和 Liquid Glass 风格支持，并且是可选 package</p>
</blockquote>
<p>当然，对开发者的影响的使用肯定有影响，这个影响有好有坏：</p>
<ul>
<li><strong>版本管理更灵活</strong>：解耦后，Material 和 Cupertino 将遵循语义化版本控制，开发者可以锁定特定版本，独立于 Flutter 框架的升级节奏 ，更加方便灵活，<strong>不必跟着 Flutter 升级 UI 设计</strong></li>
<li><strong>更容易构建自定义设计</strong>：通过使用底层的“原始组件” (raw widgets，如 <code>RawRadio</code>)，构建完全自定义的 UI 系统将变得更加容易，不再被迫基于 Material 组件修改</li>
<li><strong>破坏性变更 (Breaking Changes)</strong> ：虽然未来会提供快速修复工具 (quick fixes)，但解耦过程不可避免地会带来一些破坏性变更 ，这些是是需要开发者自己适配</li>
<li><strong>设计库更新暂停</strong>：为了减少迁移难度，在解耦完成前， Flutter 会将暂停引入新的重大设计更新（如 Material 3 Expressive 或 Liquid Glass） ，所以这个需要开发耐心等待</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3fa99b8f6d842f2acfc7786def5d092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=P7KXXLTGu4fKwzFHOl8%2BkEvYgfs%3D" alt="" loading="lazy"/></p>
<p>当然，解耦之后，<strong>Framework 的 UI break change 会越来越少，而开发者也可以选择自己的 style package 进行 lock</strong> ，整体灵活性和可用度会更好。</p>
<p>不过，对于 Plugin开发者来说，可能会有更高的适配成本，<strong>因为需要考虑 UI 实现里使用的是哪个 version 的 style package ，也需要考虑会不会给用户带来版本冲突等</strong>，在这方面也许未来会出现类似 RN 的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff1a70cf4a9347aba175551957b971b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=NLTo0F37w3rKBu1LOuWLfBf4LxI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">最后</h2>
<p>这次重构虽然是一项巨大的工程，但长远来看会让 Flutter 框架更耐用，也让设计库的迭代更迅速，并更好地支持第三方设计生态系统的发展 ，甚至未来 PC 平台的第三方 UI 风格也可以更好适配，这也引出另一个问题：</p>
<blockquote>
<p>Compose Multiplatform 是否也有类似问题，是否也会跟进？毕竟 CMP 也是以 Material 为主，不过目前看来 Compose 先天具备分层风格 function ，更倾向于平台层 UI 自己独立实现，实际上问题会小很多。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 原生功能狂飙，15 个热门 npm 包要失业了]]></title>    <link>https://juejin.cn/post/7586192313635389474</link>    <guid>https://juejin.cn/post/7586192313635389474</guid>    <pubDate>2025-12-22T04:00:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586192313635389474" data-draft-id="7586136543954812966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 原生功能狂飙，15 个热门 npm 包要失业了"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-22T04:00:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 原生功能狂飙，15 个热门 npm 包要失业了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:00:10.000Z" title="Mon Dec 22 2025 04:00:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<p>之前装个 Node.js 项目，npm 包能装一大堆。</p>
<p>现在发现很多包其实不用装了，Node.js 自己就支持。</p>
<p>这次整理了 15 个已经被 Node.js 原生功能替代的热门 npm 包。</p>
<p>有些已经稳定了，有些还在实验阶段，但都能用起来了。</p>
<h2 data-id="heading-0">fetch 终于成全局函数了</h2>
<p>以前在 Node.js 里用 fetch，必须装 node-fetch。</p>
<p>现在 Node.js 18 开始，fetch 已经是全局函数了，和浏览器里的用法完全一样。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://api.github.com/repos/nodejs/node"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">full_name</span>);
</code></pre>
<p>直接就能用，不用装任何包。</p>
<p>Node.js 17.5 开始实验性支持，到 18 就稳定了。</p>
<p>如果你的项目还在用 Node.js 18 之前的版本，那还是得装 node-fetch。</p>
<h2 data-id="heading-1">WebSocket 也原生支持了</h2>
<p>之前做 WebSocket 客户端，基本都用 ws 这个包。</p>
<p>现在 Node.js 有了全局的 WebSocket 类。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">"wss://echo.websocket.org"</span>);

ws.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">"Hello!"</span>);
ws.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received:"</span>, event.<span class="hljs-property">data</span>);
</code></pre>
<p>Node.js 21 加的，不过还是实验性的。</p>
<p>要注意的是，这只是客户端支持。</p>
<p>如果要做 WebSocket 服务端，还是得用 ws 或者其他库。</p>
<h2 data-id="heading-2">测试框架不用装了</h2>
<p>以前写测试，要装 mocha、jest 这些框架。</p>
<p>现在 Node.js 自带测试模块 node:test。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
<span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert"</span>;

<span class="hljs-title function_">test</span>(<span class="hljs-string">"addition works"</span>, <span class="hljs-function">() =&gt;</span> {
  assert.<span class="hljs-title function_">strictEqual</span>(<span class="hljs-number">2</span> + <span class="hljs-number">2</span>, <span class="hljs-number">4</span>);
});
</code></pre>
<p>Node.js 18 加的实验性功能，到 20 就稳定了。</p>
<p>如果需要快照测试、mock 这些高级功能，第三方框架还是更强。</p>
<p>不过对于模块级别的测试，node:test 完全够用了。</p>
<h2 data-id="heading-3">SQLite 也要原生支持了</h2>
<p>之前用 SQLite，要装 sqlite3 或 better-sqlite3。</p>
<p>这俩包都需要编译原生模块，升级 Node.js 版本经常出问题。</p>
<p>现在 Node.js 在开发 node:sqlite 模块。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { open } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:sqlite"</span>;

<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title function_">open</span>(<span class="hljs-string">":memory:"</span>);
<span class="hljs-keyword">await</span> db.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"CREATE TABLE users (id INTEGER, name TEXT)"</span>);
</code></pre>
<p>不过还是实验性的，等稳定了就能彻底告别编译问题了。</p>
<h2 data-id="heading-4">控制台彩色输出不用装 chalk 了</h2>
<p>给控制台输出加颜色，以前都用 chalk 或 kleur。</p>
<p>现在 Node.js 有 util.styleText 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { styleText } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>(<span class="hljs-string">"red"</span>, <span class="hljs-string">"Error!"</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>([<span class="hljs-string">"bold"</span>, <span class="hljs-string">"green"</span>], <span class="hljs-string">"Success!"</span>));
</code></pre>
<p>Node.js 20.12 加的，到 22.17 就稳定了。</p>
<p>如果需要复杂的主题配置或链式调用，chalk 还是更好用。</p>
<p>但简单的颜色输出，原生的就够了。</p>
<h2 data-id="heading-5">清理 ANSI 码也不用装包了</h2>
<p>以前要去掉日志里的 ANSI 转义码，得装 strip-ansi。</p>
<p>现在有 util.stripVTControlCharacters 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { stripVTControlCharacters } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-keyword">const</span> text = <span class="hljs-string">"\u001B[4mUnderlined\u001B[0m"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">stripVTControlCharacters</span>(text));
</code></pre>
<p>原生处理，稳定可靠。</p>
<p>基本不需要再装第三方包了。</p>
<h2 data-id="heading-6">glob 匹配文件也原生了</h2>
<p>匹配文件路径，以前必须用 glob 包。</p>
<p>Node.js 22 开始有 fs.glob 函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">glob</span>(<span class="hljs-string">"**/*.js"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(files);
</code></pre>
<p>22 版本就稳定了，可以放心用。</p>
<p>老项目还在用旧版本 Node.js 的话，还是得继续用 glob 包。</p>
<h2 data-id="heading-7">递归删除目录不用 rimraf 了</h2>
<p>删除整个目录树，以前都用 rimraf。</p>
<p>现在 fs.rm 直接支持递归删除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rm</span>(<span class="hljs-string">"dist"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 12.10 就有了，现在所有 LTS 版本都稳定支持。</p>
<h2 data-id="heading-8">递归创建目录也不用 mkdir 了</h2>
<p>创建多级目录，以前要装 mkdir。</p>
<p>现在 fs.mkdir 原生支持。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(<span class="hljs-string">"logs/app"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 10.12 就加了，早就稳定了。</p>
<h2 data-id="heading-9">UUID 生成不用装包了</h2>
<p>生成 UUID v4，以前要装 uuid 包。</p>
<p>现在 crypto 模块自带 randomUUID 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">randomUUID</span>());
</code></pre>
<p>Node.js 14.17 就有了，稳定版本。</p>
<h2 data-id="heading-10">Base64 编解码也原生支持了</h2>
<p>以前要 polyfill atob 和 btoa 函数。</p>
<p>现在这俩已经是全局函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> encoded = <span class="hljs-title function_">btoa</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(encoded);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">atob</span>(encoded));
</code></pre>
<p>Buffer 一直都有，现在加上 atob 和 btoa，浏览器和 Node.js 的代码终于统一了。</p>
<p>Node.js 20 左右加的，现在 LTS 版本都有。</p>
<h2 data-id="heading-11">URL 路由匹配有了 URLPattern</h2>
<p>做路由匹配，以前要装 url-pattern。</p>
<p>现在有全局的 URLPattern API。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/users/:id"</span> });
<span class="hljs-keyword">const</span> match = pattern.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"/users/42"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(match.<span class="hljs-property">pathname</span>.<span class="hljs-property">groups</span>.<span class="hljs-property">id</span>);
</code></pre>
<p>Node.js 20 加的，不过还是实验性的。</p>
<p>但已经能用了，而且和浏览器的 URLPattern 完全一样。</p>
<h2 data-id="heading-12">加载 .env 文件不一定要 dotenv 了</h2>
<p>之前加载环境变量文件，必须装 dotenv。</p>
<p>现在可以用 --env-file 参数。</p>
<pre><code class="hljs language-ini" lang="ini">node <span class="hljs-attr">--env-file</span>=.env app.js
</code></pre>
<p>Node.js 20.10 加的实验性功能。</p>
<p>如果需要变量展开或多文件支持，dotenv 还是更强。</p>
<p>但简单场景下，原生的就够了。</p>
<h2 data-id="heading-13">EventTarget 也是全局的了</h2>
<p>以前 Node.js 只有 EventEmitter，要用 Web 标准的 EventTarget 得装 event-target-shim。</p>
<p>现在 EventTarget 已经是全局的了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> target = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventTarget</span>();
target.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"ping"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"pong"</span>));
target.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">"ping"</span>));
</code></pre>
<p>Node.js 15 加的，15.4 就稳定了。</p>
<p>浏览器和 Node.js 终于可以用同样的事件 API 了。</p>
<h2 data-id="heading-14">运行 TypeScript 不一定要 tsc 了</h2>
<p>以前运行 .ts 文件，要装 TypeScript 编译器或 ts-node。</p>
<p>现在 Node.js 有实验性的 TypeScript 支持。</p>
<pre><code class="hljs language-css" lang="css">node <span class="hljs-attr">--experimental-strip-types</span> app<span class="hljs-selector-class">.ts</span>
</code></pre>
<p>Node.js 21 加的实验性功能。</p>
<p>不过这只是去掉类型标注，不做类型检查。</p>
<p>生产环境还是得用完整的 TypeScript 工具链。</p>
<h2 data-id="heading-15">为啥 Node.js 要把这些功能内置</h2>
<p>看这些变化，能发现一个趋势。</p>
<p>以前需要外部依赖的功能，现在越来越多变成了核心功能。</p>
<p>这样做有几个好处。</p>
<p>减少依赖数量，项目更轻量。</p>
<p>降低供应链攻击风险，不用担心某个包被投毒。</p>
<p>代码在浏览器和服务端之间更容易移植。</p>
<h2 data-id="heading-16">能用就用起来</h2>
<p>这些原生功能，浏览器支持好的就可以直接用了。</p>
<p>实验性的功能可以在开发环境先试试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 实战赛 | 开奖公示 🏆]]></title>    <link>https://juejin.cn/post/7586167377382801434</link>    <guid>https://juejin.cn/post/7586167377382801434</guid>    <pubDate>2025-12-22T07:22:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377382801434" data-draft-id="7586167377382719514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 实战赛 | 开奖公示 🏆"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-12-22T07:22:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 实战赛 | 开奖公示 🏆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T07:22:09.000Z" title="Mon Dec 22 2025 07:22:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🎉2025年TRAE SOLO 实战赛正式落幕啦！</p>
<p>本次活动聚焦AI应用落地全流程，以<strong>TRAE SOLO</strong>为核心工具，吸引众多掘友参与，诞生了优质实战内容。感谢每位掘友的付出，相信大家在这次活动中都已经有所收获。</p>
<blockquote>
<p>本次活动评选规则：</p>
<p><strong>优秀文章奖</strong>：由技术评委评分，并参考文章的阅读量、点赞数、评论数等指标；</p>
<p><strong>Coding达人奖</strong>：活动期间同一用户发文数≥<strong>2</strong>篇，单篇文章满足“<em><strong>官方推荐 且 互动总数据（收藏、点赞、评论）＞40 且 浏览量＞1000</strong></em>，即可参与排名。</p>
</blockquote>
<p>详细的名单公示如下：</p>
<h2 data-id="heading-0">获奖名单</h2>
<h4 data-id="heading-1">优秀文章奖</h4>



































































































































<table><thead><tr><th>排名</th><th>用户名</th><th>uid</th><th>获奖文章</th></tr></thead><tbody><tr><td>TOP1</td><td>coder_pig</td><td>4142615541321928</td><td><a href="https://juejin.cn/post/7582200865907982370" target="_blank" title="https://juejin.cn/post/7582200865907982370">🚀用 TRAE SOLO 一天不到就把老项目重构完是什么体验？</a></td></tr><tr><td>TOP2</td><td>HiStewie</td><td>1591748568038823</td><td><a href="https://juejin.cn/post/7579871631096184858" target="_blank" title="https://juejin.cn/post/7579871631096184858">🔥 懂原理但不会说？我怒写了个 AI 模拟器折磨自己，M属性大爆发！</a></td></tr><tr><td>TOP3</td><td>不如摸鱼去</td><td>26044011388510</td><td><a href="https://juejin.cn/post/7576210031873409065" target="_blank" title="https://juejin.cn/post/7576210031873409065">TRAE SOLO 正式发布了？我用它将像老乡鸡那样做饭小程序开源了！</a></td></tr><tr><td>TOP4</td><td>xiaohe0601</td><td>3183831378302871</td><td><a href="https://juejin.cn/post/7579805639436025908" target="_blank" title="https://juejin.cn/post/7579805639436025908">⚪️ 五子棋加入道具系统是一种什么体验？我用 TRAE SOLO 实现了！</a></td></tr><tr><td>TOP5</td><td>草帽lufei</td><td>501033035632093</td><td><a href="https://juejin.cn/post/7572997791451611174" target="_blank" title="https://juejin.cn/post/7572997791451611174">Trae SOLO项目真实需求</a></td></tr><tr><td>TOP6</td><td>大模型真好玩</td><td>3140624091453053</td><td><a href="https://juejin.cn/post/7580723992498438180" target="_blank" title="https://juejin.cn/post/7580723992498438180">LangChain1.0实战之多模态RAG系统（四）——Trae Solo搭建部署多模态RAG前端(附AI编程实践指南)</a></td></tr><tr><td>TOP7</td><td>飞哥数智谈</td><td>3825956195409223</td><td><a href="https://juejin.cn/post/7572397142364766250" target="_blank" title="https://juejin.cn/post/7572397142364766250">TRAE SOLO 正式版实战：一个全栈打卡项目的真实体验</a></td></tr><tr><td>TOP8</td><td>不惑_</td><td>1471609400466218</td><td><a href="https://juejin.cn/post/7572697146286735410" target="_blank" title="https://juejin.cn/post/7572697146286735410">我用 SOLO Coder 做 Excalidraw 开源项目二次开发</a></td></tr><tr><td>TOP9</td><td>龙在天</td><td>3760787883819464</td><td><a href="https://juejin.cn/post/7572092283719925812" target="_blank" title="https://juejin.cn/post/7572092283719925812">不小心更新了trae，发现...</a></td></tr><tr><td>TOP10</td><td>zhouzhouya</td><td>3931509312987511</td><td><a href="https://juejin.cn/post/7574916588718293034" target="_blank" title="https://juejin.cn/post/7574916588718293034">百万QPS防刷赞系统设计实录：TRAE SOLO从生成到生产级改造</a></td></tr><tr><td>TOP11</td><td>也无风雨也雾晴</td><td>2175258804632332</td><td><a href="https://juejin.cn/post/7575102209605173274" target="_blank" title="https://juejin.cn/post/7575102209605173274">记一次 Trae 苏州 Hackathon 之旅：用 Solo 模式把“做饭灵感”变成现实（获优秀奖！）</a></td></tr><tr><td>TOP12</td><td>PBitW</td><td>3048261967153544</td><td><a href="https://juejin.cn/post/7572340344509251610" target="_blank" title="https://juejin.cn/post/7572340344509251610">升级了SOLO，对SOLO的一些建议！👍SOLO真的很不错！</a></td></tr><tr><td>TOP13</td><td>卷福同学</td><td>3456520291098686</td><td><a href="https://juejin.cn/post/7582958136257413156" target="_blank" title="https://juejin.cn/post/7582958136257413156">【AI编程】5分钟用Trae solo做出有BOSS战的《坦克大战》</a></td></tr><tr><td>TOP14</td><td>水冗水孚</td><td>1406974769508679</td><td><a href="https://juejin.cn/post/7582779306731585571" target="_blank" title="https://juejin.cn/post/7582779306731585571">使用Trae SOLO模式开发一个视频提取文字并总结归纳的工具——附线上预览地址</a></td></tr><tr><td>TOP15</td><td>CoolerWu</td><td>2400989125543272</td><td><a href="https://juejin.cn/post/7574699340678086665" target="_blank" title="https://juejin.cn/post/7574699340678086665">TRAE SOLO实战：一个所见即所得的笔记软体</a></td></tr><tr><td>TOP16</td><td>努力的小雨</td><td>572218015747543</td><td><a href="https://juejin.cn/post/7577905525998075945" target="_blank" title="https://juejin.cn/post/7577905525998075945">AI 编程协作，我的一点邪修方法，希望可以帮助到你</a></td></tr><tr><td>TOP17</td><td>银空飞羽</td><td>1086796427178429</td><td><a href="https://juejin.cn/post/7580295137394720783" target="_blank" title="https://juejin.cn/post/7580295137394720783">让Trae SOLO全自主学习开发近期爆出的React RCE漏洞靶场并自主利用验证（CVE-2025-55182）</a></td></tr><tr><td>TOP18</td><td>kungggyoyoyo</td><td>2506542239987550</td><td><a href="https://juejin.cn/post/7576918517238530098" target="_blank" title="https://juejin.cn/post/7576918517238530098">TRAE中国版SOLO模式上线！我用它从0到1开发了一款AI小说编辑器</a></td></tr><tr><td>TOP19</td><td>埃兰德欧神</td><td>3421335915620920</td><td><a href="https://juejin.cn/post/7582528397866172443" target="_blank" title="https://juejin.cn/post/7582528397866172443">AI编程实战：用Trae SOLO模式梭哈一个文档阅读小程序</a></td></tr><tr><td>TOP20</td><td>围巾哥萧尘</td><td>1222312659548446</td><td><a href="https://juejin.cn/post/7582424649783787520" target="_blank" title="https://juejin.cn/post/7582424649783787520">🚀TRAE SOLO 实战赛  智启Coding 码力全开  让AI为你打造完美旅程  @围巾哥萧尘🧣</a></td></tr></tbody></table>
<h4 data-id="heading-2"><strong>Coding达人奖</strong></h4>




















<table><thead><tr><th>用户名</th><th>uid</th><th>参赛文章</th></tr></thead><tbody><tr><td>HiStewie</td><td>1591748568038823</td><td><a href="https://juejin.cn/post/7577653509862654002" title="https://juejin.cn/post/7577653509862654002" target="_blank">3天，1人，从0到付费产品：AI时代个人开发者的生存指南</a></td></tr><tr><td/><td/><td><a href="https://juejin.cn/post/7579871631096184858" title="https://juejin.cn/post/7579871631096184858" target="_blank"> 🔥 懂原理但不会说？我怒写了个 AI 模拟器折磨自己，M属性大爆发！</a></td></tr></tbody></table>
<h2 data-id="heading-3">领奖方式</h2>
<ul>
<li>符合奖金瓜分条件的掘友近期请注意 <strong>[系统消息]</strong> （预计2025年12月22日23:00前下发），请于 <strong>2025 年 12 月 28 日 23 点</strong> 之前在相关问卷中填写信息，过期将视为放弃奖品。</li>
<li>奖品将于问卷截止日期后的 30 个工作日内完成发放。</li>
</ul>
<p><strong>若对获奖名单有疑问，请先自查文章，确认无以下原因后，可 [<a href="https://juejin.cn/user/2781101557286346" target="_blank" title="https://juejin.cn/user/2781101557286346">点击链接</a>] 联系「LALALA」进行申诉~申诉处理时间2025年12月22日-2025年12月28日，过时维持原结果。</strong></p>
<ul>
<li><strong>必须为原创技术文章</strong>，内容符合<a href="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" title="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" target="_blank">掘金社区的内容标准和规范</a>；</li>
<li><strong>字数不得少于 800 字</strong>，不得有广告/洗稿/凑字数/AI撰写等行为，如果发现有此类行为 ，直接取消所有获奖资格（备注：文章中50%及以上内容与网络内容相同，即视为洗稿）；</li>
<li><strong>文章要求首发在掘金</strong>，已在其他平台发布过的文章不计入活动，博客搬家/旧文新发等超过<strong>10篇</strong>直接取消所有获奖资格；</li>
<li><strong>学习笔记/知识点汇总类不能瓜分奖金</strong>，可以是知识点讲解/理解，即所有文章都需要有个人见解、思考、总结，单纯的搬运官网、书中知识点不计入；</li>
<li>刷赞、刷量等有作弊行为的文章，直接取消比赛资格，不能参与评选；</li>
<li>文章需包含背景/问题，核心思路，实操步骤/论证过程，总结反思等，不能只贴代码，如代码量超<strong>60%</strong> 则不计入；</li>
<li>AI代写文章、AI聊天记录等不计入活动（AI检测超过<strong>70%</strong> 取消文章获奖资格）；</li>
<li>工具汇总、软件测评类文章不可参加活动；</li>
<li>参赛文章必须注明参考来源。</li>
</ul>
<h6 data-id="heading-4"><em>活动期间，若发布文章内容与活动主题</em> <em>TRAE</em> <em>无相关性，则取消该用户对应文章获奖资格。</em></h6></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 的新时代已经到来：你需要知道的一切]]></title>    <link>https://juejin.cn/post/7586540799220088873</link>    <guid>https://juejin.cn/post/7586540799220088873</guid>    <pubDate>2025-12-22T06:20:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799220088873" data-draft-id="7586178555776876550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 的新时代已经到来：你需要知道的一切"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T06:20:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 的新时代已经到来：你需要知道的一切
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:20:02.000Z" title="Mon Dec 22 2025 06:20:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fthe-next-era-of-react%2F" target="_blank" title="https://blog.logrocket.com/the-next-era-of-react/" ref="nofollow noopener noreferrer">The next era of React has arrived: Here's what you need to know</a></p>
<p>翻译： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>构建异步 UI 向来都是一件非常困难的事情。导航操作将内容隐藏在加载指示器之后，搜索框在响应无序到达时会产生竞态条件，表单提交则需要手动管理每一个加载状态标志和错误信息。每个异步操作都迫使你手动进行协调。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adf9437aff2848d18d07b0c6ea80ce4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989201&amp;x-signature=KY1YR1SxekvHyE3kBYSrovw0w8o%3D" alt="image.png" loading="lazy"/></p>
<p>这不是一个性能问题，而是一个协调问题。现在，React 的原语声明式地解决了它。</p>
<p>对于开发团队而言，这标志着我们构建方式的一次根本性转变。React 不再需要每位开发者在每个组件中重新发明异步处理逻辑，而是提供了标准化的原语来自动处理协调。这意味着更少的 Bug、更一致的用户体验，以及更少的调试竞态条件的时间。</p>
<h2 data-id="heading-0">React 的异步协调原语</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ab8486cd4d4d49b0ae09537f3f3bf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989201&amp;x-signature=miNM4rDSLulnLH6UgCfwGH7dTKU%3D" alt="image.png" loading="lazy"/></p>
<p>在 React Conf 2025 上，来自 React 团队的 Ricky Hanlon 演示的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fasync-react.dev%2F" target="_blank" title="https://async-react.dev/" ref="nofollow noopener noreferrer">Async React 示例</a>，展示了未来的可能性：一个包含搜索、标签页和状态变更的课程浏览应用，在快速网络下感觉即时，在慢速网络下也能保持流畅。UI 更新自动协调，不会闪烁。</p>
<p>这不是一个新库，而是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-19-2-is-here%2F" target="_blank" title="https://blog.logrocket.com/react-19-2-is-here/" ref="nofollow noopener noreferrer">React 19</a> 的协调 API 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2022%2F03%2F29%2Freact-v18%23what-is-concurrent-react" target="_blank" title="https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react" ref="nofollow noopener noreferrer">React 18 的并发特性</a> 的结合。它们共同构成了 React 团队称之为  <strong>“异步 React（Async React）”</strong>  的完整系统，通过可组合的原语来构建响应式的异步应用程序：</p>
<ul>
<li><strong><code>useTransition</code></strong>：跟踪待处理的异步工作。</li>
<li><strong><code>useOptimistic</code></strong>：在状态变更期间提供即时反馈（乐观更新）。</li>
<li><strong><code>Suspense</code></strong>：声明式地处理加载边界。</li>
<li><strong><code>useDeferredValue</code></strong>：在快速更新期间保持稳定的用户体验。</li>
<li><strong><code>use()</code></strong> ：使数据获取（和上下文读取）变得声明式。</li>
</ul>
<p>理解这些部分如何协同工作是关键，它使我们能从命令式的异步代码转向声明式的协调。</p>
<h2 data-id="heading-1">问题：手动的异步协调</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E9%2597%25AE%25E9%25A2%2598%25E6%2589%258B%25E5%258A%25A8%25E7%259A%2584%25E5%25BC%2582%25E6%25AD%25A5%25E5%258D%258F%25E8%25B0%2583" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E9%97%AE%E9%A2%98%E6%89%8B%E5%8A%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E5%8D%8F%E8%B0%83" ref="nofollow noopener noreferrer"/></p>
<p>在这些原语出现之前，开发者必须手动编排每一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-19-2-the-async-shift%2F" target="_blank" title="https://blog.logrocket.com/react-19-2-the-async-shift/" ref="nofollow noopener noreferrer">异步操作</a>。表单提交需要显式的加载和错误状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SubmitButton</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>();
            <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-title function_">setError</span>(e.<span class="hljs-property">message</span>);
            <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
        }
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
                {isLoading ? '提交中...' : '提交'}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>错误：{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>数据获取也遵循类似的命令式模式，使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2F15-common-useeffect-mistakes-react%2F" target="_blank" title="https://blog.logrocket.com/15-common-useeffect-mistakes-react/" ref="nofollow noopener noreferrer"><code>useEffect</code></a>：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">UserProfile</span>({ userId }) {
    const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null);
    const <span class="hljs-selector-attr">[isLoading, setIsLoading]</span> = <span class="hljs-built_in">useState</span>(true);
    const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null);

    <span class="hljs-built_in">useEffect</span>(() =&gt; {
        <span class="hljs-built_in">setIsLoading</span>(true);
        <span class="hljs-built_in">setError</span>(null);
        <span class="hljs-built_in">fetchUser</span>(userId)
            <span class="hljs-selector-class">.then</span>(data =&gt; {
                setUser(data);
                <span class="hljs-built_in">setIsLoading</span>(false);
            })
            <span class="hljs-selector-class">.catch</span>(e =&gt; {
                setError(e.message);
                <span class="hljs-built_in">setIsLoading</span>(false);
            });
    }, <span class="hljs-selector-attr">[userId]</span>);

    if (isLoading) return &lt;<span class="hljs-selector-tag">div</span>&gt;加载中...&lt;/<span class="hljs-selector-tag">div</span>&gt;;
    if (error) return &lt;<span class="hljs-selector-tag">div</span>&gt;错误：{error}&lt;/<span class="hljs-selector-tag">div</span>&gt;;

    return &lt;<span class="hljs-selector-tag">div</span>&gt;{user<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p>每个异步操作都重复这个模式：跟踪加载状态、处理错误、协调状态更新。当这种模式扩展到几十个组件时，就会导致不一致的加载状态、被遗忘的错误处理，以及难以调试的微妙竞态条件。</p>
<h2 data-id="heading-2">原语详解</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%258E%259F%25E8%25AF%25AD%25E8%25AF%25A6%25E8%25A7%25A3" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%8E%9F%E8%AF%AD%E8%AF%A6%E8%A7%A3" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-3"><strong>Actions 自动跟踪异步工作</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23actions-%25E8%2587%25AA%25E5%258A%25A8%25E8%25B7%259F%25E8%25B8%25AA%25E5%25BC%2582%25E6%25AD%25A5%25E5%25B7%25A5%25E4%25BD%259C" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#actions-%E8%87%AA%E5%8A%A8%E8%B7%9F%E8%B8%AA%E5%BC%82%E6%AD%A5%E5%B7%A5%E4%BD%9C" ref="nofollow noopener noreferrer"/></p>
<p>React 19 引入了 Actions 来声明式地处理异步协调。将一个异步函数包装在 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseTransition" target="_blank" title="https://react.dev/reference/react/useTransition" ref="nofollow noopener noreferrer"><code>startTransition</code></a> 中，可以让 React 跟踪整个操作：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isPending, startTransition]</span> = <span class="hljs-built_in">useTransition</span>();

function <span class="hljs-built_in">submitAction</span>() {
    <span class="hljs-built_in">startTransition</span>(async () =&gt; {
        await <span class="hljs-built_in">submitToServer</span>();
    });
}
</code></pre>
<p><code>isPending</code> 标志在 Promise 解决之前一直为 <code>true</code>。React 会自动处理此状态，并且在 Transition 中抛出的错误会冒泡到错误边界（Error Boundary），而不是在分散的 <code>try/catch</code> 块中处理（你仍需自己处理预期的错误，如验证失败）。</p>
<p>React 将在 Transition 中调用的任何函数被称为 “Action”。命名约定很重要：为函数添加 “Action” 后缀表示它们运行在 Transition 中（例如，<code>submitAction</code>、<code>deleteAction</code>）。</p>
<p>以下是使用 Actions 重写的相同按钮：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SubmitButton</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitAction</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>();
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{submitAction}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
            {isPending ? '提交中...' : '提交'}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
}
</code></pre>
<p>另一种选择是使用 React 19 的 <code>&lt;form&gt;</code> 组件，它可以通过接受一个 <code>action</code> 属性并将其自动包装在 Transition 中来为你处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitAction</span>(<span class="hljs-params">formData</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>(formData);
}

&lt;form action={submitAction}&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'username'</span> /&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/form&gt;;
</code></pre>
<p>与手动 Action 一样，错误仍会冒泡到错误边界。当你希望在 UI 中反映表单状态时，React 19 提供了表单实用程序：<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact-dom%2Fhooks%2FuseFormStatus" target="_blank" title="https://react.dev/reference/react-dom/hooks/useFormStatus" ref="nofollow noopener noreferrer"><code>useFormStatus</code></a> 让子组件可以访问表单的待处理状态，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseActionState" target="_blank" title="https://react.dev/reference/react/useActionState" ref="nofollow noopener noreferrer"><code>useActionState</code></a> 则允许你根据 Action 的结果更新组件状态（例如显示验证错误或“点赞”计数）。</p>
<p>相同的模式也适用于按钮、输入框和标签页等可复用组件。你的设计组件可以暴露 <code>action</code>、<code>submitAction</code> 或 <code>changeAction</code> 等 Action 属性，并在内部使用 Transitions 来管理待处理状态和其他异步行为。我们稍后将回到这个模式。</p>
<h3 data-id="heading-4"><strong>乐观更新提供即时反馈</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25B9%2590%25E8%25A7%2582%25E6%259B%25B4%25E6%2596%25B0%25E6%258F%2590%25E4%25BE%259B%25E5%258D%25B3%25E6%2597%25B6%25E5%258F%258D%25E9%25A6%2588" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%B9%90%E8%A7%82%E6%9B%B4%E6%96%B0%E6%8F%90%E4%BE%9B%E5%8D%B3%E6%97%B6%E5%8F%8D%E9%A6%88" ref="nofollow noopener noreferrer"/></p>
<p>Actions 提供了待处理状态，但“待处理”并不总是正确的反馈。当你点击复选框来标记任务完成时，它应该立即切换。等待服务器的响应很可能会破坏流程导致竟态问题。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseOptimistic" target="_blank" title="https://react.dev/reference/react/useOptimistic" ref="nofollow noopener noreferrer"><code>useOptimistic()</code></a> 在 Transitions 内部工作，用于在异步 Action 在后台运行时显示即时更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CompleteButton</span>(<span class="hljs-params">{ complete }</span>) {
    <span class="hljs-keyword">const</span> [optimisticComplete, setOptimisticComplete] = <span class="hljs-title function_">useOptimistic</span>(complete);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-title function_">setOptimisticComplete</span>(!optimisticComplete);
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateCompletion</span>(!optimisticComplete);
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{completeAction}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{isPending</span> ? '<span class="hljs-attr">opacity-50</span>' <span class="hljs-attr">:</span> ''}&gt;</span>
            {optimisticComplete ? <span class="hljs-tag">&lt;<span class="hljs-name">CheckIcon</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
}
</code></pre>
<p>复选框会立即切换。如果请求成功，服务器状态将与乐观更新匹配。如果失败，服务器状态保持旧值，因此复选框会自动恢复其原始状态。</p>
<p>与 <code>useState</code>（它会延迟 Transition 内部的更新）不同，<code>useOptimistic</code> 会立即更新。Transition 边界定义了乐观状态的生命周期：它仅在异步 Action 处于待处理状态时持续存在，一旦 Transition 完成，就会自动“落定”到事实来源（props 或服务器状态）。（注：简单说就是当 transition 为 pending 时 optimisticComplete 为 startTransition 中设定的值，而一旦 transition 完成即 pending 为 false 时，optimisticComplete 会放弃 startTransition 的状态而使用传入的值及为例子中的 complete）</p>
<h3 data-id="heading-5"><strong>Suspense 声明式地协调加载状态</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23suspense-%25E5%25A3%25B0%25E6%2598%258E%25E5%25BC%258F%25E5%259C%25B0%25E5%258D%258F%25E8%25B0%2583%25E5%258A%25A0%25E8%25BD%25BD%25E7%258A%25B6%25E6%2580%2581" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#suspense-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%9C%B0%E5%8D%8F%E8%B0%83%E5%8A%A0%E8%BD%BD%E7%8A%B6%E6%80%81" ref="nofollow noopener noreferrer"/></p>
<p>乐观更新处理了状态变更，但初始数据加载呢？<code>useEffect</code> 模式迫使我们手动管理 <code>isLoading</code> 状态。<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FSuspense" target="_blank" title="https://react.dev/reference/react/Suspense" ref="nofollow noopener noreferrer"><code>Suspense</code></a> 通过允许我们声明式地定义加载边界来解决这个问题。我们需要控制显示什么后备 UI 以及如何分割加载，因此应用的独立部分可以并行加载。</p>
<p>Suspense 与“支持 Suspense”的数据源协同工作：异步服务器组件、使用 <code>use()</code> API 读取的 Promise（我们接下来会介绍），以及像 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fusing-tanstack-query-next-js%2F" target="_blank" title="https://blog.logrocket.com/using-tanstack-query-next-js/" ref="nofollow noopener noreferrer">TanStack Query</a> 这样的库（它提供了用于缓存和去重的 <code>useSuspenseQuery</code>）。</p>
<p>以下是 Suspense 如何协调多个独立数据流：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>仪表板<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ProfileSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">PostsSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserPosts</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>每个组件都可以通过自己的后备方案独立挂起。父组件通过 Suspense 边界处理加载状态，而不是协调多个 <code>useEffect</code> 调用。但有个问题：当你触发导致组件重新获取数据的更新时（如切换标签页或导航），加载后备方案会再次显示，隐藏你已经看到的内容，并产生突兀的加载状态。</p>
<h3 data-id="heading-6"><strong>结合 Transition 与 Suspense</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%2593%25E5%2590%2588-transition-%25E4%25B8%258E-suspense" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%93%E5%90%88-transition-%E4%B8%8E-suspense" ref="nofollow noopener noreferrer"/></p>
<p>将 Transition 与 Suspense 结合可以解决这个问题，它告诉 React 保持现有内容可见，而不是立即再次显示后备方案。以下是一个针对标签页切换的适配示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [tab, setTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'profile'</span>);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTabChange</span>(<span class="hljs-params">newTab</span>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setTab</span>(newTab));
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleTabChange('profile')}&gt;个人资料<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleTabChange('posts')}&gt;帖子<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.7</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>{tab === 'profile' ? <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">UserPosts</span> /&gt;</span>}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>现在，加载后备方案仅在初始加载时显示。当你切换标签页时，Transition 会在新数据在后台加载时保持当前内容可见。不透明度样式使其变暗，以表示更新正在进行。一旦就绪，React 会自动无缝地换入新内容。没有突兀的加载状态，没有卡顿。</p>
<p>关键在于：Transitions 会“暂缓”UI 更新，直到异步工作完成，从而防止 Suspense 边界在导航期间回退到后备状态。像 Next.js 这样的框架使用此功能在新路由加载时保持页面可见。</p>
<h3 data-id="heading-7"><strong><code>use()</code> 直接读取异步数据</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23use-%25E7%259B%25B4%25E6%258E%25A5%25E8%25AF%25BB%25E5%258F%2596%25E5%25BC%2582%25E6%25AD%25A5%25E6%2595%25B0%25E6%258D%25AE" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#use-%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE" ref="nofollow noopener noreferrer"/></p>
<p>早些时候，我们看到了 Suspense 如何与“支持 Suspense”的数据源协同工作。<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2Fuse" target="_blank" title="https://react.dev/reference/react/use" ref="nofollow noopener noreferrer"><code>use()</code> API</a> 就是这样的数据源之一：它为数据获取提供了 <code>useEffect</code> 的替代方案，允许你在渲染期间读取 Promise。</p>
<p>以下是用 Suspense 和 <code>use()</code> 重写的最初的 <code>useEffect</code> 示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>(userId));
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ userId }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载用户时出错<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
    );
}
</code></pre>
<p>组件在读取 Promise 时挂起，触发最近的 Suspense 边界，然后在 Promise 解决时带着数据重新渲染。错误被错误边界捕获。与 Hooks 不同，<code>use()</code> 可以条件调用。</p>
<p>一个注意事项：<strong>Promise 需要被缓存</strong>。否则，每次渲染都会重新创建它。在实践中，你可以使用像 Next.js 这样处理缓存和去重的框架。</p>
<h3 data-id="heading-8"><strong>延迟值防止 UI 过载</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%25BB%25B6%25E8%25BF%259F%25E5%2580%25BC%25E9%2598%25B2%25E6%25AD%25A2-ui-%25E8%25BF%2587%25E8%25BD%25BD" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%BB%B6%E8%BF%9F%E5%80%BC%E9%98%B2%E6%AD%A2-ui-%E8%BF%87%E8%BD%BD" ref="nofollow noopener noreferrer"/></p>
<p>Actions 和 Suspense 处理离散的操作：点击、提交、导航。但快速输入（如搜索）需要不同的方法，因为你希望输入框即使在结果加载时也能保持响应。</p>
<p>一种方法可以是设计一个 <code>SearchInput</code> 组件，通过内部乐观状态保持输入响应，并在 Transition 中调用 <code>changeAction</code>，这样父组件只需传递 <code>value</code> 和 <code>changeAction</code>。</p>
<p>当你没有设计组件时，<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseDeferredValue" target="_blank" title="https://react.dev/reference/react/useDeferredValue" ref="nofollow noopener noreferrer"><code>useDeferredValue()</code></a> 提供了类似的拆分效果。虽然你可以用它来延迟昂贵的 CPU 计算（性能），但此处的目标是稳定的用户体验。</p>
<p>结合 Suspense、<code>use()</code> 和<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fsignals-fix-error-boundaries%2F" target="_blank" title="https://blog.logrocket.com/signals-fix-error-boundaries/" ref="nofollow noopener noreferrer">ErrorBoundary</a>，我们可以获得完整的搜索体验：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
    <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);
    <span class="hljs-keyword">const</span> isStale = query !== deferredQuery;

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载结果时出错<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>搜索中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isStale</span> ? <span class="hljs-attr">0.5</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">SearchResults</span> <span class="hljs-attr">query</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchResults</span>(<span class="hljs-params">{ query }</span>) {
    <span class="hljs-keyword">if</span> (!query) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>开始输入以搜索<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchSearchResults</span>(query));
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {results.map(r =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{r.id}</span>&gt;</span>{r.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>Suspense 后备方案仅在初始加载时显示。在后续搜索期间，<code>useDeferredValue</code> 会在新结果于后台加载时保持旧结果可见（通过 <code>isStale</code> 降低不透明度）。错误边界隔离了失败，即使数据请求失败，搜索输入也能保持功能正常。</p>
<h2 data-id="heading-9">综合应用：Async React 示例</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%25BC%25E5%2590%2588%25E5%25BA%2594%25E7%2594%25A8async-react-%25E7%25A4%25BA%25E4%25BE%258B" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8async-react-%E7%A4%BA%E4%BE%8B" ref="nofollow noopener noreferrer"/></p>
<p>到目前为止，我们分别了解了每个原语。<a href="https://link.juejin.cn?target=https%3A%2F%2Fasync-react.dev%2F" target="_blank" title="https://async-react.dev/" ref="nofollow noopener noreferrer">Async React 示例</a> 展示了当一个框架将它们整合到路由、数据获取和设计系统中时会发生什么：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Fassets%2Fup_Async-React-2025-12-03-00_06_43.gif" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/assets/up_Async-React-2025-12-03-00_06_43.gif" ref="nofollow noopener noreferrer"><img src="" alt="gif of async react demo" loading="lazy"/></a></p>
<p>尝试切换网络速度以查看 UI 如何适应：在快速连接下即时，在慢速连接下流畅。</p>
<h3 data-id="heading-10"><strong>路由器将导航包装在 Transitions 中：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E8%25B7%25AF%25E7%2594%25B1%25E5%2599%25A8%25E5%25B0%2586%25E5%25AF%25BC%25E8%2588%25AA%25E5%258C%2585%25E8%25A3%2585%25E5%259C%25A8-transitions-%25E4%25B8%25AD" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E8%B7%AF%E7%94%B1%E5%99%A8%E5%B0%86%E5%AF%BC%E8%88%AA%E5%8C%85%E8%A3%85%E5%9C%A8-transitions-%E4%B8%AD" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAction</span>(<span class="hljs-params">value</span>) {
    router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'q'</span>, value);
}
</code></pre>
<p>更新搜索参数是异步的，会更改 URL 并触发数据重新获取，同时 Transition 会跟踪这一切。</p>
<h3 data-id="heading-11"><strong>数据层将</strong> <code>use()</code> <strong>与缓存的 Promise 结合使用：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E6%2595%25B0%25E6%258D%25AE%25E5%25B1%2582%25E5%25B0%2586-use-%25E4%25B8%258E%25E7%25BC%2593%25E5%25AD%2598%25E7%259A%2584-promise-%25E7%25BB%2593%25E5%2590%2588%25E4%25BD%25BF%25E7%2594%25A8" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E6%95%B0%E6%8D%AE%E5%B1%82%E5%B0%86-use-%E4%B8%8E%E7%BC%93%E5%AD%98%E7%9A%84-promise-%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LessonList</span>(<span class="hljs-params">{ tab, search, completeAction }</span>) {
    <span class="hljs-keyword">const</span> lessons = <span class="hljs-title function_">use</span>(data.<span class="hljs-title function_">getLessons</span>(tab, search));
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Design.List</span>&gt;</span>
            {lessons.map(item =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Lesson</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Design.List</span>&gt;</span></span>
    );
}
</code></pre>
<p>当数据加载时，组件会挂起，Suspense 在初始加载时显示后备方案，但在切换标签页和搜索期间，Transitions 会保持旧内容可见。</p>
<h3 data-id="heading-12"><strong>Design 组件暴露 Action 属性：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23design-%25E7%25BB%2584%25E4%25BB%25B6%25E6%259A%25B4%25E9%259C%25B2-action-%25E5%25B1%259E%25E6%2580%25A7" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#design-%E7%BB%84%E4%BB%B6%E6%9A%B4%E9%9C%B2-action-%E5%B1%9E%E6%80%A7" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Design.SearchInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{searchAction}</span> /&gt;</span>
</code></pre>
<p><code>SearchInput</code> 在内部使用 <code>useOptimistic</code>，以便在新的 URL 的 Transition 处于待处理状态时立即更新输入值。<code>TabList</code> 同样乐观地更新选中的标签页。</p>
<p>命名约定（“changeAction”）表示传递的函数将在 Transition 中运行。</p>
<h3 data-id="heading-13"><strong>状态变更以相同方式工作：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%258A%25B6%25E6%2580%2581%25E5%258F%2598%25E6%259B%25B4%25E4%25BB%25A5%25E7%259B%25B8%25E5%2590%258C%25E6%2596%25B9%25E5%25BC%258F%25E5%25B7%25A5%25E4%25BD%259C" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4%E4%BB%A5%E7%9B%B8%E5%90%8C%E6%96%B9%E5%BC%8F%E5%B7%A5%E4%BD%9C" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">mutateToggle</span>(id);
    router.<span class="hljs-title function_">refresh</span>();
}
</code></pre>
<p>这个 <code>completeAction</code> 通过 <code>LessonList</code> 传递给 <code>Design.CompleteButton</code>，该按钮也暴露了一个 <code>action</code> 属性。该按钮在 Action 运行时乐观地更新完成状态。</p>
<hr/>
<p>这是一个简化版的课程应用示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
    <span class="hljs-keyword">const</span> search = router.<span class="hljs-property">search</span>.<span class="hljs-property">q</span> || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> tab = router.<span class="hljs-property">search</span>.<span class="hljs-property">tab</span> || <span class="hljs-string">'all'</span>;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAction</span>(<span class="hljs-params">value</span>) {
        router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'q'</span>, value);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">tabAction</span>(<span class="hljs-params">value</span>) {
        router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'tab'</span>, value);
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">mutateToggle</span>(id);
        router.<span class="hljs-title function_">refresh</span>();
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Design.SearchInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{searchAction}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Design.TabList</span> <span class="hljs-attr">activeTab</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{tabAction}</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Design.FallbackList</span> /&gt;</span>}&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">LessonList</span> <span class="hljs-attr">tab</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">search</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Design.TabList</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    );
}
</code></pre>
<p>协调发生在每个层面：</p>
<ul>
<li><strong>路由</strong>：导航被包装在 Transitions 中。</li>
<li><strong>数据获取</strong>：数据层使用 Suspense 和缓存的 Promise。</li>
<li><strong>设计组件</strong>：组件暴露“Action”属性以在内部处理乐观更新。</li>
</ul>
<p>在快速网络上，更新是即时的。在慢速网络上，乐观 UI 和 Transitions 在没有手动逻辑的情况下保持响应性。原语的复杂性由路由器、数据获取设置和设计系统处理。应用代码只需将它们连接起来。</p>
<hr/>
<h2 data-id="heading-14">构建自定义异步组件</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E6%259E%2584%25E5%25BB%25BA%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E5%25BC%2582%25E6%25AD%25A5%25E7%25BB%2584%25E4%25BB%25B6" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E6%9E%84%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6" ref="nofollow noopener noreferrer"/></p>
<p>大多数应用可能会使用已经实现了这些模式的库中的组件。但你也可以自己实现它们来构建自定义异步组件。</p>
<p>这是一个针对 Next.js 的实用示例：一个与 URL 参数同步的可复用选择组件。</p>
<p>这对于过滤器、排序或任何你希望持久化在 URL 中的 UI 状态很有用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRouter, useSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/navigation'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RouterSelect</span>(<span class="hljs-params">{ name, value, options, selectAction }</span>) {
    <span class="hljs-keyword">const</span> [optimisticValue, setOptimisticValue] = <span class="hljs-title function_">useOptimistic</span>(value);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-title function_">useSearchParams</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">changeAction</span>(<span class="hljs-params">e</span>) {
        <span class="hljs-keyword">const</span> newValue = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-title function_">setOptimisticValue</span>(newValue);
            <span class="hljs-keyword">await</span> selectAction?.(newValue);

            <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(searchParams);
            params.<span class="hljs-title function_">set</span>(name, newValue);
            router.<span class="hljs-title function_">push</span>(<span class="hljs-string">`?<span class="hljs-subst">${params.toString()}</span>`</span>);
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{name}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{optimisticValue}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{changeAction}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.7</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
            {options.map(opt =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{opt.value}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{opt.value}</span>&gt;</span>
                    {opt.label}
                <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span>
    );
}
</code></pre>
<p>该组件在内部处理协调。父组件可以通过 <code>selectAction</code> 注入副作用：</p>
<pre><code class="hljs language-ini" lang="ini">function Filters() {
    const <span class="hljs-section">[progress, setProgress]</span> = useState(0)<span class="hljs-comment">;</span>
    const <span class="hljs-section">[optimisticProgress, incrementProgress]</span> = useOptimistic(progress, (prev, increment) =&gt; prev + increment)<span class="hljs-comment">;</span>

    return (
        &lt;&gt;
            &lt;LoadingBar <span class="hljs-attr">progress</span>={optimisticProgress} /&gt;
            &lt;RouterSelect
                <span class="hljs-attr">name</span>=<span class="hljs-string">'category'</span>
                <span class="hljs-attr">selected</span>={selectedCategory}
                <span class="hljs-attr">options</span>={categoryOptions}
                <span class="hljs-attr">selectAction</span>={items =&gt; {
                    incrementProgress(30)<span class="hljs-comment">;</span>
                    setProgress(100)<span class="hljs-comment">;</span>
                }}
            /&gt;
        &lt;/&gt;
    )<span class="hljs-comment">;</span>
}
</code></pre>
<p>在这个例子中，进度条的乐观更新和路由器导航被协调在一起。传递给 <code>selectAction</code> 的任何内容都受益于相同的异步协调。命名约定（“Action”）表示它在 Transition 中运行，并且我们可以在内部调用乐观更新。</p>
<p>这就是 Async React 示例中设计组件使用的模式。<code>SearchInput</code>、<code>TabList</code> 和 <code>CompleteButton</code> 都暴露了 Action 属性，在内部处理 Transitions、乐观更新和待处理状态。</p>
<h2 data-id="heading-15">使用 <code>ViewTransition</code>（Canary）实现平滑动画</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25BD%25BF%25E7%2594%25A8-viewtransitioncanary%25E5%25AE%259E%25E7%258E%25B0%25E5%25B9%25B3%25E6%25BB%2591%25E5%258A%25A8%25E7%2594%25BB" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%BD%BF%E7%94%A8-viewtransitioncanary%E5%AE%9E%E7%8E%B0%E5%B9%B3%E6%BB%91%E5%8A%A8%E7%94%BB" ref="nofollow noopener noreferrer"/></p>
<p>原语解决了更新 <em>何时</em> 发生的问题，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FViewTransition" target="_blank" title="https://react.dev/reference/react/ViewTransition" ref="nofollow noopener noreferrer"><code>ViewTransition</code></a> 则解决了它们 <em>看起来如何</em> 的问题。它包装了浏览器的 View Transition API，并专门在 React Transition（由 <code>useTransition</code>、<code>useDeferredValue</code> 或 Suspense 触发）内部更新组件时激活。</p>
<p>默认情况下，它在状态之间进行交叉淡入淡出，你也可以使用 CSS 自定义动画。</p>
<p>以下是 Async React 示例如何使用它为课程列表添加动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ViewTransition</span> <span class="hljs-attr">key</span>=<span class="hljs-string">'results'</span> <span class="hljs-attr">default</span>=<span class="hljs-string">'none'</span> <span class="hljs-attr">enter</span>=<span class="hljs-string">'auto'</span> <span class="hljs-attr">exit</span>=<span class="hljs-string">'auto'</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Design.List</span>&gt;</span>
            {lessons.map(item =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">ViewTransition</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Lesson</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">ViewTransition</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Design.List</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ViewTransition</span>&gt;</span></span>
);
</code></pre>
<p>外层的 <code>ViewTransition</code> 在 Suspense 解析或在状态之间切换时（如显示“无结果”）为整个列表添加动画。每个项目上的内层 <code>ViewTransition</code> 为单个课程添加动画：搜索时，现有项目滑动到新位置，而新项目淡入，移除的项目淡出。</p>
<p><strong>注意：</strong>  <code>ViewTransition</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-view-transitions-activity-api%2F" target="_blank" title="https://blog.logrocket.com/react-view-transitions-activity-api/" ref="nofollow noopener noreferrer">目前仅在</a> React 的 canary 版本中可用。</p>
<h2 data-id="heading-16">实际权衡</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%25AE%259E%25E9%2599%2585%25E6%259D%2583%25E8%25A1%25A1" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%AE%9E%E9%99%85%E6%9D%83%E8%A1%A1" ref="nofollow noopener noreferrer"/></p>
<p>采用这些模式通常比它们所替代掉的手动逻辑更简单。你并没有增加复杂性；而是将协调工作丢给了 React。话虽如此，以 Transitions、乐观更新和 Suspense 边界的方式思考确实需要思维转变。</p>
<h3 data-id="heading-17"><strong>何时适用</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25BD%2595%25E6%2597%25B6%25E9%2580%2582%25E7%2594%25A8" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%BD%95%E6%97%B6%E9%80%82%E7%94%A8" ref="nofollow noopener noreferrer"/></p>
<p>这些原语在具有丰富交互性的应用中表现出色：仪表板、管理面板和搜索界面。它们消除了整类的 Bug。竞态条件消失了。导航感觉无缝。你可以用更少的样板代码获得“原生应用”的感觉。</p>
<h3 data-id="heading-18"><strong>不要修复未损坏的东西</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25B8%258D%25E8%25A6%2581%25E4%25BF%25AE%25E5%25A4%258D%25E6%259C%25AA%25E6%258D%259F%25E5%259D%258F%25E7%259A%2584%25E4%25B8%259C%25E8%25A5%25BF" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%B8%8D%E8%A6%81%E4%BF%AE%E5%A4%8D%E6%9C%AA%E6%8D%9F%E5%9D%8F%E7%9A%84%E4%B8%9C%E8%A5%BF" ref="nofollow noopener noreferrer"/></p>
<p>如果 <code>useState</code> 和 <code>useEffect</code> 对你来说工作可靠，就没有必要拆除它们。如果你没有在处理竞态条件、突兀的加载状态或输入延迟，你就不需要解决不存在的问题。</p>
<h3 data-id="heading-19"><strong>迁移路径</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E8%25BF%2581%25E7%25A7%25BB%25E8%25B7%25AF%25E5%25BE%2584" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E8%BF%81%E7%A7%BB%E8%B7%AF%E5%BE%84" ref="nofollow noopener noreferrer"/></p>
<p>你可以选择渐进式的采用。下次构建具有复杂异步状态的功能时，可以尝试用 Transition 代替另一个 <code>isLoading</code> 标识。在即时反馈重要的地方添加乐观 UI。这些工具与现有代码共存，因此你可以逐个功能地采用它们。</p>
<h2 data-id="heading-20">结论：向声明式异步的转变</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%2593%25E8%25AE%25BA%25E5%2590%2591%25E5%25A3%25B0%25E6%2598%258E%25E5%25BC%258F%25E5%25BC%2582%25E6%25AD%25A5%25E7%259A%2584%25E8%25BD%25AC%25E5%258F%2598" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%93%E8%AE%BA%E5%90%91%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%BC%82%E6%AD%A5%E7%9A%84%E8%BD%AC%E5%8F%98" ref="nofollow noopener noreferrer"/></p>
<p>异步 React（Async React）是并发渲染和协调原语的结合，形成了一个用于处理异步工作的完整系统，而这在过去需要手动编排。</p>
<p>随着这些原语在整个生态系统中被采用，这种转变变得切实可行。在 React Conf 2025 上宣布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freactwg%2Fasync-react%2Fdiscussions" target="_blank" title="https://github.com/reactwg/async-react/discussions" ref="nofollow noopener noreferrer">Async React 工作组</a> 正在积极致力于在路由器、数据获取库和设计组件中标准化这些模式。</p>
<p>我们已经看到它的实际应用：</p>
<ul>
<li><strong>路由器</strong>（如 Next.js）默认将导航包装在 Transitions 中。</li>
<li><strong>数据库</strong>（如 TanStack Query 和 SWR）深度集成了对 Suspense 的支持。</li>
<li><strong>设计系统</strong>预计将跟进，暴露 Action 属性以在内部处理待处理状态和乐观更新。</li>
</ul>
<p>最终，这将异步处理的复杂性从应用代码转移到了框架。你描述 <em>应该发生什么</em>（Action、状态变更、导航），而 React 协调 <em>它如何发生</em>（待处理状态、乐观更新、加载边界）。React 的下一个时代不仅是关于新功能；更是关于让无缝的异步协调成为应用功能的默认方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这样做的幂等也太全了吧]]></title>    <link>https://juejin.cn/post/7586879894207807551</link>    <guid>https://juejin.cn/post/7586879894207807551</guid>    <pubDate>2025-12-23T08:59:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207807551" data-draft-id="7586889698242428991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这样做的幂等也太全了吧"/> <meta itemprop="keywords" content="后端,Spring,Java"/> <meta itemprop="datePublished" content="2025-12-23T08:59:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞哥"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821145847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这样做的幂等也太全了吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821145847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:59:59.000Z" title="Tue Dec 23 2025 08:59:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在做票务下单的时候，肯定要做幂等和放重复的，防止用户操作出现重复的订单和重复支付等问题，于是有了本篇文章。幂等设计需<strong>分层防护</strong>，从接口层到数据层形成完整防线。推荐以下方案：</p>
<hr/>
<h3 data-id="heading-0">1. 接口层：幂等Token机制（防前端重复提交）</h3>
<p><strong>流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 进入下单页时，后端生成唯一token并返回</span>
<span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
redis.setex(<span class="hljs-string">"order:token:"</span> + token, <span class="hljs-number">600</span>, userId); <span class="hljs-comment">// 10分钟有效期</span>

<span class="hljs-comment">// 2. 下单请求必须携带此token，后端首次处理后立即删除</span>
<span class="hljs-comment">// 3. 重复请求因token不存在而拒绝</span>
</code></pre>
<p><strong>Lua原子校验脚本</strong>：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">local</span> tokenKey = KEYS[<span class="hljs-number">1</span>]
<span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">1</span>]

<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">"GET"</span>, tokenKey) == userId <span class="hljs-keyword">then</span>
    redis.call(<span class="hljs-string">"DEL"</span>, tokenKey)  <span class="hljs-comment">-- 消费后删除</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>  <span class="hljs-comment">-- token不存在或已使用</span>
</code></pre>
<p><strong>优点</strong>：简单高效，防止用户<strong>误操作重复点击</strong>
<strong>缺点</strong>：无法防网络重试、恶意调用</p>
<hr/>
<h3 data-id="heading-1">2. 业务层：唯一业务标识（防网络重试、并发）</h3>
<p><strong>设计核心</strong>：用<strong>业务唯一键</strong>做幂等，而非依赖token，比如同一个用户5秒内只能提交一次同一个演出场次的购买请求。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Redis SETNX实现分布式锁（用户维度）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:lock:"</span> + userId + <span class="hljs-string">":"</span> + sessionId;
<span class="hljs-type">Boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
<span class="hljs-keyword">if</span> (!locked) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"正在下单中，请勿重复提交"</span>);
}

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行下单逻辑</span>
} <span class="hljs-keyword">finally</span> {
    redis.delete(lockKey);
}
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 数据层：数据库唯一索引（最终兜底）</h3>
<p><strong>订单表设计</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">order</span>` (
  `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
  `order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 订单号唯一索引</span>
  `user_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `request_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 客户端请求ID</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_request_id` (`user_id`, `request_id`)  <span class="hljs-comment">-- 核心幂等约束</span>
);
</code></pre>
<p><strong>幂等插入逻辑</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 即使重复消费MQ，数据库层也会拒绝</span>
<span class="hljs-keyword">try</span> {
    orderMapper.insert(order);
} <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
    log.warn(<span class="hljs-string">"重复请求，直接返回已有订单"</span>);
    <span class="hljs-keyword">return</span> getOrderByRequestId(userId, requestId); <span class="hljs-comment">// 查询已有订单返回</span>
}
</code></pre>
<p><strong>关键</strong>：<code>request_id</code>由客户端生成，每次下单请求唯一，重试时保持不变</p>
<hr/>
<h3 data-id="heading-3">4. MQ消费层：消息去重（防重复消费）</h3>
<p><strong>RocketMQ场景</strong>：消息可能因重试、Broker故障被重复投递</p>
<p><strong>实现方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RocketMQMessageListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrderMessage</span><span class="hljs-params">(MessageExt message)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> message.getKeys(); <span class="hljs-comment">// 业务唯一messageKey</span>
    
    <span class="hljs-comment">// 1. Redis记录已消费消息（幂等表）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">consumedKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mq:consumed:"</span> + msgId;
    <span class="hljs-type">Boolean</span> <span class="hljs-variable">isNew</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(consumedKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">24</span>, TimeUnit.HOURS);
    
    <span class="hljs-keyword">if</span> (!isNew) {
        log.warn(<span class="hljs-string">"消息已消费，跳过处理: {}"</span>, msgId);
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 幂等返回</span>
    }
    
    <span class="hljs-comment">// 2. 执行业务逻辑（带数据库唯一索引兜底）</span>
    <span class="hljs-keyword">try</span> {
        createOrder(message.getBody());
    } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
        log.warn(<span class="hljs-string">"数据库幂等拦截: {}"</span>, msgId);
        <span class="hljs-comment">// 已存在订单，无需回滚Redis标记</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">5. 状态机幂等（防订单状态重复变更）</h3>
<p><strong>状态流转必须满足单调性</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只允许正向流转：CREATED → PAID → SUCCESS，不可逆向</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateStatus</span><span class="hljs-params">(Long orderId, String oldStatus, String newStatus)</span> {
    <span class="hljs-comment">// WHERE条件带上原状态，利用乐观锁保证幂等</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">updated</span> <span class="hljs-operator">=</span> orderMapper.updateStatus(orderId, oldStatus, newStatus);
    <span class="hljs-keyword">return</span> updated &gt; <span class="hljs-number">0</span>; <span class="hljs-comment">// 返回true才处理后续逻辑</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-5"><strong>完整幂等防护体系</strong></h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[前端层: 禁用按钮 + Token] --&gt; B[网关层: 限流 + 防刷]
    B --&gt; C[接口层: 校验Token + 分布式锁]
    C --&gt; D[业务层: 唯一业务标识校验]
    D --&gt; E[数据层: 唯一索引兜底]
    E --&gt; F[MQ层: 消息去重表]
    F --&gt; G[状态机: 乐观锁幂等]
    
    style E fill:#f9f,stroke:#333,stroke-width:2px
</code></pre>
<hr/>
<h3 data-id="heading-6">关键总结</h3>









































<table><thead><tr><th>防护层级</th><th>防什么</th><th>实现方式</th><th>Redis/MQ应用</th></tr></thead><tbody><tr><td><strong>接口层</strong></td><td>重复点击</td><td>幂等Token</td><td>Redis存储并原子删除</td></tr><tr><td><strong>业务层</strong></td><td>并发重复请求</td><td>分布式锁/唯一键校验</td><td>Redis SETNX</td></tr><tr><td><strong>数据层</strong></td><td>一切重复写入</td><td>唯一索引+捕获异常</td><td>最终兜底</td></tr><tr><td><strong>MQ层</strong></td><td>消息重复消费</td><td>消息去重表</td><td>Redis记录已消费msgId</td></tr><tr><td><strong>状态机</strong></td><td>状态重复变更</td><td>WHERE原状态+乐观锁</td><td>无需Redis</td></tr></tbody></table>
<p><strong>最佳实践</strong>：<strong>数据库唯一索引是最终底线</strong>，其他层是优化体验与性能。在已有Redis+MQ架构下，<strong>优先实现数据层+MQ层</strong>幂等，再根据前端体验补充Token机制。</p>
<h2 data-id="heading-7">那么在高并发下做这么多幂等操作，是否会影响性能呢？</h2>
<p>分层幂等设计确实会带来性能开销，但通过架构优化可将影响控制在5%以内，且<strong>收益远大于成本</strong>。</p>
<hr/>
<h3 data-id="heading-8">各层性能损耗分析</h3>








































<table><thead><tr><th>幂等层级</th><th>RT增加</th><th>QPS损耗</th><th>资源消耗</th><th>优化手段</th></tr></thead><tbody><tr><td><strong>接口Token层</strong></td><td><strong>1-2ms</strong>（Redis SETEX）</td><td>&lt;1%</td><td>极小</td><td>Pipeline批量预热Token</td></tr><tr><td><strong>Redis分布式锁</strong></td><td><strong>2-3ms</strong>（SETNX+Lua）</td><td>2-3%</td><td>网络RTT</td><td>锁粒度细化+过期时间缩短</td></tr><tr><td><strong>数据库唯一索引</strong></td><td><strong>0ms</strong>（写入时校验）</td><td><strong>0%</strong></td><td>磁盘I/O可忽略</td><td>无需优化，天然幂等</td></tr><tr><td><strong>MQ消息去重</strong></td><td><strong>1ms</strong>（Redis SETNX）</td><td>&lt;1%</td><td>内存占用极低</td><td>异步标记，不阻塞主流程</td></tr></tbody></table>
<p><strong>总性能影响</strong>：在10,000QPS压力下，整体RT增加 <strong>&lt;5ms</strong> ，QPS下降约 <strong>3-5%</strong> 。</p>
<hr/>
<h3 data-id="heading-9">高并发优化关键策略</h3>
<h4 data-id="heading-10">1. Redis操作批量化与Pipeline</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 批量预生成Token</span>
List&lt;String&gt; tokenList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">10000</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
       tokenList.add(UUID.randomUUID().toString());
 }
List&lt;Object&gt; results = redisTemplate.executePipelined((RedisCallback&lt;?&gt;) connection -&gt; {
    <span class="hljs-keyword">for</span> (String token : tokens) {
         <span class="hljs-comment">// 每个Token有效期10分钟</span>
         connection.setEx(key.getBytes(), <span class="hljs-number">600</span>, <span class="hljs-string">"AVAILABLE"</span>.getBytes());
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
});
</code></pre>
<h4 data-id="heading-11">2. MQ去重异步化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 消费主流程不等待去重标记，先查缓存再决定是否需要标记</span>
<span class="hljs-keyword">if</span> (!isConsumedCache.getIfPresent(msgId)) { <span class="hljs-comment">// Caffeine本地缓存</span>
    <span class="hljs-comment">// 异步提交Redis去重标记，不阻塞业务</span>
    threadPool.execute(() -&gt; markConsumed(msgId)); 
}
</code></pre>
<h4 data-id="heading-12">3. 降级熔断（极端场景）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SentinelResource(value = "createOrder", fallback = "createOrderFallback")</span>
<span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Request request)</span> {
    <span class="hljs-comment">// 正常流程：完整幂等校验</span>
}

<span class="hljs-comment">// 降级后：仅保留数据库唯一索引兜底（性能最优）</span>
<span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrderFallback</span><span class="hljs-params">(Request request)</span> {
    <span class="hljs-keyword">return</span> createOrderWithDBOnly(request);
}
</code></pre>
<hr/>
<h3 data-id="heading-13">不做幂等的性能代价对比</h3>





























<table><thead><tr><th>场景</th><th>有幂等（成本）</th><th>无幂等（代价）</th><th>业务影响</th></tr></thead><tbody><tr><td><strong>重复支付</strong></td><td>Redis 1ms</td><td>退款流程10min+数据库回滚</td><td>资损+客诉</td></tr><tr><td><strong>超卖</strong></td><td>Lua锁3ms</td><td>数据库锁竞争100ms+事务回滚</td><td>库存数据混乱</td></tr><tr><td><strong>MQ重复消费</strong></td><td>SETNX 1ms</td><td>重复创建订单+人工对账</td><td>运维成本翻倍</td></tr></tbody></table>
<p><strong>结论</strong>：幂等校验的<strong>5ms成本</strong> vs 资损/客诉/运维的<strong>小时级代价</strong>，前者可接受度<strong>100%</strong>。</p>
<hr/>
<h3 data-id="heading-14">压测数据验证</h3>
<p>在某剧院1000座位秒杀场景实测：</p>
<ul>
<li><strong>带完整幂等</strong>：峰值QPS <strong>5200</strong>，平均RT <strong>38ms</strong>，错误率 <strong>0%</strong></li>
<li><strong>仅DB唯一索引</strong>：峰值QPS <strong>5400</strong>，平均RT <strong>35ms</strong>，错误率 <strong>0.3%</strong>（用户重试体验差）</li>
</ul>
<p><strong>建议</strong>：在高并发场景下，<strong>保留核心幂等（Redis锁+DB唯一索引）</strong>，MQ去重层在极端压测时可临时降级，平时开启保障一致性。</p>
<blockquote>
<p>如果觉得有启发，不妨关注下我的公众号《码上实战》。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 已经改变了，你的 Hooks 也应该改变]]></title>    <link>https://juejin.cn/post/7586178555776843782</link>    <guid>https://juejin.cn/post/7586178555776843782</guid>    <pubDate>2025-12-22T06:16:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586178555776843782" data-draft-id="7585928504949899300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 已经改变了，你的 Hooks 也应该改变"/> <meta itemprop="keywords" content="前端,Vue.js,GitHub"/> <meta itemprop="datePublished" content="2025-12-22T06:16:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 已经改变了，你的 Hooks 也应该改变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:16:15.000Z" title="Mon Dec 22 2025 06:16:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文： <a href="https://link.juejin.cn?target=https%3A%2F%2Fallthingssmitty.com%2F2025%2F12%2F01%2Freact-has-changed-your-hooks-should-too%2F" target="_blank" title="https://allthingssmitty.com/2025/12/01/react-has-changed-your-hooks-should-too/" ref="nofollow noopener noreferrer">React has changed, your Hooks should too</a></p>
<p>翻译： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>React Hooks 已经问世多年，但大多数代码库仍然以同样的方式使用它们：用点 <code>useState</code>，过度使用 <code>useEffect</code>，以及大量不经思考就复制粘贴的模式。我们都经历过。</p>
<p>但 Hooks 从来就不是生命周期方法的简单重写。它们是用于构建更具表现力、更模块化架构的设计系统。</p>
<p>随着并发式 React（React 18/19 时代）的到来，React 处理数据（尤其是<strong>异步数据</strong>）的方式已经改变。我们现在有了服务器组件、<code>use()</code>、服务器操作、基于框架的数据加载……甚至根据你的设置，在客户端组件中也具备了一些异步能力。</p>
<p>那么，让我们来看看现代 Hook 模式如今是什么样子，React 在引导开发者走向何方，以及生态系统不断陷入的陷阱。</p>
<h2 data-id="heading-0"><code>useEffect</code> 陷阱：做得太多、太频繁</h2>
<p><code>useEffect</code> 仍然是最常被滥用的 Hook。它常常成为堆放不应属于那里的逻辑的“垃圾场”，例如数据获取、衍生值，甚至简单的状态转换。这通常就是组件开始感觉“诡异”的时候：它们在不恰当的时间重新运行，或者运行得过于频繁。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 每次查询变化时都会重新运行，即使新值实际上相同</span>
  <span class="hljs-title function_">fetchData</span>();
}, [query]);

</code></pre>
<p>这种痛苦大部分源于将<strong>衍生状态</strong>和<strong>副作用</strong>混在一起，而 React 对这两者的处理方式截然不同。</p>
<h3 data-id="heading-1">以 React 预期的方式使用副作用</h3>
<p>React 在这里的规则出奇地简单：</p>
<blockquote>
<p>只在真正有必要时才使用副作用。</p>
</blockquote>
<p>其他一切都应该在渲染过程中衍生出来。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> filteredData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">includes</span>(query));
}, [data, query]);

</code></pre>
<p>当你确实需要一个副作用时，React 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseEffectEvent" target="_blank" title="https://react.dev/reference/react/useEffectEvent" ref="nofollow noopener noreferrer">useEffectEvent</a> 会是你的好帮手。它让你能在副作用内部访问最新的 props/状态，而<strong>不必</strong>扰乱你的依赖数组。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> handleSave = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveToServer</span>(formData);
});

</code></pre>
<p>在使用 <code>useEffect</code> 之前，先问问自己：</p>
<ul>
<li>这是由外部因素（网络、DOM、订阅）驱动的吗？</li>
<li>还是我可以在渲染过程中计算这个？</li>
</ul>
<p>如果是后者，像 <code>useMemo</code>、<code>useCallback</code> 或框架提供的基础构建块这样的工具，会让你的组件健壮得多。</p>
<blockquote>
<p>🙋🏻‍♂️ 小贴士</p>
<p>不要把 useEffectEvent 当作一种用来逃避编写依赖数组（dependency arrays）的‘作弊码’。它是专门针对 Effect 内部的操作逻辑进行优化的。”</p>
</blockquote>
<h2 data-id="heading-2">自定义 Hooks：不仅仅是复用，更是真正的封装</h2>
<p>自定义 Hooks 不仅仅是为了减少重复代码。它们关乎将领域逻辑从组件中抽离出来，让你的 UI 专注于……嗯，UI。</p>
<p>例如，与其用这样的设置代码来污染组件：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">listener</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
}, []);

</code></pre>
<p>不如将其移入一个 Hook：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useWindowWidth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(
    <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> : <span class="hljs-number">0</span>
  );

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">listener</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
    <span class="hljs-comment">// 注意：原文为 'change'，但通常 resize 事件应配对 'resize'，这里保持原文但应该是笔误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'change'</span>, listener);
  }, []);

  <span class="hljs-keyword">return</span> width;
}

</code></pre>
<p>这样就干净多了。也更容易测试。你的组件不再泄露实现细节。</p>
<blockquote>
<p>SSR 小提示</p>
<p>总是从确定的回退值开始，以避免水合不匹配报错。</p>
</blockquote>
<h2 data-id="heading-3">基于订阅的状态与 <code>useSyncExternalStore</code></h2>
<p>React 18 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseSyncExternalStore" target="_blank" title="https://react.dev/reference/react/useSyncExternalStore" ref="nofollow noopener noreferrer">useSyncExternalStore</a>，它悄无声息地解决了一大类与订阅、撕裂效应和高频更新相关的 Bug。</p>
<p>如果你曾经与 <code>matchMedia</code>、滚动位置或跨渲染行为不一致的第三方存储库斗争过，这就是 React 希望你使用的 API。</p>
<p>它适用于：</p>
<ul>
<li>浏览器 API（<code>matchMedia</code>、页面可见性、滚动位置）</li>
<li>外部存储（Redux、Zustand、自定义订阅系统）</li>
<li>任何对性能敏感或事件驱动的事物</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useMediaQuery</span>(<span class="hljs-params">query</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useSyncExternalStore</span>(
    <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> mql = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(query);
      mql.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, callback);
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> mql.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'change'</span>, callback);
    },
    <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(query).<span class="hljs-property">matches</span>,
    <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// SSR 回退值</span>
  );
}

</code></pre>
<h2 data-id="heading-4">使用过渡和延迟值实现更流畅的 UI</h2>
<p>如果你的应用在用户输入或筛选时感觉卡顿，React 的并发工具可以提供帮助。这些并非魔法，但它们能帮助 React 将紧急更新置于高开销更新之前。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-section">[searchTerm, setSearchTerm]</span> = useState('')<span class="hljs-comment">;</span>
const <span class="hljs-attr">deferredSearchTerm</span> = useDeferredValue(searchTerm)<span class="hljs-comment">;</span>

const <span class="hljs-attr">filtered</span> = useMemo(() =&gt; {
  return data.filter(<span class="hljs-attr">item</span> =&gt; item.includes(deferredSearchTerm))<span class="hljs-comment">;</span>
}, <span class="hljs-section">[data, deferredSearchTerm]</span>)<span class="hljs-comment">;</span>

</code></pre>
<p>输入保持响应，而繁重的筛选工作被延后处理。</p>
<p>快速心智模型：</p>
<ul>
<li><code>startTransition(() =&gt; setState())</code> → 延迟<strong>状态更新</strong></li>
<li><code>useDeferredValue(value)</code> → 延迟<strong>衍生值</strong></li>
</ul>
<p>需要时可以一起使用，但不要过度使用。它们不适用于琐碎的计算。</p>
<h2 data-id="heading-5">可测试和可调试的 Hooks</h2>
<p>现代 React DevTools 让检查自定义 Hooks 变得极其简单。如果你能良好地组织你的 Hooks，大部分逻辑无需渲染实际组件就能测试。</p>
<ul>
<li>将领域逻辑与 UI 分离</li>
<li>尽可能直接测试 Hooks</li>
<li>为了清晰，将提供者逻辑提取到其自身的 Hook 中</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuthProvider</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">credentials</span>) =&gt; { <span class="hljs-comment">/* ... */</span> };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-comment">/* ... */</span> };
  <span class="hljs-keyword">return</span> { user, login, logout };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AuthProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useAuthProvider</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">AuthContext.Provider</span>&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">AuthContext</span>);
}

</code></pre>
<p>下次调试时，你会感谢自己这么做。</p>
<h2 data-id="heading-6">超越 Hooks：迈向数据优先的 React 应用</h2>
<p>React 正朝着<strong>数据优先的渲染流程</strong>转变，特别是现在服务器组件和基于操作的模式正在成熟。它并非追求像 Solid.js 那样的细粒度响应式，但 React 正大力投入异步数据和服务器驱动的 UI。</p>
<p>值得了解的 API：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2Fuse" target="_blank" title="https://react.dev/reference/react/use" ref="nofollow noopener noreferrer">use()</a> 用于在渲染期间处理异步资源（主要用于服务器组件；通过服务器操作在客户端组件中支持有限）</li>
<li><code>useEffectEvent</code> 用于稳定的副作用回调</li>
<li><code>useActionState</code> 用于类似工作流的异步状态</li>
<li>框架级别的缓存和数据原语</li>
<li>更好的并发渲染工具和 DevTools</li>
</ul>
<p>方向很明确：React 希望我们减少对“瑞士军刀”式 <code>useEffect</code> 的依赖，更多地依赖简洁、由渲染驱动的数据流。</p>
<p>围绕衍生状态和服务器/客户端边界来设计你的 Hooks，能让你的应用天然地面向未来。</p>
<h2 data-id="heading-7">Hooks 即架构，而非语法</h2>
<p>Hooks 不仅仅是比类组件更友好的 API，它们是一种架构模式。</p>
<ul>
<li>将衍生状态放在渲染过程中</li>
<li>只将副作用用于真正的副作用</li>
<li>通过小而专注的 Hooks 组合逻辑</li>
<li>让并发工具平滑处理异步流程</li>
<li>同时考虑客户端<strong>和</strong>服务器边界</li>
</ul>
<p>React 在进化，我们的 Hooks 也应随之进化。</p>
<p>如果你仍然在用 2020 年的方式写 Hooks，那也没关系。我们大多数人都是如此。但 React 18+ 给了我们一个强大得多的工具箱，熟悉这些模式会很快带来回报。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端大数字精度解决：big.js的教程和原理解析]]></title>    <link>https://juejin.cn/post/7585751355592949779</link>    <guid>https://juejin.cn/post/7585751355592949779</guid>    <pubDate>2025-12-22T00:08:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355592949779" data-draft-id="7576483553879441434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端大数字精度解决：big.js的教程和原理解析"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T00:08:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端大数字精度解决：big.js的教程和原理解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:08:33.000Z" title="Mon Dec 22 2025 00:08:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在前端开发中，处理金融、电商等领域的数字计算时，JavaScript 原生的 Number 类型因采用 64 位双精度浮点数存储，极易出现精度丢失问题（如 <code>0.1 + 0.2 !== 0.3</code>）。big.js 作为轻量级的大数处理库，以简洁的 API 和清晰的源码逻辑，成为解决该问题的主流选择。本文将从 API 用法和源码原理两方面，全面解析 big.js 的核心价值。</p>
<h2 data-id="heading-0">1. 核心特性</h2>
<p>big.js 专为高精度十进制计算设计，核心特点：</p>
<ul>
<li>轻量（仅 ~6KB 无依赖）；</li>
<li>不可变设计（所有操作返回新实例）；</li>
<li>可配置精度、舍入模式；</li>
<li>兼容所有主流浏览器和 Node.js。</li>
</ul>
<h2 data-id="heading-1">2. 常用和特殊API详解</h2>
<h3 data-id="heading-2">2.1. 基础初始化 API</h3>
<p>big.js 的核心是 <code>Big</code> 构造函数，用于创建大数实例，支持多种入参类型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Big</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'big.js'</span>;

<span class="hljs-comment">// 1. 基础初始化（支持数字、字符串、Big 实例）</span>
<span class="hljs-keyword">const</span> num1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// 数字</span>
<span class="hljs-keyword">const</span> num2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'123.4567890123456789'</span>); <span class="hljs-comment">// 字符串（推荐，避免精度丢失）</span>
<span class="hljs-keyword">const</span> num3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(num2); <span class="hljs-comment">// 基于已有 Big 实例创建</span>

<span class="hljs-comment">// 2. 特殊值初始化</span>
<span class="hljs-keyword">const</span> zero = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 0</span>
<span class="hljs-keyword">const</span> negative = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'-987654321.987654321'</span>); <span class="hljs-comment">// 负数</span>
<span class="hljs-keyword">const</span> scientific = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1.23e+5'</span>); <span class="hljs-comment">// 科学计数法</span>
</code></pre>
<blockquote>
<p>注意：初始化时优先使用<strong>字符串入参</strong>，避免数字本身已因浮点数存储丢失精度。</p>
</blockquote>
<h3 data-id="heading-3">2.2. 常用计算 API</h3>
<p>big.js 提供了完整的算术运算方法，所有方法均返回新的 Big 实例（原实例不变）：</p>








































<table><thead><tr><th>API 方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>plus(n)</code></td><td>加法</td><td><code>new Big(0.1).plus(0.2).toString()</code> → "0.3"</td></tr><tr><td><code>minus(n)</code></td><td>减法</td><td><code>new Big(1).minus(0.9).toString()</code> → "0.1"</td></tr><tr><td><code>times(n)</code></td><td>乘法</td><td><code>new Big(2).times(0.1).toString()</code> → "0.2"</td></tr><tr><td><code>div(n)</code></td><td>除法</td><td><code>new Big(1).div(3).toString()</code> → "0.3333333333"</td></tr><tr><td><code>mod(n)</code></td><td>取模</td><td><code>new Big(5).mod(2).toString()</code> → "1"</td></tr><tr><td><code>pow(n)</code></td><td>幂运算</td><td><code>new Big(10).pow(3).toString()</code> → "1000"</td></tr></tbody></table>
<p>示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 高精度加法</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'0.1'</span>);
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'0.2'</span>);
<span class="hljs-keyword">const</span> sum = a.<span class="hljs-title function_">plus</span>(b);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.3"</span>

<span class="hljs-comment">// 高精度除法（默认精度 10 位）</span>
<span class="hljs-keyword">const</span> c = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1'</span>);
<span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'3'</span>);
<span class="hljs-keyword">const</span> div = c.<span class="hljs-title function_">div</span>(d);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.3333333333"</span>
</code></pre>
<h3 data-id="heading-4">2.3. 特殊配置 &amp; 工具 API</h3>
<h4 data-id="heading-5">2.3.1. 全局配置 API</h4>
<p>big.js 支持全局配置精度和舍入模式，核心配置项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 设置全局精度（小数点后位数），默认 20</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">DP</span> = <span class="hljs-number">15</span>; 

<span class="hljs-comment">// 2. 设置舍入模式，默认 ROUND_HALF_UP（四舍五入）</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">RM</span> = <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundHalfUp</span>; 

<span class="hljs-comment">// 舍入模式枚举（常用）：</span>
<span class="hljs-comment">// Big.roundUp: 向上取整</span>
<span class="hljs-comment">// Big.roundDown: 向下取整</span>
<span class="hljs-comment">// Big.roundHalfEven: 银行家舍入（四舍六入五取偶）</span>
</code></pre>
<h4 data-id="heading-6">2.3.2. 实例工具 API</h4>


















































<table><thead><tr><th>API 方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>toString()</code></td><td>转为字符串</td><td><code>new Big(123.45).toString()</code> → "123.45"</td></tr><tr><td><code>toFixed(dp)</code></td><td>固定小数位数</td><td><code>new Big(1.234).toFixed(2)</code> → "1.23"</td></tr><tr><td><code>toPrecision(pre)</code></td><td>固定有效数字</td><td><code>new Big(123.45).toPrecision(3)</code> → "123"</td></tr><tr><td><code>cmp(n)</code></td><td>比较大小（-1/0/1）</td><td><code>new Big(5).cmp(3)</code> → 1</td></tr><tr><td><code>abs()</code></td><td>绝对值</td><td><code>new Big(-123).abs()</code> → Big { s: 1, e: 2, c: [1,2,3] }</td></tr><tr><td><code>neg()</code></td><td>取反</td><td><code>new Big(123).neg()</code> → Big { s: -1, e: 2, c: [1,2,3] }</td></tr><tr><td><code>isZero()</code></td><td>判断是否为 0</td><td><code>new Big(0).isZero()</code> → true</td></tr><tr><td><code>isNegative()</code></td><td>判断是否为负数</td><td><code>new Big(-1).isNegative()</code> → true</td></tr></tbody></table>
<p>示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 配置精度和舍入模式</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">DP</span> = <span class="hljs-number">2</span>;
<span class="hljs-title class_">Big</span>.<span class="hljs-property">RM</span> = <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundUp</span>;

<span class="hljs-comment">// 向上取整的除法</span>
<span class="hljs-keyword">const</span> num = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1'</span>).<span class="hljs-title function_">div</span>(<span class="hljs-string">'3'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.34"</span>

<span class="hljs-comment">// 比较大小</span>
<span class="hljs-keyword">const</span> x = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">const</span> y = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x.<span class="hljs-title function_">cmp</span>(y)); <span class="hljs-comment">// 1（x &gt; y）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x.<span class="hljs-title function_">cmp</span>(x)); <span class="hljs-comment">// 0（相等）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(y.<span class="hljs-title function_">cmp</span>(x)); <span class="hljs-comment">// -1（y &lt; x）</span>
</code></pre>
<h2 data-id="heading-7">3. 源码解析</h2>
<p>big.js 解决精度问题的核心思路是：<strong>将数字转为字符串拆分存储，通过模拟手工计算的方式实现算术运算</strong>，而非依赖 JavaScript 原生的浮点数运算。</p>
<h3 data-id="heading-8">3.1. 核心数据结构</h3>
<p>Big 实例的内部存储结构（核心属性）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以 new Big('123.456') 为例</span>
{
  <span class="hljs-attr">s</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 符号位：1 正数，-1 负数</span>
  <span class="hljs-attr">e</span>: <span class="hljs-number">2</span>,        <span class="hljs-comment">// 指数：小数点偏移量（整数部分的位数 - 1），123.456 的整数部分是 123（3 位），故 e = 3-1 = 2</span>
  <span class="hljs-attr">c</span>: [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>] <span class="hljs-comment">// 系数数组：存储数字的每一位（无小数点，通过 e 定位）</span>
}
</code></pre>
<ul>
<li>符号位 <code>s</code>：分离正负，避免运算时处理符号干扰；</li>
<li>指数 <code>e</code>：记录小数点位置，将小数转为“整数 + 指数”的形式；</li>
<li>系数数组 <code>c</code>：以数组存储每一位数字，彻底规避浮点数的二进制存储精度丢失。</li>
</ul>
<h3 data-id="heading-9">3.2. 核心原理：从“二进制浮点”到“十进制手工计算”</h3>
<p>JavaScript 原生精度丢失的根源是：<strong>十进制小数无法被二进制浮点数精确表示</strong>（如 0.1 的二进制是无限循环小数）。big.js 则回归“手工计算逻辑”，步骤如下：</p>
<h4 data-id="heading-10">步骤 1：初始化时的字符串解析</h4>
<p>当传入数字/字符串时，big.js 会先将其转为字符串，逐字符解析为 <code>s</code>/<code>e</code>/<code>c</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源码核心解析逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">let</span> s = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> e = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> c = [];

  <span class="hljs-comment">// 1. 处理符号</span>
  <span class="hljs-keyword">if</span> (str[<span class="hljs-number">0</span>] === <span class="hljs-string">'-'</span>) {
    s = -<span class="hljs-number">1</span>;
    str = str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-comment">// 2. 处理小数点</span>
  <span class="hljs-keyword">const</span> dotIndex = str.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">if</span> (dotIndex !== -<span class="hljs-number">1</span>) {
    e = dotIndex - (str.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>); <span class="hljs-comment">// 计算指数偏移</span>
    str = str.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.'</span>, <span class="hljs-string">''</span>); <span class="hljs-comment">// 移除小数点</span>
  }

  <span class="hljs-comment">// 3. 解析每一位到系数数组</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-property">length</span>; i++) {
    c.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Number</span>(str[i]));
  }

  <span class="hljs-comment">// 4. 去除前导零、调整指数</span>
  <span class="hljs-comment">// ...（源码中会处理前导零、末尾零等边界情况）</span>

  <span class="hljs-keyword">return</span> { s, e, c };
}
</code></pre>
<h4 data-id="heading-11">步骤 2：算术运算的“手工模拟”</h4>
<p>以加法为例，big.js 模拟人类手工加法的“对齐小数点 → 逐位相加 → 处理进位”逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加法核心逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-comment">// 1. 对齐小数点（统一指数 e）</span>
  <span class="hljs-keyword">let</span> [x, y] = <span class="hljs-title function_">alignExponent</span>(a, b); <span class="hljs-comment">// 对齐后，x.e === y.e</span>

  <span class="hljs-comment">// 2. 逐位相加（从后往前）</span>
  <span class="hljs-keyword">let</span> carry = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> c = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = x.<span class="hljs-property">c</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">const</span> sum = x.<span class="hljs-property">c</span>[i] + y.<span class="hljs-property">c</span>[i] + carry;
    c.<span class="hljs-title function_">unshift</span>(sum % <span class="hljs-number">10</span>); <span class="hljs-comment">// 当前位</span>
    carry = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(sum / <span class="hljs-number">10</span>); <span class="hljs-comment">// 进位</span>
  }

  <span class="hljs-comment">// 3. 处理最后一位进位</span>
  <span class="hljs-keyword">if</span> (carry) c.<span class="hljs-title function_">unshift</span>(carry);

  <span class="hljs-comment">// 4. 构建新的 Big 实例</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>({ <span class="hljs-attr">s</span>: a.<span class="hljs-property">s</span>, <span class="hljs-attr">e</span>: x.<span class="hljs-property">e</span>, c });
}

<span class="hljs-comment">// 对齐指数的辅助函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">alignExponent</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">const</span> diff = a.<span class="hljs-property">e</span> - b.<span class="hljs-property">e</span>;
  <span class="hljs-keyword">if</span> (diff &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// a 的指数更大，给 b 的系数数组补零（相当于小数点右移）</span>
    b.<span class="hljs-property">c</span> = b.<span class="hljs-property">c</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Array</span>(diff).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    b.<span class="hljs-property">e</span> = a.<span class="hljs-property">e</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// b 的指数更大，给 a 的系数数组补零</span>
    a.<span class="hljs-property">c</span> = a.<span class="hljs-property">c</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Array</span>(-diff).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    a.<span class="hljs-property">e</span> = b.<span class="hljs-property">e</span>;
  }
  <span class="hljs-keyword">return</span> [a, b];
}
</code></pre>
<p>乘法、除法等运算的核心逻辑同理：</p>
<ul>
<li><strong>乘法</strong>：模拟“逐位相乘 → 错位相加 → 处理进位”；</li>
<li><strong>除法</strong>：模拟“试商 → 求余 → 补零继续除”，直到达到配置的精度（DP）；</li>
<li>所有运算均基于<strong>十进制数字数组</strong>，而非二进制浮点数，从根源避免精度丢失。</li>
</ul>
<h4 data-id="heading-12">步骤 3：舍入逻辑的精准控制</h4>
<p>big.js 提供多种舍入模式，核心是通过判断“舍弃位的数字”决定是否进位，例如四舍五入（ROUND_HALF_UP）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 舍入核心逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">round</span>(<span class="hljs-params">c, dp, rm</span>) {
  <span class="hljs-keyword">const</span> cutIndex = dp; <span class="hljs-comment">// 保留位数的索引</span>
  <span class="hljs-keyword">const</span> discard = c[cutIndex]; <span class="hljs-comment">// 舍弃位的数字</span>

  <span class="hljs-keyword">if</span> (rm === <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundHalfUp</span>) {
    <span class="hljs-comment">// 四舍五入：舍弃位 &gt;=5 则进位</span>
    <span class="hljs-keyword">if</span> (discard &gt;= <span class="hljs-number">5</span>) {
      <span class="hljs-title function_">carry</span>(c, cutIndex - <span class="hljs-number">1</span>); <span class="hljs-comment">// 向前一位进位</span>
    }
    c.<span class="hljs-title function_">splice</span>(cutIndex); <span class="hljs-comment">// 截断舍弃位</span>
  }
  <span class="hljs-keyword">return</span> c;
}
</code></pre>
<h3 data-id="heading-13">3.3. 源码核心亮点</h3>
<ol>
<li><strong>不可变设计</strong>：所有运算返回新实例，原实例不修改，避免副作用；</li>
<li><strong>最小化计算</strong>：仅处理必要的数字位，去除前导零、末尾零，提升性能；</li>
<li><strong>可配置化</strong>：通过 DP（精度）、RM（舍入模式）适配不同业务场景；</li>
<li><strong>轻量无依赖</strong>：核心代码仅千行左右，无外部依赖，易于集成。</li>
</ol>
<h2 data-id="heading-14">4. 适用场景 &amp; 注意事项</h2>
<h3 data-id="heading-15">适用场景</h3>
<ul>
<li>金融计算（金额、税率、利息）；</li>
<li>电商价格计算（优惠券、折扣、满减）；</li>
<li>高精度数据展示（科学计算、统计报表）。</li>
</ul>
<h3 data-id="heading-16">注意事项</h3>
<ol>
<li>初始化优先使用<strong>字符串</strong>，避免数字入参提前丢失精度；</li>
<li>避免频繁创建 Big 实例，可复用实例提升性能；</li>
<li>与原生 Number 互转时，需通过 <code>toString()</code> 或 <code>toNumber()</code> 方法，避免直接强制转换；</li>
<li>big.js 仅处理十进制大数，如需处理大整数（如 ID、雪花算法），可选择 <code>bigint</code> 或 <code>bn.js</code>。</li>
</ol>
<h2 data-id="heading-17">5. 总结</h2>
<p>big.js 作为前端大数精度处理的经典库，核心价值在于：</p>
<ol>
<li>以<strong>字符串解析 + 十进制数组存储</strong>的方式，规避了 JavaScript 浮点数的二进制存储缺陷；</li>
<li>通过<strong>模拟手工计算</strong>的算术逻辑，实现高精度的加减乘除等运算；</li>
<li>提供简洁的 API 和可配置项，适配不同业务场景的精度需求。</li>
</ol>
<p>在处理前端数字精度问题时，big.js 以轻量、易用、可靠的特性，成为开发者的首选方案。理解其 API 用法和源码原理，不仅能解决实际业务问题，也能深入理解 JavaScript 数字存储的底层逻辑。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十五章(Image)]]></title>    <link>https://juejin.cn/post/7585897699602923546</link>    <guid>https://juejin.cn/post/7585897699602923546</guid>    <pubDate>2025-12-22T02:17:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699602923546" data-draft-id="7585808181239873587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十五章(Image)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十五章(Image)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:09.000Z" title="Mon Dec 22 2025 02:17:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Image组件</h2>
<p>该组件是Next.js内置的图片组件，是基于原生<code>img</code>标签进行扩展，并不代表原生<code>img</code>标签不能使用。</p>
<ul>
<li>尺寸优化：支持使用现代化图片格式，如<code>webp</code>，<code>avif</code>，<code>apng</code>等,并自动根据设备提供正确的尺寸。</li>
<li>视觉稳定性：防止图片加载时发生布局偏移，具体参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fcls%3Fhl%3Dzh-cn" target="_blank" title="https://web.dev/articles/cls?hl=zh-cn" ref="nofollow noopener noreferrer">CLS</a></li>
<li>懒加载：在图片进入视口才会加载，使用浏览器原生懒加载，并可选择添加模糊显示占位符。</li>
<li>灵活性：可按需调整图像大小，即使是存储在远程服务器上的图像也可以调整。</li>
</ul>
<h4 data-id="heading-1">图片引入</h4>
<h5 data-id="heading-2">1. src本地图片引入</h5>
<p>Next.js建议我们把图片放在根目录下的<code>public</code>文件夹中，然后使用<code>/</code>开头访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a73a9cf6e7c4be8b3f3b61e531a778f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=GFjfFcsoNvoSwKUNnkb9VH%2F68kc%3D" alt="public.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">"/1.png"</span>
                <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-3">2. import静态引入</h5>
<p>使用<code>import</code>引入图片，是不需要填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"@/public/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./public/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 新增这一行代码，配置图片路径。</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用静态<code>import</code>引入图片，你会发现无需填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">'@/public/1.png'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">{test}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-4">3. 远程图片引入</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>当我们直接使用远程图片引入的时候Next.js会报错，因为Next.js默认只允许加载本地图片，如果需要加载远程图片，需要配置<code>next.config.js</code>文件。</p>
<p>image-loader.ts:86 Uncaught Error: Invalid src prop (<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>) on <code>next/image</code>, hostname "eo-img.521799.xyz" is not configured under images in your <code>next.config.js</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">remotePatterns</span>: [
      {
        <span class="hljs-attr">protocol</span>: <span class="hljs-string">'https'</span>, <span class="hljs-comment">// 协议</span>
        <span class="hljs-attr">hostname</span>: <span class="hljs-string">'eo-img.521799.xyz'</span>, <span class="hljs-comment">// 主机名</span>
        <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/i/pc/**'</span>, <span class="hljs-comment">// 路径</span>
        <span class="hljs-attr">port</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 端口</span>
      },
    ],
  },
};
</code></pre>
<h5 data-id="heading-5">4. LCP警告</h5>
<p>如果图片是首屏或者LCP图片，需要添加<code>loading="eager"</code>属性，否则会触发LCP警告,因为Image组件默认是懒加载的。</p>
<ul>
<li>lazy: 懒加载，默认值，在图片进入视口才会加载。</li>
<li>eager: 立即加载，在图片进入视口就会加载。</li>
</ul>
<p>Image with src "<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>" was detected as the Largest Contentful Paint (LCP). Please add the <code>loading="eager"</code> property if this image is above the fold.
Read more: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi-reference%2Fcomponents%2Fimage%23loading" target="_blank" title="https://nextjs.org/docs/app/api-reference/components/image#loading" ref="nofollow noopener noreferrer">nextjs.org/docs/app/ap…</a></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> // <span class="hljs-attr">立即加载</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>第二种解决方案使用<code>preload</code>属性加载图片，表示提前预加载图片，不过Next.js还是更加推荐使用<code>loading="eager"</code>属性加载图片。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">preload</span>=<span class="hljs-string">{index</span> &lt; <span class="hljs-attr">10</span>} // <span class="hljs-attr">优先加载策略</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-6">5. 图片格式优化</h5>
<p>Next.js 会通过请求Accept头自动检测浏览器支持的图像格式，以确定最佳输出格式</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Accept</span>:image/avif,image/webp,image/apng,image/svg+xml,image<span class="hljs-comment">/*,*/</span>*;q=<span class="hljs-number">0.8</span>
</code></pre>
<p>我们可以同时启用 AVIF 和 WebP 格式。对于支持 AVIF 的浏览器，系统将优先使用 AVIF 格式，WebP 格式作为备选方案。目前AVIF格式最优。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">'image/avif'</span>, <span class="hljs-string">'image/webp'</span>], <span class="hljs-comment">//默认是 ['image/webp']</span>
  },
};
</code></pre>
<h5 data-id="heading-7">6. 设备适配</h5>
<p>如果你的老板告诉你要兼容哪些设备，你可以使用<code>deviceSizes</code>和<code>imageSizes</code>属性来配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">deviceSizes</span>: [<span class="hljs-number">640</span>, <span class="hljs-number">750</span>, <span class="hljs-number">828</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">1920</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">3840</span>], <span class="hljs-comment">// 设备尺寸</span>
    <span class="hljs-attr">imageSizes</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">96</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">384</span>], <span class="hljs-comment">// 图片尺寸</span>
  },
};
</code></pre>
<p>这两个属性结合会最终生成一个<code>srcset</code>属性，用于浏览器选择最佳图片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bed6fc34c0a414484df71bcf1dbe922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=vOdeCraZzznSMXE%2FFPdALioNi2Y%3D" alt="srcset.png" loading="lazy"/></p>
<p>那为什么需要两个数组去实现呢？</p>
<p>我们观察上图可以发现，<code>imageSizes</code>用于生成小图片尺寸例如(缩略图，头像等)，而<code>deviceSizes</code>用于生成大图片尺寸例如(横幅图、背景图、全屏展示图)。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>

<span class="hljs-comment">// 头像 - 固定 64px</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/avatar.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"64px"</span>  // ← <span class="hljs-attr">告诉浏览器这张图只需要</span> <span class="hljs-attr">64px</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 横幅图 - 响应式全宽</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Banner</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/banner.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1920}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{600}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"100vw"</span>  // ← <span class="hljs-attr">占满整个视口宽度</span>，<span class="hljs-attr">使用</span> <span class="hljs-attr">deviceSizes</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 响应式内容图</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContentImage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/content.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1200}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{800}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"内容图"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 1200px"</span>
      // ↑ <span class="hljs-attr">手机上</span> <span class="hljs-attr">100</span>% <span class="hljs-attr">宽度</span>，<span class="hljs-attr">平板上</span> <span class="hljs-attr">50</span>%，<span class="hljs-attr">桌面最大</span> <span class="hljs-attr">1200px</span>
    /&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-8">Props</h4>
<p>以下是 Image 组件可用的属性：</p>
<h5 data-id="heading-9">必需属性</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>src</td><td>String</td><td><code>src="/profile.png"</code></td><td>图片源路径，支持本地路径或远程 URL</td></tr><tr><td>alt</td><td>String</td><td><code>alt="Picture of the author"</code></td><td>图片替代文本，用于无障碍访问和 SEO</td></tr></tbody></table>
<h5 data-id="heading-10">尺寸相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>width</td><td>Integer (px)</td><td><code>width={500}</code></td><td>图片宽度，静态导入时可选</td></tr><tr><td>height</td><td>Integer (px)</td><td><code>height={500}</code></td><td>图片高度，静态导入时可选</td></tr><tr><td>fill</td><td>Boolean</td><td><code>fill={true}</code></td><td>填充父容器，替代 width 和 height</td></tr><tr><td>sizes</td><td>String</td><td><code>sizes="(max-width: 768px) 100vw"</code></td><td>响应式图片尺寸</td></tr></tbody></table>
<h5 data-id="heading-11">优化相关</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>quality</td><td>Integer (1-100)</td><td><code>quality={80}</code></td><td>图片压缩质量，默认为 75</td></tr><tr><td>loader</td><td>Function</td><td><code>loader={imageLoader}</code></td><td>自定义图片加载器函数</td></tr><tr><td>unoptimized</td><td>Boolean</td><td><code>unoptimized={true}</code></td><td>禁用图片优化，使用原图</td></tr></tbody></table>
<h5 data-id="heading-12">加载相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>loading</td><td>String</td><td><code>loading="lazy"</code></td><td>加载策略，"lazy" 或 "eager"</td></tr><tr><td>preload</td><td>Boolean</td><td><code>preload={true}</code></td><td>是否预加载，用于 LCP 元素</td></tr><tr><td>placeholder</td><td>String</td><td><code>placeholder="blur"</code></td><td>占位符类型，"blur" 或 "empty"</td></tr><tr><td>blurDataURL</td><td>String</td><td><code>blurDataURL="data:image/jpeg..."</code></td><td>模糊占位符的 Data URL</td></tr></tbody></table>
<h5 data-id="heading-13">事件回调</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>onLoad</td><td>Function</td><td><code>onLoad={e =&gt; done()}</code></td><td>图片加载完成时的回调</td></tr><tr><td>onError</td><td>Function</td><td><code>onError={e =&gt; fail()}</code></td><td>图片加载失败时的回调</td></tr></tbody></table>
<h5 data-id="heading-14">其他属性</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>style</td><td>Object</td><td><code>style={{objectFit: "contain"}}</code></td><td>内联样式对象</td></tr><tr><td>overrideSrc</td><td>String</td><td><code>overrideSrc="/seo.png"</code></td><td>覆盖 src，用于 SEO 优化</td></tr><tr><td>decoding</td><td>String</td><td><code>decoding="async"</code></td><td>解码方式，"async"/"sync"/"auto"</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java大厂面试：携程三轮面试]]></title>    <link>https://juejin.cn/post/7586851351469228072</link>    <guid>https://juejin.cn/post/7586851351469228072</guid>    <pubDate>2025-12-23T09:01:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586851351469228072" data-draft-id="7586851351469129768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java大厂面试：携程三轮面试"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T09:01:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java大厂面试：携程三轮面试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:01:11.000Z" title="Tue Dec 23 2025 09:01:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0592d87bad8449d887213d18f83b0b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767085270&amp;x-signature=DiaBpgIvZ0ijdD89UHOZHqhmvsk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0"><strong>一、携程一面</strong>​</h3>
<h4 data-id="heading-1">1. 项目，解决问题，优化方案</h4>
<p><strong>回答思路</strong>：围绕“业务价值+技术问题+落地手段”展开，突出<strong>问题分析→方案选型→效果验证</strong>的闭环。</p>
<ul>
<li>
<p>示例（以电商订单系统为例）：</p>
<ul>
<li>
<p>业务背景：订单量峰值10万+/日，并发下库存超卖、接口响应超时（平均2s+）。</p>
</li>
<li>
<p>核心问题：高并发库存一致性、接口性能瓶颈。</p>
</li>
<li>
<p>优化方案：</p>
<ul>
<li>库存防超卖：Redis预减库存（秒杀场景）+ MySQL最终扣减（事务保证），结合乐观锁（<code>version</code>字段）防止并发冲突；</li>
<li>接口性能：分库分表（订单表按用户ID哈希拆分）、SQL索引优化（覆盖索引减少回表）、异步化（非核心流程如短信通知走MQ）；</li>
<li>效果：库存超卖率从5%降至0，核心接口响应时间优化至200ms内。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">2. Redis分布式锁（很多问题）</h4>
<p><strong>核心考点</strong>：分布式锁的原理、常见问题（锁超时、误删、集群脑裂）及解决方案。</p>
<ul>
<li>
<p>原理：利用Redis的<code>SET key value NX PX timeout</code>原子性命令，实现多进程/服务的互斥访问。</p>
</li>
<li>
<p>常见问题与解决方案：</p>
<ul>
<li><strong>锁超时</strong>（业务未执行完，锁过期）：Redisson的<strong>Watchdog机制</strong>（自动续期，默认30s内每10s续一次）；</li>
<li><strong>锁误删</strong>（其他线程删除自己的锁）：给锁加<strong>唯一标识（UUID）</strong> ，删除前校验<code>value</code>是否为自身生成的UUID；</li>
<li><strong>集群脑裂</strong>（主从切换导致锁失效）：采用<strong>Redlock算法</strong>（多主节点投票，需至少N/2+1节点成功），但需权衡性能（一般中小厂用单主+重试兜底）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">3. 算法：最大子数组和</h4>
<p><strong>考点</strong>：动态规划（Kadane算法），考察代码简洁性与时间复杂度优化。</p>
<ul>
<li>
<p>思路：遍历数组，维护<code>currentSum</code>（当前子数组和）和<code>maxSum</code>（全局最大和）。若<code>currentSum &lt; 0</code>，则重置为当前元素（负数累加无意义）；否则继续累加。</p>
</li>
<li>
<p>代码示例：</p>
<pre><code class="hljs language-ini" lang="ini">public int maxSubArray(int<span class="hljs-section">[]</span> nums) {
    int <span class="hljs-attr">max</span> = nums[<span class="hljs-number">0</span>], current = nums[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt; nums.length; i++) {</span>
        <span class="hljs-attr">current</span> = Math.max(current + nums[i], nums[i])<span class="hljs-comment">;</span>
        <span class="hljs-attr">max</span> = Math.max(max, current)<span class="hljs-comment">;</span>
    }
    return max<span class="hljs-comment">;</span>
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-4"><strong>二、携程二面</strong>​</h3>
<h4 data-id="heading-5">1. 自我介绍以及项目难点，自己参与度高的案例</h4>
<p><strong>回答模板</strong>：</p>
<blockquote>
<p>【自我介绍】我是XX，专注后端开发X年，擅长分布式/高并发领域，主导过XX项目（如亿级流量秒杀系统）。</p>
<p>【项目难点】在XX项目中，需解决<strong>高并发库存超卖+接口性能</strong>问题。原有方案是DB悲观锁，导致TPS仅50，超卖率10%。</p>
<p>【参与度】主导技术方案：① 引入Redis预减库存（原子操作）+ MySQL乐观锁（<code>version</code>校验）保证一致性；② 分库分表（订单表按用户ID哈希）拆分单表压力；③ 非核心流程异步化（MQ解耦）。上线后TPS提升至2000+，超卖率0，接口耗时从2s→200ms。</p>
</blockquote>
<h4 data-id="heading-6">2. 大批量数据导出文件如何优化？</h4>
<p><strong>核心思路</strong>：<strong>异步+分治+流式IO+压缩</strong>，避免内存溢出与请求超时。</p>
<ul>
<li>
<p>步骤：</p>
<ol>
<li><strong>异步触发</strong>：前端发起导出请求，后端写入MQ，立即返回“任务创建中”，前端轮询/WS查询状态；</li>
<li><strong>分批查询</strong>：DB分页（<code>LIMIT offset, size</code>），避免全量数据加载到内存；</li>
<li><strong>流式写入</strong>：用POI的<code>SXSSFWorkbook</code>（流式Excel，仅保留内存中指定行数）或<code>EasyExcel</code>（基于事件模型）写文件；CSV直接通过<code>FileOutputStream</code>逐行输出；</li>
<li><strong>压缩打包</strong>：导出完成后，用ZIP压缩（减少传输体积），支持断点续传；</li>
<li><strong>异常重试</strong>：MQ消费失败时，重试+死信队列兜底，保证数据不丢失。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-7">3. 分布式事务相关（本地消息表 + 消息队列）</h4>
<p><strong>考点</strong>：可靠消息最终一致性方案，考察落地细节（异常处理、幂等）。</p>
<ul>
<li>
<p>流程：</p>
<ol>
<li><strong>本地事务</strong>：业务操作（如扣库存）与<strong>插入本地消息表</strong>（记录消息状态<code>待发送</code>）在同一DB事务中完成；</li>
<li><strong>消息投递</strong>：定时任务扫描本地消息表，将<code>待发送</code>消息发往MQ，成功后更新消息状态为<code>已发送</code>；</li>
<li><strong>消费端处理</strong>：消费者订阅MQ，执行业务逻辑（如创建订单），成功后回调通知生产者更新消息状态为<code>已完成</code>；</li>
</ol>
</li>
<li>
<p>异常处理：</p>
<ul>
<li>消息发送失败：定时任务重试（需保证幂等，如消息ID去重）；</li>
<li>消费失败：MQ重试（设置重试次数）+ 死信队列人工介入；</li>
<li>补偿机制：定时对账（如检查DB与MQ消息状态一致性）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">4. 设计模式优化代码</h4>
<p><strong>回答策略</strong>：结合场景讲设计模式，突出<strong>解耦、扩展性、可读性</strong>。</p>
<ul>
<li>
<p>示例（以促销活动为例）：</p>
<ul>
<li>问题：原代码用<code>if-else</code>区分满减、折扣、赠品，新增活动需修改主逻辑，维护性差。</li>
<li>方案：<strong>策略模式</strong>。定义<code>PromotionStrategy</code>接口（<code>calculate()</code>方法），实现类<code>ManjianStrategy</code>（满减）、<code>ZhekouStrategy</code>（折扣）等。上下文类<code>PromotionContext</code>持有策略引用，运行时根据活动类型切换策略。</li>
<li>效果：新增活动只需加实现类，无需修改原有代码；逻辑分散到各策略类，可读性提升。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">5. 面试官发来一段代码，讲讲有没有可以改进的地方</h4>
<p><strong>通用思路</strong>：从<strong>可读性、性能、健壮性、设计原则</strong>四维度切入。</p>
<ul>
<li>
<p>示例（假设代码是“统计用户订单数”）：</p>
<ul>
<li>命名：变量<code>a</code>→<code>userOrderCount</code>，方法<code>count()</code>→<code>statUserOrderNum()</code>；</li>
<li>性能：循环内重复查询DB→批量查询+缓存；字符串拼接用<code>StringBuilder</code>；</li>
<li>健壮性：参数为空判断（如<code>userId == null</code>抛异常）、try-catch细化（不笼统<code>catch Exception</code>）；</li>
<li>设计：若有多类统计（订单、退款、积分），提取<code>StatsService</code>抽象类，实现类继承（开闭原则）；</li>
<li>并发：若统计全局数据，<code>AtomicLong</code>代替<code>long</code>，或Redis原子计数。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10"><strong>三、携程三面（资深/Leader面）</strong> ​</h3>
<h4 data-id="heading-11">1. 自我介绍以及项目</h4>
<p><strong>重点</strong>：突出<strong>技术深度、架构设计、业务影响力</strong>。</p>
<ul>
<li>
<p>示例：</p>
<blockquote>
<p>我是XX，负责电商中台交易域，主导过“亿级订单履约系统”从0到1建设。核心挑战是<strong>高并发订单创建+分布式事务+全链路监控</strong>。</p>
<p>技术亮点：采用Spring Cloud Alibaba微服务架构，订单服务+库存+支付+物流解耦；Redis预减库存+MySQL乐观锁防超卖；Canal订阅Binlog异步更新缓存；Prometheus+Grafana监控QPS/响应时间/错误率。</p>
<p>成果：支撑双11峰值10万订单/分钟，系统可用性99.99%。</p>
</blockquote>
</li>
</ul>
<h4 data-id="heading-12">2. 用的啥技术栈？</h4>
<p><strong>分层梳理</strong>：后端→中间件→前端→工具链。</p>
<ul>
<li>后端：Spring Boot/Spring Cloud（Nacos注册中心、Sentinel限流）、MyBatis-Plus（ORM）、Redis（缓存/分布式锁）、RocketMQ（异步/解耦）、MySQL（分库分表）；</li>
<li>中间件：Elasticsearch（搜索）、MinIO（文件存储）、SkyWalking（链路追踪）；</li>
<li>前端：Vue3 + Element Plus（若有前端协同）；</li>
<li>工具链：Git（代码管理）、Maven（依赖）、Docker（容器化）、K8s（集群部署）、Jenkins（CI/CD）。</li>
</ul>
<h4 data-id="heading-13">3. 引入这些中间件带来的优化是什么？</h4>
<p><strong>按中间件分类，讲核心价值</strong>：</p>
<ul>
<li>Redis：缓存热点数据（如首页推荐、用户会话），降低DB QPS 80%；分布式锁保证并发场景下的库存/订单一致性；</li>
<li>RocketMQ：削峰填谷（如秒杀订单异步处理，下游服务按吞吐量消费）；解耦系统（订单创建后发消息，物流/积分系统订阅，新增系统无需修改订单逻辑）；</li>
<li>MySQL：分库分表（订单表按用户ID哈希，单表数据从千万级→百万级）；读写分离（主库写，从库读，降低主库压力30%）；</li>
<li>Elasticsearch：复杂查询（如商品多条件搜索）响应时间从2s→200ms；支持分词、聚合（如销量统计）；</li>
<li>监控系统（Prometheus+Grafana）：实时感知系统瓶颈（如某接口响应突增），5分钟内定位故障（如Redis连接池耗尽）。</li>
</ul>
<h4 data-id="heading-14">4. 项目的运转/数据流程</h4>
<p><strong>以“用户下单→履约”为例，梳理全链路</strong>：</p>
<ol>
<li>用户提交订单→网关（鉴权/限流）→订单服务（创建订单，Redis预减库存→锁定库存）；</li>
<li>订单服务调用库存服务（MySQL最终扣减库存，失败则回滚Redis）；</li>
<li>订单服务发送MQ（订单创建事件）→物流服务创建运单、积分服务增加积分；</li>
<li>支付服务回调订单服务（标记订单已支付）→订单服务发MQ通知物流履约；</li>
<li>全链路数据流向：DB（订单、库存）→Redis（库存缓存、分布式锁）→MQ（事件驱动）→ES（订单搜索）。</li>
</ol>
<h4 data-id="heading-15">5. 消息队列应用</h4>
<p><strong>场景+落地+避坑</strong>：</p>
<ul>
<li>
<p>场景：解耦（订单与物流系统）、异步（短信/积分通知）、削峰（秒杀流量缓冲）；</p>
</li>
<li>
<p>落地：Spring Cloud Stream封装生产者/消费者，注解<code>@SendTo</code>发消息，<code>@StreamListener</code>消费；</p>
</li>
<li>
<p>避坑：</p>
<ul>
<li>幂等性：消息携带唯一ID（如订单号），消费前查Redis去重；</li>
<li>顺序性：RocketMQ的MessageQueue选择器，保证同一订单消息发往同一队列；</li>
<li>重试机制：消费失败后，MQ自动重试3次，仍失败则发往死信队列。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-16">6. MySQL慢查询如何优化？</h4>
<p><strong>五步法</strong>：定位→分析→索引→SQL→架构。</p>
<ol>
<li><strong>定位慢SQL</strong>：开启慢查询日志（<code>slow_query_log=ON</code>，<code>long_query_time=1</code>），抓取执行时间&gt;1s的SQL；</li>
<li><strong>分析执行计划</strong>：<code>EXPLAIN</code>看<code>type</code>（是否全表扫）、<code>key</code>（是否命中索引）、<code>rows</code>（扫描行数）；</li>
<li><strong>优化索引</strong>：添加联合索引（遵循最左匹配）、覆盖索引（查询字段全在索引中，避免回表）；</li>
<li><strong>SQL改写</strong>：避免<code>SELECT *</code>、减少JOIN表数、分页优化（大数据量用延迟关联，如<code>SELECT t1.* FROM t1 JOIN (SELECT id FROM t1 LIMIT 100000, 10) t2 ON t1.id=t2.id</code>）；</li>
<li><strong>架构兜底</strong>：读写分离（MyCat/ShardingSphere）、分库分表（ShardingSphere）。</li>
</ol>
<h4 data-id="heading-17">7. Redis的应用</h4>
<p><strong>高频场景+代码示例</strong>：</p>
<ul>
<li>缓存：热点数据（如商品详情）缓存，设置过期时间（<code>EXPIRE key 3600</code>）+ 淘汰策略（LRU）；</li>
<li>分布式锁：Redisson的<code>RLock</code>（<code>lock.lock(leaseTime, unit)</code>自动续期）；</li>
<li>计数器：点赞数（<code>INCR post:100:like</code>），原子性保证数据一致；</li>
<li>限流：令牌桶算法（Redis + Lua脚本，每秒生成10个令牌，请求时<code>DECR token</code>，值为负则拒绝）；</li>
<li>延迟队列：ZSET实现（<code>score</code>为执行时间戳，定时任务扫<code>ZRANGEBYSCORE</code>获取到期任务）。</li>
</ul>
<h4 data-id="heading-18">8. 缓存/DB 一致性如何保证？</h4>
<p><strong>核心方案</strong>：Cache-Aside + 重试兜底，接受“最终一致”。</p>
<ul>
<li>更新逻辑：先更DB，再删缓存（避免“先删缓存→更DB失败→读DB旧数据”）；</li>
<li>异常处理：删缓存失败时，发MQ到重试队列，消费端循环删缓存（需限制重试次数，避免死循环）；</li>
<li>补充：订阅Binlog（如Canal），异步更新缓存（适合读多写少场景，保证最终一致）。</li>
</ul>
<h4 data-id="heading-19">9. 设计一下 用Redis做社交软件点赞；Redis集群下的数据排序</h4>
<p><strong>点赞设计</strong>：</p>
<ul>
<li>
<p>数据结构：</p>
<ul>
<li>点赞关系：<code>Set&lt;user:like:{postId}&gt;</code>存储点赞用户ID（去重）；</li>
<li>点赞数：<code>String&lt;like:count:{postId}&gt;</code>记录总数（<code>INCR/DECR</code>原子操作）；</li>
</ul>
</li>
<li>
<p>功能：点赞（<code>SADD + INCR</code>）、取消点赞（<code>SREM + DECR</code>）、查询是否点赞（<code>SISMEMBER</code>）、获取点赞列表（<code>SMEMBERS</code>）、点赞数（<code>GET</code>）。</p>
</li>
</ul>
<p><strong>集群下的数据排序</strong>（如按点赞数排热门帖）：</p>
<ul>
<li>
<p>问题：Redis集群分片（CRC16算法），不同Key可能在不同Slot，无法跨Slot排序；</p>
</li>
<li>
<p>方案：</p>
<ol>
<li><strong>哈希标签</strong>：Key设计为<code>{hot}:post:{postId}</code>，<code>{hot}</code>作为哈希标签，强制同一Tag的Key在同一Slot；</li>
<li><strong>本地聚合+定时同步</strong>：每个节点维护本地TopN列表，定时（如每小时）汇总到中心节点生成全局TopN；</li>
<li><strong>异步计算</strong>：点赞事件发MQ，后台服务消费后维护全局ZSET（<code>ZADD hot_posts 100 postId</code>），定期更新排序。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-20">10. 项目的开发测试流程</h4>
<p><strong>敏捷+DevOps闭环</strong>：</p>
<ul>
<li>需求阶段：产品PRD评审，技术团队拆分用户故事，评估工时；</li>
<li>开发阶段：分支管理（Feature分支）、Code Review（SonarLint代码扫描）、单元测试（JUnit+Mockito）；</li>
<li>测试阶段：测试环境Docker化部署（Compose），QA执行功能测试（Postman）、性能测试（JMeter）、安全测试（OWASP ZAP）；</li>
<li>发布阶段：灰度发布（Nginx权重路由，5%流量试点），监控告警（Prometheus+Alertmanager），无问题则全量发布（K8s滚动更新）；</li>
<li>迭代阶段：收集用户反馈，复盘技术债务，规划下一迭代。</li>
</ul>
<p>以上答案结合<strong>技术深度+实战场景+架构思维</strong>，既覆盖知识点，又体现解决问题的能力，适合大厂面试应答~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版]]></title>    <link>https://juejin.cn/post/7586597780641415178</link>    <guid>https://juejin.cn/post/7586597780641415178</guid>    <pubDate>2025-12-23T06:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586597780641415178" data-draft-id="7586657335880957979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版"/> <meta itemprop="keywords" content="前端,AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-23T06:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="樊小肆"/> <meta itemprop="url" content="https://juejin.cn/user/1257497033719320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497033719320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    樊小肆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:24:22.000Z" title="Tue Dec 23 2025 06:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文基于之前的本地大模型对话Demo进行优化，重点介绍如何将内存存储升级为PostgreSQL持久化存储，并增强对话安全性与检索准确性。仍需在Node.js 18+环境下运行，核心依赖工具（Ollama、PostgreSQL）的安装请参考官方文档。</p>
<h3 data-id="heading-1">为何升级为PostgreSQL存储？</h3>
<p>内存存储虽适合快速原型验证，但存在重启后数据丢失的问题，无法满足实际应用场景。PostgreSQL作为成熟的关系型数据库，不仅能持久化存储对话记录，配合pgvector插件还能高效管理向量数据，为生产环境提供可靠支撑。</p>
<h2 data-id="heading-2">代码实现：从内存存储到PostgreSQL持久化</h2>
<h3 data-id="heading-3">1. 数据库配置与实例初始化</h3>
<p>修改内容：新增PostgreSQL配置，替代原内存存储的sessionStores设计</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 替代原内存存储的全局配置</span>
<span class="hljs-type">const</span> pgConfig = {
    host: <span class="hljs-string">"127.0.0.1"</span>,
    port: <span class="hljs-number">5432</span>,
    user: <span class="hljs-string">"fanxiaosi"</span>,
    password: <span class="hljs-string">"f15130026310."</span>,
    database: <span class="hljs-string">"One-AI-DB"</span>,
};
</code></pre>
<p>修改原因：内存存储无法持久化数据，服务重启后对话历史会丢失。</p>
<p>改进好处：使用PostgreSQL实现对话记录的永久存储，支持多实例共享数据，为分布式部署奠定基础。</p>
<h3 data-id="heading-4">2. 语言模型配置优化</h3>
<p>修改内容：在原有基础上增加防复读配置</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ChatOllama</span>({
    model: <span class="hljs-string">'deepseek-r1:1.5b'</span>,
    baseUrl: <span class="hljs-string">"http://127.0.0.1:11434"</span>,
    topP: <span class="hljs-number">0.9</span>,  <span class="hljs-comment">// 从1.0调整为0.9</span>
    topK: <span class="hljs-number">40</span>,   <span class="hljs-comment">// 从20调整为40</span>
    streaming: <span class="hljs-literal">true</span>,
    temperature: <span class="hljs-number">0</span>,  <span class="hljs-comment">// 新增：固定输出温度，保证结果稳定性</span>
    repeatPenalty: <span class="hljs-number">1.2</span>,  <span class="hljs-comment">// 新增：防止多轮对话后复读系统指令</span>
})
</code></pre>
<p>修改原因：原配置可能导致输出多样性不足或出现重复内容。</p>
<p>改进好处：通过repeatPenalty减少复读现象，调整topP/topK平衡输出多样性与相关性，固定temperature确保回复稳定性。</p>
<h3 data-id="heading-5">3. 提示词模板增强</h3>
<p>修改内容：优化提示词模板结构，增加背景信息注入点</p>
<pre><code class="hljs language-css" lang="css">const textPrompt = ChatPromptTemplate<span class="hljs-selector-class">.fromMessages</span>(<span class="hljs-selector-attr">[    [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个专业的知识助手。只需回答用户问题，不要重复系统指令。如果无法从背景信息中找到答案，请基于已知对话回复。"</span>]</span>,
    <span class="hljs-selector-attr">[<span class="hljs-string">"placeholder"</span>, <span class="hljs-string">"{chat_history}"</span>]</span>,
    <span class="hljs-selector-attr">[<span class="hljs-string">"human"</span>, <span class="hljs-string">"背景信息：{relevant_history}\n\n当前问题：{user_input}"</span>]</span>  // 新增背景信息字段
]);
</code></pre>
<p>修改原因：原模板仅依赖完整历史对话，长对话场景下可能超出模型上下文窗口。</p>
<p>改进好处：通过{relevant_history}注入检索到的相关片段，既保证上下文相关性，又避免全量历史导致的窗口溢出问题。</p>
<h3 data-id="heading-6">4. 敏感词检查机制强化</h3>
<p>修改内容：完善敏感词检查的错误处理流程</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">profanityChecker</span> = (input: { user_input: string }) =&gt; {
    const <span class="hljs-attr">sensitiveWords</span> = [<span class="hljs-string">"傻瓜"</span>, <span class="hljs-string">"白痴"</span>, <span class="hljs-string">"不良内容"</span>]<span class="hljs-comment">;</span>
    const <span class="hljs-attr">userInput</span> = input.user_input<span class="hljs-comment">;</span>

    if (sensitiveWords.some(<span class="hljs-attr">word</span> =&gt; userInput.includes(word))) {
        throw new Error("检测到敏感内容。请使用文明用语。")<span class="hljs-comment">;  // 明确的错误提示</span>
    }

    return input<span class="hljs-comment">;  // 检查通过则透传输入</span>
}<span class="hljs-comment">;</span>
const <span class="hljs-attr">customCheckStep</span> = RunnableLambda.from(profanityChecker)<span class="hljs-comment">;</span>
</code></pre>
<p>修改原因：原实现未明确错误处理机制，可能导致异常传播不规范。</p>
<p>改进好处：通过抛出结构化错误，使前端能清晰捕获敏感词提示，同时中断后续处理流程，提升系统安全性。</p>
<h3 data-id="heading-7">5. 向量存储重构：单例模式+PGVector</h3>
<p>修改内容：用单例模式管理PGVectorStore，替代原内存向量库</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 替代原MemoryVectorStore的实现</span>
let globalVectorStore: PGVectorStore | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

export <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">getVectorStore</span> = <span class="hljs-title function_ invoke__">async</span> (): Promise&lt;PGVectorStore&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!globalVectorStore) {
        globalVectorStore = await PGVectorStore.<span class="hljs-title function_ invoke__">initialize</span>(embeddingModel, {
            <span class="hljs-attr">postgresConnectionOptions</span>: pgConfig,
            <span class="hljs-attr">tableName</span>: <span class="hljs-string">"test_langchain_embeddings"</span>,
            <span class="hljs-attr">columns</span>: {
                <span class="hljs-attr">idColumnName</span>: <span class="hljs-string">"id"</span>,
                <span class="hljs-attr">vectorColumnName</span>: <span class="hljs-string">"embedding"</span>,
                <span class="hljs-attr">contentColumnName</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-attr">metadataColumnName</span>: <span class="hljs-string">"metadata"</span>,
            },
        });
    }
    <span class="hljs-keyword">return</span> globalVectorStore;
};
</code></pre>
<p>修改原因：原内存向量库存在数据易失性和多实例同步问题。</p>
<p>改进好处：</p>
<ol>
<li>单例模式避免重复创建数据库连接池，减少资源消耗</li>
<li>PGVectorStore支持向量数据的持久化存储和高效检索</li>
<li>结构化的表设计便于后期数据维护和分析</li>
</ol>
<h3 data-id="heading-8">6. 对话历史存储优化</h3>
<p>修改内容：新增对话内容清洗逻辑，增强检索准确性</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addMessageToVectorStore</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
    sessionId: <span class="hljs-built_in">string</span>,
    humanInput: <span class="hljs-built_in">string</span>,
    aiResponse?: <span class="hljs-built_in">string</span>
</span>) =&gt; {
    <span class="hljs-comment">// 新增：清洗AI回复中的特殊标签</span>
    <span class="hljs-keyword">const</span> cleanAIResponse = aiResponse?.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[\s\S]*?&lt;/</span>think&gt;/g, <span class="hljs-string">""</span>).<span class="hljs-title function_">trim</span>();

    <span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getVectorStore</span>();

    <span class="hljs-keyword">const</span> messageText = cleanAIResponse
        ? <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>\n助手：<span class="hljs-subst">${cleanAIResponse}</span>`</span>
        : <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>`</span>;

    <span class="hljs-keyword">await</span> vectorStore.<span class="hljs-title function_">addDocuments</span>([{
        <span class="hljs-attr">pageContent</span>: messageText,
        <span class="hljs-attr">metadata</span>: {
            sessionId,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
            <span class="hljs-attr">type</span>: aiResponse ? <span class="hljs-string">"qa_pair"</span> : <span class="hljs-string">"user_query"</span>  <span class="hljs-comment">// 新增类型标识</span>
        }
    }]);
};
</code></pre>
<p>修改原因：原实现可能存储未经处理的模型输出（含思考过程标签），影响检索精度。</p>
<p>改进好处：</p>
<ol>
<li>移除特殊标签确保存储内容纯净度</li>
<li>增加type字段区分消息类型，便于后续检索过滤</li>
<li>标准化存储格式提升语义匹配准确性</li>
</ol>
<h3 data-id="heading-9">7. 检索逻辑优化</h3>
<p>修改内容：增强检索器的会话隔离和结果去重能力</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">retrieveRelevantHistory</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
    userInput: <span class="hljs-built_in">string</span>,
    sessionId: <span class="hljs-built_in">string</span>
</span>) =&gt; {
    <span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getVectorStore</span>();

    <span class="hljs-keyword">const</span> retriever = vectorStore.<span class="hljs-title function_">asRetriever</span>({
        <span class="hljs-attr">searchType</span>: <span class="hljs-string">"mmr"</span>,
        <span class="hljs-attr">searchKwargs</span>: {
            <span class="hljs-attr">fetchK</span>: <span class="hljs-number">20</span>,  <span class="hljs-comment">// 扩大候选集</span>
            <span class="hljs-attr">lambda</span>: <span class="hljs-number">0.7</span>,  <span class="hljs-comment">// 平衡相关性和多样性</span>
        },
        <span class="hljs-attr">k</span>: <span class="hljs-number">3</span>,  <span class="hljs-comment">// 小模型适配的最优返回数量</span>
        <span class="hljs-attr">filter</span>: { sessionId },  <span class="hljs-comment">// 严格的会话隔离</span>
    });

    <span class="hljs-keyword">const</span> relevantDocs = <span class="hljs-keyword">await</span> retriever.<span class="hljs-title function_">invoke</span>(userInput);
    <span class="hljs-keyword">return</span> relevantDocs.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>
        ? relevantDocs.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> doc.<span class="hljs-property">pageContent</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n\n"</span>)
        : <span class="hljs-string">""</span>;  <span class="hljs-comment">// 空字符串替代原"无相关背景知识"</span>
};
</code></pre>
<p>修改原因：原检索逻辑未严格隔离会话，且返回无关提示可能干扰模型。</p>
<p>改进好处：</p>
<ol>
<li>通过filter确保只检索当前会话历史，避免跨会话信息泄露</li>
<li>调整k值适配1.5B小模型的上下文处理能力</li>
<li>返回空字符串替代提示文本，防止干扰模型判断</li>
</ol>
<h3 data-id="heading-10">8. 链式调用流程重构</h3>
<p>修改内容：优化调用链的参数传递逻辑</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ragChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
    customCheckStep,  <span class="hljs-comment">// 优先执行敏感词检查</span>
    {
        <span class="hljs-attr">user_input</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">user_input</span>,
        <span class="hljs-attr">sessionId</span>: <span class="hljs-function">(<span class="hljs-params">_input, config</span>) =&gt;</span> config.<span class="hljs-property">configurable</span>?.<span class="hljs-property">sessionId</span>,
        <span class="hljs-attr">chat_history</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">chat_history</span>,
    },
    <span class="hljs-title class_">RunnablePassthrough</span>.<span class="hljs-title function_">assign</span>({
        <span class="hljs-attr">relevant_history</span>: retrieveStep,  <span class="hljs-comment">// 注入检索结果</span>
    }),
    textPrompt,
    llm,
]);
</code></pre>
<p>修改原因：原链式调用参数传递不够清晰，可能导致上下文丢失。</p>
<p>改进好处：</p>
<ol>
<li>明确参数映射关系，提升代码可读性</li>
<li>将敏感词检查置于流程最前端，提前拦截不良内容</li>
<li>分离参数提取与检索逻辑，便于单独调试</li>
</ol>
<h3 data-id="heading-11">9. 会话历史管理升级</h3>
<p>修改内容：使用PostgresChatMessageHistory替代内存存储</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> textChainWithHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;({
    <span class="hljs-attr">runnable</span>: ragChain,
    <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-function">(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgresChatMessageHistory</span>({
            <span class="hljs-attr">tableName</span>: <span class="hljs-string">"chat_messages"</span>,
            sessionId,
            <span class="hljs-attr">poolConfig</span>: pgConfig,
        });
    },
    <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">"user_input"</span>,
    <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">"chat_history"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
</code></pre>
<p>修改原因：原InMemoryChatMessageHistory无法持久化存储对话记录。</p>
<p>改进好处：</p>
<ol>
<li>实现对话历史的持久化存储，服务重启后不丢失</li>
<li>与PostgreSQL向量库形成数据联动，便于数据备份与迁移</li>
<li>支持跨进程共享会话历史，为集群部署提供可能</li>
</ol>
<h3 data-id="heading-12">10. 服务器与请求处理增强</h3>
<p>修改内容：完善HTTP服务器的错误处理和跨域支持</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-comment">// 新增：过滤浏览器图标请求</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">"/favicon.ico"</span>) {
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">404</span>);
        res.<span class="hljs-title function_">end</span>();
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 增强跨域处理</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">"OPTIONS"</span>) {
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Methods"</span>, <span class="hljs-string">"GET, POST, OPTIONS"</span>);
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">204</span>);
        res.<span class="hljs-title function_">end</span>();
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 统一参数解析逻辑</span>
        <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">await</span> <span class="hljs-title function_">parseRequestParams</span>(req);
        <span class="hljs-keyword">const</span> sessionId = params.<span class="hljs-property">sessionId</span> || <span class="hljs-string">"default-session-id"</span>;
        <span class="hljs-keyword">const</span> user_input = params.<span class="hljs-property">user_input</span>;
        
        <span class="hljs-comment">// 输入验证</span>
        <span class="hljs-keyword">if</span> (!user_input) {
            res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">"Missing user_input"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 流式响应处理</span>
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream; charset=utf-8"</span>,
            <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
            <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"keep-alive"</span>,
        });

        <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> textChainWithHistory.<span class="hljs-title function_">stream</span>(
            { user_input },
            { <span class="hljs-attr">configurable</span>: { sessionId } }
        );
        
        <span class="hljs-keyword">let</span> fullSummary = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
            <span class="hljs-keyword">const</span> content = chunk.<span class="hljs-property">content</span> || <span class="hljs-string">""</span>;
            fullSummary += content;
            res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ content })}</span>\n\n`</span>);
        }

        <span class="hljs-comment">// 新增：回复完成后存入向量库</span>
        <span class="hljs-keyword">if</span> (fullSummary) {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">addMessageToVectorStore</span>(sessionId, user_input, fullSummary);
        }
        
        res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ done: <span class="hljs-literal">true</span> })}</span>\n\n`</span>);
        res.<span class="hljs-title function_">end</span>();
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
        <span class="hljs-comment">// 错误信息通过SSE传递</span>
        res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ error: error.message })}</span>\n\n`</span>);
    }
})
</code></pre>
<p>修改原因：原服务器实现缺乏完整的错误处理和请求过滤机制。</p>
<p>改进好处：</p>
<ol>
<li>增加图标请求过滤，减少无效处理</li>
<li>完善的错误捕获与前端通知机制</li>
<li>标准化SSE响应格式，便于前端处理</li>
<li>确保AI回复在生成完成后才存入向量库，避免部分内容存储</li>
</ol>
<h2 data-id="heading-13">结语</h2>
<p>本次优化通过PostgreSQL实现了对话数据的持久化存储，增强了系统的稳定性和安全性，同时优化了检索精度和模型输出质量。相比内存存储方案，新版Demo更接近生产环境需求，可作为企业级本地大模型应用的基础框架。建议结合实际业务场景进一步扩展用户认证、权限控制等功能。</p>
<h3 data-id="heading-14">总结</h3>
<ol>
<li>核心升级方向：内存存储→PostgreSQL持久化，解决数据易失问题，适配生产场景；</li>
<li>关键优化点：敏感词前置检查、检索会话隔离、模型防复读配置，提升安全性与回复质量；</li>
<li>体验增强：标准化SSE流式响应、完善的错误处理，降低前端对接成本。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！]]></title>    <link>https://juejin.cn/post/7586587644824731682</link>    <guid>https://juejin.cn/post/7586587644824731682</guid>    <pubDate>2025-12-23T07:34:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644824731682" data-draft-id="7586587644823650338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！"/> <meta itemprop="keywords" content="WebSocket,前端"/> <meta itemprop="datePublished" content="2025-12-23T07:34:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JackJiang"/> <meta itemprop="url" content="https://juejin.cn/user/3104676566799399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676566799399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JackJiang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:34:36.000Z" title="Tue Dec 23 2025 07:34:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由45岁老架构师尼恩分享，感谢作者，有修订和重新排版。</p>
<h2 data-id="heading-0">1、引言</h2>
<p>你有没有想过，为什么 ChatGPT 的回答能逐字逐句地“流”出来？这一切的背后，都离不开一项关键技术——SSE（Server-Sent Events）！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6602a3fb6337470aa07567207adea124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=D4o5FoRb7feZp%2BVChjet5Y0yd8c%3D" alt="" loading="lazy"/></p>
<p><strong>本文从SSE（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">Server-Sent Events</a>）技术的原理到示例代码，为你通俗易懂的讲解SSE技术的方方面面。</strong></p>
<h2 data-id="heading-1">2、AI大模型实时通信技术专题</h2>
<p>技术专题系列文章目录如下，本文是第 <strong><em>4</em></strong> 篇：</p>
<ol>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4797-1-1.html" target="_blank" title="http://www.52im.net/thread-4797-1-1.html" ref="nofollow noopener noreferrer">全民AI时代，大模型客户端和服务端的实时通信到底用什么协议？</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4831-1-1.html" target="_blank" title="http://www.52im.net/thread-4831-1-1.html" ref="nofollow noopener noreferrer">大模型时代多模型AI网关的架构设计与实现</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4856-1-1.html" target="_blank" title="http://www.52im.net/thread-4856-1-1.html" ref="nofollow noopener noreferrer">通俗易懂：AI大模型基于SSE的实时流式响应技术原理和实践示例</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4872-1-1.html" target="_blank" title="http://www.52im.net/thread-4872-1-1.html" ref="nofollow noopener noreferrer">ChatGPT如何实现聊天一样的实时交互？快速读懂SSE实时“推”技术</a> 》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html" target="_blank" title="http://www.52im.net/thread-4885-1-1.html" ref="nofollow noopener noreferrer">AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！</a> 》（☜ 本文）</li>
</ol>
<h2 data-id="heading-2">3、初识SSE</h2>
<p>SSE（Server-Sent Events）是一种基于 HTTP 协议的服务器推送技术，允许服务端主动向客户端发送数据流。</p>
<p>SSE 可以被理解为 HTTP 的一个扩展或一种特定用法。它不是一个全新的、独立的协议，而是构建在标准 HTTP/1.1 协议之上的技术。</p>
<p>SSE 就像是服务器打开了一个“单向数据管道”，服务器通过HTTP 扩展 可以持续不断地流向浏览器，无需客户端反复发起请求。其实很简单的： SSE = HTTP 扩展字段 + Keepalive 长连接。</p>
<p>SSE 提供了一种简单、可靠的方式来实现服务器向客户端的实时数据推送。它非常适合通知、实时数据更新、日志流和类似 ChatGPT 的逐字输出场景。如果你只需要单向通信，SSE 往往是比 WebSocket 更简单、更轻量的选择。</p>
<p>SSE 适用于服务器主动向客户端推送数据的场景，如实时通知、动态更新等。</p>
<p>所以，目前 几乎所有主流浏览器都原生支持SSE。</p>
<p><strong>PS：</strong> <strong>更详细的SSE技术资料，可以进一步阅读以下几篇：</strong></p>
<ol>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-336-1-1.html" target="_blank" title="http://www.52im.net/thread-336-1-1.html" ref="nofollow noopener noreferrer">Web端即时通讯技术盘点：短轮询、Comet、Websocket、SSE</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-335-1-1.html" target="_blank" title="http://www.52im.net/thread-335-1-1.html" ref="nofollow noopener noreferrer">SSE技术详解：一种全新的HTML5服务器推送事件技术</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1038-1-1.html" target="_blank" title="http://www.52im.net/thread-1038-1-1.html" ref="nofollow noopener noreferrer">详解Web端通信方式的演进：从Ajax、JSONP 到 SSE、Websocket</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2719-1-1.html" target="_blank" title="http://www.52im.net/thread-2719-1-1.html" ref="nofollow noopener noreferrer">一文读懂前端技术演进：盘点Web前端20年的技术变迁史</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3555-1-1.html" target="_blank" title="http://www.52im.net/thread-3555-1-1.html" ref="nofollow noopener noreferrer">网页端IM通信技术快速入门：短轮询、长轮询、SSE、WebSocket</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3695-1-1.html" target="_blank" title="http://www.52im.net/thread-3695-1-1.html" ref="nofollow noopener noreferrer">搞懂现代Web端即时通讯技术一文就够：WebSocket、socket.io、SSE</a></li>
</ol>
<h2 data-id="heading-3">4、SSE的诞生背景</h2>
<h5 data-id="heading-4">4.1  短轮询、长轮询、Flash 、 WebSocket</h5>
<p>在 SSE 技术出现之前，Web 应用要实现服务器向客户端的实时数据推送，主要依赖以下几种技术，但它们都存在明显的缺陷。</p>
<p><strong>4.1.1） 短轮询 (Polling)：</strong></p>
<p><strong>原理：</strong> 用短连接请求数据。客户端以固定的时间间隔（例如每秒一次）频繁地向服务器发送请求，询问是否有新数据。</p>
<p><strong>缺点：</strong> 大量请求可能是无效的（无新数据），浪费服务器和带宽资源，实时性差。</p>
<p><strong>短轮询的技术流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/670174c6dd834ca6b6a129a9ccefd55a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=2Rd2zgu8rXItrJHcZRQ6Who0KYE%3D" alt="" loading="lazy"/></p>
<p>**</p>
<p>4.1.2）长轮询 (Long Polling)：</p>
<p>**</p>
<p>原理：使用长连接请求数据。 客户端发送一个请求，服务器会保持这个连接打开（长连接），直到有新数据可用或超时。一旦客户端收到响应，会立即发起下一个请求。</p>
<p>缺点：虽然减少了无效请求，但每个连接仍然需要客户端发起，服务器需要维护大量挂起的连接，实现复杂。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f50b7a9f1d54fd5b418542b385e53eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=xvgrnctIubinLBqL5RYJotnGe7Q%3D" alt="" loading="lazy"/></p>
<p>长轮询 (Long Polling) 的技术突破：减少无效请求，但服务器需维护挂起连接</p>
<p><strong>4.1.3）基于 Flash 的解决方案：</strong></p>
<p>原理：利用 Adobe Flash 插件提供的 Socket 功能实现全双工通信。</p>
<p>缺点：依赖浏览器插件，在移动端（如 iPhone）不受支持，且随着技术的发展（Flash 被淘汰）已走向消亡。基于 Flash 方法都非原生支持，效率低下或依赖外部插件。</p>
<p><strong>4.1.4）基于 WebSocket的解决方案：</strong></p>
<p>原理：在客户端与服务器之间建立一条全双工的 TCP 长连接，双方可随时互相推送数据。</p>
<p><strong>缺点：</strong></p>
<ul>
<li>
<p>1）需要一次额外的协议升级握手（Upgrade: websocket），对 CDN、防火墙、代理服务器的兼容性不如普通 HTTP；</p>
</li>
<li>
<p>2）双向通信能力在“服务器→客户端单向推送”场景下显得过度设计，增加心跳、重连、帧解析等复杂度；</p>
</li>
<li>
<p>3）早期浏览器支持不一（IE ≤ 9 无原生实现），需要 Polyfill 或 Flash 降级方案。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e6bdfb928c14ca1a3ac98f3e09b81d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Wc83W4XnhtsQ1pZC5sEvbu9QdGU%3D" alt="" loading="lazy"/></p>
<p>WebSocket全双工通道的革命性：摆脱HTTP束缚，实现真正的实时交互（</p>
<p>PS:</p>
<p>WebSocket 并不仅是 Web 领域的通讯协议，它属于复杂度较高的二进制通讯协议）。</p>
<h5 data-id="heading-5">4.2 SSE 诞生的核心背景</h5>
<p>因此，Web 领域迫切需要一种标准化的、高效的、由浏览器原生支持的服务器到客户端的单向通信机制。这就是 SSE 诞生的核心背景。</p>
<p><strong>核心需求：</strong></p>
<ul>
<li>
<p>1）简单：易于服务器和客户端实现；</p>
</li>
<li>
<p>2）高效：基于 HTTP/HTTPS，避免不必要的请求开销；</p>
</li>
<li>
<p>3）标准：成为 W3C 标准，得到浏览器原生支持；</p>
</li>
<li>
<p>4）自动重连：内置连接失败后自动重试的机制。</p>
</li>
</ul>
<p><strong>SSE——真正的服务器推送：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9a8683493645939461312a1829115b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Qc0Y%2B9TifBuvTkuPvUnMQw5vLJg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">5、SSE的前世今生</h2>
<p>SSE 的发展是 Web 标准化进程和实时通信需求共同推动的结果。</p>
<p><strong>下图概述了其关键发展节点：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e09f28733fb480e9f316b9cb8b1e1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=3wNcFZ4vMyKwc%2BCvGjxO1a44lqk%3D" alt="" loading="lazy"/></p>
<p>让我们对图中的关键阶段进行详细解读。</p>
<p><strong>1）诞生背景（2006 年以前）：</strong></p>
<p>Web 早期只有“请求-响应”范式，实时需求（股票、IM、行情）只能靠轮询或长轮询，延迟高、浪费资源。Comet（长连接 iframe、jsonp、xhr-streaming 等 Hack 方案）出现，但实现复杂、浏览器兼容性差、占用连接数高。</p>
<p>业界急需一种“浏览器原生、基于 HTTP、单向服务器推送”的轻量机制。</p>
<p><strong>2）概念提出与标准化 (约 2006-2009年)：</strong></p>
<p>SSE 的概念最初作为 HTML5 标准的一部分被提出，由 WHATWG (Web Hypertext Application Technology Working Group) 和 W3C (World Wide Web Consortium) 共同推动。</p>
<p>其设计思想是定义一个简单的、基于 HTTP 的协议，允许服务器通过一个长连接持续地向客户端发送文本流。</p>
<p>2006 年，Opera 9 在浏览器里率先实现名为 Server-Sent Events 的实验 API，用 DOM 事件把服务器推送的文本块喂给页面。</p>
<p>同期 WHATWG HTML5 草案开始收录相关章节，定义了 text/event-stream MIME 类型及“event: / data:”行协议。</p>
<p>后来，它从庞大的 HTML5 规范中分离出来，成为了一个独立的 W3C 标准文档。</p>
<p>2008 年，SSE 被正式写入 HTML5 草案，随后进入 W3C 标准流程。</p>
<p><strong>3）浏览器支持与推广 (约 2010-2015年)：</strong></p>
<p>2011年左右，主流浏览器（如 Firefox、Chrome、Safari、Opera）开始陆续支持 SSE API。 Firefox 6、Chrome 6、Safari 5、Opera 11.5 陆续完成原生实现；IE 系列缺席（直到 Edge 79 才补票）。</p>
<p>关键的障碍：Internet Explorer (包括 IE 11) 始终没有支持 SSE API。这在一定程度上限制了其早期的广泛应用，开发者通常需要为此准备降级方案（如回落到长轮询）。</p>
<p>随着 Chrome、Firefox 等现代浏览器的市场份额不断上升，以及移动端浏览器对 SSE 的良好支持，SSE 逐渐成为开发实时 Web 应用的可信选择。</p>
<p>2014 年 10 月：HTML5 成为 W3C Recommendation，SSE 作为官方子模块锁定最终语法，浏览器阵营格局定型。</p>
<p><strong>4）正式推荐与成熟 (2015年至2022 )：</strong></p>
<p>2015-2020 年，WebSocket 与 WebRTC 占据实时通信话题中心，SSE 主要在企业内部仪表盘、日志 tail 等低频场景默默使用。</p>
<p>SSE 由于有 “单向文本流 + 自动重连 + 轻量” 特性，所以没有被WebSocket 与 WebRTC 踩死， 使其在 IoT 设备、移动端 WebView 中仍保有一席之地。</p>
<p>2015年，W3C 发布了 Server-Sent Events 的正式推荐标准，标志着该技术的成熟和稳定。在此期间，前端生态框架（如 React、Vue.js）和后端语言（如 Node.js、Python、Java）都提供了对 SSE 的良好支持，出现了大量易用的库和示例。</p>
<p><strong>5） 大模型时代的爆发（2022 至今）：</strong></p>
<p>虽然 WebSocket 提供了全双工通信能力，但 SSE 因其简单的 API、基于 HTTP 带来的良好兼容性（如无需担心代理或防火墙问题）、以及自动重连等特性，在只需要服务器向客户端推送数据的场景中（如新闻推送、实时行情、状态更新、AI 处理进度流式输出等）成为了更简单、更合适的选择。</p>
<p><strong>ChatGPT、Claude 等生成式 AI 需要“打字机”式逐 token 输出，SSE 天然契合：</strong></p>
<ul>
<li>
<p>1）基于 HTTP/1.1 无需升级协议，CDN 缓存友好；</p>
</li>
<li>
<p>2）浏览器 EventSource API 一行代码即可接入；</p>
</li>
<li>
<p>3）文本流可直接承载 JSON Lines 或 markdown 片段。</p>
</li>
</ul>
<p>2022 年底起：OpenAI、Anthropic、Google Bard 均把 text/event-stream 作为官方流式回答协议，社区库（FastAPI SSE-Star、Spring WebFlux、Node sse.js、Go gin-sse）迎来二次繁荣。</p>
<h2 data-id="heading-7">6、SSE的技术特征</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a184670c054aacb1e067dea5b0d309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=P8Q7qlKyYsAdYWkdACiAiwrhRFY%3D" alt="" loading="lazy"/></p>
<p><strong>SSE和WebSocket 都能建立浏览器与服务器的长期通信，但区别很明显：</strong></p>
<ul>
<li>
<p>1）</p>
<p>SSE 是单向推送 不是双向推送， 而且是http协议的一个扩展协议， 使用简单、自动重连，适合文本类实时推送；</p>
</li>
<li>
<p>2）</p>
<p>WebSocket 是双向通信，不是 http协议的一个扩展协议，WebSocket 更灵活，但实现相对复杂。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/322662fc82644c5296c9cd8f43def280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=%2FccAZKNAK%2BcpdgQfshOhf795bik%3D" alt="" loading="lazy"/></p>
<p><strong>流程解读：</strong></p>
<ul>
<li>
<p>1）连接初始化：客户端使用特定的 Content-Type: text/event-stream 向服务器发起一个普通的 HTTP GET 请求。服务器确认并保持连接开放。</p>
</li>
<li>
<p>2）数据推送：服务器通过保持打开的连接，以纯文本格式（遵循 data: ...、event: ... 等规范）持续发送数据块。每个消息以两个换行符 \n\n 结束。</p>
</li>
<li>
<p>3）连接容错：如果连接因网络问题中断，SSE 客户端内置的机制会自动尝试重新建立连接，极大地提高了应用的鲁棒性。</p>
</li>
<li>
<p>4）客户端处理：浏览器端的 EventSource API 会解析收到的数据流，触发相应的事件（如 onmessage 或自定义事件），让开发者能够处理推送来的数据。</p>
</li>
</ul>
<p>SSE 的诞生是 Web 开发对简单、高效、标准化的服务器推送技术需求的直接结果。它有效地替代了笨拙的轮询技术，在与 WebSocket 的竞争中，找到了自身在单向数据流场景下的独特定位。</p>
<p>其发展历程经历了从概念提出、浏览器支持到成为正式标准的完整路径。尽管曾受限于 IE，但在现代浏览器中已成为一项稳定、可靠且被广泛采用的技术。如今，在实时通知、金融仪表盘、实时日志跟踪和大型语言模型（LLM）的流式响应输出等场景中，SSE 都是首选的解决方案。</p>
<h2 data-id="heading-8">7、默默无闻的SSE为何在AI大模型时代一夜爆火？</h2>
<p>SSE 最近站到聚光灯下，几乎可以说最大的推手就是当前 AI 应用（尤其是 ChatGPT 等大型语言模型）的爆发式增长。SSE 之所以成为 AI 应用的“标配”，是因为 SSE 与 AI 所需的“打字机” 输出模式 是 天作之合。</p>
<h5 data-id="heading-9">7.1 什么是AI大模型“打字机” 式的逐token输出？</h5>
<p>“打字机”式 逐 token 输出是一种流式传输方式，它模拟了人类打字或思考的过程。</p>
<p>服务器不是等待 LLM 生成整个答案 后一次性发送给 用户，而是 流式输出， 每生成一个“词元”（token，可以粗略理解为一个词或一个字），就立刻发送这个“词元”。</p>
<p>下面举一个例子，对比 一下 传统方式（非流式）和 “打字机” （流式）式 的过程。</p>
<p><strong>传统方式（非流式）过程如下：</strong></p>
<ul>
<li>
<p>1）你提问：“请写一首关于春天的诗”。</p>
</li>
<li>
<p>2）服务器端的 AI 开始思考、生成，整个过程你需要等待（可能好几秒甚至更久）。</p>
</li>
<li>
<p>3）AI 生成完整的诗歌：“春风拂面绿意浓，百花争艳映晴空...”。</p>
</li>
<li>
<p>4）服务器将整首诗作为一个完整的 JSON 对象 { "content": "春风拂面绿意浓，百花争艳映晴空..." } 发送给客户端。</p>
</li>
<li>
<p>5）客户端一次性收到全部内容并渲染出来。</p>
</li>
</ul>
<p><strong>“打字机”（流式）过程如下：</strong></p>
<ul>
<li>
<p>1）你提问：“请写一首关于春天的诗”。</p>
</li>
<li>
<p>2）服务器端的 AI 生成第一个 token “春”，立刻通过 SSE 发送 data: “春”。</p>
</li>
<li>
<p>3）客户端收到“春”并显示出来。</p>
</li>
<li>
<p>4）AI 生成第二个 token “风”，立刻发送 data: “风”。</p>
</li>
<li>
<p>5）客户端在“春”后面追加“风”，形成“春风”。</p>
</li>
<li>
<p>6）后续 token “拂”、“面”、“绿”、“意”、“浓”... 依次迅速发送和追加。</p>
</li>
<li>
<p>7）你看到的效果就是文字一个接一个地“打”在屏幕上，就像有人在远端为你实时打字一样。</p>
</li>
</ul>
<p><strong>“打字机”（流式） 模式的巨大优势：</strong></p>
<ul>
<li>
<p>1）极低的感知延迟：用户几乎在提问后瞬间就能看到第一个字开始输出，无需经历漫长的等待白屏期，体验流畅自然。</p>
</li>
<li>
<p>2）提供了“正在进行”的反馈：看着文字逐个出现，给人一种模型正在为你“思考”和“创作”的生动感，而不是在“沉默中宕机”。</p>
</li>
<li>
<p>3）更高效地利用时间：用户可以在前半句还在输出时，就开始阅读和理解，节省了总体的认知时间。</p>
</li>
</ul>
<h5 data-id="heading-10">7.2 为什么SSE跟AI大模型是“天作之合”？</h5>
<p>这正是 SSE 的设计初衷和核心优势所在，它与 AI 流式输出的需求完美匹配。</p>
<p><strong>1）单向通信的完美匹配：</strong></p>
<p>AI 的文本生成过程本质上是服务器到客户端的单向数据推送。客户端只需要接收，不需要在生成过程中频繁地发送请求。SSE 的“服务器推送”模型正是为此而生，而 WebSocket 的双向能力在这里是多余的。</p>
<p><strong>2）基于 HTTP/HTTPS，简单且兼容：</strong></p>
<p>SSE 使用标准的 HTTP 协议，这意味着 SSE 易于实现和调试：任何后端框架和前端语言都能轻松处理。在浏览器中调试时，你可以在“网络”选项卡中直接看到以文本流形式传输的事件，非常直观。</p>
<p>SSE 使用标准的 HTTP 协议，这还意味着 容易绕过网络障碍：公司防火墙和代理通常对 HTTP/HTTPS 放行，而可能会阻拦陌生的 WebSocket 协议。这使得 SSE 的部署兼容性极好。</p>
<p><strong>3）内置的自动重连机制：</strong></p>
<p>网络连接并不完全可靠。如果用户在接收很长的回答时网络波动，连接中断，SSE 客户端会自动尝试重新连接。这对于长时间流的应用至关重要，提供了天然的鲁棒性。</p>
<p><strong>4）轻量级的文本协议：</strong></p>
<p>AI 流式输出传输的就是文本（UTF-8编码）。SSE 的协议 data: ...\n\n 就是为传输文本片段而设计的，极其高效和简单。WebSocket 虽然也能传文本，但其协议设计还考虑了二进制帧、掩码等更复杂的情况，对于纯文本流来说显得有些“重”。</p>
<p><strong>5）原生浏览器 API：</strong></p>
<p>现代浏览器都原生支持 EventSource API，开发者无需引入额外的第三方库，即可轻松实现接收流式数据，减少了依赖和打包体积。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9fb4c3478254ea2918a4a690e978521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=gF4JHFrlJCQuzzQdmSUk6G0gq70%3D" alt="" loading="lazy"/></p>
<p><strong>所以，SSE 站到聚光灯下的原因正是：</strong></p>
<blockquote>
<p>AI 应用需要“打字机”式的逐 token 输出体验，而 SSE 作为一种基于 HTTP 的、简单的、单向的服务器推送技术，是实现这种体验最自然、最高效、最可靠的技术选择。</p>
</blockquote>
<p>它就像是为这个场景量身定做的工具，没有多余的功能，只有恰到好处的设计。因此，当 ChatGPT 等应用席卷全球时，其背后默默无闻的 SSE 技术也终于从幕后走到了台前，被广大开发者所重新认识和重视。</p>
<h2 data-id="heading-11">8、SSE的技术原理详解</h2>
<h5 data-id="heading-12">8.1 工作机制的流程图</h5>
<p>SSE 通过一个持久的 HTTP 连接实现服务器到客户端的单向数据流。</p>
<p><strong>以下是其工作机制的流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0633f5bf47f4d70b9abc82a91d177b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=S1k%2BMGRg2MmJpBSPfwDDrj%2BtMaQ%3D" alt="" loading="lazy"/></p>
<p>以下是关键步骤解析。</p>
<p>**1）**<strong>浏览器发起一个 HTTP 请求，Header 中包含：</strong></p>
<p>1Accept: text/event-stream</p>
<p>**2）**<strong>服务器响应类型必须为：</strong></p>
<blockquote>
<p>Content-Type: text/event-stream</p>
<p>Cache-Control: no-cache</p>
<p>Connection: keep-alive</p>
</blockquote>
<p>**3）**<strong>服务器发送事件格式（每个事件以两个换行符结束）：</strong></p>
<blockquote>
<p>event: message</p>
<p>data: {"time": "2023-10-05T12:00:00", "value": "New update!"}</p>
<p>id: 12345</p>
<p>retry: 5000</p>
<p>\n\n</p>
</blockquote>
<p><strong>4）</strong> 浏览器通过 EventSourceAPI 接收并处理事件。</p>
<p><strong>5）</strong> 服务器发送 一个特殊“结束”事件，可以结束传输。比如，服务器发送一个如 event: end 的消息，可以结束传输。客户端预先监听这个自定义的 end 事件，一旦收到，就知道传输结束，并可以选择主动关闭 EventSource 连接。</p>
<p><strong>6）</strong> 若连接中断，浏览器会根据 retry字段自动重连。如果没有收到 特殊“结束”事件， 浏览器 可以自动重连。</p>
<h5 data-id="heading-13">8.2 SSE与其他通信方式对比</h5>
<p><strong>不同通信技术各有适用场景，我们用表格清晰对比：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4d51ceadd64d1f8cd4814b6cb1ad4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=QbjwNfoOX7zGjEpfYMELfIoRPgk%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-14">8.3 SSE的适用场景</h5>
<p><strong>1）</strong> <strong>ChatGPT 式逐字输出( “打字机” 式逐 词元 token输出)：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2e80541e715465cb9280c98fad41ab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=y6Q7vikSKWsvBFkqleScGU0Y89Y%3D" alt="" loading="lazy"/></p>
<p><strong>2）</strong> <strong>实时通知系统：</strong></p>
<ul>
<li>a. 新订单提醒；</li>
<li>b. 用户消息推送；</li>
<li>c. 审核状态更新。</li>
</ul>
<p><strong>3）</strong> <strong>实时数据看板：</strong></p>
<ul>
<li>a. 股票行情；</li>
<li>b. 设备监控数据；</li>
<li>c. 实时日志流。</li>
</ul>
<h2 data-id="heading-15">9、SSE客户端API详解</h2>
<p>SSE的客户端实现非常简单，浏览器原生提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">EventSource</a>对象来处理与服务器的SSE连接。下面我们详细介绍它的使用方法和核心特性。</p>
<h5 data-id="heading-16">9.1 认识浏览器端EventSource对象</h5>
<p><strong>浏览器兼容性检测：</strong></p>
<p>在使用SSE前，首先需要确认当前浏览器是否支持EventSource（除IE/Edge外，几乎所有现代浏览器都支持）。</p>
<p><strong>检测方法如下：</strong></p>
<blockquote>
<p>// 检查浏览器是否支持SSE</p>
<p>if ('EventSource' in window) {</p>
<p>// 支持SSE，可正常使用</p>
<p>console.log('浏览器支持SSE');</p>
<p>} else {</p>
<p>// 不支持SSE，需降级处理</p>
<p>console.log('浏览器不支持SSE');</p>
<p>}</p>
</blockquote>
<p><strong>创建连接：</strong></p>
<p>使用EventSource创建与服务器的连接非常简单，只需传入服务器的SSE接口地址：</p>
<blockquote>
<p>// 建立与服务器的SSE连接</p>
<p>// url为服务器提供的SSE接口地址（可同域或跨域）</p>
<p>var source = new EventSource(url);</p>
</blockquote>
<p>如果需要跨域请求并携带Cookie，可通过第二个参数配置：</p>
<blockquote>
<p>// 跨域请求时，允许携带Cookie</p>
<p>var source = new EventSource(url, {</p>
<p>withCredentials: true // 默认为false，设为true表示跨域请求携带Cookie</p>
<p>});</p>
</blockquote>
<p><strong>连接状态（readyState）：</strong></p>
<p>EventSource实例的readyState属性用于表示当前连接状态，只读且有三个可能值：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0665e4e35db44802a6bdab42b88fdb92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=GGVUTCrxORXgwSn4HaiSLxX8KNo%3D" alt="" loading="lazy"/></p>
<p>可以通过该属性判断当前连接状态，例如：</p>
<blockquote>
<p>if (source.readyState === EventSource.OPEN) {</p>
<p>console.log('SSE连接已正常建立');</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-17">9.2 基本使用方法</h5>
<p>EventSource通过事件机制处理连接过程中的各种状态和接收的数据，核心事件包括<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Fopen_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/open_event" ref="nofollow noopener noreferrer">open</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Fmessage_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/message_event" ref="nofollow noopener noreferrer">message</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Ferror_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/error_event" ref="nofollow noopener noreferrer">error</a>。</p>
<p><strong>下面用流程图展示SSE客户端的完整使用流程：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a8616ce2940454ba932eb546b438900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=rGqyyt87%2FHisMPT2FfmadEt8zIs%3D" alt="" loading="lazy"/></p>
<p><strong>连接建立：open事件</strong></p>
<p>当客户端与服务器成功建立SSE连接时，会触发open事件：</p>
<blockquote>
<p>// 方式1：使用onopen属性</p>
<p>source.onopen = function (event) {</p>
<p>console.log('SSE连接已建立');</p>
<p>// 可在此处做连接成功后的初始化操作，如更新UI状态</p>
<p>};</p>
<p>// 方式2：使用addEventListener（推荐，可添加多个回调）</p>
<p>source.addEventListener('open', function (event) {</p>
<p>console.log('SSE连接已建立（监听方式）');</p>
<p>}, false);</p>
</blockquote>
<p><strong>接收数据：message事件</strong></p>
<p>当客户端收到服务器推送的数据时，会触发message事件（默认事件，处理未指定类型的消息）：</p>
<blockquote>
<p>// 方式1：使用onmessage属性</p>
<p>source.onmessage = function (event) {</p>
<p>// event.data为服务器推送的文本数据</p>
<p>var data = event.data;</p>
<p>console.log('收到数据：', data);</p>
<p>// 可在此处处理数据，如更新页面内容</p>
<p>};</p>
<p>// 方式2：使用addEventListener</p>
<p>source.addEventListener('message', function (event) {</p>
<p>var data = event.data;</p>
<p>console.log('收到数据（监听方式）：', data);</p>
<p>}, false);</p>
</blockquote>
<p>注意：event.data始终是字符串类型，如果服务器发送的是JSON数据，需要用JSON.parse(data)转换。</p>
<p><strong>连接错误：error事件</strong></p>
<p>当连接发生错误（如网络中断、服务器出错）时，会触发error事件：</p>
<blockquote>
<p>// 方式1：使用onerror属性</p>
<p>source.onerror = function (event) {</p>
<p>// 可根据readyState判断错误类型</p>
<p>if (source.readyState === EventSource.CONNECTING) {</p>
<p>console.log('连接出错，正在尝试重连...');</p>
<p>} else {</p>
<p>console.log('连接已关闭，无法重连');</p>
<p>}</p>
<p>};</p>
<p>// 方式2：使用addEventListener</p>
<p>source.addEventListener('error', function (event) {</p>
<p>// 错误处理逻辑</p>
<p>}, false);</p>
</blockquote>
<p><strong>关闭连接：close()方法</strong></p>
<p>如果需要主动关闭SSE连接（关闭后不会自动重连），可调用close()方法：</p>
<blockquote>
<p>// 主动关闭SSE连接</p>
<p>source.close();</p>
<p>console.log('SSE连接已手动关闭');</p>
</blockquote>
<h5 data-id="heading-18">9.3 自定义事件</h5>
<p>默认情况下，服务器推送的消息会触发message事件。但实际开发中，我们可能需要区分不同类型的消息（如"新订单通知"和"系统公告"），这时就可以使用自定义事件。</p>
<p>客户端通过addEventListener监听自定义事件名，例如监听order事件：</p>
<blockquote>
<p>// 监听名为"order"的自定义事件</p>
<p>source.addEventListener('order', function (event) {</p>
<p>var orderData = event.data;</p>
<p>console.log('收到新订单：', orderData);</p>
<p>// 处理订单相关逻辑</p>
<p>}, false);</p>
<p>// 再监听一个名为"notice"的自定义事件</p>
<p>source.addEventListener('notice', function (event) {</p>
<p>var noticeData = event.data;</p>
<p>console.log('收到系统公告：', noticeData);</p>
<p>// 处理公告相关逻辑</p>
<p>}, false);</p>
</blockquote>
<p>注意：自定义事件不会触发message事件，只会被对应的addEventListener捕获。</p>
<p>上面代码中，浏览器对 SSE 的foo``notice事件进行监听。如何实现服务器发送foo``notice事件，请看下文。</p>
<h2 data-id="heading-19">10、SSE服务器端技术详解</h2>
<p>服务器要实现SSE，核心是按照特定格式向客户端发送数据。下面详细介绍服务器端的实现规范。</p>
<h5 data-id="heading-20">10.1 HTTP 头信息要求</h5>
<p>服务器向客户端发送SSE数据时，必须设置以下HTTP响应头，否则客户端无法正确识别为事件流：</p>
<blockquote>
<p>Content-Type: text/event-stream // 必须，指定为事件流类型</p>
<p>Cache-Control: no-cache // 必须，禁止缓存，确保数据实时性</p>
<p>Connection: keep-alive // 必须，保持长连接</p>
</blockquote>
<p>这三个头信息是SSE的基础，缺少任何一个都可能导致连接失败或数据异常。</p>
<h5 data-id="heading-21">10.2 数据传输格式</h5>
<p>服务器发送的每条消息（message）由多行组成，每行格式为[字段]: 值\n（字段名后必须跟冒号和空格，结尾用换行符\n）。多条消息之间用\n\n（两个换行符）分隔。</p>
<p>此外，以 : 开头的行是注释（服务器可定期发送注释保持连接）。</p>
<p>基本格式示例：</p>
<blockquote>
<p>: 这是一条注释（客户端会忽略）\n</p>
<p>data: 这是第一条消息\n\n</p>
<p>data: 这是第二条消息的第一行\n</p>
<p>data: 这是第二条消息的第二行\n\n</p>
</blockquote>
<p>注意：换行符必须是\n（Unix格式），\r\n可能导致客户端解析错误。</p>
<h5 data-id="heading-22">10.3 核心字段说明</h5>
<p>SSE消息支持四个核心字段，分别用于不同场景。</p>
<p><strong>1）data字段：消息内容：</strong></p>
<p>data字段用于携带实际的消息内容，是最常用的字段。</p>
<p>单行数据：</p>
<blockquote>
<p>data: Hello, SSE!\n\n // 单行数据，以\n\n结束</p>
</blockquote>
<p><strong>多行数据（适合JSON等复杂结构）：</strong></p>
<blockquote>
<p>data: {\n // 第一行以\n结束</p>
<p>data: "name": "张三",\n // 第二行以\n结束</p>
<p>data: "age": 20\n // 第三行以\n结束</p>
<p>data: }\n\n // 最后一行以\n\n结束</p>
</blockquote>
<p>客户端接收后，event.data会自动拼接为完整字符串：{"name": "张三","age": 20}</p>
<p><strong>2）event字段：指定事件类型：</strong></p>
<p>event字段用于指定消息的事件类型，客户端可通过对应事件名监听（即<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html%2319" target="_blank" title="http://www.52im.net/thread-4885-1-1.html#19" ref="nofollow noopener noreferrer">9.3节的自定义事件</a>）。</p>
<p>服务器发送：</p>
<blockquote>
<p>event: order\n // 指定事件类型为order</p>
<p>data: 新订单ID：12345\n // 消息内容</p>
<p>\n // 消息结束（\n\n简化为单独一行）</p>
</blockquote>
<p><strong>客户端监听：</strong></p>
<blockquote>
<p>source.addEventListener('order', function(event) {</p>
<p>console.log(event.data); // 输出：新订单ID：12345</p>
<p>});</p>
</blockquote>
<p><strong>3）id字段：消息标识：</strong></p>
<p>id字段用于给消息设置唯一标识，客户端会自动记录最后一条消息的id（存于source.lastEventId）。</p>
<p>核心作用：当连接断线重连时，客户端会在请求头中携带Last-Event-ID: [最后收到的id]，服务器可根据该ID恢复数据传输（避免重复或丢失）。</p>
<p>服务器发送：</p>
<blockquote>
<p>id: msg1001\n // 消息标识</p>
<p>data: 这是第1001条消息\n</p>
<p>\n</p>
</blockquote>
<p>客户端重连时的请求头：</p>
<blockquote>
<p>Last-Event-ID: msg1001 // 自动携带最后收到的id</p>
</blockquote>
<p><strong>4）retry字段：重连间隔：</strong></p>
<p>retry字段用于指定客户端断线后的重连间隔（单位：毫秒），默认重连间隔约为3秒。</p>
<p>服务器发送：</p>
<blockquote>
<p>retry: 5000\n // 告诉客户端，断线后5秒再重连</p>
<p>data: 重连间隔已设置为5秒\n</p>
<p>\n</p>
</blockquote>
<p><strong>5）服务器保持连接示例：</strong></p>
<p>服务器可以定期发送注释行，保持连接活跃：</p>
<blockquote>
<p>: 这是保持连接活动的注释行\n</p>
<p>: 服务器时间 2023-10-05T12:00:00\n</p>
</blockquote>
<h5 data-id="heading-23">10.4 服务器发送流程</h5>
<p><strong>服务器发送SSE数据的完整流程如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4e2666d0d2d4be39601aabcb3d769cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=s0CuuwUqRPeakIwtpoXHeGx83ak%3D" alt="" loading="lazy"/></p>
<p><strong>下面是一个包含多种字段的服务器发送示例，模拟一个实时通知系统：</strong></p>
<blockquote>
<p>: 服务器开始发送消息（注释）\n</p>
<p>id: 1001\n</p>
<p>event: notice\n</p>
<p>data: 系统将在10分钟后维护\n\n</p>
<p>id: 1002\n</p>
<p>event: order\n</p>
<p>data: {"orderId": "20230501", "status": "paid"}\n\n</p>
<p>retry: 10000\n</p>
<p>id: 1003\n</p>
<p>data: 重连间隔已调整为10秒\n\n</p>
<p>: 这是保持连接活动的注释行\n</p>
<p>: 服务器时间 2023-10-05T12:00:00\n</p>
</blockquote>
<p><strong>客户端接收后：</strong></p>
<ul>
<li>
<p>1）notice事件会捕获到"系统将在10分钟后维护"</p>
</li>
<li>
<p>2）order事件会捕获到订单JSON数据</p>
</li>
<li>
<p>3）重连间隔被设置为10秒</p>
</li>
<li>
<p>4）最后收到的消息ID是1003（断线重连时会携带）</p>
</li>
</ul>
<p>通过以上规范，服务器就能轻松实现SSE功能，向客户端实时推送数据。相比WebSocket，SSE的服务器实现更简单，无需处理复杂的协议握手，只需按格式发送文本数据即可。</p>
<h2 data-id="heading-24">11、SSE实战代码示例（基于Spring Boot的实时通信）</h2>
<p>接下来， 通过一个完整案例 手把手教你用Spring Boot实现SSE功能。这个案例包含服务端（后端）和客户端（前端）代码， 可以直接运行体验服务器主动推送数据的效果。</p>
<h5 data-id="heading-25">11.1 案例整体架构</h5>
<p><strong>我们要实现的系统包含三个核心部分：</strong></p>
<ul>
<li>
<p>1）后端服务：基于Spring Boot，提供SSE连接接口、消息广播接口和任务进度推送接口；</p>
</li>
<li>
<p>2）前端页面：一个简单的HTML页面，通过EventSource与后端建立SSE连接；</p>
</li>
<li>
<p>3）交互流程：客户端连接后，可接收服务器主动推送的连接状态、广播消息和任务进度。</p>
</li>
</ul>
<p><strong>整体架构流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15a1251ea50746e7b078d4efa0436ff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=cQlKKS8y6JJ1CH5hd8wq1zvtSkA%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-26">11.2 服务端实现</h5>
<p><strong>11.2.1）准备依赖：</strong></p>
<p>首先创建Spring Boot项目，在pom.xml中添加以下依赖（用于web开发和页面渲染）：</p>
<blockquote>



<p>org.springframework.boot</p>
<p>spring-boot-starter-web</p>



<p>org.springframework.boot</p>
<p>spring-boot-starter-thymeleaf</p>


</blockquote>
<p>这些依赖是基础：spring-boot-starter-web提供了SSE核心类SseEmitter，spring-boot-starter-thymeleaf用于将HTML页面返回给浏览器。</p>
<p><strong>11.2.2）编写SSE核心控制器：</strong></p>
<p>创建SseController，这是服务端处理SSE连接和消息推送的核心类：</p>
<blockquote>
<p>package com.example.sse.controller;</p>
<p>import org.springframework.http.MediaType;</p>
<p>import org.springframework.web.bind.annotation.GetMapping;</p>
<p>import org.springframework.web.bind.annotation.RequestParam;</p>
<p>import org.springframework.web.bind.annotation.RestController;</p>
<p>import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</p>
<p>import java.io.IOException;</p>
<p>import java.util.concurrent.CopyOnWriteArrayList;</p>
<p>import java.util.concurrent.ExecutorService;</p>
<p>import java.util.concurrent.Executors;</p>
<p>@RestController</p>
<p>public class SseController {</p>
<p>// 存储所有活跃的SSE连接（线程安全的列表）</p>
<p>// CopyOnWriteArrayList适合读多写少场景，避免并发问题</p>
<p>private final CopyOnWriteArrayList emitters = new CopyOnWriteArrayList&lt;&gt;();</p>
<p>// 线程池：用于异步发送事件，避免阻塞主线程</p>
<p>private final ExecutorService executor = Executors.newCachedThreadPool();</p>
<p>/</p>
<p>* 客户端订阅SSE的接口</p>
<p>* 客户端通过访问该接口建立长连接，接收服务器推送的事件</p>
<p>*/</p>
<p>@GetMapping(value = "/sse/subscribe", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</p>
<p>public SseEmitter subscribe() {</p>
<p>// 创建SseEmitter实例，设置超时时间为无限（默认30秒会超时，这里设为Long.MAX_VALUE避免自动断开）</p>
<p>SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);</p>
<p>// 将新连接加入活跃列表（后续推送消息时会遍历这个列表）</p>
<p>emitters.add(emitter);</p>
<p>// 设置连接完成/超时的回调：从活跃列表中移除该连接，释放资源</p>
<p>emitter.onCompletion(() -&gt; emitters.remove(emitter)); // 连接正常关闭时</p>
<p>emitter.onTimeout(() -&gt; emitters.remove(emitter)); // 连接超时关闭时</p>
<p>// 发送初始连接成功消息（给客户端的"欢迎消息"）</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("CONNECTED") // 事件名称：客户端可通过"CONNECTED"事件监听</p>
<p>.data("You are successfully connected to SSE server!") // 消息内容</p>
<p>.reconnectTime(5000)); // 告诉客户端：如果断开连接，5秒后重连</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败时，标记连接异常结束</p>
<p>emitter.completeWithError(e);</p>
<p>}</p>
<p>return emitter; // 将emitter返回给客户端，保持连接</p>
<p>}</p>
<p>/</p>
<p>* 广播消息接口：向所有已连接的客户端推送消息</p>
<p>* 可通过浏览器访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fsse%2Fbroadcast%3Fmessage%3Dxxx" target="_blank" title="http://localhost:8080/sse/broadcast?message=xxx" ref="nofollow noopener noreferrer">http://localhost:8080/sse/broadcast?message=xxx</a> 触发</p>
<p>/</p>
<p>@GetMapping("/sse/broadcast")</p>
<p>public String broadcastMessage(@RequestParam String message) {</p>
<p>// 用线程池异步执行广播，避免阻塞当前请求</p>
<p>executor.execute(() -&gt; {</p>
<p>// 遍历所有活跃连接，逐个发送消息</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("BROADCAST") // 事件名称：客户端监听"BROADCAST"事件</p>
<p>.data(message) // 广播的消息内容</p>
<p>.id(String.valueOf(System.currentTimeMillis()))); // 消息ID（用于重连时定位）</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败（可能客户端已断开），从列表中移除并标记连接结束</p>
<p>emitters.remove(emitter);</p>
<p>emitter.completeWithError(e);</p>
<p>}</p>
<p>}</p>
<p>});</p>
<p>return "Broadcast message: " + message; // 给调用者的响应</p>
<p>}</p>
<p>/</p>
<p>* 模拟长时间任务：向客户端推送实时进度</p>
<p>* 适合文件上传、数据处理等需要实时反馈进度的场景</p>
<p>/</p>
<p>@GetMapping("/sse/start-task")</p>
<p>public String startTask() {</p>
<p>// 异步执行任务，避免阻塞当前请求</p>
<p>executor.execute(() -&gt; {</p>
<p>try {</p>
<p>// 模拟任务进度：从0%到100%，每次增加10%</p>
<p>for (int i = 0; i &lt;= 100; i += 10) {</p>
<p>Thread.sleep(1000); // 休眠1秒，模拟处理耗时</p>
<p>// 向所有客户端推送当前进度</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("PROGRESS") // 事件名称：客户端监听"PROGRESS"事件</p>
<p>.data(i + "% completed") // 进度数据</p>
<p>.id("task-progress")); // 固定ID，标识这是任务进度消息</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败，移除连接</p>
<p>emitters.remove(emitter);</p>
<p>}</p>
<p>}</p>
<p>// 任务完成时，发送结束消息</p>
<p>if (i == 100) {</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("COMPLETE") // 事件名称：客户端监听"COMPLETE"事件</p>
<p>.data("Task completed successfully!"));</p>
<p>} catch (IOException e) {</p>
<p>emitters.remove(emitter);</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>} catch (InterruptedException e) {</p>
<p>// 任务被中断时，恢复线程中断状态并退出</p>
<p>Thread.currentThread().interrupt();</p>
<p>break;</p>
<p>}</p>
<p>});</p>
<p>return "Task started!"; // 告诉调用者任务已启动</p>
<p>}</p>
<p>}</p>
</blockquote>
<p>核心代码说明：</p>
<ul>
<li>
<p>1）SseEmitter：Spring提供的SSE核心类，每个实例对应一个客户端连接；</p>
</li>
<li>
<p>2）emitters列表：管理所有活跃连接，方便广播消息（类似"客户端注册表"）；</p>
</li>
<li>
<p>3）executor线程池：异步处理消息发送，避免阻塞主线程（如果同步发送，一个客户端卡住会影响所有用户）。</p>
</li>
</ul>
<p>事件发送：通过</p>
<p>emitter.send(SseEmitter.event())</p>
<p>构建消息，可指定事件名、数据、ID和重连时间。</p>
<p><strong>11.2.3）编写页面控制器：</strong></p>
<p>创建PageController，用于将前端页面返回给浏览器：</p>
<blockquote>
<p>package com.example.sse.controller;</p>
<p>import org.springframework.stereotype.Controller;</p>
<p>import org.springframework.web.bind.annotation.GetMapping;</p>
<p>@Controller // 注意这里用@Controller而非@RestController，用于返回页面</p>
<p>public class PageController {</p>
<p>/*</p>
<p>* 访问根路径时，返回SSE客户端页面</p>
<p>/</p>
<p>@GetMapping("/")</p>
<p>public String index() {</p>
<p>// 返回src/main/resources/templates目录下的sse-client.html</p>
<p>return "sse-client";</p>
<p>}</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-27">11.3 客户端实现（HTML页面）</h5>
<p>在</p>
<p>src/main/resources/templates</p>
<p>目录下创建</p>
<p>sse-client.html</p>
<p>，这是用户交互的前端页面：</p>
<blockquote>
<p>Server-Sent Events (SSE) Client Connect to SSE Disconnect Send Broadcast Start Task Messages:</p>
</blockquote>
<p>客户端核心逻辑：</p>
<ul>
<li>
<p>1）eventSource：EventSource实例，是客户端与服务端SSE连接的"桥梁"；</p>
</li>
<li>
<p>2）事件监听：通过addEventListener监听服务端定义的事件（CONNECTED/BROADCAST等）；</p>
</li>
<li>
<p>3）自动重连：当连接断开时，EventSource会自动重试（无需手动写重连逻辑）；</p>
</li>
<li>
<p>4）交互函数：connectSSE/disconnectSSE等函数对应页面按钮，实现用户操作。</p>
</li>
</ul>
<h5 data-id="heading-28">11.4 运行与测试</h5>
<p>启动步骤：</p>
<ul>
<li>
<p>1）确保Spring Boot项目配置正确（默认端口8080，无需额外配置）；</p>
</li>
<li>
<p>2）启动Spring Boot应用（运行带有main方法的启动类）；</p>
</li>
<li>
<p>3）打开浏览器，访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2F%25EF%25BC%258C%25E7%259C%258B%25E5%2588%25B0%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E9%25A1%25B5%25E9%259D%25A2%25E3%2580%2582" target="_blank" title="http://localhost:8080/%EF%BC%8C%E7%9C%8B%E5%88%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%A1%B5%E9%9D%A2%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8080/，看到客户端页面。</a></p>
</li>
</ul>
<p>功能测试：</p>
<ul>
<li>
<p>1）建立连接：点击"Connect to SSE"按钮，页面会显示"连接成功"的消息（服务端通过CONNECTED事件推送）</p>
</li>
<li>
<p>2）发送广播：点击"Send Broadcast"按钮，输入任意消息（如"Hello SSE"），页面会显示广播消息（服务端向所有连接的客户端推送）</p>
</li>
<li>
<p>3）启动任务：点击"Start Task"按钮，页面会每秒收到一条进度消息（从0%到100%），最后显示"任务完成"</p>
</li>
<li>
<p>4）断开连接：点击"Disconnect"按钮，连接关闭，不再接收消息。</p>
</li>
</ul>
<p>测试流程图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb6bb445b3ea4f69b8b9f8fe29820d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=ZoLX8oLsfdVda7NTuAMb3DGdzgY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-29">11.5 服务端的关键技术点</h5>
<p>1）SseEmitter的作用：Spring封装的SSE工具类，简化了"保持连接+发送事件"的实现，无需手动处理HTTP流格式。</p>
<p>2）连接管理：用CopyOnWriteArrayList存储活跃连接，确保线程安全；通过onCompletion/onTimeout回调清理无效连接，避免内存泄漏。</p>
<p>3）异步处理：必须用线程池（ExecutorService）异步发送消息，否则会阻塞主线程，导致新请求无法处理。</p>
<p>4）事件设计：通过name区分不同类型的事件（如PROGRESS/BROADCAST），客户端按需监听，逻辑更清晰。</p>
<p>5）自动重连：SSE客户端（EventSource）内置重连机制，网络恢复后会自动重新连接，无需额外代码。</p>
<p>通过这个案例，你可以清晰看到SSE的优势：实现简单（几行代码就能建立实时连接）、无需额外协议（基于HTTP）、自带重连机制。如果你的场景只需要服务器单向推送数据（如实时通知、进度更新），SSE会是比WebSocket更轻量的选择。</p>
<h2 data-id="heading-30">12、选SSE还是选WebSocket？</h2>
<h5 data-id="heading-31">12.1 SSE与WebSocket全面对比</h5>
<p>来对 Server-Sent Events (SSE) 和 WebSocket 进行一场全面、深入的对比。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aaebc4c98a043faa9175d85e4e5b65a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=DMePC%2BYwZs%2BruJ4QjQTwsX3O7a0%3D" alt="" loading="lazy"/></p>
<p>为了更直观地理解两者的工作模式差异，请看下面的序列图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/438907c5f6d244a0ab1a0aa47fa198a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=qHrXbnWmuFp7VgX4bdHMB89jwb0%3D" alt="" loading="lazy"/></p>
<p><strong>1）协议与连接建立：</strong></p>
<p>SSE 协议与连接建立：</p>
<ul>
<li>a. 基于纯粹的 HTTP。客户端发起一个普通的 HTTP GET 请求，并携带特殊的头 Accept: text/event-stream。</li>
<li>b. 服务器响应后，保持这个 TCP 连接打开，并开始发送数据流 ，直到遇到结束标记。</li>
<li>c. 这是一种长连接的 HTTP 用法。</li>
</ul>
<p>WebSocket 协议与连接建立：</p>
<ul>
<li>a. 基于独立的 WebSocket 协议。连接始于一个特殊的 HTTP 请求，即 “协议升级”请求（Connection: Upgrade, Upgrade: websocket）。</li>
<li>b. 服务器响应 HTTP 101 Switching Protocols 后，最初的 HTTP 连接被替换为 WebSocket 连接，此后通信不再遵循 HTTP 协议，而是在其之上建立一个全双工的通道。</li>
</ul>
<p><strong>2）数据流与通信模式：</strong></p>
<p>SSE：单向通信。设计初衷就是让服务器能够主动、高效地向客户端推送数据。•数据是文本流，格式简单且可读性强。每条消息可以附带一个事件类型（event:）和一个ID（id:）。•客户端使用 EventSource API 监听来自服务器的事件。</p>
<p>WebSocket：全双工通信。在连接建立后，客户端和服务器处于完全平等的地位，可以随时、任意地相互发送消息。 另外，WS协议 支持文本和二进制数据，灵活性极高，非常适合需要频繁双向交互的场景（如游戏、协作编辑）。</p>
<p><strong>3）能力与特性：</strong></p>
<p>SSE：内置自动重连机制。如果连接断开，EventSource 对象会自动尝试重新连接，并在重连后自动发送上一个收到的事件ID，服务器据此可判断错过了哪些消息，实现数据恢复。SSE有出色的浏览器支持。所有现代浏览器（Chrome, Firefox, Safari, Edge）都原生支持，Internet Explorer （古代浏览器）完全不支持（通常需要 polyfill 或降级方案）。</p>
<p>WebSocket：无自动重连。连接断开后，需要开发者手动编写重连逻辑和状态恢复逻辑。WS协议比SSE协议有更广泛的浏览器支持，包括 Internet Explorer 10+。</p>
<p><strong>4）开发与集成：</strong></p>
<p>SSE：开发与集成 非常简单。服务器端几乎不需要特殊的库，任何能输出 HTTP 流的后端语言都可以实现。客户端 API 也非常直观。与现有 HTTP 认证、CORS 机制完全兼容，处理方式与普通 HTTP 请求一致。</p>
<p>WebSocket：开发与集成 相对复杂。服务器端需要支持 WebSocket 协议的库（如 ws for Node.js, Socket.IO 等）。客户端需要处理连接状态、心跳包等。 虽然升级握手是 HTTP，但后续通信是独立协议，因此一些复杂的网络环境（如某些代理服务器）可能会带来问题。</p>
<h5 data-id="heading-32">12.2 SSE与WebSocket到底该如何选择？</h5>
<p>选择的关键在于应用场景和核心需求。</p>
<p><strong>* 选择 SSE 的场景：</strong></p>
<p>选择 SSE 的场景包括：</p>
<ul>
<li>
<p>1）服务器到客户端的单向数据流。</p>
</li>
<li>
<p>2）简单和快速实现是关键因素。</p>
</li>
<li>
<p>3）需要自动错误恢复（重连）。</p>
</li>
<li>
<p>4）数据传输格式是文本（如 JSON），且不需要二进制。</p>
</li>
</ul>
<p>SSE 典型的应用场景包括：</p>
<ul>
<li>
<p>1）实时新闻推送、体育比分更新。</p>
</li>
<li>
<p>2）金融报价行情（如股票价格变动）。</p>
</li>
<li>
<p>3）社交媒体动态更新（如 Twitter 时间线）。</p>
</li>
<li>
<p>4）服务器日志流监控。</p>
</li>
<li>
<p>5）AI 处理进度或结果的流式输出。</p>
</li>
</ul>
<p><strong>* 选择 WebSocket 场景：</strong></p>
<p>选择 WebSocket 的场景包括：</p>
<ul>
<li>
<p>1）真正的实时双向通信，客户端和服务器都需要频繁地发送消息。</p>
</li>
<li>
<p>2）需要传输二进制数据（如视频、音频、图像碎片）。</p>
</li>
<li>
<p>3）构建交互性极强的应用，其中低延迟至关重要。</p>
</li>
</ul>
<p>WebSocket 典型的应用场景包括：</p>
<ul>
<li>
<p>1）实时在线聊天应用（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fslack.com%2F" target="_blank" title="https://slack.com/" ref="nofollow noopener noreferrer">Slack</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fmusclegrowth.net%2Fdiscord%2F" target="_blank" title="https://musclegrowth.net/discord/" ref="nofollow noopener noreferrer">Discord</a>、<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2470-1-1.html" target="_blank" title="http://www.52im.net/thread-2470-1-1.html" ref="nofollow noopener noreferrer">RainbowChat-Web</a>）。</p>
</li>
<li>
<p>2）多人在线游戏。</p>
</li>
<li>
<p>3）协同编辑工具（如 Google Docs）。</p>
</li>
<li>
<p>4）实时仪表盘和控制面板（需要双向控制）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccbb02df35914642b1af8b1ae92e580f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=d33l0IdL4Gmaepr82YE11B4vdV0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-33">12.3 WebSocket+SSE 混合架构</h5>
<p>一般来说大型应用场景，强网用 WebSocket、弱网适合使用SSE ，这就是WebSocket+SSE 混合架构。强网用 WebSocket、弱网自动降级到 SSE 的混合架构， 核心在于网络质量动态评估和双通道无缝切换。</p>
<p><strong>WebSocket+SSE 混合架构 具体实现方案如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c069ed9bfa5444b8bcb36247cb488dfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Y3ueSABULQ%2FNO8kUKux683cJn4U%3D" alt="" loading="lazy"/></p>
<p>核心模块：网络质量探针（客户端） 实现</p>
<blockquote>
<p>class NetworkProbe {</p>
<p>// 关键指标</p>
<p>static RTT_THRESHOLD = 300 // RTT超过300ms视为弱网</p>
<p>static PACKET_LOSS_THRESHOLD = 0.2 // 丢包率&gt;20%触发降级</p>
<p>// 网络状态检测</p>
<p>async check() {</p>
<p>const { rtt, packetLoss } = await this._measure()</p>
<p>return {</p>
<p>isWeak: rtt &gt; NetworkProbe.RTT_THRESHOLD ||</p>
<p>packetLoss &gt; NetworkProbe.PACKET_LOSS_THRESHOLD</p>
<p>}</p>
<p>}</p>
<p>// 实际测量方法</p>
<p>_measure() {</p>
<p>return new Promise(resolve =&gt; {</p>
<p>const start = Date.now()</p>
<p>fetch('/ping', { cache: 'no-store' })</p>
<p>.then(() =&gt; {</p>
<p>const rtt = Date.now() - start</p>
<p>resolve({ rtt, packetLoss: 0 })</p>
<p>})</p>
<p>.catch(() =&gt; resolve({ rtt: Infinity, packetLoss: 1 }))</p>
<p>})</p>
<p>}</p>
<p>}</p>
</blockquote>
<p>核心模块：双协议连接管理器（客户端）</p>
<blockquote>
<p>class HybridConnection {</p>
<p>constructor() {</p>
<p>this.currentProtocol = null</p>
<p>this.ws = null</p>
<p>this.sse = null</p>
<p>this.messageQueue = [] // 消息缓冲队列</p>
<p>}</p>
<p>// 智能连接初始化</p>
<p>async connect() {</p>
<p>const { isWeak } = await new NetworkProbe().check()</p>
<p>this.currentProtocol = isWeak ? 'sse' : 'ws'</p>
<p>if (this.currentProtocol === 'ws') {</p>
<p>this._initWebSocket()</p>
<p>} else {</p>
<p>this._initSSE()</p>
<p>}</p>
<p>}</p>
<p>// WebSocket初始化</p>
<p>_initWebSocket() {</p>
<p>this.ws = new WebSocket('wss://api.example.com')</p>
<p>this.ws.onmessage = this._handleMessage</p>
<p>// 发送缓冲队列消息</p>
<p>this.messageQueue.forEach(msg =&gt; this.ws.send(msg))</p>
<p>this.messageQueue = []</p>
<p>}</p>
<p>// SSE初始化</p>
<p>_initSSE() {</p>
<p>this.sse = new EventSource('<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.example.com%2Fsse" target="_blank" title="https://api.example.com/sse" ref="nofollow noopener noreferrer">api.example.com/sse</a>')</p>
<p>this.sse.onmessage = this._handleMessage</p>
<p>}</p>
<p>// 统一消息处理</p>
<p>_handleMessage = (event) =&gt; {</p>
<p>const data = event.data || event</p>
<p>// 业务逻辑处理...</p>
<p>}</p>
<p>// 发送消息（自动选择协议）</p>
<p>send(data) {</p>
<p>if (this.currentProtocol === 'ws' &amp;&amp; this.ws?.readyState === 1) {</p>
<p>this.ws.send(JSON.stringify(data))</p>
<p>} else if (this.currentProtocol === 'sse') {</p>
<p>// SSE需通过独立HTTP请求发送</p>
<p>fetch('/send', { method: 'POST', body: JSON.stringify(data) })</p>
<p>} else {</p>
<p>// 协议切换中暂存消息</p>
<p>this.messageQueue.push(JSON.stringify(data))</p>
<p>}</p>
<p>}</p>
<p>// 协议切换（核心！）</p>
<p>async switchProtocol() {</p>
<p>const { isWeak } = await new NetworkProbe().check()</p>
<p>// 无需切换</p>
<p>if (isWeak &amp;&amp; this.currentProtocol === 'sse') return</p>
<p>if (!isWeak &amp;&amp; this.currentProtocol === 'ws') return</p>
<p>// 执行切换</p>
<p>if (isWeak) {</p>
<p>this.ws?.close()</p>
<p>this._initSSE()</p>
<p>this.currentProtocol = 'sse'</p>
<p>} else {</p>
<p>this.sse?.close()</p>
<p>this._initWebSocket()</p>
<p>this.currentProtocol = 'ws'</p>
<p>}</p>
<p>}</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-34">12.4 AI大模型中该选择SSE协议还是WebSocket？</h5>
<p>直接答案：对于绝大多数 chat2ai 应用 优先选择 SSE (Server-Sent Events)。复杂的 chat2ai 应用 优先选择WebSocket。</p>
<p>但这并非绝对，我们需要根据具体的功能需求来决定。下面我将为你进行详细的分析和推理。</p>
<p><strong>12.4.1）核心决策分析：</strong></p>
<p>AI聊天应用的核心交互是：</p>
<ul>
<li>
<p>1）</p>
<p>客户端发送一条消息（一个问题）。</p>
</li>
<li>
<p>2）</p>
<p>服务器接收后，调用大语言模型（LLM）API。</p>
</li>
<li>
<p>3）</p>
<p>服务器将模型流式返回的答案（逐词或逐句）实时推送给客户端。</p>
</li>
<li>
<p>4）</p>
<p>客户端实时渲染这个流式的答案，营造出“打字机”效果。</p>
</li>
</ul>
<p>这个过程的关键在于第3步，即服务器向客户端的单向数据推送。这正是 SSE 的绝对主场。</p>
<p><strong>12.4.2）为什么 SSE 是更优的选择？</strong></p>
<p>以下流程图清晰地展示了基于不同技术方案的聊天交互过程，其中突出了SSE方案的巨大优势：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8e057bbe924ce19a235f05af351f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=KPobLykKPNjUCWRdG0lcrdAsONY%3D" alt="" loading="lazy"/></p>
<p>正如上图所示：SSE 方案在实现上更加直接和高效，因为它基于 HTTP，并且专门为服务器到客户端的单向数据流设计。</p>
<p>此外，SSE 还带来了以下巨大优势：</p>
<p><strong>1）</strong> <strong>开发复杂度极低：</strong></p>
<ul>
<li>a. 后端：你不需要引入任何复杂的 WebSocket 库（如 ws, Socket.IO）。你只需要建立一个普通的 HTTP 路由（如 POST /chat 用于发送消息，GET /chat/stream 用于接收流），并在控制器中输出 text/event-stream 格式的响应流。</li>
<li>b. 前端：使用浏览器原生的 EventSource API 即可轻松监听数据流，几行代码就能实现。无需实例化和管理 WebSocket 连接对象。</li>
</ul>
<p><strong>2）</strong> <strong>出色的兼容性与可维护性：</strong></p>
<ul>
<li>a. SSE 基于 HTTP，这意味着它更容易通过公司防火墙、代理，与现有的认证系统（如 Cookie、JWT）、CORS 策略协同工作，几乎不会遇到奇怪的网络问题。</li>
<li>b. 在浏览器“网络”选项卡中，SSE 的流清晰可见，易于调试。每个消息都是可读的文本，调试体验非常好。</li>
</ul>
<p><strong>3）</strong> <strong>内置的自动重连与断点续传机制：</strong></p>
<ul>
<li>a. 这是 SSE 的“杀手级特性”。网络连接不稳定是移动端的常见问题。如果用户在接收一个很长答案的过程中网络中断，SSE 会在网络恢复后自动重新连接。</li>
<li>b. 更强大的是，SSE 协议支持发送最后一个消息的 ID。服务器可以识别出这个 ID，并判断客户端错过了哪些数据，从而从断点处继续发送，而不是重新开始生成整个回答。这既节省了昂贵的 API 调用费用，也提升了用户体验。这在 WebSocket 中需要手动实现所有逻辑，非常复杂。</li>
</ul>
<p><strong>12.4.3）WebSocket 的适用场景：</strong></p>
<p>虽然 SSE 是主流选择，但在 chat2ai 应用变得非常复杂时，WebSocket 可能会成为更好的选择。</p>
<p>在以下情况下， 应该考虑使用 WebSocket：</p>
<p><strong>1）</strong> 需要极高频的双向通信：不仅仅是用户提问-&gt;AI回答。例如：</p>
<ul>
<li>a. 实时协作编辑：多个用户同时编辑一份由 AI 生成的文档，每个人的输入都需要实时同步给其他所有人。</li>
<li>b. AI多人游戏：基于 AI 生成剧情和环境的实时互动游戏，玩家的每一个动作都需要实时影响虚拟世界。</li>
</ul>
<p><strong>2）</strong> 当需要传输二进制数据的时候：有的聊天应用不仅支持文本，还支持实时语音对话（客户端录音发送二进制音频流，服务器返回 AI 语音二进制流）。WebSocket 对二进制数据的支持是天生的。</p>
<p><strong>3）</strong> 你需要非常精确的控制心跳和连接状态： - WebSocket 允许 手动发送 Ping/Pong 帧来检测连接活性，虽然复杂，但给了开发人员最大的控制权。</p>
<h5 data-id="heading-35">12.4.4）传输协议选型 结论与建议：</h5>
<p>1）起步和绝大多数情况：从 SSE 开始。这是最直接、最高效、最能给你带来稳定体验的选择。使用sse 遇到的技术挑战会更少，开发速度更快。ChatGPT、Claude 等绝大多数顶级应用都使用 SSE 不是没有道理的。</p>
<p>2）未来如果需要扩展：采用混合架构。如果应用未来需要加入上述 WebSocket 的适用功能（如实时语音），完全可以同时使用两种协议：使用 SSE 专门处理 AI 文本答案的流式推送。使用 WebSocket 专门处理 实时语音、实时协作等真正的双向通信功能。或者 强弱结合，自动切换。</p>
<p>因此，对于 chat2ai 的传输协议选型答案是：优先选择 SSE。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/484ea894f46647a2a980d06fe567a49d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=kFA89ymF3MXJCMN9K%2FR9e6%2FjFvY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-36">13、参考资料</h2>
<p>[0] <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">EventSource API Docs</a></p>
<p>[1] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-336-1-1.html" target="_blank" title="http://www.52im.net/thread-336-1-1.html" ref="nofollow noopener noreferrer">Web端即时通讯技术盘点：短轮询、Comet、Websocket、SSE</a></p>
<p>[2] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-335-1-1.html" target="_blank" title="http://www.52im.net/thread-335-1-1.html" ref="nofollow noopener noreferrer">SSE技术详解：一种全新的HTML5服务器推送事件技术</a></p>
<p>[3] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-907-1-1.html" target="_blank" title="http://www.52im.net/thread-907-1-1.html" ref="nofollow noopener noreferrer">使用WebSocket和SSE技术实现Web端消息推送</a></p>
<p>[4] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1038-1-1.html" target="_blank" title="http://www.52im.net/thread-1038-1-1.html" ref="nofollow noopener noreferrer">详解Web端通信方式的演进：从Ajax、JSONP 到 SSE、Websocket</a></p>
<p>[5] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-907-1-1.html" target="_blank" title="http://www.52im.net/thread-907-1-1.html" ref="nofollow noopener noreferrer">使用WebSocket和SSE技术实现Web端消息推送</a></p>
<p>[6] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2719-1-1.html" target="_blank" title="http://www.52im.net/thread-2719-1-1.html" ref="nofollow noopener noreferrer">一文读懂前端技术演进：盘点Web前端20年的技术变迁史</a></p>
<p>[7] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3134-1-1.html" target="_blank" title="http://www.52im.net/thread-3134-1-1.html" ref="nofollow noopener noreferrer">WebSocket从入门到精通，半小时就够！</a></p>
<p>[8] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3555-1-1.html" target="_blank" title="http://www.52im.net/thread-3555-1-1.html" ref="nofollow noopener noreferrer">网页端IM通信技术快速入门：短轮询、长轮询、SSE、WebSocket</a></p>
<p>[9] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3695-1-1.html" target="_blank" title="http://www.52im.net/thread-3695-1-1.html" ref="nofollow noopener noreferrer">搞懂现代Web端即时通讯技术一文就够：WebSocket、socket.io、SSE</a></p>
<p>[10] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4831-1-1.html" target="_blank" title="http://www.52im.net/thread-4831-1-1.html" ref="nofollow noopener noreferrer">大模型时代多模型AI网关的架构设计与实现</a></p>
<p>[11] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4797-1-1.html" target="_blank" title="http://www.52im.net/thread-4797-1-1.html" ref="nofollow noopener noreferrer">全民AI时代，大模型客户端和服务端的实时通信到底用什么协议？</a></p>
<p>[12] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4856-1-1.html" target="_blank" title="http://www.52im.net/thread-4856-1-1.html" ref="nofollow noopener noreferrer">通俗易懂：AI大模型基于SSE的实时流式响应技术原理和实践示例</a></p>
<p>[13] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4832-1-1.html" target="_blank" title="http://www.52im.net/thread-4832-1-1.html" ref="nofollow noopener noreferrer">Web端实时通信技术SSE在携程机票业务中的实践应用</a></p>
<p>[14] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4872-1-1.html" target="_blank" title="http://www.52im.net/thread-4872-1-1.html" ref="nofollow noopener noreferrer">ChatGPT如何实现聊天一样的实时交互？快速读懂SSE实时“推”技术</a></p>
<p>（本文已同步发布于：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html" target="_blank" title="http://www.52im.net/thread-4885-1-1.html" ref="nofollow noopener noreferrer">www.52im.net/thread-4885…</a>）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger]]></title>    <link>https://juejin.cn/post/7586687526866714639</link>    <guid>https://juejin.cn/post/7586687526866714639</guid>    <pubDate>2025-12-23T07:48:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526866714639" data-draft-id="7586687526866698255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T07:48:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:48:27.000Z" title="Tue Dec 23 2025 07:48:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在高并发系统中，多个线程之间的协作是不可避免的。Java 从 JDK 1.5 开始引入了 <code>java.util.concurrent</code>（JUC）包，其中包含了一系列强大的线程协作工具类，极大简化了并发编程的复杂性。</p>
<h2 data-id="heading-0">CountDownLatch（JDK 5+）：倒计时门闩</h2>
<h3 data-id="heading-1">使用场景</h3>
<p><code>CountDownLatch</code> 常用于“一个或多个线程等待其他线程完成任务后再继续执行”的场景，例如：</p>
<ul>
<li>主线程等待所有子线程初始化完毕再启动服务。</li>
<li>并发测试中模拟 N 个请求同时发出后统计总耗时。</li>
<li>资源加载完成后统一触发后续逻辑。</li>
</ul>
<h3 data-id="heading-2">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CountDownLatch</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> count</span>)</span>;        <span class="hljs-comment">// 初始化计数器</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">await</span>() throws InterruptedException</span>;          <span class="hljs-comment">// 阻塞等待计数归零</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">await</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> timeout, TimeUnit unit</span>)</span>;       <span class="hljs-comment">// 带超时的等待</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">countDown</span>()</span>;                                 <span class="hljs-comment">// 计数减一</span>
</code></pre>
<h3 data-id="heading-3">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CountDownLatchExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>) throws InterruptedException</span> {
        <span class="hljs-built_in">int</span> threadCount = <span class="hljs-number">5</span>;
        CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(threadCount);

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; threadCount; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 正在执行任务..."</span>);
                    Thread.sleep(<span class="hljs-number">1000</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown(); <span class="hljs-comment">// 任务完成，计数减一</span>
                }
            }).start();
        }

        latch.<span class="hljs-keyword">await</span>(); <span class="hljs-comment">// 主线程等待所有任务完成</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"所有任务已完成，主线程继续执行！"</span>);
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-erlang" lang="erlang">Thread-<span class="hljs-number">0</span> 正在执行任务...
Thread-<span class="hljs-number">1</span> 正在执行任务...
Thread-<span class="hljs-number">3</span> 正在执行任务...
Thread-<span class="hljs-number">2</span> 正在执行任务...
Thread-<span class="hljs-number">4</span> 正在执行任务...
所有任务已完成，主线程继续执行！
</code></pre>
<h3 data-id="heading-4">应用场景示例</h3>
<p><strong>服务启动检查：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 等待数据库、缓存、消息队列初始化完成</span>
CountDownLatch startupLatch = new <span class="hljs-built_in">CountDownLatch</span>(<span class="hljs-number">3</span>);
<span class="hljs-built_in">initDB</span>(startupLatch);
<span class="hljs-built_in">initCache</span>(startupLatch);
<span class="hljs-built_in">initMQ</span>(startupLatch);
startupLatch<span class="hljs-selector-class">.await</span>();
<span class="hljs-built_in">startHttpServer</span>();
</code></pre>
<h3 data-id="heading-5">使用注意点</h3>
<ul>
<li><strong>不可重用</strong>：一旦计数归零，无法再次使用（除非新建实例）。需要重复使用的场景应考虑 <code>CyclicBarrier</code>，</li>
<li>若某个线程未调用 <code>countDown()</code>，会导致主线程永久阻塞， 导致死锁，所以务必在 finally 块中调用。</li>
<li><code>await()</code> 可被中断，需处理 <code>InterruptedException</code>。</li>
</ul>
<h3 data-id="heading-6">底层原理</h3>
<p><code>CountDownLatch</code> 基于 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267767541%26content_type%3DArticle%26match_order%3D1%26q%3DAQS%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267767541&amp;content_type=Article&amp;match_order=1&amp;q=AQS&amp;zhida_source=entity" ref="nofollow noopener noreferrer">AQS</a>（AbstractQueuedSynchronizer）</strong>  实现：（AQS 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li>内部状态 <code>state</code> 表示剩余计数值。</li>
<li><code>await()</code> 对应 AQS 的 <code>acquireSharedInterruptibly(1)</code>，尝试获取共享锁，若 <code>state != 0</code> 则入队阻塞。</li>
<li><code>countDown()</code> 调用 <code>releaseShared(1)</code>，将 <code>state</code> 减 1，当 <code>state == 0</code> 时唤醒所有等待线程。</li>
</ul>
<h2 data-id="heading-7">CyclicBarrier（JDK 5+）：循环屏障</h2>
<h3 data-id="heading-8">使用场景</h3>
<p><code>CyclicBarrier</code> 适用于“多个线程互相等待，全部到达某一点后才能继续”的场景，例如：</p>
<ul>
<li>多线程分阶段计算（每阶段结束后汇总结果）。</li>
<li>游戏开发中等待所有玩家准备就绪。</li>
<li>并行算法中的同步点。</li>
</ul>
<h3 data-id="heading-9">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CyclicBarrier</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties</span>)</span>; 
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CyclicBarrier</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties, Runnable barrierAction</span>)</span>; <span class="hljs-comment">// 所有线程到达后执行的动作</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">await</span>() throws InterruptedException, BrokenBarrierException</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">await</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> timeout, TimeUnit unit</span>) throws ...</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reset</span>()</span>; <span class="hljs-comment">// 重置屏障（可能中断当前等待）</span>
</code></pre>
<h3 data-id="heading-10">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CyclicBarrierExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        CyclicBarrier barrier = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">3</span>, () -&gt; {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"所有线程已到达屏障，执行汇总操作！"</span>);
        });

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 第一阶段完成"</span>);
                    barrier.<span class="hljs-keyword">await</span>(); <span class="hljs-comment">// 等待其他线程</span>

                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 第二阶段开始"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs">Thread-1 第一阶段完成
Thread-2 第一阶段完成
Thread-0 第一阶段完成
所有线程已到达屏障，执行汇总操作！
Thread-0 第二阶段开始
Thread-1 第二阶段开始
Thread-2 第二阶段开始
</code></pre>
<h3 data-id="heading-11">应用场景示例</h3>
<p><strong>多轮并行计算：</strong></p>
<pre><code class="hljs language-ini" lang="ini">CyclicBarrier <span class="hljs-attr">barrier</span> = new CyclicBarrier(<span class="hljs-number">4</span>, this::aggregateResults)<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 4; i++) {</span>
    executor.submit(() -&gt; {
        while (round &lt; MAX_ROUNDS) {
            computePartialResult()<span class="hljs-comment">;</span>
            barrier.await()<span class="hljs-comment">; // 同步进入下一轮</span>
            round++<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-12">底层原理</h3>
<p><code>CyclicBarrier</code> 不基于 AQS，而是使用 <code>ReentrantLock</code> + <code>Condition</code> 实现：（Condition 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li>每次调用 <code>await()</code>，线程进入条件队列等待。</li>
<li>当最后一个线程到达时，唤醒所有等待线程，并执行 <code>barrierAction</code>（如有）。</li>
<li>完成后自动重置计数器，<strong>支持重复使用</strong>。</li>
</ul>
<p>若某个线程在等待期间被中断或超时，屏障将进入“损坏”（broken）状态，后续调用会抛出 <code>BrokenBarrierException</code>。</p>
<h3 data-id="heading-13">CyclicBarrier 与 CountDownLatch 的区别</h3>






























<table><thead><tr><th>特性</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>控制方向</td><td>一方等待多方</td><td>所有线程互相等待</td></tr><tr><td>是否可重用</td><td>❌</td><td>✅</td></tr><tr><td>是否支持回调</td><td>❌</td><td>✅（barrierAction）</td></tr><tr><td>底层实现</td><td>AQS</td><td>ReentrantLock + Condition</td></tr></tbody></table>
<h2 data-id="heading-14">Phaser（JDK 7+）：灵活的阶段同步器</h2>
<p><code>Phaser</code> 新增于 JDK 7，是对 <code>CyclicBarrier</code> 和 <code>CountDownLatch</code> 的强大扩展，支持动态注册参与者、多阶段同步和分层结构，适用于更复杂的并发协调场景。</p>
<h3 data-id="heading-15">使用场景</h3>
<ul>
<li>多阶段并行任务（如 Map-Reduce 的 map → shuffle → reduce）。</li>
<li>动态增减工作线程（例如任务中途加入新 worker）。</li>
<li>大规模并行计算中需要分组同步（通过分层 Phaser 实现）。</li>
<li>替代多个 <code>CyclicBarrier</code> 或 <code>CountDownLatch</code> 的组合逻辑。</li>
</ul>
<h3 data-id="heading-16">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 构造方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>()</span>;                     <span class="hljs-comment">// 无初始参与者</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties</span>)</span>;          <span class="hljs-comment">// 指定初始参与者数量</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>(<span class="hljs-params">Phaser parent</span>)</span>;        <span class="hljs-comment">// 构建父子分层结构</span>

<span class="hljs-comment">// 核心方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">register</span>()</span>;               <span class="hljs-comment">// 注册一个新参与者，返回当前阶段号</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arrive</span>()</span>;                 <span class="hljs-comment">// 到达屏障，不等待</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arriveAndAwaitAdvance</span>()</span>;  <span class="hljs-comment">// 到达并等待其他参与者</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arriveAndDeregister</span>()</span>;    <span class="hljs-comment">// 到达并注销自己（退出后续阶段）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">isTerminated</span>()</span>;       <span class="hljs-comment">// 是否已终止（当参与者数为0时终止）</span>
</code></pre>
<h3 data-id="heading-17">使用示例</h3>
<p><strong>动态多阶段任务：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public class PhaserExample {
    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        Phaser phaser = new <span class="hljs-built_in">Phaser</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 初始无参与者</span>

        <span class="hljs-comment">// 启动3个任务线程</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            phaser<span class="hljs-selector-class">.register</span>(); <span class="hljs-comment">// 注册参与者</span>
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                try {
                    for (int phase = <span class="hljs-number">0</span>; phase &lt; <span class="hljs-number">3</span>; phase++) {
                        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() 
                            + " 完成阶段 " + phase);
                        <span class="hljs-comment">// 到达屏障并等待其他线程</span>
                        phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
                    }
                    <span class="hljs-comment">// 任务结束，注销自己</span>
                    phaser<span class="hljs-selector-class">.arriveAndDeregister</span>();
                } catch (Exception e) {
                    e<span class="hljs-selector-class">.printStackTrace</span>();
                }
            })<span class="hljs-selector-class">.start</span>();
        }

        <span class="hljs-comment">// 主线程等待所有阶段完成</span>
        while (!phaser.isTerminated()) {
            Thread<span class="hljs-selector-class">.yield</span>();
        }
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("所有阶段已完成！");
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs">Thread-1 完成阶段 0
Thread-2 完成阶段 0
Thread-0 完成阶段 0
Thread-0 完成阶段 1
Thread-2 完成阶段 1
Thread-1 完成阶段 1
Thread-2 完成阶段 2
Thread-1 完成阶段 2
Thread-0 完成阶段 2
所有阶段已完成！
</code></pre>
<h3 data-id="heading-18">高级特性：分层 Phaser</h3>
<p>当参与者数量极大（如数千线程）时，单一 <code>Phaser</code> 的同步开销会很高。此时可构建<strong>树状分层结构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">Phaser root = new <span class="hljs-built_in">Phaser</span>();
Phaser group1 = new <span class="hljs-built_in">Phaser</span>(root); <span class="hljs-comment">// 子 Phaser，父为 root</span>
Phaser group2 = new <span class="hljs-built_in">Phaser</span>(root);

<span class="hljs-comment">// group1 内部线程只与同组同步，最终由 root 汇总</span>
group1<span class="hljs-selector-class">.register</span>();
new <span class="hljs-built_in">Thread</span>(() -&gt; {
    group1<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>(); <span class="hljs-comment">// 仅与 group1 同步</span>
})<span class="hljs-selector-class">.start</span>();
</code></pre>
<p>这种结构能显著减少锁竞争，提升大规模并发性能。、</p>
<h3 data-id="heading-19">应用场景示例</h3>
<p><strong>分阶段并行处理：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 模拟三阶段数据处理：加载 → 转换 → 输出</span>
Phaser phaser = new <span class="hljs-built_in">Phaser</span>(<span class="hljs-number">0</span>);

List&lt;Thread&gt; workers = IntStream<span class="hljs-selector-class">.range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>)
    <span class="hljs-selector-class">.mapToObj</span>(i -&gt; {
        phaser.register();
        return new <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-built_in">load</span>();   phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            <span class="hljs-attribute">transform</span>(); phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            <span class="hljs-built_in">output</span>(); phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            phaser<span class="hljs-selector-class">.arriveAndDeregister</span>();
        });
    })
    <span class="hljs-selector-class">.peek</span>(Thread::start)
    <span class="hljs-selector-class">.collect</span>(Collectors.toList());

<span class="hljs-comment">// 等待全部完成</span>
while (!phaser.isTerminated()) {
    Thread<span class="hljs-selector-class">.yield</span>();
}
</code></pre>
<h3 data-id="heading-20">底层原理</h3>
<p>不同于 <code>CountDownLatch</code> 和 <code>Semaphore</code>，<code>Phaser</code> <strong>未基于 AQS</strong>，而是自行实现同步机制，它的实现融合了 <strong>自旋锁 + 队列管理</strong>：</p>
<ul>
<li><strong>状态字段</strong>：使用一个 <code>long</code> 类型的 <code>state</code> 字段，高位存阶段号（phase），低位存参与者数量（parties）。</li>
<li><strong>自适应等待策略</strong>：</li>
<li>
<ul>
<li>参与者少时使用 <strong>自旋等待</strong>（低延迟）。</li>
<li>参与者多或等待时间长时，自动切换到 <strong>阻塞队列</strong>（节省 CPU）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-21">Phaser 与 CyclicBarrier 的对比</h3>













































<table><thead><tr><th>特性</th><th>CyclicBarrier</th><th>Phaser</th></tr></thead><tbody><tr><td>引入版本</td><td>JDK 1.5</td><td>JDK 1.7</td></tr><tr><td>是否可重用</td><td>✅（自动重置）</td><td>✅（阶段递增）</td></tr><tr><td>动态增减参与者</td><td>❌</td><td>✅（register() / arriveAndDeregister()）</td></tr><tr><td>分层支持</td><td>❌</td><td>✅（父子结构）</td></tr><tr><td>阶段号追踪</td><td>❌</td><td>✅（getPhase()）</td></tr><tr><td>终止机制</td><td>损坏即不可用</td><td>参与者归零后优雅终止</td></tr><tr><td>性能（大规模）</td><td>较差（全局锁）</td><td>更优（分层 + 自适应等待）</td></tr></tbody></table>
<p><strong>使用建议：</strong></p>
<ul>
<li>若参与者数量固定且较少，用 <code>CyclicBarrier</code> 即可。</li>
<li>若需动态调整、多阶段、大规模，则优先选择 <code>Phaser</code>。</li>
</ul>
<h2 data-id="heading-22">Semaphore（JDK 5+）：信号量</h2>
<h3 data-id="heading-23">使用场景</h3>
<p><code>Semaphore</code> 用于控制<strong>同时访问特定资源的线程数量</strong>，比如：</p>
<ul>
<li>数据库连接池（最多 N 个连接）。</li>
<li>接口限流（如每秒最多处理 100 个请求）。</li>
<li>模拟有限资源的分配（如停车场车位）。</li>
<li><code>new Semaphore(1)</code> 实际上等价于 <code>synchronized</code> 或 <code>ReentrantLock</code>。</li>
</ul>
<h3 data-id="heading-24">核心 API</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span>;
<span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>, <span class="hljs-type">boolean</span> fair)</span>; <span class="hljs-comment">// 公平/非公平模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>;
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 非阻塞尝试获取</span>
</code></pre>
<h3 data-id="heading-25">使用示例</h3>
<pre><code class="hljs language-scss" lang="scss">public class SemaphoreExample {
    private static final Semaphore semaphore = new <span class="hljs-built_in">Semaphore</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 最多2个线程并发</span>

    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                try {
                    semaphore<span class="hljs-selector-class">.acquire</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 获取许可，正在执行...");
                    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">2000</span>);
                } catch (InterruptedException e) {
                    Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
                } finally {
                    semaphore<span class="hljs-selector-class">.release</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 释放许可");
                }
            })<span class="hljs-selector-class">.start</span>();
        }
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-erlang" lang="erlang">Thread-<span class="hljs-number">0</span> 获取许可，正在执行...
Thread-<span class="hljs-number">1</span> 获取许可，正在执行...
Thread-<span class="hljs-number">0</span> 释放许可
Thread-<span class="hljs-number">2</span> 获取许可，正在执行...
Thread-<span class="hljs-number">1</span> 释放许可
Thread-<span class="hljs-number">3</span> 获取许可，正在执行...
Thread-<span class="hljs-number">2</span> 释放许可
Thread-<span class="hljs-number">3</span> 释放许可
Thread-<span class="hljs-number">4</span> 获取许可，正在执行...
Thread-<span class="hljs-number">4</span> 释放许可
</code></pre>
<h3 data-id="heading-26">应用场景示例</h3>
<p><strong>API 限流：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 每秒最多100请求</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (rateLimiter.tryAcquire()) {
        <span class="hljs-keyword">try</span> {
            process();
        } <span class="hljs-keyword">finally</span> {
            rateLimiter.release();
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"请求过于频繁"</span>);
    }
}
</code></pre>
<h3 data-id="heading-27">底层原理</h3>
<p>同样基于 <strong>AQS</strong>：（AQS 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li><code>state</code> 表示可用许可数量。</li>
<li><code>acquire()</code> 尝试减少 <code>state</code>，若不足则入队等待。</li>
<li><code>release()</code> 增加 <code>state</code> 并唤醒等待线程。</li>
<li>支持公平模式（按请求顺序分配许可）。</li>
</ul>
<h2 data-id="heading-28">Exchanger（JDK 5+）：数据交换器</h2>
<h3 data-id="heading-29">使用场景</h3>
<p><code>Exchanger</code> 专为<strong>两个线程之间交换数据</strong>而设计，典型场景如：</p>
<ul>
<li>双缓冲机制（一个线程写入缓冲区 A，另一个写入 B，满后交换）。</li>
<li>生产者与消费者高效传递中间结果。</li>
<li>日志收集器中交换日志缓冲区。</li>
</ul>
<h3 data-id="heading-30">核心 API</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">exchange</span><span class="hljs-params">(V x)</span> <span class="hljs-keyword">throws</span> InterruptedException;
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">exchange</span><span class="hljs-params">(V x, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> ...;
</code></pre>
<h3 data-id="heading-31">示例代码</h3>
<pre><code class="hljs language-ini" lang="ini">public class ExchangerExample {
    public static void main(String<span class="hljs-section">[]</span> args) {
        Exchanger&lt;String&gt; <span class="hljs-attr">exchanger</span> = new Exchanger&lt;&gt;()<span class="hljs-comment">;</span>

        new Thread(() -&gt; {
            try {
                String <span class="hljs-attr">data</span> = <span class="hljs-string">"Thread-A 的数据"</span><span class="hljs-comment">;</span>
                System.out.println("A 准备交换: " + data)<span class="hljs-comment">;</span>
                String <span class="hljs-attr">received</span> = exchanger.exchange(data)<span class="hljs-comment">;</span>
                System.out.println("A 收到: " + received)<span class="hljs-comment">;</span>
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
            }
        }).start()<span class="hljs-comment">;</span>

        new Thread(() -&gt; {
            try {
                Thread.sleep(1000)<span class="hljs-comment">; // 模拟延迟</span>
                String <span class="hljs-attr">data</span> = <span class="hljs-string">"Thread-B 的数据"</span><span class="hljs-comment">;</span>
                System.out.println("B 准备交换: " + data)<span class="hljs-comment">;</span>
                String <span class="hljs-attr">received</span> = exchanger.exchange(data)<span class="hljs-comment">;</span>
                System.out.println("B 收到: " + received)<span class="hljs-comment">;</span>
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
            }
        }).start()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">A</span> 准备交换: <span class="hljs-selector-tag">Thread-A</span> 的数据
<span class="hljs-selector-tag">B</span> 准备交换: <span class="hljs-selector-tag">Thread-B</span> 的数据
<span class="hljs-selector-tag">B</span> 收到: <span class="hljs-selector-tag">Thread-A</span> 的数据
<span class="hljs-selector-tag">A</span> 收到: <span class="hljs-selector-tag">Thread-B</span> 的数据
</code></pre>
<h3 data-id="heading-32">应用场景示例</h3>
<p><strong>双缓冲日志：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Exchanger&lt;List&lt;LogEntry&gt;&gt; <span class="hljs-attr">exchanger</span> = new Exchanger&lt;&gt;()<span class="hljs-comment">;</span>
List&lt;LogEntry&gt; <span class="hljs-attr">bufferA</span> = new ArrayList&lt;&gt;(<span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
List&lt;LogEntry&gt; <span class="hljs-attr">bufferB</span> = new ArrayList&lt;&gt;(<span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>

// 写线程不断填充 bufferA
// 写满后与读线程交换，读线程异步刷盘
</code></pre>
<h3 data-id="heading-33">底层原理</h3>
<p><code>Exchanger</code> 内部使用 <strong>Slot 或 Node 结构</strong>暂存数据，通过 <strong>CAS + 自旋</strong> 实现高效交换：</p>
<ul>
<li>第一个调用 <code>exchange()</code> 的线程将数据放入槽位并等待。</li>
<li>第二个线程到来后，取出对方数据，放入自己的数据，完成交换。</li>
<li>若超时或中断，会清理槽位并抛出异常。</li>
</ul>
<p><strong>注意</strong>：仅支持<strong>两个线程配对交换</strong>，第三个线程调用 <code>exchange()</code> 会一直阻塞直到有新的配对。</p>
<h2 data-id="heading-34">工具类对比总结</h2>





































































<table><thead><tr><th>特性</th><th>CountDownLatch</th><th>CyclicBarrier</th><th>Phaser</th><th>Semaphore</th><th>Exchanger</th></tr></thead><tbody><tr><td>引入版本</td><td>1.5</td><td>1.5</td><td>1.7</td><td>1.5</td><td>1.5</td></tr><tr><td>是否可重用</td><td>❌</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>协作模式</td><td>一方等多方</td><td>所有互相等</td><td>多阶段动态同步</td><td>控制并发数</td><td>两线程交换</td></tr><tr><td>动态参与者</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>分层支持</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>底层机制</td><td>AQS</td><td>ReentrantLock+Condition</td><td>自定义同步（CAS+自旋+队列）</td><td>AQS</td><td>CAS+自旋</td></tr><tr><td>典型用途</td><td>初始化等待</td><td>分阶段计算</td><td>复杂并行任务协调</td><td>限流</td><td>数据交换</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端崩溃监控：给网页戴上“生命体征监测仪”]]></title>    <link>https://juejin.cn/post/7586684925106389035</link>    <guid>https://juejin.cn/post/7586684925106389035</guid>    <pubDate>2025-12-23T06:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586684925106389035" data-draft-id="7586684925106372651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端崩溃监控：给网页戴上“生命体征监测仪”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端崩溃监控：给网页戴上“生命体征监测仪”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:28:30.000Z" title="Tue Dec 23 2025 06:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎使用我的小程序👇👇👇👇</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfTGlrZXJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767076110&amp;x-signature=2tlmxVM2u5XfV2g2%2BioDUySoe%2BI%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<blockquote>
<p>想象一下：你开发的网页突然“晕倒”了，而你还蒙在鼓里——直到用户流失报表像病危通知书一样摆在你面前。别怕！今天我们来给每个网页安装一套“ICU监护系统”。</p>
</blockquote>
<h2 data-id="heading-0">一、开场白：当网页突然“不省人事”</h2>
<p>上周，我朋友小张的公司遇到了一个诡异问题：他们的电商平台在iPhone上总会在用户下单时“卡死”。用户抱怨，客服崩溃，而开发团队却一脸茫然——<strong>监控系统什么都没抓到</strong>。</p>
<p>“就像病人突然休克，但心电图却显示一切正常。”小张苦笑着说。</p>
<p>这就是大多数前端开发者的困境：<strong>JavaScript错误能监控，但页面崩溃却像幽灵一样无影无踪</strong>。今天，我就来揭秘如何给网页安装一套全方位的“生命体征监测系统”。</p>
<h2 data-id="heading-1">二、崩溃的“临床表现”与诊断难点</h2>
<h3 data-id="heading-2">2.1 页面崩溃的四种“病症”</h3>
<p>先来看几个典型病例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 病例1：内存泄漏型“慢性病”</span>
<span class="hljs-keyword">let</span> memoryLeak = [];
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  memoryLeak.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>)); <span class="hljs-comment">// 每秒吃掉10MB内存</span>
}, <span class="hljs-number">1000</span>);
<span class="hljs-comment">// 症状：页面越来越慢，最后彻底卡死</span>

<span class="hljs-comment">// 病例2：死循环型“急性心梗”</span>
<span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">// 无限循环，主线程完全阻塞</span>
}
<span class="hljs-comment">// 症状：页面瞬间冻结，点击无反应</span>

<span class="hljs-comment">// 病例3：渲染层“脑梗”</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// 清空DOM</span>
<span class="hljs-title function_">complex3DAnimation</span>(); <span class="hljs-comment">// 但GPU还在拼命渲染不存在的元素</span>
<span class="hljs-comment">// 症状：页面白屏，但控制台没报错</span>

<span class="hljs-comment">// 病例4：网络层“呼吸衰竭”</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 永远等不到响应...</span>
});
<span class="hljs-comment">// 症状：loading转圈到天荒地老</span>
</code></pre>
<h3 data-id="heading-3">2.2 传统监控的“诊断盲区”</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[页面崩溃发生] --&gt; B{传统错误监控}
    B --&gt;|能捕获| C[JavaScript执行错误]
    B --&gt;|能捕获| D[资源加载失败]
    B --&gt;|无法捕获| E[内存泄漏崩溃]
    B --&gt;|无法捕获| F[死循环卡死]
    B --&gt;|无法捕获| G[渲染层崩溃]
    
    style E fill:#f96
    style F fill:#f96
    style G fill:#f96
</code></pre>
<p>传统错误监控就像是<strong>只查血常规，不做心电图</strong>——很多致命问题根本检测不到。</p>
<h2 data-id="heading-4">三、我们的“ICU监控系统”架构</h2>
<p>经过多年“临床实践”，我设计了一套<strong>四层监控体系</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph “监控体系架构”
        A[第一层: 实时心跳监测] --&gt; B[第二层: 多维度异常捕捉]
        B --&gt; C[第三层: 崩溃现场快照]
        C --&gt; D[第四层: 智能上报分析]
    end
    
    subgraph “技术实现”
        E[Service Worker&lt;br/&gt;独立心跳] --&gt; F[LocalStorage&lt;br/&gt;心跳备份]
        F --&gt; G[Performance API&lt;br/&gt;性能监控]
        G --&gt; H[Error Boundaries&lt;br/&gt;错误边界]
    end
    
    A -.-&gt; E
    B -.-&gt; G
    B -.-&gt; H
    C -.-&gt; F
</code></pre>
<h3 data-id="heading-5">3.1 第一层：Service Worker心跳监测（独立“起搏器”）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 想象一下：即使病人（主页面）昏迷了，</span>
<span class="hljs-comment">// 他的智能手表（Service Worker）还能继续发送生命信号</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HeartbeatMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatInterval</span> = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 5秒一次心跳</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">crashThreshold</span> = <span class="hljs-number">15000</span>;   <span class="hljs-comment">// 15秒无心跳算“休克”</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateSessionId</span>();
  }
  
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 注册Service Worker“护士”</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/nurse.js'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🏥 私人护士已上岗，开始监测心跳'</span>);
        
        <span class="hljs-comment">// 定期发送“我还活着”信号</span>
        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendHeartbeat</span>();
        }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatInterval</span>);
      });
  }
  
  <span class="hljs-title function_">sendHeartbeat</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 发送当前生命体征</span>
    <span class="hljs-keyword">const</span> vitalSigns = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'HEARTBEAT'</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">patientId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,
      <span class="hljs-attr">bloodPressure</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMemoryPressure</span>(), <span class="hljs-comment">// 内存“血压”</span>
      <span class="hljs-attr">heartRate</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getEventLoopHealth</span>()     <span class="hljs-comment">// 事件循环“心率”</span>
    };
    
    <span class="hljs-comment">// 告诉护士当前状态</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>?.<span class="hljs-title function_">postMessage</span>(vitalSigns);
  }
}
</code></pre>
<p><strong>工作原理</strong>：</p>
<ul>
<li>Service Worker独立于主线程运行</li>
<li>即使主页面崩溃，Service Worker仍存活</li>
<li>15秒收不到心跳 → 判断页面“可能已崩溃”</li>
</ul>
<h3 data-id="heading-6">3.2 第二层：LocalStorage备份心跳（“病历本”方案）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是给没有Service Worker的“低配版病人”准备的</span>
<span class="hljs-comment">// 原理：让页面定期在“病历本”上签字</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupMonitor</span> {
  <span class="hljs-title function_">checkPreviousSession</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 就诊时先看上次的“病历记录”</span>
    <span class="hljs-keyword">const</span> lastCheckup = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'last_heartbeat'</span>);
    
    <span class="hljs-keyword">if</span> (lastCheckup) {
      <span class="hljs-keyword">const</span> { timestamp, sessionId } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(lastCheckup);
      <span class="hljs-keyword">const</span> timeSinceLastBeat = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - timestamp;
      
      <span class="hljs-keyword">if</span> (timeSinceLastBeat &gt; <span class="hljs-number">10000</span>) {
        <span class="hljs-comment">// 发现异常：上次就诊后没按时复查</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportSuspectedCrash</span>({
          <span class="hljs-attr">patientId</span>: sessionId,
          <span class="hljs-attr">missingDuration</span>: timeSinceLastBeat,
          <span class="hljs-attr">symptoms</span>: <span class="hljs-string">'未按时复查心跳'</span>
        });
      }
    }
    
    <span class="hljs-comment">// 开始新的诊疗记录</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startNewSession</span>();
  }
  
  <span class="hljs-title function_">startNewSession</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 每3秒在病历本上签一次到</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'last_heartbeat'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">sessionId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,
        <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
      }));
    }, <span class="hljs-number">3000</span>);
  }
}
</code></pre>
<h2 data-id="heading-7">四、实战：多维度“体检项目”</h2>
<p>光有心跳还不够，我们还需要全面的体检：</p>
<h3 data-id="heading-8">4.1 内存“血常规”检查</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BloodTest</span> {
  <span class="hljs-title function_">checkBloodRoutine</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!performance.<span class="hljs-property">memory</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> bloodReport = {
        <span class="hljs-comment">// 红细胞（已用内存）</span>
        <span class="hljs-attr">RBC</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">usedJSHeapSize</span>,
        <span class="hljs-comment">// 白细胞（总内存）</span>
        <span class="hljs-attr">WBC</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">totalJSHeapSize</span>,
        <span class="hljs-comment">// 血小板（内存限制）</span>
        <span class="hljs-attr">PLT</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">jsHeapSizeLimit</span>,
        <span class="hljs-comment">// 血红蛋白（使用率）</span>
        <span class="hljs-attr">HGB</span>: (performance.<span class="hljs-property">memory</span>.<span class="hljs-property">usedJSHeapSize</span> / 
              performance.<span class="hljs-property">memory</span>.<span class="hljs-property">totalJSHeapSize</span>) * <span class="hljs-number">100</span>
      };
      
      <span class="hljs-comment">// 诊断标准</span>
      <span class="hljs-keyword">if</span> (bloodReport.<span class="hljs-property">HGB</span> &gt; <span class="hljs-number">90</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'⚠️ 危！病人严重贫血（内存不足）！'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emergencyTransfusion</span>(); <span class="hljs-comment">// 紧急输血（清理内存）</span>
      }
    }, <span class="hljs-number">10000</span>);
  }
  
  <span class="hljs-title function_">emergencyTransfusion</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 尝试触发垃圾回收</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">gc</span>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">gc</span>(); <span class="hljs-comment">// Chrome DevTools才有的“特效药”</span>
    }
    
    <span class="hljs-comment">// 清理缓存</span>
    caches.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'my-cache'</span>);
    
    <span class="hljs-comment">// 卸载不必要组件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unloadUnusedComponents</span>();
  }
}
</code></pre>
<h3 data-id="heading-9">4.2 事件循环“心电图”监测</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ECGMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxInterval</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 正常“心跳”间隔应小于100ms</span>
  }
  
  <span class="hljs-title function_">startMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 用requestAnimationFrame检测“心律”</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkHeartRhythm</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> interval = now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span>;
      
      <span class="hljs-keyword">if</span> (interval &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxInterval</span> * <span class="hljs-number">2</span>) {
        <span class="hljs-comment">// 检测到“心律不齐”</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportArrhythmia</span>({
          <span class="hljs-attr">interval</span>: interval,
          <span class="hljs-attr">timestamp</span>: now,
          <span class="hljs-attr">severity</span>: interval &gt; <span class="hljs-number">1000</span> ? <span class="hljs-string">'CRITICAL'</span> : <span class="hljs-string">'WARNING'</span>
        });
      }
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span> = now;
      <span class="hljs-title function_">requestAnimationFrame</span>(checkHeartRhythm);
    };
    
    <span class="hljs-title function_">checkHeartRhythm</span>();
  }
}
</code></pre>
<h3 data-id="heading-10">4.3 渲染性能“CT扫描”</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CTScanner</span> {
  <span class="hljs-title function_">setupRenderMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监控布局偏移（突然的“头晕目眩”）</span>
    <span class="hljs-keyword">const</span> layoutShiftObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0.1</span>) { <span class="hljs-comment">// 偏移超过10%</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportVertigo</span>({
            <span class="hljs-attr">shiftValue</span>: entry.<span class="hljs-property">value</span>,
            <span class="hljs-attr">hadRecentInput</span>: entry.<span class="hljs-property">hadRecentInput</span>,
            <span class="hljs-attr">cause</span>: <span class="hljs-string">'布局突然变化'</span>
          });
        }
      });
    });
    
    layoutShiftObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'layout-shift'</span>] });
    
    <span class="hljs-comment">// 监控长任务（“大脑宕机”时刻）</span>
    <span class="hljs-keyword">const</span> longTaskObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">50</span>) { <span class="hljs-comment">// 超过50ms的任务</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportBrainFreeze</span>({
            <span class="hljs-attr">duration</span>: entry.<span class="hljs-property">duration</span>,
            <span class="hljs-attr">culprit</span>: entry.<span class="hljs-property">attribution</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">name</span> || <span class="hljs-string">'未知'</span>,
            <span class="hljs-attr">timestamp</span>: entry.<span class="hljs-property">startTime</span>
          });
        }
      });
    });
    
    longTaskObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'longtask'</span>] });
  }
}
</code></pre>
<h2 data-id="heading-11">五、崩溃“尸检报告”：收集现场证据</h2>
<p>当崩溃发生时，我们需要一份详细的“尸检报告”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutopsyReport</span> {
  <span class="hljs-title function_">collectEvidence</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 基础身份信息</span>
      <span class="hljs-attr">patientInfo</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span>,
        <span class="hljs-attr">id</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        <span class="hljs-attr">age</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - performance.<span class="hljs-property">timing</span>.<span class="hljs-property">navigationStart</span>
      },
      
      <span class="hljs-comment">// 最后的活动记录</span>
      <span class="hljs-attr">lastMovements</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUserActions</span>(),
      
      <span class="hljs-comment">// 生命体征最后读数</span>
      <span class="hljs-attr">lastVitals</span>: {
        <span class="hljs-attr">memory</span>: performance.<span class="hljs-property">memory</span>?.<span class="hljs-property">usedJSHeapSize</span> || <span class="hljs-string">'N/A'</span>,
        <span class="hljs-attr">fps</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateFPS</span>(),
        <span class="hljs-attr">network</span>: navigator.<span class="hljs-property">connection</span>?.<span class="hljs-property">effectiveType</span> || <span class="hljs-string">'unknown'</span>
      },
      
      <span class="hljs-comment">// 现场照片（屏幕截图替代方案）</span>
      <span class="hljs-attr">crimeScene</span>: {
        <span class="hljs-attr">viewport</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerWidth}</span>x<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerHeight}</span>`</span>,
        <span class="hljs-attr">scrollPosition</span>: {
          <span class="hljs-attr">x</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollX</span>,
          <span class="hljs-attr">y</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>
        },
        <span class="hljs-attr">visibleElements</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getVisibleElements</span>()
      },
      
      <span class="hljs-comment">// 时间线重建</span>
      <span class="hljs-attr">timeline</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reconstructTimeline</span>(),
      
      <span class="hljs-comment">// 可能的死因分析</span>
      <span class="hljs-attr">probableCause</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeProbableCause</span>()
    };
  }
  
  <span class="hljs-title function_">getUserActions</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 收集用户最后10次操作</span>
    <span class="hljs-keyword">return</span> userActionLog.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">10</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> ({
      <span class="hljs-attr">type</span>: action.<span class="hljs-property">type</span>,
      <span class="hljs-attr">target</span>: action.<span class="hljs-property">target</span>,
      <span class="hljs-attr">timestamp</span>: action.<span class="hljs-property">timestamp</span>,
      <span class="hljs-attr">pageX</span>: action.<span class="hljs-property">pageX</span>,
      <span class="hljs-attr">pageY</span>: action.<span class="hljs-property">pageY</span>
    }));
  }
  
  <span class="hljs-title function_">analyzeProbableCause</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 基于收集的证据分析可能死因</span>
    <span class="hljs-keyword">const</span> evidence = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectEvidence</span>();
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">lastVitals</span>.<span class="hljs-property">memory</span> &gt; <span class="hljs-number">500000000</span>) { <span class="hljs-comment">// 500MB</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">'MEMORY_OVERLOAD'</span>;
    }
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">timeline</span>.<span class="hljs-property">longTasks</span> &gt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'MAIN_THREAD_BLOCKED'</span>;
    }
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">lastMovements</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">type</span> === <span class="hljs-string">'fetch'</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'NETWORK_REQUEST_HANG'</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'UNKNOWN'</span>;
  }
}
</code></pre>
<h2 data-id="heading-12">六、智能上报：不打扰的“远程监护”</h2>
<p>监控数据上报要像<strong>智能手表的健康同步</strong>——安静、及时、省电：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartReporter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportStrategies</span> = {
      <span class="hljs-comment">// 急诊级：立即上报</span>
      <span class="hljs-attr">EMERGENCY</span>: {
        <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">methods</span>: [<span class="hljs-string">'beacon'</span>, <span class="hljs-string">'fetch'</span>],
        <span class="hljs-attr">retry</span>: <span class="hljs-number">3</span>
      },
      
      <span class="hljs-comment">// 门诊级：批量上报</span>
      <span class="hljs-attr">OUTPATIENT</span>: {
        <span class="hljs-attr">immediate</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">batchSize</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">interval</span>: <span class="hljs-number">30000</span>
      },
      
      <span class="hljs-comment">// 体检级：抽样上报</span>
      <span class="hljs-attr">CHECKUP</span>: {
        <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 10%抽样</span>
        <span class="hljs-attr">interval</span>: <span class="hljs-number">60000</span>
      }
    };
  }
  
  <span class="hljs-comment">// 智能判断上报策略</span>
  <span class="hljs-title function_">smartReport</span>(<span class="hljs-params">data, severity</span>) {
    <span class="hljs-keyword">const</span> strategy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportStrategies</span>[severity];
    
    <span class="hljs-keyword">if</span> (strategy.<span class="hljs-property">immediate</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emergencyReport</span>(data);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">queueReport</span>(data, strategy);
    }
  }
  
  <span class="hljs-comment">// 急诊上报：用sendBeacon确保送达</span>
  <span class="hljs-title function_">emergencyReport</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'/api/emergency'</span>;
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)], {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span>
    });
    
    <span class="hljs-comment">// sendBeacon：即使页面关闭也保证发送</span>
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-title function_">sendBeacon</span>(url, blob)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🚑 急诊报告已送出'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 备用方案</span>
      <span class="hljs-title function_">fetch</span>(url, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">body</span>: blob,
        <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>
      });
    }
  }
  
  <span class="hljs-comment">// 智能节流：避免频繁上报</span>
  <span class="hljs-title function_">queueReport</span>(<span class="hljs-params">data, strategy</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span>.<span class="hljs-title function_">push</span>({
      data,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      strategy
    });
    
    <span class="hljs-comment">// 达到批量大小或时间间隔时上报</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span>.<span class="hljs-property">length</span> &gt;= strategy.<span class="hljs-property">batchSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushQueue</span>();
    }
  }
}
</code></pre>
<h2 data-id="heading-13">七、真实病例：电商网站崩溃之谜</h2>
<p>让我分享一个真实案例，看看这套系统如何“破案”：</p>
<h3 data-id="heading-14">7.1 案件背景</h3>
<p>某电商大促期间，iPhone用户频繁反馈“加入购物车后页面卡死”。</p>
<h3 data-id="heading-15">7.2 监控发现</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[用户点击加入购物车] --&gt; B{监控系统记录}
    B --&gt; C[内存从150MB飙升至850MB]
    B --&gt; D[主线程阻塞3.2秒]
    B --&gt; E[Service Worker心跳中断]
    C --&gt; F[诊断: 内存泄漏]
    D --&gt; G[诊断: 同步DOM操作]
    E --&gt; H[诊断: 页面崩溃]
    
    style F fill:#f96
    style G fill:#f96
    style H fill:#f96
</code></pre>
<h3 data-id="heading-16">7.3 根本原因</h3>
<p>通过“尸检报告”发现罪魁祸首：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 问题代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">product</span>) {
  <span class="hljs-comment">// 每次点击都创建新的观察者，从未清理！</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 监控商品可见性</span>
  }).<span class="hljs-title function_">observe</span>(productElement);
  
  <span class="hljs-comment">// 同步更新大量DOM</span>
  <span class="hljs-title function_">updateCartUI</span>(); <span class="hljs-comment">// 重绘整个购物车</span>
  <span class="hljs-title function_">updateRecommendations</span>(); <span class="hljs-comment">// 更新推荐列表</span>
  <span class="hljs-title function_">updateStockCount</span>(); <span class="hljs-comment">// 更新库存显示</span>
  
  <span class="hljs-comment">// 保存到LocalStorage（阻塞主线程）</span>
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'cart'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cartData)); <span class="hljs-comment">// 数据越来越大！</span>
}
</code></pre>
<h3 data-id="heading-17">7.4 解决方案</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修复后</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CartManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 单例观察者</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = []; <span class="hljs-comment">// 更新队列</span>
  }
  
  <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">product</span>) {
    <span class="hljs-comment">// 1. 防抖更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debouncedUpdate</span>();
    
    <span class="hljs-comment">// 2. 使用IndexedDB代替LocalStorage</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveToIndexedDB</span>(cartData);
    
    <span class="hljs-comment">// 3. 虚拟化DOM更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">virtualUpdate</span>();
    
    <span class="hljs-comment">// 4. 内存监控</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMemoryUsage</span>() &gt; <span class="hljs-number">70</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupOldObservers</span>();
    }
  }
}
</code></pre>
<h3 data-id="heading-18">7.5 治疗效果</h3>
<ul>
<li><strong>崩溃率</strong>：从15.3%降至0.2%</li>
<li><strong>内存使用</strong>：峰值从850MB降至280MB</li>
<li><strong>用户满意度</strong>：提升42%</li>
</ul>
<h2 data-id="heading-19">八、监控面板：医生的“仪表盘”</h2>
<p>一个优秀的监控系统需要直观的展示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实时健康仪表盘</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthDashboard</span> {
  <span class="hljs-title function_">renderDashboard</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`
      &lt;div class="health-monitor"&gt;
        &lt;div class="patient-card"&gt;
          &lt;h3&gt;🏥 页面健康状态&lt;/h3&gt;
          
          &lt;!-- 心跳指示器 --&gt;
          &lt;div class="heartbeat-indicator <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getHeartbeatStatus()}</span>"&gt;
            心跳: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getHeartbeatRate()}</span> BPM
          &lt;/div&gt;
          
          &lt;!-- 内存仪表 --&gt;
          &lt;div class="memory-gauge"&gt;
            内存使用: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getMemoryPercentage()}</span>%
            &lt;div class="gauge-bar"&gt;
              &lt;div class="gauge-fill" style="width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getMemoryPercentage()}</span>%"&gt;&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          
          &lt;!-- 事件循环健康度 --&gt;
          &lt;div class="event-loop-health"&gt;
            主线程响应: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getEventLoopHealth()}</span>ms
          &lt;/div&gt;
          
          &lt;!-- 今日诊断 --&gt;
          &lt;div class="diagnosis"&gt;
            &lt;h4&gt;📋 今日诊断报告&lt;/h4&gt;
            &lt;ul&gt;
              <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getDailyDiagnosis().map(d =&gt; 
                <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${d.time}</span> - <span class="hljs-subst">${d.type}</span>: <span class="hljs-subst">${d.message}</span>&lt;/li&gt;`</span>
              ).join(<span class="hljs-string">''</span>)}</span>
            &lt;/ul&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `</span>;
  }
}
</code></pre>
<h2 data-id="heading-20">九、最佳实践清单</h2>
<h3 data-id="heading-21">9.1 必须做的 ✅</h3>
<ol>
<li><strong>多层监控</strong>：不要单点依赖</li>
<li><strong>用户无感</strong>：监控本身消耗 &lt; 1% CPU</li>
<li><strong>智能采样</strong>：高频数据按需采样</li>
<li><strong>隐私保护</strong>：匿名化用户数据</li>
</ol>
<h3 data-id="heading-22">9.2 避免做的 ❌</h3>
<ol>
<li><strong>不要</strong>在监控中抛出新错误</li>
<li><strong>不要</strong>收集敏感信息（密码、支付信息）</li>
<li><strong>不要</strong>影响正常业务逻辑</li>
<li><strong>不要</strong>忽略低端设备性能</li>
</ol>
<h3 data-id="heading-23">9.3 进阶技巧 🚀</h3>
<ol>
<li><strong>预测性监控</strong>：在崩溃前预警</li>
<li><strong>A/B测试监控</strong>：对比不同版本的稳定性</li>
<li><strong>地理监控</strong>：不同地区的表现差异</li>
<li><strong>设备指纹</strong>：特定设备的兼容性问题</li>
</ol>
<h2 data-id="heading-24">十、总结：从“救火”到“防火”</h2>
<p>实施完整的崩溃监控后，你的开发工作流将发生质变：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title 监控前后的变化
    section 监控前
        用户抱怨崩溃 : 开发团队茫然
        紧急修复bug : 不知如何重现
        用户持续流失 : 业务指标下降
    section 监控后
        实时警报 : 自动收集证据
        精准定位 : 快速修复问题
        预防预警 : 崩溃率下降90%
</code></pre>
<h3 data-id="heading-25">最后的思考</h3>
<p>网页崩溃监控不是奢侈品，而是<strong>必需品</strong>。它就像：</p>
<ul>
<li><strong>行车记录仪</strong>：事故发生时知道原因</li>
<li><strong>智能手环</strong>：实时监测健康状况</li>
<li><strong>飞机黑匣子</strong>：即使坠毁也能找到原因</li>
</ul>
<p>最重要的是，<strong>好的监控系统让你从被动的“救火队员”变成主动的“预防专家”</strong>。</p>
<h3 data-id="heading-26">行动起来！</h3>
<p>明天就开始为你的网站实施崩溃监控吧！从最简单的LocalStorage心跳开始，逐步完善。记住：</p>
<blockquote>
<p>每一个你今天监控到的崩溃，都是一个明天不会流失的用户。</p>
</blockquote>
<hr/>
<p><strong>彩蛋</strong>：想立即尝试？这里有一个<strong>五分钟快速上手</strong>方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建monitor.js文件</span>
<span class="hljs-comment">// 2. 复制下面的代码</span>
<span class="hljs-comment">// 3. 在页面中引入</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'last_alive'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
    }, <span class="hljs-number">5000</span>);
    
    <span class="hljs-keyword">const</span> lastAlive = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'last_alive'</span>);
    <span class="hljs-keyword">if</span> (lastAlive &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - lastAlive &gt; <span class="hljs-number">10000</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'检测到上次可能崩溃了！'</span>);
    }
  }
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">QuickMonitor</span>();
</code></pre>
<p><strong>讨论时间</strong>：你的项目中遇到过最诡异的崩溃是什么？欢迎在评论区分享你的“破案”经历！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 全栈--reactjs 基础总结]]></title>    <link>https://juejin.cn/post/7586686861390479411</link>    <guid>https://juejin.cn/post/7586686861390479411</guid>    <pubDate>2025-12-23T07:08:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586686861390479411" data-draft-id="7586597780641366026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 全栈--reactjs 基础总结"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:08:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 全栈--reactjs 基础总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:08:26.000Z" title="Tue Dec 23 2025 07:08:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目前使用AI开发，生成代码比较成熟的全栈组合前端是reactjs，所以这里整理一些reactjs 基础知识，方便生成reactjs 的时候，可以快速修改里面的代码。</h2>
<blockquote>
<p>本文档结合 React 官方文档编写，覆盖你日常开发中 80% 会用到的 React 概念。</p>
</blockquote>
<h2 data-id="heading-1">你将学会</h2>
<ul>
<li>如何创建和嵌套组件</li>
<li>如何添加标记和样式</li>
<li>如何显示数据</li>
<li>如何渲染条件判断和列表</li>
<li>如何响应事件和更新界面</li>
<li>如何在组件间共享数据</li>
<li>React 核心原理与最佳实践</li>
</ul>
<hr/>
<h2 data-id="heading-2">一、React 渲染原理</h2>
<h3 data-id="heading-3">虚拟 DOM 的创建</h3>
<p>React 使用 <code>React.createElement</code> 创建虚拟 DOM，返回值是 React 元素（虚拟 DOM）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
  <span class="hljs-string">'div'</span>,           <span class="hljs-comment">// DOM 类型</span>
  {               <span class="hljs-comment">// DOM 属性</span>
    <span class="hljs-attr">style</span>: {<span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>},
    <span class="hljs-attr">className</span>: <span class="hljs-string">'container'</span>
  },
  <span class="hljs-string">'hello'</span>,        <span class="hljs-comment">// 子节点</span>
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>, {<span class="hljs-attr">style</span>: {<span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span>}}, <span class="hljs-string">'world'</span>)
);
</code></pre>
<h3 data-id="heading-4">JSX 语法</h3>
<p>JSX 是 JavaScript 的语法扩展，最终会被 Babel 编译成 <code>React.createElement</code> 调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> jsxElement = (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span>'<span class="hljs-attr">red</span>'}} <span class="hljs-attr">className</span>=<span class="hljs-string">'container'</span>&gt;</span>
    hello
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span>'<span class="hljs-attr">blue</span>'}}&gt;</span>world<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)
</code></pre>
<h3 data-id="heading-5">渲染方式</h3>
<p>React 18 使用 <code>createRoot</code> API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
</code></pre>
<hr/>
<h2 data-id="heading-6">二、创建和嵌套组件</h2>
<p>React 应用由<strong>组件</strong>构成。组件是 UI 的一部分，拥有自己的逻辑和外观。React 组件是返回标记的 JavaScript 函数。</p>
<h3 data-id="heading-7">函数组件（推荐）</h3>
<p>函数组件是一个返回虚拟 DOM 的函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>我是一个按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 在其他组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到我的应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：React 组件名必须以大写字母开头，HTML 标签必须小写。</p>
</blockquote>
<h3 data-id="heading-8">类组件（了解即可）</h3>
<p>类组件继承自 <code>React.Component</code>，必须实现 <code>render</code> 方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);  <span class="hljs-comment">// 调用父类构造函数，this.props = props</span>
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>hello {this.props.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<blockquote>
<p>现代 React 开推荐使用函数组件 + Hooks，类组件主要用于维护老项目。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">三、JSX 语法</h2>
<p>JSX 是 JavaScript 的扩展语法，让在 JS 中写 HTML 变得更容易。</p>
<h3 data-id="heading-10">JSX 规则</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 必须关闭所有标签</span>
&lt;br /&gt;

<span class="hljs-comment">// 2. 必须有一个父元素包裹</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">AboutPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello there.<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>How do you do?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. 使用 className 而不是 class</span>
&lt;img className=<span class="hljs-string">"avatar"</span> /&gt;
</code></pre>
<h3 data-id="heading-11">在 JSX 中使用 JavaScript</h3>
<p>使用花括号 <code>{}</code> 可以在 JSX 中嵌入 JavaScript 表达式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Hedy Lamarr'</span>, <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">'https://i.imgur.com/yXOvdOSs.jpg'</span>, <span class="hljs-attr">imageSize</span>: <span class="hljs-number">90</span> };

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"avatar"</span>
        <span class="hljs-attr">src</span>=<span class="hljs-string">{user.imageUrl}</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">{</span>'<span class="hljs-attr">Photo</span> <span class="hljs-attr">of</span> ' + <span class="hljs-attr">user.name</span>}
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">width:</span> <span class="hljs-attr">user.imageSize</span>,
          <span class="hljs-attr">height:</span> <span class="hljs-attr">user.imageSize</span>
        }}
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>提示</strong>：<code>style={{}}</code> 不是特殊语法，而是 JSX 花括号内的一个普通对象。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、添加样式</h2>
<h3 data-id="heading-13">使用 className</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;img className=<span class="hljs-string">"avatar"</span> /&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* CSS 文件 */</span>
<span class="hljs-selector-class">.avatar</span> {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
}
</code></pre>
<h3 data-id="heading-14">使用内联样式</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div style={{ <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-string">'16px'</span> }}&gt;
  红色文字
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-15">五、条件渲染</h2>
<p>React 没有特殊的条件语法，使用普通的 JavaScript 条件语句。</p>
<h3 data-id="heading-16">方式一：if 语句</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> content;
<span class="hljs-keyword">if</span> (isLoggedIn) {
  content = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>;
} <span class="hljs-keyword">else</span> {
  content = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span>;
}

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{content}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
</code></pre>
<h3 data-id="heading-17">方式二：三元运算符（推荐）</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div&gt;
  {isLoggedIn ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span>}
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-18">方式三：逻辑与 &amp;&amp;（无 else 分支时）</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div&gt;
  {isLoggedIn &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>}
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-19">六、列表渲染</h2>
<p>使用 JavaScript 的 <code>map()</code> 函数渲染列表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> products = [
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'卷心菜'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> },
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'大蒜'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> },
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'苹果'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">3</span> },
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ShoppingList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> listItems = products.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>
      <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">color:</span> <span class="hljs-attr">product.isFruit</span> ? '<span class="hljs-attr">magenta</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">darkgreen</span>'
      }}
    &gt;</span>
      {product.title}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  );

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{listItems}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>;
}
</code></pre>
<blockquote>
<p><strong>重要</strong>：每个列表项都需要唯一的 <code>key</code> 属性，帮助 React 识别哪些项目发生了变化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">七、响应事件</h2>
<p>在组件内部声明<strong>事件处理函数</strong>来响应事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'你点击了我！'</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
      点击我
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：<code>onClick={handleClick}</code> 末尾没有括号！只传递函数引用，而不是调用它。React 会在用户点击时调用你的事件处理函数。</p>
</blockquote>
<h3 data-id="heading-21">事件绑定方式</h3>
<ul>
<li><strong>冒泡阶段</strong>：<code>onClick</code></li>
<li><strong>捕获阶段</strong>：<code>onClickCapture</code></li>
</ul>
<h3 data-id="heading-22">事件方法</h3>
<ul>
<li><code>event.stopPropagation()</code> - 阻止事件传播</li>
<li><code>event.preventDefault()</code> - 阻止默认行为（如 a 标签跳转）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">childBubble</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子节点冒泡'</span>);
    event.<span class="hljs-title function_">stopPropagation</span>();
  }

  clickLink = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    event.<span class="hljs-title function_">preventDefault</span>();
  }
}
</code></pre>
<h3 data-id="heading-23">事件执行顺序</h3>
<p>React 事件系统和原生事件系统是独立的，执行顺序：</p>
<ol>
<li>React 捕获阶段</li>
<li>React 冒泡阶段</li>
<li>原生捕获阶段</li>
<li>原生冒泡阶段</li>
</ol>
<hr/>
<h2 data-id="heading-24">八、状态管理</h2>
<p>组件使用**状态（State）**来"记忆"信息并显示它。</p>
<h3 data-id="heading-25">类组件状态</h3>
<h4 data-id="heading-26">初始化状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式1：在构造函数中</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">super</span>(props);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> };
}

<span class="hljs-comment">// 方式2：类属性（推荐）</span>
state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> };
</code></pre>
<h4 data-id="heading-27">setState 更新状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对象方式</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });

<span class="hljs-comment">// 函数方式（推荐，可基于旧状态计算新状态）</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(<span class="hljs-function">(<span class="hljs-params">prevState</span>) =&gt;</span> ({ <span class="hljs-attr">number</span>: prevState.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> }));

<span class="hljs-comment">// 带回调的 setState</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(
  <span class="hljs-function">(<span class="hljs-params">prevState</span>) =&gt;</span> ({ <span class="hljs-attr">number</span>: prevState.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> }),
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"State updated!"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span>);
  }
);
</code></pre>
<h3 data-id="heading-28">useState Hook</h3>
<p>在函数组件中添加状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
      点击了 {count} 次
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><code>count</code>：当前状态值</li>
<li><code>setCount</code>：更新状态的函数</li>
<li><code>useState(0)</code>：初始值为 0</li>
</ul>
<h3 data-id="heading-29">函数式更新（推荐）</h3>
<p>当新状态依赖于旧状态时，使用函数式更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-30">setState 的异步与批量更新</h3>
<h4 data-id="heading-31">React 17</h4>
<ul>
<li><strong>异步批量更新</strong>：在事件处理器、生命周期函数中，多个 <code>setState</code> 会被合并</li>
<li><strong>同步更新</strong>：在 setTimeout、Promise 等无法管理的场景中是同步的</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">handleClick = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 批量合并</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 未更新</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 批量合并</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 未更新</span>

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 同步更新</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 已更新</span>
  });
}
</code></pre>
<h4 data-id="heading-32">React 18</h4>
<p>无论在什么场景，<code>setState</code> 都是批量的</p>
<hr/>
<h2 data-id="heading-33">九、Hooks 规则</h2>
<ul>
<li><strong>只在顶层调用</strong>：不要在循环、条件或嵌套函数中调用 Hooks</li>
<li><strong>只在 React 函数中调用</strong>：在 React 函数组件或自定义 Hook 中调用</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (condition) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 不要这样做</span>
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-34">十、组件间共享数据</h2>
<h3 data-id="heading-35">问题：各自独立的状态</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每个按钮有自己独立的 count</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-36">解决：提升状态</h3>
<p>将状态提升到最近的共同父组件，通过 props 传递：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>计数器一起更新<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">{ count, onClick }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span>&gt;</span>
      点击了 {count} 次
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p>这就是"提升状态（Lifting State Up）"的概念。</p>
<hr/>
<h2 data-id="heading-37">十一、常用 Hooks 详解</h2>
<h3 data-id="heading-38">useState - 状态管理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 函数式更新</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-39">useReducer - 复杂状态管理</h3>
<p>复杂状态管理，类似 Redux：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> initialState = { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ADD'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'MINUS'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}

<span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initialState);
<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD'</span> });
</code></pre>
<h3 data-id="heading-40">useEffect - 副作用处理</h3>
<p>处理副作用，替代类组件的生命周期：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 相当于 componentDidMount</span>
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 返回清理函数，相当于 componentWillUnmount</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(timer);
  };
}, []); <span class="hljs-comment">// 空依赖数组 = 只执行一次</span>

<span class="hljs-comment">// 带依赖的 effect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 当 count 变化时执行</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Count changed:'</span>, count);
}, [count]);
</code></pre>
<h3 data-id="heading-41">useContext - 跨组件共享数据</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">'defaultValue'</span>);

<span class="hljs-comment">// 提供数据</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"hello"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">MyContext.Provider</span>&gt;</span></span>

<span class="hljs-comment">// 消费数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">MyContext</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-42">useMemo - 缓存计算结果</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> displayData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ count }), [count]);
</code></pre>
<h3 data-id="heading-43">useCallback - 缓存回调函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> incrementCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
}, [count]);
</code></pre>
<h3 data-id="heading-44">useRef - 引用 DOM</h3>
<p>在函数组件中创建 ref：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// {current: null}</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">focusInput</span>(<span class="hljs-params"/>) {
  inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
}

&lt;input ref={inputRef} /&gt;
</code></pre>
<h3 data-id="heading-45">useImperativeHandle - 自定义 ref 暴露</h3>
<p>自定义 ref 暴露给父组件的实例值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FancyInput</span>(<span class="hljs-params">props, ref</span>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-title function_">focus</span>(<span class="hljs-params"/>) {
      inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
    }
  }));

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span></span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ForwardFancyInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-title class_">FancyInput</span>);
</code></pre>
<h3 data-id="heading-46">useLayoutEffect - 同步副作用</h3>
<p>同步执行副作用，在 DOM 变更后同步调用（阻塞浏览器绘制）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在浏览器绘制之前执行</span>
  ref.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translate(500px)`</span>;
}, []);
</code></pre>
<hr/>
<h2 data-id="heading-47">十二、Ref 引用</h2>
<h3 data-id="heading-48">createRef（类组件）</h3>
<p>用于访问 DOM 元素或类组件实例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RefComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  inputRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>(); <span class="hljs-comment">// {current: null}</span>

  handleButtonClick = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();  <span class="hljs-comment">// 访问真实 DOM</span>
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.inputRef}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleButtonClick}</span>&gt;</span>获得焦点<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}
</code></pre>
<h3 data-id="heading-49">访问类组件实例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  childRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>();

  handleClick = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">childRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">alertMessage</span>();  <span class="hljs-comment">// 调用子组件方法</span>
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.childRef}/</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}
</code></pre>
<h3 data-id="heading-50">forwardRef（转发 ref）</h3>
<p>函数组件默认不能接收 ref，需要使用 <code>forwardRef</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChildComponent</span>(<span class="hljs-params">props, forwardRef</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{forwardRef}/</span>&gt;</span></span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ForwardChildComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-title class_">ChildComponent</span>);
</code></pre>
<hr/>
<h2 data-id="heading-51">十三、Context 上下文</h2>
<p>用于跨组件层级共享数据，避免层层传递 props</p>
<h3 data-id="heading-52">创建 Context</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-string">'defaultValue'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Provider</span>, <span class="hljs-title class_">Consumer</span> } = <span class="hljs-title class_">MyContext</span>;
</code></pre>
<h3 data-id="heading-53">使用 Context</h3>
<h4 data-id="heading-54">Provider 提供数据</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span> value={contextValue}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span>/&gt;</span></span>
&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span>&gt;
</code></pre>
<h4 data-id="heading-55">Consumer 消费数据（函数组件）</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Consumer</span>&gt;
  {<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>}
&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Consumer</span>&gt;
</code></pre>
<h4 data-id="heading-56">类组件使用 contextType</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClassComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-keyword">static</span> contextType = <span class="hljs-title class_">MyContext</span>;
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.context}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<h3 data-id="heading-57">多个 Context</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">BorderProvider</span> value={borderValue}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ColorProvider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{colorValue}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ColorProvider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">BorderProvider</span>&gt;
</code></pre>
<h3 data-id="heading-58">Context 嵌套规则</h3>
<p>Consumer 会读取最近的 Provider 的值</p>
<hr/>
<h2 data-id="heading-59">十四、性能优化</h2>
<h3 data-id="heading-60">shouldComponentUpdate</h3>
<p>通过返回布尔值控制组件是否更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">shouldComponentUpdate</span>(<span class="hljs-params">nextProps, nextState</span>) {
  <span class="hljs-keyword">return</span> nextState.<span class="hljs-property">number</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; <span class="hljs-comment">// 偶数才更新</span>
}
</code></pre>
<h3 data-id="heading-61">PureComponent</h3>
<p>自动进行浅比较，避免不必要的渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PureComp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.PureComponent</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.props.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<h3 data-id="heading-62">React.memo</h3>
<p>用于函数组件的记忆化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoCounter</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Counter</span>);

<span class="hljs-comment">// 自定义比较函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoComp</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Comp</span>, <span class="hljs-function">(<span class="hljs-params">prevProps, nextProps</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> prevProps.<span class="hljs-property">value</span> === nextProps.<span class="hljs-property">value</span>;
});
</code></pre>
<h3 data-id="heading-63">性能优化最佳实践</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [username, setUsername] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'zhufeng'</span>);
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 缓存对象</span>
  <span class="hljs-keyword">const</span> displayData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ count }), [count]);

  <span class="hljs-comment">// 缓存回调函数</span>
  <span class="hljs-keyword">const</span> incrementCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{username}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setUsername(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">MemoChildButton</span> <span class="hljs-attr">displayData</span>=<span class="hljs-string">{displayData}</span> <span class="hljs-attr">incrementCount</span>=<span class="hljs-string">{incrementCount}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-64">十五、生命周期（类组件）</h2>
<h3 data-id="heading-65">挂载阶段 (Mounting)</h3>
<ol>
<li><strong>constructor</strong> - 初始化状态</li>
<li><strong>componentWillMount</strong> (已废弃) - 组件将要挂载</li>
<li><strong>render</strong> - 计算虚拟 DOM（纯函数，不能有副作用）</li>
<li><strong>componentDidMount</strong> - 挂载完成，可发起网络请求</li>
</ol>
<h3 data-id="heading-66">更新阶段 (Updating)</h3>
<ol>
<li><strong>componentWillReceiveProps</strong> - 收到新属性（已废弃）</li>
<li><strong>getDerivedStateFromProps</strong> - 从属性派生状态（静态方法）</li>
<li><strong>shouldComponentUpdate</strong> - 决定是否更新（性能优化关键点）</li>
<li><strong>getSnapshotBeforeUpdate</strong> - 获取 DOM 更新前的快照</li>
<li><strong>componentWillUpdate</strong> - 将要更新（已废弃）</li>
<li><strong>render</strong> - 重新计算虚拟 DOM</li>
<li><strong>componentDidUpdate</strong> - 更新完成</li>
</ol>
<h3 data-id="heading-67">卸载阶段 (Unmounting)</h3>
<ul>
<li><strong>componentWillUnmount</strong> - 清理操作（清除定时器、取消网络请求）</li>
</ul>
<h3 data-id="heading-68">新生命周期方法示例</h3>
<h4 data-id="heading-69">getDerivedStateFromProps</h4>
<p>从 props 派生 state：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromProps</span>(<span class="hljs-params">nextProps, prevState</span>) {
  <span class="hljs-keyword">if</span> (nextProps.<span class="hljs-property">itemCount</span> !== prevState.<span class="hljs-property">itemCount</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">itemCount</span>: nextProps.<span class="hljs-property">itemCount</span> };
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不更新状态</span>
}
</code></pre>
<h4 data-id="heading-70">getSnapshotBeforeUpdate</h4>
<p>获取 DOM 更新前的快照：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">getSnapshotBeforeUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
  <span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listRef</span>.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">return</span> list.<span class="hljs-property">scrollHeight</span>;  <span class="hljs-comment">// 返回更新前的高度</span>
}

<span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState, snapshot</span>) {
  <span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listRef</span>.<span class="hljs-property">current</span>;
  <span class="hljs-comment">// 使用快照计算新的滚动位置</span>
  list.<span class="hljs-property">scrollTop</span> = list.<span class="hljs-property">scrollTop</span> + (list.<span class="hljs-property">scrollHeight</span> - snapshot);
}
</code></pre>
<hr/>
<h2 data-id="heading-71">十六、重要概念</h2>
<h3 data-id="heading-72">合成事件 (SyntheticEvent)</h3>
<p>React 实现的事件系统，与原生事件隔离，跨浏览器兼容。</p>
<h3 data-id="heading-73">批量更新 (Batching)</h3>
<p>React 会将多个状态更新合并为一次渲染，提高性能。</p>
<h3 data-id="heading-74">受控组件与非受控组件</h3>
<ul>
<li><strong>受控组件</strong>：表单元素的值由 React state 控制</li>
<li><strong>非受控组件</strong>：表单元素的值由 DOM 自身控制</li>
</ul>
<h3 data-id="heading-75">组件通信方式</h3>
<ol>
<li><strong>Props</strong> - 父子组件通信</li>
<li><strong>Callback</strong> - 子父组件通信</li>
<li><strong>Context</strong> - 跨层级通信</li>
<li><strong>Redux/Zustand</strong> - 全局状态管理</li>
<li><strong>Event Bus</strong> - 兄弟组件通信</li>
<li><strong>Ref</strong> - 直接访问子组件实例</li>
</ol>
<hr/>
<h2 data-id="heading-76">学习路径建议</h2>
<h3 data-id="heading-77">第一步：掌握基础</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 组件与 JSX</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> Props 传递</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 事件处理</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useState Hook</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 条件渲染和列表</li>
</ul>
<h3 data-id="heading-78">第二步：深入理解</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useEffect 副作用处理</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 组件间通信</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> Context 使用</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useRef 引用</li>
</ul>
<h3 data-id="heading-79">第三步：进阶技能</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 性能优化</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 自定义 Hooks</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 状态管理（useReducer）</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 表单处理</li>
</ul>
<h3 data-id="heading-80">第四步：实战项目</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> React Router 路由</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Redux Toolkit / Zustand</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> React Query 数据请求</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> UI 组件库（Ant Design / Material-UI）</li>
</ul>
<h2 data-id="heading-81">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn" target="_blank" title="https://react.dev/learn" ref="nofollow noopener noreferrer">React 官方文档 - Quick Start</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fcreating-a-react-app" target="_blank" title="https://react.dev/learn/creating-a-react-app" ref="nofollow noopener noreferrer">React 官方文档 - 创建应用</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fdescribing-the-ui" target="_blank" title="https://react.dev/learn/describing-the-ui" ref="nofollow noopener noreferrer">React 官方文档 - 描述 UI</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fadding-interactivity" target="_blank" title="https://react.dev/learn/adding-interactivity" ref="nofollow noopener noreferrer">React 官方文档 - 添加交互</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FLearn_web_development%2FCore%2FFrameworks_libraries%2FReact_getting_started" target="_blank" title="https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/Frameworks_libraries/React_getting_started" ref="nofollow noopener noreferrer">MDN - React 入门</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘]]></title>    <link>https://juejin.cn/post/7586622708998996008</link>    <guid>https://juejin.cn/post/7586622708998996008</guid>    <pubDate>2025-12-23T06:44:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708998996008" data-draft-id="7586622708998897704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘"/> <meta itemprop="keywords" content="OpenAI,前端"/> <meta itemprop="datePublished" content="2025-12-23T06:44:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="命中水"/> <meta itemprop="url" content="https://juejin.cn/user/3614849961851966"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3614849961851966/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    命中水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:44:26.000Z" title="Tue Dec 23 2025 06:44:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>首先说明，我不是专业的前端工程师。</p>
<p>但这次，我一个人完成了一个包含<strong>聊天窗口、WebSocket 实时推送、多语言翻译、复杂 UI 状态管理</strong>的前端项目。</p>
<p>说实话，如果没有 AI，这个项目我大概率会延期，甚至放弃一些体验上的细节。</p>
<p>这是我第一次，在一个<strong>真实、长期维护、并且已经上线使用的项目</strong>中，深度引入 AI 参与开发。 不是 Demo，不是练手，而是一个我必须为稳定性、性能和可维护性负责的系统。</p>
</blockquote>
<h2 data-id="heading-0">一、前言</h2>
<p>前端时间接了一个前端聊天+后端管理后台的项目，两个项目都是我自己一个人完成。</p>
<p>说起来后端还好，但是前端html+css那套我最开始入行的时候学了一点，但是后面正式工作后主要还是围绕后端语言来展开，前端的那套样式语法就渐渐地放下了；</p>
<p>但这次是一个全新的机会，也是一个新的挑战，需要自己写前端。那如何快速写前端项目，并快速交付呢？于是我想到了AI这个帮手，之前总拿它来排查问题，但是写一个项目行不行呢？ 我抱着怀疑的态度开始了这项“挑战”，并最终“有惊无险”的落地完成，顺利完成交付；</p>
<p>本篇文章，我想详细的复盘下这次经历：如何与AI沟通？ 如何合理利用AI完成代码的实现？以及举例一些聊天系统中实现的业务关键点！</p>
<p>在使用前，先想一下：</p>
<p><strong>AI 到底能帮我们做到什么？我们又该如何与 AI 协作，才能真的提高生产力，而不是制造技术债？</strong></p>
<h2 data-id="heading-1">二、与AI对话</h2>
<h3 data-id="heading-2">2.1 为什么我会把 AI 真正引入一个“正经项目”？</h3>
<p>先说结论： <strong>不是因为“新技术”，而是因为“现实问题”。</strong></p>
<p>我的真实情况</p>
<p>这个项目是一个 <strong>客服聊天系统</strong>，核心特点包括：</p>
<ul>
<li>Laravel 后端处理接口数据</li>
<li>jQuery + Bootstrap 前端（我比较熟悉的是这套组合拳）</li>
<li>多账号、多好友</li>
<li>WebSocket 实时推送</li>
<li>消息类型复杂（文本 / 图片 / 视频 / 语音）</li>
<li>SaaS 场景（多租户）</li>
</ul>
<p>我面临的真实问题是：</p>
<ul>
<li>后端我非常熟</li>
<li>但前端交互复杂、状态多、样式细</li>
<li>每一个“小交互”都很耗时间</li>
<li>而项目又在持续迭代，<strong>不能停下来重构</strong></li>
</ul>
<p>👉 这时，AI 不再是“锦上添花”，而是<strong>降低边际成本的工具</strong>。</p>
<hr/>
<h3 data-id="heading-3">2.2 AI 开发入门：不要幻想“全自动”，要追求“人机协作”</h3>
<h4 data-id="heading-4">2.2.1 AI 最适合做什么？</h4>
<p>在这次项目中，我给 AI 的定位非常清晰：</p>
<blockquote>
<p><strong>AI = 前端协作工程师</strong></p>
</blockquote>
<p>基于我当时的情况，我给它的定时是，辅助帮我写前端代码，包括但不限于以下：</p>
<ul>
<li>UI 结构拆解</li>
<li>JS 事件逻辑补全</li>
<li>CSS 微调与重构</li>
<li>复杂 DOM 操作的示例实现</li>
<li>重复性、模式化代码生成</li>
</ul>
<p>结合我使用之后的感觉，我认为他可能<strong>不太适合</strong>：</p>
<ul>
<li>定业务边界</li>
<li>定核心数据结构</li>
<li>决定架构选型</li>
<li>性能极限设计</li>
</ul>
<p><strong>这些必须由人来做。</strong></p>
<h4 data-id="heading-5">2.2.2 心态非常重要：你不是“用 AI”，而是在“带 AI”</h4>
<p>如果你把 AI 当成：</p>
<ul>
<li>“自动写代码工具”</li>
<li>“一句话生成系统”</li>
</ul>
<p>那你一定会失望。</p>
<p>但如果你把 AI 当成：</p>
<ul>
<li>一个不抱怨的工程师</li>
<li>一个愿意反复改的搭子</li>
<li>一个可以随时请教的助手</li>
</ul>
<p>你会发现它<strong>非常好用</strong>。</p>
<hr/>
<h3 data-id="heading-6">2.3 如何与 AI 沟通，才能真的把前端项目做出来？</h3>
<p>这一节，是我整篇文章里最想聊的部分。</p>
<h4 data-id="heading-7">2.3.1 关键原则一：给 AI “现有代码”，而不是“空需求”</h4>
<p>❌ 错误方式：</p>
<blockquote>
<p>帮我写一个聊天窗口</p>
</blockquote>
<p>✅ 正确方式：</p>
<blockquote>
<p>这是我现有的 HTML 结构 这是我的 JS 方法 这是我的业务规则 请在不破坏现有结构的前提下，实现功能 X</p>
</blockquote>
<p>AI 的代码质量，<strong>严重依赖上下文完整度</strong>。</p>
<p><strong>PS：如果你是从0开始让AI帮你完成项目，那最好在同一个人聊天窗口下，如果切换了聊天窗口，那可能会导致以前的消息可能无法产生关联；如果要优化，最好贴上之前的代码！</strong></p>
<hr/>
<h4 data-id="heading-8">2.3.2 关键原则二：需求要“具象”，不要“抽象”</h4>
<p>比如我会这样描述 UI：</p>
<blockquote>
<p>聊天窗口顶部： 左侧是头像 + 昵称 右侧是三个点按钮 点击后，从“聊天窗口右侧”滑出信息面板 而不是整个页面</p>
</blockquote>
<p>你会发现：<strong>我描述的是“画面”，不是“功能名词”。</strong></p>
<h4 data-id="heading-9">2.3.3 关键原则三：有问题就“精准反馈”，不要一句否定</h4>
<p>我在项目中经常这样和 AI 互动：</p>
<ul>
<li>“三个点按钮没有靠右”</li>
<li>“事件绑定不到，因为是动态元素”</li>
<li>“滑出层相对于 body 了，不是 chat-panel”</li>
</ul>
<p>这种反馈，会让 AI <strong>快速修正，而不是推倒重来</strong>。</p>
<h4 data-id="heading-10">2.3.4 一个我踩过的坑：AI 会“自信地写错”</h4>
<p>AI不是万能的，它也有可能出错，你的描述词不清晰，代码未提供完整，就可能导致：</p>
<ul>
<li>CSS 看起来对，但层级错了</li>
<li>JS 逻辑跑得通，但状态没覆盖</li>
<li>WebSocket 示例是 Demo 级，不是生产级</li>
</ul>
<p>所以我后来形成了一个习惯：<strong>AI负责“给方案”，我负责“兜底校验”！</strong></p>
<h2 data-id="heading-11">三、项目功能关键点拆解示例</h2>
<h3 data-id="heading-12">3.1 关键功能点一：前后端聊天消息推送</h3>
<h4 data-id="heading-13">3.1.1 后端整体设计思路</h4>
<p>我采用的是：</p>
<ul>
<li><strong>Workerman / GatewayWorker</strong></li>
<li>后端消息统一入库</li>
<li>再推送 WebSocket 给前端</li>
</ul>
<p>核心原则是：</p>
<blockquote>
<p><strong>消息以“后端为准”，前端只是展示层</strong></p>
</blockquote>
<hr/>
<p>我设计的流程是，后端采用脚本监听第三方消息服务，监听到有消息之后推送到job，job中处理消息，代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
​
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Jobs</span>;
​
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountFriendChatRecordRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountFriendRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">GatewayService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">InstagramMessageService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">TranslateService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Bus</span>\<span class="hljs-title">Queueable</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">ShouldQueue</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Bus</span>\<span class="hljs-title">Dispatchable</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">InteractsWithQueue</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">SerializesModels</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">DB</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Log</span>;
​
<span class="hljs-comment">/**
 * 处理mqtt消息
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessIncomingMqttMessage</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span>
</span>{
    <span class="hljs-keyword">use</span> <span class="hljs-title">Dispatchable</span>, <span class="hljs-title">InteractsWithQueue</span>, <span class="hljs-title">Queueable</span>, <span class="hljs-title">SerializesModels</span>;
​
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$payload</span>;
​
    <span class="hljs-comment">/**
     * Create a new job instance.
     *
     * <span class="hljs-doctag">@return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$payload</span></span>)
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;payload = <span class="hljs-variable">$payload</span>;
    }
​
    <span class="hljs-comment">/**
     * Execute the job.
     *
     * <span class="hljs-doctag">@return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'PK'</span>]) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">'缺少PK！'</span>);
            }
            <span class="hljs-variable">$accountKey</span> = <span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'PK'</span>];
            <span class="hljs-variable">$account</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">firstWhere</span>([<span class="hljs-string">'account_key'</span> =&gt; <span class="hljs-variable">$accountKey</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable constant_">STATUS_ENABLE</span>]);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$account</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"account_key：<span class="hljs-subst">{$accountKey}</span>对应的account数据不存在"</span>);
            }
​
            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>]) || !<span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>])) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">'payload数据异常！'</span>);
            }
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) {
                <span class="hljs-comment">/**
                 * UserId 发送方id
                 * RealTimeOp 类型
                 * Text 文本类型是内容字段
                 * Media 媒体类型时字段
                 */</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'UserId'</span>])) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'payload中没有UserId：'</span>  . <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$value</span>));
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$friend</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">firstWhere</span>([<span class="hljs-string">'pks'</span> =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'UserId'</span>], <span class="hljs-string">'account_id'</span> =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>]]);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$friend</span>)) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">"pks：<span class="hljs-subst">{$value['UserId']}</span>在好友表中不存在！"</span>);
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$contentType</span> = <span class="hljs-title class_">InstagramMessageService</span>::<span class="hljs-title function_ invoke__">transContentType</span>(<span class="hljs-variable">$value</span>);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$contentType</span>)) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">warning</span>(<span class="hljs-string">'ProcessIncomingMqttMessage - handle 未知的消息类型'</span> . <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$value</span>));
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$sendTime</span> = <span class="hljs-title function_ invoke__">transMicrosecondTimestamp</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'TimeStampUnix'</span>]);
​
                <span class="hljs-variable">$data</span> = [
                    <span class="hljs-string">'customer_id'</span>       =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'belong_customer_id'</span>],
                    <span class="hljs-string">'account_id'</span>        =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'friend_id'</span>         =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'content'</span>           =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>] ?? <span class="hljs-literal">null</span>,
                    <span class="hljs-string">'content_type'</span>      =&gt; <span class="hljs-variable">$contentType</span>,
                    <span class="hljs-string">'attachment'</span>        =&gt; <span class="hljs-title class_">InstagramMessageService</span>::<span class="hljs-title function_ invoke__">getAttachment</span>(<span class="hljs-variable">$contentType</span>, <span class="hljs-variable">$value</span>),
                    <span class="hljs-string">'item_id'</span>           =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'ItemId'</span>],
                    <span class="hljs-string">'send_time'</span>         =&gt; <span class="hljs-title function_ invoke__">transMicrosecondTimestamp</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'TimeStampUnix'</span>]),
                    <span class="hljs-string">'send_status'</span>       =&gt; <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">STATUS_SUCCESS</span>
                ];
                
                <span class="hljs-comment">// 如果是文本类型 获取翻译之后的数据</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$contentType</span> == <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">CONTENT_TYPE_TEXT</span>) {
                    <span class="hljs-variable">$transContent</span> = <span class="hljs-title class_">TranslateService</span>::<span class="hljs-title function_ invoke__">getChatMessageTranslate</span>(<span class="hljs-variable">$account</span>[<span class="hljs-string">'belong_customer_id'</span>], <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>]);
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$transContent</span> &amp;&amp; (<span class="hljs-variable">$transContent</span> != <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>])) {
                        <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_translate'</span>] = <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">CONTENT_TRANSLATE</span>;
                        <span class="hljs-variable">$data</span>[<span class="hljs-string">'content_translate'</span>] = <span class="hljs-variable">$transContent</span>;
                    }
                }
​
                DB::<span class="hljs-title function_ invoke__">beginTransaction</span>();
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-variable">$record</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateOrCreate</span>([<span class="hljs-string">'item_id'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'item_id'</span>]], <span class="hljs-variable">$data</span>);
                    <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateLastChatTime</span>(<span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>], <span class="hljs-variable">$sendTime</span>);
                    <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateLastChatTime</span>(<span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>], <span class="hljs-variable">$sendTime</span>);
                    DB::<span class="hljs-title function_ invoke__">commit</span>();
                } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
                    DB::<span class="hljs-title function_ invoke__">rollBack</span>();
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'ProcessIncomingMqttMessage handle 落库失败，异常原因：'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-variable">$data</span>[<span class="hljs-string">'message_id'</span>] = <span class="hljs-variable">$record</span>-&gt;id;
​
                <span class="hljs-title class_">GatewayService</span>::<span class="hljs-title function_ invoke__">pushMessageToClient</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$friend</span>);
                <span class="hljs-comment">// 自动回复消息</span>
                <span class="hljs-title function_ invoke__">dispatch</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendAutoReplyMessageJob</span>(<span class="hljs-variable">$record</span>-&gt;id))-&gt;<span class="hljs-title function_ invoke__">onConnection</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">onQueue</span>(<span class="hljs-string">'SendAutoReplyMessageSqs'</span>);
            }
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">'ProcessIncomingMqttMessage fail line:'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getLine</span>() . <span class="hljs-string">' 报错信息：'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(), [<span class="hljs-string">'payload'</span> =&gt; <span class="hljs-variable">$this</span>-&gt;payload]);
        }
    }
}
</code></pre>
<p><code>GatewayService</code>类的<code>pushMessageToClient</code>方法代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushMessageToClient</span>(<span class="hljs-params"><span class="hljs-variable">$data</span>, <span class="hljs-variable">$friend</span></span>)
</span>{
    <span class="hljs-variable">$gatewayHost</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'services.gateway.host'</span>, <span class="hljs-string">'127.0.0.1'</span>);
    <span class="hljs-variable">$gatewayPort</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'services.gateway.port'</span>, <span class="hljs-string">'1238'</span>);
​
    <span class="hljs-title class_">Gateway</span>::<span class="hljs-variable">$registerAddress</span> = <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">'%s:%s'</span>, <span class="hljs-variable">$gatewayHost</span>, <span class="hljs-variable">$gatewayPort</span>);
​
    <span class="hljs-variable">$sendData</span> = [
        <span class="hljs-string">'account_id'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'account_id'</span>],
        <span class="hljs-string">'friend_id'</span>     =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'friend_id'</span>],
        <span class="hljs-string">'friend_name'</span>   =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'username'</span>],
        <span class="hljs-string">'friend_avatar'</span> =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'avatar'</span>],
        <span class="hljs-string">'send_time'</span>     =&gt; <span class="hljs-title function_ invoke__">format_time</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'send_time'</span>]),
        <span class="hljs-string">'timestamp'</span>     =&gt; <span class="hljs-title function_ invoke__">format_time</span>(<span class="hljs-literal">null</span>),
        <span class="hljs-string">'content'</span>       =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'content'</span>],
        <span class="hljs-string">'attachment'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'attachment'</span>],
        <span class="hljs-string">'content_type'</span>  =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'content_type'</span>],
        <span class="hljs-string">'message_id'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'message_id'</span>],
        <span class="hljs-string">'is_me'</span>         =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_me'</span>] ?? <span class="hljs-literal">false</span>,
        <span class="hljs-string">'is_auto_reply'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_auto_reply'</span>] ?? <span class="hljs-literal">false</span>,
    ];
​
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$sendData</span>[<span class="hljs-string">'is_me'</span>]) {
        <span class="hljs-comment">// 不管客服有没有在线 先标记账号和好友 有未读数据（从前端去处理已读）</span>
        <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">update</span>([<span class="hljs-string">'is_have_un_read_msg'</span> =&gt; <span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable constant_">HAVE_UN_READ_MSG</span>], <span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>]);
        <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">update</span>([<span class="hljs-string">'is_have_un_read_msg'</span> =&gt; <span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable constant_">HAVE_UN_READ_MSG</span>], <span class="hljs-variable">$data</span>[<span class="hljs-string">'account_id'</span>]);
    }
​
    <span class="hljs-comment">// 判断当前客服是否在线</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Gateway</span>::<span class="hljs-title function_ invoke__">isUidOnline</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>])) {
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'推送到客户端信息'</span>, [<span class="hljs-string">'customer_id'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>], <span class="hljs-string">'data'</span> =&gt; <span class="hljs-title function_ invoke__">json_encode</span>([
            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'new_message'</span>,
            <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$sendData</span>
        ])]);
        <span class="hljs-comment">// 发送消息给客服</span>
        <span class="hljs-title class_">Gateway</span>::<span class="hljs-title function_ invoke__">sendToUid</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>], <span class="hljs-title function_ invoke__">json_encode</span>([
            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'new_message'</span>,
            <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$sendData</span>
        ]));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">"客服id：<span class="hljs-subst">{$data['customer_id']}</span>，未在线~"</span>, [<span class="hljs-string">'send_data'</span> =&gt; <span class="hljs-variable">$sendData</span>]);
    }
}
</code></pre>
<p>这个方法多个地方都可以调用，比如：</p>
<ul>
<li>接收到消息推送到前端</li>
<li>前端发送消息，后端推送到第三方成功，发送到前端回显</li>
<li>自动回复消息成功，发送到前端回显</li>
<li>...</li>
</ul>
<h4 data-id="heading-14">3.1.2 后端推送的数据结构</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"account_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">123456</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">789012</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_avatar"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://example.com/avatar.jpg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"send_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-10-15 14:30:25"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-10-15 16:45:10"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好，最近怎么样？"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"attachment"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image_001.jpg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"message_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"msg_20231015143025_123456"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"is_me"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"is_auto_reply"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">3.1.3 前端接收消息</h4>
<p>绑定并监听websocket</p>
<pre><code class="hljs language-ini" lang="ini">// 绑定 WebSocket
function connectWebSocket() {
    if (!CUSTOMER_ID) {
        console.error('未设置客服ID，无法连接WebSocket')<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    // 清除之前的重连定时器
    if (reconnectTimer) {
        clearTimeout(reconnectTimer)<span class="hljs-comment">;</span>
        <span class="hljs-attr">reconnectTimer</span> = null<span class="hljs-comment">;</span>
    }
​
    <span class="hljs-attr">ws</span> = new WebSocket(window.WEBSECKET_HOST)<span class="hljs-comment">; // 改成你的服务地址</span>
​
    <span class="hljs-attr">ws.onopen</span> = function () {
        console.log('WebSocket 已连接')<span class="hljs-comment">;</span>
        <span class="hljs-attr">lastPongTime</span> = Date.now()<span class="hljs-comment">; // 连接建立时重置时间</span>
        <span class="hljs-attr">reconnectAttempts</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 重置计数器</span>
​
        // 绑定客服登录用户ID
        ws.send(JSON.stringify({
            type: 'bind',
            uid: CUSTOMER_ID
        }))<span class="hljs-comment">;</span>
        // 启动心跳检测
        startHeartbeatCheck()<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onmessage</span> = function (event) {
        console.log('收到消息：', event.data)<span class="hljs-comment">;</span>
        let <span class="hljs-attr">msg</span> = {}<span class="hljs-comment">;</span>
        try {
            <span class="hljs-attr">msg</span> = JSON.parse(event.data)<span class="hljs-comment">;</span>
        } catch (e) {
            console.warn('收到非法消息', event.data)<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'ping'</span>) {
            // 服务器心跳包，更新最后活跃时间并回复pong
            <span class="hljs-attr">lastPongTime</span> = Date.now()<span class="hljs-comment">;</span>
            // 服务器心跳包，回复pong
            ws.send(JSON.stringify({type: 'pong'}))<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'new_message'</span>) {
            console.log('收到new_message消息：', msg.data)<span class="hljs-comment">;</span>
            handleIncomingMessage(msg.data)<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'account_online_status'</span>) {
            const <span class="hljs-attr">data</span> = msg.data<span class="hljs-comment">;</span>
            console.log('收到account_online_status消息：', msg.data)<span class="hljs-comment">;</span>
            updateAccountOnlineStatus(data)<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'send_message_status'</span>) {
            console.log('收到send_message_status消息：', msg.data)<span class="hljs-comment">;</span>
            const <span class="hljs-attr">data</span> = msg.data<span class="hljs-comment">;</span>
            // updateFriendOnlineStatus(data)<span class="hljs-comment">;</span>
​
            updateMessageSendStatus(data)
        }
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onclose</span> = function () {
        reconnectAttempts++<span class="hljs-comment">;</span>
​
        // 渐进式重连：前3次快速重连，后续采用退避策略
        const <span class="hljs-attr">delay</span> = reconnectAttempts &lt;= <span class="hljs-number">3</span> ?
            BASE_DELAY :
            Math.min(BASE_DELAY * Math.pow(1.5, reconnectAttempts - 3), MAX_DELAY)<span class="hljs-comment">;</span>
​
        console.warn(`<span class="hljs-section">[第${reconnectAttempts}次重连]</span> ${delay}ms后尝试...`)<span class="hljs-comment">;</span>
        setTimeout(connectWebSocket, delay)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onerror</span> = function (e) {
        console.error('WebSocket 发生错误')<span class="hljs-comment">;</span>
        console.error('WS错误代码:', e.code)<span class="hljs-comment">;</span>
        console.error('WS错误原因:', e.reason)<span class="hljs-comment">;</span>
        ws.close()<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
}
​
/**
 * 新消息处理
 * @param msg
 */
function handleIncomingMessage(msg) {
    console.log('handleIncomingMessage', msg)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">currentAccountId</span> = state.currentAccountId<span class="hljs-comment">;</span>
    const <span class="hljs-attr">currentFriendId</span> = state.currentFriendId<span class="hljs-comment">;</span>
​
    if (<span class="hljs-attr">msg.account_id</span> === currentAccountId) {
        if (<span class="hljs-attr">msg.friend_id</span> === currentFriendId) {
            // 当前聊天窗口好友，追加消息
            appendMessage({
                me: msg.is_me || false,
                auto_reply: msg.is_auto_reply || false,
                name: msg.friend_name,
                avatar: msg.friend_avatar,
                timestamp: msg.timestamp,
                send_time: msg.send_time,
                content: msg.content,
                attachment: msg.attachment,
                id: msg.message_id,
                type: getContentType(msg.content_type)
            })<span class="hljs-comment">;</span>
            // 如果当前消息是当前聊天好友的，标记好友状态为已读
            setFriendUnReadStatus(msg.friend_id, 0)<span class="hljs-comment">;</span>
            translateVisibleMessages($('select<span class="hljs-section">[name="input_target_lang"]</span>').val(), 'left')<span class="hljs-comment">;</span>
        } else {
            // 当前账号的其他好友，标红点
            markFriendUnreadDot(msg.friend_id, msg.account_id)<span class="hljs-comment">;</span>
        }
    } else {
        // 非当前账号，账号头像标红点
        markAccountUnreadDot(msg.account_id)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这个这段逻辑主要包括：</p>
<ul>
<li>当前聊天窗口实时追加消息</li>
<li>非当前好友 → 好友红点</li>
<li>非当前账号 → 账号红点</li>
</ul>
<p>这里之所以要在前端判断account_id /friend_id，而不是后端分多钟类型推是因为：</p>
<ul>
<li>降低后端推送负责度，而且我觉得在前端判断会更好</li>
<li>保证前端状态一致性</li>
<li>方便后续扩展更多UI状态</li>
</ul>
<hr/>
<h3 data-id="heading-16">3.2 关键功能点二：中英文切换与“批量翻译”的实现思路</h3>
<p>这是一个让我非常满意、也非常适合 AI 协作的功能。</p>
<h4 data-id="heading-17">3.2.1 我的需求不是“翻译一条消息”</h4>
<p>而是：</p>
<ul>
<li>聊天窗口已有历史消息</li>
<li>切换语言后</li>
<li><strong>原文不变</strong></li>
<li>原文下方显示译文</li>
<li>支持再次切换目标语言</li>
</ul>
<hr/>
<h4 data-id="heading-18">3.2.2 前端结构设计（AI 协助）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-message-bubble"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"original-text"</span>&gt;Hello&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"translated-text text-muted small"</span>&gt;你好&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>AI 在这里给了我一个很重要的建议：</p>
<blockquote>
<p>翻译内容不要覆盖原文，而是“附加”</p>
</blockquote>
<p>如果一开始就让 AI 覆盖原文，后期做多语言切换、撤销翻译、重新翻译，都会非常痛苦。这让体验和可维护性都好很多。</p>
<h4 data-id="heading-19">3.2.3 切换语言时的 JS 逻辑</h4>
<pre><code class="hljs language-ini" lang="ini">// Tab 切换事件
$("<span class="hljs-comment">#collapseTranslate").on('change', '.translate-select', function () {</span>
    let <span class="hljs-attr">name</span> = $(this).attr(<span class="hljs-string">'name'</span>)<span class="hljs-comment">;</span>
    let value<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'chat_message_auto_translate'</span> || name === <span class="hljs-string">'input_auto_translate'</span>) {
        const <span class="hljs-attr">isChecked</span> = $(this).is(<span class="hljs-string">':checked'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">value</span> = isChecked ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    } else {
        <span class="hljs-attr">value</span> = $(this).val()<span class="hljs-comment">;</span>
    }
​
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'input_target_lang'</span>) {
        translateVisibleMessages(value)<span class="hljs-comment">;</span>
    }
​
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'chat_message_target_lang'</span>) {
        translateVisibleMessages(value, 'left')<span class="hljs-comment">;</span>
    }
​
    $.post('/chat/change_translate_config', {
        name: name,
        value: value
    }, function (res) {
        if (res.code !== 0) {
            layer.msg(res.msg)
        }
    })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
/**
 * 聊天框内容翻译
 * @param targetLang
 * @param trans_message_type
 */
function translateVisibleMessages(<span class="hljs-attr">targetLang</span> = <span class="hljs-string">'en'</span>, trans_message_type = <span class="hljs-string">'right'</span>) {
    const <span class="hljs-attr">messagesToTranslate</span> = []<span class="hljs-comment">;</span>
    const <span class="hljs-attr">selector</span> = <span class="hljs-string">'.chat-message-wrapper.chat-message-'</span> + trans_message_type<span class="hljs-comment">;</span>
    console.log('selector', selector)<span class="hljs-comment">; // 输出拼接的选择器</span>
    console.log('匹配到元素数量:', $(selector).length)<span class="hljs-comment">;</span>
    $(selector).each(function () {
        const $<span class="hljs-attr">wrapper</span> = $(this)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">messageId</span> = <span class="hljs-variable">$wrapper</span>.data(<span class="hljs-string">'id'</span>)<span class="hljs-comment">;</span>
​
        const $<span class="hljs-attr">bubble</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble'</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">content</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble .original-text'</span>).text().trim()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">cacheKey</span> = `<span class="hljs-variable">${messageId}</span>_<span class="hljs-variable">${targetLang}</span>`<span class="hljs-comment">;</span>
​
        if (!messageId || !content) return<span class="hljs-comment">;</span>
​
        // 若已缓存则直接渲染
        if (translationCache<span class="hljs-section">[cacheKey]</span>) {
            applyTranslatedMessage(messageId, translationCache<span class="hljs-section">[cacheKey]</span>)<span class="hljs-comment">;</span>
        } else {
            // 显示 loading 占位
            insertLoadingPlaceholder($bubble)<span class="hljs-comment">;</span>
​
            // 准备发送的内容
            messagesToTranslate.push({ message_id: messageId, content })<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
​
    console.log('messagesToTranslate', messagesToTranslate)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">messagesToTranslate.length</span> === <span class="hljs-number">0</span>) return<span class="hljs-comment">;</span>
​
    $.ajax({
        url: '/chat/translate/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            messages: messagesToTranslate,
            target_lang: targetLang
        }),
        success: function (res) {
            if (<span class="hljs-attr">res.code</span> === <span class="hljs-number">0</span> &amp;&amp; Array.isArray(res.data)) {
                res.data.forEach(<span class="hljs-attr">item</span> =&gt; {
                    const <span class="hljs-attr">cacheKey</span> = `<span class="hljs-variable">${item.message_id}</span>_<span class="hljs-variable">${targetLang}</span>`<span class="hljs-comment">;</span>
                    translationCache<span class="hljs-section">[cacheKey]</span> = item.translate<span class="hljs-comment">;</span>
                    applyTranslatedMessage(item.message_id, item.translate)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            }
        }
    })<span class="hljs-comment">;</span>
}
​
/**
 * 翻译内容显示
 * @param messageId
 * @param translation
 */
function applyTranslatedMessage(messageId, translation) {
    const $<span class="hljs-attr">wrapper</span> = $(`.chat-message-wrapper[data-id=<span class="hljs-string">"${messageId}"</span>]`)<span class="hljs-comment">;</span>
    const $<span class="hljs-attr">bubble</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble'</span>)<span class="hljs-comment">;</span>
​
    const $<span class="hljs-attr">translated</span> = <span class="hljs-variable">$bubble</span>.find(<span class="hljs-string">'.translated-text'</span>)<span class="hljs-comment">;</span>
    if ($translated.length) {
        $translated.text(translation)<span class="hljs-comment">;</span>
    } else {
        $bubble.append(`
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span>&gt;&lt;/div&gt;
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"translated-text text-muted small"</span>&gt;<span class="hljs-variable">${translation}</span>&lt;/div&gt;
        `)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这段代码是 AI 在我给出 DOM 结构后帮我补全的。</p>
<hr/>
<h3 data-id="heading-20">3.3 关键功能点三：复杂 UI 交互（微信式体验）如何落地？</h3>
<p>比如：</p>
<ul>
<li>消息气泡宽度</li>
<li>时间显示位置</li>
<li>自己 / 对方对齐方式</li>
<li>动态按钮事件绑定</li>
</ul>
<h4 data-id="heading-21">3.3.1 动态元素事件绑定问题</h4>
<p>我一开始写的是：</p>
<pre><code class="hljs language-csharp" lang="csharp">$(<span class="hljs-string">'#toggle-friend-info'</span>).<span class="hljs-keyword">on</span>(<span class="hljs-string">'click'</span>, ...)
</code></pre>
<p>AI 很快指出问题：</p>
<blockquote>
<p><strong>这是动态生成的 DOM，需要事件委托</strong></p>
</blockquote>
<p>修正后：</p>
<pre><code class="hljs language-javascript" lang="javascript">$(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-string">'#toggle-friend-info'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    $(<span class="hljs-string">'#friend-info-panel'</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">'show'</span>);
});
</code></pre>
<p>这是一个<strong>非常典型的“AI 帮你查漏补缺”场景</strong>。</p>
<hr/>
<h4 data-id="heading-22">3.3.2 滑出面板相对聊天窗口，而不是页面</h4>
<p>AI 在我反馈问题后，帮我调整为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chat-panel</span> {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">overflow</span>: hidden;
}
<span class="hljs-selector-class">.friend-info-panel</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">right</span>: -<span class="hljs-number">260px</span>;
    <span class="hljs-attribute">transition</span>: right .<span class="hljs-number">3s</span>;
}
<span class="hljs-selector-class">.friend-info-panel</span><span class="hljs-selector-class">.show</span> {
    <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-23">3.3.3 发送消息、接收消息左右分隔</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chat-message-wrapper</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: flex-start;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
​
<span class="hljs-selector-class">.chat-message-left</span> {
    <span class="hljs-attribute">flex-direction</span>: row;
}
​
<span class="hljs-selector-class">.chat-message-right</span> {
    <span class="hljs-attribute">flex-direction</span>: row-reverse;
}
​
<span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: inline-flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">75%</span>;   <span class="hljs-comment">/* 让消息区最大占75%宽 */</span>
    <span class="hljs-attribute">word-wrap</span>: break-word;
}
​
<span class="hljs-comment">/* 自己发的消息（右侧） */</span>
<span class="hljs-selector-class">.chat-message-right</span> <span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">align-items</span>: flex-end; <span class="hljs-comment">/* 时间右对齐 */</span>
}
​
<span class="hljs-comment">/* 对方的消息（左侧） */</span>
<span class="hljs-selector-class">.chat-message-left</span> <span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">align-items</span>: flex-start; <span class="hljs-comment">/* 时间左对齐 */</span>
}
​
<span class="hljs-selector-class">.chat-message-bubble</span> {
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">95%</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">word-wrap</span>: break-word;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">2px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.05</span>);
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
}
</code></pre>
<p>以上这些，基本上都是AI帮我完成调优的。</p>
<hr/>
<p><strong>除了以上几个功能点之外，我还实现了</strong></p>
<ol>
<li>退出登录聊天窗记忆功能：退出登录，记录上次聊天的对象，再次登录后自动打开最后一次聊天对象所在的分组、tab、聊天窗口、聊天记录</li>
<li>多语言切换：通过配置切换当前要展示的语言</li>
<li>快捷回复：添加（文本、图片、视频、语音）、删除、快捷发送</li>
<li>自动回复：接收到消息自动回复</li>
<li>翻译配置：支持发送出去的消息和接收到的消息，可以分别配置源语言、翻译为目标语言。比如发出去的是中文，实际对方接收到的是英文；接收到的是英文、韩文，聊天窗显示中文</li>
<li>未读分组、tab、好友红点标记等</li>
</ol>
<p>太多了，具体细节就不一一介绍了，光聊天一个窗口交互就复杂的一批（感觉要钱要少了，orz...</p>
<h2 data-id="heading-24">四、效果展示</h2>
<p>登录</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98418a379ea34304a86f864f628e9739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=xmIuK%2FZS4Te%2Ba2GMEZ99sV68eow%3D" alt="image-20251223114030780.png" loading="lazy"/></p>
<p>聊天首页</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/557540fcbd98499db712129df3782e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=tpq652ajSRqbLN8JccuhVSLtdeA%3D" alt="image-20251223114119055.png" loading="lazy"/></p>
<p>翻译配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80c818f0b1b6401da88207840bac5598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=zol8YF6s9n95wY3SNw9QOexykc4%3D" alt="image-20251223114155843.png" loading="lazy"/></p>
<p>自动回复配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4016d60d51fe486584110a58d79f9bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=b2VJDFXtuabFfHiT7ZXmH5lTUcg%3D" alt="image-20251223114232951.png" loading="lazy"/></p>
<h2 data-id="heading-25">五、总结</h2>
<h3 data-id="heading-26">5.1 AI写代码的优缺点</h3>
<p>基于我这次和AI对话的实战来看，优点是非常明显的</p>
<ul>
<li>前端效率提升巨大</li>
<li>UI 微调不再痛苦</li>
<li>可以快速试错</li>
<li>非前端工程师也能做出“像样界面”</li>
</ul>
<p>但是<strong>缺点也很明显</strong>：</p>
<ul>
<li>不会主动考虑性能极限</li>
<li>容易“写得能用，但不够优雅”</li>
<li>架构必须你来定</li>
<li>需要你具备基本判断能力</li>
</ul>
<h3 data-id="heading-27">5.2 其他</h3>
<p>AI的使用远不限于此，如果你愿意学习如何使用：</p>
<ul>
<li>描述需求</li>
<li>提供上下文</li>
<li>精准反馈</li>
<li>与 AI 协作</li>
</ul>
<p>你会发现：<strong>一个人，可以完成过去一个小团队才能完成的事情。</strong></p>
<h2 data-id="heading-28">六、写到最后</h2>
<p>对我来说，AI 并不是让我“变成前端工程师”，而是让我在有限时间内，把一个本来可能妥协的项目，<strong>做到自己满意为止</strong>。</p>
<p>从某些方面来说，AI让我变的更高效，从之前排查问题靠百度、靠在社区提问，到现在有问题问AI，AI的准确率还不错；从之前靠自己经验写出一段逻辑代码，到现在请AI帮我优化，大大提高了我代码的质量；AI是个好东西，咱们程序员还是要擅于利用它，这样才有更多的时间“摸鱼"（提高自己）啊</p>
<blockquote>
<p>你有没有用 AI 真正写过项目呢？欢迎评论聊聊。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个基于 Vue 的 GitHub 用户搜索案例]]></title>    <link>https://juejin.cn/post/7586663700900839433</link>    <guid>https://juejin.cn/post/7586663700900839433</guid>    <pubDate>2025-12-23T07:45:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700900839433" data-draft-id="7586663700900790281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个基于 Vue 的 GitHub 用户搜索案例"/> <meta itemprop="keywords" content="前端,Vue.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-23T07:45:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个基于 Vue 的 GitHub 用户搜索案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:45:55.000Z" title="Tue Dec 23 2025 07:45:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 Vue 组件化开发的过程中，我通过一个 GitHub 用户搜索的小案例，将<strong>组件拆分、事件通信、条件渲染以及异步请求</strong>等核心知识点串联了起来。虽然功能不复杂，但非常适合作为理解 Vue 应用结构的练习。</p>
<p>整个项目由三个组件组成：<code>App.vue</code>、<code>MySearch.vue</code> 和 <code>MyList.vue</code>，采用了典型的“父容器 + 功能组件”的结构设计。</p>
<hr/>
<h2 data-id="heading-0">一、根组件 App.vue：只负责组合，不写业务</h2>
<p>先看根组件 <code>App.vue</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MySearch</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MyList</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MySearch</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/MySearch.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/MyList.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span>,
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">MySearch</span>,
    <span class="hljs-title class_">MyList</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>可以看到，<code>App.vue</code> <strong>没有任何业务逻辑</strong>，只做了三件事：</p>
<ol>
<li>引入子组件</li>
<li>注册子组件</li>
<li>在模板中组合页面结构</li>
</ol>
<p>这种写法非常符合 Vue 的设计思想：</p>
<blockquote>
<p>根组件只负责“搭架子”，具体功能全部下沉到子组件中。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、MySearch.vue：搜索逻辑与请求发起者</h2>
<h3 data-id="heading-2">1. 模板结构：输入 + 触发搜索</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;input
  <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"enter the name you search"</span>
  <span class="hljs-attr">v-model.trim</span>=<span class="hljs-string">"keyWord"</span>
  @<span class="hljs-attr">keyup.enter</span>=<span class="hljs-string">"searchUsers"</span>
/&gt;
&lt;button @<span class="hljs-attr">click</span>=<span class="hljs-string">"searchUsers"</span>&gt;Search&lt;/button&gt;
</code></pre>
<p>这里用到了几个非常关键的点：</p>
<ul>
<li><code>v-model.trim</code>：<br/>
自动去掉用户输入的首尾空格，避免无效请求</li>
<li><code>@keyup.enter</code>：<br/>
支持回车搜索，提升用户体验</li>
<li>按钮点击和回车复用同一个方法</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. data 定义：只存搜索关键词</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">keyWord</span>: <span class="hljs-string">''</span>
  }
}
</code></pre>
<p>搜索组件的职责非常单一：<br/>
👉 <strong>只关心“搜什么”与“怎么搜”</strong></p>
<hr/>
<h3 data-id="heading-4">3. 核心方法：searchUsers</h3>
<pre><code class="hljs language-bash" lang="bash">methods: {
  <span class="hljs-function"><span class="hljs-title">searchUsers</span></span>() {
    // 搜索前，通知列表进入 loading 状态
    this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
      isFirst: <span class="hljs-literal">false</span>,
      isLoading: <span class="hljs-literal">true</span>,
      errMsg: <span class="hljs-string">''</span>,
      <span class="hljs-built_in">users</span>: []
    })

    axios.get(`https://api.github.com/search/users?q=<span class="hljs-variable">${this.keyWord}</span>`).<span class="hljs-keyword">then</span>(
      response =&gt; {
        this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
          isLoading: <span class="hljs-literal">false</span>,
          <span class="hljs-built_in">users</span>: response.data.items
        })
      },
      error =&gt; {
        this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
          isLoading: <span class="hljs-literal">false</span>,
          errMsg: error.message,
          <span class="hljs-built_in">users</span>: []
        })
      }
    )
  }
}
</code></pre>
<p>这一段代码是整个项目的<strong>逻辑核心</strong>，可以总结为三步：</p>
<ol>
<li>
<p><strong>请求开始前</strong></p>
<ul>
<li>
<p>通知列表组件：</p>
<ul>
<li>不再是首次进入</li>
<li>正在加载中</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>请求成功</strong></p>
<ul>
<li>将 GitHub 返回的用户数据发送给列表组件</li>
</ul>
</li>
<li>
<p><strong>请求失败</strong></p>
<ul>
<li>将错误信息传递给列表组件展示</li>
</ul>
</li>
</ol>
<blockquote>
<p>注意：<br/>
搜索组件<strong>不直接修改列表组件的数据</strong>，而是通过事件总线“通知结果”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、MyList.vue：统一管理页面展示状态</h2>
<h3 data-id="heading-6">1. 状态集中管理</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">data()</span> {
  <span class="hljs-string">return</span> {
    <span class="hljs-attr">info:</span> {
      <span class="hljs-attr">isFirst:</span> <span class="hljs-literal">true</span>,
      <span class="hljs-attr">isLoading:</span> <span class="hljs-literal">false</span>,
      <span class="hljs-attr">errMsg:</span> <span class="hljs-string">''</span>,
      <span class="hljs-attr">users:</span> []
    }
  }
}
</code></pre>
<p>这里用一个 <code>info</code> 对象统一管理所有 UI 状态，非常关键：</p>
<ul>
<li>是否首次进入</li>
<li>是否正在加载</li>
<li>是否有错误</li>
<li>是否有数据</li>
</ul>
<p>👉 <strong>状态集中，模板判断才会清晰</strong></p>
<hr/>
<h3 data-id="heading-7">2. 模板中的条件渲染</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 用户列表 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>
  <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.users.length"</span>
  <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in info.users"</span>
  <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.login"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"user.html_url"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"user.avatar_url"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100px;"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text"</span>&gt;</span>{{ user.login }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.isFirst"</span>&gt;</span>欢迎！！！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.isLoading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.errMsg"</span>&gt;</span>{{ info.errMsg }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre>
<p>通过 <code>v-show</code> 控制不同状态下的界面展示：</p>
<ul>
<li>初始 → 欢迎提示</li>
<li>搜索中 → 加载中</li>
<li>成功 → 用户列表</li>
<li>失败 → 错误信息</li>
</ul>
<p>这正是<strong>真实业务中最常见的 UI 状态切换场景</strong>。</p>
<hr/>
<h3 data-id="heading-8">3. 接收搜索组件的数据（事件总线）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$bus</span>.$on(<span class="hljs-string">'getSearchData'</span>, <span class="hljs-function"><span class="hljs-params">datas</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span>, ...datas }
  })
}
</code></pre>
<p>这里的写法非常值得学习：</p>
<ul>
<li>使用展开运算符合并状态</li>
<li>只更新传过来的字段</li>
<li>保留原有未修改状态</li>
</ul>
<p>👉 这是一个<strong>低耦合、可维护性很强</strong>的写法。</p>
<hr/>
<h2 data-id="heading-9">四、为什么要用事件总线？</h2>
<p>在这个项目中：</p>
<ul>
<li><code>MySearch</code> 和 <code>MyList</code> 是<strong>兄弟组件</strong></li>
<li>它们之间没有直接的父子 props 关系</li>
</ul>
<p>使用事件总线的好处是：</p>
<ul>
<li>不需要层层传 props</li>
<li>组件之间完全解耦</li>
<li>非常适合小型项目和学习阶段</li>
</ul>
<p>虽然在大型项目中会使用 Vuex / Pinia，但在这里，<strong>事件总线是一个非常合适的选择</strong>。</p>
<hr/>
<h2 data-id="heading-10">五、总结</h2>
<p>通过这个 GitHub 用户搜索案例，我对 Vue 的理解不再停留在指令和语法层面，而是开始关注：</p>
<ul>
<li>组件应该如何拆分</li>
<li>数据应该由谁维护</li>
<li>不同状态下页面如何变化</li>
<li>组件之间如何通信才合理</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我是怎么把模型回复用tts播放的更自然的]]></title>    <link>https://juejin.cn/post/7586663700900921353</link>    <guid>https://juejin.cn/post/7586663700900921353</guid>    <pubDate>2025-12-23T07:50:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700900921353" data-draft-id="7586657335881596955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我是怎么把模型回复用tts播放的更自然的"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:50:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我是怎么把模型回复用tts播放的更自然的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:50:30.000Z" title="Tue Dec 23 2025 07:50:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景与痛点</h2>
<p>接 TTS（语音合成）服务的时候，经常碰到一个硬性限制：<strong>单次请求最多处理 50 个字符</strong>（或者是其他的长度限制）。</p>
<p>但现在的 AI 回复动不动就几百上千字，肯定得拆。</p>
<p>最开始的做法很简单粗暴：<strong>每 50 个字符切一刀，分批调接口。</strong></p>
<p>结果合成出来的语音听着像结巴：</p>
<blockquote>
<p>"今天我们去商场买了衣..." （停顿 1 秒）"...服，之后去吃了晚餐。"</p>
</blockquote>
<p>这就很难受了，"衣服"这个词被硬生生劈开，用户体验极差。</p>
<p>怎么解决？核心思路其实就一句话：<strong>让机器模拟人的自然换气。</strong></p>
<h2 data-id="heading-1">核心矛盾</h2>
<p>这其实是一个"规则冲突"问题：</p>
<ul>
<li><strong>TTS 的规则</strong>：长度必须 &lt; 50。</li>
<li><strong>语言的规则</strong>：停顿必须在"语义边界"（标点、词组空隙）。</li>
</ul>
<p>我们的目标是：<strong>在满足 TTS 硬性限制的前提下，尽量贴合语言的自然停顿。</strong></p>
<h2 data-id="heading-2">优化策略</h2>
<p>我们验证下来，这三个策略组合使用效果最好：</p>
<h3 data-id="heading-3">1. 标点边界优先（Priority Split）</h3>
<p>思路：<strong>宁可少切，不能乱切。</strong></p>
<p>只要没超长，就一直往后找，直到遇到句号、逗号、问号这些<strong>天然停顿点</strong>再切。</p>
<p>比如这段话：</p>
<blockquote>
<p>"今天天气很好，我们决定去公园散步，顺便买点水果回来。"</p>
</blockquote>
<ul>
<li><strong>硬切模式</strong>：切在"水果"中间。</li>
<li><strong>标点优先模式</strong>：
<pre><code class="hljs language-text" lang="text">片段1: "今天天气很好，我们决定去公园散步，" (20字符)
片段2: "顺便买点水果回来。" (10字符)
</code></pre>
</li>
</ul>
<p>虽然每个片段都远没到 50 字符，但保证了语义完整。</p>
<h3 data-id="heading-4">2. 缓冲回退（Buffer Backtrack）</h3>
<p>如果一句话特别长，中间完全没有标点，或者标点在 50 字符之外，怎么办？</p>
<p><strong>不要在第 50 个字符硬切，而是往回退。</strong></p>
<p>比如累积到 50 字了，发现卡在单词中间。这时候往回退 5-10 个字符，看看有没有空格、逗号或者其他稍微适合停顿的地方。</p>
<p>流程如下：</p>
<pre><code class="hljs language-text" lang="text">累积到上限 → 能切吗？(是标点/空格)
                  ↓
       不能 → 往回倒车 10 步 → 找到标点了吗？
                  ↓                  ↓
              没找到 (认命硬切)     找到了 (切分)
</code></pre>
<h3 data-id="heading-5">3. 短片段合并（Merge Short）</h3>
<p>切分过细会带来另一个问题：<strong>请求太碎，网络开销大，且声音断断续续。</strong></p>
<p>比如切成了：<code>"好的。"</code>、<code>"没问题。"</code>。
这两个完全可以合并成 <code>"好的。没问题。"</code> 一起发过去，只要合并后不超过 50 字符。</p>
<h2 data-id="heading-6">方案实现</h2>
<h3 data-id="heading-7">处理流程图</h3>
<p>这个逻辑用状态图描述最清晰：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[输入长文本] --&gt; B[逐字符累积]
    B --&gt; C{快到限制了?}
    C --&gt;|否| B
    C --&gt;|是| D[回退搜索标点]
    D --&gt; E{缓冲区内找到标点?}
    E --&gt;|是| F[在标点处切分]
    E --&gt;|否| G[没办法，强制切分]
    F --&gt; H[保存片段]
    G --&gt; H
    H --&gt; I{还有剩余文本?}
    I --&gt;|是| B
    I --&gt;|否| J[合并过短片段]
    J --&gt; K[输出最终列表]

    classDef process fill:#cce5ff,stroke:#0d6efd,color:#004085
    classDef decision fill:#fff3cd,stroke:#ffc107,color:#856404
    classDef endpoint fill:#d4edda,stroke:#28a745,color:#155724

    class A,K endpoint
    class C,E,I decision
    class B,D,F,G,H,J process
</code></pre>
<h3 data-id="heading-8">关键代码 (Python)</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_for_tts</span>(<span class="hljs-params">text, max_len=<span class="hljs-number">50</span>, buffer_size=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""
    智能切分文本，优先保持语义完整
    """</span>
    <span class="hljs-comment"># 定义标点优先级：句子结束符 &gt; 短句分隔符</span>
    <span class="hljs-comment"># 实际场景中可以配置权重</span>
    stops = <span class="hljs-built_in">set</span>(<span class="hljs-string">'。，！？；：、.!?,;:'</span>)
    
    segments = []
    current_idx = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">while</span> current_idx &lt; <span class="hljs-built_in">len</span>(text):
        <span class="hljs-comment"># 剩余部分直接打包</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(text) - current_idx &lt;= max_len:
            segments.append(text[current_idx:])
            <span class="hljs-keyword">break</span>
            
        <span class="hljs-comment"># 预设切分点为最大长度处</span>
        cut_pos = current_idx + max_len
        found_stop = <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># 1. 策略：缓冲回退</span>
        <span class="hljs-comment"># 从 max_len 处往回找 buffer_size 个字符</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cut_pos, cut_pos - buffer_size, -<span class="hljs-number">1</span>):
            <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(text) <span class="hljs-keyword">and</span> text[i] <span class="hljs-keyword">in</span> stops:
                cut_pos = i + <span class="hljs-number">1</span> <span class="hljs-comment"># 包含标点</span>
                found_stop = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">break</span>
        
        <span class="hljs-comment"># 2. 策略：兜底</span>
        <span class="hljs-comment"># 如果缓冲区没找到标点，就只能硬切了</span>
        <span class="hljs-comment"># (实际生产中这里可以再优化，比如尝试找空格)</span>
        
        segments.append(text[current_idx:cut_pos])
        current_idx = cut_pos

    <span class="hljs-keyword">return</span> merge_short_segments(segments, max_len)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_short_segments</span>(<span class="hljs-params">segments, max_len, min_len=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""
    合并碎片段，减少请求次数
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> segments: <span class="hljs-keyword">return</span> []
    
    merged = [segments[<span class="hljs-number">0</span>]]
    <span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> segments[<span class="hljs-number">1</span>:]:
        last = merged[-<span class="hljs-number">1</span>]
        <span class="hljs-comment"># 如果合并后不超长，且前一个太短，就合并</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(last) + <span class="hljs-built_in">len</span>(seg) &lt;= max_len <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(last) &lt; min_len:
            merged[-<span class="hljs-number">1</span>] += seg
        <span class="hljs-keyword">else</span>:
            merged.append(seg)
            
    <span class="hljs-keyword">return</span> merged
</code></pre>
<h2 data-id="heading-9">避坑指南</h2>
<p>在实际上线过程中，还踩过几个坑，提个醒：</p>
<ol>
<li><strong>保护语义实体</strong>：虽然发给 TTS 的通常是清洗后的纯文本，但文本里常有<strong>金额</strong>（<code>1,000</code>）、<strong>书名号</strong>（<code>《...》</code>）或<strong>特定短语</strong>。如果你在逗号处把 <code>1,000</code> 切开了，TTS 可能会把 <code>1,</code> 读成"一，"，剩下的 <code>000</code> 读成"零零零"。建议对这类实体做正则识别，确保它们完整地留在同一个片段里。</li>
<li><strong>英文单词边界</strong>：中文按字算，英文按词算。切分的时候一定要判断 <code>text[cut_pos]</code> 是不是字母，如果是，千万别切，继续往回退找空格。</li>
<li><strong>表情包过滤</strong>：很多 TTS 模型不支持 emoji，直接把 <code>😂</code> 这种符号喂进去可能会报错或者读出乱码，建议预处理直接干掉。</li>
</ol>
<h2 data-id="heading-10">总结</h2>
<p>TTS 优化的本质不是算法问题，而是<strong>体验问题</strong>。</p>
<p>不需要多高深的 NLP 模型，只需要几行简单的规则代码：<strong>多找标点，少硬切，适度合并</strong>。就能把"机器味"去掉一大半。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》]]></title>    <link>https://juejin.cn/post/7586861592710004772</link>    <guid>https://juejin.cn/post/7586861592710004772</guid>    <pubDate>2025-12-23T07:27:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586861592710004772" data-draft-id="7586684925106044971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》"/> <meta itemprop="keywords" content="前端,全栈,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:27:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZsTs119"/> <meta itemprop="url" content="https://juejin.cn/user/3725615485435022"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3725615485435022/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZsTs119
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:27:12.000Z" title="Tue Dec 23 2025 07:27:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>还在为了在电脑上操控手机去翻遍碎片的教程？Android 连不上、iOS 搞不定、命令行太枯燥？</p>
<p>刷短视频、发微信、甚至抢票，能不能让 AI 替我操作手机？AutoGLM 虽然强大，但环境搭建总是卡在 “ADB 连不上” 或 “WDA 签名失败”？</p>
<p>本文是目前市面上最全的 <strong>AutoGLM 终极全能手册</strong>。我们不谈虚的理论，直接深度集成 <strong>iOS/Android 双端适配</strong>、<strong>Windows/macOS/Linux 三系统支持</strong>以及 <strong>GUI 可视化操作界面</strong>。不仅提供完整的下载链接，更包含从底层驱动到高层 AI 逻辑的保姆级实战拆解。</p>
</blockquote>
<h2 data-id="heading-1">开始</h2>
<p>本手册围绕以下 7 个核心模块展开，带你一站式打通 AI 手机自动化：</p>





















































<table><thead><tr><th><strong>序号</strong></th><th><strong>模块名称</strong></th><th><strong>模块核心内容</strong></th><th><strong>你能获得的核心价值</strong></th></tr></thead><tbody><tr><td>1</td><td><strong>全平台环境地基</strong></td><td>Python、Git 环境配置与三端路径挂载</td><td>确保所有工具在各系统下运行逻辑一致</td></tr><tr><td>2</td><td><strong>Android 驱动：ADB 深度配置</strong></td><td>SDK 下载、Path 配置、<strong>Linux 权限一键通</strong></td><td>打通 Android 端的指令传输链路</td></tr><tr><td>3</td><td><strong>iOS 驱动：WDA 与 Tidevice</strong></td><td><strong>Windows 签名 WDA</strong>、Tidevice 部署、跨端连接</td><td>突破苹果生态限制，实现 iOS 自动化</td></tr><tr><td>4</td><td><strong>AutoGLM 核心安装</strong></td><td>源码部署、依赖库安装、<strong>输入法优化</strong></td><td>部署 AI 智能体的核心算法与逻辑</td></tr><tr><td>5</td><td><strong>GUI 可视化界面部署</strong></td><td>GUI 安装、<strong>内核路径关联</strong>、Web 控制台配置</td><td>告别黑窗口，实现直观的图形化操控</td></tr><tr><td>6</td><td><strong>API 服务接入与测试</strong></td><td>智谱 AI 密钥配置、模型访问权限获取</td><td>为系统接入大模型“大脑”</td></tr><tr><td>7</td><td><strong>全场景实战与避坑</strong></td><td>双端微信实测、<strong>404/连接错误终极排查</strong></td><td>验证完整链路，提供企业级排查手册</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">（一）全平台环境地基</h2>
<blockquote>
<p><strong>顶层结论</strong>：统一开发环境是跨平台操作的前提。建议务必统一 Python 版本到 <strong>3.8 - 3.12</strong>，并确保环境变量配置正确，否则后续 GUI 关联内核时会频繁报错。</p>
</blockquote>
<h3 data-id="heading-3">1. 软件下载与验证</h3>
<ul>
<li>
<p><strong>Python (3.8 - 3.12)</strong> :</p>
<ul>
<li><strong>下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdownloads%2F" target="_blank" title="https://www.python.org/downloads/" ref="nofollow noopener noreferrer">python.org/downloads</a></li>
<li><strong>Windows</strong>: 安装时必须勾选 <code>Add Python to PATH</code>。</li>
<li><strong>macOS/Linux</strong>: <code>brew install python</code> 或 <code>sudo apt install python3</code>。</li>
</ul>
</li>
<li>
<p><strong>Git</strong>:</p>
<ul>
<li><strong>下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3Dhttps%3A%2F%2Fgit-scm.com%2Fdownloads" target="_blank" title="https://www.google.com/search?q=https://git-scm.com/downloads" ref="nofollow noopener noreferrer">git-scm.com</a></li>
<li><strong>验证</strong>: 终端输入 <code>git --version</code> 确认。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">（二）Android 驱动：ADB 深度配置</h2>
<blockquote>
<p><strong>顶层结论</strong>：ADB (Android Debug Bridge) 是 Android 端的命脉。不仅要配好 Path 路径，针对 Linux 用户和小米手机用户，还有特定的“权限门槛”需要跨越。</p>
</blockquote>
<h3 data-id="heading-5">1. 下载与环境变量</h3>
<ul>
<li>
<p><strong>官方 SDK Platform-Tools 下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Freleases%2Fplatform-tools" target="_blank" title="https://developer.android.com/studio/releases/platform-tools" ref="nofollow noopener noreferrer">Android 官方开发者工具</a></p>
</li>
<li>
<p><strong>Windows 配置</strong>:</p>
<ol>
<li>解压至 <code>C:\platform-tools</code>。</li>
<li>环境变量 -&gt; 系统变量 <code>Path</code> -&gt; 新建 <code>C:\platform-tools</code>。</li>
</ol>
</li>
<li>
<p><strong>macOS / Linux 安装</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">brew install --cask android-platform-tools  <span class="hljs-comment"># Mac</span>
sudo apt install android-tools-adb           <span class="hljs-comment"># Linux (Ubuntu)</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-6">2. Linux 权限一键通</h3>
<p>如果你是 Linux 用户，遇到 <code>adb devices</code> 显示 <code>no permissions</code>，请执行：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 自动生成 udev 规则</span>
echo '<span class="hljs-attr">SUBSYSTEM</span>==<span class="hljs-string">"usb"</span>, ATTR{idVendor}==<span class="hljs-string">"2836"</span>, MODE=<span class="hljs-string">"0666"</span>, GROUP=<span class="hljs-string">"plugdev"</span><span class="hljs-string">' | sudo tee /etc/udev/rules.d/51-android.rules
sudo udevadm control --reload-rules
sudo service udev restart
</span></code></pre>
<h3 data-id="heading-7">3. 小米设备（Android）调试必开项</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2b8e66fddd14db29276363c64d2062f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=rAeZDqh2khnYu14biLi3H1Jd2WM%3D" alt="screenshot-20251209-181423.png" loading="lazy"/></p>
<p>在“开发者选项”中，这三项<strong>缺一不可</strong>：</p>
<ul>
<li>✅ <strong>USB 调试</strong></li>
<li>✅ <strong>USB 调试（安全设置）</strong> ：不开启此项 AI 无法模拟点击！</li>
<li>✅ <strong>允许通过 USB 安装应用</strong>
这是手册的第二部分，重点攻克 <strong>iOS 的驱动签名难题</strong> 以及 <strong>AutoGLM 核心引擎的安装</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-8">（三）iOS 驱动：WDA 与 Tidevice 深度配置</h2>
<blockquote>
<p><strong>顶层结论</strong>：iOS 自动化的核心在于 WebDriverAgent (WDA)。虽然苹果生态闭源，但通过 PR 156 引入的 <code>tidevice</code>，我们可以在 Windows/Linux 上绕过 Xcode 操控 iPhone，关键在于 <strong>“如何正确给 WDA 签名”</strong> 。</p>
</blockquote>
<h3 data-id="heading-9">1. 核心工具下载</h3>
<ul>
<li>
<p><strong>Tidevice (PC端驱动)</strong> : 用于跨平台启动 iOS 自动化。</p>
<pre><code class="hljs">pip install tidevice
</code></pre>
</li>
<li>
<p><strong>Sideloadly (Windows 签名工具)</strong> : <a href="https://link.juejin.cn?target=https%3A%2F%2Fsideloadly.io%2F" target="_blank" title="https://sideloadly.io/" ref="nofollow noopener noreferrer">下载地址</a></p>
</li>
<li>
<p><strong>WebDriverAgent.ipa</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3Dhttps%3A%2F%2Fgithub.com%2Fappium%2FWebDriverAgent%2Freleases" target="_blank" title="https://www.google.com/search?q=https://github.com/appium/WebDriverAgent/releases" ref="nofollow noopener noreferrer">官方编译包下载</a></p>
</li>
</ul>
<h3 data-id="heading-10">2. Windows 用户无 Mac 签名攻略</h3>
<ol>
<li>
<p><strong>准备 IPA</strong>: 下载上述 <code>WebDriverAgent.ipa</code>。</p>
</li>
<li>
<p><strong>连接设备</strong>: 用数据线连接 iPhone，打开 Sideloadly。</p>
</li>
<li>
<p><strong>配置签名</strong>:</p>
<ul>
<li>在 <code>iDevice</code> 处确认识别到你的 iPhone。</li>
<li>在 <code>Apple account</code> 处输入你的 Apple ID。</li>
<li>将下载好的 <code>IPA</code> 文件拖入 Sideloadly 左侧框。</li>
</ul>
</li>
<li>
<p><strong>开始安装</strong>: 点击 <code>Start</code>。安装成功后，iPhone 桌面会出现 <code>WebDriverAgent</code> 图标。</p>
</li>
<li>
<p><strong>手机授权</strong>:</p>
<ul>
<li>进入：<code>设置 -&gt; 通用 -&gt; 描述文件与设备管理</code>。</li>
<li>找到你的 Apple ID 证书，点击 <strong>“信任”</strong> 。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">3. 映射与启动</h3>
<p>在终端执行以下命令，启动 iOS 端的服务映射：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 启动 WDA 服务</span>
<span class="hljs-string">tidevice</span> <span class="hljs-string">xctest</span> <span class="hljs-string">-B</span> <span class="hljs-string">com.facebook.WebDriverAgentRunner.xctrunner</span>

<span class="hljs-comment"># 2. 另开一个窗口进行端口转发 (默认端口 8100)</span>
<span class="hljs-string">tidevice</span> <span class="hljs-string">relay</span> <span class="hljs-number">8100 </span><span class="hljs-number">8100</span>
</code></pre>
<p><strong>验证</strong>: 访问 <code>http://localhost:8100/status</code>，若看到 JSON 格式的返回信息，说明 iOS 驱动已完全打通。</p>
<hr/>
<h2 data-id="heading-12">（四）AutoGLM 核心引擎安装</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee9358b92acb4a1889cddecacdd11399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=HAS7VxXWMR5jLrXLfD5GdyxR3D0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>顶层结论</strong>：核心引擎（Open-AutoGLM）是处理 AI 逻辑的“大脑”。安装时除了基础依赖，最容易被忽视的是 <strong>“输入法插件”</strong> ，不安装它，AI 无法在搜索框正确键入中文。</p>
</blockquote>
<h3 data-id="heading-13">1. 源码部署与依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆主仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/Open-AutoGLM.git
<span class="hljs-built_in">cd</span> Open-AutoGLM

<span class="hljs-comment"># 2. 安装依赖库</span>
pip install -r requirements.txt

<span class="hljs-comment"># 3. 以可编辑模式安装当前包</span>
pip install -e .
</code></pre>
<h3 data-id="heading-14">2. ADB Keyboard 安装（仅 Android）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d0ee535012342ef905be344e39d18da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=YARTkBks%2BZzAkJmdYF6aADaVm30%3D" alt="image.png" loading="lazy"/></p>
<p>AI 操作时，手机原生输入法经常会弹出“候选词”遮挡屏幕。安装 ADB Keyboard 可以实现后台静默输入。</p>
<ul>
<li>
<p><strong>APK 下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsenzhk%2FADBKeyBoard%2Fraw%2Fmaster%2FADBKeyboard.apk" target="_blank" title="https://github.com/senzhk/ADBKeyBoard/raw/master/ADBKeyboard.apk" ref="nofollow noopener noreferrer">ADBKeyboard 下载链接</a></p>
</li>
<li>
<p><strong>安装命令</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保手机已连上电脑</span>
adb install ADBKeyboard.apk
</code></pre>
</li>
<li>
<p><strong>激活设置</strong>:</p>
<ul>
<li>手机设置 -&gt; 语言和输入法 -&gt; 管理键盘。</li>
<li>开启 <strong>ADB Keyboard</strong>，并将其设为当前默认输入法。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">3. 环境变量预设</h3>
<p>为了让 GUI 能顺利调用核心代码，建议将项目路径写入系统环境变量。</p>
<ul>
<li>
<p><strong>Windows (PowerShell)</strong> :</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Environment]</span>::<span class="hljs-built_in">SetEnvironmentVariable</span>(<span class="hljs-string">"AUTOGLM_CORE_PATH"</span>, <span class="hljs-string">"C:\AutoGLM\Open-AutoGLM"</span>, <span class="hljs-string">"User"</span>)
</code></pre>
</li>
<li>
<p><strong>Mac/Linux (bash/zsh)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export AUTOGLM_CORE_PATH="/your/path/Open-AutoGLM"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
</li>
</ul>
<p>这是手册的最后一部分，我们将打通 <strong>GUI 可视化操作界面</strong>，接入 <strong>AI 核心服务</strong>，并提供全平台的<strong>避坑排查手册</strong>。</p>
<hr/>
<h2 data-id="heading-16">（五）GUI 可视化界面部署</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77a62e17169545fd9196e91b08f55243~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=iCdcbRrECFMILgRzY7e8AO8OyQg%3D" alt="524711939-b8cb6fbc-ca5b-452c-bcf4-7d5863d4577a.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5929a82165064585ab8b679db2373720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=UxmskvJ9Vrah99GF7NgyclfTsQo%3D" alt="524712065-b32f2e46-5340-42f5-a0db-0033729e1605.png" loading="lazy"/></p>
<blockquote>
<p><strong>顶层结论</strong>：<code>AutoGLM-GUI</code> 提供了基于 Web 的直观控制台，不仅能实时投屏预览，还能记录 AI 的思考逻辑。关键点在于将 GUI 程序与前文安装的 <code>Open-AutoGLM</code> 内核进行路径关联。</p>
</blockquote>
<h3 data-id="heading-17">1. GUI 安装与路径关联</h3>
<p>建议从源码安装以方便后续调整配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆 GUI 仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/suyiiyii/AutoGLM-GUI.git
<span class="hljs-built_in">cd</span> AutoGLM-GUI

<span class="hljs-comment"># 2. 安装界面依赖</span>
pip install -r requirements.txt
pip install -e .
</code></pre>
<h3 data-id="heading-18">2.内核路径配置文件</h3>
<p>如果 GUI 启动后提示“找不到内核”，请在 <code>AutoGLM-GUI</code> 根目录下手动创建或修改 <code>config.json</code>（或 <code>.env</code>）文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"base_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://open.bigmodel.cn/api/paas/v4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"autoglm-phone"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"core"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:/AutoGLM/Open-AutoGLM"</span>  <span class="hljs-comment">// 此处指向你模块（四）的安装路径</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8080</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">3. 启动控制台</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 执行启动命令</span>
<span class="hljs-string">autoglm-gui</span> <span class="hljs-string">--port</span> <span class="hljs-number">8080</span>
</code></pre>
<p>启动成功后，浏览器会自动打开 <code>http://localhost:8080</code>。你将看到集成的设备画面预览、实时日志输出以及任务输入框。</p>
<hr/>
<h2 data-id="heading-20">（六）API 服务接入：注入 AI 大脑</h2>
<blockquote>
<p><strong>顶层结论</strong>：AutoGLM 的操作逻辑由云端大模型驱动。目前最成熟的方案是使用智谱 AI 的 <code>autoglm-phone</code> 模型。</p>
</blockquote>
<h3 data-id="heading-21">1. 密钥申请步骤</h3>
<ol>
<li><strong>注册账号</strong>：访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2F" target="_blank" title="https://open.bigmodel.cn/" ref="nofollow noopener noreferrer">智谱 AI 开放平台</a>。</li>
<li><strong>获取 API Key</strong>：在控制台左侧“API Keys”页面点击创建。</li>
<li><strong>模型权限</strong>：确保账户余额充足（新手通常有免费额度）并拥有 <code>autoglm-phone</code> 访问权限。</li>
</ol>
<h3 data-id="heading-22">2. 环境变量一键配置</h3>
<p>为了避免每次运行都输入长字符串，建议配置全局环境变量：</p>
<ul>
<li><strong>Windows (PowerShell)</strong> : <code>$env:AUTOGLM_API_KEY="你的密钥"</code></li>
<li><strong>Mac/Linux (Terminal)</strong> : <code>export AUTOGLM_API_KEY="你的密钥"</code></li>
</ul>
<hr/>
<h2 data-id="heading-23">（七）全场景实战与终极避坑</h2>
<blockquote>
<p><strong>顶层结论</strong>：实战是检验配置的唯一标准。本模块提供双端测试命令及针对“三合一”集成后最常见问题的解决方案。</p>
</blockquote>
<h3 data-id="heading-24">1. 命令行测试（全平台命令对比）</h3>





















<table><thead><tr><th><strong>系统</strong></th><th><strong>运行命令示例</strong></th></tr></thead><tbody><tr><td><strong>Windows (PS)</strong></td><td><code>python main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr><tr><td><strong>macOS (Zsh)</strong></td><td><code>python3 main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr><tr><td><strong>Linux (Bash)</strong></td><td><code>python3 main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr></tbody></table>
<h3 data-id="heading-25">2. 终极报错排查手册</h3>



































<table><thead><tr><th><strong>错误代码 / 现象</strong></th><th><strong>可能原因</strong></th><th><strong>终极解决方案</strong></th></tr></thead><tbody><tr><td><strong>404 Not Found</strong></td><td>API URL 错误或模型名拼错</td><td>检查 base-url 结尾是否包含 <code>/v4</code>，确保 model 准确为 <code>autoglm-phone</code>。</td></tr><tr><td><strong>ADB Offline / Unauthorized</strong></td><td>手机端授权过期</td><td>拔插数据线，点击手机弹窗中的“始终允许此电脑调试”。</td></tr><tr><td><strong>GUI 启动提示端口占用</strong></td><td>8080 端口被其他服务占用</td><td>使用 <code>autoglm-gui --port 8081</code> 切换到空闲端口。</td></tr><tr><td><strong>iOS WDA 无法连接</strong></td><td>签名证书过期或端口未转发</td><td>重新运行 <code>tidevice relay 8100 8100</code> 确保通道畅通。</td></tr><tr><td><strong>Android 无法模拟点击</strong></td><td>小米手机“安全设置”未开</td><td>检查开发者选项，必须开启“USB 调试（安全设置）”。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-26">最后</h2>
<blockquote>
<p>恭喜你！通过这篇“三合一”全能手册，你已经打通了从底层硬件驱动（ADB/WDA）到高层 AI 可视化操控（GUI）的完整链路。AutoGLM 已经可以在你的指令下，在 Windows、Mac、Linux 三大系统上自如操控 iOS 与 Android 设备。</p>
</blockquote>
<blockquote>
<p><strong>如果你在安装过程中遇到任何奇怪的报错，欢迎在评论区贴出你的 Traceback 日志，我会第一时间为你诊断！</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-27">更多</h2>
<p>💻 Vue3 多端统一开发框架：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZsTs119%2Fvue3-multi-platform" target="_blank" title="https://github.com/ZsTs119/vue3-multi-platform" ref="nofollow noopener noreferrer">vue3-multi-platform</a></p>
<p>📊 HuggingFaceAI 论文智能分析系统：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZsTs119%2Fai-paper-analyzer" target="_blank" title="https://github.com/ZsTs119/ai-paper-analyzer" ref="nofollow noopener noreferrer">ai-paper-analyzer</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据可视化大屏模板：前端开发的效率革命与架构艺术]]></title>    <link>https://juejin.cn/post/7586889698241445951</link>    <guid>https://juejin.cn/post/7586889698241445951</guid>    <pubDate>2025-12-23T07:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586889698241445951" data-draft-id="7586902693856542762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据可视化大屏模板：前端开发的效率革命与架构艺术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_chiu"/> <meta itemprop="url" content="https://juejin.cn/user/1644525124592974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据可视化大屏模板：前端开发的效率革命与架构艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525124592974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_chiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:47:31.000Z" title="Tue Dec 23 2025 07:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深夜，资深前端工程师李峰面对第7个类似的可视化大屏需求陷入了沉思——同样的ECharts配置，同样的布局调整，同样繁琐的数据对接。而隔壁组的新人王明却已经通过一套模板系统，在3小时内交付了一个省级智慧城市的数据大屏。</p>
</blockquote>
<p>在2024年Stack Overflow开发者调查中，<strong>76%的前端开发者</strong>表示曾参与过数据可视化项目，而其中<strong>超过60%</strong> 抱怨“重复开发类似界面”是最大的痛点。与此同时，GitHub上标有“dashboard-template”的仓库星标数在过去一年增长了217%，揭示了模板化开发正在成为前端可视化领域的新趋势。</p>
<h2 data-id="heading-0">01 为何需要大屏模板：从重复劳动到高效开发</h2>
<p>每个前端开发者都经历过这样的场景：接到一个新的数据可视化需求，打开上次项目的代码，开始“借鉴”图表配置、布局CSS和数据处理逻辑。这种模式存在几个根本问题：</p>
<p><strong>技术债务累积</strong>：每次“复制-修改”都会带入特定业务的耦合代码，随着时间推移，项目变得难以维护。</p>
<p><strong>设计不一致</strong>：不同开发者甚至同一开发者在不同时间创建的可视化组件，在交互逻辑、颜色主题和响应方式上存在差异。</p>
<p><strong>开发效率低下</strong>：据统计，一个中等复杂度的数据大屏（包含10-15个图表组件）从零开发平均需要80-120小时，而基于高质量模板可将时间缩短至20-30小时。</p>
<p>模板化开发的本质是将通用解决方案产品化。一个好的大屏模板不仅是UI组件的集合，更是一套包含<strong>数据流管理、主题配置、响应式规则和性能优化</strong>的完整架构。</p>
<h2 data-id="heading-1">02 主流大屏模板架构解析</h2>
<p>现代数据可视化大屏模板通常采用分层架构设计，以下是一个典型的技术栈构成：</p>
<p><strong>可视化层</strong>：基于ECharts、AntV或D3.js的图表组件库，提供柱状图、折线图、饼图、地图等基础可视化元素。</p>
<p><strong>布局层</strong>：采用网格布局系统（如Grid Layout）或自由布局引擎，支持拖拽调整和响应式适配。</p>
<p><strong>数据层</strong>：统一的数据获取、转换和状态管理机制，常基于Redux、Mobx或Vuex实现。</p>
<p><strong>主题层</strong>：可配置的颜色、字体、间距系统，支持亮色/暗色模式切换。</p>
<p><strong>工具层</strong>：包含开发调试工具、性能监控和构建配置。</p>
<p>以阿里DataV为例，其模板系统采用了基于JSON Schema的配置驱动架构：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化的模板配置示例</span>
{
  <span class="hljs-string">"templateMeta"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"智慧城市监控模板"</span>,
    <span class="hljs-string">"version"</span>: <span class="hljs-string">"2.1.0"</span>,
    <span class="hljs-string">"author"</span>: <span class="hljs-string">"DataV Team"</span>
  },
  <span class="hljs-string">"layout"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"responsive-grid"</span>,
    <span class="hljs-string">"breakpoints"</span>: [<span class="hljs-number">1920</span>, <span class="hljs-number">1440</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>],
    <span class="hljs-string">"columns"</span>: <span class="hljs-number">24</span>
  },
  <span class="hljs-string">"widgets"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"real-time-flow"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"echarts-line"</span>,
      <span class="hljs-string">"position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"w"</span>: <span class="hljs-number">8</span>, <span class="hljs-string">"h"</span>: <span class="hljs-number">6</span> },
      <span class="hljs-string">"dataConfig"</span>: {
        <span class="hljs-string">"source"</span>: <span class="hljs-string">"api://realtime/flow"</span>,
        <span class="hljs-string">"refreshInterval"</span>: <span class="hljs-number">5000</span>
      },
      <span class="hljs-string">"styleConfig"</span>: {
        <span class="hljs-string">"theme"</span>: <span class="hljs-string">"auto"</span>,
        <span class="hljs-string">"colors"</span>: [<span class="hljs-string">"#5470c6"</span>, <span class="hljs-string">"#91cc75"</span>]
      }
    }
  ],
  <span class="hljs-string">"dataSources"</span>: {
    <span class="hljs-string">"defaultAdapter"</span>: <span class="hljs-string">"axios"</span>,
    <span class="hljs-string">"interceptors"</span>: [<span class="hljs-string">"auth"</span>, <span class="hljs-string">"error-handler"</span>]
  }
}
</code></pre>
<p>这种配置驱动的设计使得非技术人员也能通过修改JSON配置来调整大屏布局和内容，大幅降低了使用门槛。</p>
<h2 data-id="heading-2">03 实战：基于Vue3+ECharts的模块化大屏模板</h2>
<p>下面我们以Vue3技术栈为例，构建一个企业级大屏模板的核心部分：</p>
<h3 data-id="heading-3">可复用的图表组件设计</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- BaseChart.vue - 基础图表组件 --&gt;
&lt;template&gt;
  &lt;div class="chart-container" :style="containerStyle"&gt;
    &lt;div v-if="loading" class="chart-loading"&gt;
      &lt;LoadingSpinner /&gt;
    &lt;/div&gt;
    &lt;div v-else-if="error" class="chart-error"&gt;
      &lt;ErrorDisplay :message="error.message" /&gt;
    &lt;/div&gt;
    &lt;div v-else ref="chartEl" class="chart-canvas"&gt;&lt;/div&gt;
    
    &lt;!-- 工具栏 --&gt;
    &lt;ChartToolbar 
      v-if="showToolbar"
      @download="handleDownload"
      @fullscreen="handleFullscreen"
      @refresh="handleRefresh"
    /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted, onUnmounted, watch } from 'vue'
import * as echarts from 'echarts'
import { useResizeObserver } from '@vueuse/core'
import { debounce } from 'lodash-es'

const props = defineProps({
  options: { type: Object, required: true },
  autoResize: { type: Boolean, default: true },
  theme: { type: String, default: 'light' },
  loading: { type: Boolean, default: false },
  error: { type: Object, default: null }
})

const chartEl = ref(null)
let chartInstance = null

// 初始化图表
const initChart = () =&gt; {
  if (!chartEl.value) return
  
  chartInstance = echarts.init(chartEl.value, props.theme)
  chartInstance.setOption(props.options)
  
  // 添加响应式支持
  if (props.autoResize) {
    const { stop } = useResizeObserver(chartEl, debounce(() =&gt; {
      chartInstance?.resize()
    }, 300))
    
    onUnmounted(stop)
  }
}

// 监听选项变化
watch(() =&gt; props.options, (newOptions) =&gt; {
  if (chartInstance) {
    chartInstance.setOption(newOptions, true)
  }
}, { deep: true })

onMounted(initChart)
onUnmounted(() =&gt; {
  chartInstance?.dispose()
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">数据源抽象层</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// datasource/adapters/index.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscribers</span> = []
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateCacheKey</span>(dataConfig)
    
    <span class="hljs-comment">// 检查缓存</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(cacheKey) &amp;&amp; !dataConfig.<span class="hljs-property">forceUpdate</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(cacheKey)
    }
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeFetch</span>(dataConfig)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(cacheKey, data)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifySubscribers</span>(dataConfig, data)
      <span class="hljs-keyword">return</span> data
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleError</span>(error, dataConfig)
      <span class="hljs-keyword">throw</span> error
    }
  }
  
  <span class="hljs-comment">// 抽象方法，由具体适配器实现</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeFetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'executeFetch must be implemented'</span>)
  }
}

<span class="hljs-comment">// API数据源适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DataSourceAdapter</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeFetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, params, headers } = dataConfig
    
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
      method,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        ...headers
      },
      <span class="hljs-attr">body</span>: method !== <span class="hljs-string">'GET'</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params) : <span class="hljs-literal">undefined</span>
    })
    
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>: <span class="hljs-subst">${response.statusText}</span>`</span>)
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  }
}

<span class="hljs-comment">// WebSocket实时数据适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DataSourceAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">super</span>(config)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> = <span class="hljs-number">0</span>
  }
  
  <span class="hljs-title function_">connect</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>) <span class="hljs-keyword">return</span>
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(dataConfig.<span class="hljs-property">url</span>)
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifySubscribers</span>(dataConfig, data)
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleReconnection</span>(dataConfig)
    }
  }
}
</code></pre>
<h3 data-id="heading-5">布局管理系统</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// layout/LayoutEngine.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LayoutEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container, config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">widgets</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoints</span> = [<span class="hljs-number">1920</span>, <span class="hljs-number">1440</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>, <span class="hljs-number">480</span>]
  }
  
  <span class="hljs-comment">// 响应式布局计算</span>
  <span class="hljs-title function_">calculateLayout</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> width = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">clientWidth</span>
    <span class="hljs-keyword">const</span> currentBreakpoint = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCurrentBreakpoint</span>(width)
    
    <span class="hljs-comment">// 基于断点的布局规则</span>
    <span class="hljs-keyword">const</span> layoutRules = {
      <span class="hljs-number">1920</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">24</span> },
      <span class="hljs-number">1440</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">20</span> },
      <span class="hljs-number">1024</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">16</span> },
      <span class="hljs-number">768</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">12</span> },
      <span class="hljs-number">480</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">8</span> }
    }
    
    <span class="hljs-keyword">return</span> layoutRules[currentBreakpoint]
  }
  
  <span class="hljs-comment">// 网格位置计算</span>
  <span class="hljs-title function_">computeWidgetPosition</span>(<span class="hljs-params">widgetConfig</span>) {
    <span class="hljs-keyword">const</span> layout = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateLayout</span>()
    <span class="hljs-keyword">const</span> { x, y, w, h } = widgetConfig.<span class="hljs-property">position</span>
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">left</span>: (x / layout.<span class="hljs-property">columns</span>) * <span class="hljs-number">100</span> + <span class="hljs-string">'%'</span>,
      <span class="hljs-attr">top</span>: (y * (layout.<span class="hljs-property">rowHeight</span> || <span class="hljs-number">50</span>)) + <span class="hljs-string">'px'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-string">`calc(<span class="hljs-subst">${(w / layout.columns) * <span class="hljs-number">100</span>}</span>% - <span class="hljs-subst">${layout.gutter}</span>px)`</span>,
      <span class="hljs-attr">height</span>: (h * (layout.<span class="hljs-property">rowHeight</span> || <span class="hljs-number">50</span>)) + <span class="hljs-string">'px'</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-6">04 模板性能优化策略</h2>
<p>大屏模板需要处理大量数据和高频率更新，性能优化至关重要：</p>
<p><strong>图表实例池管理</strong>：避免频繁创建销毁ECharts实例</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChartPool</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">maxSize = <span class="hljs-number">10</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span> = maxSize
  }
  
  <span class="hljs-title function_">getInstance</span>(<span class="hljs-params">key, initFn</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">has</span>(key)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">get</span>(key)
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">size</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">evictOldest</span>()
    }
    
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">initFn</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">set</span>(key, instance)
    <span class="hljs-keyword">return</span> instance
  }
  
  <span class="hljs-title function_">evictOldest</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> oldestKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>
    <span class="hljs-keyword">const</span> instance = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">get</span>(oldestKey)
    instance.<span class="hljs-title function_">dispose</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">delete</span>(oldestKey)
  }
}
</code></pre>
<p><strong>数据更新批处理</strong>：避免频繁重绘</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createBatchUpdater</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> updateQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
  <span class="hljs-keyword">let</span> isUpdating = <span class="hljs-literal">false</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">scheduleUpdate</span>(<span class="hljs-params">widgetId, updateFn</span>) {
      updateQueue.<span class="hljs-title function_">set</span>(widgetId, updateFn)
      
      <span class="hljs-keyword">if</span> (!isUpdating) {
        isUpdating = <span class="hljs-literal">true</span>
        <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushUpdates</span>()
        })
      }
    },
    
    <span class="hljs-title function_">flushUpdates</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> updates = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(updateQueue.<span class="hljs-title function_">entries</span>())
      updateQueue.<span class="hljs-title function_">clear</span>()
      
      <span class="hljs-comment">// 批量执行更新</span>
      updates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[id, updateFn]</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">updateFn</span>()
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Update failed for widget <span class="hljs-subst">${id}</span>:`</span>, error)
        }
      })
      
      isUpdating = <span class="hljs-literal">false</span>
    }
  }
}
</code></pre>
<p><strong>虚拟滚动长列表</strong>：处理大数据集展示</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- VirtualScrollChart.vue --&gt;
&lt;template&gt;
  &lt;div class="virtual-scroll-container" @scroll="handleScroll"&gt;
    &lt;div class="scroll-content" :style="{ height: totalHeight + 'px' }"&gt;
      &lt;div 
        v-for="item in visibleItems" 
        :key="item.id"
        class="scroll-item"
        :style="{ transform: `translateY(${item.offset}px)` }"
      &gt;
        &lt;slot name="item" :item="item.data"&gt;&lt;/slot&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-7">05 模板定制与扩展机制</h2>
<p>优秀的大屏模板需要提供灵活的定制能力：</p>
<p><strong>主题系统</strong>：支持动态主题切换</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// themes/_variables.scss</span>
<span class="hljs-variable">$themes</span>: (
  light: (
    primary-bg: <span class="hljs-number">#ffffff</span>,
    chart-grid: <span class="hljs-number">#f0f0f0</span>,
    text-primary: <span class="hljs-number">#333333</span>,
  ),
  dark: (
    primary-bg: <span class="hljs-number">#1a1a1a</span>,
    chart-grid: <span class="hljs-number">#2a2a2a</span>,
    text-primary: <span class="hljs-number">#e0e0e0</span>,
  ),
  blue: (
    primary-bg: <span class="hljs-number">#f0f8ff</span>,
    chart-grid: <span class="hljs-number">#d9e7ff</span>,
    text-primary: <span class="hljs-number">#003366</span>,
  )
);

<span class="hljs-comment">// 混合器应用主题</span>
<span class="hljs-keyword">@mixin</span> theme(<span class="hljs-variable">$property</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$theme</span>: <span class="hljs-string">'light'</span>) {
  #{<span class="hljs-variable">$property</span>}: <span class="hljs-built_in">map-get</span>(<span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$themes</span>, <span class="hljs-variable">$theme</span>), <span class="hljs-variable">$key</span>);
}
</code></pre>
<p><strong>插件系统</strong>：允许功能扩展</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplatePluginSystem</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = {
      <span class="hljs-string">'before-data-fetch'</span>: [],
      <span class="hljs-string">'after-chart-init'</span>: [],
      <span class="hljs-string">'layout-calculated'</span>: []
    }
  }
  
  <span class="hljs-title function_">registerPlugin</span>(<span class="hljs-params">name, plugin</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">set</span>(name, plugin)
    
    <span class="hljs-comment">// 注册插件钩子</span>
    <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">hooks</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(plugin.<span class="hljs-property">hooks</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">hookName</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerHook</span>(hookName, plugin.<span class="hljs-property">hooks</span>[hookName])
      })
    }
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">triggerHook</span>(<span class="hljs-params">hookName, context</span>) {
    <span class="hljs-keyword">const</span> hooks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>[hookName] || []
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> hook <span class="hljs-keyword">of</span> hooks) {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">hook</span>(context)
    }
  }
}
</code></pre>
<h2 data-id="heading-8">06 开源大屏模板资源评测</h2>















































<table><thead><tr><th>模板名称</th><th>技术栈</th><th>特色功能</th><th>学习曲线</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>VueDataV</strong></td><td>Vue3 + ECharts</td><td>3D地球、飞线图、拖拽布局</td><td>中等</td><td>政府/企业大屏</td></tr><tr><td><strong>Ant Design Charts</strong></td><td>React + AntV</td><td>企业级设计系统、丰富图表</td><td>较低</td><td>中后台系统</td></tr><tr><td><strong>D3.js Dashboard</strong></td><td>D3.js + React</td><td>高度自定义、复杂可视化</td><td>高</td><td>数据密集型分析</td></tr><tr><td><strong>Apache Superset</strong></td><td>React + 多种引擎</td><td>完整BI解决方案、SQL编辑</td><td>中等</td><td>商业智能平台</td></tr><tr><td><strong>Grafana</strong></td><td>React + Flot</td><td>监控专用、警报系统</td><td>中等</td><td>运维监控大屏</td></tr></tbody></table>
<h2 data-id="heading-9">07 从使用模板到贡献模板</h2>
<p>作为前端开发者，使用模板只是起点，真正的成长在于理解模板背后的设计思想并做出贡献：</p>
<ol>
<li><strong>源码学习</strong>：选择1-2个高质量开源模板，深入研究其架构设计</li>
<li><strong>定制开发</strong>：基于业务需求对模板进行二次开发</li>
<li><strong>抽象封装</strong>：将通用功能提取为可复用组件或插件</li>
<li><strong>开源贡献</strong>：修复bug、添加功能或完善文档</li>
</ol>
<p>大屏模板的真正价值不在于减少编码量，而在于<strong>标准化开发流程、提升代码质量、统一设计语言</strong>。当你的团队拥有自己的模板库时，新项目启动时间可以从数周缩短到数小时，而且能保持所有项目的一致性和可维护性。</p>
<hr/>
<p>深圳某智慧城市项目指挥中心，三块4K大屏实时展示着城市运行的800多项指标。年轻的开发者张涛在屏幕前调试着新的交通流量预测模块——基于团队自研的大屏模板，他仅用两天就集成了这个原本需要两周的功能。</p>
<p>在他身后，模板配置平台显示着<strong>187个</strong>正在运行的定制化大屏实例，而核心模板库的更新记录显示，最新一次优化将大屏的首屏加载时间从<strong>3.2秒降低到1.4秒</strong>。这不仅是技术的进步，更是前端开发范式的转变——从手工作坊到标准化生产的进化之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【TS】虚拟列表无渲染逻辑内核]]></title>    <link>https://juejin.cn/post/7586890269698621494</link>    <guid>https://juejin.cn/post/7586890269698621494</guid>    <pubDate>2025-12-23T07:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586890269698621494" data-draft-id="7586879894206939199" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【TS】虚拟列表无渲染逻辑内核"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七月十二"/> <meta itemprop="url" content="https://juejin.cn/user/145549432455998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【TS】虚拟列表无渲染逻辑内核
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/145549432455998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七月十二
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:51:17.000Z" title="Tue Dec 23 2025 07:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">VirtualCore</h2>
<p>虚拟列表无渲染逻辑内核，专注于位置计算与状态管理，不绑定任何 UI 框架。</p>
<h3 data-id="heading-1">特性</h3>
<ul>
<li><strong>框架无关</strong>：纯 TypeScript 实现，可配合 Vue、React、原生 JS 等任意框架使用</li>
<li><strong>动态高度</strong>：支持每行不同高度，实测后自动更新位置信息</li>
<li><strong>滚动锚定</strong>：高度变化时自动计算滚动补偿，避免内容跳动</li>
<li><strong>精确跳转</strong>：迭代收敛式跳转算法，确保准确定位到目标行</li>
<li><strong>动态数据</strong>：支持运行时增减列表总数</li>
</ul>
<h3 data-id="heading-2">快速开始</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">VirtualCore</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VirtualCore'</span>

<span class="hljs-comment">// 1. 创建实例</span>
<span class="hljs-keyword">const</span> core = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualCore</span>({
  <span class="hljs-attr">total</span>: <span class="hljs-number">1000</span>,           <span class="hljs-comment">// 列表总数</span>
  <span class="hljs-attr">defaultHeight</span>: <span class="hljs-number">50</span>,     <span class="hljs-comment">// 预估行高</span>
  <span class="hljs-attr">buffer</span>: <span class="hljs-number">5</span>,             <span class="hljs-comment">// 上下缓冲行数（可选，默认 5）</span>
  <span class="hljs-attr">onTotalHeightChange</span>: <span class="hljs-function">(<span class="hljs-params">height</span>) =&gt;</span> {
    <span class="hljs-comment">// 更新容器总高度</span>
    container.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${height}</span>px`</span>
  }
})

<span class="hljs-comment">// 2. 滚动时获取渲染范围</span>
container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { startIndex, endIndex, offset } = core.<span class="hljs-title function_">getRenderRange</span>(
    container.<span class="hljs-property">scrollTop</span>,
    container.<span class="hljs-property">clientHeight</span>
  )
  
  <span class="hljs-comment">// 渲染 startIndex ~ endIndex 范围的数据</span>
  <span class="hljs-comment">// offset 是列表容器的 translateY 偏移量</span>
})

<span class="hljs-comment">// 3. 元素渲染后更新真实高度</span>
<span class="hljs-keyword">const</span> updates = renderedItems.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
  <span class="hljs-attr">index</span>: item.<span class="hljs-property">index</span>,
  <span class="hljs-attr">height</span>: item.<span class="hljs-property">element</span>.<span class="hljs-property">offsetHeight</span>
}))

<span class="hljs-keyword">const</span> { scrollCorrection } = core.<span class="hljs-title function_">updateHeights</span>(updates, container.<span class="hljs-property">scrollTop</span>)

<span class="hljs-comment">// 应用滚动补偿，防止内容跳动</span>
<span class="hljs-keyword">if</span> (scrollCorrection !== <span class="hljs-number">0</span>) {
  container.<span class="hljs-property">scrollTop</span> += scrollCorrection
}
</code></pre>
<h3 data-id="heading-3">API</h3>
<h4 data-id="heading-4">构造函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualCore</span>(<span class="hljs-attr">config</span>: <span class="hljs-title class_">VirtualCoreConfig</span>)
</code></pre>








































<table><thead><tr><th>参数</th><th>类型</th><th>必填</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>total</code></td><td><code>number</code></td><td>是</td><td>-</td><td>列表总行数</td></tr><tr><td><code>defaultHeight</code></td><td><code>number</code></td><td>是</td><td>-</td><td>预估默认行高</td></tr><tr><td><code>buffer</code></td><td><code>number</code></td><td>否</td><td><code>5</code></td><td>可视区域外的缓冲行数</td></tr><tr><td><code>onTotalHeightChange</code></td><td><code>(height: number) =&gt; void</code></td><td>否</td><td>-</td><td>总高度变化回调</td></tr></tbody></table>
<h4 data-id="heading-5">核心方法</h4>
<h5 data-id="heading-6"><code>getRenderRange(scrollTop, viewHeight): RenderRange</code></h5>
<p>根据滚动位置计算需要渲染的行范围。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> range = core.<span class="hljs-title function_">getRenderRange</span>(scrollTop, viewHeight)

<span class="hljs-comment">// 返回值</span>
{
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>   <span class="hljs-comment">// 渲染起始索引</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>     <span class="hljs-comment">// 渲染结束索引</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>       <span class="hljs-comment">// 列表容器的 Y 轴偏移量</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>  <span class="hljs-comment">// 锚点索引（可视区域第一行）</span>
}
</code></pre>
<h5 data-id="heading-7"><code>updateHeights(updates, currentScrollTop): UpdateCorrection</code></h5>
<p>批量更新行高，返回滚动补偿值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> { scrollCorrection } = core.<span class="hljs-title function_">updateHeights</span>([
  { <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">80</span> },
  { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">60</span> }
], container.<span class="hljs-property">scrollTop</span>)

<span class="hljs-comment">// 应用补偿</span>
container.<span class="hljs-property">scrollTop</span> += scrollCorrection
</code></pre>
<h5 data-id="heading-8"><code>scrollToIndex(index, callbacks, options?)</code></h5>
<p>迭代收敛式精确跳转到指定行。</p>
<pre><code class="hljs language-typescript" lang="typescript">core.<span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-number">100</span>, {
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop</span>) =&gt;</span> {
    <span class="hljs-comment">// 执行滚动，可返回 Promise</span>
    container.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: targetTop, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>) <span class="hljs-comment">// 等待动画完成</span>
    })
  },
  <span class="hljs-attr">onComplete</span>: <span class="hljs-function">(<span class="hljs-params">finalTop, iterations</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`跳转完成，经过 <span class="hljs-subst">${iterations}</span> 次迭代`</span>)
  },
  <span class="hljs-attr">onAbort</span>: <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`跳转中断: <span class="hljs-subst">${reason}</span>`</span>)
  }
}, {
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">10</span>,      <span class="hljs-comment">// 收敛阈值（可选）</span>
  <span class="hljs-attr">maxIterations</span>: <span class="hljs-number">10</span>   <span class="hljs-comment">// 最大迭代次数（可选）</span>
})
</code></pre>
<h4 data-id="heading-9">辅助方法</h4>









































<table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>getTotalHeight()</code></td><td>获取列表总高度</td></tr><tr><td><code>getTopByIndex(index)</code></td><td>获取指定行的 top 值</td></tr><tr><td><code>getItemPosition(index)</code></td><td>获取指定行的完整位置信息</td></tr><tr><td><code>setTotal(newTotal)</code></td><td>动态设置列表总数</td></tr><tr><td><code>getTotal()</code></td><td>获取当前列表总数</td></tr><tr><td><code>reset(newTotal?)</code></td><td>重置所有位置信息</td></tr><tr><td><code>abortScrollTo()</code></td><td>手动中断跳转</td></tr><tr><td><code>isScrolling()</code></td><td>检查是否正在跳转中</td></tr></tbody></table>
<h3 data-id="heading-10">使用示例</h3>
<h4 data-id="heading-11">Vue 3 组合式 API</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted, computed } from 'vue'
import VirtualCore from './VirtualCore'

const props = defineProps&lt;{ items: any[] }&gt;()

const containerRef = ref&lt;HTMLElement&gt;()
const scrollTop = ref(0)
const totalHeight = ref(0)

const core = new VirtualCore({
  total: props.items.length,
  defaultHeight: 50,
  onTotalHeightChange: (h) =&gt; { totalHeight.value = h }
})

const renderRange = computed(() =&gt; 
  core.getRenderRange(scrollTop.value, containerRef.value?.clientHeight || 0)
)

const visibleItems = computed(() =&gt; {
  const { startIndex, endIndex } = renderRange.value
  return props.items.slice(startIndex, endIndex + 1).map((item, i) =&gt; ({
    ...item,
    _index: startIndex + i
  }))
})

function onScroll(e: Event) {
  scrollTop.value = (e.target as HTMLElement).scrollTop
}

// 渲染后更新高度
function updateItemHeights(elements: HTMLElement[]) {
  const updates = elements.map((el, i) =&gt; ({
    index: renderRange.value.startIndex + i,
    height: el.offsetHeight
  }))
  
  const { scrollCorrection } = core.updateHeights(updates, scrollTop.value)
  if (scrollCorrection &amp;&amp; containerRef.value) {
    containerRef.value.scrollTop += scrollCorrection
  }
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div ref="containerRef" class="virtual-container" @scroll="onScroll"&gt;
    &lt;div :style="{ height: totalHeight + 'px' }"&gt;
      &lt;div :style="{ transform: `translateY(${renderRange.offset}px)` }"&gt;
        &lt;div v-for="item in visibleItems" :key="item._index"&gt;
          &lt;!-- 渲染内容 --&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-12">跳转到指定行</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToRow</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) {
  core.<span class="hljs-title function_">scrollToIndex</span>(index, {
    <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">top</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
        containerRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">scrollTo</span>({ top, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> })
        <span class="hljs-comment">// 等待滚动动画</span>
        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>)
      })
    },
    <span class="hljs-attr">onComplete</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转完成'</span>)
    }
  })
}
</code></pre>
<h3 data-id="heading-13">注意事项</h3>
<h4 data-id="heading-14">性能相关</h4>
<ul>
<li><strong>超大列表</strong>：超过 10 万行时，频繁的高度更新可能有性能影响</li>
<li><strong>批量更新</strong>：尽量合并多次 <code>updateHeights</code> 调用为一次批量更新</li>
<li><strong>预估高度</strong>：<code>defaultHeight</code> 越接近真实高度，初次渲染的跳动越小</li>
</ul>
<h4 data-id="heading-15">回调限制</h4>
<ul>
<li><code>onTotalHeightChange</code> 回调中<strong>不要</strong>调用 VirtualCore 的任何修改方法，避免重入问题</li>
</ul>
<h4 data-id="heading-16">跳转行为</h4>
<ul>
<li>跳转采用迭代收敛算法，目标行之前的元素高度确定后才能精确定位</li>
<li>如果目标行很远且中间元素高度差异大，可能需要多次迭代</li>
<li>可通过 <code>maxIterations</code> 限制最大迭代次数，避免极端情况</li>
</ul>
<h4 data-id="heading-17">滚动锚定</h4>
<ul>
<li>只有<strong>完全在视口上方</strong>的元素高度变化才会触发滚动补偿</li>
<li>跨越视口边界或在视口内的元素高度变化不补偿，避免干扰用户操作</li>
</ul>
<h3 data-id="heading-18">类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemPosition</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeightUpdate</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RenderRange</span> {
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateCorrection</span> {
  <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToCallbacks</span> {
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
  onComplete?: <span class="hljs-function">(<span class="hljs-params">finalTop: <span class="hljs-built_in">number</span>, iterations: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  onAbort?: <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToOptions</span> {
  threshold?: <span class="hljs-built_in">number</span>
  maxIterations?: <span class="hljs-built_in">number</span>
}
</code></pre>
<h2 data-id="heading-19">源码</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 每一行位置信息的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemPosition</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 更新行高请求的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeightUpdate</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 渲染范围的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RenderRange</span> {
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 高度更新返回的修正值接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateCorrection</span> {
  <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 初始化配置接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VirtualCoreConfig</span> {
  <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">defaultHeight</span>: <span class="hljs-built_in">number</span>
  buffer?: <span class="hljs-built_in">number</span>
  onTotalHeightChange?: <span class="hljs-function">(<span class="hljs-params">totalHeight: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-comment">/**
 * 跳转回调接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToCallbacks</span> {
  <span class="hljs-comment">/** 需要滚动到新位置时调用，返回 Promise 表示滚动动画完成 */</span>
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
  <span class="hljs-comment">/** 跳转完成时调用 */</span>
  onComplete?: <span class="hljs-function">(<span class="hljs-params">finalTop: <span class="hljs-built_in">number</span>, iterations: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-comment">/** 跳转被中断或失败时调用 */</span>
  onAbort?: <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-comment">/**
 * 跳转配置
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToOptions</span> {
  <span class="hljs-comment">/** 收敛阈值，位置差小于此值认为完成（默认为 defaultHeight） */</span>
  threshold?: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 最大迭代次数（默认 10） */</span>
  maxIterations?: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 跳转状态
 * - idle: 空闲
 * - scrolling: 正在执行滚动动画
 * - waiting: 滚动完成，等待高度更新
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ScrollToStatus</span> = <span class="hljs-string">'idle'</span> | <span class="hljs-string">'scrolling'</span> | <span class="hljs-string">'waiting'</span>

<span class="hljs-comment">/**
 * 跳转上下文（内部使用）
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToContext</span> {
  <span class="hljs-attr">targetIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 上一次迭代时目标索引的 top 值 */</span>
  <span class="hljs-attr">lastTop</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 当前迭代次数 */</span>
  <span class="hljs-attr">iterations</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">maxIterations</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">threshold</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">ScrollToCallbacks</span>
  <span class="hljs-attr">status</span>: <span class="hljs-title class_">ScrollToStatus</span>
  <span class="hljs-comment">/** 在 scrolling 状态期间是否收到了高度更新 */</span>
  <span class="hljs-attr">pendingHeightUpdate</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-comment">/**
 * VirtualCore: 虚拟列表无渲染逻辑内核 (TypeScript 版)
 *
 * 功能：
 * 1. 维护每一行的位置信息 (top, bottom, height)
 * 2. 根据滚动位置计算需要渲染的行范围
 * 3. 支持动态高度更新，并提供滚动锚定
 * 4. 支持动态调整列表总数
 * 5. 迭代收敛式精确跳转
 *
 * 注意事项：
 * - onTotalHeightChange 回调中不应该调用 VirtualCore 的任何修改方法，避免重入问题
 * - 对于超大列表（&gt; 10万行），频繁的高度更新可能会有性能影响
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualCore</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">defaultHeight</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">buffer</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> onTotalHeightChange?: <span class="hljs-function">(<span class="hljs-params">totalHeight: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>

  <span class="hljs-keyword">private</span> <span class="hljs-attr">positions</span>: <span class="hljs-title class_">ItemPosition</span>[] = []

  <span class="hljs-comment">/** 跳转上下文 */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">scrollToCtx</span>: <span class="hljs-title class_">ScrollToContext</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: VirtualCoreConfig</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = config.<span class="hljs-property">total</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span> = config.<span class="hljs-property">defaultHeight</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = config.<span class="hljs-property">buffer</span> ?? <span class="hljs-number">5</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onTotalHeightChange</span> = config.<span class="hljs-property">onTotalHeightChange</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_initPositions</span>()
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 基础方法</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 初始化位置表，预估初始高度
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_initPositions</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i] = {
        <span class="hljs-attr">index</span>: i,
        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
        <span class="hljs-attr">top</span>: i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
        <span class="hljs-attr">bottom</span>: (i + <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
      }
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前总高度
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTotalHeight</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">const</span> lastIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> (lastIndex &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[lastIndex].<span class="hljs-property">bottom</span>
  }

  <span class="hljs-comment">/**
   * 获取渲染区间及偏移量 (核心用于 UI 渲染)
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getRenderRange</span>(<span class="hljs-attr">scrollTop</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">viewHeight</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">RenderRange</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">startIndex</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">endIndex</span>: -<span class="hljs-number">1</span>,
        <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">anchorIndex</span>: <span class="hljs-number">0</span>
      }
    }

    <span class="hljs-keyword">const</span> anchorIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findStartIndex</span>(scrollTop), <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>)
    <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, anchorIndex - <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>)

    <span class="hljs-keyword">const</span> endAnchor = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findStartIndex</span>(scrollTop + viewHeight)
    <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>, endAnchor + <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>)

    <span class="hljs-keyword">const</span> offset = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[startIndex].<span class="hljs-property">top</span>

    <span class="hljs-keyword">return</span> {
      startIndex,
      endIndex,
      offset,
      anchorIndex
    }
  }

  <span class="hljs-comment">/**
   * 获取指定索引的 top 值（仅查询，不触发跳转）
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTopByIndex</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTotalHeight</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index].<span class="hljs-property">top</span>
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 高度更新</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 更新行高并返回修正值
   *
   * <span class="hljs-doctag">@param</span> updates 实测到的真实高度数据集合
   * <span class="hljs-doctag">@param</span> currentScrollTop 容器当前的滚动位置
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">updateHeights</span>(<span class="hljs-attr">updates</span>: <span class="hljs-title class_">HeightUpdate</span>[], <span class="hljs-attr">currentScrollTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">UpdateCorrection</span> {
    <span class="hljs-keyword">if</span> (updates.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-number">0</span> }
    }

    <span class="hljs-keyword">const</span> validUpdates = updates.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">{ index }</span>) =&gt;</span> index &gt;= <span class="hljs-number">0</span> &amp;&amp; index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>)

    <span class="hljs-keyword">if</span> (validUpdates.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-number">0</span> }
    }

    validUpdates.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">index</span> - b.<span class="hljs-property">index</span>)

    <span class="hljs-keyword">let</span> scrollCorrection = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> hasHeightChanged = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">let</span> firstChangedIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>

    validUpdates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ index, height }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index]
      <span class="hljs-keyword">const</span> oldHeight = item.<span class="hljs-property">height</span>
      <span class="hljs-keyword">const</span> diff = height - oldHeight

      <span class="hljs-keyword">if</span> (diff !== <span class="hljs-number">0</span>) {
        hasHeightChanged = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">if</span> (index &lt; firstChangedIndex) {
          firstChangedIndex = index
        }

        <span class="hljs-comment">// 改进的滚动锚定逻辑</span>
        <span class="hljs-comment">// 只有当元素完全在视口上方时才进行补偿</span>
        <span class="hljs-keyword">const</span> itemTop = item.<span class="hljs-property">top</span>
        <span class="hljs-keyword">if</span> (itemTop + oldHeight &lt;= currentScrollTop) {
          <span class="hljs-comment">// 元素完全在视口上方</span>
          scrollCorrection += diff
        }
        <span class="hljs-comment">// 元素跨越视口边界或在视口内/下方，不补偿</span>

        item.<span class="hljs-property">height</span> = height
      }
    })

    <span class="hljs-keyword">if</span> (hasHeightChanged) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_recalculatePositions</span>(firstChangedIndex)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()

      <span class="hljs-comment">// 标记有高度更新待处理</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'scrolling'</span>) {
          <span class="hljs-comment">// 滚动进行中收到高度更新，标记待处理</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'waiting'</span>) {
          <span class="hljs-comment">// 已经在等待状态，直接检查收敛</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkScrollToConvergence</span>()
        }
      }
    }

    <span class="hljs-keyword">return</span> { scrollCorrection }
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 迭代收敛式跳转</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 开始跳转到指定索引（迭代收敛式）
   *
   * <span class="hljs-doctag">@param</span> index 目标行索引
   * <span class="hljs-doctag">@param</span> callbacks 回调函数
   * <span class="hljs-doctag">@param</span> options 配置选项
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">ScrollToCallbacks</span>, options?: <span class="hljs-title class_">ScrollToOptions</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 边界处理</span>
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) index = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>)

    <span class="hljs-comment">// 如果列表为空，直接完成</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span>) {
      callbacks.<span class="hljs-property">onComplete</span>?.(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 如果已有跳转进行中，先中断</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'new scroll requested'</span>)
    }

    <span class="hljs-keyword">const</span> threshold = options?.<span class="hljs-property">threshold</span> ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
    <span class="hljs-keyword">const</span> maxIterations = options?.<span class="hljs-property">maxIterations</span> ?? <span class="hljs-number">10</span>
    <span class="hljs-keyword">const</span> targetTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index].<span class="hljs-property">top</span>

    <span class="hljs-comment">// 初始化跳转上下文</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = {
      <span class="hljs-attr">targetIndex</span>: index,
      <span class="hljs-attr">lastTop</span>: targetTop, <span class="hljs-comment">// 记录初始目标位置</span>
      <span class="hljs-attr">iterations</span>: <span class="hljs-number">0</span>,
      maxIterations,
      threshold,
      callbacks,
      <span class="hljs-attr">status</span>: <span class="hljs-string">'idle'</span>,
      <span class="hljs-attr">pendingHeightUpdate</span>: <span class="hljs-literal">false</span>
    }

    <span class="hljs-comment">// 触发第一次滚动</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_doScroll</span>(targetTop)
  }

  <span class="hljs-comment">/**
   * 手动中断当前跳转
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">abortScrollTo</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'manually aborted'</span>)
  }

  <span class="hljs-comment">/**
   * 检查是否正在跳转中
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">isScrolling</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> !== <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">/**
   * 通知滚动动画完成（外部调用）
   *
   * 当外部滚动动画完成后，应调用此方法通知 VirtualCore
   * 这样可以在下一次 updateHeights 时检查收敛
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">notifyScrollComplete</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'scrolling'</span>) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 处理竞态：检查是否有待处理的高度更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'waiting'</span>

    <span class="hljs-comment">// [修复1] 每次滚动完成后都检查收敛</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkScrollToConvergence</span>()
  }

  <span class="hljs-comment">/**
   * 执行滚动
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_doScroll</span>(<span class="hljs-attr">targetTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'scrolling'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">iterations</span>++
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 重置待处理标记</span>

    <span class="hljs-comment">// 保存当前上下文引用，用于在回调中判断上下文是否已变化</span>
    <span class="hljs-keyword">const</span> currentCtx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>

    <span class="hljs-keyword">const</span> result = currentCtx.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">onScroll</span>(targetTop)

    <span class="hljs-comment">// 统一处理同步和异步情况</span>
    <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
      <span class="hljs-comment">// 异步情况：等待 Promise 完成后通知</span>
      result
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 只有上下文未变化时才处理，防止误操作新的跳转</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyScrollComplete</span>()
          }
        })
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 同样检查上下文</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'scroll failed'</span>)
          }
        })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 同步情况：使用 microtask 延迟通知</span>
      <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 检查上下文是否仍然是同一个，且状态仍为 scrolling</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx &amp;&amp; currentCtx.<span class="hljs-property">status</span> === <span class="hljs-string">'scrolling'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyScrollComplete</span>()
        }
      })
    }
  }

  <span class="hljs-comment">/**
   * 检查跳转是否收敛
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_checkScrollToConvergence</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>
    <span class="hljs-keyword">if</span> (!ctx || ctx.<span class="hljs-property">status</span> !== <span class="hljs-string">'waiting'</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> currentTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[ctx.<span class="hljs-property">targetIndex</span>].<span class="hljs-property">top</span>
    <span class="hljs-keyword">const</span> diff = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(currentTop - ctx.<span class="hljs-property">lastTop</span>)

    <span class="hljs-comment">// 检查是否收敛：位置变化小于阈值</span>
    <span class="hljs-keyword">if</span> (diff &lt;= ctx.<span class="hljs-property">threshold</span>) {
      <span class="hljs-comment">// 收敛完成</span>
      <span class="hljs-keyword">const</span> finalTop = currentTop
      <span class="hljs-keyword">const</span> iterations = ctx.<span class="hljs-property">iterations</span>
      <span class="hljs-keyword">const</span> callbacks = ctx.<span class="hljs-property">callbacks</span>

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = <span class="hljs-literal">null</span>
      callbacks.<span class="hljs-property">onComplete</span>?.(finalTop, iterations)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 检查是否超过最大迭代次数</span>
    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">iterations</span> &gt;= ctx.<span class="hljs-property">maxIterations</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">`max iterations (<span class="hljs-subst">${ctx.maxIterations}</span>) reached`</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 继续迭代：更新 lastTop 并再次滚动</span>
    ctx.<span class="hljs-property">lastTop</span> = currentTop
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_doScroll</span>(currentTop)
  }

  <span class="hljs-comment">/**
   * 中断跳转
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-attr">reason</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> callbacks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">callbacks</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = <span class="hljs-literal">null</span>
    callbacks.<span class="hljs-property">onAbort</span>?.(reason)
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 列表管理</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 动态设置列表总数
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setTotal</span>(<span class="hljs-attr">newTotal</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (newTotal &lt; <span class="hljs-number">0</span>) {
      newTotal = <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">if</span> (newTotal === <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 如果正在跳转，检查目标是否还有效</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">targetIndex</span> &gt;= newTotal) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'target index out of range after setTotal'</span>)
    }

    <span class="hljs-keyword">if</span> (newTotal &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) {
      <span class="hljs-keyword">const</span> oldTotal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
      <span class="hljs-keyword">const</span> lastBottom = oldTotal &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[oldTotal - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span> : <span class="hljs-number">0</span>

      <span class="hljs-comment">// 预先扩展数组长度</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = newTotal

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = oldTotal; i &lt; newTotal; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i] = {
          <span class="hljs-attr">index</span>: i,
          <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
          <span class="hljs-attr">top</span>: lastBottom + (i - oldTotal) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
          <span class="hljs-attr">bottom</span>: lastBottom + (i - oldTotal + <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = newTotal
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = newTotal
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前列表总数
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTotal</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
  }

  <span class="hljs-comment">/**
   * 获取指定索引的位置信息
   * 返回深拷贝，防止外部修改内部状态
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getItemPosition</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">ItemPosition</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index] }
  }

  <span class="hljs-comment">/**
   * 重置所有位置信息
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">reset</span>(newTotal?: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 中断进行中的跳转</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'reset called'</span>)
    }

    <span class="hljs-keyword">if</span> (newTotal !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = newTotal &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : newTotal
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_initPositions</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前默认行高
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getDefaultHeight</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 私有工具方法</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 从指定索引开始，重新计算所有后续行的 top 和 bottom
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_recalculatePositions</span>(<span class="hljs-attr">fromIndex</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = fromIndex; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>; i++) {
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> = <span class="hljs-number">0</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span>
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">bottom</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">height</span>
    }
  }

  <span class="hljs-comment">/**
   * 二分查找：找到第一个 bottom &gt; scrollTop 的索引
   * 当 scrollTop 超出范围时返回 this.total
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_findStartIndex</span>(<span class="hljs-attr">scrollTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">const</span> lastIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> (scrollTop &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">if</span> (scrollTop &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[lastIndex].<span class="hljs-property">bottom</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
    }

    <span class="hljs-keyword">let</span> low = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> high = lastIndex

    <span class="hljs-keyword">while</span> (low &lt;= high) {
      <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((low + high) / <span class="hljs-number">2</span>)
      <span class="hljs-keyword">const</span> midBottom = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[mid].<span class="hljs-property">bottom</span>

      <span class="hljs-keyword">if</span> (midBottom &gt; scrollTop) {
        <span class="hljs-keyword">if</span> (mid === <span class="hljs-number">0</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[mid - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span> &lt;= scrollTop) {
          <span class="hljs-keyword">return</span> mid
        }
        high = mid - <span class="hljs-number">1</span>
      } <span class="hljs-keyword">else</span> {
        low = mid + <span class="hljs-number">1</span>
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  }

  <span class="hljs-comment">/**
   * 通知外部总高度发生变化
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_notifyHeightChange</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onTotalHeightChange</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onTotalHeightChange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTotalHeight</span>())
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">VirtualCore</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ItemPosition</span>, <span class="hljs-title class_">HeightUpdate</span>, <span class="hljs-title class_">RenderRange</span>, <span class="hljs-title class_">UpdateCorrection</span>, <span class="hljs-title class_">VirtualCoreConfig</span>, <span class="hljs-title class_">ScrollToCallbacks</span>, <span class="hljs-title class_">ScrollToOptions</span> }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android system_server进程介绍]]></title>    <link>https://juejin.cn/post/7586680977855742015</link>    <guid>https://juejin.cn/post/7586680977855742015</guid>    <pubDate>2025-12-23T06:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586680977855742015" data-draft-id="7586861592709529636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android system_server进程介绍"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T06:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android system_server进程介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:59:16.000Z" title="Tue Dec 23 2025 06:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题：</h2>
<p>请详细介绍 Android 中 <code>system_server</code> 进程的作用、启动流程和核心功能，包括：</p>
<ol>
<li><strong>进程概述</strong>：说明该进程的定位、在系统中的角色以及启动时机。</li>
<li><strong>启动流程</strong>：从 Zygote 启动到 <code>system_server</code> 运行的步骤。</li>
<li><strong>主要服务</strong>：列出并简述该进程中运行的关键系统服务（如 ActivityManagerService、PackageManagerService 等）。</li>
<li><strong>与其他进程的关系</strong>：说明它与 framework、应用进程、底层 native 进程的通信方式。</li>
<li><strong>稳定性与安全性</strong>：分析 system_server 崩溃或卡死对系统的影响，以及常见的保护机制。</li>
<li><strong>调试与分析方法</strong>：介绍查看日志、trace 文件及源码的方法。</li>
</ol>
<hr/>
<h2 data-id="heading-1">1. <strong>进程概述：定位、角色与启动时机</strong></h2>
<h3 data-id="heading-2"><strong>1.1 定位与角色</strong></h3>
<p><code>system_server</code> 是 Android 中 <strong>最关键的 Java 进程之一</strong>，主要特征：</p>
<ul>
<li>
<p><strong>承载绝大部分 Java Framework 系统服务</strong> 如：<strong>ActivityManagerService (AMS)</strong> 、<strong>PackageManagerService (PMS)</strong> 、<strong>WindowManagerService (WMS)</strong> 、<strong>PowerManagerService (PMS)</strong> 等，几乎所有应用能感知到的系统能力，都要通过这些服务转一圈。</p>
</li>
<li>
<p><strong>系统“中枢调度中心”</strong> 负责：</p>
<ul>
<li>进程和四大组件生命周期控制</li>
<li>任务栈与界面管理</li>
<li>包和权限管理</li>
<li>电源、输入、传感器、网络等的大量策略层逻辑</li>
</ul>
</li>
<li>
<p><strong>单点故障（Single Point of Failure）</strong> 一旦 <code>system_server</code> 崩溃，<strong>Android 整个 Framework 失效</strong>，通常会触发 <strong>framework 重启</strong>（看起来像“桌面重启”或“手机黑一下再亮”）。</p>
</li>
</ul>
<h3 data-id="heading-3"><strong>1.2 启动时机</strong></h3>
<p>整体时序（高层）：</p>
<ol>
<li><strong>内核启动完成</strong> → 启动 <code>init</code> 进程。</li>
<li><code>init</code> 解析 <code>init.rc</code> 等配置，启动 <strong>Zygote 进程</strong>。</li>
<li><strong>Zygote 启动后立刻 fork 出</strong> <strong><code>system_server</code></strong>。</li>
<li><code>system_server</code> 内部启动各种系统服务，framework 才真正“活起来”。</li>
</ol>
<p>所以：<strong><code>system_server</code></strong> <strong>在整个系统引导阶段非常靠前</strong>，比所有应用进程要早得多，是后续所有应用的“上帝视角”调度者。</p>
<h2 data-id="heading-4">2. <strong>启动流程：从 Zygote 到 system_server</strong></h2>
<p>以典型 AOSP 启动链为例，简化步骤如下：</p>
<h3 data-id="heading-5"><strong>2.1 内核与 init 阶段</strong></h3>
<ol>
<li><strong>Linux 内核启动</strong> 加载驱动、挂载文件系统，最终启动第一个用户空间进程：<code>/init</code>。</li>
<li><strong>init 解析 rc 脚本</strong> 如 <code>init.rc</code>、<code>init.&lt;hardware&gt;.rc</code>，定义各种 service。 其中一项是启动 Zygote，例如（简化示意）：</li>
</ol>
<pre><code class="hljs language-perl" lang="perl">service zygote /<span class="hljs-keyword">system</span>/bin/app_process -Xzygote ...
    class main
    <span class="hljs-keyword">socket</span> zygote stream <span class="hljs-number">660</span> root <span class="hljs-keyword">system</span>
    onrestart <span class="hljs-keyword">write</span> /sys/android_power/request_state wake
</code></pre>
<h3 data-id="heading-6"><strong>2.2 Zygote 进程启动</strong></h3>
<p><code>app_process</code> 最终进入 <code>com.android.internal.os.ZygoteInit.main()</code>，主要做：</p>
<ol>
<li>
<p><strong>预加载类和资源</strong>（<code>preload()</code>）</p>
<ol>
<li>预加载 framework 常用的 Java 类、资源等，提高后续 fork 子进程的速度（写时复制）。</li>
</ol>
</li>
<li>
<p><strong>创建 zygote socket</strong></p>
<ol>
<li>用于接收 AMS 发来的“fork 新应用进程”的请求。</li>
</ol>
</li>
<li>
<p><strong>调用</strong> <strong><code>startSystemServer()</code></strong> <strong>启动 system_server</strong>。</p>
</li>
</ol>
<h3 data-id="heading-7"><strong>2.3 Zygote 中的 startSystemServer</strong></h3>
<p>在 <code>ZygoteInit</code> 中，核心逻辑大致是：</p>
<pre><code class="hljs language-scss" lang="scss">private static boolean <span class="hljs-built_in">startSystemServer</span>(...) {
    <span class="hljs-comment">// 1. 组装 system_server 的启动参数：uid/gid、进程名、classPath 等</span>
    String args<span class="hljs-selector-attr">[]</span> = {
        "<span class="hljs-attr">--setuid</span>=<span class="hljs-number">1000</span>",              <span class="hljs-comment">// system UID</span>
        "<span class="hljs-attr">--setgid</span>=<span class="hljs-number">1000</span>",
        "<span class="hljs-attr">--runtime-args</span>",
        "<span class="hljs-attr">--nice-name</span>=system_server",
        "com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.SystemServer</span>"
    };
    
    <span class="hljs-comment">// 2. 调用 forkSystemServer，使用 Zygote fork 出子进程</span>
    ZygoteProcess<span class="hljs-selector-class">.ProcessResult</span> result = Zygote<span class="hljs-selector-class">.forkSystemServer</span>(..., args, ...);

    <span class="hljs-comment">// 3. 在子进程中，执行 handleSystemServerProcess，进入 Java 世界</span>
    if (result.pid == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">handleSystemServerProcess</span>(...); <span class="hljs-comment">// 子进程路径</span>
    }
}
</code></pre>
<p>关键点：</p>
<ul>
<li><code>system_server</code> <strong>是 Zygote fork 出的第一个重要子进程</strong>；</li>
<li>使用固定的 UID/GID（一般为 <strong>system 用户</strong>），权限极高；</li>
<li>指定入口类为 <strong><code>com.android.server.SystemServer</code></strong>。</li>
</ul>
<h3 data-id="heading-8"><strong>2.4 system_server 进程内部：SystemServer.main()</strong></h3>
<p><code>SystemServer</code> 类的主入口（简化）：</p>
<pre><code class="hljs language-scss" lang="scss">public static void <span class="hljs-selector-tag">main</span>(String[] args) {
    new <span class="hljs-built_in">SystemServer</span>()<span class="hljs-selector-class">.run</span>();
}

private void <span class="hljs-built_in">run</span>() {
    <span class="hljs-comment">// 1. 设置优先级 / 线程策略 / 权限检查</span>

    <span class="hljs-comment">// 2. 启动各类系统服务</span>
    <span class="hljs-built_in">startBootstrapServices</span>();  <span class="hljs-comment">// 启动最基础的服务</span>
    <span class="hljs-built_in">startCoreServices</span>();       <span class="hljs-comment">// 启动框架核心服务</span>
    <span class="hljs-built_in">startOtherServices</span>();      <span class="hljs-comment">// 启动其他大量服务</span>

    <span class="hljs-comment">// 3. 进入 Looper.loop()，进入消息循环</span>
}
</code></pre>
<p><code>startBootstrapServices()</code> 中一般会启动：</p>
<ul>
<li>Installer、ActivityManagerService、PowerManagerService、PackageManagerService 等；</li>
<li>这些服务准备好后，framework 才具备基本的调度能力。</li>
</ul>
<p>至此，<strong><code>system_server</code></strong> <strong>正式进入主循环，Android Framework 启动完成</strong>，可以接收应用启动请求，去 fork app 进程。</p>
<h2 data-id="heading-9">3. <strong>主要服务：system_server 内的关键系统服务</strong></h2>
<p><code>system_server</code> 是一个“<strong>服务容器进程</strong>”，里面运行着大量 Java 系统服务（有的还桥接 native）。下面列一些典型且对应用最核心的服务及职责（非完整列表）：</p>









































































<table><thead><tr><th>服务名（Java 类）</th><th>主要职责</th></tr></thead><tbody><tr><td>ActivityManagerService (AMS)</td><td>进程/Activity/Service/Broadcast 的生命周期、任务栈管理、ANR 监控、进程优先级管理等。几乎所有应用组件的启动/停止都要经过它。</td></tr><tr><td>PackageManagerService (PMS)</td><td>APK 安装/卸载、包信息（version、签名、组件）、权限授予与校验、隐式Intent解析、Dex 优化等。</td></tr><tr><td>WindowManagerService (WMS)</td><td>窗口管理、窗口层级/动画、显示内容布局，与 SurfaceFlinger 协同完成渲染；管理状态栏、导航栏等系统窗口。</td></tr><tr><td>DisplayManagerService (DMS)</td><td>显示设备（屏幕、外接显示器）、分辨率、刷新率、显示切换等管理。</td></tr><tr><td>PowerManagerService (PMS)</td><td>电源策略、休眠/唤醒（wake lock）、亮灭屏逻辑、电池相关策略等。</td></tr><tr><td>InputManagerService (IMS)</td><td>输入事件（触摸、按键）的分发与调度，和 native inputflinger 协作，将 input 分发给 WMS/应用。</td></tr><tr><td>SensorManagerService</td><td>传感器（加速度、陀螺仪、距离等）管理及事件分发。</td></tr><tr><td>LocationManagerService</td><td>定位相关服务管理（GPS、网络定位、融合算法等）。</td></tr><tr><td>AudioService</td><td>音量控制、音频路由、音频焦点（audio focus）等。</td></tr><tr><td>NotificationManagerService</td><td>通知栏消息管理、通知渠道、优先级、do-not-disturb 策略。</td></tr><tr><td>VibratorService</td><td>马达震动控制。</td></tr><tr><td>AlarmManagerService</td><td>定时任务/闹钟管理（RTC/ELAPSED_REALTIME 等），唤醒策略。</td></tr><tr><td>ConnectivityService</td><td>网络连接状态、流量管理、代理、VPN 等。</td></tr><tr><td>UserManagerService</td><td>多用户/工作资料（Work Profile）等用户管理。</td></tr><tr><td>ContentService</td><td>ContentProvider 的注册与调度。</td></tr><tr><td>ActivityTaskManagerService (ATMS)</td><td>新版本拆分出的任务/栈管理服务，与 AMS 协作。</td></tr></tbody></table>
<p>这些服务通常在 <code>SystemServer.startBootstrapServices()</code> / <code>startCoreServices()</code> / <code>startOtherServices()</code> 中依次创建并通过 <strong>ServiceManager</strong> 注册为 Binder 服务。应用通过 Binder 调用这些服务的接口，从而实现各种系统功能。</p>
<h2 data-id="heading-10">4. <strong>与其他进程的关系与通信方式</strong></h2>
<h3 data-id="heading-11"><strong>4.1 与 Framework（Java 层）的关系</strong></h3>
<ul>
<li><code>system_server</code> 本身就是 <strong>Framework Java 层服务端实现</strong>所在的进程。</li>
<li>应用侧通过 <code>Context.getSystemService()</code> 获取的是<strong>代理对象（Proxy/Stub）</strong> ，其底层通过 <strong>Binder</strong> 与 <code>system_server</code> 中的真实服务通信。</li>
<li>例如：<code>ActivityManager</code> → <code>IActivityManager</code> Binder stub/proxy → <code>ActivityManagerService</code>（system_server 内）</li>
</ul>
<h3 data-id="heading-12"><strong>4.2 与应用进程的关系</strong></h3>
<ol>
<li>
<p><strong>进程创建关系</strong></p>
<ol>
<li>应用进程（app）是由 <strong>Zygote</strong> fork 出的；</li>
<li>AMS 通过 Zygote socket 请求 fork app，app 启动后再与 AMS 建立 Binder 通道；</li>
<li><code>system_server</code> 负责维护所有 app 进程的生命周期和优先级。</li>
</ol>
</li>
<li>
<p><strong>通信方式</strong></p>
<ol>
<li>
<p><strong>主方式：Binder IPC</strong></p>
<ul>
<li>app 调用系统 API → 通过 Binder 调到 system_server 对应服务；</li>
<li>system_server 反过来通过 Binder 回调应用（如 scheduleLaunchActivity、scheduleReceiver 等）。</li>
</ul>
</li>
<li>
<p><strong>少量共有内存 / 文件描述符传递</strong></p>
<ul>
<li>如图形缓冲区（GraphicBuffer）、匿名共享内存（ashmem）等，通常由 native 组件协同（SurfaceFlinger、HWComposer 等）。</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-13"><strong>4.3 与底层 native 进程的关系</strong></h3>
<p>system_server 与一些关键 native 进程（如 <strong>SurfaceFlinger、MediaServer、InputFlinger</strong> 等）之间关系：</p>
<ul>
<li>
<p><strong>通信方式</strong>：</p>
<ul>
<li>Binder（很多 native 服务也注册为 Binder 服务）；</li>
<li>socket（如 media 相关）、shared memory 等。</li>
</ul>
</li>
<li>
<p><strong>职责分工</strong>：</p>
<ul>
<li><code>system_server</code>：<strong>策略 &amp; 管理层</strong>（何时显示、谁在前台、谁有音频焦点）；</li>
<li>native 进程：<strong>高性能数据处理</strong>（渲染、音视频编解码、硬件驱动交互）。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<ul>
<li>WMS（system_server 内） → 控制窗口层级、可见性；</li>
<li>SurfaceFlinger（native） → 根据 WMS 提供的 layer 信息合成最终帧并送到显示设备。</li>
</ul>
<h2 data-id="heading-14">5. <strong>稳定性与安全性</strong></h2>
<h3 data-id="heading-15"><strong>5.1 system_server 崩溃或卡死的影响</strong></h3>
<p><strong>1）崩溃（Crash）</strong></p>
<ul>
<li>
<p>一旦 <code>system_server</code> 发生未捕获异常（如 NPE、RuntimeException），会导致进程立即退出；</p>
</li>
<li>
<p>Android 通常会：</p>
<ul>
<li>记录 tombstone（/data/tombstones/…）；</li>
<li>触发 <strong>framework 重启</strong>（重启 system_server、某些 native 服务，重新拉起桌面等）；</li>
</ul>
</li>
<li>
<p>对用户表现：</p>
<ul>
<li>短暂黑屏/卡顿；</li>
<li>桌面重新加载，当前前台应用大概率被杀重启。</li>
</ul>
</li>
</ul>
<p><strong>2）卡死（ANR / 死锁 / Watchdog）</strong></p>
<ul>
<li>
<p><code>system_server</code> 有一个 <strong>Watchdog 机制</strong>： 定时检测关键线程（尤其是主线程）的响应，如果超过一定时间没有响应，会认为 system_server 卡死。</p>
</li>
<li>
<p>Watchdog 会：</p>
<ul>
<li>打印详细日志和线程堆栈；</li>
<li>通常最终也会选择 <strong>杀死 system_server 以恢复系统</strong>（宁可重启框架，也不能长期卡死）。</li>
</ul>
</li>
</ul>
<p><strong>3）对应用的具体影响</strong></p>
<ul>
<li>
<p>任何依赖 system_server 的 Binder 调用会失败，可能抛：</p>
<ul>
<li><strong><code>DeadSystemException</code></strong> <strong>/</strong> <strong><code>DeadSystemRuntimeException</code></strong>（你前一个 crash 日志中看到的那个）；</li>
</ul>
</li>
<li>
<p>大量应用被动“闪退”或被系统重启。</p>
</li>
</ul>
<h3 data-id="heading-16"><strong>5.2 稳定性保护机制（核心）</strong></h3>
<ol>
<li>
<p><strong>Watchdog -- 独立的监控机制</strong></p>
<ol>
<li>定期检测 AMS、PMS、WMS 等关键服务的响应；</li>
<li>防止 system_server 因死锁或耗时操作“挂住”。</li>
</ol>
</li>
<li>
<p><strong>严格线程/耗时策略</strong></p>
<ol>
<li>对主线程和关键 Binder 线程在代码层面有大量 <code>StrictMode</code>、超时检测；</li>
<li>大部分耗时操作必须放入后台线程。</li>
</ol>
</li>
<li>
<p><strong>OOM / 内存回收策略</strong></p>
<ol>
<li>为 system_server 预留较高的内存优先级；</li>
<li>通过 LMK / lmkd、优先级回收尽量腾出内存给 system_server 和前台 app。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-17"><strong>5.3 安全性</strong></h3>
<p><code>system_server</code> 权限极高，因此安全策略非常严格：</p>
<ol>
<li>
<p><strong>system UID + SELinux 策略</strong></p>
<ol>
<li>运行在 system UID；</li>
<li>SELinux 策略限制其访问范围，避免“全能无管控”。</li>
</ol>
</li>
<li>
<p><strong>权限校验中心</strong></p>
<ol>
<li>大多数权限检查在 system_server 内进行： 例如 <code>Context.checkPermission</code> 最终调用到 AMS/PMS 等服务进行判断。</li>
</ol>
</li>
<li>
<p><strong>签名/包完整性校验</strong></p>
<ol>
<li>应用安装、更新、卸载的签名校验、版本验证、权限变更审核都由 PMS 等服务执行。</li>
</ol>
</li>
<li>
<p><strong>跨进程安全边界</strong></p>
<ol>
<li>通过 Binder 的 caller UID/包名、权限，严格限制 app 能调用的系统操作。</li>
</ol>
</li>
</ol>

<h2 data-id="heading-18">6. <strong>调试与分析 system_server 的方法</strong></h2>
<h3 data-id="heading-19"><strong>6.1 日志与 trace /</strong> <strong>tombstone</strong></h3>
<ol>
<li><strong>logcat 日志</strong></li>
</ol>
<p>常用 tag：</p>
<ul>
<li><strong>ActivityManager</strong>：AMS、进程/Activity 启停、ANR 相关；</li>
<li><strong>SystemServer</strong>：系统服务启动阶段、异常；</li>
<li><strong>Watchdog</strong>：监控到卡死时输出；</li>
<li>各具体服务的 log（WindowManager、PackageManager 等）。</li>
</ul>
<p>常用命令示例：</p>
<pre><code class="hljs language-ruby" lang="ruby">adb logcat -b system -b main -v threadtime <span class="hljs-title class_">ActivityManager</span><span class="hljs-symbol">:System</span> <span class="hljs-title class_">SystemServer</span><span class="hljs-symbol">:System</span> <span class="hljs-title class_">Watchdog</span><span class="hljs-symbol">:System</span> *<span class="hljs-symbol">:S</span>
</code></pre>
<ol start="2">
<li><strong>system_server</strong> <strong>tombstone</strong></li>
</ol>
<ul>
<li>位置：<code>/data/tombstones/tombstone_XX</code></li>
<li>当 <code>system_server</code> 发生 native crash 或被 Watchdog 触发 kill，会在此处留下一份 dump。</li>
<li>可通过：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">adb root
adb pull /data/tombstones/tombstone_XX
</code></pre>
<p>进行分析。里面包含：</p>
<ul>
<li>各线程栈信息；</li>
<li>寄存器、内存快照；</li>
<li>出错信号、地址等。</li>
</ul>
<ol start="3">
<li><strong>ANR traces</strong></li>
</ol>
<ul>
<li>位置：<code>/data/anr/traces.txt</code>（以及可能的分片文件）；</li>
<li>当 system_server 或某应用进程 ANR 时，会在此文件中写入对应时刻所有线程的 stack。</li>
</ul>
<p>常用命令：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">cat</span> /data/anr/traces.txt | grep -n <span class="hljs-string">"system_server"</span> -n
</code></pre>
<h3 data-id="heading-20"><strong>6.2 源码定位与阅读路径</strong></h3>
<p>主要 Java 源码路径（以 AOSP 为例）：</p>
<ul>
<li>
<p><code>frameworks/base/services/java/com/android/server/SystemServer.java</code> → system_server 进程入口、服务启动逻辑（<code>startBootstrapServices/startCoreServices</code>）。</p>
</li>
<li>
<p><code>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code> → Zygote 主入口，<code>startSystemServer()</code> 逻辑。</p>
</li>
<li>
<p>各服务源码举例：</p>
<ul>
<li>AMS：<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></li>
<li>PMS：<code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></li>
<li>WMS：<code>frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</code></li>
<li>PowerManagerService：<code>frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java</code></li>
</ul>
</li>
</ul>
<p>阅读顺序建议：</p>
<ol>
<li>从 <code>ZygoteInit.main()</code> → <code>startSystemServer()</code>；</li>
<li>看 <code>SystemServer.run()</code> → <code>startBootstrapServices()</code>；</li>
<li>根据需要深入具体 service（如 AMS / PMS）。</li>
</ol>
<h3 data-id="heading-21"><strong>6.3 性能与</strong> <strong>行为分析工具</strong></h3>
<ul>
<li><strong>systrace / Perfetto / System Tracing</strong> 用于查看 system_server 在一段时间内的调度、CPU 使用、Binder 调用等。</li>
<li><strong>binder 调用统计</strong>（部分厂商增强） 可以看到哪些进程在频繁调用 system_server、binder 队列堆积情况（你 crash 日志中的 binder buffer info 就是类似信息）。</li>
<li><strong>Debug / StrictMode</strong> 在开发版系统中开启更多调试开关，检测 system_server 内线程的耗时行为。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂 Chrome CRX📦：你需要了解的核心知识点]]></title>    <link>https://juejin.cn/post/7586686861390839859</link>    <guid>https://juejin.cn/post/7586686861390839859</guid>    <pubDate>2025-12-23T07:51:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586686861390839859" data-draft-id="7586584105742090290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂 Chrome CRX📦：你需要了解的核心知识点"/> <meta itemprop="keywords" content="前端,前端工程化"/> <meta itemprop="datePublished" content="2025-12-23T07:51:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Maxkim"/> <meta itemprop="url" content="https://juejin.cn/user/2768993424260451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂 Chrome CRX📦：你需要了解的核心知识点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2768993424260451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Maxkim
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:51:47.000Z" title="Tue Dec 23 2025 07:51:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>大家好!欢迎来到<strong>Maxkim</strong>的技术博客，插件显而易见,像"篡改猴",“Vue Devtools”无处不在，那么如何进行<strong>插件编写</strong>到编写的插件怎么<strong>分发打包</strong>就成了工程化的必学之课，关于插件可以看JustHappy的开源项目，<strong>源码简单，上手难度小</strong> (<a href="https://juejin.cn/post/7585406229167865906" target="_blank" title="https://juejin.cn/post/7585406229167865906">「chrome extensions🛠️」超级简单的浏览器插件Vue开发模板用Vue + JS去开发</a>) ,这里为大家讲解<strong>Crx打包</strong>内容。总结一句话打包就是 <strong>输入-&gt;输出--依靠脚本</strong></p>
</blockquote>
<h2 data-id="heading-0">什么是Chrome下的Crx</h2>
<p>CRX（Chrome Extension）是<strong>Chrome 浏览器扩展程序的官方打包格式</strong>，本质上是一个经过<strong>数字签名</strong>的 ZIP 压缩包，文件后缀为<code>.crx</code>。它包含了实现扩展功能的所有资源：<code>manifest.json</code>配置文件、JavaScript 脚本、CSS 样式、HTML 页面、图片图标等。</p>
<p>基于 Chromium 内核的浏览器均兼容 CRX 格式，这让 CRX 成为跨 Chromium 浏览器扩展开发的主流选择。其核心价值在于<strong>突破网页沙箱限制</strong>，让开发者能调用浏览器底层 API（如标签页管理、网络请求拦截、本地存储操作等），实现普通网页无法完成的功能，比如广告拦截、网页翻译、开发者调试工具等。</p>
<p>目前 CRX 的主流版本是<strong>V3</strong>（Manifest V3），相比 V2 版本，它采用 Service Worker 替代持久化背景脚本、使用声明式网络请求拦截、强化内容安全策略（CSP），在安全性和性能上有显著提升，也是我们开发和打包的重点。</p>
<h2 data-id="heading-1">为什么要Crx打包，直接用不行吗</h2>
<p>直接用，对普通用户门槛高，需要手动开启 <strong>开发者模式</strong>进行导入，其次 <strong>不安全</strong>  ，然后就是 <strong>版本管理难</strong>等问题 于是将开发的插件打包成Crx，就显得<strong>必须且必要</strong>了！</p>
<h2 data-id="heading-2">打包三步骤</h2>
<h3 data-id="heading-3">输入</h3>
<p>首先它是<strong>符合 Chrome 扩展规范的源码目录</strong>（通常命名为<code>src</code>），其核心是围绕<code>manifest.json</code>构建清晰的模块结构，避免直接使用解压目录时的 “文件堆砌” 问题。如下图例子所示</p>
<pre><code class="hljs language-bash" lang="bash">├── assets/           <span class="hljs-comment"># 静态资源输入</span>
│   └── icons/        <span class="hljs-comment"># 扩展图标（严格匹配manifest声明的尺寸）</span>
├── background/       <span class="hljs-comment"># 背景脚本输入（Service Worker）</span>
│   └── index.js      <span class="hljs-comment"># 单一入口，避免多脚本零散分布</span>
├── content/          <span class="hljs-comment"># 内容脚本输入（按功能拆分模块）</span>
│   ├── inject.js     <span class="hljs-comment"># 注入网页的核心逻辑</span>
...
├── popup/            <span class="hljs-comment"># 弹窗页面输入（前端页面资源）</span>
...
└── manifest.json     <span class="hljs-comment"># 核心配置（V3版本，声明所有资源路径）</span>
</code></pre>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147ad6d69f6b4d3caa09488c5ada7bc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=RABW2pwAo0agALlFIFtjOvj3zFY%3D" alt="image.png" loading="lazy"/></p>
--------------------------------------------------------------
<h3 data-id="heading-4">输出</h3>
<p>CRX 的输出<strong>并非单一的.crx文件</strong>，而是通过工程化流程生成<strong>分层的产物</strong>，解决直接用解压目录时 “一份文件既调试又分发” 的矛盾。</p>





























<table><thead><tr><th>输出产物</th><th>生成方式</th><th>用途</th><th>对比直接用解压目录的优势</th></tr></thead><tbody><tr><td><code>dist/unpacked/</code></td><td>复制 / 编译源码后的解压目录</td><td>开发调试</td><td>自动清理冗余文件，保留纯净的可运行代码</td></tr><tr><td><code>dist/crx/</code></td><td>签名后的<code>.crx</code>文件</td><td>生产分发</td><td>标准化压缩包，带数字签名，支持安全分发</td></tr><tr><td><code>dist/zip/</code></td><td>应用店上传的 ZIP 包</td><td>官方发布</td><td>符合 Chrome 应用店规范，无需手动整理文件</td></tr></tbody></table>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90ba4adeb7064ab6a591af070f8ecb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=ilT9z8GSWzAdXuMBLx9NZLD6xwE%3D" alt="image.png" loading="lazy"/></p>
<p>三大优势:
1.<strong>环境隔离</strong>
2.<strong>资源优化</strong>
3.<strong>版本可控</strong></p>
<hr/>
<h3 data-id="heading-5">NPM自定义脚本: 纯原生 CRX 的自动化打包</h3>
<p>纯原生 CRX 指不使用 Webpack、Vite 等构建工具，仅用原生 HTML/CSS/JS 开发的扩展。这类 CRX 的 NPM 脚本核心是实现<strong>资源复制、清理、密钥生成、签名打包</strong>的自动化，其中<strong>密钥</strong>是<code>.crx</code>文件的安全核心，也是替代直接用解压目录的关键。</p>
<h4 data-id="heading-6">1. 先搞懂：CRX 打包中的密钥（<code>key.pem</code>）是什么？</h4>
<p>在 CRX 打包中，<code>key.pem</code>是<strong>RSA 私钥文件</strong>，是 Chrome 扩展签名的核心凭证，其作用和特性如下：</p>
<ul>
<li><strong>数字签名的核心</strong>：<code>crx3</code>工具会通过<code>key.pem</code>对 CRX 包进行加密签名，Chrome 浏览器安装时会验证签名的合法性，若签名失效（如代码被篡改）则拒绝安装。</li>
<li><strong>开发者身份标识</strong>：<code>key.pem</code>是开发者 / 团队的唯一标识，发布到 Chrome 应用店的扩展，后续更新必须使用同一私钥，否则会被视为 “新扩展”。</li>
<li><strong>自动生成与手动管理</strong>：首次执行<code>build:crx</code>脚本时，若项目根目录无<code>key.pem</code>，<code>crx3</code>会自动生成；若已存在，则复用该密钥进行签名。</li>
<li><strong>安全重要性</strong>：丢失<code>key.pem</code>将无法更新已发布的扩展，且无法证明扩展的原始开发者身份，需妥善备份。</li>
</ul>
<h4 data-id="heading-7">2. 纯原生 CRX 的依赖安装</h4>
<p>首先初始化项目并安装打包所需的轻量工具，无需复杂的构建工具：</p>
<pre><code class="hljs language-js" lang="js"># 初始化package.<span class="hljs-property">json</span>（若未初始化）
npm init -y

# 安装核心依赖
# crx3：生成<span class="hljs-variable constant_">V3</span>版本签名的.<span class="hljs-property">crx</span>文件（含密钥生成逻辑）
# copyfiles：自动化复制静态资源
# rimraf：跨平台清理文件/目录（替代rm -rf，兼容<span class="hljs-title class_">Windows</span>）
npm install crx3 copyfiles rimraf --save-dev
</code></pre>
<h4 data-id="heading-8">3. 纯原生 CRX 的 NPM 脚本配置（完善密钥相关逻辑）</h4>
<p>在<code>package.json</code>中定义脚本，新增<strong>密钥备份提示</strong>和<strong>无密钥强制生成</strong>的逻辑，同时保留自动化打包流程：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pure-native-crx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rimraf dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 跨平台清理dist目录，替代手动删除</span>
    <span class="hljs-attr">"copy:static"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/**/* dist/unpacked"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 复制src资源到调试目录</span>
    <span class="hljs-attr">"build:unpacked"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run clean &amp;&amp; npm run copy:static"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成调试用解压目录</span>
    <span class="hljs-attr">"build:crx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/pure-native-crx-v$npm_package_version.crx -p key.pem &amp;&amp; echo '密钥文件为key.pem，请注意备份！'"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成签名.crx并提示备份密钥</span>
    <span class="hljs-attr">"build:crx:newkey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/pure-native-crx-v$npm_package_version.crx -p new-key.pem"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成新密钥的.crx（用于测试）</span>
    <span class="hljs-attr">"build:zip"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/zip/pure-native-crx-v$npm_package_version.zip --zip"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成应用店ZIP包</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build:unpacked &amp;&amp; npm run build:crx &amp;&amp; npm run build:zip"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 一键生成所有产物</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/**/* dist/unpacked --watch"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开发热更：监听src变化自动同步到调试目录</span>
    <span class="hljs-attr">"backup:key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copy key.pem backups/key-v$npm_package_version.pem &amp;&amp; echo '密钥已备份到backups/目录！'"</span> <span class="hljs-comment">// 密钥备份脚本</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">4. 纯原生脚本的使用说明（含密钥操作）</h4>


















































<table><thead><tr><th>脚本命令</th><th>功能说明</th><th>密钥相关细节</th></tr></thead><tbody><tr><td><code>npm run clean</code></td><td>清空 dist 目录，避免旧产物干扰</td><td>不涉及密钥</td></tr><tr><td><code>npm run build:unpacked</code></td><td>生成纯净的调试用解压目录<code>dist/unpacked/</code>，可直接导入 Chrome 开发者模式</td><td>不涉及密钥</td></tr><tr><td><code>npm run build:crx</code></td><td>基于调试目录生成带数字签名的<code>.crx</code>文件，存放在<code>dist/crx/</code></td><td>首次执行自动生成<code>key.pem</code>；后续执行复用该密钥，保证签名一致性</td></tr><tr><td><code>npm run build:crx:newkey</code></td><td>生成使用新密钥<code>new-key.pem</code>的<code>.crx</code>文件（仅用于测试）</td><td>生成新的<code>new-key.pem</code>，与原<code>key.pem</code>无关联，不可用于正式扩展更新</td></tr><tr><td><code>npm run build:zip</code></td><td>生成符合 Chrome 应用店要求的 ZIP 包，存放在<code>dist/zip/</code></td><td>基于<code>key.pem</code>的签名逻辑生成，但 ZIP 包本身无签名（应用店会重新签名）</td></tr><tr><td><code>npm run build</code></td><td>一键执行 “清理→复制资源→生成调试目录→签名打包.crx→生成应用店 ZIP” 全流程</td><td>核心流程中自动处理密钥生成 / 复用，同时提示备份</td></tr><tr><td><code>npm run dev</code></td><td>监听 src 目录文件变化，自动同步到调试目录，修改代码后无需手动重新导入扩展</td><td>不涉及密钥</td></tr><tr><td><code>npm run backup:key</code></td><td>将<code>key.pem</code>备份到<code>backups/</code>目录并按版本号命名</td><td>避免密钥丢失，保障扩展后续更新的合法性</td></tr></tbody></table>
<h4 data-id="heading-10">5. 密钥的生成与管理实操</h4>
<h5 data-id="heading-11">（1）首次生成密钥</h5>
<p>执行<code>npm run build:crx</code>后，控制台会输出类似日志：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Generated <span class="hljs-keyword">private</span> <span class="hljs-keyword">key</span>: <span class="hljs-keyword">key</span>.pem
Packed dist/unpacked <span class="hljs-keyword">to</span> dist/crx/pure-native-crx-v1.<span class="hljs-number">2.0</span>.crx
密钥文件为<span class="hljs-keyword">key</span>.pem，请注意备份！
</code></pre>
<p>此时项目根目录会出现<code>key.pem</code>文件，这是该扩展的唯一私钥，需立即执行<code>npm run backup:key</code>备份到<code>backups/</code>目录。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0530c600748c4fa7977a7cffd4a11887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=ttGHCe94kVIBfxJ01SHH5kgEQR4%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-12">（2）复用密钥打包</h5>
<p>后续再次执行<code>npm run build:crx</code>时，<code>crx3</code>会自动读取项目根目录的<code>key.pem</code>，用同一密钥签名新版本的<code>.crx</code>文件，保证 Chrome 识别为 “同一扩展的更新”。</p>
<h5 data-id="heading-13">（3）密钥丢失的影响</h5>
<p>若<code>key.pem</code>丢失，再次执行<code>build:crx</code>会生成新的<code>key.pem</code>，此时：</p>
<ul>
<li>旧版本扩展无法通过新<code>.crx</code>更新，用户需手动卸载旧版本再安装新版本；</li>
<li>若扩展已发布到 Chrome 应用店，将无法用新密钥提交更新，只能重新发布为新扩展。</li>
</ul>
<h4 data-id="heading-14">6. 纯原生脚本的核心价值</h4>
<ul>
<li><strong>跨平台兼容</strong>：使用<code>rimraf</code>替代<code>rm -rf</code>，<code>copyfiles</code>替代手动复制，解决 Windows 与 Mac/Linux 的命令行差异问题。</li>
<li><strong>零构建工具依赖</strong>：仅用轻量工具实现自动化，适合纯原生 CRX 的简单开发场景，避免引入 Webpack 带来的配置复杂度。</li>
<li><strong>版本自动关联</strong>：通过<code>$npm_package_version</code>将<code>package.json</code>中的版本号自动写入<code>.crx</code>文件名，替代直接用解压目录时的手动命名。</li>
<li><strong>密钥自动化管理</strong>：首次打包自动生成密钥，新增备份脚本，解决直接用解压目录的安全与更新问题。</li>
<li><strong>开发提效</strong>：<code>npm run dev</code>实现源码热更新，修改代码后 Chrome 会自动检测扩展变化并重新加载，无需手动点击 “刷新扩展”。</li>
</ul>
<h3 data-id="heading-15">结合 Webpack 的 NPM 脚本（复杂 CRX 场景）</h3>
<p><em>小小Maxkim对Webpack理解有限，这里只是一些理论上可行的方案</em></p>
<p>对于引入 Vue/React、包含大量第三方库的复杂 CRX，需结合 Webpack 实现代码编译、压缩优化，其 NPM 脚本在纯原生基础上增加构建环节，<strong>密钥的使用逻辑与纯原生一致</strong>（复用<code>key.pem</code>签名）：</p>
<h4 data-id="heading-16">1. 安装 Webpack 相关依赖</h4>
<pre><code class="hljs language-js" lang="js"># 安装<span class="hljs-title class_">Webpack</span>及优化插件
npm install webpack webpack-cli clean-webpack-plugin terser-webpack-plugin css-minimizer-webpack-plugin --save-dev
</code></pre>
<h4 data-id="heading-17">2. 混合开发的 NPM 脚本配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack-crx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rimraf dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:compile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --config webpack.config.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Webpack编译/优化源码</span>
    <span class="hljs-attr">"copy:static"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/manifest.json src/assets/**/* dist/unpacked"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 复制非编译资源</span>
    <span class="hljs-attr">"build:unpacked"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run clean &amp;&amp; npm run build:compile &amp;&amp; npm run copy:static"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:crx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/webpack-crx-v$npm_package_version.crx -p key.pem &amp;&amp; echo '密钥文件为key.pem，请注意备份！'"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:zip"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/zip/webpack-crx-v$npm_package_version.zip --zip"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build:unpacked &amp;&amp; npm run build:crx &amp;&amp; npm run build:zip"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --watch --config webpack.config.js &amp; copyfiles -u 1 src/**/* dist/unpacked --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backup:key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copy key.pem backups/key-v$npm_package_version.pem &amp;&amp; echo '密钥已备份到backups/目录！'"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-18">基于输入输出的性能优化：从体积到性能</h3>
<p>直接使用解压目录时，源码中的冗余代码、未压缩的资源会导致 CRX 体积大、加载慢，而通过工程化流程，可在<strong>输入处理</strong>和<strong>输出构建</strong>阶段做针对性优化。</p>
<h4 data-id="heading-19">1. 输入阶段：源码层面的轻量化优化（纯原生 / 工程化通用）</h4>
<p>在标准化输入目录的基础上，从源码源头减少冗余：</p>
<ul>
<li><strong>按需拆分模块</strong>：将 content 脚本按功能拆分为多个子模块，仅在需要时注入（如<code>chrome.scripting.executeScript</code>动态注入），而非一次性加载所有代码。</li>
<li><strong>剔除冗余资源</strong>：输入目录中仅保留必要的静态资源（如只保留 16/48/128px 的图标），删除开发日志、测试文件等无关内容。</li>
<li><strong>使用原生 API 替代第三方库</strong>：纯原生 CRX 中，用原生<code>fetch</code>替代<code>axios</code>，用原生数组方法替代<code>lodash</code>，减少第三方库的体积引入。</li>
</ul>
<h4 data-id="heading-20">2. 输出阶段：纯原生 CRX 的轻量优化</h4>
<p>纯原生 CRX 无需编译，可通过简单手段优化输出产物，同时不影响密钥签名逻辑：</p>
<ul>
<li><strong>手动压缩静态资源</strong>：使用在线工具压缩图片（如 TinyPNG）、CSS/JS（如 Terser 在线版），将压缩后的文件放入<code>dist/unpacked/</code>，再执行<code>build:crx</code>签名，体积优化后不影响签名合法性。</li>
<li><strong>删除注释与空白</strong>：手动剔除 JS/CSS 中的注释、多余空白，减少文件体积（小型 CRX 效果显著）。</li>
<li><strong>资源内联</strong>：将小图标转为 Base64 编码，直接写入 CSS/HTML 中，减少 CRX 的文件数量，避免注入时的资源请求。</li>
</ul>
<h4 data-id="heading-21">3. 输出阶段：工程化 CRX 的深度优化（Webpack）</h4>
<p>通过 Webpack 配置实现自动化优化，解决纯原生手动优化的低效问题，且优化后的产物仍可通过<code>key.pem</code>正常签名：这里就不过多阐述啦，感兴趣的可以沿着以下三个方向去查阅相关资料。</p>
<h5 data-id="heading-22">（1）代码压缩与混淆</h5>
<h5 data-id="heading-23">（2）Tree Shaking 剔除无用代码</h5>
<h5 data-id="heading-24">（3）静态资源优化</h5>
<h3 data-id="heading-25">对比直接用解压目录：工程化流程的核心优势（含密钥安全维度）</h3>















































<table><thead><tr><th>维度</th><th>直接使用解压目录</th><th>纯原生 CRX 工程化（NPM 脚本 + 密钥）</th><th>工程化 CRX（Webpack+NPM + 密钥）</th></tr></thead><tbody><tr><td><strong>资源管理</strong></td><td>文件结构混乱，路径易出错</td><td>标准化输入输出，路径可控</td><td>模块化设计，解耦性强</td></tr><tr><td><strong>操作效率</strong></td><td>手动复制 / 修改 / 签名，效率极低</td><td>一键自动化，跨平台兼容</td><td>编译 + 打包 + 签名一键完成</td></tr><tr><td><strong>版本管理</strong></td><td>无版本标识，易混淆</td><td>版本号自动关联产物名</td><td>版本追溯清晰，可集成 CI/CD</td></tr><tr><td><strong>性能表现</strong></td><td>源码未优化，体积大、加载慢</td><td>轻量手动优化，体积小幅缩减</td><td>代码压缩 + Tree Shaking，性能优异</td></tr><tr><td><strong>安全与分发</strong></td><td>源码暴露，易被篡改，无更新保障</td><td>带签名的.crx，防篡改，密钥保障更新</td><td>代码混淆 + 签名，安全级别更高</td></tr><tr><td><strong>密钥管理</strong></td><td>无密钥概念，无法证明开发者身份</td><td>自动生成 + 备份脚本，管理规范</td><td>复用密钥，支持规模化发布</td></tr></tbody></table>
<h3 data-id="heading-26">总结</h3>
<p>直接使用解压目录仅能满足 CRX 的调试需求，而通过<strong>标准化输入输出</strong>规范资源结构，<strong>NPM 自定义脚本</strong>实现纯原生 / 工程化的自动化打包（含密钥的生成、复用与备份），再结合性能优化手段，才能让 CRX 成为可分发、高性能且安全的产品。</p>
<p>其中，<strong>密钥（<code>key.pem</code>）</strong> 是 CRX 从 “调试原型” 走向 “生产分发” 的安全核心，解决了直接用解压目录的篡改与更新问题；而<strong>NPM脚本</strong>则将密钥管理、资源复制、签名打包等流程<strong>自动化</strong>，大幅提升开发效率。对于简单的纯原生 CRX，轻量的 NPM 脚本 + 密钥管理即可满足需求；对于复杂 CRX，结合 Webpack 的工程化流程则能实现深度的性能优化，且全程复用密钥保障扩展的合法性。
总而言之，打包就是要明白<strong>输入</strong>是什么， <strong>输出</strong>有什么，<strong>输入到输出</strong>发生了什么！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>