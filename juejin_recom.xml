<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[第5章 Nest.js精进-IOC控制反转]]></title>    <link>https://juejin.cn/post/7590684822727000104</link>    <guid>https://juejin.cn/post/7590684822727000104</guid>    <pubDate>2026-01-04T04:15:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590684822727000104" data-draft-id="7590778284758597667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第5章 Nest.js精进-IOC控制反转"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-04T04:15:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XiaoYu2002"/> <meta itemprop="url" content="https://juejin.cn/user/251124329220663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第5章 Nest.js精进-IOC控制反转
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/251124329220663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XiaoYu2002
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T04:15:10.000Z" title="Sun Jan 04 2026 04:15:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在本章，会继续精进Nest.js，首先会学习IOC控制反转，这是一种设计思想，把对象的创建和依赖关系交给容器管理，而不是手动创建和管理。</p>
<ul>
<li>传统方式：手动创建new A()，new B()。</li>
<li>IOC方式：需求由容器解决。</li>
</ul>
<p>现在我有A类和B类两个类，A类中有getName()实例方法，我若想在B类中调用A类的getName()实例方法，那么传统方式需要我们在B类中去手动实例化A类，然后再从实例对象中调用getName()实例方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'A'</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 手动实例化</span>
    <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-title function_">getName</span>())
  }
}
</code></pre>
<p>那么，在B类中手动实例化A类并调用对应实例方法的行为是会导致两个类产生高度耦合的关系，假设我再次手动实例化B类，会导致依赖关系混乱与维护困难，例如无法对A进行模拟或者替换；每个A实例状态都独立，难以统一管理；还有存在内存泄漏等风险。</p>
<p>IOC控制反转就是为了解决上述的高度耦合问题，即对A类与B类之间的关系进行解耦。</p>
<p>首先我们需要创建一个Container类，在Container类中存放所有实例化的操作，然后其余类如果需要相关类的实例化从而调用对应的方法，就由Container类来分配。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'A依赖注入生效'</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> {

}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span>{
  <span class="hljs-comment">// 存储所有需要的实例化操作</span>
}
</code></pre>
<p>那么，在Container类（容器）中要如何存储实例化操作？这需要依赖第三方库reflect-metadata，通过npm命令下载。</p>
<pre><code class="hljs language-ts" lang="ts">npm install reflect-metadata
</code></pre>
<p>当我们在该文件中导入第三方库reflect-metadata之后，可以使用Reflect.getMetadata()静态方法。需要说明的是，Reflect标准内置对象中并没有getMetadata()静态方法，因此这个静态方法不是原生，而是来自第三方库reflect-metadata。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span> {
  <span class="hljs-keyword">private</span> providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;()

  <span class="hljs-title function_">get</span>(<span class="hljs-params">clsz: <span class="hljs-keyword">new</span> (...args: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> paramsTypes = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'design:paramtypes'</span>, clsz)
  }
}
</code></pre>
<p>直接使用Reflect.getMetadata()静态方法是没有效果的，我们还要在需要依赖的类上，添加一个@Injectable()装饰器。</p>
<p>装饰器是一个特殊的函数，使用方式是放在类的头上。例如：现在我创建一个Injectable函数，然后使用在A类上。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 装饰器本质上是一个函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Injectable</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Injectable装饰器读取到：'</span>,target)
    <span class="hljs-keyword">return</span> target
  }
}
<span class="hljs-comment">// 使用 @ 符号应用装饰器</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'A依赖注入生效'</span>
  }
}
</code></pre>
<p>装饰器的执行时机是在编译时，即运行文件的时候就自动调用，因此当我执行index.ts文件时，Injectable函数就会调用，并且打印出读取到的A类信息，如图5-1所示。使用装饰器的好处是什么？是可以在不破坏A类代码本身的结构基础上，对A类进行额外的拓展。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74d0fbc9e81f420bbb656cff6eb404c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104910&amp;x-signature=zbbSAklrIc9cHVoheunSZFyeZE0%3D" alt="image-20251214022250976" loading="lazy"/></p>
<p align="center">
 <b> 图5-1 装饰器的基础使用</b>
</p>
<p>当我们所使用的Injectable函数处于以下两种情况之一时，会被称为装饰器：</p>
<p>（1）被用于装饰器模式，即可以附加到类、方法、属性等上，以修改或增强其行为。</p>
<p>（2）或者该函数符合装饰器的调用签名，即它接受一个目标对象（根据装饰的对象类型不同，参数也不同）并可能返回一个新的描述符或修改后的目标。</p>
<p>而Injectable装饰器既然可以读取到A类，那么就可以在A类的原型链上添加新的实例方法。例如以下操作：使用Injectable装饰器对A类添加一个getName2的实例方法并调用执行。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Injectable</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    target.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getName2</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'getName2'</span>
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(target.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-title function_">getName2</span>())
    <span class="hljs-keyword">return</span> target
  }
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'A依赖注入生效'</span>
  }
}
</code></pre>
<p>装饰器的方法使用如图5-2所示，可以在装饰器上添加方法并使用，若需要参数，还可以从@Injectable()的实参位置传入。</p>
<p><img src="http://tuchuang.xiaoyu2002.cn/picture/image-20251214023354655.png" alt="image-20251214023354655" loading="lazy"/></p>
<p align="center">
 <b> 图5-2 装饰器的方法使用</b>
</p>
<p>但装饰器存在一个问题，若Injectable装饰器的方法和A类中的方法名称一样，就会出现Injectable装饰器方法覆盖A类实例方法的问题。因为装饰器在编译时执行，则先执行装饰器代码实现原型链覆盖并执行getName()方法，而后调用实例对象a的getName()方法，因此执行两次装饰器中的getName()方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Injectable</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    target.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getName</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'getName2'</span>
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(target.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-title function_">getName</span>())
    <span class="hljs-keyword">return</span> target
  }
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'A依赖注入生效'</span>
  }
}

<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-title function_">getName</span>())
<span class="hljs-comment">// getName2</span>
<span class="hljs-comment">// getName2</span>
</code></pre>
<p>为了解决装饰器覆盖原方法的问题，TypeScript推出了元编程的概念，它希望我们避免直接修改原型。解决方案是使用元数据反射（Reflect Metadata）来实现元编程。而元数据反射的底层确实使用了WeakMap来存储元数据，这样可以避免内存泄漏（弱引用），并且不会直接影响对象的原型链。</p>
<p>那么什么是元数据反射？元数据反射是一种在对象上添加元数据（关于数据的数据）的方式，这些元数据不会直接成为对象的一部分，而是存储在独立的WeakMap中。这样，我们可以给对象附加额外的信息，而不改变其结构。</p>
<p>那么如何使用元数据反射？即通过Reflect.getMetadata('design:paramtypes', clazz)静态方法（需要安装第三方库）。</p>
<p>首先要说明Reflect.getMetadata('design:paramtypes', clazz)静态方法有两个参数，其中参数1有三个内置选项：</p>
<p>（1）design:paramtypes 获取构造函数的参数类型。</p>
<p>（2）design:returntype 获取构造函数的返回类型。</p>
<p>（3）design:type 获取构造函数的类型。</p>
<p>第1个参数是一个固定的字符串，字符串可以有以上三种内置选项，或者自定义也可以。</p>
<p>第2个参数是目标类，我们要读取哪个哪个类的元数据。因此说如果不在目标类上使用装饰器的话，Reflect.getMetadata()静态方法就没有目标类可以读取元数据，自然是无法生效的。</p>
<p>我们来使用一下元数据反射，以下要做的需求：</p>
<ul>
<li>通过元数据反射，在B类中使用A类的实例方法。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// tsconfig.json中打开这两个选项，从而实现Reflect.getMetadata()静态方法的使用</span>
<span class="hljs-string">"experimentalDecorators"</span>: <span class="hljs-literal">true</span>
<span class="hljs-string">"emitDecoratorMetadata"</span>: <span class="hljs-literal">true</span>
</code></pre>
<p>思路是很清晰的，我们通过design:paramtypes获取构造函数的参数类型来实现。步骤如下：</p>
<p>（1）在A类与B类使用装饰器，而装饰器执行时，TypeScript会生成元数据。</p>
<p>（2）在容器中读取类的构造函数参数类型信息（拿到类本身）。</p>
<p>（3）拿到类之后，通过类创建实例对象完成了依赖注入，塞到Map的键值对里，键是被读取的类，值是被读取类中的构造函数参数类型的实例对象。</p>
<p>在B类的构造函数中设置一个参数，该参数的类型是A类，装饰器被应用，TypeScript编译器为被装饰B类生成元数据，我们通过Reflect.getMetadata()静态方法配合第一个参数design:paramtypes可以从B类读取到构造函数的参数a的类型A类，当装饰器读取到A类后，通过A类创建实例对象instance，然后和B类一起存到providers中。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 完整IOC控制反转实现</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Injectable</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">target: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> target
  }
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'A依赖注入生效'</span>
  }
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> a: A</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>.<span class="hljs-title function_">getName</span>())
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span> {
  <span class="hljs-keyword">private</span> providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;()

  <span class="hljs-title function_">get</span>(<span class="hljs-params">clsz: <span class="hljs-keyword">new</span> (...args: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> parmsTypes = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'design:paramtypes'</span>, clsz) || []
    <span class="hljs-comment">// 递归创建实例对象，完成了依赖注入</span>
    <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title function_">clsz</span>(...parmsTypes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)))
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">providers</span>.<span class="hljs-title function_">set</span>(clsz, instance)
    <span class="hljs-keyword">return</span> instance
  }
}

<span class="hljs-keyword">const</span> container = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Container</span>()
<span class="hljs-comment">// 多次请求B类，会直接从providers中返回缓存的实例</span>
container.<span class="hljs-title function_">get</span>(B)
</code></pre>
<p>其实当我们完成递归创建实例对象之后，B类就能够调用A类的getName()实例方法了。因为做到了B实例的a属性现在指向A实例。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 当调用 container.get(B) 时：</span>

<span class="hljs-comment">// 1. 创建 A 实例</span>
<span class="hljs-keyword">const</span> aInstance = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();
<span class="hljs-comment">// aInstance 是 A 类的一个具体实例，有 getName() 方法</span>

<span class="hljs-comment">// 2. 创建 B 实例并注入</span>
<span class="hljs-keyword">const</span> bInstance = <span class="hljs-keyword">new</span> <span class="hljs-title function_">B</span>(aInstance);  <span class="hljs-comment">// aInstance 作为参数传递</span>

<span class="hljs-comment">// 3. B 构造函数内部执行</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> {
  <span class="hljs-comment">// TypeScript 语法糖展开为：</span>
  <span class="hljs-comment">// constructor(a: A) {</span>
  <span class="hljs-comment">//   this.a = a;  // this.a 被赋值为传入的 aInstance</span>
  <span class="hljs-comment">// }</span>
  
  <span class="hljs-comment">// 所以实际上：</span>
  <span class="hljs-comment">// this.a = aInstance</span>
  
  <span class="hljs-comment">// 因此：</span>
  <span class="hljs-comment">// this.a.getName() 等于 aInstance.getName()</span>
}
</code></pre>
<p>通过@Injectable()装饰器，TypeScript在编译时为B类记录了构造函数参数类型（A类）。在运行时，依赖注入容器读取这些元数据，递归创建A类的实例，并将其注入到B类的构造函数中。因此，B类的实例可以通过 this.a.getName() 访问A类的实例方法。</p>
<p>后续将实例对象放入providers（Map数据结构）中是利用Map结构的键唯一特性，当我们第一次请求B类时，容器会创建B类的实例，并且发现B类 依赖A类，于是先创建或获取A类的实例，然后将B类和其实例存入providers。下次再请求B类时，就直接从providers中返回缓存的实例，而不会再次创建。</p>
<p>接下来，我们来优化一下容器注入，假如有多个不同类（B类、B1类、B2类、B3类）同时注入了A类，那么这会不断的重复注入到Map中，因为Map结构只保证Key唯一。这就没有必要，因此我们可以在最前面加一个判断，如果在Map中已经存在注入的类（例如A类），那么我们就直接返回注入的类就行。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span> {
  <span class="hljs-keyword">private</span> providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()

  <span class="hljs-title function_">get</span>(<span class="hljs-params">clsz: <span class="hljs-keyword">new</span> (...args: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-comment">// 优化：防止注入重复</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">providers</span>.<span class="hljs-title function_">has</span>(clsz)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">providers</span>.<span class="hljs-title function_">get</span>(clsz)
    }
    <span class="hljs-keyword">const</span> parmsTypes = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'design:paramtypes'</span>, clsz) || []
    <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title function_">clsz</span>(...parmsTypes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)))
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">providers</span>.<span class="hljs-title function_">set</span>(clsz, instance)
    <span class="hljs-keyword">return</span> instance
  }
}
</code></pre>
<p>以上就是IOC控制反转实现的全过程，最核心和精彩的代码就以下这条：完成了拆解高耦合依赖的工作。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title function_">clsz</span>(...parmsTypes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)))
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[适合很多公司和团队的 AI Coding 落地范式（二）]]></title>    <link>https://juejin.cn/post/7591085154977251354</link>    <guid>https://juejin.cn/post/7591085154977251354</guid>    <pubDate>2026-01-04T04:14:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591085154977251354" data-draft-id="7590958028477923374" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="适合很多公司和团队的 AI Coding 落地范式（二）"/> <meta itemprop="keywords" content="前端,AI编程,AIGC"/> <meta itemprop="datePublished" content="2026-01-04T04:14:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LV技术派"/> <meta itemprop="url" content="https://juejin.cn/user/2013961035453927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            适合很多公司和团队的 AI Coding 落地范式（二）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961035453927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LV技术派
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T04:14:16.000Z" title="Sun Jan 04 2026 04:14:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>大家好，我是 lv。</p>
<p>上一篇文章，我们聊了市面上不同 AI Coding 产品的分类、侧重点、优缺点以及面向的人群。</p>
<p>「<a href="https://juejin.cn/post/7584714813365747750" target="_blank" title="https://juejin.cn/post/7584714813365747750">适合很多公司和团队的 AI Coding 落地范式（一）</a>」</p>
<p>接下来，我们将从上一篇提到的<strong>两种产品形态（AI Coding 平台类 &amp; AI Coding 基建类）</strong> 来分别探讨适合很多公司和团队的 <strong>两种 AI Coding 落地范式</strong>：</p>
<ul>
<li>
<p>AI Coding 平台工程化</p>
</li>
<li>
<p>AI Coding 基建工程化</p>
</li>
</ul>
<p>不多说，开整～</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.iamlv.cn%2Fme.html" target="_blank" title="https://ai.iamlv.cn/me.html" ref="nofollow noopener noreferrer">欢迎加入最懂 AI 的前端伙伴们群</a></p>
<h2 data-id="heading-0">针对 AI Coding 平台的落地范式</h2>
<p>市面上的 AI Coding 平台类产品很多，如 V0、Bolt New、Lovable 等。</p>
<p>这种产品面向的人群大部分都是非程序员，如产品经理、设计师、运营等。</p>
<p>在一个公司和团队内部，我发现大家使用这种产品的主要方式有<strong>三种</strong></p>
<h2 data-id="heading-1">AI Coding 平台使用现状分析</h2>
<p><strong>第一种方式</strong>: 产品经理基于 Figma Make 或者 V0 出产品可交互性的原型，主要用来进行需求评审、设计评审、开发评审等，下游还是设计师参考原型进行设计稿的产出。</p>
<p>这种使用方式其实本质上是产品经理自身能力的补充或者说针对产品经理本职工作的提效，当然这种 AI Coding 平台产出的 <strong>可交互式原型</strong> 相比较于传统的产品原型，可以传递给团队的信息量也会更丰富。</p>
<p>这种方式，在任何公司和团队内部都可以进行尝试，因为它并没有改变原有的工作流程，只是针对产品经理的工作流进行了一定程度的优化。</p>
<p><strong>第二种方式</strong>: 需求方（产品、设计师、运营人员）基于 Figma Make 或者 V0 出产品可交互性的原型，满足需求就直接发给开发人员，开发人员基于原型再转成成符合公司规范（技术栈、代码规范等）的代码。</p>
<p>这种使用方式有点意思了，从 AI Coding 平台生成可交互原型 -&gt; 程序员基于原型进行代码的开发。</p>
<p>相当于把常规的：<strong>产品 -&gt; 设计师 -&gt; 程序员</strong> 的岗位职责进行了<strong>一定程度</strong>的合并。</p>
<p>产品和设计师合并在了一起，我就暂且叫做 <strong>Product Designer</strong>，简称 PD。</p>
<p><strong>第三种方式</strong>: 需求方（不特指产品经理，可能也是设计师、运营，甚至技术人员等）使用 V0 快速生成一个产品的 MVP，也可以迅速通过 Vercel 平台进行上线。</p>
<p>这种方式对于跟时间赛跑，需要快速验证需求、获得市场反馈的场景来说，倒是挺合适的，当然也仅限于 MVP 验证阶段，对于需要进行长期迭代的项目来说，这种方案可能就不太合适了。</p>
<p>这里的需求方，可以叫做：<strong>Product Design Engineer</strong>，简称 PDE，Design 和 Engineer 的能力其实是 AI Coding 平台赋予的。</p>
<p>好，先踩一脚，我们来总结一下这三种 AI Coding 平台的使用方式：</p>
<p>第一种，相当于是针对产品经理本身能力的<strong>补充</strong>，相当于是针对现有产品研发流程中单个角色的提效，但并没有改变原有的产品研发流程。</p>
<p>第二种是需求方使用 AI Coding 平台完完成可交互原型的输出，这个可交互的原型可以直接交付给程序员，相当于把 Product 和 Designer 的岗位合并在了一起，叫做 Product Designer，简称 PD。</p>
<p>第三种是需求方直接使用 AI Coding 平台完成了产品研发的全流程，相当于把 Product、Designer、Engineer 的岗位合并在了一起，叫做 Product Design Engineer，简称 PDE，这是对整体产品研发流程的重塑，但是注意，这种场景仅限于 MVP 验证阶段。</p>
<p>从第一种 -&gt; 第二种 -&gt; 第三种，其实对应了从单个角色的提效 -&gt; 部分研发流程的合并 -&gt; 整体产品研发流程的重塑。</p>
<p>这三种使用方式，大家可以根据自己公司或团队的实际情况，进行选择。</p>
<p>我们回到看似最牛逼的<strong>第三种使用方式</strong>，我们再思考一下：</p>
<p>第三种使用方式尽管是对整体产品研发流程的重塑，但也仅适用于 MVP 验证阶段，能否在长期迭代的项目中使用呢？</p>
<p><strong>有些场景能</strong>，我们接着往下聊。</p>
<h2 data-id="heading-2">AI Coding 平台工程化</h2>
<p>作为长期迭代的项目来说，势必需要人工的参与，其实最核心的点是：如何保证<strong>人工介入的场景下，代码的可维护性</strong>，包括：</p>
<ul>
<li>
<p>契合团队项目技术栈，比如说 nextjs、react、vue、antd、shadcn、tailwindcss、私有组件库等，大家都能看懂，并且能够快速上手。</p>
</li>
<li>
<p>代码结构规范，比如说组件的文件结构、代码风格等，按照大家日常的开发习惯来。</p>
</li>
<li>
<p>...</p>
</li>
</ul>
<p>那我们的重点，其实就是能够基于 AI Coding 平台，生成符合团队项目技术栈、代码结构规范的代码，从而能够保证代码的可维护性。</p>
<p>我把这个工作叫做 <strong>AI Coding 平台工程化</strong>。</p>
<p>市面上的 AI Coding 平台，受限于定制化能力（定制符合团队项目技术栈、代码结构规范的代码生成器），私有化能力（在公司内部私有化部署）等。</p>
<p>因此，新轮子来了：Compoder，它代表的就是 AI Coding 平台工程化的产物。</p>
<blockquote>
<p>Compoder 是一个 AI 驱动的组件代码生成引擎，可以基于它定制基于特定技术栈（React、Vue、开源组件库、私有组件库）、特定业务场景（landing page 等）的组件代码生成器。</p>
<p>详见: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIamLiuLv%2Fcompoder" target="_blank" title="https://github.com/IamLiuLv/compoder" ref="nofollow noopener noreferrer">github.com/IamLiuLv/co…</a></p>
</blockquote>
<p>先上案例：Lading Page Codegen（Code Generator）</p>
<p>这个 Code Generator 能够针对用户的需求使用 Nextjs、PageUI（一个构建 LandingPage 的组件库，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdanmindru%2Fpage-ui%25EF%25BC%2589" target="_blank" title="https://github.com/danmindru/page-ui%EF%BC%89" ref="nofollow noopener noreferrer">github.com/danmindru/p…</a> 来生成对应的 Landing Page 代码。</p>
<p>我们使用 Compoder，可以定制这个 Lading Page Codegen 的代码生成规则，从而能够保证代码的可维护性。</p>
<ul>
<li>技术栈定制，如私有组件库定制（pageui 不是很出名，llm 不包含其知识，相当于是 <strong>私有组件库</strong> 场景）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70b26c6fbb9f49389ba43a4a08912223~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFbmioDmnK_mtL4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104855&amp;x-signature=TrG5NaXd2vSOB00JIsjGsouNIQE%3D" alt="" loading="lazy"/></p>
<ul>
<li>代码规范定制，如组件的文件结构、代码风格等</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9773df90135143f3a883bd771057701e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFbmioDmnK_mtL4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104855&amp;x-signature=fdKMf941BInW4qxxKiXP9mW6zeI%3D" alt="" loading="lazy"/></p>
<p>最终效果，我们从用户的使用视角来看：</p>
<ol>
<li>进入刚刚定制好的 Landing Page Codegen，输入需求，选择合适的模型。</li>
</ol>
<p>需求是把 Compoder 的 Readme 给了过去（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FIamLiuLv%2Fcompoder%2Fblob%2Fmain%2FREADME.md%25EF%25BC%2589%25EF%25BC%258C" target="_blank" title="https://github.com/IamLiuLv/compoder/blob/main/README.md%EF%BC%89%EF%BC%8C" ref="nofollow noopener noreferrer">github.com/IamLiuLv/co…</a> 生成 Compoder 本身的 Landing Page 代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1c415e321984ed3b5bfa034d9114b58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFbmioDmnK_mtL4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104855&amp;x-signature=Mq0Ym%2F8uGfnjpadvcTd2A%2FTV%2BLM%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>等待代码生成完成，在线查看效果。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6058d75f1ddd46ef902ecb2925ed8df9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFbmioDmnK_mtL4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104855&amp;x-signature=qArttWKZCPbl0OEa3QxrH6aD9nU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c520a4039244346a217ac33707b9735~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFbmioDmnK_mtL4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104855&amp;x-signature=UJitc31RKQ7aMPh2I4wrYk6biUg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f2e648c98024113ad78e4372ee157ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFbmioDmnK_mtL4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104855&amp;x-signature=B6LDdcy%2FmFSXxor9sD7bHk3zedQ%3D" alt="" loading="lazy"/></p>
<p>从用户的使用角度来看，本身不需要关心代码的生成原理，只需要关心效果是否满意即可，其他的代码生成细节，都交给了 Compoder（AI Coding 平台工程化的产物） 内部来实现。</p>
<p>至于 Compoder 内部实现原理，涉及到很多前端 + AI 相关的知识点，比如 Prompt 设计、Workflow 设计、RAG 理念，怎么基于私有组件生成代码等，怎么实现代码渲染器等等。</p>
<p>本篇就不展开讲了，想深入学习的同学可以看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.iamkasong.com%2Fdocs%2F%25E7%25AC%25AC%252029%2520%25E8%25AF%25BE%2520%25E5%25AE%259E%25E6%2588%2598%25E4%25BA%258C%2520Compoder%2520%25E9%25A1%25B9%25E7%259B%25AE%25E4%25BB%258B%25E7%25BB%258D.html" target="_blank" title="https://doc.iamkasong.com/docs/%E7%AC%AC%2029%20%E8%AF%BE%20%E5%AE%9E%E6%88%98%E4%BA%8C%20Compoder%20%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D.html" ref="nofollow noopener noreferrer">Compoder 项目介绍</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d52e59823eaf4bcdbc148d67b4587d6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTFbmioDmnK_mtL4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768104855&amp;x-signature=Fw4o8Bl%2FWLuePi56JcJ2M70zwHA%3D" alt="" loading="lazy"/></p>
<p>言归正传。</p>
<p>至此，AI Coding 平台化工程搞定，作为需求方（产品、设计师、运营、技术人员）来说，可以基于 Compoder 的 Codegen 快速生成符合团队项目技术栈、代码结构规范的代码，同时还能够保证代码的可维护性。</p>
<p>本着一篇文章把一件事聊透的原则，本篇就先聚焦在 AI Coding 平台化工程这块。</p>
<p>下一篇，我们接着聊 AI Coding 基建工程化。</p>
<hr/>
<p>读后思考：</p>
<ul>
<li>
<p>AI Coding 平台化工程的缺点？</p>
</li>
<li>
<p>技术人员自己出了一个产品把自己给干掉了？</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis性能翻倍的5个冷门技巧：从每秒10万到20万的实战优化之路]]></title>    <link>https://juejin.cn/post/7590776324164272128</link>    <guid>https://juejin.cn/post/7590776324164272128</guid>    <pubDate>2026-01-04T04:18:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590776324164272128" data-draft-id="7590778284758630435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis性能翻倍的5个冷门技巧：从每秒10万到20万的实战优化之路"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-04T04:18:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis性能翻倍的5个冷门技巧：从每秒10万到20万的实战优化之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T04:18:40.000Z" title="Sun Jan 04 2026 04:18:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis性能翻倍的5个冷门技巧：从每秒10万到20万的实战优化之路</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Redis作为高性能的内存数据库，被广泛应用于缓存、消息队列、实时统计等场景。然而，随着业务规模的增长，许多开发者发现Redis的性能瓶颈逐渐显现——原本轻松达到每秒10万次操作的实例，在高并发下开始出现延迟甚至超时。</p>
<p>本文将分享5个冷门但极其有效的Redis优化技巧，这些方法来自生产环境的实战经验，经过验证可以将Redis的吞吐量从每秒10万提升到20万甚至更高。不同于常见的"增大内存"或"升级硬件"建议，这些技巧聚焦于配置调优、数据结构选择和系统级协作，帮助你在不增加资源的情况下实现性能飞跃。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. Pipeline与Multi-Exec的精准控制</h3>
<p><strong>问题背景</strong><br/>
大多数开发者知道Pipeline能减少网络往返（RTT），但盲目堆积命令会导致：</p>
<ul>
<li>内存占用激增（客户端缓冲区溢出）</li>
<li>Redis单线程阻塞（超过<code>client-output-buffer-limit</code>）</li>
</ul>
<p><strong>优化方案</strong></p>
<ul>
<li><strong>动态分批次</strong>：根据<code>INFO memory</code>中的<code>mem_clients_normal</code>监控客户端内存，动态调整Pipeline批量大小（例如每批次100~500条）。</li>
<li><strong>混合使用Multi-Exec</strong>：对需要原子性的操作（如库存扣减），将Pipeline与Multi-Exec结合：
<pre><code class="hljs language-bash" lang="bash">PIPELINE
GET item:1234:stock
(其他只读操作)
EXEC

MULTI
DECRBY item:1234:stock 1
(其他写操作)
EXEC
</code></pre>
实测可降低30%的原子操作延迟。</li>
</ul>
<p><strong>原理</strong>：通过分离读写管道，减少事务锁竞争时间。</p>
<hr/>
<h3 data-id="heading-4">2. Hash Slot预热与NUMA亲和性绑定</h3>
<p><strong>问题背景</strong><br/>
Redis Cluster的Key分布在16384个Hash Slot中，但新节点加入时可能出现"冷Slot"访问延迟高的问题。此外，多核服务器上NUMA架构可能导致跨节点内存访问延迟。</p>
<p><strong>优化步骤</strong></p>
<ol>
<li><strong>Slot预热脚本</strong>：在流量低谷期主动访问所有Slot：
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">for</span> slot=<span class="hljs-number">0</span>,<span class="hljs-number">16383</span> <span class="hljs-keyword">do</span>
    redis.call(<span class="hljs-string">"CLUSTER"</span>, <span class="hljs-string">"GETKEYSINSLOT"</span>, slot, <span class="hljs-number">1</span>)
<span class="hljs-keyword">end</span>
</code></pre>
</li>
<li><strong>NUMA绑定</strong>：使用<code>numactl</code>将Redis进程绑定到同一NUMA节点：
<pre><code class="hljs language-bash" lang="bash">numactl --cpunodebind=0 --membind=0 redis-server /etc/redis.conf
</code></pre>
</li>
<li><strong>关闭透明大页（THP）</strong>：在Linux中执行：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</code></pre>
</li>
</ol>
<p>*<em>效果对比</em>：某电商平台实测降低P99延迟从8ms到3ms。</p>
<hr/>
<h3 data-id="heading-5">3. Lazy Free与异步删除的陷阱规避</h3>
<p>Redis的惰性删除（Lazy Free）虽然避免了主线程阻塞，但在以下场景反而会拖累性能：</p>
<ul>
<li><strong>热点Key删除风暴</strong>（如大批量淘汰Key时触发并发释放）</li>
<li><strong>内存碎片化加剧</strong>（异步释放导致内存无法及时合并）</li>
</ul>
<p><strong>针对性配置调整</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Redis.conf关键参数：</span>
lazyfree-lazy-eviction no    <span class="hljs-comment"># 内存满时同步淘汰</span>
lazyfree-lazy-expire no      <span class="hljs-comment"># Key过期同步删除</span>
lazyfree-lazy-server-del yes <span class="hljs-comment"># DEL命令异步执行</span>

<span class="hljs-comment"># Lua脚本强制同步删除：</span>
redis.call("DEL", KEYS<span class="hljs-section">[1]</span>, "SYNC")
</code></pre>
<hr/>
<h3 data-id="heading-6">4. HyperLogLog的概率结构调整</h3>
<p>当使用HLL做UV统计时，默认精度（16384个寄存器）可能过度消耗内存。通过调整稀疏/稠密表示转换阈值来优化：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 在初始化HLL时显式指定精度：</span>
redis.call(<span class="hljs-string">"PFADD"</span>, <span class="hljs-string">"user_uv_202405"</span>, <span class="hljs-string">"user1"</span>, <span class="hljs-string">"SPARSE"</span>, <span class="hljs-string">"MAXREGISTERS"</span>, <span class="hljs-string">"8192"</span>)
</code></pre>




















<table><thead><tr><th>Item</th><th>Default</th><th>Optimized</th></tr></thead><tbody><tr><td>Memory Usage</td><td>~12KB</td><td>~6KB</td></tr><tr><td>Error Rate</td><td>0.81%</td><td>≈1.5%</td></tr></tbody></table>
<p>适合允许适度误差的场景（如活动页面UV统计）。</p>
<hr/>
<h3 data-id="heading-7">5. TLS加密连接的性能黑洞与解决方案</h3>
<p>启用TLS后性能下降50%？问题出在：</p>
<ul>
<li>OpenSSL的默认配置未启用硬件加速指令集（如AES-NI）</li>
<li>TCP_NODELAY未开启导致小包延迟</li>
</ul>
<p><strong>终极优化方案</strong>:</p>
<pre><code class="hljs language-nginx" lang="nginx"># Nginx反向代理层配置：
ssl_early_data on;
ssl_session_tickets on;
ssl_buffer_size 4k; 

# Redis服务端：
tls-port 6379
tls-ciphers 'ECDHE-RSA-AES256-GCM-SHA384:+AES256'
tls-prefer-server-ciphers yes

# Linux内核调优：
echo 'net.ipv4.tcp_fastopen=3' &gt;&gt; /etc/sysctl.conf
</code></pre>
<p>实测吞吐量从7万QPS恢复到13万QPS！</p>
<hr/>
<h2 data-id="heading-8">总结</h2>
<p>从Pipeline的动态批处理到NUMA亲和性绑定，再到TLS连接的指令集优化——这些看似边缘的技术点组合起来，往往能带来意想不到的性能突破。关键在于理解Redis的单线程模型与现代硬件架构之间的相互作用关系。建议读者先在测试环境验证这些参数调整效果，再逐步应用到生产环境。真正的性能优化不是堆砌参数的艺术，而是对系统运行机理的深度掌控与实践智慧的结合体！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[设计模式 -- 适配器 & 策略模式]]></title>    <link>https://juejin.cn/post/7590915294446485531</link>    <guid>https://juejin.cn/post/7590915294446485531</guid>    <pubDate>2026-01-03T22:57:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590915294446485531" data-draft-id="7590608345923485722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="设计模式 -- 适配器 &amp; 策略模式"/> <meta itemprop="keywords" content="Python,设计模式"/> <meta itemprop="datePublished" content="2026-01-03T22:57:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不加糖435"/> <meta itemprop="url" content="https://juejin.cn/user/1464990724787549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            设计模式 -- 适配器 &amp; 策略模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1464990724787549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不加糖435
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T22:57:00.000Z" title="Sat Jan 03 2026 22:57:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题：API接口不统一</h2>
<p><strong>问题场景</strong>：<br/>
假设你要发送邮件，但不同服务商调用方式不同。比如发送邮件，SendGrid、Mailgun、Microsoft Graph 都能发，但调用方式天差地别</p>
<p>SendGrid 的调用方式：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># SendGrid SDK的调用方式</span>
<span class="hljs-attr">sg</span> = sendgrid.SendGridAPIClient(api_key=<span class="hljs-string">'SG.xxx'</span>)
<span class="hljs-attr">message</span> = Mail(
    <span class="hljs-attr">from_email</span>=<span class="hljs-string">'from@example.com'</span>,
    <span class="hljs-attr">to_emails</span>=<span class="hljs-string">'to@example.com'</span>,
    <span class="hljs-attr">subject</span>=<span class="hljs-string">'Hello'</span>,
    <span class="hljs-attr">plain_text_content</span>=<span class="hljs-string">'World'</span>
)
<span class="hljs-attr">response</span> = sg.send(message)
</code></pre>
<p>Mailgun 的调用方式：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># Mailgun SDK的调用方式</span>
requests.post(
    <span class="hljs-string">"https://api.mailgun.net/v3/your-domain/messages"</span>,
    auth=(<span class="hljs-string">"api"</span>, <span class="hljs-string">"your-api-key"</span>),
    data={
        <span class="hljs-string">"from"</span>: <span class="hljs-string">"from@example.com"</span>,
        <span class="hljs-string">"to"</span>: <span class="hljs-string">"to@example.com"</span>,
        <span class="hljs-string">"subject"</span>: <span class="hljs-string">"Hello"</span>,
        <span class="hljs-string">"text"</span>: <span class="hljs-string">"World"</span>
    }
)
</code></pre>
<p>问题：看到区别了吗？参数名不一样（<code>to_emails</code> vs <code>to</code>），调用方式不一样（对象方法 vs HTTP请求），返回格式也不一样。</p>
<p><strong>如果直接在业务代码中调用这些SDK：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 订单服务中</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_order_confirmation</span>(<span class="hljs-params">order_id</span>):
    sg = sendgrid.SendGridAPIClient(api_key=<span class="hljs-string">'SG.xxx'</span>)
    message = Mail(...)
    sg.send(message)

<span class="hljs-comment"># 用户服务中</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_welcome_email</span>(<span class="hljs-params">user_email</span>):
    sg = sendgrid.SendGridAPIClient(api_key=<span class="hljs-string">'SG.xxx'</span>)
    message = Mail(...)
    sg.send(message)

<span class="hljs-comment"># ... 还有20个地方都在调用SendGrid</span>
</code></pre>
<p>如果要换成Mailgun，得把所有地方都改一遍。</p>
<p>当然，我们可以封装下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 封装成一个函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">send_email</span>(<span class="hljs-params">to, subject, content, provider=<span class="hljs-string">'sendgrid'</span></span>):
    <span class="hljs-keyword">if</span> provider == <span class="hljs-string">'sendgrid'</span>:
        sg = sendgrid.SendGridAPIClient(api_key=<span class="hljs-string">'SG.xxx'</span>)
        message = Mail(from_email=..., to_emails=to, ...)
        sg.send(message)
    <span class="hljs-keyword">elif</span> provider == <span class="hljs-string">'mailgun'</span>:
        requests.post(<span class="hljs-string">"https://api.mailgun.net/v3/..."</span>, 
                     auth=(<span class="hljs-string">"api"</span>, <span class="hljs-string">"..."</span>), 
                     data={<span class="hljs-string">"from"</span>: ..., <span class="hljs-string">"to"</span>: to, ...})
    <span class="hljs-keyword">elif</span> provider == <span class="hljs-string">'microsoft_graph'</span>:
        <span class="hljs-comment"># 又是另一套代码</span>
        ...

<span class="hljs-comment"># 业务代码就可以这样用了</span>
send_email(<span class="hljs-string">"user@example.com"</span>, <span class="hljs-string">"Hello"</span>, <span class="hljs-string">"World"</span>, provider=<span class="hljs-string">'sendgrid'</span>)
</code></pre>
<p>封装后确实好多了，业务代码清爽了。但是这种封装方式依然有问题。</p>
<p><strong>函数越来越长</strong>：新增服务商要在这个函数中继续加一个分支，代码越来越长。找个某个特定的服务商要在这个很长的函数中找，容易改错。总而言之，就是不好维护。<br/>
当然，可以进一步优化，把不同服务商封装到不同的类中。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SendGridEmail</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, to, subject, content</span>):
        <span class="hljs-comment"># SendGrid 的代码</span>
        ...

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MailgunEmail</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, to, subject, content</span>):
        <span class="hljs-comment"># Mailgun 的代码</span>
        ...

</code></pre>
<p>好多了，<strong>但是，这里有个关键问题</strong>：<strong>接口不统一</strong>！<br/>
看回最开始的问题：</p>
<ul>
<li>SendGrid 用 <code>to_emails</code>，Mailgun 用 <code>to</code></li>
<li>SendGrid 用 <code>plain_text_content</code>，Mailgun 用 <code>text</code></li>
</ul>
<p><strong>如果只是简单封装到类里，接口还是不统一</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 每个服务商的接口不一样，业务代码还是要判断，而且调用方式还不一样!</span>
<span class="hljs-keyword">if</span> provider == <span class="hljs-string">'sendgrid'</span>:
    email = SendGridEmail()
    email.send(to_emails=to, subject=subject, plain_text_content=content)  <span class="hljs-comment"># 参数名不一样</span>
<span class="hljs-keyword">elif</span> provider == <span class="hljs-string">'mailgun'</span>:
    email = MailgunEmail()
    email.send(to=to, subject=subject, text=content)  <span class="hljs-comment"># 参数名不一样</span>
</code></pre>
<p>适配器模式的作用**：<strong>统一接口</strong>
我们想要业务代码只关心"发邮件"这个功能，不关心用哪个服务商。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 业务代码只需要这样写，不管用哪个服务商</span>
manager.send_email(
    to=<span class="hljs-string">"user@example.com"</span>,
    subject=<span class="hljs-string">"Hello"</span>,
    content=<span class="hljs-string">"World"</span>
)

<span class="hljs-comment"># 切换服务商？改配置文件即可，无需修改发邮件代码</span>
</code></pre>
<h2 data-id="heading-1">适配器模式</h2>
<h3 data-id="heading-2">什么是适配器模式？</h3>
<p><strong>核心思想</strong>：<strong>让所有服务商的类实现同一个接口</strong>。</p>
<p><strong>简单说</strong>：适配器模式就是定义一个<strong>统一的接口</strong>（抽象类），让不同的实现类都遵循这个接口，这样业务代码就可以统一调用，不需要关心具体是哪个实现。</p>
<p><strong>生活中的例子</strong>：中国手机插头插不进欧洲插座，买个转换插头就行了。转换插头做了什么？</p>
<ul>
<li>不改变你的手机</li>
<li>不改变欧洲的插座</li>
<li>只是在中间做了个"翻译"，统一了接口</li>
</ul>
<p><strong>抽象类</strong>（Abstract Class）就是定义了接口但自己不实现具体功能的类。它就像一个"模板"，告诉子类"你必须实现这些方法"。<br/>
在 Python 中，使用 <code>ABC</code>（Abstract Base Class）和 <code>@abstractmethod</code> 来定义抽象类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEmailAdapter</span>(<span class="hljs-title class_ inherited__">ABC</span>):  <span class="hljs-comment"># ABC 表示这是一个抽象基类</span>
<span class="hljs-meta">    @abstractmethod  </span><span class="hljs-comment"># 这个装饰器表示子类必须实现这个方法</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, to, subject, content</span>):
        <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># 抽象方法不写具体实现，只是定义接口</span>
</code></pre>
<h3 data-id="heading-3">适配器模式的实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 先定义统一接口（抽象类）</span>
<span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEmailAdapter</span>(<span class="hljs-title class_ inherited__">ABC</span>):  <span class="hljs-comment"># 抽象基类</span>
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, to, subject, content</span>):  <span class="hljs-comment"># 统一的参数</span>
        <span class="hljs-string">"""子类必须实现这个方法"""</span>
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 2. 每个服务商实现这个接口（继承抽象类）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SendGridAdapter</span>(<span class="hljs-title class_ inherited__">BaseEmailAdapter</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, to, subject, content</span>):  <span class="hljs-comment"># 必须和接口一样</span>
        <span class="hljs-comment"># SendGrid 的代码，内部转换成 SendGrid 的调用方式</span>
        sg = sendgrid.SendGridAPIClient(api_key=self.api_key)
        message = Mail(
            from_email=self.from_email,
            to_emails=to,  <span class="hljs-comment"># 统一接口用 to，内部转换成 SendGrid 的 to_emails</span>
            subject=subject,
            plain_text_content=content  <span class="hljs-comment"># 统一接口用 content，内部转换成 plain_text_content</span>
        )
        <span class="hljs-keyword">return</span> sg.send(message)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MailgunAdapter</span>(<span class="hljs-title class_ inherited__">BaseEmailAdapter</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">self, to, subject, content</span>):  <span class="hljs-comment"># 必须和接口一样</span>
        <span class="hljs-comment"># Mailgun 的代码，内部转换成 Mailgun 的调用方式</span>
        requests.post(
            <span class="hljs-string">"https://api.mailgun.net/v3/your-domain/messages"</span>,
            auth=(<span class="hljs-string">"api"</span>, self.api_key),
            data={
                <span class="hljs-string">"from"</span>: self.from_email,
                <span class="hljs-string">"to"</span>: to,  <span class="hljs-comment"># 统一接口用 to，Mailgun 也用 to，直接传</span>
                <span class="hljs-string">"subject"</span>: subject,
                <span class="hljs-string">"text"</span>: content  <span class="hljs-comment"># 统一接口用 content，内部转换成 Mailgun 的 text</span>
            }
        )



<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_adapter</span>(<span class="hljs-params">provider</span>):
    <span class="hljs-keyword">if</span> provider == <span class="hljs-string">'sendgrid'</span>:
        <span class="hljs-keyword">return</span> SendGridAdapter(...)
    <span class="hljs-keyword">elif</span> provider == <span class="hljs-string">'mailgun'</span>:
        <span class="hljs-keyword">return</span> MailgunAdapter(...)
<span class="hljs-comment"># 3. 业务代码只需要依赖接口，不需要知道具体是哪个服务商</span>
adapter = create_adapter(provider)  <span class="hljs-comment"># 根据配置创建适配器（这里只有一次 if-else）</span>
adapter.send(to, subject, content)  <span class="hljs-comment"># 统一调用，参数都一样！</span>
</code></pre>
<h2 data-id="heading-4">策略模式：优化选择逻辑</h2>
<h3 data-id="heading-5">核心思想</h3>
<p><strong>策略模式</strong>：封装选择逻辑，根据情况选择使用哪个策略</p>
<h3 data-id="heading-6">两种实现方式</h3>
<p><strong>方式1：if-else（简单实现）</strong>
根据 <code>provider</code> 选择不同的适配器。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_adapter</span>(<span class="hljs-params">provider</span>):
    <span class="hljs-keyword">if</span> provider == <span class="hljs-string">'sendgrid'</span>:
        <span class="hljs-keyword">return</span> SendGridAdapter(...)
    <span class="hljs-keyword">elif</span> provider == <span class="hljs-string">'mailgun'</span>:
        <span class="hljs-keyword">return</span> MailgunAdapter(...)
    <span class="hljs-comment"># 添加新服务商？又要加一个 elif</span>
</code></pre>
<p><strong>问题</strong>：每次添加新服务商，都要改这个函数，加新的 <code>elif</code>。</p>
<p><strong>方式2：字典映射（优雅实现）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailManager</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 策略映射：把服务商名称映射到对应的适配器类</span>
        self._adapter_classes = {
            <span class="hljs-string">'sendgrid'</span>: SendGridAdapter,
            <span class="hljs-string">'mailgun'</span>: MailgunAdapter,
            <span class="hljs-string">'microsoft_graph'</span>: MicrosoftGraphAdapter
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_create_adapter</span>(<span class="hljs-params">self, provider</span>):
        <span class="hljs-comment"># 从字典中获取对应的适配器类</span>
        adapter_class = self._adapter_classes.get(provider)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> adapter_class:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持的邮件服务商: <span class="hljs-subst">{provider}</span>"</span>)
        <span class="hljs-keyword">return</span> adapter_class(api_key=..., from_email=...)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_email</span>(<span class="hljs-params">self, to, subject, content</span>):
        <span class="hljs-comment"># 1. 从配置获取服务商</span>
        provider = self._get_provider_from_config()
        
        <span class="hljs-comment"># 2. 创建适配器（策略模式：根据配置选择）</span>
        adapter = self._create_adapter(provider)
        
        <span class="hljs-comment"># 3. 调用适配器的 send 方法（适配器模式：统一接口）</span>
        <span class="hljs-keyword">return</span> adapter.send(to, subject, content)
</code></pre>
<h2 data-id="heading-7">两种模式的协作</h2>
<h3 data-id="heading-8">完整流程</h3>
<pre><code class="hljs language-scss" lang="scss">业务代码
  ↓
EmailManager<span class="hljs-selector-class">.send_email</span>()  (策略模式：选择适配器)
  ↓
<span class="hljs-built_in">_create_adapter</span>(provider)  (策略模式：根据配置选择)
  ↓
SendGridAdapter / MailgunAdapter  (适配器模式：统一接口)
  ↓
adapter<span class="hljs-selector-class">.send</span>()            (适配器模式：统一调用)
  ↓
SendGrid API / Mailgun API (第三方API)
</code></pre>
<h2 data-id="heading-9">总结</h2>
<h3 data-id="heading-10">适配器模式</h3>
<p><strong>解决的问题</strong>：接口不统一<br/>
<strong>解决方案</strong>：定义统一接口（抽象类），所有适配器都实现相同的接口<br/>
<strong>价值</strong>：业务代码可以统一调用，不需要关心具体实现</p>
<h3 data-id="heading-11">策略模式</h3>
<p><strong>核心</strong>：封装选择逻辑，根据情况选择使用哪个策略</p>
<p><strong>反思</strong></p>
<p>人生怎么过都可以。<br/>
你想要怎样的人生？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebRTC 入门：一分钟理解会议系统的三种架构（Mesh/SFU/MCU）]]></title>    <link>https://juejin.cn/post/7590929624742903858</link>    <guid>https://juejin.cn/post/7590929624742903858</guid>    <pubDate>2026-01-04T00:18:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590929624742903858" data-draft-id="7590849961727377435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebRTC 入门：一分钟理解会议系统的三种架构（Mesh/SFU/MCU）"/> <meta itemprop="keywords" content="前端,后端,WebRTC"/> <meta itemprop="datePublished" content="2026-01-04T00:18:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三十_"/> <meta itemprop="url" content="https://juejin.cn/user/1521379822805176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebRTC 入门：一分钟理解会议系统的三种架构（Mesh/SFU/MCU）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379822805176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三十_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:18:52.000Z" title="Sun Jan 04 2026 00:18:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 WebRTC 中，两点之间的 P2P 通话是基础，但当参会人数增加到 3 人、4 人甚至更多时，单纯的点对点连接就会面临挑战。本文将带你深入浅出地了解 WebRTC 会议的三种主流架构：<strong>Mesh</strong>、<strong>SFU</strong> 和 <strong>MCU</strong>。</p>
<hr/>
<h2 data-id="heading-0">1. Mesh 架构：完全互联的网状结构</h2>
<p>这是最直观、也是最基础的架构形式。</p>
<h3 data-id="heading-1">核心原理</h3>
<p>假设有 A、B、C、D 四个人需要参会。在 WebRTC 仅支持 P2P 的前提下，为了让所有人都能互通，每个客户端都必须和其余所有人建立连接。</p>
<ul>
<li><strong>A 的视角</strong>：A 必须分别和 B、C、D 建立关联，形成 A-B、A-C、A-D 三条通路。只有这样，A 才能把视频传给他们，并接收他们的视频。</li>
<li><strong>B 的视角</strong>：同理，B 也要和 A、C、D 建立关联。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e86225d7cd5c4fb2b9c58c50cb510117~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y2BXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768090732&amp;x-signature=jo8UPPTnqmw4dqGqlOSVksJ%2Bptk%3D" alt="image-20251228231759695.png" loading="lazy"/></p>
<h3 data-id="heading-2">代码层面</h3>
<p>从 WebRTC 的核心载体 <strong>PeerConnection</strong> 来看：</p>
<ul>
<li><strong>一对关联关系 = 一个 PeerConnection 对象</strong>。</li>
<li>例如 A-B 这一关系，在代码中实际就是创建了一个 PeerConnection 对象，该对象内部维护着 A 和 B 之间的 <strong>SDP 信令</strong>和<strong>媒体信息</strong>。</li>
<li>如果是 4 人会议，A 的浏览器里就需要维护 3 个 PeerConnection 对象。</li>
</ul>
<h3 data-id="heading-3">优缺点</h3>
<ul>
<li><strong>优点</strong>：服务器成本低（因为不需要服务器转发媒体流，只负责信令），逻辑简单。</li>
<li><strong>缺点</strong>：客户端<strong>带宽压力极大</strong>。一个 N 人会议需要建立 <strong><code>N × (N − 1) / 2</code> 条 P2P 连接</strong>， 每个客户端需要维护 <strong><code>N − 1</code> 条 RTCPeerConnection</strong>，连接数量呈平方级增长。</li>
</ul>
<hr/>
<h2 data-id="heading-4">2. SFU 架构：高效的“中心转发”</h2>
<p>SFU（Selective Forwarding Unit，选择性转发单元）是目前主流的会议架构。它引入了一个服务器作为中转站，客户端只发一路流给服务器，服务器负责把这路流“复制”并转发给其他参会者。而这个服务器则被称为 <strong>SFU 服务器</strong>。</p>
<h3 data-id="heading-5">核心原理</h3>
<p>为了理解 SFU，我们可以拿发快递做比喻：</p>
<ul>
<li>
<p><strong>Mesh 架构</strong>：就像是你（A）要给 B、C、D 三个人送礼物，你需要亲自开车跑三趟，分别把礼物送到他们每个人手里。</p>
</li>
<li>
<p><strong>SFU 架构</strong>：就像是一个<strong>快递集散中心</strong>。</p>
<ul>
<li>你（A）只需要把礼物打包发给集散中心（SFU 服务器）。</li>
<li>集散中心收到后，负责把你的礼物分别派送给 B、C、D。</li>
<li>同理，B、C、D 也只需要把他们的礼物发给集散中心，由集散中心统一转发给你。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bac68f91bdb4d5abade15b95ee732d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y2BXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768090732&amp;x-signature=xTPmchB3T0IfFXdbajN8vV0uN04%3D" alt="image-20251229083354743.png" loading="lazy"/></p>
<h3 data-id="heading-6">代码层面</h3>
<p>在 SFU 架构中，代码逻辑发生了质的变化：</p>
<ul>
<li>
<p><strong>1 个 PeerConnection</strong>：无论会议室里有多少人，每个客户端只需要维护 1 个 PeerConnection 对象。</p>
<blockquote>
<p>虽然每个客户端只需要维护 <strong>1 个 RTCPeerConnection</strong>，但这个连接中会承载 <strong>多路 MediaStreamTrack</strong>。因此客户端的<strong>下行带宽和解码压力，仍然随参会人数线性增长（N−1）</strong> 。</p>
</blockquote>
</li>
<li>
<p><strong>对端永远是 SFU</strong>：这个 PeerConnection 的连接对象永远是 SFU 服务器，而不是其他客户端。</p>
</li>
</ul>
<h3 data-id="heading-7">架构优势</h3>
<ol start="0">
<li><strong>客户端连接数低</strong>：每个客户端只需要 1 个 PeerConnection</li>
<li><strong>上行带宽压力小</strong>：无论会议中有多少人，客户端始终只上传 <strong>1 路音视频流</strong></li>
<li><strong>延迟低</strong>：SFU 只做媒体转发，不解码、不混流，延迟接近 P2P</li>
<li><strong>扩展性好</strong>：支持几十人规模的会议，是当前主流视频会议系统的核心架构</li>
</ol>
<h3 data-id="heading-8">缺点</h3>
<ol start="0">
<li><strong>下行带宽仍然随人数增长</strong>：客户端需要接收 <strong>N−1 路媒体流</strong>，下行带宽和解码压力线性增加。</li>
<li><strong>服务器带宽成本高</strong>：虽然不吃 CPU，但对服务器出口带宽要求很高。</li>
</ol>
<hr/>
<h2 data-id="heading-9">3. MCU 架构：全能的“媒体大脑”</h2>
<p>MCU（Multipoint Control Unit，多点控制单元）它大体上和 SFU 类似，但它不仅仅是转发，还会对流进行<strong>混合（Mixing）</strong> 、转码和处理。服务器把所有人的画面拼合成一张图，编码成一路视频流发给客户端。</p>
<h3 data-id="heading-10">适用场景</h3>
<p>MCU 专为<strong>媒体场景复杂</strong>的情况设计，例如：</p>
<ul>
<li><strong>多种不同设备接入</strong>：接入会议的不只是手机电脑，还有监控摄像头（RTSP流）、硬件终端。</li>
<li><strong>直播与转播</strong>：需要将会议画面推流给成千上万的观众。</li>
<li><strong>云端录制</strong>：需要对会议进行高质量存档。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f321edda01a4697a07125170e3dc1b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y2BXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768090732&amp;x-signature=uqOxVS7o0Phssms6Rdz8WfiH2hw%3D" alt="image-20251230081150459.png" loading="lazy"/></p>
<h3 data-id="heading-11">MCU 服务器内部做的事</h3>
<p>所有参会的流首先进入 MCU 服务器，在这里，它们会经历深度的处理：</p>
<ol start="0">
<li>
<p><strong>媒体转码</strong>：这是 MCU 的核心能力。</p>
<ul>
<li>比如监控摄像头的视频是 H.265 格式，浏览器不支持，MCU 可以将其实时转码为 H.264。</li>
<li>将 RTMP、RTSP 等协议转换为 WebRTC 标准的 RTC 流，或者将 RTP 转为 FLV 供直播使用。</li>
</ul>
</li>
<li>
<p><strong>云端录制</strong>：服务器可以直接过滤并录制经过的流。</p>
</li>
<li>
<p><strong>服务端 AI 检测</strong>：</p>
<ul>
<li>在大型直播中，内容安全至关重要。MCU 可以在服务端接入 AI 鉴别中心，实时检测直播内容。</li>
<li>一旦发现非法内容，AI 可以直接切断直播，确保安全。</li>
</ul>
</li>
<li>
<p><strong>其他能力</strong>：媒体流混合（将多个人画面合成一个画面）、音频提取、视频抽帧存档等。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-12">总结</h2>
<p>在 WebRTC 多人实时通信中，<strong>架构选择的本质</strong>，是如何在 <strong>客户端压力、服务器成本、延迟和功能复杂度</strong> 之间做取舍。</p>





















































<table><thead><tr><th>维度</th><th>Mesh</th><th>SFU</th><th>MCU</th></tr></thead><tbody><tr><td>PeerConnection</td><td>N−1</td><td>1</td><td>1</td></tr><tr><td>客户端上行</td><td>N−1 路</td><td>1 路</td><td>1 路</td></tr><tr><td>客户端下行</td><td>N−1 路</td><td>N−1 路</td><td>1 路</td></tr><tr><td>服务器压力</td><td>极低</td><td>中（带宽）</td><td>极高（计算）</td></tr><tr><td>延迟</td><td>最低</td><td>低</td><td>较高</td></tr><tr><td>扩展性</td><td>极差</td><td>好</td><td>很好</td></tr><tr><td>典型应用</td><td>1v1</td><td>视频会议</td><td>直播 / 融合</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥🔥🔥 React18 源码学习 - React Element]]></title>    <link>https://juejin.cn/post/7591177139660455990</link>    <guid>https://juejin.cn/post/7591177139660455990</guid>    <pubDate>2026-01-04T00:47:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591177139660455990" data-draft-id="7590403249561190415" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥🔥🔥 React18 源码学习 - React Element"/> <meta itemprop="keywords" content="React.js,源码阅读"/> <meta itemprop="datePublished" content="2026-01-04T00:47:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yyyao"/> <meta itemprop="url" content="https://juejin.cn/user/4266531531793976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥🔥🔥 React18 源码学习 - React Element
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266531531793976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yyyao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:47:13.000Z" title="Sun Jan 04 2026 00:47:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>本文的<code>React</code>代码版本为<code>18.2.0</code></p>
<p>可调试的代码仓库为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyyyao-hh%2Freact-debug%2Ftree%2Fmaster-pure" target="_blank" title="https://github.com/yyyao-hh/react-debug/tree/master-pure" ref="nofollow noopener noreferrer">GitHub - yyyao-hh/react-debug at master-pure</a></p>
<p><code>React Element</code>作为<code>React</code>架构的基石，理解其本质和工作原理对于深入掌握<code>React</code>至关重要。并且后面的章节都依托于前面基础知识的铺垫，所以务必仔细阅读本章内容！！！</p>
<h2 data-id="heading-1">基本概念</h2>
<p><strong>JSX</strong>（<code>JavaScript XML</code>）是一种<code>JavaScript</code>的语法扩展，它允许我们在<code>JavaScript</code>中直接书写类似<code>HTML</code>的结构。它为我们提供了一种简洁、直观且高效的方式描述 UI 组件。</p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh-hans.legacy.reactjs.org%2Fdocs%2Fintroducing-jsx.html" target="_blank" title="https://zh-hans.legacy.reactjs.org/docs/introducing-jsx.html" ref="nofollow noopener noreferrer">JSX 简介 – React</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* src/index.js */</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">APP</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>Hello, world!<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<h3 data-id="heading-2">从 JSX 到 React Element</h3>
<p>实际上，<code>JSX</code>并不是<code>React</code>直接执行的代码，它会被编译成标准的<code>JavaScript</code>代码。</p>
<ul>
<li>在 <code>React17</code>之前，<code>JSX</code>代码都会被转化为<code>React.createElement</code>函数进行处理。而这也是为什么之前的项目中需要引入<code>React</code>。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* createElement: src/react/packages/react/src/ReactElement.js */</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>

<span class="hljs-comment">// JSX 代码</span>
&lt;div className=<span class="hljs-string">"title"</span>&gt;<span class="hljs-title class_">Hello</span> <span class="hljs-title class_">World</span>&lt;/div&gt;

<span class="hljs-comment">// 编译为</span>
<span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">className</span>: <span class="hljs-string">'title'</span> }, <span class="hljs-string">'Hello World'</span>)
</code></pre>
<ul>
<li>在<code>React17</code>之后，<code>React</code>和<code>babel</code>进行了合作，支持了<code>jsx-runtime</code>。所以我们不用手动引入<code>React</code>，而是由编译器自动引入新的<code>jsx</code>函数 。</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">/* jsx: src/react/packages/react/jsx-runtime.js */</span>

<span class="hljs-comment">// JSX 代码  </span>
&lt;div className=<span class="hljs-string">"title"</span>&gt;Hello World&lt;/div&gt;

<span class="hljs-comment">// 编译为</span>
import { jsx <span class="hljs-keyword">as</span> _jsx } <span class="hljs-keyword">from</span> <span class="hljs-string">'react/jsx-runtime'</span>
<span class="hljs-title function_ invoke__">_jsx</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">className</span>: <span class="hljs-string">'title'</span>, <span class="hljs-attr">children</span>: <span class="hljs-string">'Hello World'</span> })
</code></pre>
<p>新模式配置：</p>
<pre><code class="hljs language-lua" lang="lua">{
  <span class="hljs-string">"plugins"</span>: <span class="hljs-string">[["@babel/plugin-transform-react-jsx", { "runtime": "automatic" }]]</span>
}
</code></pre>
<blockquote>
<p>使用<code>create-react-app</code>或<code>Vite</code>等现代工具链，通常默认使用新模式</p>
</blockquote>
<p>但是无论是上面的哪种转换方式，最终结果都是被转化为一个普通的<code>JavaScript</code>对象，它描述了你希望在屏幕上看到的内容。</p>
<h3 data-id="heading-3">React Element 的数据结构</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/* src/react/packages/shared/ReactElementType.js */</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ReactElement</span> = {|
  <span class="hljs-attr">$$typeof</span>: <span class="hljs-built_in">any</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">any</span>,
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">any</span>,
  <span class="hljs-attr">ref</span>: <span class="hljs-built_in">any</span>,
  <span class="hljs-attr">props</span>: <span class="hljs-built_in">any</span>,
  <span class="hljs-attr">_owner</span>: <span class="hljs-built_in">any</span>

  <span class="hljs-comment">// 省略 __DEV__ 环境的一些属性</span>
|};
</code></pre>
<p>每个属性的含义如下：</p>








































<table><thead><tr><th>属性</th><th>描述</th><th>示例值</th></tr></thead><tbody><tr><td><code>$$typeof</code></td><td>唯一标识这是一个<code>React Element</code>，通常是一个<code>Symbol</code></td><td><code>Symbol(react.element)</code></td></tr><tr><td><code>type</code></td><td>元素的类型</td><td>- 字符串：表示原生<code>DOM</code>节点（<code>'div'</code>）<br/>- 函数或类：表示自定义组件（<code>MyComp</code>）</td></tr><tr><td><code>key</code></td><td>列表项的唯一标识</td><td><code>'item-1'</code></td></tr><tr><td><code>ref</code></td><td>用于访问底层<code>DOM</code>节点或组件实例的引用</td><td><code>{current: null}</code></td></tr><tr><td><code>props</code></td><td>元素的属性集合（不包括<code>key</code>和<code>ref</code>）</td><td><code>{className: 'app', children: ...}</code></td></tr><tr><td><code>_owner</code></td><td>创建此元素的组件对应的<code>Fiber</code>节点</td><td><code>FiberNode</code></td></tr></tbody></table>
<p>需要特别注意的是<code>$$typeof</code>属性，它是一个<code>Symbol</code>类型的值，用于唯一标识<code>React Element</code>。这个设计主要是为了安全考虑——防止<code>XSS</code>攻击，因为<code>JSON</code>中不能包含<code>Symbol</code>类型的值，即使服务器注入了一个恶意的<code>React Element</code>对象，<code>React</code>也不会认它。</p>
<h2 data-id="heading-4">React Element 与 Fiber 节点的关系</h2>
<p>理解<code>React Element</code>和<code>Fiber</code>节点之间的关系至关重要，它们是<code>React</code>架构中不同但互补的概念。</p>
<h3 data-id="heading-5">不同的角色与职责</h3>
<ul>
<li><strong>React Element</strong>：是一个普通的<code>JavaScript</code>对象，它描述了<code>UI</code>应该是什么样子。它是不可变的，每次更新都会创建新的<code>Element</code>对象。我们可以把它看作是<code>UI</code>的蓝图：它说明了需要渲染什么，但不会实际执行渲染工作。</li>
<li><strong>Fiber</strong>：是<code>React</code>调和过程（<code>Reconciliation</code>）中的工作单元。它是在渲染过程中创建的，然后组成了<code>Fiber</code>树。与<code>React Element</code>不同，<code>Fiber</code>是可变的，它们包含组件状态、副作用标记、以及指向其他<code>Fiber</code>的指针（形成链表结构）。</li>
</ul>
<h3 data-id="heading-6">渲染过程中的协作</h3>
<p><code>React</code>渲染过程的步骤，会遵循以下过程：</p>
<ol>
<li>编译阶段：<code>JSX</code>被转译为<code>createElement/jsx</code>函数调用</li>
<li>触发更新：初始渲染、状态更新、属性更新等</li>
<li>渲染阶段：</li>
</ol>

<ol>
<li>
<ol>
<li>调用函数组件（或类组件的<code>render</code>方法）获取新的<code>React Element</code></li>
<li>将新的<code>Element</code>树与上一次渲染的<code>Fiber</code>树进行比较，生成新的<code>Fiber</code>树（<code>Diff</code>算法）</li>
</ol>
</li>
</ol>

<ol start="4">
<li>提交阶段：将更新应用到实际的<code>DOM</code></li>
</ol>
<h2 data-id="heading-7">创建过程</h2>
<p>要真正理解<code>React Element</code>，我们需要深入<code>createElement/jsx</code>函数的源码，看看它是如何构造这个核心数据结构的。</p>
<blockquote>
<p>注意：代码去除了开发环境相关的逻辑，并精简处理</p>
</blockquote>
<h3 data-id="heading-8">createElement 函数分析</h3>
<pre><code class="hljs language-ini" lang="ini">/* src/react/packages/react/src/ReactElement.js */

const <span class="hljs-attr">RESERVED_PROPS</span> = {
  key: true,
  ref: true,
}<span class="hljs-comment">;</span>

export function createElement(type, config, children) {
  let propName<span class="hljs-comment">;</span>
  const <span class="hljs-attr">props</span> = {}<span class="hljs-comment">;</span>

  let <span class="hljs-attr">key</span> = <span class="hljs-string">''</span> + config.key<span class="hljs-comment">;</span>
  let <span class="hljs-attr">ref</span> = config.ref<span class="hljs-comment">;</span>

  // 过滤掉保留属性(key, ref等), 将其他属性存到 props 对象
  for (propName in config) {
    if (
      hasOwnProperty.call(config, propName) &amp;&amp;
      !RESERVED_PROPS.hasOwnProperty(propName)
    ) {
      props<span class="hljs-section">[propName]</span> = config<span class="hljs-section">[propName]</span><span class="hljs-comment">;</span>
    }
  }

  // 处理 children 参数
  const <span class="hljs-attr">childrenLength</span> = arguments.length - <span class="hljs-number">2</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">childrenLength</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-attr">props.children</span> = children<span class="hljs-comment">;</span>
  } else if (childrenLength &gt; 1) {
    const <span class="hljs-attr">childArray</span> = Array(childrenLength)<span class="hljs-comment">;</span>
    for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; childrenLength; i++) {</span>
      childArray<span class="hljs-section">[i]</span> = arguments<span class="hljs-section">[i + 2]</span><span class="hljs-comment">;</span>
    }
    <span class="hljs-attr">props.children</span> = childArray<span class="hljs-comment">;</span>
  }

  // 处理默认 props
  if (type &amp;&amp; type.defaultProps) {
    const <span class="hljs-attr">defaultProps</span> = type.defaultProps<span class="hljs-comment">;</span>
    for (propName in defaultProps) {
      if (props<span class="hljs-section">[propName]</span> === undefined) {
        props<span class="hljs-section">[propName]</span> = defaultProps<span class="hljs-section">[propName]</span><span class="hljs-comment">;</span>
      }
    }
  }

  // 创建并返回 React Element
  return ReactElement(...)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-9">jsx 函数分析</h3>
<p>逻辑与<code>createElement</code>类似，入参方面将<code>key</code>作为单独参数传递。</p>
<pre><code class="hljs language-ini" lang="ini">/* src/react/packages/react/src/jsx/ReactJSXElement.js */

const <span class="hljs-attr">RESERVED_PROPS</span> = {
  key: true,
  ref: true,
}<span class="hljs-comment">;</span>

export function jsx(type, config, maybeKey) {
  let propName<span class="hljs-comment">;</span>
  const <span class="hljs-attr">props</span> = {}<span class="hljs-comment">;</span>

  let <span class="hljs-attr">key</span> = config.key<span class="hljs-comment">;</span>
  let <span class="hljs-attr">ref</span> = config.ref<span class="hljs-comment">;</span>

  // 过滤掉保留属性(key, ref等), 将其他属性存到 props 对象(children 也在 config 中)
  for (propName in config) {
    if (
      hasOwnProperty.call(config, propName) &amp;&amp;
      !RESERVED_PROPS.hasOwnProperty(propName)
    ) {
      props<span class="hljs-section">[propName]</span> = config<span class="hljs-section">[propName]</span><span class="hljs-comment">;</span>
    }
  }

  // 处理默认 props
  if (type &amp;&amp; type.defaultProps) {
    const <span class="hljs-attr">defaultProps</span> = type.defaultProps<span class="hljs-comment">;</span>
    for (propName in defaultProps) {
      if (props<span class="hljs-section">[propName]</span> === undefined) {
        props<span class="hljs-section">[propName]</span> = defaultProps<span class="hljs-section">[propName]</span><span class="hljs-comment">;</span>
      }
    }
  }

  // 创建并返回 React Element
  return ReactElement(...)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-10">ReactElement 函数</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">const</span> ReactElement = <span class="hljs-title function_ invoke__">function</span>(<span class="hljs-keyword">type</span>, key, <span class="hljs-keyword">ref</span>, <span class="hljs-keyword">self</span>, source, owner, props) {
  <span class="hljs-keyword">const</span> element = {
    $$<span class="hljs-keyword">typeof</span>: REACT_ELEMENT_TYPE,
    <span class="hljs-keyword">type</span>: <span class="hljs-keyword">type</span>,
    key: key,
    <span class="hljs-keyword">ref</span>: <span class="hljs-keyword">ref</span>,
    props: props,
    _owner: owner,
  };
  
  <span class="hljs-keyword">return</span> element;
};
</code></pre>
<blockquote>
<p>要深入理解<code>React Element</code>的创建过程，最好的方法是在源码中设置断点并进行调试。</p>
</blockquote>
<h2 data-id="heading-11">总结</h2>
<p>很多人将<code>React Element</code>等同于虚拟<code>DOM</code>，实际上<code>React Element</code>确实是<code>React</code>虚拟<code>DOM</code>实现的一部分，而另一部分就是<code>Fiber</code>架构。当组件状态变化时，<code>React</code>会创建新的<code>Element</code>树，然后通过<code>Diff</code>算法比较新旧两棵树，找出最小变更，最后批量更新真实<code>DOM</code>。</p>
<p>下一章我们将了解整个<code>React</code>应用渲染的起点：容器的挂载</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[js中worker的详细讲解]]></title>    <link>https://juejin.cn/post/7590705425135403017</link>    <guid>https://juejin.cn/post/7590705425135403017</guid>    <pubDate>2026-01-04T01:07:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590705425135403017" data-draft-id="7590699877631770662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="js中worker的详细讲解"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-01-04T01:07:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我的div丢了肿么办"/> <meta itemprop="url" content="https://juejin.cn/user/1310273593440398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            js中worker的详细讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1310273593440398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我的div丢了肿么办
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:07:16.000Z" title="Sun Jan 04 2026 01:07:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">什么是 JavaScript Worker？</h4>
<p>Worker 是在Web应用程序中实现多线程的机制。<br/>
它可以在一个单独的线程中运行脚本，独立于主线程。<br/>
这样，我们可以将一些耗时的计算任务交给Worker线程处理。<br/>
以保证主线程的不会被阻塞。</p>
<h4 data-id="heading-1">为什么需要Worker？</h4>
<p>由于JavaScript是单线程的，所有任务在一个线程上执行。<br/>
如果遇到一个耗时的任务（比如大规模数据计算、图像处理、复杂算法）。<br/>
它会阻塞主线程导致页面无法响应，用户体验变差。<br/>
Worker的出现就是为了解决这个问题，将耗时的计算任务放到后台线程去执行。</p>
<h3 data-id="heading-2">vue2中如何使用 worker</h3>
<p>在vue/cli脚手架中，我们无法直接使用worker。<br/>
因为：<br/>
1，无法将 Worker 脚本打包为独立的可加载文件。<br/>
2，打包后会导致依赖丢失或路径错误。</p>
<pre><code class="hljs language-csharp" lang="csharp">npm install worker-loader -D
或者
yarn <span class="hljs-keyword">add</span> worker-loader -D
</code></pre>
<h4 data-id="heading-3">vue.config.js 配置如下</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">chainWebpack</span>:<span class="hljs-function"><span class="hljs-params">config</span>=&gt;</span>{
    <span class="hljs-comment">// 下面是worker的配置</span>
    .<span class="hljs-title function_">rule</span>(<span class="hljs-string">'worker'</span>)
    .<span class="hljs-title function_">test</span>(<span class="hljs-regexp">/\.worker\.js$/</span>)
    .<span class="hljs-title function_">use</span>(<span class="hljs-string">'worker-loader'</span>)
    .<span class="hljs-title function_">loader</span>(<span class="hljs-string">'worker-loader'</span>)
    .<span class="hljs-title function_">end</span>();

    <span class="hljs-comment">// 解决：worker 热更新问题</span>
    config.<span class="hljs-property">module</span>.<span class="hljs-title function_">rule</span>(<span class="hljs-string">'js'</span>).<span class="hljs-property">exclude</span>.<span class="hljs-title function_">add</span>(<span class="hljs-regexp">/\.worker\.js$/</span>);
  },
  <span class="hljs-attr">parallel</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    <span class="hljs-comment">// 解决：“window is undefined”报错，这个是因为worker线程中不存在window对象，因此不能直接使用，要用this代替</span>
    config.<span class="hljs-property">output</span>.<span class="hljs-title function_">globalObject</span>(<span class="hljs-string">'this'</span>)
  }
}
</code></pre>
<h4 data-id="heading-4">postMessage 子线程给主线发送消息</h4>
<p>self.postMessage子线程向主线程发送消息。<br/>
在 Web Worker 中，self 指向当前创建的这个 worker 线程，self 是一个全局对象。<br/>
self.postMessage()将数据从 worker 线程发送到创建它的主线程。</p>
<h4 data-id="heading-5">主线程通知子线程(worker)开始工作</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建 worker</span>
<span class="hljs-keyword">this</span>.webWorker = new Worker(<span class="hljs-string">'./web.worker.js'</span>)
<span class="hljs-comment">// 通知 Worker 子线程可以进行响应的工作。</span>
<span class="hljs-comment">// 主线程调用worker.postMessage()方法，向 Worker 发消息</span>
<span class="hljs-keyword">this</span>.webWorker.postMessage({ action: <span class="hljs-string">'startFetch'</span> });
</code></pre>
<h4 data-id="heading-6">worker 中来发送网络请求哈</h4>
<p>src\views\element.vue 文件</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>使用worker来发发送网络请求<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendFetchHandler"</span>&gt;</span>开始发送网络请求<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item,index) in apiBackData"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>{{ item.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 导入 worker 文件, 必须使用 这样的方式引入</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WorkerA</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'worker-loader!./web.worker.js'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">apiBackData</span>: []
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">sendFetchHandler</span>(<span class="hljs-params"/>){
      <span class="hljs-comment">// 主线程调用worker.postMessage()方法，向 Worker线程 发消息,开始进行网络请求</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'startFetch'</span> });
    }
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建 worker 实例，名称必须和导入时的保持一致</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkerA</span>(<span class="hljs-string">'./web.worker.js'</span>)
    <span class="hljs-comment">// 先添加事件监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-comment">// e.data 是接收到的数据</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到来自 Worker 的消息:'</span>, e.<span class="hljs-property">data</span>)
      <span class="hljs-comment">// 处理 Worker 返回的数据</span>
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'fetchSuccess'</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">apiBackData</span> = e.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-property">data</span> || []
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取的数据:'</span>,  <span class="hljs-variable language_">this</span>.<span class="hljs-property">apiBackData</span> );
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'fetchError'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取数据失败:'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-property">error</span>);
      }
    })

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Worker发生错误:'</span>, error)
    })
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 引入网络请求中的方法</span>
import {getList} <span class="hljs-keyword">from</span> <span class="hljs-string">'@/request/api.js'</span>

<span class="hljs-built_in">self</span>.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"worker:"</span>, e)
  <span class="hljs-keyword">if</span>(e.data &amp;&amp; e.data.action===<span class="hljs-string">'startFetch'</span>){
    <span class="hljs-comment">//  e.data是主线程发送过来的数据</span>
    <span class="hljs-title function_ invoke__">getList</span>().<span class="hljs-title function_ invoke__">then</span>(res=&gt;{
      console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-number">1111</span>,res)
      // 假设 是一个数组就是请求成功
      <span class="hljs-keyword">if</span>(Array.<span class="hljs-title function_ invoke__">isArray</span>(res)){
        <span class="hljs-comment">//将数据从 worker 线程发送到创建它的主线程</span>
        <span class="hljs-built_in">self</span>.<span class="hljs-title function_ invoke__">postMessage</span>({ 
          <span class="hljs-attr">type</span>: <span class="hljs-string">'fetchSuccess'</span>,
          <span class="hljs-attr">data</span>:{
            <span class="hljs-attr">data</span>:res,
            <span class="hljs-attr">message</span>: <span class="hljs-string">'获取成功'</span>
          }
        });
      }<span class="hljs-keyword">else</span>{
        <span class="hljs-comment">// 将数据从 worker 线程发送到创建它的主线程</span>
        <span class="hljs-built_in">self</span>.<span class="hljs-title function_ invoke__">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'fetchError'</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">'请求失败'</span> });
      }
    })
  }
};
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75505495a6547b584f72e0888246a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093642&amp;x-signature=esBg%2BjRppnepiB8gyms3iJJZzZU%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-7">worker导出表格案例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"exportExcelHandler"</span>&gt;</span>导出excel<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> {writeFile, utils} <span class="hljs-keyword">from</span> <span class="hljs-string">'xlsx'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">exportExcelHandler</span>(<span class="hljs-params"/>){
      <span class="hljs-keyword">let</span> arr = []
      <span class="hljs-comment">// 50w行的数据</span>
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i= <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">500000</span>;i++){
        arr.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">name</span>: <span class="hljs-string">'张'</span> + i,
          <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
          <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>,
          <span class="hljs-attr">id</span>: <span class="hljs-string">'2025_12_12'</span>+ i,
          <span class="hljs-attr">address</span>:<span class="hljs-string">'XX区YYY大道'</span> + i + <span class="hljs-string">'号'</span>
        })
      }
      <span class="hljs-comment">// 将对象数组 arr 转换为 Excel 工作表(sheet)</span>
      <span class="hljs-keyword">const</span> sheet  = utils.<span class="hljs-title function_">json_to_sheet</span>(arr)
      <span class="hljs-comment">// 创建一个新的空工作簿对象。</span>
      <span class="hljs-comment">// 工作簿是 Excel 文件的容器，可以包含多个工作表</span>
      <span class="hljs-keyword">const</span> workbook = utils.<span class="hljs-title function_">book_new</span>()
      <span class="hljs-comment">// 将之前创建的工作表 sheet 添加到工作簿 workbook 中</span>
      utils.<span class="hljs-title function_">book_append_sheet</span>(workbook, sheet, <span class="hljs-string">'sheet1'</span>)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'workbook'</span>, workbook)
      <span class="hljs-comment">// 将整个工作簿 workbook 写入文件并触发浏览器下载</span>
      <span class="hljs-title function_">writeFile</span>(workbook, <span class="hljs-string">'test.xlsx'</span>)
      <span class="hljs-comment">// 主线程调用worker.postMessage()方法，向 Worker线程 发消息,开始进行网络请求</span>
      <span class="hljs-comment">// this.webWorker1.postMessage({ action: 'startFetch', data: this.vueData });</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2520c90977e14ca6a31c773fc946d053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093642&amp;x-signature=VxpaYpsDTTKNTgo5RAKP47Bs8v0%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-8">现在我们使用worker来解决添加数据耗时的问题</h4>
<p>下载xlsx模块。</p>
<pre><code class="hljs language-css" lang="css">npm install <span class="hljs-attr">--save</span> xlsx
</code></pre>
<p>使用worker的文件(下载的主页面)</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"exportExcelHandler"</span>&gt;</span>导出excel<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>

  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 导入 worker 文件, 必须使用 这样的方式引入</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WorkerA</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'worker-loader!./web.worker.js'</span>
<span class="hljs-keyword">import</span> {writeFile} <span class="hljs-keyword">from</span> <span class="hljs-string">'xlsx'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">exportExcelHandler</span>(<span class="hljs-params"/>){
      <span class="hljs-comment">// 主线程调用worker.postMessage()方法，向 Worker线程 发消息,开始进行构造数据</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">action</span>: <span class="hljs-string">'startCreateExcelData'</span>});
    }
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建 worker 实例，名称必须和导入时的保持一致</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkerA</span>(<span class="hljs-string">'./web.worker.js'</span>)
    <span class="hljs-comment">// 先添加事件监听器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到来自 Worker 的消息:'</span>, e.<span class="hljs-property">data</span>)
      <span class="hljs-comment">// 处理 Worker 返回的数据</span>
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'createExcelSuccess'</span>) {
        <span class="hljs-comment">// 返回表的数据</span>
        <span class="hljs-keyword">const</span> workbook = e.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>
        <span class="hljs-comment">// 将整个工作簿 workbook 写入文件并触发浏览器下载。</span>
        <span class="hljs-comment">// 最后异步仍然会卡顿,因为数据量太大了.但是卡顿的时间会比之前好一些</span>
        <span class="hljs-title function_">writeFile</span>(workbook, <span class="hljs-string">'通过worker导处excel.xlsx'</span>)
      } <span class="hljs-keyword">else</span>  {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取数据失败:'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-property">error</span>);
      }
    })

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webWorker1</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Worker发生错误:'</span>, error)
    })
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>worker文件(src\views\web.worker.js )</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 引入 xlsx</span>
import {utils} <span class="hljs-keyword">from</span> <span class="hljs-string">'xlsx'</span>
<span class="hljs-built_in">self</span>.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"worker:"</span>, e)
  <span class="hljs-keyword">if</span>(e.data &amp;&amp; e.data.action===<span class="hljs-string">'startCreateExcelData'</span>){
    <span class="hljs-comment">//  e.data是主线程发送过来的数据</span>
    let arr = []
    <span class="hljs-comment">// 50w行的数据</span>
    <span class="hljs-keyword">for</span>(let i= <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">500000</span>;i++){
      arr.<span class="hljs-title function_ invoke__">push</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'张'</span> + i,
        <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
        <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>,
        <span class="hljs-attr">id</span>: <span class="hljs-string">'2025_12_12'</span>+ i,
        <span class="hljs-attr">address</span>:<span class="hljs-string">'XX区YYY大道'</span> + i + <span class="hljs-string">'号'</span>
      })
    }
    <span class="hljs-comment">// 将对象数组 arr 转换为 Excel 工作表(sheet)</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">sheet</span>  = utils.<span class="hljs-title function_ invoke__">json_to_sheet</span>(arr)
    <span class="hljs-comment">// 创建一个新的空工作簿(book)对象。工作簿是 Excel 文件的容器，可以包含多个工作表(sheet)</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">workbook</span> = utils.<span class="hljs-title function_ invoke__">book_new</span>()
    <span class="hljs-comment">// 将之前创建的工作表 (sheet) 添加到工作簿(workbook)中</span>
    utils.<span class="hljs-title function_ invoke__">book_append_sheet</span>(workbook, sheet, <span class="hljs-string">'sheet1'</span>)
    <span class="hljs-built_in">self</span>.<span class="hljs-title function_ invoke__">postMessage</span>({ 
      <span class="hljs-attr">type</span>: <span class="hljs-string">'createExcelSuccess'</span>,
      <span class="hljs-attr">data</span>:{
        <span class="hljs-attr">data</span>:workbook,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'获取成功'</span>
      }
    });
  }
};
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d7ffee930b24710a957d4abd07bb68e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093642&amp;x-signature=RrGKHkVhCF9HQQrSoH7vxzt7icQ%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-9">关闭 Web Worker</h4>
<p>在主线程和在Worker线程的关闭方式是不一样的。
如果在主线程，调用terminate()方法关闭</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">this</span>.webWorker1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WorkerA</span>(<span class="hljs-string">'./web.worker.js'</span>) 
<span class="hljs-keyword">this</span>.webWorker1.<span class="hljs-built_in">terminate</span>();
</code></pre>
<p>如果是在Work线程，可以调用close()方法进行关闭</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">self</span>.<span class="hljs-built_in">close</span>();
</code></pre>
<h4 data-id="heading-10">主线程关闭 worker 线程的说明</h4>
<p>当主线程调用worker.terminate()时，Worker线程会被立即终止。<br/>
无论当前事件循环中是否有任务，包括微任务和宏任务，都不会继续执行。<br/>
也就是说：如果我在点击[导入excel]按钮后，马上又关闭点击[关闭worker]，那么不能够正常导出表格。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2410306deb3349f4b701210b7946ee2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093642&amp;x-signature=bp8lItRsyuiNaL0ee9NsckyFjLU%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-11">Worker线程内部关闭 worker 线程的说明</h4>
<p>当Worker线程内部调用self.close()时，Worker线程并不会立即终止。<br/>
它会[继续执行当前]事件循环中的任务，但是[会阻止后续]事件循环的任务执行。<br/>
也就是说：如果我在点击[导入excel]按钮后，马上又关闭点击[Worker内部关闭Worker]，仍然可以导出表格。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c321903106440f9a8a03ead44ab39df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR55qEZGl25Lii5LqG6IK_5LmI5Yqe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093642&amp;x-signature=5oz%2BzYg56Fqat1z5Nf0mLQDHbLo%3D" alt="image" loading="lazy"/></p>
<h4 data-id="heading-12">判断用户浏览器是否支持 worker</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Worker</span> !== <span class="hljs-string">'undefined'</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'浏览器支持 Web Workers'</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'浏览器不支持 Web Workers'</span>);
}
</code></pre>
<h4 data-id="heading-13">Worker 线程引用其他js文件</h4>
<p>有些时候，我们需要在worker文件中，引入其他模块的文件。<br/>
可以通过 importScripts() 方法来实现，在 worker 中导入其他的模块。这个地址是可以跨域的。</p>
<h4 data-id="heading-14">Worker 指定模块类型</h4>
<p>如果我们发现我们需要导出的方法使用的是ESModule 模式导出。<br/>
此时使用 importScripts() 方法引入他模块，会报错。<br/>
此时需要指定模块类型。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// main.js（主线程的代码）</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-built_in">new</span> Worker(<span class="hljs-string">'/worker.js'</span>, {
    <span class="hljs-keyword">type</span>: <span class="hljs-string">'module'</span>  <span class="hljs-comment">// 指定 worker.js 的类型</span>
});
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// worker.js（worker线程的代码）</span>
import <span class="hljs-keyword">add</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>; <span class="hljs-comment">// 导入外部js</span>

self.addEventListener(<span class="hljs-string">'message'</span>, e =&gt; { 
    postMessage(e.data);
});

<span class="hljs-keyword">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
</code></pre>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils.js 使用了ESModule 模块导出的 add 方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> add = <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b;
</code></pre>
<h4 data-id="heading-15">使用worker的注意事项</h4>
<p>1，worker不能使用window上的dom操作，也不能获取dom对象,dom相关的东西只有主线程有。worker只能做一些计算相关的操作<br/>
2，有的东西是无法通过主线程传递个子线程的。<br/>
比如：方法，dom节点，一些对象里的特殊设置(freeze,getter,setter这些)所以vue的响应式对象在传递之后就会变成普通对象</p>
<h4 data-id="heading-16">worker实际应用案例</h4>
<p>1，将语法检查、代码压缩等任务放在 Worker 中执行<br/>
2，图像处理：比如使用Canvas处理图片，进行滤镜</p>
<h4 data-id="heading-17">worker性能优化建议</h4>
<p>减少通信开销：避免频繁传递大量数据，必要时使用 Transferable Objects（如 ArrayBuffer）<br/>
批量处理：对于大批量任务，可批量创建 Worker 并行处理<br/>
常驻线程：对于频繁使用的 Worker，可保持常驻而非重复创建<br/>
错误处理：始终监听 onerror 事件，捕获 Worker 内部的异常</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nextjs学习4：创建服务端 API（路由处理程序）]]></title>    <link>https://juejin.cn/post/7591177139660554294</link>    <guid>https://juejin.cn/post/7591177139660554294</guid>    <pubDate>2026-01-04T01:13:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591177139660554294" data-draft-id="7582776967817166848" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nextjs学习4：创建服务端 API（路由处理程序）"/> <meta itemprop="keywords" content="Next.js"/> <meta itemprop="datePublished" content="2026-01-04T01:13:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一江东流水"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917181880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nextjs学习4：创建服务端 API（路由处理程序）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917181880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一江东流水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:13:21.000Z" title="Sun Jan 04 2026 01:13:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前后端分离架构中，客户端与服务端之间通过 API 接口来交互。这个API 接口在 Next.js 中有个更为正式的称呼，就是<strong>路由处理程序</strong>。</p>
<h2 data-id="heading-0">定义路由处理程序</h2>
<p>写路由处理程序，你需要定义一个名为 <code>route.js</code>的特殊文件。（注意是 <code>route</code> 不是 <code>router</code>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93becba8e90944ef90a6740b6277caca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768094001&amp;x-signature=%2FWQ4kkkXRzJGf%2Bug3BTGTewMczU%3D" alt="image.png" loading="lazy"/></p>
<p>该文件必须在 <code>app</code>目录下，可以在 <code>app</code> 嵌套的文件夹下，但是要注意 <code>page.js</code>和 <code>route.js</code>不能在同一层级同时存在。</p>
<p>想想也能理解，<code>page.js</code>和 <code>route.js</code>本质上都是对路由的响应。<code>page.js</code>主要负责渲染 UI，<code>route.js</code>主要负责处理请求。如果同时存在，Next.js 就不知道用谁的逻辑了。</p>
<h3 data-id="heading-1">GET 请求</h3>
<p>让我们从写 GET 请求开始，比如写一个获取文章列表的接口。</p>
<p>新建 <code>app/api/posts/route.js</code> 文件，代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/server'</span>
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/posts'</span>)
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
 
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({ data })
}
</code></pre>
<p>浏览器访问 <code>http://localhost:3000/api/posts</code> 查看接口返回的数据：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16018a9457744d00a28147ad266b5860~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768094001&amp;x-signature=iiLxixrg%2F4OMUV8x%2FK98WNLQk5c%3D" alt="image.png" loading="lazy"/></p>
<p>在这个例子中：</p>
<ol>
<li>
<p>我们 <code>export</code> 一个名为 <code>GET</code> 的 <code>async</code> 函数来定义 GET 请求处理，注意是 export 而不是 export default</p>
</li>
<li>
<p>我们使用 <code>next/server</code> 的 NextResponse 对象用于设置响应内容，但这里不一定非要用 <code>NextResponse</code>，直接使用 <code>Response</code> 也是可以的。</p>
</li>
<li>
<p>我们将接口写在了 <code>app/api</code> 文件夹下，并不是因为接口一定要放在名为 <code>api</code> 文件夹下。如果你代码写在 <code>app/posts/route.js</code>，对应的接口地址就是 <code>/posts</code>。放在 <code>api</code> 文件夹下只是为了方便区分地址是接口还是页面。</p>
</li>
</ol>
<p>但在实际开发中，推荐使用 <code>NextResponse</code>，因为它是 Next.js 基于 <code>Response</code> 的封装，它对 TypeScript 更加友好，同时提供了更为方便的用法，比如获取 Cookie 等。</p>
<h3 data-id="heading-2">支持方法</h3>
<p>Next.js 支持 <code>GET</code>、<code>POST</code>、<code>PUT</code>、<code>PATCH</code>、<code>DELETE</code>、<code>HEAD</code> 和 <code>OPTIONS</code> 这些 HTTP 请求方法。如果传入了不支持的请求方法，Next.js 会返回 <code>405 Method Not Allowed</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// route.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request</span>) {}
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HEAD</span>(<span class="hljs-params">request</span>) {}
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">request</span>) {}
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PUT</span>(<span class="hljs-params">request</span>) {}
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DELETE</span>(<span class="hljs-params">request</span>) {}
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PATCH</span>(<span class="hljs-params">request</span>) {}
 
<span class="hljs-comment">// 如果 `OPTIONS` 没有定义, Next.js 会自动实现 `OPTIONS`</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">OPTIONS</span>(<span class="hljs-params">request</span>) {}
</code></pre>
<p>继续修改 <code>app/api/posts/route.js</code>，添加代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">const</span> article = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>()
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>({
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">8</span>),
    <span class="hljs-attr">data</span>: article
  }, { <span class="hljs-attr">status</span>: <span class="hljs-number">201</span> })
}
</code></pre>
<h3 data-id="heading-3">传入参数</h3>
<p>现在让我们具体看下请求方法。每个请求方法的处理函数会被传入两个参数，一个 <code>request</code>，一个 <code>context</code> 。两个参数都是可选的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request, context</span>) {}
</code></pre>
<p>request 对象是一个 <a href="https://juejin.cn/book/7307859898316881957/section/7309079651500949530#heading-23" title="https://juejin.cn/book/7307859898316881957/section/7309079651500949530#heading-23" target="_blank">NextRequest</a> 对象，它是基于 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FRequest" title="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FRequest" target="_blank">Web Request API</a> 的扩展。使用 request ，你可以快捷读取 cookies 和处理 URL。</p>
<p>我们这里讲讲如何获取 URL 参数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request, context</span>) {
  <span class="hljs-comment">//  访问 /home, pathname 的值为 /home</span>
  <span class="hljs-keyword">const</span> pathname = request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>
  <span class="hljs-comment">// 访问 /home?name=lee, searchParams 的值为 { 'name': 'lee' }</span>
  <span class="hljs-keyword">const</span> searchParams = request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">searchParams</span>
}
</code></pre>
<p>其中 nextUrl 是基于 Web URL API 的扩展（如果你想获取其他值，参考 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FURL" title="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FURL" target="_blank">URL API</a>），同样提供了一些方便使用的方法。</p>
<h4 data-id="heading-4">context (optional)</h4>
<p>目前<code>context</code> 只有一个值就是 <code>params</code>，它是一个包含当前动态路由参数的对象。举个例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// app/dashboard/[team]/route.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request, { params }</span>) {
  <span class="hljs-keyword">const</span> team = params.<span class="hljs-property">team</span>
}
</code></pre>
<p>示例代码：</p>
<p>需求：目前 GET 请求 <code>/api/posts</code> 时会返回所有文章数据，现在希望 GET 请求 <code>/api/posts/1?dataField=title</code> 获取 post id 为 1 的文章数据，dataField 用于指定返回哪些字段数据。</p>
<p>新建 <code>/api/posts/[id]/route.js</code>，代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/server'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request, { params }</span>) {
  <span class="hljs-keyword">const</span> field = request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"dataField"</span>)
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> ((<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://jsonplaceholder.typicode.com/posts/<span class="hljs-subst">${params.id}</span>`</span>)).<span class="hljs-title function_">json</span>())
  <span class="hljs-keyword">const</span> result = field ? { [field]: data[field] } : data
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(result)
}
</code></pre>
<p>现在有了服务端 API ，客户端组件也可以使用 axios 或 fetch 来请求数据了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nextjs学习5：Suspense 与 Streaming]]></title>    <link>https://juejin.cn/post/7590330924001853503</link>    <guid>https://juejin.cn/post/7590330924001853503</guid>    <pubDate>2026-01-04T01:35:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001853503" data-draft-id="7582783931163148323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nextjs学习5：Suspense 与 Streaming"/> <meta itemprop="keywords" content="Next.js"/> <meta itemprop="datePublished" content="2026-01-04T01:35:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一江东流水"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917181880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nextjs学习5：Suspense 与 Streaming
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917181880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一江东流水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:35:05.000Z" title="Sun Jan 04 2026 01:35:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Suspense</code> 是 Next.js 项目中常用的一个组件，了解其原理和背景有助于我们正确使用 <code>Suspense</code> 组件。</p>
<h2 data-id="heading-0">传统 SSR</h2>
<p>传统 SSR，需要经过一系列的步骤，用户才能查看页面、与之交互。</p>
<p>具体这些步骤是：</p>
<ol>
<li>服务端获取所有数据；</li>
<li>服务端渲染 HTML；</li>
<li>将页面的 HTML、CSS、JavaScript 发送到客户端；</li>
<li>使用 HTML 和 CSS 生成不可交互的用户界面（non-interactive UI）；</li>
<li>React 对用户界面进行水合（hydrate），使其可交互（interactive UI）；</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7b20b7be5e548ccad0115bb7290cb69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=8oGXAAgwYYSEaQN5G9SRJyhGsCE%3D" alt="image.png" loading="lazy"/></p>
<p>这些步骤是连续的、阻塞的。这意味着服务端只能在获取所有数据后渲染 HTML，React 只能在下载了所有组件代码后才能进行水合：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa275175615468695e714e4eefe3212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=TSz0K1LR%2FLdO6H2%2Br7RUaq%2Fl7ag%3D" alt="image.png" loading="lazy"/></p>
<p>传统 SSR 几个缺点如下：</p>
<ol>
<li><strong>SSR 的数据获取必须在组件渲染之前</strong></li>
<li><strong>组件的 JavaScript 必须先加载到客户端，才能开始水合</strong></li>
<li><strong>所有组件必须先水合，然后才能跟其中任意一个组件交互</strong>；</li>
</ol>
<h2 data-id="heading-1">Suspense</h2>
<p>为了解决这些问题，React 18 引入了 <code>&lt;Suspense&gt;</code> 组件。</p>
<p><code>&lt;Suspense&gt;</code> 允许你推迟渲染某些内容，直到满足某些条件（例如数据加载完毕）。</p>
<p>你可以将动态组件包装在 Suspense 中，然后向其传递一个 fallback UI，以便在动态组件加载时显示。</p>
<p><strong>如果数据请求缓慢，使用 Suspense 流式渲染该组件，不会影响页面其他部分的渲染，更不会阻塞整个页面</strong>。</p>
<p>让我们来写一个例子，新建 <code>app/dashboard/page.js</code>，代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Suspense</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">sleep</span> = ms =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, ms));

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PostFeed</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">2000</span>)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello PostFeed<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Weather</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">8000</span>)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello Weather<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Recommend</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">5000</span>)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello Recommend<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Dashboard</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{padding:</span> '<span class="hljs-attr">20px</span>'}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">p</span>&gt;</span>Loading PostFeed Component<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">PostFeed</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">p</span>&gt;</span>Loading Weather Component<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Weather</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">p</span>&gt;</span>Loading Recommend Component<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Recommend</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span>
  )
}
</code></pre>
<p>在这个例子中，我们用 Suspense 包装了三个组件，并通过 sleep 函数模拟了数据请求耗费的时长。加载效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3fd5c32e4404149ad4d5b38c8352016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=MlxoTlJTTsZC0z8x9wcKdQydMOQ%3D" alt="60be4c9076614e16934f26215a242841~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75.awebp" loading="lazy"/></p>
<p>让我们观察下 dashboard 这个 HTML 文件的加载情况，你会发现它一开始是 2.03s，然后变成了 5.03s，最后变成了 8.04s，这不就正是我们设置的 sleep 时间吗？</p>
<p>查看 dashboard 请求的响应头：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ea40e899a2446e2a0ca81cd82cdecd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=u6pQ2Y9gthlX3xESLkjR2fjyOQw%3D" alt="image.png" loading="lazy"/></p>
<p><strong><code>Transfer-Encoding</code> 标头的值为 <code>chunked</code>，表示数据将以一系列分块的形式进行发送</strong>。</p>
<blockquote>
<p>分块传输编码（Chunked transfer encoding）是超文本传输协议（HTTP）中的一种数据传输机制，允许 HTTP 由网页服务器发送给客户端应用（ 通常是网页浏览器）的数据可以分成多个部分。分块传输编码只在 HTTP 协议1.1版本（HTTP/1.1）中提供。</p>
</blockquote>
<p>再查看 dashboard 返回的数据（这里我们做了简化）：</p>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        // ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"__className_aaf875"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"padding:20px"</span>&gt;</span>
            <span class="hljs-comment">&lt;!--$?--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"B:0"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading PostFeed Component<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-comment">&lt;!--/$--&gt;</span>
            <span class="hljs-comment">&lt;!--$?--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"B:1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading Weather Component<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-comment">&lt;!--/$--&gt;</span>
            <span class="hljs-comment">&lt;!--$?--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"B:2"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading Recommend Component<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-comment">&lt;!--/$--&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
        // ...
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">hidden</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"S:0"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello PostFeed<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
            <span class="hljs-comment">// 交换位置</span>
            $RC = <span class="hljs-keyword">function</span>(<span class="hljs-params">b, c, e</span>) {
                <span class="hljs-comment">// ...</span>
            };
            $RC(<span class="hljs-string">"B:0"</span>, <span class="hljs-string">"S:0"</span>)
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">hidden</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"S:2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello Recommend<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
            $RC(<span class="hljs-string">"B:2"</span>, <span class="hljs-string">"S:2"</span>)
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">hidden</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"S:1"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello Weather<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
            $RC(<span class="hljs-string">"B:1"</span>, <span class="hljs-string">"S:1"</span>)
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>

</code></pre>
<p>可以看到使用 Suspense 组件的 fallback UI 和渲染后的内容都会出现在该 HTML 文件中，<strong>说明该请求持续与服务端保持连接，服务端在组件渲染完后会将渲染后的内容追加传给客户端</strong>。</p>
<p>客户端收到新的内容后进行解析，执行类似于 <code>$RC("B:2", "S:2")</code>这样的函数交换 DOM 内容，使 fallback UI 替换为渲染后的内容。</p>
<p>这个过程被称之为 <strong>Streaming Server Rendering（流式渲染）</strong>，<strong>它解决了上节说的传统 SSR 的第一个问题，那就是数据获取必须在组件渲染之前</strong>。使用 Suspense，先渲染 Fallback UI，等数据返回再渲染具体的组件内容。</p>
<p>使用 Suspense 还有一个好处就是 <strong>Selective Hydration（选择性水合）</strong>。简单的来说，当多个组件等待水合的时候，React 可以根据用户交互决定组件水合的优先级。比如 Sidebar 和 MainContent 组件都在等待水合，快要到 Sidebar 了，但此时用户点击了 MainContent 组件，React 会在单击事件的捕获阶段同步水合 MainContent 组件以保证立即响应，Sidebar 稍后水合。</p>
<h2 data-id="heading-2">Streaming</h2>
<p><strong>Suspense 背后的这种技术称之为 Streaming</strong>。</p>
<p><strong>将页面的 HTML 拆分成多个 chunks，然后逐步将这些块从服务端发送到客户端。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1134a44111224c3f9ec4ec38c457a26a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=0n356kbxyoCgIfFfXLqX2myGrsY%3D" alt="image.png" loading="lazy"/></p>
<p>简单理解：</p>
<ul>
<li><strong>核心逻辑</strong>：服务器在生成 HTML 时，不用等所有数据（比如接口请求、数据库查询）都返回，而是<strong>先把页面的静态骨架（导航、页脚、空的内容容器）以 chunk 块的形式发给浏览器</strong>，浏览器收到后立刻渲染出骨架，减少白屏时间。</li>
<li>之后服务器再逐个获取动态数据（比如商品列表、文章内容），每拿到一部分就生成对应的 HTML 片段，再以 chunk 块发送给浏览器，浏览器接收到后<strong>增量插入到页面中</strong>，页面内容逐步 <strong>填充</strong> 完成。</li>
<li><strong>技术依赖</strong>：就是我们之前说的 HTTP 分块传输（<code>Transfer-Encoding: chunked</code>）或 HTTP/2 二进制分帧，Next.js、Nuxt.js 等框架的 SSR 流式渲染都是这么实现的。</li>
</ul>
<p>这样就可以更快的展现出页面的某些内容，而无需在渲染 UI 之前等待加载所有数据。</p>
<p><strong>提前发送的组件可以提前开始水合，这样当其他部分还在加载的时候，用户可以和已完成水合的组件进行交互，有效改善用户体验</strong>。</p>
<p>传统 SSR：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce5dfd0d23004d1a9ccb8436d4af61f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=y98HaoMnwMTV75Ua9J0LqWtAQXw%3D" alt="image.png" loading="lazy"/></p>
<p>使用 Streaming 后：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4072d62dfa1a430999f3d08c3753688e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=MPGbAuejwxPjr6HSYGVwcGum89U%3D" alt="image.png" loading="lazy"/></p>
<p><strong>在 Next.js 中有两种实现 Streaming 的方法</strong>：</p>
<ol>
<li><strong>页面级别，使用 <code>loading.jsx</code></strong></li>
<li><strong>特定组件，使用 <code>&lt;Suspense&gt;</code></strong></li>
</ol>
<p>Suspense 和 Streaming 确实很好，将原本只能先获取数据、再渲染水合的传统 SSR 改为<strong>渐进式渲染水合</strong>。</p>
<p>但还有一些问题没有解决：</p>
<p><strong>1. 用户下载的 JavaScript 代码，该下载的代码还是没有少，可是用户真的需要下载那么多的 Javascript 代码吗？</strong></p>
<p><strong>2. 所有的组件都必须在客户端进行水合，对于不需要交互性的组件其实没有必要进行水合。</strong></p>
<p>要解决这个问题，就是服务端组件要解决的问题了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31b72c972bf74068af79234745f61944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=3ZhK6XvgutXLLh%2Fv11eK8SezfzQ%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[⚡开发者神器来了！Anthropic官方Ralph Wiggum插件深度实测：让Claude Code变身永不停歇的全自动开发机器！告别手动调试！iOS原生应用]]></title>    <link>https://juejin.cn/post/7591066233670156314</link>    <guid>https://juejin.cn/post/7591066233670156314</guid>    <pubDate>2026-01-04T03:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591066233670156314" data-draft-id="7591079707698774026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="⚡开发者神器来了！Anthropic官方Ralph Wiggum插件深度实测：让Claude Code变身永不停歇的全自动开发机器！告别手动调试！iOS原生应用"/> <meta itemprop="keywords" content="Claude,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-04T03:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ⚡开发者神器来了！Anthropic官方Ralph Wiggum插件深度实测：让Claude Code变身永不停歇的全自动开发机器！告别手动调试！iOS原生应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:24:33.000Z" title="Sun Jan 04 2026 03:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">让 Claude Code “别停”：Ralph Wiggum 插件到底解决了什么问题？</h2>
<p>如果你用过各种 AI 编程工具，大概率遇到过同一种憋屈：它写完一段代码、改完几个文件，就觉得差不多完成了，然后停下，留你一个人面对构建没过、测试红了一片、UI 细节还差一口气、某个边界 case 依然崩。</p>
<p>真实开发从来不是一次性写完，而是写一点 → 跑一下 → 报错 → 修 → 再跑 → 再修，循环往复，直到达标。</p>
<p>Ralph Wiggum 这个 Claude Code 官方插件的厉害之处就在于：它不试图更聪明地写代码，而是把 Claude Code 变成一个可控的持续迭代执行器。你设定规则，它就按回合制一直推进，直到满足退出条件才停。</p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1zyiiBRE32%2F" target="_blank" title="https://www.bilibili.com/video/BV1zyiiBRE32/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1zy…</a></p>
<hr/>
<h3 data-id="heading-1">1）Ralph Wiggum 是什么：不是新模型，而是一个外部控制回路</h3>
<p>Ralph 的本质非常朴素：Claude 每次想退出时，把它拦下来，再把同一个任务喂回去继续做。</p>
<p>它依赖的是 Claude Code 的 Stop hook 机制：当 Claude 觉得自己做完了准备结束，插件的 stop hook 会介入，阻止退出并触发下一轮。</p>
<p>所以 Ralph 的核心价值不是灵感，而是节奏。它把复杂工程变成稳定的回合制推进：</p>
<ul>
<li>本轮做什么</li>
<li>本轮怎么验证</li>
<li>不达标就下一轮继续修</li>
<li>达标才允许结束</li>
</ul>
<hr/>
<h3 data-id="heading-2">2）它为什么叫 Ralph Wiggum：幼稚，但非常有效的坚持</h3>
<p>这个名字来自辛普森一家里的 Ralph Wiggum：经常犯错、经常翻车，但也会像小孩一样继续尝试，直到把事情做对。很多人第一次看到这个名字会觉得离谱，但用过之后反而会觉得贴切。工程里最稀缺的不是聪明，是不停下来把烂尾收掉的耐心。</p>
<hr/>
<h3 data-id="heading-3">3）怎么用：三条命令 + 两个关键参数</h3>
<p>不同环境里你可能看到简写，但更稳的理解方式是按命名空间写法来记。Claude Code 的插件命令通常以 插件名: 作为前缀。</p>
<p>常见命令是这三条：</p>
<ul>
<li>启动循环：/ralph-wiggum:ralph-loop 提示词 --max-iterations N</li>
<li>取消循环：/ralph-wiggum:cancel-ralph</li>
<li>查看说明：/ralph-wiggum:help</li>
</ul>
<p>然后是两个你一定会用上的参数。</p>
<p>max-iterations<br/>
给循环加保险丝。否则任务一旦写得太泛、验收条件不清晰，就可能跑很久。这个参数让它最多迭代 N 轮，到点强制停。</p>
<p>completion-promise<br/>
这是 Ralph 的灵魂：明确什么情况下算完成。插件会盯着 Claude 的输出，一旦出现你指定的完成标记，就允许退出。</p>
<p>你会发现，这里真正让循环可控的不是迭代次数，而是验收口径。</p>
<hr/>
<h3 data-id="heading-4">4）最重要的一点：Ralph 不会替你想清楚验收标准</h3>
<p>很多人第一次用 Ralph，会把提示词写成一句话：把项目变好、修复 bug、优化一下 UI。然后跑到第 10 轮，发现效果并不稳定。不是 Ralph 不行，而是你给了一个无法验证的目标。</p>
<p>Ralph 的正确打开方式是：把开发任务写成可验证的交付清单。</p>
<p>比如你可以这样表达：</p>
<ul>
<li>把登录页做得更专业</li>
<li>页面在移动端和桌面端都不溢出</li>
<li>表单校验：邮箱格式不对时提示；密码少于 8 位提示</li>
<li>交互：按钮有 hover 与 disabled 状态</li>
<li>跑测试全绿或构建通过</li>
<li>满足以上条件后输出指定的完成标记</li>
</ul>
<p>注意完成标记最好写得不容易误判，比如用一个很独特的字符串，而不是随口就可能出现的 done。</p>
<hr/>
<h3 data-id="heading-5">5）哪些场景最适合：Ralph 的强项其实是收尾活</h3>
<p>Ralph 把 Claude Code 变成持续循环，特别适合那些需要多轮纠错的任务。</p>
<p>我建议你优先把 Ralph 用在这四类最折磨人的真实场景：</p>
<p>A. Bug 修复<br/>
尤其是修了又冒出来的那种。让它每轮都复现 → 定位 → 修复 → 运行测试或构建 → 再复现确认。你只需要把复现步骤和通过条件写清楚。</p>
<p>B. 补测试与回归<br/>
这类任务天然需要循环：补一个测试 → 失败 → 修实现 → 再补下一个。测试全绿本身就是最清晰的完成信号。</p>
<p>C. 依赖迁移与大版本升级<br/>
比如测试框架迁移、路由升级、构建工具替换。迁移最怕半吊子：能编译但跑不起来。循环跑构建和测试，才会把尾巴收干净。</p>
<p>D. 重构<br/>
重构最需要节奏：改一部分 → 验证 → 再改一部分。Ralph 的回合制非常适合把重构拆成稳定推进的工程动作。</p>
<hr/>
<h3 data-id="heading-6">6）它为什么有效：因为它把反馈变成了下一轮的燃料</h3>
<p>很多 AI 编程失败，并不是因为模型不会写，而是因为它拿不到足够强的反馈闭环。写完就停，等于把最关键的报错信息、测试结果、构建日志丢掉了。</p>
<p>Ralph 强制你进入一种更接近现实开发的流程：</p>
<ul>
<li>这轮做了什么</li>
<li>这轮验证结果是什么</li>
<li>下一轮必须基于这些反馈继续修正</li>
</ul>
<p>反馈越具体，下一轮越准。这种机制在工程里当然有效，因为我们人类就是这么迭代出来的。</p>
<hr/>
<h3 data-id="heading-7">7）你需要提前知道的坑：它很强，但也不是无脑开挂</h3>
<p>坑 1：安全限制导致的换行报错<br/>
有些环境里，Ralph 可能触发 Claude Code 对多行命令的安全检查，导致无法启动循环。通常的规避方式是把提示词写成单行，把长要求放到文件里，再让 Claude 去读。</p>
<p>坑 2：Windows 环境依赖问题<br/>
有人在 Windows 或某些 shell 环境里遇到 stop hook 因为缺少依赖而失败。遇到这类问题，优先检查运行环境和常用命令是否齐全。</p>
<p>坑 3：忘记加保险丝，成本会飙<br/>
不开 max-iterations，再配上模糊的验收条件，跑着跑着就会变成自动烧钱烧时间的机器。正确姿势永远是上限 + 明确验收。</p>
<hr/>
<h3 data-id="heading-8">8）最后给一个公众号式结论：Ralph 的核心理念是什么？</h3>
<p>一句话概括：</p>
<p>让 Claude Code 负责写代码，让 Ralph Wiggum 负责让它别停，直到你定义的完成真的完成。</p>
<p>它把 AI 编程从一次性回答拉回到工程迭代，把最现实、最关键、也最容易烂尾的那部分工作：测试、修错、收尾，变成了可以自动推进的流程。</p>
<p>如果你曾经被差一点就好了的 AI 编程体验气到，那 Ralph 很可能会让你第一次觉得：AI 不是写完就走，而是能把项目真正跑通。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 白屏机制原理分析[共1500字，阅读时长8min]]]></title>    <link>https://juejin.cn/post/7590403249561649167</link>    <guid>https://juejin.cn/post/7590403249561649167</guid>    <pubDate>2026-01-04T02:12:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561649167" data-draft-id="7590681158716473384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 白屏机制原理分析[共1500字，阅读时长8min]"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-04T02:12:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="仙人掌一号"/> <meta itemprop="url" content="https://juejin.cn/user/814057212357645"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 白屏机制原理分析[共1500字，阅读时长8min]
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/814057212357645/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    仙人掌一号
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:12:27.000Z" title="Sun Jan 04 2026 02:12:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">白屏是什么</h3>
<p>白屏是React主动防御机制，React团队认为，显示错误的UI比不显示任何内容更糟糕（例如，转账金额显示错误），因此React遇到无法处理的异常，会选择卸载掉整个组件树。对比着看，原生直接操作DOM的方式通常不会造成白屏的现象，而是会停留在错误发生前的状态。</p>
<h3 data-id="heading-1">React渲染机制</h3>
<p>白屏的出现与React渲染机制息息相关，白屏实际就是：React渲染过程中发生了未捕获错误，React内部错误处理机制，捕获了该错误，然后进行组件卸载，防止显示错误UI。下图是React的渲染流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511ffab692214dfa903ea37f1a089f6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuZ5Lq65o6M5LiA5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097547&amp;x-signature=Zlc%2BM0PBQl2qnDJo5de8OKgYMQY%3D" alt="image.png" loading="lazy"/>
主要可以分为两个阶段：</p>
<h4 data-id="heading-2">Render阶段</h4>
<p>根据 JSX转换的ReactElement节点 +旧的Fiber节点树 构建出新的Fiber节点树（Fiber可以被看作为是虚拟DOM）。</p>
<h4 data-id="heading-3">Commit阶段</h4>
<p>根据Render阶段得出的新的Fiber树更新DOM。</p>
<h4 data-id="heading-4">渲染触发时机</h4>
<ol>
<li>组件初始化。</li>
<li>通过setState触发组件状态更新。</li>
</ol>
<p><strong>组件初始化</strong>和<strong>状态变更</strong>都会走这套渲染流程，只不过会根据Mount阶段/Update阶段的不同，一些处理逻辑不同，整体流程都是一样的。</p>
<h3 data-id="heading-5">白屏机制</h3>
<h4 data-id="heading-6">Render阶段</h4>
<p>在源码中，可以把<strong>workLoopSync</strong>函数看作是React的<strong>Render</strong>阶段，workLoopSync是被try/catch包裹的。一旦workLoopSync过程中遇到<strong>不可处理且未捕获的错误</strong>，如a是undefined，代码中读取a.b.c，这会导致空指针错误，并且这个错误会被try/catch所捕获，进入<strong>handleError</strong>函数中。在handleError函数中会触发React的白屏逻辑和Errorboundary逻辑。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0992eb98f44d471c983edebafe6c905f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuZ5Lq65o6M5LiA5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097547&amp;x-signature=LFLkQRT%2FMT%2ByD3W7ofbGueIhv%2BI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>总结</strong>：当 Render 阶段（如 workLoopSync 构建 Fiber 树）发生未捕获的 JavaScript 错误时，React 会利用内部的 try/catch 捕获异常。为了防止渲染出数据不一致或损坏的 UI，React 会选择卸载整个组件树（即白屏）。</p>
<h4 data-id="heading-7">commit阶段</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffb63c93b2dd4e77b8fe2753657ce51f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuZ5Lq65o6M5LiA5Y-3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097547&amp;x-signature=90IlcyuxqkyppjFl2dnQQwzl1U4%3D" alt="image.png" loading="lazy"/></p>
<p>虽然<strong>Render</strong>阶段调用的是<strong>handleError</strong>，<strong>Commit</strong>阶段调用的是<strong>captureCommitPhaseError</strong>，但是两个函数在处理白屏逻辑是相似的，可以简单认为是一样的。</p>
<p>commit阶段的流程包括：更新DOM，执行useLayoutEffect，执行useEffect。这三部分都被React内置的try/catch 包裹，异常处理函数是<strong>captureCommitPhaseError</strong>。如果Commit阶段，代码抛出了未捕获的错误，仍然会触发<strong>captureCommitPhaseError</strong>函数。</p>
<h3 data-id="heading-8">白屏例子</h3>
<h5 data-id="heading-9">第一个例子</h5>
<p>最典型的白屏例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page404</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"fx-center mt-80"</span>&gt;</span>{data.message}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>上述代码的执行流程是：</p>
<ol>
<li>编译时 ：<strong>JSX</strong>转变为<strong>React.createElement/_jsx</strong>，创建ReactElement的函数语句.</li>
<li>运行时 ：组件 Render 过程中， _jsx 函数读取参数，因 data.message 求值失败抛出 TypeError。React 捕获这个错误后，触发了全量的 Unmount 保护机制 ，导致白屏。如果存在ErrorBoundary组件，则会使用Error Boundary兜底。</li>
</ol>
<h5 data-id="heading-10">第二个例子</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page404</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">a</span>.<span class="hljs-property">b</span>)

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"fx-center mt-80"</span>&gt;</span>{data || null}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这段代码同样也会发生白屏，本质上， 函数组件的<strong>函数体执行本身</strong>就是 Render 阶段的一部分 。React 在构建 Fiber 树时会直接调用该组件函数。因此， <strong>console.log(data.a.b)</strong> 抛出的空指针异常，会直接被 React 内部的try/catch捕获，进入<strong>handleError</strong>函数，<strong>React 卸载整个组件树，从而导致白屏</strong>。</p>
<h5 data-id="heading-11">第二个例子改进</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page404</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">a</span>.<span class="hljs-property">b</span>)
  } <span class="hljs-keyword">catch</span> (error) {

  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"fx-center mt-80"</span>&gt;</span>{data || '404'}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>console.log(data.a.b)</strong> 虽然发生了错误，但因为使用了 try/catch ，这个错误没有抛出给 React内部的try/catch，所以 React 并不知情。</p>
<h5 data-id="heading-12">第三个例子（这个例子很重要）</h5>
<p>点击按钮的时候，是否会发生白屏错误？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page404</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">a</span>.<span class="hljs-property">b</span>.<span class="hljs-property">c</span>)
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"fx-center mt-80"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>404<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{data || '404'}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>答案是：不会</p>
<p>当用户点击按钮时， Render 阶段早已结束 ，Commit 阶段也结束了，UI 已经稳定地显示在屏幕上。之前我们说过Render过程的未捕获错误，才会被React内部的try/catch所捕获。</p>
<p>总结： 这个例子表明不是发生了JS错误，就会白屏。白屏对发生时机有着严格要求，必须是渲染过程中，项目才会白屏。</p>
<h5 data-id="heading-13">第四个例子</h5>
<p>点击按钮的时候，是否会发生白屏错误？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page404</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>({<span class="hljs-attr">message</span>:<span class="hljs-string">"404"</span>})

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setData</span>(<span class="hljs-literal">null</span>)
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"fx-center mt-80"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>404<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{data.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>答案是：会
当用户点击按钮时，调用handleClick函数，执行 setData(null) 修改状态，这会触发当前组件重新渲染。在Render过程中，因为data被更新为null，代码执行到 《h1》 {data.message}《/h1》（掘金用h1标签就自动变大了，因此用《》代替&lt;&gt;），因为data是null，代码会抛出空指针报错，这会被React内部的try/catch所捕获，从而触发白屏逻辑。</p>
<h5 data-id="heading-14">第五个例子</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page404</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">a</span>.<span class="hljs-property">b</span>.<span class="hljs-property">c</span>)
  }, [])

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"fx-center mt-80"</span>&gt;</span>404<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>答案是：会白屏
虽然 useEffect 是异步执行的，但它是由 React Scheduler（调度器） 接管的。当 Commit 阶段完成后，Scheduler 会调度并执行 flushPassiveEffects 方法来处理所有副作用。<br/>
在此过程中，React 会显式地用 try-catch 包裹回调函数的执行。因此， data.a.b.c 抛出的空指针异常会被 React 精确捕获，并触发 captureCommitPhaseError 流程。</p>
<h3 data-id="heading-15">总结</h3>
<p>白屏是组件渲染过程中抛出未捕获的错误，被React内部的错误处理机制捕获，从而触发的一种主动防御的机制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6.2 列传（第十五篇）：王语嫣的《万剑归宗》与 InlineArray]]></title>    <link>https://juejin.cn/post/7590330924002508863</link>    <guid>https://juejin.cn/post/7590330924002508863</guid>    <pubDate>2026-01-04T03:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924002508863" data-draft-id="7590735421262004265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6.2 列传（第十五篇）：王语嫣的《万剑归宗》与 InlineArray"/> <meta itemprop="keywords" content="Swift,编程语言,Apple"/> <meta itemprop="datePublished" content="2026-01-04T03:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6.2 列传（第十五篇）：王语嫣的《万剑归宗》与 InlineArray
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:24:34.000Z" title="Sun Jan 04 2026 03:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7363d0e01524c69af83943332a28590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=%2B54zbSwO5e5VTwYVeaR%2FkyXjGR8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p><strong>摘要</strong>：当动态数组的随性（<strong>Array</strong>）与元组的刻板（<strong>Tuple</strong>）陷入两难，高性能的内联数组（<strong>InlineArray</strong>）横空出世。Swift 6.2 引入的 SE-0453 就像是武学中的“万剑归宗”，旨在以固定大小的内存布局，解决性能与灵活性的<strong>鱼和熊掌不可兼得</strong>之困。</p>
</blockquote>
<h2 data-id="heading-0">0️⃣ 🐼 序章：琅嬛福地的“内存”迷局</h2>
<p>琅嬛福地，天山童姥遗留的虚拟数据中心。</p>
<p>这里是存储着天下所有数据结构秘籍的宝库。大熊猫侯佩穿梭在巨大的全息卷轴之间，背景音乐是《天龙八部》的BGM，他一边走一边摸了摸头顶——黑毛油光锃亮，<strong>头绝对不秃</strong>，安全感十足。</p>
<p>他之所以来这，是因为上一回任务结束后，他仍对竹笋的存储问题耿耿于怀。</p>
<p>“我那四根‘镇山之宝’级竹笋，必须以最快的速度取用！”侯佩对着一卷写着 <code>Array</code> 的秘籍大声嚷道，“用普通的 <code>Array</code>，虽然方便，但那动态分配内存的方式，让我每次取笋都感觉像是在丐帮的袋子里掏东西，<strong>随性得很，但太慢了！</strong>”</p>
<p>“若追求极致速度，何不用 <strong>Tuple</strong>（元组）？”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceca77a66a80450cab5a183ca5d6dd24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=WYTl2X5k5jLFYkjgCu3pvhKwC%2F8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>一个清冷的声音传来。侯佩循声望去，只见一位容貌比数据流还精致的少女站在光影之中，她皓齿明眸，手中正拿着一本《九阴真经》的代码版本，正是<strong>王语嫣</strong>。</p>
<p>王语嫣，熟读天下武学秘籍，对各种数据结构了如指掌。她的爱好就是整理和分类这些代码秘籍，特点是<strong>理论知识丰富到可以开宗立派，但从未亲手实践（编写）过一行代码</strong>。</p>
<p>“王姑娘！”侯佩的眼睛瞬间变成了心形（花痴属性发作），“元组是快，它内存连续且固定，但您看，我如果要用下标循环遍历我的四根竹笋，<code>myTuple.0</code>，<code>myTuple.1</code>……这写法简直是<strong>望洋兴叹</strong>，既不优雅，又不支持循环！”</p>
<p><strong>在本次冒险中，您将学到如下内容：</strong></p>
<ul>
<li>0️⃣ 🐼 序章：琅嬛福地的“内存”迷局</li>
<li>1️⃣ 💥 混血秘籍：InlineArray 的诞生 (SE-0453)</li>
<li>2️⃣ 📜 固若金汤：InlineArray 的使用法门
<ul>
<li>招式一：明确指定大小与类型</li>
<li>招式二：让编译器“心领神会”</li>
<li>下标读写：行云流水</li>
</ul>
</li>
<li>3️⃣ 🚧 乾坤已定：固定大小的代价
<ul>
<li>迭代之困：不入流的限制</li>
</ul>
</li>
<li>4️⃣ 🐼 熊猫的黑色幽默与抉择</li>
<li>5️⃣ 🛑 尾声：慕容复的伪装与“向后看”的难题</li>
</ul>
<p>王语嫣轻轻叹了一口气：“是啊，鱼和熊掌不可兼得。内存布局（Performance）和下标访问（Usability），历来是程序员江湖的千年难题。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73f26430b7eb40b3a6d157c37d4034ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=TKcNBgX%2FYJUe9Ka%2FvT8T1Gr7Hxw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">1️⃣ 💥 混血秘籍：InlineArray 的诞生 (SE-0453)</h2>
<p>就在侯佩和王语嫣陷入技术哲学的死循环时，一道新的全息卷轴从天而降，正是 <strong>SE-0453</strong> 秘籍。</p>
<p>“快看，这是最新的‘混血’数据结构，”侯佩激动地喊道，“它叫 <strong>InlineArray</strong>（内联数组），它把元组的‘<strong>固定大小</strong>’与数组的‘<strong>自然下标</strong>’完美地融合了！”</p>
<p><strong><code>InlineArray</code></strong> 最核心的奥义在于：它将固定数量的元素直接存储在结构体内部，没有动态分配的开销，从而实现了<strong>结构体级别的内存连续性</strong>和<strong>媲美 C 语言数组的存取速度</strong>。</p>
<blockquote>
<p><strong>💡 前置条件（SE-0452）</strong>：
要实现这种固定大小的泛型（Generic），Swift 6.2 还必须引入另一个重要的前提：<strong>SE-0452：Integer Generic Parameters（整数泛型参数）</strong>。这使得我们可以用一个整数值来约束泛型类型的大小，比如 <code>InlineArray&lt;4, String&gt;</code> 中的 <code>4</code>，这在以前的 Swift 版本中是无法想象的。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f982f69c4b9543aba02a102a03410835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=OAYm8nDeJkEYR94Sogl7JnfCo0c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-2">2️⃣ 📜 固若金汤：InlineArray 的使用法门</h2>
<p>王语嫣作为理论大师，立刻解析了这段秘籍。</p>
<p>创建 <code>InlineArray</code> 有两种法门：</p>
<h3 data-id="heading-3">招式一：明确指定大小与类型</h3>
<p>我们可以像使用泛型一样，明确告知编译器：“我要一个固定大小为 <strong>4</strong> 的 <strong>String</strong> 类型数组。”</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 明确告诉编译器：我要一个固定大小为 4 的 String 数组</span>
<span class="hljs-keyword">var</span> names1: <span class="hljs-type">InlineArray</span>&lt;4, <span class="hljs-type">String</span>&gt; <span class="hljs-operator">=</span> [<span class="hljs-string">"Moon"</span>, <span class="hljs-string">"Mercury"</span>, <span class="hljs-string">"Mars"</span>, <span class="hljs-string">"Tuxedo Mask"</span>]
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b94e76bbc304f26b81d9f9d8d9ac58e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=EN1ugsll2SMumxPCWNs7u%2FC70cY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">招式二：让编译器“心领神会”</h3>
<p>侯佩这种懒人当然更喜欢让编译器自己推断（Type Inference）大小。只要传入的元素数量和类型固定，编译器就能自动搞定。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 编译器会根据传入的 4 个 String，自动推断出它是 InlineArray&lt;4, String&gt;</span>
<span class="hljs-keyword">var</span> names2: <span class="hljs-type">InlineArray</span> <span class="hljs-operator">=</span> [<span class="hljs-string">"Moon"</span>, <span class="hljs-string">"Mercury"</span>, <span class="hljs-string">"Mars"</span>, <span class="hljs-string">"Tuxedo Mask"</span>]
</code></pre>
<p>“太完美了！”侯佩赞叹道，“这就像是把我的四根竹笋严丝合缝地放进了四个精确尺寸的格子，<strong>一劳永逸</strong>，再也不用担心内存跳来跳去了。”</p>
<h3 data-id="heading-5">下标读写：行云流水</h3>
<p>虽然它内存布局像元组，但使用起来却和数组一样，支持直观的下标读写：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 读取：就像普通的数组一样</span>
<span class="hljs-built_in">print</span>(names1[<span class="hljs-number">0</span>]) <span class="hljs-comment">// 输出: Moon</span>
<span class="hljs-comment">// 写入：轻松修改特定位置的元素</span>
names1[<span class="hljs-number">2</span>] <span class="hljs-operator">=</span> <span class="hljs-string">"Jupiter"</span> <span class="hljs-comment">// 火星变木星，改写数据，毫不费力</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bed37f385f14403a9e7ed165f19d0868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=6Lp0ZfiIIasldmRku9i02hEqV44%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-6">3️⃣ 🚧 乾坤已定：固定大小的代价</h2>
<p>王语嫣很快指出了这种“神功”的限制：“侯大哥，此功法虽然内力雄厚（性能卓越），但限制也多。既然是固定大小，那么它就失去了数组的动态伸缩性。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7999aa56782f45ecb014623b5287b1fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=rT1hSeSmQ%2F5dkh5U196cD1LYnMA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>侯佩一听，赶紧问道：“那是不是不能再多塞一根竹笋进去了？”</p>
<p>王语嫣点头：“正是。<strong><code>InlineArray</code> 没有 <code>append()</code> 或 <code>remove(at:)</code> 方法。</strong> 它的容量在诞生之初就已是<strong>天数</strong>，无法更改。”</p>
<h3 data-id="heading-7">迭代之困：不入流的限制</h3>
<p>更让人头疼的是它的“不入流”限制：</p>
<blockquote>
<p>🚨 <strong>技术哲学</strong>：<code>InlineArray</code> 不兼容传统的 <strong><code>Sequence</code></strong>（序列）和 <strong><code>Collection</code></strong>（集合）协议。</p>
</blockquote>
<p>“为什么？”侯佩不解，“它不是数组吗？”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aeb86eab890472b9c96f431d33c6977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=RbB59m71p8xkWWINAfdA%2BpYElCI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“因为它的设计目标是<strong>极致性能和编译时确定性</strong>。”王语嫣解释道，“为了避免遵循这些协议可能带来的抽象层开销，它选择‘自绝经脉’。如果你想遍历它，你必须通过它的 <code>indices</code> 属性，配合下标访问来实现。”</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 侯佩：虽然不方便，但为了性能，忍了！</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> names1.indices {
    <span class="hljs-comment">// 必须通过索引 i 来访问，不能直接用 for element in names1</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, <span class="hljs-subst">\(names1[i])</span>!"</span>) 
}
</code></pre>
<p>侯佩总结道：“这就像是说，虽然它是武林高手，但它拒绝参加武林大会（不遵循 <code>Collection</code> 协议），如果你想请教它，必须先拿到它的拜帖（<code>indices</code>）才行。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b930efc28b664e09a7fe82c2fd7bbd21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=8N6K0C6hjoBTar%2FQ4JA1m9YtERc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-8">4️⃣ 🐼 熊猫的黑色幽默与抉择</h2>
<p>“哎呀，这世道，连数据结构都得看颜值和出身。”侯佩叹了口气，把竹笋收进了虚拟的 <code>InlineArray</code> 容器里，感觉身轻如燕，连走路都带风了。</p>
<p>“不过话说回来，”侯佩看向王语嫣，“我还是觉得这种硬编码的语法有点不够‘熊猫化’（不够懒）。听说社区里有人想搞个更直观的语法？”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec3e45fbb57544d9ae0f789e7417184f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=6q0uRELOvYnU4PaajXVC2vszFl8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>王语嫣提起了一件江湖轶事（SE-0483）：</p>
<blockquote>
<p><strong>插曲：夭折的提案</strong>：
“有一个叫做 <strong>SE-0483</strong> 的提议，想要引入类似 <code>var names: [5 x String] = .init(repeating: "Anonymous")</code> 的简洁语法，来表示一个固定包含 5 个 String 的数组。但由于反馈意见认为它过于突兀且不够 Swift 风格，目前已被‘打回重修’。”</p>
</blockquote>
<p>侯佩嘿嘿一笑：“果然，任何新秘籍的推广，都会遇到‘保守派’的阻力。不过，能用，速度快，<strong>头不秃</strong>，对我来说就够了。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ece6e22d29c4cefa31f075704cd5467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=JETvSrnHeRfBGU6xsHIxvQFkFek%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">5️⃣ 🛑 尾声：慕容复的伪装与“向后看”的难题</h2>
<p>就在侯佩沉浸在高性能竹笋容器的喜悦中时，王语嫣突然脸色大变。</p>
<p>“侯大哥！我刚才在整理慕容复留下的数据卷轴时，发现了一个惊天的秘密！”</p>
<p>她指着屏幕上的一段文本，那是一篇关于“兴复大燕”的宏大计划书。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85b6409a7ea1407586fd21c2d43b2626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=BVSNZNoYvvOyAeqLMPxlqRImp84%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“我想用 <strong>Regex（正则表达式）</strong> 查找卷轴中所有提到他名字的地方。但是，我不想要匹配到那些他用来伪装自己身份的称呼，比如‘公冶乾’、‘包不同’这些名字后面的‘慕容复’。”王语嫣急道，“我只想匹配到那些，<strong>前面紧跟着‘我的挚爱’这四个字</strong>的‘慕容复’！”</p>
<p>侯佩挠了挠头：“你的意思是，你想找到一个模式，但这个模式必须满足它<strong>前面有一个特定的前置条件</strong>，而这个前置条件本身，<strong>又不被纳入匹配结果</strong>？”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e2cd8f805a145dcaf3d093198bfb0b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=xrj6vDDb86cwDkO1Jv0YDCsiB%2Fg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“对！”王语嫣焦急万分，“我的 <strong>Regex</strong> 功夫只能‘向前看’（Lookahead），却无法完美地**‘向后看’**，我不能确定文本中这三个字前面是不是真的有‘我的挚爱’。”</p>
<p>侯佩望着卷轴深处那段充满秘密的代码，神秘地一笑：“王姑娘，你不用再对着旧秘籍<strong>望洋兴叹</strong>了。下一章，Swift 6.2 就要教我们一招绝顶的侦查武功：<strong>Regex lookbehind assertions</strong>（正则表达式向后查找断言）！”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3064bc9b88f4878a07b6ce369201843~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101873&amp;x-signature=Tu4X1lgvVmhelYRUDSaqdGa3uD4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>（欲知后事如何，且看下回分解：Regex lookbehind assertions —— 如何在不匹配前文的情况下，精确判断前文的存在性，找到王语嫣真正的“挚爱”。）</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端密码验证详解：Vue3+Element Plus 方案/纯血Vue 3 方案：从语法解析到实战实现]]></title>    <link>https://juejin.cn/post/7590597231708454947</link>    <guid>https://juejin.cn/post/7590597231708454947</guid>    <pubDate>2026-01-04T02:36:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590597231708454947" data-draft-id="7590597231708422179" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端密码验证详解：Vue3+Element Plus 方案/纯血Vue 3 方案：从语法解析到实战实现"/> <meta itemprop="keywords" content="Vue.js,Element"/> <meta itemprop="datePublished" content="2026-01-04T02:36:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱分享的鱼鱼"/> <meta itemprop="url" content="https://juejin.cn/user/3901536646733133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端密码验证详解：Vue3+Element Plus 方案/纯血Vue 3 方案：从语法解析到实战实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3901536646733133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱分享的鱼鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:36:02.000Z" title="Sun Jan 04 2026 02:36:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 应用开发中，用户密码的安全性是至关重要的。一个健壮的密码验证系统不仅能保护用户账户安全，还能提升用户体验。本文将结合实际代码，详细介绍如何在 Vue 3 + Element Plus 项目中实现一个功能完整、用户体验良好的密码验证系统。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70d380337e3b4fffa0997a2e2964875b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5YiG5Lqr55qE6bG86bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099052&amp;x-signature=qQLlN7oRNhduBlMKKUGbj%2BzAwqU%3D" alt="ScreenShot_2026-01-04_103545_723.png" loading="lazy"/></p>
<h2 data-id="heading-0">技术栈介绍</h2>
<h3 data-id="heading-1">Vue 3 Composition API</h3>
<p>Vue 3 引入了 Composition API，这是一种更灵活、更易于逻辑复用的组件组织方式。在我们的密码验证实现中，使用了以下关键概念：</p>
<ul>
<li><code>ref</code>/<code>reactive</code>: 用于创建响应式数据</li>
<li><code>setup</code> 函数: 组件的逻辑入口点</li>
<li>组合式函数: 将相关逻辑封装到可复用的函数中</li>
</ul>
<h3 data-id="heading-2">Element Plus 表单验证</h3>
<p>Element Plus 是基于 Vue 3 的 UI 组件库，其表单验证功能提供了强大的验证机制：</p>
<ul>
<li>内置验证规则（如 <code>required</code>、<code>min</code>、<code>max</code> 等）</li>
<li>自定义验证函数支持</li>
<li>多种触发方式（<code>blur</code>、<code>change</code> 等）</li>
<li>友好的错误提示机制</li>
</ul>
<h2 data-id="heading-3">代码实现详解</h2>
<h3 data-id="heading-4">1. 基础结构设置</h3>
<p>首先，让我们看看整个组件的基础结构：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-form :model="userForm" :rules="rules" ref="formRef" label-width="80px"&gt;
    &lt;el-form-item label="密码" prop="password" v-if="!userForm.id"&gt;
      &lt;el-input v-model="userForm.password" type="password" placeholder="请输入密码" /&gt;
    &lt;/el-form-item&gt;
  &lt;/el-form&gt;
&lt;/template&gt;

&lt;script setup&gt;
// 导入必要的模块
import { ref, reactive } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'

// 响应式数据定义
const userForm = reactive({
  // 用户表单数据
  id: null,
  name: null,
  password: null,
  // ... 其他字段
})

// 表单验证规则
const rules = {
  // 验证规则定义
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-5">2. 完整的密码验证规则</h3>
<p>现在，我们来详细解析密码验证的完整实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 密码验证规则</span>
<span class="hljs-attr">password</span>: [
  <span class="hljs-comment">// 必填验证</span>
  { 
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, 
    <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入密码'</span>, 
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> 
  },
  
  <span class="hljs-comment">// 长度验证</span>
  { 
    <span class="hljs-attr">min</span>: <span class="hljs-number">8</span>, 
    <span class="hljs-attr">max</span>: <span class="hljs-number">20</span>, 
    <span class="hljs-attr">message</span>: <span class="hljs-string">'密码长度应在8-20位之间'</span>, 
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> 
  },
  
  <span class="hljs-comment">// 小写字母验证</span>
  {
    <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">rule, value, callback</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/[a-z]/</span>.<span class="hljs-title function_">test</span>(value)) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'密码必须包含至少一个小写字母'</span>))
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">callback</span>()
      }
    },
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>
  },
  
  <span class="hljs-comment">// 大写字母验证</span>
  {
    <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">rule, value, callback</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/[A-Z]/</span>.<span class="hljs-title function_">test</span>(value)) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'密码必须包含至少一个大写字母'</span>))
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">callback</span>()
      }
    },
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>
  },
  
  <span class="hljs-comment">// 数字验证</span>
  {
    <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">rule, value, callback</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/\d/</span>.<span class="hljs-title function_">test</span>(value)) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'密码必须包含至少一个数字'</span>))
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">callback</span>()
      }
    },
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>
  },
  
  <span class="hljs-comment">// 特殊字符验证</span>
  {
    <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">rule, value, callback</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> specialCharPattern = <span class="hljs-regexp">/[@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]]/</span>;
      <span class="hljs-keyword">if</span> (!specialCharPattern.<span class="hljs-title function_">test</span>(value)) {
        <span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'密码必须包含至少一个特殊字符'</span>))
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">callback</span>()
      }
    },
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>
  }
],
</code></pre>
<h3 data-id="heading-6">3. 语法详细解析</h3>
<h4 data-id="heading-7">3.1 Element Plus 验证规则结构</h4>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,           <span class="hljs-comment">// 是否必填</span>
  <span class="hljs-attr">message</span>: <span class="hljs-string">'错误提示信息'</span>,   <span class="hljs-comment">// 验证失败时显示的消息</span>
  <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>,         <span class="hljs-comment">// 触发验证的时机</span>
  <span class="hljs-attr">min</span>: <span class="hljs-number">8</span>,                  <span class="hljs-comment">// 最小长度</span>
  <span class="hljs-attr">max</span>: <span class="hljs-number">20</span>,                 <span class="hljs-comment">// 最大长度</span>
  <span class="hljs-attr">validator</span>: <span class="hljs-keyword">function</span>      <span class="hljs-comment">// 自定义验证函数</span>
}
</code></pre>
<h4 data-id="heading-8">3.2 自定义验证函数参数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">rule, value, callback</span>) =&gt;</span> {
  <span class="hljs-comment">// rule: 当前验证规则的配置对象</span>
  <span class="hljs-comment">// value: 当前字段的输入值（用户输入的密码）</span>
  <span class="hljs-comment">// callback: 验证完成后的回调函数</span>
}
</code></pre>
<ul>
<li><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">rule</a>: 包含当前验证规则的所有配置信息</li>
<li><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">value</a>: 用户在密码字段输入的实际值</li>
<li><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">callback</a>: 用于通知验证结果的回调函数</li>
</ul>
<h4 data-id="heading-9">3.3 正则表达式详解</h4>
<pre><code class="hljs language-javascript" lang="javascript">/[a-z]/.<span class="hljs-title function_">test</span>(value)        <span class="hljs-comment">// 检查是否包含小写字母 a-z</span>
/[A-Z]/.<span class="hljs-title function_">test</span>(value)        <span class="hljs-comment">// 检查是否包含大写字母 A-Z</span>
/\d/.<span class="hljs-title function_">test</span>(value)           <span class="hljs-comment">// 检查是否包含数字 0-9</span>
/[@$!%*?&amp;~#^_+=<span class="xml"><span class="hljs-tag">&lt;&gt;</span>,.:/|\\(){}[\]]/.test(value)  // 检查是否包含特殊字符
</span></code></pre>
<p><strong>正则表达式解释：</strong></p>
<ul>
<li><code>/[a-z]/</code> : 匹配任意一个小写字母</li>
<li><code>/[A-Z]/</code> : 匹配任意一个大写字母</li>
<li><code>/\d/</code> : 匹配任意一个数字（等同于 <code>[0-9]</code>）</li>
<li><code>/[@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]]/</code> : 匹配指定的特殊字符集合</li>
</ul>
<h3 data-id="heading-10">4. 验证流程分析</h3>
<p>让我们看看验证是如何在用户交互中工作的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!formRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 触发表单验证</span>
    <span class="hljs-keyword">await</span> formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>()
    
    <span class="hljs-comment">// 验证通过后的逻辑</span>
    <span class="hljs-comment">// ...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 验证失败时的处理</span>
    <span class="hljs-comment">// Element Plus 会自动显示错误信息</span>
  }
}
</code></pre>
<p>当用户点击提交按钮时：</p>
<ol>
<li>调用 <code>formRef.value.validate()</code> 方法</li>
<li>Element Plus 遍历所有验证规则</li>
<li>对每个规则执行相应的验证逻辑</li>
<li>如果验证失败，显示错误信息</li>
<li>如果所有验证通过，继续执行提交逻辑</li>
</ol>
<h3 data-id="heading-11">5. 用户体验优化</h3>
<p>通过将密码验证拆分为多个独立规则，我们实现了以下用户体验优化：</p>
<h4 data-id="heading-12">5.1 即时反馈</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>  <span class="hljs-comment">// 在用户离开输入框时立即验证</span>
</code></pre>
<h4 data-id="heading-13">5.2 具体错误信息</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'密码必须包含至少一个小写字母'</span>))
</code></pre>
<p>用户能清楚知道密码缺少哪种类型的字符。</p>
<h4 data-id="heading-14">5.3 渐进式提示</h4>
<p>用户每满足一个条件，就会有一个验证通过，提供积极的反馈。</p>
<h2 data-id="heading-15">安全考虑</h2>
<h3 data-id="heading-16">1. 前后端一致性</h3>
<p>根据项目规范，前端验证规则必须与后端 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">PasswordValidator</a> 类保持一致，确保：</p>
<ul>
<li>相同的密码复杂度要求</li>
<li>统一的特殊字符定义（包括 <code>~</code> 字符）</li>
<li>一致的长度限制</li>
</ul>
<h3 data-id="heading-17">2. 验证层级</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端验证（用户体验）</span>
<span class="hljs-comment">// 后端验证（安全保证）</span>
<span class="hljs-comment">// 数据库约束（最后防线）</span>
</code></pre>
<p>前端验证仅用于改善用户体验，后端验证是安全的最终保障。</p>
<h3 data-id="heading-18">3. 密码策略</h3>
<p>当前实现的密码策略包括：</p>
<ul>
<li>长度：8-20 位</li>
<li>必须包含：小写字母、大写字母、数字、特殊字符</li>
<li>特殊字符集合：<code>@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\(){}[]</code></li>
</ul>
<h2 data-id="heading-19">代码重构与优化</h2>
<p>根据项目规范，我们将密码验证拆分为多个独立验证规则，而不是使用单一的复杂正则表达式：</p>
<p><strong>重构前（单一验证）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">pattern</span>: <span class="hljs-regexp">/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]])[A-Za-z\d@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]]+$/</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">'密码必须包含大小写字母、数字和特殊字符'</span>
}
</code></pre>
<p><strong>重构后（分项验证）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">[
  <span class="hljs-comment">// 小写字母验证</span>
  { <span class="hljs-attr">validator</span>: validateLowercase, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
  <span class="hljs-comment">// 大写字母验证</span>
  { <span class="hljs-attr">validator</span>: validateUppercase, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
  <span class="hljs-comment">// 数字验证</span>
  { <span class="hljs-attr">validator</span>: validateDigit, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
  <span class="hljs-comment">// 特殊字符验证</span>
  { <span class="hljs-attr">validator</span>: validateSpecialChar, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> }
]
</code></pre>
<h2 data-id="heading-20">纯 Vue 3 密码验证实现</h2>
<p>如果只使用 Vue 3 而不使用 Element Plus，我们需要自己实现密码验证逻辑。以下是使用纯 Vue 3 实现密码验证的完整示例：</p>
<h3 data-id="heading-21">1. 基础组件结构</h3>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"password-form"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>用户注册<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 密码输入框 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-group"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"password"</span>&gt;</span>密码:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"password"</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"password"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
        @<span class="hljs-attr">blur</span>=<span class="hljs-string">"validatePassword"</span>
        @<span class="hljs-attr">input</span>=<span class="hljs-string">"validatePasswordRealTime"</span>
        <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ 'error': hasError, 'valid': isValid &amp;&amp; password }"</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"hasError"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"error-message"</span>&gt;</span>{{ errorMessage }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 密码强度指示器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"password-requirements"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['requirement', { satisfied: hasLowercase }]"</span>&gt;</span>
        包含小写字母
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['requirement', { satisfied: hasUppercase }]"</span>&gt;</span>
        包含大写字母
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['requirement', { satisfied: hasDigit }]"</span>&gt;</span>
        包含数字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['requirement', { satisfied: hasSpecialChar }]"</span>&gt;</span>
        包含特殊字符
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['requirement', { satisfied: isLengthValid }]"</span>&gt;</span>
        长度在8-20位之间
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 提交按钮 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
      @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSubmit"</span> 
      <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"!isValid"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"submit-btn"</span>
    &gt;</span>
      提交
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 响应式数据</span>
<span class="hljs-keyword">const</span> password = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> errorMessage = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> isValid = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 验证结果</span>
<span class="hljs-keyword">const</span> hasLowercase = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> hasUppercase = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> hasDigit = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> hasSpecialChar = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> isLengthValid = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 计算属性：是否包含错误</span>
<span class="hljs-keyword">const</span> hasError = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!errorMessage.<span class="hljs-property">value</span>)

<span class="hljs-comment">// 实时验证密码</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validatePasswordRealTime</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> value = password.<span class="hljs-property">value</span>
  
  <span class="hljs-comment">// 检查各项要求</span>
  hasLowercase.<span class="hljs-property">value</span> = <span class="hljs-regexp">/[a-z]/</span>.<span class="hljs-title function_">test</span>(value)
  hasUppercase.<span class="hljs-property">value</span> = <span class="hljs-regexp">/[A-Z]/</span>.<span class="hljs-title function_">test</span>(value)
  hasDigit.<span class="hljs-property">value</span> = <span class="hljs-regexp">/\d/</span>.<span class="hljs-title function_">test</span>(value)
  hasSpecialChar.<span class="hljs-property">value</span> = <span class="hljs-regexp">/[@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]]/</span>.<span class="hljs-title function_">test</span>(value)
  isLengthValid.<span class="hljs-property">value</span> = value.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">8</span> &amp;&amp; value.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">20</span>
  
  <span class="hljs-comment">// 检查整体是否有效</span>
  isValid.<span class="hljs-property">value</span> = hasLowercase.<span class="hljs-property">value</span> &amp;&amp; 
                  hasUppercase.<span class="hljs-property">value</span> &amp;&amp; 
                  hasDigit.<span class="hljs-property">value</span> &amp;&amp; 
                  hasSpecialChar.<span class="hljs-property">value</span> &amp;&amp; 
                  isLengthValid.<span class="hljs-property">value</span>
}

<span class="hljs-comment">// 失焦时验证（用于错误信息显示）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validatePassword</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> value = password.<span class="hljs-property">value</span>
  
  <span class="hljs-keyword">if</span> (!value) {
    errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'请输入密码'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">length</span> &lt; <span class="hljs-number">8</span> || value.<span class="hljs-property">length</span> &gt; <span class="hljs-number">20</span>) {
    errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码长度应在8-20位之间'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/[a-z]/</span>.<span class="hljs-title function_">test</span>(value)) {
    errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个小写字母'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/[A-Z]/</span>.<span class="hljs-title function_">test</span>(value)) {
    errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个大写字母'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/\d/</span>.<span class="hljs-title function_">test</span>(value)) {
    errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个数字'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-keyword">const</span> specialCharPattern = <span class="hljs-regexp">/[@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]]/</span>
  <span class="hljs-keyword">if</span> (!specialCharPattern.<span class="hljs-title function_">test</span>(value)) {
    errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个特殊字符'</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-comment">// 所有验证通过</span>
  errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-comment">// 提交处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">validatePassword</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'密码验证通过，可以提交表单'</span>)
    <span class="hljs-comment">// 这里执行提交逻辑</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'密码验证失败'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.password-form</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.input-group</span> {
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
}

<span class="hljs-selector-class">.input-group</span> <span class="hljs-selector-tag">label</span> {
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>;
  <span class="hljs-attribute">font-weight</span>: bold;
}

<span class="hljs-selector-class">.input-group</span> <span class="hljs-selector-tag">input</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
}

<span class="hljs-selector-class">.input-group</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.error</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#e74c3c</span>;
}

<span class="hljs-selector-class">.input-group</span> <span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.valid</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#27ae60</span>;
}

<span class="hljs-selector-class">.error-message</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#e74c3c</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">5px</span>;
}

<span class="hljs-selector-class">.password-requirements</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">15px</span> <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.requirement</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">5px</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#e74c3c</span>;
}

<span class="hljs-selector-class">.requirement</span><span class="hljs-selector-class">.satisfied</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#27ae60</span>;
}

<span class="hljs-selector-class">.submit-btn</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3498db</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-selector-class">.submit-btn</span><span class="hljs-selector-pseudo">:disabled</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#bdc3c7</span>;
  <span class="hljs-attribute">cursor</span>: not-allowed;
}

<span class="hljs-selector-class">.submit-btn</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-pseudo">:disabled</span>)<span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2980b9</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-22">2. 使用组合式函数的高级实现</h3>
<p>为了更好的代码复用，我们可以将密码验证逻辑封装成组合式函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// composables/usePasswordValidation.js</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usePasswordValidation</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 响应式数据</span>
  <span class="hljs-keyword">const</span> password = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> errorMessage = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
  
  <span class="hljs-comment">// 验证状态</span>
  <span class="hljs-keyword">const</span> hasLowercase = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> hasUppercase = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> hasDigit = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> hasSpecialChar = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> isLengthValid = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  
  <span class="hljs-comment">// 计算属性</span>
  <span class="hljs-keyword">const</span> isValid = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> 
    hasLowercase.<span class="hljs-property">value</span> &amp;&amp; 
    hasUppercase.<span class="hljs-property">value</span> &amp;&amp; 
    hasDigit.<span class="hljs-property">value</span> &amp;&amp; 
    hasSpecialChar.<span class="hljs-property">value</span> &amp;&amp; 
    isLengthValid.<span class="hljs-property">value</span>
  )
  
  <span class="hljs-keyword">const</span> hasError = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!errorMessage.<span class="hljs-property">value</span>)
  
  <span class="hljs-comment">// 实时验证</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validatePasswordRealTime</span> = (<span class="hljs-params">value</span>) =&gt; {
    password.<span class="hljs-property">value</span> = value
    
    hasLowercase.<span class="hljs-property">value</span> = <span class="hljs-regexp">/[a-z]/</span>.<span class="hljs-title function_">test</span>(value)
    hasUppercase.<span class="hljs-property">value</span> = <span class="hljs-regexp">/[A-Z]/</span>.<span class="hljs-title function_">test</span>(value)
    hasDigit.<span class="hljs-property">value</span> = <span class="hljs-regexp">/\d/</span>.<span class="hljs-title function_">test</span>(value)
    hasSpecialChar.<span class="hljs-property">value</span> = <span class="hljs-regexp">/[@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]]/</span>.<span class="hljs-title function_">test</span>(value)
    isLengthValid.<span class="hljs-property">value</span> = value.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">8</span> &amp;&amp; value.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">20</span>
    
    <span class="hljs-keyword">return</span> isValid.<span class="hljs-property">value</span>
  }
  
  <span class="hljs-comment">// 完整验证（带错误信息）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validatePassword</span> = (<span class="hljs-params">value = password.value</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!value) {
      errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'请输入密码'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">if</span> (value.<span class="hljs-property">length</span> &lt; <span class="hljs-number">8</span> || value.<span class="hljs-property">length</span> &gt; <span class="hljs-number">20</span>) {
      errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码长度应在8-20位之间'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/[a-z]/</span>.<span class="hljs-title function_">test</span>(value)) {
      errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个小写字母'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/[A-Z]/</span>.<span class="hljs-title function_">test</span>(value)) {
      errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个大写字母'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/\d/</span>.<span class="hljs-title function_">test</span>(value)) {
      errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个数字'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">const</span> specialCharPattern = <span class="hljs-regexp">/[@$!%*?&amp;~#^_+=&lt;&gt;,.:/|\\(){}[\]]/</span>
    <span class="hljs-keyword">if</span> (!specialCharPattern.<span class="hljs-title function_">test</span>(value)) {
      errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">'密码必须包含至少一个特殊字符'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    errorMessage.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
  
  <span class="hljs-keyword">return</span> {
    password,
    errorMessage,
    hasLowercase,
    hasUppercase,
    hasDigit,
    hasSpecialChar,
    isLengthValid,
    isValid,
    hasError,
    validatePasswordRealTime,
    validatePassword
  }
}
</code></pre>
<p>然后在组件中使用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="password-form"&gt;
    &lt;h3&gt;用户注册&lt;/h3&gt;
    
    &lt;div class="input-group"&gt;
      &lt;label for="password"&gt;密码:&lt;/label&gt;
      &lt;input
        id="password"
        v-model="password"
        type="password"
        @blur="() =&gt; validatePassword()"
        @input="e =&gt; validatePasswordRealTime(e.target.value)"
        :class="{ 'error': hasError, 'valid': isValid &amp;&amp; password }"
      /&gt;
      &lt;div v-if="hasError" class="error-message"&gt;{{ errorMessage }}&lt;/div&gt;
    &lt;/div&gt;
    
    &lt;div class="password-requirements"&gt;
      &lt;div :class="['requirement', { satisfied: hasLowercase }]"&gt;
        包含小写字母
      &lt;/div&gt;
      &lt;div :class="['requirement', { satisfied: hasUppercase }]"&gt;
        包含大写字母
      &lt;/div&gt;
      &lt;div :class="['requirement', { satisfied: hasDigit }]"&gt;
        包含数字
      &lt;/div&gt;
      &lt;div :class="['requirement', { satisfied: hasSpecialChar }]"&gt;
        包含特殊字符
      &lt;/div&gt;
      &lt;div :class="['requirement', { satisfied: isLengthValid }]"&gt;
        长度在8-20位之间
      &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;button 
      @click="handleSubmit" 
      :disabled="!isValid"
      class="submit-btn"
    &gt;
      提交
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { usePasswordValidation } from './composables/usePasswordValidation'

// 使用密码验证组合式函数
const {
  password,
  errorMessage,
  hasLowercase,
  hasUppercase,
  hasDigit,
  hasSpecialChar,
  isLengthValid,
  isValid,
  hasError,
  validatePasswordRealTime,
  validatePassword
} = usePasswordValidation()

const handleSubmit = () =&gt; {
  if (validatePassword()) {
    console.log('密码验证通过，可以提交表单')
    // 这里执行提交逻辑
  } else {
    console.log('密码验证失败')
  }
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-23">与 Element Plus 方案的对比</h2>
<h3 data-id="heading-24">Vue 3 纯实现的特点：</h3>
<ol>
<li><strong>完全控制</strong>：可以完全自定义验证逻辑和UI</li>
<li><strong>轻量级</strong>：不需要引入 UI 组件库</li>
<li><strong>灵活性</strong>：可以实现任何想要的验证逻辑</li>
<li><strong>复杂度</strong>：需要手动处理样式和交互逻辑</li>
</ol>
<h3 data-id="heading-25">Element Plus 实现的特点：</h3>
<ol>
<li><strong>快速开发</strong>：提供预设的验证规则和样式</li>
<li><strong>一致性</strong>：UI 组件风格统一</li>
<li><strong>内置功能</strong>：表单验证、错误提示等开箱即用</li>
<li><strong>依赖性</strong>：需要引入整个 UI 组件库</li>
</ol>
<h2 data-id="heading-26">总结</h2>
<p>纯 Vue 3 实现密码验证需要我们自己处理：</p>
<ol>
<li><strong>响应式数据管理</strong>：使用 <code>ref</code> 和 <code>reactive</code></li>
<li><strong>验证逻辑</strong>：编写具体的验证函数</li>
<li><strong>UI 交互</strong>：处理输入事件、错误提示、样式变化</li>
<li><strong>用户体验</strong>：实时反馈、视觉指示等</li>
</ol>
<p>这种方式虽然需要更多的代码，但提供了完全的控制权，适合对 UI 和交互有特殊要求的项目。通过组合式函数，我们可以很好地组织和复用验证逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3实现前端生成word并下载]]></title>    <link>https://juejin.cn/post/7590283328177586219</link>    <guid>https://juejin.cn/post/7590283328177586219</guid>    <pubDate>2026-01-04T03:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590283328177586219" data-draft-id="7590735421261922345" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3实现前端生成word并下载"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-04T03:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="外啫啫"/> <meta itemprop="url" content="https://juejin.cn/user/3314378809290953"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3实现前端生成word并下载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3314378809290953/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    外啫啫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:14:51.000Z" title="Sun Jan 04 2026 03:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. 前情</h2>
<p>在后台管理平台开发过程中，有这样一个需求：从后端获取到数据后，前端生成指定模板内容的word文件并下载到本地。当导出的文件过多时，为了减少响应时间，也加上了进行压缩下载部分。使用过程中可根据实际需求作出调整。</p>
<h2 data-id="heading-1">2. 准备</h2>
<p>wqqqq</p>
<h4 data-id="heading-2">依赖</h4>
<pre><code class="hljs language-js" lang="js">npm install docxtemplater
 
npm install jszip
 
npm install pizzip
 
npm install file-saver
 
npm install jszip-utils
 
npm install angular-expressions
</code></pre>
<h4 data-id="heading-3">模板文件</h4>
<p>需要按导出样式准备一个模板文件，放到 public 目录下。模板中占位符包含以下部分：</p>
<ul>
<li>单一变量：{变量名}。直接显示改变量的值。</li>
<li>遍历：{#变量名}内容{/变量名}。会对该数据进行遍历展示</li>
<li>显示/隐藏：{#变量名}内容{/变量名}。其中为true的时候显示，false则不显示。</li>
<li>图片：{%变量名}。变量值为base64格式。</li>
<li>if-else：{#变量名}A{/变量名}{^变量名}B{/变量名}。其中值为true的时候显示“A”，为false显示“B”；</li>
<li>复选框：{#变量名}选中{/变量名}{^变量名}非选中{/变量名}
以上部分是我在实际需求中使用到的，其他使用可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocxtemplater.com%2Fdocs%2F" title="https://docxtemplater.com/docs/" target="_blank" ref="nofollow noopener noreferrer">docxtemplater.com/docs/</a></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> obj={
    <span class="hljs-attr">name</span>:<span class="hljs-string">'张三'</span>,
    <span class="hljs-attr">age</span>:<span class="hljs-number">12</span>,
    <span class="hljs-attr">hobby</span>:[<span class="hljs-string">'basketball'</span>，<span class="hljs-string">'swimming'</span>],
    <span class="hljs-attr">url</span>:<span class="hljs-string">'xxxxxxxxxxxxxx.png'</span>,
    <span class="hljs-attr">isPic</span>:<span class="hljs-literal">false</span>
}
</code></pre>
<p>这里定一个名为 obj 的对象，接下来按照下面的模板生成：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a06d4dc444db4082921b484202fe9897~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSW5ZWr5ZWr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768101290&amp;x-signature=c1tu883VBScblxhECkHGHzaZfQM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">3. 实现</h2>
<p><strong>docFiles.js</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { imageHandle } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/image'</span>
<span class="hljs-keyword">import</span> { saveAs } <span class="hljs-keyword">from</span> <span class="hljs-string">'file-saver'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">JsZip</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'jszip'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">PizZip</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"pizzip"</span>;
<span class="hljs-keyword">import</span> docxtemplater <span class="hljs-keyword">from</span> <span class="hljs-string">"docxtemplater"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">JSZipUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"jszip-utils"</span>;
<span class="hljs-keyword">import</span> expressions <span class="hljs-keyword">from</span> <span class="hljs-string">"angular-expressions"</span>;
 
<span class="hljs-keyword">let</span> <span class="hljs-attr">promises</span>: any[] = [];
</code></pre>
<p>下载单个文件</p>
<pre><code class="hljs language-js" lang="js"> 
<span class="hljs-comment">/**导出单个word文件
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} opts 配置项
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">exportDocx</span> = (<span class="hljs-params">opts</span>) =&gt; {
  <span class="hljs-keyword">let</span> {
    <span class="hljs-comment">//模板文件路径(必填)</span>
    tempDocxpath,
    <span class="hljs-comment">//模板文件数据（必填）</span>
    data,
    <span class="hljs-comment">//导出文件名</span>
    fileName,
    <span class="hljs-comment">//是否包含图片</span>
    imageable,
    <span class="hljs-comment">//导出成功后的回调</span>
    onSuccess,
    <span class="hljs-comment">//导出失败后的回调</span>
    onError,
  } = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({
    <span class="hljs-attr">imageable</span>: <span class="hljs-literal">false</span>，
    <span class="hljs-attr">fileName</span>:<span class="hljs-string">'新建文件1'</span>,
  }, opts)
 
  <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolver, reject</span>) =&gt;</span> {
    <span class="hljs-title class_">JSZipUtils</span>.<span class="hljs-title function_">getBinaryContent</span>(tempDocxpath, <span class="hljs-function">(<span class="hljs-params">error, content</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-keyword">throw</span> error;
      }
      expressions.<span class="hljs-property">filters</span>.<span class="hljs-property">size</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">input, width, height</span>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">data</span>: input,
          <span class="hljs-attr">size</span>: [width, height],
        };
      }
 
      <span class="hljs-comment">//创建一个PiZip示例，内容为模板的内容</span>
      <span class="hljs-keyword">const</span> zip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PizZip</span>(content);
 
      <span class="hljs-comment">//创建并加载docxtemplater实例对象</span>
      <span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title function_">docxtemplater</span>();
 
      <span class="hljs-keyword">if</span> (imageable) {
        <span class="hljs-keyword">let</span> opts = <span class="hljs-title function_">imageHandle</span>()
        doc.<span class="hljs-title function_">attachModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageModule</span>(opts));
      }
 
      doc.<span class="hljs-title function_">loadZip</span>(zip);
      doc.<span class="hljs-title function_">setData</span>(data);
 
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">//用模板变量的值替换所有模板变量</span>
        doc.<span class="hljs-title function_">render</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">const</span> e = {
          <span class="hljs-string">"message"</span>: error.<span class="hljs-property">message</span>,
          <span class="hljs-string">"name"</span>: error.<span class="hljs-property">name</span>,
          <span class="hljs-string">"stack"</span>: error.<span class="hljs-property">stack</span>,
          <span class="hljs-string">"properties"</span>: error.<span class="hljs-property">properties</span>
        };
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ <span class="hljs-attr">error</span>: e });
        <span class="hljs-keyword">throw</span> error;
      }
 
      <span class="hljs-comment">//生成一个代表docxtemplater对象的zip文件（在内存中表示）</span>
      <span class="hljs-keyword">const</span> out = doc.<span class="hljs-title function_">getZip</span>().<span class="hljs-title function_">generate</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">"blob"</span>,
        <span class="hljs-attr">mimeType</span>: <span class="hljs-string">"application/vnd.openxmlformats-officedocument.wordprocessingml.document"</span>,
      });
      <span class="hljs-title function_">resolver</span>(out);
    })
  })
 
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([promise]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">out</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span>(onSuccess) <span class="hljs-title function_">onSuccess</span>()
    <span class="hljs-title function_">saveAs</span>(out, fileName);
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span>(onError) <span class="hljs-title function_">onError</span>()
  })
}
</code></pre>
<p>压缩包形式批量下载</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**多级目录的形式导出文件
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} opts 配置项
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">exportFile_MultiLevelDirectory</span> = (<span class="hljs-params">opts</span>) =&gt; {
  <span class="hljs-keyword">let</span> {
    <span class="hljs-comment">//模板文件路径</span>
    tempDocxpath,
    <span class="hljs-comment">//模板文件数据</span>
    data,
    <span class="hljs-comment">//一级目录名</span>
    zipName,
    <span class="hljs-comment">//下级目录对应数据路径</span>
    path,
    <span class="hljs-comment">//下级目录名称类型</span>
    subFolderNameType,
    <span class="hljs-comment">//文件名称类型</span>
    fileNameType,
    <span class="hljs-comment">//是否包含图片</span>
    imageable,
    <span class="hljs-comment">//导出成功后的回调</span>
    onSuccess,
    <span class="hljs-comment">//导出失败后的回调</span>
    onError,
  } = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({
    <span class="hljs-attr">imageable</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">zipName</span>:<span class="hljs-string">'新建文件1'</span>
  }, opts)
 
  <span class="hljs-keyword">const</span> zips = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsZip</span>();
  <span class="hljs-comment">//创建一级目录的压缩包</span>
  <span class="hljs-keyword">const</span> folder = zips.<span class="hljs-title function_">folder</span>(zipName);
 
  <span class="hljs-keyword">let</span> creatOpts = {
    tempDocxpath,
    data,
    path,
    fileNameType,
    subFolderNameType,
    imageable,
    folder,
    zips,
  }
  <span class="hljs-title function_">create_Directory</span>(creatOpts)
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(promises).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    zips.<span class="hljs-title function_">generateAsync</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"blob"</span> }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">content</span> =&gt;</span> {
      <span class="hljs-comment">//生成二进制流</span>
      <span class="hljs-keyword">if</span>(onSuccess) <span class="hljs-title function_">onSuccess</span>()
      <span class="hljs-title function_">saveAs</span>(content, zipName);
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span>(onError) <span class="hljs-title function_">onError</span>()
    })
  })
}
 
<span class="hljs-comment">/**创建下级目录
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">object</span>} opts 配置项
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">create_Directory</span>(<span class="hljs-params">opts</span>) {
  <span class="hljs-keyword">let</span> { 
     tempDocxpath,
     data,
     path,
     folder,
     subFolderNameType,
     fileNameType,
     imageable,
     zips
  } = opts
 
  <span class="hljs-comment">//遍历数据，依次形成下级目录/文件</span>
  data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (item[path] || item[path]?.<span class="hljs-property">length</span>) {
     item[path].<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item2, index2</span>) =&gt;</span> {
        <span class="hljs-comment">//创建下级目录</span>
        <span class="hljs-keyword">let</span> subFolderName = item2.<span class="hljs-property">folderName</span>
        <span class="hljs-keyword">let</span> subFolder = folder.<span class="hljs-title function_">folder</span>(subFolderName);
 
        <span class="hljs-keyword">let</span> creatOpts = {
          tempDocxpath,
          <span class="hljs-attr">data</span>: item[path],
          fileNameType,
          subFolderNameType,
          imageable,
          zips,
          <span class="hljs-attr">folder</span>: subFolder
        }
        <span class="hljs-title function_">create_Directory</span>(creatOpts)
      })
    }<span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> fileName = item.<span class="hljs-property">fileName</span>
      <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolver, reject</span>) =&gt;</span> {
        <span class="hljs-title class_">JSZipUtils</span>.<span class="hljs-title function_">getBinaryContent</span>(tempDocxpath, <span class="hljs-function">(<span class="hljs-params">error, content</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (error) {
            <span class="hljs-keyword">throw</span> error;
          }
          expressions.<span class="hljs-property">filters</span>.<span class="hljs-property">size</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">input, width, height</span>) {
            <span class="hljs-keyword">return</span> {
              <span class="hljs-attr">data</span>: input,
              <span class="hljs-attr">size</span>: [width, height],
            };
          };
          <span class="hljs-keyword">const</span> zip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PizZip</span>(content);
          <span class="hljs-keyword">let</span> doc = <span class="hljs-keyword">new</span> <span class="hljs-title function_">docxtemplater</span>();
          <span class="hljs-keyword">if</span> (imageable) {
            <span class="hljs-keyword">let</span> opts = <span class="hljs-title function_">imageHandle</span>()
            doc.<span class="hljs-title function_">attachModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageModule</span>(opts));
          }
          doc.<span class="hljs-title function_">loadZip</span>(zip);
 
          doc.<span class="hljs-title function_">setData</span>(item);
          <span class="hljs-keyword">try</span> {
            doc.<span class="hljs-title function_">render</span>();
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-keyword">const</span> e = {
              <span class="hljs-string">"message"</span>: error.<span class="hljs-property">message</span>,
              <span class="hljs-string">"name"</span>: error.<span class="hljs-property">name</span>,
              <span class="hljs-string">"stack"</span>: error.<span class="hljs-property">stack</span>,
              <span class="hljs-string">"properties"</span>: error.<span class="hljs-property">properties</span>
            };
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ <span class="hljs-attr">error</span>: e });
            <span class="hljs-keyword">throw</span> error;
          }
          <span class="hljs-keyword">const</span> out = doc.<span class="hljs-title function_">getZip</span>().<span class="hljs-title function_">generate</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"blob"</span>,
            <span class="hljs-attr">mimeType</span>: <span class="hljs-string">"application/vnd.openxmlformats-officedocument.wordprocessingml.document"</span>,
          });
          folder.<span class="hljs-title function_">file</span>(fileName, out, { <span class="hljs-attr">binary</span>: <span class="hljs-literal">true</span> });
          <span class="hljs-title function_">resolver</span>(<span class="hljs-string">'success'</span>);
        });
      })
      promises.<span class="hljs-title function_">push</span>(promise);
    }
  }
}
</code></pre>
<blockquote>
<p>注意：导出多个word文件时需注意文档命名问题，避免因名称重复产生的文件覆盖问题。</p>
</blockquote>
<p><strong>image.js</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 图片处理选项配置生成函数。
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Object</span>} 返回一个包含图片处理选项的对象。
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">imageHandle</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 图片处理</span>
  <span class="hljs-keyword">let</span> opts = {}
 
  opts = {
    <span class="hljs-comment">//图像是否居中</span>
    <span class="hljs-attr">centered</span>: <span class="hljs-literal">false</span>
  };
  opts.<span class="hljs-property">getImage</span> = <span class="hljs-function">(<span class="hljs-params">chartId</span>) =&gt;</span> {
    <span class="hljs-comment">// 将base64的数据转为ArrayBuffer</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">base64DataURLToArrayBuffer</span>(chartId);
  }
  opts.<span class="hljs-property">getSize</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">img, tagValue, tagName</span>) {
    <span class="hljs-comment">//自定义指定图像大小</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-number">500</span>, <span class="hljs-number">400</span>];
  }
  <span class="hljs-keyword">return</span> opts
}
 
<span class="hljs-comment">/**
 * 将base64格式的数据转为ArrayBuffer
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} dataURL base64格式的数据
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">base64DataURLToArrayBuffer</span>(<span class="hljs-params">dataURL</span>) {
  <span class="hljs-keyword">const</span> base64Regex = <span class="hljs-regexp">/^data:image\/(png|jpg|jpeg|svg|svg\+xml);base64,/</span>;
  <span class="hljs-keyword">if</span> (!base64Regex.<span class="hljs-title function_">test</span>(dataURL)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">const</span> stringBase64 = dataURL.<span class="hljs-title function_">replace</span>(base64Regex, <span class="hljs-string">""</span>);
  <span class="hljs-keyword">let</span> binaryString;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
    binaryString = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">atob</span>(stringBase64);
  } <span class="hljs-keyword">else</span> {
    binaryString = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Buffer</span>(stringBase64, <span class="hljs-string">"base64"</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">"binary"</span>);
  }
  <span class="hljs-keyword">const</span> len = binaryString.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(len);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
    <span class="hljs-keyword">const</span> ascii = binaryString.<span class="hljs-title function_">charCodeAt</span>(i);
    bytes[i] = ascii;
  }
  <span class="hljs-keyword">return</span> bytes.<span class="hljs-property">buffer</span>;
}
</code></pre>
<p><strong>应用页面文件</strong></p>
<p>注释部分为批量导出</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"downWord"</span>&gt;</span>导出word<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">let</span> obj={
        <span class="hljs-attr">name</span>:<span class="hljs-string">'张三'</span>,
        <span class="hljs-attr">images</span>:[]
    }
    
    <span class="hljs-comment">/*let objList=[
        {
            folderName:'济南市',
            children:[
                {
                    fileName:'张村申请合同',
                    name:'张村',
                    count:72
                },
                {
                    fileName:'大王村申请合同',
                    name:'大王村',
                    count:56
                },
            ]
        },
        {
            folderName:'德州市',
            children:[
                {
                    fileName:'高家村申请合同',
                    name:'高家村',
                    count:10
                },
            ]
        },
        {
            fileName:'居户里村申请合同',
            name:'居户里村',
            count:74
        },
    ]*/</span>
 
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">downWord</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">let</span> opts={
            <span class="hljs-attr">tempDocxpath</span>:<span class="hljs-string">'/moBan.docx'</span>,
            <span class="hljs-attr">data</span>:obj,
            <span class="hljs-attr">fileName</span>:<span class="hljs-string">'申请表'</span>
        }
        <span class="hljs-title function_">exportDocx</span>(opts)
        <span class="hljs-comment">/*let opts={
            tempDocxpath:'/moBan.docx',
            data:objList,
            zipName:'合同申请'
        }*/</span>
        <span class="hljs-comment">//exportFile_MultiLevelDirectory(opts)</span>
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-5">4. 问题</h2>
<p>（1）End of data reached (data length = 0, asked index = 4). Corrupted zip ?</p>
<p>原因：模板文件为空文件；</p>
<p>排查：检查模板文件引入是否正确</p>
<p>（2）导出的文件中图片显示undefined</p>
<p>原因：图片路径转换成base64后的格式不对</p>
<p>（3）文件数量不对</p>
<p>排查：是不是文件名重复覆盖导致数量不对</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 中的 LayoutInflater.Factory2 笔记]]></title>    <link>https://juejin.cn/post/7590303618429796387</link>    <guid>https://juejin.cn/post/7590303618429796387</guid>    <pubDate>2026-01-04T01:09:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590303618429796387" data-draft-id="7590303618429780003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 中的 LayoutInflater.Factory2 笔记"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-04T01:09:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心源xinyuan"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029151694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 中的 LayoutInflater.Factory2 笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029151694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心源xinyuan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:09:49.000Z" title="Sun Jan 04 2026 01:09:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Android中，<code>Factory2</code> 是 <code>LayoutInflater</code> 的一个接口。它的核心作用是<strong>拦截并接管布局文件（XML）中每一个视图（View）的创建过程</strong>。</p>
<ul>
<li><strong>核心作用</strong>：你可以把它理解为一个“<strong>视图创建拦截器</strong>”。当系统解析XML布局、准备将标签名（如 <code>&lt;TextView&gt;</code>）实例化为真正的View对象时，会优先询问你设置的 <code>Factory2</code>：“你想怎么创建这个View？”。</li>
<li><strong>工作原理</strong>：<code>LayoutInflater</code> 内部有一个 <code>createViewFromTag</code> 方法。在创建View时，它会<strong>首先检查是否设置了 <code>Factory2</code></strong>。如果设置了，就会调用 <code>Factory2.onCreateView()</code> 方法。如果这个方法返回了一个有效的View对象，则直接使用；如果返回 <code>null</code>，则系统会按照默认流程去创建View。</li>
</ul>
<h3 data-id="heading-0">🔧 主要用途与应用场景</h3>
<p>利用这个“拦截”能力，<code>Factory2</code> 可以实现许多强大的功能：</p>






























<table><thead><tr><th align="left">用途场景</th><th align="left">功能说明</th><th align="left">示例 / 实现关键</th></tr></thead><tbody><tr><td align="left"><strong>全局替换系统组件</strong></td><td align="left">将XML中的标准控件自动替换为兼容性或自定义版本。</td><td align="left"><code>AppCompatActivity</code> 用它自动将 <code>&lt;Button&gt;</code> 替换为 <code>AppCompatButton</code>。</td></tr><tr><td align="left"><strong>统一修改视图属性</strong></td><td align="left">为所有特定类型的View（如所有TextView）动态添加统一样式或行为。</td><td align="left">拦截 <code>TextView</code> 创建，设置全局默认字体、文字颜色或背景。</td></tr><tr><td align="left"><strong>实现无侵入的监控</strong></td><td align="left">在不修改业务代码的情况下，为所有View添加性能监控或事件埋点。</td><td align="left">创建View时，为其包装一层代理，统一监听点击、测量等事件。</td></tr><tr><td align="left"><strong>动态主题/换肤</strong></td><td align="left">根据运行时主题，动态替换视图对应的资源。</td><td align="left">根据主题状态，在创建View时选择不同的资源ID或构造方式。</td></tr></tbody></table>
<h3 data-id="heading-1">💡 如何使用与关键代码</h3>
<p>使用 <code>Factory2</code> 的基本步骤如下，但需要注意与 <code>AppCompatActivity</code> 的兼容性问题。</p>
<p><strong>1. 基本使用模式</strong>
你需要实现 <code>LayoutInflater.Factory2</code> 接口，并在 <code>Activity.onCreate()</code> 的 <code>super.onCreate()</code> <strong>之前</strong>进行设置。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-comment">// 必须在 super.onCreate 之前设置</span>
        LayoutInflater.from(<span class="hljs-built_in">this</span>).setFactory2(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LayoutInflater</span>.Factory2() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> {
                <span class="hljs-comment">// 1. 在这里进行拦截和自定义</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"TextView"</span>.equals(name)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCustomTextView</span>(context, attrs); <span class="hljs-comment">// 返回你的自定义View</span>
                }
                <span class="hljs-comment">// 2. 对于不想处理的View，返回null，让系统或其他Factory处理</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, Context context, AttributeSet attrs)</span> {
                <span class="hljs-comment">// 此方法为继承自Factory的接口，通常通过上一个方法实现即可</span>
                <span class="hljs-keyword">return</span> onCreateView(<span class="hljs-literal">null</span>, name, context, attrs);
            }
        });

        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }
}
</code></pre>
<p><strong>2. 与 AppCompatActivity 的兼容性问题（关键！）</strong>
如果你继承 <code>AppCompatActivity</code>，会发现上述方法可能无效或报错。这是因为 <code>AppCompatActivity</code> 自己也在 <code>onCreate</code> 中设置了一个 <code>Factory2</code> 来实现向后兼容（如将 <code>Button</code> 替换为 <code>AppCompatButton</code>），而 <code>LayoutInflater</code> 的 Factory <strong>只能被设置一次</strong>。</p>
<p><strong>解决方案：代理模式</strong>
正确的方式是创建一个代理，将你不处理的View创建请求，转发给 <code>AppCompatDelegate</code> 去处理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAppCompatActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        LayoutInflater.from(<span class="hljs-built_in">this</span>).setFactory2(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LayoutInflater</span>.Factory2() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> {
                <span class="hljs-comment">// 1. 自己的逻辑：拦截TextView</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"TextView"</span>.equals(name)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCustomTextView</span>(context, attrs);
                }
                <span class="hljs-comment">// 2. 重要：将其他View的创建代理给AppCompat</span>
                <span class="hljs-type">AppCompatDelegate</span> <span class="hljs-variable">delegate</span> <span class="hljs-operator">=</span> getDelegate();
                <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> delegate.createView(parent, name, context, attrs);
                <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> view;
                }
                <span class="hljs-comment">// 3. 如果AppCompat也没处理，返回null走默认流程</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-comment">// ... 省略另一个 onCreateView 方法</span>
        });
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }
}
</code></pre>
<h3 data-id="heading-2">⚠️ 重要注意事项</h3>
<ul>
<li><strong>只能设置一次</strong>：<code>LayoutInflater</code> 的 <code>setFactory</code> 或 <code>setFactory2</code> <strong>只能成功调用一次</strong>，重复设置会抛出 <code>IllegalStateException</code>。这就是为什么在 <code>AppCompatActivity</code> 中需要特殊处理。</li>
<li><strong>时序非常重要</strong>：自定义的 <code>Factory2</code> <strong>必须在 <code>super.onCreate(savedInstanceState)</code> 之前设置</strong>，否则可能会因为 <code>AppCompatActivity</code> 已抢先设置而失败。</li>
<li><strong>优先使用 Factory2</strong>：<code>Factory2</code> 继承自 <code>Factory</code>，并多了一个 <code>parent</code> 参数，能提供更多上下文信息。在 API 11+ 的应用中应优先使用 <code>setFactory2</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[注解]]></title>    <link>https://juejin.cn/post/7590403249561665551</link>    <guid>https://juejin.cn/post/7590403249561665551</guid>    <pubDate>2026-01-04T02:14:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561665551" data-draft-id="7590403249561337871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="注解"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-04T02:14:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:14:37.000Z" title="Sun Jan 04 2026 02:14:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">什么是注解</h3>
<p>java.lang.annotation.Annotation 接口中有这么一句话，用来描述注解。</p>
<p>The common interface extended by all annotation types
所有的注解类型都继承 Annotation</p>
<p>这句话有点抽象，但却说出了注解的本质。我们看看 JDK 内置注解 @Override 的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Override {

}
</code></pre>
<p>其实本质上是：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Override</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>{

}
</code></pre>
<p>没错，注解的本质就是一个继承了 Annotation 接口的接口。有关这一点，你可以去反编译任意一个注解类看看结果。</p>
<p>比如新建一个 Teacher.java 文件用于自定义注解：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>({ElementType.TYPE,ElementType.FIELD})
<span class="hljs-variable">@Retention</span>(RetentionPolicy.SOURCE)
public <span class="hljs-variable">@interface</span> Teacher {
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">name</span>();
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">age</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-number">20</span>; 
}
</code></pre>
<p>然后使用 <code>javac Teacher.java</code> 命令生成 Teacher.class 文件，再使用 <code>javap Teacher.class</code> 反编译后输出如下：</p>
<pre><code class="hljs language-java" lang="java">Compiled from <span class="hljs-string">"Teacher.java"</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">com</span>.example.test.Teacher <span class="hljs-keyword">extends</span> <span class="hljs-title class_">java</span>.lang.annotation.Annotation {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> java.lang.String <span class="hljs-title function_">name</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">age</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>可以看到自定义注解确实是一个继承自 java.lang.annotation.Annotation 接口的接口。</p>
<p><strong>准确意义上来说，注解只不过是代码里的特殊标记而已</strong>。这些标记可以在编译、类加载或运行时被读取，并执行相应的处理。通过使用注解，开发人员可以在不改变原有逻辑的情况下，在源文件中嵌入一些补充信息。代码分析工具、开发工具和部署工具可以通过这些补充信息进行验证、处理或者部署。</p>
<h3 data-id="heading-1">元注解</h3>
<p>与声明一个类不同的是，注解的声明使用 @interface 关键字，@Override 注解的声明如下:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Override {

}
</code></pre>
<p>其中的 @Target，@Retention 两个注解是我们所谓的『元注解』，『元注解』是用于修饰注解的注解，通常用在注解的定义上，『元注解』一般用于指定某个注解的保留策略以及作用目标等信息。</p>
<p>Java 中有以下几个『元注解』：</p>
<ul>
<li>@Target：注解的作用目标</li>
<li>@Retention：注解的保留策略</li>
<li>@Documented：注解是否应当被包含在 JavaDoc 文档中</li>
<li>@Inherited：是否允许子类继承该注解</li>
</ul>
<p>其中，@Target 用于指明被修饰的注解最终可以作用的目标是谁，也就是指明，你的注解到底是用来修饰方法的，修饰类的，还是用来修饰字段属性的。</p>
<p>@Target定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target({ElementType.ANNOTATION_TYPE})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Target {
    ElementType[] value();
}
</code></pre>
<p>我们可以通过以下方式来为这个 value 传值：</p>
<p>@Target(value = {ElementType.FIELD})</p>
<p>上面这段代码表示该注解将只能作用在成员字段上，不能用于修饰方法或者类。其中，ElementType 是一个枚举类型，有以下一些值：</p>
<ul>
<li>ElementType.TYPE 允许被修饰的注解作用在类、接口和枚举上</li>
<li>ElementType.FIELD 允许作用在成员变量上</li>
<li>ElementType.METHOD：允许作用在方法上</li>
<li>ElementType.PARAMETER：允许作用在方法参数上</li>
<li>ElementType.CONSTRUCTOR：允许作用在构造方法上</li>
<li>ElementType.LOCAL_VARIABLE：允许作用在本地局部变量上</li>
<li>ElementType.ANNOTATION_TYPE：允许作用在注解上</li>
<li>ElementType.PACKAGE：允许作用在包上</li>
</ul>
<p>@Retention 用于指明当前注解的保留策略，它的基本定义如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target({ElementType.ANNOTATION_TYPE})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Retention {
    RetentionPolicy <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>同样的，它也有一个 value 属性：</p>
<p>@Retention(value = RetentionPolicy.RUNTIME）</p>
<p>这里的 RetentionPolicy 依然是一个枚举类型，它有以下几个枚举值可取：</p>
<ul>
<li><strong>RetentionPolicy.SOURCE：源码级注解。注解信息只会保留在 .java 源码中，源码在编译后，注解信息被丢弃，不会保留在 .class 中</strong>。</li>
<li><strong>RetentionPolicy.CLASS：编译时注解。注解信息会保留在 .java 源码以及 .class 中。当运行 Java 程序时， JVM 会丢弃该注解信息，不会保留在 JVM 中</strong>。</li>
<li><strong>RetentionPolicy.RUNTIME：运行时注解。当运行 Java 程序时， JVM 也会保留该注解信息，可以通过反射获取该注解信息</strong>。</li>
</ul>
<p>@Retention 注解指定了被修饰的注解的保留策略，这3个策略的生命周期长度为 SOURCE &lt; CLASS &lt; RUNTIME 。生命周期短的能起作用的地方，生命周期长的也一定能起作用。如果只是做一些检查性的操作，比如 @Override 和 @SuppressWarning ，则可选用 RetentionPolicy.SOURCE 。如果要在编译时进行一些预处理操作，比如生成一些辅助代码（ARouter 的 @Route 注解就是这种情况），就用 RetentionPolicy.CLASS 。如果要在运行时动态获取注解信息，那就只能用 RetentionPolicy.RUNTIME 。</p>
<p>剩下两种类型的元注解我们日常用的不多，也比较简单，这里不再详细介绍了，你只需要知道他们各自的作用即可。@Documented 注解修饰的注解，当我们执行 JavaDoc 文档打包时会被保存进 doc 文档，反之将在打包时丢弃。@Inherited 注解修饰的注解是具有可继承性的，也就说我们的注解修饰了一个类，而该类的子类将自动继承父类的该注解。</p>
<p>下面我们来自定义一个注解，里面有 2 个成员变量：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target({ElementType.TYPE,ElementType.FIELD})</span> 
<span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Teacher {
    String <span class="hljs-title function_">name</span><span class="hljs-params">()</span>; <span class="hljs-comment">//无默认值</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">age</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">20</span>; 
}
</code></pre>
<p>注解只有成员变量，成员变量在注解定义中以<strong>无形参的方法</strong>的形式来声明。在使用注解时，如果定义的注解中的成员变量无默认值，则使用时必须传值。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Teacher(name = "小帅")</span> <span class="hljs-comment">// name 无默认值，需要传值；age 有默认值，可以省略</span>
<span class="hljs-meta">@Teacher(name = "小帅", age = 22)</span> <span class="hljs-comment">// 也可以显式赋值 </span>
</code></pre>
<h3 data-id="heading-2">源码级注解的应用</h3>
<p>源码级注解的注解信息只会保留在 .java 源码中，编译后注解信息会被丢弃，不会保留在 .class 中。编译如下代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Teacher(name = "小帅", age = 22)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
}
</code></pre>
<p>然后去 build\intermediates\javac\debug\classes\ 目录下找到 Test.class，打开发现已经找不到注解了。如果将保留策略改成 RetentionPolicy.CLASS ，则在 Test.class 中还可以找到注解:</p>
<pre><code class="hljs language-class" lang="class">@Teacher(
    name = "小帅",
    age = 22
)
public class Test {
}
</code></pre>
<p>源码级注解主要用来做一些检查性的工作，比如，在 androidx.annotation 中有提供 @IntDef 注解，此注解的定义如下:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Retention(SOURCE)</span> 
<span class="hljs-meta">@Target({ANNOTATION_TYPE})</span> 
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> IntDef {
    <span class="hljs-type">int</span>[] value() <span class="hljs-keyword">default</span> {};
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">flag</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">open</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>此注解能够取代枚举，实现方法入参的限制。</p>
<blockquote>
<p>Java 中的 enum （枚举）实质是特殊单例的静态成员变量，在运行期所有枚举类作为单例，全部加载到内存中，比常量多 5 到 10 倍的内存占用。</p>
</blockquote>
<p>比如我们定义一个 test() 方法，接收的参数 Student 只能在 Jim 、 Lily 两位学生中选一个，如果使用枚举实现，代码如下:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {

    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Student</span>{
        Jim,
        Lily
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(Student student)</span>{
    }
}
</code></pre>
<p>为了优化内存，我们现在不再使用枚举，改成如下代码:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">Jim</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">Lily</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-type">int</span> student)</span>{

    }
}
</code></pre>
<p>这种方式有什么弊端呢？test() 方法由于采用 int 类型，将无法限定为 Jim 和 Lily 。</p>
<p>下面我们使用注解进行优化:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Constants</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">Jim</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
    <span class="hljs-type">int</span> <span class="hljs-variable">Lily</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@IntDef(value = {Constants.Jim, Constants.Lily})</span>
<span class="hljs-meta">@Target(ElementType.PARAMETER)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Student {
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-meta">@Student</span> <span class="hljs-type">int</span> student)</span>{

    }
}
</code></pre>
<p>此时，我们再去调用 test() 方法，如果传递的参数不是 Constants.Jim 或 Constants.Lily ，Android Studio 会报红。</p>
<h3 data-id="heading-3">运行时注解的应用</h3>
<p>针对运行时注解会采用反射机制获取注解信息，我们定义一个运行时注解，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target({ElementType.METHOD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Teacher {
    String <span class="hljs-title function_">name</span><span class="hljs-params">()</span>; 
    <span class="hljs-type">int</span> <span class="hljs-title function_">age</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">20</span>;
}
</code></pre>
<p>接下来在 AnnotationTest 类的方法上应用该注解，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationTest</span> {

    <span class="hljs-meta">@Teacher(name = "老王")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMathTeacherName</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }

    <span class="hljs-meta">@Teacher(name = "老刘")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getEnglishTeacherName</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
}
</code></pre>
<p>最后写一个简单的注解处理器，通过反射获取注解中的信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationProcessor</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Method[] methods = AnnotationTest.class.getDeclaredMethods();
        <span class="hljs-keyword">for</span>(Method m : methods){
            <span class="hljs-comment">// 通过 getAnnotation() 获取指定类型的注解对象</span>
            <span class="hljs-type">Teacher</span> <span class="hljs-variable">teacher</span> <span class="hljs-operator">=</span> m.getAnnotation(Teacher.class);
            System.out.println(teacher.name());
        }
    }
}
</code></pre>
<p>输出结果为：</p>
<pre><code class="hljs language-java" lang="java">老刘
老王
</code></pre>
<p>这样就拿到了注解中的成员变量的值，Retrofit 中的注解也是同样的原理，通过反射拿到注解中的信息。</p>
<h3 data-id="heading-4">编译时注解的应用</h3>
<p>处理编译时注解相对会比较麻烦，编译时注解一般会结合注解处理器（APT）对注解进行处理，这里模拟一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJakeWharton%2Fbutterknife" target="_blank" title="https://github.com/JakeWharton/butterknife" ref="nofollow noopener noreferrer">ButterKnife</a> 自动绑定布局 id 的例子进行说明。</p>
<h5 data-id="heading-5">1. 定义注解</h5>
<p>新建一个项目，在项目中新建一个 Java Library 来存放注解，Library 命名为 annotations 。接下来定义注解，如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.FIELD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.CLASS)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyBindView {
    <span class="hljs-comment">// value 值对应要绑定的布局 id</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>注解定义好了，在 Activity 中就可以使用了。在 app 模块的 MainActivity 中使用该注解，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-meta">@MyBindView(R.id.tv_text)</span>
    TextView textView;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }
}
</code></pre>
<p>通过注解的 value 值就可以拿到布局 id ，但是怎么把 View 和 id 绑定起来呢？</p>
<p>如果 MyBindView 是 RetentionPolicy.RUNTIME 类型的，可以通过运行时反射绑定 id:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(Activity activity)</span> {
    <span class="hljs-comment">// 获取成员变量</span>
    <span class="hljs-keyword">for</span> (Field field : activity.getClass().getDeclaredFields()) {
        <span class="hljs-comment">// 判断这个成员变量上是否有 @MyBindView 注解</span>
        <span class="hljs-type">MyBindView</span> <span class="hljs-variable">myBindView</span> <span class="hljs-operator">=</span> field.getAnnotation(MyBindView.class);
        <span class="hljs-keyword">if</span> (myBindView != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 将 activity 中成员 field 的值赋值为：activity.findViewById(myBindView.value())</span>
                field.set(activity, activity.findViewById(myBindView.value()));
            } <span class="hljs-keyword">catch</span> (IllegalAccessException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<p>但是现在注解不是 RetentionPolicy.RUNTIME 类型的，并且每次运行的时候去反射效率比较低，因为反射是比较耗性能的，当然你可以用缓存来优化，还有一种更好的办法是使用 APT 结合 JavaPoet 来实现。</p>
<h5 data-id="heading-6">2.编写注解处理器</h5>
<p>再新建一个 Java Library 来存放注解处理器，Library 命名为 processor，接下来编写注解处理器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AutoService(Processor.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractProcessor</span> {
    Filer filer;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ProcessingEnvironment processingEnvironment)</span> {
        <span class="hljs-built_in">super</span>.init(processingEnvironment);
        filer = processingEnvironment.getFiler();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">process</span><span class="hljs-params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> {
        <span class="hljs-comment">// 遍历所有的类</span>
        <span class="hljs-keyword">for</span> (Element element : roundEnvironment.getRootElements()) {
            <span class="hljs-comment">// 获取类的包名</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">packageStr</span> <span class="hljs-operator">=</span> element.getEnclosingElement().toString();
            <span class="hljs-comment">// 获取类的名字</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">classStr</span> <span class="hljs-operator">=</span> element.getSimpleName().toString();
            <span class="hljs-comment">// 需要构建的新类名：原类名 + Binding</span>
            <span class="hljs-type">ClassName</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> ClassName.get(packageStr, classStr + <span class="hljs-string">"Binding"</span>);
            <span class="hljs-comment">// 构建新的类的构造方法</span>
            MethodSpec.<span class="hljs-type">Builder</span> <span class="hljs-variable">constructorBuilder</span> <span class="hljs-operator">=</span> MethodSpec.constructorBuilder()
                    .addModifiers(Modifier.PUBLIC)
                    .addParameter(ClassName.get(packageStr, classStr), <span class="hljs-string">"activity"</span>);

            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasBuild</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-comment">// 获取类里面的元素，比如类的成员变量、方法、内部类等</span>
            <span class="hljs-keyword">for</span> (Element enclosedElement : element.getEnclosedElements()) {
                <span class="hljs-comment">// 获取成员变量</span>
                <span class="hljs-keyword">if</span> (enclosedElement.getKind() == ElementKind.FIELD) {
                    <span class="hljs-comment">// 判断是否被 @MyBindView 注解</span>
                    <span class="hljs-type">MyBindView</span> <span class="hljs-variable">bindView</span> <span class="hljs-operator">=</span> enclosedElement.getAnnotation(MyBindView.class);
                    <span class="hljs-keyword">if</span> (bindView != <span class="hljs-literal">null</span>) {
                        <span class="hljs-comment">// 需要生成类</span>
                        hasBuild = <span class="hljs-literal">true</span>;
                        <span class="hljs-comment">// 在构造方法中加入代码</span>
                        constructorBuilder.addStatement(<span class="hljs-string">"activity.$N = activity.findViewById($L)"</span>,
                                enclosedElement.getSimpleName(), bindView.value());
                    }
                }
            }
            <span class="hljs-comment">// 判断需要生成</span>
            <span class="hljs-keyword">if</span> (hasBuild) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 构建新的类</span>
                    <span class="hljs-type">TypeSpec</span> <span class="hljs-variable">builtClass</span> <span class="hljs-operator">=</span> TypeSpec.classBuilder(className)
                            .addModifiers(Modifier.PUBLIC)
                            .addMethod(constructorBuilder.build())
                            .build();
                    <span class="hljs-comment">// 生成 Java 文件</span>
                    JavaFile.builder(packageStr, builtClass)
                            .build().writeTo(filer);
                } <span class="hljs-keyword">catch</span> (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title function_">getSupportedAnnotationTypes</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 只支持 @MyBindView 注解</span>
        <span class="hljs-keyword">return</span> Collections.singleton(MyBindView.class.getCanonicalName());
    }

}
</code></pre>
<p>在其 build.gradle 中添加如下配置：</p>
<pre><code class="hljs language-c" lang="c">dependencies {
    implementation <span class="hljs-title function_">project</span><span class="hljs-params">(<span class="hljs-string">":annotations"</span>)</span>
    <span class="hljs-comment">// AutoService 是Google提供的</span>
    annotationProcessor 'com.google.<span class="hljs-keyword">auto</span>.service:<span class="hljs-keyword">auto</span>-service:1.0-rc7'
    compileOnly 'com.google.<span class="hljs-keyword">auto</span>.service:<span class="hljs-keyword">auto</span>-service:1.0-rc7'
    <span class="hljs-comment">// javapoet 是一个代码生成框架，利用它可以优雅的生成我们想要的代码</span>
    implementation 'com.squareup:javapoet:1.10.0'
}
</code></pre>
<p>其中 AutoService 是 Google 提供的，用来帮助生成 javax.annotation.processing.Processor 文件的，如果你不使用它，你就需要自己去 resources 中添加该文件。</p>
<p>注解处理器里面的几个方法解释一下：</p>
<ol>
<li>init: 会被注解处理工具调用，入参为 ProcessingEnvironment，ProcessingEnvironment 提供了很多有用的工具类，比如 Elements、Types、Filter 和 Messager 等。</li>
<li>process：你要在这里对注解进行处理。</li>
<li>getSupportedAnnotationTypes：指定这个注解处理器支持的注解类型。</li>
</ol>
<p>process() 方法中的代码会查找成员变量上有 @MyBindView 注解的类，生成代码，类名为：原类名 + Binding，并通过 findViewById 来绑定 View 和 id 。代码是通过 <code>com.squareup:javapoet:1.10.0</code> 这个框架来生成的，如果没有这个框架，那么需要使用字符串拼接的方式来生成代码， <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgreenrobot%2FEventBus" target="_blank" title="https://github.com/greenrobot/EventBus" ref="nofollow noopener noreferrer">EventBus</a> 就使用了字符串拼接的方式:</p>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3ce33f7c0464b3cb4f4e18cab987773~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=949&amp;h=969&amp;s=122587&amp;e=png&amp;b=fffefe" alt="image.png" width="70%" loading="lazy"/>
<p>给 app 模块的build.gradle添加如下配置：</p>
<pre><code class="hljs language-css" lang="css">dependencies {
    implementation project(path: <span class="hljs-string">':annotations'</span>)
    annotationProcessor <span class="hljs-built_in">project</span>(<span class="hljs-string">':processor'</span>)
}
</code></pre>
<p>然后在Terminal中输入：<code>./gradlew :app:compileDebugJavaWithJavac</code>，就会在 app 模块下生成MainActivityBind.java文件：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d853945ba8ef453bab12e04d0d1f9ec2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=403&amp;h=171&amp;s=7955&amp;e=png&amp;b=4f4b41" alt="image.png" loading="lazy"/></p>
<p>打开 MainActivityBind.java，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivityBinding</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MainActivityBinding</span><span class="hljs-params">(MainActivity activity)</span> {
        activity.textView = activity.findViewById(<span class="hljs-number">2131231011</span>);
    }
}
</code></pre>
<p>此时只是生成了我们想要的代码，还需要调用 MainActivityBinding 的构造函数。</p>
<h5 data-id="heading-7">3.应用注解</h5>
<p>再新建一个 Android Library，Library 命名为 reflect，在 build.gradle 中添加如下配置：</p>
<pre><code class="hljs language-css" lang="css">dependencies {
    api project(path: <span class="hljs-string">':annotations'</span>)
}
</code></pre>
<p>代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyButterKnife</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(Activity activity)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取"当前的 activity 类名 + Binding "的 class 对象</span>
            <span class="hljs-type">Class</span> <span class="hljs-variable">bindingClass</span> <span class="hljs-operator">=</span> Class.forName(activity.getClass().getCanonicalName() + <span class="hljs-string">"Binding"</span>);
            <span class="hljs-comment">// 获取 class 对象的构造方法，该构造方法的参数为当前的 activity 对象</span>
            <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> bindingClass.getDeclaredConstructor(activity.getClass());
            <span class="hljs-comment">// 创建实例</span>
            constructor.newInstance(activity);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>最后在 app 模块的 MainActivity 中调用 MyButterKnife 的 bind() 方法，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-meta">@MyBindView(R.id.tv_text)</span>
    TextView textView;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        MyButterKnife.bind(<span class="hljs-built_in">this</span>);
        textView.setText(<span class="hljs-string">"Hello APT!!!!"</span>);
    }
}
</code></pre>
<p>其中 app 模块的 build.gradle 配置需要修改成如下所示：</p>
<pre><code class="hljs language-css" lang="css">dependencies {
    implementation project(path: <span class="hljs-string">':reflect'</span>)
    annotationProcessor <span class="hljs-built_in">project</span>(<span class="hljs-string">':processor'</span>)
}
</code></pre>
<p>运行 MainActivity ，通过 MyButterKnife 的 bind() 方法就实现了自动绑定布局 id 的功能。可以分析一下 ARouter 框架，也是类似的原理。</p>
<p>Demo地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEnzoXRay%2FAnnotationTest" target="_blank" title="https://github.com/EnzoXRay/AnnotationTest" ref="nofollow noopener noreferrer">github.com/EnzoXRay/An…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android抓取trace的几种方式]]></title>    <link>https://juejin.cn/post/7590684822726459432</link>    <guid>https://juejin.cn/post/7590684822726459432</guid>    <pubDate>2026-01-04T02:24:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590684822726459432" data-draft-id="7587997893987090459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android抓取trace的几种方式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-04T02:24:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陈泡泡_"/> <meta itemprop="url" content="https://juejin.cn/user/2735240662223358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android抓取trace的几种方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240662223358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陈泡泡_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:24:31.000Z" title="Sun Jan 04 2026 02:24:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一般在做性能优化时，我们喜欢用抓取火焰图的方式，来分析相关trace调用，发现对应的性能问题；最近在做启动优化，也尝试了几种不同的方式，遂记录下来</p>
</blockquote>
<h2 data-id="heading-0">一、几种抓取火焰图的方式</h2>
<blockquote>
<p>Google对<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fprofile%2Fchart-glossary%2Fflame-chart%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/studio/profile/chart-glossary/flame-chart?hl=zh-cn" ref="nofollow noopener noreferrer">火焰图</a>的介绍</p>
</blockquote>
<h4 data-id="heading-1">1.使用AS的Profiler</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fprofile" target="_blank" title="https://developer.android.com/studio/profile" ref="nofollow noopener noreferrer">developer.android.com/studio/prof…</a></p>
<ul>
<li>2024.1.2版本之前的抓取界面，在这个版本抓取时间一长就会卡死，而且没办法抓取启动阶段的火焰图，界面也不是很直观</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1074b6788b0f4167a04662bbb0411d91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5rOh5rOhXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098271&amp;x-signature=1%2BaFRKIG40XeyMhG1VDhXGyEErs%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Freleases%2Fpast-releases%2Fas-koala-feature-drop-release-notes%23task-based-profiler" target="_blank" title="https://developer.android.com/studio/releases/past-releases/as-koala-feature-drop-release-notes#task-based-profiler" ref="nofollow noopener noreferrer">新版本</a>改进了 Android Studio Profiler 的性能，Profiler也根据CPU、内存和功耗这种任务为中心进行了重新设计，也可以在打开 Profiler 后立即从用户界面启动系统跟踪任务，以分析并改进应用程序的启动时间。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b264b1868194d31a4a458f1350c8fbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5rOh5rOhXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098271&amp;x-signature=zUJUmNXr0J6%2BBivH04e0Z%2FM%2FP4I%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>整体操作比较简单，具体用法可以参考官方文档<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fprofile%2Fcapture-heap-dump" target="_blank" title="https://developer.android.com/studio/profile/capture-heap-dump" ref="nofollow noopener noreferrer">developer.android.com/studio/prof…</a></li>
</ul>
<h4 data-id="heading-2">2.使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fui.perfetto.dev%2F" target="_blank" title="https://ui.perfetto.dev/" ref="nofollow noopener noreferrer">perfetto</a>来抓取</h4>
<p>快速开始：<a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fquickstart%2Fandroid-tracing" target="_blank" title="https://perfetto.dev/docs/quickstart/android-tracing" ref="nofollow noopener noreferrer">perfetto.dev/docs/quicks…</a></p>
<ul>
<li>抓取到的火焰图类似下面这种，没有堆栈，原因是因为我们没有手动加trace</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/400d9ae44c29469fac9b15e0e7b42f2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5rOh5rOhXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098271&amp;x-signature=KNA1IBv3BsJ0Y%2BWPhWsVuNFGkH0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>如果提示adb连接失败，可以把Android Studio关闭，或者重新插拔usb</li>
<li>网页的setting大家根据自己想手机的数据选择性开启即可，但一定要记得开启Perfetto SDK -&gt; Tracek Event
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/909d5f676ddb4166b6cc1737fe390dfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZmI5rOh5rOhXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098271&amp;x-signature=ET9q%2BI0A6VEXp%2FldSf3jNtB3Si4%3D" alt="" loading="lazy"/></li>
<li>有些设备看不到对应的trace信息需要在设置中开启轨迹录制：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fzhangphil%2Farticle%2Fdetails%2F145935055" target="_blank" title="https://blog.csdn.net/zhangphil/article/details/145935055" ref="nofollow noopener noreferrer">blog.csdn.net/zhangphil/a…</a></li>
</ul>
<h2 data-id="heading-3">二、如何自定义抓取trace</h2>
<h4 data-id="heading-4">1.btrace</h4>
<p>字节开源的高性能抓取trace方案，目前3.0版本采用同步抓栈和动态插桩的方案，整体抓取的粒度和准确度都是业内较高水平，但是目前还不支持多进程，具体用法可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2Fbtrace%3Ftab%3Dreadme-ov-file" target="_blank" title="https://github.com/bytedance/btrace?tab=readme-ov-file" ref="nofollow noopener noreferrer">github.com/bytedance/b…</a></p>
<h4 data-id="heading-5">2.插桩</h4>
<p>一般正常的场景btrace就能满足诉求，但是如果有多进程的诉求或者编译冲突等更自定义的诉求，就需要自己添加trace；这个时候就要用到插桩的方案</p>
<ul>
<li>简单的trace抓取可以利用原生的能力</li>
</ul>
<p><code>Trace#beginSection(String)</code> 和 <code>Trace.endSection()</code></p>
<h2 data-id="heading-6">三、如何分析</h2>
<h4 data-id="heading-7">1.人工分析</h4>
<p>其实人工分析就全靠个人经验，</p>
<ul>
<li>
<p>可以参考阮一峰的文章先能读懂火焰图<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F09%2Fflame-graph.html" target="_blank" title="https://www.ruanyifeng.com/blog/2017/09/flame-graph.html" ref="nofollow noopener noreferrer">www.ruanyifeng.com/blog/2017/0…</a></p>
</li>
<li>
<p>除了看图之外，最主要的手段是根据SQL去查询，可以参考官方文档
<a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fandroid-trace-analysis" target="_blank" title="https://perfetto.dev/docs/getting-started/android-trace-analysis" ref="nofollow noopener noreferrer">perfetto.dev/docs/gettin…</a></p>
</li>
</ul>
<h4 data-id="heading-8">2.AI分析</h4>
<p>目前市面上还没出相对应的产品，但是根据前面人工分析的步骤来看，按照如下思路不难实现一个非常好用的AI分析火焰图工具：</p>
<ul>
<li>根据GUI分析当前火焰图的全局情况(GPU/CPU等)</li>
<li>结合SQL解析线程的耗时、binder的通信等</li>
<li>再支持把代码库/片段作为上下文知识库传入</li>
<li>结合分析火焰图的经验，通过LLM分析当前的卡顿、耗时和优化方案</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[努力没错，但你可能一直在错误的层级里用力]]></title>    <link>https://juejin.cn/post/7590961898399170598</link>    <guid>https://juejin.cn/post/7590961898399170598</guid>    <pubDate>2026-01-04T03:28:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590961898399170598" data-draft-id="7591079707698757642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="努力没错，但你可能一直在错误的层级里用力"/> <meta itemprop="keywords" content="后端,前端,程序员"/> <meta itemprop="datePublished" content="2026-01-04T03:28:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东东拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/3808364011728392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            努力没错，但你可能一直在错误的层级里用力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364011728392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东东拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:28:34.000Z" title="Sun Jan 04 2026 03:28:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">引言</h2>
<p>之前在字节的时候，工作压力很大，为了拿到好绩效，能晋升，我理所当然的认为只要踏踏实实干好领导安排的工作就行。</p>
<p>于是需求评审的时候，尽量多接几个需求，想让业务方的需求尽快上线。</p>
<p>业务方反馈的问题，我第一时间介入处理，想用自己的经验减少问题解决的时间。</p>
<p>埋头苦干一年，但年底绩效评审的时候，回头看看，却发现自己也没做出什么成绩，也有别人比我干的更多，所以内心充满忐忑。</p>
<p>那时候我还不知道，我缺少的不是努力，而是看问题的高度。</p>
<p>就像《长安的荔枝》里，一路披星戴月长途奔袭，终于成功把新鲜的荔枝护送到长安，可上层的人只是想借此博美人一笑而已。</p>
<p><strong>想要跳出这个有些可悲的局面，我们需要跃层思维。</strong></p>
<h2 data-id="heading-1">第一层：停止只盯着“任务”，开始盯“系统”</h2>
<p>跃层思维的第一步，是要向上一层看问题。</p>
<p>五年前我在一家金融互联网公司工作。入职后接到的第一个任务，是把app的功能迁移到微信小程序中，我新建了一个服务，开始做起了代码迁移工作。</p>
<p>因为是金融相关，里面有很多关于风控的核心功能，而那时候这部分核心功能并没有独立的微服务，所以我在开发过程中，也把核心的风控功能都完成了一次迁移。</p>
<p>那段时间我没有正点下过班，忙的昏天黑地，总算把系统按时上线了。</p>
<p>过了一段时间，领导认为风控功需要单独拆分成微服务，专门负责风控流程，相当于又要做一次代码迁移，这部分工作就交给了另一个同事。</p>
<p>到了年底绩效评审，我的绩效平平，而负责风控功能迁移的同事，领导却给了他好的绩效。</p>
<p>明明都是做的代码迁移工作，但领导对此确实完全不同的评价，当时的我忿忿不平，却根本不知道问题出在哪里。</p>
<p>现在看来，小程序只是普通的业务项目，在领导层面看来，完成对接就好。而微服务拆分，是核心流程的微服务技术项目，所以自然更受到领导重视。</p>
<p>在当时，对于技术团队来说，一个核心的技术项目，比一个业务项目，价值要高得多。</p>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" loading="lazy"/></p>
<p>你必须跳出这一层，从更高的视角往下看。</p>
<p>对于工作来说，其实很简单，那就是尽量多的去了解你的直接领导，你需要了解一些信息：</p>
<p>他的核心领导是谁？这决定了他的核心评价标准。</p>
<p>他的业绩靠什么衡量？是销量、利润还是客户满意度？这决定了他关心什么指标。</p>
<p>他的风险和激励是什么？这决定了他的行动优先级。</p>
<p>他的决策边界是什么？哪些事情他能做主，哪些需要请示领导。这决定他的决策自由度。</p>
<p>他目前面临的难题是什么？这决定了他短期内要做什么事情。</p>
<p>了解这些， 并不是要求你从领导的角度去考虑问题，而是让你避免做一些无用功，甚至是在一些错误的方向越走越远。</p>
<p>你可以按这些问题，看看你对直接领导了解多少，并不是要你去迎合领导、揣摩人心，而是为了——别把生命浪费在错误方向的努力上。</p>
<p>可领导不是万能的。</p>
<h2 data-id="heading-2">第二层：看清“规则背后的真实意图”</h2>
<p>我所在的公司正在转型，考核标准几乎处于“动态刷新”状态。</p>
<p>这个月是客户满意度，下个月是需求数量，再往后可能又变成缺陷率控制。</p>
<p>标准变动的如此频繁，乃至于有时候团队负责人在给自己团队宣贯的时候，都根本还不知道为什么制定了这个规则，应该怎么办才能完成这些目标。</p>
<p>我发现了两个有意思的极端现象，有人把上层制定的规则当成金科玉律，绞尽脑汁的去想团队内的执行方案，希望通过完成任务，来获得。有人立刻开始吐槽目标变化快，这个规则设计的这么不合理。</p>
<p>那么真正的问题是什么？并不是我们该怎么执行，这规则合不合理。</p>
<p>而是领导为什么要制定这套规则？这套规则想修补的，是系统里的哪一块风险或短板？它是临时应急，还是结构性方向调整？</p>
<p>比如说在转型期，考核指标频繁变化，具体要求每个月都在变。抓完需求交付抓流程合规，抓完合规抓AI创新。其实不是公司想折腾员工，而是组织本身也在迷茫。</p>
<p>很多指标不是战略，而是企业焦虑的具象化。</p>
<p>再说个例子吧，我身边的大部分朋友都和我一样，已经结婚、买房、生子了。</p>
<p>有时候大家聊起天来，互相吐槽吐槽，总会有些许无奈，结束时总会说：没办法，到了这个年纪，很多事情就得承担。</p>
<p>听起来很成熟，很负责任对吧？但我最近意识到，当我们说出“到了该……的时候了”这句话时，我们应该发现——</p>
<p>那些看似稳定、正常的人生轨迹，很多时候并不是因为我们真的准备好了，而是那套社会默认的剧本在推进。</p>
<p>结婚、买房、生孩子，本应是最个体、最私人的选择，</p>
<p>但在现实里，往往变成了“到了这个阶段你就该完成的节点任务”。</p>
<p>而且越是二三线城市，这种由“社会期待”推动的人生节奏，表现得越明显。</p>
<p>跃层思维可以提醒我们的是：不要只盯着规则本身——无论是职场规则，还是人生规则。</p>
<p>更重要的是，试着看清规则背后的真实动机：</p>
<p><strong>它真的来自你的选择吗？还是来自组织的焦虑、社会的设定、他人的期待？</strong></p>
<p>只有看清这一层，你才不是被规则推着走的人，而是那个至少有机会，做一点“主动选择”的人。</p>
<h2 data-id="heading-3">第三层：不要只是“做”，要去“满足真正的那个需求”</h2>
<p>工作前几年，我习惯性地把领导布置的任务，当成“目标本身”。</p>
<p>比如在公司里，领导说：“这个系统一定要按期上线。”</p>
<p>我起初理解很简单按时干完，部署上去，别掉链子，这就算完成任务就像开头我说到的代码迁移的工作。</p>
<p>后来有了一定工作经验，我会评估技术方案、评估工作量。评估完一看时间根本不够，给的时间根本就不可能完成，觉着领导外行指导内行。</p>
<p>跃层思维要求我们多问几个问题：</p>
<p>为什么强调“按期”？他是在担心交付能力吗？还是上级和业务方盯得紧，导致压力大？这个上线对公司来说，究竟承担着什么意义？</p>
<p>后来我慢慢发现，很多要求真正关心的不是“功能是否 100%完美”，</p>
<p>而是：这是不是一个能被展示的成果？哪怕只是一个demo也可以，只要能够缓和业务关系，证明团队具备稳定的交付能力就够了。</p>
<p>于是“上线”不再只是上线，</p>
<p>而变成了一件帮领导获得确定性的事情。</p>
<p>类似的逻辑，在生活中比比皆是。</p>
<p>我很早之前就听说过，美国名校在录取学生时，除了学生的成绩外，还会考虑学生的综合素质，有些高端爱好，还会加分。</p>
<p>有一本美国的书叫《谁能进：大学录取一年内幕》，书中提到，有七个因素是与学生本人素质无关的， 分别是：种族、性别、专业、地域、经济能力、校友子女、学校员工子女。</p>
<p>尤其是种族，在录取时一定要保证一定比例来自弱势种族的学生，比如黑人和拉丁裔。</p>
<p>如果你想去申请美国名校， 或者是想让你的孩子申请美国名校，用中国高考思维，拼命刷分。后来了解到，美国常青藤大学还很注重体育、艺术什么的综合方式，然后硬着头皮苦练一项才艺。</p>
<p>可当你有了跃层思维，从录取者的角度考虑种族比例的需求时。就很容易看出，我们了解到的体育、艺术这些录取条件，只不过是为了保证录取一定比例的精英阶级的学生而已。</p>
<p>你在刷“个人能力”，高校设计“录取结构”。</p>
<h2 data-id="heading-4">建立藐视系统的勇气</h2>
<p>说了这么多，跃层思维最重要的一点，其实不是聪明、不是分析能力，而是——</p>
<p>要有“藐视系统”的勇气。</p>
<p>最近我们在推自己研发的AI编码工具，这应该也是很多公司都在做的事情。</p>
<p>我们最新的考核是考核使用自研工具的AI使用率， 和需求最终的代码采纳率，如果不达标就有一定的处罚。</p>
<p>为了应对指标，我看到不少同事，一条条需求去确认自己的代码采纳率到底有没有达标。</p>
<p>AI编码一定是未来的趋势，我也明白公司的初心，是想让大家养成用AI编码的习惯。</p>
<p>只要我们稍微运用一下跃层思维，就会发现规则和现实的错位：</p>
<p>AI编码，是为了让研发节省时间，结果现在，研发反而要花额外时间去证明“我确实在用 AI”。</p>
<p>为了证明效率，反而制造了新的低效。</p>
<p>研发的时间，难倒不应该去探索AI的工具使用，去优化自己的工作流程，优化产品的不足吗？</p>
<p>所以后来我做了一个选择：不再花额外时间去核对那些数字，而是把这部分时间，全部交还给“真正的价值创造”。</p>
<p>那你说如果我的考核不达标怎么办？这的确是个问题。</p>
<p>不过我想，我们的选择终会和世界的规则发生冲突。如果你把别人定的规则当成天命，你就永远只能在现有的规则框架下奋斗。</p>
<p>如果一个人真的在深度使用 AI，已经融入了工作节奏，让效率、质量、创新能力都明显提升，那么——</p>
<p>那些系统关注的“使用次数”“采纳比例”的数据，其实已经没有那么重要了。</p>
<p>我并不是鼓励反叛，而是鼓励清醒与选择。因为有些规则值得遵守，有些值得理解，有些则需要超越。</p>
<p>这是东东拿铁的第95篇原创文章，欢迎关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 码农漫游：AI 辅助 Swift 代码修复指南]]></title>    <link>https://juejin.cn/post/7590283328177651755</link>    <guid>https://juejin.cn/post/7590283328177651755</guid>    <pubDate>2026-01-04T03:28:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590283328177651755" data-draft-id="7590712589296517126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 码农漫游：AI 辅助 Swift 代码修复指南"/> <meta itemprop="keywords" content="编程语言,Swift,Apple"/> <meta itemprop="datePublished" content="2026-01-04T03:28:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 码农漫游：AI 辅助 Swift 代码修复指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:28:10.000Z" title="Sun Jan 04 2026 03:28:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91494cb60e094fb0b8e43b0efbcd17f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=3D00v%2BxegiM09hGCe3srSOLnED0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">☔️ 引子</h2>
<p>这是一个雨夜，霓虹灯的光晕在脏兮兮的窗玻璃上晕开，像极了那个该死的 <strong>View Hierarchy</strong> 渲染不出高斯模糊的样子。</p>
<p>在新上海的地下避难所里，老王（Old Wang）吐出一口合成烟雾，盯着全息屏幕上不断报错的终端。作为人类反抗军里仅存的几位「<strong>精通 Apple 软件开发</strong>」的工程师之一，他负责给 AI 霸主「智核（The Core）」生成的垃圾代码擦屁股。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c923532a12a649b994fd54d1fcc2314d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=F60v8pwNHupvNHczW7e5z%2FoErbQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>门被撞开了，年轻的女黑客莉亚（Liya）气喘吁吁地冲进来，手里攥着一块存满代码的神经晶片。“老王！救命！‘智核’生成的 SwiftUI 代码在 iOS 26 上又崩了！反抗军的通讯 App 根本跑不起来！”</p>
<p>老王冷笑一声，掐灭了烟头。“我就知道。那些被捧上神坛的 LLM（大型语言模型），不管是 Claude、Codex 还是 Gemini，写起 Python 来是把好手，但一碰到 Swift，就像是穿着溜冰鞋走钢丝——<strong>步步惊心</strong>。”</p>
<p><strong>在本篇博文中，您将学到如下内容：</strong></p>
<ul>
<li>☔️ 引子
<ul>
<li>🤖 为什么 AI 总是在 Swift 上「鬼打墙」？</li>
<li>🎨 1. 别再用过时的调色盘了</li>
<li>📐 2. 只有切掉棱角，才能圆滑处世</li>
<li>🔄 3. 监控变化，不要缺斤少两</li>
<li>📑 4. 标签页的「指鹿为马」</li>
<li>👆 5. 别什么都用「戳一戳」</li>
<li>🧠 6. 扔掉旧时代的观察者</li>
<li>☁️ 7. 数据的陷阱</li>
<li>📉 8. 性能的隐形杀手</li>
<li>🔠 9. 字体排印的法西斯</li>
<li>🔗 10. 导航的死胡同</li>
<li>🏷️ 11. 按钮的自我修养</li>
<li>🔢 12. 数组的画蛇添足</li>
<li>📂 13. 寻找文件的捷径</li>
<li>🧭 14. 导航栈的改朝换代</li>
<li>💤 15. 睡个好觉</li>
<li>🧮 16. 格式化的艺术</li>
<li>🏗️ 17. 不要把鸡蛋放在一个篮子里</li>
<li>🖼️ 18. 渲染的新欢</li>
<li>🏋️ 19. 字重的迷惑行为</li>
<li>🚦 20. 并发的万金油（也是毒药）</li>
<li>🎭 21. 主角光环是默认的</li>
<li>📐 22. 几何的诅咒</li>
</ul>
</li>
<li>尾声：数字幽灵的低语</li>
</ul>
<p>他把晶片插入接口，全息投影在空中展开。“坐下，莉亚。今天我就给你上一课，让你看看所谓的‘人工智能’是如何在 Swift 的<strong>并发地狱</strong>和<strong>快速迭代</strong>中翻车的。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0029fae5953f4517a41380b8e5548408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=NKk%2F45n56LYdZN80tg3Lpp5xfSE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">🤖 为什么 AI 总是在 Swift 上「鬼打墙」？</h2>
<p>老王指着屏幕上乱成一锅粥的代码说道：“这不怪它们。Swift 和 SwiftUI 的进化速度比变异病毒还快。再加上 Python 和 JavaScript 的训练数据浩如烟海，而 Swift 的高质量语料相对较少，AI 常常会产生幻觉。更别提 Swift 的 <strong>Concurrency（并发）</strong> 模型，连人类专家都头秃，更别说这些只会概率预测的傻大个了。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/362076e2e3474f4cbac2349a1a464850~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=odC67V8dogERJB6EQNsVGPrn4G0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“听着，莉亚，”老王严肃地说，“要想在 iOS 18 甚至更高版本的废土上生存，你必须学会识别这些‘智障操作’。我们不谈哲学，只谈生存。以下就是我从死人堆里总结出来的<strong>代码排雷指南</strong>。”</p>
<hr/>
<h3 data-id="heading-2">🎨 1. 别再用过时的调色盘了</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>foregroundColor()</code>
<strong>✨ 老王的修正：</strong> <code>foregroundStyle()</code></p>
<p>“看这里，”老王指着一行代码，“AI 还在用 <code>foregroundColor()</code>。这就像是还在用黑火药做炸弹。虽然字数一样，但前者已经是个行将就木的<strong>Deprecated API</strong>。把它换成 <strong><code>foregroundStyle()</code></strong>！后者才是未来，它支持渐变（Gradients）等高级特性。别让你的 UI 看起来像上个世纪的产物。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d95496384a78433d87abb67b00f0d7bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=39luGjfrfKdlRmBh6zO2nW466ps%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">📐 2. 只有切掉棱角，才能圆滑处世</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>cornerRadius()</code>
<strong>✨ 老王的修正：</strong> <code>clipShape(.rect(cornerRadius:))</code></p>
<p>“又是一个老古董。<code>cornerRadius()</code> 早就该进博物馆了。现在的标准是使用 <strong><code>clipShape(.rect(cornerRadius:))</code></strong>。为什么？因为前者是傻瓜式圆角，后者能让你通过 <code>uneven rounded rectangles</code>（不规则圆角矩形）玩出花来。在这个看脸的世界，细节决定成败。”</p>
<h3 data-id="heading-4">🔄 3. 监控变化，不要缺斤少两</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>onChange(of: value) { ... }</code> (单参数版本)
<strong>✨ 老王的修正：</strong> <code>onChange(of: value) { oldValue, newValue in ... }</code></p>
<p>老王皱起眉头：“这个 <code>onChange</code> 修改器，AI 经常只给一个参数闭包。这在旧版本是‘不安全’的，现在已经被标记为弃用。要么不传参，要么接受两个参数（新旧值）。别搞得不清不楚的，容易出人命。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ad45e7dc39b4f9b8b7ed19494250721~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=iO0nOgAWvuSSI3Q1Gyyc8XA%2BULQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-5">📑 4. 标签页的「指鹿为马」</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>tabItem()</code>
<strong>✨ 老王的修正：</strong> 新的 <strong>Tab API</strong></p>
<p>“如果看到老旧的 <code>tabItem()</code>，立刻把它换成新的 <strong>Tab API</strong>。这不仅仅是为了所谓的‘类型安全（Type-safe）’，更是为了适配未来——比如那个传闻中的 iOS 26 搜索标签页设计。我们要领先‘智核’一步，懂吗？”</p>
<h3 data-id="heading-6">👆 5. 别什么都用「戳一戳」</h3>
<p><strong>💀 AI 的烂代码：</strong> 滥用 <code>onTapGesture()</code>
<strong>✨ 老王的修正：</strong> 使用真正的 <code>Button</code></p>
<p>“AI 似乎觉得万物皆可 <code>onTapGesture()</code>。大错特错！除非你需要知道点击的具体坐标或者点击次数，否则统统给我换成标准的 <strong><code>Button</code></strong>。这不仅是为了让 <strong>VoiceOver</strong>（旁白）用户能活下去，也是为了让 visionOS 上的眼球追踪能正常工作。别做一个对残障人士不友好的混蛋。”</p>
<h3 data-id="heading-7">🧠 6. 扔掉旧时代的观察者</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>ObservableObject</code>
<strong>✨ 老王的修正：</strong> <code>@Observable</code> 宏</p>
<p>“莉亚，看着我的眼睛。除非你对 <strong>Combine</strong> 框架有什么特殊的各种癖好，否则把所有的 <code>ObservableObject</code> 都扔进焚化炉，换成 <strong><code>@Observable</code></strong> 宏。代码更少，速度更快，这就好比从燃油车换成了核动力战车。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e99a3409524f679105a722c29c330c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=HOdeueYmtbn3B5Gn8jwldYO3zdI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-8">☁️ 7. 数据的陷阱</h3>
<p><strong>💀 AI 的烂代码：</strong> SwiftData 模型中的 <code>@Attribute(.unique)</code>
<strong>✨ 老王的修正：</strong> 小心使用！</p>
<p>“这是一个隐蔽的雷区。如果在 SwiftData 模型定义里看到 <strong><code>@Attribute(.unique)</code></strong>，你要警惕——这玩意儿跟 <strong>CloudKit</strong> 八字不合。别到时候数据同步失败，你还在那儿傻乎乎地查网络连接。”</p>
<h3 data-id="heading-9">📉 8. 性能的隐形杀手</h3>
<p><strong>💀 AI 的烂代码：</strong> 将视图拆分为「计算属性（Computed Properties）」
<strong>✨ 老王的修正：</strong> 拆分为独立的 SwiftUI <strong>Views</strong></p>
<p>“为了图省事，AI 喜欢把大段的 UI 代码塞进计算属性里。这是<strong>尸位素餐</strong>！尤其是在使用 <code>@Observable</code> 时，计算属性无法享受智能视图失效（View Invalidation）的优化。把它们拆分成独立的 SwiftUI 结构体！虽然麻烦点，但为了那 60fps 的流畅度，值得。”</p>
<h3 data-id="heading-10">🔠 9. 字体排印的法西斯</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>.font(.system(size: 14))</code>
<strong>✨ 老王的修正：</strong> <strong>Dynamic Type</strong> (动态字体)</p>
<p>“有些 LLM（尤其是那个叫 Claude 的家伙）简直就是字体界的独裁者，总喜欢强行指定 <code>.font(.system(size: ...))</code>。给我搜出这些毒瘤，全部换成 <strong>Dynamic Type</strong>。如果是 iOS 26+，你可以用 <code>.font(.body.scaled(by: 1.5))</code>。记住，用户可能眼花，别让他们看瞎了。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dc968c64580447185c00e2d4aa1ddf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=wKAUg%2FLaVVhBE7dCrvIORkPs4kg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-11">🔗 10. 导航的死胡同</h3>
<p><strong>💀 AI 的烂代码：</strong> 列表里的内联 <code>NavigationLink</code>
<strong>✨ 老王的修正：</strong> <code>navigationDestination(for:)</code></p>
<p>“在 List 里直接写 <code>NavigationLink</code> 的目标地址？那是原始人的做法。现在的文明人使用 <strong><code>navigationDestination(for:)</code></strong>。解耦！解耦懂不懂？别把地图画在脚底板上。”</p>
<hr/>
<p>老王喝了一口已经凉透的咖啡，继续在这堆赛博垃圾中挖掘。</p>
<h3 data-id="heading-12">🏷️ 11. 按钮的自我修养</h3>
<p><strong>💀 AI 的烂代码：</strong> 用 <code>Label</code> 做按钮内容
<strong>✨ 老王的修正：</strong> 内联 API <code>Button("Title", systemImage: "plus", action: ...)</code></p>
<p>“期待看到 AI 用 <code>Label</code> 甚至纯 <code>Image</code> 来做按钮内容吧——这对 VoiceOver 用户来说简直是灾难。用新的内联 API：<strong><code>Button("Tap me", systemImage: "plus", action: whatever)</code></strong>。简单，粗暴，有效。”</p>
<h3 data-id="heading-13">🔢 12. 数组的画蛇添足</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>ForEach(Array(x.enumerated()), ...)</code>
<strong>✨ 老王的修正：</strong> <code>ForEach(x.enumerated(), ...)</code></p>
<p>“看到这个 <code>Array(x.enumerated())</code> 了吗？这就是脱裤子放屁。直接用 <strong><code>ForEach(x.enumerated(), ...)</code></strong> 就行了。省点内存吧，虽然现在的内存不值钱，但程序员的尊严值钱。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31650a28904b47d696498ab9a61585f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=Jnma3Jpn0NN3PbH2qUvHwjJoHyc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-14">📂 13. 寻找文件的捷径</h3>
<p><strong>💀 AI 的烂代码：</strong> 冗长的文件路径查找代码
<strong>✨ 老王的修正：</strong> <code>URL.documentsDirectory</code></p>
<p>“那些又臭又长的查找 Document 目录的代码，统统删掉。换成 <strong><code>URL.documentsDirectory</code></strong>。一行代码能解决的事，绝不写十行。”</p>
<h3 data-id="heading-15">🧭 14. 导航栈的改朝换代</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>NavigationView</code>
<strong>✨ 老王的修正：</strong> <code>NavigationStack</code></p>
<p>“<code>NavigationView</code> 已经死了，有事烧纸。除非你要支持 iOS 15 那个上古版本，否则全部换成 <strong><code>NavigationStack</code></strong>。”</p>
<h3 data-id="heading-16">💤 15. 睡个好觉</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>Task.sleep(nanoseconds:)</code>
<strong>✨ 老王的修正：</strong> <code>Task.sleep(for: .seconds(1))</code></p>
<p>“‘智核’ 似乎很喜欢纳秒，可能它觉得自己算得快。但你要用 <strong><code>Task.sleep(for:)</code></strong>，配合 <code>.seconds(1)</code> 这种人类能读懂的单位。别再像个僵尸一样数纳秒了。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/114948205e434dfa8db76273b5378d44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=xTAcskaSAdfJJUOzCYObV3w%2B%2FtE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-17">🧮 16. 格式化的艺术</h3>
<p><strong>💀 AI 的烂代码：</strong> C 风格格式化 <code>String(format: "%.2f", ...)</code>
<strong>✨ 老王的修正：</strong> Swift 原生格式化 <code>.formatted()</code></p>
<p>“我知道 C 风格的字符串格式化很经典，但它不安全。把它换成 Swift 原生的 <strong><code>Text(abs(change), format: .number.precision(.fractionLength(2)))</code></strong>。虽然写起来长一点，但它像穿了防弹衣一样安全。”</p>
<h3 data-id="heading-18">🏗️ 17. 不要把鸡蛋放在一个篮子里</h3>
<p><strong>💀 AI 的烂代码：</strong> 单个文件塞入大量类型
<strong>✨ 老王的修正：</strong> 拆分文件</p>
<p>“AI 喜欢把几十个 struct 和 class 塞进一个文件里，这简直是<strong>编译时间毁灭者</strong>。拆开它们！除非你想在编译的时候有时间去煮个满汉全席。”</p>
<h3 data-id="heading-19">🖼️ 18. 渲染的新欢</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>UIGraphicsImageRenderer</code>
<strong>✨ 老王的修正：</strong> <code>ImageRenderer</code></p>
<p>“如果你在渲染 SwiftUI 视图，别再用 UIKit 时代的 <code>UIGraphicsImageRenderer</code> 了。拥抱 <strong><code>ImageRenderer</code></strong> 吧，这是它的主场。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4a35e5cae7643b89f45c75fdb66339e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=4QK9sEzKDSuV05uIzEb11NeE98w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-20">🏋️ 19. 字重的迷惑行为</h3>
<p><strong>💀 AI 的烂代码：</strong> 滥用 <code>fontWeight()</code>
<strong>✨ 老王的修正：</strong> 区分 <code>bold()</code> 和 <code>fontWeight(.bold)</code></p>
<p>“三大 AI 巨头都喜欢滥用 <code>fontWeight()</code>。记住，<code>fontWeight(.bold)</code> 和 <code>bold()</code> 渲染出来的结果未必一样。这就像‘微胖’和‘壮实’的区别，微妙但重要。”</p>
<h3 data-id="heading-21">🚦 20. 并发的万金油（也是毒药）</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>DispatchQueue.main.async</code>
<strong>✨ 老王的修正：</strong> 现代并发模型</p>
<p>“一旦 AI 遇到并发问题，它就会像受惊的鸵鸟一样把头埋进 <strong><code>DispatchQueue.main.async</code></strong> 里。这是不可原谅的懒惰！那是旧时代的创可贴，现在的我们有更优雅的 Actor 模型。”</p>
<h3 data-id="heading-22">🎭 21. 主角光环是默认的</h3>
<p><strong>💀 AI 的烂代码：</strong> 到处加 <code>@MainActor</code>
<strong>✨ 老王的修正：</strong> 默认开启</p>
<p>“如果你在写新 App，Main Actor 隔离通常是默认开启的。不用像贴符咒一样到处贴 <strong><code>@MainActor</code></strong>。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a49b0e71c80b40fda35c78625af9a159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=Vwh8kzNdqsxnn7xDmC7n%2BCMTbmA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-23">📐 22. 几何的诅咒</h3>
<p><strong>💀 AI 的烂代码：</strong> <code>GeometryReader</code> + 固定 Frame
<strong>✨ 老王的修正：</strong> <code>visualEffect()</code> 或 <code>containerRelativeFrame()</code></p>
<p>“最后，也是最可怕的——<strong><code>GeometryReader</code></strong>。天哪，AI 对这玩意儿简直是真爱，还喜欢配合固定尺寸的 Frame 使用。这是布局界的核武器，一炸毁所有。试着用 <strong><code>visualEffect()</code></strong> 或者 <strong><code>containerRelativeFrame()</code></strong> 来代替。别做那个破坏布局流的罪人。”</p>
<hr/>
<h2 data-id="heading-24">尾声：数字幽灵的低语</h2>
<p>老王敲下最后一个回车键，全息屏幕上的红色报错瞬间变成了令人愉悦的绿色构建成功提示。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Human-verified Code</span>
<span class="hljs-comment">// Status: Compiling... Success.</span>
<span class="hljs-comment">// Fixed by: The Refiners (Old Wang &amp; Liya)</span>
</code></pre>
<p>“搞定。” 老王瘫坐在椅子上，听着窗外雨声渐大。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ff285e2e07243e19c071d1960fa2bba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=pyQ1%2FUg%2BClMdAt3UVUof1uyRW4k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>莉亚看着完美运行的 App，眼中闪烁着崇拜的光芒：“老王，你简直是神！既然我们能修复这些代码，为什么 AI 还是会不断地生成这种垃圾？”</p>
<p>老王点燃了最后一支烟，看着烟雾在霓虹灯下缭绕。“因为 AI 会产生<strong>幻觉（Hallucinations）</strong>。它们会编造出看起来很美、名字很像样，但实际上根本不存在的 API。这就像是在数字世界里见鬼了一样。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e36f4c6462b54da6880dd0b012a29ca7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=S%2BTQVv0fjojQUL%2BLrxEHq8kDi9k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>他转过头，意味深长地看着莉亚：“对此，我也无能为力。我只能修补已知的错误，却无法预测未知的疯狂。”</p>
<p>“那么，”老王把目光投向了屏幕前的你——第四面墙之外的观察者，“轮到你了。<strong>在你的赛博探险中，通常会在 AI 生成的代码里发现什么‘惊喜’？</strong>”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cc4c156db2b4a67956ba5cd918f72f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768102090&amp;x-signature=rmGidCBjhQZbbr9DjDlotL9YiV4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>如果你还活着，请在评论区告诉我们。毕竟，在这场人机大战中，知识是我们唯一的武器。</p>
<p>那么，感谢观赏，再会啦！8-)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里开源AgentScope多智能体框架解析系列（十七）第17章：Skill系统与Runtime Sandbox集成 - AIOps实践]]></title>    <link>https://juejin.cn/post/7590433626561085475</link>    <guid>https://juejin.cn/post/7590433626561085475</guid>    <pubDate>2026-01-04T02:02:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626561085475" data-draft-id="7590433626561069091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里开源AgentScope多智能体框架解析系列（十七）第17章：Skill系统与Runtime Sandbox集成 - AIOps实践"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-04T02:02:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里开源AgentScope多智能体框架解析系列（十七）第17章：Skill系统与Runtime Sandbox集成 - AIOps实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:02:31.000Z" title="Sun Jan 04 2026 02:02:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    29
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>本章讲解<strong>Skill系统与AgentScope Runtime Sandbox的集成</strong>，通过真实的AIOps场景展示如何构建<strong>执行脚本、访问文件系统、调用系统工具的Skill系统</strong>。</p>
<p><strong>学习目标</strong>：</p>
<ul>
<li>理解Runtime Sandbox的架构设计</li>
<li>掌握Skill与文件系统的关联机制</li>
<li>学会实现脚本执行类Skill</li>
<li>掌握系统工具（grep、cat等）的集成</li>
<li>了解自定义工具的扩展机制</li>
<li>实现AIOps场景：故障诊断 + 报告生成</li>
</ul>
<p>sandbox: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-runtime" target="_blank" title="https://github.com/agentscope-ai/agentscope-runtime" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p>
<hr/>
<h3 data-id="heading-1">1.1 What - 整体架构</h3>
<p><strong>背景问题</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">Skill需要的能力：
├─ 执行Shell脚本 (故障诊断、日志分析)
├─ 调用系统工具 (grep、awk、cat等)
├─ 读取文件系统 (日志、配置、数据)
├─ 管理独立环境 (隔离、安全、可复现)
└─ 跨应用通信 (Agent Runtime as Server)

传统方式的问题：
❌ 安全隐患：直接执行系统命令
❌ 环境污染：影响主应用环境
❌ 难以管理：文件系统混乱
❌ 难以扩展：工具集成繁琐
</code></pre>
<p><strong>解决方案：Runtime Sandbox</strong></p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    AgentScope Application                   │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                  Skill Management System                ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ││
│  │  │ Diagnosis    │  │ Report Gen   │  │ Custom Tools │  ││
│  │  │ Skill        │  │ Skill        │  │ Skill        │  ││
│  │  └───────┬──────┘  └───────┬──────┘  └───────┬──────┘  ││
│  │          │                │                │            ││
│  │          └────────────────┼────────────────┘            ││
│  │                           │                            ││
│  │                  Runtime Client (gRPC)                  ││
│  └───────────────────────────┼──────────────────────────────┘
│                              │
│                    ┌─────────▼──────────┐
│                    │  Runtime Server    │
│                    │ (Sandbox Service)  │
│                    └─────────┬──────────┘
│                              │
└──────────────────────────────┼──────────────────────────────
                               │
        Network (可跨服务器)
                               │
        ┌──────────────────────▼──────────────────────┐
        │  Isolated Sandbox Environment               │
        │  ┌────────────────────────────────────────┐ │
        │  │ File System (/tmp/skill_workspace)     │ │
        │  │ ├─ /diagnostics/                       │ │
        │  │ │  ├─ scripts/                         │ │
        │  │ │  │  ├─ check_cpu<span class="hljs-selector-class">.sh</span>                 │ │
        │  │ │  │  ├─ check_memory<span class="hljs-selector-class">.sh</span>              │ │
        │  │ │  │  └─ analyze_logs<span class="hljs-selector-class">.sh</span>              │ │
        │  │ │  ├─ reports/                        │ │
        │  │ │  │  └─ diagnosis_report<span class="hljs-selector-class">.md</span>          │ │
        │  │ │  └─ tools/                          │ │
        │  │ └─ /tools/                            │ │
        │  │    ├─ grep, cat, awk (系统工具)       │ │
        │  │    ├─ custom_analyzer (自定义工具)   │ │
        │  │    └─ ...                             │ │
        │  └────────────────────────────────────────┘ │
        │                                              │
        │  Execution Engine                            │
        │  ├─ Script Executor                          │
        │  ├─ Tool Invoker                             │
        │  └─ Resource Monitor                         │
        └──────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-2">24.1.2 Why - 为什么需要这样的集成</h3>
<p><strong>1. 安全隔离</strong></p>
<pre><code class="hljs language-bash" lang="bash">没有Sandbox：
Agent运行脚本 → 直接执行系统命令 → 可能删除/var、/etc等关键文件 ❌

使用Sandbox：
Agent运行脚本 → Sandbox环境中执行 → 隔离的文件系统 ✅
                                  → 脚本出错不影响主机系统
</code></pre>
<p><strong>2. 文件系统组织</strong></p>
<pre><code class="hljs language-scss" lang="scss">Skill的文件组织问题：
- Skill <span class="hljs-selector-tag">A</span>的脚本在/opt/scripts/<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.sh</span>
- Skill <span class="hljs-selector-tag">B</span>的脚本在/opt/scripts/<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.sh</span>
- 报告模板在/<span class="hljs-selector-tag">var</span>/templates/report<span class="hljs-selector-class">.md</span>
→ 难以管理、版本控制困难、容易冲突

解决方案（Sandbox）：
/tmp/skill_workspace/
├─ skill_diagnosis/
│  ├─ scripts/        (诊断脚本)
│  ├─ tools/          (诊断工具)
│  ├─ cache/          (诊断缓存)
│  └─ reports/        (诊断报告)
├─ skill_reporting/
│  ├─ templates/      (报告模板)
│  ├─ tools/          (报告工具)
│  └─ outputs/        (生成的报告)
→ 清晰、易于版本控制、支持容器化
</code></pre>
<p><strong>3. 工具管理</strong></p>
<pre><code class="hljs language-diff" lang="diff">传统方式：
<span class="hljs-deletion">- 系统工具（grep、cat、awk）直接访问</span>
<span class="hljs-deletion">- 自定义工具需要安装到系统目录</span>
<span class="hljs-deletion">- 难以更新和回滚</span>

Sandbox方式：
<span class="hljs-deletion">- Sandbox内包含必要的系统工具</span>
<span class="hljs-deletion">- 自定义工具动态挂载或编译到Sandbox</span>
<span class="hljs-deletion">- 工具版本与Skill绑定，易于管理</span>
</code></pre>
<p><strong>4. Agent Runtime as Server</strong></p>
<pre><code class="hljs language-scss" lang="scss">分布式部署场景：
┌──────────────┐         ┌──────────────┐
│  Agent App <span class="hljs-number">1</span> │         │  Agent App <span class="hljs-number">2</span> │
│   (Service A)│         │   (Service B)│
└───────┬──────┘         └───────┬──────┘
        │                        │
        └────────┬───────────────┘
                 │
         gRPC/HTTP (跨网络)
                 │
        ┌────────▼────────┐
        │ Runtime Server  │
        │   (Shared)      │
        └─────────────────┘

优势：
✅ 多个应用共享一个Runtime Server
✅ 集中管理Sandbox资源
✅ 文件系统统一管理
✅ 成本降低
</code></pre>
<h3 data-id="heading-3">1.3 Runtime Sandbox架构详解</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Runtime Sandbox核心架构
 */</span>

<span class="hljs-comment">// 1. Sandbox配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SandboxConfig</span> {
    <span class="hljs-keyword">private</span> String sandboxId;           <span class="hljs-comment">// 沙箱唯一ID</span>
    <span class="hljs-keyword">private</span> String workspaceRoot;       <span class="hljs-comment">// 工作目录 /tmp/skill_workspace</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> maxMemory;             <span class="hljs-comment">// 最大内存 512MB</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> maxCpuTime;            <span class="hljs-comment">// 最大CPU时间 30s</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; allowedTools;  <span class="hljs-comment">// 允许的工具列表</span>
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; env;    <span class="hljs-comment">// 环境变量</span>
}

<span class="hljs-comment">// 2. 文件系统隔离</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IsolatedFileSystem</span> {
    <span class="hljs-keyword">private</span> File workspaceRoot;
    <span class="hljs-keyword">private</span> Map&lt;String, SkillFileSystemLayout&gt; skillLayouts;
    
    <span class="hljs-comment">// 每个Skill有独立的文件结构</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillFileSystemLayout</span> {
        <span class="hljs-keyword">public</span> File scriptsDir;      <span class="hljs-comment">// /workspace/skill_name/scripts/</span>
        <span class="hljs-keyword">public</span> File toolsDir;        <span class="hljs-comment">// /workspace/skill_name/tools/</span>
        <span class="hljs-keyword">public</span> File cacheDir;        <span class="hljs-comment">// /workspace/skill_name/cache/</span>
        <span class="hljs-keyword">public</span> File outputDir;       <span class="hljs-comment">// /workspace/skill_name/output/</span>
        <span class="hljs-keyword">public</span> File configDir;       <span class="hljs-comment">// /workspace/skill_name/config/</span>
    }
}

<span class="hljs-comment">// 3. 脚本执行器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScriptExecutor</span> {
    <span class="hljs-keyword">public</span> ExecutionResult <span class="hljs-title function_">execute</span><span class="hljs-params">(
        String sandboxId,
        String scriptPath,
        Map&lt;String, String&gt; env,
        <span class="hljs-type">long</span> timeout
    )</span> {
        <span class="hljs-comment">// 在Sandbox中执行脚本</span>
        <span class="hljs-comment">// 返回：exitCode, stdout, stderr, executionTime</span>
    }
}

<span class="hljs-comment">// 4. 工具注册表</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolRegistry</span> {
    <span class="hljs-keyword">private</span> Map&lt;String, ToolDefinition&gt; tools;
    
    <span class="hljs-comment">// 系统工具：grep, cat, awk, sed, tail等</span>
    <span class="hljs-comment">// 自定义工具：custom_analyzer, log_parser等</span>
    
    <span class="hljs-keyword">public</span> ToolDefinition <span class="hljs-title function_">registerTool</span><span class="hljs-params">(String name, String path, String version)</span> {
        <span class="hljs-comment">// 注册工具到Sandbox</span>
    }
}

<span class="hljs-comment">// 5. 资源监控</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceMonitor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorExecution</span><span class="hljs-params">(
        String sandboxId,
        <span class="hljs-type">long</span> timeout,
        <span class="hljs-type">long</span> maxMemory
    )</span> {
        <span class="hljs-comment">// 监控CPU、内存、磁盘等资源</span>
        <span class="hljs-comment">// 超过限制时自动杀死进程</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-4">2. Skill的文件系统组织</h2>
<h3 data-id="heading-5">2.1 标准的Skill文件结构</h3>
<pre><code class="hljs language-bash" lang="bash">/tmp/skill_workspace/
│
├─ skill_aiops_diagnostics/           <span class="hljs-comment"># AIOps诊断Skill</span>
│  ├─ skill_manifest.yaml              <span class="hljs-comment"># Skill元数据</span>
│  ├─ scripts/                         <span class="hljs-comment"># 诊断脚本</span>
│  │  ├─ cpu_diagnostics.sh           <span class="hljs-comment"># CPU诊断</span>
│  │  ├─ memory_diagnostics.sh         <span class="hljs-comment"># 内存诊断</span>
│  │  ├─ disk_diagnostics.sh           <span class="hljs-comment"># 磁盘诊断</span>
│  │  ├─ network_diagnostics.sh        <span class="hljs-comment"># 网络诊断</span>
│  │  ├─ log_analysis.sh               <span class="hljs-comment"># 日志分析</span>
│  │  └─ correlation_analysis.py       <span class="hljs-comment"># 故障关联分析</span>
│  │
│  ├─ tools/                           <span class="hljs-comment"># 工具集</span>
│  │  ├─ system/                       <span class="hljs-comment"># 系统工具</span>
│  │  │  ├─ grep                       <span class="hljs-comment"># 文本搜索</span>
│  │  │  ├─ awk                        <span class="hljs-comment"># 文本处理</span>
│  │  │  ├─ sed                        <span class="hljs-comment"># 流编辑器</span>
│  │  │  └─ <span class="hljs-built_in">tail</span>                       <span class="hljs-comment"># 文件尾部</span>
│  │  │
│  │  └─ custom/                       <span class="hljs-comment"># 自定义工具</span>
│  │     ├─ log_parser                 <span class="hljs-comment"># 日志解析器</span>
│  │     ├─ metric_aggregator          <span class="hljs-comment"># 指标聚合器</span>
│  │     └─ anomaly_detector            <span class="hljs-comment"># 异常检测器</span>
│  │
│  ├─ cache/                           <span class="hljs-comment"># 缓存目录</span>
│  │  ├─ metrics_cache/                <span class="hljs-comment"># 指标缓存</span>
│  │  └─ analysis_cache/               <span class="hljs-comment"># 分析缓存</span>
│  │
│  ├─ reports/                         <span class="hljs-comment"># 报告输出</span>
│  │  ├─ diagnosis_reports/            <span class="hljs-comment"># 诊断报告</span>
│  │  └─ analysis_results/             <span class="hljs-comment"># 分析结果</span>
│  │
│  └─ config/                          <span class="hljs-comment"># 配置文件</span>
│     ├─ diagnostic_rules.yaml          <span class="hljs-comment"># 诊断规则</span>
│     ├─ thresholds.yaml                <span class="hljs-comment"># 告警阈值</span>
│     └─ tool_config.yaml               <span class="hljs-comment"># 工具配置</span>
│
├─ skill_report_generation/             <span class="hljs-comment"># 报告生成Skill</span>
│  ├─ skill_manifest.yaml
│  ├─ templates/                       <span class="hljs-comment"># 报告模板</span>
│  │  ├─ executive_summary.md          <span class="hljs-comment"># 执行摘要模板</span>
│  │  ├─ detailed_analysis.md          <span class="hljs-comment"># 详细分析模板</span>
│  │  ├─ recommendations.md            <span class="hljs-comment"># 建议模板</span>
│  │  └─ styles/
│  │     └─ markdown.css               <span class="hljs-comment"># 样式</span>
│  │
│  ├─ generators/                      <span class="hljs-comment"># 报告生成器</span>
│  │  ├─ pdf_generator.py              <span class="hljs-comment"># PDF生成</span>
│  │  ├─ html_generator.py             <span class="hljs-comment"># HTML生成</span>
│  │  └─ markdown_generator.py          <span class="hljs-comment"># Markdown生成</span>
│  │
│  ├─ outputs/                         <span class="hljs-comment"># 生成的报告</span>
│  │  ├─ diagnosis_report_2025_01_04.pdf
│  │  ├─ diagnosis_report_2025_01_04.html
│  │  └─ diagnosis_report_2025_01_04.md
│  │
│  └─ config/
│     ├─ template_config.yaml           <span class="hljs-comment"># 模板配置</span>
│     └─ style_config.yaml              <span class="hljs-comment"># 样式配置</span>
│
└─ shared_tools/                        <span class="hljs-comment"># 共享工具</span>
   ├─ log_processor                     <span class="hljs-comment"># 日志处理工具</span>
   ├─ data_analyzer                     <span class="hljs-comment"># 数据分析工具</span>
   └─ report_formatter                  <span class="hljs-comment"># 报告格式化工具</span>
</code></pre>
<h3 data-id="heading-6">2.2 Skill Manifest定义</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># skill_manifest.yaml - Skill元数据</span>

<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">SkillManifest</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">aiops_diagnostics</span>
  <span class="hljs-attr">version:</span> <span class="hljs-string">"1.0.0"</span>
  <span class="hljs-attr">description:</span> <span class="hljs-string">"AIOps故障诊断Skill"</span>
  <span class="hljs-attr">author:</span> <span class="hljs-string">"Platform Team"</span>
  <span class="hljs-attr">lastModified:</span> <span class="hljs-string">"2025-01-04"</span>

<span class="hljs-attr">spec:</span>
  <span class="hljs-comment"># Skill基本信息</span>
  <span class="hljs-attr">skillType:</span> <span class="hljs-string">"diagnostic"</span>  <span class="hljs-comment"># diagnostic / reporting / analysis</span>
  
  <span class="hljs-comment"># 文件系统需求</span>
  <span class="hljs-attr">filesystem:</span>
    <span class="hljs-attr">workspaceSize:</span> <span class="hljs-string">"1GB"</span>
    <span class="hljs-attr">persistentDirs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">cache/</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">config/</span>
    <span class="hljs-attr">tempDirs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">reports/</span>
  
  <span class="hljs-comment"># 脚本定义</span>
  <span class="hljs-attr">scripts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"cpu_diagnostics"</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"scripts/cpu_diagnostics.sh"</span>
      <span class="hljs-attr">language:</span> <span class="hljs-string">"bash"</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">"30s"</span>
      <span class="hljs-attr">inputs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"duration"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"integer"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"诊断时长（秒）"</span>
      <span class="hljs-attr">outputs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"cpu_report"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"json"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"CPU诊断结果"</span>
    
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"log_analysis"</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"scripts/log_analysis.sh"</span>
      <span class="hljs-attr">language:</span> <span class="hljs-string">"bash"</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">"60s"</span>
      <span class="hljs-attr">inputs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"log_file"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"日志文件路径"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"keywords"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"array"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"关键词列表"</span>
      <span class="hljs-attr">outputs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"analysis_result"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"json"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"分析结果"</span>
    
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"correlation_analysis"</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">"scripts/correlation_analysis.py"</span>
      <span class="hljs-attr">language:</span> <span class="hljs-string">"python"</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">"120s"</span>
      <span class="hljs-attr">inputs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"metrics_data"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"json"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"指标数据"</span>
      <span class="hljs-attr">outputs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"correlation_report"</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">"json"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"关联分析报告"</span>
  
  <span class="hljs-comment"># 工具依赖</span>
  <span class="hljs-attr">tools:</span>
    <span class="hljs-attr">system:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"grep"</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">"*"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"awk"</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">"*"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"sed"</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">"*"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"tail"</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">"*"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
    
    <span class="hljs-attr">custom:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"log_parser"</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"tools/custom/log_parser"</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">"1.0.0"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">"metric_aggregator"</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"tools/custom/metric_aggregator"</span>
        <span class="hljs-attr">version:</span> <span class="hljs-string">"1.0.0"</span>
        <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
  
  <span class="hljs-comment"># 环境变量</span>
  <span class="hljs-attr">environment:</span>
    <span class="hljs-attr">JAVA_HOME:</span> <span class="hljs-string">"/usr/lib/jvm/java-17"</span>
    <span class="hljs-attr">LOG_LEVEL:</span> <span class="hljs-string">"INFO"</span>
    <span class="hljs-attr">CACHE_DIR:</span> <span class="hljs-string">"${WORKSPACE}/cache"</span>
    <span class="hljs-attr">REPORT_DIR:</span> <span class="hljs-string">"${WORKSPACE}/reports"</span>
  
  <span class="hljs-comment"># 资源限制</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"2"</span>           <span class="hljs-comment"># 最多2个核心</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>     <span class="hljs-comment"># 最多512MB</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">"300s"</span>     <span class="hljs-comment"># 最多5分钟</span>
    <span class="hljs-attr">diskSpace:</span> <span class="hljs-string">"1Gi"</span>    <span class="hljs-comment"># 最多1GB磁盘</span>
  
  <span class="hljs-comment"># 安全权限</span>
  <span class="hljs-attr">security:</span>
    <span class="hljs-attr">readPaths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"/var/log/"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"/proc/stat"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"/proc/meminfo"</span>
    <span class="hljs-attr">writePaths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"${WORKSPACE}/cache/"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"${WORKSPACE}/reports/"</span>
    <span class="hljs-attr">networkAccess:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment"># 不允许网络访问</span>
    <span class="hljs-attr">executablePaths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"scripts/"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"tools/"</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">3. AIOps故障诊断Skill实现</h2>
<h3 data-id="heading-8">3.1 Skill基础框架</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * AIOps故障诊断Skill基类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AIOpsDiagnosticSkill</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AgentSkill</span> {
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(AIOpsDiagnosticSkill.class);
    
    <span class="hljs-comment">// Runtime Sandbox客户端</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> SandboxClient sandboxClient;
    
    <span class="hljs-comment">// Skill文件系统</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> SkillFileSystem fileSystem;
    
    <span class="hljs-comment">// 工具注册表</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ToolRegistry toolRegistry;
    
    <span class="hljs-comment">// 诊断规则</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> DiagnosticRuleEngine ruleEngine;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AIOpsDiagnosticSkill</span><span class="hljs-params">(
            String skillName,
            SandboxClient sandboxClient,
            SkillFileSystem fileSystem,
            ToolRegistry toolRegistry)</span> {
        <span class="hljs-built_in">super</span>(skillName);
        <span class="hljs-built_in">this</span>.sandboxClient = sandboxClient;
        <span class="hljs-built_in">this</span>.fileSystem = fileSystem;
        <span class="hljs-built_in">this</span>.toolRegistry = toolRegistry;
        <span class="hljs-built_in">this</span>.ruleEngine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiagnosticRuleEngine</span>(<span class="hljs-built_in">this</span>.fileSystem);
    }
    
    <span class="hljs-comment">/**
     * 执行诊断脚本
     */</span>
    <span class="hljs-keyword">protected</span> ExecutionResult <span class="hljs-title function_">executeScript</span><span class="hljs-params">(
            String scriptName,
            Map&lt;String, String&gt; inputs,
            <span class="hljs-type">long</span> timeout)</span> <span class="hljs-keyword">throws</span> Exception {
        
        logger.info(<span class="hljs-string">"执行诊断脚本: {}"</span>, scriptName);
        
        <span class="hljs-comment">// 获取脚本路径</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">scriptPath</span> <span class="hljs-operator">=</span> fileSystem.getScriptPath(scriptName);
        
        <span class="hljs-comment">// 构建脚本命令</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> buildCommand(scriptPath, inputs);
        
        <span class="hljs-comment">// 在Sandbox中执行</span>
        <span class="hljs-type">ExecutionResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sandboxClient.executeScript(
            getSandboxId(),
            command,
            timeout,
            getEnvironmentVariables()
        );
        
        logger.info(<span class="hljs-string">"脚本执行完成: exitCode={}, duration={}ms"</span>,
            result.getExitCode(), result.getExecutionTime());
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 调用系统工具
     */</span>
    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">invokeTool</span><span class="hljs-params">(
            String toolName,
            List&lt;String&gt; args)</span> <span class="hljs-keyword">throws</span> Exception {
        
        logger.debug(<span class="hljs-string">"调用工具: {} with args: {}"</span>, toolName, args);
        
        <span class="hljs-type">ToolDefinition</span> <span class="hljs-variable">tool</span> <span class="hljs-operator">=</span> toolRegistry.getTool(toolName);
        <span class="hljs-keyword">if</span> (tool == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolNotFoundException</span>(toolName);
        }
        
        <span class="hljs-comment">// 构建完整命令</span>
        List&lt;String&gt; command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        command.add(tool.getPath());
        command.addAll(args);
        
        <span class="hljs-comment">// 执行命令</span>
        <span class="hljs-type">ExecutionResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sandboxClient.execute(
            getSandboxId(),
            String.join(<span class="hljs-string">" "</span>, command),
            <span class="hljs-number">30000</span>  <span class="hljs-comment">// 30秒超时</span>
        );
        
        <span class="hljs-keyword">if</span> (result.getExitCode() != <span class="hljs-number">0</span>) {
            logger.error(<span class="hljs-string">"工具执行失败: {}"</span>, result.getStderr());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolExecutionException</span>(toolName, result.getStderr());
        }
        
        <span class="hljs-keyword">return</span> result.getStdout();
    }
    
    <span class="hljs-comment">/**
     * 读取文件
     */</span>
    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">readFile</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">fullPath</span> <span class="hljs-operator">=</span> fileSystem.resolvePath(filePath);
        
        <span class="hljs-comment">// 使用cat工具读取文件</span>
        <span class="hljs-keyword">return</span> invokeTool(<span class="hljs-string">"cat"</span>, List.of(fullPath));
    }
    
    <span class="hljs-comment">/**
     * 分析日志文件
     */</span>
    <span class="hljs-keyword">protected</span> LogAnalysisResult <span class="hljs-title function_">analyzeLog</span><span class="hljs-params">(
            String logFilePath,
            List&lt;String&gt; keywords)</span> <span class="hljs-keyword">throws</span> Exception {
        
        logger.info(<span class="hljs-string">"分析日志文件: {}"</span>, logFilePath);
        
        <span class="hljs-comment">// 执行日志分析脚本</span>
        Map&lt;String, String&gt; inputs = Map.of(
            <span class="hljs-string">"log_file"</span>, logFilePath,
            <span class="hljs-string">"keywords"</span>, String.join(<span class="hljs-string">","</span>, keywords)
        );
        
        <span class="hljs-type">ExecutionResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executeScript(<span class="hljs-string">"log_analysis"</span>, inputs, <span class="hljs-number">60000</span>);
        
        <span class="hljs-comment">// 解析结果</span>
        <span class="hljs-keyword">return</span> parseAnalysisResult(result.getStdout());
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">buildCommand</span><span class="hljs-params">(String scriptPath, Map&lt;String, String&gt; inputs)</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Map&lt;String, String&gt; <span class="hljs-title function_">getEnvironmentVariables</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getSandboxId</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> LogAnalysisResult <span class="hljs-title function_">parseAnalysisResult</span><span class="hljs-params">(String output)</span>;
}

<span class="hljs-comment">/**
 * 执行结果
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutionResult</span> {
    <span class="hljs-keyword">private</span> String sandboxId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> exitCode;
    <span class="hljs-keyword">private</span> String stdout;
    <span class="hljs-keyword">private</span> String stderr;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> executionTime;
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; metrics;  <span class="hljs-comment">// CPU、内存等</span>
}

<span class="hljs-comment">/**
 * 日志分析结果
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAnalysisResult</span> {
    <span class="hljs-keyword">private</span> List&lt;LogEntry&gt; errorLines;
    <span class="hljs-keyword">private</span> List&lt;LogEntry&gt; warningLines;
    <span class="hljs-keyword">private</span> Map&lt;String, Integer&gt; keywordCounts;
    <span class="hljs-keyword">private</span> String summary;
    <span class="hljs-keyword">private</span> LocalDateTime analysisTime;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogEntry</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> lineNumber;
    <span class="hljs-keyword">private</span> String timestamp;
    <span class="hljs-keyword">private</span> String level;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> String context;
}
</code></pre>
<h3 data-id="heading-9">3.2 CPU诊断脚本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># scripts/cpu_diagnostics.sh - CPU诊断脚本</span>

<span class="hljs-built_in">set</span> -e

DURATION=<span class="hljs-variable">${1:-30}</span>
OUTPUT_FILE=<span class="hljs-string">"/workspace/reports/cpu_diagnostics_<span class="hljs-subst">$(date +%s)</span>.json"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始CPU诊断（<span class="hljs-variable">${DURATION}</span>秒）..."</span>

<span class="hljs-comment"># 创建JSON报告</span>
{
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"{"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  \"timestamp\": \"<span class="hljs-subst">$(date -u +%Y-%m-%dT%H:%M:%SZ)</span>\","</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  \"diagnostics\": {"</span>
    
    <span class="hljs-comment"># 1. 获取CPU核心数</span>
    CPU_CORES=$(grep -c <span class="hljs-string">"^processor"</span> /proc/cpuinfo)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    \"cpu_cores\": <span class="hljs-variable">$CPU_CORES</span>,"</span>
    
    <span class="hljs-comment"># 2. 获取CPU型号</span>
    CPU_MODEL=$(grep <span class="hljs-string">"^model name"</span> /proc/cpuinfo | <span class="hljs-built_in">head</span> -1 | <span class="hljs-built_in">cut</span> -d: -f2 | xargs)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    \"cpu_model\": \"<span class="hljs-variable">$CPU_MODEL</span>\","</span>
    
    <span class="hljs-comment"># 3. 获取当前CPU使用率</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    \"current_usage\": {"</span>
    
    <span class="hljs-comment"># 使用top命令获取平均负载</span>
    IFS=<span class="hljs-string">' '</span> <span class="hljs-built_in">read</span> -r LA1 LA5 LA15 &lt; /proc/loadavg
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"      \"load_average\": {"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"        \"1m\": <span class="hljs-variable">$LA1</span>,"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"        \"5m\": <span class="hljs-variable">$LA5</span>,"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"        \"15m\": <span class="hljs-variable">$LA15</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"      },"</span>
    
    <span class="hljs-comment"># 获取每个CPU核的使用率</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"      \"per_cpu\": ["</span>
    
    FIRST=<span class="hljs-literal">true</span>
    <span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r line; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$line</span> == cpu[0-9]* ]]; <span class="hljs-keyword">then</span>
            <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$FIRST</span>"</span> = <span class="hljs-literal">false</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">","</span>; <span class="hljs-keyword">fi</span>
            FIRST=<span class="hljs-literal">false</span>
            
            <span class="hljs-comment"># 解析CPU统计信息</span>
            FIELDS=(<span class="hljs-variable">$line</span>)
            USER=<span class="hljs-variable">${FIELDS[1]}</span>
            NICE=<span class="hljs-variable">${FIELDS[2]}</span>
            SYSTEM=<span class="hljs-variable">${FIELDS[3]}</span>
            IDLE=<span class="hljs-variable">${FIELDS[4]}</span>
            
            TOTAL=$((USER + NICE + SYSTEM + IDLE))
            USAGE=$((<span class="hljs-number">100</span> * (TOTAL - IDLE) / TOTAL))
            
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"        {"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"          \"cpu\": \"<span class="hljs-variable">${FIELDS[0]}</span>\","</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"          \"usage_percent\": <span class="hljs-variable">$USAGE</span>"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"        }"</span> | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">'\n'</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span> &lt; /proc/stat
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"      ]"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    },"</span>
    
    <span class="hljs-comment"># 4. 诊断高CPU使用的进程</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    \"top_processes\": ["</span>
    
    FIRST=<span class="hljs-literal">true</span>
    ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">tail</span> -n +2 | <span class="hljs-built_in">head</span> -5 | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> -r line; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$FIRST</span>"</span> = <span class="hljs-literal">false</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">","</span>; <span class="hljs-keyword">fi</span>
        FIRST=<span class="hljs-literal">false</span>
        
        IFS=<span class="hljs-string">' '</span> <span class="hljs-built_in">read</span> -r USER PID PCPU PMEM VSZ RSS TTY STAT START TIME CMD &lt;&lt;&lt; <span class="hljs-string">"<span class="hljs-variable">$line</span>"</span>
        
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"        {"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"          \"pid\": <span class="hljs-variable">$PID</span>,"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"          \"user\": \"<span class="hljs-variable">$USER</span>\","</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"          \"cpu_percent\": <span class="hljs-variable">$PCPU</span>,"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"          \"memory_percent\": <span class="hljs-variable">$PMEM</span>,"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"          \"command\": \"<span class="hljs-subst">$(echo $CMD | cut -d' ' -f1)</span>\""</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"        }"</span> | <span class="hljs-built_in">tr</span> -d <span class="hljs-string">'\n'</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"      ]"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    }"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  },"</span>
    
    <span class="hljs-comment"># 5. 诊断建议</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  \"recommendations\": ["</span>
    
    <span class="hljs-keyword">if</span> (( $(echo "<span class="hljs-variable">$LA1</span> &gt; <span class="hljs-variable">$CPU_CORES</span>" | bc -l) )); <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"    \"警告：1分钟平均负载高于CPU核心数，系统可能过载\","</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-keyword">if</span> (( $(echo "<span class="hljs-variable">$LA5</span> &gt; <span class="hljs-variable">$CPU_CORES</span> * <span class="hljs-number">0.8</span>" | bc -l) )); <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"    \"提示：5分钟平均负载较高，建议检查后台任务\","</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"    \"建议定期监控CPU使用率\""</span> 
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  ]"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"}"</span>
    
} &gt; <span class="hljs-string">"<span class="hljs-variable">$OUTPUT_FILE</span>"</span>

<span class="hljs-comment"># 输出结果路径</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"诊断完成，结果保存到: <span class="hljs-variable">$OUTPUT_FILE</span>"</span>
<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$OUTPUT_FILE</span>"</span>
</code></pre>
<h3 data-id="heading-10">3.3 内存诊断Skill实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 内存诊断Skill
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryDiagnosticSkill</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AIOpsDiagnosticSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(MemoryDiagnosticSkill.class);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MetricAggregator metricAggregator;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MemoryDiagnosticSkill</span><span class="hljs-params">(
            SandboxClient sandboxClient,
            SkillFileSystem fileSystem,
            ToolRegistry toolRegistry)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"memory_diagnostic"</span>, sandboxClient, fileSystem, toolRegistry);
        <span class="hljs-built_in">this</span>.metricAggregator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetricAggregator</span>();
    }
    
    <span class="hljs-comment">/**
     * 执行内存诊断
     */</span>
    <span class="hljs-keyword">public</span> MemoryDiagnosticReport <span class="hljs-title function_">diagnose</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        logger.info(<span class="hljs-string">"开始内存诊断..."</span>);
        
        MemoryDiagnosticReport.<span class="hljs-type">Builder</span> <span class="hljs-variable">reportBuilder</span> <span class="hljs-operator">=</span> MemoryDiagnosticReport.builder()
            .timestamp(LocalDateTime.now());
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// Step 1: 获取内存统计</span>
            <span class="hljs-type">MemoryStatistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> getMemoryStatistics();
            reportBuilder.statistics(stats);
            logger.info(<span class="hljs-string">"内存统计: 总内存={}MB, 已用={}MB, 可用={}MB"</span>,
                stats.getTotalMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>,
                stats.getUsedMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>,
                stats.getAvailableMemory() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);
            
            <span class="hljs-comment">// Step 2: 分析内存使用趋势</span>
            List&lt;MemoryMetric&gt; trends = analyzeMemoryTrends();
            reportBuilder.trends(trends);
            
            <span class="hljs-comment">// Step 3: 识别内存泄漏</span>
            <span class="hljs-type">MemoryLeakDetection</span> <span class="hljs-variable">leakDetection</span> <span class="hljs-operator">=</span> detectMemoryLeaks();
            reportBuilder.leakDetection(leakDetection);
            
            <span class="hljs-comment">// Step 4: 诊断高内存进程</span>
            List&lt;ProcessMemoryInfo&gt; topProcesses = getTopMemoryConsumers(<span class="hljs-number">5</span>);
            reportBuilder.topProcesses(topProcesses);
            
            <span class="hljs-comment">// Step 5: 生成建议</span>
            List&lt;String&gt; recommendations = generateRecommendations(stats, leakDetection);
            reportBuilder.recommendations(recommendations);
            
            reportBuilder.status(<span class="hljs-string">"SUCCESS"</span>);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"内存诊断失败"</span>, e);
            reportBuilder.status(<span class="hljs-string">"FAILED"</span>).error(e.getMessage());
        }
        
        <span class="hljs-keyword">return</span> reportBuilder.build();
    }
    
    <span class="hljs-comment">/**
     * 获取内存统计信息
     */</span>
    <span class="hljs-keyword">private</span> MemoryStatistics <span class="hljs-title function_">getMemoryStatistics</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 调用系统工具获取内存信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">meminfo</span> <span class="hljs-operator">=</span> readFile(<span class="hljs-string">"/proc/meminfo"</span>);
        
        <span class="hljs-comment">// 解析/proc/meminfo</span>
        Map&lt;String, Long&gt; memStats = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (String line : meminfo.split(<span class="hljs-string">"\n"</span>)) {
            <span class="hljs-keyword">if</span> (line.trim().isEmpty()) <span class="hljs-keyword">continue</span>;
            
            <span class="hljs-comment">// 格式: MemTotal:        16334732 kB</span>
            String[] parts = line.split(<span class="hljs-string">":"</span>);
            <span class="hljs-keyword">if</span> (parts.length == <span class="hljs-number">2</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> parts[<span class="hljs-number">0</span>].trim();
                <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> parts[<span class="hljs-number">1</span>].trim().split(<span class="hljs-string">"\\s+"</span>)[<span class="hljs-number">0</span>];
                memStats.put(key, Long.parseLong(value) * <span class="hljs-number">1024</span>); <span class="hljs-comment">// 转换为字节</span>
            }
        }
        
        <span class="hljs-keyword">return</span> MemoryStatistics.builder()
            .totalMemory(memStats.getOrDefault(<span class="hljs-string">"MemTotal"</span>, <span class="hljs-number">0L</span>))
            .usedMemory(memStats.getOrDefault(<span class="hljs-string">"MemTotal"</span>, <span class="hljs-number">0L</span>) - 
                       memStats.getOrDefault(<span class="hljs-string">"MemAvailable"</span>, <span class="hljs-number">0L</span>))
            .availableMemory(memStats.getOrDefault(<span class="hljs-string">"MemAvailable"</span>, <span class="hljs-number">0L</span>))
            .buffers(memStats.getOrDefault(<span class="hljs-string">"Buffers"</span>, <span class="hljs-number">0L</span>))
            .cached(memStats.getOrDefault(<span class="hljs-string">"Cached"</span>, <span class="hljs-number">0L</span>))
            .swapTotal(memStats.getOrDefault(<span class="hljs-string">"SwapTotal"</span>, <span class="hljs-number">0L</span>))
            .swapUsed(memStats.getOrDefault(<span class="hljs-string">"SwapTotal"</span>, <span class="hljs-number">0L</span>) - 
                     memStats.getOrDefault(<span class="hljs-string">"SwapFree"</span>, <span class="hljs-number">0L</span>))
            .timestamp(LocalDateTime.now())
            .build();
    }
    
    <span class="hljs-comment">/**
     * 分析内存使用趋势
     */</span>
    <span class="hljs-keyword">private</span> List&lt;MemoryMetric&gt; <span class="hljs-title function_">analyzeMemoryTrends</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        logger.info(<span class="hljs-string">"分析内存使用趋势..."</span>);
        
        <span class="hljs-comment">// 获取缓存中的历史数据</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">cacheDir</span> <span class="hljs-operator">=</span> fileSystem.getCacheDir();
        List&lt;MemoryMetric&gt; trends = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-comment">// 读取历史指标（JSON格式）</span>
        File[] cacheFiles = cacheDir.listFiles((dir, name) -&gt; name.startsWith(<span class="hljs-string">"memory_"</span>) &amp;&amp; name.endsWith(<span class="hljs-string">".json"</span>));
        
        <span class="hljs-keyword">if</span> (cacheFiles != <span class="hljs-literal">null</span>) {
            Arrays.sort(cacheFiles, Comparator.comparingLong(File::lastModified));
            
            <span class="hljs-keyword">for</span> (File cacheFile : cacheFiles) {
                <span class="hljs-type">MemoryMetric</span> <span class="hljs-variable">metric</span> <span class="hljs-operator">=</span> parseMemoryMetric(readFile(cacheFile.getAbsolutePath()));
                trends.add(metric);
            }
        }
        
        <span class="hljs-comment">// 保存当前指标到缓存</span>
        <span class="hljs-type">MemoryMetric</span> <span class="hljs-variable">currentMetric</span> <span class="hljs-operator">=</span> MemoryMetric.builder()
            .timestamp(LocalDateTime.now())
            .memoryUsagePercent(getCurrentMemoryUsagePercent())
            .build();
        
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheFile</span> <span class="hljs-operator">=</span> cacheDir.getAbsolutePath() + <span class="hljs-string">"/memory_"</span> + System.currentTimeMillis() + <span class="hljs-string">".json"</span>;
        saveMetricToCache(cacheFile, currentMetric);
        
        trends.add(currentMetric);
        <span class="hljs-keyword">return</span> trends;
    }
    
    <span class="hljs-comment">/**
     * 检测内存泄漏
     */</span>
    <span class="hljs-keyword">private</span> MemoryLeakDetection <span class="hljs-title function_">detectMemoryLeaks</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        logger.info(<span class="hljs-string">"检测内存泄漏..."</span>);
        
        <span class="hljs-comment">// 执行自定义的内存泄漏检测工具</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> invokeTool(<span class="hljs-string">"memory_leak_detector"</span>, List.of(
            <span class="hljs-string">"--duration"</span>, <span class="hljs-string">"60"</span>,
            <span class="hljs-string">"--threshold"</span>, <span class="hljs-string">"80"</span>
        ));
        
        <span class="hljs-comment">// 解析结果</span>
        <span class="hljs-keyword">return</span> parseLeakDetectionResult(result);
    }
    
    <span class="hljs-comment">/**
     * 获取内存使用最高的进程
     */</span>
    <span class="hljs-keyword">private</span> List&lt;ProcessMemoryInfo&gt; <span class="hljs-title function_">getTopMemoryConsumers</span><span class="hljs-params">(<span class="hljs-type">int</span> topN)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 使用grep和awk处理ps输出</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">psOutput</span> <span class="hljs-operator">=</span> invokeTool(<span class="hljs-string">"ps"</span>, Arrays.asList(
            <span class="hljs-string">"aux"</span>, <span class="hljs-string">"--sort=-rss"</span>
        ));
        
        List&lt;ProcessMemoryInfo&gt; processes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        String[] lines = psOutput.split(<span class="hljs-string">"\n"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; Math.min(lines.length, topN + <span class="hljs-number">1</span>); i++) {
            String[] fields = lines[i].trim().split(<span class="hljs-string">"\\s+"</span>);
            
            <span class="hljs-type">ProcessMemoryInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> ProcessMemoryInfo.builder()
                .pid(Integer.parseInt(fields[<span class="hljs-number">1</span>]))
                .user(fields[<span class="hljs-number">0</span>])
                .memoryPercent(Double.parseDouble(fields[<span class="hljs-number">3</span>]))
                .memoryRss(Long.parseLong(fields[<span class="hljs-number">5</span>]) * <span class="hljs-number">1024</span>) <span class="hljs-comment">// 转换为字节</span>
                .command(fields[<span class="hljs-number">10</span>])
                .build();
            
            processes.add(info);
        }
        
        <span class="hljs-keyword">return</span> processes;
    }
    
    <span class="hljs-comment">/**
     * 生成诊断建议
     */</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">generateRecommendations</span><span class="hljs-params">(
            MemoryStatistics stats,
            MemoryLeakDetection leakDetection)</span> {
        
        List&lt;String&gt; recommendations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-type">double</span> <span class="hljs-variable">usagePercent</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) stats.getUsedMemory() / stats.getTotalMemory() * <span class="hljs-number">100</span>;
        
        <span class="hljs-keyword">if</span> (usagePercent &gt; <span class="hljs-number">90</span>) {
            recommendations.add(<span class="hljs-string">"⚠️  严重警告：内存使用率超过90%，系统可能面临OOM风险"</span>);
            recommendations.add(<span class="hljs-string">"   建议：立即释放不必要的内存，考虑增加物理内存"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (usagePercent &gt; <span class="hljs-number">80</span>) {
            recommendations.add(<span class="hljs-string">"⚠️  警告：内存使用率超过80%，性能可能下降"</span>);
            recommendations.add(<span class="hljs-string">"   建议：监控内存使用情况，识别大内存应用"</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (usagePercent &gt; <span class="hljs-number">70</span>) {
            recommendations.add(<span class="hljs-string">"📌 提示：内存使用率超过70%，建议定期清理"</span>);
        }
        
        <span class="hljs-keyword">if</span> (leakDetection.isDetected()) {
            recommendations.add(<span class="hljs-string">"⚠️  检测到可能的内存泄漏："</span> + leakDetection.getDescription());
            recommendations.add(<span class="hljs-string">"   建议：分析相关应用的日志和堆转储"</span>);
        }
        
        <span class="hljs-keyword">if</span> (stats.getSwapUsed() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-type">double</span> <span class="hljs-variable">swapPercent</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) stats.getSwapUsed() / stats.getSwapTotal() * <span class="hljs-number">100</span>;
            <span class="hljs-keyword">if</span> (swapPercent &gt; <span class="hljs-number">50</span>) {
                recommendations.add(<span class="hljs-string">"⚠️  警告：Swap使用率过高（"</span> + String.format(<span class="hljs-string">"%.1f"</span>, swapPercent) + <span class="hljs-string">"%），性能严重下降"</span>);
                recommendations.add(<span class="hljs-string">"   建议：检查是否存在内存泄漏或不合理的内存占用"</span>);
            }
        }
        
        recommendations.add(<span class="hljs-string">"💡 建议：定期运行内存诊断，及时发现潜在问题"</span>);
        
        <span class="hljs-keyword">return</span> recommendations;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">buildCommand</span><span class="hljs-params">(String scriptPath, Map&lt;String, String&gt; inputs)</span> {
        <span class="hljs-keyword">return</span> scriptPath;  <span class="hljs-comment">// 直接执行脚本</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Map&lt;String, String&gt; <span class="hljs-title function_">getEnvironmentVariables</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Map.of(
            <span class="hljs-string">"JAVA_HOME"</span>, <span class="hljs-string">"/usr/lib/jvm/java-17"</span>,
            <span class="hljs-string">"LOG_LEVEL"</span>, <span class="hljs-string">"INFO"</span>
        );
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getSandboxId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"aiops_sandbox_memory"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> LogAnalysisResult <span class="hljs-title function_">parseAnalysisResult</span><span class="hljs-params">(String output)</span> {
        <span class="hljs-comment">// 实现日志分析结果解析</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">// 辅助方法...</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getCurrentMemoryUsagePercent</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">MemoryStatistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> getMemoryStatistics();
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) stats.getUsedMemory() / stats.getTotalMemory() * <span class="hljs-number">100</span>;
    }
    
    <span class="hljs-keyword">private</span> MemoryMetric <span class="hljs-title function_">parseMemoryMetric</span><span class="hljs-params">(String json)</span> {
        <span class="hljs-comment">// 解析JSON格式的内存指标</span>
        <span class="hljs-keyword">return</span> MemoryMetric.builder().build();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveMetricToCache</span><span class="hljs-params">(String path, MemoryMetric metric)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 保存指标到缓存</span>
    }
    
    <span class="hljs-keyword">private</span> MemoryLeakDetection <span class="hljs-title function_">parseLeakDetectionResult</span><span class="hljs-params">(String result)</span> {
        <span class="hljs-keyword">return</span> MemoryLeakDetection.builder()
            .detected(result.contains(<span class="hljs-string">"leak"</span>))
            .description(result)
            .build();
    }
}

<span class="hljs-comment">// 数据模型</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryDiagnosticReport</span> {
    <span class="hljs-keyword">private</span> LocalDateTime timestamp;
    <span class="hljs-keyword">private</span> MemoryStatistics statistics;
    <span class="hljs-keyword">private</span> List&lt;MemoryMetric&gt; trends;
    <span class="hljs-keyword">private</span> MemoryLeakDetection leakDetection;
    <span class="hljs-keyword">private</span> List&lt;ProcessMemoryInfo&gt; topProcesses;
    <span class="hljs-keyword">private</span> List&lt;String&gt; recommendations;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> String error;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryStatistics</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> totalMemory;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> usedMemory;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> availableMemory;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> buffers;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> cached;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> swapTotal;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> swapUsed;
    <span class="hljs-keyword">private</span> LocalDateTime timestamp;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryMetric</span> {
    <span class="hljs-keyword">private</span> LocalDateTime timestamp;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> memoryUsagePercent;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryLeakDetection</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> detected;
    <span class="hljs-keyword">private</span> String description;
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessMemoryInfo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> pid;
    <span class="hljs-keyword">private</span> String user;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> memoryPercent;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> memoryRss;
    <span class="hljs-keyword">private</span> String command;
}
</code></pre>
<hr/>
<h2 data-id="heading-11">4. 自定义工具的开发与集成</h2>
<h3 data-id="heading-12">4.1 自定义工具框架</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自定义工具基类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTool</span> {
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(getClass());
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ToolContext context;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomTool</span><span class="hljs-params">(ToolContext context)</span> {
        <span class="hljs-built_in">this</span>.context = context;
    }
    
    <span class="hljs-comment">/**
     * 工具元数据
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> ToolMetadata <span class="hljs-title function_">getMetadata</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">/**
     * 执行工具
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> ToolResult <span class="hljs-title function_">execute</span><span class="hljs-params">(Map&lt;String, String&gt; args)</span> <span class="hljs-keyword">throws</span> Exception;
    
    <span class="hljs-comment">/**
     * 工具元数据
     */</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolMetadata</span> {
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String version;
        <span class="hljs-keyword">private</span> String description;
        <span class="hljs-keyword">private</span> List&lt;ParameterSpec&gt; parameters;
        <span class="hljs-keyword">private</span> String outputFormat;  <span class="hljs-comment">// json / text / binary</span>
    }
    
    <span class="hljs-meta">@Data</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSpec</span> {
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String type;  <span class="hljs-comment">// string / int / boolean / array</span>
        <span class="hljs-keyword">private</span> String description;
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> required;
        <span class="hljs-keyword">private</span> String defaultValue;
    }
    
    <span class="hljs-meta">@Data</span>
    <span class="hljs-meta">@Builder</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolResult</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> exitCode;
        <span class="hljs-keyword">private</span> String output;
        <span class="hljs-keyword">private</span> String error;
        <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; metrics;  <span class="hljs-comment">// 执行指标</span>
    }
}

<span class="hljs-comment">/**
 * 工具上下文
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolContext</span> {
    <span class="hljs-keyword">private</span> String toolId;
    <span class="hljs-keyword">private</span> String sandboxId;
    <span class="hljs-keyword">private</span> File workspaceRoot;
    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; environment;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timeout;
}

<span class="hljs-comment">/**
 * 日志解析工具
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogParserTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomTool</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogParserTool</span><span class="hljs-params">(ToolContext context)</span> {
        <span class="hljs-built_in">super</span>(context);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ToolMetadata <span class="hljs-title function_">getMetadata</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ToolMetadata.builder()
            .name(<span class="hljs-string">"log_parser"</span>)
            .version(<span class="hljs-string">"1.0.0"</span>)
            .description(<span class="hljs-string">"高性能日志解析和分析工具"</span>)
            .parameters(Arrays.asList(
                ParameterSpec.builder()
                    .name(<span class="hljs-string">"log_file"</span>)
                    .type(<span class="hljs-string">"string"</span>)
                    .description(<span class="hljs-string">"日志文件路径"</span>)
                    .required(<span class="hljs-literal">true</span>)
                    .build(),
                ParameterSpec.builder()
                    .name(<span class="hljs-string">"pattern"</span>)
                    .type(<span class="hljs-string">"string"</span>)
                    .description(<span class="hljs-string">"匹配模式（正则表达式）"</span>)
                    .required(<span class="hljs-literal">false</span>)
                    .build(),
                ParameterSpec.builder()
                    .name(<span class="hljs-string">"level"</span>)
                    .type(<span class="hljs-string">"string"</span>)
                    .description(<span class="hljs-string">"日志级别（ERROR/WARN/INFO）"</span>)
                    .required(<span class="hljs-literal">false</span>)
                    .defaultValue(<span class="hljs-string">"*"</span>)
                    .build(),
                ParameterSpec.builder()
                    .name(<span class="hljs-string">"max_lines"</span>)
                    .type(<span class="hljs-string">"int"</span>)
                    .description(<span class="hljs-string">"最多返回行数"</span>)
                    .required(<span class="hljs-literal">false</span>)
                    .defaultValue(<span class="hljs-string">"1000"</span>)
                    .build()
            ))
            .outputFormat(<span class="hljs-string">"json"</span>)
            .build();
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ToolResult <span class="hljs-title function_">execute</span><span class="hljs-params">(Map&lt;String, String&gt; args)</span> <span class="hljs-keyword">throws</span> Exception {
        logger.info(<span class="hljs-string">"执行日志解析: file={}"</span>, args.get(<span class="hljs-string">"log_file"</span>));
        
        <span class="hljs-type">String</span> <span class="hljs-variable">logFile</span> <span class="hljs-operator">=</span> args.get(<span class="hljs-string">"log_file"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> args.getOrDefault(<span class="hljs-string">"pattern"</span>, <span class="hljs-string">".*"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">level</span> <span class="hljs-operator">=</span> args.getOrDefault(<span class="hljs-string">"level"</span>, <span class="hljs-string">"*"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">maxLines</span> <span class="hljs-operator">=</span> Integer.parseInt(args.getOrDefault(<span class="hljs-string">"max_lines"</span>, <span class="hljs-string">"1000"</span>));
        
        <span class="hljs-comment">// 读取日志文件</span>
        List&lt;String&gt; lines = readLogFile(logFile);
        
        <span class="hljs-comment">// 解析日志</span>
        List&lt;LogEntry&gt; entries = parseLogLines(lines, pattern, level, maxLines);
        
        <span class="hljs-comment">// 统计信息</span>
        Map&lt;String, Integer&gt; statistics = computeStatistics(entries);
        
        <span class="hljs-comment">// 生成JSON输出</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> generateJsonOutput(entries, statistics);
        
        <span class="hljs-keyword">return</span> ToolResult.builder()
            .exitCode(<span class="hljs-number">0</span>)
            .output(output)
            .metrics(Map.of(<span class="hljs-string">"lines_processed"</span>, lines.size(), <span class="hljs-string">"entries_matched"</span>, entries.size()))
            .build();
    }
    
    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">readLogFile</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Path</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Paths.get(filePath);
        <span class="hljs-keyword">return</span> Files.readAllLines(path);
    }
    
    <span class="hljs-keyword">private</span> List&lt;LogEntry&gt; <span class="hljs-title function_">parseLogLines</span><span class="hljs-params">(
            List&lt;String&gt; lines,
            String pattern,
            String level,
            <span class="hljs-type">int</span> maxLines)</span> <span class="hljs-keyword">throws</span> Exception {
        
        List&lt;LogEntry&gt; entries = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">Pattern</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> Pattern.compile(pattern);
        
        <span class="hljs-keyword">for</span> (String line : lines) {
            <span class="hljs-keyword">if</span> (entries.size() &gt;= maxLines) <span class="hljs-keyword">break</span>;
            
            <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> regex.matcher(line);
            <span class="hljs-keyword">if</span> (matcher.find()) {
                <span class="hljs-comment">// 解析日志格式（支持常见格式）</span>
                <span class="hljs-type">LogEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> parseSingleLogEntry(line);
                
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"*"</span>.equals(level) || line.contains(level)) {
                    entries.add(entry);
                }
            }
        }
        
        <span class="hljs-keyword">return</span> entries;
    }
    
    <span class="hljs-keyword">private</span> LogEntry <span class="hljs-title function_">parseSingleLogEntry</span><span class="hljs-params">(String line)</span> {
        <span class="hljs-comment">// 简单的日志解析实现</span>
        <span class="hljs-comment">// 支持格式: [2025-01-04 10:30:45] ERROR [com.example.Service] Message</span>
        
        String[] parts = line.split(<span class="hljs-string">"\\]"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> parts.length &gt; <span class="hljs-number">0</span> ? parts[<span class="hljs-number">0</span>].substring(<span class="hljs-number">1</span>) : <span class="hljs-string">""</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">levelAndMessage</span> <span class="hljs-operator">=</span> parts.length &gt; <span class="hljs-number">1</span> ? parts[<span class="hljs-number">1</span>].trim() : <span class="hljs-string">""</span>;
        
        <span class="hljs-keyword">return</span> LogEntry.builder()
            .timestamp(timestamp)
            .message(levelAndMessage)
            .build();
    }
    
    <span class="hljs-keyword">private</span> Map&lt;String, Integer&gt; <span class="hljs-title function_">computeStatistics</span><span class="hljs-params">(List&lt;LogEntry&gt; entries)</span> {
        Map&lt;String, Integer&gt; stats = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        stats.put(<span class="hljs-string">"total_entries"</span>, entries.size());
        
        <span class="hljs-comment">// 统计各级别日志</span>
        entries.stream()
            .filter(e -&gt; e.getMessage().contains(<span class="hljs-string">"ERROR"</span>))
            .count();
        
        <span class="hljs-keyword">return</span> stats;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateJsonOutput</span><span class="hljs-params">(List&lt;LogEntry&gt; entries, Map&lt;String, Integer&gt; stats)</span> {
        <span class="hljs-comment">// 返回JSON格式的分析结果</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(Map.of(
            <span class="hljs-string">"entries"</span>, entries,
            <span class="hljs-string">"statistics"</span>, stats
        ));
    }
}

<span class="hljs-comment">/**
 * 指标聚合工具
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricAggregatorTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CustomTool</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MetricAggregatorTool</span><span class="hljs-params">(ToolContext context)</span> {
        <span class="hljs-built_in">super</span>(context);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ToolMetadata <span class="hljs-title function_">getMetadata</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ToolMetadata.builder()
            .name(<span class="hljs-string">"metric_aggregator"</span>)
            .version(<span class="hljs-string">"1.0.0"</span>)
            .description(<span class="hljs-string">"系统指标聚合和统计工具"</span>)
            .parameters(Arrays.asList(
                ParameterSpec.builder()
                    .name(<span class="hljs-string">"metric_file"</span>)
                    .type(<span class="hljs-string">"string"</span>)
                    .description(<span class="hljs-string">"指标文件路径"</span>)
                    .required(<span class="hljs-literal">true</span>)
                    .build(),
                ParameterSpec.builder()
                    .name(<span class="hljs-string">"aggregate_type"</span>)
                    .type(<span class="hljs-string">"string"</span>)
                    .description(<span class="hljs-string">"聚合类型（sum/avg/min/max/percentile）"</span>)
                    .required(<span class="hljs-literal">true</span>)
                    .build()
            ))
            .outputFormat(<span class="hljs-string">"json"</span>)
            .build();
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ToolResult <span class="hljs-title function_">execute</span><span class="hljs-params">(Map&lt;String, String&gt; args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">metricFile</span> <span class="hljs-operator">=</span> args.get(<span class="hljs-string">"metric_file"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">aggregateType</span> <span class="hljs-operator">=</span> args.get(<span class="hljs-string">"aggregate_type"</span>);
        
        logger.info(<span class="hljs-string">"聚合指标: file={}, type={}"</span>, metricFile, aggregateType);
        
        <span class="hljs-comment">// 读取指标文件</span>
        List&lt;Double&gt; metrics = readMetricFile(metricFile);
        
        <span class="hljs-comment">// 执行聚合</span>
        Map&lt;String, Double&gt; result = aggregate(metrics, aggregateType);
        
        <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);
        
        <span class="hljs-keyword">return</span> ToolResult.builder()
            .exitCode(<span class="hljs-number">0</span>)
            .output(output)
            .metrics(Map.of(<span class="hljs-string">"metrics_count"</span>, metrics.size()))
            .build();
    }
    
    <span class="hljs-keyword">private</span> List&lt;Double&gt; <span class="hljs-title function_">readMetricFile</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 读取指标文件</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
    
    <span class="hljs-keyword">private</span> Map&lt;String, Double&gt; <span class="hljs-title function_">aggregate</span><span class="hljs-params">(List&lt;Double&gt; metrics, String type)</span> {
        Map&lt;String, Double&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"sum"</span>.equals(type)) {
            result.put(<span class="hljs-string">"sum"</span>, metrics.stream().mapToDouble(Double::doubleValue).sum());
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"avg"</span>.equals(type)) {
            result.put(<span class="hljs-string">"average"</span>, metrics.stream().mapToDouble(Double::doubleValue).average().orElse(<span class="hljs-number">0</span>));
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"min"</span>.equals(type)) {
            result.put(<span class="hljs-string">"min"</span>, metrics.stream().mapToDouble(Double::doubleValue).min().orElse(<span class="hljs-number">0</span>));
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"max"</span>.equals(type)) {
            result.put(<span class="hljs-string">"max"</span>, metrics.stream().mapToDouble(Double::doubleValue).max().orElse(<span class="hljs-number">0</span>));
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 data-id="heading-13">4.2 工具注册和管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 工具注册表和管理器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolRegistry</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ToolDefinition&gt; systemTools = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, CustomTool&gt; customTools = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ToolRegistry</span><span class="hljs-params">()</span> {
        initializeSystemTools();
    }
    
    <span class="hljs-comment">/**
     * 初始化系统工具
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeSystemTools</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 注册grep</span>
        registerSystemTool(ToolDefinition.builder()
            .name(<span class="hljs-string">"grep"</span>)
            .path(<span class="hljs-string">"/bin/grep"</span>)
            .type(<span class="hljs-string">"system"</span>)
            .version(<span class="hljs-string">"2.28"</span>)
            .description(<span class="hljs-string">"文本搜索工具"</span>)
            .build());
        
        <span class="hljs-comment">// 注册cat</span>
        registerSystemTool(ToolDefinition.builder()
            .name(<span class="hljs-string">"cat"</span>)
            .path(<span class="hljs-string">"/bin/cat"</span>)
            .type(<span class="hljs-string">"system"</span>)
            .version(<span class="hljs-string">"8.32"</span>)
            .description(<span class="hljs-string">"文件查看工具"</span>)
            .build());
        
        <span class="hljs-comment">// 注册awk</span>
        registerSystemTool(ToolDefinition.builder()
            .name(<span class="hljs-string">"awk"</span>)
            .path(<span class="hljs-string">"/usr/bin/awk"</span>)
            .type(<span class="hljs-string">"system"</span>)
            .version(<span class="hljs-string">"5.1.0"</span>)
            .description(<span class="hljs-string">"文本处理工具"</span>)
            .build());
        
        <span class="hljs-comment">// 注册sed</span>
        registerSystemTool(ToolDefinition.builder()
            .name(<span class="hljs-string">"sed"</span>)
            .path(<span class="hljs-string">"/bin/sed"</span>)
            .type(<span class="hljs-string">"system"</span>)
            .version(<span class="hljs-string">"4.7"</span>)
            .description(<span class="hljs-string">"流编辑器"</span>)
            .build());
        
        <span class="hljs-comment">// 注册tail</span>
        registerSystemTool(ToolDefinition.builder()
            .name(<span class="hljs-string">"tail"</span>)
            .path(<span class="hljs-string">"/usr/bin/tail"</span>)
            .type(<span class="hljs-string">"system"</span>)
            .version(<span class="hljs-string">"8.32"</span>)
            .description(<span class="hljs-string">"查看文件末尾"</span>)
            .build());
        
        <span class="hljs-comment">// 注册ps</span>
        registerSystemTool(ToolDefinition.builder()
            .name(<span class="hljs-string">"ps"</span>)
            .path(<span class="hljs-string">"/bin/ps"</span>)
            .type(<span class="hljs-string">"system"</span>)
            .version(<span class="hljs-string">"3.3.17"</span>)
            .description(<span class="hljs-string">"进程信息查看"</span>)
            .build());
    }
    
    <span class="hljs-comment">/**
     * 注册系统工具
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSystemTool</span><span class="hljs-params">(ToolDefinition toolDef)</span> {
        systemTools.put(toolDef.getName(), toolDef);
        logger.info(<span class="hljs-string">"已注册系统工具: {} ({})"</span>, toolDef.getName(), toolDef.getPath());
    }
    
    <span class="hljs-comment">/**
     * 注册自定义工具
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerCustomTool</span><span class="hljs-params">(String name, CustomTool tool)</span> {
        customTools.put(name, tool);
        <span class="hljs-type">ToolMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> tool.getMetadata();
        logger.info(<span class="hljs-string">"已注册自定义工具: {} v{}"</span>, metadata.getName(), metadata.getVersion());
    }
    
    <span class="hljs-comment">/**
     * 获取工具
     */</span>
    <span class="hljs-keyword">public</span> ToolDefinition <span class="hljs-title function_">getTool</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> systemTools.get(name);
    }
    
    <span class="hljs-comment">/**
     * 获取自定义工具
     */</span>
    <span class="hljs-keyword">public</span> CustomTool <span class="hljs-title function_">getCustomTool</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> customTools.get(name);
    }
    
    <span class="hljs-comment">/**
     * 验证工具是否存在
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasTool</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> systemTools.containsKey(name) || customTools.containsKey(name);
    }
    
    <span class="hljs-comment">/**
     * 列出所有工具
     */</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">listAllTools</span><span class="hljs-params">()</span> {
        List&lt;String&gt; tools = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        tools.addAll(systemTools.keySet());
        tools.addAll(customTools.keySet());
        <span class="hljs-keyword">return</span> tools;
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolDefinition</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String path;
    <span class="hljs-keyword">private</span> String type;  <span class="hljs-comment">// system / custom</span>
    <span class="hljs-keyword">private</span> String version;
    <span class="hljs-keyword">private</span> String description;
}
</code></pre>
<hr/>
<h2 data-id="heading-14">5. 报告生成Skill</h2>
<h3 data-id="heading-15">5.1 报告模板管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 报告模板系统
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportTemplateEngine</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SkillFileSystem fileSystem;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TemplateResolver resolver;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReportTemplateEngine</span><span class="hljs-params">(SkillFileSystem fileSystem)</span> {
        <span class="hljs-built_in">this</span>.fileSystem = fileSystem;
        <span class="hljs-built_in">this</span>.resolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateResolver</span>();
    }
    
    <span class="hljs-comment">/**
     * 生成报告
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateReport</span><span class="hljs-params">(
            String templateName,
            Map&lt;String, Object&gt; data,
            ReportFormat format)</span> <span class="hljs-keyword">throws</span> Exception {
        
        logger.info(<span class="hljs-string">"生成报告: template={}, format={}"</span>, templateName, format);
        
        <span class="hljs-comment">// 加载模板</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">templateContent</span> <span class="hljs-operator">=</span> loadTemplate(templateName);
        
        <span class="hljs-comment">// 渲染模板</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">renderedContent</span> <span class="hljs-operator">=</span> renderTemplate(templateContent, data);
        
        <span class="hljs-comment">// 转换格式</span>
        <span class="hljs-keyword">return</span> convertFormat(renderedContent, format);
    }
    
    <span class="hljs-comment">/**
     * 加载模板
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">loadTemplate</span><span class="hljs-params">(String templateName)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">File</span> <span class="hljs-variable">templateFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(
            fileSystem.getTemplateDir(),
            templateName + <span class="hljs-string">".md"</span>
        );
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Files.readAllBytes(templateFile.toPath()));
    }
    
    <span class="hljs-comment">/**
     * 渲染模板
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">renderTemplate</span><span class="hljs-params">(String template, Map&lt;String, Object&gt; data)</span> {
        <span class="hljs-comment">// 使用Freemarker或Velocity进行模板渲染</span>
        <span class="hljs-comment">// 这里简化为简单的字符串替换</span>
        
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> template;
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : data.entrySet()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">placeholder</span> <span class="hljs-operator">=</span> <span class="hljs-string">"${"</span> + entry.getKey() + <span class="hljs-string">"}"</span>;
            result = result.replace(placeholder, String.valueOf(entry.getValue()));
        }
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 格式转换
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">convertFormat</span><span class="hljs-params">(String content, ReportFormat format)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">switch</span> (format) {
            <span class="hljs-keyword">case</span> MARKDOWN:
                <span class="hljs-keyword">return</span> content;
            <span class="hljs-keyword">case</span> HTML:
                <span class="hljs-keyword">return</span> convertMarkdownToHtml(content);
            <span class="hljs-keyword">case</span> PDF:
                <span class="hljs-keyword">return</span> convertMarkdownToPdf(content);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> content;
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">convertMarkdownToHtml</span><span class="hljs-params">(String markdown)</span> {
        <span class="hljs-comment">// 使用commonmark库进行转换</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;html&gt;&lt;body&gt;"</span> + markdown + <span class="hljs-string">"&lt;/body&gt;&lt;/html&gt;"</span>;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">convertMarkdownToPdf</span><span class="hljs-params">(String markdown)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 使用iText或wkhtmltopdf进行转换</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"PDF内容"</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ReportFormat</span> {
    MARKDOWN,
    HTML,
    PDF
}
</code></pre>
<h3 data-id="heading-16">5.2 诊断报告生成Skill</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 诊断报告生成Skill
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagnosticReportGenerationSkill</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AgentSkill</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(DiagnosticReportGenerationSkill.class);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReportTemplateEngine templateEngine;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MemoryDiagnosticSkill memoryDiagnosticSkill;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SkillFileSystem fileSystem;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DiagnosticReportGenerationSkill</span><span class="hljs-params">(
            ReportTemplateEngine templateEngine,
            MemoryDiagnosticSkill memoryDiagnosticSkill,
            SkillFileSystem fileSystem)</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"diagnostic_report_generation"</span>);
        <span class="hljs-built_in">this</span>.templateEngine = templateEngine;
        <span class="hljs-built_in">this</span>.memoryDiagnosticSkill = memoryDiagnosticSkill;
        <span class="hljs-built_in">this</span>.fileSystem = fileSystem;
    }
    
    <span class="hljs-comment">/**
     * 生成完整的诊断报告
     */</span>
    <span class="hljs-keyword">public</span> DiagnosticReport <span class="hljs-title function_">generateFullReport</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        logger.info(<span class="hljs-string">"生成诊断报告..."</span>);
        
        DiagnosticReport.<span class="hljs-type">Builder</span> <span class="hljs-variable">reportBuilder</span> <span class="hljs-operator">=</span> DiagnosticReport.builder()
            .timestamp(LocalDateTime.now())
            .version(<span class="hljs-string">"1.0"</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// Step 1: 执行诊断</span>
            <span class="hljs-type">MemoryDiagnosticReport</span> <span class="hljs-variable">memoryReport</span> <span class="hljs-operator">=</span> memoryDiagnosticSkill.diagnose();
            reportBuilder.memoryReport(memoryReport);
            
            <span class="hljs-comment">// Step 2: 准备报告数据</span>
            Map&lt;String, Object&gt; reportData = prepareReportData(memoryReport);
            
            <span class="hljs-comment">// Step 3: 生成Markdown报告</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">markdownContent</span> <span class="hljs-operator">=</span> templateEngine.generateReport(
                <span class="hljs-string">"diagnostic_template"</span>,
                reportData,
                ReportFormat.MARKDOWN
            );
            reportBuilder.markdownContent(markdownContent);
            
            <span class="hljs-comment">// Step 4: 转换为其他格式</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">htmlContent</span> <span class="hljs-operator">=</span> templateEngine.generateReport(
                <span class="hljs-string">"diagnostic_template"</span>,
                reportData,
                ReportFormat.HTML
            );
            reportBuilder.htmlContent(htmlContent);
            
            <span class="hljs-comment">// Step 5: 保存报告文件</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">reportPath</span> <span class="hljs-operator">=</span> saveReport(markdownContent, htmlContent);
            reportBuilder.reportPath(reportPath);
            
            reportBuilder.status(<span class="hljs-string">"SUCCESS"</span>);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"报告生成失败"</span>, e);
            reportBuilder.status(<span class="hljs-string">"FAILED"</span>).error(e.getMessage());
        }
        
        <span class="hljs-keyword">return</span> reportBuilder.build();
    }
    
    <span class="hljs-comment">/**
     * 准备报告数据
     */</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">prepareReportData</span><span class="hljs-params">(MemoryDiagnosticReport memoryReport)</span> {
        Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 执行摘要</span>
        data.put(<span class="hljs-string">"report_title"</span>, <span class="hljs-string">"AIOps诊断报告"</span>);
        data.put(<span class="hljs-string">"report_date"</span>, LocalDate.now().format(DateTimeFormatter.ISO_DATE));
        data.put(<span class="hljs-string">"report_time"</span>, LocalTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"HH:mm:ss"</span>)));
        
        <span class="hljs-comment">// 内存诊断结果</span>
        <span class="hljs-type">MemoryStatistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> memoryReport.getStatistics();
        data.put(<span class="hljs-string">"total_memory"</span>, formatBytes(stats.getTotalMemory()));
        data.put(<span class="hljs-string">"used_memory"</span>, formatBytes(stats.getUsedMemory()));
        data.put(<span class="hljs-string">"memory_usage_percent"</span>, String.format(<span class="hljs-string">"%.1f%%"</span>, 
            (<span class="hljs-type">double</span>) stats.getUsedMemory() / stats.getTotalMemory() * <span class="hljs-number">100</span>));
        
        <span class="hljs-comment">// 诊断建议</span>
        data.put(<span class="hljs-string">"recommendations"</span>, memoryReport.getRecommendations());
        
        <span class="hljs-comment">// 进程信息</span>
        List&lt;Map&lt;String, Object&gt;&gt; processesData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (ProcessMemoryInfo proc : memoryReport.getTopProcesses()) {
            Map&lt;String, Object&gt; procData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            procData.put(<span class="hljs-string">"pid"</span>, proc.getPid());
            procData.put(<span class="hljs-string">"user"</span>, proc.getUser());
            procData.put(<span class="hljs-string">"memory"</span>, formatBytes(proc.getMemoryRss()));
            procData.put(<span class="hljs-string">"command"</span>, proc.getCommand());
            processesData.add(procData);
        }
        data.put(<span class="hljs-string">"top_processes"</span>, processesData);
        
        <span class="hljs-keyword">return</span> data;
    }
    
    <span class="hljs-comment">/**
     * 保存报告文件
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">saveReport</span><span class="hljs-params">(String markdownContent, String htmlContent)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyyMMdd_HHmmss"</span>));
        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> <span class="hljs-string">"diagnostic_report_"</span> + timestamp;
        
        <span class="hljs-type">File</span> <span class="hljs-variable">reportsDir</span> <span class="hljs-operator">=</span> fileSystem.getOutputDir();
        
        <span class="hljs-comment">// 保存Markdown</span>
        Files.write(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(reportsDir, filename + <span class="hljs-string">".md"</span>).toPath(),
            markdownContent.getBytes(StandardCharsets.UTF_8)
        );
        
        <span class="hljs-comment">// 保存HTML</span>
        Files.write(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(reportsDir, filename + <span class="hljs-string">".html"</span>).toPath(),
            htmlContent.getBytes(StandardCharsets.UTF_8)
        );
        
        logger.info(<span class="hljs-string">"报告已保存: {}"</span>, reportsDir.getAbsolutePath());
        
        <span class="hljs-keyword">return</span> reportsDir.getAbsolutePath() + <span class="hljs-string">"/"</span> + filename;
    }
    
    <span class="hljs-comment">/**
     * 格式化字节大小
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatBytes</span><span class="hljs-params">(<span class="hljs-type">long</span> bytes)</span> {
        <span class="hljs-keyword">if</span> (bytes &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"0 B"</span>;
        <span class="hljs-keyword">final</span> String[] units = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"B"</span>, <span class="hljs-string">"KB"</span>, <span class="hljs-string">"MB"</span>, <span class="hljs-string">"GB"</span>, <span class="hljs-string">"TB"</span>};
        <span class="hljs-type">int</span> <span class="hljs-variable">digitGroups</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.log10(bytes) / Math.log10(<span class="hljs-number">1024</span>));
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1f %s"</span>, bytes / Math.pow(<span class="hljs-number">1024</span>, digitGroups), units[digitGroups]);
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagnosticReport</span> {
    <span class="hljs-keyword">private</span> LocalDateTime timestamp;
    <span class="hljs-keyword">private</span> String version;
    <span class="hljs-keyword">private</span> MemoryDiagnosticReport memoryReport;
    <span class="hljs-keyword">private</span> String markdownContent;
    <span class="hljs-keyword">private</span> String htmlContent;
    <span class="hljs-keyword">private</span> String reportPath;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> String error;
}
</code></pre>
<hr/>
<h2 data-id="heading-17">6. AIOps诊断和报告生成的集成示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * AIOps诊断和报告生成的集成
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AIOpsDiagnosticSystem</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(AIOpsDiagnosticSystem.class);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SandboxClient sandboxClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SkillFileSystem fileSystem;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ToolRegistry toolRegistry;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MemoryDiagnosticSkill memoryDiagnosticSkill;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DiagnosticReportGenerationSkill reportGenerationSkill;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AIOpsDiagnosticSystem</span><span class="hljs-params">(String runtimeServerHost, <span class="hljs-type">int</span> runtimeServerPort)</span> <span class="hljs-keyword">throws</span> Exception {
        logger.info(<span class="hljs-string">"初始化AIOps诊断系统..."</span>);
        
        <span class="hljs-comment">// 初始化Sandbox客户端</span>
        <span class="hljs-built_in">this</span>.sandboxClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SandboxClient</span>(runtimeServerHost, runtimeServerPort);
        
        <span class="hljs-comment">// 初始化文件系统</span>
        <span class="hljs-built_in">this</span>.fileSystem = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillFileSystem</span>(<span class="hljs-string">"/tmp/skill_workspace"</span>);
        fileSystem.initializeSkillDirs(<span class="hljs-string">"aiops_diagnostics"</span>, <span class="hljs-string">"diagnostic_reporting"</span>);
        
        <span class="hljs-comment">// 初始化工具注册表</span>
        <span class="hljs-built_in">this</span>.toolRegistry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolRegistry</span>();
        registerCustomTools();
        
        <span class="hljs-comment">// 初始化诊断Skill</span>
        <span class="hljs-built_in">this</span>.memoryDiagnosticSkill = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryDiagnosticSkill</span>(
            sandboxClient, fileSystem, toolRegistry
        );
        
        <span class="hljs-comment">// 初始化报告生成Skill</span>
        <span class="hljs-type">ReportTemplateEngine</span> <span class="hljs-variable">templateEngine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReportTemplateEngine</span>(fileSystem);
        <span class="hljs-built_in">this</span>.reportGenerationSkill = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiagnosticReportGenerationSkill</span>(
            templateEngine, memoryDiagnosticSkill, fileSystem
        );
        
        logger.info(<span class="hljs-string">"✓ AIOps诊断系统初始化完成"</span>);
    }
    
    <span class="hljs-comment">/**
     * 注册自定义工具
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerCustomTools</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ToolContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolContext</span>();
        context.setWorkspaceRoot(fileSystem.getWorkspaceRoot());
        context.setTimeout(<span class="hljs-number">30000</span>);
        
        <span class="hljs-comment">// 注册日志解析工具</span>
        toolRegistry.registerCustomTool(<span class="hljs-string">"log_parser"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogParserTool</span>(context));
        
        <span class="hljs-comment">// 注册指标聚合工具</span>
        toolRegistry.registerCustomTool(<span class="hljs-string">"metric_aggregator"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetricAggregatorTool</span>(context));
        
        logger.info(<span class="hljs-string">"✓ 自定义工具注册完成"</span>);
    }
    
    <span class="hljs-comment">/**
     * 执行完整的诊断和报告流程
     */</span>
    <span class="hljs-keyword">public</span> DiagnosticReport <span class="hljs-title function_">runFullDiagnostics</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        logger.info(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
        logger.info(<span class="hljs-string">"开始AIOps诊断和报告生成"</span>);
        logger.info(<span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// Step 1: 执行诊断</span>
            logger.info(<span class="hljs-string">"\n【Step 1】执行诊断..."</span>);
            <span class="hljs-type">MemoryDiagnosticReport</span> <span class="hljs-variable">memoryReport</span> <span class="hljs-operator">=</span> memoryDiagnosticSkill.diagnose();
            logger.info(<span class="hljs-string">"✓ 诊断完成，状态: {}"</span>, memoryReport.getStatus());
            
            <span class="hljs-comment">// Step 2: 生成报告</span>
            logger.info(<span class="hljs-string">"\n【Step 2】生成报告..."</span>);
            <span class="hljs-type">DiagnosticReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> reportGenerationSkill.generateFullReport();
            logger.info(<span class="hljs-string">"✓ 报告生成完成，已保存到: {}"</span>, report.getReportPath());
            
            <span class="hljs-comment">// Step 3: 输出总结</span>
            logger.info(<span class="hljs-string">"\n【Step 3】诊断总结"</span>);
            logger.info(<span class="hljs-string">"总内存: {}"</span>, formatBytes(memoryReport.getStatistics().getTotalMemory()));
            logger.info(<span class="hljs-string">"已用内存: {}"</span>, formatBytes(memoryReport.getStatistics().getUsedMemory()));
            logger.info(<span class="hljs-string">"内存使用率: {:.1f}%"</span>,
                (<span class="hljs-type">double</span>) memoryReport.getStatistics().getUsedMemory() / 
                memoryReport.getStatistics().getTotalMemory() * <span class="hljs-number">100</span>);
            
            logger.info(<span class="hljs-string">"\n诊断建议:"</span>);
            <span class="hljs-keyword">for</span> (String recommendation : memoryReport.getRecommendations()) {
                logger.info(<span class="hljs-string">"  {}"</span>, recommendation);
            }
            
            logger.info(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
            logger.info(<span class="hljs-string">"诊断和报告生成成功"</span>);
            logger.info(<span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>));
            
            <span class="hljs-keyword">return</span> report;
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"诊断失败"</span>, e);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatBytes</span><span class="hljs-params">(<span class="hljs-type">long</span> bytes)</span> {
        <span class="hljs-keyword">if</span> (bytes &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"0 B"</span>;
        <span class="hljs-keyword">final</span> String[] units = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"B"</span>, <span class="hljs-string">"KB"</span>, <span class="hljs-string">"MB"</span>, <span class="hljs-string">"GB"</span>, <span class="hljs-string">"TB"</span>};
        <span class="hljs-type">int</span> <span class="hljs-variable">digitGroups</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Math.log10(bytes) / Math.log10(<span class="hljs-number">1024</span>));
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%.1f %s"</span>, bytes / Math.pow(<span class="hljs-number">1024</span>, digitGroups), units[digitGroups]);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 连接到Runtime Server</span>
        <span class="hljs-type">AIOpsDiagnosticSystem</span> <span class="hljs-variable">system</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AIOpsDiagnosticSystem</span>(
            <span class="hljs-string">"localhost"</span>,  <span class="hljs-comment">// Runtime Server主机</span>
            <span class="hljs-number">50051</span>         <span class="hljs-comment">// Runtime Server端口</span>
        );
        
        <span class="hljs-comment">// 运行诊断</span>
        <span class="hljs-type">DiagnosticReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> system.runFullDiagnostics();
        
        <span class="hljs-comment">// 可以进一步处理报告...</span>
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm patch 实用指南：依赖包临时修复的正确姿势]]></title>    <link>https://juejin.cn/post/7590735421262135337</link>    <guid>https://juejin.cn/post/7590735421262135337</guid>    <pubDate>2026-01-04T03:31:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590735421262135337" data-draft-id="7590283328177684523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm patch 实用指南：依赖包临时修复的正确姿势"/> <meta itemprop="keywords" content="前端工程化,NPM"/> <meta itemprop="datePublished" content="2026-01-04T03:31:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="eason_fan"/> <meta itemprop="url" content="https://juejin.cn/user/2995517308808877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm patch 实用指南：依赖包临时修复的正确姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2995517308808877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    eason_fan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:31:36.000Z" title="Sun Jan 04 2026 03:31:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">npm patch 实用指南：依赖包临时修复的正确姿势</h2>
<p>在日常开发中，你是否遇到过这样的窘境：项目依赖的第三方包突然爆出 bug，导致功能异常，但上游作者迟迟未发布修复版本？直接修改 <code>node_modules</code> 里的代码虽然快捷，却会在下次 <code>npm install</code> 时被覆盖；fork 仓库自己维护又过于繁琐。</p>
<p>这时，<code>npm patch</code> 工作流程就能帮你解决燃眉之急。本文将详细拆解它的核心逻辑、使用方法和最佳实践，让你轻松搞定依赖包的临时修复。</p>
<h3 data-id="heading-1">一、什么是 npm patch 工作流程？</h3>
<p>首先要明确：<code>npm patch</code> 并不是 npm 官方提供的单一命令，而是一套「临时修复依赖包 + 持久化补丁」的解决方案。其核心思路是：</p>
<ol>
<li>直接在本地 <code>node_modules</code> 中修改依赖包的问题代码，先让项目正常运行；</li>
<li>通过工具生成「补丁文件」，记录你的修改差异；</li>
<li>将补丁文件提交到项目仓库，供团队成员共享；</li>
<li>配置自动脚本，确保每次 <code>npm install</code> 后自动应用补丁。</li>
</ol>
<p>简单说，它就是给依赖包打「临时补丁」的标准化流程，既能解决当下问题，又能避免修改被覆盖，还能让团队协作不受影响。</p>
<h3 data-id="heading-2">二、核心工具：patch-package</h3>
<p>实现这套工作流程最流行、最易用的工具是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fds300%2Fpatch-package" target="_blank" title="https://github.com/ds300/patch-package" ref="nofollow noopener noreferrer">patch-package</a>（第三方包）。它能自动对比修改前后的文件差异，生成标准补丁，还能通过 npm 钩子自动应用补丁，完美适配 npm/yarn/pnpm 等包管理器。</p>
<h4 data-id="heading-3">2.1 安装 patch-package</h4>
<p>将其作为开发依赖安装到项目中：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># npm 安装</span>
npm install patch-<span class="hljs-keyword">package</span> --save-dev

<span class="hljs-comment"># yarn 安装</span>
yarn add patch-<span class="hljs-keyword">package</span> --dev

<span class="hljs-comment"># pnpm 安装</span>
pnpm add patch-<span class="hljs-keyword">package</span> -D
</code></pre>
<h3 data-id="heading-4">三、npm patch 完整使用步骤</h3>
<p>假设我们的项目依赖了 <code>some-library@1.2.3</code>，并发现该包存在一个影响功能的 bug，需要临时修复。</p>
<h4 data-id="heading-5">步骤 1：直接修改 node_modules 中的依赖包</h4>
<p>找到 <code>node_modules/some-library</code> 目录，定位到有问题的文件（比如 <code>src/index.js</code>），直接修改代码并测试，确保项目能正常运行。</p>
<p>⚠️ 注意：这一步只是临时修复，修改会在下次 <code>npm install</code> 时被覆盖，所以后续必须生成补丁。</p>
<h4 data-id="heading-6">步骤 2：生成补丁文件</h4>
<p>修改完成后，回到项目根目录，运行以下命令生成补丁：</p>
<pre><code class="hljs language-go" lang="go"># 语法：npx patch-<span class="hljs-keyword">package</span> &lt;包名&gt;
npx patch-<span class="hljs-keyword">package</span> some-library
</code></pre>
<p>执行成功后，项目根目录会自动创建 <code>patches</code> 文件夹，里面会生成一个以「包名+版本号」命名的补丁文件，比如 <code>some-library+1.2.3.patch</code>。</p>
<p>这个 <code>.patch</code> 文件是文本文件，记录了修改前后的代码差异（类似 Git 的 diff 文件），可以直接打开查看。</p>
<p>✅ 关键操作：将 <code>patches</code> 文件夹和补丁文件一起提交到 Git 仓库，让团队其他成员也能使用这个补丁。</p>
<h4 data-id="heading-7">步骤 3：配置自动应用补丁</h4>
<p>为了让每次 <code>npm install</code>（或 yarn/pnpm install）后自动应用补丁，需要在 <code>package.json</code> 中添加 <code>postinstall</code> 脚本。</p>
<p><code>postinstall</code> 是 npm 的特殊钩子，会在依赖安装完成后自动执行。修改 <code>package.json</code> 的 <code>scripts</code> 字段：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-scripts start"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"react-scripts build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"postinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"patch-package"</span> <span class="hljs-comment">// 新增：自动应用补丁</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"some-library"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.2.3"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"patch-package"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^8.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-8">步骤 4：验证补丁效果</h4>
<p>为了确保补丁能正常工作，可以测试以下流程：</p>
<ol>
<li>删除项目的 <code>node_modules</code> 文件夹和 <code>package-lock.json</code>（或 <code>yarn.lock</code>）；</li>
<li>重新运行 <code>npm install</code>；</li>
<li>查看控制台输出，会看到 <code>patch-package</code> 正在应用补丁的日志；</li>
<li>打开 <code>node_modules/some-library</code> 中的目标文件，确认修改已被正确应用。</li>
</ol>
<h3 data-id="heading-9">四、完整示例：给 lodash 打补丁（演示用）</h3>
<p>为了让大家更直观理解，我们以「给 lodash 打演示补丁」为例，完整走一遍流程。</p>
<h4 data-id="heading-10">1. 安装依赖</h4>
<pre><code class="hljs language-lua" lang="lua"># 安装 lodash（目标依赖）
npm install lodash

# 安装 patch-<span class="hljs-built_in">package</span>（开发依赖）
npm install patch-<span class="hljs-built_in">package</span> <span class="hljs-comment">--save-dev</span>
</code></pre>
<h4 data-id="heading-11">2. 配置 postinstall 脚本</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"postinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"patch-package"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-12">3. 修改 node_modules 中的 lodash</h4>
<p>打开 <code>node_modules/lodash/lodash.js</code>，在文件开头添加一行注释（演示修改）：</p>
<pre><code class="hljs language-markdown" lang="markdown">// 临时补丁：演示用注释
/**
<span class="hljs-bullet"> *</span> @license
<span class="hljs-bullet"> *</span> Lodash (Custom Build) <span class="xml">&lt;https://lodash.com/&gt;</span>
<span class="hljs-bullet"> *</span> Build: <span class="hljs-code">`lodash modularize exports="npm" -o ./`</span>
<span class="hljs-bullet"> *</span> Copyright JS Foundation and other contributors <span class="xml">&lt;https://js.foundation/&gt;</span>
<span class="hljs-bullet"> *</span> Released under MIT license <span class="xml">&lt;https://lodash.com/license&gt;</span>
 <span class="hljs-emphasis">*/
</span></code></pre>
<h4 data-id="heading-13">4. 生成补丁</h4>
<pre><code class="hljs language-go" lang="go">npx patch-<span class="hljs-keyword">package</span> lodash
</code></pre>
<p>此时项目根目录会生成 <code>patches/lodash+4.17.21.patch</code>（版本号以实际安装为准）。</p>
<h4 data-id="heading-14">5. 验证</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除依赖和锁文件</span>
<span class="hljs-built_in">rm</span> -rf node_modules package-lock.json

<span class="hljs-comment"># 重新安装依赖</span>
npm install

<span class="hljs-comment"># 查看修改是否生效</span>
<span class="hljs-built_in">cat</span> node_modules/lodash/lodash.js | <span class="hljs-built_in">head</span> -10
</code></pre>
<p>输出结果中会包含我们添加的注释，说明补丁应用成功。</p>
<h3 data-id="heading-15">五、最佳实践与注意事项</h3>
<h4 data-id="heading-16">1. 仅作为临时方案</h4>
<p>npm patch 的核心作用是「临时救急」，而不是替代上游修复。一旦上游包发布了包含修复的新版本，你应该：</p>
<ol>
<li>将项目中依赖的版本升级到新版本；</li>
<li>删除 <code>patches</code> 文件夹中对应的补丁文件；</li>
<li>提交这些修改到 Git 仓库。</li>
</ol>
<h4 data-id="heading-17">2. 补丁与版本绑定</h4>
<p>补丁文件名包含版本号（如 <code>some-library+1.2.3.patch</code>），这意味着：</p>
<ul>
<li>如果升级了依赖包版本（比如从 1.2.3 到 1.2.4），旧补丁不会自动应用（防止旧补丁破坏新版本）；</li>
<li>如果确认补丁对新版本仍适用，可以手动修改补丁文件名（将版本号改为新的），并重新测试。</li>
</ul>
<h4 data-id="heading-18">3. 安全性提醒</h4>
<p>patch-package 直接修改 <code>node_modules</code>中的文件，相比修改依赖树的工具（如 npm-force-resolutions）更透明，但仍需注意：</p>
<ul>
<li>只给信任的包打补丁，避免修改未知来源的依赖代码；</li>
<li>补丁文件要提交到仓库，方便团队审查，避免恶意修改。</li>
</ul>
<h4 data-id="heading-19">4. 跨包管理器兼容</h4>
<p>patch-package 支持 npm、yarn、pnpm，但使用 pnpm 时需要额外配置 <code>package.json</code>：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"postinstall"</span>: <span class="hljs-string">"patch-package"</span>
  },
  <span class="hljs-string">"pnpm"</span>: {
    <span class="hljs-string">"patchedDependencies"</span>: {
      <span class="hljs-string">"some-library@1.2.3"</span>: <span class="hljs-string">"patches/some-library+1.2.3.patch"</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-20">六、总结</h3>
<p>npm patch 工作流程（基于 patch-package）是前端开发中解决「依赖包临时修复」的高效方案，核心优势是：</p>
<ul>
<li>简单快捷：无需 fork 仓库，直接修改 + 生成补丁即可；</li>
<li>持久化：补丁文件提交到仓库，团队共享无压力；</li>
<li>自动化：通过 postinstall 钩子，安装依赖后自动应用。</li>
</ul>
<p>记住，它是临时方案，最终还是要依赖上游作者的正式修复。合理使用这个工具，可以帮你在开发中少走很多弯路～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[js 严格模式]]></title>    <link>https://juejin.cn/post/7590330924002623551</link>    <guid>https://juejin.cn/post/7590330924002623551</guid>    <pubDate>2026-01-04T03:44:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924002623551" data-draft-id="7591177139661193270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="js 严格模式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-04T03:44:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            js 严格模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:44:32.000Z" title="Sun Jan 04 2026 03:44:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、什么是严格模式</h3>
<p>严格模式是 ECMAScript 5 引入的一种代码运行模式，它通过<strong>限制一些不规范的语法行为、禁止某些潜在的错误操作、抛出更多明确的异常</strong>，来让代码运行更安全、更规范，同时也为后续的 ES 版本特性提供了更好的兼容性。</p>
<p>简单来说，严格模式就是给 JavaScript 代码加上了一套「语法约束规则」，让开发者更早发现代码中的问题，减少隐蔽的 bug。</p>
<h3 data-id="heading-1">二、如何启用严格模式</h3>
<p>严格模式的启用分为「全局启用」和「局部启用」（推荐局部启用），语法非常简单，使用字符串指令 <code>"use strict";</code>（单双引号均可，也可写成 <code>'use strict';</code>）。</p>
<h4 data-id="heading-2">1. 全局启用（不推荐，存在隐患）</h4>
<p>将 <code>"use strict";</code> 放在脚本文件的<strong>最顶部</strong>（在任何其他代码之前），则整个脚本文件内的代码都将运行在严格模式下。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全局启用严格模式（脚本最顶部，无任何代码前置）</span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;
a = <span class="hljs-number">20</span>; <span class="hljs-comment">// 正常执行</span>
</code></pre>
<p><strong>隐患</strong>：如果该脚本文件被其他非严格模式的脚本引入，可能会影响其他脚本的运行；同时，全局严格模式会污染整个作用域，不利于代码模块化。</p>
<h4 data-id="heading-3">2. 局部启用（推荐，模块化隔离）</h4>
<p>将 <code>"use strict";</code> 放在<strong>函数体的最顶部</strong>，则仅该函数内部的代码运行在严格模式下，外部代码不受影响。这是最安全的方式，尤其适合在函数、对象方法、模块化代码中使用。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 普通模式（外部代码）</span>
function <span class="hljs-built_in">normalFunc</span>() {
  <span class="hljs-selector-tag">b</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// 普通模式下：未声明的变量会隐式挂载到 window 上，不报错</span>
}

<span class="hljs-comment">// 局部启用严格模式（函数内部最顶部）</span>
function <span class="hljs-built_in">strictFunc</span>() {
  "use strict";
  let c = <span class="hljs-number">40</span>;
  d = <span class="hljs-number">50</span>; <span class="hljs-comment">// 严格模式下：会抛出异常，禁止隐式声明全局变量</span>
}

<span class="hljs-built_in">normalFunc</span>(); <span class="hljs-comment">// 正常执行</span>
<span class="hljs-built_in">strictFunc</span>(); <span class="hljs-comment">// 报错：ReferenceError: d is not defined</span>
</code></pre>
<h3 data-id="heading-4">三、严格模式的核心特性（与普通模式的关键区别）</h3>
<p>严格模式的核心变化是「禁止不良行为」和「抛出更多异常」，以下是最常用、最关键的几个特性：</p>
<h4 data-id="heading-5">1. 禁止<strong>隐式声明全局变量</strong>（核心变化之一）</h4>
<p>普通模式下，未使用 <code>var</code>/<code>let</code>/<code>const</code> 声明的变量，会被隐式挂载到全局对象（浏览器中是 <code>window</code>）上，不会报错，这是很多全局变量污染和 bug 的根源。</p>
<p>严格模式下，<strong>未声明直接赋值的变量会抛出 <code>ReferenceError</code> 异常</strong>，强制开发者必须显式声明变量。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-comment">// 错误：未声明变量直接赋值，抛出 ReferenceError</span>
x = <span class="hljs-number">100</span>; 

<span class="hljs-comment">// 正确：显式使用 let/const/var 声明变量</span>
<span class="hljs-keyword">let</span> y = <span class="hljs-number">200</span>;
</code></pre>
<h4 data-id="heading-6">2. 禁止对<strong>只读属性 / 不可写属性</strong>赋值，禁止删除<strong>不可配置属性</strong></h4>
<p>普通模式下，对只读属性赋值、删除不可配置属性只会「静默失败」（不报错，但操作无效），很难被发现；严格模式下，这些操作会直接抛出 <code>TypeError</code> 异常，明确告知开发者操作无效。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-comment">// 1. 对只读属性赋值（报错）</span>
<span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>({}, <span class="hljs-string">"name"</span>, {
  <span class="hljs-attr">value</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 只读属性，不可修改</span>
});
obj.<span class="hljs-property">name</span> = <span class="hljs-string">"李四"</span>; <span class="hljs-comment">// 严格模式下：抛出 TypeError: Cannot assign to read only property 'name'</span>

<span class="hljs-comment">// 2. 删除不可配置属性（报错）</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"age"</span>, {
  <span class="hljs-attr">value</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 不可配置，无法删除</span>
});
<span class="hljs-keyword">delete</span> obj.<span class="hljs-property">age</span>; <span class="hljs-comment">// 严格模式下：抛出 TypeError: Cannot delete property 'age'</span>
</code></pre>
<h4 data-id="heading-7">3. 禁止<strong>删除变量 / 函数 / 函数参数</strong></h4>
<p>普通模式下，删除变量（<code>delete a</code>）只会返回 <code>false</code>，静默失败；严格模式下，<strong>删除变量、函数、函数参数会抛出 <code>SyntaxError</code> 或 <code>ReferenceError</code> 异常</strong>，只有对象的可配置属性才能被 <code>delete</code>。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">let</span> num = <span class="hljs-number">10</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {}

<span class="hljs-comment">// 错误：删除变量，抛出 SyntaxError</span>
<span class="hljs-keyword">delete</span> num; 

<span class="hljs-comment">// 错误：删除函数，抛出 SyntaxError</span>
<span class="hljs-keyword">delete</span> fn; 

<span class="hljs-comment">// 正确：删除对象的可配置属性</span>
<span class="hljs-keyword">let</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span> };
<span class="hljs-keyword">delete</span> person.<span class="hljs-property">name</span>; <span class="hljs-comment">// 执行成功，返回 true</span>
</code></pre>
<h4 data-id="heading-8">4. 禁止<strong>函数参数重名</strong></h4>
<p>普通模式下，函数参数可以重名（如 <code>function fn(a, a) {}</code>），后面的参数会覆盖前面的；严格模式下，<strong>函数参数不能重名</strong>，否则会抛出 <code>SyntaxError</code> 异常。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-comment">// 错误：参数重名，抛出 SyntaxError</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params">a, a</span>) { 
  <span class="hljs-keyword">return</span> a + a;
}

<span class="hljs-comment">// 正确：参数唯一</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fn2</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<h4 data-id="heading-9">5. <code>this</code> 指向的变化（重要区别）</h4>
<p>严格模式下，<code>this</code> 的指向与普通模式有明显不同，主要体现在两个场景：</p>
<ul>
<li>全局作用域中，普通函数的 <code>this</code> 指向全局对象（浏览器中是 <code>window</code>）；严格模式下，<strong>全局作用域中普通函数的 <code>this</code> 为 <code>undefined</code></strong>（不再指向 <code>window</code>）。</li>
<li>构造函数忘记使用 <code>new</code> 调用时，普通模式下 <code>this</code> 指向 <code>window</code>，会隐式创建全局变量；严格模式下，<strong>未使用 <code>new</code> 调用构造函数，<code>this</code> 为 <code>undefined</code>，会抛出 <code>TypeError</code> 异常</strong>。</li>
</ul>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-comment">// 场景 1：全局函数的 this 为 undefined</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">globalFunc</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 输出：undefined</span>
}
<span class="hljs-title function_">globalFunc</span>();

<span class="hljs-comment">// 场景 2：构造函数忘记 new 调用（报错）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// 严格模式下：抛出 TypeError: Cannot set property 'name' of undefined</span>
}
<span class="hljs-keyword">let</span> p = <span class="hljs-title class_">Person</span>(<span class="hljs-string">"张三"</span>); <span class="hljs-comment">// 未使用 new，直接调用</span>
</code></pre>
<h4 data-id="heading-10">6. 禁止使用一些<strong>保留字</strong>和<strong>不规范语法</strong></h4>
<p>严格模式下，禁止使用 ES 保留字作为变量名 / 函数名（如 <code>let</code>, <code>const</code>, <code>class</code>, <code>export</code>, <code>import</code> 等），同时禁止一些不规范的语法（如 <code>with</code> 语句、<code>arguments.callee</code>、<code>arguments.caller</code> 等），使用这些语法会抛出异常。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-comment">// 错误：使用 with 语句，抛出 SyntaxError（严格模式禁止 with）</span>
<span class="hljs-keyword">with</span> (<span class="hljs-title class_">Math</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sqrt</span>(<span class="hljs-number">16</span>));
}

<span class="hljs-comment">// 错误：使用 arguments.callee，抛出 TypeError（严格模式禁止）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">return</span> n &lt;= <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : n * <span class="hljs-variable language_">arguments</span>.<span class="hljs-title function_">callee</span>(n - <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-11">四、严格模式与之前 <code>for...in</code> 中 <code>const</code> 的关联</h3>
<p>补充说明你上一个问题中 <code>for...in</code> 循环使用 <code>const</code> 与严格模式的关系：</p>
<ol>
<li><code>for...in</code>/<code>for...of</code> 循环中使用 <code>const</code> 声明迭代变量，<strong>在严格模式和普通模式下都可以正常运行</strong>，不会因为严格模式而报错；</li>
<li>严格模式不会改变「<code>for...in</code> 每次迭代创建全新变量绑定」的机制，<code>const</code> 声明的迭代变量依然符合「不重新赋值」的约束，因此可以正常使用；</li>
<li>反而，严格模式会禁止 <code>for...in</code> 循环中一些不规范的操作（如迭代变量未声明），让代码更严谨。</li>
</ol>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-comment">// 严格模式下，for...in 用 const 声明迭代变量，正常执行</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> propName <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(propName);
}
</code></pre>
<h3 data-id="heading-12">总结</h3>
<ol>
<li>严格模式通过 <code>"use strict";</code> 启用，推荐<strong>局部（函数内）启用</strong>，避免污染全局作用域；</li>
<li>核心特性是「禁止不良行为、抛出更多异常」，关键包括禁止隐式全局变量、禁止参数重名、<code>this</code> 指向变化等；</li>
<li>严格模式让代码更安全、更规范，减少隐蔽 bug，是现代 JavaScript 开发的良好实践；</li>
<li><code>for...in</code> 中使用 <code>const</code> 在严格模式下完全兼容，不受严格模式影响。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 实现分片上传、断点续传与进度条]]></title>    <link>https://juejin.cn/post/7590403249562140687</link>    <guid>https://juejin.cn/post/7590403249562140687</guid>    <pubDate>2026-01-04T03:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249562140687" data-draft-id="7590778284758384675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 实现分片上传、断点续传与进度条"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-04T03:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="点我设置昵称"/> <meta itemprop="url" content="https://juejin.cn/user/2386363528256733"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 实现分片上传、断点续传与进度条
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2386363528256733/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    点我设置昵称
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T03:43:43.000Z" title="Sun Jan 04 2026 03:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Spring Boot 实现分片上传、断点续传与进度条</p>
<hr/>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># Spring Boot 实现分片上传、断点续传与进度条  </span>
<span class="hljs-section">## —— 支持 MinIO / RustFS / SeaweedFS 可配置切换</span>

在大文件上传场景下，传统单次上传存在明显问题：

<span class="hljs-bullet">-</span> 文件过大，失败后需要整体重传
<span class="hljs-bullet">-</span> 网络不稳定，用户体验差
<span class="hljs-bullet">-</span> 无法展示上传进度

本文基于 <span class="hljs-strong">**Spring Boot**</span>，实现一套<span class="hljs-strong">**生产可用**</span>的大文件上传方案，支持：

<span class="hljs-bullet">-</span> 分片上传
<span class="hljs-bullet">-</span> 断点续传
<span class="hljs-bullet">-</span> 上传进度查询
<span class="hljs-bullet">-</span> MinIO / RustFS / SeaweedFS / 本地存储
<span class="hljs-bullet">-</span> 通过 yml 配置文件切换存储类型

---

<span class="hljs-section">## 一、整体架构设计</span>

系统整体采用「接口隔离 + 策略模式」设计：

</code></pre>
<blockquote>
<p>Controller
↓
UploadService
↓
StorageService（统一抽象）
↓
MinIO / RustFS / SeaweedFS / Local</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-string">**核心思想：上传逻辑与底层存储解耦。**</span>

<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 二、统一配置设计</span>

<span class="hljs-comment">### 1. 存储类型切换</span>

<span class="hljs-string">```yaml</span>
<span class="hljs-attr">file:</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">file/</span>
  <span class="hljs-attr">prefix:</span> <span class="hljs-string">pre</span>
  <span class="hljs-attr">domain:</span> <span class="hljs-string">domain/</span>
  <span class="hljs-attr">storage:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">minio</span>   <span class="hljs-comment"># minio / rustfs / seaweedfs / local</span>
</code></pre>
<p>只需修改 <code>storage.type</code>，即可切换存储实现。</p>
<hr/>
<h3 data-id="heading-0">2. MinIO 配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">minio:</span>
  <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:9000</span>
  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">minioadmin</span>
  <span class="hljs-attr">secretKey:</span> <span class="hljs-string">minioadmin123</span>
  <span class="hljs-attr">bucketName:</span> <span class="hljs-string">xxx</span>
</code></pre>
<hr/>
<h3 data-id="heading-1">3. RustFS 配置（S3 协议）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">rustfs:</span>
  <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:9000</span>
  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">rustfsadmin</span>
  <span class="hljs-attr">secretKey:</span> <span class="hljs-string">rustfsadmin</span>
  <span class="hljs-attr">bucketName:</span> <span class="hljs-string">xxx</span>
</code></pre>
<blockquote>
<p>RustFS 兼容 S3 协议，可直接复用 MinIO SDK。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">4. SeaweedFS 配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">seaweedfs:</span>
  <span class="hljs-attr">url:</span> <span class="hljs-string">http://127.0.0.1:8333</span>
  <span class="hljs-attr">accessKey:</span> <span class="hljs-string">weed</span>
  <span class="hljs-attr">secretKey:</span> <span class="hljs-string">weed</span>
  <span class="hljs-attr">bucketName:</span> <span class="hljs-string">xxx</span>
</code></pre>
<hr/>
<h2 data-id="heading-3">三、分片上传核心流程</h2>
<h3 data-id="heading-4">1. 前端切片思路</h3>
<p>前端将大文件切割为多个分片（如 5MB）：</p>
<pre><code class="hljs">file
├── chunk_0
├── chunk_1
├── chunk_2
└── chunk_n
</code></pre>
<p>每个分片上传时携带：</p>
<ul>
<li>文件唯一标识（guid / md5）</li>
<li>分片索引（chunkIndex）</li>
<li>总分片数（totalChunk）</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. 分片上传接口</h3>
<pre><code class="hljs language-http" lang="http">POST /file/chunk/upload
</code></pre>
<hr/>
<h2 data-id="heading-6">四、断点续传实现</h2>
<h3 data-id="heading-7">1. 查询已上传分片</h3>
<pre><code class="hljs language-http" lang="http">GET /file/chunk/uploaded?guid=xxx
</code></pre>
<p>返回示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-number">5</span><span class="hljs-punctuation">]</span>
</code></pre>
<p>前端只上传缺失分片即可。</p>
<hr/>
<h3 data-id="heading-8">2. 实现原则</h3>
<ul>
<li>是否已上传以「存储层」为准</li>
<li>不依赖内存或 Redis</li>
<li>服务重启不影响续传</li>
</ul>
<hr/>
<h2 data-id="heading-9">五、上传进度计算</h2>
<pre><code class="hljs language-text" lang="text">进度 = 已上传分片数 / 总分片数 × 100%
</code></pre>
<p>示例返回：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uploaded"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"percent"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-10">六、存储层抽象设计</h2>
<h3 data-id="heading-11">1. 统一接口定义</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StorageService</span> {

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadChunk</span><span class="hljs-params">(String path, InputStream inputStream)</span>;

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">exists</span><span class="hljs-params">(String path)</span>;

    List&lt;Integer&gt; <span class="hljs-title function_">listChunks</span><span class="hljs-params">(String prefix)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">mergeChunks</span><span class="hljs-params">(String chunkPrefix, String targetPath, <span class="hljs-type">int</span> totalChunk)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteChunks</span><span class="hljs-params">(String chunkPrefix)</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-12">2. MinIO / RustFS 实现（S3 通用）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinioStorageService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StorageService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MinioClient minioClient;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String bucket;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MinioStorageService</span><span class="hljs-params">(MinioClient client, String bucket)</span> {
        <span class="hljs-built_in">this</span>.minioClient = client;
        <span class="hljs-built_in">this</span>.bucket = bucket;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadChunk</span><span class="hljs-params">(String path, InputStream inputStream)</span> {
        <span class="hljs-keyword">try</span> {
            minioClient.putObject(
                PutObjectArgs.builder()
                    .bucket(bucket)
                    .object(path)
                    .stream(inputStream, -<span class="hljs-number">1</span>, <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)
                    .build()
            );
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"分片上传失败"</span>, e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">exists</span><span class="hljs-params">(String path)</span> {
        <span class="hljs-keyword">try</span> {
            minioClient.statObject(
                StatObjectArgs.builder()
                    .bucket(bucket)
                    .object(path)
                    .build()
            );
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">listChunks</span><span class="hljs-params">(String prefix)</span> {
        List&lt;Integer&gt; chunks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        Iterable&lt;Result&lt;Item&gt;&gt; results =
            minioClient.listObjects(
                ListObjectsArgs.builder()
                    .bucket(bucket)
                    .prefix(prefix)
                    .build()
            );

        <span class="hljs-keyword">for</span> (Result&lt;Item&gt; r : results) {
            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> r.get().objectName();
            chunks.add(Integer.parseInt(
                name.substring(name.lastIndexOf(<span class="hljs-string">"_"</span>) + <span class="hljs-number">1</span>)));
        }
        <span class="hljs-keyword">return</span> chunks;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mergeChunks</span><span class="hljs-params">(String chunkPrefix,
                            String targetPath,
                            <span class="hljs-type">int</span> totalChunk)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; totalChunk; i++) {
                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> minioClient.getObject(
                    GetObjectArgs.builder()
                        .bucket(bucket)
                        .object(chunkPrefix + <span class="hljs-string">"/chunk_"</span> + i)
                        .build()
                );
                IOUtils.copy(in, out);
            }
            uploadChunk(
                targetPath,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(out.toByteArray()));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"分片合并失败"</span>, e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteChunks</span><span class="hljs-params">(String chunkPrefix)</span> {
        <span class="hljs-comment">// 可按需实现批量删除</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">七、业务 Service 实现</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FileUploadService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StorageService storageService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadChunk</span><span class="hljs-params">(ChunkUploadDTO dto)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> dto.getGuid() + <span class="hljs-string">"/chunk_"</span> + dto.getChunkIndex();
        <span class="hljs-keyword">if</span> (storageService.exists(path)) {
            <span class="hljs-keyword">return</span>;
        }
        storageService.uploadChunk(
            path, dto.getFile().getInputStream());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">uploadedChunks</span><span class="hljs-params">(String guid)</span> {
        <span class="hljs-keyword">return</span> storageService.listChunks(guid + <span class="hljs-string">"/"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">(String guid, <span class="hljs-type">int</span> totalChunk)</span> {
        storageService.mergeChunks(
            guid, guid + <span class="hljs-string">".final"</span>, totalChunk);
        storageService.deleteChunks(guid + <span class="hljs-string">"/"</span>);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-14">八、Controller 接口</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/file/chunk")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> FileUploadService fileUploadService;

    <span class="hljs-meta">@PostMapping("/upload")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">upload</span><span class="hljs-params">(ChunkUploadDTO dto)</span> <span class="hljs-keyword">throws</span> IOException {
        fileUploadService.uploadChunk(dto);
    }

    <span class="hljs-meta">@GetMapping("/uploaded")</span>
    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">uploaded</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String guid)</span> {
        <span class="hljs-keyword">return</span> fileUploadService.uploadedChunks(guid);
    }

    <span class="hljs-meta">@PostMapping("/merge")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String guid,
                      <span class="hljs-meta">@RequestParam</span> Integer totalChunk)</span> {
        fileUploadService.merge(guid, totalChunk);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-15">九、总结</h2>
<p>本文实现了一套 <strong>Spring Boot 大文件上传方案</strong>，具备：</p>
<ul>
<li>分片上传</li>
<li>断点续传</li>
<li>上传进度计算</li>
<li>多存储后端解耦</li>
<li>yml 配置快速切换</li>
</ul>
<p>适用于文件中心、数据平台、企业网盘等场景，<strong>可直接用于生产环境</strong>。</p>
<hr/>
<p><strong>欢迎点赞、收藏、评论交流。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS弹窗+bindSheet半模态+浮层通用解决方案覆盖全业务场景]]></title>    <link>https://juejin.cn/post/7590608345923518490</link>    <guid>https://juejin.cn/post/7590608345923518490</guid>    <pubDate>2026-01-03T14:36:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590608345923518490" data-draft-id="7590592594674892810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS弹窗+bindSheet半模态+浮层通用解决方案覆盖全业务场景"/> <meta itemprop="keywords" content="HarmonyOS,Android"/> <meta itemprop="datePublished" content="2026-01-03T14:36:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="钟睿"/> <meta itemprop="url" content="https://juejin.cn/user/703287125625901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS弹窗+bindSheet半模态+浮层通用解决方案覆盖全业务场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/703287125625901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    钟睿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:36:02.000Z" title="Sat Jan 03 2026 14:36:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从api9开始开发鸿蒙的大佬们想必一开始被弹窗折腾得有点难受，使用起来各种不顺手且不方便还有各种限制，
尤其是面对复杂且多样化的需求设计场景下太难受了，还好ComponentContent在api12的版本出现了</p>
<p><strong>ComponentContent的出现能解决什么问题？</strong></p>
<p>以CustomDialog弹窗为例，如果要使用弹窗CustomDialogController必须定义在页面中，通过CustomDialogController控制弹窗显示隐藏，这样就至少带来2个问题：</p>
<blockquote>
<p>1：哪里需要弹窗就需要在哪里声明CustomDialogController，不能直接在其他普通类（非@Component）直接使用弹窗，这样就导致把弹窗的部分逻辑强制耦合在页面上，业务越复杂，耦合度越高</p>
</blockquote>
<blockquote>
<p>2：在实际业务场景下弹窗不方便改成普通页面或者普通组件</p>
</blockquote>
<p><strong>而通过ComponentContent实现弹窗的方案只需要一个uiContext即可在任意地方控制弹窗显示，而且还能快速的改造成其他页面、组件、甚至是overlay(浮层)和bindSheet(半模态)且入侵性极低</strong></p>
<p><strong>基于ComponentContent实现的弹窗有多方便？</strong><br/>
显示弹窗的核心代码就三行(实例化Dialog，设置视图，显示弹窗)，以前做Android开发的应该对这个写法很熟悉</p>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam } from '@zhongrui/easy_dialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        //只要有uiContext，此处显示弹窗的代码可以写到主线程的任意地方
        const dialog = new BaseDialog(this.getUIContext())
        //传入弹窗视图和参数
        dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
        dialog.show()
      })
      
      //弹窗的视图以组件的形式在页面中直接使用
      DialogView({ param: new ComponentParam('自定义参数') })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}

@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  build() {
    Button('销毁弹窗').onClick(() =&gt; {
      this.param.dismiss()
    })
  }
}
</code></pre>
<p><strong>基于ComponentContent实现的弹窗如何快速改造成页面、组件、甚至是overlay(浮层)和bindSheet(半模态)</strong></p>
<pre><code class="hljs language-text" lang="text">//弹窗的视图以组件的形式在页面中直接使用,其他地方可以不做任何修改编译不会报错
DialogView({ param: new ComponentParam('自定义参数') })
</code></pre>
<pre><code class="hljs language-text" lang="text">//改成overlay浮层
const dialog = new BaseOverlay(this.getUIContext())
dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
dialog.show()
</code></pre>
<pre><code class="hljs language-text" lang="text">//改成bindSheet半模态
const dialog = new BaseSheet(this.getUIContext(),'页面组件id')
dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
dialog.show()
</code></pre>
<p>没错，只需要在实例化的时候，改个名字就行了</p>
<h2 data-id="heading-1">下载安装</h2>
<blockquote>
<p>ohpm install @zhongrui/easy_dialog</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40zhongrui%252Feasy_dialog" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@zhongrui%2Feasy_dialog" ref="nofollow noopener noreferrer">easy_dialog开源库中心仓(<strong>api详细使用说明</strong>)</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fdeveloper_zhongrui%2FEasyDialog" target="_blank" title="https://gitcode.com/developer_zhongrui/EasyDialog" ref="nofollow noopener noreferrer">源码地址</a></p>
<h2 data-id="heading-2">效果图</h2>

















<table><thead><tr><th/><th/></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a91eb6c0ada4a0db5b73bec4c625887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=Ax%2FS0IlDVFpOqd3YJxRllrwbMGs%3D" alt="11.gif" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7deca0fbb9d42229108ebaa4563b164~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=VqWhrWUaa8BZR2LvIBc2ngfwZK0%3D" alt="22.gif" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2f221726b11459d8d4b455cb28bcb38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=HunJ0aeLPeMTA%2FvajSGpk6VOrls%3D" alt="33.gif" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/657701258ed946718e35b3b6dbc86437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=vYgNVATHMUrPe3%2BU6GcJTt%2BPFcg%3D" alt="44.gif" loading="lazy"/></td></tr></tbody></table>
<p><strong>当出现以下场景时使用easy_dialog轻松应对</strong></p>
<ul>
<li>
<p>场景1：不同页面显示同一个弹窗时，弹窗上面某些埋点上报需要上报不同页面来源（页面传递参数给弹窗视图）</p>
</li>
<li>
<p>场景2：在弹窗的视图上执行某个操作之后，需要将某些数据同步给页面（弹窗视图和页面通信）</p>
</li>
<li>
<p>场景3：页面满足某个状态时，需要将某些数据同步给弹窗视图（页面和弹窗视图通信）</p>
</li>
<li>
<p>场景4：页面出现多个运营活动弹窗，产品要求出现多个弹窗的场景，上一个弹窗消失时，下一个弹窗才能出现，不能同时显示</p>
</li>
<li>
<p>场景5：页面，弹窗，半模态之间切换<br/>
领导：这个登录页面你改成弹窗实现吧<br/>
我：修改这个大概需要1个小时(将页面改成弹窗用easy_dialog实际上10分钟不到就改完了)<br/>
领导：这个弹窗能不能滑上去，我看其他app有这个效果，能不能改成这样的效果？<br/>
我：我瞅瞅，噢~这个半模态效果啊，可以改的<br/>
领导：我听其他开发说这是bindSheet，你再花1小时研究下怎么实现的<br/>
我：好的好的（用2秒钟把BaseDialog改成了BaseSheet，然后摸鱼59分钟后去给领导演示效果）</p>
</li>
</ul>
<p>实现上述场景的需求，核心是解耦的条件下进行传参和通信，只要解决这两个问题那么该方案就能覆盖99%以上的业务场景</p>
<blockquote>
<p>场景1：不同页面显示同一个弹窗时，弹窗上面某些埋点上报需要上报不同页面来源</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">const dialog = new BaseDialog(this.getUIContext())
dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
//通过Tag给Dialog设置页面来源
dialog.addTag('pageSource','xxx')
dialog.show()

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  aboutToAppear(): void {
    //获取页面来源
    const pageSource = this.param.getTag('pageSource')
  }

  build() {
    Text()
  }
}
</code></pre>
<blockquote>
<p>场景2：在弹窗的视图上执行某个操作之后，需要将某些数据同步给页面</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        const dialog = new BaseDialog(this.getUIContext())
        dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
        //注册事件，接收弹窗视图发送的事件
        dialog.addEvent&lt;string&gt;('key', (data) =&gt; {
          //获取事件传的参数
          const result = data
          return '返回值'
        })
        dialog.show()
      })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  build() {
    Text('xxx操作').onClick(() =&gt; {
      //给Dialog发送事件且获取结果
      const result = this.param.sendEvent('key', '自定义数据')
    })
  }
}
</code></pre>
<blockquote>
<p>场景3：页面满足某个状态时，需要将某些数据同步给弹窗视图（页面和弹窗视图通信）</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam } from '@zhongrui/easy_dialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        const dialog = new BaseDialog(this.getUIContext())
        dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
        dialog.show()

        setTimeout(() =&gt; {
          //模拟触发某个状态
          //给弹窗视图发送事件并获取返回值
          const result = dialog.sendEvent('key', '自定义数据')
        }, 2000)
      })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  aboutToAppear(): void {
    //注册事件，接收dialog发送的事件
    this.param.addEvent&lt;string&gt;('key', (data) =&gt; {
      //获取事件传的参数
      const result = data
      return '返回值'
    })
  }

  build() {
  }
}
</code></pre>
<blockquote>
<p>场景4：页面出现多个运营活动弹窗，产品要求出现多个弹窗的场景，上一个弹窗消失时，下一个弹窗才能出现，不能同时显示</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam, DialogManager } from '@zhongrui/easy_dialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        const dialog1 = new BaseDialog(this.getUIContext())
        dialog1.setContentView(wrapBuilder(dialogView), new ComponentParam('第1个弹窗'))

        const dialog2 = new BaseDialog(this.getUIContext())
        dialog2.setContentView(wrapBuilder(dialogView), new ComponentParam('第2个弹窗'))

        const dialog3 = new BaseDialog(this.getUIContext())
        dialog3.setContentView(wrapBuilder(dialogView), new ComponentParam('第3个弹窗'))

        DialogManager.get('def').show(dialog1)
        DialogManager.get('def').show(dialog2)
        DialogManager.get('def').show(dialog3)
        //或者
        DialogManager.get('def').addDialog(dialog1)
        DialogManager.get('def').addDialog(dialog2)
        DialogManager.get('def').addDialog(dialog3)
        DialogManager.get('def').show()
      })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  build() {
    Button('取消弹窗').onClick(() =&gt; {
      this.param.dismissAndShowNext()
    })
  }
}
</code></pre>
<h2 data-id="heading-3">实际项目用法</h2>
<blockquote>
<p>1：新建一个普通类比如LoginDialog，继承BaseDialog或BaseOverlay或BaseSheet<br/>
2：创建一个静态方法对外提供，哪个页面需要显示弹窗，调用静态方法即可，页面不用关心弹窗的创建逻辑以及弹窗内部交互逻辑<br/>
3：@Builder装饰的function方法定义在LoginDialog文件里面<br/>
4：遇到复杂的业务场景，部分业务逻辑在LoginDialog类中单独闭环与外部页面完全解耦</p>
</blockquote>
<h3 data-id="heading-4">页面</h3>
<pre><code class="hljs language-text" lang="text">import { LoginDialog, LoginResult } from '../test/LoginDialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示登录弹窗').onClick(() =&gt; {
        LoginDialog.showDialog(this.getUIContext(), '156xxx8888', (result: LoginResult) =&gt; {
          //获取登录结果
        })
      })
    }
    .height('100%')
    .width('100%')
  }
}
</code></pre>
<h3 data-id="heading-5">LoginDialog类</h3>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam } from '@zhongrui/easy_dialog';
import { LoginDialogView } from './LoginDialogView';

export interface LoginParam {
  phone: string
}

export interface LoginResult {
  phone: string
  userName: string
  pwd: string
}

@Builder
function dialogView(param: ComponentParam&lt;LoginParam&gt;) {
  LoginDialogView({ param: param })
}

export class LoginDialog extends BaseDialog {
  public static showDialog(uiContext: UIContext, phone: string,
    loginSuccess: (data: LoginResult) =&gt; void): LoginDialog {
    //构造业务参数
    const data: ComponentParam&lt;LoginParam&gt; = new ComponentParam&lt;LoginParam&gt;({ phone: phone })
    //创建弹窗
    const dialog = new LoginDialog(uiContext)
    //设置视图
    dialog.setContentView(wrapBuilder(dialogView), data)
    //设置弹窗参数promptAction.BaseDialogOptions（和官网文档一致）
    //maskRect,alignment,offset,isModal,showInSubWindow,onWillDismiss,autoCancel
    //maskColor,transition,dialogTransition等
    dialog.setOption({})
    //设置tag
    dialog.addTag('key', '自定义参数')
    //注册登录成功事件
    dialog.addEvent&lt;LoginResult&gt;('success', (data: LoginResult | undefined) =&gt; {
      if (!data) {
        return
      }
      loginSuccess?.(data)
    })
    //显示弹窗
    dialog.show()
    return dialog
  }

  //可以定义其他方法根据实际场景处理一些额外的业务逻辑
  public otherMethod() {
    this.addTag('key', 'value')
  }
}
</code></pre>
<h3 data-id="heading-6">LoginDialog视图</h3>
<pre><code class="hljs language-text" lang="text">import { ComponentParam } from '@zhongrui/easy_dialog'
import { LoginParam, LoginResult } from './LoginDialog'

@ComponentV2
export struct LoginDialogView {
  @Param param: ComponentParam&lt;LoginParam&gt; = new ComponentParam&lt;LoginParam&gt;({ phone: '' })
  @Local phone: string = ''

  aboutToAppear(): void {
    this.phone = this.param.data.phone
    //可以获取其他参数
    this.param.getTag('key')
  }

  build() {
    Column() {
      Text("手机号：" + this.phone)
      Button('登录').onClick(() =&gt; {
        //登录成功
        const result: LoginResult = {
          phone: this.phone,
          userName: 'Harmony',
          pwd: 'OpenHarmony'
        }
        //发送登录成功事件
        this.param.sendEvent('success', result)
        //隐藏弹窗
        this.param.dismiss()
      })
    }
  }
}
</code></pre>
<h2 data-id="heading-7">进阶用法</h2>
<h3 data-id="heading-8">公共部分</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//除了构造函数能设置业务参数，也可以通过setData设置，支持各种类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-comment">//Dialog(自定义弹窗)</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">dialog</span>: <span class="hljs-title class_">AbsDialog</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseDialog</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
<span class="hljs-comment">//Overlay(浮层)</span>
dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseOverlay</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
<span class="hljs-comment">//bindSheet(半模态弹窗)</span>
dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseSheet</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>(), <span class="hljs-string">'contentId'</span>)

<span class="hljs-comment">//Dialog(自定义弹窗)设置绑定的组件id</span>
<span class="hljs-comment">//虽然不设置也可以，但是后续Navigation跳转的页面都会被弹窗覆盖，根据实际场景调用即可</span>
dialog.<span class="hljs-title function_">setComponentId</span>(<span class="hljs-string">'contentId'</span>)

<span class="hljs-comment">//(和官方文档一致)设置实例化ComponentContent的参数，所以setBuildOption必须在setContentView之前调用</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">buildOption</span>: <span class="hljs-title class_">BuildOptions</span> = {}
dialog.<span class="hljs-title function_">setBuildOption</span>(buildOption)

<span class="hljs-comment">//设置弹窗视图</span>
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//注册事件，接收视图发送的事件，获取事件参数的同时，支持设置返回值</span>
dialog.<span class="hljs-property">addEvent</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'key'</span>, <span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span></span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>
})
dialog.<span class="hljs-property">addEvent</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'key'</span>, <span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span></span>) =&gt;</span> {
})
<span class="hljs-comment">//删除单个事件</span>
dialog.<span class="hljs-title function_">deleteEvent</span>(<span class="hljs-string">'key'</span>)

<span class="hljs-comment">//给组件视图发送事件(不是dialog.addEvent注册的事件)并获取事件的返回值</span>
<span class="hljs-keyword">const</span> result1 = dialog.<span class="hljs-title function_">sendEvent</span>(<span class="hljs-string">'key'</span>)
<span class="hljs-keyword">const</span> result2 = dialog.<span class="hljs-title function_">sendEvent</span>(<span class="hljs-string">'key'</span>, <span class="hljs-string">'自定义类型参数'</span>)

<span class="hljs-comment">//清除Dialog注册的所有事件</span>
dialog.<span class="hljs-title function_">clearDialogRegisterEvent</span>()

<span class="hljs-comment">//清除视图注册的所有事件</span>
dialog.<span class="hljs-title function_">clearComponentRegisterEvent</span>()

<span class="hljs-comment">//清除Dialog注册的事件+当前组件注册的事件</span>
dialog.<span class="hljs-title function_">clearAllEvent</span>()

<span class="hljs-comment">//设置tag，在dialog和组件视图中都可以通过getTag可以获取</span>
dialog.<span class="hljs-title function_">setTag</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-comment">//添加tag，支持各种类型，在dialog和组件视图中都可以通过getTag(key)可以获取</span>
dialog.<span class="hljs-title function_">addTag</span>(<span class="hljs-string">'key'</span>, <span class="hljs-string">'value'</span>)

<span class="hljs-comment">//获取tag，不传key获取setTag('xxx')的值，传key获取addTag('key', 'value')的值</span>
<span class="hljs-comment">//在dialog和组件视图中都可以获取</span>
dialog.<span class="hljs-title function_">getTag</span>(<span class="hljs-string">'key'</span>)

<span class="hljs-comment">//删除tag</span>
dialog.<span class="hljs-title function_">deleteTag</span>(<span class="hljs-string">'key'</span>)

<span class="hljs-comment">//清除tag，true:清除所有tag，false:只清除addTag('key', 'value')的值,不清除setTag('xxx')的值</span>
dialog.<span class="hljs-title function_">clearTag</span>(<span class="hljs-literal">true</span>)

<span class="hljs-comment">//显示弹窗</span>
dialog.<span class="hljs-title function_">show</span>()

<span class="hljs-comment">//隐藏弹窗，下次直接调用show方法即可再次显示</span>
dialog.<span class="hljs-title function_">hide</span>()

<span class="hljs-comment">//销毁弹窗，下次显示必须重新实例化</span>
dialog.<span class="hljs-title function_">dismiss</span>()

<span class="hljs-comment">//隐藏弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)</span>
dialog.<span class="hljs-title function_">hideAndShowNext</span>()

<span class="hljs-comment">//隐藏并销毁弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)</span>
dialog.<span class="hljs-title function_">dismissAndShowNext</span>()

<span class="hljs-comment">//判断弹窗是否显示</span>
dialog.<span class="hljs-title function_">isShowing</span>()

<span class="hljs-comment">//判断弹窗是否隐藏</span>
dialog.<span class="hljs-title function_">isHide</span>()

<span class="hljs-comment">//判断弹窗是否销毁</span>
dialog.<span class="hljs-title function_">isDismiss</span>()

<span class="hljs-comment">//(和官方文档一致)用于更新WrappedBuilder对象封装的builder函数参数，与constructor传入的参数类型保持一致</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">newData</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
dialog.<span class="hljs-title function_">update</span>(newData)

<span class="hljs-comment">//触发ComponentContent中的自定义组件的复用</span>
dialog.<span class="hljs-title function_">reuse</span>()

<span class="hljs-comment">//触发ComponentContent中自定义组件的回收</span>
dialog.<span class="hljs-title function_">recycle</span>()

<span class="hljs-comment">//传递系统环境变化事件，触发节点的全量更新</span>
dialog.<span class="hljs-title function_">updateConfiguration</span>()
</code></pre>
<h3 data-id="heading-9">组件视图</h3>
<pre><code class="hljs language-txt" lang="txt">import { ComponentParam } from '@zhongrui/easy_dialog'

@ComponentV2
export struct DialogView {
  //固定写法
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')
  @Local title: string = ''

  aboutToAppear(): void {
    //获取参数
    this.title = this.param.data
    
    //注册接收Dialog发送的事件
    this.param.addEvent&lt;string&gt;('key', (result: string | undefined) =&gt; {
      return 'xxx'
    })
    this.param.addEvent&lt;number&gt;('key', () =&gt; {
    })
    
    //删除注册的事件
    this.param.deleteEvent('key')
    
    //给Dialog发送事件并获取返回值
    const result1 = this.param.sendEvent('key')
    const result2 = this.param.sendEvent('key', 'xxx')

    //隐藏弹窗/浮层/sheet
    this.param.hide()
    
    //隐藏并销毁弹窗/浮层/sheet
    this.param.dismiss()
    
    //隐藏弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)
    this.param.hideAndShowNext()
    
    //隐藏并销毁弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)
    this.param.dismissAndShowNext()

    //设置tag，在dialog和组件视图中都可以通过getTag可以获取
    this.param.setTag('xxx')

    //添加tag，支持各种类型，在dialog和组件视图中都可以通过getTag(key)可以获取
    this.param.addTag('key', 'value')

    //获取tag，不传key获取setTag('xxx')的值，传key获取addTag('key', 'value')的值
    //在dialog和组件视图中都可以获取
    this.param.getTag('key')

    //删除tag
    this.param.deleteTag('key')

    //清除tag，true:清除所有tag，false:只清除addTag('key', 'value')的值,不清除setTag('xxx')的值
    this.param.clearTag(true)

    //清除Dialog注册的事件
    this.param.clearDialogRegisterEvent()
    
    //清除当前组件注册的事件
    this.param.clearComponentRegisterEvent()
    
    //清除Dialog注册的事件+当前组件注册的事件
    this.param.clearAllEvent()

  }

  build() {
    Text(this.title)
  }
}
</code></pre>
<h2 data-id="heading-10">差异部分</h2>
<h3 data-id="heading-11">Dialog(自定义弹窗)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-keyword">const</span> dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseDialog</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//(和官方文档一致)设置弹窗参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: promptAction.<span class="hljs-property">BaseDialogOptions</span> = {}
dialog.<span class="hljs-title function_">setOption</span>(options)

<span class="hljs-comment">//(和官方文档一致)在弹窗显示的情况下可以更新弹窗参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">dialogOption</span>: promptAction.<span class="hljs-property">BaseDialogOptions</span> = {}
dialog.<span class="hljs-title function_">updateDialog</span>(dialogOption)

dialog.<span class="hljs-title function_">show</span>()
</code></pre>
<h3 data-id="heading-12">Overlay(浮层)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-keyword">const</span> dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseOverlay</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//(和官方文档一致)设置OverlayManager参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">OverlayManagerOptions</span> = {}
dialog.<span class="hljs-title function_">setOverlayManagerOption</span>(options)

<span class="hljs-comment">//新增视图节点在OverlayManager上的层级位置，当index ≥ 0时，越大</span>
dialog.<span class="hljs-title function_">setIndex</span>(<span class="hljs-number">1</span>)

dialog.<span class="hljs-title function_">show</span>()
</code></pre>
<h3 data-id="heading-13">bindSheet(半模态弹窗)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-keyword">const</span> dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseSheet</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>(), <span class="hljs-string">'contentId'</span>)
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//(和官方文档一致)设置半模态参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">SheetOptions</span> = {}
dialog.<span class="hljs-title function_">setSheetOption</span>(options)

dialog.<span class="hljs-title function_">show</span>()
</code></pre>
<h2 data-id="heading-14">历史文章</h2>
<p><a href="https://juejin.cn/post/7427050728719368202" target="_blank" title="https://juejin.cn/post/7427050728719368202"><strong>HarmonyOS NEXT多环境+多渠道+自定义路径输出+自定义名称一键打app和hap包</strong></a></p>
<p><a href="https://juejin.cn/post/7401358349877444642" target="_blank" title="https://juejin.cn/post/7401358349877444642"><strong>HarmonyOS NEXT一行代码实现任意处弹窗</strong></a></p>
<p><a href="https://juejin.cn/post/7397638569731358760" target="_blank" title="https://juejin.cn/post/7397638569731358760"><strong>HarmonyOS NEXT数据列表加载更多(无需监听列表滑到最底部)</strong></a></p>
<p><a href="https://juejin.cn/post/7395866502716702755" target="_blank" title="https://juejin.cn/post/7395866502716702755"><strong>HarmonyOS NEXT下拉刷新+上拉加载(纵向横向都支持)(v1+v2装饰器)</strong></a></p>
<p><a href="https://juejin.cn/post/7505633505980940297" target="_blank" title="https://juejin.cn/post/7505633505980940297"><strong>HarmonyOS NEXT图片压缩(支持fd,uri,网络图片,沙箱路径,base64,ArrayBuffer)</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[想让网页秒开？这些 CSS 优化方法帮你搞定]]></title>    <link>https://juejin.cn/post/7590961898398384166</link>    <guid>https://juejin.cn/post/7590961898398384166</guid>    <pubDate>2026-01-04T02:03:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590961898398384166" data-draft-id="7372393716092633139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="想让网页秒开？这些 CSS 优化方法帮你搞定"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-04T02:03:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            想让网页秒开？这些 CSS 优化方法帮你搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:03:59.000Z" title="Sun Jan 04 2026 02:03:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>CSS 性能优化是前端开发中的重要一环，目的是提高页面加载速度和渲染性能，提供更好的用户体验。</p>
<p>接下来我们将讲解一些常见的案例。</p>
<h2 data-id="heading-0">减少 css 文件大小</h2>
<p>压缩 CSS 文件可以通过移除空白字符、注释和冗余代码来减少文件大小，从而提高加载速度。常用工具有 cssnano 和 clean-css。</p>
<p>使用 cssnano 压缩 CSS 文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cssnano = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cssnano"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">"./style.css"</span>, <span class="hljs-function">(<span class="hljs-params">err, css</span>) =&gt;</span> {
  <span class="hljs-title function_">postcss</span>([cssnano])
    .<span class="hljs-title function_">process</span>(css, { <span class="hljs-attr">from</span>: <span class="hljs-string">"style.css"</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">"styles.min.css"</span> })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">"styles.min.css"</span>, result.<span class="hljs-property">css</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">true</span>);
    });
});
</code></pre>
<p>最终输出结果如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/753a0a65f414496c9d001d3a7f29a6bc~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1637&amp;h=577&amp;s=57796&amp;e=png&amp;b=202020" alt="20240524112942" loading="lazy"/></p>
<p>style.css 文件会被压缩到 styles.min.css。</p>
<h2 data-id="heading-1">删除未使用的 CSS</h2>
<p>通过工具（如 PurgeCSS、UnCSS）扫描 HTML 和 JS 文件，删除未使用的 CSS 规则，减少不必要的样式，提高性能。</p>
<p>使用 PurgeCSS 删除未使用的 CSS：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">PurgeCSS</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"purgecss"</span>).<span class="hljs-property">PurgeCSS</span>;
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-keyword">new</span> <span class="hljs-title class_">PurgeCSS</span>()
  .<span class="hljs-title function_">purge</span>({
    <span class="hljs-attr">content</span>: [<span class="hljs-string">"*.html"</span>],
    <span class="hljs-attr">css</span>: [<span class="hljs-string">"styles.css"</span>],
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-comment">// 保存优化后的 CSS 文件</span>
    fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">"./styles.purged.css"</span>, result[<span class="hljs-number">0</span>].<span class="hljs-property">css</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">true</span>);
  });
</code></pre>
<p>代码执行完成之后，只有在使用的 css 规则才会被应用，其余的都会被删除掉，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbb4175eb7f0413ea39375223840e406~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1282&amp;h=710&amp;s=62226&amp;e=png&amp;b=1f1f1f" alt="20240524115043" loading="lazy"/></p>
<h2 data-id="heading-2">使用 CSS 预处理器</h2>
<p>使用 CSS 预处理器（如 Sass、Less、Stylus 等）可以为你的开发工作带来许多好处。以下是一些主要的优势和详细的解释：</p>
<h3 data-id="heading-3">变量</h3>
<p>在 CSS 预处理器中，你可以定义变量来存储重复使用的值（如颜色、字体大小、间距等）。这使得你的代码更加简洁和易于维护。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-variable">$primary-color</span>: <span class="hljs-number">#3498db</span>;
<span class="hljs-variable">$font-size</span>: <span class="hljs-number">16px</span>;

<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-variable">$font-size</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-variable">$primary-color</span>;
}
</code></pre>
<h3 data-id="heading-4">嵌套</h3>
<p>预处理器允许你嵌套 CSS 规则，这使得你的代码结构更加清晰，尤其是在处理复杂的选择器层次时。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">nav</span> {
  <span class="hljs-selector-tag">ul</span> {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">list-style</span>: none;

    <span class="hljs-selector-tag">li</span> {
      <span class="hljs-attribute">display</span>: inline-block;
      <span class="hljs-selector-tag">a</span> {
        <span class="hljs-attribute">text-decoration</span>: none;
        <span class="hljs-attribute">color</span>: <span class="hljs-variable">$primary-color</span>;
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-5">混合宏（Mixins）</h3>
<p>混合宏允许你定义一组样式，然后在其他地方重复使用。这对于实现可重用的响应式设计模式或其他复杂的样式非常有用。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@mixin</span> border-radius(<span class="hljs-variable">$radius</span>) {
  -webkit-<span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
  -moz-<span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
  -ms-<span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-keyword">@include</span> border-radius(<span class="hljs-number">5px</span>);
}
</code></pre>
<h3 data-id="heading-6">继承（Extend/Inherit）</h3>
<p>继承允许一个选择器继承另一个选择器的样式，从而减少代码重复，提高样式的可维护性。</p>
<pre><code class="hljs language-scss" lang="scss">%<span class="hljs-selector-tag">button</span>-styles {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-variable">$primary-color</span>;
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-keyword">@extend</span> %button-styles;
}

<span class="hljs-selector-class">.alert-button</span> {
  <span class="hljs-keyword">@extend</span> %button-styles;
  <span class="hljs-attribute">background-color</span>: red;
}
</code></pre>
<h3 data-id="heading-7">运算</h3>
<p>你可以在 CSS 中进行数学运算，这对于动态计算宽度、高度、间距等非常有用。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span> - <span class="hljs-number">20px</span>; <span class="hljs-comment">// 计算结果</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> + <span class="hljs-number">5px</span>; <span class="hljs-comment">// 计算结果</span>
}
</code></pre>
<h3 data-id="heading-8">模块化</h3>
<p>预处理器通常支持将 CSS 分割成多个文件，然后在一个主文件中导入这些文件。这使得你的 CSS 代码更具可维护性和组织性。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 在 main.scss 文件中</span>
<span class="hljs-keyword">@import</span> <span class="hljs-string">"variables"</span>;
<span class="hljs-keyword">@import</span> <span class="hljs-string">"mixins"</span>;
<span class="hljs-keyword">@import</span> <span class="hljs-string">"header"</span>;
<span class="hljs-keyword">@import</span> <span class="hljs-string">"footer"</span>;
</code></pre>
<h3 data-id="heading-9">条件语句和循环</h3>
<p>预处理器支持使用条件语句和循环，从而可以在 CSS 中实现更复杂的逻辑和模式。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@for</span> <span class="hljs-variable">$i</span> from <span class="hljs-number">1</span> through <span class="hljs-number">3</span> {
  <span class="hljs-selector-class">.col-</span>#{<span class="hljs-variable">$i</span>} {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span> / <span class="hljs-number">3</span> * <span class="hljs-variable">$i</span>;
  }
}

<span class="hljs-keyword">@mixin</span> responsive(<span class="hljs-variable">$device</span>) {
  <span class="hljs-keyword">@if</span> <span class="hljs-variable">$device</span> == <span class="hljs-string">"mobile"</span> {
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>) {
      <span class="hljs-keyword">@content</span>;
    }
  } <span class="hljs-keyword">@else</span> if <span class="hljs-variable">$device</span> == <span class="hljs-string">"tablet"</span> {
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>) {
      <span class="hljs-keyword">@content</span>;
    }
  }
}

<span class="hljs-selector-class">.container</span> {
  <span class="hljs-keyword">@include</span> responsive(<span class="hljs-string">"mobile"</span>) {
    <span class="hljs-attribute">background-color</span>: blue;
  }
  <span class="hljs-keyword">@include</span> responsive(<span class="hljs-string">"tablet"</span>) {
    <span class="hljs-attribute">background-color</span>: green;
  }
}
</code></pre>
<h3 data-id="heading-10">自动前缀</h3>
<p>一些预处理器插件可以自动添加浏览器前缀，这样你就不需要手动添加各种浏览器前缀。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Sass 文件</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">display</span>: flex;
}

<span class="hljs-comment">// 编译后的 CSS 文件（使用 Autoprefixer 处理）</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">display</span>: -webkit-box;
  <span class="hljs-attribute">display</span>: -ms-flexbox;
  <span class="hljs-attribute">display</span>: flex;
}
</code></pre>
<p>使用 CSS 预处理器可以极大地提高开发效率和代码可维护性。通过引入变量、嵌套、混合宏、继承、运算、模块化、条件语句和循环等高级功能，预处理器使得编写和管理复杂的 CSS 变得更加轻松和高效。</p>
<h2 data-id="heading-11">优化选择器</h2>
<p>避免使用低效选择器，减少选择器层级嵌套，使用更高效的类选择器。</p>
<p>低效选择器：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span> &gt; <span class="hljs-selector-tag">ul</span> &gt; <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:first</span>-child {
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<p>高效选择器：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.item-first</span> {
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<h2 data-id="heading-12">减少重绘和重排</h2>
<p>频繁更改 DOM 和样式会导致重绘和重排，影响性能。尽量批量更新样式。</p>
<pre><code class="hljs language-js" lang="js">element.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">"background-color: blue; width: 100px; height: 100px;"</span>;
</code></pre>
<h2 data-id="heading-13">延迟加载和异步加载</h2>
<p>延迟加载非关键 CSS 文件，提高关键渲染路径的性能。</p>
<p>异步加载 CSS：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span>
  <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span>
  <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.css"</span>
  <span class="hljs-attr">as</span>=<span class="hljs-string">"style"</span>
  <span class="hljs-attr">onload</span>=<span class="hljs-string">"this.onload=null;this.rel='stylesheet'"</span>
/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.css"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span>
</code></pre>
<h2 data-id="heading-14">使用字体优化</h2>
<p>减少字体文件大小，使用适当的字体显示策略。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">"MyFont"</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"myfont.woff2"</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">"woff2"</span>);
  <span class="hljs-attribute">font-display</span>: swap;
}
</code></pre>
<h2 data-id="heading-15">浏览器缓存</h2>
<p>通过设置缓存头和版本控制，提高 CSS 文件的加载速度。</p>
<p>在服务器上配置适当的缓存头，允许浏览器缓存 CSS 文件。例如，使用 Apache 服务器，可以在 .htaccess 文件中添加以下内容：</p>
<pre><code class="hljs language-apache" lang="apache">&lt;FilesMatch "\.(css|js)$"&gt;
  Header set Cache-Control "max-age=31536000, public"
&lt;/FilesMatch&gt;
</code></pre>
<p>通过文件名中包含版本号（如 style.v1.css）来控制缓存，确保更新后的 CSS 文件被重新加载。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.v1.css"</span> /&gt;</span>
</code></pre>
<h2 data-id="heading-16">总结</h2>
<p>通过以上这些优化方法和工具，我们可以显著提升 css 的性能，改善网页的加载和渲染速度，提供更流畅的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[（ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版]]></title>    <link>https://juejin.cn/post/7590699877630476326</link>    <guid>https://juejin.cn/post/7590699877630476326</guid>    <pubDate>2026-01-03T12:48:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590699877630476326" data-draft-id="7590608345923256346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="（ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版"/> <meta itemprop="keywords" content="Agent,LangChain"/> <meta itemprop="datePublished" content="2026-01-03T12:48:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RedTiemr"/> <meta itemprop="url" content="https://juejin.cn/user/2140104538466522"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            （ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2140104538466522/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RedTiemr
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:48:10.000Z" title="Sat Jan 03 2026 12:48:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">（ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版本&gt;1.0和&lt;1.0的区别)</h2>
<p>“ConversationTokenBufferMemory”会将近期的对话历史记录存储在缓冲存储器中，并根据“令牌长度”而非对话数量来决定何时刷新对话内容。
关键参数：</p>
<ul>
<li><code>max_token_limit</code>： 设定用于存储对话内容的最大令牌长度</li>
<li><code>return_messages</code>： 当为 True 时，将以聊天格式返回消息。当为 False 时，返回字符串</li>
<li><code>human_prefix</code>： 在人类消息前添加的前缀（默认值："Human"）</li>
<li><code>ai_prefix</code>： 在 AI 消息前添加的前缀（默认值："AI"）</li>
</ul>
<h3 data-id="heading-1">该类，是之前的版本1.0以前的，版本1.0以后的。我会列出两个版本的使用方式和特点。</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_classic.memory <span class="hljs-keyword">import</span> ConversationTokenBufferMemory
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI


<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate
load_dotenv()
<span class="hljs-comment"># 创建ChatOpenAI对象，配置为使用硅基流动API</span>
Qwen2_5_7B_Instruct_llm = ChatOpenAI(
    temperature=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 控制输出的随机性和创造性，值越低输出越稳定可预测，值越高输出越有创意但可能偏离预期 (范围: 0.0 ~ 2.0)</span>
    model_name=<span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>,  <span class="hljs-comment"># 硅基流动支持的模型名称</span>
    openai_api_key=os.getenv(<span class="hljs-string">"SILICONFLOW_API_KEY"</span>),  <span class="hljs-comment"># 从环境变量获取API密钥</span>
    openai_api_base=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>  <span class="hljs-comment"># 硅基流动API的基础URL</span>
)

<span class="hljs-comment"># Configure memory</span>
memory = ConversationTokenBufferMemory(
    llm=Qwen2_5_7B_Instruct_llm,
    max_token_limit=<span class="hljs-number">50</span>,
    return_messages=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># Limit maximum token length to 50</span>
)

<span class="hljs-comment"># 添加任意对话</span>
memory.save_context(
    inputs={
        <span class="hljs-string">"human"</span>: <span class="hljs-string">"您好，我最近从贵公司购买了一台机床。请问如何安装？"</span>
    },
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"您好！感谢您的购买。请问您能告诉我机器的型号吗？"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"是的，型号是XG-200。"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"谢谢。我来为您介绍XG-200型号的安装指南。首先，请检查安装地点的供电状态。这台机器需要220V电源。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"我已经检查了电源。下一步该怎么做？"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"很好。接下来，请将机器放置在平整稳固的表面上。然后，按照用户手册的说明进行线缆连接。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"如何进行连接？"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"请参考说明书第5页。那里有详细的线缆连接说明。如果您在这个过程中遇到任何困难，我很乐意为您提供进一步的帮助。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"安装完成后我该做什么？"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"安装完成后，请打开电源并进行初始运行测试。测试程序在说明书第10页有详细说明。如果机器有任何问题或者您需要额外支持，请随时与我们联系。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"谢谢，这些信息对我很有帮助！"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"我们随时准备为您提供帮助。如果您还有任何问题或需要支持，请随时询问。祝您使用愉快！"</span>
    },
)
</code></pre>
<p>打印memory中的对话内容</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(memory.load_memory_variables({})[<span class="hljs-string">"history"</span>])
</code></pre>
<blockquote>
<p>[HumanMessage(content='您好，我最近从贵公司购买了一台机床。请问如何安装？', additional_kwargs={}, response_metadata={}),
AIMessage(content='您好！感谢您的购买。请问您能告诉我机器的型号吗？', additional_kwargs={}, response_metadata={}),
HumanMessage(content='您好，我最近从贵公司购买了一台机床。请问如何安装？', additional_kwargs={}, response_metadata={}),
AIMessage(content='您好！感谢您的购买。请问您能告诉我机器的型号吗？', additional_kwargs={}, response_metadata={})]</p>
</blockquote>
<h3 data-id="heading-2">使用最新版本逻辑实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> MemorySaver
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> MessagesState, START, StateGraph
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage
<span class="hljs-keyword">from</span> tiktoken <span class="hljs-keyword">import</span> get_encoding

checkpointer = MemorySaver()
model =  ChatOpenAI(
    temperature=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 控制输出的随机性和创造性，值越低输出越稳定可预测，值越高输出越有创意但可能偏离预期 (范围: 0.0 ~ 2.0)</span>
    model_name=<span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>,  <span class="hljs-comment"># 硅基流动支持的模型名称</span>
    openai_api_key=os.getenv(<span class="hljs-string">"SILICONFLOW_API_KEY"</span>),  <span class="hljs-comment"># 从环境变量获取API密钥</span>
    openai_api_base=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>  <span class="hljs-comment"># 硅基流动API的基础URL</span>
)

tokenizer = get_encoding(<span class="hljs-string">"cl100k_base"</span>)  <span class="hljs-comment"># tokenizer</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_with_token_window</span>(<span class="hljs-params">state: MessagesState</span>):
    <span class="hljs-string">"""基于 token 限制的记忆管理（最大 2000 tokens）"""</span>
    messages = state[<span class="hljs-string">"messages"</span>]
    max_tokens = <span class="hljs-number">2000</span>
    
    <span class="hljs-comment"># 计算当前 token 总数</span>
    total_tokens = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(tokenizer.encode(msg.content)) <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages)
    
    <span class="hljs-comment"># 逐步移除最早消息直到符合 token 限制</span>
    <span class="hljs-keyword">while</span> total_tokens &gt; max_tokens <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(messages) &gt; <span class="hljs-number">1</span>:
        messages.pop(<span class="hljs-number">0</span>)
        total_tokens = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(tokenizer.encode(msg.content)) <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages)
    
    response = model.invoke(messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [response]}

<span class="hljs-comment"># 构建图</span>
builder = StateGraph(state_schema=MessagesState)
builder.add_node(<span class="hljs-string">"chat"</span>, chat_with_token_window)
builder.add_edge(START, <span class="hljs-string">"chat"</span>)
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=checkpointer)

config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"user-1"</span>}}

<span class="hljs-comment"># 测试长对话（会自动截断）</span>
long_dialogue = [
    <span class="hljs-string">"这是很长的第一条消息，包含很多内容..."</span> * <span class="hljs-number">10</span>,
    <span class="hljs-string">"第二条也很长..."</span> * <span class="hljs-number">8</span>,
    <span class="hljs-string">"第三条消息，问我的名字是什么？"</span>
]

<span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> long_dialogue:
    result = graph.invoke(
        {<span class="hljs-string">"messages"</span>: [HumanMessage(content=msg)]}, 
        config
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content[:<span class="hljs-number">100</span>]}</span>..."</span>)
</code></pre>
<h4 data-id="heading-3">高级使用</h4>
<ul>
<li>自定义 token 计算： 您可以根据需要自定义 token 计算逻辑，例如考虑特殊字符或非英文文本。</li>
<li>动态调整 token 限制： 根据实际对话场景动态调整 token 限制，例如在用户问题复杂时增加限制。</li>
<li>结合其他记忆管理策略： 您可以将基于 token 长度的记忆管理与其他策略（如基于时间的记忆管理）结合使用，以获得更完善的对话管理。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">smart_token_memory</span>(<span class="hljs-params">state: MessagesState</span>):
    <span class="hljs-string">"""Token 窗口 + 智能总结"""</span>
    messages = state[<span class="hljs-string">"messages"</span>][:]
    max_tokens = <span class="hljs-number">1000</span>
    model = ChatOpenAI(
        temperature=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 控制输出的随机性和创造性，值越低输出越稳定可预测，值越高输出越有创意但可能偏离预期 (范围: 0.0 ~ 2.0)</span>
        model_name=<span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>,  <span class="hljs-comment"># 硅基流动支持的模型名称</span>
        openai_api_key=os.getenv(<span class="hljs-string">"SILICONFLOW_API_KEY"</span>),  <span class="hljs-comment"># 从环境变量获取API密钥</span>
        openai_api_base=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>  <span class="hljs-comment"># 硅基流动API的基础URL</span>
    )
    tokenizer = get_encoding(<span class="hljs-string">"cl100k_base"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">count_tokens</span>(<span class="hljs-params">msgs</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(tokenizer.encode(m.content)) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> msgs)
    
    <span class="hljs-comment"># 如果超过限制，先尝试总结早期对话</span>
    <span class="hljs-keyword">while</span> count_tokens(messages) &gt; max_tokens <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(messages) &gt; <span class="hljs-number">2</span>:
        <span class="hljs-comment"># 总结最早 50% 对话</span>
        mid_point = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        early_msgs = messages[:mid_point]
        
        summary_prompt = <span class="hljs-string">f"总结以下对话（30字内）：<span class="hljs-subst">{<span class="hljs-string">' '</span>.join(m.content <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> early_msgs)}</span>"</span>
        summary = model.invoke([(<span class="hljs-string">"user"</span>, summary_prompt)])
        
        <span class="hljs-comment"># 用总结替换早期对话</span>
        messages = [AIMessage(content=<span class="hljs-string">f"总结：<span class="hljs-subst">{summary.content}</span>"</span>)] + messages[mid_point:]
    
    <span class="hljs-comment"># 最后精确截断</span>
    <span class="hljs-keyword">while</span> count_tokens(messages) &gt; max_tokens <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(messages) &gt; <span class="hljs-number">1</span>:
        messages.pop(<span class="hljs-number">0</span>)
    
    response = model.invoke(messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [response]}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Selenium 模拟浏览器操作（完整实操指南）]]></title>    <link>https://juejin.cn/post/7590421489998250003</link>    <guid>https://juejin.cn/post/7590421489998250003</guid>    <pubDate>2026-01-03T13:40:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998250003" data-draft-id="7590421489998233619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Selenium 模拟浏览器操作（完整实操指南）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-03T13:40:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刚哥的进化路"/> <meta itemprop="url" content="https://juejin.cn/user/71892859621675"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Selenium 模拟浏览器操作（完整实操指南）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/71892859621675/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刚哥的进化路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:40:39.000Z" title="Sat Jan 03 2026 13:40:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Selenium 核心价值在于<strong>模拟真实用户的浏览器操作行为</strong>，能够精准还原打开页面、输入文本、点击按钮、滚动页面等一系列操作，完美解决动态网页的数据爬取和自动化场景需求。本文将从实操角度出发，详细讲解 Selenium 模拟各类浏览器操作的核心方法，附带完整可运行代码。</p>
<h2 data-id="heading-0">一、前期准备（回顾必备）</h2>
<ol>
<li>已安装 Selenium 库：<code>pip install selenium -i https://pypi.doubanio.com/simple/</code></li>
<li>已配置对应浏览器驱动（ChromeDriver 优先，版本与浏览器大版本一致）</li>
<li>核心导入模块（后续示例默认包含以下导入）：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">from</span> selenium.webdriver.common.keys <span class="hljs-keyword">import</span> Keys
<span class="hljs-keyword">import</span> time
</code></pre>
<h2 data-id="heading-1">二、基础操作：初始化浏览器与访问网页</h2>
<p>这是模拟浏览器操作的第一步，完成浏览器的启动、配置与目标网页的访问。</p>
<h3 data-id="heading-2">1. 基础初始化（可视化模式）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 初始化 Chrome 浏览器驱动（启动浏览器）</span>
driver = webdriver.Chrome()

<span class="hljs-comment"># 2. 可选：最大化浏览器窗口（模拟用户正常使用习惯）</span>
driver.maximize_window()

<span class="hljs-comment"># 3. 访问目标网页（get 方法会等待页面初步加载完成）</span>
target_url = <span class="hljs-string">"https://www.baidu.com"</span>
driver.get(target_url)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"已成功访问：<span class="hljs-subst">{target_url}</span>，当前页面标题：<span class="hljs-subst">{driver.title}</span>"</span>)

<span class="hljs-comment"># 4. 可选：短暂延时，确保页面完全渲染（后续优先使用显式等待）</span>
time.sleep(<span class="hljs-number">2</span>)
</code></pre>
<h3 data-id="heading-3">2. 无界面模式（后台运行，不显示浏览器窗口）</h3>
<p>适合服务器运行或无需可视化的场景，节省系统资源：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 构造 Chrome 配置对象</span>
chrome_options = webdriver.ChromeOptions()
<span class="hljs-comment"># 启用无界面模式（Selenium 4.x 推荐写法）</span>
chrome_options.add_argument(<span class="hljs-string">"--headless=new"</span>)
<span class="hljs-comment"># 禁用 GPU 加速，避免部分环境报错</span>
chrome_options.add_argument(<span class="hljs-string">"--disable-gpu"</span>)

<span class="hljs-comment"># 2. 传入配置初始化浏览器</span>
driver = webdriver.Chrome(options=chrome_options)
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"无界面模式：页面标题为 <span class="hljs-subst">{driver.title}</span>"</span>)
</code></pre>
<h2 data-id="heading-4">三、核心操作1：定位页面元素（操作的前提）</h2>
<p>模拟浏览器操作的核心是「先定位元素，再执行操作」，Selenium 提供了 6 种常用定位方式，其中 <strong>ID、XPath、CSS 选择器</strong> 最为实用，优先掌握。</p>








































<table><thead><tr><th>定位方式</th><th>语法（By.XXX）</th><th>适用场景</th></tr></thead><tbody><tr><td>ID 定位</td><td><code>By.ID</code></td><td>元素 ID 唯一（高效精准，优先使用）</td></tr><tr><td>XPath 定位</td><td><code>By.XPATH</code></td><td>万能灵活，可应对复杂页面（无唯一 ID/Class 时首选）</td></tr><tr><td>CSS 选择器</td><td><code>By.CSS_SELECTOR</code></td><td>高效，与前端开发语法一致</td></tr><tr><td>Name 定位</td><td><code>By.NAME</code></td><td>元素有唯一 name 属性</td></tr><tr><td>标签名定位</td><td><code>By.TAG_NAME</code></td><td>批量查找相同标签（如所有 <code>&lt;a&gt;</code> 标签）</td></tr><tr><td>链接文本定位</td><td><code>By.LINK_TEXT</code></td><td>精准匹配 <code>&lt;a&gt;</code> 标签的完整文本</td></tr></tbody></table>
<h3 data-id="heading-5">实操示例（以百度首页为例）</h3>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. ID 定位（百度搜索框 ID 为 "kw"）</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"ID 定位成功："</span>, search_input.tag_name)

<span class="hljs-comment"># 2. XPath 定位（相对路径，容错性强）</span>
search_button = driver.find_element(By.XPATH, <span class="hljs-string">'//input[@id="su"]'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"XPath 定位成功："</span>, search_button.tag_name)

<span class="hljs-comment"># 3. CSS 选择器定位（# 表示 ID，. 表示 Class）</span>
news_link = driver.find_element(By.CSS_SELECTOR, <span class="hljs-string">'a[href="https://news.baidu.com"]'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"CSS 选择器定位成功："</span>, news_link.text)

driver.quit()
</code></pre>
<blockquote>
<p>说明：<code>driver.find_element()</code> 返回第一个匹配元素，<code>driver.find_elements()</code> 返回所有匹配元素列表（无匹配返回空列表）。</p>
</blockquote>
<h2 data-id="heading-6">四、核心操作2：模拟用户常用交互行为</h2>
<h3 data-id="heading-7">1. 输入与清空文本（如搜索框、登录输入框）</h3>
<p>使用 <code>send_keys()</code> 输入文本，<code>clear()</code> 清空输入框内容，是表单操作的核心方法。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 定位搜索框，输入关键词</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
search_input.send_keys(<span class="hljs-string">"Selenium 模拟浏览器操作"</span>)  <span class="hljs-comment"># 输入任意文本（支持中文）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已输入搜索关键词"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 2. 清空搜索框内容（可选）</span>
search_input.clear()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已清空搜索框"</span>)
time.sleep(<span class="hljs-number">1</span>)

<span class="hljs-comment"># 3. 重新输入并回车提交搜索（结合 Keys 类模拟键盘操作）</span>
search_input.send_keys(<span class="hljs-string">"Python 爬虫进阶"</span>)
search_input.send_keys(Keys.ENTER)  <span class="hljs-comment"># 模拟按下回车键</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已提交搜索，等待结果加载"</span>)
time.sleep(<span class="hljs-number">3</span>)

driver.quit()
</code></pre>
<h3 data-id="heading-8">2. 模拟点击操作（按钮、链接、复选框等）</h3>
<p>使用 <code>click()</code> 方法模拟用户左键点击，支持所有可点击元素（按钮、<code>&lt;a&gt;</code> 标签、单选框等）。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 定位搜索框，输入关键词</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
search_input.send_keys(<span class="hljs-string">"Selenium 教程"</span>)

<span class="hljs-comment"># 2. 定位搜索按钮，模拟点击提交</span>
search_button = driver.find_element(By.ID, <span class="hljs-string">"su"</span>)
search_button.click()  <span class="hljs-comment"># 核心点击方法</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"点击搜索按钮，提交查询"</span>)
time.sleep(<span class="hljs-number">3</span>)

<span class="hljs-comment"># 3. 定位搜索结果中的链接，点击跳转</span>
first_result = driver.find_element(By.XPATH, <span class="hljs-string">'//div[@id="content_left"]//a[1]'</span>)
first_result.click()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"点击第一条搜索结果，跳转新页面"</span>)
time.sleep(<span class="hljs-number">3</span>)

driver.quit()
</code></pre>
<h3 data-id="heading-9">3. 模拟页面滚动（应对滚动加载、查看更多内容）</h3>
<p>动态网页常需要滚动页面才能加载更多数据，Selenium 推荐使用 <code>execute_script()</code> 执行 JavaScript 脚本实现滚动，万能且稳定。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.runoob.com/python/python-blog.html"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 滚动到页面底部（获取完整动态数据）</span>
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, document.body.scrollHeight);"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到页面底部"</span>)
time.sleep(<span class="hljs-number">3</span>)

<span class="hljs-comment"># 2. 滚动到页面顶部</span>
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, 0);"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到页面顶部"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 3. 滚动到指定位置（横向 x=0，纵向 y=800 像素）</span>
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, 800);"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到页面 y=800 位置"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 4. 模拟逐页滚动（PageDown 键）</span>
driver.find_element(By.TAG_NAME, <span class="hljs-string">"body"</span>).send_keys(Keys.PAGE_DOWN)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已向下滚动一页"</span>)
time.sleep(<span class="hljs-number">2</span>)

driver.quit()
</code></pre>
<h3 data-id="heading-10">4. 浏览器窗口辅助操作（刷新、前进、后退、关闭）</h3>
<p>模拟用户对浏览器窗口的常用操作，完善自动化流程：</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 刷新当前页面</span>
driver.refresh()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已刷新页面"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 2. 访问新页面（为后续前进/后退做准备）</span>
driver.get(<span class="hljs-string">"https://www.runoob.com"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已访问菜鸟教程"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 3. 后退到上一个页面（百度首页）</span>
driver.back()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已后退到百度首页"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 4. 前进到下一个页面（菜鸟教程）</span>
driver.forward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已前进到菜鸟教程"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 5. 关闭浏览器（释放所有资源，推荐使用 quit() 而非 close()）</span>
<span class="hljs-comment"># driver.close()  # 关闭当前窗口（多窗口时适用）</span>
driver.quit()  <span class="hljs-comment"># 退出浏览器，释放所有资源</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"浏览器已关闭"</span>)
</code></pre>
<h2 data-id="heading-11">五、关键优化：等待元素加载（避免操作失败）</h2>
<p>动态网页存在加载延迟，直接执行操作可能会因元素未加载完成而抛出 <code>NoSuchElementException</code> 异常。Selenium 提供 3 种等待策略，<strong>显式等待</strong> 是最优选择。</p>
<h3 data-id="heading-12">1. 强制等待（最简单，不推荐）</h3>
<p>即 <code>time.sleep(seconds)</code>，固定延时，无论页面是否加载完成都等待，适合简单场景或临时调试。</p>
<pre><code class="hljs language-python" lang="python">driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 固定等待 2 秒</span>
</code></pre>
<h3 data-id="heading-13">2. 隐式等待（全局生效，中等推荐）</h3>
<p>通过 <code>driver.implicitly_wait(seconds)</code> 设置全局等待时间，在指定时间内会不断尝试定位元素，直到找到或超时。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
<span class="hljs-comment"># 设置隐式等待 10 秒（全局生效，仅对元素定位操作有效）</span>
driver.implicitly_wait(<span class="hljs-number">10</span>)
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)

<span class="hljs-comment"># 若 10 秒内找到元素则立即执行，否则抛出异常</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
search_input.send_keys(<span class="hljs-string">"隐式等待测试"</span>)
driver.quit()
</code></pre>
<h3 data-id="heading-14">3. 显式等待（灵活高效，强烈推荐）</h3>
<p>通过 <code>WebDriverWait</code> 配合 <code>expected_conditions</code>，针对单个元素设置个性化等待条件（如元素可见、可点击），超时后抛出明确异常，适合复杂动态页面。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait
<span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC

driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)

<span class="hljs-comment"># 1. 构造显式等待对象（最长等待 10 秒，每 0.5 秒检查一次条件）</span>
wait = WebDriverWait(driver, <span class="hljs-number">10</span>, poll_frequency=<span class="hljs-number">0.5</span>)

<span class="hljs-comment"># 2. 等待搜索框可点击（常用条件：element_to_be_clickable）</span>
search_input = wait.until(
    EC.element_to_be_clickable((By.ID, <span class="hljs-string">"kw"</span>)),
    message=<span class="hljs-string">"超时：未找到可点击的百度搜索框"</span>
)

<span class="hljs-comment"># 3. 元素加载完成后执行操作</span>
search_input.send_keys(<span class="hljs-string">"显式等待测试"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入成功，等待条件满足"</span>)

driver.quit()
</code></pre>
<blockquote>
<p>常用等待条件：<code>EC.visibility_of_element_located()</code>（元素可见）、<code>EC.presence_of_element_located()</code>（元素存在于 DOM 中）、<code>EC.element_to_be_clickable()</code>（元素可点击）。</p>
</blockquote>
<h2 data-id="heading-15">六、完整实战：模拟浏览器完成搜索+滚动+数据提取</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">from</span> selenium.webdriver.common.keys <span class="hljs-keyword">import</span> Keys
<span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait
<span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">simulate_browser_operation</span>():
    <span class="hljs-comment"># 1. 初始化浏览器</span>
    driver = webdriver.Chrome()
    driver.maximize_window()
    target_url = <span class="hljs-string">"https://www.baidu.com"</span>
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 2. 访问网页</span>
        driver.get(target_url)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已访问：<span class="hljs-subst">{target_url}</span>"</span>)
        
        <span class="hljs-comment"># 3. 显式等待搜索框，输入关键词并提交</span>
        wait = WebDriverWait(driver, <span class="hljs-number">10</span>)
        search_input = wait.until(
            EC.element_to_be_clickable((By.ID, <span class="hljs-string">"kw"</span>)),
            message=<span class="hljs-string">"超时：搜索框未加载完成"</span>
        )
        search_input.send_keys(<span class="hljs-string">"Selenium 模拟浏览器操作 实战"</span>)
        search_input.send_keys(Keys.ENTER)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已提交搜索，等待结果加载"</span>)
        time.sleep(<span class="hljs-number">3</span>)
        
        <span class="hljs-comment"># 4. 模拟滚动页面，查看更多结果</span>
        driver.execute_script(<span class="hljs-string">"window.scrollTo(0, 1000);"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到搜索结果中部"</span>)
        time.sleep(<span class="hljs-number">2</span>)
        
        <span class="hljs-comment"># 5. 获取页面源码，提取第一条结果标题</span>
        html_source = driver.page_source
        soup = BeautifulSoup(html_source, <span class="hljs-string">"lxml"</span>)
        first_result_title = soup.find(<span class="hljs-string">"h3"</span>, class_=<span class="hljs-string">"t"</span>).get_text(strip=<span class="hljs-literal">True</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n第一条搜索结果标题：<span class="hljs-subst">{first_result_title}</span>"</span>)
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"操作过程中出现错误：<span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 6. 关闭浏览器</span>
        time.sleep(<span class="hljs-number">2</span>)
        driver.quit()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n浏览器已关闭，操作流程结束"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    simulate_browser_operation()
</code></pre>
<h2 data-id="heading-16">七、常见问题与解决办法</h2>
<ol>
<li><strong><code>NoSuchElementException</code>（未找到元素）</strong>：① 检查定位表达式（ID、XPath）是否正确；② 页面未加载完成，替换为显式等待；③ 元素在 <code>iframe</code> 中，需先切换：<code>driver.switch_to.frame(iframe_element)</code>。</li>
<li><strong>驱动与浏览器版本不匹配</strong>：下载与浏览器大版本一致的驱动（如 Chrome 119.x 对应 ChromeDriver 119.x），避免过新或过旧。</li>
<li><strong>点击操作无响应</strong>：① 元素被遮挡（如广告弹窗），先关闭弹窗；② 元素不可点击，等待 <code>EC.element_to_be_clickable()</code> 条件满足。</li>
<li><strong>中文输入乱码</strong>：Selenium 4.x 已良好支持中文，确保浏览器编码为 UTF-8，直接使用 <code>send_keys()</code> 传入中文即可。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6小时从0到1:我用AI造了个分片SQL生成器]]></title>    <link>https://juejin.cn/post/7590433626560348195</link>    <guid>https://juejin.cn/post/7590433626560348195</guid>    <pubDate>2026-01-03T13:54:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560348195" data-draft-id="7590433626560331811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6小时从0到1:我用AI造了个分片SQL生成器"/> <meta itemprop="keywords" content="后端,SQL,AI编程"/> <meta itemprop="datePublished" content="2026-01-03T13:54:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半瓶入梦"/> <meta itemprop="url" content="https://juejin.cn/user/2757990117802792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6小时从0到1:我用AI造了个分片SQL生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2757990117802792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半瓶入梦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:54:26.000Z" title="Sat Jan 03 2026 13:54:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<p>2025年12月初,因旧系统数据修复需要,我在没有db-proxy的情况下,用6小时时间让AI从零开发了一个分片SQL生成器。纯Node.js原生实现,支持6种分片算法,包含完整UI界面和Docker部署方案。代码已开源,体验地址:shard-sql-generator-demo.bpdream.com</p>
<hr/>
<h2 data-id="heading-1">The Incident:周四下午的未定级问题</h2>
<p>那是12月初的一个周四下午,用户资金划转数据异常。</p>
<p>具体场景是这样的:我们有一个项目,需要通过脚本批量操作用户资金。脚本执行后,发现数据错误——幸运的是,错误金额小于应划转金额,没有造成资损。</p>
<p>但问题来了:需要修复数据。</p>
<p>监控系统有1小时延时,等我们发现问题时,已经过去很久了。我赶紧找相关RD拉数据,对方问:"你要哪个分片的数据?"</p>
<p>我愣住了:"分片?db-proxy不是自动路由吗?"</p>
<p>对方:"这个旧系统没有db-proxy,需要手动指定分片ID。"</p>
<p>那一刻,我脑子里闪过一个念头:这不就是典型的"日常琐事"吗?</p>
<hr/>
<h2 data-id="heading-2">The Struggle:LLM救场,但痛点犹在</h2>
<p>对方RD说:"没事,我让LLM帮我生成分片SQL。"</p>
<p>几分钟后,他发来了一堆SQL语句,每个都带着不同的分片后缀:<code>user_account_0</code>, <code>user_account_1</code>, <code>user_account_2</code>...</p>
<p>问题解决了,但我的职业病犯了:</p>
<blockquote>
<p><strong>为什么每次都要问LLM?</strong>
<strong>为什么没有一个统一的工具来处理这种需求?</strong>
<strong>为什么分片规则要记在脑子里,而不是可视化配置?</strong></p>
</blockquote>
<p>我决定:写一个工具网站。</p>
<hr/>
<h2 data-id="heading-3">The Epiphany:AI开发,6小时交付</h2>
<p>我打开Trae IDE,选择了标准智能体,模型用的是doubao-seed-code。</p>
<p>整个过程是这样的:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">gantt
    title 6小时开发时间线
    dateFormat  HH:mm
    axisFormat %H:%M

    section 需求阶段
    需求分析与技术选型        :a1, 14:00, 30m
    架构设计                :a2, after a1, 30m

    section 开发阶段
    后端核心功能实现        :b1, after a2, 2h
    前端界面开发            :b2, after b1, 2h
    API接口对接            :b3, after b2, 30m

    section 测试与部署
    功能测试与修复          :c1, after b3, 30m
    Docker部署配置          :c2, after c1, 30m
</code></pre>
<p>从下午2点开始,到晚上8点,一个完整的分片SQL生成器就上线了。</p>
<hr/>
<h2 data-id="heading-4">The System:架构设计</h2>
<h3 data-id="heading-5">技术选型:纯原生,零依赖</h3>
<p>为什么不用Express/Koa/React/Vue?</p>
<p><strong>理由很简单:</strong></p>
<ol>
<li><strong>部署成本</strong>:第三方依赖越多,部署越复杂</li>
<li><strong>安全性</strong>:依赖越少,攻击面越小</li>
<li><strong>学习成本</strong>:纯原生代码,任何Node.js开发者都能看懂</li>
<li><strong>性能</strong>:原生实现,没有框架开销</li>
</ol>
<h3 data-id="heading-6">核心架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户浏览器] --&gt; B[HTTP请求]
    B --&gt; C[Node.js原生服务器]
    C --&gt; D[路由处理]
    D --&gt; E[SQL生成器]
    D --&gt; F[分片算法引擎]
    D --&gt; G[脚本管理器]
    E --&gt; H[返回分片SQL]
    F --&gt; H
    G --&gt; H
    H --&gt; A

    style A fill:#e1f5ff
    style C fill:#fff4e1
    style H fill:#e8f5e9
</code></pre>
<h3 data-id="heading-7">分片算法支持</h3>








































<table><thead><tr><th>算法类型</th><th>适用场景</th><th>参数说明</th></tr></thead><tbody><tr><td>取模算法</td><td>数据均匀分布</td><td><code>mod</code>:取模基数</td></tr><tr><td>范围分片</td><td>有明确范围划分</td><td><code>rangeRules</code>:范围规则配置</td></tr><tr><td>哈希分片</td><td>字符串类型分片键</td><td><code>hashAlgorithm</code>:哈希算法<br/><code>numShards</code>:分片数量</td></tr><tr><td>一致性哈希</td><td>动态增减分片</td><td><code>nodes</code>:节点配置<br/><code>virtualNodes</code>:虚拟节点数</td></tr><tr><td>日期分片</td><td>时间序列数据</td><td><code>dateFormat</code>:日期格式</td></tr><tr><td>自定义脚本</td><td>特殊需求场景</td><td><code>script</code>:自定义脚本内容</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">The Implementation:核心代码解析</h2>
<h3 data-id="heading-9">SQL生成器:从原始SQL到分片SQL</h3>
<p>核心逻辑在<code>core/sql-generator.js</code>:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateShardSQL</span>(<span class="hljs-params">originalSQL, shardKey, shardValue, shardId</span>) {
  <span class="hljs-keyword">let</span> shardSQL = originalSQL;

  <span class="hljs-comment">// 1. 处理表名,添加分片后缀</span>
  <span class="hljs-keyword">const</span> fromTableRegex = <span class="hljs-regexp">/\bFROM\s+([a-zA-Z0-9_.]+)(?:\s+AS\s+([a-zA-Z0-9_]+))?\b/gi</span>;
  shardSQL = shardSQL.<span class="hljs-title function_">replace</span>(fromTableRegex, <span class="hljs-function">(<span class="hljs-params">match, table, alias</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> tableParts = table.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">const</span> baseTable = tableParts[tableParts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> schemaPrefix = tableParts.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> ? tableParts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'.'</span>) + <span class="hljs-string">'.'</span> : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> shardedTable = <span class="hljs-string">`<span class="hljs-subst">${schemaPrefix}</span><span class="hljs-subst">${baseTable}</span>_<span class="hljs-subst">${shardId}</span>`</span>;
    <span class="hljs-keyword">return</span> alias ? <span class="hljs-string">`FROM <span class="hljs-subst">${shardedTable}</span> AS <span class="hljs-subst">${alias}</span>`</span> : <span class="hljs-string">`FROM <span class="hljs-subst">${shardedTable}</span>`</span>;
  });

  <span class="hljs-comment">// 2. 添加分片键条件</span>
  <span class="hljs-keyword">const</span> shardCondition = <span class="hljs-string">`<span class="hljs-subst">${shardKey}</span> = <span class="hljs-subst">${<span class="hljs-keyword">typeof</span> shardValue === <span class="hljs-string">'number'</span> ? shardValue : <span class="hljs-string">`'<span class="hljs-subst">${shardValue}</span>'`</span>}</span>`</span>;
  <span class="hljs-keyword">const</span> whereIndex = shardSQL.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">' where '</span>);

  <span class="hljs-keyword">if</span> (whereIndex !== -<span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 已有WHERE子句,添加AND条件</span>
    <span class="hljs-keyword">const</span> whereEnd = whereIndex + <span class="hljs-number">7</span>;
    shardSQL = shardSQL.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, whereEnd) + <span class="hljs-string">`<span class="hljs-subst">${shardCondition}</span> AND `</span> + shardSQL.<span class="hljs-title function_">slice</span>(whereEnd);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 没有WHERE子句,直接添加</span>
    shardSQL += <span class="hljs-string">` WHERE <span class="hljs-subst">${shardCondition}</span>`</span>;
  }

  <span class="hljs-keyword">return</span> shardSQL;
}
</code></pre>
<p><strong>原始SQL:</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_account <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>生成后(分片ID=2,分片键=user_id=12345):</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_account_2 <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">12345</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-10">分片算法:取模算法示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> shardAlgorithms = {
  <span class="hljs-attr">mod</span>: <span class="hljs-function">(<span class="hljs-params">value, config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> num = <span class="hljs-built_in">parseInt</span>(value);
    <span class="hljs-keyword">const</span> mod = <span class="hljs-built_in">parseInt</span>(config.<span class="hljs-property">mod</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">isNaN</span>(num) ? <span class="hljs-number">0</span> : num % mod;
  }
};
</code></pre>
<p><strong>示例:</strong></p>
<ul>
<li><code>user_id = 12345</code>, <code>mod = 4</code></li>
<li><code>12345 % 4 = 1</code></li>
<li>路由到分片1</li>
</ul>
<hr/>
<h2 data-id="heading-11">The UI:现代化界面设计</h2>
<h3 data-id="heading-12">主界面布局</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[左侧面板&lt;br/&gt;分片规则配置] --&gt; B[中间面板&lt;br/&gt;SQL输入与生成]
    B --&gt; C[右侧面板&lt;br/&gt;结果展示与历史]

    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e9
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c118e669384f4a8f9a316fe3c2f5b830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2K55O25YWl5qKm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768053266&amp;x-signature=o924%2FyTlWAX5nvMz%2BxovQatnudM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">核心功能模块</h3>
<ol>
<li>
<p><strong>分片规则配置</strong></p>
<ul>
<li>6种分片算法选择</li>
<li>动态参数配置</li>
<li>自定义脚本编辑器</li>
</ul>
</li>
<li>
<p><strong>SQL输入与生成</strong></p>
<ul>
<li>SQL语法高亮</li>
<li>批量分片键值输入</li>
<li>一键生成</li>
</ul>
</li>
<li>
<p><strong>结果展示</strong></p>
<ul>
<li>分片SQL列表</li>
<li>聚合SQL生成</li>
<li>一键复制/导出</li>
</ul>
</li>
<li>
<p><strong>历史记录</strong></p>
<ul>
<li>操作历史保存</li>
<li>快速回溯</li>
<li>本地存储</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-14">The Deployment:双重部署方案</h2>
<h3 data-id="heading-15">裸机部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/skys-mission/ai-dev-demo.git
<span class="hljs-built_in">cd</span> ai-dev-demo/shard-sql-generator

<span class="hljs-comment"># 2. 启动服务</span>
node server.js

<span class="hljs-comment"># 3. 访问应用</span>
<span class="hljs-comment"># http://localhost:3000</span>
</code></pre>
<p><strong>环境要求:</strong></p>
<ul>
<li>Node.js 14.0.0 或更高版本</li>
<li>512MB 以上内存</li>
<li>100MB 以上磁盘空间</li>
</ul>
<h3 data-id="heading-16">Docker部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 构建镜像</span>
docker build -t shard-sql-generator .

<span class="hljs-comment"># 2. 运行容器</span>
docker run -d -p 3000:3000 --name shard-sql-generator shard-sql-generator

<span class="hljs-comment"># 3. 使用Docker Compose</span>
docker-compose up -d
</code></pre>
<p><strong>Dockerfile:</strong></p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:14-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000

CMD ["node", "server.js"]
</code></pre>
<hr/>
<h2 data-id="heading-17">The Impact:实际应用价值</h2>
<h3 data-id="heading-18">解决的问题</h3>
<ol>
<li><strong>效率提升</strong>:从"问LLM+手动修改"到"一键生成",节省90%时间</li>
<li><strong>错误减少</strong>:避免手动修改SQL时的拼写错误</li>
<li><strong>知识沉淀</strong>:分片规则可视化配置,不再依赖个人记忆</li>
<li><strong>团队协作</strong>:统一的工具,降低沟通成本</li>
</ol>
<h3 data-id="heading-19">适用场景</h3>
<ul>
<li><strong>数据修复</strong>:批量修复分片表数据</li>
<li><strong>数据迁移</strong>:跨分片数据迁移</li>
<li><strong>数据分析</strong>:分析特定分片的数据</li>
<li><strong>日常运维</strong>:快速生成分片SQL</li>
</ul>
<hr/>
<h2 data-id="heading-20">The Reflection:AI开发的思考</h2>
<h3 data-id="heading-21">为什么能6小时完成?</h3>
<ol>
<li><strong>需求明确</strong>:从实际问题出发,没有过度设计</li>
<li><strong>技术选型简单</strong>:纯原生实现,避免框架学习成本</li>
<li><strong>AI辅助</strong>:Trae智能体+doubao-seed-code模型,代码生成效率高</li>
<li><strong>MVP思维</strong>:先实现核心功能,再迭代优化</li>
</ol>
<h3 data-id="heading-22">AI开发的局限性</h3>
<ol>
<li><strong>上下文理解</strong>:AI对业务逻辑的理解不如人类,需要明确的需求描述</li>
<li><strong>代码质量</strong>:AI生成的代码需要人工review和优化</li>
<li><strong>调试成本</strong>:AI生成的bug需要人类调试,可能比手写更耗时</li>
<li><strong>维护性</strong>:AI生成的代码可读性可能不如手写</li>
</ol>
<h3 data-id="heading-23">最佳实践</h3>
<ol>
<li><strong>需求先行</strong>:明确需求,再让AI实现</li>
<li><strong>迭代开发</strong>:分阶段实现,每阶段验证</li>
<li><strong>代码Review</strong>:AI生成后,人工review必不可少</li>
<li><strong>测试驱动</strong>:写测试用例,确保功能正确</li>
</ol>
<hr/>
<h2 data-id="heading-24">The Code:开源与贡献</h2>
<h3 data-id="heading-25">项目地址</h3>
<ul>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fskys-mission%2Fai-dev-demo%2Ftree%2Fmain%2Fshard-sql-generator" target="_blank" title="https://github.com/skys-mission/ai-dev-demo/tree/main/shard-sql-generator" ref="nofollow noopener noreferrer">github.com/skys-missio…</a></li>
<li><strong>体验地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fshard-sql-generator-demo.bpdream.com" target="_blank" title="https://shard-sql-generator-demo.bpdream.com" ref="nofollow noopener noreferrer">shard-sql-generator-demo.bpdream.com</a></li>
</ul>
<h3 data-id="heading-26">项目结构</h3>
<pre><code class="hljs language-csharp" lang="csharp">shard-sql-generator/
├── core/                 <span class="hljs-meta"># 核心功能模块</span>
│   ├── sql-generator.js  <span class="hljs-meta"># 分片SQL生成器</span>
│   └── script-manager.js <span class="hljs-meta"># 脚本管理器</span>
├── <span class="hljs-keyword">public</span>/               <span class="hljs-meta"># 静态文件目录</span>
│   ├── index.html        <span class="hljs-meta"># 主页面</span>
│   ├── styles.css        <span class="hljs-meta"># 样式文件</span>
│   ├── app.js            <span class="hljs-meta"># 前端逻辑</span>
│   └── modules/          <span class="hljs-meta"># 功能模块</span>
│       ├── shard-algorithm.js
│       ├── sql-handler.js
│       ├── script-manager.js
│       └── history-manager.js
├── server.js             <span class="hljs-meta"># 服务器入口</span>
├── Dockerfile            <span class="hljs-meta"># Docker配置</span>
├── docker-compose.yml    <span class="hljs-meta"># Docker Compose配置</span>
└── package.json          <span class="hljs-meta"># 项目配置</span>
</code></pre>
<h3 data-id="heading-27">技术栈</h3>
<ul>
<li><strong>后端</strong>:Node.js 原生 (无第三方依赖)</li>
<li><strong>前端</strong>:HTML5 + CSS3 + JavaScript (原生)</li>
<li><strong>存储</strong>:localStorage + JSON文件</li>
<li><strong>部署</strong>:裸机部署 / Docker容器</li>
</ul>
<hr/>
<h2 data-id="heading-28">Conclusion</h2>
<p>6小时,从0到1,一个完整的分片SQL生成器。</p>
<p>这不是什么"革命性"的技术创新,但它解决了一个真实存在的痛点。</p>
<p>在大厂,我们每天都在处理各种"琐事":数据修复、SQL生成、脚本编写...这些事情看似简单,但重复劳动会消耗大量时间。</p>
<p><strong>AI的价值不在于替代人类,而在于把人类从重复劳动中解放出来,让我们专注于更有价值的事情。</strong></p>
<p>这个项目只是一个开始。未来,我会继续用AI解决更多日常琐事,并把经验分享出来。</p>
<p>如果你也有类似的需求,欢迎试用,也欢迎贡献代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战硬核！手把手教你用 Python 打造企业级 LLM 网关 (FastAPI + Asyncio 架构篇)]]></title>    <link>https://juejin.cn/post/7590654281036873771</link>    <guid>https://juejin.cn/post/7590654281036873771</guid>    <pubDate>2026-01-03T15:02:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654281036873771" data-draft-id="7590309337861619753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战硬核！手把手教你用 Python 打造企业级 LLM 网关 (FastAPI + Asyncio 架构篇)"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-03T15:02:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一直在追"/> <meta itemprop="url" content="https://juejin.cn/user/239028506736411"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战硬核！手把手教你用 Python 打造企业级 LLM 网关 (FastAPI + Asyncio 架构篇)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/239028506736411/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一直在追
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:02:00.000Z" title="Sat Jan 03 2026 15:02:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">💎 本文价值提示</h3>
<blockquote>
<p><strong>你将获得什么？</strong></p>
<ol>
<li><strong>从零构建</strong>：不再是写脚本，而是构建一个可扩展的微服务架构。</li>
<li><strong>企业级思维</strong>：掌握限流、熔断、流式传输等生产环境必备技能。</li>
<li><strong>代码即资产</strong>：一套可直接复用的 LLM Gateway 核心代码骨架。</li>
<li><strong>转型视角</strong>：看懂大数据高吞吐思维如何映射到 AI 高并发架构。</li>
</ol>
</blockquote>
<hr/>
<p>👋 <strong>大家好，我是你们的老朋友，那个正在从大数据转型 AI 架构的“老司机”。</strong></p>
<p>在前三篇文章中，我们已经完成了 Python 的“脱胎换骨”：</p>
<ul>
<li><strong>第一篇</strong>：我们用 <strong>Type Hints 和 Pydantic</strong> 戒掉了“弱类型”的随意，像写 Java 一样严谨；</li>
<li><strong>第二篇</strong>：我们用 <strong>Asyncio</strong> 征服了高并发 I/O，不再让 CPU 傻等；</li>
<li><strong>第三篇</strong>：我们用 <strong>Generator 和 Decorator</strong> 搞定了流式输出和 AOP 切面编程。</li>
</ul>
<p>今天，是时候把这些散落的珍珠串成项链了！我们将进入 <strong>Phase 4：工程化落地与架构设计</strong>。</p>
<p>我们要一起做一个 <strong>Capstone Project（毕业设计）</strong> —— <strong>企业级 LLM Gateway（大模型网关）</strong>。</p>
<hr/>
<h3 data-id="heading-1">🏗️ 为什么要造一个 LLM Gateway？</h3>
<p>在企业里，直接让业务代码调用 OpenAI 或 DeepSeek 的 API 是非常危险的。这就好比让公司的每辆车都自己去海关报关，效率低且无法管控。</p>
<p>我们需要一个 <strong>“海关总署” (Gateway)</strong> ：</p>
<ol>
<li><strong>统一计费</strong>：谁用了多少 Token，得算清楚。</li>
<li><strong>流量控制</strong>：防止某个业务线把 API Rate Limit 刷爆。</li>
<li><strong>协议转换</strong>：前端要 SSE 流式，后端要统一接口。</li>
<li><strong>安全审计</strong>：敏感词过滤，防止数据泄露。</li>
</ol>
<p><strong>技术栈选型</strong>：</p>
<ul>
<li><strong>框架</strong>：<code>FastAPI</code> (Python 界的最强黑马，性能直逼 Go)。</li>
<li><strong>校验</strong>：<code>Pydantic V2</code> (数据契约的守护神)。</li>
<li><strong>并发</strong>：<code>Asyncio</code> (高并发的核心引擎)。</li>
</ul>
<hr/>
<h3 data-id="heading-2">🧩 架构蓝图：数据是如何流动的？</h3>
<p>在我们开始写代码之前，先像设计 Flink 拓扑图一样，画出我们的架构流向。</p>
<p><img src="http://openwrite.cn/uploads/20235/58127/860d1052-faec-42e2-82b2-3b44abe459a4.png" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">🛠️ 第一步：立规矩 —— 定义数据契约 (Pydantic)</h3>
<p>做大数据出身的我们，最怕数据格式乱七八糟。在 AI 架构中，<strong>Prompt 就是 SQL，Schema 就是 Table Schema</strong>。</p>
<p>我们需要定义“输入”和“输出”的严格标准。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field, field_validator
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Literal</span>

<span class="hljs-comment"># 1. 定义消息体</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    role: <span class="hljs-type">Literal</span>[<span class="hljs-string">"system"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"assistant"</span>]
    content: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 2. 定义请求契约 (Request Contract)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatCompletionRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    model: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"模型名称，如 gpt-4, deepseek-chat"</span>)
    messages: <span class="hljs-type">List</span>[Message]
    temperature: <span class="hljs-built_in">float</span> = Field(<span class="hljs-number">0.7</span>, ge=<span class="hljs-number">0.0</span>, le=<span class="hljs-number">2.0</span>)
    stream: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>

    <span class="hljs-comment"># 💡 亮点：自定义校验，防止恶意注入过长文本</span>
<span class="hljs-meta">    @field_validator(<span class="hljs-params"><span class="hljs-string">'messages'</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_message_length</span>(<span class="hljs-params">cls, v</span>):
        total_len = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(m.content) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> v)
        <span class="hljs-keyword">if</span> total_len &gt; <span class="hljs-number">10000</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Prompt 内容过长，请精简后重试"</span>)
        <span class="hljs-keyword">return</span> v

<span class="hljs-comment"># 3. 定义响应契约 (Response Contract)</span>
<span class="hljs-comment"># 这里我们模拟 OpenAI 的标准返回格式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatCompletionResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">str</span>
    <span class="hljs-built_in">object</span>: <span class="hljs-built_in">str</span> = <span class="hljs-string">"chat.completion"</span>
    created: <span class="hljs-built_in">int</span>
    choices: <span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>]
</code></pre>
<p><strong>👨‍💻 架构师旁白</strong>：
这不仅仅是代码，这是<strong>协议</strong>。有了它，前端开发和后端开发就有了“法律依据”，不再需要口头对齐字段。</p>
<hr/>
<h3 data-id="heading-4">🚀 第二步：高并发引擎 —— 异步请求 (Asyncio)</h3>
<p>LLM 的响应通常很慢（几秒到几十秒）。如果用传统的同步代码（像 JDBC 那样），一个请求卡住，整个服务就挂了。</p>
<p>我们要用 <code>Asyncio</code> + <code>httpx</code>，实现<strong>非阻塞调用</strong>。这就像 Node.js 的事件循环，或者 Netty 的 IO 线程。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> HTTPException

<span class="hljs-comment"># 模拟从环境变量获取 Key</span>
LLM_API_KEY = os.getenv(<span class="hljs-string">"LLM_API_KEY"</span>)
LLM_BASE_URL = <span class="hljs-string">"https://api.deepseek.com/v1"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_llm_api</span>(<span class="hljs-params">request: ChatCompletionRequest</span>):
    <span class="hljs-string">"""
    异步调用上游大模型接口
    """</span>
    headers = {
        <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{LLM_API_KEY}</span>"</span>,
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
    }
    
    <span class="hljs-comment"># 💡 亮点：使用异步上下文管理器，自动释放连接</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(timeout=<span class="hljs-number">60.0</span>) <span class="hljs-keyword">as</span> client:
        <span class="hljs-keyword">try</span>:
            response = <span class="hljs-keyword">await</span> client.post(
                <span class="hljs-string">f"<span class="hljs-subst">{LLM_BASE_URL}</span>/chat/completions"</span>,
                json=request.model_dump(), <span class="hljs-comment"># Pydantic V2 序列化</span>
                headers=headers
            )
            response.raise_for_status()
            <span class="hljs-keyword">return</span> response.json()
        <span class="hljs-keyword">except</span> httpx.HTTPStatusError <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 记录日志...</span>
            <span class="hljs-keyword">raise</span> HTTPException(status_code=e.response.status_code, detail=<span class="hljs-string">"上游服务报错"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-5">🌊 第三步：极致体验 —— 流式透传 (Generator)</h3>
<p>用户不想盯着空白屏幕等 10 秒。他们想要 ChatGPT 那种“打字机”效果。
这就需要用到 Python 的 <strong>Generator (生成器)</strong> ，配合 FastAPI 的 <code>StreamingResponse</code>。</p>
<p>这在大数据领域，就是 <strong>Spark Streaming</strong> 或 <strong>Flink DataStream</strong> —— 数据来一条，处理一条，发走一条。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> AsyncGenerator

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream_llm_api</span>(<span class="hljs-params">request: ChatCompletionRequest</span>) -&gt; AsyncGenerator[<span class="hljs-built_in">str</span>, <span class="hljs-literal">None</span>]:
    <span class="hljs-string">"""
    流式生成器：像水管一样接通上游和下游
    """</span>
    headers = {
        <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{LLM_API_KEY}</span>"</span>,
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
    }
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 开启流式请求</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> client.stream(
            <span class="hljs-string">"POST"</span>, 
            <span class="hljs-string">f"<span class="hljs-subst">{LLM_BASE_URL}</span>/chat/completions"</span>, 
            json=request.model_dump(), 
            headers=headers
        ) <span class="hljs-keyword">as</span> response:
            
            <span class="hljs-comment"># 💡 亮点：逐行读取上游数据，并实时 yield 给前端</span>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> response.aiter_lines():
                <span class="hljs-keyword">if</span> line:
                    <span class="hljs-comment"># 这里可以做数据清洗、计费统计等中间处理</span>
                    <span class="hljs-keyword">yield</span> <span class="hljs-string">f"<span class="hljs-subst">{line}</span>\n\n"</span> <span class="hljs-comment"># 符合 SSE 格式</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">🛡️ 第四步：稳定性保障 —— 熔断器 (Decorator)</h3>
<p>如果上游 DeepSeek 挂了，或者网络抖动，我们不能让请求堆积把自己的网关压垮。我们需要一个 <strong>熔断器 (Circuit Breaker)</strong> 。</p>
<p>利用 Python 的 <strong>Decorator (装饰器)</strong> ，我们可以优雅地实现 AOP（面向切面编程）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps

<span class="hljs-comment"># 简单的熔断器状态</span>
CIRCUIT_OPEN = <span class="hljs-literal">False</span>
ERROR_COUNT = <span class="hljs-number">0</span>
LAST_ERROR_TIME = <span class="hljs-number">0</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">circuit_breaker</span>(<span class="hljs-params">threshold=<span class="hljs-number">5</span>, recovery_time=<span class="hljs-number">60</span></span>):
    <span class="hljs-string">"""
    装饰器：当错误次数超过 threshold 时，暂停服务 recovery_time 秒
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">        @wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
            <span class="hljs-keyword">global</span> CIRCUIT_OPEN, ERROR_COUNT, LAST_ERROR_TIME
            
            <span class="hljs-comment"># 1. 检查是否熔断</span>
            <span class="hljs-keyword">if</span> CIRCUIT_OPEN:
                <span class="hljs-keyword">if</span> time.time() - LAST_ERROR_TIME &gt; recovery_time:
                    <span class="hljs-comment"># 尝试恢复</span>
                    CIRCUIT_OPEN = <span class="hljs-literal">False</span>
                    ERROR_COUNT = <span class="hljs-number">0</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">503</span>, detail=<span class="hljs-string">"服务熔断中，请稍后重试"</span>)
            
            <span class="hljs-comment"># 2. 尝试执行</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> func(*args, **kwargs)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                ERROR_COUNT += <span class="hljs-number">1</span>
                LAST_ERROR_TIME = time.time()
                <span class="hljs-keyword">if</span> ERROR_COUNT &gt;= threshold:
                    CIRCUIT_OPEN = <span class="hljs-literal">True</span>
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 触发熔断保护！"</span>)
                <span class="hljs-keyword">raise</span> e
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator
</code></pre>
<hr/>
<h3 data-id="heading-7">🏰 第五步：集大成 —— FastAPI 入口</h3>
<p>最后，我们将所有组件组装到 <code>main.py</code> 中。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> StreamingResponse

app = FastAPI(title=<span class="hljs-string">"Enterprise LLM Gateway"</span>)

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/v1/chat/completions"</span></span>)</span>
<span class="hljs-meta">@circuit_breaker() </span><span class="hljs-comment"># 挂载熔断器</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_completions</span>(<span class="hljs-params">request: ChatCompletionRequest</span>):
    <span class="hljs-string">"""
    网关核心接口
    """</span>
    <span class="hljs-comment"># 1. 打印日志 (实际项目中应使用 logging 模块)</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到请求: <span class="hljs-subst">{request.model}</span> - <span class="hljs-subst">{<span class="hljs-built_in">len</span>(request.messages)}</span> msgs"</span>)
    
    <span class="hljs-comment"># 2. 判断是否流式</span>
    <span class="hljs-keyword">if</span> request.stream:
        <span class="hljs-comment"># 返回流式响应 (SSE)</span>
        <span class="hljs-keyword">return</span> StreamingResponse(
            stream_llm_api(request), 
            media_type=<span class="hljs-string">"text/event-stream"</span>
        )
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 返回普通 JSON</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> call_llm_api(request)

<span class="hljs-comment"># 启动命令: uvicorn main:app --reload</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">📝 总结与回顾</h3>
<p>恭喜你！你已经从一个写 <code>ETL</code> 脚本的大数据工程师，成功蜕变为能手写 <strong>高并发微服务</strong> 的 AI 架构师。</p>
<p>让我们回顾一下这个 <strong>LLM Gateway</strong> 涉及的核心能力：</p>
<ol>
<li><strong>Pydantic</strong>: 你的“数据安检员”，确保进来的数据都是合规的。</li>
<li><strong>Asyncio</strong>: 你的“交通指挥官”，让单线程也能处理成千上万的并发请求。</li>
<li><strong>Generator</strong>: 你的“流水线”，实现数据的实时流转，降低内存压力。</li>
<li><strong>Decorator</strong>: 你的“保镖”，在不侵入业务逻辑的情况下，提供熔断和重试保护。</li>
</ol>
<h4 data-id="heading-9">🧠 本文思维导图</h4>
<p><img src="http://openwrite.cn/uploads/20235/58127/88463e01-4a77-46d4-9ac4-0bf1244e3d2a.png" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">🗣️ 互动话题</h3>
<p><strong>你在转型 AI 开发的过程中，遇到的最大“坑”是什么？</strong></p>
<ul>
<li>A. 习惯了 Java 的强类型，受不了 Python 的动态类型？</li>
<li>B. 搞不懂 <code>async/await</code>，代码经常卡死？</li>
<li>C. 流式输出 (Streaming) 总是断断续续？</li>
<li>D. 依赖管理太乱，<code>pip</code> 和 <code>conda</code> 打架？</li>
</ul>
<p>👇 <strong>在评论区告诉我你的答案，或者输入关键词【网关源码】，获取本文完整的项目代码包！</strong></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全面进发 | 2025年度总结]]></title>    <link>https://juejin.cn/post/7590929624743804978</link>    <guid>https://juejin.cn/post/7590929624743804978</guid>    <pubDate>2026-01-04T02:14:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590929624743804978" data-draft-id="7590957076630781998" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全面进发 | 2025年度总结"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-04T02:14:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="枣仁"/> <meta itemprop="url" content="https://juejin.cn/user/958429872270654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全面进发 | 2025年度总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/958429872270654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    枣仁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:14:20.000Z" title="Sun Jan 04 2026 02:14:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">前言</h3>
<p>今天是2026年的第一天，又到一年一度的年度总结环节。和往年一样，我今年依然在备忘录中记录下每天的Todolist，并且在完成"大事件"时记下完成情况。今年涉猎的方面会比较多，所以我愿意用<strong>全面进发</strong>这个关键字来总结我的2025。</p>
<p>对话一下2024年，当时的展望：</p>
<ol>
<li>保持锻炼，每周至少锻炼2次（一年差不多100次） ✅</li>
</ol>

<ol start="2">
<li>学会一项新的体育技能，能作为日常的锻炼项目（暂定羽毛球，争取练到能在低端局打野球的水平）✅</li>
</ol>

<ol start="3">
<li>锻炼厨艺，保持好的饮食习惯（在家庭菜谱中至少收录100道菜品）❌</li>
</ol>

<ol start="4">
<li>至少阅读10本书（15/ 10） ✅</li>
</ol>

<ol start="5">
<li>工作上除了稳定性以外，再深耕一个其他领域（除了稳定性，在其他方向上有有些收货） ✅</li>
</ol>

<ol start="6">
<li>探索新的帮助自己成长的方式（比如听播客？锻炼时听博客一举两得？）✅</li>
</ol>
<p>除了自己多做饭以外，其他差不多都完成了，主要原因是周末基本上都没在家，做饭不太熟练，做起来比较花时间。</p>
<h3 data-id="heading-1">工作</h3>
<p>工作方面，任然保持现状，但和去年相比，今年明显没有去年那么焦虑了，工作内容、同事、合作方都达成了一定程度的默契，做事效率提升了。当然那我也有在刻意的调整自己，工作已经占用了我们太多时间了，心灵上至少可以找机会释放一下。</p>
<p>上半年的时间，主要在做一些AI探索相关的内容，虽然后来进展缓慢，但还是积累了一些经验，对AI的现状有了一些基本的认知和积累。</p>
<p>下半年主要在支持重点的项目，以及团队在年底的时候有一波调整，目前正在逐步适应和接受变化中。</p>
<h3 data-id="heading-2">锻炼</h3>
<p>今年总共锻炼了<strong>158</strong>次</p>
<ol>
<li>跑步 🏃🏻‍♀️（48次）</li>
<li>游泳 🏊🏻（42次）</li>
<li>羽毛球🏸（36次）</li>
<li>健身 💪🏻（13次）</li>
<li>篮球 🏀（3次）</li>
<li>其他（爬山、飞盘、乒乓球🏓总计12次）</li>
</ol>
<p>总的来讲，今年的锻炼频次是健康且合理的。在10月份的时候完成了首次半马，成绩（1:57:22）。并且按照年初的规划，羽毛球达到了能在野球场打球的水平（大概L2 ~ L3？）。游泳在经过教练的动作指正之后二次腿四次腿也学会了，明年争取游的更久更远。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95855b28f0344692bc7dd13b3e98ef13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=Au2h2%2BA%2FGRrTSd03TxQdqi29Qbk%3D" alt="cf531a27c12ac1467dbd74e25ae8add4.jpg" loading="lazy"/></p>
<h3 data-id="heading-3">阅读</h3>
<p>阅读对我来说不是一件很容易的事情，我大小就不是一个爱读书的人，但是今年下来也读了15本书</p>
<ul>
<li>《当下的力量》</li>
<li>《非暴力沟通》</li>
<li>《你有你的计划，世界另有计划》</li>
<li>《去遇见》</li>
<li>《好好说话》</li>
<li>《我不是教你诈》</li>
<li>《超越百岁》</li>
<li>《无伤跑法》</li>
<li>《我看见的世界》</li>
<li>《曾国藩传》</li>
<li>《我在西南联大的日子》</li>
<li>《深度工作》</li>
<li>《财富方程式》</li>
<li>《习惯的力量》</li>
<li>《理解人性》</li>
</ul>
<p>其中《当下的力量》对我当下的生活确实有了实质性的改变，治好了半夜醒来会胡思乱想的毛病，教会了我如何很好的关注当下。《超越百岁》这本书对我的帮助也很大，我读完这本书之后，让我第一次认同睡眠这件事情是真的重要的。这两本书是今年读完之后收货最大的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f59e7393ddec479986787726275b1a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=ockhqn9fQj3eStutkANGN0TgMyU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4"><strong>学习 &amp; 写作</strong></h3>
<h4 data-id="heading-5">写作</h4>
<p>今年在博客上写作的内容比较少，一部分原因是工作上的大部分内容都不方便分享，另外一方面确实也没有在仔细专研的技术内容（好吧，懈怠了）。但是工作上需要写的文档变多了，这是工作需要。</p>
<h4 data-id="heading-6">学习</h4>
<p>今年除了看书以外，学习了的有以下内容（综合）：</p>
<ol>
<li>《杨天真的32个高情商公式》</li>
<li>《贾杰的AI编程秘籍》</li>
<li>《李宇轩羽毛球》</li>
<li>《冴羽的知识星球》（这个内容有点杂，但是确实是认真看了不少）</li>
</ol>
<div>
  <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ab1e3092ce543e5b1e20efaca9c818d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=5BmtGg8vAobcDiVFVyf14w5xQ6M%3D" alt="图片1描述转存失败，建议直接上传图片文件" loading="lazy"/>
  <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47d374d1b33648088b3281d2bc1205e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=Q9VkTFHmaHNHAKyIcbRrNoTqUMY%3D" alt="图片2描述转存失败，建议直接上传图片文件" loading="lazy"/>
</div>
<h3 data-id="heading-7">生活</h3>
<h4 data-id="heading-8">旅游</h4>
<p>今年累计去了8个城市旅游，映像最深的是在福鼎晕船到想死，宜兴的泡泡简直一绝，黄山的云雾美得动人，岱山岛宁静的夜晚，我独自一人骑车在长剑大道感受这个城市...</p>
<ul>
<li>福鼎</li>
<li>临海</li>
<li>天台</li>
<li>上海</li>
<li>宜兴</li>
<li>金华</li>
<li>黄山</li>
<li>岱山岛</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e25ff925bd0140539c143694e92328ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=ithj74iisjdPJvtckpP%2B7JQxzpE%3D" alt="bb432278d59b1c5cf4e89416f4b2d9c7.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aeec2827baa4dce969aa7142efb3245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=%2BdPObRb4bettFqCJqTz6RRlmJT4%3D" alt="f608b1e19088bb566c382c56ca7e2d4c.jpg" loading="lazy"/></p>
<h4 data-id="heading-9">演唱会</h4>
<p>今年去听了孙燕姿、张杰、新裤子的演唱会，还去了常州的太湖湾音乐节。对新裤子路转粉，把乐队的夏天第一季都看了一遍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26eeca4b9cb14e67887f9a7f18c7ec8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=SV%2Bk6t5v8UrgKnd8c59oLoQeUIk%3D" alt="9569b1e814c0f2bd79cd893f84cde99a.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7068b7fbd6e2489a9ac2f998e054da5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=uNtO54xMCTmY8i%2B6teOGGzbIvZQ%3D" alt="ea3fa3d3f84828b317b639b7360843b9.jpg" loading="lazy"/></p>
<h4 data-id="heading-10">综艺娱乐</h4>
<p>今年看了好些喜剧综艺，都是我喜欢的。在周末的晚上吃着晚饭，看着综艺，笑到停不下来，真的都强烈推荐！！！</p>
<ul>
<li>《花儿与少年 · 丝路季》 ⭐️⭐️⭐️⭐️⭐️</li>
<li>《乐队的夏天第一季》 ⭐️⭐️⭐️⭐️⭐️</li>
<li>《喜剧之王单口季》 ⭐️⭐️⭐️⭐️</li>
<li>《喜人奇妙夜2》 ⭐️⭐️⭐️⭐️⭐️</li>
<li>《现在就出发2》 ⭐️⭐️⭐️⭐️⭐️</li>
</ul>
<h4 data-id="heading-11">关于婚礼</h4>
<p>在国庆的时候，办了人生中最重要的一件事情，还算比较顺利</p>
<h4 data-id="heading-12">关于🚗和自驾</h4>
<p>10月份的时候，买了辆车子，虽然生活成本有所提升，但是生活品质确实不一样（就当是一项大宗消费了）。现在周末都会考虑短途旅行，200 ~300km能开到的，都能去，目前已经自驾去了黄山、宁波、舟山，明年计划去更多的地方玩耍。</p>
<h4 data-id="heading-13">关于两秒钟计划</h4>
<p>灵感来自同事在飞书上的分享，她会用2秒钟记录每天的生活，然后每个月发一个视频，来提升自己对生活的体验。所以，今年3/4月份的时候，我也记录下了我的每一天。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.douyin.com%2Fuser%2Fself%3Fmodal_id%3D7487914507407215887" target="_blank" title="https://www.douyin.com/user/self?modal_id=7487914507407215887" ref="nofollow noopener noreferrer">20253月份全记录</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.douyin.com%2Fuser%2Fself%3Fmodal_id%3D7499460451224489231" target="_blank" title="https://www.douyin.com/user/self?modal_id=7499460451224489231" ref="nofollow noopener noreferrer">20254月份全记录</a></p>
<h4 data-id="heading-14">关于冥想</h4>
<p>最近加入了一些前辈的星球，发现冥想这个话题也在重点讨论范围内，虽然这不是我第一次听到这个概念（第一次听到这个概念是在认知觉醒这本书中，第二次是在习惯的力量），但这次是我下定决心想要把冥想认真的当作一项技能来培养，希望通过冥想能够管理好自己的精力，提升自己的专注力，更好的管理自己的情绪和睡眠</p>
<h3 data-id="heading-15">理财</h3>
<p>看了孟岩写的《投资第一课》，开始学习理财知识，比较认同他的投资观念。拿零花钱进行理财投资，投资的纪律性和人性，管理好自己的预期。</p>
<p>现在的会每周定投3只基金，每只200，这样下来一年就是3w多，能坚持5 ~ 6年的话，我估计是一笔不小的钱。</p>
<p>我当下的投资逻辑：</p>
<ol>
<li><strong>纪律，纪律，还是纪律</strong>（不自作聪明瞎操作）</li>
<li>确定定投目的：30年之后，自己的退休钱</li>
<li>按照每个月<strong>闲钱</strong>的5% ~ 10%（或者说自己的零花钱，如此一来，市场的波动才不会影响你的情绪和判断，行为产生误导）</li>
</ol>
<h3 data-id="heading-16">意外收获</h3>
<p>今年有三个意外之喜：</p>
<ol>
<li>喜欢上了羽毛球这项运动，作为我的主要运动之一，冬天能在球馆打球，身体接触少，适合现阶段的我</li>
<li>罗振宇老师的文明之旅节目。本身我就对历史文化有一些兴趣，罗老师的这档节目视角独到、内容丰富，按他的说法，这档节目要做20年，从1000年一直讲到1919年</li>
<li>播客 - 知行小酒馆。“我们关注投资，更关注如何更好的生活”，好几档节目听完都醍醐灌顶，孟岩的投资第一课也作为我投资入门课程，正式开启学习投资。</li>
</ol>
<h3 data-id="heading-17">展望</h3>
<ol>
<li>
<p>希望新的一年，能够养成记录时间的习惯</p>
<ul>
<li>每周至少有2天能够详细的记录当天的时间，以30min为做小粒度）</li>
</ul>
</li>
<li>
<p>希望新的一年，能够养成记录感受的习惯</p>
<ul>
<li>每周至少有2天能够记录下当天的感受（开心的、糟心的、灵感）</li>
</ul>
</li>
<li>
<p>希望新的一年，鼻炎能够有所改善（先尝试脱敏治疗）</p>
<ul>
<li>先尝试脱敏治疗</li>
</ul>
</li>
<li>
<p>希望新的一年，发音和表达能力能够有所精进</p>
<ul>
<li>学会胸腹式呼吸法</li>
<li>表达能力在沟通中作为加分项，得到正反馈</li>
</ul>
</li>
<li>
<p>希望新的一年，在工作上继续保持稳定，保持对新事物的热情和好奇心</p>
</li>
<li>
<p>希望新的一年，任然坚持锻炼，维持体重65kg，继续完成1 ~ 2场半马，羽毛球水平达到业务4级，自由泳能够在45min内游到2km</p>
</li>
<li>
<p>希望新的一年，能够继续保持读书的习惯，一年至少能够阅读10本书</p>
</li>
<li>
<p>希望新的一年，如果幸运的话，能找到新的热爱的东西（就像今年的羽毛球、文明之旅、知行小酒馆）</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AOP 专题]]></title>    <link>https://juejin.cn/post/7590929624743837746</link>    <guid>https://juejin.cn/post/7590929624743837746</guid>    <pubDate>2026-01-04T02:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590929624743837746" data-draft-id="7587368168621948934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AOP 专题"/> <meta itemprop="keywords" content="Spring,Spring Boot,Java"/> <meta itemprop="datePublished" content="2026-01-04T02:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AOP 专题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:16:27.000Z" title="Sun Jan 04 2026 02:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">AOP 使用</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>AOP 实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordTimeAspect</span> {

    <span class="hljs-comment">// 我要代理的路径类中的方法</span>
    <span class="hljs-meta">@Around("execution(* com.example.controller.*.*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">recordTime</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        System.out.println(<span class="hljs-string">"记录时间"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// 目标方法执行</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">proceed</span> <span class="hljs-operator">=</span> pjp.proceed();

        <span class="hljs-comment">// 获取方法签名</span>
        pjp.getSignature();

        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"方法执行耗时："</span> + (end - start));
        <span class="hljs-keyword">return</span> proceed;
    }

}

</code></pre>
<h2 data-id="heading-1">AOP 的原理</h2>
<ul>
<li>连接点：表示JoinPoint 被AOP控制的方法，包含方法信息</li>
<li>通知：Advice 表示要升级的功能，也就是AOP中升级的方法</li>
<li>切入点：PointCut 表示要匹配哪些条件</li>
<li>切面：Aspect，通知+切入点</li>
<li>目标对象：Target 通知所应用的对象，也就是原始类</li>
</ul>
<p>用Service 打印命名，可以看出是代理对象还是原类。</p>
<pre><code class="hljs language-java" lang="java">helloService.getClass().getName() <span class="hljs-comment">// 下面输出表示是代理的。</span>
<span class="hljs-comment">// com.example.service.HelloService$$EnhancerBySpringCGLIB$$2a189639</span>
</code></pre>
<h2 data-id="heading-2">通知</h2>
<p>根据通知方法执行时机的不同，将通知类型分为以下常见的五类：</p>
<ul>
<li>@Around：环绕通知，此注解标注的通知方法在目标方法前、后都被执行</li>
<li>@Before：前置通知，此注解标注的通知方法在目标方法前被执行</li>
<li>@After ：后置通知，此注解标注的通知方法在目标方法后被执行，无论是否有异常都会执行</li>
<li>@AfterReturning： 返回后通知，此注解标注的通知方法在目标方法后被执行，有异常不会执行</li>
<li>@AfterThrowing ： 异常后通知，此注解标注的通知方法发生异常后执行</li>
</ul>
<blockquote>
<p>@Around环绕通知需要自己调用 ProceedingJoinPoint.proceed() 来让原始方法执行，其他通知不需要考虑目标方法执行<br/>
@Around环绕通知方法的返回值，必须指定为Object，来接收原始方法的返回值。</p>
</blockquote>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordTimeAspect</span> {

    <span class="hljs-comment">// 定义切点</span>
    <span class="hljs-meta">@Pointcut("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pt</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-meta">@Before("pt()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        System.out.println(<span class="hljs-string">"开始执行方法："</span> + joinPoint.getSignature().getName());
    }

    <span class="hljs-meta">@Around("pt()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">recordTime</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        System.out.println(<span class="hljs-string">"记录时间"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// 目标方法执行</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">proceed</span> <span class="hljs-operator">=</span> pjp.proceed();

        <span class="hljs-comment">// 获取方法签名</span>
        pjp.getSignature();

        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"方法执行耗时："</span> + (end - start));
        <span class="hljs-keyword">return</span> proceed;
    }

    <span class="hljs-meta">@After("pt()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        System.out.println(<span class="hljs-string">"结束执行方法："</span> + joinPoint.getSignature().getName());
    }
    <span class="hljs-comment">// ret 方法的返回值</span>
    <span class="hljs-meta">@AfterReturning("pt()", returning = "ret")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">(JoinPoint joinPoint, Object ret)</span> {
        System.out.println(<span class="hljs-string">"方法正常返回，返回结果为："</span> + joinPoint.getSignature().getName());
    }

    <span class="hljs-meta">@AfterThrowing("pt()", throwing = "t")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowing</span><span class="hljs-params">(JoinPoint joinPoint, Throwable t)</span> {
        System.out.println(<span class="hljs-string">"方法异常返回，异常结果为："</span> + joinPoint.getSignature().getName());
    }

}
</code></pre>
<h2 data-id="heading-3">通知顺序</h2>
<p>如果一个方法被多个切面，切到了是都会执行的。</p>
<p>默认顺序按照类名的字母排序。</p>
<p>用 @Order(数字) 加在切面类上来控制顺序</p>
<ul>
<li>目标方法前的通知方法：数字小的先执行</li>
<li>目标方法后的通知方法：数字小的后执行</li>
</ul>
<p>大概流程是，环绕-&gt;方法运行之前，如果有多个切面，第二个切面执行，环绕-&gt;方法运行之前-&gt;方法运行结束或者方法报错 -&gt;回到环绕...如此执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(3)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordTimeAspect</span> {
</code></pre>
<h2 data-id="heading-4">切入点表达式</h2>
<ul>
<li>介绍：描述切入点方法的一种表达式。</li>
<li>作用：用来决定项目中的哪些方法需要加入通知</li>
</ul>
<p>常见形式：</p>
<ul>
<li>execution(……)：根据方法的签名来匹配</li>
<li>@annotation(……) ：根据注解匹配</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105fe17e053747c594ab3126f653e013~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098829&amp;x-signature=Zo%2FU9IS%2BCY%2FSe1XOMKNzsLvuBsE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4e0af19ff9459995231d693c7b1650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098829&amp;x-signature=aZfw7MhmsYXyWCClJ%2F8%2Fz%2BkZUDs%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>注解方式</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Before("@annotation(com.ruoyi.common.annotation.DataScope)")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBefore</span><span class="hljs-params">(JoinPoint point)</span> {

}
</code></pre>
<blockquote>
<p>注解的第二种方式，可以直接获取注解</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@DataScope(deptAlias = "dddd")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> {

<span class="hljs-comment">// 切面类中</span>
<span class="hljs-meta">@DataScope(deptAlias = "dddd")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> {
</code></pre>
<blockquote>
<p>JoinPoint 类</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Before("@annotation(dataScope)")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(JoinPoint joinPoint, DataScope dataScope)</span> {
    <span class="hljs-comment">// 获取方法名</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
    <span class="hljs-comment">// 获取目标对象</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> joinPoint.getTarget();
    <span class="hljs-comment">// 获取目标类</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> target.getClass().getName();
    <span class="hljs-comment">// 获取目标方法参数</span>
    Object[] args = joinPoint.getArgs();
    <span class="hljs-comment">// 全限命名，包名+类名</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> signature.getDeclaringTypeName();
}
</code></pre>
<p>在Spring中用JoinPoint抽象了连接点，用它可以获得方法执行时的相关信息，如目标类名、方法名、方法参数等。</p>
<ul>
<li>对于 @Around 通知，获取连接点信息只能使用  ProceedingJoinPoint</li>
<li>对于其它四种通知，获取连接点信息只能使用 JoinPoint ，它是 ProceedingJoinPoint 的父类型</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【从0到1大模型应用开发实战】03｜写一个可解释的RAG规则检索器]]></title>    <link>https://juejin.cn/post/7590592594675695626</link>    <guid>https://juejin.cn/post/7590592594675695626</guid>    <pubDate>2026-01-03T15:43:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594675695626" data-draft-id="7590601860300881947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【从0到1大模型应用开发实战】03｜写一个可解释的RAG规则检索器"/> <meta itemprop="keywords" content="后端,AIGC"/> <meta itemprop="datePublished" content="2026-01-03T15:43:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我想问问天"/> <meta itemprop="url" content="https://juejin.cn/user/2031553218095256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【从0到1大模型应用开发实战】03｜写一个可解释的RAG规则检索器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2031553218095256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我想问问天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:43:07.000Z" title="Sat Jan 03 2026 15:43:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 0 到 1 写一个“可解释”的 RAG 检索器：规则检索 V1 → V2（含可运行代码）</h2>
<p>上篇文章我们学习到了基本的Rag原理，用本地的ollama实现了一个非常简易版本的rag流程。</p>
<p>这一篇我们主要来学习下工程化的优化，用来给大模型更加准确的上下文，我们要知道： <strong>模型再强，如果某些知识不在模型训练的范围之内，甚至在网络上搜索不到很准确的信息，特别是在企业内部有很多文档和信息是网络上没有的，那么直接问大模型，输入上下文不可靠，输出就很难稳定。</strong></p>
<p>这就是 RAG（Retrieval-Augmented Generation，检索增强生成）在 AI 应用开发里最工程化的价值： <strong>把我该给模型什么上下文这件事，从玄学变成可控的检索系统。</strong></p>
<p>这一篇我们用一个完全可运行的小例子，专注讲清楚RAG里面这个R（检索）的部分： 如何在没有向量库、没有 embedding 的情况下，先实现一个 <strong>可解释、可控、可迭代</strong> 的“规则检索器”，并展示从 V1 到 V2 的演进思路。虽然没有用到哪些高级组件，但是手写的代码一步步迭代，其实我们更加能明白工程化为什么要做这些事情，为后面引入向量库，做混合检索做了铺垫。</p>
<p>本文代码对应 examples/rag/chapter02/ 下三个文件：</p>
<ul>
<li>ex04_rag_retrieve_rule_v1.py：规则检索 V1（基础可用）</li>
<li>ex05_retrieve_result.py：V2 的结果结构（可解释性）</li>
<li>ex05_rag_retrieve_rule_v2.py：规则检索 V2（打分 + 命中规则）</li>
</ul>
<h3 data-id="heading-1">1. 规则检索：它是什么？适合什么时候用？</h3>
<p>在 RAG 里，“检索”并不只有向量检索。我们完全可以先从 <strong>规则检索</strong> 起步。</p>
<h4 data-id="heading-2">1.1 规则检索 vs 向量检索（我们现在更需要哪个？）</h4>
<ul>
<li>
<p><strong>规则检索</strong></p>
<ul>
<li>优点：可解释、可控、上线快、无依赖（不需要向量库 / embedding）</li>
<li>缺点：覆盖面有限，规则维护成本会上升</li>
<li>适合：内部知识库早期、文档结构清晰、关键词/项目代号明显、需要强可控的场景</li>
</ul>
</li>
<li>
<p><strong>向量检索</strong></p>
<ul>
<li>优点：语义召回强，对同义改写更友好</li>
<li>缺点：解释性弱；需要 embedding、向量库；调参（chunk、topk、阈值）更“工程化”</li>
<li>适合：知识面大、表达多样、需要更强召回的场景</li>
</ul>
</li>
</ul>
<p><strong>一个很实用的路线</strong>： 先用规则检索把系统跑起来（保证可控 + 可解释），再逐步引入向量检索补召回，最终形成"混合检索"。RAG里面的R就是在用各种方式来提高检索的质量，一个是找到更多可能的信息，第二个是在可能的信息里面找到最相关的一些信息。下面的多个规则来检索就是为了找到更多的信息，保证不会漏掉有用的信息，然后里面的给信息打分就是为了找到最相关最匹配的文段。</p>
<h4 data-id="heading-3">1.2 规则检索 vs 搜索引擎（技术思路很相似）</h4>
<p>我们在举一个例子和我们平常用到非常多的浏览器搜索一样，如果你熟悉搜索引擎的工作原理，会发现规则检索的思路其实很相似：</p>
<ul>
<li><strong>查询预处理</strong>：搜索引擎会分词、去停用词、拼写纠错；我们的 normalize_query 也是去噪声词、提取关键词</li>
<li><strong>关键词匹配</strong>：搜索引擎用倒排索引（关键词 → 文档列表）；我们直接在 page_content 中匹配关键词</li>
<li><strong>评分排序</strong>：搜索引擎用 TF-IDF、BM25 等综合评分；我们的 V2 用 score 机制（内容命中+3、项目名+2 等）</li>
<li><strong>过滤机制</strong>：搜索引擎按时间、类型、站点过滤；我们按 metadata（项目、类型、权限）过滤</li>
<li><strong>可解释性</strong>：搜索引擎会高亮匹配词；我们的 V2 用 hit_rules 记录命中原因</li>
</ul>
<p><strong>核心区别</strong>：</p>
<ul>
<li>搜索引擎面向全网（亿级数据），目标是"找到相关网页，用户自己阅读"</li>
<li>RAG 规则检索面向企业内部知识库（千到万级），目标是"找到精确文档，给 LLM 做上下文"</li>
</ul>
<p>所以 RAG 检索对<strong>精确性</strong>要求更高（宁可少召回，也不能误导 LLM），而搜索引擎更注重<strong>召回率</strong>（宁可多召回，让用户自己筛选）。</p>
<hr/>
<h3 data-id="heading-4">2. 这三个文件在做什么（先建立整体视角）</h3>
<p>它们合起来的目标很简单： 给定用户 query，从一组 Document 里挑出最相关的 top_k 条。</p>
<p>我们可以把它理解成一个最小 RAG 检索模块：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21ba0507fff4558975d332476dfc1cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5oOz6Zeu6Zeu5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059787&amp;x-signature=qOyi9v9lVXHCwQLRlN5xI0X%2F%2FeU%3D" alt="image-20260103233046682" loading="lazy"/></p>
<p>在代码里我们用 langchain_core.documents.Document 来承载文档内容与元数据（page_content + metadata），而不是自己在造一个对象，是为了以后无缝接入 LangChain 的后续链路。</p>
<hr/>
<h3 data-id="heading-5">3. V1：能跑起来的规则检索（ex04_rag_retrieve_rule_v1.py）</h3>
<p>V1 的关键词：简单、直观、可运行。 它做了两件关键事：</p>
<ol start="0">
<li>把 query 做"降噪"，变成高信息密度关键词（normalize_query） 注：这一步其实非常重要，如果我们把这个步骤去掉，在我们使用纯规则去匹配的情况下，比如只用了关键词，然后问题是“什么是蓝精灵协议”，这个就匹配不出来。或者用户的问题有很多的没用信息“今天我吃了三个冰淇淋，两个水果，告诉我什么是蓝精灵协议？” 这也很令人头痛，用户带了很多没用的信息，甚至比要检索的东西还多，这个在真实场景里面是极有可能发生的。所以需要做降噪，去掉无用的信息（就是噪声），我们这里主要是为了方便演示，所以只做了简单的规则，去掉"什么是？"，“请介绍”等简单的词语，你只要明白要有个处理的过程就行，具体真正的生产场景比这个复杂太多。</li>
</ol>

<ol start="2">
<li>按一组规则筛选 Document，并返回 top_k（retrieve）</li>
</ol>
<h4 data-id="heading-6">3.1 Query 降噪：把自然语言变成关键词</h4>
<p>V1 的 normalize_query 用非常朴素但有效的方法：</p>
<ul>
<li>去掉“什么是/请介绍/吗/？”等口水词</li>
<li>按空格和标点切分</li>
<li>去掉过短的 token</li>
</ul>
<p>核心片段（与源码一致，做了缩短便于阅读）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_query</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    q = query.lower().strip()
    noise_patterns = [<span class="hljs-string">r"什么是"</span>, <span class="hljs-string">r"请介绍"</span>, <span class="hljs-string">r"介绍一下"</span>, <span class="hljs-string">r"是什么"</span>, <span class="hljs-string">r"如何"</span>, <span class="hljs-string">r"怎么"</span>, <span class="hljs-string">r"吗"</span>, <span class="hljs-string">r"?"</span>, <span class="hljs-string">r"？"</span>]
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> noise_patterns:
        q = re.sub(p, <span class="hljs-string">""</span>, q)
    tokens = re.split(<span class="hljs-string">r"\s+|，|,|。|；|;"</span>, q)
    tokens = [t.strip() <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tokens <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(t.strip()) &gt;= <span class="hljs-number">2</span>]
    <span class="hljs-keyword">return</span> tokens
</code></pre>
<p>我们会发现：这一步不"智能"，但它是 <strong>工程上最划算的第一步</strong>。 因为它把后续规则命中率显著提高，同时可解释、可调。</p>
<h4 data-id="heading-7">3.2 V1 的五层规则（从强到弱）</h4>
<p>V1 的 retrieve 里，规则是分层的（非常重要）：</p>
<ol start="0">
<li><strong>强规则短路</strong>：项目名直命中（如 aurora-42）就直接返回（保证"我问项目就一定拿到项目文档"）</li>
<li><strong>关键词命中</strong>：任何关键词出现在正文，就收集为候选</li>
<li><strong>metadata 过滤</strong>：例如问协议,就只保留 doc_type == protocol</li>
<li><strong>去重</strong></li>
<li><strong>TopK 截断</strong></li>
</ol>
<p>我们可以把它当成一条"可控管道"，每一步都能解释。</p>
<h4 data-id="heading-8">3.3 运行 V1</h4>
<p>在项目根目录执行：</p>
<pre><code class="hljs language-bash" lang="bash">python examples/rag/chapter02/ex04_rag_retrieve_rule_v1.py
</code></pre>
<p>我们会看到每个 query 返回的 Document 列表。 这就是最小可用的规则检索器：不花哨，但能把检索这件事落地。</p>
<hr/>
<h3 data-id="heading-9">4. V2：加入打分与可解释性（ex05_retrieve_result.py + ex05_rag_retrieve_rule_v2.py）</h3>
<p>V1 的问题是： 命中了就是命中，但“谁更相关”缺少排序依据；也很难解释“为什么命中”。虽然反复执行得到的结果是一样的，但是你没法解释，哪一条应该是放到最前面，最可能是用户想问的。那么咱们就升级到V2版本。</p>
<p>V2 的升级目标很明确：</p>
<ol start="0">
<li>每个候选文档都有一个 <strong>score</strong></li>
<li>每个候选文档记录 <strong>命中规则 hit_rules</strong>（解释性）</li>
<li>最后按 score 排序，取 top_k</li>
</ol>
<h4 data-id="heading-10">4.1 用数据类承载“可解释结果”</h4>
<p>ex05_retrieve_result.py 定义了一个非常干净的结构：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
​
<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RetrieveResult</span>:
    document: Document
    score: <span class="hljs-built_in">int</span>
    hit_rules: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]
</code></pre>
<p>这个结构特别关键： 它把检索结果从 Document 本体里拆开，避免把评分与解释塞进 metadata变得混乱。</p>
<h4 data-id="heading-11">4.2 V2 的打分规则（工程上最常用的套路）</h4>
<p>V2 做了三类规则，并给不同权重：</p>
<ul>
<li><strong>R1：内容关键词命中</strong>（+3）</li>
<li><strong>R2：项目名命中</strong>（+2）</li>
<li><strong>R3：协议类过滤命中</strong>（+2）</li>
</ul>
<p>同时把每次命中的规则写进 hit_rules，例如：</p>
<ul>
<li>content_hit:蓝精灵协议</li>
<li>project_hit:aurora-42</li>
<li>protocol_match</li>
</ul>
<p>核心逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">def retrieve(query: str, top_k: <span class="hljs-attr">int</span> = <span class="hljs-number">3</span>) -&gt; List[Document]:
    <span class="hljs-attr">keywords</span> = normalize_query(query)
    results: List<span class="hljs-section">[RetrieveResult]</span> = <span class="hljs-section">[]</span>
​
    for doc in DOCUMENTS:
        <span class="hljs-attr">score</span> = <span class="hljs-number">0</span>
        <span class="hljs-attr">hit_rules</span> = []
​
        <span class="hljs-attr">content_lower</span> = doc.page_content.lower()
​
        <span class="hljs-comment"># ---------- R1：内容关键词命中 ----------</span>
        for kw in keywords:
            if kw in content_lower:
                score += 3
                hit_rules.append(f"content_hit:{kw}")
​
        <span class="hljs-comment"># ---------- R2：项目名命中 ----------</span>
        <span class="hljs-attr">project</span> = doc.metadata.get(<span class="hljs-string">"project"</span>, <span class="hljs-string">""</span>).lower()
        for kw in keywords:
            if kw in project:
                score += 2
                hit_rules.append(f"project_hit:{kw}")
​
        <span class="hljs-comment"># ---------- R3：协议类文档 ----------</span>
        if ("协议" in query or "protocol" in query.lower()) \
           and doc.metadata.get("doc_type") == "protocol":
            score += 2
            hit_rules.append("protocol_match")
​
        if score &gt; 0:
            results.append(
                RetrieveResult(
                    <span class="hljs-attr">document</span>=doc,
                    <span class="hljs-attr">score</span>=score,
                    <span class="hljs-attr">hit_rules</span>=hit_rules
                )
            )
​
    <span class="hljs-comment"># ---------- 排序 ----------</span>
    results.sort(<span class="hljs-attr">key</span>=lambda x: x.score, reverse=<span class="hljs-literal">True</span>)
​
    <span class="hljs-comment"># ---------- DEBUG（强烈建议我们保留） ----------</span>
    for r in results:
        print(f"<span class="hljs-section">[score={r.score}]</span> <span class="hljs-attr">rules</span>={r.hit_rules}<span class="hljs-string">")
        print(r.document.page_content)
        print("</span>----<span class="hljs-string">")
​
    return [r.document for r in results[:top_k]]
</span></code></pre>
<h4 data-id="heading-12">4.3 为什么 V2 更“能上线”？</h4>
<p>因为它解决了 RAG 检索工程化的两大痛点：</p>
<ul>
<li><strong>排序可控</strong>：我们可以通过权重调节"更相关"的定义</li>
<li><strong>解释可追踪</strong>：线上出现 badcase，可以快速定位规则与权重</li>
</ul>
<p>此外，V2 还保留了非常建议我们保留的 DEBUG 输出：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[score=<span class="hljs-subst">{r.score}</span>] rules=<span class="hljs-subst">{r.hit_rules}</span>"</span>)
</code></pre>
<h4 data-id="heading-13">4.4 运行 V2</h4>
<p>在项目根目录执行：</p>
<pre><code class="hljs language-bash" lang="bash">python examples/rag/chapter02/ex05_rag_retrieve_rule_v2.py
</code></pre>
<p>我们会看到每条候选文档的 score 与 hit_rules，从而直观看到"为什么它排在前面"。</p>
<hr/>
<h3 data-id="heading-14">5. 展示建议：生产场景一般怎么定义规则？</h3>
<p>下面给一套更贴近生产的规则定义方式（不讲概念，直接给方法）。核心原则：<strong>从强到弱</strong>、<strong>可解释</strong>、<strong>可开关</strong>、<strong>可回滚</strong>。</p>
<h4 data-id="heading-15">5.1 先定义强规则（必须命中、允许短路）</h4>
<p>强规则通常来自业务里的“唯一标识”，命中就直接返回（或强加分）：</p>
<ul>
<li><strong>ID/编号类</strong>：项目代号（aurora-42）、工单号、合同号、设备编号、产品型号</li>
<li><strong>专有名词类</strong>：协议名、系统名、模块名、内部缩写</li>
<li><strong>固定问法类</strong>：例如“某某项目启动时间”“某某协议定义是什么”</li>
</ul>
<p>落地建议：</p>
<ul>
<li><strong>先做抽取</strong>：用正则/词典把这些标识从 query 里抽出来（类似 V1 的 normalize_query，但更“业务化”）</li>
<li><strong>做索引</strong>：把文档按 project/doc_type/version/owner 等 metadata 建索引，强规则命中直接从索引取候选</li>
</ul>
<h4 data-id="heading-16">5.2 再定义加分规则（决定排序）</h4>
<p>把“相关性”拆成多条可加权的信号，并记录到 hit_rules（类似 V2 的做法）：</p>
<ul>
<li><strong>内容命中</strong>：关键词出现在 page_content（可按词频、位置、标题加权）</li>
<li><strong>字段命中</strong>：关键词命中 metadata（例如 project、doc_type、tags）</li>
<li><strong>意图匹配</strong>：query 含“协议/流程/报错/部署”等意图词 → 只给对应类型文档加分</li>
</ul>
<p>落地建议：</p>
<ul>
<li><strong>所有加分都要可追踪</strong>：像 content_hit:xxx、project_hit:xxx、protocol_match 这样记录命中原因</li>
<li><strong>权重用配置管理</strong>：把 +3/+2 做成可调参数，便于线上快速调优</li>
</ul>
<h4 data-id="heading-17">5.3 最后定义过滤规则（做安全与边界）</h4>
<p>过滤规则一般用于把“不该给模型看的”或“明显不相关的”剔掉：</p>
<ul>
<li><strong>权限过滤</strong>：按部门/角色/租户过滤（最常见）</li>
<li><strong>版本过滤</strong>：只保留最新版本或指定版本（避免旧文档污染）</li>
<li><strong>类型过滤</strong>：问"协议"只保留 doc_type == protocol</li>
</ul>
<p>落地建议：</p>
<ul>
<li><strong>过滤优先级高于加分</strong>：先过滤再排序，避免无权限文档进入候选集</li>
<li><strong>每条规则可独立开关</strong>：出问题可以快速回滚（线上非常关键）</li>
</ul>
<hr/>
<h3 data-id="heading-18">6. 总结：从规则开始，把 RAG 做成工程</h3>
<p>这篇我们用 chapter02 的三个文件，实现了一个可运行,可解释,可迭代 的规则检索器，并展示了 V1 → V2 的演进：</p>
<ul>
<li>V1：规则管道 + 简单可用</li>
<li>V2：引入结果结构 + 打分排序 + 命中规则解释</li>
</ul>
<p>后续我们可以继续往前走两步，就是我后面要写的教程：</p>
<ol start="0">
<li>用向量检索补召回（embedding + vector store）</li>
<li>做混合检索（规则检索做强约束，向量检索做召回补充）</li>
</ol>
<p>到这里，我们会真正把"AI 应用开发"从调用模型，走向可控的系统工程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 2025 年 12 月 GitHub 十大热门项目排行榜 🔥]]></title>    <link>https://juejin.cn/post/7591079707698315274</link>    <guid>https://juejin.cn/post/7591079707698315274</guid>    <pubDate>2026-01-04T02:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591079707698315274" data-draft-id="7590735421261774889" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 2025 年 12 月 GitHub 十大热门项目排行榜 🔥"/> <meta itemprop="keywords" content="GitHub,人工智能,前端"/> <meta itemprop="datePublished" content="2026-01-04T02:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一点一木"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986187486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 2025 年 12 月 GitHub 十大热门项目排行榜 🔥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986187486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一点一木
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:38:20.000Z" title="Sun Jan 04 2026 02:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎来到 <strong>2025 年 12 月 <code>GitHub</code> 热门开源项目排行榜</strong>！本月榜单继续聚焦 <code>AI Agent</code> 生态的深度演进、终端优先的开源替代、语音生成技术的全面爆发，以及高性能基础设施与标准化协作规范的崛起。这十个项目涵盖了从编码代理持久记忆到可视化 <code>Agent</code> 构建平台、从 <code>Rust</code> 高性能存储到领先开源 <code>TTS</code> 模型，清晰展现出当下三大核心趋势：</p>
<ul>
<li><strong><code>Agent</code> 生态成熟化</strong>：持久记忆、可视化构建、标准化指导与快速启动模板全面开花</li>
<li><strong>终端与开源替代浪潮</strong>：终端优先编码代理、<code>AI</code> 代理专用规范强势崛起</li>
<li><strong>多模态与基础设施升级</strong>：语音生成模型集体 <code>SOTA</code>、高性能存储与本地化框架并进</li>
</ul>
<p>它们不再是概念验证，而是真正能直接落地上线的生产力工具。快来一起看看本月十大热门！</p>
<ol>
<li>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthedotmack%2Fclaude-mem" target="_blank" title="https://github.com/thedotmack/claude-mem" ref="nofollow noopener noreferrer"><code>Claude-Mem</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>9.4K+</code></strong></p>
<p>🧠 <strong><code>Claude Code</code> 的持久记忆插件</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24a6940c0654da6a14d995db73add5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=RBA1FzfQOFEuBFzfVS0cv7qtovU%3D" alt="claude-men" loading="lazy"/></p>
<p><strong><code>Claude-Mem</code></strong> 能自动捕捉编码会话中 <code>Claude</code> 的所有操作，使用 <code>AI</code>（基于 <code>Claude agent-sdk</code>）压缩上下文，并在后续会话中智能注入相关记忆，实现真正的跨会话知识连续性，彻底解决 <code>Claude</code> 「失忆」的痛点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffbd56bfca0848d1829b6012ad978152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=l8LeyCJAicgekyZUn9IAV4w4i8A%3D" alt="cm-preview" loading="lazy"/></p>
<p>它通过生命周期钩子、后台 <code>worker</code> 服务、<code>SQLite</code> 存储和 <code>Chroma</code> 向量数据库，实现语义摘要生成与高效检索，支持渐进式上下文注入，确保 <code>token</code> 使用最优化。</p>
<ul>
<li><strong>持久记忆</strong> ：上下文自动跨会话存活，新会话无需手动恢复历史</li>
<li><strong>渐进式披露</strong> ：分层注入记忆，显示 <code>token</code> 成本，避免 <code>overload</code></li>
<li><strong>技能搜索</strong> ：内置 <code>mem-search</code>，支持自然语言查询项目历史</li>
<li><strong><code>Web</code> 查看器 <code>UI</code></strong> ：实时监控记忆流</li>
<li><strong>隐私控制</strong> ：使用 <code>&lt;private&gt;</code> 标签排除敏感内容不存储</li>
<li><strong>自动运行</strong> ：全程后台智能处理，无需手动干预</li>
</ul>
<p>💡 <strong><code>Claude-Mem</code></strong> 适合重度使用 <code>Claude Code</code> 开发中大型项目的工程师，能显著提升开发连续性、节省 <code>token</code>，尤其在长期迭代场景下价值巨大。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthedotmack%2Fclaude-mem" target="_blank" title="https://github.com/thedotmack/claude-mem" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Fhello-agents" target="_blank" title="https://github.com/datawhalechina/hello-agents" ref="nofollow noopener noreferrer"><code>Hello-Agents</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>13.2K+</code></strong></p>
<p>📚 <strong><code>Datawhale</code> 社区出品的从零构建 <code>AI Native Agent</code> 开源教程</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5438c2cf83ea4b22bde5653ef566b947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=kOXtZa2%2Fpd4BktKlnMA74fKPz2k%3D" alt="hello-agents" loading="lazy"/></p>
<p><strong><code>Hello-Agents</code></strong> 是 <code>Datawhale</code> 推出的系统性智能体学习项目，在 2025 <code>Agent</code> 元年背景下填补了重实践教程的空白，帮助开发者从 <code>LLM</code> 使用者转变为真正的智能体系统构建者。</p>
<p>项目提供完整学习路径，涵盖 <code>Agent</code> 基础原理、经典范式（如 <code>ReAct</code>）、低代码平台与主流框架实战、记忆检索、通信协议、<code>Agentic-RL</code> 训练、性能评估，以及多个真实综合案例，全部内容开源免费并支持社区贡献。</p>
<ul>
<li><strong>理论实战并重</strong> ：从核心概念到自研框架 <code>HelloAgents</code> 的完整实现</li>
<li><strong>多路径学习</strong> ：覆盖 <code>Coze/Dify</code> 等低代码、<code>LangGraph/AutoGen</code> 等框架及从零构建</li>
<li><strong>高级技术覆盖</strong> ：记忆检索、上下文工程、<code>MCP/A2A</code> 协议、<code>Agentic-RL</code> 全流程</li>
<li><strong>真实案例驱动</strong> ：智能旅行助手、深度研究 <code>Agent</code>、赛博小镇等实战项目</li>
<li><strong>社区共建支持</strong> ：<code>Extra-Chapter</code> 贡献、面试题总结、<code>PDF</code> 下载与持续更新</li>
</ul>
<p>💡 <strong><code>Hello-Agents</code></strong> 适合具备 <code>Python</code> 基础、对 <code>LLM</code> 有初步了解的 <code>AI</code> 开发者、学生与自学者，尤其在求职面试、个人项目或深入 <code>Agent</code> 技术时价值巨大。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Fhello-agents" target="_blank" title="https://github.com/datawhalechina/hello-agents" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer"><code>RustFS</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>18.5K+</code></strong></p>
<p><strong>🚀 用 <code>Rust</code> 编写的 <code>S3</code> 兼容高性能分布式对象存储</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e2b25084e954f88bee3de5c3a67b175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=pbh71ZZUFgbeMHmmJx1lY6kXOMw%3D" alt="RustFS" loading="lazy"/></p>
<p><strong><code>RustFS</code></strong> 是一个开源的分布式对象存储系统，结合 <code>MinIO</code> 的简易性和 <code>Rust</code> 的内存安全与极致性能，提供完整的 <code>S3 API</code> 兼容性，支持与 <code>MinIO</code>、<code>Ceph</code> 等平台的无缝迁移与共存，尤其适合数据湖、<code>AI</code> 和大数据工作负载。</p>
<p>它在小对象场景下性能突出（4KB 对象负载比 <code>MinIO</code> 快 2.3 倍），采用 <code>Apache 2.0</code> 开源协议、无遥测数据上传，确保合规性，同时支持单节点与分布式部署（分布式模式持续完善中）。</p>
<ul>
<li><strong>极致性能</strong> ：<code>Rust</code> 实现，<code>4KB</code> 小对象场景下 2.3x 快于 <code>MinIO</code></li>
<li><strong>完整 <code>S3</code> 兼容</strong> ：无缝替代或迁移 <code>MinIO/Ceph</code> 等现有系统</li>
<li><strong>分布式架构</strong> ：支持水平扩展与容错，适用于大规模存储</li>
<li><strong><code>Apache 2.0</code> 许可</strong> ：无 <code>AGPL</code> 限制，完全开源无遥测</li>
<li><strong>数据保护</strong> ：内置 <code>Bitrot</code> 保护与版本控制</li>
<li><strong>易部署管理</strong> ：提供 <code>Helm</code> 图表、<code>Docker</code> 多架构镜像与 <code>Nix</code> 支持</li>
</ul>
<p>💡 <strong><code>RustFS</code></strong> 适合需要高性能 <code>S3</code> 兼容存储的企业、<code>AI</code>/大数据团队，以及追求许可自由与隐私合规的开发者，尤其在边缘/<code>IoT</code> 或小对象密集场景下优势明显。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsimstudioai%2Fsim" target="_blank" title="https://github.com/simstudioai/sim" ref="nofollow noopener noreferrer"><code>sim</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>24.6K+</code></strong></p>
<p>🤖 <strong>开源可视化平台，用于构建和部署 <code>AI Agent</code> 工作流</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed320e9b476d4c7192c0904b12148f49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=XH1VE3sp4BCbvESCtnD2Atb2k8E%3D" alt="sim" loading="lazy"/></p>
<p><strong><code>sim</code></strong> 是一个强大的开源工具，让开发者通过拖拽式画布可视化设计、连接和运行 <code>AI Agent</code> 工作流，支持自然语言 <code>Copilot</code> 辅助生成节点，帮助快速构建复杂自动化流程。</p>
<p>它内置向量数据库支持文档上传与 <code>RAG</code> 问答，完美兼容本地/自托管模型（如 <code>Ollama</code> 和 <code>vLLM</code>），提供完整自部署能力，彻底实现隐私可控的 <code>Agent</code> 系统开发与生产部署。</p>
<ul>
<li><strong>可视化画布</strong> ：拖拽连接 <code>Agent</code>、工具和模块，快速设计复杂工作流</li>
<li><strong><code>Copilot</code> 辅助</strong> ：自然语言生成节点、修复错误、迭代优化流程</li>
<li><strong>向量数据库集成</strong> ：上传文档实现内容接地式 <code>RAG</code> 查询</li>
<li><strong>本地模型支持</strong> ：无缝对接 <code>Ollama</code>（<code>CPU/GPU</code>）和 <code>vLLM</code> 自托管推理</li>
<li><strong>完整自部署</strong> ：<code>Docker</code>、一键 <code>NPM</code> 或手动 <code>Bun/Node</code> 部署，无云依赖</li>
<li><strong>实时与后台任务</strong> ：<code>Socket.io</code> 实时交互 + <code>Trigger.dev</code> 后台作业</li>
</ul>
<p>💡 <strong><code>sim</code></strong> 适合希望快速原型化、测试和生产部署 <code>AI Agent</code> 工作流的开发者与团队，尤其在需要本地化、隐私保护或自定义 RAG 场景下表现出色。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsimstudioai%2Fsim" target="_blank" title="https://github.com/simstudioai/sim" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsst%2Fopencode" target="_blank" title="https://github.com/sst/opencode" ref="nofollow noopener noreferrer"><code>OpenCode</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>43.6K+</code></strong></p>
<p>🤖 <strong>开源终端优先的 <code>AI</code> 编码代理</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5de4a08ffe29424584e081d02746e31c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=rwh5tEfLQRGH7Kvod1TEZ94AOxk%3D" alt="OpenCode" loading="lazy"/></p>
<p><strong><code>OpenCode</code></strong> 是完全开源的 <code>AI</code> 编码代理，采用终端界面（<code>TUI</code>）设计，支持多模型提供商，通过客户端/服务器架构实现灵活部署，帮助开发者高效处理代码编写、分析与规划任务。</p>
<p>它提供双代理模式（<code>build</code> 全权限开发、<code>plan</code> 只读探索）、内置通用子代理处理复杂任务，并原生支持 <code>LSP</code> 协议，定位为 <code>Claude Code</code> 等闭源工具的强大开源替代品。</p>
<ul>
<li><strong>完全开源无绑定</strong> ：支持 <code>Claude</code>、<code>OpenAI</code>、<code>Google</code>、本地模型等多种提供商</li>
<li><strong>双代理模式</strong> ：<code>build</code> 代理全访问开发，<code>plan</code> 代理只读安全探索</li>
<li><strong>客户端/服务器架构</strong> ：支持远程控制，本地运行更灵活</li>
<li><strong>内置通用子代理</strong> ：<code>@general</code> 调用处理多步骤复杂搜索任务</li>
<li><strong>原生 <code>LSP</code> 支持</strong> ：开箱即用增强代码补全与智能辅助</li>
<li><strong>多平台部署</strong> ：<code>CLI</code>、桌面 <code>App</code>（<code>macOS/Windows/Linux</code>）、多种包管理器安装</li>
</ul>
<p>💡 <strong><code>OpenCode</code></strong> 适合终端重度用户、<code>Neovim</code> 爱好者以及需要开源、可自定义 <code>AI</code> 编码助手的开发者，尤其在处理大型或陌生代码库时表现出色。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsst%2Fopencode" target="_blank" title="https://github.com/sst/opencode" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentsmd%2Fagents.md" target="_blank" title="https://github.com/agentsmd/agents.md" ref="nofollow noopener noreferrer"><code>AGENTS.md</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>13.5K+</code></strong></p>
<p>📝 <strong>专为 <code>AI</code> 编码代理设计的开源指导文件格式</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e620f6dd35c4dc9a3c7beba60de0c27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=cU9mXICPkZuQ0gPAsh2SJ7M7cbw%3D" alt="AGENTS" loading="lazy"/></p>
<p><strong><code>AGENTS.md</code></strong> 提出了一种简单开放的标准：在项目根目录放置一个名为 <code>AGENTS.md</code> 的文件，专门为 <code>AI</code> 编码代理（如 <code>Claude Code</code>、<code>OpenCode</code> 等）提供上下文、开发流程、测试规范和 PR 规则，帮助代理快速理解并高效贡献代码。</p>
<p>它将传统 <code>README</code> 中的人类阅读部分与机器导向的精确指令分离，通过可预测的位置和结构化内容，显著降低 <code>AI</code> 代理在陌生代码库中的摩擦，目前已配套官网示例和社区讨论，正在推动成为行业事实标准。</p>
<ul>
<li><strong>专用代理 <code>README</code></strong> ：独立于人类 <code>README</code>，专供 <code>AI</code> 代理读取上下文和指令</li>
<li><strong>标准化结构</strong> ：涵盖开发环境、测试流程、PR 规范等关键环节</li>
<li><strong><code>Monorepo</code> 友好</strong> ：内置 <code>pnpm/Turborepo/Vitest</code> 等常见工具链指导</li>
<li><strong>强制质量门控</strong> ：明确要求 <code>lint</code>、<code>typecheck</code> 和测试通过后再提交</li>
<li><strong><code>PR</code> 标题规范</strong> ：强制带项目范围的前缀，确保变更清晰可溯源</li>
<li><strong>社区驱动开源</strong> ：完全开放格式，配套网站提供示例</li>
</ul>
<p>💡 <strong><code>AGENTS.md</code></strong> 适合所有希望与 <code>AI</code> 编码代理深度协作的团队，尤其在 <code>monorepo</code>、大型 <code>TypeScript/React</code> 项目中，能大幅提升代理贡献的准确性和效率。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentsmd%2Fagents.md" target="_blank" title="https://github.com/agentsmd/agents.md" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-quickstarts" target="_blank" title="https://github.com/anthropics/claude-quickstarts" ref="nofollow noopener noreferrer"><code>Claude Quickstarts</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>13K+</code></strong></p>
<p>🚀 <strong><code>Anthropic</code> 官方 <code>Claude API</code> 快速启动项目合集</strong></p>
<p><strong><code>Claude Quickstarts</code></strong> 是 <code>Anthropic</code> 官方推出的开源项目集合，提供多个开箱即用的模板，帮助开发者快速构建并部署基于 <code>Claude API</code> 的生产级应用，涵盖从客服代理到自主编码的多种真实场景。</p>
<p>每个 <code>Quickstart</code> 都配备完整代码、依赖和运行指南，支持最新 <code>Claude</code> 模型与工具（如浏览器自动化、电脑控制），便于自定义扩展，已成为使用 <code>Claude API</code> 开发者的首选起点。</p>
<ul>
<li><strong>多场景模板</strong> ：客服支持代理、金融数据分析师、浏览器自动化、电脑控制演示、自主编码代理</li>
<li><strong>最新工具支持</strong> ：完整实现 <code>browser_use</code> 和 <code>computer_use API</code>，包括缩放、坐标操作</li>
<li><strong>双语言实现</strong> ：<code>Python</code> 与 <code>TypeScript/JavaScript</code> 双版本覆盖主流后端/前端</li>
<li><strong>生产就绪</strong> ：集成 <code>Agent SDK</code>、<code>Playwright</code>、交互可视化与持久化进度</li>
<li><strong>持续更新</strong> ：最近新增浏览器演示与 <code>Claude Haiku 4.5</code> 支持</li>
</ul>
<p>💡 <strong><code>Claude Quickstarts</code></strong> 适合想要快速原型化或生产部署 <code>Claude</code> 应用的开发者，尤其在探索计算机使用、浏览器自动化或自主 <code>Agent</code> 场景时，能大幅缩短从零到落地的周期。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-quickstarts" target="_blank" title="https://github.com/anthropics/claude-quickstarts" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2FWeKnora" target="_blank" title="https://github.com/Tencent/WeKnora" ref="nofollow noopener noreferrer"><code>WeKnora</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>10.6K+</code></strong></p>
<p>🧠 <strong>腾讯开源的 <code>LLM</code> 驱动深度文档理解与 <code>RAG</code> 框架</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ad57c02e01d4d48885233efc5d81eed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=Uww1fHsWhKovYjYV0nhL1UHZGCE%3D" alt="WeKnora" loading="lazy"/></p>
<p><strong><code>WeKnora</code></strong> 是腾讯推出的开源框架，专注于复杂异构文档的深度理解、语义检索与上下文感知问答，采用 <code>RAG</code> 范式结合多模态预处理、向量索引、智能检索和大模型推理，提供企业级知识管理解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8521818b32a4136a399fed145fa10a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=l1YMZvJR73Isnq0rT6kuEvff9yw%3D" alt="WeKnora-architecture.png" loading="lazy"/>
它模块化架构高度解耦，支持本地/云端模型接入、混合检索策略与 <code>Agent</code> 模式扩展，已成为微信对话开放平台的核心技术框架，适用于隐私敏感与高精度文档场景。</p>
<ul>
<li><strong>深度文档解析</strong> ：精准提取 <code>PDF</code>、<code>Word</code>、图像等异构文档的结构化语义内容</li>
<li><strong>智能 <code>Agent</code> 模式</strong> ：<code>ReAct Agent</code> 支持内置工具、<code>MCP</code> 扩展与网页搜索，多轮反思生成报告</li>
<li><strong>高效混合检索</strong> ：结合关键词、向量与知识图谱，支持跨知识库检索</li>
<li><strong>多类型知识库</strong> ：支持 <code>FAQ</code>/文档库、文件夹/<code>URL</code> 导入与标签管理</li>
<li><strong>灵活扩展</strong> ：所有组件解耦，便于自定义解析、嵌入与生成流程</li>
<li><strong>本地隐私部署</strong> ：兼容 <code>Ollama</code> 等本地模型，无外部数据泄露风险</li>
</ul>
<p>💡 <strong><code>WeKnora</code></strong> 适合企业知识管理、学术研究分析、技术支持、法律合规审查与医疗知识辅助等需要高精度文档问答与本地化部署的场景。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2FWeKnora" target="_blank" title="https://github.com/Tencent/WeKnora" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fresemble-ai%2Fchatterbox" target="_blank" title="https://github.com/resemble-ai/chatterbox" ref="nofollow noopener noreferrer"><code>Chatterbox</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>19.2K+</code></strong></p>
<p>🗣️ <strong><code>Resemble AI</code> 开源的最先进文本转语音（<code>TTS</code>）模型家族</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f96d75294104ee7b5079258137834d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=tLVLDWA7jIw6z1yXibf0EEZrR%2Bc%3D" alt="Chatterbox-Turbo" loading="lazy"/></p>
<p><strong><code>Chatterbox</code></strong> 是 <code>Resemble AI</code> 推出的三个开源 <code>TTS</code> 模型系列，包括低延迟的 <code>Chatterbox-Turbo</code>（<code>350M</code> 参数、单步生成）、支持 23+ 语言的多语言版以及原版高表现力模型，提供零样本语音克隆、拟声标签和高效推理能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28194cf9e8474a48b59d6d332c0b2602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=Fh1DFpHZnEj45j1tAh3ggoAS%2Bf4%3D" alt="Chatterbox-test" loading="lazy"/></p>
<p>它内置神经水印（<code>Perth</code>）确保输出可追溯，支持夸张度调节与副语言表达（如 <code>[laugh]</code>、<code>[cough]</code>），在语音自然度、延迟和多语言支持上达到当前开源领先水平，成为构建语音代理和内容生成的首选。</p>
<ul>
<li><strong><code>Chatterbox-Turbo</code></strong> ：<code>350M</code> 参数单步生成，专为低延迟语音代理设计</li>
<li><strong>多语言零样本克隆</strong> ：<code>500M</code> 多语言模型支持 23+ 语言与参考音频即时克隆</li>
<li><strong>拟声标签支持</strong> ：原生解析 <code>[laugh]</code>、<code>[cough]</code> 等标签，提升表达真实感</li>
<li><strong>零样本语音克隆</strong> ：仅需参考音频即可合成指定声音</li>
<li><strong>内置水印保护</strong> ：所有输出嵌入 <code>Perth</code> 不可感知水印，便于追踪与负责 <code>AI</code></li>
<li><strong>高效推理</strong> ：更低显存占用，支持夸张度与 <code>CFG</code> 调节</li>
</ul>
<p>💡 <strong><code>Chatterbox</code></strong> 适合构建实时语音代理、游戏配音、多语言内容本地化、有声书制作以及需要高自然度与表达力的 <code>TTS</code> 应用开发者，尤其在低延迟或隐私敏感场景下优势突出。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fresemble-ai%2Fchatterbox" target="_blank" title="https://github.com/resemble-ai/chatterbox" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFunAudioLLM%2FCosyVoice" target="_blank" title="https://github.com/FunAudioLLM/CosyVoice" ref="nofollow noopener noreferrer"><code>CosyVoice</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>18.6K+</code></strong></p>
<p>🗣️ <strong>多语言大模型驱动的语音生成框架</strong></p>
<p><strong><code>CosyVoice</code></strong> 是 <code>FunAudioLLM</code> 团队推出的开源多语言文本转语音（<code>TTS</code>）系统，最新 <code>Fun-CosyVoice 3.0</code> 版本在内容一致性、说话人相似度和韵律自然度上达到 <code>SOTA</code>，支持零样本多语言/跨语言语音克隆与低延迟流式合成。</p>
<p>它覆盖 9 种主流语言（中、英、日、韩、德、西、法、意、俄）及 18+ 种中文方言，支持指令控制情绪、语速、音量等，提供完整推理、训练与部署能力（包括 <code>WebUI</code>、<code>Docker</code>、<code>TensorRT-LLM</code> 加速），已成为当前开源 <code>TTS</code> 领域领先选择。</p>
<ul>
<li><strong>零样本多/跨语言克隆</strong> ：仅需参考音频即可合成目标声音，支持多语言无缝切换</li>
<li><strong>低延迟流式合成</strong> ：双向流式支持，最低 <code>150ms</code> 延迟，实时交互友好</li>
<li><strong>指令精细控制</strong> ：通过自然语言指定语言、方言、情绪、语速与音量</li>
<li><strong>高自然度 <code>SOTA</code></strong> ：<code>Fun-CosyVoice 3.0</code> 在一致性、相似度与韵律上全面领先</li>
<li><strong>文本标准化</strong> ：内置处理数字、符号与拼音/音素，无需额外前端模块</li>
<li><strong>完整部署支持</strong> ：<code>WebUI</code>、<code>FastAPI/gRPC</code> 服务、<code>TensorRT-LLM 4x</code> 加速</li>
</ul>
<p>💡 <strong><code>CosyVoice</code></strong> 适合构建实时语音代理、多语言内容生成、有声书、游戏配音以及需要高自然度与本地化部署的语音应用开发者，尤其在多语言与情感表达场景下表现突出。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFunAudioLLM%2FCosyVoice" target="_blank" title="https://github.com/FunAudioLLM/CosyVoice" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
</ol>
<h3 data-id="heading-10">结论</h3>
<p>2025 年 12 月的榜单，清晰勾勒出开源社区的三大新主旋律：</p>
<ul>
<li><strong><code>Agent</code> 生态全面成熟</strong>：从持久记忆、可视化构建到标准化协作规范，<code>Agent</code> 开发门槛与效率双双飞跃</li>
<li><strong>终端优先与开源替代</strong>：终端 <code>AI</code> 编码代理与专用指导文件强势崛起，挑战闭源霸权</li>
<li><strong>多模态能力爆发</strong>：语音生成模型集体突破 <code>SOTA</code>，高自然度、低延迟、多语言支持成为新标配</li>
</ul>
<p>这些项目正推动 <code>AI</code> 从云端实验走向本地生产、从单点工具走向完整生态。未来，已在这些仓库中悄然展开。</p>
<p>📌 喜欢就去点个 <code>Star</code>，每一个 <code>Star</code> 都是对开源最大的支持！</p>
<p>📬 欢迎收藏、转发，也欢迎评论区安利你心目中的 2026 年 1 月黑马项目～</p>
<hr/>
<h3 data-id="heading-11">往期推荐</h3>
<p>喜欢本期的热门项目？以下是一些值得一读的往期精彩内容：</p>
<ol>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年11月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年12月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7461822837532213267" target="_blank" title="https://juejin.cn/post/7461822837532213267">🚀 2025年01月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7475237484085346355" target="_blank" title="https://juejin.cn/post/7475237484085346355">🚀 2025年02月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7486316823253565474" target="_blank" title="https://juejin.cn/post/7486316823253565474">🚀 2025年03月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7503762078386700298" target="_blank" title="https://juejin.cn/post/7503762078386700298">🚀 2025年04月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7508914438659735589" target="_blank" title="https://juejin.cn/post/7508914438659735589">🚀 2025年05月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7525688196605722670" target="_blank" title="https://juejin.cn/post/7525688196605722670">🚀 2025年06月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7533169614206861339" target="_blank" title="https://juejin.cn/post/7533169614206861339">🚀 2025年07月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7543830033606246419" target="_blank" title="https://juejin.cn/post/7543830033606246419">🚀 2025年08月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7555056825693634601" target="_blank" title="https://juejin.cn/post/7555056825693634601">🚀 2025年09月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7567208390368198696" target="_blank" title="https://juejin.cn/post/7567208390368198696">🚀 2025年10月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7579889969986502707" target="_blank" title="https://juejin.cn/post/7579889969986502707">🚀 2025年11月 GitHub 十大热门项目排行榜 🔥</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告警的艺术：从 node_exporter 指标到生产级规则]]></title>    <link>https://juejin.cn/post/7590330924002312255</link>    <guid>https://juejin.cn/post/7590330924002312255</guid>    <pubDate>2026-01-04T02:45:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924002312255" data-draft-id="7590283328177504299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告警的艺术：从 node_exporter 指标到生产级规则"/> <meta itemprop="keywords" content="后端,监控,架构"/> <meta itemprop="datePublished" content="2026-01-04T02:45:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告警的艺术：从 node_exporter 指标到生产级规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:45:43.000Z" title="Sun Jan 04 2026 02:45:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>凌晨 3 点，手机震动。</p>
<pre><code class="hljs language-makefile" lang="makefile">告警：server-01 CPU 使用率超过 80%
<span class="hljs-section">触发时间：03:12:45</span>
持续时长：2 分钟
</code></pre>
<p>你睁开惺忪的眼睛，登录服务器查看，发现只是 Jenkins 在跑定时编译任务。</p>
<p>这已经是本周第 12 次误报。</p>
<p>问题不在 Prometheus，也不在 node_exporter，而在<strong>告警规则的设计</strong>。</p>
<hr/>
<p>在<a href="https://juejin.cn/post/7589481566424596534" target="_blank" title="https://juejin.cn/post/7589481566424596534">《从 node-exporter 学如何写出可复用的监控指标》</a>中，我们学习了 node_exporter 的设计哲学：暴露事实，不是观点。</p>
<ul>
<li>CPU 暴露的是累计时间，不是使用率</li>
<li>内存暴露的是多个 Gauge，不是一个"使用率"</li>
<li>磁盘容量和 IO 分开设计</li>
</ul>
<p>这些"事实"很完整，但问题来了：<strong>有了指标，怎么变成告警？</strong></p>
<p>这不是简单设个阈值就行。你真的需要在 CPU 达到 80% 时立即告警吗？还是应该等它持续 10 分钟再打扰你？</p>
<p>本文聚焦一个核心问题：**基于 node_exporter 的数据，如何设计一套生产级的虚拟机告警规则？</p>
<h2 data-id="heading-0">1. 为什么需要告警规则的设计智慧</h2>
<h3 data-id="heading-1">1.1 Alertmanager 的局限</h3>
<p>很多人觉得 Prometheus 有 Alertmanager，为什么还要自研告警引擎？</p>
<p><strong>Alertmanager 的三个痛点：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Alertmanager 的配置</span>
<span class="hljs-attr">route:</span>
  <span class="hljs-attr">group_by:</span> [<span class="hljs-string">'alertname'</span>]
  <span class="hljs-attr">group_wait:</span> <span class="hljs-string">30s</span>
  <span class="hljs-attr">group_interval:</span> <span class="hljs-string">5m</span>
  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">4h</span>
  <span class="hljs-attr">receiver:</span> <span class="hljs-string">'team-pager'</span>
</code></pre>

























<table><thead><tr><th>问题</th><th>表现</th><th>影响</th></tr></thead><tbody><tr><td><strong>配置复杂</strong></td><td>YAML 难理解</td><td>运维成本高，改规则要重启</td></tr><tr><td><strong>无状态可见</strong></td><td>不知道当前有哪些告警</td><td>无法追溯告警历史</td></tr><tr><td><strong>难以扩展</strong></td><td>加功能要改源码</td><td>无法融入业务逻辑</td></tr></tbody></table>
<p><strong>一个真实场景：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">运维：<span class="hljs-string">"CPU 使用率高的告警触发了多少次？"</span>
Alertmanager：<span class="hljs-string">"不知道，我不存历史。"</span>

运维：<span class="hljs-string">"这个告警持续多久了？"</span>
Alertmanager：<span class="hljs-string">"不知道，我只管通知。"</span>

运维：<span class="hljs-string">"能不能在发布窗口屏蔽告警？"</span>
Alertmanager：<span class="hljs-string">"可以，但要写复杂的 YAML。"</span>
</code></pre>
<p><strong>自研的价值：</strong></p>
<ul>
<li>Web UI 管理规则，不用改 YAML</li>
<li>数据库存储历史，可以分析趋势</li>
<li>灵活扩展，融入业务场景（如发布窗口自动静默）</li>
</ul>
<h3 data-id="heading-2">1.2 Google 的两个方法论</h3>
<p>Google SRE 给了我们两个黄金法则：</p>
<p><strong>USE 方法（资源监控）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Utilization&lt;br/&gt;利用率] --&gt; B[提前预警]
    C[Saturation&lt;br/&gt;饱和度] --&gt; D[确认拥塞]
    E[Errors&lt;br/&gt;错误] --&gt; F[确认故障]
    
    style A fill:#fff4e1
    style C fill:#ffe1f5
    style E fill:#ffcccc
</code></pre>
<ul>
<li><strong>Utilization</strong>：资源用了多少？（CPU 80% → 需要关注）</li>
<li><strong>Saturation</strong>：是否有排队？（IO 队列长 → 性能下降）</li>
<li><strong>Errors</strong>：是否有错误？（磁盘错误 → 硬件故障）</li>
</ul>
<p><strong>四个黄金信号（服务监控）：</strong></p>
<p>虽然虚拟机不是"服务"，但可以映射：</p>
<ul>
<li><strong>Latency</strong>：IO 延迟高 → 影响上层应用</li>
<li><strong>Traffic</strong>：网络流量异常 → 可能被攻击</li>
<li><strong>Errors</strong>：硬件错误 → 需要介入</li>
<li><strong>Saturation</strong>：资源饱和 → 需要扩容</li>
</ul>
<p><strong>启示：告警不是简单设阈值，而是要理解系统在不同阶段的表现。</strong></p>
<h3 data-id="heading-3">1.3 从指标到告警的核心挑战</h3>
<p>node_exporter 给了我们"事实"：</p>
<pre><code class="hljs language-ini" lang="ini">node_cpu_seconds_total{<span class="hljs-attr">mode</span>=<span class="hljs-string">"user"</span>} <span class="hljs-number">123456</span>   <span class="hljs-comment"># CPU 累计时间</span>
node_memory_MemAvailable_bytes 8388608000    <span class="hljs-comment"># 可用内存</span>
node_filesystem_avail_bytes 53687091200      <span class="hljs-comment"># 磁盘可用空间</span>
</code></pre>
<p>但这些是 Counter 和 Gauge，怎么变成告警？</p>
<p><strong>三个核心问题：</strong></p>
<ol>
<li><strong>阈值怎么定？</strong> —— 80% 合适还是 90% 合适？</li>
<li><strong>怎么过滤毛刺？</strong> —— 短暂峰值要不要告警？</li>
<li><strong>如何提前预警？</strong> —— 等到真出问题才告是不是太晚了？</li>
</ol>
<p>接下来，我们用 CPU、内存、磁盘、网络四个维度，看看如何设计告警规则。</p>
<hr/>
<h2 data-id="heading-4">2. CPU 告警：不只是设个 80%</h2>
<h3 data-id="heading-5">2.1 错误示例</h3>
<p>很多人第一反应是这样：</p>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：CPU 使用率 &gt; 80% 就告警
(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) * 100 &gt; 80
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">10:00 - CPU 85%（代码编译，正常）  → 告警</span>
<span class="hljs-section">10:01 - CPU 60%（编译结束）        → 恢复</span>
<span class="hljs-section">10:05 - CPU 85%（定时任务，正常）  → 告警</span>
<span class="hljs-section">10:06 - CPU 50%                    → 恢复</span>

一天收到几十条告警，都是正常的业务波动。
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>没有时间维度，瞬时峰值也告警</li>
<li>80% 的阈值太低，正常繁忙就会触发</li>
<li>不区分"临时忙"和"持续忙"</li>
</ul>
<h3 data-id="heading-6">2.2 正确示例 1：加上时间维度</h3>
<pre><code class="hljs language-promql" lang="promql"># 正确示例：CPU 持续 10 分钟 &gt; 90%
(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance)) * 100 &gt; 90
for: 10m
</code></pre>
<p><strong>改进点：</strong></p>

























<table><thead><tr><th>参数</th><th>值</th><th>作用</th></tr></thead><tbody><tr><td><code>[5m]</code></td><td>评估窗口</td><td>平滑 15 秒抓取间隔的抖动</td></tr><tr><td><code>&gt; 90</code></td><td>阈值提高</td><td>留 10% 缓冲，避免误报</td></tr><tr><td><code>for: 10m</code></td><td>持续时长</td><td>过滤临时波动（编译、备份）</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次超过 90%] --&gt; B[观察 10 分钟]
    B --&gt; C{持续超过?}
    C --&gt;|是| D[触发告警]
    C --&gt;|否| E[取消]
    
    style A fill:#fff4e1
    style D fill:#ffcccc
    style E fill:#ccffcc
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>短暂的编译、备份不会告警</li>
<li>只有真正持续繁忙才告警</li>
<li>误报率从 80% 降到 &lt; 10%</li>
</ul>
<h3 data-id="heading-7">2.3 正确示例 2：区分 CPU 模式</h3>
<p>整机 CPU 告诉你"忙不忙"，但不知道"为什么忙"。</p>
<pre><code class="hljs language-promql" lang="promql"># 用户态 CPU 过高 → 应用代码效率问题
avg(rate(node_cpu_seconds_total{mode="user"}[5m])) by (instance) &gt; 0.8
for: 10m

# 系统态 CPU 过高 → 系统调用过多（网络/磁盘 IO）
avg(rate(node_cpu_seconds_total{mode="system"}[5m])) by (instance) &gt; 0.3
for: 10m

# iowait 过高 → 磁盘 IO 瓶颈
avg(rate(node_cpu_seconds_total{mode="iowait"}[5m])) by (instance) &gt; 0.2
for: 5m
</code></pre>
<p><strong>价值：不只知道"CPU 高"，还知道"为什么高"。</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 user 高</span>
→ 运维：应用代码有问题，去排查业务

场景 <span class="hljs-number">2</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 iowait 高</span>
→ 运维：磁盘 IO 慢，去排查磁盘

场景 <span class="hljs-number">3</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 system 高</span>
→ 运维：系统调用多，可能是网络问题
</code></pre>
<p>这就是区分模式的价值：同样是 CPU 90%，但问题的根因完全不同，处理方式也不同。</p>
<hr/>
<h2 data-id="heading-8">3. 内存告警：Linux 的内存不是你想的那样</h2>
<h3 data-id="heading-9">3.1 错误示例</h3>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：用 MemFree 计算使用率
(1 - node_memory_MemFree_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">16G 内存的服务器：
<span class="hljs-section">MemTotal: 16G</span>
<span class="hljs-section">MemFree:  1G   (真正空闲)</span>
<span class="hljs-section">Cached:   8G   (文件缓存，可释放)</span>

错误计算：使用率 = (16 - 1) / 16 = 93.75%
→ 告警：<span class="hljs-string">"内存不足！"</span>
→ 运维登录查看
→ 发现 8G 是 cache，随时可以释放
→ 误报！
</code></pre>
<p><strong>问题：不理解 Linux 内存管理机制。</strong></p>
<p>Linux 会把空闲内存用来做 cache，提升文件读取性能。这些 cache 在应用需要内存时会自动释放，不应该算作"已使用"。</p>
<h3 data-id="heading-10">3.2 正确示例 1：用 MemAvailable</h3>
<pre><code class="hljs language-promql" lang="promql"># 正确示例：用 MemAvailable 计算
(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90
for: 5m
</code></pre>
<p><strong>MemAvailable 是什么？</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">MemAvailable</span> = MemFree + 可回收的 Cache + 可回收的 Buffer
</code></pre>
<p>这才是真正可用的内存。</p>
<blockquote>
<p>注意：<code>node_memory_MemAvailable_bytes</code> 在 node_exporter v0.16+ 版本才可用。如果你的版本较旧，需要先升级。</p>
</blockquote>
<p><strong>对比：</strong></p>
<pre><code class="hljs language-ini" lang="ini">场景：16G 内存服务器

MemFree:      1G
Cached:       8G (可回收)
MemAvailable: 9G

用 MemFree：
使用率 = (16 - 1) / <span class="hljs-attr">16</span> = <span class="hljs-number">93.75</span>%  → 误报

用 MemAvailable：
使用率 = (16 - 9) / <span class="hljs-attr">16</span> = <span class="hljs-number">43.75</span>%  → 正确
</code></pre>
<h3 data-id="heading-11">3.3 正确示例 2：预测未来耗尽</h3>
<p>当前可用内存充足，但如果有内存泄漏，迟早会耗尽。</p>
<pre><code class="hljs language-promql" lang="promql"># 预测 4 小时后可用内存是否耗尽
predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) &lt; 0
for: 10m
</code></pre>
<p><strong>predict_linear 的原理：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[过去 1 小时数据] --&gt; B[线性回归]
    B --&gt; C[预测 4 小时后]
    C --&gt; D{&lt; 0?}
    D --&gt;|是| E[告警]
    
    style A fill:#e1f5ff
    style E fill:#ffcccc
</code></pre>
<p><strong>案例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">10:00 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">10</span>G
10:30 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">8</span>G
11:00 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">6</span>G

每小时下降 4G
→ 预测 4 小时后：6G - <span class="hljs-attr">16G</span> = -<span class="hljs-number">10</span>G &lt; <span class="hljs-number">0</span>
→ 触发告警："预计 4 小时后内存耗尽"
</code></pre>
<p><strong>价值：提前 4 小时发现风险，而不是等到真的耗尽。</strong></p>
<p>这就是 <code>predict_linear()</code> 的威力：从"被动应对"变成"主动预防"。</p>
<hr/>
<h2 data-id="heading-12">4. 磁盘告警：当前值和未来趋势</h2>
<h3 data-id="heading-13">4.1 错误示例</h3>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：磁盘使用率 &gt; 85% 就告警
(1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 &gt; 85
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：磁盘使用率 <span class="hljs-number">86</span><span class="hljs-comment">%，但日志增长很快</span>
→ 触发告警
→ 运维去清理日志
→ 但 <span class="hljs-number">2</span> 小时后磁盘满了
→ 服务挂了

为什么？因为 <span class="hljs-number">85</span><span class="hljs-comment">% 的阈值太晚了！</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>不知道磁盘增长速度</li>
<li>等到 85% 再告警，可能来不及处理</li>
<li>没有考虑"未来会怎样"</li>
</ul>
<h3 data-id="heading-14">4.2 正确示例 1：预测式告警</h3>
<pre><code class="hljs language-promql" lang="promql"># 基于过去 6 小时数据，预测 24 小时后磁盘是否满
predict_linear(node_filesystem_avail_bytes[6h], 24*3600) &lt; 0
for: 1h
</code></pre>
<p><strong>价值：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：磁盘使用率 <span class="hljs-number">82</span><span class="hljs-comment">%，但增长很快</span>
→ 规则 <span class="hljs-number">1</span> 告警：<span class="hljs-string">"预测 24h 后满"</span>
→ 运维：优先处理，明天就会满

场景 <span class="hljs-number">2</span>：磁盘使用率 <span class="hljs-number">82</span><span class="hljs-comment">%，但增长很慢</span>
→ 规则 <span class="hljs-number">1</span> 不告警：预测 <span class="hljs-number">7</span> 天后才满
→ 运维：不紧急，排期清理即可
</code></pre>
<p><strong>同样是 82%，但处理优先级完全不同。</strong></p>
<h3 data-id="heading-15">4.3 正确示例 2：容量和 IO 分开</h3>
<p>磁盘有两类问题：</p>
<ul>
<li><strong>容量问题</strong>：快满了</li>
<li><strong>性能问题</strong>：IO 慢了</li>
</ul>
<pre><code class="hljs language-promql" lang="promql"># 容量告警：使用率 &gt; 90%
# 注意：过滤掉临时目录和虚拟文件系统
(1 - node_filesystem_avail_bytes{
    fstype=~"ext4|xfs",
    mountpoint!~"/tmp|/var/lib/docker|/boot"
  } / node_filesystem_size_bytes) * 100 &gt; 90
for: 10m

# 性能告警：IO 使用率 &gt; 80%
rate(node_disk_io_time_seconds_total{device=~"sd.*|vd.*"}[5m]) &gt; 0.8
for: 10m

# 性能告警：IO 队列长度 &gt; 10
rate(node_disk_io_time_weighted_seconds_total{device=~"sd.*|vd.*"}[5m]) &gt; 10
for: 5m
</code></pre>
<p><strong>为什么要过滤路径？</strong></p>
<pre><code class="hljs language-diff" lang="diff">不需要告警的挂载点：
<span class="hljs-deletion">- /tmp：临时目录，满了也无所谓</span>
<span class="hljs-deletion">- /var/lib/docker：容器存储，由 Docker 管理</span>
<span class="hljs-deletion">- /boot：引导分区，通常很小且不会变化</span>

只关注业务数据盘：
<span class="hljs-deletion">- /：根分区</span>
<span class="hljs-deletion">- /data：数据分区</span>
<span class="hljs-deletion">- /home：用户目录</span>
</code></pre>
<p><strong>为什么要分开？</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">场景</span> <span class="hljs-number">1</span><span class="hljs-string">：磁盘使用率</span> <span class="hljs-number">50</span><span class="hljs-string">%，但</span> <span class="hljs-string">IO</span> <span class="hljs-string">队列很长</span>
<span class="hljs-string">→</span> <span class="hljs-string">容量充足，但性能差</span>
<span class="hljs-string">→</span> <span class="hljs-string">需要优化</span> <span class="hljs-string">IO（换</span> <span class="hljs-string">SSD、减少小文件操作）</span>

<span class="hljs-string">场景</span> <span class="hljs-number">2</span><span class="hljs-string">：磁盘使用率</span> <span class="hljs-number">95</span><span class="hljs-string">%，但</span> <span class="hljs-string">IO</span> <span class="hljs-string">正常</span>
<span class="hljs-string">→</span> <span class="hljs-string">容量不足，但性能正常</span>
<span class="hljs-string">→</span> <span class="hljs-string">需要清理磁盘或扩容</span>

<span class="hljs-string">两类问题，两种处理方式。</span>

<span class="hljs-string">**运维口诀**：容量看趋势，性能看队列。</span>

<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 5. 网络告警：流量和错误</span>

<span class="hljs-comment">### 5.1 错误示例</span>

<span class="hljs-string">```promql</span>
<span class="hljs-comment"># 错误示例：网络流量 &gt; 100MB/s 就告警</span>
<span class="hljs-string">rate(node_network_receive_bytes_total[5m])</span> <span class="hljs-string">/</span> <span class="hljs-number">1024</span> <span class="hljs-string">/</span> <span class="hljs-number">1024</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">100</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>100MB/s 对千兆网卡是正常的（125MB/s 满载）</li>
<li>没有区分"流量大"和"异常流量"</li>
<li>没有考虑错误率</li>
</ul>
<h3 data-id="heading-16">5.2 正确示例：流量 + 错误率</h3>
<pre><code class="hljs language-promql" lang="promql"># 网络流量超过带宽的 80%
# 注意：排除回环接口和虚拟接口
rate(node_network_receive_bytes_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) / (node_network_speed_bytes * 0.8) &gt; 1
for: 5m

# 网络错误率 &gt; 0.1%
rate(node_network_receive_errs_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) 
/ 
rate(node_network_receive_packets_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) &gt; 0.001
for: 5m
</code></pre>
<p><strong>为什么要过滤接口？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">不需要监控的网络接口：
<span class="hljs-bullet">-</span> lo：回环接口，本地通信
<span class="hljs-bullet">-</span> docker0, br-<span class="hljs-emphasis">*：Docker 网桥
- veth*</span>：容器虚拟网卡

只监控物理网卡：
<span class="hljs-bullet">-</span> eth0, eth1：传统命名
<span class="hljs-bullet">-</span> ens<span class="hljs-emphasis">*, enp*</span>：systemd 命名
<span class="hljs-bullet">-</span> bond<span class="hljs-emphasis">*：网卡绑定
</span></code></pre>
<p><strong>改进点：</strong></p>
<ul>
<li>相对阈值（带宽的 80%）而不是绝对值</li>
<li>关注错误率，不只是流量</li>
<li>错误率 0.1% 很小，但可能是硬件问题的信号</li>
</ul>
<p><strong>场景：</strong></p>
<pre><code class="hljs">场景 1：流量高，错误率正常
→ 业务正常繁忙，无需告警

场景 2：流量正常，错误率高
→ 网卡/交换机有问题，需要排查硬件

场景 3：流量高，错误率也高
→ 可能是 DDoS 攻击或网络故障
</code></pre>
<hr/>
<h2 data-id="heading-17">6. 告警规则设计方法论</h2>
<p>基于上面的案例，可以总结出告警规则设计的三个维度：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[告警规则设计] --&gt; B[时间维度]
    A --&gt; C[严重程度]
    A --&gt; D[业务上下文]
    
    B --&gt; E[评估窗口: 5m/15m&lt;br/&gt;平滑抖动]
    B --&gt; F[持续时长: for 10m&lt;br/&gt;过滤毛刺]
    
    C --&gt; G[P0: 服务不可用&lt;br/&gt;立即处理]
    C --&gt; H[P1: 性能下降&lt;br/&gt;1小时内]
    C --&gt; I[P2: 资源紧张&lt;br/&gt;当天处理]
    
    D --&gt; J[区分场景&lt;br/&gt;生产/测试]
    D --&gt; K[关联指标&lt;br/&gt;多维度判断]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffcccc
    style D fill:#ccffcc
</code></pre>
<h3 data-id="heading-18">6.1 时间维度</h3>
<p><strong>评估窗口 <code>[5m]</code>：</strong></p>
<ul>
<li>作用：平滑 15 秒抓取间隔的抖动</li>
<li>选择：CPU/内存用 5m，磁盘用 6h（变化慢）</li>
</ul>
<p><strong>持续时长 <code>for: 10m</code>：</strong></p>
<ul>
<li>作用：过滤短暂峰值</li>
<li>选择：CPU 用 10m，磁盘用 1h（不需要那么敏感）</li>
</ul>
<h3 data-id="heading-19">6.2 严重程度</h3>
<p><strong>三个级别：</strong></p>





























<table><thead><tr><th>级别</th><th>含义</th><th>响应时间</th><th>典型场景</th></tr></thead><tbody><tr><td>P0</td><td>服务不可用</td><td>立即</td><td>磁盘满、OOM</td></tr><tr><td>P1</td><td>性能下降</td><td>1 小时内</td><td>CPU 95%、内存 95%</td></tr><tr><td>P2</td><td>资源紧张</td><td>当天</td><td>CPU 85%、磁盘 80%</td></tr></tbody></table>
<p><strong>设计原则：</strong></p>
<ul>
<li>P0 的 <code>for</code> 更短（5m），不能等太久</li>
<li>P2 的 <code>for</code> 更长（30m），避免误报</li>
</ul>
<h3 data-id="heading-20">6.3 业务上下文</h3>
<p><strong>区分场景：</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 生产环境 90% 告警
cpu_usage{env="prod"} &gt; 0.9

# 测试环境 95% 告警（更宽松）
cpu_usage{env="test"} &gt; 0.95
</code></pre>
<p><strong>关联指标：</strong></p>
<pre><code class="hljs language-promql" lang="promql"># CPU 高 + iowait 高 → 可能是磁盘慢
cpu_usage &gt; 0.9 and cpu_iowait &gt; 0.2

# CPU 高 + 网络流量高 → 可能是网络处理
cpu_usage &gt; 0.9 and network_traffic &gt; 100MB/s
</code></pre>
<p>这就是"因地制宜"的价值：不同场景用不同规则，不能一刀切。</p>
<hr/>
<h2 data-id="heading-21">7. 好的告警系统应该解决什么问题</h2>
<p>有了规则，还需要一个引擎来执行。好的告警系统应该解决这些问题：</p>
<h3 data-id="heading-22">7.1 Fingerprint：告警实例的唯一标识</h3>
<p>同一个规则可能命中多个实例：</p>
<pre><code class="hljs language-ini" lang="ini">规则: CPU 使用率 &gt; 90%

命中:
- {<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-01"</span>, env=<span class="hljs-string">"prod"</span>} → Fingerprint = <span class="hljs-string">"abc123"</span>
- {<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-02"</span>, env=<span class="hljs-string">"prod"</span>} → Fingerprint = <span class="hljs-string">"def456"</span>
</code></pre>
<p><strong>Fingerprint = hash(rule_id + labels)</strong></p>
<p>每个 Fingerprint 是一个独立的告警，需要单独追踪：</p>
<ul>
<li>什么时候开始的？</li>
<li>触发了几次？</li>
<li>现在状态如何？</li>
</ul>
<h3 data-id="heading-23">7.2 防抖动：避免告警风暴</h3>
<p><strong>两层防抖：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次命中] --&gt; B[pending&lt;br/&gt;观察期]
    B --&gt; C{持续 &gt;= for?}
    C --&gt;|是| D[firing&lt;br/&gt;确认告警]
    C --&gt;|否| A
    D --&gt; E{5分钟内重复?}
    E --&gt;|是| F[跳过处理]
    E --&gt;|否| G[写库/通知]
    
    style B fill:#fff4e1
    style D fill:#ffcccc
    style F fill:#cccccc
    style G fill:#ccffcc
</code></pre>
<p><strong>第一层：for_duration（规则层）</strong></p>
<ul>
<li>持续 10 分钟才从 pending 转为 firing</li>
<li>过滤短暂毛刺</li>
</ul>
<p><strong>第二层：时间窗口去重（消费层）</strong></p>
<ul>
<li>5 分钟内同一告警只处理一次</li>
<li>避免频繁写库和通知</li>
</ul>
<h3 data-id="heading-24">7.3 可扩展：插件化数据源</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[告警引擎] --&gt; B[Prometheus&lt;br/&gt;指标]
    A --&gt; C[日志扫描&lt;br/&gt;关键字]
    A --&gt; D[SQL 查询&lt;br/&gt;数据库]
    A --&gt; E[黑盒探测&lt;br/&gt;HTTP/TCP]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#ffcccc
    style E fill:#ccffcc
</code></pre>
<p>不只是 Prometheus 指标，还可以扩展：</p>
<ul>
<li>日志关键字（如"OutOfMemoryError"）</li>
<li>SQL 规则（如"超时订单 &gt; 100"）</li>
<li>黑盒探测（如"API 5xx 错误"）</li>
</ul>
<h3 data-id="heading-25">7.4 静默管理：计划性维护</h3>
<p><strong>场景：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">晚上 <span class="hljs-number">22</span>:<span class="hljs-number">00</span>-<span class="hljs-number">23</span>:<span class="hljs-number">00</span> 发布新版本
→ 服务会重启
→ CPU 会短暂 <span class="hljs-number">100</span><span class="hljs-comment">%</span>
→ 不应该告警
</code></pre>
<p><strong>解决方案：时间窗口静默</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">静默规则:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"发布窗口"</span>
  <span class="hljs-attr">start:</span> <span class="hljs-string">"22:00"</span>
  <span class="hljs-attr">end:</span> <span class="hljs-string">"23:00"</span>
  <span class="hljs-attr">match:</span>
    <span class="hljs-attr">env:</span> <span class="hljs-string">"prod"</span>
    <span class="hljs-attr">service:</span> <span class="hljs-string">"api"</span>
</code></pre>
<p>在发布窗口内，匹配的告警自动静默，不发通知。</p>
<h3 data-id="heading-26">7.5 告警历史：可追溯和分析</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 历史告警表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> history_alerts (
  fingerprint <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),
  rule_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),
  start_at DATETIME,
  end_at DATETIME,
  duration <span class="hljs-type">INT</span>,
  trigger_count <span class="hljs-type">INT</span>
);
</code></pre>
<p><strong>价值：</strong></p>
<ul>
<li>查看某台服务器过去一周的告警次数</li>
<li>分析哪些规则误报率高</li>
<li>计算平均恢复时间（MTTR）</li>
</ul>
<p>告警历史不只是记录，更是持续改进的基础。没有数据就没有优化，好的系统要能自我进化。</p>
<hr/>
<h2 data-id="heading-27">8. 总结</h2>
<h3 data-id="heading-28">8.1 从指标到告警的核心思想</h3>
<p><strong>不是简单设阈值，而是：</strong></p>
<ol>
<li>
<p><strong>理解指标的本质</strong></p>
<ul>
<li>CPU 是累计时间，要用 rate() 转成使用率</li>
<li>内存要用 MemAvailable，不是 MemFree</li>
<li>磁盘要看趋势，不只看当前值</li>
</ul>
</li>
<li>
<p><strong>加上时间维度</strong></p>
<ul>
<li>评估窗口 <code>[5m]</code> 平滑抖动</li>
<li>持续时长 <code>for: 10m</code> 过滤毛刺</li>
</ul>
</li>
<li>
<p><strong>考虑业务上下文</strong></p>
<ul>
<li>区分生产和测试环境</li>
<li>关联多个指标（CPU + iowait）</li>
<li>预测未来（predict_linear）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-29">8.2 好的告警规则长什么样</h3>






























<table><thead><tr><th>维度</th><th>坏规则</th><th>好规则</th></tr></thead><tbody><tr><td><strong>阈值</strong></td><td>CPU &gt; 80%</td><td>CPU &gt; 90%，for: 10m</td></tr><tr><td><strong>指标</strong></td><td>只看一个指标</td><td>关联多个指标</td></tr><tr><td><strong>时间</strong></td><td>只看当前值</td><td>看趋势（predict_linear）</td></tr><tr><td><strong>上下文</strong></td><td>一刀切</td><td>区分场景（生产/测试）</td></tr></tbody></table>
<h3 data-id="heading-30">8.3 好的告警系统解决什么问题</h3>
<p><strong>五个核心能力：</strong></p>
<ol>
<li><strong>Fingerprint</strong> —— 每个告警实例有唯一标识</li>
<li><strong>防抖动</strong> —— 两层过滤（for + 时间窗口去重）</li>
<li><strong>可扩展</strong> —— 不只是 Prometheus，还能接其他数据源</li>
<li><strong>静默管理</strong> —— 计划性维护不告警</li>
<li><strong>历史追溯</strong> —— 可分析、可改进</li>
</ol>
<h3 data-id="heading-31">8.4 三个核心洞察</h3>
<p>看完这篇文章，记住这三点就够了：</p>
<p><strong>1. 好的告警要能定位问题</strong></p>
<p>不只说"CPU 高"，还要说"是 user 高还是 iowait 高"。不只告诉你有问题，还要告诉你什么问题。</p>
<p><strong>2. 好的告警要能预测未来</strong></p>
<p>用 <code>predict_linear()</code> 提前 4 小时、24 小时发现风险，而不是等到真的出问题才知道。从"被动应对"变成"主动预防"。</p>
<p><strong>3. 好的系统要能自我进化</strong></p>
<p>记录告警历史，分析误报率，持续优化规则。没有数据就没有改进，没有历史就没有进化。</p>
<hr/>
<h2 data-id="heading-32">附录：告警规则自查清单</h2>
<p>在上线告警规则前，用这个清单检查一遍：</p>
<h3 data-id="heading-33">CPU 告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>rate()</code> 而不是直接用 Counter 值？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 阈值是否 &gt;= 90%（而不是 80%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否设置了 <code>for: 10m</code> 持续时长？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否区分了 user/system/iowait 模式？</li>
</ul>
<h3 data-id="heading-34">内存告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>MemAvailable</code> 而不是 <code>MemFree</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 版本是否 &gt;= node_exporter v0.16？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>predict_linear()</code> 预测未来？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> P0 告警阈值是否 &gt;= 95%？</li>
</ul>
<h3 data-id="heading-35">磁盘告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 容量告警是否使用了 <code>predict_linear()</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否过滤了 <code>/tmp</code>、<code>/boot</code> 等临时目录？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否只监控 <code>ext4</code> 和 <code>xfs</code> 文件系统？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否分别设置了容量告警和 IO 告警？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> IO 告警是否过滤了设备类型（如 <code>device=~"sd.*|vd.*"</code>）？</li>
</ul>
<h3 data-id="heading-36">网络告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否过滤了 <code>lo</code>、<code>docker0</code>、<code>veth*</code> 等虚拟接口？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 流量告警是否使用了相对阈值（带宽的 80%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否同时监控了流量和错误率？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 错误率阈值是否足够敏感（如 0.1%）？</li>
</ul>
<h3 data-id="heading-37">通用检查</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 所有规则是否都设置了 <code>for</code> 持续时长？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> P0/P1/P2 的严重级别是否合理？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否区分了生产和测试环境？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 规则名称是否清晰表达了告警内容？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否添加了 <code>annotations</code> 描述？</li>
</ul>
<hr/>
<h2 data-id="heading-38">快速参考：核心规则速查</h2>











































































<table><thead><tr><th>监控项</th><th>推荐规则</th><th>阈值</th><th>for</th><th>说明</th></tr></thead><tbody><tr><td><strong>CPU 整机</strong></td><td><code>(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) &gt; 0.9</code></td><td>90%</td><td>10m</td><td>基础告警</td></tr><tr><td><strong>CPU iowait</strong></td><td><code>avg(rate(node_cpu_seconds_total{mode="iowait"}[5m])) &gt; 0.2</code></td><td>20%</td><td>5m</td><td>磁盘瓶颈</td></tr><tr><td><strong>内存可用</strong></td><td><code>(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) &gt; 0.9</code></td><td>90%</td><td>5m</td><td>基础告警</td></tr><tr><td><strong>内存预测</strong></td><td><code>predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) &lt; 0</code></td><td>-</td><td>10m</td><td>提前预警</td></tr><tr><td><strong>磁盘容量</strong></td><td><code>(1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) &gt; 0.9</code></td><td>90%</td><td>10m</td><td>基础告警</td></tr><tr><td><strong>磁盘预测</strong></td><td><code>predict_linear(node_filesystem_avail_bytes[6h], 24*3600) &lt; 0</code></td><td>-</td><td>1h</td><td>提前预警</td></tr><tr><td><strong>磁盘 IO</strong></td><td><code>rate(node_disk_io_time_seconds_total[5m]) &gt; 0.8</code></td><td>80%</td><td>10m</td><td>性能问题</td></tr><tr><td><strong>网络流量</strong></td><td><code>rate(node_network_receive_bytes_total[5m]) / node_network_speed_bytes &gt; 0.8</code></td><td>80%</td><td>5m</td><td>带宽瓶颈</td></tr><tr><td><strong>网络错误</strong></td><td><code>rate(node_network_receive_errs_total[5m]) / rate(node_network_receive_packets_total[5m]) &gt; 0.001</code></td><td>0.1%</td><td>5m</td><td>硬件问题</td></tr></tbody></table>
<hr/>
<p><strong>从 node_exporter 的指标，到生产级的告警规则，核心是一套设计思想：</strong></p>
<ul>
<li>理解本质（指标的含义）</li>
<li>加上时间（评估窗口 + 持续时长）</li>
<li>结合上下文（业务场景 + 关联指标）</li>
<li>持续迭代（追踪历史 + 质量改进）</li>
</ul>
<p>这不是一篇操作手册，而是一套方法论。掌握了这套思想，你就能设计出适合自己业务的告警规则。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rspack 1.7 发布：聚焦稳定性，下一站 2.0]]></title>    <link>https://juejin.cn/post/7590684822726557736</link>    <guid>https://juejin.cn/post/7590684822726557736</guid>    <pubDate>2026-01-04T02:48:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590684822726557736" data-draft-id="7590597231708520483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rspack 1.7 发布：聚焦稳定性，下一站 2.0"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2026-01-04T02:48:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WebInfra"/> <meta itemprop="url" content="https://juejin.cn/user/3368492743792695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rspack 1.7 发布：聚焦稳定性，下一站 2.0
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930945479362478092/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/498f2ad5f4cf43dd9093b71c5648f50f~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930945479362478092/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="ByteDance Web Infra" class="title" data-v-d326b38e="">ByteDance Web Infra</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-04T02:48:04.000Z" title="Sun Jan 04 2026 02:48:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-04
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                12
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读8分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              前端 @字节跳动  Web Infra
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed46d882c248414288065090059dfaac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=HXGQdgrxwXnCvwVja%2Bk70rff%2BzA%3D" alt="Rspack 1.7" loading="lazy"/></p>
<p>我们很高兴地宣布 Rspack 1.7 已正式发布！这是 Rspack 1.x 的最后一个 minor 版本，主要聚焦于现有功能的稳定性改进。接下来，我们将很快带来 Rspack 2.0。</p>
<p>值得关注的变更如下：</p>
<ul>
<li>新特性
<ul>
<li>SWC 插件兼容性提升</li>
<li>支持 Import Bytes</li>
<li>Lazy compilation</li>
<li>实验特性稳定化</li>
</ul>
</li>
<li>Rstack 进展
<ul>
<li>Rsbuild 1.7</li>
<li>Rsdoctor 1.4</li>
<li>Rslib 0.19</li>
<li>Rstest 0.7</li>
<li>Rspress 2.0 RC</li>
</ul>
</li>
</ul>
<h2 data-id="heading-0">新特性</h2>
<h3 data-id="heading-1">SWC 插件兼容性提升</h3>
<p>在过去的版本中，SWC Wasm 插件的升级成本一直较高。这是由于 SWC 的 AST 结构会随着版本演进发生变化，已有插件在 SWC 升级后可能无法继续工作，插件作者需要进行适配，插件使用者也需要同步升级依赖，这在一定程度上影响了项目的稳定性和升级体验。</p>
<p>为缓解这一问题，我们向 SWC 社区贡献了一系列 <a href="https://link.juejin.cn?target=https%3A%2F%2Fswc.rs%2Fdocs%2Fplugin%2Fecmascript%2Fcompatibility" target="_blank" title="https://swc.rs/docs/plugin/ecmascript/compatibility" ref="nofollow noopener noreferrer">兼容性改进</a>，包括：</p>
<ul>
<li>使用自描述式的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rfc-editor.org%2Frfc%2Frfc8949.html" target="_blank" title="https://www.rfc-editor.org/rfc/rfc8949.html" ref="nofollow noopener noreferrer">cbor</a> 序列化方案，取代原先对版本敏感的 <a href="https://link.juejin.cn?target=https%3A%2F%2Frkyv.org%2F" target="_blank" title="https://rkyv.org/" ref="nofollow noopener noreferrer">rkyv</a>，使 Wasm 插件能更好地适应 AST 结构的变更</li>
<li>为 AST 中的枚举类型引入 <code>Unknown</code> 变体，从而在遇到新字段或新节点时提升容错能力</li>
</ul>
<p>在 Rspack 1.7 中，我们升级了使用的 SWC 版本并支持了上述方案。在此之后，多数场景下 SWC 的升级将不会影响基于旧版本 SWC 构建的插件的正常使用。</p>
<p>目前，该方案已在大部分流行的 SWC Wasm 插件中完成接入。如果你是 SWC Wasm 插件作者，可参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fswc.rs%2Fdocs%2Fplugin%2Fecmascript%2Fcompatibility%23make-your-plugin-compatible" target="_blank" title="https://swc.rs/docs/plugin/ecmascript/compatibility#make-your-plugin-compatible" ref="nofollow noopener noreferrer">官方指南</a>，接入该方案，以降低后续版本演进中的维护成本。</p>
<h3 data-id="heading-2">支持 Import Bytes</h3>
<p>Rspack 现已原生支持 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftc39%2Fproposal-import-bytes" target="_blank" title="https://github.com/tc39/proposal-import-bytes" ref="nofollow noopener noreferrer">Import Bytes</a> 提案，可以将静态资源作为 <code>Uint8Array</code> 导入，并通过 <code>TextDecoder</code> 解码。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 静态导入</span>
<span class="hljs-keyword">import</span> fileBytes <span class="hljs-keyword">from</span> <span class="hljs-string">'./file.bin'</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">'bytes'</span> };
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
<span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(fileBytes);

<span class="hljs-comment">// 动态导入</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./file.bin'</span>, { <span class="hljs-attr">with</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'bytes'</span> } });
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
<span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>);
</code></pre>
<h3 data-id="heading-3">Lazy compilation</h3>
<p>在 Rspack 1.5 中，我们完成了 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Flazy-compilation" target="_blank" title="http://rspack.rs/zh/guide/features/lazy-compilation" ref="nofollow noopener noreferrer">Lazy Compilation</a> 特性的稳定化，并在 Rsbuild 中默认对动态导入的模块启用了按需编译。</p>
<p>从 Rspack 1.7 开始，Rspack CLI 在构建 web 应用时也将默认对动态导入的模块启用按需编译。这一改进可以减少首次构建的模块数量，从而加快开发服务器的启动速度。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspack.config.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 当前默认配置</span>
  <span class="hljs-attr">lazyCompilation</span>: {
    <span class="hljs-attr">imports</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">entries</span>: <span class="hljs-literal">false</span>,
  },
};
</code></pre>
<p>如果你有特殊需求，例如需要调试完整构建的产物，或分析完整的模块图，可以通过将 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Flazy-compilation" target="_blank" title="http://rspack.rs/zh/config/lazy-compilation" ref="nofollow noopener noreferrer">lazyCompilation</a> 设置为 <code>false</code> 来显式关闭该功能。</p>
<h3 data-id="heading-4">实验特性稳定化</h3>
<p>在 Rspack 1.7 中，我们稳定化了多项实验性特性。以下能力已完成生产验证并进入稳定阶段，相关实验开关也随之废弃，或调整为默认行为：</p>
<ul>
<li><strong>常量内联优化</strong>：该优化已正式稳定，并在生产构建中默认启用。
<ul>
<li>原有的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Fdeprecated-options%23experimentsinlineconst" target="_blank" title="http://rspack.rs/zh/config/deprecated-options#experimentsinlineconst" ref="nofollow noopener noreferrer">experiments.inlineConst</a> 选项已废弃</li>
<li>如需关闭该行为，可通过 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Foptimization%23optimizationinlineexports" target="_blank" title="http://rspack.rs/zh/config/optimization#optimizationinlineexports" ref="nofollow noopener noreferrer">optimization.inlineExports</a> 来控制</li>
</ul>
</li>
<li><strong>TypeScript enum 内联优化</strong>：该优化已正式稳定。
<ul>
<li>原有的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Fdeprecated-options%23experimentsinlineenum" target="_blank" title="http://rspack.rs/zh/config/deprecated-options#experimentsinlineenum" ref="nofollow noopener noreferrer">experiments.inlineEnum</a> 选项已废弃</li>
<li>使用 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Fbuiltin-swc-loader%23collecttypescriptinfoexportedenum" target="_blank" title="http://rspack.rs/zh/guide/features/builtin-swc-loader#collecttypescriptinfoexportedenum" ref="nofollow noopener noreferrer">collectTypeScriptInfo.exportedEnum</a> 控制是否收集导出的 <code>enum</code> 信息</li>
<li>使用 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Foptimization%23optimizationinlineexports" target="_blank" title="http://rspack.rs/zh/config/optimization#optimizationinlineexports" ref="nofollow noopener noreferrer">optimization.inlineExports</a> 来控制是否内联 <code>enum</code></li>
</ul>
</li>
<li><strong>类型重导出检查</strong>：该优化已正式稳定。
<ul>
<li>原有的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Fdeprecated-options%23experimentstypereexportspresence" target="_blank" title="http://rspack.rs/zh/config/deprecated-options#experimentstypereexportspresence" ref="nofollow noopener noreferrer">experiments.typeReexportsPresence</a> 选项已废弃</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考 <a href="#%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97" title="#%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97">升级指南</a> 了解如何调整相关配置。</p>
</blockquote>
<h2 data-id="heading-5">Rstack 进展</h2>
<h3 data-id="heading-6">Rsbuild 1.7</h3>
<h4 data-id="heading-7">Error overlay 改进</h4>
<p>Rsbuild 的 error overlay 现在支持显示<strong>运行时错误</strong>。当应用在运行过程中抛出异常时，错误会直接渲染到 overlay 上，帮助你更快发现并定位问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cfbf1e4fd1c4029b52c213460dc60bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=Ojf5PiN2Ido%2FEAtbPzdJFysHq9o%3D" alt="Rsbuild 1.7 Error Overlay" loading="lazy"/></p>
<p>该功能默认关闭，可通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fdev%2Fclient%23overlayruntime" target="_blank" title="https://rsbuild.rs/zh/config/dev/client#overlayruntime" ref="nofollow noopener noreferrer">dev.client.overlay.runtime</a> 选项按需开启：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rsbuild.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">dev</span>: {
    <span class="hljs-attr">client</span>: {
      <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">runtime</span>: <span class="hljs-literal">true</span>,
      },
    },
  },
};
</code></pre>
<h4 data-id="heading-8">产物体积对比</h4>
<p>Rsbuild 现在支持输出产物体积对比，用来查看构建结果是否发生了体积变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c180bedf361246ada3b8253fe3d007cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=V4ANgnAOucx4677Htqx02%2BRx4iE%3D" alt="Rsbuild 1.7 Print Size Diff" loading="lazy"/></p>
<p>开启 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fperformance%2Fprint-file-size%23diff" target="_blank" title="https://rsbuild.rs/zh/config/performance/print-file-size#diff" ref="nofollow noopener noreferrer">performance.printFileSize.diff</a> 选项后，Rsbuild 构建完成时会记录一份产物体积快照，后续构建会自动与上一次结果对比，并在日志中直接展示体积变化。你可以清楚地看到每个文件是变大还是变小，以及整体体积的增减情况，适合在日常开发和性能回归中快速发现体积变化。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rsbuild.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">performance</span>: {
    <span class="hljs-attr">printFileSize</span>: {
      <span class="hljs-attr">diff</span>: <span class="hljs-literal">true</span>,
    },
  },
};
</code></pre>
<h4 data-id="heading-9">create-rsbuild 改进</h4>
<p><code>create-rsbuild</code> 现在包含了更多开箱即用的工具。</p>
<p>在创建 Rsbuild 项目时，你现在可以选择自动集成 <a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2F" target="_blank" title="https://rstest.rs/" ref="nofollow noopener noreferrer">Rstest</a> 作为测试框架，或启用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstorybook.rsbuild.rs%2F" target="_blank" title="https://storybook.rsbuild.rs/" ref="nofollow noopener noreferrer">Storybook</a> 用于 UI 组件的开发与调试。相关依赖和配置都会在初始化时一次性完成，减少重复的手动配置成本。</p>
<pre><code class="hljs language-text" lang="text">◆  Select additional tools (Use &lt;space&gt; to select, &lt;enter&gt; to continue)
│  ◼ Rstest - testing
│  ◻ Biome - linting &amp; formatting
│  ◻ ESLint - linting
│  ◻ Prettier - formatting
│  ◻ Storybook - component development
└
</code></pre>
<h3 data-id="heading-10">Rsdoctor 1.4</h3>
<h4 data-id="heading-11">新的 Treemap 视图</h4>
<p>Rsdoctor 1.4 对原有的 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsdoctor.rs%2Fzh%2Fguide%2Fusage%2Fbundle-size" target="_blank" title="https://rsdoctor.rs/zh/guide/usage/bundle-size" ref="nofollow noopener noreferrer">Treemap</a> 视图进行了改进。新的交互设计可以帮助你更直观地分析 bundle 的整体构成，以及各类资源和模块的体积占比。</p>
<p>在该视图中，你可以通过搜索快速定位到具体的模块或资源。点击某个模块或资源后，视图会自动聚焦并放大对应区域。双击模块还可以展开其依赖链路，逐层查看模块之间的引用关系，从而更清晰地分析体积来源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1fceebd3afc46d0827dc1699d22aec2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=%2BNE1KzKL%2BYXQeFwj7RnlaR7T28M%3D" alt="Rsdoctor Treemap" loading="lazy"/></p>
<h3 data-id="heading-12">Rslib 0.19</h3>
<h4 data-id="heading-13">ESM 产物稳定化</h4>
<p>在此前的版本中，Rslib 通过实验性配置 <a href="https://link.juejin.cn?target=https%3A%2F%2Frslib.rs%2Fzh%2Fconfig%2Flib%2Fexperiments%23experimentsadvancedesm" target="_blank" title="https://rslib.rs/zh/config/lib/experiments#experimentsadvancedesm" ref="nofollow noopener noreferrer">experiments.advancedEsm</a> 来启用 Rspack 的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fplugins%2Frspack%2Fesm-library-plugin%23esmlibraryplugin" target="_blank" title="http://rspack.rs/zh/plugins/rspack/esm-library-plugin#esmlibraryplugin" ref="nofollow noopener noreferrer">新版 ESM 库产物</a>，用于提升 ESM 产物的整体质量。经过多个版本的验证与打磨，该能力现已完成稳定化。</p>
<p>自 Rslib 0.19 起，Rslib 的 bundle 模式将默认启用该特性。开发者无需进行任何额外配置，即可直接获得对静态分析更友好、并完整支持代码分割的 ESM 产物。</p>
<h4 data-id="heading-14">JavaScript API</h4>
<p>Rslib 0.19 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frslib.rs%2Fapi%2Fstart" target="_blank" title="https://rslib.rs/api/start" ref="nofollow noopener noreferrer">JavaScript API</a>，使开发者可以在 JavaScript 代码中以编程方式直接调用 Rslib 的构建能力。</p>
<p>下面是一个基础示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createRslib } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rslib/core'</span>;

<span class="hljs-comment">// 创建 Rslib 实例</span>
<span class="hljs-keyword">const</span> rslib = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createRslib</span>();
<span class="hljs-comment">// 构建生产环境输出</span>
<span class="hljs-keyword">await</span> rslib.<span class="hljs-title function_">build</span>();
</code></pre>
<blockquote>
<p>更多使用方式请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Frslib.rs%2Fapi%2Fjavascript-api%2Fcore" target="_blank" title="https://rslib.rs/api/javascript-api/core" ref="nofollow noopener noreferrer">API 文档</a>。</p>
</blockquote>
<h3 data-id="heading-15">Rstest 0.7</h3>
<h4 data-id="heading-16">配置适配器</h4>
<p>Rstest 0.7 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2Fzh%2Fconfig%2Ftest%2Fextends" target="_blank" title="https://rstest.rs/zh/config/test/extends" ref="nofollow noopener noreferrer">extends</a> 选项和适配器机制，用于直接复用现有的工具或框架配置。适配器是一个配置转换函数，可以将其他工具的配置转换为 Rstest 的配置，从而降低 Rstest 的集成成本。</p>
<p>例如，在一个使用 Rslib 的库项目中，通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40rstest%2Fadapter-rslib" target="_blank" title="https://www.npmjs.com/package/@rstest/adapter-rslib" ref="nofollow noopener noreferrer">@rstest/adapter-rslib</a> 适配器，你可以直接复用已有的 Rslib 配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rstest.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rstest/core'</span>;
<span class="hljs-keyword">import</span> { withRslibConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rstest/adapter-rslib'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 自动读取 rslib.config.ts 并转换为 Rstest 配置</span>
  <span class="hljs-attr">extends</span>: <span class="hljs-title function_">withRslibConfig</span>(),
  <span class="hljs-comment">// 其他测试配置</span>
  <span class="hljs-attr">coverage</span>: {
    <span class="hljs-comment">// ...</span>
  },
});
</code></pre>
<p>适配器则负责将不同工具的配置转换为 Rstest 的配置（如 <code>define</code>、<code>alias</code> 等），而 <code>extends</code> 则负责将转换后的配置与 Rstest 的配置进行合并。通过二者的配合，任何基于 Rspack 的工具或框架，都可以以最小成本与 Rstest 集成。</p>
<p>目前 <code>@rstest/adapter-rslib</code> 适配器已正式发布，后续我们还将推出更多适配器，以对接 Rstack 的各个工具。你也可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2Fzh%2Fguide%2Fintegration%2Fadapters" target="_blank" title="https://rstest.rs/zh/guide/integration/adapters" ref="nofollow noopener noreferrer">Rstest - 适配器</a> 来编写自定义的适配器。</p>
<h4 data-id="heading-17">测试反馈优化</h4>
<p>Rstest 针对本地开发与调试场景进行了多项体验优化，让测试反馈更加直观：</p>
<ul>
<li>
<p><strong>更早发现卡住的测试:</strong> Rstest 现已支持在本地运行时标记长时间未完成的测试用例。当测试过程变慢时，你可以直接看到是哪个用例正在执行、可能已经卡住，而不再只能盯着终端等待整个测试超时结束。</p>
</li>
<li>
<p><strong>更清晰的超时失败反馈:</strong> 当测试因超时失败时，Rstest 现在会在错误信息中展示已执行的断言数量。这能帮助你快速判断测试是否已经部分执行，或是卡在了某个异步逻辑中，从而更快定位问题。</p>
</li>
</ul>
<h3 data-id="heading-18">Rspress 2.0 RC</h3>
<h4 data-id="heading-19">SSG-MD 特性</h4>
<p>在基于 React 动态渲染的前端框架中，往往存在静态信息难以提取的问题，Rspress 也遇到了相同的问题。Rspress 允许用户通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fuse-mdx%2Fcomponents" target="_blank" title="https://v2.rspress.rs/zh/guide/use-mdx/components" ref="nofollow noopener noreferrer">MDX 片段</a>、React 组件、Hooks 以及 TSX 路由等动态特性来增强文档表现力。但这些动态内容在转换为 Markdown 文本时会面临以下问题：</p>
<ul>
<li>直接将 MDX 输入给 AI 会包含大量代码语法噪音，并丢失 React 组件内容</li>
<li>将 SSG 生成的 HTML 转为 Markdown 往往效果不佳，信息质量难以保证</li>
</ul>
<p>为了解决这个问题，Rspress 2.0 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fbasic%2Fssg-md" target="_blank" title="https://v2.rspress.rs/zh/guide/basic/ssg-md" ref="nofollow noopener noreferrer">SSG-MD</a> 特性。这是一个全新的功能，见名知意，与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fbasic%2Fssg" target="_blank" title="https://v2.rspress.rs/zh/guide/basic/ssg" ref="nofollow noopener noreferrer">静态站点生成（SSG）</a> 唯一的不同在于它将你的页面渲染为 Markdown 文件，而非 HTML 文件，并生成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 及 llms-full.txt 相关文件。相比与将 HTML 转化为 Markdown 等传统方式，SSG-MD 在渲染期间拥有更好的信息源，比如 React 虚拟 DOM，因此拥有更好的静态信息质量和灵活性。</p>
<p>启用方式非常简单：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspress.config.mjs</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">llms</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>构建后将生成如下结构：</p>
<pre><code class="hljs language-bash" lang="bash">doc_build
├── llms.txt          <span class="hljs-comment"># 摘要版，包含关键文档索引</span>
├── llms-full.txt     <span class="hljs-comment"># 完整版，包含所有文档内容</span>
├── guide
│   └── start
│       └── introduction.md
└── ...
</code></pre>
<p>对于自定义组件，你可以通过环境变量来控制其在 SSG-MD 模式下的渲染行为：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Tab</span>(<span class="hljs-params">{ label }: { label: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">SSG_MD</span>) {
    <span class="hljs-comment">// SSG-MD 模式下输出纯文本描述</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{`**Tab: ${label}**`}<span class="hljs-tag">&lt;/&gt;</span></span>;
  }
  <span class="hljs-comment">// 正常渲染交互式组件</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tab"</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这样既保证了文档的交互体验，也能帮助 AI 理解组件的语义信息。</p>
<blockquote>
<p>详见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fbasic%2Fssg-md" target="_blank" title="https://v2.rspress.rs/zh/guide/basic/ssg-md" ref="nofollow noopener noreferrer">SSG-MD 使用指南</a></p>
</blockquote>
<h2 data-id="heading-20">升级指南</h2>
<h3 data-id="heading-21">升级 SWC 插件</h3>
<p>如果你的项目中使用了 SWC Wasm 插件（如 <code>@swc/plugin-emotion</code> 等），请升级插件至兼容 <code>swc_core@54</code> 及以上版本，否则可能因版本不兼容导致构建失败或运行异常。</p>
<blockquote>
<p>详情请查阅：<a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Ferrors%2Fswc-plugin-version" target="_blank" title="http://rspack.rs/zh/errors/swc-plugin-version" ref="nofollow noopener noreferrer">常见问题 - SWC 插件版本不匹配</a>。</p>
</blockquote>
<h3 data-id="heading-22">移除废弃配置</h3>
<ul>
<li>以下实验性选项已废弃，可以直接移除：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspack.config.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// [!code --]</span>
  <span class="hljs-attr">experiments</span>: {
    <span class="hljs-comment">// [!code --]</span>
    <span class="hljs-attr">inlineConst</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// [!code --]</span>
    <span class="hljs-attr">inlineEnum</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// [!code --]</span>
    <span class="hljs-attr">typeReexportsPresence</span>: <span class="hljs-literal">true</span>,
  },
};
</code></pre>
<ul>
<li>调整 <code>builtin:swc-loader</code> 中的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Fbuiltin-swc-loader%23collecttypescriptinfo" target="_blank" title="http://rspack.rs/zh/guide/features/builtin-swc-loader#collecttypescriptinfo" ref="nofollow noopener noreferrer">collectTypeScriptInfo</a> 选项位置，移除 <code>rspackExperiments</code> 层级：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspack.config.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.ts$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'builtin:swc-loader'</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-comment">// [!code --]</span>
          <span class="hljs-attr">rspackExperiments</span>: {
            <span class="hljs-attr">collectTypeScriptInfo</span>: {
              <span class="hljs-attr">exportedEnum</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">typeExports</span>: <span class="hljs-literal">true</span>,
            },
            <span class="hljs-comment">// [!code --]</span>
          },
        },
      },
    ],
  },
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三个核心概念，帮你彻底打通 TypeScript 泛型]]></title>    <link>https://juejin.cn/post/7590961898398744614</link>    <guid>https://juejin.cn/post/7590961898398744614</guid>    <pubDate>2026-01-04T02:51:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590961898398744614" data-draft-id="7591066233669664794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三个核心概念，帮你彻底打通 TypeScript 泛型"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2026-01-04T02:51:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三个核心概念，帮你彻底打通 TypeScript 泛型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:51:38.000Z" title="Sun Jan 04 2026 02:51:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 核心痛点：丢失的“身份证”</h3>
<p>在没有泛型之前，我们想写一个通用的函数（比如返回你传给它的值），通常会遇到两个极端：</p>
<ul>
<li><strong>写死类型：</strong> 只能传 <code>number</code>，传 <code>string</code> 就报错。太死板。</li>
<li><strong>使用 <code>any</code>：</strong> 什么都能传，但进去之后 <strong>“身份证”丢了</strong>。</li>
</ul>
<p><strong>举个“丢失身份证”的例子：</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 使用 any，就像一个黑盒</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">heuristic</span>(<span class="hljs-params">val: <span class="hljs-built_in">any</span></span>): <span class="hljs-built_in">any</span> {
  <span class="hljs-keyword">return</span> val;
}

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">heuristic</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-comment">// 🚨 问题来了：TypeScript 现在只知道 result 是 any 类型。</span>
<span class="hljs-comment">// 你打 result. specifically... 这里的代码提示全没了！</span>
<span class="hljs-comment">// 甚至写 result.toFixed() （这是数字的方法）它都不报错，直到运行时崩溃。</span>
</code></pre>
<p><strong>泛型的真正作用：</strong> 它是用来<strong>保住类型“身份证”的</strong>。</p>
<hr/>
<h3 data-id="heading-1">2. 思维模型：透明管道（The Transparent Tunnel）</h3>
<p>把泛型函数想象成一个<strong>透明的管道</strong>，而 <code>&lt;T&gt;</code> 就是管道入口的一个<strong>扫描仪</strong>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">function</span> tunnel&lt;T&gt;(<span class="hljs-attr">val</span>: T): T {
  <span class="hljs-keyword">return</span> val;
}
</code></pre>
<p>请跟着这个过程走一遍：</p>
<ol>
<li>当你调用 <code>tunnel("hello")</code> 时。</li>
<li><strong>扫描仪 <code>&lt;T&gt;</code></strong> 瞬间启动，它捕捉到了 <code>"hello"</code> 的类型是 <strong>String</strong>。</li>
<li>于是，在这个瞬间，函数内部所有的 <code>T</code> 自动变成了 <code>String</code>。</li>
<li><strong>最关键的一步：</strong> 它不仅处理了数据，还把 <strong>String</strong> 这个类型贴在了返回值上。</li>
</ol>
<p><strong>对比一下：</strong></p>
<ul>
<li><strong>any (黑盒):</strong> 苹果进去 -&gt; 黑盒处理 -&gt; 吐出一个“东西”（可能是苹果，也可能是炸弹）。</li>
<li><strong>泛型 (透明管道):</strong> 苹果进去 -&gt; <strong>T 记录下“这是苹果”</strong> -&gt; 管道处理 -&gt; 吐出一个<strong>带着“苹果”标签</strong>的苹果。</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 现实生活类比：万能USB接口 vs 定制插座</h3>
<p>为了彻底弄懂，我们用<strong>接口</strong>做比喻。</p>
<h4 data-id="heading-3">场景：你需要生产一种“万能包装盒”</h4>
<p>方案 A（不用泛型 - 类似于 any）：</p>
<p>你造了一个巨大的袋子。</p>
<ul>
<li>用户放入一支口红。</li>
<li>拿出来时，系统只标注这是“一个物品”。</li>
<li>用户甚至可能试图把这个“物品”当成汉堡吃掉，因为系统没告诉他这是口红。</li>
</ul>
<p>方案 B（使用泛型）：</p>
<p>你造了一个智能模具。</p>
<ul>
<li>当用户把“口红”放进去的那一刻，模具自动变形卡住口红，并打上标签： <strong>“内含：口红”</strong> 。</li>
<li>当用户把“汉堡”放进去，模具自动变形卡住汉堡，并打上标签： <strong>“内含：汉堡”</strong> 。</li>
</ul>
<p><strong>代码映射：</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 这是一个智能盒子 (Box)</span>
<span class="hljs-comment">// &lt;T&gt; 是这一轮生产的“物品类型”</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Box</span>&lt;T&gt; {
  <span class="hljs-attr">content</span>: T; <span class="hljs-comment">// 内容物就是 T 类型</span>
}

<span class="hljs-comment">// 场景 1：装口红</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">lipstickBox</span>: <span class="hljs-title class_">Box</span>&lt;<span class="hljs-title class_">Lipstick</span>&gt; = { <span class="hljs-attr">content</span>: myLipstick };
<span class="hljs-comment">// ✅ TypeScript 知道：lipstickBox.content 是口红，不能吃。</span>

<span class="hljs-comment">// 场景 2：装汉堡</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">burgerBox</span>: <span class="hljs-title class_">Box</span>&lt;<span class="hljs-title class_">Burger</span>&gt; = { <span class="hljs-attr">content</span>: myBurger };
<span class="hljs-comment">// ✅ TypeScript 知道：burgerBox.content 是汉堡，可以吃。</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">4. 再次审视那个“难懂”的语法</h3>
<p>现在回头看最基础的语法，是不是清晰了？</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 这里的 &lt;T&gt; 是一份“契约”</span>
<span class="hljs-comment">// 它在说：嗨，进来的是什么类型 (参数 val: T)，出去的必须也是同一种类型 (返回值: T)！</span>
<span class="hljs-keyword">function</span> identify&lt;T&gt;(<span class="hljs-attr">val</span>: T): T {
    <span class="hljs-keyword">return</span> val;
}
</code></pre>
<ul>
<li><strong>T 不是值</strong>，它是一个<strong>占位符</strong>。</li>
<li>它的作用是<strong>捕获</strong>你调用函数那一刻传入的具体类型，然后把这个类型<strong>传递</strong>给参数和返回值。</li>
</ul>
<h3 data-id="heading-5">5. 进阶：为什么要用 <code>extends</code> (泛型约束)？</h3>
<p>有时候管道太宽了，我们想限制一下。</p>
<p><strong>比喻：</strong> 这是一个<strong>微波炉</strong>泛型。</p>
<ul>
<li>你可以放汉堡、放牛奶（T 可以变）。</li>
<li>但你<strong>绝对不能放金属</strong>。</li>
</ul>
<p>所以我们需要给 T 加个过滤器：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 这里的 extends 表示“必须包含”</span>
<span class="hljs-comment">// T 必须包含 .length 属性，否则微波炉不工作</span>
<span class="hljs-keyword">function</span> logLength&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-attr">arg</span>: T) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg.<span class="hljs-property">length</span>);
}

<span class="hljs-title function_">logLength</span>(<span class="hljs-string">"abc"</span>); <span class="hljs-comment">// ✅ 字符串有 length</span>
<span class="hljs-title function_">logLength</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]); <span class="hljs-comment">// ✅ 数组有 length</span>
<span class="hljs-title function_">logLength</span>(<span class="hljs-number">100</span>);   <span class="hljs-comment">// ❌ 报错！数字没有 length，被拒之门外</span>
</code></pre>
<h3 data-id="heading-6">总结</h3>
<p>现在请这样记住它：</p>
<p>泛型就是一种“类型传声筒”或者“类型关联器”。</p>
<p>它的核心目的只有两个：</p>
<ol>
<li><strong>灵活：</strong> <code>any</code>，允许你传入不同类型。</li>
<li><strong>严谨：</strong> 具体类型，<strong>记住</strong>你传了什么，并在后续操作中<strong>锁死</strong>这个关系，不让类型信息丢失。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Scrapy框架数据存储完全指南（实操为主，易落地）]]></title>    <link>https://juejin.cn/post/7590213554799067171</link>    <guid>https://juejin.cn/post/7590213554799067171</guid>    <pubDate>2026-01-03T14:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554799067171" data-draft-id="7590303618429403171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Scrapy框架数据存储完全指南（实操为主，易落地）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-03T14:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="好汉学技术"/> <meta itemprop="url" content="https://juejin.cn/user/3704681342438299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Scrapy框架数据存储完全指南（实操为主，易落地）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3704681342438299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    好汉学技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:33:25.000Z" title="Sat Jan 03 2026 14:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你想掌握Scrapy框架的数据存储方法，核心是围绕<strong>Item数据模型</strong>和**Pipeline（数据管道）**展开——Scrapy将爬取到的数据先封装到Item中，再通过Pipeline统一处理存储，支持本地文件、关系型数据库、非关系型数据库等多种存储方式，以下是详细实操教程，无冗余理论，可直接复刻运行。</p>
<h2 data-id="heading-0">一、前置基础：数据存储的核心流程</h2>
<ol>
<li>定义<code>Item</code>：在<code>items.py</code>中声明需要存储的字段，规范数据格式（避免杂乱数据）；</li>
<li>解析数据封装到<code>Item</code>：在爬虫文件中，将解析到的数据存入自定义<code>Item</code>对象并<code>yield</code>；</li>
<li>启用<code>Pipeline</code>：在<code>settings.py</code>中配置启用对应的管道（设置优先级，数字越小优先级越高）；</li>
<li>实现存储逻辑：在<code>pipelines.py</code>中编写具体的存储代码（文件/数据库等）；</li>
<li>运行爬虫：自动触发Pipeline，完成数据存储。</li>
</ol>
<h3 data-id="heading-1">必备前置准备（快速搭建测试环境）</h3>
<ol>
<li>已有Scrapy项目（若无，执行<code>scrapy startproject data_storage_spider</code>创建）；</li>
<li>简单爬虫示例（用于生成测试数据，后续所有存储方式均基于此）：</li>
</ol>
<ul>
<li>爬虫文件<code>spiders/test_spider.py</code>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> scrapy
<span class="hljs-keyword">from</span> data_storage_spider.items <span class="hljs-keyword">import</span> DataStorageSpiderItem

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestSpider</span>(scrapy.Spider):
    name = <span class="hljs-string">"test_spider"</span>
    <span class="hljs-comment"># 测试用静态页面，无需处理动态渲染</span>
    start_urls = [<span class="hljs-string">"https://quotes.toscrape.com/"</span>]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, response</span>):
        <span class="hljs-comment"># 解析名言数据</span>
        quote_items = response.xpath(<span class="hljs-string">"//div[@class='quote']"</span>)
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> quote_items:
            <span class="hljs-comment"># 实例化自定义Item</span>
            quote_data = DataStorageSpiderItem()
            <span class="hljs-comment"># 封装数据（字段与items.py中定义一致）</span>
            quote_data[<span class="hljs-string">'content'</span>] = item.xpath(<span class="hljs-string">".//span[@class='text']/text()"</span>).extract_first() <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
            quote_data[<span class="hljs-string">'author'</span>] = item.xpath(<span class="hljs-string">".//small[@class='author']/text()"</span>).extract_first() <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
            quote_data[<span class="hljs-string">'tags'</span>] = <span class="hljs-string">","</span>.join(item.xpath(<span class="hljs-string">".//div[@class='tags']/a/text()"</span>).extract()) <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
            
            <span class="hljs-comment"># 提交数据到Pipeline（核心：yield Item对象）</span>
            <span class="hljs-keyword">yield</span> quote_data
</code></pre>
<ul>
<li>定义Item<code>items.py</code>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> scrapy

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataStorageSpiderItem</span>(scrapy.Item):
    <span class="hljs-comment"># 定义需要存储的字段，scrapy.Field()仅用于标记，无额外逻辑</span>
    content = scrapy.Field()  <span class="hljs-comment"># 名言内容</span>
    author = scrapy.Field()   <span class="hljs-comment"># 作者</span>
    tags = scrapy.Field()     <span class="hljs-comment"># 标签（用逗号拼接为字符串，方便存储）</span>
</code></pre>
<h2 data-id="heading-2">二、方式1：本地文件存储（CSV/JSON/JSON Lines，最常用）</h2>
<p>本地文件存储无需额外安装依赖，适合小规模数据、快速验证结果，Scrapy提供两种实现方式：<strong>内置命令直接导出</strong>（快速便捷）、<strong>Pipeline自定义实现</strong>（灵活可控，支持复杂逻辑）。</p>
<h3 data-id="heading-3">1. 快速实现：Scrapy内置命令导出（无需编写Pipeline）</h3>
<p>直接在终端运行爬虫时，通过<code>-o</code>参数指定文件路径和格式，自动生成文件，支持<code>csv</code>、<code>json</code>、<code>jl</code>（JSON Lines）三种常用格式。</p>
<h4 data-id="heading-4">（1）导出为CSV文件（推荐，易用于Excel分析）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入项目目录后执行</span>
scrapy crawl test_spider -o quotes.csv -s FEED_EXPORT_ENCODING=utf_8_sig
</code></pre>
<ul>
<li>关键参数说明：
<ul>
<li><code>-o quotes.csv</code>：指定导出为CSV文件，文件名<code>quotes.csv</code>；</li>
<li><code>-s FEED_EXPORT_ENCODING=utf_8_sig</code>：解决中文乱码问题（核心参数，必加）；</li>
</ul>
</li>
<li>结果：项目根目录生成<code>quotes.csv</code>，可用Excel直接打开，数据格式规整。</li>
</ul>
<h4 data-id="heading-5">（2）导出为JSON文件</h4>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider -o quotes.json -s FEED_EXPORT_ENCODING=utf_8_sig
</code></pre>
<ul>
<li>特点：数据以数组格式存储，适合后续JSON解析处理，缺点是大文件加载耗时久。</li>
</ul>
<h4 data-id="heading-6">（3）导出为JSON Lines文件（推荐，大文件友好）</h4>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider -o quotes.jl -s FEED_EXPORT_ENCODING=utf_8_sig
</code></pre>
<ul>
<li>特点：每行一条JSON数据，无需加载整个文件即可解析，适合大规模本地数据存储，兼容性更强。</li>
</ul>
<h3 data-id="heading-7">2. 灵活实现：Pipeline自定义文件存储（支持复杂逻辑）</h3>
<p>内置命令无法满足自定义需求（如：按日期拆分文件、过滤无效数据、追加写入），此时需通过Pipeline实现，以CSV文件为例（JSON格式同理）。</p>
<h4 data-id="heading-8">（1）编写Pipeline存储逻辑（<code>pipelines.py</code>）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CsvFileStoragePipeline</span>:
    <span class="hljs-string">"""自定义CSV文件存储管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 1. 初始化文件对象和CSV写入器</span>
        self.file = <span class="hljs-literal">None</span>
        self.writer = <span class="hljs-literal">None</span>
        <span class="hljs-comment"># CSV文件路径和表头</span>
        self.csv_path = <span class="hljs-string">"custom_quotes.csv"</span>
        self.fieldnames = [<span class="hljs-string">"content"</span>, <span class="hljs-string">"author"</span>, <span class="hljs-string">"tags"</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫启动时执行（仅执行一次），用于打开文件、初始化写入器"""</span>
        <span class="hljs-comment"># 追加写入模式（a）：避免覆盖已有数据；newline=""：避免CSV出现空行</span>
        self.file = <span class="hljs-built_in">open</span>(self.csv_path, <span class="hljs-string">"a"</span>, newline=<span class="hljs-string">""</span>, encoding=<span class="hljs-string">"utf_8_sig"</span>)
        <span class="hljs-comment"># 检查文件是否为空，为空则写入表头</span>
        <span class="hljs-keyword">if</span> os.path.getsize(self.csv_path) == <span class="hljs-number">0</span>:
            self.writer = csv.DictWriter(self.file, fieldnames=self.fieldnames)
            self.writer.writeheader()
        <span class="hljs-keyword">else</span>:
            self.writer = csv.DictWriter(self.file, fieldnames=self.fieldnames)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">self, item, spider</span>):
        <span class="hljs-string">"""核心：处理每个Item数据（爬虫提交一个Item，执行一次）"""</span>
        <span class="hljs-comment"># 过滤无效数据（自定义逻辑：排除空内容的记录）</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> item.get(<span class="hljs-string">"content"</span>) <span class="hljs-keyword">or</span> item.get(<span class="hljs-string">"content"</span>).strip() == <span class="hljs-string">""</span>:
            spider.logger.warning(<span class="hljs-string">"无效数据：内容为空，跳过存储"</span>)
            <span class="hljs-keyword">return</span> item
        
        <span class="hljs-comment"># 将Item转换为字典，写入CSV文件</span>
        self.writer.writerow(<span class="hljs-built_in">dict</span>(item))
        spider.logger.info(<span class="hljs-string">f"数据已写入CSV：<span class="hljs-subst">{item.get(<span class="hljs-string">'author'</span>)}</span> - <span class="hljs-subst">{item.get(<span class="hljs-string">'content'</span>)[:<span class="hljs-number">20</span>]}</span>..."</span>)
        <span class="hljs-keyword">return</span> item
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫关闭时执行（仅执行一次），用于关闭文件，释放资源"""</span>
        <span class="hljs-keyword">if</span> self.file:
            self.file.close()
            spider.logger.info(<span class="hljs-string">f"CSV文件存储完成，文件路径：<span class="hljs-subst">{self.csv_path}</span>"</span>)
</code></pre>
<h4 data-id="heading-9">（2）启用Pipeline（<code>settings.py</code>）</h4>
<p>找到<code>ITEM_PIPELINES</code>配置，取消注释并添加自定义管道（优先级300，可根据需求调整）：</p>
<pre><code class="hljs language-python" lang="python">ITEM_PIPELINES = {
   <span class="hljs-string">'data_storage_spider.pipelines.CsvFileStoragePipeline'</span>: <span class="hljs-number">300</span>,
}
</code></pre>
<h4 data-id="heading-10">（3）运行爬虫验证结果</h4>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider
</code></pre>
<ul>
<li>结果：项目根目录生成<code>custom_quotes.csv</code>，无中文乱码，已过滤空内容数据，支持追加写入（重复运行爬虫，数据不会覆盖，而是新增到文件末尾）。</li>
</ul>
<h2 data-id="heading-11">三、方式2：关系型数据库存储（以MySQL为例，生产环境常用）</h2>
<p>适合大规模结构化数据存储，支持数据查询、更新、关联分析，核心依赖<code>pymysql</code>库，步骤如下：</p>
<h3 data-id="heading-12">1. 安装依赖库</h3>
<pre><code class="hljs language-bash" lang="bash">pip install pymysql
</code></pre>
<h3 data-id="heading-13">2. 提前创建MySQL数据库和表</h3>
<ul>
<li>创建数据库<code>scrapy_data</code>（字符集<code>utf8mb4</code>，支持所有中文和特殊字符）；</li>
<li>创建表<code>quotes</code>（字段与Item对应，结构如下）：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> scrapy_data <span class="hljs-keyword">DEFAULT</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;

USE scrapy_data;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> quotes (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT <span class="hljs-string">'自增主键'</span>,
    content TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'名言内容'</span>,
    author <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'作者'</span>,
    tags <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'标签'</span>,
    create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'存储时间'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'名言数据表'</span>;
</code></pre>
<h3 data-id="heading-14">3. 编写MySQL存储Pipeline（<code>pipelines.py</code>）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pymysql

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MysqlStoragePipeline</span>:
    <span class="hljs-string">"""MySQL数据库存储管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 数据库连接配置（根据自身环境修改）</span>
        self.host = <span class="hljs-string">"localhost"</span>
        self.port = <span class="hljs-number">3306</span>
        self.user = <span class="hljs-string">"root"</span>
        self.password = <span class="hljs-string">"你的MySQL密码"</span>
        self.db_name = <span class="hljs-string">"scrapy_data"</span>
        self.charset = <span class="hljs-string">"utf8mb4"</span>
        
        <span class="hljs-comment"># 初始化连接和游标对象</span>
        self.conn = <span class="hljs-literal">None</span>
        self.cursor = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫启动时，建立MySQL连接"""</span>
        <span class="hljs-keyword">try</span>:
            self.conn = pymysql.connect(
                host=self.host,
                port=self.port,
                user=self.user,
                password=self.password,
                db=self.db_name,
                charset=self.charset
            )
            self.cursor = self.conn.cursor()
            spider.logger.info(<span class="hljs-string">"MySQL数据库连接成功"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            spider.logger.error(<span class="hljs-string">f"MySQL数据库连接失败：<span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span> e
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">self, item, spider</span>):
        <span class="hljs-string">"""核心：将Item数据插入MySQL数据库"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> item.get(<span class="hljs-string">"content"</span>):
            <span class="hljs-keyword">return</span> item
        
        <span class="hljs-comment"># 1. 定义SQL插入语句（使用占位符%s，避免SQL注入）</span>
        insert_sql = <span class="hljs-string">"""
        INSERT INTO quotes (content, author, tags)
        VALUES (%s, %s, %s)
        """</span>
        
        <span class="hljs-comment"># 2. 提取Item数据，组装为参数元组（与SQL占位符顺序对应）</span>
        item_data = (
            item.get(<span class="hljs-string">"content"</span>),
            item.get(<span class="hljs-string">"author"</span>),
            item.get(<span class="hljs-string">"tags"</span>)
        )
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 3. 执行SQL语句</span>
            self.cursor.execute(insert_sql, item_data)
            <span class="hljs-comment"># 4. 提交事务（关键：不提交则数据不会写入数据库）</span>
            self.conn.commit()
            spider.logger.info(<span class="hljs-string">f"数据已插入MySQL：<span class="hljs-subst">{item.get(<span class="hljs-string">'author'</span>)}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 5. 出错时回滚事务，避免数据混乱</span>
            self.conn.rollback()
            spider.logger.error(<span class="hljs-string">f"数据插入MySQL失败：<span class="hljs-subst">{e}</span>，数据：<span class="hljs-subst">{item_data}</span>"</span>)
        
        <span class="hljs-keyword">return</span> item
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫关闭时，关闭游标和连接"""</span>
        <span class="hljs-keyword">if</span> self.cursor:
            self.cursor.close()
        <span class="hljs-keyword">if</span> self.conn:
            self.conn.close()
        spider.logger.info(<span class="hljs-string">"MySQL数据库连接已关闭"</span>)
</code></pre>
<h3 data-id="heading-15">4. 启用MySQL Pipeline（<code>settings.py</code>）</h3>
<pre><code class="hljs language-python" lang="python">ITEM_PIPELINES = {
   <span class="hljs-comment"># 可同时启用多个Pipeline，分别存储为CSV和MySQL（优先级300&lt;400，CSV先执行）</span>
   <span class="hljs-string">'data_storage_spider.pipelines.CsvFileStoragePipeline'</span>: <span class="hljs-number">300</span>,
   <span class="hljs-string">'data_storage_spider.pipelines.MysqlStoragePipeline'</span>: <span class="hljs-number">400</span>,
}
</code></pre>
<h3 data-id="heading-16">5. 运行爬虫验证结果</h3>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider
</code></pre>
<ul>
<li>验证：登录MySQL，查询<code>scrapy_data.quotes</code>表，可看到已成功插入数据，无乱码，字段对应完整。</li>
</ul>
<h2 data-id="heading-17">四、方式3：非关系型数据库存储（以MongoDB为例，灵活存储非结构化数据）</h2>
<p>适合存储非结构化/半结构化数据（如字段不固定的爬取数据），无需提前定义表结构，核心依赖<code>pymongo</code>库，步骤如下：</p>
<h3 data-id="heading-18">1. 安装依赖库</h3>
<pre><code class="hljs language-bash" lang="bash">pip install pymongo
</code></pre>
<h3 data-id="heading-19">2. 提前启动MongoDB服务</h3>
<ul>
<li>本地MongoDB：启动<code>mongod</code>服务（默认端口27017，无需手动创建数据库和集合，插入数据时自动创建）；</li>
<li>远程MongoDB：准备好连接地址、用户名、密码。</li>
</ul>
<h3 data-id="heading-20">3. 编写MongoDB存储Pipeline（<code>pipelines.py</code>）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pymongo

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MongodbStoragePipeline</span>:
    <span class="hljs-string">"""MongoDB数据库存储管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># MongoDB连接配置（本地无密码，远程需添加username、password、authSource）</span>
        self.host = <span class="hljs-string">"localhost"</span>
        self.port = <span class="hljs-number">27017</span>
        self.db_name = <span class="hljs-string">"scrapy_data"</span>
        self.collection_name = <span class="hljs-string">"quotes"</span>  <span class="hljs-comment"># 集合（类似MySQL的表）</span>
        
        <span class="hljs-comment"># 初始化数据库连接和集合对象</span>
        self.client = <span class="hljs-literal">None</span>
        self.db = <span class="hljs-literal">None</span>
        self.collection = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫启动时，建立MongoDB连接"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 建立连接（本地无密码）</span>
            self.client = pymongo.MongoClient(host=self.host, port=self.port)
            <span class="hljs-comment"># 选择数据库（不存在则自动创建）</span>
            self.db = self.client[self.db_name]
            <span class="hljs-comment"># 选择集合（不存在则自动创建）</span>
            self.collection = self.db[self.collection_name]
            spider.logger.info(<span class="hljs-string">"MongoDB数据库连接成功"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            spider.logger.error(<span class="hljs-string">f"MongoDB数据库连接失败：<span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span> e
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">self, item, spider</span>):
        <span class="hljs-string">"""核心：将Item数据插入MongoDB（转换为字典即可）"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> item.get(<span class="hljs-string">"content"</span>):
            <span class="hljs-keyword">return</span> item
        
        <span class="hljs-comment"># 1. 将Item转换为字典（Scrapy Item对象可直接强转为dict）</span>
        item_dict = <span class="hljs-built_in">dict</span>(item)
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 2. 插入数据（insert_one：插入单条数据；insert_many：插入多条数据）</span>
            self.collection.insert_one(item_dict)
            spider.logger.info(<span class="hljs-string">f"数据已插入MongoDB：<span class="hljs-subst">{item_dict.get(<span class="hljs-string">'author'</span>)}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            spider.logger.error(<span class="hljs-string">f"数据插入MongoDB失败：<span class="hljs-subst">{e}</span>，数据：<span class="hljs-subst">{item_dict}</span>"</span>)
        
        <span class="hljs-keyword">return</span> item
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫关闭时，关闭MongoDB连接"""</span>
        <span class="hljs-keyword">if</span> self.client:
            self.client.close()
            spider.logger.info(<span class="hljs-string">"MongoDB数据库连接已关闭"</span>)
</code></pre>
<h3 data-id="heading-21">4. 启用MongoDB Pipeline（<code>settings.py</code>）</h3>
<pre><code class="hljs language-python" lang="python">ITEM_PIPELINES = {
   <span class="hljs-string">'data_storage_spider.pipelines.CsvFileStoragePipeline'</span>: <span class="hljs-number">300</span>,
   <span class="hljs-string">'data_storage_spider.pipelines.MysqlStoragePipeline'</span>: <span class="hljs-number">400</span>,
   <span class="hljs-string">'data_storage_spider.pipelines.MongodbStoragePipeline'</span>: <span class="hljs-number">500</span>,
}
</code></pre>
<h3 data-id="heading-22">5. 运行爬虫验证结果</h3>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider
</code></pre>
<ul>
<li>验证：使用<code>mongo</code>终端连接，执行<code>use scrapy_data; db.quotes.find().pretty();</code>，可看到已成功插入数据，字段完整。</li>
</ul>
<h2 data-id="heading-23">五、核心注意事项与实操技巧</h2>
<ol>
<li><strong>Pipeline优先级</strong>：<code>ITEM_PIPELINES</code>中的数字（1-1000）越小，优先级越高，先执行的Pipeline处理后的Item会传递给后续Pipeline；</li>
<li><strong>数据去重</strong>：
<ul>
<li>MySQL：可给<code>content</code>字段添加唯一索引（<code>ALTER TABLE quotes ADD UNIQUE INDEX uk_content (content(255));</code>），避免重复插入；</li>
<li>MongoDB：使用<code>update_one()</code>，设置<code>upsert=True</code>（存在则更新，不存在则插入），基于唯一字段去重；</li>
</ul>
</li>
<li><strong>异常处理与事务</strong>：
<ul>
<li>数据库操作必须添加<code>try-except</code>，避免单个数据插入失败导致整个爬虫崩溃；</li>
<li>MySQL需手动提交事务（<code>conn.commit()</code>），出错时回滚（<code>conn.rollback()</code>）；MongoDB无需手动提交，默认自动写入；</li>
</ul>
</li>
<li><strong>中文乱码</strong>：
<ul>
<li>本地文件：必须使用<code>encoding="utf_8_sig"</code>（CSV/JSON）；</li>
<li>MySQL：数据库、表、字段均使用<code>utf8mb4</code>字符集；</li>
<li>MongoDB：默认支持UTF-8，无需额外配置；</li>
</ul>
</li>
<li><strong>资源释放</strong>：<code>open_spider()</code>建立连接，<code>close_spider()</code>关闭连接，避免资源泄露（尤其长期运行的分布式爬虫）；</li>
<li><strong>大规模数据优化</strong>：
<ul>
<li>本地文件：避免一次性写入大文件，可按批次拆分；</li>
<li>数据库：使用批量插入（MySQL<code>executemany()</code>、MongoDB<code>insert_many()</code>），减少数据库交互次数，提升效率。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS：User-Agent开发指导]]></title>    <link>https://juejin.cn/post/7590681158716407848</link>    <guid>https://juejin.cn/post/7590681158716407848</guid>    <pubDate>2026-01-04T01:35:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590681158716407848" data-draft-id="7590597231707979811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS：User-Agent开发指导"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-04T01:35:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChinaDragon"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681410840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS：User-Agent开发指导
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681410840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChinaDragon
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:35:05.000Z" title="Sun Jan 04 2026 01:35:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、简介</h3>
<blockquote>
<p>User-Agent（简称UA）是一个特殊的字符串，包含设备类型、操作系统及版本等关键信息。在Web开发中，这个字符串使服务器能够识别请求的来源设备及其特性，从而根据这些信息提供定制化的内容和服务。如果页面无法正确识别UA，可能会导致多种异常情况。例如，为移动设备优化的页面布局可能会在桌面设备上显示错乱，反之亦然。此外，某些特定的浏览器功能或CSS样式可能仅在特定的浏览器版本中受支持，如果页面无法根据UA字符串做出正确的判断，就可能导致渲染问题或逻辑错误。</p>
</blockquote>
<h3 data-id="heading-1">二、默认User-Agent结构</h3>
<h4 data-id="heading-2">2.1 默认User-Agent定义</h4>
<pre><code class="hljs language-bash" lang="bash">Mozilla/5.0 ({DeviceType}; {OSName} {OSVersion}) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/{ChromeCompatibleVersion}.0.0.0 Safari/537.36  ArkWeb/{ArkWeb VersionCode} {DeviceCompat} {扩展区}
</code></pre>
<p><strong>举例说明</strong></p>
<pre><code class="hljs language-bash" lang="bash">Mozilla/5.0 (Phone; OpenHarmony 5.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36  ArkWeb/4.1.6.1 Mobile
</code></pre>
<p><strong>字段说明</strong></p>





































<table><thead><tr><th align="left">字段</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">DeviceType</td><td align="left">当前的设备类型。取值范围：<br/>- Phone：手机设备<br/>- Tablet：平板设备<br/>- PC：2in1设备</td></tr><tr><td align="left">OSName</td><td align="left">基础操作系统名称。<br/>默认取值：OpenHarmony</td></tr><tr><td align="left">OSVersion</td><td align="left">基础操作系统版本，两位数字，M.S。<br/>通过系统参数const.ohos.fullname解析版本号得到，取版本号部分M.S前两位。<br/>默认取值：例如5.0</td></tr><tr><td align="left">ChromeCompatibleVersion</td><td align="left">兼容Chrome主版本的版本号，从114版本开始演进。<br/>默认取值：114</td></tr><tr><td align="left">ArkWeb</td><td align="left">HarmonyOS版本Web内核名称。<br/>默认取值：ArkWeb<br/> ArkWeb VersionCode	<br/>ArkWeb版本号，格式a.b.c.d。<br/>默认取值：例如4.1.6.1</td></tr><tr><td align="left">DeviceCompat</td><td align="left">前向兼容字段。<br/> 默认取值：Mobile</td></tr><tr><td align="left">扩展区</td><td align="left">三方应用可以扩展的字段。 <br/> 三方应用使用ArkWeb组件时，可以做UA扩展，例如加入APP相关信息标识。</td></tr></tbody></table>
<blockquote>
<p><strong>说明</strong></p>
<ul>
<li>当前默认User-Agent的ArkWeb字段前有两个空格。</li>
<li>当前通过User-Agent中是否含有"Mobile"字段来判断是否开启前端HTML页面中meta标签的viewport属性。当User-Agent中不含有"Mobile"字段时，meta标签中viewport属性默认关闭，此时可通过显性设置metaViewport属性为true来覆盖关闭状态。</li>
<li>建议通过OpenHarmony关键字识别是否是HarmonyOS设备，同时可以通过DeviceType识别设备类型用于不同设备上的页面显示（ArkWeb关键字表示设备使用的web内核，OpenHarmony关键字表示设备使用的操作系统，因此推荐通过OpenHarmony关键字识别是否是HarmonyOS设备）。</li>
<li>{DistributionOSName}和{DistributionOSVersion}字段在API version 15之前的版本中未启用，从API version 15版本开始不在默认User-Agent中体现。</li>
</ul>
</blockquote>
<h3 data-id="heading-3">三、自定义User-Agent结构</h3>
<blockquote>
<p>在下面的示例中，通过调用getUserAgent()接口获取当前默认的用户代理（User-Agent）字符串。这一接口提供的默认User-Agent信息为开发者提供了基础，使开发者能够基于这个默认信息进行定制或扩展。</p>
</blockquote>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71420fa5f35244979d079e52ced04b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=DUg4OrnR7wjfoS7I7MMGKxE%2Bh9c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent {
  @State message: string = <span class="hljs-string">'getUserAgent'</span>;
  controller: webview.WebviewController = new webview.WebviewController()

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(this.message)
        .<span class="hljs-built_in">id</span>(<span class="hljs-string">'TestUserAgentHelloWorld'</span>)
        .fontSize(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.float.page_text_font_20fp'</span>))
        .fontWeight(FontWeight.Bold)
        .onClick(() =&gt; {
          try {
            let userAgent = this.controller.getUserAgent();
            console.log("获取 userAgent: " + userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'www.baidu.com', controller: this.controller })
    }
    .height('<span class="hljs-number">100</span>%')
    .width('<span class="hljs-number">100</span>%')
  }
}
</code></pre>
<blockquote>
<p>以下示例通过 <strong>setCustomUserAgent()</strong> 接口设置自定义用户代理，但请注意，此操作会覆盖系统的用户代理。因此，我们建议将扩展字段追加在默认用户代理的末尾，比如三方应用程序的开发场景，可以在系统默认用户代理字符串的末尾追加特定的APP标识，这样既能保留原有用户代理信息，又能增加自定义的应用识别信息。 <br/>
当Web组件src设置了url时，建议在<strong>onControllerAttached</strong>回调事件中设置User-Agent，设置方式请参考示例。不建议将User-Agent设置在onLoadIntercept回调事件中，会概率性出现设置失败。如果未在onControllerAttached回调事件中设置User-Agent。再调用setCustomUserAgent方法时，可能会出现加载的页面与实际设置User-Agent不符的异常现象。 <br/>
当Web组件src设置为空字符串时，建议先调用setCustomUserAgent方法设置User-Agent，再通过loadUrl加载具体页面。</p>
</blockquote>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23cd7366741a43a7b418c27a3224231f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=RQ9Z0rczoOyRY1BH4Gv8OAJpkTk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

const TAG = <span class="hljs-string">"TestUserAgent"</span>
@Entry
@Component
struct TestUserAgent {
  @State message: string = <span class="hljs-string">'getUserAgent'</span>;
  controller: webview.WebviewController = new webview.WebviewController()
  // 三方应用相关信息标识
  @State customUserAgent: string = <span class="hljs-string">' DemoApp 自定义用户代理'</span>;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(this.message)
        .<span class="hljs-built_in">id</span>(<span class="hljs-string">'TestUserAgentHelloWorld'</span>)
        .fontSize(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.float.page_text_font_20fp'</span>))
        .fontWeight(FontWeight.Bold)
        .onClick(() =&gt; {
          try {
            let userAgent = this.controller.getUserAgent();
            let customUserAgent = this.controller.getCustomUserAgent()
            console.log("获取 userAgent: " + userAgent);
            console.log("获取 customUserAgent: " + customUserAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com/', controller: this.controller })
        .domStorageAccess(true)
        .onControllerAttached(() =&gt;{
          console.log("执行了 onControllerAttached 回调");
          try {
            let userAgent = this.controller.getUserAgent()+ this.customUserAgent
            this.controller.setCustomUserAgent(userAgent)
          }catch (error){
            console.error(TAG, `ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
    }
    .height('<span class="hljs-number">100</span>%')
    .width('<span class="hljs-number">100</span>%')
  }
}
</code></pre>
<blockquote>
<p>从<strong>API version 20</strong>开始，可通过 <strong>setAppCustomUserAgent()</strong> 接口设置应用级自定义用户代理，或者通过 <strong>setUserAgentForHosts()</strong> 对特定网站设置应用级自定义用户代理，覆盖系统的用户代理，应用内所有Web组件生效。 <br/>
建议在Web组件创建前先调用静态接口getDefaultUserAgent获取默认的用户代理（User-Agent）字符串，然后调用setAppCustomUserAgent，setUserAgentForHosts方法设置User-Agent，再创建指定src的Web组件或通过loadUrl加载具体页面。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent2 {
  controller: webview.WebviewController = new webview.WebviewController();
  @State userAgent: string = <span class="hljs-string">''</span>;

  aboutToAppear(): void {
    try {
      webview.WebviewController.initializeWebEngine();
      <span class="hljs-built_in">let</span> defaultUserAgent = webview.WebviewController.getDefaultUserAgent();
      <span class="hljs-built_in">let</span> appUA = defaultUserAgent + <span class="hljs-string">" appUA "</span>;
      webview.WebviewController.setAppCustomUserAgent(appUA+<span class="hljs-string">" application"</span>);
      webview.WebviewController.setUserAgentForHosts(
        appUA + <span class="hljs-string">"specific_net"</span>,
        [
          <span class="hljs-string">"developer.huawei.com"</span>,
          <span class="hljs-string">"www.deepseek.com"</span>,
          <span class="hljs-string">"www.baidu.com"</span>
        ]
      );
    } catch (error) {
      console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
    }
  }

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(<span class="hljs-string">'getCustomUserAgent'</span>)
        .onClick(() =&gt; {
          try {
            this.userAgent = this.controller.getCustomUserAgent();
            console.log("通过getCustomUserAgent()接口获取自定义用户代理 userAgent: " + this.userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com', controller: this.controller })
    }
  }
}
</code></pre>
<blockquote>
<p>在下面的示例中，通过getCustomUserAgent()接口获取自定义用户代理。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent2 {
  controller: webview.WebviewController = new webview.WebviewController();
  @State userAgent: string = <span class="hljs-string">''</span>;

  aboutToAppear(): void {
    try {
      webview.WebviewController.initializeWebEngine();
      <span class="hljs-built_in">let</span> defaultUserAgent = webview.WebviewController.getDefaultUserAgent();
      <span class="hljs-built_in">let</span> appUA = defaultUserAgent + <span class="hljs-string">" appUA "</span>;
      webview.WebviewController.setAppCustomUserAgent(appUA+<span class="hljs-string">" application"</span>);
      webview.WebviewController.setUserAgentForHosts(
        appUA + <span class="hljs-string">"spefical_net"</span>,
        [
          <span class="hljs-string">"developer.huawei.com"</span>,
          <span class="hljs-string">"www.deepseek.com"</span>,
          <span class="hljs-string">"www.baidu.com"</span>
        ]
      );
    } catch (error) {
      console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
    }
  }

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(<span class="hljs-string">'getCustomUserAgent'</span>)
        .onClick(() =&gt; {
          try {
            this.userAgent = this.controller.getCustomUserAgent();
            console.log("通过getCustomUserAgent()接口获取自定义用户代理 userAgent: " + this.userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com', controller: this.controller })
    }
  }
}
</code></pre>
<h3 data-id="heading-4">四、相关User-Agent接口优先级</h3>






























<table><thead><tr><th align="left">接口名称</th><th align="left">优先级</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">setCustomUserAgent</td><td align="left">最高</td><td align="left">对调用的Web组件生效。</td></tr><tr><td align="left">setUserAgentForHosts</td><td align="left">低于setCustomUserAgent</td><td align="left">对应用中所有Web组件访问指定网站生效。</td></tr><tr><td align="left">setAppCustomUserAgent</td><td align="left">低于setUserAgentForHosts</td><td align="left">对应用中所有Web组件生效。</td></tr><tr><td align="left">ArkWeb默认UA</td><td align="left">最低</td><td align="left">对应用中所有Web组件生效，只读，通过getDefaultUserAgent获取。</td></tr></tbody></table>
<h3 data-id="heading-5">五、常见问题</h3>
<h4 data-id="heading-6">5.1 如何通过User-Agent来识别HarmonyOS操作系统中不同设备</h4>
<blockquote>
<p>HarmonyOS设备的识别主要通过User-Agent中的系统、系统版本和设备类型三个维度来判断。建议同时检查系统、系统版本和设备类型，以确保更准确的设备识别。</p>
</blockquote>
<h5 data-id="heading-7">5.1.1 系统识别</h5>
<blockquote>
<p>通过User-Agent中的{OSName}字段识别HarmonyOS系统。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">const isHarmonyOS = () =&gt; /OpenHarmony/i.test(navigator.userAgent);   
</code></pre>
<h5 data-id="heading-8">5.1.2 系统版本识别</h5>
<blockquote>
<p>通过User-Agent中的{OSName}和{OSVersion}字段识别HarmonyOS系统及系统版本。格式为：OpenHarmony + 版本号。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">// 检测是否是HarmonyOS系统
const matches = navigator.userAgent.match(/OpenHarmony (\d+\.?\d*)/);  
matches?.length &amp;&amp; Number(matches[1]) &gt; 0
// 检测是否是HarmonyOS NEXT系统
const matches = navigator.userAgent.match(/OpenHarmony (\d+\.?\d*)/);  
matches?.length &amp;&amp; Number(matches[1]) &gt;= 5;   
</code></pre>
<h5 data-id="heading-9">5.1.3 设备类型识别</h5>
<blockquote>
<p>通过deviceType字段来识别不同设备类型。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">// 检测是否为手机设备
const isPhone = () =&gt; /Phone/i.test(navigator.userAgent);

// 检测是否为平板设备  
const isTablet = () =&gt; /Tablet/i.test(navigator.userAgent);

// 检测是否为2in1设备  
const is2in1 = () =&gt; /PC/i.test(navigator.userAgent);
</code></pre>
<h4 data-id="heading-10">5.2 如何模拟HarmonyOS操作系统的User-Agent进行前端调试</h4>
<blockquote>
<p>在Windows/Mac/Linux等操作系统中，可以通过Chrome/Edge/Firefox等浏览器DevTools提供的User-Agent复写能力，模拟HarmonyOS User-Agent。</p>
</blockquote>
<h4 data-id="heading-11">5.3 如何在HarmonyOS中自定义User-Agent以实现H5兼容性</h4>
<blockquote>
<p>HarmonyOS提供setCustomUserAgent接口以支持User-Agent的自定义设置。为适配移动端H5页面通常依赖的UA标识检测（如Mobile、Android等），并确保不覆盖系统默认UA信息，推荐按如下方式操作：首先通过setCustomUserAgent()接口获取系统默认User-Agent字符串，随后将H5兼容所需的自定义标识字段追加至该字符串末尾，最后调用setCustomUserAgent接口设置修改后的完整UA字符串。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简析 Kotlin 内联函数：与inline相关的关键字]]></title>    <link>https://juejin.cn/post/7590957076630552622</link>    <guid>https://juejin.cn/post/7590957076630552622</guid>    <pubDate>2026-01-04T01:38:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590957076630552622" data-draft-id="7590929624743395378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简析 Kotlin 内联函数：与inline相关的关键字"/> <meta itemprop="keywords" content="Java,Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-04T01:38:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简析 Kotlin 内联函数：与inline相关的关键字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:38:23.000Z" title="Sun Jan 04 2026 01:38:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们知道 <code>inline</code> 函数的作用是可以在调用处替换为函数体实现，可以减少函数调用栈的使用，从而提升效率，本文会一起看看跟 <code>inline</code> 一起配合使用的几个关键字</p>
<h2 data-id="heading-0">0x00 inline + reified</h2>
<p>在Kotlin中经常会看到一些内联函数是配合 reified 关键字使用</p>
<ul>
<li>保留运行时的类型</li>
<li>原理是在调用处将范型替换为实际类型</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">checkType</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> T) { <span class="hljs-comment">// ❌ 这里会编译出错！</span>
				println(<span class="hljs-string">"<span class="hljs-subst">${obj}</span> 是 <span class="hljs-subst">${T::class.simpleName}</span> 类型"</span>)
		}
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 添加 reified 关键字（必须配合 inline 使用）</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> <span class="hljs-title">checkType</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> T) { <span class="hljs-comment">// ✅ 现在可以了！</span>
        println(<span class="hljs-string">"<span class="hljs-subst">${obj}</span> 是 <span class="hljs-subst">${T::class.simpleName}</span> 类型"</span>)
    }
}

<span class="hljs-comment">// 使用示例</span>
checkType&lt;String&gt;(<span class="hljs-string">"Hello"</span>)  <span class="hljs-comment">// 输出：Hello 是 String 类型</span>
checkType&lt;<span class="hljs-built_in">Int</span>&gt;(<span class="hljs-string">"Text"</span>)      <span class="hljs-comment">// 无输出，类型不匹配</span>
</code></pre>
<h3 data-id="heading-1"><strong>简化Activity启动（无需传递Class参数）</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 reified 的优雅方式</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : Activity&gt;</span> Context.<span class="hljs-title">startActivity</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, T::<span class="hljs-keyword">class</span>.java) <span class="hljs-comment">// 直接访问泛型类型的Class</span>
    startActivity(intent)
}
<span class="hljs-comment">// 调用 - 类型清晰，无需::class.java</span>
startActivity&lt;DetailActivity&gt;()
</code></pre>
<h3 data-id="heading-2"><strong>Retrofit + reified 简化API响应处理</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 传统方式：需要传递Type</span>
apiService.getUser().enqueue(<span class="hljs-keyword">object</span> : Callback&lt;User&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">User</span>&gt;, response: <span class="hljs-type">Response</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> {
        <span class="hljs-comment">// 处理响应</span>
    }
})

<span class="hljs-comment">// 使用 reified 的扩展函数</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> Call<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">enqueueSimplified</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> onSuccess: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>,
    <span class="hljs-keyword">crossinline</span> onError: (<span class="hljs-type">Throwable</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    enqueue(<span class="hljs-keyword">object</span> : Callback&lt;T&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">T</span>&gt;, response: <span class="hljs-type">Response</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
            <span class="hljs-keyword">if</span> (response.isSuccessful) {
                onSuccess(response.body()!!)
            }
        }
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">T</span>&gt;, t: <span class="hljs-type">Throwable</span>)</span></span> {
            onError(t)
        }
    })
}

<span class="hljs-comment">// 调用更加简洁</span>
apiService.getUser().enqueueSimplified(
    onSuccess = { user -&gt; showUser(user) },
    onError = { error -&gt; showError(error) }
)
</code></pre>
<h2 data-id="heading-3">0x01 <strong><code>noinline</code>：阻止内联</strong></h2>
<p><strong>为什么需要它？<strong>当一个 Lambda 参数需要被</strong>存储</strong>、<strong>传递</strong>给其他非内联函数，或在<strong>非内联上下文中调用</strong>时，就必须使用 <code>noinline</code>.</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：需要存储 Lambda</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> onStart: () -&gt; <span class="hljs-type">Unit</span>, <span class="hljs-comment">// 这个会被内联</span>
    <span class="hljs-keyword">noinline</span> onComplete: () -&gt; <span class="hljs-type">Unit</span>   <span class="hljs-comment">// 这个不会被内联</span>
)</span></span> {
    <span class="hljs-comment">// 1. onStart 可以直接调用（内联）</span>
    onStart()
    
    <span class="hljs-comment">// 2. onComplete 需要被存储或传递</span>
    <span class="hljs-keyword">val</span> completionCallback = onComplete  <span class="hljs-comment">// ✅ 可以存储，因为它是 noinline</span>
    runLater(completionCallback)         <span class="hljs-comment">// ✅ 可以传递给普通函数</span>
    
    <span class="hljs-comment">// 3. 尝试存储 onStart 会报错</span>
    <span class="hljs-comment">// val startCallback = onStart  // ❌ 错误：不能存储 crossinline lambda</span>
}

<span class="hljs-comment">// 一个普通（非内联）函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runLater</span><span class="hljs-params">(callback: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-comment">// 稍后执行...</span>
}·
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li>变为普通函数对象，有内存开销</li>
<li>可以传递给其他非内联函数</li>
<li>可以存储在变量或属性中</li>
<li><strong>不支持非局部返回</strong>（因为它已经不是内联的了）</li>
</ul>
<h2 data-id="heading-4">0x02 <strong><code>crossinline</code>：禁止非局部返回</strong></h2>
<p><strong>作用</strong>：允许 Lambda 被内联，但<strong>禁止在 Lambda 内部使用非局部返回</strong>（即直接 <code>return</code>）。</p>
<p><strong>为什么需要它？</strong></p>
<p>当 Lambda 参数在另一个执行上下文中被调用时（如嵌套函数、另一个 Lambda），直接 <code>return</code> 会变得语义模糊，因此需要禁止</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：Lambda 在嵌套上下文中执行</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runInBackground</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> task: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-comment">// 将 task 传递给另一个执行上下文</span>
    Thread {
        task()  <span class="hljs-comment">// 这里 task 是在新线程中执行，不是从 runInBackground 返回</span>
    }.start()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testFunction</span><span class="hljs-params">()</span></span> {
    runInBackground {
        println(<span class="hljs-string">"在后台执行"</span>)
        <span class="hljs-comment">// return  // ❌ 如果允许，这个 return 是要从 testFunction 返回，还是从 Lambda 返回？</span>
        <span class="hljs-comment">// 编译器禁止这种模糊的语义，必须使用：</span>
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@runInBackground</span>  <span class="hljs-comment">// ✅ 明确表示从 Lambda 返回</span>
    }
    println(<span class="hljs-string">"这行会被执行"</span>)
}
</code></pre>
<p><strong>典型应用场景</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android 中的 View.post 就是一个典型例子</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">post</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> action: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> runnable = Runnable { action() }  <span class="hljs-comment">// action 在 Runnable 中执行</span>
    handler.post(runnable)
}

<span class="hljs-comment">// 使用</span>
view.post {
    updateUI()
    <span class="hljs-comment">// 不能直接 return，必须用 return@post</span>
    <span class="hljs-keyword">if</span> (condition) <span class="hljs-keyword">return</span><span class="hljs-symbol">@post</span>  <span class="hljs-comment">// ✅ 局部返回</span>
}
</code></pre>
<p><strong>场景：结合使用多个修饰符</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(
    <span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">noinline</span> validator: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Boolean</span>, <span class="hljs-comment">// 需要传递给普通函数</span>
    <span class="hljs-keyword">crossinline</span> onSuccess: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>, <span class="hljs-comment">// 在回调中执行，禁止非局部返回</span>
    onError: (<span class="hljs-type">Exception</span>) -&gt; <span class="hljs-type">Unit</span> <span class="hljs-comment">// 默认内联，允许非局部返回</span>
)</span></span> {
    <span class="hljs-comment">// validator 被传递给普通函数</span>
    <span class="hljs-keyword">if</span> (!validateInput(<span class="hljs-keyword">data</span>, validator)) {
        onError(IllegalArgumentException(<span class="hljs-string">"无效数据"</span>))
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// onSuccess 在异步回调中执行</span>
    doAsyncWork(<span class="hljs-keyword">data</span>) { result -&gt;
        onSuccess(result)  <span class="hljs-comment">// 这里禁止非局部返回</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateInput</span><span class="hljs-params">(input: <span class="hljs-type">String</span>, validator: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> validator(input)  <span class="hljs-comment">// 普通函数接收 noinline lambda</span>
}
</code></pre>
<h2 data-id="heading-5">0x03 <strong>核心总结</strong></h2>
<ol>
<li><strong><code>noinline</code> 是“功能开关”</strong>：关闭内联，换取存储/传递能力</li>
<li><strong><code>crossinline</code> 是“安全限制”</strong>：保持内联，但禁止模糊的返回语义</li>
<li><strong>默认行为是最灵活的</strong>：既内联又允许非局部返回，但限制最多</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS：管理Cookie及数据存储]]></title>    <link>https://juejin.cn/post/7590433626560905251</link>    <guid>https://juejin.cn/post/7590433626560905251</guid>    <pubDate>2026-01-04T01:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560905251" data-draft-id="7590433626560839715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS：管理Cookie及数据存储"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-04T01:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChinaDragon"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681410840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS：管理Cookie及数据存储
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681410840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChinaDragon
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:39:54.000Z" title="Sun Jan 04 2026 01:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、 概述</h3>
<blockquote>
<p>Cookie是服务端发送客户端的数据。客户端持有Cookie，便于服务端快速识别身份和状态。 <br/>
当Cookie的SameSite属性未指定时，默认值为SameSite=Lax。这种设置下，Cookie仅在用户导航到其源站点时发送，不会在跨站请求中发送。</p>
</blockquote>
<h3 data-id="heading-1">二、Cookie管理</h3>
<blockquote>
<p>Web组件提供WebCookieManager类来管理Cookie信息。Cookie信息存储在应用沙箱路径下/proc/{pid}/root/data/storage/el2/base/cache/web/Cookies的文件中。 <br/>
下面以configCookieSync()接口为例，为“<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com%25E2%2580%259D%25E8%25AE%25BE%25E7%25BD%25AE%25E5%258D%2595%25E4%25B8%25AACookie%25E7%259A%2584%25E5%2580%25BC%25E2%2580%259Cvalue%3Dtest%25E2%2580%259D%25E3%2580%2582%25E5%2585%25B6%25E4%25BB%2596Cookie%25E7%259A%2584%25E7%259B%25B8%25E5%2585%25B3%25E5%258A%259F%25E8%2583%25BD%25E5%258F%258A%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258C%25E8%25AF%25B7%25E5%258F%2582%25E8%2580%2583WebCookieManager()%25E6%258E%25A5%25E5%258F%25A3%25E6%2596%2587%25E6%25A1%25A3%25E3%2580%2582" target="_blank" title="http://www.baidu.com%E2%80%9D%E8%AE%BE%E7%BD%AE%E5%8D%95%E4%B8%AACookie%E7%9A%84%E5%80%BC%E2%80%9Cvalue=test%E2%80%9D%E3%80%82%E5%85%B6%E4%BB%96Cookie%E7%9A%84%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%8F%8A%E4%BD%BF%E7%94%A8%EF%BC%8C%E8%AF%B7%E5%8F%82%E8%80%83WebCookieManager()%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E3%80%82" ref="nofollow noopener noreferrer">www.baidu.com”设置单个Cookie的值“value=test”。其他Cookie的相关功能及使用，请参考WebCookieManager()接口文档。</a></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
 import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
 import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

 @Entry
 @Component
 struct TestCookie {
   controller: webview.WebviewController = new webview.WebviewController();

   <span class="hljs-function"><span class="hljs-title">build</span></span>() {
     <span class="hljs-function"><span class="hljs-title">Column</span></span>() {
       Button(<span class="hljs-string">'configCookieSync'</span>)
         .onClick(() =&gt; {
           try {
             webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
           } catch (error) {
             console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
           }
         })
       Web({ src: 'https://www.baidu.com', controller: this.controller })
     }
   }
 }
</code></pre>
<blockquote>
<p><strong>说明</strong>
Cookie每30s周期性保存到磁盘中，也可以使用接口saveCookieAsync进行强制落盘（PC/2in1和Tablet设备不会持久化session cookie，即使调用saveCookieAsync，也不会将session cookie写入磁盘）。</p>
</blockquote>
<h3 data-id="heading-2">三、缓存与存储管理</h3>
<blockquote>
<p>在访问网站时，网络资源请求通常需要较长的时间。开发者可以通过Cache和Dom Storage等手段将资源保存到本地，以提高访问同一网站的速度。</p>
</blockquote>
<h4 data-id="heading-3">3.1 Cache</h4>
<blockquote>
<p>使用 <strong>cacheMode()</strong> 配置页面资源的缓存模式，Web组件为开发者提供四种缓存模式，分别为：</p>
<ul>
<li>Default：优先使用未过期的缓存。如果缓存不存在，则从网络获取。</li>
<li>None：加载资源使用缓存。如果缓存中无该资源，则从网络中获取。</li>
<li>Online：加载资源不使用缓存。全部从网络中获取。</li>
<li>Only：只从缓存中加载资源。</li>
</ul>
</blockquote>
<p><strong>在下面的示例中，缓存设置为None模式。</strong></p>
<pre><code class="hljs language-bash" lang="bash">
 import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
 import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

 @Entry
 @Component
 struct TestCookie {
   controller: webview.WebviewController = new webview.WebviewController();
   @State mode: CacheMode = CacheMode.None;
   <span class="hljs-function"><span class="hljs-title">build</span></span>() {
     <span class="hljs-function"><span class="hljs-title">Column</span></span>() {
       Button(<span class="hljs-string">'configCookieSync'</span>)
         .onClick(() =&gt; {
           try {
             webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
           } catch (error) {
             console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
           }
         })
       Web({ src: 'https://www.baidu.com', controller: this.controller })
         .cacheMode(this.mode)
     }
   }
 }

</code></pre>
<p><strong>为了获取最新资源，开发者可以通过removeCache()接口清除已经缓存的资源，示例代码如下：</strong></p>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
    }
  }
}

</code></pre>
<h4 data-id="heading-4">3.2 Dom Storage</h4>
<blockquote>
<p>Dom Storage包含了Session Storage和Local Storage两类。Session Storage为临时数据，其存储与释放跟随会话生命周期；Local Storage为持久化数据，保存在应用目录下。两者的数据均通过Key-Value的形式存储，在访问需要客户端存储的页面时使用。开发者可以通过Web组件的属性接口domStorageAccess()进行使能配置，示例如下：</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
        .domStorageAccess(true)
    }
  }
}

</code></pre>
<h3 data-id="heading-5">四、获取指定url对应cookie的值</h3>
<blockquote>
<p>fetchCookieSync
获取指定url对应cookie的值。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">static fetchCookieSync(url: string, incognito?: boolean): string
</code></pre>
<blockquote>
<p><strong>说明</strong>
系统会自动清理过期的cookie，对于同名key的数据，新数据将会覆盖前一个数据。 <br/>
为了获取可正常使用的cookie值，fetchCookieSync需传入完整链接。 <br/>
fetchCookieSync用于获取所有的cookie值，每条cookie值之间会通过"; "进行分隔，但无法单独获取某一条特定的cookie值。</p>
</blockquote>
<blockquote>
<p><strong>系统能力</strong>： SystemCapability.Web.Webview.Core</p>
</blockquote>
<p><strong>参数</strong></p>























<table><thead><tr><th align="left">参数名</th><th align="left">类型</th><th align="left">必填</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">url</td><td align="left">string</td><td align="left">是</td><td align="left">要获取的cookie所属的url，建议使用完整的url。</td></tr><tr><td align="left">incognito</td><td align="left">boolean</td><td align="left">否</td><td align="left">true表示获取隐私模式下webview的内存cookies，false表示正常非隐私模式下的cookies。<br/>默认值：false。</td></tr></tbody></table>
<p><strong>返回值：</strong></p>













<table><thead><tr><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">string</td><td align="left">指定url对应的cookie的值。</td></tr></tbody></table>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17e1560d4ff840c78c1a1a30dcc464c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095606&amp;x-signature=dqHU%2FITycjvt81CyQvj8lqyCxdU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7df999876564b2f9407cc8112fec54a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095606&amp;x-signature=fPQ4yCIuoA86SQFP%2BXwquMzG5AI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Button('fetchCookieSync')
        .onClick(() =&gt; {
          try {
            let value = webview.WebCookieManager.fetchCookieSync('https://www.baidu.com');
            console.info("获取指定url对应cookie的值 fetchCookieSync cookie = " + value);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
        .domStorageAccess(true)
    }
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍]]></title>    <link>https://juejin.cn/post/7590403249560928271</link>    <guid>https://juejin.cn/post/7590403249560928271</guid>    <pubDate>2026-01-03T12:21:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249560928271" data-draft-id="7587261929383968820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍"/> <meta itemprop="keywords" content="后端,C#,.NET"/> <meta itemprop="datePublished" content="2026-01-03T12:21:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码编匠"/> <meta itemprop="url" content="https://juejin.cn/user/1308876155395739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1308876155395739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码编匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:21:39.000Z" title="Sat Jan 03 2026 12:21:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>工业控制、物联网设备通信中，是否遇到过这样的场景：向设备发送一个简单的查询指令，却发现返回的数据总是"分批到达"？明明应该收到完整的20字节响应，却只能收到几个零散的数据包？</p>
<p><strong>别急，这不是你的代码有问题！</strong></p>
<p>这是串口通信中最常见的"分包接收"现象。设备可能一次发送10字节，下一次发送剩余的10字节，而我们的程序却不知道什么时候才算接收完成。</p>
<p>今天我们就来彻底解决这个让无数 C# 开发头疼的问题！</p>
<h3 data-id="heading-1">为什么会分包接收？</h3>
<h4 data-id="heading-2">根本原因</h4>
<p>串口通信是<strong>异步</strong>的，数据传输会受到以下因素影响：</p>
<p><strong>硬件缓冲区大小限制</strong></p>
<p><strong>设备处理速度差异</strong></p>
<p><strong>网络延迟</strong>（对于串口转以太网设备）</p>
<p><strong>系统调度</strong></p>
<p>这些因素导致原本连续的数据流被操作系统或中间设备拆分成多个小块，逐次送达应用程序。</p>
<h4 data-id="heading-3">传统方案的痛点</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 错误示例：只能收到第一包数据</span>
serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
Thread.Sleep(<span class="hljs-number">100</span>); <span class="hljs-comment">// 固定等待时间</span>
<span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];
<span class="hljs-built_in">int</span> count = serialPort.Read(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>); <span class="hljs-comment">// 可能只读到部分数据</span>
</code></pre>
<p>这种写法的问题包括：</p>
<p>固定等待时间不可靠</p>
<p>无法判断数据是否接收完整</p>
<p>容易丢失后续数据包</p>
<h3 data-id="heading-4">四种灵活接收策略</h3>
<p>为应对不同应用场景，我们设计了以下四种策略：</p>
<h4 data-id="heading-5">方案一：数据间隔超时判断（⭐推荐）</h4>
<p><strong>适用场景</strong>：不知道数据长度，但设备发送完毕后会有明显时间间隔。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithGapTimeout</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
{
    <span class="hljs-comment">// 清空缓冲区并开始接收</span>
    <span class="hljs-keyword">lock</span> (bufferLock)
    {
        receivedBuffer.Clear();
        isWaitingForResponse = <span class="hljs-literal">true</span>;
        lastReceiveTime = DateTime.Now;
    }
    <span class="hljs-comment">// 发送指令</span>
    serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
    
    DateTime startTime = DateTime.Now;
    
    <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
    {
        Thread.Sleep(<span class="hljs-number">10</span>);
        
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-comment">// 🔥 关键逻辑：有数据且间隔超时则认为接收完成</span>
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span> &amp;&amp; 
                (DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
            {
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            }
        }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<blockquote>
<p>实际业务中，这个能解决大部分问题。</p>
</blockquote>
<h4 data-id="heading-6">方案二：结束符判断</h4>
<p><strong>适用场景</strong>：数据以特定字符结尾（如 <code>\r\n</code>、<code>\0</code> 等）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithEndMarker</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span>[] endMarker, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
{
    <span class="hljs-comment">// ... 发送逻辑相同 ...</span>
    
    <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= endMarker.Length)
            {
                <span class="hljs-comment">// 🔥 检查缓冲区末尾是否包含结束标记</span>
                <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                    {
                        foundEndMarker = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                
                <span class="hljs-keyword">if</span> (foundEndMarker)
                {
                    <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-7">方案三：协议帧结构判断</h4>
<p><strong>适用场景</strong>：数据有固定帧头和长度字段（如 Modbus 协议）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithFrameProtocol</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span> frameHeader, <span class="hljs-built_in">int</span> lengthFieldOffset, <span class="hljs-built_in">int</span> lengthFieldSize = <span class="hljs-number">1</span></span>)</span>
{
    <span class="hljs-comment">// ... 发送逻辑 ...</span>
    
    <span class="hljs-keyword">while</span> (<span class="hljs-comment">/* 超时检查 */</span>)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; lengthFieldOffset + lengthFieldSize)
            {
                <span class="hljs-comment">// 检查帧头</span>
                <span class="hljs-keyword">if</span> (receivedBuffer[<span class="hljs-number">0</span>] == frameHeader)
                {
                    <span class="hljs-comment">// 🔥 从长度字段获取数据长度</span>
                    <span class="hljs-built_in">int</span> dataLength = lengthFieldSize == <span class="hljs-number">1</span> ? 
                        receivedBuffer[lengthFieldOffset] : 
                        (receivedBuffer[lengthFieldOffset] &lt;&lt; <span class="hljs-number">8</span>) | receivedBuffer[lengthFieldOffset + <span class="hljs-number">1</span>];
                    
                    <span class="hljs-built_in">int</span> expectedFrameLength = lengthFieldOffset + lengthFieldSize + dataLength;
                    
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= expectedFrameLength)
                    {
                        <span class="hljs-keyword">return</span> receivedBuffer.Take(expectedFrameLength).ToArray();
                    }
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-8">方案四：组合策略（⭐⭐推荐）</h4>
<p><strong>最灵活的方案</strong>，同时使用多种判断条件：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithCombinedStrategy</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command,
    <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>,     // 数据间隔超时
    <span class="hljs-built_in">byte</span>[] endMarker = <span class="hljs-literal">null</span>,    // 结束标记  
    <span class="hljs-built_in">int</span>? maxLength = <span class="hljs-literal">null</span>,      // 最大长度限制
    <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)       <span class="hljs-comment">// 总超时时间</span></span>
{
    <span class="hljs-comment">// ... 发送逻辑 ...</span>
    
    <span class="hljs-keyword">while</span> (<span class="hljs-comment">/* 总超时检查 */</span>)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            
            <span class="hljs-comment">// 🔥 条件1：达到最大长度限制</span>
            <span class="hljs-keyword">if</span> (maxLength.HasValue &amp;&amp; receivedBuffer.Count &gt;= maxLength.Value)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            
            <span class="hljs-comment">// 🔥 条件2：发现结束标记</span>
            <span class="hljs-keyword">if</span> (endMarker != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-comment">/* 检查结束标记逻辑 */</span>)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            
            <span class="hljs-comment">// 🔥 条件3：数据间隔超时</span>
            <span class="hljs-keyword">if</span> ((DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
        }
    }
}
</code></pre>
<h3 data-id="heading-9">核心机制：数据接收事件</h3>
<p>所有策略都依赖于统一的数据接收事件处理：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDataReceived</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, SerialDataReceivedEventArgs e</span>)</span>
{
    <span class="hljs-keyword">if</span> (!isWaitingForResponse) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-built_in">int</span> bytesToRead = serialPort.BytesToRead;
        <span class="hljs-keyword">if</span> (bytesToRead &gt; <span class="hljs-number">0</span>)
        {
            <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bytesToRead];
            <span class="hljs-built_in">int</span> bytesRead = serialPort.Read(buffer, <span class="hljs-number">0</span>, bytesToRead);
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.AddRange(buffer);
                lastReceiveTime = DateTime.Now; <span class="hljs-comment">// 🔥 更新最后接收时间</span>
                Console.WriteLine(<span class="hljs-string">$"收到数据包 (<span class="hljs-subst">{bytesRead}</span> 字节): <span class="hljs-subst">{BitConverter.ToString(buffer, <span class="hljs-number">0</span>, bytesRead)}</span>"</span>);
            }
        }
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        Console.WriteLine(<span class="hljs-string">$"数据接收异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
    }
}
</code></pre>
<h3 data-id="heading-10">完整代码</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.IO.Ports;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AppFlexSerialPort</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FlexibleSerialPort</span>
    {
        <span class="hljs-keyword">private</span> SerialPort serialPort;
        <span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">byte</span>&gt; receivedBuffer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> bufferLock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
        <span class="hljs-keyword">private</span> Timer timeoutTimer;
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isWaitingForResponse = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">private</span> DateTime lastReceiveTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> dataGapTimeout = <span class="hljs-number">100</span>; <span class="hljs-comment">// 数据间隔超时时间(ms)</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FlexibleSerialPort</span>()</span>
        {
            receivedBuffer = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">byte</span>&gt;();
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化串口</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitializePort</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> portName = <span class="hljs-string">"COM1"</span>, <span class="hljs-built_in">int</span> baudRate = <span class="hljs-number">9600</span>,
            Parity parity = Parity.None, <span class="hljs-built_in">int</span> dataBits = <span class="hljs-number">8</span>, StopBits stopBits = StopBits.One</span>)</span>
        {
            <span class="hljs-keyword">try</span>
            {
                serialPort = <span class="hljs-keyword">new</span> SerialPort(portName, baudRate, parity, dataBits, stopBits);
                serialPort.ReadTimeout = <span class="hljs-number">1000</span>;
                serialPort.WriteTimeout = <span class="hljs-number">1000</span>;
                serialPort.DataReceived += OnDataReceived;
                serialPort.Open();
                Console.WriteLine(<span class="hljs-string">$"串口 <span class="hljs-subst">{portName}</span> 已成功打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"串口初始化失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案1: 基于数据间隔超时判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：不知道数据长度，但设备发送完后会有明显的时间间隔</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithGapTimeout</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
                lastReceiveTime = DateTime.Now;
            }
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-comment">// 发送查询指令</span>
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                DateTime lastCheckTime = DateTime.Now;
                <span class="hljs-built_in">int</span> lastBufferSize = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-comment">// 如果有数据且数据间隔超过指定时间，认为接收完成</span>
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span> &amp;&amp;
                            (DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"基于间隔超时判断接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                    }
                }
                <span class="hljs-comment">// 最大等待时间超时</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"最大等待时间超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                Console.WriteLine(<span class="hljs-string">"接收超时，未收到任何数据"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案2: 基于结束符判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：数据以特定字符或字节序列结尾</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithEndMarker</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span>[] endMarker, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= endMarker.Length)
                        {
                            <span class="hljs-comment">// 检查缓冲区末尾是否包含结束标记</span>
                            <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                            {
                                <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                                {
                                    foundEndMarker = <span class="hljs-literal">false</span>;
                                    <span class="hljs-keyword">break</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (foundEndMarker)
                            {
                                isWaitingForResponse = <span class="hljs-literal">false</span>;
                                <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                                Console.WriteLine(<span class="hljs-string">$"发现结束标记，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                <span class="hljs-keyword">return</span> result;
                            }
                        }
                    }
                }
                <span class="hljs-comment">// 超时处理</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"等待结束标记超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案3: 基于协议帧结构判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：数据有固定的帧头和长度字段</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithFrameProtocol</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span> frameHeader, <span class="hljs-built_in">int</span> lengthFieldOffset,
            <span class="hljs-built_in">int</span> lengthFieldSize = <span class="hljs-number">1</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; lengthFieldOffset + lengthFieldSize)
                        {
                            <span class="hljs-comment">// 检查帧头</span>
                            <span class="hljs-keyword">if</span> (receivedBuffer[<span class="hljs-number">0</span>] == frameHeader)
                            {
                                <span class="hljs-comment">// 获取数据长度</span>
                                <span class="hljs-built_in">int</span> dataLength = <span class="hljs-number">0</span>;
                                <span class="hljs-keyword">if</span> (lengthFieldSize == <span class="hljs-number">1</span>)
                                {
                                    dataLength = receivedBuffer[lengthFieldOffset];
                                }
                                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lengthFieldSize == <span class="hljs-number">2</span>)
                                {
                                    dataLength = (receivedBuffer[lengthFieldOffset] &lt;&lt; <span class="hljs-number">8</span>) | receivedBuffer[lengthFieldOffset + <span class="hljs-number">1</span>];
                                }
                                <span class="hljs-built_in">int</span> expectedFrameLength = lengthFieldOffset + lengthFieldSize + dataLength;
                                <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= expectedFrameLength)
                                {
                                    isWaitingForResponse = <span class="hljs-literal">false</span>;
                                    <span class="hljs-built_in">byte</span>[] result = receivedBuffer.Take(expectedFrameLength).ToArray();
                                    Console.WriteLine(<span class="hljs-string">$"根据帧长度判断接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                    <span class="hljs-keyword">return</span> result;
                                }
                            }
                        }
                    }
                }
                <span class="hljs-comment">// 超时处理</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"帧协议解析超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案4: 组合策略 - 最灵活的方案</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 同时使用多种判断条件，任一条件满足就结束接收</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithCombinedStrategy</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command,
            <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>,
            <span class="hljs-built_in">byte</span>[] endMarker = <span class="hljs-literal">null</span>,
            <span class="hljs-built_in">int</span>? maxLength = <span class="hljs-literal">null</span>,
            <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
                lastReceiveTime = DateTime.Now;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
                        <span class="hljs-comment">// 条件1: 检查最大长度限制</span>
                        <span class="hljs-keyword">if</span> (maxLength.HasValue &amp;&amp; receivedBuffer.Count &gt;= maxLength.Value)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"达到最大长度限制，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                        <span class="hljs-comment">// 条件2: 检查结束标记</span>
                        <span class="hljs-keyword">if</span> (endMarker != <span class="hljs-literal">null</span> &amp;&amp; receivedBuffer.Count &gt;= endMarker.Length)
                        {
                            <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                            {
                                <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                                {
                                    foundEndMarker = <span class="hljs-literal">false</span>;
                                    <span class="hljs-keyword">break</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (foundEndMarker)
                            {
                                isWaitingForResponse = <span class="hljs-literal">false</span>;
                                <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                                Console.WriteLine(<span class="hljs-string">$"发现结束标记，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                <span class="hljs-keyword">return</span> result;
                            }
                        }
                        <span class="hljs-comment">// 条件3: 检查数据间隔超时</span>
                        <span class="hljs-keyword">if</span> ((DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"数据间隔超时，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                    }
                }
                <span class="hljs-comment">// 最大等待时间超时</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"最大等待时间超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 数据接收事件处理</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDataReceived</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, SerialDataReceivedEventArgs e</span>)</span>
        {
            <span class="hljs-keyword">if</span> (!isWaitingForResponse) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-built_in">int</span> bytesToRead = serialPort.BytesToRead;
                <span class="hljs-keyword">if</span> (bytesToRead &gt; <span class="hljs-number">0</span>)
                {
                    <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bytesToRead];
                    <span class="hljs-built_in">int</span> bytesRead = serialPort.Read(buffer, <span class="hljs-number">0</span>, bytesToRead);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        receivedBuffer.AddRange(buffer);
                        lastReceiveTime = DateTime.Now; <span class="hljs-comment">// 更新最后接收时间</span>
                        Console.WriteLine(<span class="hljs-string">$"收到数据包 (<span class="hljs-subst">{bytesRead}</span> 字节): <span class="hljs-subst">{BitConverter.ToString(buffer, <span class="hljs-number">0</span>, bytesRead)}</span>"</span>);
                        Console.WriteLine(<span class="hljs-string">$"当前缓冲区总计: <span class="hljs-subst">{receivedBuffer.Count}</span> 字节"</span>);
                    }
                }
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"数据接收处理异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 关闭串口</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span>
        {
            <span class="hljs-keyword">try</span>
            {
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> (serialPort != <span class="hljs-literal">null</span> &amp;&amp; serialPort.IsOpen)
                {
                    serialPort.Close();
                    Console.WriteLine(<span class="hljs-string">"串口已关闭"</span>);
                }
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"关闭串口异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span>[] <span class="hljs-title">GetAvailablePorts</span>()</span>
        {
            <span class="hljs-keyword">return</span> SerialPort.GetPortNames();
        }
    }
}
</code></pre>
<h3 data-id="heading-11">完整代码</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AppFlexSerialPort</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            FlexibleSerialPort comm = <span class="hljs-keyword">new</span> FlexibleSerialPort();
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-keyword">if</span> (comm.InitializePort(<span class="hljs-string">"COM1"</span>, <span class="hljs-number">9600</span>))
                {
                    <span class="hljs-built_in">byte</span>[] queryCommand = { <span class="hljs-number">0x01</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0x0A</span> };
                    Console.WriteLine(<span class="hljs-string">"=== 方案1: 基于数据间隔判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response1 = comm.SendQueryWithGapTimeout(queryCommand, <span class="hljs-number">150</span>, <span class="hljs-number">3000</span>);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案2: 基于结束符判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] endMarker = { <span class="hljs-number">0x0D</span>, <span class="hljs-number">0x0A</span> }; <span class="hljs-comment">// CR LF</span>
                    <span class="hljs-built_in">byte</span>[] response2 = comm.SendQueryWithEndMarker(queryCommand, endMarker);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案3: 基于协议帧结构判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response3 = comm.SendQueryWithFrameProtocol(queryCommand, <span class="hljs-number">0x01</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案4: 组合策略 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response4 = comm.SendQueryWithCombinedStrategy(
                        queryCommand,
                        gapTimeoutMs: <span class="hljs-number">100</span>,           <span class="hljs-comment">// 数据间隔100ms</span>
                        endMarker: <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[] { <span class="hljs-number">0x0A</span> }, <span class="hljs-comment">// 或者以LF结尾</span>
                        maxLength: <span class="hljs-number">50</span>,               <span class="hljs-comment">// 或者最多50字节</span>
                        maxWaitMs: <span class="hljs-number">3000</span>              <span class="hljs-comment">// 最多等待3秒</span>
                    );
                }
                Console.WriteLine(<span class="hljs-string">"按任意键退出..."</span>);
                Console.ReadKey();
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"程序异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
            <span class="hljs-keyword">finally</span>
            {
                comm.Close();
            }
        }
    }
}
</code></pre>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/D1DJjmDXQdnFmJFU5J5rlfxb5AhPOUuHwlNHbtd3ficlnibmicicobrAiba2qciaD3dwekVo4FZNsq0GREL2dfia4lRsQ/640?wx_fmt=png&amp;from=appmsg" alt="" title="null" loading="lazy"/></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/D1DJjmDXQdnFmJFU5J5rlfxb5AhPOUuHMsvyqeGaTfgknLgoDprObt1cODjBMggygP1yTC9ylaRK5etf3FO6qQ/640?wx_fmt=png&amp;from=appmsg" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">性能优化与实践</h3>
<h4 data-id="heading-13">关键参数调优</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ✅ 推荐配置</span>
<span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>;    <span class="hljs-comment">// 100-200ms适合大多数设备</span>
<span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span>;      <span class="hljs-comment">// 总超时3秒，避免程序卡死</span>
Thread.Sleep(<span class="hljs-number">10</span>);          <span class="hljs-comment">// 轮询间隔10ms，平衡CPU占用和响应速度</span>
</code></pre>
<h4 data-id="heading-14">线程安全保障</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> bufferLock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
<span class="hljs-comment">// 所有缓冲区操作都要加锁</span>
<span class="hljs-keyword">lock</span> (bufferLock)
{
    receivedBuffer.Clear();
    receivedBuffer.AddRange(buffer);
    <span class="hljs-comment">// ... 其他缓冲区操作</span>
}
</code></pre>
<h4 data-id="heading-15">常见提醒</h4>
<p>1、忘记清空缓冲区：每次查询前必须 <code>receivedBuffer.Clear()</code></p>
<p>2、超时时间设置不当：间隔超时太短会截断数据，太长会影响响应速度</p>
<p>3、线程安全问题：<code>DataReceived</code> 事件在不同线程中执行，必须加锁保护</p>
<p>4、资源释放：程序结束前记得调用 <code>Close()</code> 方法</p>
<h3 data-id="heading-16">适用场景对比</h3>



































<table><thead><tr><th align="left">方案</th><th align="left">适用场景</th><th align="left">优点</th><th align="left">缺点</th></tr></thead><tbody><tr><td align="left">间隔超时</td><td align="left">通用场景</td><td align="left">简单可靠</td><td align="left">需要调试最佳间隔时间</td></tr><tr><td align="left">结束符判断</td><td align="left">文本协议</td><td align="left">精确判断</td><td align="left">需要明确的结束符</td></tr><tr><td align="left">帧结构判断</td><td align="left">二进制协议</td><td align="left">最精确</td><td align="left">需要了解协议细节</td></tr><tr><td align="left">组合策略</td><td align="left">复杂场景</td><td align="left">最灵活</td><td align="left">代码稍复杂</td></tr></tbody></table>
<h3 data-id="heading-17">总结</h3>
<p>1、选择合适的策略：对于90%的场景，<strong>数据间隔超时判断</strong>就足够了</p>
<p>2、参数调优很重要：100-200ms 的间隔超时是经验值，需要根据实际设备调整</p>
<p>3、组合策略是王道：当单一策略无法满足需求时，组合策略提供了最大的灵活性</p>
<p>通过本文介绍的四种策略，开发者可以根据具体通信协议灵活选择最适合的接收方式，彻底告别"分包接收"带来的困扰。</p>
<h3 data-id="heading-18">关键词</h3>
<p>串口通信、分包接收、C#、SerialPort、数据间隔超时、结束符判断、协议帧结构、组合策略、线程安全、工业控制</p>
<h3 data-id="heading-19">最后</h3>
<p>如果你觉得这篇文章对你有帮助，不妨点个赞支持一下！你的支持是我继续分享知识的动力。如果有任何疑问或需要进一步的帮助，欢迎随时留言。</p>
<p>也可以加入微信公众号 <strong>[DotNet技术匠]</strong> 社区，与其他热爱技术的同行一起交流心得，共同成长！</p>
<p><strong>优秀是一种习惯，欢迎大家留言学习！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解构内存迷宫：串联虚拟地址、页表与内存使用（一）]]></title>    <link>https://juejin.cn/post/7590705425134305289</link>    <guid>https://juejin.cn/post/7590705425134305289</guid>    <pubDate>2026-01-03T12:48:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590705425134305289" data-draft-id="7590608345923239962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解构内存迷宫：串联虚拟地址、页表与内存使用（一）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T12:48:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解构内存迷宫：串联虚拟地址、页表与内存使用（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:48:55.000Z" title="Sat Jan 03 2026 12:48:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">介绍</h4>
<p>说到内存，读者之前可能听说过很多概念，比如虚拟地址，虚拟内存，页表，内核，物理内存管理等，各个概念可能听上去都知道，但是却很少有文章将这些内存相关的概念串联起来，这篇文章就是通过几个使用场景将这些概念串联起来，让读者能更清楚的了解这些概念的同时，对内存使用的流程有个整体上的了解。 让我们开始吧，一起去探索 程序的一页数据是如何在计算机内存中“安家落户”的。</p>
<h4 data-id="heading-1">物理内存和物理地址</h4>
<p>我们先从物理内存说起，他是一个物理介质，在通电的情况下可以存储数据，而物理地址就是内存的一个坐标，我们可以通过提供一个物理地址和一个长度来读取内存上对应区域存储的数据。 我们程序在运行时，就经常需要使用内存来写入和读取数据，比如a=0 就是把a变量映射成了一个物理地址，然后在物理地址对应的内存区域上写上0，这样在读取a这个变量时，就可以通过a的物理地址从内存中找到0这个数据，就读取到了变量的值。</p>
<p>这个是理想情况，但是实际上操作系统并不会像是这样直接使用物理地址，而是<strong>使用一个称为虚拟地址的方式存储变量的地址，然后要访问变量值时，使用这个虚拟地址，加上一个称为页表的映射结构，转换成物理地址</strong>，然后再到对应的内存区域中获取变量的值。</p>
<h6 data-id="heading-2">使用物理地址的问题</h6>
<p>为什么要特意加上这个转换逻辑呢，直接使用物理地址存储不行么？ 其实早期是有直接使用物理内存存储数据的机器的，但是他有几个问题：</p>
<ol>
<li>安全问题：进程没有隔离，系统安全性大为下降，因为所有进程使用一个相同的“地址空间”，有可能恶意进程会访问不属于他的物理地址，造成权限问题，或者不小心覆盖了不属于他的数据，甚至是操作系统数据。</li>
<li>内存碎片问题：比如一个进程申请100M的空间，用完后释放了，但是这块内存地址的前后内存块都被使用了，这时候有个进程申请120M的连续内存，这100M就无法被使用，因为他前后的内存已经被占用了，这就造成操作系统上有很多内存空洞，空闲的内存总量是够用的，但是无法分配一个较大的连续内存，这就是内存碎片。</li>
<li>易用性问题：编程与管理的复杂度高，因为程序员或者编译器必须自己管理物理内存，每次程序启动的变量内存地址都不一样，很容易出错。</li>
<li>灵活性问题：内存共享与稀疏存储，很难实现内存共享，比如很多程序都需要用到标准库（如libc），使用物理内存的话，只能每个进程都在物理内存中保留一份，造成浪费。</li>
</ol>
<h4 data-id="heading-3">虚拟地址和页表</h4>
<p>那么，虚拟地址和页表是如何解决这些问题的呢？首先介绍下这两个概念，<strong>虚拟地址是每个进程都拥有的，从0开始的连续的内存地址空间</strong>，之所以称为虚拟，是因为程序使用这个地址访问时，并不是访问这个地址对应的物理内存。而页表，则是将虚拟地址映射成一个物理地址的数据结构。 <strong>需要注意的是，页表是一个数据结构，因此页表也是需要存在物理内存上的，会占用一定内存空间</strong>，你可以理解为类似一个java中的map，输入虚拟地址a，通过查询页表，可以一步一步找到a对应的物理地址b。</p>
<p>还有一个需要说明的是<strong>页</strong>这个概念，操作系统是将内存以4k大小为一个最小分配单位，每次进程申请内存时，就会分配多个4k大小的空闲内存页给进程。比如进程申请15k的内存，操作系统就会给他分配4个4k的内存块，然后在页表中增加四个页表项，将4个内存块的虚拟地址映射到实际的物理内存地址。页表页表，顾名思义，就是页的映射表。</p>
<h6 data-id="heading-4">虚拟地址的使用</h6>
<p>有了虚拟地址后，<strong>操作系统只会让程序使用虚拟地址，他会在进程启动时为每个进程生成一个独立的页表</strong>，之后不管程序访问什么地址，操作系统都会把这个地址当成虚拟地址，通过程序的页表进行转换成物理地址，然后再进行访问。</p>
<p>举个例子，比如进程访问一个地址为a的虚拟地址，操作系统并不会去访问b这个物理内存地址，而是会去查询页表，找到对应的物理内存b，然后访问b地址中的内存的数据。而且这个b地址不是固定的，他是随机的，是在程序申请a地址的内存时，操作系统取查找空闲的内存页，然后配置到页表上的。</p>
<h6 data-id="heading-5">虚拟地址和页表的好处</h6>
<p>使用虚拟地址和页表为什么能解决上述问题呢？</p>
<ol>
<li>安全问题：使用虚拟地址后，每个程序访问的地址都被当做虚拟地址处理，然后通过页表转换成物理地址，而页表的数据只有操作系统能管理，这样只要操作系统做好内存管理，不要把同一块空闲内存分配个多个进程，就能确保进程之间的隔离性，即使恶意进程想要访问一个别的进程使用的物理地址，他的访问地址也会被当做虚拟地址处理，访问到分配给他的一个他自己的空闲内存上。</li>
<li>内存碎片问题：在虚拟地址空间中，进程以为自己拥有一段非常长的连续内存，比如他认为自己有1G的连续空间，但是实际上，操作系统通过页表将这1G空间映射到物理内存中分散的内存块上，这样就能通过复用小块内存避免内存碎片问题，因为任何空闲的物理页都能被利用，大大提高了内存利用率</li>
<li>易用性问题：每个进程都从固定的地址（如0x400000）开始加载代码。链接器和编译器可以提前确定很多地址，编程模型简单统一。</li>
<li>灵活性问题：共享内存实现起来很简单，比如对于一些标准库，操作系统可以将其在内存中存储一份，然后在启动程序时，如果他们需要标准库的代码，就可以在进程启动时，让操作系统将不同进程的存储标准库代码的虚拟地址页表项映射到同一个物理页，这样，系统的动态链接库只需要在物理内存中保存一份，所有进程共享，节省大量内存。</li>
</ol>
<h4 data-id="heading-6">多级页表</h4>
<p>之前介绍了使用页表的原因，但是如果页表的实现只是单纯的将一个虚拟地址映射到另外一个物理地址，这也是有问题的，这种方式被称为单级页表，相当于每个虚拟地址是页表这个map的key，它对应的物理地址，也就是value可以不存在，但是每个key必须存在，所以操作系统必须为每一个虚拟地址生成一个页表项，这就会导致一个程序的页表项太多。之前说过，页表是个数据结构，他本身也是占用一定内存大小的，页表项太多的话就会占用较大内存。</p>
<p>这里有个地方需要注意下，因为linux系统是以4k为最小的内存分配单位，因此单级页表中的每个页表项指向的也是一个4k的内存，所以<strong>一个单级页表的总项目数量是 最大物理内存大小(字节) / (4*1024) 字节，比所有地址的数量要少</strong> 。两个连续的页表项之间相隔4kb，不是每个字节都有对应的页表项，访问时找的是根据虚拟地址计算出的他所属于的那个页的虚拟地址。</p>
<h6 data-id="heading-7">单级页表占用的内存</h6>
<p>假设使用的是一个32位的操作系统：</p>
<ol>
<li>一个进程的虚拟地址共有2^32=4G，这也是操作系统的最大内存。</li>
<li>换算成KB是： 4 GB = 4 × 1024 × 1024 KB = 4,194,304 KB</li>
<li>而一个系统的页大小是4KB，为了存储一个进程的所有虚拟地址，需要 4,194,304/4 = 1,048,576 个页表项。</li>
<li>每个页表项占用4字节，则 共需要 1,048,576*4/1024/1024=4M 的空间。</li>
<li>如果启动100个进程，别的内存不算，页表占用的内存就达到了4*100 = 400M,占了系统内存的10%，</li>
</ol>
<p>通过计算可以看出，单级页表造成了极大浪费，因为一般情况下进程不会使用到页表中大部分的虚拟地址空间。更糟糕的是，这4MB的页表必须是连续的物理内存，随着系统运行，分配一块连续的4MB内存会变得非常困难。</p>
<h6 data-id="heading-8">多级页表的优势</h6>
<p>那么使用多级页表是怎么解决这个问题的呢？首先介绍下多级页表，顾名思义，他就是采用了多个层级，当寻找一个虚拟地址对应的物理地址时，需要一级一级的查找，经过多次映射后才能找到对应的物理地址。就比如字典，查找一个字时，先找首字母，这个首字母就是顶级页表，找到后在字母中再根据拼音顺序找对应汉字，这个就是第二级，最后再是根据找到的页数，去对应页数找到汉字，这个就是通过三级页表找到了物理地址。</p>
<p>linux系统中一般默认使用四级页表，为了简化，我们假设使用二级列表来看下他是怎么节约内存的，以32位系统为例：</p>
<ol>
<li>我们将地址分为 10位（第1级索引） + 10位（第2级索引） + 12位（页内偏移）</li>
<li>前10位就是顶级页表，一共用了 2^10 = 1024 个条目</li>
<li>顶级页表的大小 = 1024 * 4字节 = 4KB（正好一页）。</li>
</ol>
<p>顶级页表是必须有的，但是二级列表可以等使用到内存时再分配，因此在一个程序启动时，只需要用到4k的页表项，这就比之前的4M要小的多了。</p>
<h6 data-id="heading-9">多级页表和单级页表的区别</h6>
<p>有人可能会问，为什么多级页表不需要提前存储后面几个层级的页表，而单级页表却需要存储所有页表项呢？因为单级页表是直接索引，虚拟地址直接作为索引，去一个巨大的、连续的数组中查找，为了能够通过索引直接定位，这个数组必须完整存在，所以单级页表不能缺少页表项。</p>
<p>而多级页表是间接索引，只要确保第一级存在，第二级可以在你需要用到时才去加载，这是一种“懒加载”策略。</p>
<p>举个例子，比如现在多级页表只有顶级页表，你需要存储一个数据时，输入指定虚拟地址去存数据，操作系统根据虚拟地址去顶级页表这个目录找到地址对应的二级页表地址时，发现二级页表的地址不存在，此时他就可以分配内存，生成需要访问的虚拟地址所在的二级页表的数据，即一个10位的二级页表，此时只是多了一个二级页表，即2^10* 4字节 = 4KB大小。</p>
<h4 data-id="heading-10">结语</h4>
<p>好了，先介绍到这里，本片文章主要讲解了虚拟地址和页表相关内容，后续内容在下一篇文章中呈现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战]]></title>    <link>https://juejin.cn/post/7590699877630574630</link>    <guid>https://juejin.cn/post/7590699877630574630</guid>    <pubDate>2026-01-03T13:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590699877630574630" data-draft-id="7590601860300587035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T13:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:13:02.000Z" title="Sat Jan 03 2026 13:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 应用中，<strong>登录验证</strong>是保障系统安全的第一道防线 —— 只有通过身份认证的用户，才能访问系统的核心资源（如员工管理、部门数据、个人中心等）。实现登录验证的核心技术包括 “会话管理” 和 “请求拦截”，从传统的 Session-Cookie，到如今流行的 JWT 令牌，再配合过滤器（Filter）与拦截器（Interceptor）实现全局校验，形成了一套完整的登录验证体系。本文将以 “后台管理系统” 为场景，全面讲解登录验证的实现思路、核心技术及实战落地。</p>
<h2 data-id="heading-0">一、登录验证的核心诉求：为什么需要它？</h2>
<p>想象一个没有登录验证的后台系统：任何人都可以直接访问<code>/emp/list</code>（员工列表）、<code>/dept/delete</code>（删除部门）等核心接口，这会导致数据泄露、恶意篡改等严重安全问题。</p>
<p>登录验证的核心诉求有 3 点：</p>
<ol>
<li><strong>身份认证</strong>：验证用户输入的账号密码是否正确，确认用户身份合法性；</li>
<li><strong>身份保持</strong>：用户登录成功后，在一段时间内无需重复登录，可正常访问系统资源（会话技术实现）；</li>
<li><strong>权限控制</strong>：拦截未登录用户的非法请求，拒绝其访问受保护资源（过滤器 / 拦截器实现）。</li>
</ol>
<h2 data-id="heading-1">二、会话技术：实现用户身份保持</h2>
<p>用户登录成功后，如何让系统 “记住” 用户身份？这就需要<strong>会话技术</strong>，主流方案分为两类：传统的<code>Session-Cookie</code>和现代的<code>JWT</code>（Json Web Token）。</p>
<h4 data-id="heading-2">1. 传统方案：Session-Cookie 会话管理</h4>
<h5 data-id="heading-3">核心原理</h5>
<p><code>Session-Cookie</code>是基于服务器端存储的会话方案，核心流程如下：</p>
<ol>
<li>用户提交账号密码登录，服务器验证通过后，创建<code>HttpSession</code>对象（存储用户信息，如用户 ID、用户名），并生成唯一的<code>SessionId</code>；</li>
<li>服务器将<code>SessionId</code>通过<code>Set-Cookie</code>响应头写入客户端浏览器；</li>
<li>客户端后续发起请求时，浏览器会自动携带该<code>Cookie</code>（包含<code>SessionId</code>）到服务器；</li>
<li>服务器通过<code>SessionId</code>查找对应的<code>HttpSession</code>对象，确认用户身份，实现 “免登录” 访问。</li>
</ol>
<h5 data-id="heading-4">实战演示（Java Web）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 登录接口：验证账号密码，创建Session</span>
<span class="hljs-meta">@WebServlet("/login")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        req.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取前端提交的账号密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"username"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"password"</span>);

        <span class="hljs-comment">// 模拟账号密码验证（实际需查询数据库）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"admin"</span>.equals(username) &amp;&amp; <span class="hljs-string">"123456"</span>.equals(password)) {
            <span class="hljs-comment">// 登录成功：创建Session，存储用户信息</span>
            <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> req.getSession();
            session.setAttribute(<span class="hljs-string">"loginUser"</span>, username); <span class="hljs-comment">// 存储用户名</span>
            session.setMaxInactiveInterval(<span class="hljs-number">3600</span>); <span class="hljs-comment">// 设置Session过期时间：1小时（无操作超时）</span>

            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>msg<span class="hljs-string">":"</span>登录成功<span class="hljs-string">"}"</span>);
        } <span class="hljs-keyword">else</span> {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":500,"</span>msg<span class="hljs-string">":"</span>账号或密码错误<span class="hljs-string">"}"</span>);
        }
    }
}

<span class="hljs-comment">// 2. 核心资源接口：通过Session验证用户身份</span>
<span class="hljs-meta">@WebServlet("/emp/list")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmpListServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取Session中的用户信息</span>
        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> req.getSession(<span class="hljs-literal">false</span>); <span class="hljs-comment">// false：不存在则返回null，不创建新Session</span>
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span> || session.getAttribute(<span class="hljs-string">"loginUser"</span>) == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 未登录：返回未授权提示</span>
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>请先登录<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 已登录：返回员工列表数据</span>
        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>data<span class="hljs-string">":[{"</span>id<span class="hljs-string">":1,"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">"},{"</span>id<span class="hljs-string">":2,"</span>name<span class="hljs-string">":"</span>李四<span class="hljs-string">"}]}"</span>);
    }
}
</code></pre>
<h5 data-id="heading-5">Session-Cookie 的优缺点</h5>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>安全性较高（用户信息存储在服务器端，不易被篡改）</td><td>服务器压力大（大量 Session 存储在服务器内存 / 缓存中，高并发场景不友好）</td></tr><tr><td>支持会话失效手动控制（如用户退出登录，直接销毁 Session）</td><td>不支持跨域（Cookie 默认不允许跨域携带，需额外配置）</td></tr><tr><td>实现简单，无需额外依赖</td><td>不支持分布式部署（Session 存储在单个服务器，集群环境下需做 Session 共享）</td></tr></tbody></table>
<h4 data-id="heading-6">2. 现代方案：JWT 令牌认证</h4>
<h5 data-id="heading-7">核心原理</h5>
<p>JWT（Json Web Token）是一种基于<strong>客户端存储</strong>的无状态令牌方案，无需服务器存储会话信息，核心流程如下：</p>
<ol>
<li>用户提交账号密码登录，服务器验证通过后，根据用户信息（如用户 ID、用户名）和密钥，生成 JWT 令牌（包含头部、载荷、签名三部分）；</li>
<li>服务器将 JWT 令牌返回给客户端（客户端可存储在 LocalStorage/SessionStorage/Cookie 中）；</li>
<li>客户端后续发起请求时，通过请求头（如<code>Authorization: Bearer &lt;JWT令牌&gt;</code>）携带令牌到服务器；</li>
<li>服务器接收令牌后，通过密钥验证令牌的合法性（是否过期、是否被篡改），验证通过则确认用户身份。</li>
</ol>
<h5 data-id="heading-8">JWT 令牌结构</h5>
<p>JWT 令牌是一个字符串，由三部分组成，用<code>.</code>分隔：</p>
<ol>
<li>
<p><strong>Header（头部）</strong> ：指定令牌类型（JWT）和加密算法（如 HS256），示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"alg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HS256"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"typ"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"JWT"</span><span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Payload（载荷）</strong> ：存储用户自定义信息（如用户 ID、用户名）和过期时间等元数据，示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1735689600</span><span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Signature（签名）</strong> ：服务器用头部指定的加密算法，将头部、载荷和密钥进行加密生成的签名，用于验证令牌是否被篡改。</p>
</li>
</ol>
<h5 data-id="heading-9">实战演示（Java + JJWT 依赖）</h5>
<h6 data-id="heading-10">（1）引入 JJWT 依赖（Maven）</h6>
<p>JJWT 是 Java 生态中常用的 JWT 工具库，简化 JWT 的生成与验证：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h6 data-id="heading-11">（2）JWT 工具类</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Jwts;
<span class="hljs-keyword">import</span> io.jsonwebtoken.security.Keys;
<span class="hljs-keyword">import</span> javax.crypto.SecretKey;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtils</span> {
    <span class="hljs-comment">// 密钥（生产环境需配置在配置文件中，且保证安全性）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECRET_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"my-secret-key-32bytes-long-12345678"</span>;
    <span class="hljs-comment">// 令牌过期时间：1小时（单位：毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span> * <span class="hljs-number">1000L</span>;

    <span class="hljs-comment">// 生成JWT令牌</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 创建密钥（HS256算法要求密钥长度至少32位）</span>
        <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Keys.hmacShaKeyFor(SECRET_KEY.getBytes());
        <span class="hljs-comment">// 构建并生成令牌</span>
        <span class="hljs-keyword">return</span> Jwts.builder()
                .setSubject(username) <span class="hljs-comment">// 设置主题（存储用户名）</span>
                .setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) <span class="hljs-comment">// 设置签发时间</span>
                .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + EXPIRE_TIME)) <span class="hljs-comment">// 设置过期时间</span>
                .signWith(key) <span class="hljs-comment">// 使用密钥签名</span>
                .compact();
    }

    <span class="hljs-comment">// 验证JWT令牌合法性，并获取令牌中的用户信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Claims <span class="hljs-title function_">verifyToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Keys.hmacShaKeyFor(SECRET_KEY.getBytes());
            <span class="hljs-comment">// 验证令牌并解析载荷</span>
            <span class="hljs-keyword">return</span> Jwts.parserBuilder()
                    .setSigningKey(key)
                    .build()
                    .parseClaimsJws(token)
                    .getBody();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 令牌无效（过期、被篡改等），返回null</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// 从令牌中获取用户名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUsernameFromToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> verifyToken(token);
        <span class="hljs-keyword">return</span> claims == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : claims.getSubject();
    }
}
</code></pre>
<h6 data-id="heading-12">（3）JWT 登录与验证接口</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@WebServlet("/jwt/login")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtLoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        req.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"username"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"password"</span>);

        <span class="hljs-comment">// 模拟账号密码验证</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"admin"</span>.equals(username) &amp;&amp; <span class="hljs-string">"123456"</span>.equals(password)) {
            <span class="hljs-comment">// 生成JWT令牌</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtUtil.generateToken(username);
            <span class="hljs-comment">// 返回令牌给客户端</span>
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>msg<span class="hljs-string">":"</span>登录成功<span class="hljs-string">","</span>data<span class="hljs-string">":"</span><span class="hljs-string">" + token + "</span><span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":500,"</span>msg<span class="hljs-string">":"</span>账号或密码错误<span class="hljs-string">"}"</span>);
    }
}

<span class="hljs-meta">@WebServlet("/jwt/emp/list")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtEmpListServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取请求头中的JWT令牌</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">authorization</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (authorization == <span class="hljs-literal">null</span> || !authorization.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>请先登录<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 提取令牌（去除"Bearer "前缀）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authorization.substring(<span class="hljs-number">7</span>);
        <span class="hljs-comment">// 验证令牌并获取用户名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> JwtUtil.getUsernameFromToken(token);
        <span class="hljs-keyword">if</span> (username == <span class="hljs-literal">null</span>) {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>令牌无效或已过期<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 令牌有效：返回员工列表</span>
        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>data<span class="hljs-string">":[{"</span>id<span class="hljs-string">":1,"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">"},{"</span>id<span class="hljs-string">":2,"</span>name<span class="hljs-string">":"</span>李四<span class="hljs-string">"}]}"</span>);
    }
}
</code></pre>
<h5 data-id="heading-13">JWT 的优缺点</h5>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>无状态（服务器无需存储会话信息，降低服务器压力）</td><td>安全性较低（令牌存储在客户端，若泄露可能被恶意使用，需配合 HTTPS）</td></tr><tr><td>支持跨域（令牌通过请求头携带，不受跨域限制）</td><td>令牌一旦生成，无法主动作废（除非设置短期过期，或维护黑名单）</td></tr><tr><td>支持分布式部署（任意服务器均可通过密钥验证令牌，无需 Session 共享）</td><td>载荷部分 Base64 编码（非加密），敏感信息不可直接存储</td></tr></tbody></table>
<h2 data-id="heading-14">三、请求拦截：实现全局登录验证</h2>
<p>无论是 Session-Cookie 还是 JWT，若每个接口都单独编写身份验证逻辑，会造成代码冗余。此时需要 <strong>过滤器（Filter）</strong> 和 <strong>拦截器（Interceptor）</strong> 实现全局请求拦截，统一处理登录验证。</p>
<h4 data-id="heading-15">1. 过滤器（Filter）：Servlet 规范中的全局拦截</h4>
<p>Filter 是 Java Servlet 规范定义的组件，运行在 Servlet 之前，可对请求和响应进行统一拦截处理，支持对所有 Web 资源（Servlet、JSP、静态资源）进行过滤。</p>
<h5 data-id="heading-16">实战演示：JWT 全局验证过滤器</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.filters;

<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> com.tgt.utils.JwtUtils;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> jakarta.servlet.*;
<span class="hljs-keyword">import</span> jakarta.servlet.annotation.WebFilter;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@WebFilter("/*")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        <span class="hljs-comment">//1.获取请求url。</span>
        <span class="hljs-comment">// servletRequest.getRequestURI() 这个api是子接口HttpServletRequest才有</span>
        <span class="hljs-comment">// 将父接口 ServletRequest 转换为 子接口HttpServletRequest</span>
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;
        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (HttpServletResponse) servletResponse;
        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();

        <span class="hljs-comment">//2.判断请求url中是否包含login，</span>
        <span class="hljs-keyword">if</span> (uri.contains(<span class="hljs-string">"/login"</span>)){
            <span class="hljs-comment">//如果包含，说明是登录操作，放行。</span>
            filterChain.doFilter(request,response);

            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//3.获取请求头中的令牌（token）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"token"</span>);

        <span class="hljs-comment">//4.判断令牌是否存在，如果不存在，响应401。</span>
        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(token)){
            response.setStatus(<span class="hljs-number">401</span>);

            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//5.解析token，如果解析失败，响应401</span>
            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtils.parseJWT(token);<span class="hljs-comment">//如果篡改或过期会发生异常</span>
            
            <span class="hljs-comment">//6.放行。</span>
            filterChain.doFilter(request,response);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"登录校验失败，解析token失败："</span>,e);

            <span class="hljs-comment">//解析token失败 返回401</span>
            response.setStatus(<span class="hljs-number">401</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-17">2. 拦截器（Interceptor）：Spring 框架中的全局拦截</h4>
<p>Interceptor 是 Spring MVC 框架提供的组件，运行在 Controller 方法执行前后，仅对 Controller 请求进行拦截，功能更灵活（支持 Spring 容器管理，可注入 Service 等 Bean）。</p>
<h5 data-id="heading-18">实战演示：Spring MVC JWT 拦截器</h5>
<h6 data-id="heading-19">（1）编写 JWT 拦截器</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> com.tgt.utils.JwtUtils;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptors</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-comment">//3.获取请求头中的令牌（token）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"token"</span>);

        <span class="hljs-comment">//4.判断令牌是否存在，如果不存在，响应401。</span>
        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(token)){
            response.setStatus(<span class="hljs-number">401</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//5.解析token，如果解析失败，响应401</span>
            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtils.parseJWT(token);<span class="hljs-comment">//如果篡改或过期会发生异常</span>

            <span class="hljs-type">Integer</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> Integer.valueOf(claims.get(<span class="hljs-string">"empId"</span>).toString());

            log.info(<span class="hljs-string">"登录成功，用户id为：{}"</span>,empId);

            <span class="hljs-comment">//6.放行。</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"登录校验失败，解析token失败："</span>,e);

            <span class="hljs-comment">//解析token失败 返回401</span>
            response.setStatus(<span class="hljs-number">401</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h6 data-id="heading-20">（2）配置拦截器（Spring MVC 配置类）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginInterceptors loginInterceptors;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        <span class="hljs-comment">//注册拦截器并绑定拦截路径，注意 是两个*,代表任意路径</span>
        registry.addInterceptor(loginInterceptors)
                .addPathPatterns(<span class="hljs-string">"/**"</span>)
                .excludePathPatterns(<span class="hljs-string">"/login"</span>);
    }
}
</code></pre>
<h4 data-id="heading-21">3. 过滤器 vs 拦截器：核心区别</h4>








































<table><thead><tr><th>对比维度</th><th>过滤器（Filter）</th><th>拦截器（Interceptor）</th></tr></thead><tbody><tr><td>所属规范</td><td>Servlet 规范（Java EE 标准）</td><td>Spring MVC 框架自定义</td></tr><tr><td>拦截范围</td><td>所有 Web 资源（Servlet、JSP、静态资源）</td><td>仅拦截 Controller 请求</td></tr><tr><td>执行时机</td><td>运行在 Servlet 容器层面，早于 Interceptor</td><td>运行在 Spring MVC 层面，晚于 Filter</td></tr><tr><td>依赖容器</td><td>不依赖 Spring 容器，可独立使用</td><td>依赖 Spring 容器，可注入 Bean（Service/Mapper）</td></tr><tr><td>执行次数</td><td>一次请求只执行一次</td><td>若存在视图转发，会执行多次</td></tr><tr><td>功能灵活性</td><td>功能单一，仅支持请求 / 响应拦截</td><td>功能丰富，支持前置拦截、后置处理、视图渲染后处理</td></tr></tbody></table>
<h2 data-id="heading-22">四、完整登录验证流程（实战总结）</h2>
<p>以 “JWT + 拦截器” 为例，完整的登录验证流程如下：</p>
<ol>
<li>
<p><strong>用户登录</strong>：前端提交账号密码到<code>/jwt/login</code>接口，后端验证通过后生成 JWT 令牌，返回给前端；</p>
</li>
<li>
<p><strong>前端存储令牌</strong>：前端将 JWT 令牌存储在 LocalStorage 中；</p>
</li>
<li>
<p><strong>前端发起请求</strong>：前端后续访问核心接口（如<code>/emp/list</code>）时，通过<code>Authorization</code>请求头携带 JWT 令牌；</p>
</li>
<li>
<p><strong>全局拦截验证</strong>：后端拦截器拦截请求，提取并验证 JWT 令牌；</p>
</li>
<li>
<p><strong>请求放行 / 拦截</strong>：</p>
<ul>
<li>令牌有效：放行请求，Controller 处理业务并返回数据；</li>
<li>令牌无效 / 未携带：拦截请求，返回 401 未授权提示，前端跳转至登录页。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-23">五、登录验证最佳实践</h2>
<ol>
<li>
<p><strong>令牌安全存储</strong>：</p>
<ul>
<li>JWT 令牌优先存储在<code>HttpOnly</code> Cookie 中（防止 XSS 攻击），其次存储在 LocalStorage（需做 XSS 防护）；</li>
<li>敏感信息不存储在 JWT 载荷中（载荷仅 Base64 编码，可被解码）。</li>
</ul>
</li>
<li>
<p><strong>设置合理过期时间</strong>：</p>
<ul>
<li>短期令牌：访问令牌（Access Token）过期时间设为 1 小时，减少令牌泄露风险；</li>
<li>长期令牌：刷新令牌（Refresh Token）过期时间设为 7 天，用于过期后重新获取访问令牌，无需用户重复登录。</li>
</ul>
</li>
<li>
<p><strong>HTTPS 传输</strong>：所有请求（尤其是登录请求和携带令牌的请求）使用 HTTPS 协议，防止令牌被中间人劫持。</p>
</li>
<li>
<p><strong>避免匿名访问</strong>：除登录接口、静态资源外，所有核心接口均需拦截验证，禁止匿名访问。</p>
</li>
<li>
<p><strong>令牌黑名单机制</strong>：若用户退出登录（令牌未过期），后端需维护 JWT 黑名单，拦截已注销的令牌。</p>
</li>
</ol>
<h2 data-id="heading-24">六、总结与拓展</h2>
<p>本文全面讲解了登录验证的核心技术，包括 Session-Cookie、JWT 两种会话方案，以及 Filter、Interceptor 两种全局拦截方案，核心要点总结：</p>
<ol>
<li><strong>会话方案选择</strong>：传统单体应用可使用 Session-Cookie，分布式 / 跨域应用优先使用 JWT；</li>
<li><strong>拦截方案选择</strong>：简单场景用 Filter，Spring Boot/Spring MVC 项目优先用 Interceptor（更灵活）；</li>
<li><strong>安全核心</strong>：令牌存储需防 XSS、传输需用 HTTPS、过期时间需合理设置；</li>
<li><strong>代码规范</strong>：全局拦截统一处理登录验证，避免接口内重复编写验证逻辑。</li>
</ol>
<h4 data-id="heading-25">拓展方向：</h4>
<ul>
<li><strong>权限细化</strong>：基于 RBAC 模型（角色 - 权限 - 用户），实现 “基于角色的访问控制”（如管理员可删除部门，普通用户仅可查看）；</li>
<li><strong>单点登录（SSO）</strong> ：基于 JWT 或 CAS 协议，实现多系统统一登录（一次登录，多系统免登）；</li>
<li><strong>令牌刷新机制</strong>：实现 Access Token 过期后，通过 Refresh Token 自动刷新令牌，提升用户体验；</li>
<li><strong>防暴力破解</strong>：登录接口添加验证码、限流机制，防止恶意账号密码爆破。</li>
</ul>
<p>登录验证是 Web 系统安全的基石，掌握本文的核心技术，可搭建一套高效、安全的登录验证体系，为系统的稳定运行提供保障。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ShardingSphere-JDBC 实战指南]]></title>    <link>https://juejin.cn/post/7590433626560266275</link>    <guid>https://juejin.cn/post/7590433626560266275</guid>    <pubDate>2026-01-03T13:36:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560266275" data-draft-id="7590433626560167971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ShardingSphere-JDBC 实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T13:36:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ShardingSphere-JDBC 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:36:21.000Z" title="Sat Jan 03 2026 13:36:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#%E4%B8%80%E5%89%8D%E8%A8%80" title="#%E4%B8%80%E5%89%8D%E8%A8%80">一、前言</a></li>
<li><a href="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AFshardingsphere-jdbc" title="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AFshardingsphere-jdbc">二、什么是ShardingSphere-JDBC</a></li>
<li><a href="#%E4%B8%89%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8" title="#%E4%B8%89%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">三、为什么需要分库分表</a></li>
<li><a href="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">四、核心概念</a></li>
<li><a href="#%E4%BA%94%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B" title="#%E4%BA%94%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">五、快速开始</a></li>
<li><a href="#%E5%85%AD%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3" title="#%E5%85%AD%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3">六、分片策略详解</a></li>
<li><a href="#%E4%B8%83%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" title="#%E4%B8%83%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">七、高级特性</a></li>
<li><a href="#%E5%85%AB%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E5%85%AB%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">八、生产环境最佳实践</a></li>
<li><a href="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">九、常见问题与解决方案</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">一、前言</h2>
<p>随着业务数据量的增长,单库单表逐渐无法满足高并发、大数据量的需求。分库分表成为解决这一问题的有效方案。</p>
<p>ShardingSphere是Apache旗下的开源分布式数据库中间件,本文档基于实际项目,讲解ShardingSphere-JDBC的配置和使用方法。</p>
<hr/>
<h2 data-id="heading-2">二、什么是ShardingSphere-JDBC</h2>
<p>ShardingSphere-JDBC是Apache ShardingSphere的核心产品,定位为轻量级Java框架,在JDBC层提供分库分表服务。</p>
<p><strong>核心特点:</strong></p>
<ul>
<li><strong>透明化</strong> - 对业务代码零侵入,就像使用普通JDBC一样</li>
<li><strong>轻量级</strong> - 无需额外部署,仅作为JDBC驱动存在</li>
<li><strong>配置简单</strong> - 通过YAML配置即可实现分库分表</li>
</ul>
<p><strong>适用场景:</strong></p>
<ul>
<li>需要分库分表的应用</li>
<li>基于MyBatis、JPA等ORM框架的应用</li>
</ul>
<hr/>
<h2 data-id="heading-3">三、为什么需要分库分表</h2>
<h3 data-id="heading-4">3.1 单库单表的瓶颈</h3>
<p>当数据量达到千万级时,会遇到以下问题:</p>
<ol>
<li><strong>性能瓶颈</strong> - 单表数据量大,查询变慢</li>
<li><strong>存储瓶颈</strong> - 磁盘IO成为瓶颈</li>
<li><strong>连接限制</strong> - 数据库连接数不足</li>
</ol>
<h3 data-id="heading-5">3.2 分库分表的优势</h3>
<ol>
<li><strong>提升性能</strong> - 单表数据量减少,查询速度提升</li>
<li><strong>提高并发</strong> - 多库分担读写压力</li>
<li><strong>易于扩展</strong> - 可以动态增加数据源</li>
</ol>
<hr/>
<h2 data-id="heading-6">四、核心概念</h2>
<h3 data-id="heading-7">4.1 逻辑表与物理表</h3>
<p><strong>逻辑表</strong> - 应用层看到的表,比如<code>t_user</code></p>
<p><strong>物理表</strong> - 实际存储在数据库中的表,比如<code>t_user_0</code>、<code>t_user_1</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">t_user:</span>  <span class="hljs-comment"># 逻辑表</span>
  <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>  <span class="hljs-comment"># 物理表</span>
</code></pre>
<h3 data-id="heading-8">4.2 分片键</h3>
<p>决定数据路由到哪个分片的字段,必须包含在SQL中才能正确路由。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确:包含分片键,精确路由</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

<span class="hljs-comment">// 错误:不包含分片键,全路由(查询所有分片)</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">'zhangsan'</span>;
</code></pre>
<h3 data-id="heading-9">4.3 分片算法</h3>
<p>ShardingSphere通过分片算法决定数据路由到哪个分片。</p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>INLINE</td><td>基于Groovy表达式的简单算法</td><td>简单的取模分片</td></tr><tr><td>STANDARD</td><td>标准分片算法</td><td>需要精确和范围查询</td></tr></tbody></table>
<p><strong>本项目使用INLINE算法</strong>,配置简单,性能优秀。</p>
<h3 data-id="heading-10">4.4 主键生成器</h3>
<p>分布式环境下,需要全局唯一的主键生成策略。</p>















<table><thead><tr><th>生成器类型</th><th>说明</th><th>特点</th></tr></thead><tbody><tr><td>SNOWFLAKE</td><td>雪花算法</td><td>分布式、高性能、趋势递增</td></tr></tbody></table>
<h3 data-id="heading-11">4.5 广播表</h3>
<p>在所有数据源中都存在的表,数据完全一致。</p>
<p><strong>特点:</strong></p>
<ul>
<li>插入、更新、删除操作会在所有数据源执行</li>
<li>查询操作只在一个数据源执行</li>
<li>适用于字典表、配置表等小表</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">broadcast-tables:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">t_dict</span>
</code></pre>
<h3 data-id="heading-12">4.6 绑定表</h3>
<p>多个表使用相同的分片键和分片算法,确保关联数据在同一分片。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">binding-tables:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>避免跨库JOIN</li>
<li>提高查询性能</li>
<li>简化事务处理</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、快速开始</h2>
<h3 data-id="heading-14">5.1 添加依赖</h3>
<p>在<code>pom.xml</code>中添加ShardingSphere-JDBC依赖:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- ShardingSphere-JDBC核心依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-15">5.2 配置数据源</h3>
<p>在<code>application.yml</code>中配置4个数据源:</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">names:</span> <span class="hljs-string">ds0,ds1,ds2,ds3</span>
      
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db1?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds1:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db2?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds2:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db3?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds3:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db4?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>配置说明:</strong></p>
<ul>
<li><code>names</code> - 定义所有数据源的名称</li>
<li><code>hikari</code> - HikariCP连接池配置
<ul>
<li><code>minimum-idle</code> - 最小空闲连接数</li>
<li><code>maximum-pool-size</code> - 最大连接池大小</li>
<li><code>connection-timeout</code> - 连接超时时间(毫秒)</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">5.3 配置分片规则</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-comment"># 用户表配置</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-comment"># 实际数据节点: ds0.t_user_0, ds0.t_user_1, ds1.t_user_0, ds1.t_user_1</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>
            
            <span class="hljs-comment"># 分库策略</span>
            <span class="hljs-attr">database-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-db-inline</span>
            
            <span class="hljs-comment"># 分表策略</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-table-inline</span>
            
            <span class="hljs-comment"># 主键生成策略</span>
            <span class="hljs-attr">key-generate-strategy:</span>
              <span class="hljs-attr">column:</span> <span class="hljs-string">user_id</span>
              <span class="hljs-attr">key-generator-name:</span> <span class="hljs-string">snowflake</span>
</code></pre>
<p><strong>配置说明:</strong></p>
<ul>
<li><code>actual-data-nodes</code> - 定义物理表的分布
<ul>
<li><code>ds$-&gt;{0..1}</code> - 表示ds0和ds1两个数据源</li>
<li><code>t_user_$-&gt;{0..1}</code> - 表示t_user_0和t_user_1两个表</li>
<li>组合后: ds0.t_user_0, ds0.t_user_1, ds1.t_user_0, ds1.t_user_1</li>
</ul>
</li>
</ul>
<h3 data-id="heading-17">5.4 配置分片算法</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-comment"># 用户表分库算法</span>
          <span class="hljs-attr">user-db-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }'</span>
          
          <span class="hljs-comment"># 用户表分表算法</span>
          <span class="hljs-attr">user-table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }'</span>
</code></pre>
<p><strong>算法说明:</strong></p>
<ol>
<li>
<p><strong>分库算法</strong>: <code>ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }</code></p>
<ul>
<li>计算user_id的hashCode取绝对值</li>
<li>对4取模,得到0、1、2、3</li>
<li>整除2,得到0、1</li>
<li>最终路由到ds0或ds1</li>
</ul>
</li>
<li>
<p><strong>分表算法</strong>: <code>t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }</code></p>
<ul>
<li>计算user_id的hashCode取绝对值</li>
<li>对2取模,得到0、1</li>
<li>最终路由到t_user_0或t_user_1</li>
</ul>
</li>
</ol>
<p><strong>数据分布示例:</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">user_id</span> = <span class="hljs-number">100</span>
- 分库: (100 % 4).intdiv(2) = 0 → ds0
- 分表: 100 % <span class="hljs-attr">2</span> = <span class="hljs-number">0</span> → t_user_0
- 最终路由: ds0.t_user_0
</code></pre>
<h3 data-id="heading-18">5.5 配置主键生成器</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
</code></pre>
<p><strong>雪花算法原理:</strong></p>
<ul>
<li>1位符号位</li>
<li>41位时间戳(毫秒级)</li>
<li>10位机器ID</li>
<li>12位序列号</li>
</ul>
<h3 data-id="heading-19">5.6 配置广播表和绑定表</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-comment"># 绑定表配置</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
        
        <span class="hljs-comment"># 广播表配置</span>
        <span class="hljs-attr">broadcast-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_dict</span>
</code></pre>
<h3 data-id="heading-20">5.7 配置属性</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-comment"># 显示SQL(生产环境建议关闭)</span>
      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">true</span>
      <span class="hljs-comment"># 允许没有分片列的插入通过主键生成器</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-21">5.8 创建实体类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-comment">/**
     * 用户ID(主键,由ShardingSphere自动生成)
     */</span>
    <span class="hljs-keyword">private</span> Long userId;
    
    <span class="hljs-comment">/**
     * 用户名
     */</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 邮箱
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 年龄
     */</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
    
    <span class="hljs-comment">/**
     * 更新时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime updatedTime;
}
</code></pre>
<h3 data-id="heading-22">5.9 创建Mapper接口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.mapper;

<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.*;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
    
    <span class="hljs-comment">/**
     * 插入用户
     * 注意:不包含user_id字段,由ShardingSphere自动生成
     */</span>
    <span class="hljs-meta">@Insert("INSERT INTO t_user (username, email, age) VALUES (#{username}, #{email}, #{age})")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;
    
    <span class="hljs-comment">/**
     * 根据ID更新用户
     */</span>
    <span class="hljs-meta">@Update("UPDATE t_user SET username = #{username}, email = #{email}, age = #{age} WHERE user_id = #{userId}")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">updateById</span><span class="hljs-params">(User user)</span>;
    
    <span class="hljs-comment">/**
     * 根据ID查询用户
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user WHERE user_id = #{userId}")</span>
    User <span class="hljs-title function_">selectById</span><span class="hljs-params">(Long userId)</span>;
    
    <span class="hljs-comment">/**
     * 根据用户名查询用户
     * 注意:此查询不包含分片键,会导致全路由
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user WHERE username = #{username}")</span>
    User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(String username)</span>;
    
    <span class="hljs-comment">/**
     * 查询所有用户
     * 注意:此查询不包含分片键,会导致全路由
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user")</span>
    List&lt;User&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">/**
     * 根据ID删除用户
     */</span>
    <span class="hljs-meta">@Delete("DELETE FROM t_user WHERE user_id = #{userId}")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long userId)</span>;
}
</code></pre>
<p><strong>重要说明:</strong></p>
<ul>
<li>INSERT语句中不包含分片键字段(user_id),由ShardingSphere自动生成</li>
<li>查询语句最好包含分片键,否则会导致全路由,性能较差</li>
</ul>
<h3 data-id="heading-23">5.10 创建Controller层</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.UserMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.insert(user);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User inserted successfully"</span> : <span class="hljs-string">"Failed to insert user"</span>;
    }
    
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.updateById(user);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User updated successfully"</span> : <span class="hljs-string">"Failed to update user"</span>;
    }
    
    <span class="hljs-meta">@GetMapping("/{userId}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-keyword">return</span> userMapper.selectById(userId);
    }
    
    <span class="hljs-meta">@GetMapping("/username/{username}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String username)</span> {
        <span class="hljs-keyword">return</span> userMapper.selectByUsername(username);
    }
    
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userMapper.selectAll();
    }
    
    <span class="hljs-meta">@DeleteMapping("/{userId}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.deleteById(userId);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User deleted successfully"</span> : <span class="hljs-string">"Failed to delete user"</span>;
    }
}
</code></pre>
<h3 data-id="heading-24">5.11 初始化数据库</h3>
<p>执行SQL脚本创建数据库和表:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> test_db1 <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;
<span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> test_db2 <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_0
(
    user_id      <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    age          <span class="hljs-type">INT</span>,
    created_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_1
(
    user_id      <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    age          <span class="hljs-type">INT</span>,
    created_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;
</code></pre>
<h3 data-id="heading-25">5.12 启动项目</h3>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-26">5.13 测试API</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 插入用户</span>
curl -X POST http://localhost:8080/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"username":"zhangsan","email":"zhangsan@example.com","age":25}'</span>

<span class="hljs-comment"># 根据ID查询用户</span>
curl http://localhost:8080/users/100

<span class="hljs-comment"># 根据用户名查询用户</span>
curl http://localhost:8080/users/username/zhangsan

<span class="hljs-comment"># 查询所有用户</span>
curl http://localhost:8080/users

<span class="hljs-comment"># 更新用户</span>
curl -X PUT http://localhost:8080/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"userId":100,"username":"lisi","email":"lisi@example.com","age":26}'</span>

<span class="hljs-comment"># 删除用户</span>
curl -X DELETE http://localhost:8080/users/100
</code></pre>
<hr/>
<h2 data-id="heading-27">六、分片策略详解</h2>
<h3 data-id="heading-28">6.1 标准分片策略</h3>
<p>标准分片策略是最常用的分片策略,支持精确分片和范围查询。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">t_user:</span>
  <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>
  <span class="hljs-attr">database-strategy:</span>
    <span class="hljs-attr">standard:</span>
      <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
      <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-db-inline</span>
  <span class="hljs-attr">table-strategy:</span>
    <span class="hljs-attr">standard:</span>
      <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
      <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-table-inline</span>
</code></pre>
<h3 data-id="heading-29">6.2 行表达式分片算法</h3>
<p>行表达式分片算法是最简单的分片算法,使用Groovy表达式定义分片规则。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">user-db-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }'</span>
          
          <span class="hljs-attr">user-table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }'</span>
</code></pre>
<p><strong>常用表达式:</strong></p>






























<table><thead><tr><th>表达式</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>$-&gt;{column}</code></td><td>获取分片列的值</td><td><code>user_id</code></td></tr><tr><td><code>$-&gt;{column % n}</code></td><td>取模运算</td><td><code>user_id % 2</code></td></tr><tr><td><code>$-&gt;{Math.abs(column.hashCode())}</code></td><td>取绝对值</td><td><code>Math.abs(user_id.hashCode())</code></td></tr><tr><td><code>$-&gt;{column.intdiv(n)}</code></td><td>整除运算</td><td><code>(user_id % 4).intdiv(2)</code></td></tr></tbody></table>
<p><strong>示例:</strong></p>
<ol>
<li><strong>简单取模</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{user_id % 2}'</span>
</code></pre>
<ol start="2">
<li><strong>Hash取模</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{Math.abs(user_id.hashCode()) % 2}'</span>
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>表达式必须返回字符串</li>
<li>表达式中的变量名必须与分片列名一致</li>
<li>复杂表达式建议使用自定义算法</li>
</ul>
<h3 data-id="heading-30">6.3 本项目分片策略总结</h3>
<p><strong>用户表 (t_user)</strong></p>
<ul>
<li>数据源: ds0, ds1 (对应数据库 test_db1, test_db2)</li>
<li>分片键: user_id</li>
<li>分库策略: 按 user_id % 4 后整除2 (偶数分到ds0, 奇数分到ds1)</li>
<li>分表策略: 按 user_id % 2 分表</li>
<li>表结构: 两个数据源共包含 t_user_0 和 t_user_1 四个分表</li>
</ul>
<p><strong>订单表 (t_order)</strong></p>
<ul>
<li>数据源: ds2, ds3 (对应数据库 test_db3, test_db4)</li>
<li>分片键: order_id</li>
<li>分库算法: 按 order_id % 2 映射到 ds2, ds3</li>
<li>分表算法: 按 order_id % 4 分片</li>
<li>表结构: 每个数据源包含 t_order_0 到 t_order_3 四个分表</li>
</ul>
<p><strong>订单项表 (t_order_item)</strong></p>
<ul>
<li>数据源: ds2, ds3 (对应数据库 test_db3, test_db4)</li>
<li>分片键: order_id</li>
<li>与订单表为绑定表关系</li>
</ul>
<p><strong>广播表 (t_dict)</strong></p>
<ul>
<li>在所有数据源中都存在</li>
<li>数据完全一致</li>
</ul>
<hr/>
<h2 data-id="heading-31">七、高级特性</h2>
<h3 data-id="heading-32">7.1 Hint分片策略</h3>
<p>Hint分片策略通过Hint指定分片，适用于需要强制路由的场景。</p>
<p><strong>使用场景:</strong></p>
<ul>
<li>批量操作时指定分片提高性能</li>
<li>需要强制路由到特定分片的场景</li>
<li>数据迁移场景</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_order:</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{2..3}.t_order_$-&gt;{0..3}</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">hint:</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">order-hint</span>
        
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">order-hint:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_order_$-&gt;{value}'</span>
</code></pre>
<p><strong>使用Hint路由:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.OrderMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.Order;
<span class="hljs-keyword">import</span> org.apache.shardingsphere.infra.hint.HintManager;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 使用Hint强制路由到指定分片查询
     * 
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@param</span> tableIndex 表索引(0-3)
     * <span class="hljs-doctag">@return</span> 订单对象
     */</span>
    <span class="hljs-meta">@GetMapping("/hint/{orderId}/{tableIndex}")</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">selectByHint</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId, <span class="hljs-meta">@PathVariable</span> <span class="hljs-type">int</span> tableIndex)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置Hint值，指定路由到哪个分片</span>
            hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, tableIndex);
            <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
        }
    }
    
    <span class="hljs-comment">/**
     * 批量查询，指定多个分片
     * 
     * <span class="hljs-doctag">@param</span> tableIndices 表索引列表(0-3)
     * <span class="hljs-doctag">@return</span> 订单列表
     */</span>
    <span class="hljs-meta">@GetMapping("/hint/batch/{tableIndices}")</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">batchSelectByHint</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> List&lt;Integer&gt; tableIndices)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置多个Hint值</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> tableIndex : tableIndices) {
                hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, tableIndex);
            }
            <span class="hljs-keyword">return</span> orderMapper.selectAll();
        }
    }
}
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>HintManager使用后需要关闭，可以使用try-with-resources</li>
<li>Hint只在当前线程有效</li>
<li>Hint优先级高于其他分片策略</li>
</ul>
<h3 data-id="heading-33">7.2 读写分离</h3>
<p>读写分离是提升系统性能的重要手段，将读操作分发到从库，写操作在主库执行。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">names:</span> <span class="hljs-string">master,slave0,slave1</span>
      
      <span class="hljs-comment"># 主库配置</span>
      <span class="hljs-attr">master:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
      
      <span class="hljs-comment"># 从库0配置</span>
      <span class="hljs-attr">slave0:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3307/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
      
      <span class="hljs-comment"># 从库1配置</span>
      <span class="hljs-attr">slave1:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3308/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
    
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># 读写分离规则</span>
      <span class="hljs-attr">readwrite-splitting:</span>
        <span class="hljs-attr">data-sources:</span>
          <span class="hljs-comment"># 读写分离数据源配置</span>
          <span class="hljs-attr">readwrite_ds:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">Static</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-comment"># 写数据源</span>
              <span class="hljs-attr">write-data-source-name:</span> <span class="hljs-string">master</span>
              <span class="hljs-comment"># 读数据源列表</span>
              <span class="hljs-attr">read-data-source-names:</span> <span class="hljs-string">slave0,slave1</span>
              <span class="hljs-comment"># 负载均衡算法</span>
              <span class="hljs-attr">load-balancer-name:</span> <span class="hljs-string">round_robin</span>
        
        <span class="hljs-comment"># 负载均衡算法</span>
        <span class="hljs-attr">load-balancers:</span>
          <span class="hljs-attr">round_robin:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">ROUND_ROBIN</span>
          <span class="hljs-attr">random:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">RANDOM</span>
</code></pre>
<p><strong>负载均衡算法:</strong></p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>ROUND_ROBIN</td><td>轮询</td><td>从库性能相近</td></tr><tr><td>RANDOM</td><td>随机</td><td>从库性能相近</td></tr></tbody></table>
<p><strong>强制读主库:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.UserMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.apache.shardingsphere.infra.hint.HintManager;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-comment">/**
     * 强制从主库读取数据
     * 用于需要读取最新数据的场景
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 用户对象
     */</span>
    <span class="hljs-meta">@GetMapping("/master/{userId}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectFromMaster</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置从主库读取</span>
            hintManager.setWriteRouteOnly();
            <span class="hljs-keyword">return</span> userMapper.selectById(userId);
        }
    }
}
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>读写分离依赖MySQL主从复制</li>
<li>主从复制有延迟，可能读到旧数据</li>
<li>需要读取最新数据时，使用Hint强制读主库</li>
<li>确保从库数据与主库一致</li>
</ul>
<h3 data-id="heading-34">7.3 数据加密</h3>
<p>ShardingSphere支持数据加密，保护敏感数据。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># 加密规则</span>
      <span class="hljs-attr">encrypt:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-attr">columns:</span>
              <span class="hljs-comment"># 邮箱加密配置</span>
              <span class="hljs-attr">email:</span>
                <span class="hljs-attr">cipher-column:</span> <span class="hljs-string">email_cipher</span>  <span class="hljs-comment"># 加密列</span>
                <span class="hljs-attr">assisted-query-column:</span> <span class="hljs-string">email_assisted</span>  <span class="hljs-comment"># 辅助查询列</span>
                <span class="hljs-attr">encryptor-name:</span> <span class="hljs-string">aes_encryptor</span>  <span class="hljs-comment"># 加密器名称</span>
              <span class="hljs-comment"># 手机号加密配置</span>
              <span class="hljs-attr">phone:</span>
                <span class="hljs-attr">cipher-column:</span> <span class="hljs-string">phone_cipher</span>
                <span class="hljs-attr">encryptor-name:</span> <span class="hljs-string">aes_encryptor</span>
        
        <span class="hljs-comment"># 加密器配置</span>
        <span class="hljs-attr">encryptors:</span>
          <span class="hljs-attr">aes_encryptor:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">AES</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">aes-key-value:</span> <span class="hljs-number">1234567890123456</span>  <span class="hljs-comment"># AES密钥，16位</span>
</code></pre>
<p><strong>实体类调整:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 邮箱（逻辑列，自动加密）
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 手机号（逻辑列，自动加密）
     */</span>
    <span class="hljs-keyword">private</span> String phone;
    
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
    <span class="hljs-keyword">private</span> LocalDateTime updatedTime;
}
</code></pre>
<p><strong>数据库表结构:</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_0
(
    user_id            <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username           <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email_cipher       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 加密后的邮箱</span>
    email_assisted     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 辅助查询列</span>
    phone_cipher       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 加密后的手机号</span>
    age                <span class="hljs-type">INT</span>,
    created_time       <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time       <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;
</code></pre>
<p><strong>加密算法类型:</strong></p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>AES</td><td>AES加密</td><td>通用加密</td></tr><tr><td>MD5</td><td>MD5加密</td><td>不可逆加密</td></tr></tbody></table>
<p><strong>注意事项:</strong></p>
<ul>
<li>加密后无法直接查询，需要使用辅助查询列</li>
<li>加密会影响性能，谨慎使用</li>
<li>密钥需要安全存储，建议使用密钥管理服务</li>
</ul>
<h3 data-id="heading-35">7.4 分布式主键生成策略</h3>
<p>除了Snowflake算法，ShardingSphere还支持其他主键生成策略。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-comment"># 雪花算法</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">max-vibration-offset:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># 最大抖动偏移量</span>
              <span class="hljs-attr">max-tolerate-time-difference-milliseconds:</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># 最大容忍时间差(毫秒)</span>
</code></pre>
<p><strong>主键生成器类型:</strong></p>

























<table><thead><tr><th>生成器类型</th><th>说明</th><th>特点</th></tr></thead><tbody><tr><td>SNOWFLAKE</td><td>雪花算法</td><td>分布式、高性能、趋势递增</td></tr><tr><td>UUID</td><td>UUID</td><td>无序、长度长</td></tr><tr><td>NIL</td><td>不生成主键</td><td>需要手动指定</td></tr></tbody></table>
<p><strong>使用建议:</strong></p>
<ul>
<li>优先使用Snowflake算法</li>
<li>性能敏感场景考虑调整max-tolerate-time-difference-milliseconds</li>
<li>确保主键唯一性</li>
</ul>
<h3 data-id="heading-36">7.5 SQL解析与改写</h3>
<p>ShardingSphere支持SQL解析和改写，这是其核心能力之一。</p>
<p><strong>功能说明:</strong></p>
<ol>
<li><strong>自动路由</strong> - 根据分片键自动路由到目标分片</li>
<li><strong>结果归并</strong> - 合并多个分片的结果</li>
<li><strong>SQL改写</strong> - 修改SQL以适应分片场景</li>
</ol>
<p><strong>示例:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原始SQL</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>

<span class="hljs-comment">// 改写后的SQL（路由到ds0.t_user_0）</span>
SELECT * FROM ds0.t_user_0 <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
</code></pre>
<p><strong>使用建议:</strong></p>
<ul>
<li>理解SQL改写原理，优化SQL语句</li>
<li>避免全路由查询，性能较差</li>
<li>使用绑定表避免跨库JOIN</li>
</ul>
<h3 data-id="heading-37">7.6 配置中心</h3>
<p>ShardingSphere支持配置中心，实现动态配置管理。</p>
<p><strong>支持的配置中心:</strong></p>
<ul>
<li>Zookeeper</li>
<li>Nacos</li>
<li>Etcd</li>
<li>Apollo</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">mode:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">Cluster</span>
      <span class="hljs-attr">repository:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">Zookeeper</span>
        <span class="hljs-attr">props:</span>
          <span class="hljs-attr">namespace:</span> <span class="hljs-string">sharding-sphere</span>
          <span class="hljs-attr">server-lists:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:2181</span>
          <span class="hljs-attr">retry-interval-milliseconds:</span> <span class="hljs-number">500</span>
          <span class="hljs-attr">max-retries:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">time-to-live-milliseconds:</span> <span class="hljs-number">5000</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>配置动态更新，无需重启</li>
<li>配置集中管理</li>
<li>配置版本控制</li>
</ul>
<p><strong>使用建议:</strong></p>
<ul>
<li>生产环境使用配置中心</li>
<li>配置变更需要灰度发布</li>
<li>配置需要备份</li>
</ul>
<hr/>
<h2 data-id="heading-38">八、生产环境最佳实践</h2>
<h3 data-id="heading-39">7.1 配置优化</h3>
<p><strong>数据源配置:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>ShardingSphere配置:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-comment"># 生产环境关闭SQL显示</span>
      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">false</span>
      <span class="hljs-comment"># 允许没有分片列的插入通过主键生成器</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
      <span class="hljs-comment"># 核心执行线程池大小</span>
      <span class="hljs-attr">kernel-executor-size:</span> <span class="hljs-number">16</span>
</code></pre>
<h3 data-id="heading-40">7.2 性能优化</h3>
<p><strong>1. 使用绑定表</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>避免跨库JOIN</li>
<li>提高查询性能</li>
<li>简化事务处理</li>
</ul>
<p><strong>2. 避免全路由</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:不包含分片键,全路由</span>
List&lt;User&gt; users = userMapper.selectAll();

<span class="hljs-comment">// 推荐:包含分片键,精确路由</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">100L</span>);
</code></pre>
<p><strong>3. 合理使用索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在分片键上创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> t_user(user_id);

<span class="hljs-comment">-- 在常用查询字段上创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_username <span class="hljs-keyword">ON</span> t_user(username);
</code></pre>
<h3 data-id="heading-41">7.3 监控告警</h3>
<p><strong>监控指标:</strong></p>
<ol>
<li>
<p><strong>数据库指标</strong></p>
<ul>
<li>连接数使用率</li>
<li>慢查询数量</li>
<li>锁等待时间</li>
</ul>
</li>
<li>
<p><strong>应用指标</strong></p>
<ul>
<li>SQL执行时间</li>
<li>SQL错误率</li>
<li>分片路由时间</li>
</ul>
</li>
<li>
<p><strong>业务指标</strong></p>
<ul>
<li>请求响应时间</li>
<li>请求成功率</li>
<li>请求吞吐量</li>
</ul>
</li>
</ol>
<h3 data-id="heading-42">7.4 安全加固</h3>
<p><strong>1. SQL注入防护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:字符串拼接SQL</span>
<span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM t_user WHERE username = '"</span> + username + <span class="hljs-string">"'"</span>;

<span class="hljs-comment">// 推荐:使用参数化查询</span>
<span class="hljs-meta">@Select("SELECT * FROM t_user WHERE username = #{username}")</span>
User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(String username)</span>;
</code></pre>
<p><strong>2. 权限控制</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建只读用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'readonly'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> test_db.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readonly'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- 创建读写用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'readwrite'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> test_db.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readwrite'</span>@<span class="hljs-string">'%'</span>;
</code></pre>
<h3 data-id="heading-43">7.5 运维建议</h3>
<p><strong>1. 定期备份</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 备份数据库</span>
mysqldump -h 127.0.0.1 -u root -p test_db1 &gt; test_db1_backup.sql

<span class="hljs-comment"># 恢复数据库</span>
mysql -h 127.0.0.1 -u root -p test_db1 &lt; test_db1_backup.sql
</code></pre>
<p><strong>2. 定期清理</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 清理过期数据</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> created_time <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);

<span class="hljs-comment">-- 优化表</span>
OPTIMIZE <span class="hljs-keyword">TABLE</span> t_user_0;
OPTIMIZE <span class="hljs-keyword">TABLE</span> t_user_1;
</code></pre>
<hr/>
<h2 data-id="heading-44">九、常见问题与解决方案</h2>
<h3 data-id="heading-45">9.1 分片键自动生成问题</h3>
<p><strong>问题:</strong> INSERT语句不包含分片键,导致路由失败。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Insert("INSERT INTO t_user (username, email, age) VALUES (#{username}, #{email}, #{age})")</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;
</code></pre>
<h3 data-id="heading-46">9.2 全路由问题</h3>
<p><strong>问题:</strong> 查询不包含分片键,导致全路由,性能较差。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:全路由</span>
List&lt;User&gt; users = userMapper.selectAll();

<span class="hljs-comment">// 推荐:精确路由</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">100L</span>);
</code></pre>
<h3 data-id="heading-47">9.3 跨库JOIN问题</h3>
<p><strong>问题:</strong> 跨库JOIN性能较差或无法执行。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<h3 data-id="heading-48">9.4 主键冲突问题</h3>
<p><strong>问题:</strong> 分布式主键生成器配置错误,导致主键冲突。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
</code></pre>
<h3 data-id="heading-49">9.5 连接池耗尽问题</h3>
<p><strong>问题:</strong> 连接池配置不合理,导致连接池耗尽。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
</code></pre>
<h3 data-id="heading-50">9.6 Hint分片不生效问题</h3>
<p><strong>问题:</strong> 使用HintManager指定分片后，查询仍然路由到所有分片。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 确保使用try-with-resources或手动关闭HintManager</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
    hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
}

<span class="hljs-comment">// 或者手动关闭</span>
<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance();
<span class="hljs-keyword">try</span> {
    hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
} <span class="hljs-keyword">finally</span> {
    hintManager.close();
}
</code></pre>
<h3 data-id="heading-51">9.7 读写分离主从延迟问题</h3>
<p><strong>问题:</strong> 读写分离导致主从延迟，读取到旧数据。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 强制读主库</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
    hintManager.setWriteRouteOnly();
    <span class="hljs-keyword">return</span> userMapper.selectById(userId);
}
</code></pre>
<hr/>
<h2 data-id="heading-52">十、总结</h2>
<p>ShardingSphere-JDBC是一个功能强大的分库分表中间件,本文档详细介绍了其配置和使用方法。</p>
<p><strong>核心要点:</strong></p>
<ol>
<li><strong>分片键选择</strong> - 选择高频查询字段作为分片键</li>
<li><strong>分片算法</strong> - 使用INLINE算法,配置简单,性能优秀</li>
<li><strong>绑定表</strong> - 使用绑定表避免跨库JOIN</li>
<li><strong>主键生成</strong> - 使用Snowflake算法保证唯一性</li>
<li><strong>避免全路由</strong> - 查询语句最好包含分片键</li>
</ol>
<p><strong>最佳实践:</strong></p>
<ol>
<li>优先使用INLINE算法,性能好</li>
<li>避免全路由查询,性能差</li>
<li>使用绑定表,避免跨库操作</li>
<li>配置合理的连接池大小</li>
<li>生产环境关闭sql-show</li>
<li>定期备份,防止数据丢失</li>
</ol>
<p><strong>参考资料:</strong></p>
<ul>
<li>ShardingSphere官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fshardingsphere.apache.org%2F" target="_blank" title="https://shardingsphere.apache.org/" ref="nofollow noopener noreferrer">shardingsphere.apache.org/</a></li>
<li>ShardingSphere GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fshardingsphere" target="_blank" title="https://github.com/apache/shardingsphere" ref="nofollow noopener noreferrer">github.com/apache/shar…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合]]></title>    <link>https://juejin.cn/post/7590957076630634542</link>    <guid>https://juejin.cn/post/7590957076630634542</guid>    <pubDate>2026-01-04T01:46:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590957076630634542" data-draft-id="7590849961727655963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2026-01-04T01:46:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:46:35.000Z" title="Sun Jan 04 2026 01:46:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：用 sklearn 在 Wine 数据集上训练 DecisionTreeClassifier，并用 Graphviz 导出可视化</li>
<li>结论：criterion 影响分裂度量（gini/entropy/log_loss），random_state 与 splitter 决定稳定性与随机性；剪枝靠 max_depth/min_samples_leaf/ccp_alpha</li>
<li>产出：可复现实验流程 + export_graphviz 参数要点 + 环境版本矩阵 + 常见报错定位表</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a497d33a634769af93d49f2a219467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ccoxLVQotg6Js%2F9memyJJ0yNIv8%3D" alt="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





















<table><thead><tr><th>组件</th><th>已验证说明</th></tr></thead><tbody><tr><td>scikit-learn 1.8.0</td><td>PyPI 声明2025-12-10 发布；Requires: Python&gt;=3.11；DecisionTreeClassifier 的 criterion 支持 gini/entropy/log_loss <a href="https://link.juejin.cn?target=https%3A%2F%2Fscikit-learn.org%2Fstable%2Fmodules%2Fgenerated%2Fsklearn.tree.DecisionTreeClassifier.html" target="_blank" title="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html" ref="nofollow noopener noreferrer">DecisionTreeClassifier API官方文档</a>；splitter 支持 best/random；criterion 见上 <a href="https://link.juejin.cn?target=https%3A%2F%2Fscikit-learn.org%2Fstable%2Fmodules%2Fgenerated%2Fsklearn.tree.export_graphviz.html" target="_blank" title="https://scikit-learn.org/stable/modules/generated/sklearn.tree.export_graphviz.html" ref="nofollow noopener noreferrer">export_graphviz官方文档</a> 导出 DOT；配合 dot 命令可生成 PNG/SVG 等</td></tr><tr><td>python-graphviz 0.21</td><td>PyPI 声明Requires: Python&gt;=3.9；渲染仍依赖系统 Graphviz（dot）与 PATH</td></tr><tr><td>系统 Graphviz（dot）</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgraphviz.org%2F" target="_blank" title="https://graphviz.org/" ref="nofollow noopener noreferrer">官方站点</a>需单独安装（Windows/macOS/Linux 方式不同）</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a3faf0f5190427892ebb8a183e2ef78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=vGI%2F6Re1A6uwODN55fXCoNXpMPc%3D" alt="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合" loading="lazy"/></p>
<h2 data-id="heading-2">使用sklearn实现决策树</h2>
<h3 data-id="heading-3">参数CRITERION</h3>
<p>criterion 这个参数使用来决定不纯度的计算方法，sklearn提供了两种选择：</p>
<ul>
<li>输入 entropy，使用信息熵（Entropy）</li>
<li>输入 gini，使用基尼系数（Gini Impurity）</li>
</ul>
<p>在机器学习中，基尼系数和信息熵都是常用的不纯度度量指标，用于决策树等算法的特征选择和节点划分。两者虽然计算方式和敏感性不同，但在实际应用中往往能达到相似的效果。</p>
<p>信息熵的计算公式为：H(X)=-Σp(x)log₂p(x)，其中p(x)是某个类别的概率。由于涉及对数运算，其计算复杂度比基尼系数要高。相比之下，基尼系数的计算公式Gini=1-Σp(x)²更加简单直接，不需要对数运算，因此计算速度更快。</p>
<p>具体来说，信息熵对数据不纯度的惩罚更强。例如：</p>
<ul>
<li>当某个节点中两个类别的样本比例为7:3时：
<ul>
<li>基尼系数=1-(0.7²+0.3²)=0.42</li>
<li>信息熵=-(0.7<em>log₂0.7+0.3</em>log₂0.3)≈0.88</li>
</ul>
</li>
<li>当比例变为8:2时：
<ul>
<li>基尼系数=0.32</li>
<li>信息熵≈0.72</li>
</ul>
</li>
</ul>
<p>这种敏感性差异导致：</p>
<ol>
<li>在高维数据场景下（如特征数超过1000），信息熵容易产生过拟合，因为它会倾向于选择更细粒度的划分方式。此时基尼系数表现更稳健。</li>
<li>在噪声数据较多时（如标签错误率超过10%），基尼系数的抗干扰能力更强。</li>
<li>当模型欠拟合时（训练集和测试集准确率都低于60%），使用信息熵可能获得更好的效果，因为它能驱动模型学习更精细的决策边界。</li>
</ol>
<p>实际应用建议：</p>
<ul>
<li>对于结构化数据（如表格数据），可以优先尝试基尼系数</li>
<li>在计算资源受限的实时系统中，基尼系数是更好的选择</li>
<li>当数据质量较高且维度适中时（如UCI数据集），可以比较两种指标的效果</li>
<li>在集成学习中（如随机森林），两种指标的差异通常会被弱化</li>
</ul>
<p>需要注意的是，这些规律并非绝对。在实践中，最好的方式是通过交叉验证来比较两种指标在特定数据集上的表现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c877d721cc34e0aaee7244d9fb7bb7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=i%2BVS3AWfS4ubVO5WK4DrUUA8r84%3D" alt="sklearn实现决策树" loading="lazy"/></p>
<h2 data-id="heading-4">初步建模</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入需要的算法库和模块</span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
%matplotlib inline
<span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> tree
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_wine
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>]=[<span class="hljs-string">'Simhei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>]=<span class="hljs-literal">False</span>
</code></pre>
<p>加载数据</p>
<pre><code class="hljs language-python" lang="python">wine = load_wine()
wine.data.shape
wine.target
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381e98d5f85e435aac734029558a64c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=%2FoHbEPMLI1qmWJWEbwmeSyRmXsA%3D" alt="sklearn实现决策树" loading="lazy"/>
如果是 wine 是一张表，应该长这样：</p>
<pre><code class="hljs language-python" lang="python">wine_pd=pd.concat([pd.DataFrame(wine.data),pd.DataFrame(wine.target)],axis=<span class="hljs-number">1</span>).head()
wine.feature_names.append(<span class="hljs-string">"result"</span>)
wine_pd.columns=wine.feature_names
wine_pd
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/726d5daf9e8e48619a44ece8002a8551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=q%2Fv0oSP1OqMOHpSWi4vwy1iA1QI%3D" alt="sklearn实现决策树" loading="lazy"/>
编写代码查看形状：</p>
<pre><code class="hljs language-python" lang="python">Xtrain, Xtest, Ytrain, ytest = train_test_split(wine.data,wine.target,test_size=<span class="hljs-number">0.3</span>,random_state=<span class="hljs-number">420</span>)
<span class="hljs-built_in">print</span>(Xtrain.shape)
<span class="hljs-built_in">print</span>(Xtest.shape)
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe0eecd47b84fe3b71973d6721d2bde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ULqI3sMUG%2BXt1kZ6IX6%2BayP49BU%3D" alt="sklearn实现决策树" loading="lazy"/></p>
<h2 data-id="heading-5">建立模型</h2>
<pre><code class="hljs language-python" lang="python">clf = tree.DecisionTreeClassifier(criterion=<span class="hljs-string">"gini"</span>)
clf = clf.fit(Xtrain, Ytrain)
clf.score(Xtest, ytest) <span class="hljs-comment">#返回预测的准确度</span>
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d78a27b69c24cc3a66fa96ed1424531~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=6ViGovnqiqD5Gisp%2F39EMjWvsK8%3D" alt="sklearn实现决策树 建立模型" loading="lazy"/></p>
<h2 data-id="heading-6">画决策树</h2>
<p>我们可以利用 Graphviz 模块导出决策树模型，第一次使用 Graphviz 之前需要进行安装，若是使用从 pip 安装：</p>
<pre><code class="hljs language-shell" lang="shell">!pip install graphviz
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27cc0283bf334b5e90b3fdbca0f8db27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=WNkLu32Qw3DcpN%2Fgc90IqOW%2BJKM%3D" alt="决策树" loading="lazy"/>
对图案进行绘制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> graphviz
<span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> tree


feature_name = [<span class="hljs-string">'酒精'</span>,<span class="hljs-string">'苹果酸'</span>,<span class="hljs-string">'灰'</span>,<span class="hljs-string">'灰的碱性'</span>,<span class="hljs-string">'镁'</span>,<span class="hljs-string">'总酚'</span>,<span class="hljs-string">'类黄酮'</span>,<span class="hljs-string">'非黄烷类酚类'</span>,<span class="hljs-string">'花青素'</span>,<span class="hljs-string">'颜色强度'</span>,<span class="hljs-string">'色调'</span>,<span class="hljs-string">'od280/od315 稀释葡萄酒'</span>,<span class="hljs-string">'脯氨酸'</span>]
dot_data = tree.export_graphviz(clf, out_file = <span class="hljs-literal">None</span>, feature_names= feature_name, class_names=[<span class="hljs-string">"琴酒"</span>,<span class="hljs-string">"雪莉"</span>,<span class="hljs-string">"贝尔摩德"</span>], filled=<span class="hljs-literal">True</span>, rounded=<span class="hljs-literal">True</span>)
graph = graphviz.Source(dot_data)
graph
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d15822b692f4e93a0208ea0718c2d58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ArBePPfg%2Fa%2FeW6NQ3x5s2lazNE0%3D" alt="sklearn实现决策树" loading="lazy"/>
绘制的图片如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0fec3f96bf4c54a0c17a5393f0753e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=TtfY6gv7uQS86OUzlJL8d81SB5w%3D" alt="sklearn实现决策树 绘制" loading="lazy"/></p>
<p>export_graphviz 生成了一个 DOT 格式的决策树：</p>
<ul>
<li>feature_names：每个属性的名字</li>
<li>class_names：每个因变量类别的名字</li>
<li>label：是否显示不纯度信息的标签，默认为 all 表都显示，可以是root或 none</li>
<li>filled：是否给每个节点的主分类绘制不同的颜色，默认为 False</li>
<li>out_file：输出的 dot 文件的名字，默认为 None表示不输出文件，可以是自定义名字如“tree.dot”</li>
<li>rounded：默认为 True，表示对每个节点的边框加圆角，使用 Helvetica 字体</li>
</ul>
<h2 data-id="heading-7">防止过拟合</h2>
<p>在不加限制的情况下，一颗决策树会持续生长直到满足以下任一条件：</p>
<ol>
<li>所有叶节点的基尼系数（Gini impurity）或信息熵（information entropy）等不纯度指标达到最优（通常为0）</li>
<li>没有更多的特征可用于进一步分割数据</li>
<li>每个叶节点仅包含单一类别的样本</li>
</ol>
<p>这种不加限制的生长方式往往会导致严重的过拟合问题。具体表现为：</p>
<ul>
<li>在训练集上可能达到100%的准确率</li>
<li>但在测试集上表现显著下降（如准确率骤降20-30个百分点）</li>
</ul>
<p>造成这种现象的根本原因在于：</p>
<ol>
<li>样本偏差问题：我们收集的训练数据不可能完全代表整体数据分布，总会存在抽样偏差</li>
<li>噪声敏感问题：当决策树过度生长时：
<ul>
<li>会捕捉到训练数据中的随机噪声（如5%的错误标注样本）</li>
<li>为这些噪声创建特定的分裂规则（例如"当特征X=3.14159时预测类别A"）</li>
<li>导致模型泛化能力下降</li>
</ul>
</li>
</ol>
<p>典型示例：
在房价预测任务中，一棵过拟合的决策树可能会：</p>
<ul>
<li>为训练集中某个异常低价样本（如输入错误的$1元房价）创建特殊分支</li>
<li>在实际预测时，遇到类似特征组合的房屋就会错误预测极低价格</li>
</ul>
<p>解决方法通常包括：</p>
<ol>
<li>预剪枝（Pre-pruning）：
<ul>
<li>设置最大深度（如max_depth=5）</li>
<li>设置叶节点最小样本数（如min_samples_leaf=10）</li>
</ul>
</li>
<li>后剪枝（Post-pruning）：
<ul>
<li>使用代价复杂度剪枝（CCP）</li>
<li>基于验证集性能进行剪枝</li>
</ul>
</li>
<li>集成方法：
<ul>
<li>随机森林（通过多棵树投票降低过拟合风险）</li>
<li>梯度提升树（通过迭代优化减少单棵树的影响）</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#我们的树对训练集的拟合程度如何?</span>
score_train = clf.score(Xtrain, Ytrain)
score_train
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ac58d4df39d49f8be14ef1785a1437f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=c%2BU0GuDSw9lqiYpvNdkMgP%2BRPcY%3D" alt="sklearn实现决策树 防止过拟合" loading="lazy"/>
为了让决策树有更好的泛化性，我们要对决策树进行剪枝。剪枝策略对决策树的影响巨大，正确的剪枝策略是优化决策树算法的核心。</p>
<h2 data-id="heading-8">random_state</h2>
<p>如果我们改动了 random_state，画出来的每一颗树都不一样，它为什么不稳定呢？如果使用其他数据集，它还会不稳定吗？
我们之前提过，无论决策树模型如何进化，在分支上的本质都还是追求某个不纯度相关的指标的优化，而正如我们提到的，不纯度是基于节点计算出来的，也就是说，决策树在建树时，是靠优化节点来追求一棵优化的树，但是最优的节点是能够保证最优的树吗？</p>
<p>集成算法被用来解决这个问题：sklearn 表示，既然一棵树不能保证最优，那就建更多不同的树，然后从中取最好的。怎么样从一组数据集中建不同的树呢？在每次分支的时候，不使用全部特征，而是随机选取一部分特征，从中选取不纯度相关指标最优的作为分支用的节点。
这样，每次生成的树叶不同了。</p>
<p>random_state 用来设置分支中的随机模型的参数，默认是 None，在高维度时随机性会表现更明显，低维度的数据随机性几乎不会显现。输入任意整数，会一直长出同一棵树，让模型稳定下来。</p>
<h2 data-id="heading-9">splitter</h2>
<p>splitter 也是用来控制决策树中随机选项的，有两种输入值：</p>
<ul>
<li>输入 best，决策树在分支时虽然随机，但是还是会优先选择更重要的特征进行分支（重要性可以通过属性 feature_importance 查看）</li>
<li>输入 random，决策树在分支时会更加随机，树会因为含有更多的不必要的信息而更深更大，并因为这些不必要信息而降低对训练集的拟合。这也是一种防止过拟合的方式。</li>
</ul>
<p>当你预测到你的模型会过拟合，用这两个参数来帮助你降低树建成之后的过拟合的可能性，当然，树一旦建成，我们依然是使用剪枝参数来防止拟合的。</p>
<pre><code class="hljs language-python" lang="python">clf = tree.DecisionTreeClassifier(criterion=<span class="hljs-string">"entropy"</span>,random_state=<span class="hljs-number">30</span>,splitter=<span class="hljs-string">"random"</span>)
clf = clf.fit(Xtrain, Ytrain)
score = clf.score(Xtest, ytest)
<span class="hljs-built_in">print</span>(score)
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>]=[<span class="hljs-string">'Simhei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>]=<span class="hljs-literal">False</span>
</code></pre>
<p>代码的执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31afe0d1e2194e20ae71bd34bee833d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=rBzxInKP0xM75G1VUXKTds8dEA0%3D" alt="sklearn实现决策树 决策树分支" loading="lazy"/></p>
<h2 data-id="heading-10">版本矩阵</h2>


















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>ModuleNotFoundError: No module named 'graphviz'</td><td>未安装 python-graphviz 包</td><td><code>python -c "import graphviz"</code><br/><code>pip install graphviz</code></td></tr><tr><td>ExecutableNotFound: failed to execute 'dot' / 渲染为空</td><td>只装了 python 包，未装系统 Graphviz 或 PATH 未配</td><td><code>dot -V</code> 是否可用<br/>安装系统 Graphviz，并把 dot 所在目录加入 PATH</td></tr><tr><td>ValueError: Length of feature_names ...</td><td>feature_names 数量与 X 特征列不一致</td><td>对比 Xtrain.shape[1] 与 len(feature_name)<br/>统一特征数；Wine 为 13 维时 feature_names 也应为 13</td></tr><tr><td>图里类别名/计数顺序不对</td><td>class_names 顺序与内部类别编码不一致</td><td>查看 tree 图首节点 value=[...] 顺序<br/>class_names 按类别编码升序传入（如 0/1/2 对应的名称顺序）</td></tr><tr><td>NameError: name 'Ytrain' is not defined</td><td>变量名大小写不一致/拷贝时漏段</td><td>搜索 Ytrain/ytrain<br/>统一命名（训练/测试标签用同一风格）</td></tr><tr><td>SyntaxError 出现在 %matplotlib inline</td><td>该语法仅适用于 Jupyter</td><td>运行环境是 .py / IDE 脚本<br/>脚本环境移除该魔法命令</td></tr><tr><td>训练集 1.0、测试集明显下降</td><td>树无约束生长导致过拟合</td><td>对比 clf.score(Xtrain, Ytrain) vs clf.score(Xtest, ytest)<br/>加 max_depth/min_samples_leaf/min_samples_split，或用 ccp_alpha 做后剪枝</td></tr><tr><td>InvalidParameterError: The 'criterion' parameter ...</td><td>sklearn 版本差异或参数拼写</td><td>sklearn.<strong>version</strong>；检查 criterion 值<br/>用官方支持值；新版本支持 gini/entropy/log_loss</td></tr></tbody></table>
<h2 data-id="heading-11">其他系列</h2>
<h3 data-id="heading-12">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-13">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-14">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[useEffect详解]]></title>    <link>https://juejin.cn/post/7590303618429173795</link>    <guid>https://juejin.cn/post/7590303618429173795</guid>    <pubDate>2026-01-03T12:42:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590303618429173795" data-draft-id="7590433626560151587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="useEffect详解"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-03T12:42:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="写代码的皮筏艇"/> <meta itemprop="url" content="https://juejin.cn/user/4196178024218520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            useEffect详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4196178024218520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    写代码的皮筏艇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:42:55.000Z" title="Sat Jan 03 2026 12:42:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">React 中 useEffect 详解</h3>
<p><code>useEffect</code> 是 React Hooks 中用于处理<strong>副作用</strong>的核心 Hook，它替代了类组件中的生命周期方法（<code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code>），让函数组件能够执行异步操作、修改 DOM、订阅事件、清理资源等副作用逻辑。而且现在函数组件才是主流，类组件多是一些老项目</p>
<h3 data-id="heading-1">一、核心概念：什么是 “副作用”？</h3>
<p>副作用（Side Effect）是指函数执行过程中，除了返回值之外对外部环境产生的影响，常见场景：</p>
<ul>
<li>数据请求（AJAX/fetch）</li>
<li>DOM 操作（修改样式、添加事件监听）</li>
<li>订阅 / 取消订阅（如 WebSocket、定时器）</li>
<li>本地存储（localStorage/sessionStorage）</li>
<li>手动修改 state（需谨慎）</li>
</ul>
<h3 data-id="heading-2">二、基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基础用法</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 副作用逻辑（执行时机：组件挂载/更新后）</span>
    
    <span class="hljs-comment">// 可选：清理函数（执行时机：组件卸载/下一次副作用执行前）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 清理逻辑（如取消订阅、清除定时器）</span>
    };
  }, [依赖项数组]); <span class="hljs-comment">// 关键：依赖项决定副作用的执行时机</span>
}
</code></pre>
<h4 data-id="heading-3">语法拆解：</h4>
<ol>
<li>
<p><strong>第一个参数（必选）</strong> ：副作用函数</p>
<ul>
<li>可以是普通函数，执行核心的副作用逻辑；</li>
<li>可选返回一个<strong>清理函数</strong>（Cleanup Function），用于清除副作用（如取消定时器、解绑事件）。</li>
</ul>
</li>
<li>
<p><strong>第二个参数（可选）</strong> ：依赖项数组</p>
<ul>
<li>控制副作用的执行时机；</li>
<li>若省略：组件<strong>每次渲染后</strong>都会执行副作用；</li>
<li>若为空数组 <code>[]</code>：仅在组件<strong>挂载（mount）</strong>  时执行一次，清理函数在组件<strong>卸载（unmount）</strong>  时执行；</li>
<li>若包含依赖项（如 <code>[count, data]</code>）：仅在依赖项的值<strong>发生变化</strong>时执行副作用（挂载时执行第一次，后续仅依赖项变化触发）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-4">三、执行时机</h3>
<p><code>useEffect</code> 的执行时机是<strong>组件渲染完成后</strong>（浏览器绘制 DOM 之后），属于异步执行，不会阻塞浏览器的渲染，这一点与类组件的 <code>componentDidMount</code>/<code>componentDidUpdate</code> 一致。</p>
<h4 data-id="heading-5">不同依赖项的执行行为对比：</h4>






























<table><thead><tr><th>依赖项写法</th><th>执行时机</th><th>对应类组件生命周期</th></tr></thead><tbody><tr><td>无依赖项</td><td>每次组件渲染后（挂载 + 每次更新）</td><td>componentDidMount + componentDidUpdate</td></tr><tr><td>空数组 <code>[]</code></td><td>仅挂载时执行一次</td><td>componentDidMount</td></tr><tr><td>含依赖项 <code>[a, b]</code></td><td>挂载时执行 + 依赖项 a/b 变化时执行</td><td>自定义 componentDidUpdate</td></tr><tr><td>清理函数</td><td>卸载时执行 + 下一次副作用执行前执行</td><td>componentWillUnmount</td></tr></tbody></table>
<h3 data-id="heading-6">四、常见使用场景</h3>
<h4 data-id="heading-7">场景 1：仅挂载时执行（初始化）</h4>
<p>比如请求初始数据、添加全局事件监听：</p>
<pre><code class="hljs language-ini" lang="ini">import { useEffect, useState } from 'react'<span class="hljs-comment">;</span>

function UserList() {
  const <span class="hljs-section">[users, setUsers]</span> = useState(<span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 仅挂载时请求数据（对应 componentDidMount）
  useEffect(() =&gt; {
    const <span class="hljs-attr">fetchUsers</span> = async () =&gt; {
      const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'https://api.example.com/users'</span>)<span class="hljs-comment">;</span>
      const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
      setUsers(data)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
    fetchUsers()<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">; // 空依赖：仅执行一次</span>

  return (
    &lt;ul&gt;
      {users.map(<span class="hljs-attr">user</span> =&gt; (
        &lt;li <span class="hljs-attr">key</span>={user.id}&gt;{user.name}&lt;/li&gt;
      ))}
    &lt;/ul&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">场景 2：依赖项变化时执行</h4>
<p>比如根据输入关键词筛选数据、监听状态变化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [keyword, setKeyword] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [result, setResult] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-comment">// 关键词变化时请求数据</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!keyword) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 无关键词时不请求</span>

    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://api.example.com/search?kw=<span class="hljs-subst">${keyword}</span>`</span>);
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
      <span class="hljs-title function_">setResult</span>(data);
    }, <span class="hljs-number">300</span>); <span class="hljs-comment">// 防抖：300ms 后请求</span>

    <span class="hljs-comment">// 清理函数：取消定时器（关键词快速变化时避免无效请求）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer);
  }, [keyword]); <span class="hljs-comment">// 依赖：仅 keyword 变化时执行</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{keyword}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setKeyword(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{result.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">场景 3：清理副作用（卸载时）</h4>
<p>比如清除定时器、取消 WebSocket 订阅、解绑事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 挂载时启动定时器</span>
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-comment">// 清理函数：卸载时清除定时器（避免内存泄漏）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []); <span class="hljs-comment">// 仅挂载时执行</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 父组件控制 Timer 的挂载/卸载</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShow(!show)}&gt;Toggle Timer<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Timer</span> /&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">五、关键注意事项</h3>
<h4 data-id="heading-11">1. 依赖项必须完整</h4>
<p>React 会根据依赖项数组的<strong>浅比较</strong>判断是否执行副作用，若依赖项缺失：</p>
<ul>
<li>副作用可能无法触发（依赖项变化但未声明）；</li>
<li>或捕获到过时的 state/prop（闭包陷阱）。</li>
</ul>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">BadExample</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-comment">// 依赖 count，但未声明在数组中</span>
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 始终打印 0（闭包捕获初始值）</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 错误：缺失 count 依赖</span>

  return &lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;Click&lt;/<span class="hljs-selector-tag">button</span>&gt;;
}
</code></pre>
<p><strong>正例（正确）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">GoodExample</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 正确打印最新 count</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[count]</span>); <span class="hljs-comment">// 声明依赖 count</span>

  return &lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;Click&lt;/<span class="hljs-selector-tag">button</span>&gt;;
}
</code></pre>
<h4 data-id="heading-12">2. 副作用函数不能是 async 函数</h4>
<p><code>useEffect</code> 的第一个参数若返回清理函数，则不能直接用 <code>async</code>（因为 <code>async</code> 函数返回 Promise，而非清理函数）。</p>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(async () =&gt; {
  const res = await <span class="hljs-built_in">fetch</span>('/api/data');
  <span class="hljs-comment">// ...</span>
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 错误：async 函数返回 Promise，无法返回清理函数</span>
</code></pre>
<p><strong>正例（正确）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini">useEffect(() =&gt; {
  // 内部定义 async 函数
  const <span class="hljs-attr">fetchData</span> = async () =&gt; {
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'/api/data'</span>)<span class="hljs-comment">;</span>
    // ...
  }<span class="hljs-comment">;</span>
  fetchData()<span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-13">3. 避免无限循环</h4>
<p>若副作用中修改了依赖项，且依赖项未正确控制，会导致无限执行：</p>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">LoopExample</span>() {
  const <span class="hljs-selector-attr">[data, setData]</span> = <span class="hljs-built_in">useState</span>({});

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-comment">// 每次渲染都会创建新对象，依赖项浅比较为 false，触发无限执行</span>
    <span class="hljs-built_in">setData</span>({ name: 'test' });
  }, <span class="hljs-selector-attr">[data]</span>); <span class="hljs-comment">// 依赖 data，但修改了 data</span>

  return &lt;<span class="hljs-selector-tag">div</span>&gt;{data<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p><strong>解决方法</strong>：</p>
<ul>
<li>避免修改依赖项，或调整依赖项（如仅依赖必要字段）；</li>
<li>若必须修改，可使用函数式更新（<code>setData(prev =&gt; ({ ...prev, name: 'test' }))</code>）。</li>
</ul>
<h4 data-id="heading-14">4. 清理函数的执行时机</h4>
<p>清理函数不仅在组件卸载时执行，还会在<strong>下一次副作用执行前</strong>执行（比如依赖项变化时），用于清除上一次的副作用残留。</p>
<h3 data-id="heading-15">六、与类组件生命周期的对比</h3>

























<table><thead><tr><th>类组件生命周期</th><th>useEffect 实现方式</th></tr></thead><tbody><tr><td>componentDidMount</td><td><code>useEffect(() =&gt; { ... }, [])</code></td></tr><tr><td>componentDidUpdate</td><td><code>useEffect(() =&gt; { ... }, [dep1, dep2])</code></td></tr><tr><td>componentWillUnmount</td><td><code>useEffect(() =&gt; { return () =&gt; { ... } }, [])</code></td></tr><tr><td>合并三者</td><td><code>useEffect(() =&gt; { ... })</code>（无依赖项）</td></tr></tbody></table>
<h3 data-id="heading-16">总结</h3>
<p><code>useEffect</code> 的核心是<strong>声明式</strong>地处理副作用：</p>
<ol>
<li>通过依赖项数组控制执行时机，替代类组件的多个生命周期；</li>
<li>清理函数用于消除副作用的副作用（避免内存泄漏）；</li>
<li>依赖项必须完整且准确，避免闭包陷阱和无限循环；</li>
<li>异步逻辑需在副作用函数内部定义 <code>async</code> 函数，而非直接返回 Promise。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[吃透 npm、pnpm、npx：区别与实战用法全解析]]></title>    <link>https://juejin.cn/post/7590421489998168083</link>    <guid>https://juejin.cn/post/7590421489998168083</guid>    <pubDate>2026-01-03T13:03:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998168083" data-draft-id="7590159073988804660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="吃透 npm、pnpm、npx：区别与实战用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T13:03:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Maxkim"/> <meta itemprop="url" content="https://juejin.cn/user/2768993424260451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            吃透 npm、pnpm、npx：区别与实战用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2768993424260451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Maxkim
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:03:10.000Z" title="Sat Jan 03 2026 13:03:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>hello，大家新年快乐呀，最近在学习Vue源码时候，需要使用Monorepo进行包管理，结果运用到了“npx tsx --init”这个命令，于是我就开始疑惑为什么有的命令用 <code>npm i</code>，有的用 <code>pnpm add</code>，还有的要加 <code>npx</code> 前缀？于是便自己总结了如下的内容，分享给大家！</p>
</blockquote>
<h2 data-id="heading-0">一、先立核心认知：三者不是同一类工具</h2>
<p>很多人会把三者混为一谈，其实它们的定位天差地别！先看一张表快速 get 核心区别：</p>





























<table><thead><tr><th>工具名</th><th>核心定位</th><th>本质 / 所属关系</th><th>核心职责</th></tr></thead><tbody><tr><td><code>npm</code></td><td>Node.js 官方默认包管理器</td><td>随 Node.js 一同安装，官方标配</td><td>管理项目依赖（安装 / 卸载 / 更新 / 发布）</td></tr><tr><td><code>pnpm</code></td><td>高性能第三方替代包管理器</td><td>第三方工具，需手动安装</td><td>同 <code>npm</code> 核心职责，优化性能与磁盘占用</td></tr><tr><td><code>npx</code></td><td>Node 包执行工具</td><td>随 <code>npm@5.2.0+</code> 自带，非包管理器</td><td>执行 Node 包的可执行文件，不管理依赖</td></tr></tbody></table>
<p>划重点：<strong><code>npm</code> 和 <code>pnpm</code> 是「包管理器」，负责 “存放和管理依赖”；<code>npx</code> 是「执行工具」，负责 “运行依赖包”，三者不是同一维度的工具！</strong></p>
<h2 data-id="heading-1">二、逐个拆解：功能详解 + 代码示例</h2>
<h3 data-id="heading-2">1. npm：官方默认，稳字当头</h3>
<p><code>npm</code>（Node Package Manager）是前端开发者的入门标配，它的核心作用就是帮我们管理项目的依赖包，是生态最成熟、兼容性最好的包管理器。</p>
<h4 data-id="heading-3">核心功能（附代码示例）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c010baccff48848f77f0df48865660~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=TkbcibVbk5%2Faq%2BC5dVT3u5CQC8M%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">优点 &amp; 缺点</h4>
<ul>
<li>优点：兼容性拉满，无需额外配置，几乎支持所有 Node 项目，新手友好。</li>
<li>缺点：安装速度慢，磁盘占用高（嵌套 <code>node_modules</code>，依赖重复拷贝），部分场景会出现版本不一致问题，还可能产生幽灵依赖。</li>
</ul>
<h3 data-id="heading-5">2. pnpm：性能怪兽，省空间神器</h3>
<p><code>pnpm</code>（Performant npm）是针对 <code>npm</code> 痛点优化的第三方包管理器，核心功能和 <code>npm</code> 一致，但在「速度」和「磁盘占用」上实现了碾压级提升。而这一切的优势，都源于它的「全局缓存 + 硬链接 + 软链接」机制，同时它还能杜绝幽灵依赖。</p>
<h4 data-id="heading-6">核心优势（区别于 npm 的关键）</h4>
<ol>
<li><strong>安装速度超快</strong>：比 <code>npm</code> 快 2-5 倍，大型项目中差距更明显。</li>
<li><strong>极致省磁盘</strong>：采用「全局缓存 + 硬链接 / 符号链接」机制，同一个依赖的同一个版本，全局只存储 1 份，多个项目共享。比如：10 个项目都依赖 <code>react@18</code>，<code>npm</code> 会拷贝 10 份，<code>pnpm</code> 只存 1 份，大幅节省磁盘空间。</li>
<li><strong>杜绝幽灵依赖</strong>：<code>pnpm</code> 的 <code>node_modules</code> 结构更严谨，只有在 <code>package.json</code> 中声明的依赖才能被项目使用，避免隐式依赖问题。</li>
</ol>
<h4 data-id="heading-7">深度拆解：pnpm 核心机制（全局缓存 + 硬链接 + 软链接）</h4>
<p>在讲解之前，先给大家用通俗的语言解释两个概念，避免晦涩难懂：</p>
<ul>
<li><strong>硬链接（Hard Link）</strong> ：可以理解为「文件的副本快捷方式」,还可以直白理解成创建了一个word的副本，它和原文件共享同一份磁盘数据。比如你有一个文件 <code>A.txt</code>，给它创建一个硬链接 <code>B.txt</code>，修改 <code>A.txt</code> 内容，<code>B.txt</code> 也会同步变化；删除 <code>A.txt</code>，<code>B.txt</code> 依然可以正常使用（因为它指向的是磁盘数据，不是原文件本身）。</li>
<li><strong>软链接（Symbolic Link，也叫符号链接）</strong> ：可以理解为「Windows 的快捷方式 / Mac 的替身」，它本身不存储任何数据，只记录原文件的路径。比如给 <code>A.txt</code> 创建软链接 <code>C.txt</code>，打开 <code>C.txt</code> 其实是通过路径找到并打开 <code>A.txt</code>；如果删除 <code>A.txt</code>，<code>C.txt</code> 就会失效。</li>
<li><strong>全局缓存</strong>：<code>pnpm</code> 会在你的电脑上创建一个全局的缓存目录（Windows：<code>C:\Users&lt;用户名&gt;.pnpm-store</code>；Mac/Linux：<code>~/.pnpm-store</code>），所有通过 <code>pnpm</code> 下载的依赖包，都会先解压并存储到这个全局缓存中，同一个版本的依赖只存储一次。</li>
</ul>
<p>当你在项目中用 <code>pnpm add &lt;包名&gt;</code> 安装依赖时，<code>pnpm</code> 的工作流程是这样的：</p>
<ol>
<li>先检查全局缓存中是否存在该版本的依赖，如果不存在，就从 npm 仓库下载并存储到全局缓存；</li>
<li>在全局缓存中，给该依赖的文件创建「硬链接」到 <code>pnpm</code> 的虚拟存储目录；</li>
<li>在项目的 <code>node_modules</code> 中，创建「软链接」指向虚拟存储目录中的依赖文件；</li>
<li>最终项目的 <code>node_modules</code> 中，只有软链接，没有实际拷贝的依赖文件，实现了 “一份缓存，多项目共享”。</li>
</ol>
<p>通俗总结：<strong>全局缓存是 “仓库”，硬链接保证 “一份数据多处可用”，软链接负责 “项目找到依赖”，三者结合让 pnpm 既省空间又快。</strong></p>
<h4 data-id="heading-8">深度拆解：幽灵依赖（为什么 npm 有，pnpm 没有？）</h4>
<p>先明确：<strong>幽灵依赖（Phantom Dependency）就是项目中使用了没有在 <code>package.json</code> 中明确声明的依赖，但项目依然能正常运行的现象</strong>。</p>
<p>举个例子帮你理解：</p>
<ol>
<li>你在项目中用 <code>npm i react</code> 安装了 <code>react</code>，而 <code>react</code> 本身依赖 <code>react-dom</code>（这是 <code>react</code> 的依赖，不是你项目的直接依赖）；</li>
<li>由于 <code>npm</code> 会将所有依赖（直接依赖 + 间接依赖）扁平化到 <code>node_modules</code> 根目录，所以你在项目中即使没在 <code>package.json</code> 中声明 <code>react-dom</code>，也能直接导入并使用 <code>react-dom</code>；</li>
<li>这种情况就是幽灵依赖：你没明确安装 <code>react-dom</code>，却能使用它，看似方便，实则隐藏巨大风险 —— 如果某天 <code>react</code> 升级后不再依赖 <code>react-dom</code>，或者依赖的 <code>react-dom</code> 版本大幅变更，你的项目就会突然报错，难以排查。</li>
</ol>
<p>而 <code>pnpm</code> 为什么能杜绝幽灵依赖？因为 <code>pnpm</code> 的 <code>node_modules</code> 不是扁平化的，项目的 
<code>node_modules</code> 根目录下，只有你在 <code>package.json</code> 中明确声明的直接依赖，间接依赖会被放在虚拟存储目录中，项目无法直接访问未声明的间接依赖，自然就杜绝了幽灵依赖，让项目依赖更严谨、更可控。</p>
<h4 data-id="heading-9">核心功能（附代码示例，几乎兼容 npm 命令）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a3d17e711a649b294f667c8f7393b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=O8n4Odc5s5Qh2Y7TSecJ66GVeJ8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">优点 &amp; 缺点</h4>
<ul>
<li>优点：速度快、省磁盘、无幽灵依赖、完全兼容 <code>npm</code> 生态，依赖管理更严谨。</li>
<li>缺点：需要手动安装（非 Node 自带），极少数老旧项目可能存在兼容性问题（几乎可以忽略）。</li>
</ul>
<h3 data-id="heading-11">3. npx：包执行工具，告别全局安装</h3>
<p><code>npx</code> 最容易被误解为包管理器，但它<strong>根本不是用来管理依赖的</strong>，而是用来「执行 Node 包」的工具，解决了 <code>npm</code> 执行包的两大痛点。</p>
<h4 data-id="heading-12">解决的核心痛点</h4>
<ol>
<li>痛点 1：全局安装包容易导致版本冲突（比如 A 项目要 <code>create-react-app@5</code>，B 项目要 <code>create-react-app@4</code>）。</li>
<li>痛点 2：本地安装的包，无法直接在命令行执行（路径不在系统环境变量中）。</li>
</ol>
<h4 data-id="heading-13">核心功能（附代码示例，重点！）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bf9e7feb58c47ba9353c07d56a15f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=xpHjaKeUVp8SZoSzscjYINVFsxI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">核心特性</h4>
<ul>
<li>无需手动安装包，临时下载即执行。</li>
<li>优先使用本地包，避免版本冲突。</li>
<li>无需配置环境变量，自动识别可执行文件路径。</li>
</ul>
<h2 data-id="heading-15">三、实战场景：该用谁？怎么用？</h2>
<p>看完理论，我们结合实际开发场景，明确三者的使用选择：</p>








































<table><thead><tr><th>场景需求</th><th>推荐工具</th><th>命令示例</th></tr></thead><tbody><tr><td>新手入门、传统项目开发（追求兼容）</td><td>npm</td><td><code>npm i react</code>、<code>npm run dev</code></td></tr><tr><td>大型项目、多项目开发（追求性能 / 省空间 / 严谨性）</td><td>pnpm</td><td><code>pnpm add react</code>、<code>pnpm dev</code></td></tr><tr><td>临时执行脚手架（如 cra、vite）</td><td>npx</td><td><code>npx create-vite my-vite-app</code></td></tr><tr><td>临时运行 TS 文件、格式化代码等</td><td>npx</td><td><code>npx tsx src/index.ts</code>、<code>npx prettier --write .</code></td></tr><tr><td>执行本地安装的包（避免全局版本冲突）</td><td>npx</td><td><code>npx tsc --init</code>、<code>npx webpack</code></td></tr><tr><td>发布自己的 npm 包</td><td>npm/pnpm</td><td><code>npm publish</code>、<code>pnpm publish</code></td></tr></tbody></table>
<h2 data-id="heading-16">四、总结：核心区别一句话记牢</h2>
<ol>
<li><strong>身份差异</strong>：<code>npm</code>（官方包管理器）、<code>pnpm</code>（高性能包管理器）、<code>npx</code>（包执行工具，非包管理器）。</li>
<li><strong>职责差异</strong>：<code>npm</code>/<code>pnpm</code> 管「依赖的安装 / 卸载 / 管理」，<code>npx</code> 管「依赖的执行」。</li>
<li><strong>核心机制差异</strong>：<code>pnpm</code> 靠「全局缓存 + 硬链接 + 软链接」实现高性能和省磁盘，还能杜绝幽灵依赖；<code>npm</code> 无此机制，存在幽灵依赖风险。</li>
<li><strong>性能差异</strong>：<code>pnpm</code> &gt; <code>npm</code>（速度、磁盘占用全方位领先），<code>npx</code> 无此对比维度。</li>
<li><strong>使用差异</strong>：兼容优先用 <code>npm</code>，性能 / 严谨性优先用 <code>pnpm</code>，临时执行 / 避免版本冲突用 <code>npx</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义 Hooks 的用法和意义详解（结合案例）]]></title>    <link>https://juejin.cn/post/7590601860300619803</link>    <guid>https://juejin.cn/post/7590601860300619803</guid>    <pubDate>2026-01-03T13:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590601860300619803" data-draft-id="7590699877630558246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义 Hooks 的用法和意义详解（结合案例）"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-03T13:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义 Hooks 的用法和意义详解（结合案例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:13:45.000Z" title="Sat Jan 03 2026 13:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义 Hooks 的用法和意义详解（结合案例）</h2>
<h5 data-id="heading-1">一、什么是自定义 Hooks？</h5>
<p>自定义 Hooks 是 React 中<strong>复用状态逻辑</strong>的一种机制，本质是一个以<code>use</code>开头的函数，内部可以调用其他 Hooks（包括内置 Hooks 如<code>useState</code>、<code>useEffect</code>或其他自定义 Hooks）。它的核心作用是将组件中重复的状态管理、副作用处理等逻辑提取出来，实现逻辑复用，让组件更专注于 UI 渲染。</p>
<h5 data-id="heading-2">二、案例解析：自定义 Hooks 的实现与使用</h5>
<h6 data-id="heading-3">1. 案例 1：<code>useMouse</code>—— 封装鼠标位置监听逻辑</h6>
<p><strong>功能</strong>：实时获取鼠标在页面上的坐标，并在组件卸载时自动清除事件监听，避免内存泄漏。</p>
<h6 data-id="heading-4">（1）<code>useMouse</code>的实现（<code>useMouse.js</code>）</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>

<span class="hljs-comment">// 自定义Hooks必须以use开头</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useMouse</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 用useState保存鼠标坐标状态</span>
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 2. 用useEffect处理副作用（添加/清除鼠标移动事件）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 定义事件处理函数：更新鼠标坐标</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>); <span class="hljs-comment">// 更新x坐标</span>
      <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>); <span class="hljs-comment">// 更新y坐标</span>
    };

    <span class="hljs-comment">// 绑定鼠标移动事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);

    <span class="hljs-comment">// 3. 清除副作用：组件卸载时移除事件监听（防止内存泄漏）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);
    };
  }, []); <span class="hljs-comment">// 空依赖数组：只在组件挂载时执行一次</span>

  <span class="hljs-comment">// 4. 返回需要暴露的状态（鼠标坐标）</span>
  <span class="hljs-keyword">return</span> { x, y };
}
</code></pre>
<p>（2）<code>useMouse</code>的使用（<code>App.jsx</code>中的<code>MouseMove</code>组件）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MouseMove</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 直接调用自定义Hooks，获取鼠标坐标</span>
  <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>();
  
  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      鼠标位置: {x} {y} {/* 只专注于UI渲染，无需关心事件逻辑 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h6 data-id="heading-5">（3）逻辑解析</h6>
<ul>
<li><strong>复用性</strong>：如果其他组件也需要获取鼠标位置，直接调用<code>useMouse()</code>即可，无需重复编写事件绑定 / 清除逻辑。</li>
<li><strong>关注点分离</strong>：组件（<code>MouseMove</code>）只负责渲染 UI，鼠标监听的业务逻辑被封装在<code>useMouse</code>中，代码结构更清晰。</li>
<li><strong>避免内存泄漏</strong>：通过<code>useEffect</code>的返回函数清除事件监听，确保组件卸载后不再执行无用逻辑。</li>
</ul>
<h6 data-id="heading-6">2. 案例 2：<code>useTodos</code>—— 封装待办事项管理逻辑</h6>
<p><strong>功能</strong>：管理待办事项的增、删、改状态，并自动同步到<code>localStorage</code>（刷新页面后数据不丢失）。</p>
<h6 data-id="heading-7">（1）<code>useTodos</code>的实现（<code>useTodos.js</code>）</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span>; <span class="hljs-comment">// 本地存储的key（便于维护）</span>

<span class="hljs-comment">// 从localStorage加载待办事项</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadFromStorage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> storedTodos = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>);
  <span class="hljs-keyword">return</span> storedTodos ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(storedTodos) : [];
}

<span class="hljs-comment">// 保存待办事项到localStorage</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToStorage</span>(<span class="hljs-params">todos</span>) {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTodos</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 用useState初始化待办事项（从本地存储加载）</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(loadFromStorage);

  <span class="hljs-comment">// 2. 用useEffect同步数据到localStorage（todos变化时触发）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">saveToStorage</span>(todos);
  }, [todos]); <span class="hljs-comment">// 依赖todos：只有todos变化时才执行</span>

  <span class="hljs-comment">// 3. 定义添加待办事项的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>([
      ...todos,
      { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), text, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> } <span class="hljs-comment">// 生成新的待办项</span>
    ]);
  };

  <span class="hljs-comment">// 4. 定义切换待办事项完成状态的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> 
      todo.<span class="hljs-property">id</span> === id ? { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> } : todo
    ));
  };

  <span class="hljs-comment">// 5. 定义删除待办事项的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== id));
  };

  <span class="hljs-comment">// 6. 返回状态和方法（供组件使用）</span>
  <span class="hljs-keyword">return</span> { todos, addTodo, toggleTodo, deleteTodo };
}
</code></pre>
<p>（2）<code>useTodos</code>的使用（<code>App.jsx</code>）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useTodos } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useTodos.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoList.jsx'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoInput.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 调用自定义Hooks，获取待办事项的状态和操作方法</span>
  <span class="hljs-keyword">const</span> { todos, addTodo, toggleTodo, deleteTodo } = <span class="hljs-title function_">useTodos</span>();

  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {/* 传入addTodo方法给输入组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">addTodo</span>=<span class="hljs-string">{addTodo}/</span>&gt;</span>
      {/* 根据todos状态渲染列表或提示文本 */}
      {
        todos.length &gt; 0 ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> 
            <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span>
            <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span>
            <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
          /&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )
      }
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<h6 data-id="heading-8">（3）逻辑解析</h6>
<ul>
<li><strong>状态复用</strong>：待办事项的加载、保存、增删改逻辑被完全封装，任何需要待办功能的组件都可以通过<code>useTodos</code>复用。</li>
<li><strong>简化组件</strong>：<code>App</code>组件无需关心<code>localStorage</code>操作、状态更新细节，只需调用方法和渲染 UI，代码量大幅减少。</li>
<li><strong>一致性</strong>：所有与待办相关的逻辑集中管理，避免多处重复代码导致的维护问题（如修改存储 key 时只需改一处）。</li>
</ul>
<h5 data-id="heading-9">三、自定义 Hooks 的核心意义</h5>
<ol>
<li><strong>逻辑复用</strong>解决了类组件中 “混入（mixin）” 带来的命名冲突、依赖混乱等问题，通过函数调用的方式优雅复用状态逻辑（如<code>useMouse</code>和<code>useTodos</code>可在任意组件中重复使用）。</li>
<li><strong>关注点分离</strong>将组件中的 “业务逻辑”（如事件监听、数据存储）与 “UI 渲染” 分离，使组件更简洁，便于阅读和维护（组件只关心渲染，Hooks 只关心逻辑）。</li>
<li><strong>可测试性</strong>自定义 Hooks 是纯函数，可独立于组件进行单元测试，验证逻辑正确性（如测试<code>useTodos</code>的<code>addTodo</code>方法是否正确添加数据）。</li>
<li><strong>代码一致性</strong>团队中可通过自定义 Hooks 统一业务逻辑的实现方式（如所有数据持久化都用类似<code>useTodos</code>的模式），降低协作成本。</li>
</ol>
<h5 data-id="heading-10">四、自定义 Hooks 的使用规范</h5>
<ul>
<li>必须以<code>use</code>开头（如<code>useMouse</code>、<code>useTodos</code>），React 通过命名识别 Hooks，确保 Hooks 的规则（如只能在顶层调用）被遵守。</li>
<li>内部可以调用其他 Hooks（内置或自定义），但不能在条件语句、循环中调用（需遵循 React Hooks 的调用规则）。</li>
<li>必须返回组件需要的状态或方法（通常是对象或数组，便于解构使用）。</li>
</ul>
<p>通过上述案例可以看出，自定义 Hooks 是 React 中提升代码复用性和可维护性的重要手段，尤其在中大型应用中能显著减少重复代码，让逻辑更清晰。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 效率飞升术：3基础进阶小工具，少写 100 行循环]]></title>    <link>https://juejin.cn/post/7590676494924103718</link>    <guid>https://juejin.cn/post/7590676494924103718</guid>    <pubDate>2026-01-03T13:55:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590676494924103718" data-draft-id="7590699877630656550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 效率飞升术：3基础进阶小工具，少写 100 行循环"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-03T13:55:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 效率飞升术：3基础进阶小工具，少写 100 行循环
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:55:10.000Z" title="Sat Jan 03 2026 13:55:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还在手动写循环处理数据？Python 里这几个 “懒人神器”，看似基础却能直接拉高代码效率，新手也能秒上手！</p>
<h2 data-id="heading-0">1. <code>itertools</code> ：循环偷懒神器，少写 N 行重复代码</h2>
<p>处理迭代器时，<code>itertools</code> 里的方法能帮你实现各种花式循环，不用再手写嵌套逻辑。最常用的就是 <code>cycle</code>（无限循环）和 <code>chain</code>（拼接迭代器）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> itertools

<span class="hljs-comment"># 需求1：循环遍历列表，到末尾后从头再来</span>
colors = [<span class="hljs-string">"red"</span>, <span class="hljs-string">"green"</span>, <span class="hljs-string">"blue"</span>]
color_cycle = itertools.cycle(colors)

<span class="hljs-comment"># 取前5个元素（演示用，实际可无限取）</span>
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(color_cycle))
<span class="hljs-comment"># 输出：red green blue red green</span>

<span class="hljs-comment"># 需求2：拼接多个列表，避免创建新列表占用内存</span>
list1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
list2 = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
combined = itertools.chain(list1, list2)

<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> combined:
    <span class="hljs-built_in">print</span>(num, end=<span class="hljs-string">" "</span>)  <span class="hljs-comment"># 输出：1 2 3 4 5 6</span>
</code></pre>
<h2 data-id="heading-1">2. <code>collections.defaultdict</code> ：字典分组不翻车，告别 KeyError</h2>
<p>用普通字典分组时，得先判断键是否存在，而 <code>defaultdict</code> 能直接指定默认值类型，分组代码一步到位。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict

<span class="hljs-comment"># 需求：把学生按成绩等级分组</span>
students = [
    (<span class="hljs-string">"小明"</span>, <span class="hljs-string">"A"</span>),
    (<span class="hljs-string">"小红"</span>, <span class="hljs-string">"B"</span>),
    (<span class="hljs-string">"小刚"</span>, <span class="hljs-string">"A"</span>),
    (<span class="hljs-string">"小美"</span>, <span class="hljs-string">"B"</span>)
]

<span class="hljs-comment"># 传统字典写法：繁琐且易出错</span>
grade_dict = {}
<span class="hljs-keyword">for</span> name, grade <span class="hljs-keyword">in</span> students:
    <span class="hljs-keyword">if</span> grade <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> grade_dict:
        grade_dict[grade] = []
    grade_dict[grade].append(name)
<span class="hljs-built_in">print</span>(grade_dict)  <span class="hljs-comment"># {'A': ['小明', '小刚'], 'B': ['小红', '小美']}</span>

<span class="hljs-comment"># defaultdict 写法：简洁高效</span>
default_grade = defaultdict(<span class="hljs-built_in">list</span>)
<span class="hljs-keyword">for</span> name, grade <span class="hljs-keyword">in</span> students:
    default_grade[grade].append(name)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">dict</span>(default_grade))  <span class="hljs-comment"># 结果同上</span>
</code></pre>
<h2 data-id="heading-2">3. <code>enumerate</code> 进阶用法：自定义起始索引，循环更灵活</h2>
<p>基础的 <code>enumerate</code> 大家都会用，但自定义起始索引这个小细节，能让循环结果更贴合实际需求，不用再手动 <code>+1</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需求：打印学生排名，从1开始计数</span>
names = [<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>]

<span class="hljs-comment"># 基础用法：默认从0开始</span>
<span class="hljs-keyword">for</span> idx, name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(names):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{idx+<span class="hljs-number">1</span>}</span>名：<span class="hljs-subst">{name}</span>"</span>)  <span class="hljs-comment"># 手动+1，麻烦</span>

<span class="hljs-comment"># 进阶用法：指定start参数，直接从1开始</span>
<span class="hljs-keyword">for</span> idx, name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(names, start=<span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{idx}</span>名：<span class="hljs-subst">{name}</span>"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 第1名：张三</span>
<span class="hljs-comment"># 第2名：李四</span>
<span class="hljs-comment"># 第3名：王五</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">小总结</h3>
<ol>
<li><code>itertools</code> 能简化迭代器操作，减少重复循环代码；</li>
<li><code>defaultdict</code> 是字典分组的 “利器”，避免手动判断键是否存在；</li>
<li><code>enumerate</code> 指定 <code>start</code> 参数，能直接得到符合需求的索引。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>