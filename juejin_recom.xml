<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[大模型训练全流程实战指南基础篇（四）——本地部署大模型API调用实战：Python对接OpenAI格式全解析]]></title>    <link>https://juejin.cn/post/7597650322409291828</link>    <guid>https://juejin.cn/post/7597650322409291828</guid>    <pubDate>2026-01-22T02:49:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322409291828" data-draft-id="7596905015367073792" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型训练全流程实战指南基础篇（四）——本地部署大模型API调用实战：Python对接OpenAI格式全解析"/> <meta itemprop="keywords" content="人工智能,DeepSeek,LangChain"/> <meta itemprop="datePublished" content="2026-01-22T02:49:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型训练全流程实战指南基础篇（四）——本地部署大模型API调用实战：Python对接OpenAI格式全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:49:11.000Z" title="Thu Jan 22 2026 02:49:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上篇内容 <a href="https://juejin.cn/post/7595896809652437032" target="_blank" title="https://juejin.cn/post/7595896809652437032">大模型训练全流程实战指南基础篇（三）——大模型本地部署实战（Vllm与Ollama）</a> 面向生产环境的 <strong>VLLM</strong> 部署与适合个人快速体验的轻量级 <strong>Ollama</strong> 两种大模型本地部署方案，并提供了从环境配置到代码实现的完整实战流程。相信大家已经掌握了本地部署大模型的方法，并在算力平台上成功部署了自己的模型服务。</p>
<p>部署好的模型就像一台已经启动的引擎，接下来关键在于学会如何调用它，使其真正成为大家处理任务、开发应用的得力工具。无论是自动化数据处理、训练后模型的集成调用，还是基于大模型构建应用程序，掌握通过代码调用大模型 API 的能力都是必不可少的核心技能。</p>
<p>上期文章中笔者初步展示了使用 OpenAI 格式调用大模型的代码示例。本期笔者将进一步深入，不仅知其然，更要知其所以然，为大家系统解析 <strong>Python 通过 OpenAI 格式调用本地大模型的全流程攻略</strong>。</p>
<h2 data-id="heading-1">一、OpenAI协议：大模型对话的通用语言</h2>
<h3 data-id="heading-2">1.1 什么是OpenAI格式？</h3>
<p>如今的大模型就像是一个功能强大的“万能API”，能够通过简单的接口调用即可实现诗歌创作、问题解答、代码编写甚至哲学思辨等复杂任务。实现这一切的关键，在于一套标准化的调用方式——即笔者今天要深入介绍的 <strong>OpenAI格式</strong>。</p>
<p>OpenAI格式如今已成为绝大多数主流大模型API调用的事实标准，它如同AI领域的“通用语言”或“普通话”，使得不同厂商、不同架构的大模型能够以统一的通信方式与用户交互，极大地降低了开发者的学习和集成成本。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d2e6e75cf5a459baa838d3f7c106f09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=ZtiFQArFX2Qvse5zkYrQkWpSVMA%3D" alt="0.png" loading="lazy"/></p>
<h3 data-id="heading-3">1.2 OpenAI协议的核心：标准化传输格式与消息规范</h3>
<p>OpenAI协议本身并不复杂，它本质上是在传统HTTP协议基础上封装的一套专用规范，明确规定了与大模型交互时<strong>请求应包含的参数结构</strong>与<strong>响应要返回的数据格式</strong>。</p>
<h4 data-id="heading-4">1.2.1 请求参数详解</h4>
<p>一个典型的OpenAI格式请求主要包含以下核心参数：</p>
<ol>
<li><strong>base_url</strong>：大模型服务的API地址。</li>
<li><strong>api_key</strong>：用于身份验证和权限控制的密钥（本地部署时可简化或省略）。</li>
<li><strong>messages</strong>：<strong>核心的参数</strong>，以列表形式定义了完整的对话上下文。列表中的每个元素都是一个消息对象，包含<code>role</code>和<code>content</code>两个基本字段。消息中的<code>role</code>（角色）主要分为以下几种类型，共同构成多轮对话的逻辑结构：
<ul>
<li><code>system</code>：系统指令，用于设定模型的背景、行为或身份（例如：“你是一个乐于助人的AI助手”）。</li>
<li><code>user</code>：用户输入的问题或指令。</li>
<li><code>assistant</code>：模型之前的回复记录，用于维持对话历史。</li>
<li><code>tool</code>（扩展角色）：与下文提到的函数调用（Function Calling）功能配套使用。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-5">扩展：Function Calling与<code>tool</code>角色</h5>
<p>随着大模型能力演进，OpenAI格式扩展了<strong>函数调用（Function Calling）</strong>  能力，使模型能够理解并请求调用外部工具或函数。这引入了两个新的关键字段：</p>
<ul>
<li><strong><code>tool_calls</code></strong>：通常出现在<code>assistant</code>返回的消息中，模型通过此字段声明它希望调用哪些函数，并给出调用参数。</li>
<li><strong><code>tool</code></strong> 角色消息：当用户（或系统）根据模型的<code>tool_calls</code>执行了相应函数后，需要将执行结果以<code>tool</code>角色消息的形式反馈给模型。此消息除了<code>role</code>和<code>content</code>（函数执行结果）外，还必须包含 <code>tool_call_id</code>，用于关联先前的函数调用请求。</li>
</ul>
<blockquote>
<p><strong>提示</strong>：Function Calling是构建智能体（Agent）和实现复杂应用的基础。本系列后续将推出专门内容，深入探讨如何训练和增强大模型的函数调用与指令遵循能力。如果大家想提前了解其应用，可以参考笔者的往期文章《<a href="https://juejin.cn/post/7486323379474645027" target="_blank" title="https://juejin.cn/post/7486323379474645027">从0到1开发DeepSeek天气助手智能体——你以为大模型只会聊天？Function Calling让它“上天入地”</a>》。</p>
</blockquote>
<h4 data-id="heading-6">1.2.2 响应返回格式</h4>
<p>根据调用时是否启用流式传输（<code>stream</code>），大模型的响应格式分为两种：</p>
<p><strong>1. 非流式响应</strong><br/>
一次性接收完整的模型回复，返回一个完整的 <code>chat completion</code> 对象，主要字段包括：</p>
<ul>
<li><code>id</code>：本次会话的唯一标识符。</li>
<li><code>choices</code>：一个列表，其中<code>message</code>对象的<code>content</code>字段包含了模型的完整回复文本（Function calling的<code>message</code>对象中包括<code>tool_calls</code>内容）。</li>
<li><code>created</code>：响应生成的时间戳。</li>
<li><code>model</code>：所使用模型的名称。</li>
<li><code>usage</code>：本次请求的令牌消耗统计，包括提示（prompt）和生成（completion）的token数量。</li>
</ul>
<p><strong>2. 流式响应</strong><br/>
以数据流（Stream）的形式逐块（chunk）返回结果，用户体验更佳，能实时看到生成过程。返回的是多个 <code>chat completion chunk</code> 对象序列。其结构与上述对象类似，但核心区别在于：</p>
<ul>
<li><code>choices</code> 列表中的 <code>delta</code> 字段：它包含模型<strong>最新生成</strong>的增量内容（如<code>content</code>），而非完整消息。例如，第一个chunk的<code>delta.content</code>可能是“Hel”，第二个是“lo”，最终拼接成“Hello”。</li>
</ul>
<p>通过理解上述请求与响应的标准格式，大家便掌握了使用OpenAI格式与大模型对话的“语法”，这是进行一切后续开发工作的基石。</p>
<h2 data-id="heading-7">二、大模型API调用实战</h2>
<h3 data-id="heading-8">2.1 模型部署</h3>
<p>经过前面的理论讲解，相信大家对OpenAI请求格式已经有了初步的认识。然而，要真正掌握它，动手实践是关键的第一步。首先需要在本地环境中部署一个可用的大模型。</p>
<p>部署大模型对计算资源（尤其是GPU显存）确实有一定要求。为了降低大家的学习门槛，笔者与国内主流云平台合作，为大家争取了体验资源。您可以点击此链接 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lab4ai.cn%2Fregister%3FagentID%3Duser-XorgKKc56U" target="_blank" title="https://www.lab4ai.cn/register?agentID=user-XorgKKc56U" ref="nofollow noopener noreferrer">www.lab4ai.cn/register?ag…</a> 领取 <strong>H100 GPU 6.5小时</strong>的免费算力，用于完成本篇及本系列所有实战内容。</p>
<ol>
<li>
<p><strong>创建实例：</strong>  打开<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.lab4ai.cn%2Fhome" title="https://link.juejin.cn/?target=https%3A%2F%2Fwww.lab4ai.cn%2Fhome" target="_blank">Lab4AI官网</a>，创建一个新的 VS Code 云实例。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/402c7e10566a4b3ab8fb3be45ecc0f1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=Kq%2FsnznH6zPwFw%2BxDFiQsFNWaaw%3D" alt="1.png" loading="lazy"/></p>
</li>
<li>
<p><strong>选择镜像：</strong>  在创建实例的页面，选择包含必要模型和环境的镜像，完成实例创建。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8700ff02665f4f04a5fda43d13af5e6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=1eZQDQA8QzxsZKHyy4tUSA3f2B4%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d82e92b06643e3a3dded50a90d1386~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=LmYVwtNCuKJ7VOTD6OKPAB1jn0g%3D" alt="3.png" loading="lazy"/></p>
</li>
<li>
<p><strong>查看预置模型:</strong> Lab4AI平台非常贴心在大家启动的实例中已预置了部分常用模型。可以在 VS Code 终端的命令行中执行 <code>cd /shared-only/models</code> 来查看。</p>
</li>
<li>
<p><strong>启动 vLLM 服务:</strong> 笔者这里同样使用了<a href="https://juejin.cn/post/7595896809652437032#heading-5" target="_blank" title="https://juejin.cn/post/7595896809652437032#heading-5">大模型训练全流程实战指南基础篇（三）——大模型本地部署实战（Vllm与Ollama）</a>中所讲的vllm 部署方方式，同样使用Qwen-4B来测试部署 <code>vllm serve ./Qwen3-4B/ --served-model-name Qwen3-4B --api-key 111 --max-model-len 32768 --gpu-memory-utilization 0.9 --port 6666</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/702e11220f314d0a894b6f285c86905f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=Vd5bc8WyvKsCYNV6b9GKDT2zWqU%3D" alt="6.png" loading="lazy"/></p>
</li>
</ol>
<p>服务成功启动后模型就处于待命状态了。接下来笔者将使用Python代码来调用它。</p>
<h3 data-id="heading-9">2.2 Requests库底层实现</h3>
<p>为了帮助大家“知其然，更知其所以然”，笔者先不直接使用封装好的<code>openai</code>库，而是从更底层的<code>requests</code>库开始，亲手实现一遍API调用流程。</p>
<ol>
<li><strong>导入相关依赖:</strong></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time
</code></pre>
<ol start="2">
<li><strong>定义OpenAI客户端类：</strong> 该类构造函数接收API的基础URL和密钥。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenAI</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, base_url, api_key</span>):
        self.api_key = api_key
        self.base_url = base_url
        self.headers = {
            <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{api_key}</span>"</span>,
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
        }
</code></pre>
<ol start="3">
<li><strong>构造请求方法：</strong> 按照笔者上面分享的OpenAI格式规范组装请求参数并发起POST请求。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_request</span>(<span class="hljs-params">self, model, messages</span>):
    url = <span class="hljs-string">f"<span class="hljs-subst">{self.base_url}</span>/chat/completions"</span>

    <span class="hljs-comment"># 默认参数</span>
    payload = {
        <span class="hljs-string">"model"</span>: model,
        <span class="hljs-string">"messages"</span>: messages,
        <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>,  <span class="hljs-comment"># 非流式</span>
        <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">2048</span>,
        <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.7</span>,
        <span class="hljs-string">"top_p"</span>: <span class="hljs-number">1.0</span>,
    }

    response = requests.post(
        url,
        headers=self.headers,
        json=payload,
    )

    <span class="hljs-keyword">return</span> response
</code></pre>
<p><strong>参数说明</strong>：</p>
<ul>
<li><code>model</code>, <code>messages</code> 是核心参数。</li>
<li><code>temperature</code>（温度）：控制输出的随机性。值越高（如0.8），输出越富有创意和多样性；值越低（如0.2），输出越确定和保守。</li>
<li><code>top_p</code>（核采样）：另一种控制多样性的方式。它从累积概率超过p的最小词集中采样。值越低，输出越集中和可预测，值越高输出结果越严谨</li>
</ul>
<p>大家可以回顾<a href="https://juejin.cn/post/7594728203258347554" target="_blank" title="https://juejin.cn/post/7594728203258347554">大模型训练全流程实战指南基础篇（二）——大模型文件结构解读与原理解析</a>中介绍的Modelscope Qwen3-4B文件列表， 这些参数通常可以在模型文件中的 <code>generation_config.json</code> 里找到默认值。若想复现论文或特定效果，应确保参数与配置文件一致。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9b72537a5fb46a0b731cbdbe7cc5f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=AO%2BYZcVchFGXcTFnRfMgR%2BH%2B5tc%3D" alt="4.png" width="70%" loading="lazy"/></p>
<ol start="4">
<li><strong>解析响应结果：</strong> 根据OpenAI响应格式，从返回的JSON中提取关键信息。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_response</span>(<span class="hljs-params">self, result</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-string">"choices"</span> <span class="hljs-keyword">in</span> result <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(result[<span class="hljs-string">"choices"</span>]) &gt; <span class="hljs-number">0</span>:
        message = result[<span class="hljs-string">"choices"</span>][<span class="hljs-number">0</span>].get(<span class="hljs-string">"message"</span>, {})
        content = message.get(<span class="hljs-string">"content"</span>, <span class="hljs-string">""</span>)
        finish_reason = result[<span class="hljs-string">"choices"</span>][<span class="hljs-number">0</span>].get(<span class="hljs-string">"finish_reason"</span>, <span class="hljs-string">""</span>)

        <span class="hljs-comment"># 提取使用情况</span>
        usage = result.get(<span class="hljs-string">"usage"</span>, {})
        prompt_tokens = usage.get(<span class="hljs-string">"prompt_tokens"</span>, <span class="hljs-number">0</span>)
        completion_tokens = usage.get(<span class="hljs-string">"completion_tokens"</span>, <span class="hljs-number">0</span>)
        total_tokens = usage.get(<span class="hljs-string">"total_tokens"</span>, <span class="hljs-number">0</span>)

        <span class="hljs-comment"># 显示结果</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ Tokens使用: 提示=<span class="hljs-subst">{prompt_tokens}</span>, 完成=<span class="hljs-subst">{completion_tokens}</span>, 总计=<span class="hljs-subst">{total_tokens}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✓ 完成原因: <span class="hljs-subst">{finish_reason}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"模型回复:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
        <span class="hljs-built_in">print</span>(content)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

        <span class="hljs-comment"># 返回完整响应</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: content,
            <span class="hljs-string">"role"</span>: message.get(<span class="hljs-string">"role"</span>, <span class="hljs-string">"assistant"</span>),
            <span class="hljs-string">"finish_reason"</span>: finish_reason,
            <span class="hljs-string">"usage"</span>: usage,
            <span class="hljs-string">"full_response"</span>: result
        }
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"响应中没有找到有效内容"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<ol start="5">
<li><strong>整合聊天方法：</strong> 将请求与解析过程整合，提供简洁的<code>chat</code>接口。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_completion</span>(<span class="hljs-params">self,  model, messages</span>):
    <span class="hljs-comment"># 发送请求</span>
    response = self.make_request(model, messages)
    <span class="hljs-built_in">print</span>(response)
    <span class="hljs-comment"># 检查响应状态</span>
    <span class="hljs-keyword">if</span> response.status_code != <span class="hljs-number">200</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"HTTP错误: <span class="hljs-subst">{response.status_code}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误信息: <span class="hljs-subst">{response.text}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-comment"># 解析响应</span>
    result = response.json()
    <span class="hljs-keyword">return</span> self.extract_response(result)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">self,  model, messages</span>):
    <span class="hljs-comment"># 调用API</span>
    result = self.chat_completion(model, messages)

    <span class="hljs-keyword">if</span> result:
        <span class="hljs-keyword">return</span> result[<span class="hljs-string">"content"</span>]
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<ol start="6">
<li><strong>执行测试：</strong> 创建客户端，发起一次简单的对话。运行成功！可以看到代码不仅正确输出了模型回复，还显示了详细的用量分析：用户输入消耗18个token，模型输出消耗135个token，总计153个token。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 替换为你的API Key</span>
    base_url = <span class="hljs-string">'http://localhost:6666/v1'</span>
    API_KEY = <span class="hljs-string">"111"</span>
    model = <span class="hljs-string">'Qwen3-4B'</span>

    <span class="hljs-comment"># 创建客户端</span>
    client = OpenAI(base_url, API_KEY)

    messages = [
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个小助手"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>}
    ]

    response = client.chat(model,messages)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21836c693b3f44dfaf87e0c7c2c5895a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=L6Drswe3J2ZHjwJZuq4HzUkXLWg%3D" alt="5.png" loading="lazy"/></p>
<h3 data-id="heading-10">2.3 openai库实现</h3>
<p>使用<code>requests</code>库进行底层实现虽然有助于理解原理，但过程稍显繁琐。官方<code>openai</code>库已经封装了所有这些逻辑。对比一下，使用<code>openai</code>库实现相同功能仅需寥寥数行：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
client = OpenAI(base_url=<span class="hljs-string">"http://localhost:6666/v1"</span>, api_key=<span class="hljs-string">"111"</span>)
messages = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个小助手"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>}
]
response = client.chat.completions.create(model=<span class="hljs-string">"Qwen3-4B"</span>, messages=messages)
<span class="hljs-built_in">print</span>(response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<p>运行结果与上小节的底层实现完全一致，但代码简洁性有了质的飞跃:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d481297e6806453eb0bfcb7135b03308~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=aQ%2BwAF5neMUg9ze4Xd0ROlxFs%2BI%3D" alt="7.png" loading="lazy"/></p>
<p>通过对比大家可以清晰地看到：<strong><code>openai</code>库的本质，就是对符合OpenAI格式标准的HTTP请求/响应进行高度封装，提供了一套优雅、易用的Python接口。</strong>  理解其底层原理，能帮助大家在遇到问题时进行有效调试，并在需要时进行灵活的定制化开发。</p>
<h2 data-id="heading-11">三、构建多轮对话机器人</h2>
<p>许多人可能好奇，像ChatBox、CherryStudio这类应用是如何实现多轮对话功能的。其实，其核心逻辑并不复杂。通过分析其通信过程可以发现，关键在于<strong>妥善维护对话历史</strong>并有效利用大模型自身的上下文理解能力。</p>
<p>接下来笔者将带领大家实现一个运行在命令行环境中的多轮对话机器人。结合之前讲解的知识，并引入<strong>流式调用</strong>，让大家直观感受其实时输出的效果，并理解其背后的请求与响应格式。</p>
<ol>
<li><strong>导入依赖并初始化客户端：</strong> 引入必要的库并配置好连接本地模型的客户端。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># 初始化客户端</span>
client = OpenAI(base_url=<span class="hljs-string">"http://localhost:6666/v1"</span>, api_key=<span class="hljs-string">"111"</span>)
</code></pre>
<ol start="2">
<li><strong>设计交互界面：</strong> 为程序添加一个简单的命令行引导界面，说明基本操作。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"欢迎使用多轮对话机器人！(流式输出版)"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入 'exit' 或 'quit' 退出程序"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入 'clear' 或 'reset' 清除对话历史"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
</code></pre>
<ol start="3">
<li><strong>实现核心对话循环</strong><br/>
这里是程序的核心，主要实现两个关键机制：</li>
</ol>
<ul>
<li><strong>多轮对话历史维护</strong>：每次对话都将用户输入和AI回复完整地追加到 <code>messages</code> 列表中，并在下次请求时发送整个历史。大模型经过专门训练，能够基于完整的上下文进行连贯回复。</li>
<li><strong>流式调用处理</strong>：通过设置 <code>stream=True</code> 启用流式响应。响应内容不再是一次性返回的完整消息，而是通过一系列数据块（chunk）逐步返回，每个块的增量内容（<code>delta.content</code>）需要被拼接起来，直到收到结束信号。</li>
</ul>
<pre><code class="hljs language-python" lang="python">messages = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个友好的AI助手，乐于帮助用户解决问题。"</span>}
]
turn_count = <span class="hljs-number">1</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-keyword">try</span>:
        user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">f"\n[第<span class="hljs-subst">{turn_count}</span>轮] 你: "</span>).strip()
        <span class="hljs-keyword">if</span> user_input.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">'exit'</span>, <span class="hljs-string">'quit'</span>, <span class="hljs-string">'退出'</span>]:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"再见！"</span>)
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">if</span> user_input.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">'clear'</span>, <span class="hljs-string">'reset'</span>, <span class="hljs-string">'清除'</span>, <span class="hljs-string">'重置'</span>]:
            messages = [
                {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个友好的AI助手，乐于帮助用户解决问题。"</span>}
            ]
            turn_count = <span class="hljs-number">1</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"对话历史已清除，开始新的对话"</span>)
            <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_input:
            <span class="hljs-keyword">continue</span>
        messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_input})
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nAI: "</span>, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 流式请求</span>
            full_response = <span class="hljs-string">""</span>
            stream = client.chat.completions.create(
                model=<span class="hljs-string">"Qwen3-4B"</span>,
                messages=messages,
                stream=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 启用流式输出</span>
                max_tokens=<span class="hljs-number">1000</span>
            )
            <span class="hljs-comment"># 逐块处理响应</span>
            <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> stream:
                <span class="hljs-keyword">if</span> chunk.choices[<span class="hljs-number">0</span>].delta.content <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                    content = chunk.choices[<span class="hljs-number">0</span>].delta.content
                    <span class="hljs-built_in">print</span>(content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
                    full_response += content
            <span class="hljs-built_in">print</span>()  <span class="hljs-comment"># 换行</span>
            <span class="hljs-comment"># 将AI回复添加到消息列表</span>
            <span class="hljs-keyword">if</span> full_response:
                messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: full_response})
                turn_count += <span class="hljs-number">1</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n请求出错: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">if</span> messages <span class="hljs-keyword">and</span> messages[-<span class="hljs-number">1</span>][<span class="hljs-string">"role"</span>] == <span class="hljs-string">"user"</span>:
                messages.pop()
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n程序被中断，再见！"</span>)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">except</span> EOFError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n检测到文件结束，再见！"</span>)
        <span class="hljs-keyword">break</span>
</code></pre>
<ol start="4">
<li><strong>运行测试：</strong> 运行程序进行测试。在第一轮对话中笔者告诉AI“我的名字是苍井空”。在第二轮中，当笔者问“我叫什么名字？”时，大模型能够成功回忆起上下文，给出正确答复。这演示了大模型的多轮对话能力，也是众多聊天应用的基础。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53f05b47e8e8499f9adaacd3f295f80c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=rNGQeM5MJjtKhN4dDpeU6oHawV0%3D" alt="8.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48aef170772e4b95becd3bd0549468de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769654951&amp;x-signature=gPsc%2BhOoMHVxJ8z2jHRh4pdyiLw%3D" alt="9.png" loading="lazy"/></p>
<p>以上就是笔者今天分享的全部内容啦！本教程示例代码可以关注笔者同名公众号：<strong>大模型真好玩</strong>，并私信<strong>大模型训练</strong>免费获得。</p>
<p>要想完全学懂还是需要亲手实践一下，大家可以照着笔者的教程亲手实践一遍。为降低大家学习门槛，笔者与国内主流云平台合作，大家可以通过打开链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lab4ai.cn%2Fregister%3FagentID%3Duser-XorgKKc56U" target="_blank" title="https://www.lab4ai.cn/register?agentID=user-XorgKKc56U" ref="nofollow noopener noreferrer">www.lab4ai.cn/register?ag…</a> ，体验<strong>H100 GPU 6.5小时</strong>的算力。本系列所有实战教程均将在该平台上完成，帮助大家低成本上手实践。</p>
<h2 data-id="heading-12">四、总结</h2>
<p>本文系统分享了如何通过OpenAI格式调用本地大模型。首先解析了作为行业标准的OpenAI协议，详细说明了请求与响应的数据结构。接着通过实战演示，从使用requests库底层实现到调用openai库简化操作，完整展示了API对接流程，并构建了支持流式输出的多轮对话机器人，让开发者能够快速掌握大模型集成与应用开发的核心技能。</p>
<p>在对大模型的基础知识有了一定了解之后，从下一期开始将正式进入本系列的<strong>工具篇</strong>。笔者将带领大家一同梳理训练大模型的完整步骤，并深入介绍每个环节所需的<strong>核心工具与平台</strong>。大家敬请期待！</p>
<p>大模型训练对计算资源有一定要求，尤其是GPU显存。为降低学习门槛，笔者与国内主流云平台合作，大家可以通过打开链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lab4ai.cn%2Fregister%3FagentID%3Duser-XorgKKc56U" target="_blank" title="https://www.lab4ai.cn/register?agentID=user-XorgKKc56U" ref="nofollow noopener noreferrer">www.lab4ai.cn/register?ag…</a> ，体验<strong>H100 GPU 6.5小时</strong>的算力。本系列所有实战教程均将在该平台上完成，帮助大家低成本上手实践。</p>
<p>除大模型训练外，笔者也在同步更新<a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>免费专栏，要说明该专栏适合所有对 LangChain 感兴趣的学习者，无论之前是否接触过 LangChain。该专栏基于笔者在实际项目中的深度使用经验，系统讲解了使用LangChain/LangGraph如何开发智能体，目前已更新 37 讲，并持续补充实战与拓展内容。欢迎感兴趣的同学关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号<strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何从零用WebGPU渲染二次元MMD人物模型]]></title>    <link>https://juejin.cn/post/7597708846769831974</link>    <guid>https://juejin.cn/post/7597708846769831974</guid>    <pubDate>2026-01-21T21:46:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597708846769831974" data-draft-id="7597623395908370478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何从零用WebGPU渲染二次元MMD人物模型"/> <meta itemprop="keywords" content="前端,计算机图形学"/> <meta itemprop="datePublished" content="2026-01-21T21:46:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AmyangXYZ"/> <meta itemprop="url" content="https://juejin.cn/user/8451824037687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何从零用WebGPU渲染二次元MMD人物模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451824037687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AmyangXYZ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T21:46:12.000Z" title="Wed Jan 21 2026 21:46:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何使用 WebGPU 从零开始渲染动漫角色</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d236f6c2c69a491186ebc9713f15aef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15YW5nWFla:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769636771&amp;x-signature=cBD4nmuJh1yBZY67DuU8NEvvXog%3D" alt="https___dev-to-uploads.s3.amazonaws.com_uploads_articles_it9bc1oir7p31cuzkqn0.webp" loading="lazy"/></p>
<h3 data-id="heading-1">简介</h3>
<p>原文: <a href="https://link.juejin.cn?target=https%3A%2F%2Freze.one%2Ftutorial" target="_blank" title="https://reze.one/tutorial" ref="nofollow noopener noreferrer">reze.one/tutorial</a></p>
<p>如果你用过 three.js、babylon.js 这些框架，知道怎么加载模型、设置相机、加光照，但搞不清楚底层到底发生了什么；或者你看了 WebGPU 的 "Hello Triangle" 示例，还是不知道怎么从零开始渲染一个真正的 3D 角色——那这个教程就是为你准备的。</p>
<p>我们会用五个步骤，从最简单的三角形开始，一步步做到一个完整贴图、能动的动漫角色。在这个过程中，你会学到完整的渲染管线：几何缓冲区、相机变换、材质纹理、骨骼动画，还有把它们串起来的渲染循环。</p>
<p>重点不在数学或着色器代码（这些可以交给 AI），而在理解 WebGPU 的思维模型：<strong>有哪些组件</strong>（缓冲区、绑定组、管线、渲染通道），<strong>它们怎么连起来</strong>（数据怎么流转），<strong>为什么要这样设计</strong>（什么时候用 uniform 缓冲区，什么时候用 storage 缓冲区）。最后你会得到一个能跑的渲染器，也能看懂 <a href="https://link.juejin.cn?target=https%3A%2F%2Freze.one" target="_blank" title="https://reze.one" ref="nofollow noopener noreferrer">Reze Engine</a> 这种引擎是怎么做的。完整代码在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial" ref="nofollow noopener noreferrer">这里</a>。</p>
<hr/>
<h3 data-id="heading-2">Engine v0: 你的第一个三角形</h3>
<p>先从经典的 Hello Triangle 开始。虽然很基础，但它展示了 WebGPU 管线的所有基本组件。理解了这些组件怎么连起来，后面做复杂模型就只是加数据，不需要学新概念了。</p>
<h4 data-id="heading-3">理解 GPU 作为独立的计算单元</h4>
<p>高级框架把底层细节都藏起来了，但 WebGPU 需要你直接跟 GPU 打交道。可以把 GPU 想象成另一台电脑，有自己的内存和指令集。不像 JavaScript 里直接传数据给函数，用 GPU 得跨边界通信，你得明确告诉它：</p>
<ul>
<li><strong>要处理什么</strong>：顶点数据</li>
<li><strong>数据在哪</strong>：缓冲区（buffer），就是 GPU 内存里的一块区域，类似 ArrayBuffer</li>
<li><strong>怎么处理</strong>：着色器和管线，告诉 GPU 怎么转换和渲染</li>
<li><strong>从哪开始</strong>：渲染通道，执行渲染的命令队列</li>
</ul>
<p>简单说，高级框架你操作的是 Mesh、Material、Scene 这些对象，WebGPU 里你操作的是 Buffer、Texture、Pipeline 这些底层资源。</p>
<h4 data-id="heading-4">WebGPU 初始化模式</h4>
<p>第一个 Engine 类 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial%2Fengines%2Fv0.ts" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial/engines/v0.ts" ref="nofollow noopener noreferrer"><code>engines/v0.ts</code></a> 按标准的 WebGPU 初始化流程来：</p>
<ol>
<li>请求 GPU 设备，在画布上创建渲染上下文</li>
<li>创建 GPU 缓冲区，把 3 个顶点的位置数据写进去（用 <code>writeBuffer</code>）</li>
<li>写着色器：
<ul>
<li>顶点着色器：处理每个顶点，把 3D 坐标转成屏幕坐标</li>
<li>片段着色器：决定每个像素的颜色</li>
</ul>
</li>
<li>创建渲染管线：把着色器和缓冲区布局打包在一起</li>
<li>创建渲染通道：执行管线，在屏幕上画出三角形</li>
</ol>
<h4 data-id="heading-5">顶点缓冲区</h4>
<p>顶点缓冲区存的是顶点位置数据。创建步骤：</p>
<ul>
<li>用 <code>device.createBuffer()</code> 创建缓冲区</li>
<li>指定 <code>GPUBufferUsage.VERTEX</code> 标志</li>
<li>用 <code>device.queue.writeBuffer()</code> 把数据从 CPU 传到 GPU</li>
</ul>
<h4 data-id="heading-6">着色器</h4>
<p>着色器用 WGSL 写，在 GPU 上跑：</p>
<ul>
<li><strong>顶点着色器</strong>：每个顶点跑一次，输出屏幕位置</li>
<li><strong>片段着色器</strong>：每个像素跑一次，输出颜色</li>
</ul>
<h4 data-id="heading-7">渲染管线</h4>
<p>渲染管线把着色器、顶点布局、渲染状态打包在一起，定义：</p>
<ul>
<li>用哪些着色器</li>
<li>顶点数据格式（位置、法线、UV 等）</li>
<li>片段怎么混合和测试（深度测试、混合模式等）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e849d74b02e4778bc49f9f5f0ed6152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15YW5nWFla:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769636771&amp;x-signature=EU9Ftebng8VDBE4DQeYZGJykwLI%3D" alt="https___dev-to-uploads.s3.amazonaws.com_uploads_articles_9k2kqp1kxwrcewfqc77w.webp" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">Engine v1: 添加相机并使其成为 3D</h3>
<p>第一个例子只画了一帧静态画面。要让它变成 3D，需要两样东西：相机，还有能连续生成帧的渲染循环。</p>
<h4 data-id="heading-9">什么是相机？</h4>
<p>在 WebGPU 里，<strong>相机不是 3D 对象</strong>，是两个变换矩阵（view 和 projection），用来把 3D 世界坐标转成 2D 屏幕坐标，产生深度感。不像高级框架有现成的相机对象，WebGPU 得自己管这些矩阵。</p>
<p>简单说：</p>
<ul>
<li><strong>View 矩阵</strong>：相机在哪，朝哪看</li>
<li><strong>Projection 矩阵</strong>：怎么把 3D 空间投影到 2D 屏幕（透视投影）</li>
</ul>
<p>矩阵乘法的细节不用管（交给 AI），只要知道这两个矩阵组合起来，就能把 3D 顶点坐标转成屏幕上的 2D 像素位置。</p>
<h4 data-id="heading-10">相机类</h4>
<p>相机类在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial%2Flib%2Fcamera.ts" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial/lib/camera.ts" ref="nofollow noopener noreferrer"><code>lib/camera.ts</code></a>。实现细节不用管（交给 AI），只要知道它会算 view 和 projection 矩阵，并且会根据鼠标操作（拖拽、缩放、平移）更新。</p>
<h4 data-id="heading-11">关键概念：Uniform 缓冲区</h4>
<p>要把相机矩阵从 JavaScript 传到着色器，用 <strong>uniform 缓冲区</strong>——一块 GPU 内存，所有着色器都能访问，像全局变量一样。</p>
<p>先把相机数据写进缓冲区：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">writeBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraUniformBuffer</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraMatrixData</span>)
</code></pre>
<p>然后创建绑定组，告诉 GPU 这个缓冲区在哪，把它绑到渲染通道：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">bindGroup</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createBindGroup</span>({
  <span class="hljs-attr">label</span>: <span class="hljs-string">"bind group layout"</span>,
  <span class="hljs-attr">layout</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipeline</span>.<span class="hljs-title function_">getBindGroupLayout</span>(<span class="hljs-number">0</span>),
  <span class="hljs-attr">entries</span>: [{ <span class="hljs-attr">binding</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">resource</span>: { <span class="hljs-attr">buffer</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraUniformBuffer</span> } }],
})
</code></pre>
<p>在渲染通道里设置绑定组：</p>
<pre><code class="hljs language-typescript" lang="typescript">pass.<span class="hljs-title function_">setBindGroup</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">bindGroup</span>);
</code></pre>
<p>最后在着色器里，定义个结构体，内存布局要跟缓冲区匹配：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">struct CameraUniforms {
  view: mat4x4f,
  projection: mat4x4f,
  viewPos: vec3f,
  _padding: f32,
};

@group(0) @binding(0) var&lt;uniform&gt; camera: CameraUniforms;
</code></pre>
<p>现在着色器就能直接访问 <code>camera.view</code> 和 <code>camera.projection</code> 了。在顶点着色器里，把每个顶点位置乘上这些矩阵：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">@vertex
fn vs(@location(0) position: vec2&lt;f32&gt;) -&gt; @builtin(position) vec4&lt;f32&gt; {
  return camera.projection * camera.view * vec4f(position, 0.0, 1.0);
}
</code></pre>
<h4 data-id="heading-12">渲染循环</h4>
<p>要做出动画效果，得有个渲染循环，每帧都调用一次渲染函数。用 <code>requestAnimationFrame</code> 就行：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">render</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 更新相机（响应鼠标输入）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">camera</span>.<span class="hljs-title function_">update</span>()
  
  <span class="hljs-comment">// 更新 uniform 缓冲区</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">writeBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraUniformBuffer</span>, <span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraMatrixData</span>)
  
  <span class="hljs-comment">// 渲染</span>
  <span class="hljs-comment">// ...</span>
  
  <span class="hljs-title function_">requestAnimationFrame</span>(render)
}
</code></pre>
<h4 data-id="heading-13">为什么用 Uniform 缓冲区？</h4>
<p>uniform 缓冲区是 WebGPU 的基础模式，用来从 CPU 往 GPU 传数据，比如光照参数、材质属性、变换矩阵。它是只读的，适合每帧更新一次的数据（像相机矩阵）。storage 缓冲区是可读写的，适合需要 GPU 计算的数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d7128f3df8c4f03bf6ed388509f1868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15YW5nWFla:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769636771&amp;x-signature=GEnvD0X0duo6eL2aZWrza%2BSgOa8%3D" alt="https___dev-to-uploads.s3.amazonaws.com_uploads_articles_7v85ohemb42ikeyb8wl4.webp" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-14">Engine v2: 渲染角色几何体</h3>
<p>现在从硬编码的三角形转到真正的模型几何体。我们用预解析好的 PMX <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial%2Fmodel.json" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial/model.json" ref="nofollow noopener noreferrer">模型数据</a>，这是 MMD（MikuMikuDance）动漫角色的标准格式。MMD 在动漫风格角色建模里很常用，很多社区都在做《原神》《深空之眼》这些游戏的模型。解析器这里不讲了（什么格式都行，需要的话让 AI 生成解析器）。重点是理解两个数据结构：顶点和索引。</p>
<h4 data-id="heading-15">顶点数据结构</h4>
<p>每个顶点包含三种数据，按顺序存在内存里（这叫<strong>交错顶点数据</strong>）：</p>
<ul>
<li><strong>位置</strong>：3D 空间里的 <code>[x, y, z]</code> 坐标</li>
<li><strong>法线</strong>：垂直于表面的 <code>[nx, ny, nz]</code> 方向（用来算光照）</li>
<li><strong>UV 坐标</strong>：<code>[u, v]</code> 纹理映射坐标（告诉纹理图片的哪部分要显示）</li>
</ul>
<h4 data-id="heading-16">索引缓冲区</h4>
<p>索引缓冲区指定哪些顶点组成三角形。不用复制顶点数据，用索引引用就行，能省很多内存。</p>
<p>比如一个正方形要 4 个顶点，但可以用 2 个三角形（6 个索引）表示，不用存 6 个重复顶点。</p>
<h4 data-id="heading-17">实现细节</h4>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial%2Fengines%2Fv2.ts" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial/engines/v2.ts" ref="nofollow noopener noreferrer"><code>engines/v2.ts</code></a> 里，从模型数据创建顶点和索引缓冲区。看 <code>initVertexBuffers</code> 方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">initVertexBuffers</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> vertices = <span class="hljs-title class_">Float32Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-property">vertices</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">vertexBuffer</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createBuffer</span>({
    <span class="hljs-attr">label</span>: <span class="hljs-string">"model vertex buffer"</span>,
    <span class="hljs-attr">size</span>: vertices.<span class="hljs-property">byteLength</span>,
    <span class="hljs-attr">usage</span>: <span class="hljs-title class_">GPUBufferUsage</span>.<span class="hljs-property">VERTEX</span> | <span class="hljs-title class_">GPUBufferUsage</span>.<span class="hljs-property">COPY_DST</span>,
  })
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">writeBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vertexBuffer</span>, <span class="hljs-number">0</span>, vertices.<span class="hljs-property">buffer</span>)

  <span class="hljs-comment">// 创建索引缓冲区</span>
  <span class="hljs-keyword">const</span> indices = <span class="hljs-title class_">Uint32Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-property">indices</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">indexBuffer</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createBuffer</span>({
    <span class="hljs-attr">label</span>: <span class="hljs-string">"model index buffer"</span>,
    <span class="hljs-attr">size</span>: indices.<span class="hljs-property">byteLength</span>,
    <span class="hljs-attr">usage</span>: <span class="hljs-title class_">GPUBufferUsage</span>.<span class="hljs-property">INDEX</span> | <span class="hljs-title class_">GPUBufferUsage</span>.<span class="hljs-property">COPY_DST</span>,
  })
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">writeBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">indexBuffer</span>, <span class="hljs-number">0</span>, indices.<span class="hljs-property">buffer</span>)
}
</code></pre>
<p>关键变化是用索引绘制，不用直接绘制。渲染通道调用 <code>drawIndexed</code>，指定索引缓冲区：</p>
<pre><code class="hljs language-typescript" lang="typescript">pass.<span class="hljs-title function_">setVertexBuffer</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">vertexBuffer</span>)
pass.<span class="hljs-title function_">setIndexBuffer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">indexBuffer</span>, <span class="hljs-string">"uint32"</span>)
pass.<span class="hljs-title function_">drawIndexed</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-property">indices</span>.<span class="hljs-property">length</span>) <span class="hljs-comment">// 使用索引绘制所有三角形</span>
</code></pre>
<h4 data-id="heading-18">顶点布局定义</h4>
<p>创建渲染管线时，要定义顶点布局，告诉 GPU 怎么解释缓冲区里的数据：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">vertex</span>: {
  <span class="hljs-attr">module</span>: shaderModule,
  <span class="hljs-attr">entryPoint</span>: <span class="hljs-string">"vs"</span>,
  <span class="hljs-attr">buffers</span>: [{
    <span class="hljs-attr">arrayStride</span>: <span class="hljs-number">32</span>, <span class="hljs-comment">// 每个顶点 32 字节（3 个 float32 位置 + 3 个 float32 法线 + 2 个 float32 UV）</span>
    <span class="hljs-attr">attributes</span>: [
      { <span class="hljs-attr">shaderLocation</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">"float32x3"</span> },  <span class="hljs-comment">// 位置</span>
      { <span class="hljs-attr">shaderLocation</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">offset</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">"float32x3"</span> }, <span class="hljs-comment">// 法线</span>
      { <span class="hljs-attr">shaderLocation</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">offset</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">"float32x2"</span> }, <span class="hljs-comment">// UV</span>
    ],
  }],
}
</code></pre>
<p>结果就是角色的红色轮廓。没纹理（后面会加），只能看到原始几何体。但这是个重要里程碑——从 3 个硬编码顶点，到能渲染几千个三角形的复杂模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d1387ee104f41588d9319da49cf4581~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15YW5nWFla:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769636771&amp;x-signature=khhGhGOrRJ6I5FoMcCo%2F1lYUFDM%3D" alt="https___dev-to-uploads.s3.amazonaws.com_uploads_articles_41o3h5pvjemwfor3p5u5.webp" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-19">Engine v3: 材质和纹理</h3>
<p>现在加纹理，给角色上色和细节。这里有两个概念：<strong>材质</strong>和<strong>纹理</strong>。</p>
<h4 data-id="heading-20">材质</h4>
<p><strong>材质</strong>把一组顶点（通过索引）连起来，指定画这些三角形时用哪些纹理和参数。在角色模型里，材质可以是脸、头发、衣服这些部分。每个材质包含：</p>
<ul>
<li>纹理索引（用哪个纹理）</li>
<li>渲染参数（透明度、混合模式等）</li>
<li>顶点范围（哪些三角形属于这个材质）</li>
</ul>
<p>复杂角色模型里，不同部分（脸、头发、衣服）要用不同材质和纹理，所以得按材质分别渲染。</p>
<h4 data-id="heading-21">纹理</h4>
<p><strong>纹理</strong>就是存颜色数据的图片文件。在 WebGPU 里，得手动把图片数据上传到 GPU。每个顶点都有 UV 坐标（类似纹理的 x、y 坐标），用来映射到纹理的某个位置。片段着色器用这些坐标采样纹理，决定每个像素的颜色。</p>
<p><strong>UV 坐标</strong>：想象一张地图，UV 坐标就像经纬度，告诉着色器"这个顶点对应纹理图片的哪个位置"。UV 范围通常是 0.0 到 1.0，(0,0) 是左上角，(1,1) 是右下角。</p>
<h4 data-id="heading-22">加载和创建纹理</h4>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial%2Fengines%2Fv3.ts" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial/engines/v3.ts" ref="nofollow noopener noreferrer"><code>engines/v3.ts</code></a> 里，先加载纹理图片，创建 GPU 纹理。看 <code>initTexture</code> 方法：获取图片文件，创建 <code>ImageBitmap</code>，然后创建 <code>GPUTexture</code> 并上传图片数据：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> imageBitmap = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createImageBitmap</span>(<span class="hljs-keyword">await</span> response.<span class="hljs-title function_">blob</span>())
<span class="hljs-keyword">const</span> texture = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createTexture</span>({
  <span class="hljs-attr">size</span>: [imageBitmap.<span class="hljs-property">width</span>, imageBitmap.<span class="hljs-property">height</span>],
  <span class="hljs-attr">format</span>: <span class="hljs-string">"rgba8unorm"</span>,
  <span class="hljs-attr">usage</span>: <span class="hljs-title class_">GPUTextureUsage</span>.<span class="hljs-property">TEXTURE_BINDING</span> | <span class="hljs-title class_">GPUTextureUsage</span>.<span class="hljs-property">COPY_DST</span>,
})
<span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">copyExternalImageToTexture</span>({ <span class="hljs-attr">source</span>: imageBitmap }, { texture }, [
  imageBitmap.<span class="hljs-property">width</span>,
  imageBitmap.<span class="hljs-property">height</span>,
])
</code></pre>
<h4 data-id="heading-23">采样器</h4>
<p>然后创建采样器，定义怎么采样纹理（过滤、包装等）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">sampler</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createSampler</span>({
  <span class="hljs-attr">magFilter</span>: <span class="hljs-string">"linear"</span>,      <span class="hljs-comment">// 放大时的过滤方式</span>
  <span class="hljs-attr">minFilter</span>: <span class="hljs-string">"linear"</span>,      <span class="hljs-comment">// 缩小时的过滤方式</span>
  <span class="hljs-attr">addressModeU</span>: <span class="hljs-string">"repeat"</span>,   <span class="hljs-comment">// U 方向的包装模式</span>
  <span class="hljs-attr">addressModeV</span>: <span class="hljs-string">"repeat"</span>,   <span class="hljs-comment">// V 方向的包装模式</span>
})
</code></pre>
<ul>
<li><strong>过滤模式</strong>：<code>linear</code> 平滑插值，<code>nearest</code> 像素化</li>
<li><strong>包装模式</strong>：<code>repeat</code> 重复纹理，<code>clamp-to-edge</code> 夹到边缘</li>
</ul>
<h4 data-id="heading-24">在着色器里传 UV 坐标</h4>
<p>要把 UV 坐标从顶点着色器传到片段着色器，定义个 <code>VertexOutput</code> 结构，把位置和 UV 打包：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">struct VertexOutput {
  @builtin(position) position: vec4&lt;f32&gt;,
  @location(0) uv: vec2&lt;f32&gt;,
}

@vertex
fn vs(
  @location(0) position: vec3&lt;f32&gt;,
  @location(2) uv: vec2&lt;f32&gt;
) -&gt; VertexOutput {
  var output: VertexOutput;
  output.position = camera.projection * camera.view * vec4f(position, 1.0);
  output.uv = uv;
  return output;
}
</code></pre>
<p>片段着色器接收 UV 坐标，用 <code>textureSample</code> 采样纹理：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">@fragment
fn fs(input: VertexOutput) -&gt; @location(0) vec4&lt;f32&gt; {
  return vec4&lt;f32&gt;(textureSample(texture, textureSampler, input.uv).rgb, 1.0);
}
</code></pre>
<h4 data-id="heading-25">绑定纹理到着色器</h4>
<p>要把纹理绑到着色器，给每个材质创建个绑定组，包含纹理和采样器。作为第二个绑定组，放在相机 uniform 旁边：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> material <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-property">materials</span>) {
  <span class="hljs-keyword">const</span> textureIndex = material.<span class="hljs-property">diffuseTextureIndex</span>
  <span class="hljs-keyword">const</span> materialBindGroup = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createBindGroup</span>({
    <span class="hljs-attr">layout</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">pipeline</span>.<span class="hljs-title function_">getBindGroupLayout</span>(<span class="hljs-number">1</span>),
    <span class="hljs-attr">entries</span>: [
      { <span class="hljs-attr">binding</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">resource</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">textures</span>[textureIndex].<span class="hljs-title function_">createView</span>() },
      { <span class="hljs-attr">binding</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">resource</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sampler</span> },
    ],
  })
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">materialBindGroups</span>.<span class="hljs-title function_">push</span>(materialBindGroup)
}
</code></pre>
<h4 data-id="heading-26">按材质渲染</h4>
<p>最后按材质分别渲染。别对整个模型调一次 <code>drawIndexed</code>，要遍历材质，设置每个材质的绑定组，画它的三角形：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> firstIndex = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-property">materials</span>.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">const</span> material = <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>.<span class="hljs-property">materials</span>[i]
  <span class="hljs-keyword">if</span> (material.<span class="hljs-property">vertexCount</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>

  pass.<span class="hljs-title function_">setBindGroup</span>(<span class="hljs-number">1</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">materialBindGroups</span>[i])
  pass.<span class="hljs-title function_">drawIndexed</span>(material.<span class="hljs-property">vertexCount</span>, <span class="hljs-number">1</span>, firstIndex)
  firstIndex += material.<span class="hljs-property">vertexCount</span>
}
</code></pre>
<p>结果就是完全贴图的角色了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60e3c403ce5c494e94dcfa72178e4c9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15YW5nWFla:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769636771&amp;x-signature=tyjW%2B7XORuljnBVAK414jZWujSE%3D" alt="https___dev-to-uploads.s3.amazonaws.com_uploads_articles_vttc9ecp2u7w122yj6md.webp" loading="lazy"/></p>
<h4 data-id="heading-27">深度测试</h4>
<p>你可能会发现角色看起来透明，或者能看到背面。这是因为没开深度测试，GPU 按提交顺序画三角形——远处的可能画在近处的上面。</p>
<p>修复很简单，三步：创建深度纹理，加到渲染通道，配置管线。不用改着色器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建深度纹理</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">depthTexture</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createTexture</span>({
  <span class="hljs-attr">size</span>: [width, height],
  <span class="hljs-attr">format</span>: <span class="hljs-string">"depth24plus"</span>,
  <span class="hljs-attr">usage</span>: <span class="hljs-title class_">GPUTextureUsage</span>.<span class="hljs-property">RENDER_ATTACHMENT</span>,
})

<span class="hljs-comment">// 添加到渲染通道</span>
<span class="hljs-attr">depthStencilAttachment</span>: {
  <span class="hljs-attr">view</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">depthTexture</span>.<span class="hljs-title function_">createView</span>(),
  <span class="hljs-attr">depthClearValue</span>: <span class="hljs-number">1.0</span>,      <span class="hljs-comment">// 1.0 表示最远</span>
  <span class="hljs-attr">depthLoadOp</span>: <span class="hljs-string">"clear"</span>,      <span class="hljs-comment">// 每帧清除深度缓冲区</span>
  <span class="hljs-attr">depthStoreOp</span>: <span class="hljs-string">"store"</span>,     <span class="hljs-comment">// 存储深度值用于下一帧</span>
}

<span class="hljs-comment">// 添加到管线</span>
<span class="hljs-attr">depthStencil</span>: {
  <span class="hljs-attr">depthWriteEnabled</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 允许写入深度值</span>
  <span class="hljs-attr">depthCompare</span>: <span class="hljs-string">"less"</span>,      <span class="hljs-comment">// 只渲染更近的片段</span>
  <span class="hljs-attr">format</span>: <span class="hljs-string">"depth24plus"</span>,
}
</code></pre>
<p>完整实现在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial%2Fengines%2Fv3_2.ts" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial/engines/v3_2.ts" ref="nofollow noopener noreferrer"><code>engines/v3_2.ts</code></a>。有了材质、纹理和深度测试，静态渲染管线就完整了。角色完全贴图，从任何角度看都是实心的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1c9953a758d4b7ea6ae74fcd301d0a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15YW5nWFla:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769636771&amp;x-signature=ZzqQSK6vZhaqPDAz2Zr%2BYhhXM48%3D" alt="https___dev-to-uploads.s3.amazonaws.com_uploads_articles_zw1fja133f3s5w340393.webp" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-28">Engine v4: 骨骼和蒙皮</h3>
<p>在 WebGPU 里，得理解骨骼系统怎么工作。高级框架会自动处理骨骼动画，但这里得手动实现。</p>
<h4 data-id="heading-29">骨骼和层次结构</h4>
<p><strong>骨骼</strong>是层次结构里的变换。想象个木偶：关节（肩膀、肘部、手腕）就是骨骼，用线（层次关系）连起来。每个骨骼都有个父骨骼（除了根骨骼），移动父骨骼，所有子骨骼都会跟着动。MMD 模型里，典型的臂链是这样的：</p>
<pre><code class="hljs language-scss" lang="scss">センター (center) → 上半身 (upper_body) → 右肩 (shoulder_R) → 右腕 (arm_R) → 右ひじ (elbow_R) → 右手首 (wrist_R) → 手指关节
</code></pre>
<p>旋转上半身时，整个上半身——肩膀、手臂、肘部、手腕、手指——都会跟着转。这种级联效果是因为每个骨骼的变换是相对于父骨骼的。</p>
<p>就像 DOM 树，父元素动了，子元素也跟着动。骨骼系统就是 3D 空间里的"DOM 树"。</p>
<h4 data-id="heading-30">骨骼变换的数学原理</h4>
<p>每个骨骼都有个局部变换矩阵，表示相对父骨骼的旋转、缩放、平移。要算骨骼在世界空间的最终位置，从根骨骼往下遍历，把每个骨骼的局部变换乘上父骨骼的世界变换：</p>
<pre><code class="hljs language-css" lang="css">worldMatrix<span class="hljs-selector-attr">[bone]</span> = worldMatrix<span class="hljs-selector-attr">[parent]</span> × localMatrix<span class="hljs-selector-attr">[bone]</span>
</code></pre>
<p>这样子骨骼就会跟着父骨骼移动。</p>
<h4 data-id="heading-31">蒙皮：将骨骼连接到顶点</h4>
<p><strong>蒙皮</strong>就是骨骼怎么变形网格。这是骨骼动画的核心概念。</p>
<p>简单说：想象个木偶，皮肤（网格）要跟着关节（骨骼）动。但皮肤上的每个点（顶点）可能同时受多个关节影响。比如肩膀附近的顶点主要受肩膀骨骼影响，但也稍微受上臂骨骼影响，这样动起来过渡更自然。</p>
<p>每个顶点存最多 4 个骨骼索引和 4 个权重，权重总和是 1.0。骨骼移动时，顶点的最终位置是加权混合：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 顶点数据</span>
<span class="hljs-attr">joints</span>:  [<span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]    <span class="hljs-comment">// 骨骼索引：这个顶点受骨骼 15 和 16 影响</span>
<span class="hljs-attr">weights</span>: [<span class="hljs-number">0.7</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment">// 权重：70% 来自骨骼 15，30% 来自骨骼 16</span>

<span class="hljs-comment">// 最终位置 = 每个骨骼变换的加权和</span>
finalPosition = (skinMatrix[<span class="hljs-number">15</span>] * position) * <span class="hljs-number">0.7</span> 
              + (skinMatrix[<span class="hljs-number">16</span>] * position) * <span class="hljs-number">0.3</span>
</code></pre>
<p>就像 CSS 的 <code>transform-origin</code>，但更复杂。一个顶点可以同时有多个"原点"（骨骼），最终位置是这些原点的加权平均。</p>
<p>每个骨骼的 <code>skinMatrix</code> 结合了当前姿态和绑定姿态（bind pose），让骨骼旋转时能平滑变形。绑定姿态是模型的初始姿态（通常是 T-pose 或 A-pose），用来算顶点相对骨骼的原始位置。</p>
<h4 data-id="heading-32">绑定姿态（Bind Pose）和蒙皮矩阵</h4>
<p>绑定姿态是模型在 T-pose 或 A-pose 时的原始姿态。每个骨骼都有个逆绑定矩阵（inverse bind matrix），用来把顶点从世界空间转回骨骼的局部空间。蒙皮矩阵这么算：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">skinMatrix</span> = worldMatrix × inverseBindMatrix
</code></pre>
<p>这样顶点会跟着骨骼移动，同时保持相对骨骼的正确位置。</p>
<h4 data-id="heading-33">CPU 端的骨骼控制</h4>
<p>骨骼在 CPU 上。动画、物理、用户输入都在这里更新骨骼旋转。旋转骨骼时，引擎重新算层次结构（父到子变换），把结果上传到 GPU：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 你的游戏代码：旋转颈部骨骼</span>
engine.<span class="hljs-title function_">rotateBone</span>(<span class="hljs-string">"首"</span>, rotation)

<span class="hljs-comment">// 内部，这触发：</span>
<span class="hljs-comment">// 1. evaluatePose() - 从层次结构重新计算所有世界矩阵</span>
<span class="hljs-comment">// 2. 上传世界矩阵到 GPU</span>
<span class="hljs-comment">// 3. 计算通道 - 计算蒙皮矩阵</span>
<span class="hljs-comment">// 4. 下一次渲染使用更新的蒙皮</span>
</code></pre>
<h4 data-id="heading-34">计算着色器：并行矩阵计算</h4>
<p>几百个骨骼、几千个顶点，在 CPU 上算蒙皮矩阵太慢了。这就是<strong>计算着色器</strong>的用武之地——这也是 WebGPU 相对 WebGL 的关键优势。计算着色器在 GPU 上做大规模并行计算，很适合矩阵运算。</p>
<p>把骨骼矩阵上传到 storage 缓冲区，然后调度计算着色器并行算所有蒙皮矩阵。471 个骨骼的模型，就是 471 个矩阵乘法在 GPU 上同时跑：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">@group(0) @binding(1) var&lt;storage, read&gt; worldMatrices: array&lt;mat4x4f&gt;;
@group(0) @binding(2) var&lt;storage, read&gt; inverseBindMatrices: array&lt;mat4x4f&gt;;
@group(0) @binding(3) var&lt;storage, read_write&gt; skinMatrices: array&lt;mat4x4f&gt;;

@compute @workgroup_size(64)
fn main(@builtin(global_invocation_id) globalId: vec3&lt;u32&gt;) {
  let boneIndex = globalId.x;
  if (boneIndex &gt;= boneCount.count) { return; }
  
  skinMatrices[boneIndex] = worldMatrices[boneIndex] * inverseBindMatrices[boneIndex];
}
</code></pre>
<h4 data-id="heading-35">Storage 缓冲区 vs Uniform 缓冲区</h4>
<ul>
<li><strong>Uniform 缓冲区</strong>：只读，大小有限（通常 64KB），适合每帧更新一次的小数据（像相机矩阵）</li>
<li><strong>Storage 缓冲区</strong>：可读写，大小几乎无限制，适合需要 GPU 计算的大数据（像骨骼矩阵数组）</li>
</ul>
<h4 data-id="heading-36">完整的渲染流程</h4>
<p>每帧的完整流程（完整实现在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial%2Fengines%2Fv4.ts" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial/engines/v4.ts" ref="nofollow noopener noreferrer"><code>engines/v4.ts</code></a>）：</p>
<ol>
<li><strong>CPU</strong>：动画或用户输入更新骨骼旋转</li>
<li><strong>CPU</strong>：<code>evaluatePose()</code> 遍历层次结构，计算世界矩阵</li>
<li><strong>CPU → GPU</strong>：上传世界矩阵到 storage 缓冲区</li>
<li><strong>GPU 计算通道</strong>：并行计算所有骨骼的 <code>skinMatrix = world × inverseBind</code></li>
<li><strong>GPU 渲染通道</strong>：顶点着色器读蒙皮矩阵，按每个顶点的骨骼权重混合顶点</li>
</ol>
<p>顶点着色器做最终的蒙皮计算：</p>
<pre><code class="hljs language-wgsl" lang="wgsl">@group(0) @binding(1) var&lt;storage, read&gt; skinMats: array&lt;mat4x4f&gt;;

@vertex
fn vs(
  @location(0) position: vec3&lt;f32&gt;,
  @location(3) joints: vec4&lt;u32&gt;,
  @location(4) weights: vec4&lt;f32&gt;
) -&gt; VertexOutput {
  // 根据骨骼影响混合位置
  var skinnedPos = vec4f(0.0);
  for (var i = 0u; i &lt; 4u; i++) {
    skinnedPos += (skinMats[joints[i]] * vec4f(position, 1.0)) * weights[i];
  }
  
  output.position = camera.projection * camera.view * skinnedPos;
}
</code></pre>
<h4 data-id="heading-37">计算通道设置</h4>
<p>要用计算着色器，创建个计算管线并调度它：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建计算管线</span>
<span class="hljs-keyword">const</span> computePipeline = <span class="hljs-variable language_">this</span>.<span class="hljs-property">device</span>.<span class="hljs-title function_">createComputePipeline</span>({
  <span class="hljs-attr">layout</span>: <span class="hljs-string">"auto"</span>,
  <span class="hljs-attr">compute</span>: {
    <span class="hljs-attr">module</span>: computeShaderModule,
    <span class="hljs-attr">entryPoint</span>: <span class="hljs-string">"main"</span>,
  },
})

<span class="hljs-comment">// 在计算通道中调度</span>
<span class="hljs-keyword">const</span> computePass = encoder.<span class="hljs-title function_">beginComputePass</span>()
computePass.<span class="hljs-title function_">setPipeline</span>(computePipeline)
computePass.<span class="hljs-title function_">setBindGroup</span>(<span class="hljs-number">0</span>, computeBindGroup)
computePass.<span class="hljs-title function_">dispatchWorkgroups</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(boneCount / <span class="hljs-number">64</span>)) <span class="hljs-comment">// 64 是工作组大小</span>
computePass.<span class="hljs-title function_">end</span>()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba5d583b290f429db662d81abf98c24d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW15YW5nWFla:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769636771&amp;x-signature=9sRN4ejpgeO7sJlDqdbTv6zUlsI%3D" alt="https___dev-to-uploads.s3.amazonaws.com_uploads_articles_shb5xum7i07w1jicru4t.webp" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-38">总结</h3>
<p>现在你已经搭好了一个完整的 WebGPU 渲染管线——从简单三角形到完全贴图、骨骼动画的角色。你理解了核心组件（缓冲区、绑定组、管线、渲染通道），它们怎么连起来（CPU 到 GPU 的数据流、着色器接口），以及为什么这样设计（uniform vs storage 缓冲区、计算着色器做并行计算）。</p>
<h4 data-id="heading-39">关键点</h4>
<ol>
<li><strong>GPU 是独立的计算单元</strong>：需要明确的数据传输和指令</li>
<li><strong>缓冲区是数据传输的基础</strong>：vertex、index、uniform、storage 缓冲区各有各的用途</li>
<li><strong>着色器定义处理逻辑</strong>：vertex、fragment、compute 着色器在管线的不同阶段跑</li>
<li><strong>绑定组连接资源</strong>：把缓冲区、纹理、采样器组织在一起</li>
<li><strong>计算着色器做并行</strong>：利用 GPU 的并行计算能力</li>
</ol>
<h4 data-id="heading-40">下一步</h4>
<p>这个教程主要讲 WebGPU 的基础。物理模拟、逆运动学、动态光照、后处理这些高级功能都建立在这些概念上——它们是应用级功能，不是新的 WebGPU 原语。可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Freze.one" target="_blank" title="https://reze.one" ref="nofollow noopener noreferrer">Reze Engine</a> 源码里探索这些，它把这里学的东西扩展成了一个完整的动漫角色渲染器。</p>
<hr/>
<p><em>本教程是 Reze Engine 项目的一部分。完整源代码可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAmyangXYZ%2Freze-engine%2Ftree%2Fmaster%2Fweb%2Fapp%2Ftutorial" target="_blank" title="https://github.com/AmyangXYZ/reze-engine/tree/master/web/app/tutorial" ref="nofollow noopener noreferrer">GitHub</a> 上找到。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原生JS实现双栏布局拖拽【附源码】]]></title>    <link>https://juejin.cn/post/7597708846770978854</link>    <guid>https://juejin.cn/post/7597708846770978854</guid>    <pubDate>2026-01-22T02:51:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597708846770978854" data-draft-id="7597704040215396378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原生JS实现双栏布局拖拽【附源码】"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T02:51:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大卫"/> <meta itemprop="url" content="https://juejin.cn/user/1961184474695213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原生JS实现双栏布局拖拽【附源码】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184474695213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大卫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:51:13.000Z" title="Thu Jan 22 2026 02:51:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>之前有个老的项目，需要使用 jQuery 实现这种双栏布局拖拽的效果，特此记录一下，分享给大家。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b3eb9f2ed3848e1ae264967e72a2ed2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5aSn5Y2r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655073&amp;x-signature=faqt8pLg%2BHHnDqNJPrkZcZ2HJ%2B8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">实现思路讲解</h2>
<p>这个双栏拖拽布局，本质上只做了一件事：</p>
<blockquote>
<p><strong>通过拖拽中间的分割线，动态改变左侧容器的宽度，右侧自动填充剩余空间。</strong></p>
</blockquote>
<p>我们可以把整个实现拆成 <strong>4 个核心步骤</strong> 来理解。</p>
<h2 data-id="heading-2">一、整体布局结构是关键</h2>
<p>先看最核心的 DOM 结构（简化后）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"divider-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"right-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">为什么要这样结构？</h3>
<ul>
<li>父容器 <code>.content-container</code> 使用 <code>flex</code></li>
<li>左侧 <code>.left-container</code> <strong>固定宽度（但可变）</strong></li>
<li>中间 <code>.divider-container</code> 是<strong>拖拽手柄</strong></li>
<li>右侧 <code>.right-container</code> 使用 <code>flex-grow: 1</code> 自动填充剩余空间</li>
</ul>
<p>👉 <strong>重点：我们只需要控制 left 的宽度，right 会自动变化</strong></p>
<p>CSS 里最关键的几行是：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.content-container</span> {
  <span class="hljs-attribute">display</span>: flex;
}

<span class="hljs-selector-class">.left-container</span> {
  <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.right-container</span> {
  <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">1</span>;
}
</code></pre>
<h2 data-id="heading-4">二、拖拽的核心原理（一定要理解）</h2>
<p>拖拽其实并不神秘，本质只有 3 个事件：</p>
<ol>
<li><strong>mousedown</strong>：开始拖拽</li>
<li><strong>mousemove</strong>：拖拽过程中，持续计算距离</li>
<li><strong>mouseup</strong>：结束拖拽</li>
</ol>
<h3 data-id="heading-5">拖拽时我们关心什么？</h3>
<p>只关心 <strong>鼠标在 X 轴上移动了多少</strong></p>
<pre><code class="hljs language-js" lang="js">当前宽度 = 初始宽度 + (当前鼠标 X - 按下时鼠标 X)
</code></pre>
<p>代码里对应的是这一段：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> startX = e.<span class="hljs-property">clientX</span>;       <span class="hljs-comment">// 鼠标按下时的 X</span>
<span class="hljs-keyword">var</span> leftWidth = $left.<span class="hljs-title function_">width</span>(); <span class="hljs-comment">// 左侧初始宽度</span>

<span class="hljs-title function_">setLeftContainerWidth</span>(leftWidth + e.<span class="hljs-property">clientX</span> - startX);
</code></pre>
<h2 data-id="heading-6">三、为什么 mousemove 要绑定在 document 上？</h2>
<p>这是一个<strong>非常重要的细节</strong>，新手最容易踩坑。</p>
<pre><code class="hljs language-js" lang="js">$document.<span class="hljs-title function_">on</span>(<span class="hljs-string">"mousemove"</span>, onMousemove);
$document.<span class="hljs-title function_">on</span>(<span class="hljs-string">"mouseup"</span>, onMouseup);
</code></pre>
<h3 data-id="heading-7">如果绑定在 divider 上会怎样？</h3>
<ul>
<li>鼠标一旦移动太快</li>
<li>光标离开 divider 区域</li>
<li><strong>拖拽立刻失效</strong></li>
</ul>
<p>👉 所以<strong>正确做法是绑定到 document</strong>，确保鼠标在页面任何地方都能继续拖拽。</p>
<h2 data-id="heading-8">四、防止宽度“拖炸”的边界控制</h2>
<p>拖拽时一定要做 <strong>最大 / 最小宽度限制</strong>，否则：</p>
<ul>
<li>左边会被拖成负数</li>
<li>或者直接盖住右侧</li>
</ul>
<p>这里用了一个非常关键的方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> setLeftContainerWidth = <span class="hljs-keyword">function</span> (<span class="hljs-params">width</span>) {
  <span class="hljs-keyword">var</span> contentWidth = $content.<span class="hljs-title function_">width</span>();
  <span class="hljs-keyword">var</span> dividerWidth = $divider.<span class="hljs-title function_">width</span>();
  <span class="hljs-keyword">var</span> maxLeftWidth = contentWidth - dividerWidth;

  width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(width, maxLeftWidth);
  $left.<span class="hljs-title function_">width</span>(width);
};
</code></pre>
<h3 data-id="heading-9">这里做了什么？</h3>
<ul>
<li><strong>最大宽度</strong> = 父容器宽度 - 分割线宽度</li>
<li>使用 <code>Math.min</code> 防止超过最大值</li>
</ul>
<p>👉 这一步是拖拽体验是否“丝滑”的关键点之一</p>
<h2 data-id="heading-10">五、为什么要加 <code>body.dragging</code> 这个状态？</h2>
<p>当拖拽开始时：</p>
<pre><code class="hljs language-js" lang="js">$body.<span class="hljs-title function_">addClass</span>(<span class="hljs-string">"dragging"</span>);
</code></pre>
<p>结束时：</p>
<pre><code class="hljs language-js" lang="js">$body.<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">"dragging"</span>);
</code></pre>
<p>对应 CSS：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span><span class="hljs-selector-class">.dragging</span> {
  <span class="hljs-attribute">cursor</span>: col-resize;
}

<span class="hljs-selector-tag">body</span><span class="hljs-selector-class">.dragging</span> <span class="hljs-selector-class">.left-container</span>,
<span class="hljs-selector-tag">body</span><span class="hljs-selector-class">.dragging</span> <span class="hljs-selector-class">.right-container</span> {
  <span class="hljs-attribute">pointer-events</span>: none;
}
</code></pre>
<h3 data-id="heading-11">这一步解决了什么问题？</h3>
<ol>
<li><strong>统一鼠标样式</strong></li>
<li><strong>防止 iframe / 内部元素抢占鼠标事件</strong></li>
<li>避免拖拽中断（尤其是老项目、复杂页面）</li>
</ol>
<p>👉 这是很多“看起来能拖，但偶尔会断”的根本解决方案</p>
<h2 data-id="heading-12">六、双击 / ESC / 按钮恢复布局的设计思路</h2>
<p>为了让体验更好，这里加了几个「快捷恢复」方式：</p>
<h3 data-id="heading-13">1️⃣ 点击中间手柄，恢复 50%</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">recoverWidth</span>();
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">recoverWidth</span>(<span class="hljs-params"/>) {
  $left.<span class="hljs-title function_">width</span>($content.<span class="hljs-title function_">width</span>() / <span class="hljs-number">2</span>);
}
</code></pre>
<h3 data-id="heading-14">2️⃣ 按 ESC 键恢复</h3>
<pre><code class="hljs language-js" lang="js">$document.<span class="hljs-title function_">on</span>(<span class="hljs-string">"keydown"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">"Escape"</span>) {
    <span class="hljs-title function_">recoverWidth</span>();
  }
});
</code></pre>
<h3 data-id="heading-15">3️⃣ 左右双箭头一键全屏</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setLeftContainerWidth</span>(<span class="hljs-number">0</span>);           <span class="hljs-comment">// 左边隐藏</span>
<span class="hljs-title function_">setLeftContainerWidth</span>($content.<span class="hljs-title function_">width</span>()); <span class="hljs-comment">// 左边全屏</span>
</code></pre>
<p>并且配合 CSS 动画：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.left-container</span><span class="hljs-selector-class">.animating</span> {
  <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.4s</span> ease;
}
</code></pre>
<p>👉 这让“程序员工具类页面”的体验直接上一个档次</p>
<h2 data-id="heading-16">七、实现这个功能的几个核心关键点（必看）</h2>
<p>如果你只记住下面 5 条，也能自己写出来 👇</p>
<ol>
<li><strong>布局用 flex，只改左侧宽度</strong></li>
<li><strong>mousemove / mouseup 一定绑定 document</strong></li>
<li><strong>拖拽时要保存起始 X 和初始宽度</strong></li>
<li><strong>必须做最大 / 最小宽度限制</strong></li>
<li><strong>拖拽中禁用 pointer-events，防止事件丢失</strong></li>
</ol>
<h2 data-id="heading-17">最后</h2>
<p>这个方案虽然用了 jQuery，但<strong>实现思路是完全通用的</strong>：</p>
<ul>
<li>原生 JS</li>
<li>Vue / React</li>
<li>甚至桌面端 WebView</li>
</ul>
<p>只要你理解了「拖拽本质是计算位移」，这个效果你以后随手就能写出来。</p>
<h2 data-id="heading-18">附源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzm8%2Fwechat-oa%2Ftree%2Fmain%2Fexamples%2Fdrag-js" target="_blank" title="https://github.com/zm8/wechat-oa/tree/main/examples/drag-js" ref="nofollow noopener noreferrer">github.com/zm8/wechat-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3架构设计——调度系统]]></title>    <link>https://juejin.cn/post/7597679732364574762</link>    <guid>https://juejin.cn/post/7597679732364574762</guid>    <pubDate>2026-01-21T16:00:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597679732364574762" data-draft-id="7597679732364558378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3架构设计——调度系统"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2026-01-21T16:00:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秀秀不只会前端"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3架构设计——调度系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秀秀不只会前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T16:00:06.000Z" title="Wed Jan 21 2026 16:00:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>调度本义是指控制一系列任务的执行顺序/编排规划。Vue3 的调度系统使其能够做到**“批量更新、不重复渲染、任务执行顺序可控”** 。</p>
</blockquote>
<p><strong>Vue 的调度系统 = 副作用执行顺序 + 去重 + 批量刷新</strong></p>
<blockquote>
<p><strong>所有响应式变化，最终都不会“立刻执行”，而是被“调度”</strong></p>
</blockquote>
<h2 data-id="heading-0">一、Vue 为什么需要调度系统？</h2>
<p>如果没有调度，会发生什么？</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">state.<span class="hljs-property">a</span>++
state.<span class="hljs-property">b</span>++
state.<span class="hljs-property">c</span>++
</code></pre>
<p>如果每次 <code>set</code> 都立即触发：</p>
<pre><code class="hljs language-Plain" lang="Plain">render()
render()
render()
</code></pre>
<p>造成后果：</p>
<ul>
<li>性能问题</li>
<li>顺序不可控</li>
<li>DOM 不断更改，页面抖动</li>
</ul>
<p>所以，Vue 的目标是：</p>
<pre><code class="hljs language-Plain" lang="Plain">state.a++
state.b++
state.c++
↓
render()  // 只执行一次（Scheduler 存在的意义）
</code></pre>
<h2 data-id="heading-1">二、调度系统的数据结构</h2>
<p>源码中的位置：<code>packages/runtime-core/src/scheduler.ts</code></p>
<blockquote>
<p><strong>运行时（runtime）调度，对 effect 进行 “统一执行管理”。</strong></p>
</blockquote>
<p>调度系统​<strong>不关心数据</strong>​，只关心：</p>
<h3 data-id="heading-2">2.1 Job 的本质</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">SchedulerJob</span> = <span class="hljs-title class_">Function</span> &amp; {
  id?: <span class="hljs-built_in">number</span>
  flags?: <span class="hljs-built_in">number</span>
}
</code></pre>
<blockquote>
<ul>
<li>没有 id，直接 push 进队列</li>
<li>有 id，按照顺序通过二分查找插入到合适的位置</li>
</ul>
</blockquote>
<p><strong>Job ≈ effect.run / component update</strong></p>
<h3 data-id="heading-3">2.2 核心队列</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">SchedulerJob</span>[] = []
</code></pre>
<p>所有待执行任务，都会进这个队列。</p>
<h3 data-id="heading-4">2.3 任务去重</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">const</span> queued = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">SchedulerJob</span>&gt;()
</code></pre>
<blockquote>
<p>同一个 job，一个 flush 周期只会进队一次</p>
</blockquote>
<h2 data-id="heading-5">三、调度入口：queueJob</h2>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queueJob</span>(<span class="hljs-params">job: SchedulerJob</span>) {
  <span class="hljs-keyword">if</span> (!queued.<span class="hljs-title function_">has</span>(job)) {
    queued.<span class="hljs-title function_">add</span>(job)
    queue.<span class="hljs-title function_">push</span>(job)
    <span class="hljs-title function_">queueFlush</span>()
  }
}
</code></pre>
<ol>
<li>去重（比如说 <code>count++</code> 多次，最终的更新只需要一次）</li>
<li>入队</li>
<li>触发 flush</li>
</ol>
<h2 data-id="heading-6">四、flush：真正执行的地方</h2>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">queueFlush</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!isFlushing) {
    isFlushing = <span class="hljs-literal">true</span>
    resolvedPromise.<span class="hljs-title function_">then</span>(flushJobs)
  }
}
</code></pre>
<blockquote>
<p><strong>Vue 的调度基于 microtask（Promise.then）</strong></p>
</blockquote>
<p>所以：</p>
<pre><code class="hljs language-Plain" lang="Plain">同步代码 → 全跑完
↓
flushJobs（统一执行）
</code></pre>
<h2 data-id="heading-7">五、flushJobs 的核心逻辑</h2>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushJobs</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 批量执行 所有 job 集中执行一次</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; queue.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> job = queue[i]
      <span class="hljs-title function_">job</span>()
    }
  } <span class="hljs-keyword">finally</span> {
    queue.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
    queued.<span class="hljs-title function_">clear</span>()
    isFlushing = <span class="hljs-literal">false</span>
  }
}
</code></pre>
<h2 data-id="heading-8">六、组件更新的调度</h2>
<p>每个组件都有一个 render effect</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">const</span> effect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactiveEffect</span>(componentUpdateFn)
</code></pre>
<p>scheduler 被设置为：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript">scheduler = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">queueJob</span>(update) <span class="hljs-comment">// UI 更新</span>
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">state change
 ↓
trigger
 ↓
component render effect.scheduler
 ↓
queueJob(update)
 ↓
flushJobs（异步更新）
 ↓
update() → render()
</code></pre>
<h2 data-id="heading-9">七、computed / watch 在调度系统中的位置</h2>
<h3 data-id="heading-10">7.1 computed 的 scheduler</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript">scheduler = <span class="hljs-function">() =&gt;</span> {
  dirty = <span class="hljs-literal">true</span>
  <span class="hljs-title function_">trigger</span>(computed.<span class="hljs-property">dep</span>)
}
</code></pre>
<p>computed 的任务调度不进 scheduler 队列（queueJob），<strong>只影响依赖它的 effect</strong></p>
<h3 data-id="heading-11">7.2 watch 的 scheduler</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript">scheduler = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">queueJob</span>(job)
}
</code></pre>
<p>watch ​<strong>直接进入调度系统</strong>​（具体进入哪个优先层级取决于 flush ，默认为 queueJob）</p>
<h2 data-id="heading-12">八、flush: pre / post / sync</h2>
<p>Vue 的调度系统 <strong>不是一个队列，而是三个层级</strong></p>
<p><strong>三种 flush 模式</strong></p>
<h3 data-id="heading-13">8.1 pre 队列（默认 watch）</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title function_">queuePreFlushCb</span>(job)
</code></pre>
<p>用于：</p>
<ul>
<li>watch</li>
<li>beforeUpdate</li>
</ul>
<h3 data-id="heading-14">8.2 post 队列（DOM 后）</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title function_">queuePostFlushCb</span>(job)
</code></pre>
<p>用于：</p>
<ul>
<li>watch(flush: 'post')</li>
<li>onMounted / onUpdated</li>
</ul>
<h3 data-id="heading-15">8.3 执行顺序</h3>
<pre><code class="hljs language-Plain" lang="Plain">flushPreFlushCbs
 ↓
flushJobs（组件更新）
 ↓
flushPostFlushCbs
</code></pre>
<h2 data-id="heading-16">九、nextTick 的本质</h2>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">fn?</span>) {
  <span class="hljs-keyword">return</span> fn
    ? resolvedPromise.<span class="hljs-title function_">then</span>(fn)
    : resolvedPromise
}
</code></pre>
<p>所以 <strong>​nextTick 本质是：等当前调度周期 flush 完（在原本调度系统 ​​<code>Promise.then(调度任务队列)</code><strong>​​</strong>​ 的后面又拼接了一个 ​<code>.then(nextTick任务)</code><strong>​</strong>）</strong></p>
<p>DOM 更新会在原本的调度系统中，所以 nextTick 在开发中一般用于获取最新的 DOM 。</p>
<h2 data-id="heading-17">十、简单示例</h2>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">watch</span>(state, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'watch'</span>))

state.<span class="hljs-property">count</span>++

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'sync'</span>)

<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'tick'</span>))
</code></pre>
<p>执行顺序：</p>
<pre><code class="hljs language-Plain" lang="Plain">sync
watch
render
tick
</code></pre>
<h2 data-id="heading-18">十一、为什么 Vue 不用 setTimeout / requestAnimationFrame？</h2>
<p>Vue 的目标是：<strong>“同步代码结束后，立刻统一刷新”</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[直击痛点：告别 Excel 混乱，这款 SpringBoot3+Vue3 的开源资产管理系统太香了！]]></title>    <link>https://juejin.cn/post/7597709339981824040</link>    <guid>https://juejin.cn/post/7597709339981824040</guid>    <pubDate>2026-01-22T02:49:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597709339981824040" data-draft-id="7597664587459723299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="直击痛点：告别 Excel 混乱，这款 SpringBoot3+Vue3 的开源资产管理系统太香了！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T02:49:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ciciyoyo"/> <meta itemprop="url" content="https://juejin.cn/user/2772311402634652"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            直击痛点：告别 Excel 混乱，这款 SpringBoot3+Vue3 的开源资产管理系统太香了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2772311402634652/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ciciyoyo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:49:00.000Z" title="Thu Jan 22 2026 02:49:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导语</h2>
<p>在数字化转型的今天，很多企业的 IT 资产管理依然停留在“Excel 表格满天飞”的阶段：电脑谁领走了？服务器维保到期了吗？这台设备折旧剩多少？每次盘点都是一场灾难。</p>
<p>虽然国外有 Snipe-IT 这样优秀的产品，但“水土不服”的操作逻辑和语言障碍，让很多国内团队望而却步。<strong>今天，为大家介绍一款专为国人打造的开源 IT 资产管理神器——西柚（Ciyo）资产管理系统。</strong></p>
<hr/>
<h2 data-id="heading-1">🤔 为什么选择西柚 (Ciyo)？</h2>
<p><strong>西柚资产管理系统</strong> 是一款基于 <strong>Spring Boot 3</strong> 和 <strong>Vue 3</strong> 开发的企业级 IT 资产管理平台。</p>
<p>它不只是一个简单的增删改查系统，而是<strong>立足于企业 IT 资产管理的真实痛点</strong>，深度借鉴了国际知名开源项目 Snipe-IT 的核心业务逻辑，并针对<strong>国内企业的复杂的审批流、盘点习惯及资产分类</strong>进行了全方位改良。它既有国际化产品的严谨逻辑，又有本土化产品的顺滑体验。</p>
<h2 data-id="heading-2">✨ 核心亮点：不仅好看，更加从容</h2>
<h3 data-id="heading-3">1. 📦 资产全生命周期管理，拒绝“糊涂账”</h3>
<p>从设备入库的那一刻起，到领用、借用、调拨，再到维修、退库，直至最终报废，西柚系统提供了<strong>如电影胶卷般清晰的完整链路追踪</strong>。</p>
<ul>
<li><strong>一键追溯</strong>：不仅记录“谁在用”，更记录“谁用过”。随时调取设备历史流转档案，责任清晰可追溯。</li>
<li><strong>状态可视化</strong>：闲置、在用、维修、报废...每种状态都有专属视觉标识，资产分布情况一目了然，彻底告别资产“失联”。</li>
</ul>
<h3 data-id="heading-4">2. 📱 手机扫码，智能盘点 (开发中 🚧)</h3>
<p>告别纸质表单和人工勾兑！我们正在打造一套<strong>颠覆性的移动盘点体验</strong>：</p>
<ul>
<li><strong>移动端自由行</strong>：无需购买昂贵的 PDA 手持终端，管理员用手机就能完成盘点任务。</li>
<li><strong>极速扫码</strong>：支持资产标签二维码/条形码毫秒级识别，自动比对系统库存，效率提升 10 倍以上。</li>
<li><strong>智能差异分析</strong>：盘点结束系统自动生成差异报告，哪里多了、哪里少了，数据自动对其，让库存管理不再依靠“玄学”。</li>
</ul>
<h3 data-id="heading-5">3. 💰 财务视角，哪怕一分钱也要算清楚</h3>
<p>资产管理不仅仅是管“物”，核心更是管“钱”。西柚为您内置了<strong>专业的财务折旧引擎</strong>。</p>
<ul>
<li><strong>自动化计算</strong>：内置直线法等主流折旧算法，系统每晚自动计算资产净值，精确到分。</li>
<li><strong>报表导出</strong>：一键导出符合财务审计要求的资产折旧报表，让行政与财务的月底对账从“噩梦”变成“下午茶时间”。</li>
</ul>
<h3 data-id="heading-6">4. 🛠️ 极致技术栈，专为开发者打造的艺术品</h3>
<p>对于开发者而言，西柚不仅好用，更是<strong>值得学习和二开的优秀开源范本</strong>。我们拒绝陈旧技术，拥抱未来：</p>
<ul>
<li><strong>前沿后端</strong>：采用 <strong>Spring Boot 3.4 + JDK 17</strong> 黄金组合，配合 MyBatis Plus，性能狂飙，代码规范如诗。</li>
<li><strong>现代前端</strong>：<strong>Vue 3.5 + Vite 7.1 + UnoCSS</strong>，体验秒开的快感，告别 Webpack 时代的龟速构建。</li>
<li><strong>优雅架构</strong>：精心设计的模块化架构（Admin, Asset, Job...），结构清晰逻辑解耦，拒绝“屎山”代码，让二次开发成为一种享受。</li>
</ul>
<h3 data-id="heading-7">5. 🛡️ 企业级安全与集成</h3>
<ul>
<li><strong>RBAC 权限</strong>：基于角色的精细化权限控制，谁能看、谁能改，分毫不差。</li>
<li><strong>云服务集成</strong>：原生支持阿里云、腾讯云、Minio 等 OSS 对象存储及主流短信服务。</li>
</ul>
<hr/>
<h2 data-id="heading-8">项目截图</h2>
<p><img src="http://openwrite.cn/uploads/4713/58803/486823bc-471e-4dae-962a-e7d07392ce14.png" alt="image.png" loading="lazy"/></p>
<p><img src="http://openwrite.cn/uploads/4713/58803/f136bcc0-72c2-448b-a127-69a5846226b5.png" alt="image.png" loading="lazy"/></p>
<p><img src="http://openwrite.cn/uploads/4713/58803/d5c88206-f2fe-42f8-8225-cef0e691d99c.png" alt="image.png" loading="lazy"/></p>
<p><img src="http://openwrite.cn/uploads/4713/58803/24dc51e6-1ea3-4dc5-8f1d-efb2435f17c0.png" alt="image.png" loading="lazy"/></p>
<p><img src="http://openwrite.cn/uploads/4713/58803/5ce563fa-aa28-4102-8e08-9718f96f8f2e.png" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">🚀 快速上手</h2>
<p>项目完全开源，支持私有化部署。</p>
<p><strong>环境要求：</strong></p>
<ul>
<li>JDK 17+</li>
<li>MySQL 8.0+</li>
<li>Node.js 20+</li>
</ul>
<p><strong>后端启动：</strong></p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://gitee.com/sanbox/ciyo-itasset.git
<span class="hljs-comment"># 导入 sql/ciyo-itam.sql 数据库脚本</span>
<span class="hljs-comment"># 修改配置文件数据库连接</span>
<span class="hljs-comment"># 运行 CiyoAssetApiApplication</span>
</code></pre>
<p><strong>前端启动：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> itasset-front
pnpm install &amp;&amp; pnpm dev
</code></pre>
<hr/>
<h2 data-id="heading-10">📅 未来规划 (开发中 🚧)</h2>
<p>我们致力于打造最懂国内企业的资产管理系统，目前以下重磅功能正在<strong>紧锣密鼓地开发中</strong>，敬请期待：</p>
<ul>
<li>🔄 <strong>可视化审批流</strong> (开发中)：拖拽配置审批节点，支持会签、条件分支，满足不同企业的个性化审批需求。</li>
<li>📝 <strong>超级自定义字段</strong> (开发中)：文本、附件、日期...想加什么字段自己定，无需改代码。</li>
<li>🔌 <strong>第三方生态集成</strong> (规划中)：逐步打通钉钉、企业微信、飞书，实现消息实时触达与快捷审批。</li>
<li>📊 <strong>BI 数据大屏</strong> (规划中)：提供更多维度的可视化数据报表，辅助企业资产决策。</li>
<li>🚀 <strong>更多惊喜</strong>：持续迭代优化，欢迎在 Issue 中提出您的宝贵建议！</li>
</ul>
<h2 data-id="heading-11">🤝 参与共建</h2>
<p>开源不易，如果你觉得这个项目对你有帮助，欢迎来我们的代码仓库点个 <strong>Star ⭐️</strong> 支持一下！也欢迎提交 Issue 或 PR，让我们一起把西柚做得更好。</p>
<ul>
<li><strong>演示地址</strong>: <a href="https://link.juejin.cn?target=http%3A%2F%2F101.35.25.237%2F" target="_blank" title="http://101.35.25.237/" ref="nofollow noopener noreferrer">http://101.35.25.237/</a> (账号: admin / 12345678)</li>
<li><strong>Gitee</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsanbox%2Fciyo-itasset" target="_blank" title="https://gitee.com/sanbox/ciyo-itasset" ref="nofollow noopener noreferrer">gitee.com/sanbox/ciyo…</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fciciyoyo%2Fciyo-itasset" target="_blank" title="https://github.com/ciciyoyo/ciyo-itasset" ref="nofollow noopener noreferrer">github.com/ciciyoyo/ci…</a></li>
</ul>
<p><strong>#开源 #SpringBoot3 #Vue3 #资产管理 #ITAM #SnipeIT #Web开发</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[零信任编程：如何设计一套 AI 无法逃逸的“AI 逻辑沙盒”？]]></title>    <link>https://juejin.cn/post/7597725815917133865</link>    <guid>https://juejin.cn/post/7597725815917133865</guid>    <pubDate>2026-01-22T00:05:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597725815917133865" data-draft-id="7596997542042337323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="零信任编程：如何设计一套 AI 无法逃逸的“AI 逻辑沙盒”？"/> <meta itemprop="keywords" content="前端,代码规范,Node.js"/> <meta itemprop="datePublished" content="2026-01-22T00:05:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="donecoding"/> <meta itemprop="url" content="https://juejin.cn/user/3192637500430093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            零信任编程：如何设计一套 AI 无法逃逸的“AI 逻辑沙盒”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637500430093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    donecoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:05:43.000Z" title="Thu Jan 22 2026 00:05:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前言</p>
<p>在上一篇文章《从 Vibe Coding 到责任归属》中，我们达成了一个共识：<strong>AI 不坐牢，责任人承担。</strong></p>
<p>既然责任无法规避，那么作为架构师，我们唯一能做的就是：<strong>像约束 Docker 容器一样，约束 AI 产出的代码。</strong></p>
<p>今天，我将分享一套名为 <strong>「AI 逻辑沙盒 (AI Logic Sandbox)」</strong> 的工程治理方案。它的核心逻辑不是靠“嘴”去命令 AI，而是通过<strong>编译时授权</strong>与<strong>静态隔离</strong>，从物理上锁死 AI 代码的破坏半径。</p>
<hr/>
<p>一、 核心痛点：AI 的“先验知识”逃逸</p>
<p>为什么传统的 Prompt 约束总是失效？<br/>
因为 AI（如 Claude 或 GPT）拥有庞大的<strong>先验知识</strong>。即便你在 Prompt 里写了“不要使用原生 Fetch”，但它知道这段代码运行在浏览器环境。一旦逻辑陷入复杂，它会本能地调用 <code>window</code>、<code>localStorage</code> 甚至 <code>document.cookie</code>。</p>
<p><strong>只要环境是开放的，AI 就会存在“逻辑逃逸”。</strong></p>
<p>为了解决这个问题，我们需要在项目中开辟一个特殊的目录 —— <strong>AI 逻辑沙盒区</strong>。在这个区域内，AI 的“上帝视角”将被剥夺，它只能看到你允许它看到的世界。</p>
<hr/>
<p>二、 方案设计：基于“契约”的双层宏架构</p>
<p>为了实现这种颗粒度的控制，我设计了一套名为 <strong><code>Define-Apply</code></strong> 的双层编译宏体系。它将权限控制从“运行时”提前到了“开发态”。</p>
<ol>
<li>宿主层：定义权限边界（Define）</li>
</ol>
<p>在沙盒的入口处，由架构师（人类）显式定义该模块的权限：</p>
<p>typescript</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 宿主定义：这个 AI 模块能动什么？</span>
defineEnvContext&lt;{
  <span class="hljs-comment">// 授权事件监听：必须成对出现，确保 AI 能够清理副作用，避免内存泄露</span>
  window: Pick&lt;Window, <span class="hljs-string">'addEventListener'</span> | <span class="hljs-string">'removeEventListener'</span>&gt;, 
  document: Pick&lt;Document, <span class="hljs-string">'getElementById'</span>&gt;
}&gt;();

defineImportContext&lt;{
  debounce: <span class="hljs-function"><span class="hljs-keyword">typeof</span> <span class="hljs-title">import</span>(<span class="hljs-params"><span class="hljs-string">'lodash/debounce'</span></span>) <span class="hljs-comment">// 仅允许引入特定的工具函数</span>
}&gt;()</span>;
</code></pre>
<p>请谨慎使用此类代码。</p>
<blockquote>
<p><strong>注意：</strong>  这里我们同时 <code>Pick</code> 出了移除监听的权限。在沙盒模式下，架构师必须通过 API 声明强制 AI 关注副作用的闭环。如果你不给 AI 移除监听的权限，它写出的代码就无法通过沙盒内部的工程审计。</p>
</blockquote>
<ol start="2">
<li>AI 侧：申请能力接入（Apply）</li>
</ol>
<p>在逻辑沙盒内部，AI 编写的代码必须通过以下宏来获取能力：</p>
<p>typescript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// AI 使用：我行使被授予的能力</span>
<span class="hljs-keyword">const</span> { <span class="hljs-variable language_">window</span>, <span class="hljs-variable language_">document</span> } = applyEnvContext&lt;<span class="hljs-title class_">GlobalApi</span>&gt;();
<span class="hljs-keyword">const</span> { debounce } = applyImportContext&lt;<span class="hljs-title class_">ImportModules</span>&gt;();

<span class="hljs-comment">// AI 之后编写的逻辑将被锁死在上述解构出的变量中</span>
</code></pre>
<p>请谨慎使用此类代码。</p>
<hr/>
<p>三、 物理沙箱：如何实现“环境抹除”？</p>
<p>仅仅有宏是不够 determined，我们需要利用 <strong>TypeScript</strong> 和 <strong>ESLint</strong> 的层级配置特性，为沙盒构建“边界”。</p>
<ol>
<li>类型层面的“环境盲盒”</li>
</ol>
<p>我们在沙盒文件夹下放置一个定制的 <code>tsconfig.json</code>。通过配置 <code>lib: ["ESNext"]</code> 并<strong>移除 <code>"DOM"</code> 库</strong>，我们从类型系统层面抹除了 <code>window</code> 和 <code>document</code> 的存在。</p>
<ul>
<li><strong>结果</strong>：AI 尝试直接写 <code>window.location</code> 时，IDE 会直接报红。它必须通过 <code>applyEnvContext</code> 来获取那份被“阉割”过的环境对象。</li>
</ul>
<ol start="2">
<li>语法层面的“铁丝网”</li>
</ol>
<p>通过特定的 ESLint 规则，我们强制执行以下约束：</p>
<ul>
<li><strong>根规则覆盖</strong>：设置 <code>root: true</code>，切断父级目录的宽松配置。</li>
<li><strong>零全局变量</strong>：开启 <code>no-undef</code>，且禁止任何未经宏声明的外部 <code>import</code>。</li>
<li><strong>禁止逃逸</strong>：拦截任何尝试通过原生 <code>require</code> 或动态 <code>import()</code> 探测项目隐私的行为。</li>
</ul>

<hr/>
<p>四、 自动化映射：从“声明”到“拦截”</p>
<p>这套方案最高效的地方在于：<strong>配置是自动生成的。</strong></p>
<p>我设计了一个<strong>映射脚本（Mapping Script）</strong>  ，它会静态扫描宿主侧的 <code>define</code> 宏：</p>
<ol>
<li><strong>解析泛型</strong>：提取出你 <code>Pick</code> 出来的属性名。</li>
<li><strong>同步配置</strong>：自动将这些属性填入该文件夹下的 <code>.eslintrc.js</code> 白名单中。</li>
<li><strong>动态构建</strong>：自动生成一个受限的 <code>.d.ts</code> 类型定义文件，供该目录下的 TS 引擎使用。</li>
</ol>
<p><strong>这意味着：架构师只需要修改一行 TS 接口定义，整个 AI 逻辑沙盒的安全边界就会自动完成“扩容”或“收缩”。</strong></p>
<hr/>
<p>结语：将权力关进笼子</p>
<p>「AI 逻辑沙盒」的本质，是把原本模糊的“代码审查”变成了清晰的  <strong>“权限审批”</strong>  。</p>
<ul>
<li>你不需要读懂 AI 内部的每一行循环。</li>
<li>你只需要审批它申请的 <code>defineImportContext</code> 是否合规。</li>
<li><strong>只要编译通过，就代表这份代码的风险已经被物理性地限制在了你设定的方寸之间。</strong></li>
</ul>
<p>这是我们应对 2026 年大规模 AI 协作的底层防线。在下一篇实战篇中，我将深入底层，分享如何编写这个<strong>自动化映射脚本</strong>，以及如何通过 <strong>SWC/Babel 插件</strong>在构建时处理这些宏。</p>
<p><strong>欢迎关注专栏 [《AI 原生工程：逻辑沙盒与零信任代码治理》]，我们下一篇聊聊“自动化拦截”的技术落地。</strong></p>
<hr/>
<p><strong>讨论点：</strong><br/>
如果是你，你会给 AI 开放哪些“危险”权限？这种基于“编译宏”的隔离思路，是否能解决你对 AI 代码失控的担忧？欢迎评论区见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LeetCode 15｜三数之和：从暴力到双指针，一次性把“去重”讲清楚]]></title>    <link>https://juejin.cn/post/7597708846769897510</link>    <guid>https://juejin.cn/post/7597708846769897510</guid>    <pubDate>2026-01-22T00:34:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597708846769897510" data-draft-id="7595837635559735330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LeetCode 15｜三数之和：从暴力到双指针，一次性把“去重”讲清楚"/> <meta itemprop="keywords" content="LeetCode,算法"/> <meta itemprop="datePublished" content="2026-01-22T00:34:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YukiMori23"/> <meta itemprop="url" content="https://juejin.cn/user/4022441007125707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LeetCode 15｜三数之和：从暴力到双指针，一次性把“去重”讲清楚
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4022441007125707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YukiMori23
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:34:22.000Z" title="Thu Jan 22 2026 00:34:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>三数之和（Three Sum）是一个<strong>非常经典、非常容易写错、也非常适合训练思维</strong>的题。</p>
<p>很多人第一次做这题的状态是：</p>
<ul>
<li>思路能想出来</li>
<li>代码能跑</li>
<li>结果一堆重复答案，直接 GG</li>
</ul>
<p>这篇笔记，我会围绕一个核心目标来讲：</p>
<blockquote>
<p><strong>为什么一定要排序 + 双指针？<br/>
去重到底在去什么？</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、题目回顾</h2>
<p>给你一个整数数组 <code>nums</code>，判断是否存在三个元素 <code>a, b, c</code>，使得：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span> + c = <span class="hljs-number">0</span>
</code></pre>
<p>返回所有<strong>不重复的三元组</strong>。</p>
<p>注意关键词：<br/>
<strong>不重复</strong>，这是这道题的灵魂。</p>
<hr/>
<h2 data-id="heading-1">二、为什么暴力解法不行？</h2>
<p>最直观的写法是三层循环：</p>
<pre><code class="hljs language-ini" lang="ini">i + j + <span class="hljs-attr">k</span> == <span class="hljs-number">0</span>
</code></pre>
<p>问题有两个：</p>
<ol>
<li>时间复杂度是 O(n³)，数组稍微大一点就超时</li>
<li>完全没法优雅地去重</li>
</ol>
<p>所以这道题的正确打开方式只有一条路：</p>
<blockquote>
<p><strong>先排序，再用双指针</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-2">三、排序的真正意义</h2>
<p>排序不是为了好看，而是为了两件事：</p>
<ol>
<li><strong>让双指针成立</strong></li>
<li><strong>让去重变得可能</strong></li>
</ol>
<p>排序之后，数组满足：</p>
<pre><code class="hljs language-css" lang="css">nums<span class="hljs-selector-attr">[i]</span> &lt;= nums<span class="hljs-selector-attr">[left]</span> &lt;= nums<span class="hljs-selector-attr">[right]</span>
</code></pre>
<p>这会带来一个非常重要的性质：</p>
<ul>
<li>当前和小了，只能让 left 右移</li>
<li>当前和大了，只能让 right 左移</li>
</ul>
<p>这是双指针成立的数学基础。</p>
<hr/>
<h2 data-id="heading-3">四、整体思路拆解</h2>
<p>整体逻辑可以拆成三层：</p>
<ol>
<li>固定第一个数 <code>i</code></li>
<li>在 <code>i</code> 右侧，用双指针找 <code>left + right = -nums[i]</code></li>
<li>在三个层面上去重</li>
</ol>
<hr/>
<h2 data-id="heading-4">五、完整代码</h2>
<pre><code class="hljs language-ini" lang="ini">class Solution {
    public List&lt;List&lt;Integer&gt;&gt; threeSum(int<span class="hljs-section">[]</span> nums) {
        List&lt;List&lt;Integer&gt;&gt; <span class="hljs-attr">res</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
        Arrays.sort(nums)<span class="hljs-comment">;</span>

        int <span class="hljs-attr">n</span> = nums.length<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n - 2; i++) {</span>

            // 第一层去重：固定数 nums<span class="hljs-section">[i]</span>
            if (i &gt; 0 &amp;&amp; nums<span class="hljs-section">[i]</span> == nums<span class="hljs-section">[i - 1]</span>) {
                continue<span class="hljs-comment">;</span>
            }

            int <span class="hljs-attr">left</span> = i + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
            int <span class="hljs-attr">right</span> = n - <span class="hljs-number">1</span><span class="hljs-comment">;</span>

            while (left &lt; right) {
                int <span class="hljs-attr">sum</span> = nums[i] + nums[left] + nums[right]<span class="hljs-comment">;</span>

                if (<span class="hljs-attr">sum</span> == <span class="hljs-number">0</span>) {
                    res.add(Arrays.asList(nums<span class="hljs-section">[i]</span>, nums<span class="hljs-section">[left]</span>, nums<span class="hljs-section">[right]</span>))<span class="hljs-comment">;</span>

                    // 第二层去重：left
                    while (left &lt; right &amp;&amp; nums<span class="hljs-section">[left]</span> == nums<span class="hljs-section">[left + 1]</span>) {
                        left++<span class="hljs-comment">;</span>
                    }

                    // 第三层去重：right
                    while (left &lt; right &amp;&amp; nums<span class="hljs-section">[right]</span> == nums<span class="hljs-section">[right - 1]</span>) {
                        right--<span class="hljs-comment">;</span>
                    }

                    left++<span class="hljs-comment">;</span>
                    right--<span class="hljs-comment">;</span>
                } else if (sum &lt; 0) {
                    left++<span class="hljs-comment">;</span>
                } else {
                    right--<span class="hljs-comment">;</span>
                }
            }
        }
        return res<span class="hljs-comment">;</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-5">六、三层去重，逐层讲清楚</h2>
<p>这是这道题<strong>最容易写错、也最值得理解的部分</strong>。</p>
<h3 data-id="heading-6">1. 第一层去重：i 不能重复</h3>
<pre><code class="hljs language-css" lang="css">if (<span class="hljs-selector-tag">i</span> &gt; <span class="hljs-number">0</span> &amp;&amp; nums<span class="hljs-selector-attr">[i]</span> == nums<span class="hljs-selector-attr">[i - 1]</span>) {
    continue;
}
</code></pre>
<p>含义是：</p>
<ul>
<li>如果当前固定的数和上一次固定的一样</li>
<li>那后面的双指针结果一定也一样</li>
<li>直接跳过，避免重复三元组</li>
</ul>
<p>这是在防止这种情况：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[-1, -1, 0, 1]</span>
 ↑   ↑
 <span class="hljs-selector-tag">i</span>   <span class="hljs-selector-tag">i</span>+<span class="hljs-number">1</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">2. 第二层去重：left 去重</h3>
<pre><code class="hljs language-css" lang="css">while (<span class="hljs-attribute">left</span> &lt; <span class="hljs-attribute">right</span> &amp;&amp; nums<span class="hljs-selector-attr">[left]</span> == nums<span class="hljs-selector-attr">[left + 1]</span>) {
    <span class="hljs-attribute">left</span>++;
}
</code></pre>
<p>当我们已经找到一个合法解：</p>
<pre><code class="hljs language-css" lang="css">nums<span class="hljs-selector-attr">[i]</span> + nums<span class="hljs-selector-attr">[left]</span> + nums<span class="hljs-selector-attr">[right]</span> == <span class="hljs-number">0</span>
</code></pre>
<p>如果 <code>left</code> 指向的值后面还是一样的数：</p>
<pre><code class="hljs language-markdown" lang="markdown">... 0, 0, 0 ...
<span class="hljs-code">     ↑  ↑
</span></code></pre>
<p>继续用它只会得到<strong>一模一样的三元组</strong>。</p>
<p>所以必须跳过。</p>
<hr/>
<h3 data-id="heading-8">3. 第三层去重：right 去重</h3>
<pre><code class="hljs language-sql" lang="sql">while (<span class="hljs-keyword">left</span> <span class="hljs-operator">&lt;</span> <span class="hljs-keyword">right</span> <span class="hljs-operator">&amp;&amp;</span> nums[<span class="hljs-keyword">right</span>] <span class="hljs-operator">=</span><span class="hljs-operator">=</span> nums[<span class="hljs-keyword">right</span> <span class="hljs-operator">-</span> <span class="hljs-number">1</span>]) {
    <span class="hljs-keyword">right</span><span class="hljs-comment">--;</span>
}
</code></pre>
<p>逻辑和 <code>left</code> 完全对称。</p>
<p>你可以把这两层理解为一句话：</p>
<blockquote>
<p><strong>当前解已经用过了，这一整段相同的数都不再有价值</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-9">七、为什么要最后再 <code>left++</code> / <code>right--</code>？</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">left</span><span class="hljs-operator">+</span><span class="hljs-operator">+</span>;
<span class="hljs-keyword">right</span><span class="hljs-comment">--;</span>
</code></pre>
<p>前面的 while 只是“跳过重复值”，<br/>
但当前这对 <code>(left, right)</code> 已经用过了，必须整体向中间推进，继续找新解。</p>
<hr/>
<h2 data-id="heading-10">八、时间与空间复杂度</h2>
<ul>
<li>
<p>时间复杂度：<code>O(n²)</code></p>
<ul>
<li>外层一个 <code>i</code></li>
<li>内层双指针线性扫描</li>
</ul>
</li>
<li>
<p>空间复杂度：<code>O(1)</code>（不算结果集）</p>
</li>
</ul>
<p>这是这道题能做到的最优解法。</p>
<hr/>
<h2 data-id="heading-11">九、总结一句话版</h2>
<ul>
<li>排序是为了双指针和去重</li>
<li>固定一个数，其余两个用左右指针夹逼</li>
<li>去重一定要分三层，缺一不可</li>
</ul>
<p>如果你能把**“为什么要去重、去的是什么重”**讲清楚，<br/>
那这道题你就真的吃透了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 必学：Composition/Options API 选型指南+组合式函数最佳实践]]></title>    <link>https://juejin.cn/post/7597650322408538164</link>    <guid>https://juejin.cn/post/7597650322408538164</guid>    <pubDate>2026-01-22T00:48:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408538164" data-draft-id="7597024900520755252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 必学：Composition/Options API 选型指南+组合式函数最佳实践"/> <meta itemprop="keywords" content="Vue.js,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-22T00:48:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 必学：Composition/Options API 选型指南+组合式函数最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:48:50.000Z" title="Thu Jan 22 2026 00:48:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 生态中，Options API 和 Composition API 是两种核心的代码组织方式。Options API 作为 Vue 2 的默认 API，凭借直观的选项划分降低了新手入门门槛；而 Composition API 则在 Vue 3 中推出，以逻辑组合为核心，解决了大型项目中的代码复用与维护难题。本文将系统对比二者的优劣势，并深入探讨自定义组合式函数（Composables）的最佳实践、命名规范与类型声明，为 Vue 项目开发提供选型与编码参考。</p>
<h2 data-id="heading-0">一、Composition API 与 Options API 优劣势对比</h2>
<p>二者的核心差异源于代码组织逻辑：Options API 按功能划分选项（如 data、methods、computed），Composition API 按业务逻辑划分代码块，各自适配不同的项目场景。</p>
<h3 data-id="heading-1">1.1 Options API 优劣势</h3>
<h4 data-id="heading-2">优势</h4>
<ul>
<li><strong>入门门槛低，直观易懂</strong>：Options API 采用固定的选项结构，data 定义状态、methods 定义方法、computed 定义计算属性，新手能快速理解各部分功能，无需关心代码组织的逻辑关联，上手成本极低。</li>
<li><strong>代码结构规整，约定大于配置</strong>：固定的选项划分使代码具有统一的风格，团队协作时无需额外约定，可直接根据选项定位代码位置，适合小型项目或多人快速上手的场景。</li>
<li><strong>兼容 Vue 2 生态，迁移成本低</strong>：作为 Vue 2 的默认 API，拥有成熟的生态工具与社区案例，现有 Vue 2 项目可无缝沿用，如需迁移到 Vue 3，Options API 仍可正常使用，无需大规模重构。</li>
</ul>
<h4 data-id="heading-3">劣势</h4>
<ul>
<li><strong>逻辑碎片化，维护成本高</strong>：当组件功能复杂时，同一业务逻辑的代码会分散在 data、methods、computed、watch 等多个选项中，形成“碎片化”代码。例如，一个表单提交功能的状态、验证方法、提交逻辑可能分布在不同选项，排查问题时需跨选项跳转，随着代码量增加，维护难度呈指数级上升。</li>
<li><strong>代码复用能力有限</strong>：Options API 主要通过混入（Mixins）实现代码复用，但 Mixins 存在明显缺陷：命名冲突风险、逻辑来源不清晰、依赖关系隐式化，多个 Mixins 叠加时，难以追踪状态与方法的归属，排查问题时耗时耗力。</li>
<li><strong>类型推断支持弱</strong>：在 TypeScript 中，Options API 的选项式结构难以实现精准的类型推断，需额外通过 Vue.extend 或装饰器补充类型定义，代码冗余且易出现类型错误。</li>
</ul>
<h3 data-id="heading-4">1.2 Composition API 优劣势</h3>
<h4 data-id="heading-5">优势</h4>
<ul>
<li><strong>逻辑聚合，维护性强</strong>：Composition API 允许将同一业务逻辑的状态、方法、计算属性、监听逻辑聚合在一个代码块中（通常通过 setup 函数或 
</li><li><strong>灵活的代码复用</strong>：基于逻辑聚合特性，可将通用逻辑封装为组合式函数（Composables），在多个组件中复用。与 Mixins 不同，组合式函数的逻辑来源清晰，无命名冲突风险，且支持传递参数实现逻辑定制，复用能力更强大、灵活。</li>
<li><strong>出色的 TypeScript 支持</strong>：Composition API 天生适配 TypeScript，setup 函数、响应式 API（如 ref、reactive）均可实现精准的类型推断，无需额外冗余代码，能充分发挥 TypeScript 的类型校验能力，减少运行时错误。</li>
<li><strong>逻辑拆分与组合更灵活</strong>：支持将复杂逻辑拆分为多个小型逻辑单元，再根据需求组合使用，既保证了单一逻辑的职责清晰，又能灵活适配不同组件的功能需求，适合大型复杂项目。</li>
</ul>
<h4 data-id="heading-6">劣势</h4>
<ul>
<li><strong>入门门槛较高</strong>：相比 Options API 固定的选项结构，Composition API 需理解响应式 API（ref、reactive、toRefs 等）、生命周期钩子的写法变化，且需手动组织逻辑结构，新手可能出现逻辑混乱的问题。</li>
<li><strong>代码风格不统一风险</strong>：逻辑组织的灵活性可能导致团队内部代码风格差异，若缺乏统一规范，不同开发者的逻辑拆分方式不同，反而降低代码可读性。</li>
<li><strong>小型项目冗余</strong>：对于简单组件（如仅展示数据的静态组件），使用 Composition API 会增加代码量（如 ref 包裹状态、return 暴露属性），反而不如 Options API 简洁。</li>
</ul>
<h3 data-id="heading-7">1.3 选型建议</h3>
<ul>
<li>选择 Options API：小型项目、新手团队、Vue 2 迁移项目、组件逻辑简单且无需复用的场景。</li>
<li>选择 Composition API：大型复杂项目、需要大量逻辑复用的场景、使用 TypeScript 开发的项目、组件逻辑需拆分组合的场景。</li>
</ul>
<h2 data-id="heading-8">二、自定义组合式函数（Composables）最佳实践</h2>
<p>组合式函数是 Composition API 的核心复用载体，本质是封装通用逻辑的函数，命名通常以“use”开头（如 useRequest、useForm），返回需要暴露的状态与方法。遵循最佳实践可保证组合式函数的可复用性、可维护性与易用性。</p>
<h3 data-id="heading-9">2.1 核心原则</h3>
<ul>
<li><strong>单一职责原则</strong>：一个组合式函数只封装一项核心逻辑（如 useRequest 仅处理请求逻辑，useForm 仅处理表单逻辑），避免将多个无关逻辑混入同一函数，确保函数体积小、职责清晰，便于复用与维护。</li>
<li><strong>响应式传递</strong>：函数内部使用 ref、reactive 创建的响应式状态，需通过 return 暴露给组件，组件可直接使用并响应状态变化；若接收外部参数，需确保参数为响应式对象（或通过 toRefs 转换），避免丢失响应式特性。</li>
<li><strong>无副作用优先</strong>：尽量使组合式函数纯函数化，若必须包含副作用（如请求、DOM 操作、定时器），需在函数内部处理副作用的清理（如清除定时器、取消请求），避免内存泄漏。</li>
<li><strong>逻辑隔离</strong>：组合式函数内部逻辑应与组件解耦，不依赖组件的实例（如避免使用 this），仅通过参数接收外部依赖，通过返回值提供能力，确保可在任意组件、甚至非组件环境（如 Pinia）中复用。</li>
</ul>
<h3 data-id="heading-10">2.2 实现要点</h3>
<h4 data-id="heading-11">（1）副作用清理</h4>
<p>包含副作用的组合式函数，需使用 onUnmounted、onDeactivated 等生命周期钩子清理副作用。例如，定时器、事件监听、网络请求等，需在组件卸载时销毁，避免内存泄漏。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// useTimer.ts</span>
<span class="hljs-keyword">import</span> { ref, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTimer</span>(<span class="hljs-params">initialDelay = <span class="hljs-number">1000</span></span>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 启动定时器</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">startTimer</span> = (<span class="hljs-params"/>) =&gt; {
    timer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      count.<span class="hljs-property">value</span>++;
    }, initialDelay);
  };

  <span class="hljs-comment">// 停止定时器</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">stopTimer</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (timer) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">clearInterval</span>(timer);
      timer = <span class="hljs-literal">null</span>;
    }
  };

  <span class="hljs-comment">// 组件卸载时清理定时器</span>
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">stopTimer</span>();
  });

  <span class="hljs-keyword">return</span> { count, startTimer, stopTimer };
}
</code></pre>
<h4 data-id="heading-12">（2）参数可选与默认值</h4>
<p>为提高灵活性，组合式函数的参数应支持可选配置，并设置合理默认值，允许组件根据需求覆盖默认配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// useRequest.ts</span>
<span class="hljs-keyword">import</span> { ref, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> axios, { <span class="hljs-title class_">AxiosRequestConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseRequestOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AxiosRequestConfig</span> {
  autoRun?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否自动触发请求</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useRequest</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, options: UseRequestOptions = {}</span>) {
  <span class="hljs-keyword">const</span> { autoRun = <span class="hljs-literal">true</span>, ...axiosConfig } = options;
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(url, axiosConfig);
      data.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>;
      error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> (err) {
      error.<span class="hljs-property">value</span> = err;
      data.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-comment">// 自动触发请求</span>
  <span class="hljs-keyword">if</span> (autoRun) {
    <span class="hljs-title function_">fetchData</span>();
  }

  <span class="hljs-keyword">return</span> { data, loading, error, fetchData };
}
</code></pre>
<h4 data-id="heading-13">（3）避免命名冲突</h4>
<p>组合式函数返回的状态与方法需命名清晰，避免与组件内部变量、其他组合式函数的返回值重名。可通过前缀、语义化命名区分，例如 useForm 返回的表单状态可命名为 formValue、formErrors，而非 value、errors。</p>
<h3 data-id="heading-14">2.3 命名规范</h3>
<h4 data-id="heading-15">（1）函数命名</h4>
<ul>
<li>必须以“use”开头，遵循驼峰命名法（camelCase），明确标识为组合式函数，便于开发者识别与导入。示例：useRequest、useForm、useScrollPosition。</li>
<li>命名需语义化，准确反映函数封装的逻辑，避免模糊命名。例如，useTimer 比 useUtil 更清晰，useFormValidator 比 useFormCheck 更精准。</li>
</ul>
<h4 data-id="heading-16">（2）文件命名</h4>
<ul>
<li>单个组合式函数的文件，命名与函数名一致，后缀为 .ts（TypeScript）或 .js。示例：useTimer.ts、useRequest.ts。</li>
<li>多个相关组合式函数可放在同一个文件夹下，通过 index.ts 导出，便于批量导入。例如：在 composables/form/ 目录下存放 useForm.ts、useFormValidator.ts，通过 index.ts 聚合导出。</li>
</ul>
<h4 data-id="heading-17">（3）返回值命名</h4>
<ul>
<li>返回的状态与方法需语义化，与函数封装的逻辑强关联。例如，useScrollPosition 返回 scrollX、scrollY（滚动坐标）、updateScrollPosition（更新坐标方法）。</li>
<li>避免使用简写、模糊词汇，如不用 val 代替 value，不用 handle 代替具体动作（如 submit、clear）。</li>
</ul>
<h2 data-id="heading-18">三、组合式函数的类型声明</h2>
<p>在 TypeScript 中，合理的类型声明能提升组合式函数的易用性，避免类型错误，同时提供良好的 IDE 提示。以下是常见场景的类型声明方法。</p>
<h3 data-id="heading-19">3.1 基础类型声明</h3>
<p>对于简单组合式函数，直接通过类型注解声明参数与返回值类型，确保类型精准。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// useCounter.ts</span>
<span class="hljs-keyword">import</span> { ref, <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 声明参数类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseCounterOptions</span> {
  initialValue?: <span class="hljs-built_in">number</span>;
  step?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 声明返回值类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseCounterReturn</span> {
  <span class="hljs-attr">count</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-built_in">number</span>&gt;;
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">options: UseCounterOptions = {}</span>): <span class="hljs-title class_">UseCounterReturn</span> {
  <span class="hljs-keyword">const</span> { initialValue = <span class="hljs-number">0</span>, step = <span class="hljs-number">1</span> } = options;
  <span class="hljs-keyword">const</span> count = ref&lt;<span class="hljs-built_in">number</span>&gt;(initialValue);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span> += step;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span> -= step;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span> = initialValue;
  };

  <span class="hljs-keyword">return</span> { count, increment, decrement, reset };
}
</code></pre>
<h3 data-id="heading-20">3.2 泛型类型声明</h3>
<p>当组合式函数需适配多种数据类型时，使用泛型（Generic）声明，提高函数的灵活性与复用性。例如，封装一个通用的列表请求函数，支持不同类型的列表数据。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// useList.ts</span>
<span class="hljs-keyword">import</span> { ref, <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseListOptions</span>&lt;T&gt; {
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
  autoRun?: <span class="hljs-built_in">boolean</span>;
  formatData?: <span class="hljs-function">(<span class="hljs-params">rawData: <span class="hljs-built_in">any</span></span>) =&gt;</span> T[]; <span class="hljs-comment">// 数据格式化函数</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseListReturn</span>&lt;T&gt; {
  <span class="hljs-attr">list</span>: <span class="hljs-title class_">Ref</span>&lt;T[]&gt;;
  <span class="hljs-attr">loading</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-built_in">boolean</span>&gt;;
  <span class="hljs-attr">error</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;;
  <span class="hljs-attr">fetchList</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useList&lt;T = <span class="hljs-built_in">any</span>&gt;(<span class="hljs-attr">options</span>: <span class="hljs-title class_">UseListOptions</span>&lt;T&gt;): <span class="hljs-title class_">UseListReturn</span>&lt;T&gt; {
  <span class="hljs-keyword">const</span> { url, autoRun = <span class="hljs-literal">true</span>, formatData = <span class="hljs-function">(<span class="hljs-params">raw</span>) =&gt;</span> raw.<span class="hljs-property">data</span> } = options;
  <span class="hljs-keyword">const</span> list = ref&lt;T[]&gt;([]) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Ref</span>&lt;T[]&gt;;
  <span class="hljs-keyword">const</span> loading = ref&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> error = ref&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(url);
      list.<span class="hljs-property">value</span> = <span class="hljs-title function_">formatData</span>(res.<span class="hljs-property">data</span>);
      error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> (err) {
      error.<span class="hljs-property">value</span> = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
      list.<span class="hljs-property">value</span> = [];
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">if</span> (autoRun) {
    <span class="hljs-title function_">fetchList</span>();
  }

  <span class="hljs-keyword">return</span> { list, loading, error, fetchList };
}
</code></pre>
<p>使用时可指定具体类型，获得精准的类型提示：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 声明列表项类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 使用泛型组合式函数</span>
<span class="hljs-keyword">const</span> { list, loading } = useList&lt;<span class="hljs-title class_">User</span>&gt;({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/users'</span>,
  <span class="hljs-attr">formatData</span>: <span class="hljs-function">(<span class="hljs-params">raw</span>) =&gt;</span> raw.<span class="hljs-property">users</span> <span class="hljs-comment">// 类型校验：确保返回 User[] 类型</span>
});

<span class="hljs-comment">// list 自动推断为 Ref&lt;User[]&gt;，IDE 提供 User 属性提示</span>
list.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>);
});
</code></pre>
<h3 data-id="heading-21">3.3 响应式类型处理</h3>
<p>组合式函数中常用 ref、reactive 创建响应式状态，类型声明需注意以下几点：</p>
<ul>
<li>ref 类型：通过 ref(initialValue) 声明，若初始值为 null/undefined，需明确类型（如 ref&lt;User | null&gt;(null)）。</li>
<li>reactive 类型：直接为 reactive 传递接口类型，例如 const form = reactive({ name: '', age: 0 })。</li>
<li>toRefs 类型：当需解构 reactive 对象时，使用 toRefs 保持响应式，类型自动继承原对象类型，例如 const { name, age } = toRefs(form)，name 自动推断为 Ref。</li>
</ul>
<h2 data-id="heading-22">四、总结</h2>
<p>Options API 与 Composition API 并非对立关系，而是适配不同场景的技术方案：Options API 适合简单场景与新手入门，Composition API 则更擅长解决大型项目的逻辑复用与维护问题。自定义组合式函数作为 Composition API 的核心复用载体，需遵循单一职责、响应式传递、副作用清理等原则，配合规范的命名与精准的类型声明，才能充分发挥其灵活性与可复用性。</p>
<p>在实际开发中，建议根据项目规模、团队技术栈（是否使用 TypeScript）、逻辑复杂度选择合适的 API 方案，并制定统一的组合式函数开发规范，提升团队协作效率与代码质量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS 模块module]]></title>    <link>https://juejin.cn/post/7597695531217977394</link>    <guid>https://juejin.cn/post/7597695531217977394</guid>    <pubDate>2026-01-22T01:40:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597695531217977394" data-draft-id="7597708846770356262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS 模块module"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T01:40:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS 模块module
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T01:40:47.000Z" title="Thu Jan 22 2026 01:40:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. <code>module</code> 的核心含义</h3>
<p><code>type="module"</code> 是 HTML 给 <code>&lt;script&gt;</code> 标签新增的一个属性值，它告诉浏览器：<strong>这个脚本文件要按照 ES 模块（ES Module，简称 ESM）的规范来解析和执行</strong>，而不是按照传统的普通脚本（script）方式执行。</p>
<p>简单来说，<code>module</code> 就是把脚本标记为 “ES 模块”，让浏览器启用 ES 模块的所有特性，这是现代前端模块化开发的基础。</p>
<h3 data-id="heading-1">2. 普通脚本 vs module 脚本的核心区别</h3>
<p>为了让你更清楚，先对比传统脚本和模块脚本的关键差异：</p>



































<table><thead><tr><th>特性</th><th>普通脚本 (<code>&lt;script&gt;</code>)</th><th>模块脚本 (<code>&lt;script type="module"&gt;</code>)</th></tr></thead><tbody><tr><td>作用域</td><td>全局作用域</td><td>模块私有作用域（变量不污染全局）</td></tr><tr><td>导入导出</td><td>不支持 <code>import/export</code></td><td>支持 <code>import/export</code> 语法</td></tr><tr><td>执行时机</td><td>解析到就执行</td><td>等待 HTML 解析完成后执行（同 <code>defer</code>）</td></tr><tr><td>严格模式</td><td>需手动声明 <code>'use strict'</code></td><td>自动启用严格模式</td></tr><tr><td>重复加载</td><td>多次执行</td><td>只加载 / 执行一次</td></tr></tbody></table>
<h3 data-id="heading-2">3. 代码示例：直观理解 <code>module</code> 的作用</h3>
<h4 data-id="heading-3">示例 1：模块脚本的基础使用</h4>
<p>假设有两个文件：</p>
<ul>
<li><code>utils.js</code>（模块文件）</li>
</ul>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导出一个函数（ES 模块语法）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
}

<span class="hljs-comment">// 模块内的变量，不会污染全局</span>
<span class="hljs-keyword">const</span> moduleVar = <span class="hljs-string">"我是模块私有变量"</span>;
</code></pre>
<ul>
<li><code>index.html</code>（引入模块）</li>
</ul>
<p>预览</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 以 module 方式引入脚本，才能使用 import/export --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 导入模块中的函数（只有 type=module 才支持）</span>
    <span class="hljs-keyword">import</span> { sayHello } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sayHello</span>(<span class="hljs-string">'张三'</span>)); <span class="hljs-comment">// 输出：Hello, 张三!</span>
    <span class="hljs-comment">// 无法访问 moduleVar，因为它是模块私有变量</span>
    <span class="hljs-comment">// console.log(moduleVar); // 报错：moduleVar is not defined</span>
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 普通脚本，不支持 import/export --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// import { sayHello } from './utils.js'; // 报错：Unexpected token 'import'</span>
    <span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">"我是全局变量"</span>;
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">示例 2：模块脚本的自动严格模式</h4>
<p>预览</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 自动启用严格模式，无需手动写 'use strict'</span>
  undeclaredVar = <span class="hljs-number">123</span>; <span class="hljs-comment">// 报错：undeclaredVar is not defined（严格模式下未声明变量不能赋值）</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 普通脚本默认非严格模式</span>
  undeclaredVar = <span class="hljs-number">123</span>; <span class="hljs-comment">// 不报错，undeclaredVar 成为全局变量</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">总结</h3>
<ol>
<li><code>type="module"</code> 中的 <code>module</code> 本质是告诉浏览器：该脚本是 <strong>ES 模块</strong>，需按 ESM 规范解析执行。</li>
<li>模块脚本的核心特性：支持 <code>import/export</code>、私有作用域、自动严格模式、延迟执行（同 <code>defer</code>）。</li>
<li>普通脚本无这些特性，变量会污染全局，也无法使用 ES 模块的导入导出语法。</li>
</ol>
<p>简单来说，加了 <code>type="module"</code>，你的 JS 代码就拥有了现代模块化开发的能力，这也是目前前端项目中最常用的脚本执行方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react的Scheduler源码解析]]></title>    <link>https://juejin.cn/post/7597699032213618742</link>    <guid>https://juejin.cn/post/7597699032213618742</guid>    <pubDate>2026-01-22T01:19:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597699032213618742" data-draft-id="7597679732365606954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react的Scheduler源码解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-22T01:19:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Blackeyes"/> <meta itemprop="url" content="https://juejin.cn/user/3861140568283869"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react的Scheduler源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861140568283869/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Blackeyes
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T01:19:25.000Z" title="Thu Jan 22 2026 01:19:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">react的Scheduler源码解析</h2>
<p>react版本：18.3.1</p>
<p>位置：packages\scheduler\src\forks\Scheduler.js</p>
<h4 data-id="heading-1">是什么？</h4>
<p>对不同优先级任务进行调度，使高优先级先执行，低优先级后执行。</p>
<h4 data-id="heading-2">解决的问题？</h4>
<p>解决页面卡顿问题，js单线程，大任务会阻塞浏览器的绘制，导致页面卡顿。</p>
<h4 data-id="heading-3">怎么解决的？</h4>
<p>把任务分片，在浏览器空余时间去执行，通过优先级分配顺序</p>
<h4 data-id="heading-4">怎么使用？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { unstable_scheduleCallback } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"scheduler"</span>)
<span class="hljs-keyword">const</span> tasks = [<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>]

tasks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">priority , i</span>) =&gt;</span> {
  <span class="hljs-title function_">unstable_scheduleCallback</span>(priority , <span class="hljs-function">()=&gt;</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`优先级<span class="hljs-subst">${priority}</span>`</span> , <span class="hljs-string">`第<span class="hljs-subst">${i}</span>任务`</span>)
  })
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"同步任务"</span>)
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"微任务"</span>))

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 同步任务</span>
<span class="hljs-comment">// 微任务</span>
<span class="hljs-comment">// 优先级1，第0个任务</span>
<span class="hljs-comment">// 优先级1，第1个任务</span>
<span class="hljs-comment">// 优先级1，第8个任务</span>
<span class="hljs-comment">// 优先级1，第12个任务</span>
<span class="hljs-comment">// 优先级1，第18个任务</span>
<span class="hljs-comment">// 优先级1，第19个任务</span>
<span class="hljs-comment">// 优先级1，第20个任务</span>
<span class="hljs-comment">// 优先级1，第21个任务</span>
<span class="hljs-comment">// 优先级2，第2个任务</span>
<span class="hljs-comment">// 优先级2，第3个任务</span>
<span class="hljs-comment">// 优先级2，第9个任务</span>
<span class="hljs-comment">// 优先级2，第13个任务</span>
<span class="hljs-comment">//  ...</span>
</code></pre>
<p>Scheduler中的优先级</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ImmediatePriority</span> = <span class="hljs-number">1</span>;     <span class="hljs-comment">// 超时优先级：需要立即执行的任务       </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserBlockingPriority</span> = <span class="hljs-number">2</span>;  <span class="hljs-comment">// 用户阻塞优先级：用户交互相关任务    </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NormalPriority</span> = <span class="hljs-number">3</span>;        <span class="hljs-comment">// 普通优先级：常规更新任务         </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LowPriority</span> = <span class="hljs-number">4</span>;           <span class="hljs-comment">// 低优先级：可延迟执行的任务         </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">IdlePriority</span> = <span class="hljs-number">5</span>;          <span class="hljs-comment">// 空闲优先级：在空闲时执行的任务   </span>
</code></pre>
<p>Scheduler中的全局变量</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> maxSigned31BitInt = <span class="hljs-number">1073741823</span>;

<span class="hljs-comment">// 不同优先级对应时间，会和当前时间相加，计算出过期时间点</span>
<span class="hljs-keyword">var</span> <span class="hljs-variable constant_">IMMEDIATE_PRIORITY_TIMEOUT</span> = -<span class="hljs-number">1</span>;

<span class="hljs-keyword">var</span> <span class="hljs-variable constant_">USER_BLOCKING_PRIORITY_TIMEOUT</span> = <span class="hljs-number">250</span>;
<span class="hljs-keyword">var</span> <span class="hljs-variable constant_">NORMAL_PRIORITY_TIMEOUT</span> = <span class="hljs-number">5000</span>;
<span class="hljs-keyword">var</span> <span class="hljs-variable constant_">LOW_PRIORITY_TIMEOUT</span> = <span class="hljs-number">10000</span>;

<span class="hljs-keyword">var</span> <span class="hljs-variable constant_">IDLE_PRIORITY_TIMEOUT</span> = maxSigned31BitInt;

<span class="hljs-keyword">var</span> taskQueue = [];  <span class="hljs-comment">// 立即执行任务队列</span>
<span class="hljs-keyword">var</span> timerQueue = [];  <span class="hljs-comment">// 延迟执行任务队列</span>

<span class="hljs-keyword">var</span> taskIdCounter = <span class="hljs-number">1</span>; <span class="hljs-comment">// 任务ID计数器</span>

<span class="hljs-keyword">var</span> isSchedulerPaused = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">var</span> currentTask = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 当前正在执行的任务对象</span>
<span class="hljs-keyword">var</span> currentPriorityLevel = <span class="hljs-title class_">NormalPriority</span>;  <span class="hljs-comment">// 当前调度器优先级</span>

<span class="hljs-keyword">var</span> isPerformingWork = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 是否正在执行工作循环</span>

<span class="hljs-keyword">var</span> isHostCallbackScheduled = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 是否已安排工作循环调度</span>
<span class="hljs-keyword">var</span> isHostTimeoutScheduled = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 是否已安排延迟任务检查</span>
</code></pre>
<p>小顶堆</p>
<p>本质就是一棵二叉树结构，这里用数组模拟的，它的堆顶永远维持着最小值（最高任务），对外暴露3个方法，push 往堆中塞入一个元素，pop 弹出堆顶元素，peek获取堆顶元素</p>
<p>用节点的 sortIndex作为判断依据 ，如果比较不了，就是用ID，也就是顺序了</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">compare</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">const</span> diff = a.<span class="hljs-property">sortIndex</span> - b.<span class="hljs-property">sortIndex</span>;
  <span class="hljs-keyword">return</span> diff !== <span class="hljs-number">0</span> ? diff : a.<span class="hljs-property">id</span> - b.<span class="hljs-property">id</span>;
}
</code></pre>
<p>Scheduler暴露出的api</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> {
  <span class="hljs-title class_">ImmediatePriority</span> <span class="hljs-keyword">as</span> unstable_ImmediatePriority,
  <span class="hljs-title class_">UserBlockingPriority</span> <span class="hljs-keyword">as</span> unstable_UserBlockingPriority,
  <span class="hljs-title class_">NormalPriority</span> <span class="hljs-keyword">as</span> unstable_NormalPriority,
  <span class="hljs-title class_">IdlePriority</span> <span class="hljs-keyword">as</span> unstable_IdlePriority,
  <span class="hljs-title class_">LowPriority</span> <span class="hljs-keyword">as</span> unstable_LowPriority,
  unstable_runWithPriority,
  unstable_next,
  unstable_scheduleCallback,  <span class="hljs-comment">// 入口方法，开启调度</span>
  unstable_cancelCallback,    <span class="hljs-comment">// 取消任务</span>
  unstable_wrapCallback,			<span class="hljs-comment">// 包裹任务</span>
  unstable_getCurrentPriorityLevel,
  shouldYieldToHost <span class="hljs-keyword">as</span> unstable_shouldYield,
  unstable_requestPaint,
  unstable_continueExecution,
  unstable_pauseExecution,
  unstable_getFirstCallbackNode,
  getCurrentTime <span class="hljs-keyword">as</span> unstable_now,  <span class="hljs-comment">// 获取当前时间戳</span>
  forceFrameRate <span class="hljs-keyword">as</span> unstable_forceFrameRate,
};
</code></pre>
<p>入口函数</p>
<p>根据优先级计算出当前任务的过期时间。</p>
<p>创建当前任务对象</p>
<p>过期时间和当前时间戳比较，延时任务加入到timerQueue，其他任务加入taskQueue</p>
<p>当前任务为延时，开启定期检查timerQueue中任务的定时器</p>
<p>当前任务为task任务，开启任务调度</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">unstable_scheduleCallback</span>(<span class="hljs-params">priorityLevel, callback, options</span>) {
  <span class="hljs-keyword">var</span> currentTime = <span class="hljs-title function_">getCurrentTime</span>(); <span class="hljs-comment">// 获取当前时间</span>

  <span class="hljs-keyword">var</span> startTime; <span class="hljs-comment">// 计算任务开始时间，注意delay参数，如果有delay参数，则表示当前任务为延时任务，会加入timerQueue中</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'object'</span> &amp;&amp; options !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">var</span> delay = options.<span class="hljs-property">delay</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> delay === <span class="hljs-string">'number'</span> &amp;&amp; delay &gt; <span class="hljs-number">0</span>) {
      startTime = currentTime + delay;
    } <span class="hljs-keyword">else</span> {
      startTime = currentTime;
    }
  } <span class="hljs-keyword">else</span> {
    startTime = currentTime;
  }

  <span class="hljs-keyword">var</span> timeout;
  <span class="hljs-keyword">switch</span> (priorityLevel) { <span class="hljs-comment">// 根据优先级 计算任务过期时间</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ImmediatePriority</span>:
      timeout = <span class="hljs-variable constant_">IMMEDIATE_PRIORITY_TIMEOUT</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">UserBlockingPriority</span>:
      timeout = <span class="hljs-variable constant_">USER_BLOCKING_PRIORITY_TIMEOUT</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IdlePriority</span>:
      timeout = <span class="hljs-variable constant_">IDLE_PRIORITY_TIMEOUT</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">LowPriority</span>:
      timeout = <span class="hljs-variable constant_">LOW_PRIORITY_TIMEOUT</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NormalPriority</span>:
    <span class="hljs-attr">default</span>:
      timeout = <span class="hljs-variable constant_">NORMAL_PRIORITY_TIMEOUT</span>;
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">var</span> expirationTime = startTime + timeout;  <span class="hljs-comment">// 计算任务过期时间</span>

  <span class="hljs-keyword">var</span> newTask = {  <span class="hljs-comment">// 创建任务对象</span>
    <span class="hljs-attr">id</span>: taskIdCounter++, <span class="hljs-comment">// 任务id，自增</span>
    callback, <span class="hljs-comment">// 任务本身回调函数</span>
    priorityLevel, <span class="hljs-comment">// 任务优先级</span>
    startTime,      <span class="hljs-comment">// 任务开始时间</span>
    expirationTime,   <span class="hljs-comment">// 任务过期时间</span>
    <span class="hljs-attr">sortIndex</span>: -<span class="hljs-number">1</span>,      <span class="hljs-comment">// 用于小顶堆排序的索引，会用来计算优先级，会被赋值expirationTime</span>
  };

  <span class="hljs-keyword">if</span> (startTime &gt; currentTime) { <span class="hljs-comment">// 延时任务，加入timerQueue中</span>
      newTask.<span class="hljs-property">sortIndex</span> = startTime;
      <span class="hljs-title function_">push</span>(timerQueue, newTask);

      <span class="hljs-title function_">cancelHostTimeout</span>(); <span class="hljs-comment">// 取消定期检查timerQueue</span>
      <span class="hljs-title function_">requestHostTimeout</span>(handleTimeout, startTime - currentTime); <span class="hljs-comment">// 开启定期检查timerQueue中的任务，检查是否到期</span>
    }
  } <span class="hljs-keyword">else</span> {
    newTask.<span class="hljs-property">sortIndex</span> = expirationTime;
    <span class="hljs-title function_">push</span>(taskQueue, newTask);  <span class="hljs-comment">// 加入到 taskQueue</span>
    <span class="hljs-title function_">requestHostCallback</span>(flushWork); <span class="hljs-comment">// 开启任务调，传入flushWork</span>
  }

  <span class="hljs-keyword">return</span> newTask;
}
</code></pre>
<p>通过Scheduler调度的任务，都会在下一个宏任务中去执行，schedulePerformWorkUntilDeadline的定义会根据环境情况去实现</p>
<p>依次检查setImmediate，MessageChannel，setTimeout是否可用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">requestHostCallback</span>(<span class="hljs-params">callback</span>) {
  scheduledHostCallback = callback;  <span class="hljs-comment">//  注意，这是全局变量，callback为flushWork</span>
  
  <span class="hljs-comment">// 开启任务调度循环, 此函数会根据环境选择合适的异步调度API，实现宏任务</span>
  <span class="hljs-title function_">schedulePerformWorkUntilDeadline</span>();   
}

</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> schedulePerformWorkUntilDeadline;
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> localSetImmediate === <span class="hljs-string">'function'</span>) { <span class="hljs-comment">// setImmediate</span>
  schedulePerformWorkUntilDeadline = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">localSetImmediate</span>(performWorkUntilDeadline);
  };
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MessageChannel</span> !== <span class="hljs-string">'undefined'</span>) { <span class="hljs-comment">// MessageChannel</span>
  <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
  <span class="hljs-keyword">const</span> port = channel.<span class="hljs-property">port2</span>;
  channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = performWorkUntilDeadline;
  schedulePerformWorkUntilDeadline = <span class="hljs-function">() =&gt;</span> {
    port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
  };
} <span class="hljs-keyword">else</span> {                                            <span class="hljs-comment">// setTimeout</span>
  schedulePerformWorkUntilDeadline = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">localSetTimeout</span>(performWorkUntilDeadline, <span class="hljs-number">0</span>);
  };
}
</code></pre>
<p>循环执行taskQueue中的任务</p>
<p>会判断任务池中的任务</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">performWorkUntilDeadline</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (scheduledHostCallback !== <span class="hljs-literal">null</span>) {  <span class="hljs-comment">// 判断当前任务是否为空</span>
    <span class="hljs-keyword">const</span> currentTime = <span class="hljs-title function_">getCurrentTime</span>();
    
    <span class="hljs-comment">//全局的startTime，用来记录当前这批任务的调度开始时间，用来判断是否用完切片用的。</span>
    startTime = currentTime; 
    <span class="hljs-keyword">const</span> hasTimeRemaining = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">let</span> hasMoreWork = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 执行flushWork</span>
      hasMoreWork = <span class="hljs-title function_">scheduledHostCallback</span>(hasTimeRemaining, currentTime);   
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 如果task队列中还有，继续在下一个宏任务中调度</span>
      <span class="hljs-keyword">if</span> (hasMoreWork) {
        <span class="hljs-title function_">schedulePerformWorkUntilDeadline</span>(); 
      } <span class="hljs-keyword">else</span> {
        isMessageLoopRunning = <span class="hljs-literal">false</span>;
        scheduledHostCallback = <span class="hljs-literal">null</span>;
      }
    }
  } <span class="hljs-keyword">else</span> {
    isMessageLoopRunning = <span class="hljs-literal">false</span>;
  }
  needsPaint = <span class="hljs-literal">false</span>;
};
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushWork</span>(<span class="hljs-params">hasTimeRemaining, initialTime</span>) {
  isHostCallbackScheduled = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 重置调度状态，防止重复调度</span>

  <span class="hljs-comment">// 如果有定时检查timeQueue，取消检查定时器</span>
  <span class="hljs-keyword">if</span> (isHostTimeoutScheduled) {
    isHostTimeoutScheduled = <span class="hljs-literal">false</span>;
    <span class="hljs-title function_">cancelHostTimeout</span>();           
  }

  isPerformingWork = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 标记正在执行工作循环中</span>
  <span class="hljs-keyword">const</span> previousPriorityLevel = currentPriorityLevel; <span class="hljs-comment">// 保存当前优先级</span>
  <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// ...</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">workLoop</span>(hasTimeRemaining, initialTime);
   
  } <span class="hljs-keyword">finally</span> {
    currentTask = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 清理当前任务引用 - 当前任务已完成或暂停</span>
    currentPriorityLevel = previousPriorityLevel; <span class="hljs-comment">// 恢复原始优先级</span>
    isPerformingWork = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 标记 工作循环已完成</span>
  }
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">hasTimeRemaining, initialTime</span>) {
  <span class="hljs-keyword">let</span> currentTime = initialTime;
  <span class="hljs-title function_">advanceTimers</span>(currentTime); <span class="hljs-comment">// 检查timerQueue中是否有延时任务</span>
  currentTask = <span class="hljs-title function_">peek</span>(taskQueue);  <span class="hljs-comment">// 取出第一个任务，最高优先级</span>

  
  <span class="hljs-keyword">while</span> (currentTask !== <span class="hljs-literal">null</span>) {

    <span class="hljs-comment">// 如果 expriationTime &gt; currentTime 说明任务还没有过期，</span>
    <span class="hljs-comment">// 过期任务，不会再调用，因为调度是宏任务</span>
    <span class="hljs-comment">// shouldYieldToHost 判断浏览器是否还有空余时间（5ms），没有就跳出本次循环，下个宏任务执行</span>
    <span class="hljs-keyword">if</span> (
      currentTask.<span class="hljs-property">expirationTime</span> &gt; currentTime &amp;&amp;
      (!hasTimeRemaining || <span class="hljs-title function_">shouldYieldToHost</span>())
    ) {
      <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-keyword">const</span> callback = currentTask.<span class="hljs-property">callback</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
      currentTask.<span class="hljs-property">callback</span> = <span class="hljs-literal">null</span>;   <span class="hljs-comment">// 先置空任务，防止重复调用</span>
      currentPriorityLevel = currentTask.<span class="hljs-property">priorityLevel</span>;
      <span class="hljs-comment">// 判断当前任务是否过期，chuandaocallback中，供用户使用</span>
      <span class="hljs-keyword">const</span> didUserCallbackTimeout = currentTask.<span class="hljs-property">expirationTime</span> &lt;= currentTime; 

      <span class="hljs-comment">// 执行任务，可能有返回的新任务</span>
      <span class="hljs-keyword">const</span> continuationCallback = <span class="hljs-title function_">callback</span>(didUserCallbackTimeout);
      
      <span class="hljs-comment">// 任务未完成，继续赋值回调函数</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> continuationCallback === <span class="hljs-string">'function'</span>) {
        currentTask.<span class="hljs-property">callback</span> = continuationCallback;  
      } 
        
      <span class="hljs-comment">// 任务完成了，删除任务</span>
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (currentTask === <span class="hljs-title function_">peek</span>(taskQueue)) {  
          <span class="hljs-title function_">pop</span>(taskQueue);
        }
      }
      <span class="hljs-title function_">advanceTimers</span>(currentTime);  <span class="hljs-comment">// 执行完一个任务，就去检查timerQueue中是否有延时任务</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">pop</span>(taskQueue);
    }
    
    currentTask = <span class="hljs-title function_">peek</span>(taskQueue); <span class="hljs-comment">// 下次循环</span>
  }
  
 
  <span class="hljs-comment">// 如果taskQueue还有任务，返回true，表示还有任务未完成, 需要继续调度</span>
  <span class="hljs-keyword">if</span> (currentTask !== <span class="hljs-literal">null</span>) {  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// taskQueue已空，检查timerQueue中是否有延时任务</span>
    <span class="hljs-keyword">const</span> firstTimer = <span class="hljs-title function_">peek</span>(timerQueue);
    <span class="hljs-keyword">if</span> (firstTimer !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">requestHostTimeout</span>(handleTimeout, firstTimer.<span class="hljs-property">startTime</span> - currentTime); <span class="hljs-comment">// 开定时器，执行handleTimeout</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<p>advanceTimers用来检查timerQueue中是否有到期的延时任务，如果有则转移到taskQueue中</p>
<p>这个函数会在workLoop开始循环前调用，在一个任务执行结束后调用。</p>
<p>并且也会开始定时器，定时调用</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 循环检查timerQueue中是否有到期的延时任务，如果有则转移到taskQueue中</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">advanceTimers</span>(<span class="hljs-params">currentTime</span>) { 
  
  <span class="hljs-keyword">let</span> timer = <span class="hljs-title function_">peek</span>(timerQueue);
  <span class="hljs-keyword">while</span> (timer !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (timer.<span class="hljs-property">callback</span> === <span class="hljs-literal">null</span>) {
      
      <span class="hljs-title function_">pop</span>(timerQueue);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (timer.<span class="hljs-property">startTime</span> &lt;= currentTime) {  <span class="hljs-comment">// 检查是否过期了</span>
      
      <span class="hljs-title function_">pop</span>(timerQueue); <span class="hljs-comment">// 从timerQueue删除当前任务</span>
      timer.<span class="hljs-property">sortIndex</span> = timer.<span class="hljs-property">expirationTime</span>;
      <span class="hljs-title function_">push</span>(taskQueue, timer); <span class="hljs-comment">// 加入到 taskQueue</span>
    
    } 
    
    timer = <span class="hljs-title function_">peek</span>(timerQueue);
  }
}
</code></pre>
<p>检查timerQueue</p>
<p>当没有开启调度，并且taskQueue有任务，就开启调度</p>
<p>当taskQueue没有任务，timerQueue有任务就再开启定时器，检查timerQueue</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTimeout</span>(<span class="hljs-params">currentTime</span>) {
  isHostTimeoutScheduled = <span class="hljs-literal">false</span>;
  <span class="hljs-title function_">advanceTimers</span>(currentTime);

  <span class="hljs-keyword">if</span> (!isHostCallbackScheduled) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">peek</span>(taskQueue) !== <span class="hljs-literal">null</span>) {
      isHostCallbackScheduled = <span class="hljs-literal">true</span>;
      <span class="hljs-title function_">requestHostCallback</span>(flushWork);  <span class="hljs-comment">// 开启调度</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> firstTimer = <span class="hljs-title function_">peek</span>(timerQueue);
      <span class="hljs-keyword">if</span> (firstTimer !== <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">requestHostTimeout</span>(handleTimeout, firstTimer.<span class="hljs-property">startTime</span> - currentTime); <span class="hljs-comment">// 延时检查</span>
      }
    }
  }
}
</code></pre>
<p>shouldYieldToHost用来判断浏览器空余时间是否用完，是否要退出调度</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> frameInterval = frameYieldMs;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldYieldToHost</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> timeElapsed = <span class="hljs-built_in">exports</span>.<span class="hljs-title function_">unstable_now</span>() - startTime;
  <span class="hljs-keyword">if</span> (timeElapsed &lt; frameInterval) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 说明不应该中断，时间片还没有用完</span>
  } 
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 说明时间片已经用完了</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[scopeId 别再手动捞，可以“反手掏”：Vue3 组件迁移时的样式继承避坑指南]]></title>    <link>https://juejin.cn/post/7597664149171617834</link>    <guid>https://juejin.cn/post/7597664149171617834</guid>    <pubDate>2026-01-22T02:03:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597664149171617834" data-draft-id="7597588000613531711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="scopeId 别再手动捞，可以“反手掏”：Vue3 组件迁移时的样式继承避坑指南"/> <meta itemprop="keywords" content="前端,Vue.js,代码规范"/> <meta itemprop="datePublished" content="2026-01-22T02:03:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="donecoding"/> <meta itemprop="url" content="https://juejin.cn/user/3192637500430093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            scopeId 别再手动捞，可以“反手掏”：Vue3 组件迁移时的样式继承避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637500430093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    donecoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:03:09.000Z" title="Thu Jan 22 2026 02:03:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前言</p>
<p>在 Vue3 或 Nuxt3 项目中，为了保证业务平稳，我们经常需要做 <strong>“组件渐进式迁移”</strong> 。最直观的思路就是通过 <code>v-if/v-else</code> 来动态切换新老组件。</p>
<p>然而，当你满心欢喜地写下切换逻辑后，现实往往会给你一记响亮的耳光：<strong>父组件定义的样式（如布局宽度、外边距等）在切换到新组件时突然消失了。</strong>  同时，控制台会跳出那个令人头疼的警告：</p>
<blockquote>
<p><em>Extraneous non-props attributes (class) were passed to component but could not be automatically inherited...</em></p>
</blockquote>
<p>今天，我们就来拆解这个关于 <strong>Fragment（多根节点）</strong> 、<strong>Scoped CSS Hash</strong> 与 <strong>Nuxt 自动导入组件</strong> 纠缠在一起的“深坑”。</p>
<hr/>
<p>一、 案发现场：为什么样式消失了？</p>
<p>在 Vue3 中，Scoped CSS 的原理是给组件的根节点注入一个特殊的属性标识：<code>data-v-xxxx</code>（即 scopeId）。</p>
<ol>
<li><strong>Fragment 破坏了继承</strong>：当你使用 <code>v-if/v-else</code> 切换两个组件时，Vue 会将其视为一个 <code>Fragment</code>（多根节点）。因为“不敢确定”该把父组件的 Hash 挂载到哪个候选节点上，Vue 索性放弃自动继承。</li>
<li><strong>被屏蔽的 scopeId</strong>：你可能会想：“我不依赖自动继承，手动拿到这个 Hash 挂上去总行了吧？” 但你会发现 <code>useAttrs()</code> 里压根没有这个 <code>data-v-hash</code>。</li>
<li><strong>Nuxt 的“组件黑盒”</strong> ：在 Nuxt3 中，很多模块（如 <code>vue3-carousel-nuxt</code>）是自动全局注册的。它们没有显式导出对象，导致你无法直接在 <code>&lt;script&gt;</code> 里引用它们来做组件分发。</li>
</ol>
<hr/>
<p>二、 曾经的偏门：手动“捞” scopeId</p>
<p>面对困境，很多开发者会尝试从组件实例里强行“捞取”私有属性：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">import { getCurrentInstance } from 'vue'<span class="hljs-comment">;</span>
const <span class="hljs-attr">instance</span> = getCurrentInstance()<span class="hljs-comment">;</span>
// 强行捞取父组件注入的私有 scopeId
const <span class="hljs-attr">parentScopeId</span> = instance.vnode.scopeId<span class="hljs-comment">; </span>
</code></pre>
<p>请谨慎使用此类代码。</p>
<p>然后在模板里手动绑定：</p>
<p>vue</p>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isNew"</span> :[parentScopeId]=<span class="hljs-string">"''"</span>&gt;...&lt;/div&gt;
</code></pre>
<p>请谨慎使用此类代码。</p>
<p><strong>避坑提醒</strong>：虽然 <code>getCurrentInstance</code> 在 uni-app 等小程序开发（获取节点 <code>.in(proxy)</code>）中是刚需，但 Vue3 官方文档正有意将其“隐名埋姓”。<strong>手动捞取 <code>vnode.scopeId</code> 这种私有属性不仅累，还面临版本升级后属性变更的“崩盘”风险。</strong></p>
<hr/>
<p>三、 破局：反手一“掏”，回归正道</p>
<p>经过实测，最靠谱的方案不是去“补救” Fragment，而是<strong>将逻辑上的“碎片化根节点”还原为“动态单根节点”</strong> 。</p>
<ol>
<li>反手掏：利用 <code>resolveComponent</code></li>
</ol>
<p>既然 Nuxt 自动导入了组件但没给我导出对象，我们可以利用 Vue3 官方提供的运行时寻址 API —— <code>resolveComponent</code>。</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">import { resolveComponent, computed } from 'vue'<span class="hljs-comment">;</span>

// 动态获取那些“没被包显式导出”的全局组件引用
const <span class="hljs-attr">NewCarousel</span> = resolveComponent(<span class="hljs-string">'Carousel'</span>)<span class="hljs-comment">; </span>
const <span class="hljs-attr">OldCarousel</span> = resolveComponent(<span class="hljs-string">'OldCarousel'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">ActiveCarousel</span> = computed(() =&gt; (isNew ? NewCarousel : OldCarousel))<span class="hljs-comment">;</span>
</code></pre>
<p>请谨慎使用此类代码。</p>
<ol start="2">
<li>重构渲染树</li>
</ol>
<p>抛弃 <code>v-if/v-else</code>，回归内置的 <code>&lt;component :is&gt;</code>。</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 
    在 Vue3 中，&lt;component :is&gt; 承载的动态组件被视为一个逻辑上的 Single Root（单根节点）。
    此时，父组件的 Hash 样式会自动、精准地注入，无需任何 hack 操作。
  --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">:is</span>=<span class="hljs-string">"ActiveCarousel"</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"$attrs"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>请谨慎使用此类代码。</p>
<hr/>
<p>四、 深度总结：顺应框架的本能</p>
<p>通过这次实操，我总结了两个核心认知：</p>
<ol>
<li><strong>API 的层级性</strong>：<code>getCurrentInstance</code> 虽然强大，但在业务逻辑中应被视为“最后一道防线”。<strong>与其通过私有属性去“偷”那个消失的 Hash，不如利用官方标准的 <code>resolveComponent</code> 夺回组件的引用权。</strong></li>
<li><strong>单根节点的力量</strong>：在处理 Scoped 样式继承时，动态组件占位符（<code>component :is</code>）的优先级和稳定性远高于模板指令（<code>v-if/v-else</code>）。</li>
</ol>
<p><strong>手动“捞”</strong> ，是与框架的内部实现对抗；<strong>反手“掏”</strong> ，是顺应 Vue 3 的渲染机制本能。在复杂的 Nuxt3 架构下，这才是实现组件无感迁移的最优解。</p>
<hr/>
<blockquote>
<p><strong>注</strong>：如果你也遇到了 Vue3 样式继承失效的“灵异事件”，或者正在为 Nuxt 组件库没有导出而苦恼，希望这个方案能帮你少走弯路。欢迎在评论区一起探讨 Vue 3 的底层黑科技！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue避坑：v-for中ref绑定失效？函数Ref优雅破局]]></title>    <link>https://juejin.cn/post/7597695487302811663</link>    <guid>https://juejin.cn/post/7597695487302811663</guid>    <pubDate>2026-01-22T02:19:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597695487302811663" data-draft-id="7597664587459493923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue避坑：v-for中ref绑定失效？函数Ref优雅破局"/> <meta itemprop="keywords" content="Vue.js,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-22T02:19:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue避坑：v-for中ref绑定失效？函数Ref优雅破局
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:19:38.000Z" title="Thu Jan 22 2026 02:19:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 开发中，ref 是最常用的响应式 API 之一，用于绑定 DOM 元素或普通数据。但在 v-for 循环场景中，直接绑定 ref 会出现复用冲突、定位混乱等问题。函数 Ref（Function Ref）作为 Vue 提供的解决方案，能精准处理循环中的 ref 绑定。本文将拆解 v-for 中 ref 的痛点，详解函数 Ref 的原理、用法及最佳实践。</p>
<h2 data-id="heading-0">一、v-for 中直接绑定 ref 的痛点</h2>
<p>常规场景下，我们通过 ref="xxx" 绑定单个 DOM 元素，再通过 ref.value 访问。但在 v-for 循环中，直接绑定固定名称的 ref 会导致所有循环项共享同一个 ref，无法单独定位某一项元素。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;!-- 错误示例：所有列表项共享同一个 ref --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"listItem"</span>&gt;</span>
      {{ item.name }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">const</span> listItem = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 仅能获取最后一个 li 元素</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-title function_">ref</span>([{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项1'</span> }, { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项2'</span> }]);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>上述代码中，循环生成的多个 li 元素均绑定到 listItem，最终 ref.value 只会指向最后一个渲染的元素，无法区分和操作单个循环项，这就是直接绑定 ref 的核心痛点。</p>
<h2 data-id="heading-1">二、函数 Ref：v-for 场景的专属解决方案</h2>
<h3 data-id="heading-2">2.1 什么是函数 Ref？</h3>
<p>函数 Ref 是将 ref 绑定值设为一个函数，该函数会在元素渲染、更新或卸载时被调用，接收当前元素（或组件实例）作为参数。通过函数逻辑，可实现对循环项 ref 的精准管理。</p>
<p>核心优势：避免 ref 名称冲突，能为每个循环项单独绑定 ref 并存储，支持精准定位单个元素。</p>
<h3 data-id="heading-3">2.2 基础用法：存储循环项 Ref</h3>
<p>最常用场景是将每个循环项的 ref 存储到数组或对象中，通过索引或唯一标识关联，实现单独访问。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> 
      <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in list"</span> 
      <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span> 
      <span class="hljs-attr">:ref</span>=<span class="hljs-string">"el =&gt; (listItems[index] = el)"</span> // <span class="hljs-attr">函数</span> <span class="hljs-attr">Ref</span> <span class="hljs-attr">绑定</span>
    &gt;</span>
      {{ item.name }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"focusItem(0)"</span>&gt;</span>聚焦第一项<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">const</span> list = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项1'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项2'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项3'</span> }
]);
<span class="hljs-comment">// 用数组存储每个循环项的 ref</span>
<span class="hljs-keyword">const</span> listItems = <span class="hljs-title function_">ref</span>([]);

<span class="hljs-comment">// 操作指定项的 DOM 元素</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">focusItem</span> = (<span class="hljs-params">index</span>) =&gt; {
  listItems.<span class="hljs-property">value</span>[index]?.<span class="hljs-title function_">focus</span>(); <span class="hljs-comment">// 精准定位第一项并聚焦</span>
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>代码解析：通过箭头函数将当前 el（li 元素）赋值给 listItems 数组对应索引位置，listItems 数组会与循环项一一对应，从而实现对单个元素的操作。</p>
<h3 data-id="heading-4">2.3 进阶用法：结合唯一标识存储</h3>
<p>若循环项存在唯一标识（如 id），可使用对象存储 ref，以 id 为键，避免索引变化导致的 ref 错位（如列表排序、删除项场景）。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> 
      <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span> 
      <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span> 
      <span class="hljs-attr">:ref</span>=<span class="hljs-string">"el =&gt; { if (el) itemRefs[item.id] = el; else delete itemRefs[item.id]; }"</span>
    &gt;</span>
      {{ item.name }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"scrollToItem(2)"</span>&gt;</span>滚动到 id=2 的项<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">const</span> list = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项1'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项2'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'项3'</span> }
]);
<span class="hljs-comment">// 用对象存储，键为 item.id</span>
<span class="hljs-keyword">const</span> itemRefs = <span class="hljs-title function_">reactive</span>({});

<span class="hljs-comment">// 根据 id 操作元素</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToItem</span> = (<span class="hljs-params">id</span>) =&gt; {
  itemRefs[id]?.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>代码解析：函数中判断 el 是否存在（元素渲染时 el 存在，卸载时为 null），存在则存入对象，不存在则删除对应键，避免对象中残留已卸载元素的 ref，同时通过 id 定位，不受列表顺序变化影响。</p>
<h2 data-id="heading-5">三、函数 Ref 的执行时机与注意事项</h2>
<h3 data-id="heading-6">3.1 执行时机</h3>
<ul>
<li><strong>元素渲染时</strong>：函数被调用，el 为当前 DOM 元素/组件实例，可执行存储逻辑。</li>
<li><strong>元素更新时</strong>：若元素重新渲染（如数据变化），函数会再次调用，el 为更新后的元素。</li>
<li><strong>元素卸载时</strong>：函数被调用，el 为 null，需清理存储的 ref，避免内存泄漏。</li>
</ul>
<h3 data-id="heading-7">3.2 核心注意事项</h3>
<ul>
<li><strong>避免使用箭头函数以外的函数声明</strong>：若使用普通函数，this 指向可能异常（尤其非 &lt;script setup&gt; 场景），建议优先用箭头函数。</li>
<li><strong>清理卸载元素的 ref</strong>：元素卸载时 el 为 null，需及时删除数组/对象中对应的 ref，避免存储无效引用。</li>
<li><strong>配合 v-if 时的处理</strong>：若循环项中包含 v-if，元素可能条件性渲染，需确保函数 Ref 能处理 el 为 null 的场景，避免报错。</li>
<li><strong>组件 ref 绑定</strong>：若循环的是自定义组件，el 会指向组件实例，可访问组件暴露的属性和方法（需通过 defineExpose 暴露）。</li>
</ul>
<h2 data-id="heading-8">四、常见场景实战案例</h2>
<h3 data-id="heading-9">4.1 批量操作循环项 DOM</h3>
<p>需求：批量设置循环项的样式，或批量获取元素尺寸。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item-list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
      <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in list"</span> 
      <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span> 
      <span class="hljs-attr">:ref</span>=<span class="hljs-string">"el =&gt; (itemEls[index] = el)"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>
    &gt;</span>
      {{ item.content }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"setAllItemsRed"</span>&gt;</span>所有项设为红色<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">const</span> list = <span class="hljs-title function_">ref</span>([{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'内容1'</span> }, { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'内容2'</span> }]);
<span class="hljs-keyword">const</span> itemEls = <span class="hljs-title function_">ref</span>([]);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">setAllItemsRed</span> = (<span class="hljs-params"/>) =&gt; {
  itemEls.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (el) el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>;
  });
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-10">4.2 组件循环中的 Ref 调用</h3>
<p>需求：循环自定义组件，通过 ref 调用组件方法。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;!-- 父组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">custom-item</span> 
    <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span> 
    <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span> 
    <span class="hljs-attr">:ref</span>=<span class="hljs-string">"el =&gt; (compRefs[item.id] = el)"</span>
    <span class="hljs-attr">:data</span>=<span class="hljs-string">"item"</span>
  /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"callCompMethod(1)"</span>&gt;</span>调用 id=1 组件的方法<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CustomItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./CustomItem.vue'</span>;
<span class="hljs-keyword">const</span> list = <span class="hljs-title function_">ref</span>([{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">'数据1'</span> }, { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">'数据2'</span> }]);
<span class="hljs-keyword">const</span> compRefs = <span class="hljs-title function_">reactive</span>({});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">callCompMethod</span> = (<span class="hljs-params">id</span>) =&gt; {
  compRefs[id]?.<span class="hljs-title function_">handleClick</span>(); <span class="hljs-comment">// 调用子组件暴露的方法</span>
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

&lt;!-- 子组件 <span class="hljs-title class_">CustomItem</span>.<span class="hljs-property">vue</span> --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { defineProps, defineExpose } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>([<span class="hljs-string">'data'</span>]);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子组件方法执行'</span>, props.<span class="hljs-property">data</span>);
};
<span class="hljs-comment">// 暴露方法供父组件调用</span>
<span class="hljs-title function_">defineExpose</span>({ handleClick });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-11">五、总结</h2>
<p>函数 Ref 是 Vue 为解决 v-for 中 ref 绑定问题提供的优雅方案，通过函数逻辑实现循环项 ref 的精准存储与管理，规避了常规绑定的冲突与错位问题。在实际开发中，需根据场景选择数组或对象存储 ref，注意清理无效引用，同时结合执行时机处理边界场景。</p>
<p>掌握函数 Ref 后，能轻松应对循环中的 DOM 操作、组件交互等需求，大幅提升 Vue 项目中循环场景的开发效率与代码健壮性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么Java中的string不可变，而C++没有做这种设计？]]></title>    <link>https://juejin.cn/post/7597695531218681906</link>    <guid>https://juejin.cn/post/7597695531218681906</guid>    <pubDate>2026-01-22T02:55:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597695531218681906" data-draft-id="7597989474970992690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么Java中的string不可变，而C++没有做这种设计？"/> <meta itemprop="keywords" content="C++,Java"/> <meta itemprop="datePublished" content="2026-01-22T02:55:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么Java中的string不可变，而C++没有做这种设计？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:55:42.000Z" title="Thu Jan 22 2026 02:55:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为什么Java中的string不可变，而C++没有做这种设计？</p>
<p>这是一个非常经典且深刻的问题，触及了 <strong>C++ 与 Java 在语言哲学、内存模型和性能目标上的根本差异</strong>。虽然我们平常使用Java和C++不会在意这个问题，但是以小见大，从其中设计可以看出两种语言设计思维的根本不同。</p>
<hr/>
<h2 data-id="heading-0">一、核心结论</h2>






























<table><thead><tr><th>特性</th><th>Java <code>String</code></th><th>C++ <code>std::string</code></th></tr></thead><tbody><tr><td><strong>是否可变</strong></td><td>❌ 不可变（immutable）</td><td>✅ 可变（mutable）</td></tr><tr><td><strong>设计哲学</strong></td><td>安全性、简化并发、缓存友好</td><td>零开销抽象、贴近硬件、性能优先</td></tr><tr><td><strong>典型用途</strong></td><td>通用对象，常用于哈希键、共享数据</td><td>值语义容器，强调高效修改</td></tr><tr><td><strong>内存管理</strong></td><td>GC 自动回收</td><td>手动/RAII 控制生命周期</td></tr></tbody></table>
<blockquote>
<p><strong>根本原因</strong>：Java 为“安全”和“简化”牺牲部分灵活性；C++ 为“性能”和“控制”保留底层能力。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、为什么 Java 的 String 是不可变的？</h2>
<h3 data-id="heading-2">1. <strong>安全性（Security）</strong></h3>
<ul>
<li>字符串常用于敏感操作：文件路径、网络地址、SQL 查询、类名加载等。</li>
<li>如果可变，恶意代码可能篡改共享字符串，导致安全漏洞。
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 假设 String 可变（伪代码）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/safe/dir"</span>;
checkPermission(path); <span class="hljs-comment">// 检查通过</span>
<span class="hljs-comment">// 此时另一个线程把 path 改成 "/etc/passwd"</span>
openFile(path); <span class="hljs-comment">// 危险！</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">2. <strong>哈希码缓存（HashCode Caching）</strong></h3>
<ul>
<li><code>String</code> 是 <code>HashMap</code> 的常用 key。</li>
<li>不可变 → 哈希码计算一次后可缓存，保证 <code>hashCode()</code> 恒定。</li>
<li>若可变，key 修改后哈希值变化，会导致 <code>HashMap</code> 找不到该 entry（逻辑错误）。</li>
</ul>
<h3 data-id="heading-4">3. <strong>字符串常量池（String Pool）优化</strong></h3>
<ul>
<li>Java 虚拟机维护一个“字符串常量池”，相同字面量共享同一对象：
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello"</span>;
<span class="hljs-keyword">assert</span> a == b; <span class="hljs-comment">// true（引用相同）</span>
</code></pre>
</li>
<li>如果字符串可变，修改 <code>a</code> 会意外影响 <code>b</code>，破坏语义。</li>
</ul>
<h3 data-id="heading-5">4. <strong>线程安全（Thread Safety）</strong></h3>
<ul>
<li>不可变对象天然线程安全，无需同步。</li>
<li>多线程共享 <code>String</code> 时，无需加锁。</li>
</ul>
<h3 data-id="heading-6">5. <strong>类加载器安全</strong></h3>
<ul>
<li>JVM 使用字符串指定类名（如 <code>"java.lang.Object"</code>）。</li>
<li>若可变，可能被篡改为恶意类名，破坏 JVM 安全模型。</li>
</ul>
<hr/>
<h2 data-id="heading-7">三、为什么 C++ 的 <code>std::string</code> 是可变的？</h2>
<h3 data-id="heading-8">1. <strong>C++ 的核心哲学：零开销抽象（Zero-overhead Abstraction）</strong></h3>
<ul>
<li>“你不用的东西，不应为你带来代价。”</li>
<li>不可变字符串意味着<strong>每次修改都要分配新内存 + 拷贝</strong>，这在系统编程、高频交易、游戏引擎等场景是不可接受的。</li>
<li>C++ 选择让程序员<strong>显式控制</strong>何时拷贝（如使用 <code>std::string_view</code> 实现“视图”语义）。</li>
</ul>
<p><em><strong>这其中涉及的本质思想是，Java关闭了String原始而简单的用法，提供了大多数时候方便和安全但是偶尔很麻烦的特性。</strong></em></p>
<h3 data-id="heading-9">2. <strong>值语义（Value Semantics） vs 引用语义</strong></h3>
<ul>
<li>C++ 中 <code>std::string</code> 是<strong>值类型</strong>：赋值即拷贝（C++11 后有移动语义优化）。
<pre><code class="hljs language-cpp" lang="cpp">std::string a = <span class="hljs-string">"hello"</span>;
std::string b = a; <span class="hljs-comment">// 深拷贝（或写时拷贝，但 C++11 后基本弃用 COW）</span>
b += <span class="hljs-string">" world"</span>;     <span class="hljs-comment">// 只修改 b，不影响 a</span>
</code></pre>
</li>
<li>因此，<strong>不需要不可变性来保证隔离</strong>——每个变量拥有独立副本。</li>
</ul>
<blockquote>
<p>📌 注：早期 C++ 标准（C++98/03）允许“写时拷贝”（Copy-on-Write），但因多线程问题，在 C++11 中被禁止。现代 <code>std::string</code> 基本都是独立存储。</p>
</blockquote>
<h3 data-id="heading-10">3. <strong>性能优先：避免不必要的内存分配</strong></h3>
<ul>
<li>在嵌入式、实时系统中，动态内存分配是昂贵甚至禁止的操作。</li>
<li>可变字符串允许：
<ul>
<li>原地修改（<code>+=</code>, <code>append</code>）</li>
<li>预分配容量（<code>reserve()</code>）</li>
<li>重用缓冲区（<code>clear()</code> 后继续使用）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">4. <strong>没有垃圾回收（GC）</strong></h3>
<ul>
<li>Java 依赖 GC 自动回收不再使用的字符串副本。</li>
<li>C++ 没有 GC，如果每次拼接都生成新字符串，程序员需手动管理大量临时对象，极易导致内存泄漏或性能下降。</li>
</ul>
<h3 data-id="heading-12">5. <strong>C++ 提供了“不可变视图”作为替代方案</strong></h3>
<ul>
<li>从 C++17 开始，标准库提供 <strong><code>std::string_view</code></strong>：
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">(std::string_view sv)</span></span>; <span class="hljs-comment">// 只读、不拥有内存、零拷贝</span>
</code></pre>
</li>
<li>它实现了 Java <code>String</code> 的“不可变引用”语义，但<strong>不强制所有字符串都不可变</strong>，给予程序员选择权。</li>
</ul>
<hr/>
<h2 data-id="heading-13">四、对比总结：两种设计的取舍</h2>



































<table><thead><tr><th>维度</th><th>Java（不可变）</th><th>C++（可变）</th></tr></thead><tbody><tr><td><strong>内存开销</strong></td><td>高（频繁创建新对象）</td><td>低（原地修改）</td></tr><tr><td><strong>CPU 开销</strong></td><td>高（拷贝+GC压力）</td><td>低（直接操作）</td></tr><tr><td><strong>线程安全</strong></td><td>天然安全</td><td>需程序员保证</td></tr><tr><td><strong>API 简单性</strong></td><td>高（无状态）</td><td>低（需考虑生命周期）</td></tr><tr><td><strong>适用场景</strong></td><td>应用层、业务逻辑</td><td>系统层、高性能、资源受限环境</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">五、延伸思考：C++ 能模拟不可变字符串吗？</h2>
<p>可以，很容易：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutableString</span> {
    std::string data_;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ImmutableString</span>(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* s) : <span class="hljs-built_in">data_</span>(s) {}
    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">c_str</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> data_.<span class="hljs-built_in">c_str</span>(); }
    <span class="hljs-comment">// 不提供任何修改接口</span>
};
</code></pre>
<p>或者直接使用 <code>const std::string&amp;</code> 或 <code>std::string_view</code> 传递只读字符串。</p>
<blockquote>
<p>✅ C++ 的理念是：“<strong>默认可变，按需只读</strong>”；<br/>
✅ Java 的理念是：“<strong>默认不可变，按需构建</strong>”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">六、结语</h2>
<p>Java 和 C++ 对字符串的设计差异，本质上是 <strong>“托管运行时 vs 裸机控制”</strong>、<strong>“安全优先 vs 性能优先”</strong> 的体现。</p>
<ul>
<li>如果你在写 Web 后端、Android App，Java 的不可变字符串让你少犯错；</li>
<li>如果你在写操作系统、游戏引擎、高频交易系统，C++ 的可变字符串给你极致控制。</li>
</ul>
<p><strong>没有绝对优劣，只有适合场景。</strong></p>
<p>理解这种差异，才能真正掌握两种语言的精髓。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习Three.js--加载外部三维模型(gltf)]]></title>    <link>https://juejin.cn/post/7597736491469406262</link>    <guid>https://juejin.cn/post/7597736491469406262</guid>    <pubDate>2026-01-22T02:07:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597736491469406262" data-draft-id="7597699032214011958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习Three.js--加载外部三维模型(gltf)"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-22T02:07:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="造轮子的猪"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习Three.js--加载外部三维模型(gltf)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    造轮子的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:07:34.000Z" title="Thu Jan 22 2026 02:07:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习Three.js--加载外部三维模型(gltf)</h2>
<h3 data-id="heading-1">前置核心说明</h3>
<p>GLTF（GL Transmission Format）是 Three.js <strong>官方推荐的首选3D模型格式</strong>，也是行业通用标准（被Blender、3ds Max、C4D等主流建模软件支持），相比OBJ/FBX等格式有三大核心优势：</p>
<ol>
<li><strong>体积小</strong>：采用二进制压缩，文件体积远小于传统格式；</li>
<li><strong>功能全</strong>：原生支持PBR材质、骨骼动画、顶点动画、纹理集、层级结构；</li>
<li><strong>渲染优</strong>：Three.js对GLTF的渲染优化最完善，性能最高。</li>
</ol>
<h4 data-id="heading-2">核心规则</h4>
<ol>
<li><strong>版本兼容</strong>：Three.js r152+ 版本重构了颜色空间系统，废弃 <code>gammaOutput/gammaFactor</code>，改用 <code>outputColorSpace</code>；</li>
<li><strong>渲染配置是关键</strong>：GLTF模型（尤其是PBR材质）依赖正确的颜色空间和色调映射，否则会出现偏色、过暗/过亮；</li>
<li><strong>模型适配</strong>：不同类型模型（植物/金属/普通）需针对性调整材质参数（如透明、双面、曝光）。</li>
</ol>
<hr/>
<h3 data-id="heading-3">一、核心渲染配置（解决偏色/过亮问题）</h3>
<p>GLTF模型渲染的「底层基础配置」，必须在创建渲染器后立即设置，否则模型视觉效果异常。</p>
<h4 data-id="heading-4">1. 颜色空间配置（r152+ 版本）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// 抗锯齿（可选，提升画质）</span>
<span class="hljs-comment">// 核心：设置输出颜色空间为SRGB，匹配GLTF模型的颜色标准，解决偏色</span>
renderer.<span class="hljs-property">outputColorSpace</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">SRGBColorSpace</span>;
</code></pre>
<h4 data-id="heading-5">2. 色调映射（解决高反射材质过亮）</h4>
<p>针对<strong>金属/高反射塑料/玻璃材质</strong>的GLTF模型，默认渲染会过亮/过曝，需开启色调映射并调整曝光值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 启用ACES电影级色调映射（最接近真实物理的色调映射，推荐）</span>
renderer.<span class="hljs-property">toneMapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ACESFilmicToneMapping</span>;
<span class="hljs-comment">// 调整曝光值（核心参数，根据模型类型适配）</span>
renderer.<span class="hljs-property">toneMappingExposure</span> = <span class="hljs-number">2.0</span>; <span class="hljs-comment">// 通用推荐值：1.5 ~ 2.5</span>
</code></pre>
<h4 data-id="heading-6">3. 旧版本兼容（r152 以下）</h4>
<p>若项目必须使用旧版本Three.js，需替换为gamma配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 替代 outputColorSpace，解决偏色</span>
renderer.<span class="hljs-property">gammaOutput</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-property">gammaFactor</span> = <span class="hljs-number">2.2</span>; <span class="hljs-comment">// 固定值，匹配SRGB颜色空间</span>
</code></pre>
<h4 data-id="heading-7">4. 色调映射可选值（按效果优先级）</h4>






























<table><thead><tr><th>取值</th><th>效果特点</th><th>适用场景</th></tr></thead><tbody><tr><td>THREE.ACESFilmicToneMapping（推荐）</td><td>电影级效果，色彩自然，高光压制优秀</td><td>所有PBR模型（金属/塑料/植物）</td></tr><tr><td>THREE.ReinhardToneMapping</td><td>基础色调映射，效果柔和</td><td>普通低反射模型</td></tr><tr><td>THREE.CineonToneMapping</td><td>对比度高，暗部细节丰富</td><td>暗色调场景/模型</td></tr><tr><td>THREE.LinearToneMapping（默认）</td><td>无色调映射，易过曝</td><td>仅调试使用</td></tr></tbody></table>
<h4 data-id="heading-8">5. 曝光值适配表（按模型类型）</h4>

























<table><thead><tr><th>模型类型</th><th>推荐曝光值（toneMappingExposure）</th><th>说明</th></tr></thead><tbody><tr><td>普通模型（低反射，如木头/石头）</td><td>1.0 ~ 1.5</td><td>无需过度调整</td></tr><tr><td>高反射模型（金属/塑料/玻璃）</td><td>1.5 ~ 2.5</td><td>压制高光，避免过亮</td></tr><tr><td>植物/透明模型（草/树叶）</td><td>2.0 ~ 2.8</td><td>提升亮度，凸显细节</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">二、GLTFLoader 完整使用指南</h3>
<h4 data-id="heading-10">1. 导入方式（两种场景全覆盖）</h4>
<h5 data-id="heading-11">方式1：CDN导入（新手/快速测试，推荐）</h5>
<p>直接在HTML中引入，无需安装依赖，适配r174版本：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 先引入Three.js核心库 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 导入Three.js核心</span>
  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0'</span>;
  <span class="hljs-comment">// 导入轨道控制器</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0/examples/jsm/controls/OrbitControls.js'</span>;
  <span class="hljs-comment">// 导入GLTF加载器（核心）</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0/examples/jsm/loaders/GLTFLoader.js'</span>;
  
  <span class="hljs-comment">// 后续代码写在这里...</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h5 data-id="heading-12">方式2：NPM导入（工程化项目，Vue/React/Vite）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Three.js</span>
npm install three --save
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模块化导入</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/addons/controls/OrbitControls.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/addons/loaders/GLTFLoader.js'</span>;
</code></pre>
<h4 data-id="heading-13">2. GLTFLoader.load() 方法参数详解</h4>
<p><code>load</code> 是加载GLTF模型的核心方法，支持加载进度、成功、失败回调：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建GLTF加载器实例</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();

<span class="hljs-comment">// 语法：loader.load(url, onLoad, onProgress, onError)</span>
loader.<span class="hljs-title function_">load</span>(
  <span class="hljs-comment">// 参数1：必传，模型文件路径（本地/CDN）</span>
  <span class="hljs-string">'./models/grass_medium_01_1k.gltf'</span>,
  
  <span class="hljs-comment">// 参数2：必传，加载成功回调（核心）</span>
  <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
    <span class="hljs-comment">// gltf对象核心属性说明</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'模型加载成功'</span>, gltf);
    <span class="hljs-comment">// gltf.scene：模型的根场景（包含所有模型节点，必加）</span>
    <span class="hljs-comment">// gltf.scenes：模型包含的所有场景数组</span>
    <span class="hljs-comment">// gltf.nodes：模型的所有节点（网格/相机/光源）</span>
    <span class="hljs-comment">// gltf.materials：模型的所有材质</span>
    <span class="hljs-comment">// gltf.animations：模型的动画数据（如有）</span>
    
    <span class="hljs-comment">// 1. 将模型添加到场景（核心步骤）</span>
    scene.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
    
    <span class="hljs-comment">// 2. 模型材质适配（按需处理，如植物/透明模型）</span>
    <span class="hljs-title function_">configureMaterialForModel</span>(gltf.<span class="hljs-property">scene</span>);
    
    <span class="hljs-comment">// 3. 自动聚焦模型（让相机对准模型中心，避免看不到）</span>
    <span class="hljs-title function_">autoFocusCamera</span>(gltf.<span class="hljs-property">scene</span>, camera, controls);
  },
  
  <span class="hljs-comment">// 参数3：可选，加载进度回调</span>
  <span class="hljs-function">(<span class="hljs-params">xhr</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> progress = (xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`加载进度：<span class="hljs-subst">${progress.toFixed(<span class="hljs-number">1</span>)}</span>%`</span>);
  },
  
  <span class="hljs-comment">// 参数4：可选，加载失败回调</span>
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'模型加载失败：'</span>, error);
  }
);
</code></pre>
<h4 data-id="heading-14">3. 核心辅助函数（模型适配+自动聚焦）</h4>
<h5 data-id="heading-15">3.1 模型材质适配函数（按类型处理）</h5>
<p>针对不同模型类型调整材质参数，解决透明、双面、裁剪问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 配置GLTF模型材质
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">THREE.Object3D</span>} <span class="hljs-variable">root</span> - 模型根节点（gltf.scene）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">String</span>} <span class="hljs-variable">type</span> - 模型类型：plant（植物）/metal（金属）/normal（普通）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">configureMaterialForModel</span>(<span class="hljs-params">root, type = <span class="hljs-string">'normal'</span></span>) {
  <span class="hljs-comment">// 遍历模型所有子节点</span>
  root.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> {
    <span class="hljs-comment">// 只处理网格模型（Mesh）</span>
    <span class="hljs-keyword">if</span> (!child.<span class="hljs-property">isMesh</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> material = child.<span class="hljs-property">material</span>;
    <span class="hljs-comment">// 处理多材质情况（数组）</span>
    <span class="hljs-keyword">const</span> materials = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(material) ? material : [material];
    
    materials.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mat</span> =&gt;</span> {
      <span class="hljs-comment">// 通用配置：开启双面渲染（避免模型背面不可见）</span>
      mat.<span class="hljs-property">side</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>;
      
      <span class="hljs-comment">// 按模型类型适配</span>
      <span class="hljs-keyword">switch</span> (type) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'plant'</span>: <span class="hljs-comment">// 植物/草/树叶模型</span>
          <span class="hljs-comment">// Alpha裁剪：丢弃透明像素（解决草模型透明区域显示异常）</span>
          mat.<span class="hljs-property">alphaTest</span> = <span class="hljs-number">0.5</span>; <span class="hljs-comment">// 阈值：0.3~0.9，值越大裁剪越严格</span>
          <span class="hljs-comment">// 可选：若alphaTest无效，启用透明（慎用，可能有排序问题）</span>
          <span class="hljs-comment">// mat.transparent = true;</span>
          <span class="hljs-comment">// mat.depthWrite = false; // 关闭深度写入，解决透明闪烁</span>
          <span class="hljs-keyword">break</span>;
          
        <span class="hljs-keyword">case</span> <span class="hljs-string">'metal'</span>: <span class="hljs-comment">// 金属/高反射模型</span>
          <span class="hljs-comment">// 调整材质粗糙度（可选，让金属更真实）</span>
          <span class="hljs-keyword">if</span> (mat.<span class="hljs-property">roughness</span> !== <span class="hljs-literal">undefined</span>) {
            mat.<span class="hljs-property">roughness</span> = <span class="hljs-number">0.1</span>; <span class="hljs-comment">// 降低粗糙度，提升反光</span>
          }
          <span class="hljs-keyword">break</span>;
          
        <span class="hljs-keyword">case</span> <span class="hljs-string">'normal'</span>: <span class="hljs-comment">// 普通模型（木头/石头）</span>
          <span class="hljs-comment">// 无需额外配置，保持默认</span>
          <span class="hljs-keyword">break</span>;
      }
      
      <span class="hljs-comment">// 关键：更新材质（确保配置生效）</span>
      mat.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;
    });
  });
}
</code></pre>
<h5 data-id="heading-16">3.2 自动聚焦相机函数（避免模型看不到）</h5>
<p>计算模型包围盒，自动调整相机位置和视角，适配任意尺寸模型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 自动聚焦模型，让相机对准模型中心
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">THREE.Object3D</span>} <span class="hljs-variable">model</span> - 模型节点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">THREE.Camera</span>} <span class="hljs-variable">camera</span> - 相机对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">THREE.OrbitControls</span>} <span class="hljs-variable">controls</span> - 轨道控制器
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">autoFocusCamera</span>(<span class="hljs-params">model, camera, controls</span>) {
  <span class="hljs-comment">// 1. 计算模型的包围盒（包含所有子节点）</span>
  <span class="hljs-keyword">const</span> box = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Box3</span>().<span class="hljs-title function_">setFromObject</span>(model);
  <span class="hljs-comment">// 2. 获取模型中心坐标</span>
  <span class="hljs-keyword">const</span> center = box.<span class="hljs-title function_">getCenter</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>());
  <span class="hljs-comment">// 3. 获取模型尺寸（对角线长度）</span>
  <span class="hljs-keyword">const</span> size = box.<span class="hljs-title function_">getSize</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>()).<span class="hljs-title function_">length</span>();
  <span class="hljs-comment">// 4. 计算相机距离（模型尺寸的2倍，保证完整显示）</span>
  <span class="hljs-keyword">const</span> distance = size * <span class="hljs-number">2</span>;
  
  <span class="hljs-comment">// 5. 设置相机位置（在模型中心后方）</span>
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(center).<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, distance));
  <span class="hljs-comment">// 6. 相机看向模型中心</span>
  camera.<span class="hljs-title function_">lookAt</span>(center);
  <span class="hljs-comment">// 7. 更新轨道控制器目标（让控制器围绕模型中心旋转）</span>
  controls.<span class="hljs-property">target</span> = center;
  controls.<span class="hljs-title function_">update</span>(); <span class="hljs-comment">// 生效</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-17">三、不同类型GLTF模型加载示例</h3>
<h4 data-id="heading-18">1. 示例1：加载植物/草模型（核心适配透明）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建加载器</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
loader.<span class="hljs-title function_">load</span>(
  <span class="hljs-string">'./models/grass_medium_01_1k.gltf'</span>,
  <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
    scene.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
    <span class="hljs-comment">// 配置植物材质（alphaTest+双面）</span>
    <span class="hljs-title function_">configureMaterialForModel</span>(gltf.<span class="hljs-property">scene</span>, <span class="hljs-string">'plant'</span>);
    <span class="hljs-comment">// 自动聚焦</span>
    <span class="hljs-title function_">autoFocusCamera</span>(gltf.<span class="hljs-property">scene</span>, camera, controls);
  },
  <span class="hljs-function">(<span class="hljs-params">xhr</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`加载中：<span class="hljs-subst">${(xhr.loaded/xhr.total*<span class="hljs-number">100</span>).toFixed(<span class="hljs-number">1</span>)}</span>%`</span>),
  <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载失败：'</span>, err)
);
</code></pre>
<h4 data-id="heading-19">2. 示例2：加载金属/高反射模型（调整曝光+粗糙度）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 先调整渲染器曝光（金属模型适配）</span>
renderer.<span class="hljs-property">toneMappingExposure</span> = <span class="hljs-number">2.2</span>;

<span class="hljs-comment">// 加载金属模型</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
loader.<span class="hljs-title function_">load</span>(
  <span class="hljs-string">'./models/metal_car.gltf'</span>,
  <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
    scene.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
    <span class="hljs-comment">// 配置金属材质（降低粗糙度）</span>
    <span class="hljs-title function_">configureMaterialForModel</span>(gltf.<span class="hljs-property">scene</span>, <span class="hljs-string">'metal'</span>);
    <span class="hljs-comment">// 自动聚焦</span>
    <span class="hljs-title function_">autoFocusCamera</span>(gltf.<span class="hljs-property">scene</span>, camera, controls);
  },
  <span class="hljs-literal">null</span>,
  <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载失败：'</span>, err)
);
</code></pre>
<h4 data-id="heading-20">3. 示例3：加载带动画的GLTF模型（扩展）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 额外导入动画播放器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AnimationMixer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;

<span class="hljs-keyword">let</span> mixer; <span class="hljs-comment">// 动画混合器</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
loader.<span class="hljs-title function_">load</span>(
  <span class="hljs-string">'./models/animated_character.gltf'</span>,
  <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
    scene.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
    <span class="hljs-title function_">autoFocusCamera</span>(gltf.<span class="hljs-property">scene</span>, camera, controls);
    
    <span class="hljs-comment">// 初始化动画混合器（播放模型动画）</span>
    mixer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnimationMixer</span>(gltf.<span class="hljs-property">scene</span>);
    <span class="hljs-comment">// 播放第一个动画（如有多个，可遍历gltf.animations）</span>
    <span class="hljs-keyword">if</span> (gltf.<span class="hljs-property">animations</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      mixer.<span class="hljs-title function_">clipAction</span>(gltf.<span class="hljs-property">animations</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">play</span>();
    }
  },
  <span class="hljs-literal">null</span>,
  <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载失败：'</span>, err)
);

<span class="hljs-comment">// 动画循环中更新混合器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  <span class="hljs-keyword">if</span> (mixer) mixer.<span class="hljs-title function_">update</span>(<span class="hljs-number">0.01</span>); <span class="hljs-comment">// 传入时间增量</span>
  controls.<span class="hljs-title function_">update</span>();
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
<span class="hljs-title function_">animate</span>();
</code></pre>
<hr/>
<h3 data-id="heading-21">四、完整实战代码（适配所有模型类型）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Three.js 加载GLTF模型完整示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">overflow</span>: hidden; }
    <span class="hljs-selector-id">#progress</span> { <span class="hljs-attribute">position</span>: absolute; <span class="hljs-attribute">top</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>); <span class="hljs-attribute">color</span>: white; <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"progress"</span>&gt;</span>加载中... 0.0%<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 1. 导入核心模块</span>
    <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0'</span>;
    <span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0/examples/jsm/controls/OrbitControls.js'</span>;
    <span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0/examples/jsm/loaders/GLTFLoader.js'</span>;

    <span class="hljs-comment">// 2. 创建三大核心</span>
    <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
    <span class="hljs-comment">//背景色改成灰色</span>
    scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0x444444</span>); 
    <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>/<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
    renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
    <span class="hljs-comment">// 核心渲染配置（必加）</span>
    renderer.<span class="hljs-property">outputColorSpace</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">SRGBColorSpace</span>;
    renderer.<span class="hljs-property">toneMapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ACESFilmicToneMapping</span>;
    renderer.<span class="hljs-property">toneMappingExposure</span> = <span class="hljs-number">2.0</span>; <span class="hljs-comment">// 通用曝光值</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

    <span class="hljs-comment">// 3. 添加光源（PBR模型必须加）</span>
    <span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.8</span>); <span class="hljs-comment">// 环境光</span>
    <span class="hljs-keyword">const</span> dirLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1.2</span>); <span class="hljs-comment">// 平行光（主光源）</span>
    dirLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">5</span>);
    dirLight.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 可选：开启阴影</span>
    scene.<span class="hljs-title function_">add</span>(ambientLight, dirLight);

    <span class="hljs-comment">// 4. 创建轨道控制器</span>
    <span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
    controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 阻尼顺滑</span>
    controls.<span class="hljs-property">dampingFactor</span> = <span class="hljs-number">0.05</span>;

    <span class="hljs-comment">// 5. 核心辅助函数</span>
    <span class="hljs-comment">// 5.1 材质配置函数</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">configureMaterialForModel</span>(<span class="hljs-params">root, type = <span class="hljs-string">'normal'</span></span>) {
      root.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!child.<span class="hljs-property">isMesh</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">const</span> material = child.<span class="hljs-property">material</span>;
        <span class="hljs-keyword">const</span> materials = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(material) ? material : [material];
        
        materials.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mat</span> =&gt;</span> {
          mat.<span class="hljs-property">side</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>; <span class="hljs-comment">// 双面渲染</span>
          <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'plant'</span>) {
            mat.<span class="hljs-property">alphaTest</span> = <span class="hljs-number">0.5</span>; <span class="hljs-comment">// 植物Alpha裁剪</span>
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'metal'</span>) {
            <span class="hljs-keyword">if</span> (mat.<span class="hljs-property">roughness</span> !== <span class="hljs-literal">undefined</span>) mat.<span class="hljs-property">roughness</span> = <span class="hljs-number">0.1</span>;
          }
          mat.<span class="hljs-property">needsUpdate</span> = <span class="hljs-literal">true</span>;
        });
      });
    }

    <span class="hljs-comment">// 5.2 自动聚焦函数</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">autoFocusCamera</span>(<span class="hljs-params">model, camera, controls</span>) {
      <span class="hljs-keyword">const</span> box = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Box3</span>().<span class="hljs-title function_">setFromObject</span>(model);
      <span class="hljs-keyword">const</span> center = box.<span class="hljs-title function_">getCenter</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>());
      <span class="hljs-keyword">const</span> size = box.<span class="hljs-title function_">getSize</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>()).<span class="hljs-title function_">length</span>();
      <span class="hljs-keyword">const</span> distance = size * <span class="hljs-number">2</span>;
      camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(center).<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, distance));
      camera.<span class="hljs-title function_">lookAt</span>(center);
      controls.<span class="hljs-property">target</span> = center;
      controls.<span class="hljs-title function_">update</span>();
    }

    <span class="hljs-comment">// 6. 加载GLTF模型（替换为你的模型路径）</span>
    <span class="hljs-keyword">const</span> progressDom = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'progress'</span>);
    <span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
    loader.<span class="hljs-title function_">load</span>(
      <span class="hljs-comment">// 示例：使用CDN植物模型（避免本地路径问题）</span>
      <span class="hljs-string">'./grass_medium_01_1k/grass_medium_01_1k.gltf'</span>,
      <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
        progressDom.<span class="hljs-property">textContent</span> = <span class="hljs-string">'加载完成！'</span>;
        scene.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
        <span class="hljs-comment">// 配置植物材质</span>
        <span class="hljs-title function_">configureMaterialForModel</span>(gltf.<span class="hljs-property">scene</span>, <span class="hljs-string">'plant'</span>);
        <span class="hljs-comment">// 自动聚焦</span>
        <span class="hljs-title function_">autoFocusCamera</span>(gltf.<span class="hljs-property">scene</span>, camera, controls);
      },
      <span class="hljs-function">(<span class="hljs-params">xhr</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> progress = (xhr.<span class="hljs-property">loaded</span> / xhr.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>;
        progressDom.<span class="hljs-property">textContent</span> = <span class="hljs-string">`加载中... <span class="hljs-subst">${progress.toFixed(<span class="hljs-number">1</span>)}</span>%`</span>;
      },
      <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        progressDom.<span class="hljs-property">textContent</span> = <span class="hljs-string">'加载失败！'</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'模型加载失败：'</span>, err);
      }
    );

    <span class="hljs-comment">// 7. 动画循环</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
      <span class="hljs-title function_">requestAnimationFrame</span>(animate);
      controls.<span class="hljs-title function_">update</span>(); <span class="hljs-comment">// 更新控制器</span>
      renderer.<span class="hljs-title function_">render</span>(scene, camera);
    }
    <span class="hljs-title function_">animate</span>();

    <span class="hljs-comment">// 8. 窗口适配</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
      camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
      camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
      renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-22">示例效果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de76cd39cee417992014905190aced2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCg6L2u5a2Q55qE54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652454&amp;x-signature=J4SRtBTeJnqmjj0kaW%2FFAPP8%2Bp8%3D" alt="46d6f02a-b7f8-42ac-86b7-6cc382d026d0.png" loading="lazy"/></p>
<ol>
<li>页面显示加载进度，完成后显示植物模型；</li>
<li>植物模型透明区域正常显示，无黑边/闪烁；</li>
<li>相机自动对准模型中心，支持鼠标旋转/缩放视角；</li>
<li>模型色彩自然，无偏色、过亮问题；</li>
<li>窗口缩放时，场景自动适配尺寸。</li>
</ol>
<hr/>
<h3 data-id="heading-23">五、常见问题与避坑指南</h3>
<h4 data-id="heading-24">1. 模型加载失败</h4>

























<table><thead><tr><th>问题现象</th><th>原因</th><th>解决方法</th></tr></thead><tbody><tr><td>控制台报404</td><td>模型路径错误</td><td>检查路径（相对路径/绝对路径），确保.gltf/.glb文件存在</td></tr><tr><td>跨域错误</td><td>本地直接打开HTML，无HTTP服务</td><td>用VSCode Live Server/Node.js服务启动项目</td></tr><tr><td>CORS错误</td><td>CDN/服务器未配置跨域</td><td>配置服务器CORS头（Access-Control-Allow-Origin: *）</td></tr></tbody></table>
<h4 data-id="heading-25">2. 模型显示异常</h4>



































<table><thead><tr><th>问题现象</th><th>原因</th><th>解决方法</th></tr></thead><tbody><tr><td>模型偏色/发灰</td><td>未设置outputColorSpace</td><td>添加 <code>renderer.outputColorSpace = THREE.SRGBColorSpace</code></td></tr><tr><td>模型过亮/过曝</td><td>高反射材质未调整曝光</td><td>增大 <code>toneMappingExposure</code>（1.5~2.5）</td></tr><tr><td>模型透明区域黑边</td><td>植物模型未开alphaTest</td><td>设置 <code>mat.alphaTest = 0.5</code></td></tr><tr><td>模型背面不可见</td><td>未开双面渲染</td><td>设置 <code>mat.side = THREE.DoubleSide</code></td></tr><tr><td>模型看不到/太小</td><td>相机位置不对</td><td>使用 <code>autoFocusCamera</code> 自动聚焦</td></tr></tbody></table>
<h4 data-id="heading-26">3. 性能优化</h4>
<ul>
<li><strong>模型轻量化</strong>：用Blender简化模型面数，压缩纹理尺寸；</li>
<li><strong>复用材质</strong>：避免模型中重复创建相同材质；</li>
<li><strong>关闭不必要功能</strong>：静态模型关闭动画、阴影；</li>
<li><strong>LOD级别</strong>：为复杂模型创建多级别细节（远距显示低模）。</li>
</ul>
<hr/>
<h3 data-id="heading-27">核心总结</h3>
<ol>
<li><strong>渲染配置核心</strong>：
<ul>
<li>r152+ 必加 <code>outputColorSpace = THREE.SRGBColorSpace</code>；</li>
<li>高反射模型开启 <code>ACESFilmicToneMapping</code> + 调整 <code>toneMappingExposure</code>（1.5~2.5）；</li>
</ul>
</li>
<li><strong>加载流程</strong>：
<ul>
<li><code>GLTFLoader.load()</code> → 成功后添加 <code>gltf.scene</code> 到场景；</li>
<li>按模型类型适配材质（植物：alphaTest，金属：调整粗糙度）；</li>
<li>用 <code>Box3</code> 计算包围盒，实现相机自动聚焦；</li>
</ul>
</li>
<li><strong>避坑关键</strong>：
<ul>
<li>必须启动HTTP服务，避免跨域；</li>
<li>植物模型开启双面+Alpha裁剪；</li>
<li>不同模型适配不同曝光值，避免过亮/过暗。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【绘制】Paint 指令与栅格化（Raster）：逻辑坐标如何变成真正的位图数据。]]></title>    <link>https://juejin.cn/post/7597650624638287872</link>    <guid>https://juejin.cn/post/7597650624638287872</guid>    <pubDate>2026-01-22T02:54:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624638287872" data-draft-id="7596906923892408330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【绘制】Paint 指令与栅格化（Raster）：逻辑坐标如何变成真正的位图数据。"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-22T02:54:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小小栈"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170131006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【绘制】Paint 指令与栅格化（Raster）：逻辑坐标如何变成真正的位图数据。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170131006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小小栈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:54:25.000Z" title="Thu Jan 22 2026 02:54:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在《浏览器底层手记》的前四章中，我们已经完成了页面结构的搭建、样式的计算、几何坐标的确定以及图层的划分。</p>
<p>现在的浏览器手里拿着一堆“透明胶片”（图层），并且知道每一块胶片该叠放在什么位置。但问题是：<strong>胶片上还是空的</strong>。</p>
<p>这一章，我们将见证渲染流水线中最具魔力的时刻：浏览器如何指挥 GPU，将抽象的布局信息转化成屏幕上真实可见的<strong>像素点</strong>。</p>
<hr/>
<h2 data-id="heading-0">【绘制】Paint 指令与栅格化：像素的诞生</h2>
<p>从逻辑坐标到屏幕像素，并不是一步到位的，它经历了一个从“<strong>画法说明书</strong>”到“<strong>位图数据</strong>”的转化过程。</p>
<h3 data-id="heading-1">一、 绘制（Paint）：生成一份“画法说明书”</h3>
<p>很多人误以为“绘制”就是画出像素，但在浏览器内核里，这一步产生的其实是<strong>绘制指令（Painting Records）</strong> 。</p>
<p>想象一下，你请一位画家画画。你不会直接告诉他每个像素的颜色，而是给他一张清单：</p>
<ol>
<li>先画一个红色的矩形。</li>
<li>在矩形中心写上白色的文字。</li>
<li>给矩形加一个阴影。</li>
</ol>
<p>渲染进程的主线程会遍历布局树（Layout Tree），生成这样一个包含绘图序列的清单。</p>
<ul>
<li><strong>层叠顺序：</strong> 绘制不仅关注位置，更关注“谁在谁上面”。它会严格遵循 CSS 的层叠上下文（Stacking Context）顺序。</li>
</ul>
<h3 data-id="heading-2">二、 栅格化（Raster）：将指令转化为像素</h3>
<p>有了“说明书”，谁来执行？答案是<strong>合成线程（Compositor Thread）</strong> 。</p>
<p>主线程将生成的绘图指令提交（Commit）给合成线程。随后，合成线程启动<strong>栅格化线程池（Raster Worker Pool）</strong> 。</p>
<ul>
<li><strong>什么是栅格化？</strong> 简单来说，就是根据绘图指令，计算出每一个像素点的颜色值，最终生成<strong>位图（Bitmap）</strong> 。</li>
<li><strong>瓦片（Tiles）先行：</strong> 为了节省内存，合成线程会优先栅格化**视口（Viewport）**内的瓦片。</li>
</ul>
<h3 data-id="heading-3">三、 GPU 加速：像素的“超级工厂”</h3>
<p>在过去，栅格化是靠 CPU 完成的（软件渲染），速度较慢。现在的浏览器普遍采用 <strong>GPU 加速栅格化</strong>。</p>
<ol>
<li><strong>指令传输：</strong> 合成线程将绘图指令通过 <strong>GL/Vulkan/D3D</strong> 等图形 API 发送给 GPU。</li>
<li><strong>Skia 图形引擎：</strong> Chrome 使用 Skia（一个高性能 2D 图形库）来指挥 GPU。GPU 极其擅长并行处理数学计算，能在一瞬间完成数百万个像素的着色。</li>
<li><strong>纹理（Texture）：</strong> 栅格化后的位图会以“纹理”的形式存储在 GPU 的显存中。</li>
</ol>
<h3 data-id="heading-4">四、 显示（Display）：最后的临门一脚</h3>
<p>当所有的瓦片纹理都准备好后，合成线程会生成一份“合成帧（Compositor Frame）”。</p>
<ol>
<li><strong>提交：</strong> 合成帧被发送给<strong>浏览器进程（Browser Process）</strong> 。</li>
<li><strong>显示：</strong> 浏览器进程将其通过操作系统的 UI 接口（如 Windows 的 DWM）提交给显卡。</li>
<li><strong>刷新：</strong> 当你的显示器刷新（通常是 60Hz，即每 16.6ms 一次）时，显卡从缓冲区取出这帧数据，打在屏幕上。</li>
</ol>
<hr/>
<h3 data-id="heading-5">💡 给前端开发者的硬核贴士</h3>
<ul>
<li><strong>“重绘”（Repaint）的代价：</strong> 改变 <code>color</code> 或 <code>visibility</code> 会重新生成绘图指令并再次栅格化。虽然它不涉及布局计算（比重排快），但如果图层很大，栅格化的开销依然不可忽视。</li>
<li><strong>为什么 Canvas 比 DOM 快？</strong> DOM 元素的渲染受制于整个渲染管线（DOM-&gt;Layout-&gt;Paint-&gt;Raster），而 <code>Canvas</code> 允许开发者直接通过 API 越过前面的步骤，直接向栅格化层甚至 GPU 写入绘图指令，路径更短，控制力更强。</li>
<li><strong>内存监控：</strong> 每一个合成层都意味着显存中的一张位图。如果你的独立站图片过多或 <code>will-change</code> 滥用，会导致显存占用过高，在低配手机上甚至会导致浏览器崩溃（OOM）。</li>
</ul>
<hr/>
<h4 data-id="heading-6">结语</h4>
<p>至此，我们的“奇幻漂流”已经完成了从 0 到 1 的物理闭环：从服务器端的字节流，最终变成了显示器上的光点。</p>
<p>但在现代 Web 开发中，标准的流水线已经不能满足我们对性能和视觉的极致追求了。我们想要更早、更直接地介入这个过程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[脱糖魔法：为什么 java.time 在 Android 上还是会翻车？]]></title>    <link>https://juejin.cn/post/7597708846769750054</link>    <guid>https://juejin.cn/post/7597708846769750054</guid>    <pubDate>2026-01-21T16:16:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597708846769750054" data-draft-id="7597699796200456202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="脱糖魔法：为什么 java.time 在 Android 上还是会翻车？"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-21T16:16:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锋风"/> <meta itemprop="url" content="https://juejin.cn/user/4353721777533735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            脱糖魔法：为什么 java.time 在 Android 上还是会翻车？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721777533735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T16:16:15.000Z" title="Wed Jan 21 2026 16:16:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fiwesley.top%2Farticle%2Ff9617ce3%2F" target="_blank" title="https://iwesley.top/article/f9617ce3/" ref="nofollow noopener noreferrer">脱糖魔法：为什么 java.time 在 Android 上还是会翻车？ - Wesley's Blog</a></p>
<p>最近在写一个广告频控的功能，用 vibe coding 很快就开发完了，工具类引用了<code>java.time.*</code>，为了兼容旧安卓版本，需要启用脱糖，否则 IDE 会提示 api 的兼容性问题。项目的 AGP 版本是 8.0+，一开始运行没问题，但后面因为客户的工程是 AGP 4.0+，不愿意升级，所以要考虑兼容。由于在 agp 8.0+开发，要兼容好低版本，必须考虑第三方 SDK 的compileSdk、kotlin 和 AGP的版本要求，现在 maven 仓库居然不能直接查看 aar 的元数据，不能快速知晓这几个版本的要求，只能叫 AI 写个 gradle 版本 解析一下。坑都踩完后，发布 sdk 给客户，但客户 app 依赖sdk后，运行报错:<code>java.Lang.NoSuchMethodError: No static method ofInstant（Lj$/time/Instant;Lj$/time/ZoneId；）Lj$/time/LocalDate；in class Lj$/time/LocalDate</code>。究竟是为什么呢？分析之前先回顾一下语法糖和脱糖的知识点。</p>
<h2 data-id="heading-0">语法糖和脱糖</h2>
<p><strong>语法糖 = 让我们写代码有更爽的写法</strong>，本质上不增加能力，只是更加优雅地写代码。</p>
<p>比如：</p>
<ul>
<li><code>lambda</code></li>
<li><code>forEach { }</code></li>
<li><code>接口默认方法</code></li>
<li><code>try-with-resources</code></li>
<li>Kotlin 的很多写法（<code>data class</code>、<code>when</code>、<code>?.let</code>）等等</li>
</ul>
<p><strong>脱糖（desugar）= 把这些糖衣写法，改写成更基础、更原始的形式。</strong></p>
<h3 data-id="heading-1">Android 里脱糖分两大类</h3>
<p>A. 语言特性脱糖（Language Desugaring）</p>
<p>让 <strong>“新语法特性”</strong> 在旧 Android 版本上也能跑。</p>
<p>比如：<code>lambda</code>写法。</p>
<p>B. Java 标准库 API 脱糖（Core Library Desugaring / Library Desugaring）</p>
<p>旧 Android 系统里根本没有这些 API，或者缺很多方法，需要补上。</p>
<p>Android 的做法分为两步：</p>
<p><strong>步骤 1：打包一份“补齐的库”进 APK（desugar_jdk_libs）</strong></p>
<p><strong>步骤 2：D8/R8 把调用点路由到这份库上</strong> 也就是把对 <code>java.time.*</code> 的调用改写到 <code>j$.time.*</code>（内部替身包名）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cf18a571c10495f9d1ff1a96b42cfc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSL6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769616975&amp;x-signature=DZ1e%2BF%2Fo%2F8KxwDY0MSomS96S3Cg%3D" alt="使用“desugar”字节码转换实现 Java 8 语言功能支持" loading="lazy"/></p>
<p>也就是打包 sdk 这一步是不会发生脱糖的，脱糖发生在 apk 编译。另外<code>sourceCompatibility</code>只能阻止新语法特性，不能阻止新 api 引入，这也能理解，因为新 api 是跟随安卓版本走的，虽然你用了 java 8 编写，但只要高版本系统支持，就可以引入。</p>
<p>对于 java 8 特性，需要 1.0+版本的库，对于 java 9+ 特性需要 2.0+的库。</p>
<pre><code class="hljs language-java" lang="java">android {
    compileOptions {
        <span class="hljs-comment">// Flag to enable support for the new language APIs</span>
​
        <span class="hljs-comment">// For AGP 4.1+</span>
        isCoreLibraryDesugaringEnabled = <span class="hljs-literal">true</span>
        <span class="hljs-comment">// For AGP 4.0</span>
        <span class="hljs-comment">// coreLibraryDesugaringEnabled = true</span>
​
        <span class="hljs-comment">// Sets Java compatibility to Java 8</span>
        sourceCompatibility = JavaVersion.<span class="hljs-type">VERSION_1_8</span>
        <span class="hljs-variable">targetCompatibility</span> <span class="hljs-operator">=</span> JavaVersion.VERSION_1_8
    }
}
​
dependencies {
    <span class="hljs-comment">// For AGP 7.4+</span>
    coreLibraryDesugaring(<span class="hljs-string">"com.android.tools:desugar_jdk_libs:2.0.3"</span>)
    <span class="hljs-comment">// For AGP 7.3</span>
    <span class="hljs-comment">// coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:1.2.3")</span>
    <span class="hljs-comment">// For AGP 4.0 to 7.2</span>
    <span class="hljs-comment">// coreLibraryDesugaring("com.android.tools:desugar_jdk_libs:1.1.9")</span>
}
</code></pre>
<h2 data-id="heading-2">问题分析</h2>
<p>频控代码里面有这么一句，显示 java 9 引入。</p>
<p><code>LocalDate.ofInstant(Instant.ofEpochMilli(nowMillis), zoneId)</code></p>
<p>参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fwrite%2Fjava8-support-table%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/studio/write/java8-support-table?hl=zh-cn" ref="nofollow noopener noreferrer">通过脱糖获得 Java 8 及更高版本 API | Android Studio | Android Developers</a> 里面可知，1.0 +的库是没有<code>LocalDate.ofInstant</code> 这个方法的，需要 2.0+的库才支持 java 9+ 特性： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fwrite%2Fjava11-nio-support-table%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/studio/write/java11-nio-support-table?hl=zh-cn" ref="nofollow noopener noreferrer">通过脱糖提供的满足 Nio 规格要求的 Java 11 及更高版本 API | Android Studio | Android Developers</a>。所以客户的 agp 4.0+，不能正确脱糖导致没有生成<code>ofInstant</code>方法，运行报错：<code>java.Lang.NoSuchMethodError: No static method ofInstant（Lj$/time/Instant;Lj$/time/ZoneId；）Lj$/time/LocalDate；in class Lj$/time/LocalDate</code>。</p>
<p>这里注意，虽然脱糖不成功，但是里面的<code>LocalDate.ofInstant</code> 已经路由到新包名了，所以下面的写法也是被禁止的，即使安卓 14 支持，但是由于脱糖，无论成不成功，都会路由到新包名，所以在安卓 14 也会崩溃。但是你直接 run debug 版本的时候，会根据你的安卓设备不进行脱糖处理，看起来好像没问题，所以必须单独编译 apk 进行验证。</p>
<pre><code class="hljs language-scss" lang="scss">return if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {
    LocalDate<span class="hljs-selector-class">.ofInstant</span>(Instant.ofEpochMilli(nowMillis), zoneId)
} else {
    ZonedDateTime
        <span class="hljs-selector-class">.ofInstant</span>(Instant.ofEpochMilli(nowMillis), zoneId)
        <span class="hljs-selector-class">.toLocalDate</span>()
} 
</code></pre>
<p>最后的修复方法是，按照 1.0 脱糖库的要求，不要使用 java 9+ api。</p>
<pre><code class="hljs language-scss" lang="scss">ZonedDateTime<span class="hljs-selector-class">.ofInstant</span>(Instant.ofEpochMilli(nowMillis), zoneId)<span class="hljs-selector-class">.toLocalDate</span>()
</code></pre>
<h2 data-id="heading-3">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fwrite%2Fjava8-support%3Fhl%3Dzh-cn%23library-desugaring" target="_blank" title="https://developer.android.com/studio/write/java8-support?hl=zh-cn#library-desugaring" ref="nofollow noopener noreferrer">使用 Java 8 语言功能和 API | Android Studio | Android Developers</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fwrite%2Fjava8-support-table%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/studio/write/java8-support-table?hl=zh-cn" ref="nofollow noopener noreferrer">通过脱糖获得 Java 8 及更高版本 API | Android Studio | Android Developers</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fwrite%2Fjava11-minimal-support-table%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/studio/write/java11-minimal-support-table?hl=zh-cn" ref="nofollow noopener noreferrer">通过脱糖提供的满足最低规格要求的 Java 11 及更高版本 API | Android Studio | Android Developers</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Fwrite%2Fjava11-nio-support-table%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/studio/write/java11-nio-support-table?hl=zh-cn" ref="nofollow noopener noreferrer">通过脱糖提供的满足 Nio 规格要求的 Java 11 及更高版本 API | Android Studio | Android Developers</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fbuild%2Fkotlin-support%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/build/kotlin-support?hl=zh-cn" ref="nofollow noopener noreferrer">Kotlin 版本所需的 AGP、D8 和 R8 版本 | Android Studio | Android Developers</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fbuild%2Ftool-and-library-dependencies%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/build/tool-and-library-dependencies?hl=zh-cn" ref="nofollow noopener noreferrer">工具和库的相互依存关系 | Android Studio | Android Developers</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fbuild%2Fjdks%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/build/jdks?hl=zh-cn" ref="nofollow noopener noreferrer">Android build 中的 Java 版本 | Android Studio | Android Developers</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MDM项目给预转 apk 设置 deviceowner 权限]]></title>    <link>https://juejin.cn/post/7597650322409013300</link>    <guid>https://juejin.cn/post/7597650322409013300</guid>    <pubDate>2026-01-22T02:29:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322409013300" data-draft-id="7597623654055510031" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MDM项目给预转 apk 设置 deviceowner 权限"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-22T02:29:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yen"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426633214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MDM项目给预转 apk 设置 deviceowner 权限
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426633214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:29:15.000Z" title="Thu Jan 22 2026 02:29:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fwork%2Fdevice-admin%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.com/work/device-admin?hl=zh-cn" ref="nofollow noopener noreferrer">developer.android.com/work/device…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgooglesamples%2Fandroid-testdpc" target="_blank" title="https://github.com/googlesamples/android-testdpc" ref="nofollow noopener noreferrer">github.com/googlesampl…</a></p>
<p>假设有一个预装apk，想给它赋予deviowner权限，该怎么去处理呢？</p>
<p>我们知道，执行指令 adb shell dpm set-device-owner com.afwsamples.testdpc/.DeviceAdminReceiver，可以给应用程序 com.afwsamples.testdpc 赋予deviceowner权限。那么，我们是不是可以参考adb指令执行流程，去看看具体怎么给APP赋予deviceowner权限呢？</p>
<pre><code class="hljs language-java" lang="java">frameworks/base/services/devicepolicy/java/com/android/server/devicepolicy/DevicePolicyManagerServiceShellCommand.java

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_IS_SAFE_OPERATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"is-operation-safe"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_IS_SAFE_OPERATION_BY_REASON</span> <span class="hljs-operator">=</span> <span class="hljs-string">"is-operation-safe-by-reason"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_SET_SAFE_OPERATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"set-operation-safe"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_LIST_OWNERS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"list-owners"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_LIST_POLICY_EXEMPT_APPS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"list-policy-exempt-apps"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_SET_ACTIVE_ADMIN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"set-active-admin"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_SET_DEVICE_OWNER</span> <span class="hljs-operator">=</span> <span class="hljs-string">"set-device-owner"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_SET_PROFILE_OWNER</span> <span class="hljs-operator">=</span> <span class="hljs-string">"set-profile-owner"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_REMOVE_ACTIVE_ADMIN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"remove-active-admin"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_CLEAR_FREEZE_PERIOD_RECORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">"clear-freeze-period-record"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_FORCE_NETWORK_LOGS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"force-network-logs"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_FORCE_SECURITY_LOGS</span> <span class="hljs-operator">=</span> <span class="hljs-string">"force-security-logs"</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CMD_MARK_PO_ON_ORG_OWNED_DEVICE</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"mark-profile-owner-on-organization-owned-device"</span>;

DevicePolicyManagerServiceShellCommand(DevicePolicyManagerService service) {
    mService = Objects.requireNonNull(service);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onCommand</span><span class="hljs-params">(String cmd)</span> {
    <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> handleDefaultCommands(cmd);
    }
    <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">pw</span> <span class="hljs-operator">=</span> getOutPrintWriter()) {
        <span class="hljs-keyword">switch</span> (cmd) {
            <span class="hljs-keyword">case</span> CMD_IS_SAFE_OPERATION:
                <span class="hljs-keyword">return</span> runIsSafeOperation(pw);
            <span class="hljs-keyword">case</span> CMD_IS_SAFE_OPERATION_BY_REASON:
                <span class="hljs-keyword">return</span> runIsSafeOperationByReason(pw);
            <span class="hljs-keyword">case</span> CMD_SET_SAFE_OPERATION:
                <span class="hljs-keyword">return</span> runSetSafeOperation(pw);
            <span class="hljs-keyword">case</span> CMD_LIST_OWNERS:
                <span class="hljs-keyword">return</span> runListOwners(pw);
            <span class="hljs-keyword">case</span> CMD_LIST_POLICY_EXEMPT_APPS:
                <span class="hljs-keyword">return</span> runListPolicyExemptApps(pw);
            <span class="hljs-keyword">case</span> CMD_SET_ACTIVE_ADMIN:
                <span class="hljs-keyword">return</span> runSetActiveAdmin(pw);
            <span class="hljs-keyword">case</span> CMD_SET_DEVICE_OWNER:
                <span class="hljs-keyword">return</span> runSetDeviceOwner(pw);
            <span class="hljs-keyword">case</span> CMD_SET_PROFILE_OWNER:
                <span class="hljs-keyword">return</span> runSetProfileOwner(pw);
            <span class="hljs-keyword">case</span> CMD_REMOVE_ACTIVE_ADMIN:
                <span class="hljs-keyword">return</span> runRemoveActiveAdmin(pw);
            <span class="hljs-keyword">case</span> CMD_CLEAR_FREEZE_PERIOD_RECORD:
                <span class="hljs-keyword">return</span> runClearFreezePeriodRecord(pw);
            <span class="hljs-keyword">case</span> CMD_FORCE_NETWORK_LOGS:
                <span class="hljs-keyword">return</span> runForceNetworkLogs(pw);
            <span class="hljs-keyword">case</span> CMD_FORCE_SECURITY_LOGS:
                <span class="hljs-keyword">return</span> runForceSecurityLogs(pw);
            <span class="hljs-keyword">case</span> CMD_MARK_PO_ON_ORG_OWNED_DEVICE:
                <span class="hljs-keyword">return</span> runMarkProfileOwnerOnOrganizationOwnedDevice(pw);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> onInvalidCommand(pw, cmd);
        }
    }
}
<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">runSetDeviceOwner</span><span class="hljs-params">(PrintWriter pw)</span> {
    parseArgs();
    mService.setActiveAdmin(mComponent, <span class="hljs-comment">/* refreshing= */</span> <span class="hljs-literal">true</span>, mUserId);

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (!mService.setDeviceOwner(mComponent, mUserId,
                <span class="hljs-comment">/* setProfileOwnerOnCurrentUserIfNecessary= */</span> !mSetDoOnly)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"Can't set package "</span> + mComponent + <span class="hljs-string">" as device owner."</span>);
        }
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// Need to remove the admin that we just added.</span>
        mService.removeActiveAdmin(mComponent, UserHandle.USER_SYSTEM);
        <span class="hljs-keyword">throw</span> e;
    }

    mService.setUserProvisioningState(
            DevicePolicyManager.STATE_USER_SETUP_FINALIZED, mUserId);

    pw.printf(<span class="hljs-string">"Success: Device owner set to package %s\n"</span>, mComponent.flattenToShortString());
    pw.printf(<span class="hljs-string">"Active admin set to component %s\n"</span>, mComponent.flattenToShortString());
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>我们看到adb shell dpm 相关的执行指令是在DevicePolicyManagerServiceShellCommand这个类里面实现的，onCommand方法里识别到cmd指令匹配"set-device-owner"字符串时，会触发runSetDeviceOwner方法，里面有3个关键方法：</p>
<p>mService.setActiveAdmin(mComponent, /* refreshing= */ true, mUserId)；</p>
<pre><code class="hljs language-java" lang="java">frameworks/base/services/devicepolicy/java/com/android/server/devicepolicy/DevicePolicyManagerService.java

<span class="hljs-comment">/**
* <span class="hljs-doctag">@param</span> adminReceiver The admin to add
* <span class="hljs-doctag">@param</span> refreshing true = update an active admin, no error
*/</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setActiveAdmin</span><span class="hljs-params">(
        ComponentName adminReceiver, <span class="hljs-type">boolean</span> refreshing, <span class="hljs-type">int</span> userHandle)</span> {
    <span class="hljs-keyword">if</span> (!mHasFeature) {
        <span class="hljs-keyword">return</span>;
    }
    Preconditions.checkArgumentNonnegative(userHandle, <span class="hljs-string">"Invalid userId"</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-type">CallerIdentity</span> <span class="hljs-variable">caller</span> <span class="hljs-operator">=</span> getCallerIdentity();
    Preconditions.checkCallAuthorization(
            hasCallingOrSelfPermission(permission.MANAGE_DEVICE_ADMINS));
    Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(caller, userHandle));

    <span class="hljs-type">DevicePolicyData</span> <span class="hljs-variable">policy</span> <span class="hljs-operator">=</span> getUserData(userHandle);
    <span class="hljs-type">DeviceAdminInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> findAdmin(adminReceiver, userHandle,
            <span class="hljs-comment">/* throwForMissingPermission= */</span> <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">synchronized</span> (getLockObject()) {
        checkActiveAdminPrecondition(adminReceiver, info, policy);
        mInjector.binderWithCleanCallingIdentity(() -&gt; {
            <span class="hljs-keyword">final</span> <span class="hljs-type">ActiveAdmin</span> <span class="hljs-variable">existingAdmin</span>
                    <span class="hljs-operator">=</span> getActiveAdminUncheckedLocked(adminReceiver, userHandle);
            <span class="hljs-keyword">if</span> (!refreshing &amp;&amp; existingAdmin != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Admin is already added"</span>);
            }
            <span class="hljs-type">ActiveAdmin</span> <span class="hljs-variable">newAdmin</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActiveAdmin</span>(info, <span class="hljs-comment">/* parent */</span> <span class="hljs-literal">false</span>);
            newAdmin.testOnlyAdmin =
                    (existingAdmin != <span class="hljs-literal">null</span>) ? existingAdmin.testOnlyAdmin
                            : isPackageTestOnly(adminReceiver.getPackageName(), userHandle);
            policy.mAdminMap.put(adminReceiver, newAdmin);
            <span class="hljs-type">int</span> <span class="hljs-variable">replaceIndex</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> policy.mAdminList.size();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i &lt; N; i++) {
                <span class="hljs-type">ActiveAdmin</span> <span class="hljs-variable">oldAdmin</span> <span class="hljs-operator">=</span> policy.mAdminList.get(i);
                <span class="hljs-keyword">if</span> (oldAdmin.info.getComponent().equals(adminReceiver)) {
                    replaceIndex = i;
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">if</span> (replaceIndex == -<span class="hljs-number">1</span>) {
                policy.mAdminList.add(newAdmin);
                enableIfNecessary(info.getPackageName(), userHandle);
                mUsageStatsManagerInternal.onActiveAdminAdded(
                        adminReceiver.getPackageName(), userHandle);
            } <span class="hljs-keyword">else</span> {
                policy.mAdminList.set(replaceIndex, newAdmin);
            }
            saveSettingsLocked(userHandle);
            sendAdminCommandLocked(newAdmin, DeviceAdminReceiver.ACTION_DEVICE_ADMIN_ENABLED,
                    <span class="hljs-comment">/* adminExtras= */</span> <span class="hljs-literal">null</span>, <span class="hljs-comment">/* result= */</span> <span class="hljs-literal">null</span>);
        });
    }
}
</code></pre>
<p>mService.setDeviceOwner(mComponent, mUserId,/* setProfileOwnerOnCurrentUserIfNecessary= */ !mSetDoOnly)；</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setDeviceOwner</span><span class="hljs-params">(ComponentName admin, <span class="hljs-type">int</span> userId,
        <span class="hljs-type">boolean</span> setProfileOwnerOnCurrentUserIfNecessary)</span> {
    <span class="hljs-keyword">if</span> (!mHasFeature) {
        logMissingFeatureAction(<span class="hljs-string">"Cannot set "</span> + ComponentName.flattenToShortString(admin)
                + <span class="hljs-string">" as device owner for user "</span> + userId);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    Preconditions.checkArgument(admin != <span class="hljs-literal">null</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-type">CallerIdentity</span> <span class="hljs-variable">caller</span> <span class="hljs-operator">=</span> getCallerIdentity();
    
    calculateHasIncompatibleAccountsUnderAdb(caller)；

    <span class="hljs-type">boolean</span> <span class="hljs-variable">hasIncompatibleAccountsOrNonAdb</span> <span class="hljs-operator">=</span>
            !isAdb(caller) || hasIncompatibleAccountsOnAnyUser();

    <span class="hljs-keyword">if</span> (!hasIncompatibleAccountsOrNonAdb) {
        <span class="hljs-keyword">synchronized</span> (getLockObject()) {
            <span class="hljs-keyword">if</span> (!isAdminTestOnlyLocked(admin, userId) &amp;&amp; hasAccountsOnAnyUser()) {
                Slogf.w(LOG_TAG,
                        <span class="hljs-string">"Non test-only owner can't be installed with existing accounts."</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
    }

    <span class="hljs-keyword">synchronized</span> (getLockObject()) {
        enforceCanSetDeviceOwnerLocked(caller, admin, userId, hasIncompatibleAccountsOrNonAdb);

        Preconditions.checkArgument(isPackageInstalledForUser(admin.getPackageName(), userId),
                <span class="hljs-string">"Invalid component "</span> + admin + <span class="hljs-string">" for device owner"</span>);
        <span class="hljs-keyword">final</span> <span class="hljs-type">ActiveAdmin</span> <span class="hljs-variable">activeAdmin</span> <span class="hljs-operator">=</span> getActiveAdminUncheckedLocked(admin, userId);
        Preconditions.checkArgument(activeAdmin != <span class="hljs-literal">null</span> &amp;&amp; !getUserData(
                userId).mRemovingAdmins.contains(admin), <span class="hljs-string">"Not active admin: "</span> + admin);

        <span class="hljs-comment">// Shutting down backup manager service permanently.</span>
        toggleBackupServiceActive(UserHandle.USER_SYSTEM, <span class="hljs-comment">/* makeActive= */</span> <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">if</span> (isAdb(caller)) {
            <span class="hljs-comment">// Log device owner provisioning was started using adb.</span>
            MetricsLogger.action(mContext, PROVISIONING_ENTRY_POINT_ADB, LOG_TAG_DEVICE_OWNER);
            DevicePolicyEventLogger
                    .createEvent(DevicePolicyEnums.PROVISIONING_ENTRY_POINT_ADB)
                    .setAdmin(admin)
                    .setStrings(LOG_TAG_DEVICE_OWNER)
                    .write();
        }

        mOwners.setDeviceOwner(admin, userId);
        mOwners.writeDeviceOwner();
        setDeviceOwnershipSystemPropertyLocked();

        <span class="hljs-comment">//TODO(b/180371154): when provisionFullyManagedDevice is used in tests, remove this</span>
       <span class="hljs-comment">// hard-coded default value setting.</span>
       <span class="hljs-keyword">if</span> (isAdb(caller)) {
            activeAdmin.mAdminCanGrantSensorsPermissions = <span class="hljs-literal">true</span>;
            mPolicyCache.setAdminCanGrantSensorsPermissions(<span class="hljs-literal">true</span>);
            saveSettingsLocked(userId);
        }

        mInjector.binderWithCleanCallingIdentity(() -&gt; {
            <span class="hljs-comment">// Restrict adding a managed profile when a device owner is set on the device.</span>
            <span class="hljs-comment">// That is to prevent the co-existence of a managed profile and a device owner</span>
            <span class="hljs-comment">// on the same device.</span>
            <span class="hljs-comment">// Instead, the device may be provisioned with an organization-owned managed</span>
            <span class="hljs-comment">// profile, such that the admin on that managed profile has extended management</span>
            <span class="hljs-comment">// capabilities that can affect the entire device (but not access private data</span>
            <span class="hljs-comment">// on the primary profile).</span>
            <span class="hljs-keyword">if</span> (isHeadlessFlagEnabled()) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> u : mUserManagerInternal.getUserIds()) {
                    mUserManager.setUserRestriction(
                            UserManager.DISALLOW_ADD_MANAGED_PROFILE, <span class="hljs-literal">true</span>,
                            UserHandle.of(u));
                    <span class="hljs-comment">// Restrict adding a clone profile when a device owner is set on the device.</span>
                    <span class="hljs-comment">// That is to prevent the co-existence of a clone profile and a device owner</span>
                    <span class="hljs-comment">// on the same device.</span>
                    <span class="hljs-comment">// CDD for reference : https://source.android.com/compatibility/12/android-12-cdd#95_multi-user_support</span>
                    mUserManager.setUserRestriction(UserManager.DISALLOW_ADD_CLONE_PROFILE,
                            <span class="hljs-literal">true</span>,
                            UserHandle.of(u));
                }
            } <span class="hljs-keyword">else</span> {
                mUserManager.setUserRestriction(UserManager.DISALLOW_ADD_MANAGED_PROFILE,
                        <span class="hljs-literal">true</span>,
                        UserHandle.of(userId));
                <span class="hljs-comment">// Restrict adding a clone profile when a device owner is set on the device.</span>
                <span class="hljs-comment">// That is to prevent the co-existence of a clone profile and a device owner</span>
                <span class="hljs-comment">// on the same device.</span>
                <span class="hljs-comment">// CDD for reference : https://source.android.com/compatibility/12/android-12-cdd#95_multi-user_support</span>
                mUserManager.setUserRestriction(UserManager.DISALLOW_ADD_CLONE_PROFILE,
                        <span class="hljs-literal">true</span>,
                        UserHandle.of(userId));
            }
            <span class="hljs-comment">// TODO Send to system too?</span>
        sendOwnerChangedBroadcast(DevicePolicyManager.ACTION_DEVICE_OWNER_CHANGED, userId);
        });
        mDeviceAdminServiceController.startServiceForAdmin(
                admin.getPackageName(), userId, <span class="hljs-string">"set-device-owner"</span>);

        Slogf.i(LOG_TAG, <span class="hljs-string">"Device owner set: "</span> + admin + <span class="hljs-string">" on user "</span> + userId);
    }

    <span class="hljs-keyword">if</span> (setProfileOwnerOnCurrentUserIfNecessary
            &amp;&amp; mInjector.userManagerIsHeadlessSystemUserMode()) {
        <span class="hljs-type">int</span> currentForegroundUser;
        <span class="hljs-keyword">synchronized</span> (getLockObject()) {
            currentForegroundUser = getCurrentForegroundUserId();
        }
        Slogf.i(LOG_TAG, <span class="hljs-string">"setDeviceOwner(): setting "</span> + admin
                + <span class="hljs-string">" as profile owner on user "</span> + currentForegroundUser);
        <span class="hljs-comment">// Sets profile owner on current foreground user since</span>
        <span class="hljs-comment">// the human user will complete the DO setup workflow from there.</span>
        manageUserUnchecked(<span class="hljs-comment">/* deviceOwner= */</span> admin, <span class="hljs-comment">/* profileOwner= */</span> admin,
                <span class="hljs-comment">/* managedUser= */</span> currentForegroundUser, <span class="hljs-comment">/* adminExtras= */</span> <span class="hljs-literal">null</span>,
                <span class="hljs-comment">/* showDisclaimer= */</span> <span class="hljs-literal">false</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

</code></pre>
<p>mService.removeActiveAdmin(mComponent, UserHandle.USER_SYSTEM);</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeActiveAdmin</span><span class="hljs-params">(ComponentName adminReceiver, <span class="hljs-type">int</span> userHandle)</span> {
    <span class="hljs-keyword">if</span> (!mHasFeature) {
        <span class="hljs-keyword">return</span>;
    }
    Preconditions.checkArgumentNonnegative(userHandle, <span class="hljs-string">"Invalid userId"</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-type">CallerIdentity</span> <span class="hljs-variable">caller</span> <span class="hljs-operator">=</span> hasCallingOrSelfPermission(permission.MANAGE_DEVICE_ADMINS)
            ? getCallerIdentity() : getCallerIdentity(adminReceiver);
    Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(caller, userHandle));
    checkCanExecuteOrThrowUnsafe(DevicePolicyManager.OPERATION_REMOVE_ACTIVE_ADMIN);
    enforceUserUnlocked(userHandle);

    ActiveAdmin admin;
    <span class="hljs-keyword">synchronized</span> (getLockObject()) {
        admin = getActiveAdminUncheckedLocked(adminReceiver, userHandle);
        <span class="hljs-keyword">if</span> (admin == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// Active device/profile owners must remain active admins.</span>
        <span class="hljs-keyword">if</span> (isDeviceOwner(adminReceiver, userHandle)
                || isProfileOwner(adminReceiver, userHandle)) {
            Slogf.e(LOG_TAG, <span class="hljs-string">"Device/profile owner cannot be removed: component="</span>
                    + adminReceiver);
            <span class="hljs-keyword">return</span>;
        }
        mInjector.binderWithCleanCallingIdentity(() -&gt;
                removeActiveAdminLocked(adminReceiver, userHandle));
    }
    <span class="hljs-keyword">if</span> (isPolicyEngineForFinanceFlagEnabled() || isPermissionCheckFlagEnabled()) {
        mDevicePolicyEngine.removePoliciesForAdmin(
                EnforcingAdmin.createEnterpriseEnforcingAdmin(
                        adminReceiver, userHandle, admin));
    }
}
</code></pre>
<p>mService.setUserProvisioningState(DevicePolicyManager.STATE_USER_SETUP_FINALIZED, mUserId);</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserProvisioningState</span><span class="hljs-params">(<span class="hljs-type">int</span> newState, <span class="hljs-type">int</span> userId)</span> {
    <span class="hljs-keyword">if</span> (!mHasFeature) {
        logMissingFeatureAction(<span class="hljs-string">"Cannot set provisioning state "</span> + newState + <span class="hljs-string">" for user "</span>
                + userId);
        <span class="hljs-keyword">return</span>;
    }
    Preconditions.checkCallAuthorization(
            hasCallingOrSelfPermission(MANAGE_PROFILE_AND_DEVICE_OWNERS));

    <span class="hljs-keyword">final</span> <span class="hljs-type">CallerIdentity</span> <span class="hljs-variable">caller</span> <span class="hljs-operator">=</span> getCallerIdentity();
    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> mInjector.binderClearCallingIdentity();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">deviceOwnerUserId</span> <span class="hljs-operator">=</span> mOwners.getDeviceOwnerUserId();
        <span class="hljs-comment">// <span class="hljs-doctag">NOTE:</span> multiple if statements are nested below so it can log more info on error</span>
        <span class="hljs-keyword">if</span> (userId != deviceOwnerUserId) {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasProfileOwner</span> <span class="hljs-operator">=</span> mOwners.hasProfileOwner(userId);
            <span class="hljs-keyword">if</span> (!hasProfileOwner) {
                <span class="hljs-type">int</span> <span class="hljs-variable">managedUserId</span> <span class="hljs-operator">=</span> getManagedUserId(userId);
                <span class="hljs-keyword">if</span> (managedUserId &lt; <span class="hljs-number">0</span> &amp;&amp; newState != STATE_USER_UNMANAGED) {
                    <span class="hljs-comment">// No managed device, user or profile, so setting provisioning state makes</span>
                    <span class="hljs-comment">// no sense.</span>
                    <span class="hljs-type">String</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Not allowed to change provisioning state unless a "</span>
                            + <span class="hljs-string">"device or profile owner is set."</span>;
                    Slogf.w(LOG_TAG, <span class="hljs-string">"setUserProvisioningState(newState=%d, userId=%d) failed: "</span>
                            + <span class="hljs-string">"deviceOwnerId=%d, hasProfileOwner=%b, managedUserId=%d, err=%s"</span>,
                            newState, userId, deviceOwnerUserId, hasProfileOwner,
                            managedUserId, error);
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(error);
                }
            }
        }

        <span class="hljs-keyword">synchronized</span> (getLockObject()) {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">transitionCheckNeeded</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

            <span class="hljs-comment">// Calling identity/permission checks.</span>
            <span class="hljs-keyword">if</span> (isAdb(caller)) {
                <span class="hljs-comment">// ADB shell can only move directly from un-managed to finalized as part of</span>
                <span class="hljs-comment">// directly setting profile-owner or device-owner.</span>
                <span class="hljs-keyword">if</span> (getUserProvisioningState(userId)
                        != DevicePolicyManager.STATE_USER_UNMANAGED
|| newState != STATE_USER_SETUP_FINALIZED) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Not allowed to change provisioning state "</span>
                            + <span class="hljs-string">"unless current provisioning state is unmanaged, and new state"</span>
                            + <span class="hljs-string">"is finalized."</span>);
                }
                transitionCheckNeeded = <span class="hljs-literal">false</span>;
            }

            <span class="hljs-keyword">final</span> <span class="hljs-type">DevicePolicyData</span> <span class="hljs-variable">policyData</span> <span class="hljs-operator">=</span> getUserData(userId);
            <span class="hljs-keyword">if</span> (transitionCheckNeeded) {
                <span class="hljs-comment">// Optional state transition check for non-ADB case.</span>
                checkUserProvisioningStateTransition(policyData.mUserProvisioningState,
                        newState);
            }
            policyData.mUserProvisioningState = newState;
            saveSettingsLocked(userId);
        }
    } <span class="hljs-keyword">finally</span> {
        mInjector.binderRestoreCallingIdentity(id);
    }
}
</code></pre>
<p>大段的代码，看了就头痛，怎么办？仔细捋一捋，执行adb指令的目的，不就是为了执行DevicePolicyManagerService里面的这几个方法吗？那么，我们要是能通过某种途径，去完成这几个方法的执行，是不是就可以了？
框架层很多service都会监听开机广播，DevicePolicyManagerService也不例外。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@VisibleForTesting</span>
DevicePolicyManagerService(Injector injector, PolicyPathProvider pathProvider) {
    .......
    mContext = Objects.requireNonNull(injector.mContext);
    .......
    <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntentFilter</span>();
    filter.addAction(Intent.ACTION_BOOT_COMPLETED);
    filter.addAction(ACTION_EXPIRED_PASSWORD_NOTIFICATION);
    filter.addAction(ACTION_TURN_PROFILE_ON_NOTIFICATION);
    filter.addAction(ACTION_PROFILE_OFF_DEADLINE);
    filter.addAction(Intent.ACTION_USER_ADDED);
    filter.addAction(Intent.ACTION_USER_REMOVED);
    filter.addAction(Intent.ACTION_USER_STARTED);
    filter.addAction(Intent.ACTION_USER_STOPPED);
    filter.addAction(Intent.ACTION_USER_SWITCHED);
    filter.addAction(Intent.ACTION_USER_UNLOCKED);
    filter.addAction(LOGIN_ACCOUNTS_CHANGED_ACTION);
    filter.addAction(ACTION_MANAGED_PROFILE_UNAVAILABLE);
    filter.addAction(ACTION_MANAGED_PROFILE_AVAILABLE);
    filter.setPriority(IntentFilter.SYSTEM_HIGH_PRIORITY);
    mContext.registerReceiverAsUser(mReceiver, UserHandle.ALL, filter, <span class="hljs-literal">null</span>, mHandler);
    ....... 
}
</code></pre>
<p>于是灵光一现</p>
<p>我们先定义好预装apk的广播接收器</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">// the adminReceiver for the pre-installed apk</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">mdmDeviceOwnerPackageName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com.afwsamples.testdpc"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">mdmDeviceOwnerReceiverName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"com.afwsamples.testdpc.DeviceAdminReceiver"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isMdmDeviceOwnerSetting</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
</code></pre>
<p>然后在开机广播里去判断要不要执行adb指令里面需要用到的方法，需要的话就执行，不需要的话就不用做额外处理</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">BroadcastReceiver</span> <span class="hljs-variable">mReceiver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastReceiver</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> {
        
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">inCts</span> <span class="hljs-operator">=</span> SystemProperties.getBoolean(<span class="hljs-string">"persist.sys.cts_state"</span>, <span class="hljs-literal">false</span>);
        
        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> intent.getAction();
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">userHandle</span> <span class="hljs-operator">=</span> intent.getIntExtra(Intent.EXTRA_USER_HANDLE,
                getSendingUserId());
                .......
        <span class="hljs-keyword">if</span> (Intent.ACTION_BOOT_COMPLETED.equals(action)) {
<span class="hljs-type">ComponentName</span> <span class="hljs-variable">cn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(mdmDeviceOwnerPackageName, mdmDeviceOwnerReceiverName);
            <span class="hljs-type">boolean</span> <span class="hljs-variable">needSetDeviceOwner</span> <span class="hljs-operator">=</span> mdmNeedSetDeviceOwner(cn, userHandle);

            
            <span class="hljs-keyword">if</span> (inCts || needSetDeviceOwner) {
                calculateHasIncompatibleAccounts();
            }
            
            <span class="hljs-keyword">if</span> (needSetDeviceOwner) {
                mdmRunSetDeviceOwner(cn);
            }
        }
        ......
    }
};
</code></pre>
<p>mdmNeedSetDeviceOwner</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">mdmNeedSetDeviceOwner</span><span class="hljs-params">(ComponentName cn, <span class="hljs-type">int</span> userHandle)</span> {
        <span class="hljs-keyword">if</span> (mIPackageManager == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> mIPackageManager.getReceiverInfo(cn, GET_META_DATA, userHandle);
            <span class="hljs-keyword">if</span> (info != <span class="hljs-literal">null</span> &amp;&amp; !isDeviceOwner(cn, UserHandle.USER_SYSTEM)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
</code></pre>
<p>mdmRunSetDeviceOwner</p>
<pre><code class="hljs language-java" lang="java">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mdmRunSetDeviceOwner</span><span class="hljs-params">(ComponentName cn)</span> {
        <span class="hljs-keyword">if</span> (mHandler == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span>;
        }
        mHandler.postDelayed(() -&gt; {
            isMdmDeviceOwnerSetting = <span class="hljs-literal">true</span>;
            setActiveAdmin(cn, <span class="hljs-literal">true</span>, UserHandle.USER_SYSTEM);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (!setDeviceOwner(cn, UserHandle.USER_SYSTEM, <span class="hljs-literal">true</span>)) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Can't set mdm package "</span> + cn + <span class="hljs-string">" as device owner."</span>);
                }
                setUserProvisioningState(DevicePolicyManager.STATE_USER_SETUP_FINALIZED, UserHandle.USER_SYSTEM);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                removeActiveAdmin(cn, UserHandle.USER_SYSTEM);
            } <span class="hljs-keyword">finally</span> {
                isMdmDeviceOwnerSetting = <span class="hljs-literal">false</span>;
            }
        }, <span class="hljs-number">1000</span>);
    }
</code></pre>
<p>我们自信满满<br/>
编译代码make services -j16，<br/>
push jar包 adb push out/target/product/qssi_64/system/framework/services.jar system/framework/，<br/>
重启手机 adb reboot<br/>
去系统设置Settings里查看有没被赋予权限，很遗憾，没看到我们想要的结果<br/>
于是我们去仔细查看setDeviceOwner方法，发现有一个特殊的条件isAdb(CallerIdentity caller)</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Defines the root UID.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ROOT_UID</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">/**
 * Defines the UID/GID under which system code runs.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SYSTEM_UID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;

<span class="hljs-comment">/**
 * Defines the UID/GID for the user shell.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHELL_UID</span> <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;

<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAdb</span><span class="hljs-params">(CallerIdentity caller)</span> {
        <span class="hljs-keyword">return</span> isShellUid(caller) || isRootUid(caller);
}  
 
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isRootUid</span><span class="hljs-params">(CallerIdentity caller)</span> {
    <span class="hljs-keyword">return</span> UserHandle.isSameApp(caller.getUid(), Process.ROOT_UID);
}

<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isShellUid</span><span class="hljs-params">(CallerIdentity caller)</span> {
    <span class="hljs-keyword">return</span> UserHandle.isSameApp(caller.getUid(), Process.SHELL_UID);
}
</code></pre>
<p>我们在DevicePolicyManagerService里面直接调用setDeviceOwner，UID既不符合SHELL_UID，也不符合ROOT_UID，于是我们额外添加一个条件，变成</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAdb</span><span class="hljs-params">(CallerIdentity caller)</span> {
        <span class="hljs-keyword">return</span> isShellUid(caller) || isRootUid(caller) || isMdmDeviceOwnerSetting;
    }
    
</code></pre>
<p>isMdmDeviceOwnerSetting的使用，可回看mdmRunSetDeviceOwner方法</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[掌握大模型 RAG 优化：深度解析 4 种主流文本分块（Chunking）策略]]></title>    <link>https://juejin.cn/post/7597653098564223030</link>    <guid>https://juejin.cn/post/7597653098564223030</guid>    <pubDate>2026-01-21T17:10:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597653098564223030" data-draft-id="7597276695403790377" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="掌握大模型 RAG 优化：深度解析 4 种主流文本分块（Chunking）策略"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-21T17:10:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小鱼儿亮亮"/> <meta itemprop="url" content="https://juejin.cn/user/2831978245134504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            掌握大模型 RAG 优化：深度解析 4 种主流文本分块（Chunking）策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831978245134504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小鱼儿亮亮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T17:10:03.000Z" title="Wed Jan 21 2026 17:10:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在构建基于大语言模型（LLM）的知识库应用时，<strong>文本分块（Chunking）</strong> 是决定检索精度最关键的环节之一。本文将深入探讨为什么要进行分块，并详细介绍四种主流的分块策略及其代码实现。</p>
<hr/>
<h2 data-id="heading-0">一、 为什么“分块”至关重要？</h2>
<p>分块是将长文档拆分为更小、更易处理的片段的过程。其核心目标是：<strong>在检索时准确找到最相关的内容。</strong></p>
<ul>
<li><strong>语义独立性</strong>：理想的块应尽可能在不依赖上下文的情况下表达完整意思，方便模型理解。</li>
<li><strong>粒度平衡</strong>：块太小，有效信息不足，模型难以理解；块太大，包含噪音多，检索相关性下降。</li>
<li><strong>预处理</strong>：在分块前，通常需要进行文本清洗、去除停用词等操作。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、 四种主流分块策略实战</h2>
<h3 data-id="heading-2">1. 基于标点符号切分（句子级）</h3>
<p>通过识别自然语言中的标点符号（如 <code>。</code> <code>！</code> <code>？</code>）进行切分，最大限度保持了语义的完整。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> re

<span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text_by_punctuation</span>(<span class="hljs-params">text</span>):
    <span class="hljs-comment"># 匹配中英文结尾标点</span>
    pattern = <span class="hljs-string">r"[。！？｡]+"</span>
    segments = re.split(pattern, text)
    <span class="hljs-keyword">return</span> [s.strip() <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> segments <span class="hljs-keyword">if</span> s.strip()]

<span class="hljs-comment"># 适用场景：对话系统、对短句逻辑敏感的场景。</span>
</code></pre>
<h3 data-id="heading-3">2. 固定字符数切分</h3>
<p>不考虑内容含义，强制按照设定的字符长度进行硬切分。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text_by_fixed_length</span>(<span class="hljs-params">text, length</span>):
    <span class="hljs-keyword">return</span> [text[i:i + length] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(text), length)]

<span class="hljs-comment"># 优缺点：实现极其简单，但会造成主题和语义的严重断裂。</span>
<span class="hljs-comment"># 适用场景：日志处理、固定格式的代码块、传感器流数据。</span>
</code></pre>
<h3 data-id="heading-4">3. 带重叠窗口的固定长度切分</h3>
<p>这是对固定长度切分的改良，通过在相邻的块之间保留一部分重叠（Overlap），确保跨块的上下文信息不会丢失。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text_by_fixed_length_with_overlap</span>(<span class="hljs-params">text, length, overlap</span>):
    step = length - overlap
    <span class="hljs-keyword">return</span> [text[i:i + length] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(text) - overlap, step)]

<span class="hljs-comment"># 意义：如果某个语义被切断，重叠部分能确保它在下一个 Chunk 中以完整形式出现。</span>
</code></pre>
<h3 data-id="heading-5">4. 递归字符切分（推荐方案）</h3>
<p>这是目前 RAG 应用中最常用的策略（如 LangChain 的默认实现）。它通过一组分隔符（如 <code>\n\n</code>, <code>\n</code>, ``）递归地尝试拆分，直到块大小达标。</p>
<p><strong>LangChain 实现示例：</strong></p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

splitter = RecursiveCharacterTextSplitter(
    separators=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>], <span class="hljs-comment"># 优先级由高到低</span>
    chunk_size=<span class="hljs-number">60</span>, 
    chunk_overlap=<span class="hljs-number">12</span>,
    length_function=<span class="hljs-built_in">len</span>
)

text = <span class="hljs-string">"..."</span> <span class="hljs-comment"># 您的长文本 </span>
splits = splitter.split_text(text)
</code></pre>
<hr/>
<h2 data-id="heading-6">三、 策略效果对比</h2>
<p><strong>以以下文本为例，对比不同策略的效果。</strong></p>
<p>春节的脚步越来越近，大街小巷都布满了节日的气氛。商店门口挂满了红灯笼和春联，家家户户都在忙着打扫卫生，准备迎接新的一年。
小明回到家乡，感受到了浓浓的过年氛围。他在街上走着，看到小朋友们手持烟花棒，欢笑声此起彼伏。
夜幕降临，整个城市亮起了五彩缤纷的灯光，映照着人们脸上的喜悦与期待。老人们聚在一起，回忆过去，展望未来。
而年轻人则在夜市享受美食，放松心情。这是一个充满希望和喜悦的时刻，每个人都在以自己的方式庆祝这个特殊的节日。</p>
<p><strong>1、基于标点符号切分（句子级）</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">春节的脚步越来越近，大街小巷都布满了节日的气氛</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">商店门口挂满了红灯笼和春联，家家户户都在忙着打扫卫生，准备迎接新的一年</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">小明回到家乡，感受到了浓浓的过年氛围</span>
<span class="hljs-attr">Chunk 4:</span> <span class="hljs-string">他在街上走着，看到小朋友们手持烟花棒，欢笑声此起彼伏</span>
<span class="hljs-attr">Chunk 5:</span> <span class="hljs-string">夜幕降临，整个城市亮起了五彩缤纷的灯光，映照着人们脸上的喜悦与期待</span>
<span class="hljs-attr">Chunk 6:</span> <span class="hljs-string">老人们聚在一起，回忆过去，展望未来</span>
<span class="hljs-attr">Chunk 7:</span> <span class="hljs-string">而年轻人则在夜市享受美食，放松心情</span>
<span class="hljs-attr">Chunk 8:</span> <span class="hljs-string">这是一个充满希望和喜悦的时刻，每个人都在以自己的方式庆祝这个特殊的节日</span>
</code></pre>
<p><strong>2、固定字符数切分</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">春节的脚步越来越近，大街小巷都布满了节日的气氛。商店门口挂满了红灯笼和春联，家家户户都在忙着打扫卫生，准备迎接新的一年。小明回到家乡，感受到了浓浓的过年氛围。他在街上走着，看到小朋友们手持烟花棒，欢笑</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">声此起彼伏。夜幕降临，整个城市亮起了五彩缤纷的灯光，映照着人们脸上的喜悦与期待。老人们聚在一起，回忆过去，展望未来。而年轻人则在夜市享受美食，放松心情。这是一个充满希望和喜悦的时刻，每个人都在以自己的</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">方式庆祝这个特殊的节日。</span>
</code></pre>
<p><strong>3、带重叠窗口的固定长度切分</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">春节的脚步越来越近，大街小巷都布满了节日的气氛。商店门口挂满了红灯笼和春联，家家户户都在忙着打扫卫生，准备迎接新的一年。小明回到家乡，感受到了浓浓的过年氛围。他在街上走着，看到小朋友们手持烟花棒，欢笑</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">了浓浓的过年氛围。他在街上走着，看到小朋友们手持烟花棒，欢笑声此起彼伏。夜幕降临，整个城市亮起了五彩缤纷的灯光，映照着人们脸上的喜悦与期待。老人们聚在一起，回忆过去，展望未来。而年轻人则在夜市享受美食</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">老人们聚在一起，回忆过去，展望未来。而年轻人则在夜市享受美食，放松心情。这是一个充满希望和喜悦的时刻，每个人都在以自己的方式庆祝这个特殊的节日。</span>
</code></pre>
<p><strong>4、递归字符切分（推荐方案）</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Chunk 1:</span> <span class="hljs-string">春节的脚步越来越近，大街小巷都布满了节日的气氛。商店门口挂满了红灯笼和春联，家家户户都在忙着打扫卫生，准备迎接新的一年。</span>
<span class="hljs-attr">Chunk 2:</span> <span class="hljs-string">卫生，准备迎接新的一年。小明回到家乡，感受到了浓浓的过年氛围。他在街上走着，看到小朋友们手持烟花棒，欢笑声此起彼伏。夜幕</span>
<span class="hljs-attr">Chunk 3:</span> <span class="hljs-string">棒，欢笑声此起彼伏。夜幕降临，整个城市亮起了五彩缤纷的灯光，映照着人们脸上的喜悦与期待。老人们聚在一起，回忆过去，展望未</span>
<span class="hljs-attr">Chunk 4:</span> <span class="hljs-string">在一起，回忆过去，展望未来。而年轻人则在夜市享受美食，放松心情。这是一个充满希望和喜悦的时刻，每个人都在以自己的方式庆祝</span>
<span class="hljs-attr">Chunk 5:</span> <span class="hljs-string">个人都在以自己的方式庆祝这个特殊的节日。</span>
</code></pre>
<h2 data-id="heading-7">四、 策略对比总结</h2>








































<table><thead><tr><th><strong>策略</strong></th><th><strong>灵活性</strong></th><th><strong>语义保持</strong></th><th><strong>复杂度</strong></th><th><strong>推荐使用场景</strong></th></tr></thead><tbody><tr><td><strong>句子切分</strong></td><td>中</td><td>极高</td><td>低</td><td>结构化良好的文学或新闻文本</td></tr><tr><td><strong>固定字符</strong></td><td>低</td><td>差</td><td>极低</td><td>日志、固定格式数据</td></tr><tr><td><strong>重叠窗口</strong></td><td>中</td><td>中</td><td>低</td><td>追求检索召回率的通用 RAG</td></tr><tr><td><strong>递归切分</strong></td><td>高</td><td>高</td><td>中</td><td><strong>首选策略</strong>，适用于复杂文档</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">五、 结语</h2>
<p>分块没有“一劳永逸”的万能公式。对于开发者而言，最有效的做法是：</p>
<ol>
<li><strong>分析数据源</strong>（是规整的报告还是杂乱的网页？）。</li>
<li><strong>选择合适的 Splitter</strong>（优先尝试递归切分）。</li>
<li><strong>利用可视化工具</strong>（如 LangChain Text Splitter Streamlit App）实时调整 <code>chunk_size</code> 和 <code>overlap</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 与 Nodejs 哪个更快]]></title>    <link>https://juejin.cn/post/7597989474971025458</link>    <guid>https://juejin.cn/post/7597989474971025458</guid>    <pubDate>2026-01-22T02:53:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597989474971025458" data-draft-id="7597746812439707686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 与 Nodejs 哪个更快"/> <meta itemprop="keywords" content="前端,后端,GitHub"/> <meta itemprop="datePublished" content="2026-01-22T02:53:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员凌览"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174565198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 与 Nodejs 哪个更快
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174565198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员凌览
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:53:13.000Z" title="Thu Jan 22 2026 02:53:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是凌览。</p>
<ul>
<li>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.code24.top%2F" target="_blank" title="https://blog.code24.top/" ref="nofollow noopener noreferrer">blog.code24.top</a></li>
<li>去水印下载鸭：<a href="https://link.juejin.cn?target=http%3A%2F%2Fnologo.code.top%2F" target="_blank" title="http://nologo.code.top/" ref="nofollow noopener noreferrer">nologo.code.top</a></li>
</ul>
<p>如果本文能给你提供启发或帮助，欢迎动动小手指，一键三连（<code>点赞</code>、<code>评论</code>、<code>转发</code>），给我一些支持和鼓励谢谢。</p>
<h2 data-id="heading-0">前言</h2>
<p>又刷到了Python 与 Nodejs 哪个更快的这类话题。巧的是在GitHub还开源了类似的计算机语言性能比较的开源库——speed-comparison。</p>
<p>单纯从性能上比较，speed-comparison已经给出了结论:Python(PyPy)&gt;Javascript(nodejs)&gt;Python(CPython)</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3696a870cea6423992e7fc8deb1854cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655193&amp;x-signature=cNq1zYMyHCLQTCvYbl08YrWRFVg%3D" alt="image.png" loading="lazy"/></p>
<p>PyPy3和 Python3（CPython）的差异在于<strong>解释器实现方式</strong>。Python3 是官方默认的 C 语言实现，而 PyPy3 是用 RPython 编写的替代实现，并引入了 <strong>JIT（即时编译）</strong> 技术。</p>
<p>speed-comparison测评数据属于较客观的，speed-comparison测评数据是进行莱布尼茨公式实现π的计算快慢。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dec3524cde444de834382ac5bca8d55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655193&amp;x-signature=0izr%2BG7zVCgDCBK21ytx%2BG1602M%3D" alt="image 1.png" loading="lazy"/></p>
<p>另外考虑公平性，做了以下处理：</p>
<ol>
<li>实现必须是单线程的。无多线程、异步或并行处理</li>
<li>允许使用更宽寄存器的SIMD优化，但必须独立，而非取代标准实现。<code>swift-simdcpp-avx2</code></li>
<li>使用语言的惯用代码。编译器优化标志没问题</li>
<li>所有实现必须使用现有实现中所示的莱布尼茨公式</li>
</ol>
<p>speed-comparison给出测评的语言不只有Python、Nodejs，常用语言也包括了，如：Java、C、C++等。</p>
<p>好奇的读者，可以浏览这个网页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fniklas-heer.github.io%2Fspeed-comparison%2F" target="_blank" title="https://niklas-heer.github.io/speed-comparison/" ref="nofollow noopener noreferrer">niklas-heer.github.io/speed-compa…</a></p>
<p>再来一起看看网友们高赞评论。</p>
<h2 data-id="heading-1">高赞评论</h2>
<p><strong>【网友1】</strong></p>
<p>如果不是谷歌那个大聪明通过 v8 让人们意识到「原来 js 能跑这么快」，压根就不会有现在 JavaScript 的生态。</p>
<p><strong>【网友2】</strong></p>
<p>Python 其实是斩杀线，比Python还慢的就直接斩杀了。</p>
<p>Node.js 的 V8 JavaScript/WASM 引擎是 JIT 的，它的 非常精妙，连 JVM 和 CLR 这两个老牌的都是要服气的。</p>
<p><strong>【网友3】</strong></p>
<p>nodejs目前的解释器使用是v8 engine，它是一个 JIT。所以可以大幅增加运行时的性能。</p>
<p>python目前的主流解释器是 CPython，它还是一个常规的解释器也就是只能一行行解释，不能在运行时优化部分代码为机器码。</p>
<p>所以目前的情况是 nodejs 大幅快于 python</p>
<p><strong>【网友4】</strong></p>
<p>Python这种常年倒数的就不要来找JS碰瓷了。</p>
<p>我们常吐槽JS慢，是拿它跟C、C++、Rust这些编译型语言比的，但JS的性能可谓是脚本语言的天花板，打python就像暴打小朋友一样。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e228ac6cd9845aeb0d620c28e7914eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655193&amp;x-signature=yLKrmpUdYBNA%2B6lJoJ%2BdUwLwdmM%3D" alt="image 2.png" loading="lazy"/></p>
<h2 data-id="heading-2">总结</h2>
<p>网友们的评论较主观没有数据说明,大家看看热闹就好。</p>
<p>如果一定要从性能方面比较，不考虑应用场景、社区、难易等等方面。</p>
<p>可以参考speed-comparison，自己也能拉取speed-comparison代码在本机电脑上跑一遍数据。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[推荐 5 个本周 火火火火 的 GitHub 开源项目。]]></title>    <link>https://juejin.cn/post/7597739723805425706</link>    <guid>https://juejin.cn/post/7597739723805425706</guid>    <pubDate>2026-01-22T03:02:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597739723805425706" data-draft-id="7597746390435135524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="推荐 5 个本周 火火火火 的 GitHub 开源项目。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-22T03:02:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            推荐 5 个本周 火火火火 的 GitHub 开源项目。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T03:02:04.000Z" title="Thu Jan 22 2026 03:02:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>01</p>
<p><strong>SuperPowers</strong></p>
<p>这个 GitHub 项目在本周还挺火的，现在已经 2.7 万的 Star 了。它其实一个为 Claude Code 设计的 Skill 框架与工作流插件。</p>
<p>改天会好好介绍一下这个 GitHub 开源项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb033a0d504d4188aa10dbb2f56017da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=NsKjhIdmrzPXHQcQdHJBQpRdBjQ%3D" alt="图片" loading="lazy"/></p>
<p>它强制 AI 在编写代码之前先进行深度的思考和规划。</p>
<p>比如你让配备了这个 GitHub 项目的 AI 开发一个 APP，它不会直接生成代码，而是会首先进入头脑风暴模式。</p>
<p>AI 会就需求细节向你提问，直到明确所有功能点，很像资深程序员指导初级程序员的模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3c6e39f36d846d283a87c30e993929a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=R4h22iCZgk2L0YiYdm43bIPmpSQ%3D" alt="图片" loading="lazy"/></p>
<p>而且，在做某个具体事之前 Superpowers 会生成一份包含具体任务列表的 Markdown 文件。</p>
<p>每一个任务都被拆解为极小的可执行单元。这些单元能在几分钟内完成，并包含具体的验证步骤。</p>
<p>在执行阶段，该工具利用 Claude Code 逐项完成计划中的任务。AI 会为每个功能编写测试用例，并在代码通过测试后才继续推进。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c63b97ca6c349fc8bd1f101445cac8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=KkV%2Fjkt7gcuSV7MXxpoENDFUrzM%3D" alt="图片" loading="lazy"/></p>
<p>这个插件集成了一系列具体的指令工具。你可以使用特定的命令来触发构思、规划或执行动作。</p>
<p>这些工具以插件的形式挂载在 Claude Code 的运行环境中。它们通过预设的提示词工程来约束 AI 的输出质量。</p>
<p>这个项目解决的主要问题是 AI 编程时的短视和混乱。通过强制分步执行，它让复杂的软件开发任务变得可控。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/obra/superpowers</span>
</code></pre>
<p>02</p>
<p><strong>自动化循环 Claude Code 工具</strong></p>
<p>这是一个 Claude Code 的自动化脚本。</p>
<p>能让 Claude Code 能够连续执行任务，直到项目目标达成，而无需人工不断输入确认指令。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/791fae9b5a4a432baaa4d478caf50113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=v2SdpPMWU1B9WDzUtkmPvysfJVE%3D" alt="图片" loading="lazy"/></p>
<p>这个开源项目借鉴了递归反馈的思想。</p>
<p>它会读取你的需求文档，并输入给 Claude Code。脚本会监控 Claude Code 的输出和执行状态。如果任务未完成，它会将当前的进度和剩余任务再次反馈给 AI。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/701e53c7095d465b96f49f1f1ca59cf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=DLwbiTdCeIXndMnzbPeTVUng1Po%3D" alt="图片" loading="lazy"/></p>
<p>项目内置了防止失控的安全措施。它包含了速率限制功能，防止短时间内消耗过多的 API 配额。</p>
<p>熔断机制会在检测到连续错误时自动停止脚本运行。这保护了你的 Token 预算不被意外耗尽。</p>
<p>它支持会话状态的持久化。如果开发过程中断，脚本可以保存当前的上下文信息。下次启动时，它能够恢复之前的进度继续工作。这使得处理耗时较长的大型重构任务成为可能。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/frankbria/ralph-claude-code</span>
</code></pre>
<p>03</p>
<p><strong>实时换脸开源项目</strong></p>
<p>这个开源项目能够通过摄像头实时捕捉画面并进行换脸。它有一个直观的图形用户界面，要换成谁只需要他的一张静态照片就行，</p>
<p>它还支持直接处理本地的视频文件，将视频中的人物面部进行替换并导出新视频。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64d5ea9cfafc49e6b2d76f3e2ac13465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=U2J%2F0cjnB4Nk0anmuSpS4Ue8bhM%3D" alt="图片" loading="lazy"/></p>
<p>开源项目底层是强大的计算机视觉库和深度学习模型，利用 ONNX 运行时环境来加速推理过程。</p>
<p>毫秒级别内进行面部特征的提取和融合，保证直播时的流畅度，有 NVIDIA 显卡的可以用 CUDA 加速，macOS 的用户，也支持 CoreML 加速。</p>
<p>在没有独立显卡的设备上，它依然可以通过 CPU 运行，但是帧率不会很高。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/hacksider/Deep-Live-Cam</span>
</code></pre>
<p>04</p>
<p><strong>OpenCode</strong></p>
<p>你可以把它理解成开源的 Claude Code，在终端环境中运行。</p>
<p>确实是本周很火的 GitHub 项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47971b7e7b644af8b6ad0501753edeba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=krOSAldJVwJ2XhB9w1p5S4wYzRo%3D" alt="图片" loading="lazy"/></p>
<p>Opencode 有两个模式，一种是构建模式，拥有完整的读写权限，可以直接修改文件系统。</p>
<p>另一种是规划模式，仅拥有读取权限，用于分析代码库结构或回答有关现有代码的问题。</p>
<p>而且背后大模型可以连接到 OpenAI 或 Anthropic 的云端大模型。它也支持通过 Ollama 连接本地运行的开源模型。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/anomalyco/opencode</span>
</code></pre>
<p>05</p>
<p><strong>金融研究 AI 智能体</strong></p>
<p>这是一个专为金融研究设计的自主 AI 智能体。</p>
<p>它能够像人类分析师一样对复杂的金融问题进行深入调研。该工具利用大语言模型的能力来拆解任务、规划路径并输出结论。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4759d31010b5406da228edfa4973cd35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=2iECeXL%2BHI32xINv9gXnYQvfF3g%3D" alt="图片" loading="lazy"/></p>
<p>Dexter 采用了多智能体协作的架构设计。</p>
<p>系统内部包含了专门负责规划、执行、验证和回答的子 Agent。规划 Agent 将你的问题分解为具体的搜索和分析步骤。执行 Agent 则负责调用工具获取数据。</p>
<p>该项目集成了实时金融数据的获取能力。</p>
<p>它可以访问实时的股票市场行情、财务报表和新闻资讯。这使得它生成的分析报告基于最新的市场动态，而非大模型预训练时的过时数据。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36bbd70665424866adb3ec9194820c8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=s9QqZ%2B1WjIZYqJRmXjviwxuUjz0%3D" alt="图片" loading="lazy"/></p>
<p>而且它支持自我反思与验证。</p>
<p>在得出结论之前，验证 Agent 会检查收集到的数据是否足以支撑论点。如果发现数据缺失或逻辑漏洞，系统会自动触发新一轮的搜索和分析任务。</p>
<p>它提供了一个透明的思考过程展示。用户可以看到 AI 是如何逐步分解问题并获取信息的。这种可解释性对于金融领域的应用至关重要，因为用户需要验证分析逻辑的可靠性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3340cf029ca34087adabecca632e62d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769655724&amp;x-signature=mALnhIBjXQajLE5Dnk9zVCge9nc%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/virattt/dexter</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 为 Markdown 添加标题]]></title>    <link>https://juejin.cn/post/7597623654056624143</link>    <guid>https://juejin.cn/post/7597623654056624143</guid>    <pubDate>2026-01-21T14:12:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056624143" data-draft-id="7597650624637239296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 为 Markdown 添加标题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T14:12:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橙子不要熬夜"/> <meta itemprop="url" content="https://juejin.cn/user/1493582536535881"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 为 Markdown 添加标题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1493582536535881/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橙子不要熬夜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:12:51.000Z" title="Wed Jan 21 2026 14:12:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="ascetic">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-link,.hljs-section,.hljs-string,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#888}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#ccc}.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-strong,.hljs-type{font-weight:700}.hljs-emphasis{font-style:italic}</style><h3 data-id="heading-0">背景</h3>
<p>大模型分步骤生成多段报告，最后合成一个富文本，后面的文本不知道前一段文本是什么标号，所以无法给出标题号，但是站在用户视角，不展示标题号又不直观，所以在渲染的时候要加标题号。</p>
<p>刚开始以为要用 react-markdown 库，识别文本内容是不是h1～h6标题，然后去手动添加标题号，后来发现展示的时候，可以通过 CSS 样式添加标题号，这样原始内容就不需要写死标题号，而是根据内容自动调整标题号。</p>
<h3 data-id="heading-1">核心代码</h3>
<ul>
<li>counter-reset：初始化计数器 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FProperties%2Fcounter-reset" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/counter-reset" ref="nofollow noopener noreferrer">MDN-counter-reset</a></li>
<li>counter-increment：递增计数器 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FProperties%2Fcounter-increment" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/counter-increment" ref="nofollow noopener noreferrer">MDN-counter-increment</a></li>
<li>counter()：显示值 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FValues%2Fcounter" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Values/counter" ref="nofollow noopener noreferrer">MDN-counter()</a></li>
</ul>
<h3 data-id="heading-2">富文本案例</h3>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactMarkdown</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-markdown"</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./index.module.less"</span>;

<span class="hljs-keyword">const</span> markdownContent = <span class="hljs-string">`# 引言
## 背景
### 历史回顾
#### 早期研究
##### 关键人物
###### 爱因斯坦的贡献
###### 牛顿的经典理论
##### 现代发展
#### 当前挑战
### 研究意义
## 目标
### 具体目标
#### 子目标 A
##### 细节 A1
###### 最终层级示例

# 方法
## 实验设计
#### 实验设计四级标题
### 数据采集
#### 传感器配置
##### 采样频率
###### 100Hz 设置

# 引言
## 背景
### 补充说明
#### 额外信息
##### 子项
###### 六级示例`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CounterResetCom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.markdownContent}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ReactMarkdown</span>&gt;</span>{markdownContent}<span class="hljs-tag">&lt;/<span class="hljs-name">ReactMarkdown</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CounterResetCom</span>;
</code></pre>
<p>使用 counter-reset：重置计数器</p>
<p>counter-increment：累加</p>
<p>counter()：取值</p>
<pre><code class="hljs language-LESS" lang="LESS"><span class="hljs-selector-class">.markdownContent</span> {
  <span class="hljs-attribute">counter-reset</span>: h1-counter;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">counter-reset</span>: h2-counter h3-counter h4-counter h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h1</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h1-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'. '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h2</span> {
  <span class="hljs-attribute">counter-reset</span>: h3-counter h4-counter h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h2</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h2-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">counter-reset</span>: h4-counter h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h3</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h3-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h4</span> {
  <span class="hljs-attribute">counter-reset</span>: h5-counter h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h4</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h4-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h4-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h5</span> {
  <span class="hljs-attribute">counter-reset</span>: h6-counter;
}
<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h5</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h5-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h4-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h5-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.markdownContent</span> <span class="hljs-selector-tag">h6</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">counter-increment</span>: h6-counter;
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">counter</span>(h1-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h2-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h3-counter)
    <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h4-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h5-counter) <span class="hljs-string">'.'</span> <span class="hljs-built_in">counter</span>(h6-counter) <span class="hljs-string">' '</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76f8889665344781838c0c065ad6bada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5a2Q5LiN6KaB54as5aSc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609571&amp;x-signature=YHAN4SVcQgJTewc9Ktq6HTu4880%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">标签案例</h3>
<pre><code class="hljs language-TSX" lang="TSX"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactMarkdown</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-markdown"</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./index.module.less"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">CounterResetCom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.markdownContent}</span>&gt;</span>
      {/* 第一章 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>引言<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>背景<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>历史回顾<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>早期研究<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>关键人物<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>爱因斯坦的贡献<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>牛顿的经典理论<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>现代发展<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>当前挑战<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>研究意义<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>目标<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>具体目标<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>子目标 A<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>细节 A1<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>最终层级示例<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>

      {/* 第二章 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>方法<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>实验设计<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>实验设计四级标题<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>数据采集<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>传感器配置<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>采样频率<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>100Hz 设置<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>

      {/* 第三章（再次使用“引言”，但编号继续递增） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>引言<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>背景<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>补充说明<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>额外信息<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h5</span>&gt;</span>子项<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h6</span>&gt;</span>六级示例<span class="hljs-tag">&lt;/<span class="hljs-name">h6</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CounterResetCom</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56372680cb8a46a2bc8e9d6effba9d84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5a2Q5LiN6KaB54as5aSc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609571&amp;x-signature=Vm%2BAl7RIeU30Tk5FEI%2FJkdjspow%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">踩过的坑</h3>
<ul>
<li>把所有标题都重置了，出现了现实不正常的情况</li>
</ul>
<pre><code class="hljs language-LESS" lang="LESS"><span class="hljs-selector-class">.markdownContent</span> {
  <span class="hljs-attribute">counter-reset</span>: h1-counter h2-counter h3-counter h4-counter h5-counter
    h6-counter;
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17cf9d4927e94377a53ebcabaf1f3c92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qmZ5a2Q5LiN6KaB54as5aSc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609571&amp;x-signature=zWRF%2FETQEGmWGCM9al9h2r8O8mc%3D" alt="" loading="lazy"/>CSS 为 Markdown 添加标题</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-appD2（uni-forms学习与回顾）]]></title>    <link>https://juejin.cn/post/7597653098563977270</link>    <guid>https://juejin.cn/post/7597653098563977270</guid>    <pubDate>2026-01-21T14:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597653098563977270" data-draft-id="7597397134621540393" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-appD2（uni-forms学习与回顾）"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-21T14:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱泡脚的鸡腿"/> <meta itemprop="url" content="https://juejin.cn/user/4466663535419179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-appD2（uni-forms学习与回顾）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466663535419179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱泡脚的鸡腿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:14:48.000Z" title="Wed Jan 21 2026 14:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.使用uni中的uni-forms组件</h2>
<p><strong>其中使用v-model获取数据</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 引入ref或者reactive</span>
<span class="hljs-comment">// ref和reactive的区别:reactive不能重新赋值</span>
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-comment">// 定义表单中的数据</span>

*<span class="hljs-number">3.</span>使用reactive保存数据*
<span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">account</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>

**1.使用uni-foms表单**
**4.绑定formData**
    <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-form"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"form"</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"formData"</span>&gt;</span>
    
**  2.使用uni-forms-item**
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.account"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入账号"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"submit-button"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-keyword">@import</span> <span class="hljs-string">'./styles.scss'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre>
<h2 data-id="heading-1">2.表单验证</h2>
<h3 data-id="heading-2">2.1 表单字段</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d9ad9e223614def99a09e97790a3de8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=qXpCzivxcRR3dlt2dyrKyLK86tU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 定义校验规则</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 定义验证规则</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">accountRlues</span> = <span class="hljs-title function_ invoke__">reactive</span>({
    <span class="hljs-attr">account</span>: [
        // 可定义多个验证规则
        // requierd表示这个数据项必填
        { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'请输入登录账号'</span> },
        // 使用正则进行字母数字下划线的处理
        { <span class="hljs-attr">pattern</span>: <span class="hljs-string">'^[a-zA-Z0-9]{6,8}$'</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'登录账号格式不正确'</span> }
    ]
});
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611b7c2c329c42649588812eb8be9804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=m1Ze1GllJQEDBAQK4iTCzy9LGRI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">2.3 触发验证</h3>
<p><strong>定义一个accountForm=ref=&gt;     uni-forms组件绑定accountForm,实现将uni-forms这个组件的实例发放入accountForm中，便于后续使用validate（）=&gt;  给登录按钮绑定一个onsubmitForm函数，onsubmitForm中写validate（）=&gt;   点击onsubmitForm，触发校验</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 引入ref或者reactive</span>
<span class="hljs-comment">// ref和reactive的区别:reactive不能重新赋值</span>
<span class="hljs-keyword">import</span> { reactive, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 1. 定义获取表单元素的变量</span>
<span class="hljs-comment">// 模板里 &lt;uni-forms ref="accountForm"&gt; 会在组件挂载后把真实的 &lt;uni-forms&gt; </span>
<span class="hljs-comment">// 实例塞进 accountForm.value。</span>
<span class="hljs-comment">// → 目的：待会儿好调用它暴露的 validate() 方法。</span>
<span class="hljs-keyword">const</span> accountForm = <span class="hljs-title function_">ref</span>();

<span class="hljs-comment">// 定义表单中的数据</span>
<span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">account</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
});

<span class="hljs-comment">// 定义验证规则</span>
<span class="hljs-keyword">const</span> accountRlues = <span class="hljs-title function_">reactive</span>({
    <span class="hljs-attr">account</span>: {
        <span class="hljs-attr">rules</span>: [
            <span class="hljs-comment">// 可定义多个验证规则</span>
            <span class="hljs-comment">// requierd表示这个数据项必填</span>
            { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'请输入登录账号'</span> },
            <span class="hljs-comment">// 使用正则进行字母数字下划线的处理</span>
            { <span class="hljs-attr">pattern</span>: <span class="hljs-string">'^[a-zA-Z0-9]{6,8}$'</span>, <span class="hljs-attr">errorMessage</span>: <span class="hljs-string">'登录账号格式不正确'</span> }
        ]
    },

    <span class="hljs-attr">password</span>: {
        <span class="hljs-attr">rules</span>: [
            <span class="hljs-comment">// 可定义多个验证规则</span>
            <span class="hljs-comment">// requierd表示这个数据项必填</span>
            { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">erroMessage</span>: <span class="hljs-string">'请输入登录密码'</span> },
            <span class="hljs-comment">// 使用正则进行字母数字下划线的处理</span>
            { <span class="hljs-attr">pattern</span>: <span class="hljs-string">'^[a-zA-Z0-9]{6,8}$'</span>, <span class="hljs-attr">errorMessage</span>: <span class="hljs-string">'登录密码格式不正确'</span> }
        ]
    }
});



<span class="hljs-comment">// 4.提交表单数据</span>

<span class="hljs-comment">// 点击登录按钮 → 执行 onSubmitForm()。</span>
<span class="hljs-comment">// accountForm.value 就是第 1 步拿到的 &lt;uni-forms&gt; 实例；调用它暴露的 validate() 方法。</span>
<span class="hljs-comment">// validate() 内部会：</span>
<span class="hljs-comment">// 遍历所有 &lt;uni-forms-item&gt;；</span>
<span class="hljs-comment">// 根据 name 找到对应 rules；</span>
<span class="hljs-comment">// 用 async-validator 按顺序跑规则（required → pattern …）；</span>
<span class="hljs-comment">// 任一规则失败：</span>
<span class="hljs-comment">// 把 erroMessage 显示在对应项底部（默认红字）；</span>
<span class="hljs-comment">// 返回 false 并中断后续规则；</span>
<span class="hljs-comment">// 全部通过：继续走提交逻辑（这里你没写后续，通常发请求）。</span>

<span class="hljs-comment">//当验证成功后所返回的数据位表单中的数据，这些数据用于表单提交</span>
aysnc <span class="hljs-keyword">function</span> <span class="hljs-title function_">onSubmitForm</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 对表单数据进行验证(validate是uni-form提供的方法名)</span>
   <span class="hljs-keyword">const</span> formData= <span class="hljs-keyword">await</span> accountForm.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>();
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formData)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 2.将accountForm绑定至表单 --&gt;</span>
    <span class="hljs-comment">&lt;!-- &lt;uni-forms-item&gt; 的 name 必须和 rules 里的 key 保持一致（account/password）。 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-form"</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">"accountRlues"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"accountForm"</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"formData"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"account"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.account"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入账号"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">uni-forms-item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uni-input-input"</span> <span class="hljs-attr">placeholder-style</span>=<span class="hljs-string">"color: #818181"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms-item</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 3.监听按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onSubmitForm"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"submit-button"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">uni-forms</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-keyword">@import</span> <span class="hljs-string">'./styles.scss'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre>
<h3 data-id="heading-5">2.4 调用登录的接口</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.apifox.cn%2F4b036830-59b1-4526-b00a-61df2b3d4ae1%2Fapi-71329158" target="_blank" title="https://s.apifox.cn/4b036830-59b1-4526-b00a-61df2b3d4ae1/api-71329158" ref="nofollow noopener noreferrer">车辆信息 - 神领物流司机端-前端研究院</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2df722cffd98458a83539cc0e70496d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=AGxSILb9aE7VNuBvGIWrty5otzk%3D" alt="image.png" loading="lazy"/>
<strong>封装接口</strong></p>
<h4 data-id="heading-6">2.4.1 在apis/user.js中封装接口</h4>
<pre><code class="hljs language-apis/user.js" lang="apis/user.js">// 引入uni-fetch 进行请求的发起
import { UniFetch } from "uni-app-fetch";

// 导出函数方法一
// export const xxx=()=&gt;{
  
// }

// // 导出方法二：也可以以对象的格式
// export default{
//   xxx:()=&gt;{
    
//   }
// }

// 1.定义调用方法
export default{
  // @param {Object} data -登录所需要的用户密码
  login(data){
    if(!data.account || data.password) return
    用我事先封装好的 `uni-fetch` 拦截器实例，向 **基础地址 + /driver/login/account** 发一个 **GET** 请求，并把 `data` 里的字段自动拼到 URL 查询串上，同时带上统一设置的请求/响应拦截逻辑。”
    UniFetch.get('/driver/login/account',data)
  }

}
</code></pre>
<h4 data-id="heading-7">2.4.2 调用封装好的接口</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b93b77018409447396e1263dfb1b64e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=yUJHgl%2Bvhr0c5FqGWlYhLcZaOsw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">2.4.3 使用user.js（pinia技术）储存用户相关的数据</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-comment">// 使用ref定义一个响应式数据</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 三个参数,一个为counter,一个为箭头函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore
<span class="hljs-title class_">Store</span> = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>,
    <span class="hljs-comment">// 第二个参数:函数</span>
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 定义一个数据 token:用来记录用户登录状态</span>
      <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)

      <span class="hljs-comment">// 定义的数据必须return</span>
      <span class="hljs-keyword">return</span> { token } {
        <span class="hljs-comment">// 导出</span>
        <span class="hljs-attr">persist</span>: {
          <span class="hljs-attr">paths</span>: [<span class="hljs-string">'token'</span>]
        }
      })

</code></pre>
<p><strong>引入userUseStore并调用方法</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1cb6da8586642f3b695bb7085bdeae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=3syHpEddIXV9%2FWIgUBU%2BsgOfiF4%3D" alt="image.png" loading="lazy"/>
<strong>直接修改（让data赋值存入到pinia中）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f17457fd0a4404c872d00a468ed7eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769609688&amp;x-signature=8jfzrWuIt6xdP2r7EVfLuCDyBoE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的项目实战(三) - 轮播图（幻灯片）组件的优秀写法]]></title>    <link>https://juejin.cn/post/7597679732364476458</link>    <guid>https://juejin.cn/post/7597679732364476458</guid>    <pubDate>2026-01-21T14:23:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597679732364476458" data-draft-id="7597634458697564166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的项目实战(三) - 轮播图（幻灯片）组件的优秀写法"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-21T14:23:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ETA8"/> <meta itemprop="url" content="https://juejin.cn/user/608445545328347"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的项目实战(三) - 轮播图（幻灯片）组件的优秀写法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/608445545328347/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ETA8
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:23:51.000Z" title="Wed Jan 21 2026 14:23:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的前端开发中，轮播图（幻灯片）几乎是每个项目都会遇到的基础交互组件。无论是电商首页的商品推荐、新闻网站的头条展示，还是后台管理系统的引导页，轮播图都扮演着重要的角色。</p>
<p>今天，我们来深入探讨如何使用现代 React 技术栈构建一个<strong>高性能、可复用、体验良好</strong>的轮播图组件。我们将重点解析以下几个核心问题：</p>
<ul>
<li>如何合理使用 shadcn/ui 提供的 Carousel 组件？</li>
<li>为什么自动播放逻辑需要用 <code>useRef</code> 包装插件实例？</li>
<li>指示器（小圆点）是如何同步当前索引并保证性能的？</li>
</ul>
<p>通过这篇文章，你不仅能掌握这个组件的具体实现方式，还能理解背后的设计思想和常见陷阱，为今后自己封装通用组件打下坚实基础。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a1cadf4b3cb470f90b2b27d95a4271a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRVRBOA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769610230&amp;x-signature=aa3iSBsVPro4JYs6SUgFHXRXmOs%3D" alt="PixPin_2026-01-21_22-21-46.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、选择合适的底层轮播库：shadcn/ui 的 Carousel</h2>
<p>我们不从头造轮子，而是选择了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fui.shadcn.com%2F" target="_blank" title="https://ui.shadcn.com/" ref="nofollow noopener noreferrer">shadcn/ui</a> 提供的 <code>Carousel</code> 组件作为基础。它基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.embla-carousel.com%2F" target="_blank" title="https://www.embla-carousel.com/" ref="nofollow noopener noreferrer">Embla Carousel</a> 封装，提供了良好的 TypeScript 支持、无障碍访问能力和灵活的 API 设计。</p>
<h3 data-id="heading-1">为什么要用封装后的 Carousel？</h3>
<p>直接使用 Embla 原生库虽然功能强大，但配置复杂，需要手动处理 DOM 引用、事件绑定、响应式适配等问题。而 shadcn/ui 的封装让我们可以用更声明式的方式写代码：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Carousel</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CarouselContent</span>&gt;</span>
    {items.map((item) =&gt; (
      <span class="hljs-tag">&lt;<span class="hljs-name">CarouselItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>
        {/* 内容 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">CarouselItem</span>&gt;</span>
    ))}
  <span class="hljs-tag">&lt;/<span class="hljs-name">CarouselContent</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Carousel</span>&gt;
</code></pre>
<p>这种结构清晰明了，符合 React 的编程习惯。更重要的是，它已经内置了触摸滑动、键盘导航、循环滚动等常用功能，开箱即用。</p>
<p>我们只需关注业务逻辑：比如图片渲染、标题叠加、指示器控制、自动播放行为等。</p>
<hr/>
<h2 data-id="heading-2">二、自动播放的核心：Autoplay 插件为何要用 <code>useRef</code> 存储？</h2>
<p>这是整个组件中最值得深思的一环 —— <strong>性能优化的关键在于避免不必要的重新创建</strong>。</p>
<p>我们来看这段关键代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> plugin = <span class="hljs-title function_">useRef</span>(
  autoPlay ? <span class="hljs-title class_">Autoplay</span>({ <span class="hljs-attr">delay</span>: autoPlayDelay, <span class="hljs-attr">stopOnInteraction</span>: <span class="hljs-literal">false</span> }) : <span class="hljs-literal">null</span>
);
</code></pre>
<p>这里并没有把 <code>Autoplay(...)</code> 直接放在 <code>plugins</code> 属性里，而是用 <code>useRef</code> 包了一层。这是为什么？</p>
<h3 data-id="heading-3">❌ 错误做法：每次渲染都创建新插件</h3>
<p>如果你这样写：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Carousel</span> plugins={[<span class="hljs-title class_">Autoplay</span>({ <span class="hljs-attr">delay</span>: <span class="hljs-number">3000</span> })]} /&gt;
</code></pre>
<p>那么每当组件重新渲染时（例如父组件状态变化），<code>Autoplay(...)</code> 都会返回一个新的函数引用。Embla 会认为这是一个“新的插件”，从而卸载旧的、挂载新的 —— 这会导致：</p>
<ul>
<li>自动播放被中断或重置；</li>
<li>定时器频繁创建销毁，造成内存浪费；</li>
<li>用户正在拖动时可能意外触发重启；</li>
<li>性能下降，尤其在频繁更新的上下文中。</li>
</ul>
<h3 data-id="heading-4">✅ 正确做法：持久化存储插件实例</h3>
<p>通过 <code>useRef</code>，我们可以确保在整个组件生命周期中，<code>plugin.current</code> 只被初始化一次：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> plugin = <span class="hljs-title function_">useRef</span>(<span class="hljs-title class_">Autoplay</span>({ ... }));
</code></pre>
<p><code>useRef</code> 返回的对象是<strong>持久化的</strong>，它的 <code>.current</code> 属性不会因为重渲染而改变，除非你主动赋值。</p>
<p>这样一来：</p>
<ul>
<li>插件只会创建一次；</li>
<li>定时器稳定运行；</li>
<li>不受其他 state 或 props 更新的影响；</li>
<li>即便 <code>autoPlayDelay</code> 改变，也不会导致插件重建（当然，如果你希望动态响应 delay 变化，则需额外处理）；</li>
</ul>
<blockquote>
<p>⚠️ 注意：当前实现中 <code>autoPlayDelay</code> 是初始化后不可变的。若要支持动态调整间隔时间，建议监听该 prop 变化并通过 <code>plugin.current?.reset()</code> 手动重置定时器。</p>
</blockquote>
<p>此外，我们还设置了 <code>stopOnInteraction: false</code>，这意味着用户滑动后自动播放仍会继续。这比某些默认停止的设计更友好，提升了用户体验。</p>
<hr/>
<h2 data-id="heading-5">三、鼠标悬停控制播放：暂停与恢复的细节</h2>
<p>为了让用户有更多控制权，我们在鼠标进入和离开时控制播放状态：</p>
<pre><code class="hljs language-tsx" lang="tsx">onMouseEnter={<span class="hljs-function">() =&gt;</span> plugin.<span class="hljs-property">current</span>?.<span class="hljs-title function_">stop</span>()}
onMouseLeave={<span class="hljs-function">() =&gt;</span> plugin.<span class="hljs-property">current</span>?.<span class="hljs-title function_">reset</span>()}
</code></pre>
<p>这是一个非常实用的交互设计：</p>
<ul>
<li>当用户将鼠标移入轮播区域，自动播放暂停，方便他们仔细查看当前内容；</li>
<li>移出后自动恢复，保持流畅性；</li>
</ul>
<p>注意这里调用的是 <code>stop()</code> 和 <code>reset()</code>：</p>
<ul>
<li><code>stop()</code>：暂停当前计时器；</li>
<li><code>reset()</code>：重启动画，并从头开始倒计时；</li>
</ul>
<p>如果只调用 <code>start()</code> 而不是 <code>reset()</code>，可能会出现“延迟过久才切换”的情况，影响节奏感。</p>
<p>这也再次说明了使用 <code>useRef</code> 保存插件实例的重要性 —— 我们可以在任意事件回调中安全地访问并操作这个长期存在的对象。</p>
<hr/>
<h2 data-id="heading-6">四、指示器（Indicator Dots）的设计与同步机制</h2>
<p>底部的小圆点是轮播图的重要视觉反馈元素。它们告诉用户当前处于第几张，以及总共有多少张。</p>
<p>我们的实现如下：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div className=<span class="hljs-string">"absolute bottom-3 left-0 right-0 flex justify-center gap-2"</span>&gt;
  {slides.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">h-2</span> <span class="hljs-attr">w-2</span> <span class="hljs-attr">rounded-full</span> <span class="hljs-attr">transition-all</span> ${
        <span class="hljs-attr">selectedIndex</span> === <span class="hljs-string">i</span> ? '<span class="hljs-attr">bg-white</span> <span class="hljs-attr">w-6</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-white</span>/<span class="hljs-attr">30</span>'
      }`}
    /&gt;</span></span>
  ))}
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-7">关键点分析：</h3>
<h4 data-id="heading-8">1. 使用 <code>selectedIndex</code> 同步当前项</h4>
<p>我们通过 <code>useEffect</code> 监听 Carousel 实例的 <code>select</code> 事件来更新索引：</p>
<pre><code class="hljs language-ts" lang="ts">api.<span class="hljs-title function_">on</span>(<span class="hljs-string">'select'</span>, onSelect);
<span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> api.<span class="hljs-title function_">off</span>(<span class="hljs-string">'select'</span>, onSelect);
</code></pre>
<p>这是一种典型的“外部状态同步”模式。Embla 的 <code>selectedScrollSnap()</code> 方法返回当前激活的 slide 索引（从 0 开始），我们将它存入本地 state。</p>
<h4 data-id="heading-9">2. 动态样式控制宽度与透明度</h4>
<p>选中的 dot 宽度变为 <code>w-6</code>，形成“拉伸”动画效果，未选中的则是半透明小圆点。配合 <code>transition-all</code> 实现平滑过渡。</p>
<p>这样的设计既节省空间，又具有足够的视觉提示力。</p>
<h4 data-id="heading-10">3. 为什么 key 用 index？有没有风险？</h4>
<p>这里用了 <code>index</code> 作为 <code>key</code>，是因为 <code>slides</code> 数组本身是稳定的（不会动态增删项）。在这种前提下，用 index 是安全且高效的。</p>
<p>但如果未来支持动态添加/删除 slide，则应改用唯一 ID（如 <code>slide.id</code>）作为 key，防止 React 错误复用 DOM 元素。</p>
<hr/>
<h2 data-id="heading-11">五、图片与标题的语义化呈现</h2>
<p>除了轮播逻辑，内容展示也不能忽视。</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;img src={image} alt={title || <span class="hljs-string">`slide <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>`</span>} /&gt;
</code></pre>
<ul>
<li><code>alt</code> 文本优先使用 <code>title</code>，无标题时 fallback 到序号描述，保障可访问性（a11y）；</li>
<li>图片使用 <code>object-cover</code> 确保填满容器的同时不 distortion；</li>
<li>标题覆盖在图片下方，使用渐变遮罩提升文字可读性：</li>
</ul>
<pre><code class="hljs language-css" lang="css">bg-gradient-<span class="hljs-selector-tag">to</span>-t <span class="hljs-selector-tag">from</span>-black/<span class="hljs-number">60</span> <span class="hljs-selector-tag">to</span>-transparent
</code></pre>
<p>这个渐变从底部纯黑半透明向上渐隐，既能压暗背景突出文字，又不影响上半部分图像的可视性，是一种常见的卡片式布局技巧。</p>
<hr/>
<h2 data-id="heading-12">六、整体架构总结与可扩展建议</h2>



































<table><thead><tr><th>特性</th><th>实现方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>轮播核心</td><td>shadcn/ui Carousel + Embla</td><td>功能完整、支持触控</td><td>引入额外依赖</td></tr><tr><td>自动播放</td><td>Autoplay 插件 + useRef 持久化</td><td>避免重复创建、性能好</td><td>delay 不支持热更新</td></tr><tr><td>指示器</td><td>监听 select 事件 + 条件样式</td><td>视觉反馈清晰</td><td>圆点数量多时不适用</td></tr><tr><td>暂停控制</td><td>onMouseEnter/Leave</td><td>提升可用性</td><td>PC 端有效，移动端无效</td></tr></tbody></table>
<h3 data-id="heading-13">可扩展方向：</h3>
<ol>
<li><strong>支持垂直轮播</strong>：可通过 <code>opts={{ axis: 'y' }}</code> 实现。</li>
<li><strong>添加左右箭头按钮</strong>：利用 <code>api.prev()</code> 和 <code>api.next()</code> 控制翻页。</li>
<li><strong>适配移动端手势反馈</strong>：增加滑动提示动画或震动反馈。</li>
<li><strong>懒加载图片</strong>：对非当前页图片使用 <code>loading="lazy"</code> 或 Intersection Observer。</li>
<li><strong>自定义 transition 动画</strong>：结合 Framer Motion 实现更丰富的切换效果。</li>
</ol>
<hr/>
<h2 data-id="heading-14">结语：做一个“聪明”的组件开发者</h2>
<p>一个好的组件，不只是“能跑起来”，更要考虑：</p>
<ul>
<li><strong>性能是否可持续？</strong></li>
<li><strong>交互是否自然？</strong></li>
<li><strong>代码是否易于维护和扩展？</strong></li>
</ul>
<p>在这个 <code>SlideShow</code> 组件中，我们看到：</p>
<ul>
<li><code>useRef</code> 不只是用来拿 DOM 引用，更是管理外部实例、避免副作用重建的利器；</li>
<li>shadcn/ui 的组件封装降低了复杂度，但也要求我们理解其底层机制；</li>
<li>看似简单的指示器背后，也有状态同步、事件监听、样式过渡的精细设计。</li>
</ul>
<p>前端开发的魅力就在于此：每一个看似微不足道的细节，背后都有值得推敲的技术决策。</p>
<p>希望这篇文章能帮你建立起对轮播图组件的系统认知，在未来的项目中写出更加稳健、优雅的 UI 组件。</p>
<hr/>
<p>如果你觉得有收获，不妨点赞收藏，也欢迎留言交流你在项目中遇到的轮播图难题！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每天一例：公司里一个被忽视但能改进的流程【紧急需求】]]></title>    <link>https://juejin.cn/post/7597650624637992960</link>    <guid>https://juejin.cn/post/7597650624637992960</guid>    <pubDate>2026-01-22T01:57:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624637992960" data-draft-id="7597695487302664207" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每天一例：公司里一个被忽视但能改进的流程【紧急需求】"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-22T01:57:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每天一例：公司里一个被忽视但能改进的流程【紧急需求】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T01:57:04.000Z" title="Thu Jan 22 2026 01:57:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>每天一例｜紧急需求总是插队，但我们从没认真复盘过它们</p>
<p>那个需求是在版本封板前被塞进来的。排期已经确认，测试在做回归，开发手里剩下的都是收尾工作，但这个需求被标记为“必须马上处理”，理由很简单.....不做会影响当前客户使用。没有人再讨论优先级，也没有人问清楚背景，排期被直接打乱，原本计划中的工作全部让路，几个人被临时拉出来加班推进。那几天大家都很清楚，这不是第一次，也不会是最后一次。</p>
<p>需求最终还是赶在版本里上线了。功能能用，问题解决，客户没有再反馈。从结果看，这是一次成功的紧急响应，但团队付出的代价并不小：连续加班、原本的计划被推迟、测试时间被压缩。版本发完之后，所有人都松了一口气，然后很自然地进入了下一个迭代，好像这件事从来就该这样发生。</p>
<p>真正的问题在于，事情到这里就结束了。
没有复盘，没有追问为什么会紧急，也没有讨论是否存在更早发现的机会。紧急需求被当成一种不可讨论的事件，只要解决了，就默认流程已经完成。它像一场突发事故，被处理掉之后，大家只想尽快回到原来的节奏，而不是回头看路是怎么断的。</p>
<p>久而久之，这种默认值开始反噬团队。紧急需求越来越多，正常排期不断被打断，“先插一下”“这个更急”成了常态。团队对“紧急”的敏感度逐渐下降，从最初的高度紧张，变成疲惫应付，再到后来的一种麻木接受。当一切都紧急，其实就没有真正的紧急了，只剩下被持续打断的节奏。</p>
<p>后来我们做的改动非常小，但很关键：每一个紧急需求上线后，必须补一次极简复盘。不写长文档，不开大会，只回答三个问题，为什么会紧急、哪个节点可以提前发现、是否需要调整流程。控制在十几分钟内，只讲事实，不讨论责任。这一步不是为了追究谁的问题，而是把“紧急”重新拉回到可以被理解、被分析的范围里。</p>
<p>慢慢地，紧急需求真的开始变少了。不是因为问题消失了，而是因为团队开始更早地看见问题。复盘不是为了证明谁做错了，而是为了防止同样的紧急一再发生。当“紧急”被认真复盘过，它才不会成为一种默认状态；当紧急不再被复盘，它就一定会变成常态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Playwright学习笔记 02】CSS-selector定位]]></title>    <link>https://juejin.cn/post/7597664587458887715</link>    <guid>https://juejin.cn/post/7597664587458887715</guid>    <pubDate>2026-01-21T14:46:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597664587458887715" data-draft-id="7597664587458854947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Playwright学习笔记 02】CSS-selector定位"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T14:46:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鄭郑"/> <meta itemprop="url" content="https://juejin.cn/user/590879236308844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Playwright学习笔记 02】CSS-selector定位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/590879236308844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鄭郑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:46:33.000Z" title="Wed Jan 21 2026 14:46:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">定位后的操作方法：</h3>
<ul>
<li>点击元素， <strong><code>click()</code></strong> 方法</li>
<li>元素内输入文本， <strong><code>fill()</code></strong> 方法</li>
<li>获取元素内部文本， <strong><code>inner_text()</code></strong> 方法</li>
</ul>
<h2 data-id="heading-1">常用方法：</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/927ef48c5c66486a816e7ddcd2a7aaa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=WspA1R93NaL%2BqBCOEJB1J5OZsUM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>图中<strong>粉色字体</strong>都是可以用来定位的标志</p>
<p>定位标签常用id属性中的元素，一般html语言id的内容都是唯一的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f94a91bb7700454c818c139899d97859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=TgIUPHfWEkJzYeoc%2Fg5zoeDsrzg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>图中id属性中的内容被空格隔开的意思是，这个标签有两个属性分别是suggestion、stock</p>
<h2 data-id="heading-2">CSS selector</h2>
<p>原理：css本身就是浏览器用用来赋予内容样式的，赋予不同的颜色。</p>
<h3 data-id="heading-3">Locator 对象</h3>
<p>Page 对象的 locator方法就会创建一个 <code>Locator</code> 类型对象，参数就可以是 CSS Selector 表达式</p>
<pre><code class="hljs language-scss" lang="scss">`page<span class="hljs-selector-class">.locator</span>('#kw')<span class="hljs-selector-class">.fill</span>('通讯')
page<span class="hljs-selector-class">.locator</span>('#go')<span class="hljs-selector-class">.click</span>()`
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Page对象的 locator 定位到的如果是 <strong>''唯一''</strong> 的 html元素，就可以调用 Locator 对象的 方法，比如 <code>fill</code> , <code>click</code> , <code>inner_text</code> 等等对元素进行操作了。</p>
<h3 data-id="heading-4">根据 tag名、id、class 选择元素</h3>
<h4 data-id="heading-5">tag名</h4>
<p>直接写上tag名即可</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">locators</span> = page.locator(<span class="hljs-string">'div'</span>).all()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>然后可以通过for循环打印所有内容：</p>
<pre><code class="hljs language-css" lang="css">for one in locators:
    <span class="hljs-built_in">print</span>(one.<span class="hljs-built_in">inner_text</span>())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>要获取 所有的tag名为div的元素的内部可见文本，也可以直接调用 <code>all_inner_texts</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">texts</span> = page.locator(<span class="hljs-string">'div'</span>).all_inner_texts()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>注意，如果 locator调用 <strong><code>匹配的结果是多个元素</code></strong> ， 调用 <strong><code>针对单个元素的方法</code></strong> ，比如 <code>inner_text</code> ，会有错误抛出</p>
<h4 data-id="heading-6">根据id属性</h4>
<p>选择元素的语法是在id号前面加上一个井号： <strong><code>#id值</code></strong></p>
<p>比如 ，有下面这样的元素：</p>
<pre><code class="hljs language-python" lang="python">&lt;<span class="hljs-built_in">input</span>  <span class="hljs-built_in">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">'searchtext'</span> /&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>就可以使用 <code>#searchtext</code> 这样的 CSS Selector 来选择它。</p>
<p>比如，我们想在 <code>id 为 searchtext</code> 的输入框中输入文本 <code>你好</code> ，完整的Python代码如下</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">lct</span> = page.locator(<span class="hljs-string">'#searchtext'</span>)
lct.fill('你好')
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>根据class属性</strong></p>
<p>选择元素的语法是在 class 值 前面加上一个点： <strong><code>.class值</code></strong></p>
<p>要选择 class 属性值为 animal的元素 动物，可以这样写</p>
<pre><code class="hljs language-arduino" lang="arduino">page.<span class="hljs-built_in">locator</span>(<span class="hljs-string">'.animal'</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ad05fa904e49b185f86e9c0dcbede8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=CKUwSyYcTdLiQrg30ZIa6YW1VGI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-7">验证 CSS Selector语法是否正确</h2>
<p>由于 CSS Selector 是浏览器直接支持的，可以在浏览器 <strong>开发者工具栏</strong> 中验证。</p>
<p>比如我们使用Chrome浏览器打开一个网址</p>
<p>按F12 打开 开发者工具栏， 点击 Elements 标签后， 同时按 Ctrl 键 和 F 键， 就会出现下图箭头处的 搜索框</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8b862376f3441be8b0b867a380b2edd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YSt6YOR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769611592&amp;x-signature=Y6WMlTxhqXOpK4TkyIHEKwkw32I%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-8"><strong>匹配多个元素</strong></h2>
<p>前面已经说， 如果一个 locator表达式匹配多个元素，要获取所有的元素对应的 locator 对象，使用 <strong><code>all方法</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">locators</span> = page.locator(<span class="hljs-string">'.plant'</span>).all()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>有时，我们只需要得到某种表达式对应的元素数量 ，可以使用 <strong><code>count方法</code></strong>，如下</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">count</span> = page.locator(<span class="hljs-string">'.plant'</span>).count()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>返回结果就是匹配的元素数量。 可以根据返回结果是否为0 判断元素是否存在</p>
<p>有时，我们只需要得到某种表达式对应的<strong>第一个，或者最后一个元素。</strong></p>
<p>可以使用 <strong><code>first</code></strong> 和 <strong><code>last</code></strong> 属性 ， 如下</p>
<pre><code class="hljs language-scss" lang="scss">lct = page<span class="hljs-selector-class">.locator</span>('.plant')
<span class="hljs-built_in">print</span>(lct.first.inner_text(), lct<span class="hljs-selector-class">.last</span><span class="hljs-selector-class">.inner_text</span>())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>也可以，通过 <strong><code>nth</code></strong> 方法，获取指定次序的元素，参数0表达第一个， 1 表示第2个，比如:</p>
<pre><code class="hljs language-scss" lang="scss">lct = page<span class="hljs-selector-class">.locator</span>('.plant')
<span class="hljs-built_in">print</span>(lct.nth(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.inner_text</span>())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-9">元素内部定位</h2>
<p>前面都是通过 <strong><code>Page</code></strong> 对象调用的 locator 方法， 定位的范围是整个网页。</p>
<p>如果我们想在某个元素内部定位，可以通过 <strong><code>Locator</code></strong> 对象 调用 <strong>locator</strong> 方法。比如:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">lct</span> = page.locator(<span class="hljs-string">'#bottom'</span>)

<span class="hljs-comment"># 在 #bottom 对应元素的范围内 寻找标签名为 span 的元素。</span>
<span class="hljs-attr">eles</span> = lct.locator(<span class="hljs-string">'span'</span>).all()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 样式革命：NativeWind (Tailwind CSS) 实战]]></title>    <link>https://juejin.cn/post/7597650322408276020</link>    <guid>https://juejin.cn/post/7597650322408276020</guid>    <pubDate>2026-01-21T14:47:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408276020" data-draft-id="7597650624637386752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 样式革命：NativeWind (Tailwind CSS) 实战"/> <meta itemprop="keywords" content="React Native,前端"/> <meta itemprop="datePublished" content="2026-01-21T14:47:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小冰球"/> <meta itemprop="url" content="https://juejin.cn/user/2014722836669176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 样式革命：NativeWind (Tailwind CSS) 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2014722836669176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小冰球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:47:13.000Z" title="Wed Jan 21 2026 14:47:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前端开发的漫长历史中，样式的管理一直是个热门话题。从最原始的 CSS，到统治 Web 开发多年的 Sass/Less 预处理器，再到如今风靡全球的 Utility-First 理念。而在 React Native (RN) 的世界里，样式的写法也经历了从 <code>StyleSheet.create</code> 到各种 CSS-in-JS 库的演变。</p>
<p>本文将结合一个实际的 React Native 项目案例，探讨 CSS 预处理器的优劣，Tailwind CSS 的核心价值，以及如何通过 NativeWind 在 RN 项目中优雅地落地这一现代样式方案。</p>
<h3 data-id="heading-1">一、 前端样式的进化论：为什么我们需要改变？</h3>
<h4 data-id="heading-2">1.1 传统的痛点</h4>
<p>CSS 作为浏览器唯一能看懂的样式语言，早期存在明显的编程缺陷：缺乏变量、不支持嵌套、没有逻辑复用。为了解决这些问题，<strong>CSS 预处理器</strong>应运而生。</p>
<h4 data-id="heading-3">1.2 Sass vs Less：工具型语言的辉煌</h4>
<p>我们在项目中经常听到 Sass 和 Less，它们本质上是“为了写出更好的 CSS 而发明的工具”。</p>

























<table><thead><tr><th align="left">特性</th><th align="left">Sass (SCSS)</th><th align="left">Less</th></tr></thead><tbody><tr><td align="left"><strong>变量符</strong></td><td align="left"><code>$</code> (如 <code>$color</code>)</td><td align="left"><code>@</code> (如 <code>@color</code>)</td></tr><tr><td align="left"><strong>逻辑能力</strong></td><td align="left"><strong>强</strong> (支持复杂循环、条件判断)</td><td align="left"><strong>中</strong> (支持 Mixin、基础运算)</td></tr><tr><td align="left"><strong>运行环境</strong></td><td align="left">Dart / Ruby</td><td align="left">JavaScript (Node.js 友好)</td></tr></tbody></table>
<p>它们解决了“代码复用”和“结构清晰”的问题，但在 React Native 中，我们通常面临新的挑战：<strong>组件化与样式的隔离</strong>。虽然我们可以在 RN 中使用 Sass Transformer，但依然没有摆脱“给每个 View 起类名”的痛苦。</p>
<h3 data-id="heading-4">二、 Tailwind CSS：原子化思维的觉醒</h3>
<p>Tailwind CSS 的出现并不是为了发明一种新语言，而是提供了一套<strong>预设好的、原子级别的 CSS 类名</strong>。</p>
<h4 data-id="heading-5">2.1 什么是 Utility-First？</h4>
<ul>
<li><strong>传统写法</strong>：<code>class="card"</code> -&gt; 在 CSS 文件里写 <code>width</code>, <code>height</code>, <code>background</code>, <code>border-radius</code>。</li>
<li><strong>Tailwind 写法</strong>：<code>class="w-full h-20 bg-white rounded-lg"</code>。</li>
</ul>
<h4 data-id="heading-6">2.2 为什么要用它？</h4>
<ol>
<li><strong>极速开发</strong>：不用在 JSX 和 CSS 文件间来回跳转，不用绞尽脑汁想类名（比如 <code>wrapper-inner-box-left</code> 这种噩梦）。</li>
<li><strong>样式隔离</strong>：修改一个组件的 <code>p-4</code> (padding)，绝不会影响隔壁组件的样式。</li>
<li><strong>设计一致性</strong>：基于 Design Token 的限制（如只能用 <code>blue-500</code>, <code>blue-600</code>），避免了项目中出现几十种由于取色器误差导致的“不同的蓝色”。</li>
</ol>
<p>与 Bootstrap 这种“成品菜”不同，Tailwind 给的是“净菜”，让你自由烹饪，既快又灵活。</p>
<h3 data-id="heading-7">三、 实战：在 React Native 中落地 NativeWind</h3>
<p>在 RN 中，直接使用 Tailwind 需要很多 hack，而 <strong>NativeWind</strong> 是目前的最佳解决方案。它在编译时将 Tailwind 类名转换为 React Native 的原生样式对象 (<code>StyleSheet</code>)，兼顾了开发体验与运行时性能。</p>
<p>以下是我们项目 (<code>test_rn_css</code>) 的实战配置总结：</p>
<h4 data-id="heading-8">3.1 技术栈选择</h4>
<ul>
<li><strong>NativeWind</strong>: v4 (最新版，性能更强)</li>
<li><strong>Tailwind CSS</strong>: v3</li>
<li><strong>React Native Reanimated</strong>: 处理动画与样式转换</li>
</ul>
<h4 data-id="heading-9">3.2 关键配置详解</h4>
<p>在集成过程中，我们遇到了一些特定场景（如集成第三方 Chat UI Kit），因此配置显得尤为重要。</p>
<h5 data-id="heading-10">(1) <code>tailwind.config.js</code> 的特殊定制</h5>
<p>为了避免与引入的第三方 UI 库产生样式冲突，我们采用了<strong>前缀隔离</strong>策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// 扫描所有组件文件</span>
  <span class="hljs-attr">content</span>: [<span class="hljs-string">"./app/**/*.{js,jsx,ts,tsx}"</span>, <span class="hljs-string">"./components/**/*.{js,jsx,ts,tsx}"</span>],
  <span class="hljs-attr">presets</span>: [<span class="hljs-built_in">require</span>(<span class="hljs-string">"nativewind/preset"</span>)],

  <span class="hljs-comment">// ✨ 关键技巧：添加前缀</span>
  <span class="hljs-comment">// 所有的 utility class 必须加 'tw-'。</span>
  <span class="hljs-comment">// 例如：使用 'tw-bg-white' 而不是 'bg-white'。</span>
  <span class="hljs-comment">// 这样可以防止类名与 react-native-chat-uikit 等库内的样式名冲突。</span>
  <span class="hljs-attr">prefix</span>: <span class="hljs-string">"tw-"</span>,

  <span class="hljs-comment">// ✨ 暗黑模式手动控制</span>
  <span class="hljs-comment">// 避免跟随系统自动切换导致 UI 库背景色异常</span>
  <span class="hljs-attr">darkMode</span>: <span class="hljs-string">"class"</span>,

  <span class="hljs-attr">corePlugins</span>: {
    <span class="hljs-comment">// RN 不支持浏览器的样式重置，必须禁用</span>
    <span class="hljs-attr">preflight</span>: <span class="hljs-literal">false</span>,
  },
};
</code></pre>
<h5 data-id="heading-11">(2) 必要的 Metro 与 Babel 设置</h5>
<p>我们需要让打包工具认识 Tailwind。</p>
<ul>
<li><strong>babel.config.js</strong>: 添加 <code>nativewind/babel</code> 插件。</li>
<li><strong>metro.config.js</strong>: 使用 <code>withNativeWind</code> 包装默认配置，指定 CSS 入口。</li>
<li><strong>nativewind-env.d.ts</strong>: 引入类型定义，让 TypeScript 能够完美识别 <code>className</code> 属性。</li>
</ul>
<h4 data-id="heading-12">3.3 开发避坑指南</h4>
<p>集成后，开发体验获得了质的飞跃。但由于配置了 <code>prefix</code>，新手最容易犯的错误是忘记加前缀。</p>
<p><strong>❌ 错误写法：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">View</span> className=<span class="hljs-string">"bg-white p-4"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>样式不会生效<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">View</span>&gt;
</code></pre>
<p><strong>✅ 正确写法：</strong></p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">View</span> className=<span class="hljs-string">"tw-bg-white tw-p-4"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tw-text-black tw-text-lg"</span>&gt;</span>样式完美应用，且不污染全局<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">View</span>&gt;
</code></pre>
<h3 data-id="heading-13">四、 总结</h3>
<p>NativeWind 充当了 Web 开发思维通向 Native 开发的桥梁。它让 React Native 开发者能够享受到 Utility-First 带来的极速编码体验。虽然在初期配置（如前缀处理、TypeScript 类型支持）上需要一点细心，但一旦搭建完成，它将极大地提升项目的 UI 开发效率和可维护性。</p>
<p>如果你还在为 React Native 的样式管理头疼，不妨试试 NativeWind，把“写样式”变成一种像搭积木一样简单的乐趣。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAsteriskZuo%2Ftest_rn_css" target="_blank" title="https://github.com/AsteriskZuo/test_rn_css" ref="nofollow noopener noreferrer">演示demo源码</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟]]></title>    <link>https://juejin.cn/post/7597650624637452288</link>    <guid>https://juejin.cn/post/7597650624637452288</guid>    <pubDate>2026-01-21T15:22:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624637452288" data-draft-id="7597664587458904099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-21T15:22:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:22:33.000Z" title="Wed Jan 21 2026 15:22:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端开发效率翻倍！MockJS 实现接口 Mock 与分页模拟</h2>
<p>在前后端分离的开发模式下，前端开发者常常面临 “等后端接口开发完成才能调试” 的困境。MockJS 的出现完美解决了这一问题，它能让前端自主伪造接口数据，提前完成页面开发与调试，上线时只需切换真实接口地址即可无缝对接。本文结合实战代码，详细讲解 MockJS 的使用场景、安装教程、核心用法（含分页模拟）及核心价值。</p>
<h3 data-id="heading-1">一、MockJS 的核心使用场景</h3>
<p>MockJS 是前端接口伪造工具，核心解决前端开发中 “接口依赖” 的痛点，典型使用场景包括：</p>
<ol>
<li><strong>前后端并行开发</strong>：后端未完成接口开发时，前端基于接口文档提前 Mock 接口，无需等待后端，大幅提升开发效率；</li>
<li><strong>接口文档先行</strong>：前后端先敲定接口文档（如<code>GET /api/posts?page=1&amp;limit=10</code>），前端基于文档 Mock 数据，确保接口格式 100% 匹配；</li>
<li><strong>多场景数据模拟</strong>：可灵活模拟分页、空数据、大数量级数据等场景，覆盖开发与测试全流程；</li>
<li><strong>无缝切换真实接口</strong>：开发阶段用 Mock 接口，上线前只需替换接口地址，无需修改业务代码。</li>
</ol>
<h3 data-id="heading-2">二、MockJS 环境搭建（基于 Vite）</h3>
<p>以 Vite 项目为例，完成 MockJS 的安装与基础配置：</p>
<h4 data-id="heading-3">1. 安装依赖</h4>
<p>需要安装<code>mockjs</code>（核心 Mock 库）和<code>vite-plugin-mock</code>（Vite 的 Mock 插件）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># npm安装 </span>
npm install mockjs vite-plugin-mock --save-dev 
<span class="hljs-meta"># yarn安装 </span>
yarn <span class="hljs-keyword">add</span> mockjs vite-plugin-mock -D
</code></pre>
<h4 data-id="heading-4">2. 配置 Vite</h4>
<p>在<code>vite.config.js</code>中配置 mock 插件，让 Vite 启动时加载 Mock 接口：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span> 
<span class="hljs-keyword">import</span> { viteMockServe } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-mock'</span> 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({ 
    <span class="hljs-attr">plugins</span>: [ 
        <span class="hljs-comment">// 配置Mock插件 </span>
        <span class="hljs-title function_">viteMockServe</span>({ 
            <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'./mock'</span>, <span class="hljs-comment">// Mock文件存放目录（本文示例中为posts.js所在目录） </span>
            <span class="hljs-attr">localEnabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开发环境启用Mock </span>
            <span class="hljs-attr">prodEnabled</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 生产环境关闭Mock（上线时自动切换真实接口） </span>
            }) 
         ] 
     })
</code></pre>
<h3 data-id="heading-5">三、MockJS 核心用法（结合 posts 接口实战）</h3>
<p>以 “文章列表（posts）” 接口为例，讲解 MockJS 的基础语法、接口 Mock 及分页逻辑实现。</p>
<h4 data-id="heading-6">1. 基础：MockJS 随机数据语法</h4>
<p>MockJS 通过<code>@</code>符号提供丰富的随机数据生成能力，满足不同数据类型的伪造需求：</p>



































<table><thead><tr><th>语法</th><th>说明</th><th>示例（对应 posts.js）</th></tr></thead><tbody><tr><td><code>@ctitle(min,max)</code></td><td>生成随机中文标题</td><td><code>title:'@ctitle(8,20)'</code>（8-20 字标题）</td></tr><tr><td><code>@integer(min,max)</code></td><td>生成随机整数</td><td><code>totalLikes:'@integer(0,500)'</code>（0-500 点赞）</td></tr><tr><td><code>@cname</code></td><td>生成随机中文姓名</td><td><code>name:'@cname(2,3)'</code>（2-3 字姓名）</td></tr><tr><td><code>@image(w*h)</code></td><td>生成随机图片地址</td><td><code>avatar:'@image(300*200)'</code>（300x200 图片）</td></tr><tr><td><code>Random.pick(arr, n)</code></td><td>从数组中随机选 n 个元素</td><td><code>tags:() =&gt; Mock.Random.pick(tags,2)</code>（选 2 个标签）</td></tr></tbody></table>
<h4 data-id="heading-7">2. 实战：Mock 文章列表接口</h4>
<p>新建<code>mock/posts.js</code>文件，按接口文档实现<code>GET /api/posts</code>的 Mock 接口，核心步骤如下：</p>
<h5 data-id="heading-8">步骤 1：生成基础 Mock 数据</h5>
<p>首先用<code>Mock.mock</code>生成 45 条模拟文章数据，包含标题、简介、点赞数、用户信息、标签等字段：</p>
<pre><code class="hljs language-php" lang="php">import Mock <span class="hljs-keyword">from</span> <span class="hljs-string">"mockjs"</span> 
<span class="hljs-comment">// 定义标签池 </span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">tags</span> = [<span class="hljs-string">"前端"</span>,<span class="hljs-string">"后端"</span>,<span class="hljs-string">"职场"</span>,<span class="hljs-string">"AI"</span>,<span class="hljs-string">"副业"</span>,<span class="hljs-string">"面经"</span>,<span class="hljs-string">"算法"</span>]; 
<span class="hljs-comment">// 生成45条模拟文章数据 </span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">posts</span> = Mock.<span class="hljs-title function_ invoke__">mock</span>({ 
    <span class="hljs-string">'list|45'</span>:[ // 生成<span class="hljs-number">45</span>条数据（|<span class="hljs-number">45</span>表示数量） 
        { 
            <span class="hljs-attr">title</span>:<span class="hljs-string">'@ctitle(8,20)'</span>, // 随机中文标题（<span class="hljs-number">8</span>-<span class="hljs-number">20</span>字） 
            <span class="hljs-attr">brief</span>:<span class="hljs-string">'@ctitle(20,100)'</span>, // 简介 
            <span class="hljs-attr">totalComments</span>:<span class="hljs-string">'@integer(1,30)'</span>, // 评论数 
            <span class="hljs-attr">totalLikes</span>:<span class="hljs-string">'@integer(0,500)'</span>, // 点赞数 
            <span class="hljs-attr">publishedAt</span>:<span class="hljs-string">'datetime("yyyy-MM-dd HH:mm")'</span>, // 发布时间 
            <span class="hljs-attr">user</span>:{ // 用户信息 
                <span class="hljs-attr">id</span>:<span class="hljs-string">"@integer(1,100)"</span>, 
                <span class="hljs-attr">name</span>:<span class="hljs-string">'@cname(2,3)'</span>, 
                <span class="hljs-attr">avatar</span>:<span class="hljs-string">'@image(300*200)'</span> }, 
            <span class="hljs-attr">tags</span>:() =&gt; Mock.Random.<span class="hljs-title function_ invoke__">pick</span>(tags,<span class="hljs-number">2</span>), <span class="hljs-comment">// 随机2个标签 </span>
            thumbnail:<span class="hljs-string">'@image(300*200)'</span>, <span class="hljs-comment">// 缩略图 </span>
            pics:[<span class="hljs-string">'@image(300*200)'</span>,<span class="hljs-string">'@image(300*200)'</span>,<span class="hljs-string">'@image(300*200)'</span>], <span class="hljs-comment">// 图片组 </span>
            id:<span class="hljs-string">'@increment(1)'</span> <span class="hljs-comment">// 自增ID </span>
         } 
     ] 
}).<span class="hljs-keyword">list</span>;
</code></pre>
<h5 data-id="heading-9">步骤 2：定义 Mock 接口并实现分页</h5>
<p>接口文档要求<code>GET /api/posts?page=1&amp;limit=10</code>返回分页数据，需解析分页参数、切割数据并返回分页信息：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
    {
        url:<span class="hljs-string">'/api/posts'</span>, <span class="hljs-comment">// 匹配接口地址</span>
        method:<span class="hljs-string">'get'</span>, <span class="hljs-comment">// 匹配请求方法</span>
        response:({ query },res) =&gt; {
            <span class="hljs-comment">// 1. 解析分页参数（默认page=1，limit=10）</span>
            <span class="hljs-type">const</span> { page = <span class="hljs-string">'1'</span>,limit = <span class="hljs-string">'10'</span> } = query;
            <span class="hljs-type">const</span> currentPage = <span class="hljs-built_in">parseInt</span>(page,<span class="hljs-number">10</span>);
            <span class="hljs-type">const</span> size = <span class="hljs-built_in">parseInt</span>(limit,<span class="hljs-number">10</span>);

            <span class="hljs-comment">// 2. 校验参数合法性</span>
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(currentPage) || <span class="hljs-built_in">isNaN</span>(size) || currentPage &lt; <span class="hljs-number">1</span> || size &lt; <span class="hljs-number">1</span>){
                <span class="hljs-keyword">return</span> {
                    code: <span class="hljs-number">400</span>,
                    msg:<span class="hljs-string">"Invalid page or pageSize"</span>,
                    data: null
                }
            }

            <span class="hljs-comment">// 3. 计算分页数据：总条数、起始/结束索引</span>
            <span class="hljs-type">const</span> total = posts.length; <span class="hljs-comment">// 数据总条数</span>
            <span class="hljs-type">const</span> start = (currentPage - <span class="hljs-number">1</span>) * size; <span class="hljs-comment">// 数据起始位置</span>
            <span class="hljs-type">const</span> end = start + size; <span class="hljs-comment">// 数据结束位置</span>
            <span class="hljs-type">const</span> pagenatedData = posts.<span class="hljs-built_in">slice</span>(start,end); <span class="hljs-comment">// 切割分页数据</span>

            <span class="hljs-comment">// 4. 返回分页结果</span>
            <span class="hljs-keyword">return</span> {
                code:<span class="hljs-number">200</span>,
                msg:<span class="hljs-string">'success'</span>,
                items:pagenatedData, <span class="hljs-comment">// 当前页数据列表</span>
                pagination:{ <span class="hljs-comment">// 分页信息</span>
                    current:currentPage, <span class="hljs-comment">// 当前页码</span>
                    limit:size, <span class="hljs-comment">// 每页条数</span>
                    total, <span class="hljs-comment">// 总条数</span>
                    totalPage:Math.<span class="hljs-built_in">ceil</span>(total/size) <span class="hljs-comment">// 总页数</span>
                }
            }
        }
    }
]
</code></pre>
<h4 data-id="heading-10">分页核心逻辑解析</h4>
<p>分页是列表接口的必备能力，Mock 中实现分页的核心步骤：</p>
<ol>
<li><strong>参数解析</strong>：从请求参数中获取<code>page</code>（当前页）和<code>limit</code>（每页条数），转为整数并校验合法性；</li>
<li><strong>数据切割</strong>：通过<code>(currentPage - 1) * size</code>计算起始索引，<code>start + size</code>计算结束索引，用<code>slice(start, end)</code>切割总数据得到当前页数据；</li>
<li><strong>分页信息返回</strong>：需返回<code>当前页、每页条数、总条数、总页数</code>，方便前端渲染分页组件。</li>
</ol>
<h3 data-id="heading-11">四、MockJS 的核心意义</h3>
<ol>
<li><strong>提升开发效率</strong>：前后端并行开发，前端无需依赖后端接口进度，独立完成页面开发与调试；</li>
<li><strong>降低联调成本</strong>：基于接口文档 Mock 数据，确保前端数据格式与后端完全一致，联调时只需切换接口地址即可无缝对接；</li>
<li><strong>灵活模拟场景</strong>：可自由调整 Mock 数据量（如本文 45 条）、分页参数，模拟 “第一页”“最后一页”“无数据” 等边界场景；</li>
<li><strong>解耦开发流程</strong>：前端专注页面逻辑，后端专注接口开发，符合前后端分离的核心思想。</li>
</ol>
<h3 data-id="heading-12">五、上线切换真实接口</h3>
<p>Mock 仅用于开发阶段，上线前只需：</p>
<ol>
<li>关闭 Vite 的 Mock 插件（<code>prodEnabled: false</code>）；</li>
<li>将 axios 的请求基础地址从 Mock 地址切换为后端真实接口地址；</li>
<li>无需修改业务代码，即可无缝对接真实后端数据。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[async/await和Promise有哪些区别]]></title>    <link>https://juejin.cn/post/7597623654056787983</link>    <guid>https://juejin.cn/post/7597623654056787983</guid>    <pubDate>2026-01-21T15:44:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056787983" data-draft-id="7597664587458920483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="async/await和Promise有哪些区别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T15:44:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            async/await和Promise有哪些区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:44:38.000Z" title="Wed Jan 21 2026 15:44:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>async/await</code> 和 <code>Promise</code> 都是处理异步操作的方式，但它们在语法和使用上有重要区别：</p>
<h2 data-id="heading-0">1. <strong>本质关系</strong></h2>
<ul>
<li><strong>Promise</strong>：是异步编程的解决方案对象，代表一个异步操作的最终完成（或失败）及其结果值</li>
<li><strong>async/await</strong>：是基于 Promise 的语法糖，让异步代码看起来像同步代码</li>
</ul>
<h2 data-id="heading-1">2. <strong>语法对比</strong></h2>
<h3 data-id="heading-2">Promise 写法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
            <span class="hljs-keyword">return</span> data;
        })
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
        });
}
</code></pre>
<h3 data-id="heading-3">async/await 写法</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>);
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
        <span class="hljs-keyword">return</span> data;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
} 
</code></pre>
<h2 data-id="heading-4">3. <strong>主要区别</strong></h2>



































<table><thead><tr><th>特性</th><th>Promise</th><th>async/await</th></tr></thead><tbody><tr><td><strong>代码结构</strong></td><td>链式调用（.then().catch()）</td><td>类似同步代码的线性结构</td></tr><tr><td><strong>错误处理</strong></td><td>使用 <code>.catch()</code> 或第二个参数</td><td>使用 try/catch 块</td></tr><tr><td><strong>可读性</strong></td><td>回调嵌套可能较深（回调地狱）</td><td>更清晰，易于理解流程</td></tr><tr><td><strong>调试</strong></td><td>断点跳转可能不直观</td><td>可以像同步代码一样调试</td></tr><tr><td><strong>变量作用域</strong></td><td>每个 <code>.then()</code> 都是新作用域</td><td>整个 async 函数共享作用域</td></tr></tbody></table>
<h2 data-id="heading-5">4. <strong>关键特点</strong></h2>
<h3 data-id="heading-6">Promise 特点：</h3>
<ul>
<li>三种状态：pending、fulfilled、rejected</li>
<li>状态一旦改变不可逆转</li>
<li>可以并行处理多个异步操作（<code>Promise.all</code>、<code>Promise.race</code>）</li>
<li>可以提前创建但不立即执行</li>
</ul>
<h3 data-id="heading-7">async/await 特点：</h3>
<ul>
<li><code>async</code> 函数总是返回一个 Promise</li>
<li><code>await</code> 只能在 <code>async</code> 函数中使用</li>
<li><code>await</code> 会暂停当前 async 函数的执行，直到 Promise 解决</li>
<li>代码自上而下顺序执行，逻辑更清晰</li>
</ul>
<h2 data-id="heading-8">5. <strong>错误处理差异</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Promise 错误处理</span>
promise
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> { <span class="hljs-comment">/* 处理结果 */</span> })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> { <span class="hljs-comment">/* 处理错误 */</span> });

<span class="hljs-comment">// async/await 错误处理</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">example</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> promise;
        <span class="hljs-comment">// 处理结果</span>
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 处理错误</span>
    }
}
</code></pre>
<h2 data-id="heading-9">6. <strong>性能考虑</strong></h2>
<ul>
<li>async/await 本质上会被转换为 Promise 链</li>
<li>现代 JavaScript 引擎对两者优化都很好</li>
<li>async/await 在某些场景下可能产生微小的额外开销（生成器转换）</li>
</ul>
<h2 data-id="heading-10">7. <strong>使用建议</strong></h2>
<h3 data-id="heading-11">适合 Promise 的场景：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 并行执行多个异步操作</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([task1, task2, task3])
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
        <span class="hljs-comment">// 同时处理所有结果</span>
    });

<span class="hljs-comment">// 竞速场景</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([fetch1, fetch2])
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">firstResult</span> =&gt;</span> {
        <span class="hljs-comment">// 使用最先返回的结果</span>
    });
</code></pre>
<h3 data-id="heading-12">适合 async/await 的场景：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 有依赖关系的异步操作序列</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">orderId</span>) {
    <span class="hljs-keyword">const</span> order = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getOrder</span>(orderId);
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>(order.<span class="hljs-property">userId</span>);
    <span class="hljs-keyword">const</span> payment = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayment</span>(order.<span class="hljs-property">paymentId</span>);
    <span class="hljs-comment">// 清晰的顺序执行逻辑</span>
    <span class="hljs-keyword">return</span> { order, user, payment };
}
</code></pre>
<h2 data-id="heading-13">8. <strong>互相转换</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// async/await 转换为 Promise 链</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task1</span>();
    <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task2</span>(a);
    <span class="hljs-keyword">return</span> b;
}
<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">promiseExample</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">task1</span>()
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> <span class="hljs-title function_">task2</span>(a));
}

<span class="hljs-comment">// Promise 链转换为 async/await</span>
promise
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">process</span>(value))
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result));
<span class="hljs-comment">// 转换为</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePromise</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> value = <span class="hljs-keyword">await</span> promise;
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">process</span>(value);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
}
</code></pre>
<h2 data-id="heading-14">总结</h2>
<ul>
<li><strong>Promise 是基础</strong>，async/await 是建立在 Promise 之上的语法糖</li>
<li><strong>async/await 让代码更易读</strong>，特别适合处理有顺序依赖的异步操作</li>
<li><strong>Promise 更适合并行处理</strong>多个独立的异步任务</li>
<li>两者可以混合使用，根据具体场景选择最合适的方式</li>
</ul>
<p>实际开发中，通常会结合使用两种方式，利用各自的优势来编写更清晰、高效的异步代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[先免费试用下Claude code安装使用（教程）]]></title>    <link>https://juejin.cn/post/7597695531217354802</link>    <guid>https://juejin.cn/post/7597695531217354802</guid>    <pubDate>2026-01-21T15:53:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597695531217354802" data-draft-id="7597434154796761114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="先免费试用下Claude code安装使用（教程）"/> <meta itemprop="keywords" content="前端,Claude"/> <meta itemprop="datePublished" content="2026-01-21T15:53:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈罗哈皮"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009631447"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            先免费试用下Claude code安装使用（教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009631447/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈罗哈皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:53:10.000Z" title="Wed Jan 21 2026 15:53:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2026年了，如果还不会使用一款AI编程工具，未来将会越来越难行。
今天我们先来使用一个终端编程比较火的工具：Claude code</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3037ea57903486187786fe167b4aa66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=6hMejacmZlMexSmDJ83sBpV%2F%2FSQ%3D" alt="c30b1a20-ce33-42d5-ae63-f44b24450158.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、安装</h2>
<h3 data-id="heading-1">1、nodejs安装</h3>
<ul>
<li>如果你本地没有node环境，是需要先安装node的，node版本至少要18.0以上，可点击下面地址跳转到nodejs官网下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fdownload" target="_blank" title="https://nodejs.org/zh-cn/download" ref="nofollow noopener noreferrer">下载Node.js</a>，对于老程序员来说肯定都喜欢nvm安装node可随时切换<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnvm-sh%2Fnvm" target="_blank" title="https://github.com/nvm-sh/nvm" ref="nofollow noopener noreferrer">nvm下载</a></li>
</ul>
<h3 data-id="heading-2">2、Claude Code</h3>
<ul>
<li>安装Claude Code及指向镜像</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">npm install -g https://gaccode.com/claudecode/install --registry=https://registry.npmmirror.com 
</code></pre>
<ul>
<li>如果之前安装没有指向镜像，可以先卸载Claude Code</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">npm uninstall -g @anthropic-ai/claude-code
</code></pre>
<p>查看是否安装成功
<code>claude -v</code>
输出的内容如下，代表安装成功了：</p>
<pre><code class="hljs language-css" lang="css">🌟 Welcome <span class="hljs-selector-tag">to</span> Claude <span class="hljs-selector-tag">Code</span>!
🔗 You are using the canonical relay
💡 ANTHROPIC_API_KEY discovered, skipping OAuth
<span class="hljs-number">2.1</span>.<span class="hljs-number">6</span> (Claude <span class="hljs-selector-tag">Code</span>)
</code></pre>
<h3 data-id="heading-3">3、配置阿里云百炼的通义千问系列</h3>
<ul>
<li>使用阿里云大模型是因为现在注册可以送百万token，可以免费测试下效果如何，如果感觉不错以后可以购买；申请key 阿里云百炼地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2Fcn-beijing%2F%3Ftab%3Dhome%23%2Fhome" target="_blank" title="https://bailian.console.aliyun.com/cn-beijing/?tab=home#/home" ref="nofollow noopener noreferrer">bailian.console.aliyun.com</a></li>
<li>在 PowerShell 中运行以下命令，设置环境变量</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 用百炼 API Key 替换 YOUR_DASHSCOPE_API_KEY</span>
[<span class="hljs-title class_">Environment</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_API_KEY"</span>, <span class="hljs-string">"YOUR_DASHSCOPE_API_KEY"</span>, [<span class="hljs-title class_">EnvironmentVariableTarget</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:User</span>)
[<span class="hljs-title class_">Environment</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:SetEnvironmentVariable</span>(<span class="hljs-string">"ANTHROPIC_BASE_URL"</span>, <span class="hljs-string">"https://dashscope.aliyuncs.com/apps/anthropic"</span>, [<span class="hljs-title class_">EnvironmentVariableTarget</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:User</span>)
</code></pre>
<ul>
<li>打开一个新的 PowerShell 窗口，运行以下命令，检查环境变量是否生效。</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$env</span>:ANTHROPIC_API_KEY
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$env</span>:ANTHROPIC_BASE_URL
</code></pre>
<ul>
<li>在安装Claude Code根目录.claude创建一个<code>settings.json</code>文件，配置后claude code才能显示自定义的大模型可选</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen3-coder-plus"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_SMALL_FAST_MODEL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen-flash"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"qwen3-coder-plus"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">4、启动Claude Code</h3>
<ul>
<li>在终端中输入Claude 按在enter</li>
</ul>

<pre><code class="hljs">claude 
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/914e0ab50ef54278b04bf0b7bd9add41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=cnAJFHsr5oLvWA1RLx3dKLrv7WU%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>然后会自动打开一个新的终端，里面有欢迎语</li>
<li>然后在对话框中输入<code>/model</code>按在enter</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">/model
</code></pre>
<ul>
<li>然后选择你刚刚配置的阿里云大模型即可
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6629679e86cd4f35b2ab35bb9bcd243b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=gmAuWBMR26r8IffKXPw2k%2BJ7zVU%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h2 data-id="heading-5">小结</h2>
<ul>
<li>根据上面的操作配置完成后，你就拥有了3个月免费的Claude Code工具使用。</li>
</ul>
<h2 data-id="heading-6">其他</h2>
<h4 data-id="heading-7">1、如果想使用其他大模型，可以根据官网介绍安装</h4>
<ul>
<li>阿里云百炼教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.alibabacloud.com%2Fhelp%2Fzh%2Fmodel-studio%2Fclaude-code" target="_blank" title="https://www.alibabacloud.com/help/zh/model-studio/claude-code" ref="nofollow noopener noreferrer">www.alibabacloud.com/help/zh/mod…</a></li>
<li>智谱开放平台教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.bigmodel.cn%2Fcn%2Fcoding-plan%2Ftool%2Fclaude" target="_blank" title="https://docs.bigmodel.cn/cn/coding-plan/tool/claude" ref="nofollow noopener noreferrer">docs.bigmodel.cn/cn/coding-p…</a></li>
<li>火山方舟（Ark）教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F82379%2F1928262%3Flang%3Dzh" target="_blank" title="https://www.volcengine.com/docs/82379/1928262?lang=zh" ref="nofollow noopener noreferrer">www.volcengine.com/docs/82379/…</a></li>
<li>无问芯穹（GenStudio）教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.infini-ai.com%2Fposts%2Fuse-claude-code.html" target="_blank" title="https://docs.infini-ai.com/posts/use-claude-code.html" ref="nofollow noopener noreferrer">docs.infini-ai.com/posts/use-c…</a></li>
<li>DeepSeek教程-<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2Fguides%2Fanthropic_api" target="_blank" title="https://api-docs.deepseek.com/zh-cn/guides/anthropic_api" ref="nofollow noopener noreferrer">api-docs.deepseek.com/zh-cn/guide…</a></li>
</ul>
<h4 data-id="heading-8">2、我目前使用的是阿里百炼里面的大模型</h4>
<ul>
<li>问我为什么选择他，我只能回答因为现在注册有百万token，有效期3个月，先试试这个工具怎样先；</li>
</ul>
<h2 data-id="heading-9">使用效果</h2>
<ul>
<li>1、我截了一个百度首页给AI大模型，叫他写一个一模一样的网页，你猜他会怎样？
直接给我幻觉输出，完成不是按照截图的来输出。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e06fe85c97a4fbcbf7df5e18cac7301~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=i6M9dLxBwQ6Awqq9Y5fAVsWWKgU%3D" alt="8853088f-af82-458c-b97d-6b3fc310c6aa.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d22b14d3f5d4cbd96eafbf906504f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=gO%2FThQjCq5eW7E3VPYT1GMohKlU%3D" alt="image.png" loading="lazy"/>
最后的页面是这样的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c65d133956564cea90a834b3cc37ded2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=xgkrhZICbKcxPVmGLSbQRtfqtMM%3D" alt="711fa965-5bc7-446f-85d7-4528888ca653.png" loading="lazy"/></p>
<ul>
<li>可能是大模型不够好吧，网页输出还行，是一个标准的‘官网’，只是 不是我想要的官网。</li>
<li>就这么操作一次消耗了我41%的token
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d334987744a84145b5f473bba8b6f921~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=2O3BSFwp7NeauPNR12VzUkp%2FMtg%3D" alt="image.png" loading="lazy"/>
还好他有很多模型，还能切换
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66473385301543829f569dfc2fb5fdca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOI572X5ZOI55qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769615590&amp;x-signature=7IxlmB%2BYUw7c7WoSVw1hRxvEyg8%3D" alt="image.png" loading="lazy"/></li>
<li>这里右边的‘免费额度用完即停’建议开启吧，问过客服说如果不开启，可能用完超过10元才会有提醒。</li>
</ul>
<h2 data-id="heading-10">使用感受</h2>
<ul>
<li>只是初步搭建，还没深度使用他的MCP相关流程，这里就不评论他的好坏了，我只简单说说这次搭建使用过程的感受；</li>
<li>a、搭建速度很快，不依赖exe安装包，只要打开终端就能安装使用，感觉很隐蔽也很高级的感觉，这种开发模式比较符合开发者使用；</li>
<li>b、没有代码直接编辑，只用自然语言输出修改需求，感觉最后出现的效果全靠大模型了，还有看你提示词的精准度及大模型的能力程度；</li>
</ul>
<h2 data-id="heading-11">基础指令</h2>























































<table><thead><tr><th>命令</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><code>claude</code></td><td>启动交互模式</td><td><code>claude</code></td></tr><tr><td><code>claude "task"</code></td><td>运行一次性任务</td><td><code>claude "fix the build error"</code></td></tr><tr><td><code>claude -p "query"</code></td><td>运行一次性查询，然后退出</td><td><code>claude -p "explain this function"</code></td></tr><tr><td><code>claude -c</code></td><td>在当前目录中继续最近的对话</td><td><code>claude -c</code></td></tr><tr><td><code>claude -r</code></td><td>恢复之前的对话</td><td><code>claude -r</code></td></tr><tr><td><code>claude commit</code></td><td>创建 Git 提交</td><td><code>claude commit</code></td></tr><tr><td><code>/clear</code></td><td>清除对话历史</td><td><code>&gt; /clear</code></td></tr><tr><td><code>/help</code></td><td>显示可用命令</td><td><code>&gt; /help</code></td></tr><tr><td><code>exit</code> 或 Ctrl+C</td><td>退出 Claude Code</td><td><code>&gt; exit</code></td></tr></tbody></table>
<h2 data-id="heading-12">展望</h2>
<p>*本期先写到这里，下期我将会结合流行的MCP配置使用。</p>
<ul>
<li>需要访问Claude Code官网的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Foverview" target="_blank" title="https://code.claude.com/docs/zh-CN/overview" ref="nofollow noopener noreferrer">code.claude.com/docs/zh-CN/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15存储子系统深度解析(一):Vold与存储管理框架]]></title>    <link>https://juejin.cn/post/7597640434399592499</link>    <guid>https://juejin.cn/post/7597640434399592499</guid>    <pubDate>2026-01-21T11:37:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597640434399592499" data-draft-id="7597623395907747886" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15存储子系统深度解析(一):Vold与存储管理框架"/> <meta itemprop="keywords" content="Android,操作系统,源码阅读"/> <meta itemprop="datePublished" content="2026-01-21T11:37:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15存储子系统深度解析(一):Vold与存储管理框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:37:19.000Z" title="Wed Jan 21 2026 11:37:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>Android系统中的存储管理是一个复杂而精密的子系统。从SD卡的热插拔检测,到内部存储的分区挂载,再到OBB扩展文件的管理,这一切的核心都离不开一个关键的守护进程——<strong>Vold</strong>(Volume Daemon)。</p>
<p>作为Android存储架构的"大脑",Vold负责:</p>
<ul>
<li>🔌 <strong>设备检测</strong>: 实时监听内核Uevent,发现新插入的存储设备</li>
<li>📦 <strong>Volume管理</strong>: 抽象和管理各类存储卷(公共存储、可采用存储、模拟存储)</li>
<li>🔐 <strong>加密支持</strong>: 处理文件级加密(FBE)和磁盘加密</li>
<li>🌉 <strong>跨进程通信</strong>: 通过Binder向Framework层提供存储服务</li>
</ul>
<p>本文将基于<strong>Android 15 (AOSP 15.0)</strong> 的源码,深入剖析Vold的架构设计、启动流程、核心组件以及与StorageManagerService的交互机制。</p>
<blockquote>
<p>💡 <strong>源码路径</strong>: 本文分析的Vold源码位于 <code>system/vold/</code>,StorageManagerService位于 <code>frameworks/base/services/core/java/com/android/server/StorageManagerService.java</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、Vold架构总览</h2>
<h3 data-id="heading-2">1.1 Vold在Android存储架构中的位置</h3>
<p>在Android存储架构中,Vold扮演着"承上启下"的关键角色:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e72a31784d34427ca2d81ee86383e590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=ohnajz50K4XNyjJa215VF5aTIB4%3D" alt="04-01-vold-architecture-overview.png" loading="lazy"/></p>
<p>如上图所示,Vold的架构可以分为五个层次:</p>
<h4 data-id="heading-3"><strong>Framework层 (Java)</strong></h4>
<ul>
<li><strong>StorageManagerService</strong>: 系统服务,提供存储管理的Java API</li>
<li><strong>IStorageManager</strong>: AIDL接口,定义Framework层的存储服务接口</li>
</ul>
<h4 data-id="heading-4"><strong>Native Binder层 (C++)</strong></h4>
<ul>
<li><strong>VoldNativeService</strong>: 实现IVold接口的Binder服务,是Vold对外提供服务的入口</li>
<li><strong>IVold</strong>: AIDL接口,定义了从Framework到Native的跨进程调用接口</li>
<li><strong>IVoldListener</strong>: AIDL接口,用于Vold向Framework发送事件回调</li>
</ul>
<h4 data-id="heading-5"><strong>Vold核心层 (C++)</strong></h4>
<ul>
<li><strong>VolumeManager</strong>: Vold的核心管理器(单例),管理所有Disk和Volume对象</li>
<li><strong>NetlinkManager</strong>: 负责监听内核的Netlink Uevent事件</li>
<li><strong>NetlinkHandler</strong>: 处理Netlink事件,将设备插拔事件转换为Volume操作</li>
</ul>
<h4 data-id="heading-6"><strong>存储模型层 (C++)</strong></h4>
<ul>
<li><strong>Disk</strong>: 物理磁盘的抽象(SD卡、USB存储)</li>
<li><strong>VolumeBase</strong>: Volume的基类,提供通用的挂载/卸载接口
<ul>
<li><strong>PublicVolume</strong>: 公共存储卷(FAT32/exFAT格式)</li>
<li><strong>PrivateVolume</strong>: 可采用存储(Adoptable Storage,ext4加密)</li>
<li><strong>EmulatedVolume</strong>: 模拟存储卷(/storage/emulated)</li>
<li><strong>ObbVolume</strong>: OBB扩展文件卷</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7"><strong>底层支持</strong></h4>
<ul>
<li><strong>Kernel Netlink</strong>: 内核Uevent机制,用于设备热插拔事件通知</li>
<li><strong>/dev/block</strong>: 块设备节点</li>
<li><strong>fstab</strong>: 文件系统表配置</li>
</ul>
<h3 data-id="heading-8">1.2 核心设计模式</h3>
<p>Vold的设计体现了多个经典的设计模式:</p>
<p><strong>1. 单例模式 (Singleton)</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VolumeManager.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeManager</span> {
    <span class="hljs-type">static</span> VolumeManager* sInstance;
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">static</span> VolumeManager* <span class="hljs-title">Instance</span><span class="hljs-params">()</span></span>;
};
</code></pre>
<p>VolumeManager和NetlinkManager都采用单例模式,确保全局只有一个管理器实例。</p>
<p><strong>2. 观察者模式 (Observer)</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VoldNativeService</span> : <span class="hljs-keyword">public</span> BinderService&lt;VoldNativeService&gt;, <span class="hljs-keyword">public</span> os::BnVold {
    <span class="hljs-function">binder::Status <span class="hljs-title">setListener</span><span class="hljs-params">(<span class="hljs-type">const</span> android::sp&lt;android::os::IVoldListener&gt;&amp; listener)</span></span>;
};
</code></pre>
<p>通过IVoldListener接口,StorageManagerService可以订阅Vold的事件通知。</p>
<p><strong>3. 继承多态 (Inheritance)</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/VolumeBase.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeBase</span> {
<span class="hljs-keyword">protected</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doMount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doUnmount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PublicVolume</span> : <span class="hljs-keyword">public</span> VolumeBase { ... };
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateVolume</span> : <span class="hljs-keyword">public</span> VolumeBase { ... };
</code></pre>
<p>各种Volume类型继承自VolumeBase,实现特定的挂载逻辑。</p>
<hr/>
<h2 data-id="heading-9">二、Vold启动流程详解</h2>
<h3 data-id="heading-10">2.1 Init进程启动Vold</h3>
<p>Vold作为一个Native守护进程,由init进程根据<code>init.rc</code>配置文件启动:</p>
<pre><code class="hljs language-rc" lang="rc"># system/core/rootdir/init.rc
service vold /system/bin/vold \
    --blkid_context=u:r:blkid:s0 \
    --blkid_untrusted_context=u:r:blkid_untrusted:s0 \
    --fsck_context=u:r:fsck:s0 \
    --fsck_untrusted_context=u:r:fsck_untrusted:s0
    class core
    ioprio be 2
    writepid /dev/cpuset/foreground/tasks
    shutdown critical
</code></pre>
<p>配置解析:</p>
<ul>
<li><code>class core</code>: Vold属于核心服务,在early-boot阶段启动</li>
<li><code>--*_context</code>: 指定SELinux上下文,用于blkid和fsck工具的安全隔离</li>
<li><code>ioprio be 2</code>: 设置I/O优先级为Best Effort,优先级2</li>
<li><code>shutdown critical</code>: Vold崩溃会导致系统重启</li>
</ul>
<h3 data-id="heading-11">2.2 main()函数:初始化流程</h3>
<p>让我们深入到<code>system/vold/main.cpp</code>的启动代码:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>{
    <span class="hljs-comment">// 1. 初始化日志系统</span>
    <span class="hljs-built_in">setenv</span>(<span class="hljs-string">"ANDROID_LOG_TAGS"</span>, <span class="hljs-string">"*:d"</span>, <span class="hljs-number">1</span>);
    android::base::<span class="hljs-built_in">InitLogging</span>(argv, &amp;VoldLogger);
    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">"Vold 3.0 (the awakening) firing up"</span>;

    <span class="hljs-comment">// 2. 检测文件系统支持</span>
    <span class="hljs-built_in">LOG</span>(DEBUG) &lt;&lt; <span class="hljs-string">"Detected support for:"</span>
               &lt;&lt; (android::vold::<span class="hljs-built_in">IsFilesystemSupported</span>(<span class="hljs-string">"ext4"</span>) ? <span class="hljs-string">" ext4"</span> : <span class="hljs-string">""</span>)
               &lt;&lt; (android::vold::<span class="hljs-built_in">IsFilesystemSupported</span>(<span class="hljs-string">"f2fs"</span>) ? <span class="hljs-string">" f2fs"</span> : <span class="hljs-string">""</span>)
               &lt;&lt; (android::vold::<span class="hljs-built_in">IsFilesystemSupported</span>(<span class="hljs-string">"vfat"</span>) ? <span class="hljs-string">" vfat"</span> : <span class="hljs-string">""</span>);

    <span class="hljs-comment">// 3. 初始化SELinux</span>
    sehandle = <span class="hljs-built_in">selinux_android_file_context_handle</span>();
    <span class="hljs-keyword">if</span> (!sehandle) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to get SELinux file contexts handle"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    <span class="hljs-built_in">selinux_android_set_sehandle</span>(sehandle);

    <span class="hljs-comment">// 4. 创建必要的目录</span>
    <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">"/dev/block/vold"</span>, <span class="hljs-number">0755</span>);

    <span class="hljs-comment">// 5. 创建核心组件单例</span>
    VolumeManager* vm = VolumeManager::<span class="hljs-built_in">Instance</span>();
    NetlinkManager* nm = NetlinkManager::<span class="hljs-built_in">Instance</span>();

    <span class="hljs-comment">// 6. 启动VolumeManager</span>
    <span class="hljs-keyword">if</span> (vm-&gt;<span class="hljs-built_in">start</span>()) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start VolumeManager"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 7. 处理fstab配置</span>
    VoldConfigs configs = {};
    <span class="hljs-built_in">process_config</span>(vm, &amp;configs);

    <span class="hljs-comment">// 8. 启动Binder服务</span>
    android::hardware::<span class="hljs-built_in">configureRpcThreadpool</span>(<span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (android::vold::VoldNativeService::<span class="hljs-built_in">start</span>() != android::OK) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start VoldNativeService"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 9. 启动NetlinkManager</span>
    <span class="hljs-keyword">if</span> (nm-&gt;<span class="hljs-built_in">start</span>()) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start NetlinkManager"</span>;
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 10. 设置系统属性</span>
    android::base::<span class="hljs-built_in">SetProperty</span>(<span class="hljs-string">"vold.has_adoptable"</span>, configs.has_adoptable ? <span class="hljs-string">"1"</span> : <span class="hljs-string">"0"</span>);
    android::base::<span class="hljs-built_in">SetProperty</span>(<span class="hljs-string">"vold.has_quota"</span>, configs.has_quota ? <span class="hljs-string">"1"</span> : <span class="hljs-string">"0"</span>);

    <span class="hljs-comment">// 11. Coldboot扫描已连接设备</span>
    <span class="hljs-built_in">coldboot</span>(<span class="hljs-string">"/sys/block"</span>);

    <span class="hljs-comment">// 12. 进入主循环</span>
    android::IPCThreadState::<span class="hljs-built_in">self</span>()-&gt;<span class="hljs-built_in">joinThreadPool</span>();
    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">"vold shutting down"</span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9176e2292914478998c263d3363a248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=hlVmqlRfk2i3ucASey%2FpC5RJIks%3D" alt="04-02-vold-startup-sequence.png" loading="lazy"/></p>
<h3 data-id="heading-12">2.3 关键步骤详解</h3>
<h4 data-id="heading-13"><strong>步骤1-2: 日志和文件系统检测</strong></h4>
<ul>
<li><code>VoldLogger</code>: 自定义日志处理器,early-boot阶段的错误会同时输出到kernel log</li>
<li><code>IsFilesystemSupported()</code>: 检查内核是否支持ext4/f2fs/vfat文件系统</li>
</ul>
<h4 data-id="heading-14"><strong>步骤3: SELinux初始化</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp">sehandle = <span class="hljs-built_in">selinux_android_file_context_handle</span>();
</code></pre>
<p>获取SELinux文件上下文句柄,用于后续创建文件时设置正确的安全上下文。</p>
<h4 data-id="heading-15"><strong>步骤5: 单例创建</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp">VolumeManager* vm = VolumeManager::<span class="hljs-built_in">Instance</span>();
</code></pre>
<p>VolumeManager采用懒加载单例模式:</p>
<pre><code class="hljs language-cpp" lang="cpp">VolumeManager* VolumeManager::sInstance = <span class="hljs-literal">nullptr</span>;

<span class="hljs-function">VolumeManager* <span class="hljs-title">VolumeManager::Instance</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (!sInstance) {
        sInstance = <span class="hljs-keyword">new</span> <span class="hljs-built_in">VolumeManager</span>();
    }
    <span class="hljs-keyword">return</span> sInstance;
}
</code></pre>
<h4 data-id="heading-16"><strong>步骤7: 处理fstab配置</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">process_config</span><span class="hljs-params">(VolumeManager* vm, VoldConfigs* configs)</span> </span>{
    <span class="hljs-comment">// 读取fstab</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ReadDefaultFstab</span>(&amp;fstab_default)) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to open default fstab"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 遍历fstab条目</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; entry : fstab_default) {
        <span class="hljs-comment">// 检查是否支持quota/reserved/compress</span>
        <span class="hljs-keyword">if</span> (entry.fs_mgr_flags.quota) configs-&gt;has_quota = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (entry.reserved_size &gt; <span class="hljs-number">0</span>) configs-&gt;has_reserved = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (entry.fs_mgr_flags.fs_compress) configs-&gt;has_compress = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 处理vold_managed标记的分区</span>
        <span class="hljs-keyword">if</span> (entry.fs_mgr_flags.vold_managed) {
            <span class="hljs-function">std::string <span class="hljs-title">sysPattern</span><span class="hljs-params">(entry.blk_device)</span></span>;
            <span class="hljs-function">std::string <span class="hljs-title">nickname</span><span class="hljs-params">(entry.label)</span></span>;
            <span class="hljs-type">int</span> flags = <span class="hljs-number">0</span>;

            <span class="hljs-comment">// 可采用存储标记</span>
            <span class="hljs-keyword">if</span> (entry.<span class="hljs-built_in">is_encryptable</span>()) {
                flags |= android::vold::Disk::Flags::kAdoptable;
                configs-&gt;has_adoptable = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-comment">// 添加到VolumeManager</span>
            vm-&gt;<span class="hljs-built_in">addDiskSource</span>(std::<span class="hljs-built_in">shared_ptr</span>&lt;VolumeManager::DiskSource&gt;(
                <span class="hljs-keyword">new</span> VolumeManager::<span class="hljs-built_in">DiskSource</span>(sysPattern, nickname, flags)));
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>fstab示例</strong>:</p>
<pre><code class="hljs language-arduino" lang="arduino"># 可采用的<span class="hljs-built_in">SD</span>卡
/devices/platform/soc/<span class="hljs-number">7864900.</span>sdhci/mmc_host/mmc*  <span class="hljs-keyword">auto</span>  <span class="hljs-keyword">auto</span>  defaults  vold_managed=sdcard1:<span class="hljs-keyword">auto</span>,encryptable=userdata
</code></pre>
<h4 data-id="heading-17"><strong>步骤11: Coldboot扫描</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">coldboot</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* path)</span> </span>{
    DIR* d = <span class="hljs-built_in">opendir</span>(path);
    <span class="hljs-keyword">if</span> (d) {
        <span class="hljs-built_in">do_coldboot</span>(d, <span class="hljs-number">0</span>);
        <span class="hljs-built_in">closedir</span>(d);
    }
}

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">do_coldboot</span><span class="hljs-params">(DIR* d, <span class="hljs-type">int</span> lvl)</span> </span>{
    <span class="hljs-comment">// 遍历/sys/block目录</span>
    <span class="hljs-keyword">while</span> ((de = <span class="hljs-built_in">readdir</span>(d))) {
        <span class="hljs-comment">// 向uevent节点写入"add",触发内核发送uevent事件</span>
        fd = <span class="hljs-built_in">openat</span>(dfd, <span class="hljs-string">"uevent"</span>, O_WRONLY | O_CLOEXEC);
        <span class="hljs-keyword">if</span> (fd &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">write</span>(fd, <span class="hljs-string">"add\n"</span>, <span class="hljs-number">4</span>);
            <span class="hljs-built_in">close</span>(fd);
        }
    }
}
</code></pre>
<p>Coldboot的作用是主动触发内核重新发送已连接设备的uevent事件,确保Vold启动时能发现已插入的存储设备。</p>
<hr/>
<h2 data-id="heading-18">三、VolumeManager核心机制</h2>
<h3 data-id="heading-19">3.1 VolumeManager的数据结构</h3>
<p>让我们看看VolumeManager如何组织和管理Disk和Volume:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VolumeManager.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeManager</span> {
<span class="hljs-keyword">private</span>:
    std::mutex mLock;  <span class="hljs-comment">// 全局锁</span>
    std::mutex mCryptLock;  <span class="hljs-comment">// 加密操作锁</span>

    <span class="hljs-comment">// 核心数据结构</span>
    std::list&lt;std::shared_ptr&lt;DiskSource&gt;&gt; mDiskSources;  <span class="hljs-comment">// 磁盘源配置</span>
    std::list&lt;std::shared_ptr&lt;android::vold::Disk&gt;&gt; mDisks;  <span class="hljs-comment">// 物理磁盘列表</span>
    std::list&lt;std::shared_ptr&lt;android::vold::Disk&gt;&gt; mPendingDisks;  <span class="hljs-comment">// 待处理磁盘</span>
    std::list&lt;std::shared_ptr&lt;android::vold::VolumeBase&gt;&gt; mObbVolumes;  <span class="hljs-comment">// OBB卷</span>
    std::list&lt;std::shared_ptr&lt;android::vold::VolumeBase&gt;&gt; mInternalEmulatedVolumes;  <span class="hljs-comment">// 模拟卷</span>

    <span class="hljs-comment">// 用户管理</span>
    std::unordered_map&lt;<span class="hljs-type">userid_t</span>, <span class="hljs-type">int</span>&gt; mAddedUsers;
    std::set&lt;<span class="hljs-type">userid_t</span>&gt; mStartedUsers;

    <span class="hljs-comment">// 事件监听器</span>
    android::sp&lt;android::os::IVoldListener&gt; mListener;
};
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af95ca67bcb04968895b823c25a669f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=wQpXAC2G4qmGQeXHWN1jsNRxAlg%3D" alt="04-04-disk-volume-relationship.png" loading="lazy"/></p>
<h3 data-id="heading-20">3.2 Disk和Volume的关系</h3>
<p><strong>Disk (物理磁盘抽象)</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/Disk.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Disk</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Flags</span> {
        kAdoptable = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>,      <span class="hljs-comment">// 可采用存储</span>
        kDefaultPrimary = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>, <span class="hljs-comment">// 默认主存储</span>
        kSd = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,             <span class="hljs-comment">// SD卡</span>
        kUsb = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,            <span class="hljs-comment">// USB存储</span>
        kEmmc = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,           <span class="hljs-comment">// eMMC内部存储</span>
    };

<span class="hljs-keyword">private</span>:
    std::string mId;              <span class="hljs-comment">// 唯一ID,如"disk:179:0"</span>
    std::string mSysPath;         <span class="hljs-comment">// sysfs路径,如"/sys/devices/.../mmcblk0"</span>
    std::string mDevPath;         <span class="hljs-comment">// 设备路径,如"/dev/block/mmcblk0"</span>
    <span class="hljs-type">dev_t</span> mDevice;                <span class="hljs-comment">// 设备号(major:minor)</span>
    <span class="hljs-type">uint64_t</span> mSize;               <span class="hljs-comment">// 磁盘大小</span>
    std::string mLabel;           <span class="hljs-comment">// 磁盘标签</span>
    <span class="hljs-type">int</span> mFlags;                   <span class="hljs-comment">// 标志位</span>
    std::vector&lt;std::shared_ptr&lt;VolumeBase&gt;&gt; mVolumes;  <span class="hljs-comment">// 包含的Volume列表</span>
};
</code></pre>
<p><strong>VolumeBase (Volume基类)</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/VolumeBase.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VolumeBase</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">Type</span> {
        kPublic = <span class="hljs-number">0</span>,   <span class="hljs-comment">// 公共存储</span>
        kPrivate,      <span class="hljs-comment">// 可采用存储</span>
        kEmulated,     <span class="hljs-comment">// 模拟存储</span>
        kAsec,         <span class="hljs-comment">// 已废弃</span>
        kObb,          <span class="hljs-comment">// OBB文件</span>
        kStub,         <span class="hljs-comment">// 存根卷</span>
    };

    <span class="hljs-keyword">enum class</span> <span class="hljs-title class_">State</span> {
        kUnmounted = <span class="hljs-number">0</span>,       <span class="hljs-comment">// 未挂载</span>
        kChecking,            <span class="hljs-comment">// 检查中</span>
        kMounted,             <span class="hljs-comment">// 已挂载</span>
        kMountedReadOnly,     <span class="hljs-comment">// 只读挂载</span>
        kFormatting,          <span class="hljs-comment">// 格式化中</span>
        kEjecting,            <span class="hljs-comment">// 弹出中</span>
        kUnmountable,         <span class="hljs-comment">// 无法挂载</span>
        kRemoved,             <span class="hljs-comment">// 已移除</span>
        kBadRemoval,          <span class="hljs-comment">// 异常移除</span>
    };

<span class="hljs-keyword">protected</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doMount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;     <span class="hljs-comment">// 子类实现挂载逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">status_t</span> <span class="hljs-title">doUnmount</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;   <span class="hljs-comment">// 子类实现卸载逻辑</span>

<span class="hljs-keyword">private</span>:
    std::string mId;          <span class="hljs-comment">// Volume ID,如"public:179:1"</span>
    std::string mDiskId;      <span class="hljs-comment">// 所属Disk ID</span>
    Type mType;               <span class="hljs-comment">// Volume类型</span>
    State mState;             <span class="hljs-comment">// 当前状态</span>
    std::string mPath;        <span class="hljs-comment">// 挂载路径</span>
};
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5c74afd832b47e9a183ad09a7882a77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=PHtvztOWznJDheekvx5Q14y8ud0%3D" alt="04-03-volume-state-machine.png" loading="lazy"/></p>
<h3 data-id="heading-21">3.3 Volume生命周期管理</h3>
<p><strong>创建Volume</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/Disk.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Disk::createPublicVolume</span><span class="hljs-params">(<span class="hljs-type">dev_t</span> device)</span> </span>{
    <span class="hljs-keyword">auto</span> vol = std::<span class="hljs-built_in">make_shared</span>&lt;PublicVolume&gt;(device);
    <span class="hljs-comment">// 设置Volume属性</span>
    vol-&gt;<span class="hljs-built_in">setDiskId</span>(<span class="hljs-built_in">getId</span>());
    vol-&gt;<span class="hljs-built_in">setPartGuid</span>(partGuid);

    <span class="hljs-comment">// 添加到Disk的Volume列表</span>
    mVolumes.<span class="hljs-built_in">push_back</span>(vol);

    <span class="hljs-comment">// 创建Volume(通知Framework)</span>
    vol-&gt;<span class="hljs-built_in">create</span>();
}
</code></pre>
<p><strong>挂载Volume</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/VolumeBase.cpp</span>
<span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">VolumeBase::mount</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 状态检查</span>
    <span class="hljs-keyword">if</span> (mState != State::kUnmounted) {
        <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">"Already mounted or mounting"</span>;
        <span class="hljs-keyword">return</span> -EBUSY;
    }

    <span class="hljs-comment">// 2. 设置为检查状态</span>
    <span class="hljs-built_in">setState</span>(State::kChecking);

    <span class="hljs-comment">// 3. 调用子类实现的挂载逻辑</span>
    <span class="hljs-type">status_t</span> res = <span class="hljs-built_in">doMount</span>();

    <span class="hljs-comment">// 4. 根据结果更新状态</span>
    <span class="hljs-keyword">if</span> (res == OK) {
        <span class="hljs-built_in">setState</span>(State::kMounted);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">setState</span>(State::kUnmountable);
    }

    <span class="hljs-keyword">return</span> res;
}
</code></pre>
<p><strong>PublicVolume的挂载实现</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/model/PublicVolume.cpp</span>
<span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">PublicVolume::doMount</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 读取文件系统类型</span>
    std::string fsType;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ReadMetadataUntrusted</span>(mDevPath, &amp;fsType, &amp;fsUuid, &amp;fsLabel)) {
        <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">"Failed to read metadata"</span>;
        fsType = <span class="hljs-string">"auto"</span>;
    }

    <span class="hljs-comment">// 2. 执行fsck检查</span>
    <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"vfat"</span> &amp;&amp; vfat::<span class="hljs-built_in">Check</span>(mDevPath)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"FAT filesystem check failed"</span>;
        <span class="hljs-keyword">return</span> -EIO;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"exfat"</span> &amp;&amp; exfat::<span class="hljs-built_in">Check</span>(mDevPath)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"exFAT filesystem check failed"</span>;
        <span class="hljs-keyword">return</span> -EIO;
    }

    <span class="hljs-comment">// 3. 创建挂载点</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">PrepareDir</span>(mRawPath, <span class="hljs-number">0700</span>, AID_ROOT, AID_ROOT)) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to create mount point "</span> &lt;&lt; mRawPath;
        <span class="hljs-keyword">return</span> -errno;
    }

    <span class="hljs-comment">// 4. 执行mount系统调用</span>
    <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"vfat"</span>) {
        <span class="hljs-keyword">if</span> (vfat::<span class="hljs-built_in">Mount</span>(mDevPath, mRawPath, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>,
                       AID_MEDIA_RW, AID_MEDIA_RW, <span class="hljs-number">0007</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to mount vfat"</span>;
            <span class="hljs-keyword">return</span> -EIO;
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fsType == <span class="hljs-string">"exfat"</span>) {
        <span class="hljs-keyword">if</span> (exfat::<span class="hljs-built_in">Mount</span>(mDevPath, mRawPath, AID_MEDIA_RW, AID_MEDIA_RW, <span class="hljs-number">0007</span>)) {
            <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to mount exfat"</span>;
            <span class="hljs-keyword">return</span> -EIO;
        }
    }

    <span class="hljs-comment">// 5. 设置挂载路径</span>
    <span class="hljs-built_in">setPath</span>(mRawPath);
    <span class="hljs-keyword">return</span> OK;
}
</code></pre>
<hr/>
<h2 data-id="heading-22">四、Netlink事件处理机制</h2>
<h3 data-id="heading-23">4.1 Netlink与Uevent</h3>
<p>Linux内核通过<strong>Netlink Socket</strong>向用户空间发送设备事件(Uevent)。Vold通过NetlinkManager监听这些事件,实现设备的热插拔检测。</p>
<p><strong>Uevent事件格式示例</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ACTION</span>=add
<span class="hljs-attr">DEVPATH</span>=/devices/platform/soc/<span class="hljs-number">7864900</span>.sdhci/mmc_host/mmc0/mmc0:<span class="hljs-number">0001</span>/block/mmcblk0
<span class="hljs-attr">SUBSYSTEM</span>=block
<span class="hljs-attr">MAJOR</span>=<span class="hljs-number">179</span>
<span class="hljs-attr">MINOR</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">DEVNAME</span>=mmcblk0
<span class="hljs-attr">DEVTYPE</span>=disk
</code></pre>
<h3 data-id="heading-24">4.2 NetlinkManager实现</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/NetlinkManager.cpp</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">NetlinkManager::start</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 创建Netlink socket</span>
    mSock = <span class="hljs-built_in">socket</span>(PF_NETLINK, SOCK_DGRAM | SOCK_CLOEXEC, NETLINK_KOBJECT_UEVENT);
    <span class="hljs-keyword">if</span> (mSock &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to create Netlink socket"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 2. 绑定到KOBJECT_UEVENT组</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_nl</span> addr;
    <span class="hljs-built_in">memset</span>(&amp;addr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(addr));
    addr.nl_family = AF_NETLINK;
    addr.nl_pid = <span class="hljs-built_in">getpid</span>();
    addr.nl_groups = <span class="hljs-number">0xFFFFFFFF</span>;  <span class="hljs-comment">// 接收所有组的事件</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">bind</span>(mSock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-built_in">sizeof</span>(addr)) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to bind Netlink socket"</span>;
        <span class="hljs-built_in">close</span>(mSock);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-comment">// 3. 创建NetlinkHandler并启动监听线程</span>
    mHandler = <span class="hljs-keyword">new</span> <span class="hljs-built_in">NetlinkHandler</span>(mSock);
    <span class="hljs-keyword">if</span> (mHandler-&gt;<span class="hljs-built_in">start</span>()) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Unable to start NetlinkHandler"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-25">4.3 NetlinkHandler处理流程</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/NetlinkHandler.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">NetlinkHandler::onEvent</span><span class="hljs-params">(NetlinkEvent* evt)</span> </span>{
    VolumeManager* vm = VolumeManager::<span class="hljs-built_in">Instance</span>();
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* subsys = evt-&gt;<span class="hljs-built_in">getSubsystem</span>();

    <span class="hljs-comment">// 只处理block子系统事件</span>
    <span class="hljs-keyword">if</span> (!subsys || <span class="hljs-built_in">strcmp</span>(subsys, <span class="hljs-string">"block"</span>) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 根据action类型分发</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* action = evt-&gt;<span class="hljs-built_in">getAction</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"add"</span>)) {
        <span class="hljs-comment">// 设备添加</span>
        vm-&gt;<span class="hljs-built_in">handleBlockEvent</span>(evt);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"remove"</span>)) {
        <span class="hljs-comment">// 设备移除</span>
        vm-&gt;<span class="hljs-built_in">handleBlockEvent</span>(evt);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"change"</span>)) {
        <span class="hljs-comment">// 设备变化(如SD卡写保护开关)</span>
        vm-&gt;<span class="hljs-built_in">handleBlockEvent</span>(evt);
    }
}
</code></pre>
<h3 data-id="heading-26">4.4 VolumeManager处理块设备事件</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VolumeManager.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VolumeManager::handleBlockEvent</span><span class="hljs-params">(NetlinkEvent* evt)</span> </span>{
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mLock)</span></span>;

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* devpath = evt-&gt;<span class="hljs-built_in">findParam</span>(<span class="hljs-string">"DEVPATH"</span>);
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* action = evt-&gt;<span class="hljs-built_in">getAction</span>();

    <span class="hljs-comment">// 解析设备号</span>
    <span class="hljs-type">int</span> major = std::<span class="hljs-built_in">stoi</span>(evt-&gt;<span class="hljs-built_in">findParam</span>(<span class="hljs-string">"MAJOR"</span>));
    <span class="hljs-type">int</span> minor = std::<span class="hljs-built_in">stoi</span>(evt-&gt;<span class="hljs-built_in">findParam</span>(<span class="hljs-string">"MINOR"</span>));
    <span class="hljs-type">dev_t</span> device = <span class="hljs-built_in">makedev</span>(major, minor);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"add"</span>)) {
        <span class="hljs-comment">// 1. 检查是否匹配DiskSource</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; source : mDiskSources) {
            <span class="hljs-keyword">if</span> (source-&gt;<span class="hljs-built_in">matches</span>(devpath)) {
                <span class="hljs-comment">// 2. 创建Disk对象</span>
                <span class="hljs-keyword">auto</span> disk = std::<span class="hljs-built_in">make_shared</span>&lt;android::vold::Disk&gt;(
                    eventPath, device, source-&gt;<span class="hljs-built_in">getNickname</span>(), source-&gt;<span class="hljs-built_in">getFlags</span>());

                <span class="hljs-comment">// 3. 添加到磁盘列表</span>
                <span class="hljs-built_in">handleDiskAdded</span>(disk);
                <span class="hljs-keyword">break</span>;
            }
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(action, <span class="hljs-string">"remove"</span>)) {
        <span class="hljs-comment">// 移除对应的Disk</span>
        <span class="hljs-built_in">handleDiskRemoved</span>(device);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VolumeManager::handleDiskAdded</span><span class="hljs-params">(<span class="hljs-type">const</span> std::shared_ptr&lt;android::vold::Disk&gt;&amp; disk)</span> </span>{
    <span class="hljs-comment">// 1. 添加到mDisks列表</span>
    mDisks.<span class="hljs-built_in">push_back</span>(disk);

    <span class="hljs-comment">// 2. 创建Disk(读取分区表,创建Volume)</span>
    disk-&gt;<span class="hljs-built_in">create</span>();

    <span class="hljs-comment">// 3. 通知Framework</span>
    <span class="hljs-built_in">notifyEvent</span>(ResponseCode::DiskCreated,
                <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">"%d"</span>, disk-&gt;<span class="hljs-built_in">getId</span>()));
}
</code></pre>
<hr/>
<h2 data-id="heading-27">五、Binder通信:Framework与Vold的桥梁</h2>
<h3 data-id="heading-28">5.1 VoldNativeService架构</h3>
<p>VoldNativeService是Vold对外提供服务的Binder接口实现:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.h</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VoldNativeService</span> : <span class="hljs-keyword">public</span> BinderService&lt;VoldNativeService&gt;,
                          <span class="hljs-keyword">public</span> os::BnVold {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">status_t</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">char</span> <span class="hljs-type">const</span>* <span class="hljs-title">getServiceName</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"vold"</span>; }

    <span class="hljs-comment">// Listener管理</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">setListener</span><span class="hljs-params">(<span class="hljs-type">const</span> android::sp&lt;android::os::IVoldListener&gt;&amp; listener)</span></span>;

    <span class="hljs-comment">// Volume操作</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">mount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">int32_t</span> mountFlags, <span class="hljs-type">int32_t</span> mountUserId,
                         <span class="hljs-type">const</span> android::sp&lt;android::os::IVoldMountCallback&gt;&amp; callback)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">unmount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">format</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">const</span> std::string&amp; fsType)</span></span>;

    <span class="hljs-comment">// Disk操作</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">partition</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; diskId, <span class="hljs-type">int32_t</span> partitionType, <span class="hljs-type">int32_t</span> ratio)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">forgetPartition</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; partGuid, <span class="hljs-type">const</span> std::string&amp; fsUuid)</span></span>;

    <span class="hljs-comment">// 用户管理</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserAdded</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId, <span class="hljs-type">int32_t</span> userSerial, <span class="hljs-type">int32_t</span> sharesStorageWithUserId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserRemoved</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserStarted</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">onUserStopped</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;

    <span class="hljs-comment">// FBE加密</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">createUserStorageKeys</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId, <span class="hljs-type">bool</span> ephemeral)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">destroyUserStorageKeys</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">unlockCeStorage</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId, <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; secret)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">lockCeStorage</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId)</span></span>;

    <span class="hljs-comment">// OBB管理</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">createObb</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sourcePath, <span class="hljs-type">int32_t</span> ownerGid,
                             std::string* _aidl_return)</span></span>;
    <span class="hljs-function">binder::Status <span class="hljs-title">destroyObb</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId)</span></span>;

    <span class="hljs-comment">// 存储维护</span>
    <span class="hljs-function">binder::Status <span class="hljs-title">fstrim</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> fstrimFlags,
                          <span class="hljs-type">const</span> android::sp&lt;android::os::IVoldTaskListener&gt;&amp; listener)</span></span>;
};
</code></pre>
<h3 data-id="heading-29">5.2 StorageManagerService与Vold的交互</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43696c21256249c58a03870168b72178~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600239&amp;x-signature=hL2WpJyjebErTi0TjsUjAdvAlRw%3D" alt="04-05-sms-vold-interaction-sequence.png" loading="lazy"/></p>
<p><strong>完整的SD卡挂载流程</strong>:</p>
<h4 data-id="heading-30"><strong>阶段1: 设备检测(内核→Vold→Framework)</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/base/services/core/java/com/android/server/StorageManagerService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">IVoldListener</span> <span class="hljs-variable">mListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IVoldListener</span>.Stub() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDiskCreated</span><span class="hljs-params">(String diskId, <span class="hljs-type">int</span> flags)</span> {
        <span class="hljs-comment">// 1. 接收Vold通知:发现新磁盘</span>
        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">DiskInfo</span> <span class="hljs-variable">disk</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiskInfo</span>(diskId, flags);
            mDisks.put(diskId, disk);
        }
        <span class="hljs-comment">// 2. 通知监听器</span>
        mHandler.obtainMessage(H_DISK_SCANNED, disk).sendToTarget();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onVolumeCreated</span><span class="hljs-params">(String volId, <span class="hljs-type">int</span> type, String diskId, String partGuid)</span> {
        <span class="hljs-comment">// 3. 接收Vold通知:发现新Volume</span>
        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">VolumeInfo</span> <span class="hljs-variable">vol</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VolumeInfo</span>(volId, type, disk, partGuid);
            mVolumes.put(volId, vol);
        }
        <span class="hljs-comment">// 4. 发送广播通知应用</span>
        mHandler.obtainMessage(H_VOLUME_STATE_CHANGED, vol).sendToTarget();
    }
};
</code></pre>
<h4 data-id="heading-31"><strong>阶段2: 挂载请求(Framework→Vold)</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// StorageManagerService.java</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mount</span><span class="hljs-params">(String volId)</span> {
    <span class="hljs-comment">// 1. 权限检查</span>
    enforcePermission(android.Manifest.permission.MOUNT_UNMOUNT_FILESYSTEMS);

    <span class="hljs-comment">// 2. 查找Volume</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">VolumeInfo</span> <span class="hljs-variable">vol</span> <span class="hljs-operator">=</span> findVolumeByIdOrThrow(volId);
    <span class="hljs-keyword">if</span> (vol.type == VolumeInfo.TYPE_PRIVATE || vol.type == VolumeInfo.TYPE_PUBLIC) {
        <span class="hljs-comment">// 3. 调用Vold挂载</span>
        <span class="hljs-keyword">try</span> {
            mVold.mount(vol.id, vol.mountFlags, vol.mountUserId,
                       <span class="hljs-keyword">new</span> <span class="hljs-title class_">IVoldMountCallback</span>.Stub() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStatus</span><span class="hljs-params">(<span class="hljs-type">int</span> status, PersistableBundle extras)</span> {
                    <span class="hljs-comment">// 挂载进度回调</span>
                }
            });
        } <span class="hljs-keyword">catch</span> (Exception e) {
            Slog.wtf(TAG, e);
        }
    }
}
</code></pre>
<p><strong>VoldNativeService处理挂载请求</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.cpp</span>
<span class="hljs-function">binder::Status <span class="hljs-title">VoldNativeService::mount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">int32_t</span> mountFlags,
                                        <span class="hljs-type">int32_t</span> mountUserId,
                                        <span class="hljs-type">const</span> sp&lt;IVoldMountCallback&gt;&amp; callback)</span> </span>{
    ENFORCE_SYSTEM_OR_ROOT;

    <span class="hljs-comment">// 1. 查找Volume</span>
    <span class="hljs-keyword">auto</span> vol = VolumeManager::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">findVolume</span>(volId);
    <span class="hljs-keyword">if</span> (vol == <span class="hljs-literal">nullptr</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">error</span>(<span class="hljs-string">"Failed to find volume "</span> + volId);
    }

    <span class="hljs-comment">// 2. 设置挂载参数</span>
    vol-&gt;<span class="hljs-built_in">setMountFlags</span>(mountFlags);
    vol-&gt;<span class="hljs-built_in">setMountUserId</span>(mountUserId);
    vol-&gt;<span class="hljs-built_in">setMountCallback</span>(callback);

    <span class="hljs-comment">// 3. 执行挂载</span>
    <span class="hljs-type">int</span> res = vol-&gt;<span class="hljs-built_in">mount</span>();
    <span class="hljs-keyword">if</span> (res != OK) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">error</span>(<span class="hljs-string">"Failed to mount "</span> + volId);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ok</span>();
}
</code></pre>
<h3 data-id="heading-32">5.3 事件通知机制</h3>
<p>Vold通过IVoldListener向Framework发送异步事件:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/VoldNativeService.cpp</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VoldNativeService::notifyDiskScanned</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; diskId, <span class="hljs-type">int</span> flags)</span> </span>{
    <span class="hljs-keyword">auto</span> listener = VolumeManager::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">getListener</span>();
    <span class="hljs-keyword">if</span> (listener) {
        listener-&gt;<span class="hljs-built_in">onDiskScanned</span>(diskId, flags);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VoldNativeService::notifyVolumeStateChanged</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volId, <span class="hljs-type">int</span> state)</span> </span>{
    <span class="hljs-keyword">auto</span> listener = VolumeManager::<span class="hljs-built_in">Instance</span>()-&gt;<span class="hljs-built_in">getListener</span>();
    <span class="hljs-keyword">if</span> (listener) {
        listener-&gt;<span class="hljs-built_in">onVolumeStateChanged</span>(volId, state);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-33">六、实战:Vold调试技巧</h2>
<h3 data-id="heading-34">6.1 查看Vold日志</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 实时查看Vold日志</span>
adb logcat -s vold:*

<span class="hljs-comment"># 2. 查看Vold错误日志</span>
adb logcat -s vold:E

<span class="hljs-comment"># 3. 查看特定Volume的日志</span>
adb logcat | grep <span class="hljs-string">"public:179:1"</span>
</code></pre>
<h3 data-id="heading-35">6.2 使用dumpsys分析存储状态</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看所有存储信息</span>
adb shell dumpsys mount

<span class="hljs-comment"># 2. 查看Disk列表</span>
adb shell dumpsys mount | grep <span class="hljs-string">"Disk:"</span>

<span class="hljs-comment"># 3. 查看Volume列表</span>
adb shell dumpsys mount | grep <span class="hljs-string">"Volume:"</span>
</code></pre>
<p><strong>dumpsys输出示例</strong>:</p>
<pre><code class="hljs language-ini" lang="ini">Disks:
  disk:179:0 (SD卡):
    <span class="hljs-attr">flags</span>=kSd|kAdoptable
    <span class="hljs-attr">size</span>=<span class="hljs-number">31914983424</span>
    <span class="hljs-attr">sysPath</span>=/sys/devices/.../mmcblk0
    <span class="hljs-attr">devPath</span>=/dev/block/mmcblk0
    <span class="hljs-attr">nickname</span>=sdcard1
    volumes:
      public:179:1

Volumes:
  public:179:1 (SD卡):
    <span class="hljs-attr">type</span>=kPublic
    <span class="hljs-attr">diskId</span>=disk:<span class="hljs-number">179</span>:<span class="hljs-number">0</span>
    <span class="hljs-attr">partGuid</span>=<span class="hljs-number">00000000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">000000000000</span>
    <span class="hljs-attr">state</span>=kMounted
    <span class="hljs-attr">path</span>=/storage/<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>
    <span class="hljs-attr">internalPath</span>=/mnt/media_rw/<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>
    <span class="hljs-attr">fsType</span>=vfat
    <span class="hljs-attr">fsUuid</span>=<span class="hljs-number">0000</span>-<span class="hljs-number">0000</span>
    <span class="hljs-attr">fsLabel</span>=SD Card
</code></pre>
<h3 data-id="heading-36">6.3 手动触发Vold操作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 通过vdc(Vold Direct Command)手动挂载Volume</span>
adb shell vdc volume mount public:179:1

<span class="hljs-comment"># 2. 卸载Volume</span>
adb shell vdc volume unmount public:179:1

<span class="hljs-comment"># 3. 格式化Volume</span>
adb shell vdc volume format public:179:1 auto

<span class="hljs-comment"># 4. 分区Disk</span>
adb shell vdc volume partition disk:179:0 public

<span class="hljs-comment"># 5. 创建OBB Volume</span>
adb shell vdc volume mkobb /data/app/com.example/expansion.obb 1000
</code></pre>
<h3 data-id="heading-37">6.4 分析Netlink事件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 监听内核Uevent</span>
adb shell getevent -l /sys/kernel/uevent

<span class="hljs-comment"># 2. 手动触发coldboot</span>
adb shell <span class="hljs-string">"echo add &gt; /sys/block/mmcblk0/uevent"</span>

<span class="hljs-comment"># 3. 查看设备树</span>
adb shell <span class="hljs-built_in">ls</span> -R /sys/devices/platform/*/mmc_host
</code></pre>
<h3 data-id="heading-38">6.5 使用Systrace分析存储性能</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 追踪Vold的挂载流程</span>
systrace.py -t 10 -o trace.html <span class="hljs-built_in">sched</span> freq idle am wm gfx view binder_driver \
            hal dalvik disk pm ss database package_manager vold

<span class="hljs-comment"># 在Chrome中打开trace.html,搜索"vold"或"mount"关键字</span>
</code></pre>
<hr/>
<h2 data-id="heading-39">七、Android 15的Vold新特性</h2>
<h3 data-id="heading-40">7.1 增强的Adoptable Storage</h3>
<p>Android 15对可采用存储进行了优化:</p>
<ul>
<li><strong>更快的格式化速度</strong>: 使用<code>mkfs.ext4 -E lazy_itable_init,lazy_journal_init</code></li>
<li><strong>更好的性能</strong>: 默认启用<code>discard</code>和<code>noatime</code>挂载选项</li>
</ul>
<h3 data-id="heading-41">7.2 改进的FBE(File-Based Encryption)</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Android 15新增的FBE API</span>
<span class="hljs-function">binder::Status <span class="hljs-title">VoldNativeService::setCeStorageProtection</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> userId,
                                                          <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">uint8_t</span>&gt;&amp; secret)</span> </span>{
    <span class="hljs-comment">// 支持动态修改CE(Credential Encrypted)存储的保护密钥</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">translate</span>(<span class="hljs-built_in">fscrypt_set_ce_key_protection</span>(userId, secret));
}
</code></pre>
<h3 data-id="heading-42">7.3 FUSE Passthrough优化</h3>
<p>Android 15引入了FUSE Passthrough机制,减少FUSE带来的性能开销:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 启用FUSE Passthrough</span>
<span class="hljs-keyword">if</span> (android::base::<span class="hljs-built_in">GetBoolProperty</span>(<span class="hljs-string">"persist.sys.fuse.passthrough.enable"</span>, <span class="hljs-literal">false</span>)) {
    vol-&gt;<span class="hljs-built_in">enablePassthrough</span>();
}
</code></pre>
<hr/>
<h2 data-id="heading-43">八、常见问题与解决方案</h2>
<h3 data-id="heading-44">Q1: SD卡插入后无法识别</h3>
<p><strong>排查步骤</strong>:</p>
<ol>
<li>
<p>检查Vold日志是否收到uevent事件:</p>
<pre><code class="hljs language-bash" lang="bash">adb logcat -s vold:D | grep <span class="hljs-string">"handleBlockEvent"</span>
</code></pre>
</li>
<li>
<p>检查fstab是否配置了vold_managed:</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">cat</span> /vendor/etc/fstab* | grep vold_managed
</code></pre>
</li>
<li>
<p>检查SELinux权限:</p>
<pre><code class="hljs language-bash" lang="bash">adb shell getenforce  <span class="hljs-comment"># 应该是Enforcing</span>
adb logcat | grep <span class="hljs-string">"avc.*denied.*vold"</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-45">Q2: Volume挂载失败</h3>
<p><strong>常见原因</strong>:</p>
<ul>
<li>文件系统损坏:运行<code>fsck</code>检查</li>
<li>SELinux上下文错误:检查<code>/mnt/media_rw</code>的安全上下文</li>
<li>权限不足:确保Vold运行在root权限</li>
</ul>
<p><strong>解决方案</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 强制fsck检查</span>
adb shell vdc volume fsck public:179:1

<span class="hljs-comment"># 2. 重新格式化</span>
adb shell vdc volume format public:179:1 vfat

<span class="hljs-comment"># 3. 重启Vold</span>
adb shell stop vold &amp;&amp; adb shell start vold
</code></pre>
<h3 data-id="heading-46">Q3: Adoptable Storage性能差</h3>
<p><strong>优化建议</strong>:</p>
<ol>
<li>使用高速SD卡(UHS-I Class 10以上)</li>
<li>启用TRIM支持:
<pre><code class="hljs language-bash" lang="bash">adb shell sm set-force-adoptable <span class="hljs-literal">true</span>
</code></pre>
</li>
<li>定期运行fstrim:
<pre><code class="hljs language-bash" lang="bash">adb shell sm fstrim
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-47">总结</h2>
<p>本文深入剖析了Android 15的Vold存储管理框架,涵盖了以下核心内容:</p>
<ol>
<li><strong>架构设计</strong>: Vold采用分层架构,通过VolumeManager、NetlinkManager等核心组件实现存储管理</li>
<li><strong>启动流程</strong>: 从init进程启动到Binder服务就绪的完整流程</li>
<li><strong>Volume管理</strong>: Disk和Volume的组织关系,以及Volume的生命周期状态机</li>
<li><strong>事件处理</strong>: 基于Netlink的设备热插拔检测机制</li>
<li><strong>Binder通信</strong>: VoldNativeService与StorageManagerService的跨进程交互</li>
<li><strong>调试技巧</strong>: 使用logcat、dumpsys、vdc等工具分析存储问题</li>
</ol>
<p>Vold作为Android存储架构的核心,其设计体现了<strong>单一职责</strong>、<strong>分层解耦</strong>、<strong>事件驱动</strong>等优秀的软件工程思想。理解Vold的工作原理,对于进行存储相关的系统开发和问题排查至关重要。</p>
<p>在下一篇文章中,我们将深入探讨<strong>FUSE文件系统与Scoped Storage</strong>机制,分析MediaProvider如何通过FUSE实现应用的存储隔离和权限控制。</p>
<hr/>
<h2 data-id="heading-48">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdevices%2Fstorage" target="_blank" title="https://source.android.com/devices/storage" ref="nofollow noopener noreferrer">Android Storage Architecture</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fandroid-15.0.0_r1%3Asystem%2Fvold%2F" target="_blank" title="https://cs.android.com/android/platform/superproject/+/android-15.0.0_r1:system/vold/" ref="nofollow noopener noreferrer">Vold Source Code (AOSP 15.0)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fsecurity%2Fencryption%2Ffile-based" target="_blank" title="https://source.android.com/security/encryption/file-based" ref="nofollow noopener noreferrer">Android File-Based Encryption</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdevices%2Fstorage%2Fadoptable" target="_blank" title="https://source.android.com/devices/storage/adoptable" ref="nofollow noopener noreferrer">Android Adoptable Storage</a></li>
</ul>
<hr/>
<h3 data-id="heading-49">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7596906923892228106" target="_blank" title="https://juejin.cn/post/7596906923892228106">上一篇：Android 15 显示子系统深度解析(三)：Vsync机制与显示性能优化实战</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Kotlin系列11】协程原理与实战（下）：Flow与Channel驯服异步数据流]]></title>    <link>https://juejin.cn/post/7597623395907829806</link>    <guid>https://juejin.cn/post/7597623395907829806</guid>    <pubDate>2026-01-21T11:49:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623395907829806" data-draft-id="7597640029574283315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Kotlin系列11】协程原理与实战（下）：Flow与Channel驯服异步数据流"/> <meta itemprop="keywords" content="Kotlin,Android,编程语言"/> <meta itemprop="datePublished" content="2026-01-21T11:49:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Kotlin系列11】协程原理与实战（下）：Flow与Channel驯服异步数据流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:49:23.000Z" title="Wed Jan 21 2026 11:49:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：异步数据流的烦恼</h2>
<p>假设你正在开发一个股票交易应用，需要实时显示股票价格：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 传统方式：轮询 + 回调</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StockMonitor</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMonitoring</span><span class="hljs-params">(symbol: <span class="hljs-type">String</span>, callback: (<span class="hljs-type">Double</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        timer.scheduleAtFixedRate(<span class="hljs-keyword">object</span> : TimerTask() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> {
                <span class="hljs-keyword">val</span> price = fetchStockPrice(symbol)
                callback(price)
            }
        }, <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>)  <span class="hljs-comment">// 每秒查询一次</span>
    }
}

<span class="hljs-comment">// 使用时</span>
stockMonitor.startMonitoring(<span class="hljs-string">"AAPL"</span>) { price -&gt;
    runOnUiThread {
        updateUI(price)
    }
}
</code></pre>
<p>这种方式有什么问题？</p>
<ol>
<li><strong>资源浪费</strong>：即使价格没变化也要轮询</li>
<li><strong>内存泄漏</strong>：忘记取消timer</li>
<li><strong>线程混乱</strong>：需要手动切换线程</li>
<li><strong>难以组合</strong>：监听多个股票？处理数据流？</li>
</ol>
<p><strong>Kotlin Flow</strong>优雅地解决了这些问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用Flow：响应式数据流</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stockPriceFlow</span><span class="hljs-params">(symbol: <span class="hljs-type">String</span>)</span></span>: Flow&lt;<span class="hljs-built_in">Double</span>&gt; = flow {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">val</span> price = fetchStockPrice(symbol)
        emit(price)  <span class="hljs-comment">// 发射数据</span>
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 挂起1秒</span>
    }
}

<span class="hljs-comment">// 使用时</span>
lifecycleScope.launch {
    stockPriceFlow(<span class="hljs-string">"AAPL"</span>)
        .filter { it &gt; <span class="hljs-number">150.0</span> }  <span class="hljs-comment">// 过滤</span>
        .map { <span class="hljs-string">"$<span class="hljs-variable">$it</span>"</span> }         <span class="hljs-comment">// 转换</span>
        .collect { price -&gt;     <span class="hljs-comment">// 收集</span>
            updateUI(price)
        }
}  <span class="hljs-comment">// 自动取消，无需手动管理</span>
</code></pre>
<p><strong>优势明显</strong>：</p>
<ul>
<li>✅ 自动生命周期管理</li>
<li>✅ 线程自动切换</li>
<li>✅ 函数式操作符</li>
<li>✅ 背压处理</li>
</ul>
<p>本文将深入讲解Flow和Channel，让你彻底掌握协程的异步数据流处理。</p>
<h2 data-id="heading-1">Flow基础：响应式数据流</h2>
<h3 data-id="heading-2">什么是Flow？</h3>
<p><strong>Flow</strong>是Kotlin协程提供的<strong>异步数据流</strong>API，类似于RxJava的Observable，但：</p>
<ul>
<li><strong>基于协程</strong>：天然支持挂起函数</li>
<li><strong>冷流</strong>：只有收集时才开始执行</li>
<li><strong>结构化并发</strong>：自动管理生命周期</li>
<li><strong>背压支持</strong>：内置背压处理机制</li>
</ul>
<h3 data-id="heading-3">创建Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.flow.*

<span class="hljs-comment">// 1. flow构建器 - 最基础的方式</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">simpleFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = flow {
    println(<span class="hljs-string">"Flow开始"</span>)
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">1000</span>)
        emit(i)  <span class="hljs-comment">// 发射数据</span>
    }
}

<span class="hljs-comment">// 2. flowOf - 固定数据</span>
<span class="hljs-keyword">val</span> numbersFlow = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)

<span class="hljs-comment">// 3. asFlow - 集合转Flow</span>
<span class="hljs-keyword">val</span> listFlow = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).asFlow()

<span class="hljs-comment">// 4. channelFlow - 支持并发发射</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">concurrentFlow</span><span class="hljs-params">()</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; = channelFlow {
    launch {
        repeat(<span class="hljs-number">3</span>) {
            delay(<span class="hljs-number">1000</span>)
            send(it)  <span class="hljs-comment">// 使用send而非emit</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-4">收集Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> flow = simpleFlow()

    <span class="hljs-comment">// 收集方式1: collect - 最基础</span>
    flow.collect { value -&gt;
        println(<span class="hljs-string">"收到: <span class="hljs-variable">$value</span>"</span>)
    }

    <span class="hljs-comment">// 收集方式2: toList - 收集到列表</span>
    <span class="hljs-keyword">val</span> list = flow.toList()
    println(<span class="hljs-string">"列表: <span class="hljs-variable">$list</span>"</span>)

    <span class="hljs-comment">// 收集方式3: first - 只取第一个</span>
    <span class="hljs-keyword">val</span> first = flow.first()
    println(<span class="hljs-string">"第一个: <span class="hljs-variable">$first</span>"</span>)

    <span class="hljs-comment">// 收集方式4: reduce - 聚合</span>
    <span class="hljs-keyword">val</span> sum = flow.reduce { acc, value -&gt; acc + value }
    println(<span class="hljs-string">"总和: <span class="hljs-variable">$sum</span>"</span>)
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Flow开始</span>
<span class="hljs-comment">// 收到: 1</span>
<span class="hljs-comment">// 收到: 2</span>
<span class="hljs-comment">// 收到: 3</span>
</code></pre>
<h3 data-id="heading-5">Flow是冷流</h3>
<p>Flow是<strong>冷流（Cold Stream）</strong>，意味着：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> flow = flow {
        println(<span class="hljs-string">"Flow开始执行"</span>)
        emit(<span class="hljs-number">1</span>)
        emit(<span class="hljs-number">2</span>)
    }

    println(<span class="hljs-string">"Flow创建完成"</span>)
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"准备收集"</span>)

    flow.collect { println(<span class="hljs-string">"值: <span class="hljs-variable">$it</span>"</span>) }
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Flow创建完成</span>
<span class="hljs-comment">// 准备收集（1秒后）</span>
<span class="hljs-comment">// Flow开始执行  ← 注意：这里才开始执行</span>
<span class="hljs-comment">// 值: 1</span>
<span class="hljs-comment">// 值: 2</span>
</code></pre>
<p><strong>冷流特点</strong>：</p>
<ul>
<li>只有调用<code>collect</code>才开始执行</li>
<li>每次收集都重新执行</li>
<li>不同收集器互不影响</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> flow = flow {
        println(<span class="hljs-string">"Flow执行"</span>)
        emit(Random.nextInt())
    }

    <span class="hljs-comment">// 两次收集，Flow执行两次</span>
    flow.collect { println(<span class="hljs-string">"收集器1: <span class="hljs-variable">$it</span>"</span>) }
    flow.collect { println(<span class="hljs-string">"收集器2: <span class="hljs-variable">$it</span>"</span>) }
}

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// Flow执行</span>
<span class="hljs-comment">// 收集器1: 12345</span>
<span class="hljs-comment">// Flow执行  ← 再次执行</span>
<span class="hljs-comment">// 收集器2: 67890</span>
</code></pre>
<h2 data-id="heading-6">Flow操作符</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1efa5b1de154c179c17e6ce48092757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600962&amp;x-signature=l%2BXTShxo0tW8ySQK5ioMqOBMt0E%3D" alt="11-01-flow-operators.png" loading="lazy"/></p>
<h3 data-id="heading-7">转换操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// map - 转换每个元素</span>
flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
    emit(<span class="hljs-number">3</span>)
}.map { it * <span class="hljs-number">2</span> }
 .collect { println(it) }  <span class="hljs-comment">// 2, 4, 6</span>

<span class="hljs-comment">// filter - 过滤</span>
flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
    emit(<span class="hljs-number">3</span>)
}.filter { it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> }
 .collect { println(it) }  <span class="hljs-comment">// 2</span>

<span class="hljs-comment">// transform - 自定义转换（可以emit多次）</span>
flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
}.transform { value -&gt;
    emit(<span class="hljs-string">"开始: <span class="hljs-variable">$value</span>"</span>)
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-string">"结束: <span class="hljs-variable">$value</span>"</span>)
}.collect { println(it) }
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 开始: 1</span>
<span class="hljs-comment">// 结束: 1</span>
<span class="hljs-comment">// 开始: 2</span>
<span class="hljs-comment">// 结束: 2</span>

<span class="hljs-comment">// flatMapConcat - 顺序展平</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .flatMapConcat { value -&gt;
        flow {
            emit(<span class="hljs-string">"<span class="hljs-variable">$value</span>-a"</span>)
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-string">"<span class="hljs-variable">$value</span>-b"</span>)
        }
    }
    .collect { println(it) }
<span class="hljs-comment">// 输出：1-a, 1-b, 2-a, 2-b, 3-a, 3-b</span>

<span class="hljs-comment">// flatMapMerge - 并发展平（最多并发数）</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .flatMapMerge(concurrency = <span class="hljs-number">2</span>) { value -&gt;
        flow {
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-string">"<span class="hljs-variable">$value</span>"</span>)
        }
    }
    .collect { println(it) }
<span class="hljs-comment">// 输出顺序不定（并发执行）</span>
</code></pre>
<h3 data-id="heading-8">限流操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// take - 只取前N个</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    .take(<span class="hljs-number">3</span>)
    .collect { println(it) }  <span class="hljs-comment">// 1, 2, 3</span>

<span class="hljs-comment">// drop - 跳过前N个</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    .drop(<span class="hljs-number">2</span>)
    .collect { println(it) }  <span class="hljs-comment">// 3, 4, 5</span>

<span class="hljs-comment">// debounce - 防抖（只取最后一个）</span>
flow {
    emit(<span class="hljs-number">1</span>)
    delay(<span class="hljs-number">90</span>)
    emit(<span class="hljs-number">2</span>)
    delay(<span class="hljs-number">90</span>)
    emit(<span class="hljs-number">3</span>)
    delay(<span class="hljs-number">1000</span>)
    emit(<span class="hljs-number">4</span>)
}.debounce(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 100ms内的连续emit，只保留最后一个</span>
 .collect { println(it) }  <span class="hljs-comment">// 3, 4</span>

<span class="hljs-comment">// sample - 采样（固定时间取一个）</span>
flow {
    repeat(<span class="hljs-number">10</span>) {
        emit(it)
        delay(<span class="hljs-number">110</span>)
    }
}.sample(<span class="hljs-number">300</span>)  <span class="hljs-comment">// 每300ms采样一个</span>
 .collect { println(it) }  <span class="hljs-comment">// 0, 2, 5, 8</span>
</code></pre>
<h3 data-id="heading-9">组合操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// zip - 配对组合</span>
<span class="hljs-keyword">val</span> flow1 = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
<span class="hljs-keyword">val</span> flow2 = flowOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)
flow1.zip(flow2) { a, b -&gt; <span class="hljs-string">"<span class="hljs-variable">$a</span>-<span class="hljs-variable">$b</span>"</span> }
    .collect { println(it) }  <span class="hljs-comment">// 1-A, 2-B, 3-C</span>

<span class="hljs-comment">// combine - 组合最新值（任一更新都emit）</span>
<span class="hljs-keyword">val</span> numbers = flow {
    emit(<span class="hljs-number">1</span>)
    delay(<span class="hljs-number">100</span>)
    emit(<span class="hljs-number">2</span>)
}
<span class="hljs-keyword">val</span> strings = flow {
    emit(<span class="hljs-string">"A"</span>)
    delay(<span class="hljs-number">150</span>)
    emit(<span class="hljs-string">"B"</span>)
}
numbers.combine(strings) { num, str -&gt; <span class="hljs-string">"<span class="hljs-variable">$num</span>-<span class="hljs-variable">$str</span>"</span> }
    .collect { println(it) }
<span class="hljs-comment">// 输出：1-A, 2-A, 2-B</span>
</code></pre>
<h3 data-id="heading-10">展平操作符对比</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// flatMapConcat - 顺序执行</span>
<span class="hljs-comment">// Flow1 → [a, b] → Flow2 → [c, d]</span>
<span class="hljs-comment">// 结果: a, b, c, d（顺序）</span>

<span class="hljs-comment">// flatMapMerge - 并发执行</span>
<span class="hljs-comment">// Flow1 → [a, b]</span>
<span class="hljs-comment">// Flow2 → [c, d]  并发</span>
<span class="hljs-comment">// 结果: a, c, b, d（乱序）</span>

<span class="hljs-comment">// flatMapLatest - 只保留最新</span>
<span class="hljs-comment">// Flow1 → [a, b]</span>
<span class="hljs-comment">// Flow2 → [c, d]  ← 新Flow取消旧Flow</span>
<span class="hljs-comment">// 结果: a, c, d（b被取消）</span>
</code></pre>
<h2 data-id="heading-11">异常处理</h2>
<h3 data-id="heading-12">catch操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"出错了！"</span>)
    emit(<span class="hljs-number">3</span>)  <span class="hljs-comment">// 不会执行</span>
}.<span class="hljs-keyword">catch</span> { e -&gt;
    println(<span class="hljs-string">"捕获异常: <span class="hljs-subst">${e.message}</span>"</span>)
    emit(-<span class="hljs-number">1</span>)  <span class="hljs-comment">// 可以发射默认值</span>
}.collect { println(it) }

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// 捕获异常: 出错了！</span>
<span class="hljs-comment">// -1</span>
</code></pre>
<p><strong>注意</strong>：<code>catch</code>只能捕获<strong>上游</strong>的异常：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
}.<span class="hljs-keyword">catch</span> { e -&gt;
    println(<span class="hljs-string">"不会执行"</span>)
}.collect { value -&gt;
    <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"这个异常catch捕获不到"</span>)
}
</code></pre>
<h3 data-id="heading-13">onCompletion</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
}.onCompletion { cause -&gt;
    <span class="hljs-keyword">if</span> (cause != <span class="hljs-literal">null</span>) {
        println(<span class="hljs-string">"Flow异常完成: <span class="hljs-variable">$cause</span>"</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"Flow正常完成"</span>)
    }
}.collect { println(it) }

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 1</span>
<span class="hljs-comment">// 2</span>
<span class="hljs-comment">// Flow正常完成</span>
</code></pre>
<h3 data-id="heading-14">retry与retryWhen</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> attempts = <span class="hljs-number">0</span>

flow {
    attempts++
    println(<span class="hljs-string">"尝试 <span class="hljs-variable">$attempts</span>"</span>)
    <span class="hljs-keyword">if</span> (attempts &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">throw</span> IOException(<span class="hljs-string">"网络错误"</span>)
    }
    emit(<span class="hljs-string">"成功"</span>)
}.retry(<span class="hljs-number">3</span>) { cause -&gt;
    (cause <span class="hljs-keyword">is</span> IOException).also {
        <span class="hljs-keyword">if</span> (it) delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 重试前等待1秒</span>
    }
}.collect { println(it) }

<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 尝试 1</span>
<span class="hljs-comment">// 尝试 2</span>
<span class="hljs-comment">// 尝试 3</span>
<span class="hljs-comment">// 成功</span>
</code></pre>
<h2 data-id="heading-15">线程切换与上下文</h2>
<h3 data-id="heading-16">flowOn操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    println(<span class="hljs-string">"Flow运行在: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
    emit(fetchFromNetwork())
}.flowOn(Dispatchers.IO)  <span class="hljs-comment">// ← 上游运行在IO线程</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    loadData()
        .map { <span class="hljs-keyword">data</span> -&gt;
            println(<span class="hljs-string">"map运行在: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
            <span class="hljs-keyword">data</span>.uppercase()
        }
        .flowOn(Dispatchers.Default)  <span class="hljs-comment">// ← map运行在Default线程</span>
        .collect { <span class="hljs-keyword">data</span> -&gt;
            println(<span class="hljs-string">"collect运行在: <span class="hljs-subst">${Thread.currentThread().name}</span>"</span>)
            updateUI(<span class="hljs-keyword">data</span>)
        }  <span class="hljs-comment">// collect运行在Main线程</span>
}
</code></pre>
<p><strong>重要规则</strong>：</p>
<ul>
<li><code>flowOn</code>影响<strong>上游</strong>操作符</li>
<li>可以多次调用<code>flowOn</code>切换不同上下文</li>
<li><code>collect</code>运行在调用协程的上下文</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef6a9db4e9a743c6a3cc95863637d846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600962&amp;x-signature=EWF3piRAX%2F2%2BxoF7KzU4LmxFzWo%3D" alt="11-02-flow-threading.png" loading="lazy"/></p>
<h2 data-id="heading-17">StateFlow：可观察状态</h2>
<h3 data-id="heading-18">StateFlow vs Flow</h3>
<p><strong>StateFlow</strong>是Flow的特殊版本，特点：</p>
<ol>
<li><strong>热流</strong>：始终有值，立即发射当前状态</li>
<li><strong>状态保持</strong>：保存最新值</li>
<li><strong>去重</strong>：相同值不会重复发射</li>
<li><strong>线程安全</strong>：可以从多个协程读写</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// StateFlow示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _count = MutableStateFlow(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">val</span> count: StateFlow&lt;<span class="hljs-built_in">Int</span>&gt; = _count.asStateFlow()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        _count.value++  <span class="hljs-comment">// 更新状态</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> viewModel = CounterViewModel()

<span class="hljs-comment">// 收集器1</span>
launch {
    viewModel.count.collect { count -&gt;
        println(<span class="hljs-string">"收集器1: <span class="hljs-variable">$count</span>"</span>)
    }
}

<span class="hljs-comment">// 收集器2</span>
launch {
    viewModel.count.collect { count -&gt;
        println(<span class="hljs-string">"收集器2: <span class="hljs-variable">$count</span>"</span>)
    }
}

viewModel.increment()  <span class="hljs-comment">// 两个收集器都会收到更新</span>
</code></pre>
<h3 data-id="heading-19">StateFlow的特点</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(<span class="hljs-string">"初始值"</span>)

<span class="hljs-comment">// 1. 立即发射当前值</span>
launch {
    stateFlow.collect { println(it) }  <span class="hljs-comment">// 立即输出：初始值</span>
}

<span class="hljs-comment">// 2. 去重（相同值不会重复emit）</span>
stateFlow.value = <span class="hljs-string">"新值"</span>   <span class="hljs-comment">// ✅ emit</span>
stateFlow.value = <span class="hljs-string">"新值"</span>   <span class="hljs-comment">// ❌ 不emit（值相同）</span>
stateFlow.value = <span class="hljs-string">"更新值"</span> <span class="hljs-comment">// ✅ emit</span>

<span class="hljs-comment">// 3. 获取当前值</span>
println(<span class="hljs-string">"当前值: <span class="hljs-subst">${stateFlow.value}</span>"</span>)
</code></pre>
<h3 data-id="heading-20">StateFlow实战：用户状态管理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserState</span> {
    <span class="hljs-keyword">object</span> Loading : UserState()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> user: User) : UserState()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UserState()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _userState = MutableStateFlow&lt;UserState&gt;(UserState.Loading)
    <span class="hljs-keyword">val</span> userState: StateFlow&lt;UserState&gt; = _userState.asStateFlow()

    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
        _userState.value = UserState.Loading

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> user = api.fetchUser(userId)
            _userState.value = UserState.Success(user)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            _userState.value = UserState.Error(e.message ?: <span class="hljs-string">"未知错误"</span>)
        }
    }
}

<span class="hljs-comment">// ViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository
) : ViewModel() {
    <span class="hljs-keyword">val</span> userState = repository.userState
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
            initialValue = UserState.Loading
        )

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
        viewModelScope.launch {
            repository.loadUser(userId)
        }
    }
}

<span class="hljs-comment">// UI收集</span>
lifecycleScope.launch {
    viewModel.userState.collect { state -&gt;
        <span class="hljs-keyword">when</span> (state) {
            <span class="hljs-keyword">is</span> UserState.Loading -&gt; showLoading()
            <span class="hljs-keyword">is</span> UserState.Success -&gt; showUser(state.user)
            <span class="hljs-keyword">is</span> UserState.Error -&gt; showError(state.message)
        }
    }
}
</code></pre>
<h2 data-id="heading-21">SharedFlow：事件广播</h2>
<h3 data-id="heading-22">SharedFlow vs StateFlow</h3>






























<table><thead><tr><th align="left">特性</th><th align="left">StateFlow</th><th align="left">SharedFlow</th></tr></thead><tbody><tr><td align="left"><strong>保存值</strong></td><td align="left">✅ 保存最新值</td><td align="left">❌ 可配置（replay）</td></tr><tr><td align="left"><strong>立即发射</strong></td><td align="left">✅ 新收集器立即收到当前值</td><td align="left">❌ 只收到新事件</td></tr><tr><td align="left"><strong>去重</strong></td><td align="left">✅ 相同值不重复emit</td><td align="left">❌ 不去重</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">状态管理</td><td align="left">事件通知</td></tr></tbody></table>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SharedFlow示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EventBus</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _events = MutableSharedFlow&lt;String&gt;()
    <span class="hljs-keyword">val</span> events: SharedFlow&lt;String&gt; = _events.asSharedFlow()

    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendEvent</span><span class="hljs-params">(event: <span class="hljs-type">String</span>)</span></span> {
        _events.emit(event)
    }
}

<span class="hljs-keyword">val</span> eventBus = EventBus()

<span class="hljs-comment">// 收集器1</span>
launch {
    eventBus.events.collect { event -&gt;
        println(<span class="hljs-string">"收集器1收到: <span class="hljs-variable">$event</span>"</span>)
    }
}

delay(<span class="hljs-number">100</span>)

<span class="hljs-comment">// 收集器2（稍后订阅）</span>
launch {
    eventBus.events.collect { event -&gt;
        println(<span class="hljs-string">"收集器2收到: <span class="hljs-variable">$event</span>"</span>)
    }
}

eventBus.sendEvent(<span class="hljs-string">"事件1"</span>)  <span class="hljs-comment">// 两个收集器都收到</span>
</code></pre>
<h3 data-id="heading-23">SharedFlow配置</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> sharedFlow = MutableSharedFlow&lt;<span class="hljs-built_in">Int</span>&gt;(
    replay = <span class="hljs-number">2</span>,        <span class="hljs-comment">// 保留最近2个值给新订阅者</span>
    extraBufferCapacity = <span class="hljs-number">10</span>,  <span class="hljs-comment">// 额外缓冲容量</span>
    onBufferOverflow = BufferOverflow.DROP_OLDEST  <span class="hljs-comment">// 缓冲满时丢弃最旧的</span>
)

<span class="hljs-comment">// 发射5个值</span>
repeat(<span class="hljs-number">5</span>) { sharedFlow.emit(it) }

<span class="hljs-comment">// 新订阅者会收到最近2个值（3和4）</span>
sharedFlow.collect { println(it) }  <span class="hljs-comment">// 3, 4, ...</span>
</code></pre>
<h3 data-id="heading-24">SharedFlow实战：Toast通知</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToastManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _toastMessages = MutableSharedFlow&lt;String&gt;(
        replay = <span class="hljs-number">0</span>,  <span class="hljs-comment">// 不保留历史消息</span>
        extraBufferCapacity = <span class="hljs-number">10</span>,
        onBufferOverflow = BufferOverflow.DROP_OLDEST
    )
    <span class="hljs-keyword">val</span> toastMessages: SharedFlow&lt;String&gt; = _toastMessages.asSharedFlow()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showToast</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-comment">// tryEmit不挂起，适合从非协程代码调用</span>
        _toastMessages.tryEmit(message)
    }
}

<span class="hljs-comment">// Activity中收集</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> toastManager = ToastManager()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        lifecycleScope.launch {
            toastManager.toastMessages.collect { message -&gt;
                Toast.makeText(<span class="hljs-keyword">this</span><span class="hljs-symbol">@MainActivity</span>, message, Toast.LENGTH_SHORT).show()
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-25">Channel：协程间通信</h2>
<h3 data-id="heading-26">Channel基础</h3>
<p><strong>Channel</strong>是协程之间通信的管道，类似于阻塞队列：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> channel = Channel&lt;<span class="hljs-built_in">Int</span>&gt;()

<span class="hljs-comment">// 发送方协程</span>
launch {
    <span class="hljs-keyword">for</span> (x <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.5</span>) {
        println(<span class="hljs-string">"发送: <span class="hljs-variable">$x</span>"</span>)
        channel.send(x)  <span class="hljs-comment">// 挂起直到有接收方</span>
    }
    channel.close()  <span class="hljs-comment">// 关闭通道</span>
}

<span class="hljs-comment">// 接收方协程</span>
launch {
    <span class="hljs-keyword">for</span> (x <span class="hljs-keyword">in</span> channel) {  <span class="hljs-comment">// 迭代接收</span>
        println(<span class="hljs-string">"接收: <span class="hljs-variable">$x</span>"</span>)
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 模拟处理</span>
    }
}
</code></pre>
<h3 data-id="heading-27">Channel类型</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60f1b0001690448dbdf5acb2f0dae610~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769600962&amp;x-signature=5HWwgmvCOB21wvx3NIRidju34n0%3D" alt="11-03-channel-types.png" loading="lazy"/></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. Rendezvous（默认）- 无缓冲</span>
<span class="hljs-keyword">val</span> channel1 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;()
<span class="hljs-comment">// 发送方挂起，直到接收方ready</span>

<span class="hljs-comment">// 2. Buffered - 有缓冲</span>
<span class="hljs-keyword">val</span> channel2 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;(<span class="hljs-number">10</span>)
<span class="hljs-comment">// 缓冲未满时不挂起</span>

<span class="hljs-comment">// 3. Unlimited - 无限缓冲</span>
<span class="hljs-keyword">val</span> channel3 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;(Channel.UNLIMITED)
<span class="hljs-comment">// send永不挂起（可能OOM）</span>

<span class="hljs-comment">// 4. Conflated - 保留最新</span>
<span class="hljs-keyword">val</span> channel4 = Channel&lt;<span class="hljs-built_in">Int</span>&gt;(Channel.CONFLATED)
<span class="hljs-comment">// 只保留最新值，旧值被覆盖</span>
</code></pre>
<h3 data-id="heading-28">Channel vs Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Channel示例</span>
<span class="hljs-keyword">val</span> channel = Channel&lt;<span class="hljs-built_in">Int</span>&gt;()
launch {
    channel.send(<span class="hljs-number">1</span>)
    channel.send(<span class="hljs-number">2</span>)
}
launch {
    println(channel.receive())  <span class="hljs-comment">// 1</span>
}
launch {
    println(channel.receive())  <span class="hljs-comment">// 2（被另一个协程接收）</span>
}

<span class="hljs-comment">// Flow示例</span>
<span class="hljs-keyword">val</span> flow = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
launch {
    flow.collect { println(it) }  <span class="hljs-comment">// 1, 2</span>
}
launch {
    flow.collect { println(it) }  <span class="hljs-comment">// 1, 2（每个收集器独立）</span>
}
</code></pre>
<p><strong>对比</strong>：</p>






























<table><thead><tr><th align="left">特性</th><th align="left">Channel</th><th align="left">Flow</th></tr></thead><tbody><tr><td align="left"><strong>消费</strong></td><td align="left">热流，多消费者竞争</td><td align="left">冷流，每个收集器独立</td></tr><tr><td align="left"><strong>背压</strong></td><td align="left">通过缓冲和挂起</td><td align="left">内置背压处理</td></tr><tr><td align="left"><strong>关闭</strong></td><td align="left">需要手动关闭</td><td align="left">自动管理</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">协程间通信</td><td align="left">数据流处理</td></tr></tbody></table>
<h3 data-id="heading-29">Channel实战：生产者消费者</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 生产者</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produceNumbers</span><span class="hljs-params">()</span></span> = produce&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">var</span> x = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        send(x++)
        delay(<span class="hljs-number">100</span>)
    }
}

<span class="hljs-comment">// 消费者</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">squareNumbers</span><span class="hljs-params">(numbers: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> = produce&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">for</span> (x <span class="hljs-keyword">in</span> numbers) {
        send(x * x)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> numbers = produceNumbers()
    <span class="hljs-keyword">val</span> squares = squareNumbers(numbers)

    repeat(<span class="hljs-number">5</span>) {
        println(squares.receive())
    }

    coroutineContext.cancelChildren()  <span class="hljs-comment">// 取消所有</span>
}

<span class="hljs-comment">// 输出：1, 4, 9, 16, 25</span>
</code></pre>
<h3 data-id="heading-30">管道模式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 管道函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">pipeline</span><span class="hljs-params">(
    input: <span class="hljs-type">ReceiveChannel</span>&lt;<span class="hljs-type">Int</span>&gt;
)</span></span> = produce&lt;String&gt; {
    <span class="hljs-keyword">for</span> (num <span class="hljs-keyword">in</span> input) {
        send(<span class="hljs-string">"Processed: <span class="hljs-variable">$num</span>"</span>)
    }
}

<span class="hljs-comment">// 使用管道</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> numbers = produce {
        repeat(<span class="hljs-number">5</span>) { send(it) }
    }

    <span class="hljs-keyword">val</span> processed = pipeline(numbers)

    <span class="hljs-keyword">for</span> (result <span class="hljs-keyword">in</span> processed) {
        println(result)
    }
}
</code></pre>
<h2 data-id="heading-31">背压处理</h2>
<h3 data-id="heading-32">什么是背压？</h3>
<p><strong>背压（Backpressure）</strong>：生产者速度快于消费者时的处理策略。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 问题：生产快，消费慢</span>
flow {
    repeat(<span class="hljs-number">100</span>) {
        println(<span class="hljs-string">"发射: <span class="hljs-variable">$it</span>"</span>)
        emit(it)
        delay(<span class="hljs-number">10</span>)  <span class="hljs-comment">// 快速发射</span>
    }
}.collect { value -&gt;
    println(<span class="hljs-string">"收集: <span class="hljs-variable">$value</span>"</span>)
    delay(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 慢速收集</span>
}
</code></pre>
<h3 data-id="heading-33">Flow的背压策略</h3>
<h4 data-id="heading-34">1. buffer - 缓冲</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        delay(<span class="hljs-number">10</span>)
    }
}.buffer(<span class="hljs-number">50</span>)  <span class="hljs-comment">// 缓冲50个元素</span>
 .collect { value -&gt;
     delay(<span class="hljs-number">100</span>)
     println(value)
 }
</code></pre>
<h4 data-id="heading-35">2. conflate - 合并（只保留最新）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        delay(<span class="hljs-number">10</span>)
    }
}.conflate()  <span class="hljs-comment">// 消费慢时，跳过中间值</span>
 .collect { value -&gt;
     delay(<span class="hljs-number">100</span>)
     println(value)
 }
<span class="hljs-comment">// 输出可能是：0, 10, 20, ..., 90（跳过中间值）</span>
</code></pre>
<h4 data-id="heading-36">3. collectLatest - 只处理最新</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        delay(<span class="hljs-number">10</span>)
    }
}.collectLatest { value -&gt;
    println(<span class="hljs-string">"开始处理: <span class="hljs-variable">$value</span>"</span>)
    delay(<span class="hljs-number">100</span>)
    println(<span class="hljs-string">"处理完成: <span class="hljs-variable">$value</span>"</span>)  <span class="hljs-comment">// 可能被中断</span>
}
<span class="hljs-comment">// 输出：只有最后几个值被完整处理</span>
</code></pre>
<h3 data-id="heading-37">对比三种策略</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// buffer：缓冲所有，按顺序处理</span>
flow {
    (<span class="hljs-number">1.</span><span class="hljs-number">.5</span>).forEach {
        delay(<span class="hljs-number">100</span>)
        emit(it)
    }
}.buffer()
 .collect {
     delay(<span class="hljs-number">300</span>)
     println(it)  <span class="hljs-comment">// 1, 2, 3, 4, 5（全部处理）</span>
 }

<span class="hljs-comment">// conflate：跳过中间值</span>
flow {
    (<span class="hljs-number">1.</span><span class="hljs-number">.5</span>).forEach {
        delay(<span class="hljs-number">100</span>)
        emit(it)
    }
}.conflate()
 .collect {
     delay(<span class="hljs-number">300</span>)
     println(it)  <span class="hljs-comment">// 1, 4, 5（跳过2, 3）</span>
 }

<span class="hljs-comment">// collectLatest：只处理最新值</span>
flow {
    (<span class="hljs-number">1.</span><span class="hljs-number">.5</span>).forEach {
        delay(<span class="hljs-number">100</span>)
        emit(it)
    }
}.collectLatest {
    println(<span class="hljs-string">"开始: <span class="hljs-variable">$it</span>"</span>)
    delay(<span class="hljs-number">300</span>)
    println(<span class="hljs-string">"完成: <span class="hljs-variable">$it</span>"</span>)  <span class="hljs-comment">// 只有5完成</span>
}
</code></pre>
<h2 data-id="heading-38">实战案例：实时搜索</h2>
<p>让我们构建一个实时搜索功能，结合debounce和distinctUntilChanged：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _searchQuery = MutableStateFlow(<span class="hljs-string">""</span>)

    <span class="hljs-comment">// 搜索结果Flow</span>
    <span class="hljs-keyword">val</span> searchResults: StateFlow&lt;List&lt;String&gt;&gt; = _searchQuery
        .debounce(<span class="hljs-number">300</span>)  <span class="hljs-comment">// 防抖：300ms内的连续输入只取最后一次</span>
        .distinctUntilChanged()  <span class="hljs-comment">// 去重：相同查询不重复搜索</span>
        .filter { it.length &gt;= <span class="hljs-number">2</span> }  <span class="hljs-comment">// 过滤：至少2个字符</span>
        .flatMapLatest { query -&gt;  <span class="hljs-comment">// 切换：新查询取消旧查询</span>
            flow {
                emit(emptyList())  <span class="hljs-comment">// 先清空结果</span>
                emit(performSearch(query))  <span class="hljs-comment">// 执行搜索</span>
            }
        }
        .<span class="hljs-keyword">catch</span> { e -&gt;
            emit(emptyList())  <span class="hljs-comment">// 错误时返回空列表</span>
        }
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
            initialValue = emptyList()
        )

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateQuery</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        _searchQuery.value = query
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">performSearch</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span>: List&lt;String&gt; {
        delay(<span class="hljs-number">500</span>)  <span class="hljs-comment">// 模拟网络请求</span>
        <span class="hljs-keyword">return</span> listOf(<span class="hljs-string">"<span class="hljs-variable">$query</span> - 结果1"</span>, <span class="hljs-string">"<span class="hljs-variable">$query</span> - 结果2"</span>)
    }
}

<span class="hljs-comment">// UI层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel: SearchViewModel <span class="hljs-keyword">by</span> viewModels()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        <span class="hljs-comment">// 监听输入</span>
        searchEditText.addTextChangedListener { text -&gt;
            viewModel.updateQuery(text.toString())
        }

        <span class="hljs-comment">// 收集结果</span>
        lifecycleScope.launch {
            viewModel.searchResults.collect { results -&gt;
                updateSearchResults(results)
            }
        }
    }
}
</code></pre>
<p><strong>这个实现的优势</strong>：</p>
<ol>
<li><strong>防抖</strong>：避免频繁搜索</li>
<li><strong>去重</strong>：相同查询不重复</li>
<li><strong>取消旧请求</strong>：新查询自动取消旧请求</li>
<li><strong>异常处理</strong>：错误时返回空列表</li>
<li><strong>自动管理</strong>：生命周期自动管理</li>
</ol>
<h2 data-id="heading-39">高级技巧</h2>
<h3 data-id="heading-40">1. 组合多个Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 场景：用户信息 + 好友列表 + 帖子列表</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userId = MutableStateFlow(<span class="hljs-string">"user123"</span>)

    <span class="hljs-keyword">val</span> profileData = combine(
        userId.flatMapLatest { id -&gt; loadUser(id) },
        userId.flatMapLatest { id -&gt; loadFriends(id) },
        userId.flatMapLatest { id -&gt; loadPosts(id) }
    ) { user, friends, posts -&gt;
        ProfileData(user, friends, posts)
    }.stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        initialValue = ProfileData.Loading
    )
}
</code></pre>
<h3 data-id="heading-41">2. Flow的测试</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowTest</span> {
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> `test flow emissions`<span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-keyword">val</span> flow = flow {
            emit(<span class="hljs-number">1</span>)
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-number">2</span>)
            delay(<span class="hljs-number">100</span>)
            emit(<span class="hljs-number">3</span>)
        }

        <span class="hljs-keyword">val</span> results = flow.toList()
        assertEquals(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>), results)
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> `test StateFlow`<span class="hljs-params">()</span></span> = runTest {
        <span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(<span class="hljs-number">0</span>)

        <span class="hljs-keyword">val</span> job = launch {
            stateFlow.emit(<span class="hljs-number">1</span>)
            delay(<span class="hljs-number">100</span>)
            stateFlow.emit(<span class="hljs-number">2</span>)
        }

        <span class="hljs-keyword">val</span> results = stateFlow.take(<span class="hljs-number">3</span>).toList()
        assertEquals(listOf(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>), results)

        job.cancel()
    }
}
</code></pre>
<h3 data-id="heading-42">3. 自定义操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义操作符：mapNotNull</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">mapNotNull</span><span class="hljs-params">(
    transform: <span class="hljs-type">suspend</span> (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>?
)</span></span>: Flow&lt;R&gt; = transform { value -&gt;
    transform(value)?.let { emit(it) }
}

<span class="hljs-comment">// 使用</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)
    .mapNotNull { <span class="hljs-keyword">if</span> (it % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) it * <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span> }
    .collect { println(it) }  <span class="hljs-comment">// 4, 8</span>
</code></pre>
<h2 data-id="heading-43">常见陷阱与最佳实践</h2>
<h3 data-id="heading-44">❌ 陷阱1：在collect中调用emit</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：collect中不能调用emit</span>
flow {
    emit(<span class="hljs-number">1</span>)
}.collect { value -&gt;
    emit(value * <span class="hljs-number">2</span>)  <span class="hljs-comment">// ❌ 编译错误</span>
}

<span class="hljs-comment">// ✅ 正确：使用transform</span>
flow {
    emit(<span class="hljs-number">1</span>)
}.transform { value -&gt;
    emit(value * <span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ transform中可以</span>
}.collect { println(it) }
</code></pre>
<h3 data-id="heading-45">❌ 陷阱2：忘记切换线程</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：IO操作在Main线程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchFromNetwork()  <span class="hljs-comment">// ❌ 阻塞Main线程</span>
    emit(<span class="hljs-keyword">data</span>)
}

<span class="hljs-comment">// ✅ 正确：使用flowOn切换线程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchFromNetwork()
    emit(<span class="hljs-keyword">data</span>)
}.flowOn(Dispatchers.IO)  <span class="hljs-comment">// ✅ IO操作在IO线程</span>
</code></pre>
<h3 data-id="heading-46">❌ 陷阱3：StateFlow不会emit相同值</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(<span class="hljs-number">1</span>)

stateFlow.value = <span class="hljs-number">2</span>  <span class="hljs-comment">// ✅ emit</span>
stateFlow.value = <span class="hljs-number">2</span>  <span class="hljs-comment">// ❌ 不emit（值相同）</span>

<span class="hljs-comment">// 解决方案1：使用SharedFlow</span>
<span class="hljs-keyword">val</span> sharedFlow = MutableSharedFlow&lt;<span class="hljs-built_in">Int</span>&gt;()
sharedFlow.emit(<span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ emit</span>
sharedFlow.emit(<span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ 仍然emit</span>

<span class="hljs-comment">// 解决方案2：强制更新</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-keyword">val</span> value: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> timestamp: <span class="hljs-built_in">Long</span> = System.currentTimeMillis())
<span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(State(<span class="hljs-number">1</span>))
stateFlow.value = State(<span class="hljs-number">2</span>)  <span class="hljs-comment">// ✅ emit（timestamp不同）</span>
</code></pre>
<h3 data-id="heading-47">✅ 最佳实践1：使用sealed class表示状态</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiState</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">object</span> Loading : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : UiState&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow&lt;UiState&lt;User&gt;&gt;(UiState.Loading)
    <span class="hljs-keyword">val</span> uiState: StateFlow&lt;UiState&lt;User&gt;&gt; = _uiState.asStateFlow()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            _uiState.value = UiState.Loading
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> user = repository.loadUser()
                _uiState.value = UiState.Success(user)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _uiState.value = UiState.Error(e.message ?: <span class="hljs-string">"未知错误"</span>)
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-48">✅ 最佳实践2：使用stateIn转换Flow为StateFlow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 避免：每次collect都重新执行</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUsers</span><span class="hljs-params">()</span></span>: Flow&lt;List&lt;User&gt;&gt; = flow {
    emit(repository.getUsers())  <span class="hljs-comment">// 每次collect都查询数据库</span>
}

<span class="hljs-comment">// ✅ 推荐：使用stateIn共享结果</span>
<span class="hljs-keyword">val</span> users: StateFlow&lt;List&lt;User&gt;&gt; = loadUsers()
    .stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
        initialValue = emptyList()
    )
</code></pre>
<h3 data-id="heading-49">✅ 最佳实践3：使用shareIn实现热流</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 场景：多个订阅者共享同一个网络请求</span>
<span class="hljs-keyword">val</span> sharedData: SharedFlow&lt;Data&gt; = flow {
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchFromNetwork()  <span class="hljs-comment">// 只执行一次</span>
    emit(<span class="hljs-keyword">data</span>)
}.shareIn(
    scope = viewModelScope,
    started = SharingStarted.WhileSubscribed(),
    replay = <span class="hljs-number">1</span>  <span class="hljs-comment">// 新订阅者会收到最后一个值</span>
)
</code></pre>
<h2 data-id="heading-50">性能优化</h2>
<h3 data-id="heading-51">1. 选择合适的Flow类型</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 状态 → StateFlow</span>
<span class="hljs-keyword">val</span> userState: StateFlow&lt;User&gt; = ...

<span class="hljs-comment">// 事件 → SharedFlow</span>
<span class="hljs-keyword">val</span> clickEvents: SharedFlow&lt;<span class="hljs-built_in">Unit</span>&gt; = ...

<span class="hljs-comment">// 一次性数据流 → Flow</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadData</span><span class="hljs-params">()</span></span>: Flow&lt;Data&gt; = flow { ... }
</code></pre>
<h3 data-id="heading-52">2. 使用buffer提高吞吐量</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 无buffer：生产者等待消费者</span>
flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        println(<span class="hljs-string">"发射: <span class="hljs-variable">$it</span>"</span>)
    }
}.collect { value -&gt;
    delay(<span class="hljs-number">10</span>)
    println(<span class="hljs-string">"收集: <span class="hljs-variable">$value</span>"</span>)
}
<span class="hljs-comment">// 总耗时：约1000ms（100 * 10ms）</span>

<span class="hljs-comment">// 有buffer：生产者不等待</span>
flow {
    repeat(<span class="hljs-number">100</span>) {
        emit(it)
        println(<span class="hljs-string">"发射: <span class="hljs-variable">$it</span>"</span>)
    }
}.buffer(<span class="hljs-number">10</span>)
 .collect { value -&gt;
     delay(<span class="hljs-number">10</span>)
     println(<span class="hljs-string">"收集: <span class="hljs-variable">$value</span>"</span>)
 }
<span class="hljs-comment">// 总耗时：约100ms（并发执行）</span>
</code></pre>
<h3 data-id="heading-53">3. 避免不必要的操作符</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 避免：多次map</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .map { it * <span class="hljs-number">2</span> }
    .map { it + <span class="hljs-number">1</span> }
    .map { it.toString() }

<span class="hljs-comment">// ✅ 推荐：合并操作</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .map { (it * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>).toString() }
</code></pre>
<h2 data-id="heading-54">小结</h2>
<p>本文深入讲解了Kotlin协程的高级特性Flow和Channel：</p>
<h3 data-id="heading-55">核心概念</h3>
<ol>
<li><strong>Flow</strong>：冷流，异步数据流，支持丰富的操作符</li>
<li><strong>StateFlow</strong>：热流，可观察状态，去重，线程安全</li>
<li><strong>SharedFlow</strong>：热流，事件广播，支持多订阅者</li>
<li><strong>Channel</strong>：协程间通信管道，支持多种缓冲策略</li>
</ol>
<h3 data-id="heading-56">关键技能</h3>
<ol>
<li><strong>创建Flow</strong>：flow、flowOf、asFlow、channelFlow</li>
<li><strong>转换操作符</strong>：map、filter、transform、flatMap</li>
<li><strong>异常处理</strong>：catch、onCompletion、retry</li>
<li><strong>背压处理</strong>：buffer、conflate、collectLatest</li>
<li><strong>线程切换</strong>：flowOn切换上下文</li>
<li><strong>状态管理</strong>：StateFlow保存状态</li>
</ol>
<h3 data-id="heading-57">最佳实践</h3>
<ul>
<li>✅ 使用sealed class表示UI状态</li>
<li>✅ 使用stateIn/shareIn共享Flow</li>
<li>✅ 合理选择Flow类型（StateFlow vs SharedFlow）</li>
<li>✅ 使用flowOn切换线程</li>
<li>✅ 使用catch处理异常</li>
<li>✅ 合理使用背压策略</li>
</ul>
<h3 data-id="heading-58">下期预告</h3>
<p>下一篇文章《函数式编程在Kotlin中的实践》将介绍：</p>
<ul>
<li><strong>高阶函数</strong>：函数作为参数和返回值</li>
<li><strong>Lambda表达式</strong>：简洁的函数式编程</li>
<li><strong>扩展函数</strong>：增强类的能力</li>
<li><strong>内联函数</strong>：性能优化</li>
<li><strong>函数式集合操作</strong>：map、filter、reduce</li>
</ul>
<h2 data-id="heading-59">练习题</h2>
<h3 data-id="heading-60">基础练习</h3>
<p><strong>练习1</strong>：实现一个倒计时Flow</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">countdownFlow</span><span class="hljs-params">(from: <span class="hljs-type">Int</span>)</span></span>: Flow&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 从from倒数到0，每秒发射一个值</span>
}
</code></pre>
<p><strong>练习2</strong>：实现一个温度转换Flow</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">celsiusToFahrenheit</span><span class="hljs-params">(celsius: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">Double</span>&gt;)</span></span>: Flow&lt;<span class="hljs-built_in">Double</span>&gt; {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 将摄氏度转换为华氏度</span>
}
</code></pre>
<h3 data-id="heading-61">进阶练习</h3>
<p><strong>练习3</strong>：实现一个带重试的网络请求Flow</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">flowWithRetry</span><span class="hljs-params">(
    maxRetries: <span class="hljs-type">Int</span> = <span class="hljs-number">3</span>,
    delayMillis: <span class="hljs-type">Long</span> = <span class="hljs-number">1000</span>,
    block: <span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">T</span>
)</span></span>: Flow&lt;T&gt; {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 失败时自动重试</span>
}
</code></pre>
<p><strong>练习4</strong>：实现一个聊天消息管理器</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatManager</span> {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 使用StateFlow管理消息列表</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 使用SharedFlow广播新消息事件</span>
}
</code></pre>
<h2 data-id="heading-62">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fflow.html" target="_blank" title="https://kotlinlang.org/docs/flow.html" ref="nofollow noopener noreferrer">Kotlin Flow官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow%2Fstateflow-and-sharedflow" target="_blank" title="https://developer.android.com/kotlin/flow/stateflow-and-sharedflow" ref="nofollow noopener noreferrer">StateFlow和SharedFlow指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Felizarov.medium.com%2Fkotlin-flows-and-coroutines-256260fb3bdb" target="_blank" title="https://elizarov.medium.com/kotlin-flows-and-coroutines-256260fb3bdb" ref="nofollow noopener noreferrer">Flow背压处理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fkotlin%2Fflow" target="_blank" title="https://developer.android.com/kotlin/flow" ref="nofollow noopener noreferrer">Android中的异步数据流</a></li>
</ul>
<hr/>
<p><strong>系列文章导航:</strong></p>
<ul>
<li>👉 上一篇: <a href="https://juejin.cn/post/7597266141912465454" target="_blank" title="https://juejin.cn/post/7597266141912465454">协程原理与实战（上）：结构化并发让异步编程不再是噩梦</a></li>
</ul>
<hr/>
<p><em>如果这篇文章对你有帮助,欢迎点赞、收藏、分享!有任何问题或建议,欢迎在评论区留言讨论。让我们一起学习,一起成长!</em></p>
<p><em>也欢迎访问我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>发现更多宝藏资源</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 系统调试技巧 —— 使用 uprobe_events 分析用户态的行为]]></title>    <link>https://juejin.cn/post/7597635202324889652</link>    <guid>https://juejin.cn/post/7597635202324889652</guid>    <pubDate>2026-01-21T12:41:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324889652" data-draft-id="7597650322408030260" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 系统调试技巧 —— 使用 uprobe_events 分析用户态的行为"/> <meta itemprop="keywords" content="Android,Linux"/> <meta itemprop="datePublished" content="2026-01-21T12:41:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ADebugger"/> <meta itemprop="url" content="https://juejin.cn/user/1679709495362093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 系统调试技巧 —— 使用 uprobe_events 分析用户态的行为
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709495362093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ADebugger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:41:56.000Z" title="Wed Jan 21 2026 12:41:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在分析 Android 应用/系统的一些问题时，有时可能需要得知应用是否有直接或间接调用了系统的某个 native 函数，或调用某个函数时传入的参数情况。</p>
<h2 data-id="heading-1">uprobe_events 实战</h2>
<p>uprobe_events 是 Linux 内核提供的一种调试方案，可以跟踪一个用户态函数（或是函数内的某行代码）是否有被调用，以及函数入参等，详细介绍可阅览官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kernel.org%2Ftrace%2Fuprobetracer.html" target="_blank" title="https://docs.kernel.org/trace/uprobetracer.html" ref="nofollow noopener noreferrer">docs.kernel.org/trace/uprob…</a> ，本文主要关注如何快速使用 uprobe_events。</p>
<p>下面以跟踪系统内的进程都打开了什么文件为例，演示如何快速使用 uprobe_events。</p>
<h4 data-id="heading-2">step 1</h4>
<p>使用 readelf 获取 open64 函数在 libc.so 中的偏移量：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">flame:</span>/ # readelf -s /apex/com.android.runtime/lib64/bionic/libc.so | grep open64
   <span class="hljs-number">786</span>: <span class="hljs-number">000000000008</span>bc10   <span class="hljs-number">980</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> freopen64
   <span class="hljs-number">904</span>: <span class="hljs-number">000000000008</span>cb10   <span class="hljs-number">172</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> funopen64
  <span class="hljs-number">1154</span>: <span class="hljs-number">000000000007</span>a7f0   <span class="hljs-number">404</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> open64
  <span class="hljs-number">1225</span>: <span class="hljs-number">000000000008</span>b878   <span class="hljs-number">392</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> fopen64
  <span class="hljs-number">6160</span>: <span class="hljs-number">000000000007</span>a7f0   <span class="hljs-number">404</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> open64
  <span class="hljs-number">6652</span>: <span class="hljs-number">000000000008</span>b878   <span class="hljs-number">392</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> fopen64
  <span class="hljs-number">6653</span>: <span class="hljs-number">000000000008</span>bc10   <span class="hljs-number">980</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> freopen64
  <span class="hljs-number">6677</span>: <span class="hljs-number">000000000008</span>cb10   <span class="hljs-number">172</span> FUNC    <span class="hljs-keyword">GLOBAL</span> <span class="hljs-keyword">DEFAULT</span>   <span class="hljs-number">15</span> funopen64
</code></pre>
<p>可以看到偏移量为 0x7a7f0。</p>
<h4 data-id="heading-3">step 2</h4>
<p>在 /sys/kernel/tracing 目录下执行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'p:open_probe /apex/com.android.runtime/lib64/bionic/libc.so:0x7a7f0 pathname=+0(%x0):string'</span> &gt; uprobe_events
</code></pre>
<p>其中 [open_probe] 可以替换为其它字符串。+0(%x0):string 表示将 open64 函数的第一个参数作为字符串输出。open64 函数的实现如下，其第一个参数代表文件路径。</p>
<p>bionic/libc/bionic/open.cpp</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* pathname, <span class="hljs-type">int</span> flags, ...)</span> {
  <span class="hljs-type">mode_t</span> mode = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">if</span> (needs_mode(flags)) {
    va_list args;
    va_start(args, flags);
    mode = static_cast&lt;<span class="hljs-type">mode_t</span>&gt;(va_arg(args, <span class="hljs-type">int</span>));
    va_end(args);
  }

  <span class="hljs-keyword">return</span> FDTRACK_CREATE(__openat(AT_FDCWD, pathname, force_O_LARGEFILE(flags), mode));
}
__strong_alias(open64, open);
</code></pre>
<h4 data-id="heading-4">step 3</h4>
<p>在 /sys/kernel/tracing 目录下执行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> 1 &gt; events/uprobes/enable
<span class="hljs-built_in">echo</span> 1 &gt; tracing_on
</code></pre>
<p>其中第一条命令表示打开 uprobe_events 跟踪点，第二条命令表示打开 Linux 内核 ftrace 输出开关。</p>
<h4 data-id="heading-5">step 4</h4>
<p>在 /sys/kernel/tracing 目录下执行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> trace_pipe | grep open_probe
</code></pre>
<p>从桌面启动一个 App，得到如下输出结果（节选）：</p>
<pre><code class="hljs language-ini" lang="ini">    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382490: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/present"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382534: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu0/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382546: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu1/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382556: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu2/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382564: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu3/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382573: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu4/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382581: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu5/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382589: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu6/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[005]</span> .... 17932.382597: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/devices/system/cpu/cpu7/cpu_capacity"</span>
    RenderThread-24323 <span class="hljs-section">[007]</span> .... 17932.383114: open_probe: (0x76e789a7f0) <span class="hljs-attr">pathname</span>=<span class="hljs-string">"/sys/class/kgsl/kgsl-3d0/gpu_model"</span>
</code></pre>
<p>可以看到 RenderThread open 了一些 cpu 和 gpu 有关的节点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[根Activity的启动流程（基于Android 11.0）]]></title>    <link>https://juejin.cn/post/7597650322408308788</link>    <guid>https://juejin.cn/post/7597650322408308788</guid>    <pubDate>2026-01-21T15:01:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408308788" data-draft-id="7590433626560036899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="根Activity的启动流程（基于Android 11.0）"/> <meta itemprop="keywords" content="源码"/> <meta itemprop="datePublished" content="2026-01-21T15:01:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            根Activity的启动流程（基于Android 11.0）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T15:01:25.000Z" title="Wed Jan 21 2026 15:01:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前面我们分析了<a href="https://juejin.cn/post/7345662552959385609" target="_blank" title="https://juejin.cn/post/7345662552959385609">普通Activity的启动流程</a>，下面我们接着分析根Activity的启动流程，根Activity的启动流程相对更加复杂，里面涉及到应用进程的创建过程。</p>
<h3 data-id="heading-0">Launcher调起ATMS</h3>
<p>根Activity的启动流程的起点是从点击Launcher上一个未启动的应用的图标开始的。</p>
<blockquote>
<p>Launcher是系统的桌面，它也是一个应用，它通过<strong>PackageManagerService</strong>来获取已安装的所有应用程序的信息，然后通过列表的形式展示出来。</p>
</blockquote>
<p>Launcher的源码在<code>/packages/apps/Launcher3</code>路径下，点击桌面上某个应用的图标会调用com.android.launcher3.touch包路径下的ItemClickHandler的onClick()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemClickHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v, String sourceContainer)</span> {
        <span class="hljs-comment">// Make sure that rogue clicks don't get through while allapps is launching, or after the</span>
        <span class="hljs-comment">// view has detached (it's possible for this to happen if the view is removed mid touch).</span>
        <span class="hljs-keyword">if</span> (v.getWindowToken() == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;

        <span class="hljs-type">Launcher</span> <span class="hljs-variable">launcher</span> <span class="hljs-operator">=</span> Launcher.getLauncher(v.getContext());
        <span class="hljs-keyword">if</span> (!launcher.getWorkspace().isFinishedSwitchingState()) <span class="hljs-keyword">return</span>;

        <span class="hljs-type">Object</span> <span class="hljs-variable">tag</span> <span class="hljs-operator">=</span> v.getTag();
        <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> WorkspaceItemInfo) {
            onClickAppShortcut(v, (WorkspaceItemInfo) tag, launcher, sourceContainer);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> FolderInfo) {
            <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> FolderIcon) {
                onClickFolderIcon(v);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> AppInfo) {
            <span class="hljs-comment">//点击应用图标的跳转入口</span>
            startAppShortcutOrInfoActivity(v, (AppInfo) tag, launcher,
                    sourceContainer == <span class="hljs-literal">null</span> ? CONTAINER_ALL_APPS : sourceContainer);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag <span class="hljs-keyword">instanceof</span> LauncherAppWidgetInfo) {
            <span class="hljs-keyword">if</span> (v <span class="hljs-keyword">instanceof</span> PendingAppWidgetHostView) {
                onClickPendingWidget((PendingAppWidgetHostView) v, launcher);
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startAppShortcutOrInfoActivity</span><span class="hljs-params">(View v, ItemInfo item, Launcher launcher,
                                                       <span class="hljs-meta">@Nullable</span> String sourceContainer)</span> {
        ...
        launcher.startActivitySafely(v, intent, item, sourceContainer);
    }
}
</code></pre>
<p>startAppShortcutOrInfoActivity()方法调用了Launcher的startActivitySafely()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Launcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StatefulActivity</span>&lt;LauncherState&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LauncherExterns</span>,
        Callbacks, InvariantDeviceProfile.OnIDPChangeListener, PluginListener&lt;OverlayPlugin&gt;,
        LauncherOverlayCallbacks {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startActivitySafely</span><span class="hljs-params">(View v, Intent intent, ItemInfo item)</span> {
        ...
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.startActivitySafely(v, intent, item);
        ...
        <span class="hljs-keyword">return</span> success;
    }
}
</code></pre>
<p>里面调用了Launcher的父类的父类(BaseDraggingActivity)的startActivitySafely()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDraggingActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseActivity</span>
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnColorsChangedListener</span>, DisplayInfoChangeListener {

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startActivitySafely</span><span class="hljs-params">(View v, Intent intent, <span class="hljs-meta">@Nullable</span> ItemInfo item)</span> {
        ...
        startActivity(intent, optsBundle);
        ...
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p>BaseDraggingActivity的startActivitySafely()方法调用Activity的startActivity()方法，最终还是调用Activity的startActivityForResult()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent, <span class="hljs-meta">@Nullable</span> Bundle options)</span> {
        ...
        <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) {
            startActivityForResult(intent, -<span class="hljs-number">1</span>, options);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Note we want to go through this call for compatibility with</span>
            <span class="hljs-comment">// applications that may have overridden the method.</span>
            startActivityForResult(intent, -<span class="hljs-number">1</span>);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivityForResult</span><span class="hljs-params">(<span class="hljs-meta">@RequiresPermission</span> Intent intent, <span class="hljs-type">int</span> requestCode,
                                       <span class="hljs-meta">@Nullable</span> Bundle options)</span> {
        <span class="hljs-keyword">if</span> (mParent == <span class="hljs-literal">null</span>) {
            ...
            Instrumentation.<span class="hljs-type">ActivityResult</span> <span class="hljs-variable">ar</span> <span class="hljs-operator">=</span>
                    mInstrumentation.execStartActivity(
                            <span class="hljs-built_in">this</span>, mMainThread.getApplicationThread(), mToken, <span class="hljs-built_in">this</span>,
                            intent, requestCode, options);
            ...
        } <span class="hljs-keyword">else</span> {
            ...
        }
    }
} 
</code></pre>
<p>后面的流程与普通Activity的启动流程一致，直到进入ActivityStackSupervisor的startSpecificActivity()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityStackSupervisor</span> {

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">startSpecificActivity</span><span class="hljs-params">(ActivityRecord r, <span class="hljs-type">boolean</span> andResume, <span class="hljs-type">boolean</span> checkConfig)</span> {
        <span class="hljs-comment">//该activity所在的应用已经在运行了吗？</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">WindowProcessController</span> <span class="hljs-variable">wpc</span> <span class="hljs-operator">=</span>
                mService.getProcessController(r.processName, r.info.applicationInfo.uid);

        <span class="hljs-type">boolean</span> <span class="hljs-variable">knownToBeDead</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-comment">//wpc.hasThread()通过判断IApplicationThread是否被赋值，如果已赋值，即应用已运行， </span>
        <span class="hljs-comment">//应用已运行，则是普通Activity的启动流程，走realStartActivityLocked()方法</span>
        <span class="hljs-keyword">if</span> (wpc != <span class="hljs-literal">null</span> &amp;&amp; wpc.hasThread()) {
            <span class="hljs-keyword">try</span> {
                realStartActivityLocked(r, wpc, andResume, checkConfig);
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">catch</span> (RemoteException e) {
                Slog.w(TAG, <span class="hljs-string">"Exception when starting activity "</span>
                        + r.intent.getComponent().flattenToShortString(), e);
            }

            <span class="hljs-comment">// If a dead object exception was thrown -- fall through to</span>
            <span class="hljs-comment">// restart the application.</span>
            knownToBeDead = <span class="hljs-literal">true</span>;
        }

        r.notifyUnknownVisibilityLaunchedForKeyguardTransition();

        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isTop</span> <span class="hljs-operator">=</span> andResume &amp;&amp; r.isTopRunningActivity();
        <span class="hljs-comment">//否则需要ATMS的startProcessAsync()方法请求创建进程</span>
        mService.startProcessAsync(r, knownToBeDead, isTop, isTop ? <span class="hljs-string">"top-activity"</span> : <span class="hljs-string">"activity"</span>);
    }
}
</code></pre>
<p>此时应用进程还不存在，需要调用ATMS的startProcessAsync()来创建应用进程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityTaskManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityTaskManager</span>.Stub {

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">startProcessAsync</span><span class="hljs-params">(ActivityRecord activity, <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">boolean</span> isTop, 
            String hostingType)</span> {
        ...
        <span class="hljs-comment">//通过发送消息来启动进程，避免在持有ATMS锁的情况下调用AMS可能发生的死锁</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Message</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> PooledLambda.obtainMessage(ActivityManagerInternal::startProcess,
                mAmInternal, activity.processName, activity.info.applicationInfo, knownToBeDead,
                isTop, hostingType, activity.intent.getComponent());
        mH.sendMessage(m);
        ...
    }
}
</code></pre>
<p>这里使用Handler发送消息来启动进程，获取Message对象跟我们平时的使用方式不太一样，这里用到PooledLambda的obtainMessage()方法，实际就是调用了ActivityManagerInternal的startProcess()方法。</p>
<p>ActivityManagerInternal是一个抽象类，它是ActivityManager本地系统服务接口，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerInternal</span> {

    <span class="hljs-comment">/**
     * Starts a given process.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startProcess</span><span class="hljs-params">(String processName, ApplicationInfo info,
            <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">boolean</span> isTop, String hostingType, ComponentName hostingName)</span>;

}
</code></pre>
<p>ActivityManagerInternal的实现类为AMS的内部类LocalService，这样就把创建进程的请求传递给了AMS去处理。</p>
<blockquote>
<p>LocalServices可以理解为是一个公开缓存池，内部使用ArrayMap来存储本地服务对象。SystemServer进程中每个服务都可以通过LocalServices的addService()方法注册到LocalServices中，需要使用时通过LocalServices的getService()获取注册的本地服务。</p>
</blockquote>
<h3 data-id="heading-1">AMS请求Zygote创建进程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActivityManagerInternal</span> {

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startProcess</span><span class="hljs-params">(String processName, ApplicationInfo info, <span class="hljs-type">boolean</span> knownToBeDead,
                                 <span class="hljs-type">boolean</span> isTop, String hostingType, ComponentName hostingName)</span> {
            ...
            startProcessLocked(processName, info, knownToBeDead, <span class="hljs-number">0</span> <span class="hljs-comment">/* intentFlags */</span>,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HostingRecord</span>(hostingType, hostingName, isTop),
                    ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE, <span class="hljs-literal">false</span> <span class="hljs-comment">/* allowWhileBooting */</span>,
                    <span class="hljs-literal">false</span> <span class="hljs-comment">/* isolated */</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/* keepIfLarge */</span>);
            ...
        }
    }

    <span class="hljs-keyword">final</span> ProcessRecord <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(String processName,
            ApplicationInfo info, <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">int</span> intentFlags,
            HostingRecord hostingRecord, <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">boolean</span> allowWhileBooting,
            <span class="hljs-type">boolean</span> isolated, <span class="hljs-type">boolean</span> keepIfLarge)</span> {
        <span class="hljs-keyword">return</span> mProcessList.startProcessLocked(processName, info, knownToBeDead, intentFlags,
                hostingRecord, zygotePolicyFlags, allowWhileBooting, isolated, <span class="hljs-number">0</span> <span class="hljs-comment">/* isolatedUid */</span>,
                keepIfLarge, <span class="hljs-literal">null</span> <span class="hljs-comment">/* ABI override */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* entryPoint */</span>,
                <span class="hljs-literal">null</span> <span class="hljs-comment">/* entryPointArgs */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* crashHandler */</span>);
    }
}
</code></pre>
<p>startProcess()方法调用了startProcessLocked()方法，startProcessLocked()方法又调用了ProcessList的startProcessLocked()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessList</span> {

    <span class="hljs-keyword">final</span> ProcessRecord <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(String processName, ApplicationInfo info,
            <span class="hljs-type">boolean</span> knownToBeDead, <span class="hljs-type">int</span> intentFlags, HostingRecord hostingRecord,
            <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">boolean</span> allowWhileBooting, <span class="hljs-type">boolean</span> isolated, <span class="hljs-type">int</span> isolatedUid,
            <span class="hljs-type">boolean</span> keepIfLarge, String abiOverride, String entryPoint, String[] entryPointArgs,
            Runnable crashHandler)</span> {
        ...
        <span class="hljs-comment">//ProcessRecord记录每个进程的信息，进程名、uid等</span>
        ProcessRecord app;
        <span class="hljs-keyword">if</span> (!isolated) {
            app = getProcessRecordLocked(processName, info.uid, keepIfLarge);
            ...
        } <span class="hljs-keyword">else</span> {
            app = <span class="hljs-literal">null</span>;
        }
        ...
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span>
                startProcessLocked(app, hostingRecord, zygotePolicyFlags, abiOverride);
        ...
        <span class="hljs-keyword">return</span> success ? app : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(ProcessRecord app, HostingRecord hostingRecord,
            <span class="hljs-type">int</span> zygotePolicyFlags, String abiOverride)</span> {
        <span class="hljs-keyword">return</span> startProcessLocked(app, hostingRecord, zygotePolicyFlags,
                <span class="hljs-literal">false</span> <span class="hljs-comment">/* disableHiddenApiChecks */</span>, <span class="hljs-literal">false</span> <span class="hljs-comment">/* disableTestApiChecks */</span>,
                <span class="hljs-literal">false</span> <span class="hljs-comment">/* mountExtStorageFull */</span>, abiOverride);
    }


    <span class="hljs-type">boolean</span> <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(ProcessRecord app, HostingRecord hostingRecord,
            <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">boolean</span> disableHiddenApiChecks, <span class="hljs-type">boolean</span> disableTestApiChecks,
            <span class="hljs-type">boolean</span> mountExtStorageFull, String abiOverride)</span> {
        ...
        <span class="hljs-comment">// 启动进程，成功就返回进程的的pid，失败就抛出RuntimeException</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">entryPoint</span> <span class="hljs-operator">=</span> <span class="hljs-string">"android.app.ActivityThread"</span>;
        
        <span class="hljs-keyword">return</span> startProcessLocked(hostingRecord, entryPoint, app, uid, gids,
                runtimeFlags, zygotePolicyFlags, mountExternal, seInfo, requiredAbi,
                instructionSet, invokeWith, startTime); 
        ...
    }

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(HostingRecord hostingRecord, String entryPoint, ProcessRecord app,
            <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-type">int</span> mountExternal,
            String seInfo, String requiredAbi, String instructionSet, String invokeWith,
            <span class="hljs-type">long</span> startTime)</span> {
        ...
        <span class="hljs-keyword">if</span> (mService.mConstants.FLAG_PROCESS_START_ASYNC) {
            ...
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">final</span> Process.<span class="hljs-type">ProcessStartResult</span> <span class="hljs-variable">startResult</span> <span class="hljs-operator">=</span> startProcess(hostingRecord,
                        entryPoint, app,
                        uid, gids, runtimeFlags, zygotePolicyFlags, mountExternal, seInfo,
                        requiredAbi, instructionSet, invokeWith, startTime);
                handleProcessStartedLocked(app, startResult.pid, startResult.usingWrapper,
                        startSeq, <span class="hljs-literal">false</span>);
            }
            ...
            <span class="hljs-keyword">return</span> app.pid &gt; <span class="hljs-number">0</span>;
        }
    }

    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">startProcess</span><span class="hljs-params">(HostingRecord hostingRecord, String entryPoint,
            ProcessRecord app, <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> zygotePolicyFlags,
            <span class="hljs-type">int</span> mountExternal, String seInfo, String requiredAbi, String instructionSet,
            String invokeWith, <span class="hljs-type">long</span> startTime)</span> { 
        ...
        <span class="hljs-keyword">final</span> Process.ProcessStartResult startResult;
        <span class="hljs-keyword">if</span> (hostingRecord.usesWebviewZygote()) {
            startResult = startWebView(entryPoint,
                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,
                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,
                    app.info.dataDir, <span class="hljs-literal">null</span>, app.info.packageName, app.mDisabledCompatChanges,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{PROC_START_SEQ_IDENT + app.startSeq});
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hostingRecord.usesAppZygote()) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">AppZygote</span> <span class="hljs-variable">appZygote</span> <span class="hljs-operator">=</span> createAppZygoteForProcessIfNeeded(app);

            <span class="hljs-comment">// We can't isolate app data and storage data as parent zygote already did that.</span>
            startResult = appZygote.getProcess().start(entryPoint,
                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,
                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,
                    app.info.dataDir, <span class="hljs-literal">null</span>, app.info.packageName,
                    <span class="hljs-comment">/*zygotePolicyFlags=*/</span> ZYGOTE_POLICY_FLAG_EMPTY, isTopApp,
                    app.mDisabledCompatChanges, pkgDataInfoMap, whitelistedAppDataInfoMap,
                    <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{PROC_START_SEQ_IDENT + app.startSeq});
        } <span class="hljs-keyword">else</span> {
            startResult = Process.start(entryPoint,
                    app.processName, uid, uid, gids, runtimeFlags, mountExternal,
                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,
                    app.info.dataDir, invokeWith, app.info.packageName, zygotePolicyFlags,
                    isTopApp, app.mDisabledCompatChanges, pkgDataInfoMap,
                    whitelistedAppDataInfoMap, bindMountAppsData, bindMountAppStorageDirs,
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{PROC_START_SEQ_IDENT + app.startSeq});
        }
        <span class="hljs-keyword">return</span> startResult;
    }
}
</code></pre>
<p>在ProcessList中经过4个startProcessLocked()方法后，调用了startProcess()方法，在startProcess()方法里根据不同的参数调用不同的方法启动进程，继续跟进到Process的start()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Process</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ZygoteProcess</span> <span class="hljs-variable">ZYGOTE_PROCESS</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteProcess</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> String processClass,
                                           <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> String niceName,
                                           <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-meta">@Nullable</span> <span class="hljs-type">int</span>[] gids,
                                           <span class="hljs-type">int</span> runtimeFlags,
                                           <span class="hljs-type">int</span> mountExternal,
                                           <span class="hljs-type">int</span> targetSdkVersion,
                                           <span class="hljs-meta">@Nullable</span> String seInfo,
                                           <span class="hljs-meta">@NonNull</span> String abi,
                                           <span class="hljs-meta">@Nullable</span> String instructionSet,
                                           <span class="hljs-meta">@Nullable</span> String appDataDir,
                                           <span class="hljs-meta">@Nullable</span> String invokeWith,
                                           <span class="hljs-meta">@Nullable</span> String packageName,
                                           <span class="hljs-type">int</span> zygotePolicyFlags,
                                           <span class="hljs-type">boolean</span> isTopApp,
                                           <span class="hljs-meta">@Nullable</span> <span class="hljs-type">long</span>[] disabledCompatChanges,
                                           <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                   pkgDataInfoMap,
                                           <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                   whitelistedDataInfoMap,
                                           <span class="hljs-type">boolean</span> bindMountAppsData,
                                           <span class="hljs-type">boolean</span> bindMountAppStorageDirs,
                                           <span class="hljs-meta">@Nullable</span> String[] zygoteArgs)</span> {
        <span class="hljs-keyword">return</span> ZYGOTE_PROCESS.start(processClass, niceName, uid, gid, gids,
                runtimeFlags, mountExternal, targetSdkVersion, seInfo,
                abi, instructionSet, appDataDir, invokeWith, packageName,
                zygotePolicyFlags, isTopApp, disabledCompatChanges,
                pkgDataInfoMap, whitelistedDataInfoMap, bindMountAppsData,
                bindMountAppStorageDirs, zygoteArgs);
    }
}
</code></pre>
<p>ZYGOTE_PROCESS是ZygoteProcess在Process类中的static final类型的实例，继续进入ZygoteProcess的start()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Process.ProcessStartResult <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> String processClass,
                                                  <span class="hljs-keyword">final</span> String niceName,
                                                  <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-meta">@Nullable</span> <span class="hljs-type">int</span>[] gids,
                                                  <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> mountExternal,
                                                  <span class="hljs-type">int</span> targetSdkVersion,
                                                  <span class="hljs-meta">@Nullable</span> String seInfo,
                                                  <span class="hljs-meta">@NonNull</span> String abi,
                                                  <span class="hljs-meta">@Nullable</span> String instructionSet,
                                                  <span class="hljs-meta">@Nullable</span> String appDataDir,
                                                  <span class="hljs-meta">@Nullable</span> String invokeWith,
                                                  <span class="hljs-meta">@Nullable</span> String packageName,
                                                  <span class="hljs-type">int</span> zygotePolicyFlags,
                                                  <span class="hljs-type">boolean</span> isTopApp,
                                                  <span class="hljs-meta">@Nullable</span> <span class="hljs-type">long</span>[] disabledCompatChanges,
                                                  <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                          pkgDataInfoMap,
                                                  <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                          whitelistedDataInfoMap,
                                                  <span class="hljs-type">boolean</span> bindMountAppsData,
                                                  <span class="hljs-type">boolean</span> bindMountAppStorageDirs,
                                                  <span class="hljs-meta">@Nullable</span> String[] zygoteArgs)</span> {
        ...
        <span class="hljs-comment">//startViaZygote，即为通过Zygote启动进程</span>
        <span class="hljs-keyword">return</span> startViaZygote(processClass, niceName, uid, gid, gids,
                runtimeFlags, mountExternal, targetSdkVersion, seInfo,
                abi, instructionSet, appDataDir, invokeWith, <span class="hljs-comment">/*startChildZygote=*/</span> <span class="hljs-literal">false</span>,
                packageName, zygotePolicyFlags, isTopApp, disabledCompatChanges,
                pkgDataInfoMap, whitelistedDataInfoMap, bindMountAppsData,
                bindMountAppStorageDirs, zygoteArgs);
        ...
    }

    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">startViaZygote</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> <span class="hljs-keyword">final</span> String processClass,
                                                      <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> String niceName,
                                                      <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> uid, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> gid,
                                                      <span class="hljs-meta">@Nullable</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] gids,
                                                      <span class="hljs-type">int</span> runtimeFlags, <span class="hljs-type">int</span> mountExternal,
                                                      <span class="hljs-type">int</span> targetSdkVersion,
                                                      <span class="hljs-meta">@Nullable</span> String seInfo,
                                                      <span class="hljs-meta">@NonNull</span> String abi,
                                                      <span class="hljs-meta">@Nullable</span> String instructionSet,
                                                      <span class="hljs-meta">@Nullable</span> String appDataDir,
                                                      <span class="hljs-meta">@Nullable</span> String invokeWith,
                                                      <span class="hljs-type">boolean</span> startChildZygote,
                                                      <span class="hljs-meta">@Nullable</span> String packageName,
                                                      <span class="hljs-type">int</span> zygotePolicyFlags,
                                                      <span class="hljs-type">boolean</span> isTopApp,
                                                      <span class="hljs-meta">@Nullable</span> <span class="hljs-type">long</span>[] disabledCompatChanges,
                                                      <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                              pkgDataInfoMap,
                                                      <span class="hljs-meta">@Nullable</span> Map&lt;String, Pair&lt;String, Long&gt;&gt;
                                                              whitelistedDataInfoMap,
                                                      <span class="hljs-type">boolean</span> bindMountAppsData,
                                                      <span class="hljs-type">boolean</span> bindMountAppStorageDirs,
                                                      <span class="hljs-meta">@Nullable</span> String[] extraArgs)</span>
            <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        <span class="hljs-comment">//创建argsForZygote </span>
        ArrayList&lt;String&gt; argsForZygote = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">//存入uid、gid等参数</span>
        argsForZygote.add(<span class="hljs-string">"--runtime-args"</span>);
        argsForZygote.add(<span class="hljs-string">"--setuid="</span> + uid);
        argsForZygote.add(<span class="hljs-string">"--setgid="</span> + gid);

        ...

        <span class="hljs-keyword">synchronized</span> (mLock) {
            <span class="hljs-keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi),
                    zygotePolicyFlags,
                    argsForZygote);
        }
    }
}
</code></pre>
<p>ZygoteProcess的start()方法中调用了startViaZygote()方法，即为通过Zygote来启动进程，该方法流程如下：</p>
<ol>
<li>新建参数列表argsForZygote，将应用进程的启动参数保存在argsForZygote中，包括uid、gid、targetSdkVersion、应用进程的启动文件（android.app.ActivityThread）等参数。</li>
<li>调用openZygoteSocketIfNeeded()方法，如果与Zygote进程的Socket连接未开启，则尝试开启，可能会产生阻塞和重试。连接调用的是ZygoteState的connect()方法，ZygoteState是ZygoteProcess的内部类。</li>
<li>调用zygoteSendArgsAndGetResult()方法，向Zygote进程发送参数列表，启动一个新的子进程并返回子进程的 pid。注意：当前实现将参数列表中的换行符替换为空格。</li>
</ol>
<p>先来看看openZygoteSocketIfNeeded()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-keyword">private</span> ZygoteState <span class="hljs-title function_">openZygoteSocketIfNeeded</span><span class="hljs-params">(String abi)</span> <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//尝试与PrimaryZygote建立Socket连接</span>
            attemptConnectionToPrimaryZygote();

            <span class="hljs-keyword">if</span> (primaryZygoteState.matches(abi)) {
                <span class="hljs-keyword">return</span> primaryZygoteState;
            }

            <span class="hljs-keyword">if</span> (mZygoteSecondarySocketAddress != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">//如果PrimaryZygote不匹配，试试SecondaryZygote</span>
                attemptConnectionToSecondaryZygote();

                <span class="hljs-keyword">if</span> (secondaryZygoteState.matches(abi)) {
                    <span class="hljs-keyword">return</span> secondaryZygoteState;
                }
            }
        } <span class="hljs-keyword">catch</span> (IOException ioe) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">"Error connecting to zygote"</span>, ioe);
        }

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">"Unsupported zygote ABI: "</span> + abi);
    }

    <span class="hljs-comment">/**
     * Creates a ZygoteState for the primary zygote if it doesn't exist or has been disconnected.
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attemptConnectionToPrimaryZygote</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (primaryZygoteState == <span class="hljs-literal">null</span> || primaryZygoteState.isClosed()) {
            primaryZygoteState =
                    ZygoteState.connect(mZygoteSocketAddress, mUsapPoolSocketAddress);

            maybeSetApiBlacklistExemptions(primaryZygoteState, <span class="hljs-literal">false</span>);
            maybeSetHiddenApiAccessLogSampleRate(primaryZygoteState);
        }
    }

    <span class="hljs-comment">/**
     * Creates a ZygoteState for the secondary zygote if it doesn't exist or has been disconnected.
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attemptConnectionToSecondaryZygote</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (secondaryZygoteState == <span class="hljs-literal">null</span> || secondaryZygoteState.isClosed()) {
            secondaryZygoteState =
                    ZygoteState.connect(mZygoteSecondarySocketAddress,
                            mUsapPoolSecondarySocketAddress);

            maybeSetApiBlacklistExemptions(secondaryZygoteState, <span class="hljs-literal">false</span>);
            maybeSetHiddenApiAccessLogSampleRate(secondaryZygoteState);
        }
    }
}
</code></pre>
<p>通过openZygoteSocketIfNeeded()方法打开与Zygote进程的Socket连接，里面有涉及到与PrimaryZygote和SecondaryZygote的连接，两个都是调用ZygoteState的connect()方法来创建一个与给定Zygote Socket地址的Socket连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteState</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> {

        <span class="hljs-comment">/**
         * 通过与指定的Zygote socket建立连接创建ZygoteState实例，并保存指定的USAP socket地址
         */</span>
        <span class="hljs-keyword">static</span> ZygoteState <span class="hljs-title function_">connect</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LocalSocketAddress zygoteSocketAddress,
                                   <span class="hljs-meta">@Nullable</span> LocalSocketAddress usapSocketAddress)</span>
                <span class="hljs-keyword">throws</span> IOException {

            DataInputStream zygoteInputStream;
            BufferedWriter zygoteOutputWriter;
            <span class="hljs-keyword">final</span> <span class="hljs-type">LocalSocket</span> <span class="hljs-variable">zygoteSessionSocket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalSocket</span>();

            <span class="hljs-keyword">if</span> (zygoteSocketAddress == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"zygoteSocketAddress can't be null"</span>);
            }

            <span class="hljs-keyword">try</span> {
                zygoteSessionSocket.connect(zygoteSocketAddress);
                zygoteInputStream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(zygoteSessionSocket.getInputStream());
                zygoteOutputWriter =
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(
                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(zygoteSessionSocket.getOutputStream()),
                                Zygote.SOCKET_BUFFER_SIZE);
            } <span class="hljs-keyword">catch</span> (IOException ex) {
                <span class="hljs-keyword">try</span> {
                    zygoteSessionSocket.close();
                } <span class="hljs-keyword">catch</span> (IOException ignore) { }

                <span class="hljs-keyword">throw</span> ex;
            }

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteState</span>(zygoteSocketAddress, usapSocketAddress,
                    zygoteSessionSocket, zygoteInputStream, zygoteOutputWriter,
                    getAbiList(zygoteOutputWriter, zygoteInputStream));
        }
    }
}
</code></pre>
<p>连接上Zygote进程后，会创建BufferedWriter和DataInputStream进行参数数据的传输与读取，最后将一系列参数封装成ZygoteState对象返回给zygoteSendArgsAndGetResult()方法。</p>
<p>接下来看看zygoteSendArgsAndGetResult()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteProcess</span> {

    <span class="hljs-comment">//把参数列表发送给Zygote进程，启动新进程，并返回新进程的pid</span>
    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">zygoteSendArgsAndGetResult</span><span class="hljs-params">(
            ZygoteState zygoteState, <span class="hljs-type">int</span> zygotePolicyFlags, <span class="hljs-meta">@NonNull</span> ArrayList&lt;String&gt; args)</span>
            <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        ...
        <span class="hljs-keyword">if</span> (shouldAttemptUsapLaunch(zygotePolicyFlags, args)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> attemptUsapSendArgsAndGetResult(zygoteState, msgStr);
            } <span class="hljs-keyword">catch</span> (IOException ex) {
                <span class="hljs-comment">// If there was an IOException using the USAP pool we will log the error and</span>
                <span class="hljs-comment">// attempt to start the process through the Zygote.</span>
                Log.e(LOG_TAG, <span class="hljs-string">"IO Exception while communicating with USAP pool - "</span>
                        + ex.getMessage());
            }
        }

        <span class="hljs-keyword">return</span> attemptZygoteSendArgsAndGetResult(zygoteState, msgStr);
    }


    <span class="hljs-keyword">private</span> Process.ProcessStartResult <span class="hljs-title function_">attemptZygoteSendArgsAndGetResult</span><span class="hljs-params">(
            ZygoteState zygoteState, String msgStr)</span> <span class="hljs-keyword">throws</span> ZygoteStartFailedEx {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">zygoteWriter</span> <span class="hljs-operator">=</span> zygoteState.mZygoteOutputWriter;
            <span class="hljs-keyword">final</span> <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">zygoteInputStream</span> <span class="hljs-operator">=</span> zygoteState.mZygoteInputStream;

            zygoteWriter.write(msgStr);
            zygoteWriter.flush();

            <span class="hljs-comment">// Always read the entire result from the input stream to avoid leaving</span>
            <span class="hljs-comment">// bytes in the stream for future process starts to accidentally stumble</span>
            <span class="hljs-comment">// upon.</span>
            Process.<span class="hljs-type">ProcessStartResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Process</span>.ProcessStartResult();
            <span class="hljs-comment">//读取zygoteInputStream中的值</span>
            result.pid = zygoteInputStream.readInt();
            result.usingWrapper = zygoteInputStream.readBoolean();

            <span class="hljs-keyword">if</span> (result.pid &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(<span class="hljs-string">"fork() failed"</span>);
            }

            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (IOException ex) {
            zygoteState.close();
            Log.e(LOG_TAG, <span class="hljs-string">"IO Exception while communicating with Zygote - "</span>
                    + ex.toString());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteStartFailedEx</span>(ex);
        }
    }
} 
</code></pre>
<p>ZygoteProcess的attemptZygoteSendArgsAndGetResult()方法中使用ZygoteState中保存的BufferedWriter和DataInputStream来进行Socket通信，进行数据流的传输和读取，最后把pid和usingWrapper封装到ProcessStartResult中返回。</p>
<h3 data-id="heading-2">Zygote创建进程并执行ActivityThread的main()方法</h3>
<p>Android系统是基于Linux开发的，init进程是Linux系统用户进程的第一个进程，其它所有的用户进程都是init进程的子进程，Zygote进程也是由init进程创建的，Zygote启动之后会调用ZygoteInit的main()方法，我们先从main()方法来看Socket的创建和消息读取，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteInit</span> {

    <span class="hljs-comment">//这里是Zygote进程的入口，它创建了ZygoteServer，加载资源，并准备其他创建进程相关的事务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String argv[])</span> {
        <span class="hljs-type">ZygoteServer</span> <span class="hljs-variable">zygoteServer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        ...
        Runnable caller;
        <span class="hljs-keyword">try</span> {
            ...
            <span class="hljs-type">boolean</span> <span class="hljs-variable">startSystemServer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">zygoteSocketName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"zygote"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">abiList</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">enableLazyPreload</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; argv.length; i++) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"start-system-server"</span>.equals(argv[i])) {
                    startSystemServer = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"--enable-lazy-preload"</span>.equals(argv[i])) {
                    enableLazyPreload = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) {
                    abiList = argv[i].substring(ABI_LIST_ARG.length());
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) {
                    zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Unknown command line argument: "</span> + argv[i]);
                }
            }
            ...
            zygoteServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteServer</span>(isPrimaryZygote);

            <span class="hljs-keyword">if</span> (startSystemServer) {
                <span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> forkSystemServer(abiList, zygoteSocketName, zygoteServer);

                <span class="hljs-comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
                <span class="hljs-comment">// child (system_server) process.</span>
                <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span>) {
                    r.run();
                    <span class="hljs-keyword">return</span>;
                }
            }

            Log.i(TAG, <span class="hljs-string">"Accepting command socket connections"</span>);

            <span class="hljs-comment">// The select loop returns early in the child process after a fork and</span>
            <span class="hljs-comment">// loops forever in the zygote.</span>
            <span class="hljs-comment">// runSelectLoop()方法在子进程中后会立即return，在Zygote中会loop forever</span>
            caller = zygoteServer.runSelectLoop(abiList);
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            Log.e(TAG, <span class="hljs-string">"System zygote died with exception"</span>, ex);
            <span class="hljs-keyword">throw</span> ex;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (zygoteServer != <span class="hljs-literal">null</span>) {
                zygoteServer.closeServerSocket();
            }
        }

        <span class="hljs-comment">// We're in the child process and have exited the select loop. Proceed to execute the</span>
        <span class="hljs-comment">// command.</span>
        <span class="hljs-comment">// 子进程的启动</span>
        <span class="hljs-keyword">if</span> (caller != <span class="hljs-literal">null</span>) {
            caller.run();
        }
    }
}
</code></pre>
<p>在main()方法中新建ZygoteServer实例对象，调用ZygoteServer的runSelectLoop()方法，runSelectLoop()方法在子进程中后会立即返回，在Zygote中会开启无限循环来监听Socket客户端发来的消息。</p>
<p>下面我们看看ZygoteServer的runSelectLoop()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteServer</span> {

    <span class="hljs-comment">//用Zygote server socket, USAP pool server socket和USAP pool event FD初始化Zygote Server</span>
    ZygoteServer(<span class="hljs-type">boolean</span> isPrimaryZygote) {
        mUsapPoolEventFD = Zygote.getUsapPoolEventFD();

        <span class="hljs-keyword">if</span> (isPrimaryZygote) {
            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);
            mUsapPoolSocket =
                    Zygote.createManagedSocketFromInitSocket(
                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);
        } <span class="hljs-keyword">else</span> {
            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);
            mUsapPoolSocket =
                    Zygote.createManagedSocketFromInitSocket(
                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);
        }

        mUsapPoolSupported = <span class="hljs-literal">true</span>;
        fetchUsapPoolPolicyProps();
    }


    <span class="hljs-comment">/**
     * Runs the zygote process's select loop. Accepts new connections as
     * they happen, and reads commands from connections one spawn-request's
     * worth at a time.
     */</span>
    Runnable <span class="hljs-title function_">runSelectLoop</span><span class="hljs-params">(String abiList)</span> {
        ArrayList&lt;FileDescriptor&gt; socketFDs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        socketFDs.add(mZygoteSocket.getFileDescriptor());
        peers.add(<span class="hljs-literal">null</span>);

        mUsapPoolRefillTriggerTimestamp = INVALID_TIMESTAMP;

        <span class="hljs-comment">//开启无限循环</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            ...
            <span class="hljs-type">int</span> pollReturnValue;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">//处理轮询状态，当pollFDs有事件到来则往下执行，否则阻塞在这里</span>
                pollReturnValue = Os.poll(pollFDs, pollTimeoutMs);
            } <span class="hljs-keyword">catch</span> (ErrnoException ex) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"poll failed"</span>, ex);
            }

            <span class="hljs-keyword">if</span> (pollReturnValue == <span class="hljs-number">0</span>) {
                mUsapPoolRefillTriggerTimestamp = INVALID_TIMESTAMP;
                mUsapPoolRefillAction = UsapPoolRefillAction.DELAYED;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">usapPoolFDRead</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
                <span class="hljs-comment">//倒序处理，即优先处理已建立连接的信息，后处理新建连接的请求</span>
                <span class="hljs-keyword">while</span> (--pollIndex &gt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 采用I/O多路复用epoll机制，当接收到客户端请求到来，则往下执行；否则跳出本次循环</span>
                    <span class="hljs-keyword">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">continue</span>;
                    }

                    <span class="hljs-keyword">if</span> (pollIndex == <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// Zygote server socket</span>
                        <span class="hljs-comment">// pollIndex==0表示有新的客户端请求连接到来，调用Server Socket端的accept函数建立通信连接 </span>
                        <span class="hljs-comment">// Zygote进程与System Server进程建立了连接</span>
                        <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">newPeer</span> <span class="hljs-operator">=</span> acceptCommandPeer(abiList);
                        <span class="hljs-comment">// 加入到peers和fds, 即开始下一次监听</span>
                        peers.add(newPeer);
                        socketFDs.add(newPeer.getFileDescriptor());

                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pollIndex &lt; usapPoolEventFDIndex) {
                        <span class="hljs-comment">// Session socket accepted from the Zygote server socket</span>
                        <span class="hljs-comment">// socket 连接成功之后从 Zygote 服务器的 socket 接受到的 Session socket</span>
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> peers.get(pollIndex);
                            <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> connection.processOneCommand(<span class="hljs-built_in">this</span>);

                            <span class="hljs-comment">// TODO (chriswailes): Is this extra check necessary?</span>
                            <span class="hljs-keyword">if</span> (mIsForkChild) {
                                ...
                                <span class="hljs-keyword">return</span> command;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-comment">// We're in the server - we should never have any commands to run.</span>
                                <span class="hljs-comment">// 如果不是fork子进程则关闭连接，删除当前fd消息</span>
                                <span class="hljs-keyword">if</span> (connection.isClosedByPeer()) {
                                    connection.closeSocket();
                                    peers.remove(pollIndex);
                                    socketFDs.remove(pollIndex);
                                }
                            }
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            ...
                        } <span class="hljs-keyword">finally</span> {
                            mIsForkChild = <span class="hljs-literal">false</span>;
                        }

                    } <span class="hljs-keyword">else</span> {
                        ...
                    }
                }

                ...
            }
            ...
        }
    }
}
</code></pre>
<p>runSelectLoop()方法中获取zygoteSendArgsAndGetResult()方法传输过来的应用进程的启动参数，即和Zygote进程建立起连接，其方法流程如下：</p>
<ol>
<li>开启Loop死循环监听Socket事件，没有连接时就阻塞在那里，当有连接到来时唤醒继续往下执行。</li>
<li>pollIndex==0 时，说明收到请求连接的事件，请求和Zygote建立Socket连接，调用acceptCommandPeer()方法创建ZygoteConnection对象，并调用ZygoteSocket的accept()方法建立Socket连接，然后添加到监听列表peers中，等待与该Socket有关的命令的到来。</li>
<li>pollIndex &lt; usapPoolEventFDIndex 时，表示是已经连接的Socket上的命令到来，此时调用ZygoteConnection的processOneCommand()方法来接收客户端传输过来的应用进程的启动参数，并执行进程创建工作，处理完后，就会断开与客户端的连接，并把用于连接的Socket从监听列表peers中移除。</li>
</ol>
<p>接着进入ZygoteConnection的processOneCommand()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteConnection</span> {

    <span class="hljs-comment">/**
     * Reads one start command from the command socket. If successful, a child is forked and a
     * {<span class="hljs-doctag">@code</span> Runnable} that calls the childs main method (or equivalent) is returned in the child
     * process. {<span class="hljs-doctag">@code</span> null} is always returned in the parent process (the zygote).
     * 
     * If the client closes the socket, an {<span class="hljs-doctag">@code</span> EOF} condition is set, which callers can test
     * for by calling {<span class="hljs-doctag">@code</span> ZygoteConnection.isClosedByPeer}.
     */</span>
    Runnable <span class="hljs-title function_">processOneCommand</span><span class="hljs-params">(ZygoteServer zygoteServer)</span> {
        String[] args;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 逐行读取客户端端通过Socket write过来的启动参数(字符串数组)</span>
            args = Zygote.readArgumentList(mSocketReader);
        } <span class="hljs-keyword">catch</span> (IOException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"IOException on command socket"</span>, ex);
        }

        ...

        <span class="hljs-type">int</span> pid;
        <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">childPipeFd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">serverPipeFd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// 将参数解析成ZygoteArguments格式</span>
        <span class="hljs-type">ZygoteArguments</span> <span class="hljs-variable">parsedArgs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteArguments</span>(args);
        ...
        <span class="hljs-type">int</span>[][] rlimits = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (parsedArgs.mRLimits != <span class="hljs-literal">null</span>) {
            rlimits = parsedArgs.mRLimits.toArray(Zygote.INT_ARRAY_2D);
        }

        <span class="hljs-type">int</span>[] fdsToIgnore = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                FileDescriptor[] pipeFds = Os.pipe2(O_CLOEXEC);
                childPipeFd = pipeFds[<span class="hljs-number">1</span>];
                serverPipeFd = pipeFds[<span class="hljs-number">0</span>];
                Os.fcntlInt(childPipeFd, F_SETFD, <span class="hljs-number">0</span>);
                fdsToIgnore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{childPipeFd.getInt$(), serverPipeFd.getInt$()};
            } <span class="hljs-keyword">catch</span> (ErrnoException errnoEx) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Unable to set up pipe for invoke-with"</span>, errnoEx);
            }
        }

        <span class="hljs-comment">// 将Client端fd和Server端fd存入fdsToClose数组中，然后fd置为null</span>
        <span class="hljs-type">int</span>[] fdsToClose = {-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>};

        <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> mSocket.getFileDescriptor();

        <span class="hljs-keyword">if</span> (fd != <span class="hljs-literal">null</span>) {
            fdsToClose[<span class="hljs-number">0</span>] = fd.getInt$();
        }

        fd = zygoteServer.getZygoteSocketFileDescriptor();

        <span class="hljs-keyword">if</span> (fd != <span class="hljs-literal">null</span>) {
            fdsToClose[<span class="hljs-number">1</span>] = fd.getInt$();
        }

        <span class="hljs-comment">// 调用Zygote的forkAndSpecialize()方法来fork子进程</span>
        pid = Zygote.forkAndSpecialize(parsedArgs.mUid, parsedArgs.mGid, parsedArgs.mGids,
                parsedArgs.mRuntimeFlags, rlimits, parsedArgs.mMountExternal, parsedArgs.mSeInfo,
                parsedArgs.mNiceName, fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,
                parsedArgs.mInstructionSet, parsedArgs.mAppDataDir, parsedArgs.mIsTopApp,
                parsedArgs.mPkgDataInfoList, parsedArgs.mWhitelistedDataInfoList,
                parsedArgs.mBindMountAppDataDirs, parsedArgs.mBindMountAppStorageDirs);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// pid == 0 表示创建成功，则进入子进程中，即应用程序进程</span>
                zygoteServer.setForkChild();
                <span class="hljs-comment">// 关闭 socket 连接</span>
                zygoteServer.closeServerSocket();
                IoUtils.closeQuietly(serverPipeFd);
                serverPipeFd = <span class="hljs-literal">null</span>;
                <span class="hljs-comment">// 进入子进程执行相关操作</span>
                <span class="hljs-keyword">return</span> handleChildProc(parsedArgs, childPipeFd, parsedArgs.mStartChildZygote);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span>
                <span class="hljs-comment">// handleParentProc.</span>
                <span class="hljs-comment">// pid &lt; 0表示创建失败，则进入父进程返回消息给Client Socket表示启动失败</span>
                IoUtils.closeQuietly(childPipeFd);
                childPipeFd = <span class="hljs-literal">null</span>;
                <span class="hljs-comment">// 进入父进程执行相关操作</span>
                handleParentProc(pid, serverPipeFd);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        } <span class="hljs-keyword">finally</span> {
            IoUtils.closeQuietly(childPipeFd);
            IoUtils.closeQuietly(serverPipeFd);
        }
    }
}
</code></pre>
<p>该方法主要作用如下：</p>
<ol>
<li>读取SystemServer端Socket写入的数据，并将存入字符串数组的数据封装成ZygoteArguments格式。</li>
<li>调用Zygote的forkAndSpecialize()方法来fork子进程，并返回pid，这里的pid并非是进程id，而是返回结果值，0 表示创建成功，-1 表示创建失败。</li>
<li>子进程创建成功后进入子进程执行。</li>
</ol>
<p>看看Zygote的forkAndSpecialize()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Zygote</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">forkAndSpecialize</span><span class="hljs-params">(<span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags,
                                 <span class="hljs-type">int</span>[][] rlimits, <span class="hljs-type">int</span> mountExternal, String seInfo, String niceName, <span class="hljs-type">int</span>[] fdsToClose,
                                 <span class="hljs-type">int</span>[] fdsToIgnore, <span class="hljs-type">boolean</span> startChildZygote, String instructionSet, String appDataDir,
                                 <span class="hljs-type">boolean</span> isTopApp, String[] pkgDataInfoList, String[] whitelistedDataInfoList,
                                 <span class="hljs-type">boolean</span> bindMountAppDataDirs, <span class="hljs-type">boolean</span> bindMountAppStorageDirs)</span> {
        ZygoteHooks.preFork();
        <span class="hljs-comment">//通过JNI调用native层方法</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> nativeForkAndSpecialize(
                uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,
                fdsToIgnore, startChildZygote, instructionSet, appDataDir, isTopApp,
                pkgDataInfoList, whitelistedDataInfoList, bindMountAppDataDirs,
                bindMountAppStorageDirs);
        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// Note that this event ends at the end of handleChildProc,</span>
            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">"PostFork"</span>);
            <span class="hljs-comment">// If no GIDs were specified, don't make any permissions changes based on groups.</span>
            <span class="hljs-keyword">if</span> (gids != <span class="hljs-literal">null</span> &amp;&amp; gids.length &gt; <span class="hljs-number">0</span>) {
                NetworkUtils.setAllowNetworkingForProcess(containsInetGid(gids));
            }
        }
        <span class="hljs-comment">// Set the Java Language thread priority to the default value for new apps.</span>
        Thread.currentThread().setPriority(Thread.NORM_PRIORITY);
        ZygoteHooks.postForkCommon();
        <span class="hljs-keyword">return</span> pid;
    }
}  
</code></pre>
<p>方法中调用native层的nativeForkAndSpecialize()方法创建进程，然后返回进程的pid（父进程中，返回新建的子进程的pid，子进程中，则返回 0，出现错误时返回负数），具体native层的源码就不跟了，大致过程如下：</p>
<ol>
<li>调用Linux的fork()方法创建进程，设置进程的主线程的name，如果是null或者SystemServer，则为 SystemServer。</li>
<li>调用CallStaticVoidMethod()方法返回Zygote的callPostForkChildHooks()方法处理fork子线程之后的gc/线程池管理等操作。</li>
</ol>
<p>进入ZygoteConnection的handleChildProc()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteConnection</span> {

    <span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">handleChildProc</span><span class="hljs-params">(ZygoteArguments parsedArgs,
                                     FileDescriptor pipeFd, <span class="hljs-type">boolean</span> isZygote)</span> {
        <span class="hljs-comment">//关闭Socket连接</span>
        closeSocket();
        <span class="hljs-comment">// 设置应用进程名</span>
        Zygote.setAppProcessName(parsedArgs, TAG);

        <span class="hljs-comment">// End of the postFork event.</span>
        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
        <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-literal">null</span>) {
            WrapperInit.execApplication(parsedArgs.mInvokeWith,
                    parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,
                    VMRuntime.getCurrentInstructionSet(),
                    pipeFd, parsedArgs.mRemainingArgs);

            <span class="hljs-comment">// Should not get here.</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"WrapperInit.execApplication unexpectedly returned"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (!isZygote) {
                <span class="hljs-keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,
                        parsedArgs.mDisabledCompatChanges,
                        parsedArgs.mRemainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> ZygoteInit.childZygoteInit(parsedArgs.mTargetSdkVersion,
                        parsedArgs.mRemainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);
            }
        }
    }
}
</code></pre>
<p>该方法就是进入子进程执行不同的初始化操作，因为已经fork()成功，关闭Socket连接等释放资源，设置应用进程名，最后调用ZygoteInit的zygoteInit()方法初始化Zygote：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZygoteInit</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Runnable <span class="hljs-title function_">zygoteInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,
                                            String[] argv, ClassLoader classLoader)</span> {
        ...
        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">"ZygoteInit"</span>);
        RuntimeInit.redirectLogStreams();
        <span class="hljs-comment">//进程初始化配置，如设置异常捕获Handler、时区、重置LogManager等等</span>
        RuntimeInit.commonInit();
        <span class="hljs-comment">//native层初始化--打开/dev/binder驱动，映射内核的地址空间，创建binder线程用于IPC通信</span>
        ZygoteInit.nativeZygoteInit();
        <span class="hljs-keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,
                classLoader);
    }

}
</code></pre>
<p>zygoteInit()方法流程如下：</p>
<ol>
<li>日志流重定向，将系统输出和系统错误重定向到Android日志。</li>
<li>进程初始化配置，如设置异常捕获Handler、时区、重置LogManager等等。</li>
<li>native层初始化，打开/dev/binder驱动，映射内核的地址空间，创建Binder线程用于IPC通信。</li>
<li>调用RuntimeInit的applicationInit()方法，返回创建的Runnable对象。</li>
</ol>
<p>接下来执行RuntimeInit的applicationInit()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeInit</span> {

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">applicationInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,
                                              String[] argv, ClassLoader classLoader)</span> {
        <span class="hljs-comment">//如果应用程序调用了System.exit()方法立即终止进程，可能会导致剩余的运行线程在进程实际退出之前崩溃</span>
        nativeSetExitWithoutCleanup(<span class="hljs-literal">true</span>);

        VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);
        VMRuntime.getRuntime().setDisabledCompatChanges(disabledCompatChanges);

        <span class="hljs-keyword">final</span> <span class="hljs-type">Arguments</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arguments</span>(argv);

        <span class="hljs-comment">// The end of of the RuntimeInit event (see #zygoteInit).</span>
        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);

        <span class="hljs-comment">// Remaining arguments are passed to the start class's static main</span>
        <span class="hljs-keyword">return</span> findStaticMain(args.startClass, args.startArgs, classLoader);
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">findStaticMain</span><span class="hljs-params">(String className, String[] argv,
                                             ClassLoader classLoader)</span> {
        <span class="hljs-comment">// 待加载的类，这里是指ActivityThread，</span>
        <span class="hljs-comment">// 就是前面ProcessList的startProcessLocked()中的 String entryPoint = "android.app.ActivityThread"</span>
        Class&lt;?&gt; cl;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 加载 android.app.ActivityThread 类</span>
            cl = Class.forName(className, <span class="hljs-literal">true</span>, classLoader);
        } <span class="hljs-keyword">catch</span> (ClassNotFoundException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"Missing class when invoking static main "</span> + className, ex);
        }

        Method m;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取ActivityThread的main()函数</span>
            m = cl.getMethod(<span class="hljs-string">"main"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]{String[].class});
        } <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Missing static main on "</span> + className, ex);
        } <span class="hljs-keyword">catch</span> (SecurityException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Problem getting static main on "</span> + className, ex);
        }
        <span class="hljs-comment">// 判断main()方法是不是 public static 类型 </span>
        <span class="hljs-type">int</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> m.getModifiers();
        <span class="hljs-keyword">if</span> (!(Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Main method is not public and static on "</span> + className);
        }
        <span class="hljs-comment">// 返回 Caller，即本小节第一部分的 ZygoteInit.main() 中的 caller </span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAndArgsCaller</span>(m, argv);
    }
} 
</code></pre>
<p>applicationInit()方法中首先做了一个System.exit()的保护，防止退出进程时发生Crash，设置 targetSDKVersion 等参数，最后调用findStaticMain()方法去加载ActivityThread类以及方法。 findStaticMain()方法中通过ClassLoader加载获取目标类ActivityThread，后获取其静态main()方法，然后封装成MethodAndArgsCaller对象返回，MethodAndArgsCaller实现了Runnable接口。即ZygoteInit的main()方法的 caller，如果caller != null 会调用这个caller的run()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeInit</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodAndArgsCaller</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-comment">/** method to call */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;
        
        <span class="hljs-comment">/** argument array */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] mArgs;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodAndArgsCaller</span><span class="hljs-params">(Method method, String[] args)</span> {
            mMethod = method;
            mArgs = args;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{mArgs});
            } <span class="hljs-keyword">catch</span> (IllegalAccessException ex) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);
            } <span class="hljs-keyword">catch</span> (InvocationTargetException ex) { 
                ...
            }
        }
    }
} 
</code></pre>
<p>MethodAndArgsCaller的run()方法中使用了invoke反射调用，至此ActivityThread的main()方法得以执行，应用进程也就成功启动了ActivityThread。</p>
<p>Zygote进程启动流程：</p>
<ol>
<li>init进程为用户空间（相对于内核空间）的第一个进程，通过解析init.rc启动Zygote进程。</li>
<li>Zygote进程启动步骤：创建虚拟机、注册JNI、执行 ZygoteInit的main()方法。</li>
<li>Zygote进程启动SystemServer进程（Zygote启动的第一个进程），这个本小节没有具体分析。</li>
<li>Zygote创建Socket连接通道，阻塞并等待新建进程的指令到来，收到指令后通过fork新建用户进程。</li>
<li>Zygote新加了一个优化进程创建的机制，UsapPool——池化机制，我跟了一下源码，是预先缓存了几个进程。</li>
</ol>
<h3 data-id="heading-3">根Activity的启动</h3>
<p><strong>ActivityThread</strong>运行在主线程中，ActivityThread的入口是它的main()方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClientTransactionHandler</span> {
    <span class="hljs-comment">//初始化ApplicationThread </span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">ApplicationThread</span> <span class="hljs-variable">mAppThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationThread</span>();
    <span class="hljs-comment">//初始化Handler，给ApplicationThread与ActivityThread通信使用 </span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">H</span> <span class="hljs-variable">mH</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">H</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> { 
        ...
        <span class="hljs-comment">//准备主线程的Looper </span>
        Looper.prepareMainLooper();
        <span class="hljs-comment">//获取startSeq long startSeq = 0; </span>
        <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> args.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) {
                <span class="hljs-keyword">if</span> (args[i] != <span class="hljs-literal">null</span> &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) {
                    startSeq = Long.parseLong(
                            args[i].substring(PROC_START_SEQ_IDENT.length()));
                }
            }
        }
        <span class="hljs-comment">//这里实例化ActivityThread，也就实例化了上面的mH </span>
        <span class="hljs-type">ActivityThread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityThread</span>();
        <span class="hljs-comment">//调用ActivityThread的attach()方法 </span>
        thread.attach(<span class="hljs-literal">false</span>, startSeq);
        <span class="hljs-comment">//获取Handler </span>
        <span class="hljs-keyword">if</span> (sMainThreadHandler == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// sMainThreadHandler = mH </span>
            sMainThreadHandler = thread.getHandler();
        } 
        ...
        <span class="hljs-comment">//开启主线程Looper循环 </span>
        Looper.loop();
        <span class="hljs-comment">//因为主线程的Looper是不能退出的，退出就无法接收事件了。一旦意外退出，会抛出异常 </span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Main thread loop unexpectedly exited"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(<span class="hljs-type">boolean</span> system, <span class="hljs-type">long</span> startSeq)</span> { 
        ...
        <span class="hljs-keyword">if</span> (!system) {
            ...
            <span class="hljs-keyword">final</span> <span class="hljs-type">IActivityManager</span> <span class="hljs-variable">mgr</span> <span class="hljs-operator">=</span> ActivityManager.getService(); 
            ...
            mgr.attachApplication(mAppThread, startSeq); 
            ...
        } <span class="hljs-keyword">else</span> {
            ...
        } 
        ...
    }
} 
</code></pre>
<p>ActivityThread的attach()方法中使用Binder通信跨进程调用了AMS的attachApplication()方法，并将ApplicationThread作为参数传递过去。 下面执行AMS绑定ApplicationThread：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityManager</span>.Stub 
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, BatteryStatsImpl.BatteryCallback {
        
    <span class="hljs-comment">// ActivityTaskManagerInternal是一个抽象类，实现类是ATMS的内部类LocalService</span>
    <span class="hljs-comment">// ATMS启动的时候，通过LocalServices的addService()方法注册进LocalServices</span>
    <span class="hljs-keyword">public</span> ActivityTaskManagerInternal mAtmInternal;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ActivityManagerService</span><span class="hljs-params">(Context systemContext, ActivityTaskManagerService atm)</span> {
        ...
        mAtmInternal = LocalServices.getService(ActivityTaskManagerInternal.class);
        ...
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachApplication</span><span class="hljs-params">(IApplicationThread thread, <span class="hljs-type">long</span> startSeq)</span> {
        <span class="hljs-keyword">if</span> (thread == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityException</span>(<span class="hljs-string">"Invalid application interface"</span>);
        }
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingUid</span> <span class="hljs-operator">=</span> Binder.getCallingUid();
            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">origId</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();
            attachApplicationLocked(thread, callingPid, callingUid, startSeq);
            Binder.restoreCallingIdentity(origId);
        }
    }

    <span class="hljs-meta">@GuardedBy("this")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">attachApplicationLocked</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> IApplicationThread thread, 
            <span class="hljs-type">int</span> pid, <span class="hljs-type">int</span> callingUid, <span class="hljs-type">long</span> startSeq)</span> {
        <span class="hljs-comment">// 保存当前正在运行的进程的所有信息</span>
        ProcessRecord app;
        ...
        <span class="hljs-keyword">try</span> {
            ...
            <span class="hljs-comment">// 跨进程调用应用进程ApplicationThread的bindApplication()创建绑定Application</span>
            thread.bindApplication(processName, appInfo, providerList, <span class="hljs-literal">null</span>, profilerInfo,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, testMode, 
                    mBinderTransactionTrackingEnabled, enableTrackAllocation,
                    isRestrictedBackupMode || !normalMode, app.isPersistent(),
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(app.getWindowProcessController().getConfiguration()),
                    app.compat, getCommonServicesLocked(app.isolated),
                    mCoreSettingsObserver.getCoreSettingsLocked(),
                    buildSerial, autofillOptions, contentCaptureOptions,
                    app.mDisabledCompatChanges);
            ...
            <span class="hljs-comment">// Make app active after binding application or client may be running requests (e.g </span>
            <span class="hljs-comment">// starting activities) before it is ready.</span>
            <span class="hljs-comment">//给WindowProcessController中的变量mThread赋值</span>
            app.makeActive(thread, mProcessStats);
            ...
        }
        ...
        <span class="hljs-comment">//通过ATMS启动根Activity</span>
        didSomething = mAtmInternal.attachApplication(app.getWindowProcessController());
        ...
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>AMS的attachApplication()方法在获取到 pid、uid后继续调用AMS的attachApplicationLocked()方法。</p>
<p>AMS的attachApplicationLocked()方法中关注以下流程：</p>
<ol>
<li>通过跨进程通信调用应用进程中ApplicationThread的bindApplication()创建并绑定Application。</li>
<li>ProcessRecord调用makeActive()方法给WindowProcessController中的变量mThread赋值。</li>
<li>通过ActivityTaskManagerInternal本地服务过渡到ATMS启动根Activity。</li>
</ol>
<p>先来看看makeActive()方法代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessRecord</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowProcessListener</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeActive</span><span class="hljs-params">(IApplicationThread _thread, ProcessStatsService tracker)</span> {
        ...
        thread = _thread; 
        mWindowProcessController.setThread(thread); 
    } 
} 
</code></pre>
<p>里面调用了WindowProcessController的setThread()方法存储IApplicationThread实例，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowProcessController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ConfigurationContainer</span>&lt;ConfigurationContainer&gt;
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurationContainerListener</span> {

    <span class="hljs-keyword">private</span> IApplicationThread mThread;

    <span class="hljs-meta">@HotPath(caller = HotPath.PROCESS_CHANGE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setThread</span><span class="hljs-params">(IApplicationThread thread)</span> {
        <span class="hljs-keyword">synchronized</span> (mAtm.mGlobalLockWithoutBoost) {
            mThread = thread;
            <span class="hljs-keyword">if</span> (thread != <span class="hljs-literal">null</span>) {
                setLastReportedConfiguration(getConfiguration());
            }
        }
    }

    IApplicationThread <span class="hljs-title function_">getThread</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mThread;
    }

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasThread</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> mThread != <span class="hljs-literal">null</span>;
    }

} 
</code></pre>
<p>WindowProcessController的setThread()方法中将传入的IApplicationThread实例赋值给mThread保存，前面进程不存在的情况下，startSpecificActivity()方法中通过wpc.hasThread()拿到的值为false，因为进程创建完成后才给WindowProcessController中的mThread赋值。IApplicationThread的bindApplication()方法调用的是应用进程中的实现类ApplicationThread的bindApplication()方法，方法中通过内部类H发送Handler消息，进而调用到ActivityThread的handleBindApplication()方法，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClientTransactionHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(AppBindData data)</span> { 
        ...
        <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">appContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, data.info);
        updateLocaleListFromAppContext(appContext, 
                mResourcesManager.getConfiguration().getLocales()); 
        ...
        <span class="hljs-keyword">if</span> (ii != <span class="hljs-literal">null</span>) { 
            ...
            <span class="hljs-keyword">final</span> <span class="hljs-type">LoadedApk</span> <span class="hljs-variable">pi</span> <span class="hljs-operator">=</span> getPackageInfo(instrApp, data.compatInfo, 
                    appContext.getClassLoader(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
                    
            <span class="hljs-keyword">final</span> <span class="hljs-type">ContextImpl</span> <span class="hljs-variable">instrContext</span> <span class="hljs-operator">=</span> ContextImpl.createAppContext(<span class="hljs-built_in">this</span>, pi, 
                    appContext.getOpPackageName());
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 获取ClassLoader加载类文件 </span>
                <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> instrContext.getClassLoader();
                <span class="hljs-comment">// 构建Instrumentation实例 </span>
                mInstrumentation = (Instrumentation)
                    cl.loadClass(data.instrumentationName.getClassName()).newInstance();
            } 
            ...
            <span class="hljs-keyword">final</span> <span class="hljs-type">ComponentName</span> <span class="hljs-variable">component</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(ii.packageName, ii.name);
            mInstrumentation.init(<span class="hljs-built_in">this</span>, instrContext, appContext, component,
                    data.instrumentationWatcher, data.instrumentationUiAutomationConnection);
            ...
        } 
        ...
        Application app; 
        ...
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建Application </span>
            app = data.info.makeApplication(data.restrictedBackupMode, <span class="hljs-literal">null</span>); 
            ...
            mInitialApplication = app;
            <span class="hljs-comment">//初始化ContentProvider，里面会构建ContentProvider实例并调用其onCreate()方法 </span>
            <span class="hljs-keyword">if</span> (!data.restrictedBackupMode) {
                <span class="hljs-keyword">if</span> (!ArrayUtils.isEmpty(data.providers)) {
                    installContentProviders(app, data.providers);
                }
            }
            <span class="hljs-keyword">try</span> {
                mInstrumentation.onCreate(data.instrumentationArgs);
            } 
            ...
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 内部调用了Application的onCreate()的方法 </span>
                mInstrumentation.callApplicationOnCreate(app); 
            } 
            ...
        } 
        ...
    }
}
</code></pre>
<p>在handleBindApplication()方法中创建了Instrumentation实例和Application实例，调用了<code>mInstrumentation.callApplicationOnCreate(app)</code>，里面调用了Application的onCreate()的方法。ActivityThread的performLaunchActivity()方法中也有创建Application实例的操作，里面会先判断Application是否已存在。也就是说，<strong>正常情况下Application的初始化是在handleBindApplication方法中的，并且是创建进程后调用的。performLaunchActivity()中只是做了一个检测，异常情况Application不存在时才会创建。</strong> 这里注意一点，创建Application后，马上会执行Application的attach()方法，attach()内部会调用attachBaseContext()方法，后面才是Application的onCreate()方法。</p>
<p>回到前面的ATMS中的attachApplication()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityTaskManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IActivityTaskManager</span>.Stub {
    <span class="hljs-comment">// 启动的时候注册到 LocalServices 中 </span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        LocalServices.addService(ActivityTaskManagerInternal.class, mInternal);
    }

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ActivityTaskManagerInternal</span> { 
        ...
        <span class="hljs-meta">@HotPath(caller = HotPath.PROCESS_CHANGE)</span>
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">attachApplication</span><span class="hljs-params">(WindowProcessController wpc)</span> <span class="hljs-keyword">throws</span> RemoteException {
            <span class="hljs-keyword">synchronized</span> (mGlobalLockWithoutBoost) {
                <span class="hljs-keyword">if</span> (Trace.isTagEnabled(TRACE_TAG_WINDOW_MANAGER)) {
                    Trace.traceBegin(TRACE_TAG_WINDOW_MANAGER, <span class="hljs-string">"attachApplication:"</span> + wpc.mName);
                }
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">//调用RootWindowContainer的attachApplication()方法 </span>
                    <span class="hljs-keyword">return</span> mRootWindowContainer.attachApplication(wpc);
                } <span class="hljs-keyword">finally</span> {
                    Trace.traceEnd(TRACE_TAG_WINDOW_MANAGER);
                }
            }
        } 
        ...
    }
} 
</code></pre>
<p>ActivityTaskManagerInternal是一个抽象类，实现类是ATMS的内部类LocalService，所以AMS中调用 ActivityTaskManagerInternal的方法，实际上调用的是ATMS中的实现类LocalService的方法。该方法继续调用 RootWindowContainer的attachApplication()方法，启动流程交给RootWindowContainer处理。RootWindowContainer的attachApplication()方法代码如下：</p>
<pre><code class="hljs language-java" lang="java">RootWindowContainer <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WindowContainer</span>&lt;DisplayContent&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DisplayManager</span>.DisplayListener { 

    <span class="hljs-type">boolean</span> <span class="hljs-title function_">attachApplication</span><span class="hljs-params">(WindowProcessController app)</span> <span class="hljs-keyword">throws</span> RemoteException {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">didSomething</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">displayNdx</span> <span class="hljs-operator">=</span> getChildCount() - <span class="hljs-number">1</span>; displayNdx &gt;= <span class="hljs-number">0</span>; --displayNdx) {
            mTmpRemoteException = <span class="hljs-literal">null</span>;
            mTmpBoolean = <span class="hljs-literal">false</span>; <span class="hljs-comment">// Set to true if an activity was started.</span>

            <span class="hljs-keyword">final</span> <span class="hljs-type">DisplayContent</span> <span class="hljs-variable">display</span> <span class="hljs-operator">=</span> getChildAt(displayNdx);
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">areaNdx</span> <span class="hljs-operator">=</span> display.getTaskDisplayAreaCount() - <span class="hljs-number">1</span>; areaNdx &gt;= <span class="hljs-number">0</span>; --areaNdx) {
                <span class="hljs-keyword">final</span> <span class="hljs-type">TaskDisplayArea</span> <span class="hljs-variable">taskDisplayArea</span> <span class="hljs-operator">=</span> display.getTaskDisplayAreaAt(areaNdx);
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">taskNdx</span> <span class="hljs-operator">=</span> taskDisplayArea.getStackCount() - <span class="hljs-number">1</span>; taskNdx &gt;= <span class="hljs-number">0</span>; --taskNdx) {
                    <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityStack</span> <span class="hljs-variable">rootTask</span> <span class="hljs-operator">=</span> taskDisplayArea.getStackAt(taskNdx);
                    <span class="hljs-keyword">if</span> (rootTask.getVisibility(<span class="hljs-literal">null</span> <span class="hljs-comment">/*starting*/</span>) == STACK_VISIBILITY_INVISIBLE) {
                        <span class="hljs-keyword">break</span>;
                    }
                    <span class="hljs-keyword">final</span> <span class="hljs-type">PooledFunction</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> PooledLambda.obtainFunction(
                            RootWindowContainer::startActivityForAttachedApplicationIfNeeded, <span class="hljs-built_in">this</span>,
                            PooledLambda.__(ActivityRecord.class), app,
                            rootTask.topRunningActivity());
                    rootTask.forAllActivities(c);
                    c.recycle();
                    <span class="hljs-keyword">if</span> (mTmpRemoteException != <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">throw</span> mTmpRemoteException;
                    }
                }
            }
            didSomething |= mTmpBoolean;
        }
        <span class="hljs-keyword">if</span> (!didSomething) {
            ensureActivitiesVisible(<span class="hljs-literal">null</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span> <span class="hljs-comment">/* preserve_windows */</span>);
        }
        <span class="hljs-keyword">return</span> didSomething;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startActivityForAttachedApplicationIfNeeded</span><span class="hljs-params">(ActivityRecord r,
            WindowProcessController app, ActivityRecord top)</span> {
        <span class="hljs-keyword">if</span> (r.finishing || !r.okToShowLocked() || !r.visibleIgnoringKeyguard || r.app != <span class="hljs-literal">null</span>
                || app.mUid != r.info.applicationInfo.uid || !app.mName.equals(r.processName)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (mStackSupervisor.realStartActivityLocked(r, app,
                    top == r &amp;&amp; r.isFocusable() <span class="hljs-comment">/*andResume*/</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">/*checkConfig*/</span>)) {
                mTmpBoolean = <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
            ...
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    } 

} 
</code></pre>
<p>RootWindowContainer的attachApplication()方法中，调用到RootWindowContainer的startActivityForAttachedApplicationIfNeeded()方法。RootWindowContainer的 startActivityForAttachedApplicationIfNeeded()方法中继续调用ActivityStackSupervisor的 realStartActivityLocked()方法。从这里开始，又跟普通Activity的启动流程一样了。</p>
<p>我们发现，<strong>根Activity启动前需要创建进程，然后执行ActivityThread的main()方法，开启主线程循环，初始化并绑定Application、赋值IApplicationThread，最后真正的启动过程和普通Activity是一致的。</strong></p>
<p>整个流程梳理成流程图如下所示： <img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/670d05f040634d2dadd47d031512c3d0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1966&amp;h=1389&amp;s=198171&amp;e=png&amp;b=ffffff" alt="根Activity的启动流程.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[硬核] 给 LLM 配上“自动换刀库”：智能体来了（西南总部）【AI智能体运营工程师就业班】的插件开发实战笔记]]></title>    <link>https://juejin.cn/post/7597635202324611124</link>    <guid>https://juejin.cn/post/7597635202324611124</guid>    <pubDate>2026-01-21T10:37:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324611124" data-draft-id="7597635202324578356" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[硬核] 给 LLM 配上“自动换刀库”：智能体来了（西南总部）【AI智能体运营工程师就业班】的插件开发实战笔记"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-21T10:37:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老百姓懂点AI"/> <meta itemprop="url" content="https://juejin.cn/user/819569764079769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [硬核] 给 LLM 配上“自动换刀库”：智能体来了（西南总部）【AI智能体运营工程师就业班】的插件开发实战笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819569764079769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老百姓懂点AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:37:06.000Z" title="Wed Jan 21 2026 10:37:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h3 data-id="heading-0">🚀 写在前面：当大模型遇到“物理墙”</h3>
<p>在大语言模型（LLM）的开发圈子里，有一个共识：<strong>没有 Tool Use（工具调用）能力的 LLM，只是一个只会空谈的哲学家。</strong></p>
<p>作为一名机械工程背景的开发者，我习惯用“机械原理”来理解软件架构。在我看来，LLM 就像是一台拥有顶级扭矩和转速的<strong>五轴机床主轴</strong>，它动力澎湃，算力惊人。但是，如果这根主轴上不装任何<strong>刀具（Cutter）</strong> ，它就无法对物理世界进行任何切削（执行操作）。它可以完美地描述“如何加工一个齿轮”，但它造不出齿轮。</p>
<p>如何让 LLM 真正落地？答案就是 <strong>Agent（智能体）</strong> 。而 Agent 的核心，在于构建一个强大的 <strong>ATC（自动换刀系统，Automatic Tool Changer）</strong> 。</p>
<p>本文将复盘我在<strong>智能体来了（西南总部）参加【AI智能体运营工程师就业班】期间，在技术导师金加德讲师</strong>指导下，如何从零开始开发、调试并优化一个工业级 Agent 插件（Plugin）的全过程。我们将深入探讨 <code>Function Calling</code> 的底层逻辑，以及如何用“机械思维”解决 LLM 的幻觉问题。</p>
<hr/>
<h3 data-id="heading-1">一、 架构设计：什么是 LLM 的“自动换刀”？</h3>
<p>在数控加工中，ATC 系统根据 G 代码指令，自动从刀库中抓取 T01（铣刀）、T02（钻头）装在主轴上。</p>
<p>在 Agent 开发中，这个过程映射如下：</p>
<ul>
<li><strong>主轴 (Spindle) = LLM (推理核心)</strong> ：负责理解用户意图 (Intent)，规划任务链 (Chain of Thought)。</li>
<li><strong>刀具 (Tool) = Plugin / API (执行单元)</strong> ：负责执行具体动作（查库存、算参数、发邮件）。</li>
<li><strong>刀柄标准 (Holder Standard) = JSON Schema (接口定义)</strong> ：LLM 与工具之间的通信协议。如果协议对不上（比如 BT40 刀柄插不进 BT50 主轴），调用就会失败。</li>
</ul>
<p>我在<strong>智能体来了（西南总部）的项目目标是：开发一个“机床售后备件查询插件”</strong> ，让 Agent 能够回答：“VMC850 的主轴轴承还有货吗？”</p>
<hr/>
<h3 data-id="heading-2">二、 实战 Step 1：磨刀（编写 Python 业务逻辑）</h3>
<p>首先，我们需要一把“锋利的刀”。这部分是纯粹的后端逻辑，不涉及 AI。</p>
<p>我们需要编写一个 Python 函数，能够连接 ERP 数据库并查询数据。</p>
<p>Python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pymysql
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>

<span class="hljs-comment"># 模拟 ERP 数据库连接配置</span>
DB_CONFIG = {
    <span class="hljs-string">"host"</span>: <span class="hljs-string">"192.168.1.100"</span>,
    <span class="hljs-string">"user"</span>: <span class="hljs-string">"admin"</span>,
    <span class="hljs-string">"password"</span>: <span class="hljs-string">"secure_password"</span>,
    <span class="hljs-string">"db"</span>: <span class="hljs-string">"mes_inventory"</span>
}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_spare_part_stock</span>(<span class="hljs-params">part_model: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""
    [Core Logic] 实际执行查询的 Python 函数
    这就像是铣刀的硬质合金刀片，负责真正的切削
    """</span>
    connection = pymysql.connect(**DB_CONFIG)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> connection.cursor() <span class="hljs-keyword">as</span> cursor:
            <span class="hljs-comment"># 模拟查询逻辑</span>
            sql = <span class="hljs-string">"SELECT quantity, warehouse_loc, price FROM stock WHERE model_id = %s"</span>
            cursor.execute(sql, (part_model,))
            result = cursor.fetchone()
            
            <span class="hljs-keyword">if</span> result:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>,
                    <span class="hljs-string">"model"</span>: part_model,
                    <span class="hljs-string">"quantity"</span>: result[<span class="hljs-number">0</span>],
                    <span class="hljs-string">"location"</span>: result[<span class="hljs-number">1</span>],
                    <span class="hljs-string">"price"</span>: <span class="hljs-built_in">float</span>(result[<span class="hljs-number">2</span>])
                }
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"not_found"</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">f"型号 <span class="hljs-subst">{part_model}</span> 无库存记录"</span>}
    <span class="hljs-keyword">finally</span>:
        connection.close()
</code></pre>
<p>这段代码对于掘金的开发者来说没有任何难度。但关键在于：<strong>LLM 怎么知道如何调用它？</strong></p>
<hr/>
<h3 data-id="heading-3">三、 实战 Step 2：定义刀柄（编写 JSON Schema）</h3>
<p>这是 Agent 开发中最硬核、也最容易踩坑的环节。</p>
<p>LLM 不会读你的 Python 源码，它只读你的 <strong>API 描述（Schema）</strong> 。</p>
<p>在**【AI智能体运营工程师就业班】**上，<strong>金加德讲师</strong>反复强调：“<strong>Schema 就是 Prompt 的一部分。</strong> 你在 Schema 里写的每一个字段描述，都会进入 LLM 的上下文窗口。写得越烂，LLM 抓错刀的概率就越大。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fdff7778f514ba6a63fd0ecf3375308~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB55m-5aeT5oeC54K5QUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769596626&amp;x-signature=JD8UUsqOGI1Kp4XfDpzVszQTtT8%3D" alt="dreamina-2026-01-21-3557-Schema 就是 Prompt 的一部分。 你在 Schema 里写的每一个字....jpeg" loading="lazy"/></p>
<h4 data-id="heading-4">❌ 错误的写法（导致幻觉）：</h4>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_stock"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查库存"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 太简略，LLM 不知道什么时候用</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"part_model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"型号"</span> <span class="hljs-comment">// 模糊，LLM 可能会把 "轴承" 这个词直接传进来</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-5">✅ 金加德讲师推荐的“工业级”写法：</h4>
<p>我们采用了类似 OpenAPI (Swagger) 的规范，加入了大量的<strong>约束条件</strong>和**Few-Shot（少样本）**提示。</p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_spare_part_stock"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"当用户询问特定机床配件的库存数量、价格或存放位置时，必须使用此工具。注意：此工具仅接受标准的物料编码（如 'H7002-C'），不接受模糊名称（如 '那个红色的轴承'）。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"part_model"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"目标配件的精确型号代码。如果用户未提供具体型号，请先追问用户，不要臆造型号。"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"examples"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"H7002-C"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"A860-2000-T301"</span><span class="hljs-punctuation">]</span> 
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"part_model"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>技术要点解析：</strong></p>
<ol>
<li><strong>Description 增强：</strong> 明确了“When to use”（什么时候用）和“What NOT to do”（不要做什么）。这相当于在刀柄上刻了“严禁超速”的警示语。</li>
<li><strong>Examples 注入：</strong> 给出了具体的参数示例。这对 LLM 提取参数的准确率提升巨大。</li>
</ol>
<hr/>
<h3 data-id="heading-6">四、 实战 Step 3：试切削（调试与 Function Calling 流程）</h3>
<p>配置好 Coze (或者 LangChain) 后，我们进行链路测试。</p>
<p>这里展示一下 <strong>Function Calling</strong> 在后台的真实交互日志（Trace），这对于理解 Agent 原理至关重要。</p>
<p><strong>User Input:</strong></p>
<blockquote>
<p>“帮我查一下 VMC850 的主轴编码器 A860 还有没有货？”</p>
</blockquote>
<p><strong>Agent Trace (Round 1):</strong></p>
<ol>
<li>
<p><strong>Thinking (Thought Chain):</strong></p>
<ul>
<li>用户意图：查询库存。</li>
<li>可用工具：<code>query_spare_part_stock</code>。</li>
<li>参数提取：识别到关键词 "A860"（注意：这里 LLM 可能会提取不完整）。</li>
<li><em>决策：</em> 调用工具。</li>
</ul>
</li>
<li>
<p><strong>Call Tool (Action):</strong></p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"function_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_spare_part_stock"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{"</span>part_model<span class="hljs-string">": "</span>A860<span class="hljs-string">"}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Tool Output (Observation):</strong></p>
<ul>
<li><em>System:</em> 调用 Python 函数... 返回 <code>{"status": "not_found", "msg": "型号 A860 无库存记录"}</code>。</li>
<li><em>注：</em> 因为型号不完整，导致查询失败。这在工业场景很常见。</li>
</ul>
</li>
</ol>
<p><strong>Agent Trace (Round 2 - 自我修正):</strong></p>
<ol start="4">
<li>
<p><strong>Thinking:</strong></p>
<ul>
<li>工具返回“无记录”。可能是用户给的型号不完整，或者是真的没货。</li>
<li>根据 Schema 中的提示“不接受模糊名称”，我应该追问用户确认完整型号，而不是直接说没货。</li>
</ul>
</li>
<li>
<p><strong>Final Response:</strong></p>
<blockquote>
<p>“系统查询‘A860’未找到记录。请问您是指 <strong>A860-2000-T301</strong>（通用编码器）还是其他具体子型号？请提供完整物料代码。”</p>
</blockquote>
</li>
</ol>
<p><strong>复盘：</strong></p>
<p>看到没？这就是**“Schema 调优”**的威力。如果我们在 Schema 里没有写那句“不要臆造型号”，LLM 很有可能就直接编造一个库存数量回答用户了（幻觉）。</p>
<hr/>
<h3 data-id="heading-7">五、 进阶技巧：如何处理“非标刀具”？</h3>
<p>在**智能体来了（西南总部）**的高阶课程中，我们还解决了一个更复杂的问题：<strong>多步参数清洗</strong>。</p>
<p>有时候，用户的输入非常不标准，比如“查一下内径50的那个日本轴承”。</p>
<p>这时候，单一的插件（刀具）搞不定。我们需要<strong>组合刀具</strong>。</p>
<p>我设计了一个 <strong>Workflow（工作流）</strong> ，串联了两个节点：</p>
<ol>
<li><strong>Node A (LLM 模糊匹配):</strong> 先用一个大模型节点，结合 RAG 知识库，将“内径50的日本轴承”翻译成标准型号列表 <code>["NSK-6210", "NTN-6210"]</code>。</li>
<li><strong>Node B (Python 查询):</strong> 再遍历这个列表，去调用 <code>query_spare_part_stock</code>。</li>
</ol>
<p>这就好比数控机床的<strong>复合加工</strong>：先用车刀把毛坯车圆（标准化），再用铣刀铣键槽（查数据）。</p>
<hr/>
<h3 data-id="heading-8">六、 总结：从 Developer 到 Operator</h3>
<p>通过这次实战，我对<strong>AI 智能体运营工程师</strong>这个岗位有了更深的理解。</p>
<p>我们不是在写传统的 CRUD 业务代码，我们是在**“编写机器人的说明书”**。</p>
<ul>
<li>Python 代码决定了 Agent <strong>能做什么（能力边界）</strong> 。</li>
<li>JSON Schema 决定了 Agent <strong>知不知道怎么做（认知边界）</strong> 。</li>
</ul>
<p>正如<strong>金加德讲师</strong>所言：“未来的编程，一半是写给机器看的（Code），一半是写给模型看的（Prompt/Schema）。掌握这两门语言的人，才是 AI 时代的架构师。”</p>
<p>如果你也是技术出身，建议赶紧去玩一下 Coze 或 LangChain。当你看到自己写的 Python 函数被 LLM 像抓取刀具一样灵活调用时，那种**“给大脑装上双手”**的成就感，是无与伦比的。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 框架之文档加载器]]></title>    <link>https://juejin.cn/post/7597642574933737481</link>    <guid>https://juejin.cn/post/7597642574933737481</guid>    <pubDate>2026-01-21T10:29:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597642574933737481" data-draft-id="7597623392456228915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 框架之文档加载器"/> <meta itemprop="keywords" content="AIGC,AI编程,LangChain"/> <meta itemprop="datePublished" content="2026-01-21T10:29:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草帽lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 框架之文档加载器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草帽lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:29:07.000Z" title="Wed Jan 21 2026 10:29:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>之前学到了 LangChain 框架的核心组件记忆，接下来学习文档加载器（Document Loaders）</p>
<h2 data-id="heading-1">文档加载器（Document Loaders）</h2>
<p>作用就是加载外部的文档到 LangChain 中，读取文档中的内容，然后用于后续的处理和分析</p>
<h2 data-id="heading-2">应用场景</h2>
<p>基于文档的问答系统，日常比较常见的例如客服系统，根据产品手册自动回答相关问题，文字自动分类等；个人笔记知识库，基于自己的笔记文档等进行回答，总结等；以及其他场景如学习研究，教育内容管理 等等</p>
<h3 data-id="heading-3">文本文件加载 （TextLoader）</h3>
<p>TextLoader 是最基础的文档加载器，用于加载纯文本文件</p>
<p>通过 <code>TextLoader()</code> 加载文件,代码如下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> TextLoader  <span class="hljs-comment"># 文本文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>
...
    <span class="hljs-comment"># 创建一个示例文本文件</span>
    sample_text = <span class="hljs-string">"""
    LangChain 是一个用于构建基于大型语言模型(LLM)应用程序的框架。
    它提供了模块化的组件，让开发者能够轻松地构建复杂的AI应用。
    
    主要特点：
    1. 模块化设计
    2. 易于使用
    3. 支持多种LLM
    4. 丰富的工具集成
    """</span>
    
    <span class="hljs-comment"># 将示例文本写入文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"sample.txt"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(sample_text)
    
    <span class="hljs-comment"># 使用 TextLoader 加载文本文件</span>
    loader = TextLoader(<span class="hljs-string">"sample.txt"</span>, encoding=<span class="hljs-string">"utf-8"</span>)  <span class="hljs-comment"># 创建文本加载器，指定编码格式</span>
    documents = loader.load()  <span class="hljs-comment"># 加载文档，返回 Document 对象列表</span>
    
    <span class="hljs-comment"># 打印加载结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文档内容: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].page_content[:<span class="hljs-number">1000</span>]}</span>..."</span>)  <span class="hljs-comment"># 打印前1000个字符</span>
...
</code></pre>
<p>通过 <code>loader.load()</code> 返回的对象，包含了文档内容，可以通过 <code>page_content</code> 属性读取，整体操作很简单，两三行代码就能读取文件</p>
<h3 data-id="heading-4">PDF加载器 （PyPDFLoader）</h3>
<p>PyPDFLoader 是用于加载 PDF 文件的文档加载器，可以读取 PDF 文件中的文本内容</p>
<p>通过 <code>PyPDFLoader()</code> 加载文件,代码如下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> PyPDFLoader  <span class="hljs-comment"># PDF 文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>
...
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 使用 PyPDFLoader 加载同级目录下的 PDF 文件</span>
        loader = PyPDFLoader(<span class="hljs-string">"document.pdf"</span>)  <span class="hljs-comment"># 创建PDF加载器</span>
        documents = loader.load()  <span class="hljs-comment"># 加载PDF文档</span>
        
        <span class="hljs-comment"># 打印加载结果</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nPDF内容预览："</span>)
        
        <span class="hljs-comment"># 遍历每一页并输出内容</span>
        <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(documents):
            page_num = doc.metadata.get(<span class="hljs-string">"page"</span>, i + <span class="hljs-number">1</span>)  <span class="hljs-comment"># 获取页码</span>
            content = doc.page_content.strip()  <span class="hljs-comment"># 获取页面内容并去除首尾空格</span>
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 页面 <span class="hljs-subst">{page_num}</span> ---"</span>)
            <span class="hljs-keyword">if</span> content:
                <span class="hljs-comment"># 限制每页输出长度，避免内容过长</span>
                preview = content[:<span class="hljs-number">300</span>] + <span class="hljs-string">"..."</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(content) &gt; <span class="hljs-number">300</span> <span class="hljs-keyword">else</span> content
                <span class="hljs-built_in">print</span>(preview)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"(此页面无文本内容)"</span>)
            
            <span class="hljs-comment"># 打印页面元数据</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"元数据: <span class="hljs-subst">{doc.metadata}</span>"</span>)
        
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：找不到 document.pdf 文件"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请确保在同级目录下存在 document.pdf 文件"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF加载错误: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"可能的原因："</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. PDF文件损坏"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. PDF文件受密码保护"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 缺少PDF处理依赖"</span>)

</code></pre>
<p>和文本加载器类似，通过 <code>loader.load()</code> 返回的对象，包含了文档内容，可以通过 <code>page_content</code> 属性读取，读取PDF文件数据时或输出的时候按需处理对应的格式</p>
<h3 data-id="heading-5">网页加载器 （WebBaseLoader）</h3>
<p>加载网页，通过网站地址加载网页内容，用法和文本，PDF加载器都一样，一两行代码就能加载网页内容</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> WebBaseLoader  <span class="hljs-comment"># 网页加载器</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 网页加载演示 ==="</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 使用 WebBaseLoader 加载 LangChain 官方文档</span>
        loader = WebBaseLoader(<span class="hljs-string">"https://docs.langchain.com/oss/python/langchain/overview"</span>)  <span class="hljs-comment"># 创建网页加载器</span>
        documents = loader.load()  <span class="hljs-comment"># 加载网页内容</span>
        
        <span class="hljs-comment"># 打印加载结果</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"网页内容预览: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].page_content[:<span class="hljs-number">500</span>]}</span>..."</span>)  <span class="hljs-comment"># 打印前500个字符</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"网页元数据: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].metadata}</span>"</span>)  <span class="hljs-comment"># 包含URL等信息</span>
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"网页加载错误: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"可能是网络连接问题或网站不可访问"</span>)
    
    <span class="hljs-built_in">print</span>()
</code></pre>
<h3 data-id="heading-6">数据库加载器 （SQLDatabaseLoader）</h3>
<p>作用是从数据库中加载数据，返回的是一个文档对象列表，每个文档对象包含了数据库中的一条记录，记录的内容就是数据库中的字段值，记录的元数据就是数据库中的字段名</p>
<p>由于我日常前端开发为主，下面使用 <code>CSVLoader</code> 加载 CSV 文件，模拟数据库数据</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> CSVLoader  <span class="hljs-comment"># CSV文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数：演示数据库内容加载"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 数据库加载演示 ==="</span>)
    
    <span class="hljs-comment"># 创建一个示例CSV文件来模拟数据库数据</span>
    csv_content = <span class="hljs-string">"""id,name,description,category
1,Python,一种高级编程语言,编程语言
2,JavaScript,网页脚本语言,编程语言
3,MySQL,关系型数据库,数据库
4,MongoDB,文档型数据库,数据库
5,Docker,容器化平台,开发工具"""</span>
    
    <span class="hljs-comment"># 将CSV内容写入文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"data.csv"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(csv_content)
    
    <span class="hljs-comment"># 使用 CSVLoader 加载CSV文件（模拟数据库数据）</span>
    loader = CSVLoader(<span class="hljs-string">"data.csv"</span>, encoding=<span class="hljs-string">"utf-8"</span>)  <span class="hljs-comment"># 创建CSV加载器</span>
    documents = loader.load()  <span class="hljs-comment"># 加载数据</span>
    
    <span class="hljs-comment"># 打印加载结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的记录数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"前3条记录："</span>)
    <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(documents[:<span class="hljs-number">3</span>]):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"记录 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{doc.page_content}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"元数据: <span class="hljs-subst">{doc.metadata}</span>"</span>)
    
    <span class="hljs-comment"># 清理示例文件</span>
    os.remove(<span class="hljs-string">"data.csv"</span>)
    
</code></pre>
<h3 data-id="heading-7">Markdown文件加载器 （MarkdownLoader）</h3>
<p>从 Markdown 文件中加载内容，和文本加载器类似，就是函数名不一样</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入必要的库</span>
<span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> UnstructuredMarkdownLoader  <span class="hljs-comment"># Markdown文件加载器</span>
<span class="hljs-keyword">import</span> os  <span class="hljs-comment"># 文件操作库</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数：演示Markdown文件加载"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== Markdown文件加载演示 ==="</span>)
    
    <span class="hljs-comment"># 创建一个示例Markdown文件</span>
    markdown_content = <span class="hljs-string">"""# LangChain 教程

## 简介
LangChain 是一个强大的框架，用于构建基于LLM的应用程序。

## 主要功能
- **文档处理**: 加载和分割各种格式的文档
- **向量存储**: 高效的文档检索
- **链式调用**: 复杂的工作流程

## 代码示例

from langchain.llms import OpenAI
llm = OpenAI()
result = llm("Hello, LangChain!")


## 总结
LangChain 让AI应用开发变得简单高效。"""</span>
    
    <span class="hljs-comment"># 将Markdown内容写入文件</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"sample.md"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(markdown_content)
    
    <span class="hljs-comment"># 使用 UnstructuredMarkdownLoader 加载Markdown文件</span>
    loader = UnstructuredMarkdownLoader(<span class="hljs-string">"sample.md"</span>)  <span class="hljs-comment"># 创建Markdown加载器</span>
    documents = loader.load()  <span class="hljs-comment"># 加载文档</span>
    
    <span class="hljs-comment"># 打印加载结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载的文档数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(documents)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文档内容预览: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].page_content[:<span class="hljs-number">200</span>]}</span>..."</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文档元数据: <span class="hljs-subst">{documents[<span class="hljs-number">0</span>].metadata}</span>"</span>)
    
    <span class="hljs-comment"># 清理示例文件</span>
    os.remove(<span class="hljs-string">"sample.md"</span>)
    <span class="hljs-built_in">print</span>()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-8">小结</h2>
<p>文档加载器相关知识点和例子就结束了，除了概念和作用有点内容了解一下，代码上没什么新鲜东西，引入的库和函数不一样，看下例子简单过一遍就行了</p>
<p>后面将继续学习文本分割器相关内容</p>
<blockquote>
<p>欢迎留言交流，如果觉得有帮助，可以<code>点个赞</code>支持一下</p>
<p>公众号：草帽lufei</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别“模糊”与“迟钝”！首创波动方程建模视觉，ImageNet 84.2%，推理速度飙升]]></title>    <link>https://juejin.cn/post/7597695487302696975</link>    <guid>https://juejin.cn/post/7597695487302696975</guid>    <pubDate>2026-01-22T02:01:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597695487302696975" data-draft-id="7597650624637927424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别“模糊”与“迟钝”！首创波动方程建模视觉，ImageNet 84.2%，推理速度飙升"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-22T02:01:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别“模糊”与“迟钝”！首创波动方程建模视觉，ImageNet 84.2%，推理速度飙升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:01:21.000Z" title="Thu Jan 22 2026 02:01:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在深度学习视觉建模领域，如何既实现高效的全局语义交互，又能精准保留图像中的高频细节（如边缘和纹理），一直是一个关键难题。传统的卷积神经网络（CNN）依赖局部感受野，难以建模长程依赖；而视觉Transformer（ViT）虽然通过自注意力实现了全局交互，但其二次复杂度限制了在高分辨率图像上的应用，且缺乏对空间频率传播的显式建模。更重要的是，多数基于物理启发的模型（如热传导方法）倾向于过度平滑高频信号，导致细节丢失。</p>
<p>那么，是否存在一种既能保持全局语义连贯性，又能避免高频信息被过度过滤的物理建模方式？</p>
<p>最近，北京大学和清华大学研究团队提出了一种全新的思路：<strong>将视觉特征传播建模为波动方程中的阻尼振荡过程</strong>，从而在频率与时间解耦的框架下，实现高效且细节保留的全局建模。</p>
<h2 data-id="heading-0"><strong>从“热传导”到“波动方程”：一种频率友好的传播机制</strong></h2>
<p>传统基于热传导的方法在频域中相当于一个强低通滤波器，高频成分会随时间迅速衰减，导致特征平滑、细节模糊。而波动方程描述的是一种<strong>振荡传播机制</strong>：不同频率的成分在传播过程中以阻尼振荡的形式共存，低频决定整体结构，高频保留局部细节，且衰减与频率无关。</p>
<p>将特征图视为空间信号，将其演化建模为一个二维阻尼波动方程：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f5e4a2198ba444c92bf7735f5722063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=RRSCCLUzQ26fOc9eRrZsCpji9v0%3D" alt="screenshot_2026-01-21_14-29-29.png" loading="lazy"/></p>
<p>其中 u 表示语义场，v 为传播速度，α 为阻尼系数。通过对该方程在频域中求解，得到了一个<strong>闭式解</strong>，实现了频率与时间的解耦：阻尼项<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9251019bf9e4d3b99ad9d5e713e497d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=dWZS8kNTmv%2Fi6pP4kZW9SrpswWo%3D" alt="screenshot_2026-01-21_14-32-48.png" loading="lazy"/>对所有频率成分一致衰减，而振荡项<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10020a4888df4d49803f80bd5665bc8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=ISPUEtzzt0HHKjftU8vgBQ7YZu8%3D" alt="screenshot_2026-01-21_14-32-56.png" loading="lazy"/>和<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4e3f4985d4b4d7390a62b6d6b147aae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=0xP2DEZYjPV%2F1n5ulS7Ru8DUJ%2FE%3D" alt="screenshot_2026-01-21_14-33-03.png" loading="lazy"/>则保留了频率特性。</p>
<h2 data-id="heading-1"><strong>Wave Propagation Operator（WPO）：波动传播的可计算模块</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ac738b01b740728407e2b71272fe1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=KgIaHfSsFOhyO3DefA%2BuvuuAlUc%3D" alt="screenshot_2026-01-21_13-57-46.png" loading="lazy"/></p>
<p>基于上述理论，研究者提出了 Wave Propagation Operator（WPO），这是一个轻量级模块，用于在频域中模拟波动传播过程。其计算过程如下：</p>
<ol>
<li>将输入特征图通过傅里叶变换转换到频域；</li>
<li>利用闭式解对每个频率分量进行阻尼振荡调制；</li>
<li>通过逆傅里叶变换将结果映射回空间域。</li>
</ol>
<p>整个过程复杂度仅为<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c04f0e203cdd43c483d6564e0da6a738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=wL42gkz6gXjPjt1nBty4O98mMyY%3D" alt="screenshot_2026-01-21_14-34-31.png" loading="lazy"/>，远低于自注意力的<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91b68e1ff00d4a8aa96f87b74c9b4bac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=kKPbwDpMhuxv6%2BPaZ%2FRBbm2sC2o%3D" alt="screenshot_2026-01-21_14-34-38.png" loading="lazy"/>，且保留了全局交互能力与高频细节。</p>
<ul>
<li><strong>WaveFormer：一个即插即用的视觉骨干网络</strong></li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4002bc679cb64725b5ce257f1668c414~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=CkIz%2FavL3VmthJg0nE4Ua%2FHjq6s%3D" alt="screenshot_2026-01-21_14-00-22.png" loading="lazy"/></p>
<p>基于WPO，研究者构建了一系列WaveFormer模型（Tiny/Small/Base），可作为标准ViT或CNN的直接替代。模型采用分层设计，每个阶段包含多个Wave Propagation Layer，结合深度卷积与前馈网络，实现多尺度特征提取。</p>
<h2 data-id="heading-2"><strong>为什么波动传播适合视觉建模？实验给出的有力证据</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840bf99674924da1a11f5b3860b2b49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=FgVWGiGxCrSMEJrGyUEmFj%2F2EQk%3D" alt="screenshot_2026-01-21_14-01-27.png" loading="lazy"/></p>
<p>与热传导相比，波动传播具有以下理论优势：</p>
<ul>
<li><strong>频率平衡：</strong> 振荡机制使能量在高低频之间更均匀分布；</li>
<li><strong>细节保留：</strong> 高频成分通过振荡项得以保留，避免过度平滑；</li>
<li><strong>双向传播：</strong> 支持信息的可逆传递，更符合语义传播的物理直觉；</li>
<li><strong>高效计算：</strong> 频域实现带来接近线性的复杂度。</li>
</ul>
<p>那么，这些理论优势是否转化为了实际性能的提升？实验给出了肯定的答案：</p>
<ol>
<li><strong>图像分类（ImageNet-1K）：</strong> WaveFormer在保持高效的同时，实现了更高的准确率。例如，<strong>WaveFormer-Base</strong> 以 <strong>10.8G FLOPs</strong> 和 <strong>68M参数</strong> 取得了 84.2% 的Top-1准确率，超过了Swin-B (83.5%) 和 vHeat-B (84.0%)。其推理吞吐量达到 <strong>719 img/s</strong>，显著高于同类模型。</li>
<li><strong>目标检测与实例分割（COCO）：</strong> 在密集预测任务中，WaveFormer展现出更强的边界和细节建模能力。使用Mask R-CNN框架，<strong>WaveFormer-Tiny</strong> 在1x训练调度下取得了 <strong>45.8% AP^b</strong> 和 <strong>41.5% AP^m</strong>，分别比Swin-T高出  <strong>+3.1%</strong> 和  <strong>+2.2%</strong> ，同时保持了更高的推理速度（FPS）。</li>
<li><strong>语义分割（ADE20K）：</strong> 这项任务对高频细节（如物体边界）的保留要求极高。<strong>WaveFormer-Base</strong> 在ADE20K数据集上达到了 <strong>50.5% mIoU</strong>，超越了同样基于物理启发的 <strong>vHeat-B (49.6%)</strong> ，以及 <strong>ConvNeXt-B (49.1%)</strong> 。这直接证明了其“频率-时间解耦”机制在保留精细结构上的有效性。</li>
</ol>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6dfcc8332aa4c978c45987add09c58c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=UC2Agtaw7EsZVMa8pJ2PVxZ%2BL%2F8%3D" alt="screenshot_2026-01-21_14-02-24.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9494b5bb20428a92cc9be6628a7ec6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=ospNvRFE0UuFaVYHGMoi06BrIYA%3D" alt="screenshot_2026-01-21_14-04-07.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dfc3f4862564911b5a241b4ed61d64d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652080&amp;x-signature=cMj6c6G7bEsl5GEw07RId7TLgNk%3D" alt="screenshot_2026-01-21_14-04-12.png" loading="lazy"/></p>
<p>这些实验结果一致表明，波动传播机制不仅是一种理论上的优雅设计，更在实践中带来了精度、效率与细节保真度的全面优势。</p>
<h2 data-id="heading-3"><strong>总结：波动方程为视觉建模注入物理直觉</strong></h2>
<p>WaveFormer的提出，不仅为视觉表示学习提供了一种高效、可解释的建模范式，也展示了<strong>物理方程与深度学习</strong>结合的潜力。通过将波动方程引入视觉传播过程，研究者成功实现了频率与时间的解耦，在保持全局语义的同时，精准保留了图像的高频细节。</p>
<p>这一工作也为未来视觉骨干网络的设计提供了新方向：<strong>如何将更多物理机制（如波动、扩散、对流等）融入深度学习架构，以带来更强大的归纳偏置与更高效的计算范式。</strong></p>
<blockquote>
<p>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.08602" target="_blank" title="https://arxiv.org/abs/2601.08602" ref="nofollow noopener noreferrer">arxiv.org/abs/2601.08…</a></p>
<p>代码开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZishanShu%2FWaveFormer" target="_blank" title="https://github.com/ZishanShu/WaveFormer" ref="nofollow noopener noreferrer">github.com/ZishanShu/W…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网易一面：Read View是干嘛的？]]></title>    <link>https://juejin.cn/post/7597650624638009344</link>    <guid>https://juejin.cn/post/7597650624638009344</guid>    <pubDate>2026-01-22T02:02:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624638009344" data-draft-id="7555780704270942227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网易一面：Read View是干嘛的？"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2026-01-22T02:02:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1665088861772688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网易一面：Read View是干嘛的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1665088861772688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:02:28.000Z" title="Thu Jan 22 2026 02:02:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><strong>文章内容收录到个人网站，方便阅读</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhardyfish.top%2F" target="_blank" title="http://hardyfish.top/" ref="nofollow noopener noreferrer">hardyfish.top/</a></p>
<blockquote>
<p>它是 InnoDB 实现 <strong>MVCC</strong> 的核心，用来判断<strong>某个行版本，对当前这次一致性读取是否可见</strong>。</p>
</blockquote>
<p>Read View 是什么？</p>
<blockquote>
<p>一份<strong>快照元数据</strong>，记录<strong>在它创建的那一刻仍然活跃的事务集合</strong>及相关边界。</p>
<p>有了它，普通 <code>SELECT</code>（不加锁）就能在<strong>不加行锁</strong>的前提下读到<strong>一致</strong>的数据版本。</p>
</blockquote>
<p><strong>Read View 主要字段（逻辑上）</strong></p>
<ul>
<li><code>m_ids</code>：创建瞬间 <strong>仍在活跃</strong> 的事务 ID 列表（未提交）。</li>
<li><code>creator_trx_id</code>：创建该 Read View 的事务 ID。</li>
<li><code>low_limit_id</code>：<code>m_ids</code> 中的最小值；如果 <code>m_ids</code> 为空则等于 <code>up_limit_id</code>。</li>
<li><code>up_limit_id</code>：创建瞬间<strong>下一个将要分配</strong>的事务 ID（相当于高水位）。</li>
</ul>
<blockquote>
<p>实际字段名在源码里是 <code>m_ids/m_low_limit_id/m_up_limit_id/m_creator_trx_id</code>，不同版本命名略有差异，但语义一致。</p>
</blockquote>
<p><strong>哪些隔离级别会用到 Read View？</strong></p>
<blockquote>
<p><strong>READ COMMITTED（RC）</strong>：</p>
<ul>
<li><strong>每条一致性读</strong>都会新建一个 Read View（所以同一事务内两次查到的结果可能不同）。</li>
</ul>
<p><strong>REPEATABLE READ（RR）</strong>：</p>
<ul>
<li><strong>第一次一致性读</strong>创建 Read View，<strong>整个事务复用</strong>这份快照（后续一致性读结果可重复）。</li>
</ul>
<p><strong>READ UNCOMMITTED</strong>：</p>
<ul>
<li>不创建 Read View（能读到未提交版本）。</li>
</ul>
<p><strong>SERIALIZABLE</strong>：</p>
<ul>
<li>普通 <code>SELECT</code> 会被提升为加锁读（走锁，不用 Read View）。</li>
</ul>
</blockquote>
<blockquote>
<p>无论什么隔离级别。</p>
<p><strong>当前读</strong>（<code>SELECT … FOR UPDATE/LOCK IN SHARE MODE</code>、<code>UPDATE/DELETE</code>）都<strong>不用</strong> Read View，而是读取最新版本并加锁。</p>
</blockquote>
<p><strong>可见性判定规则</strong></p>
<blockquote>
<p>给定某行的一个版本由事务 <code>trx_id</code> 写入，针对某个 Read View 的<strong>一致性读</strong>是否能看到它？</p>
</blockquote>
<p>伪代码如下（与 InnoDB 逻辑等价）：</p>
<pre><code class="hljs language-text" lang="text">if (trx_id == creator_trx_id)
    可见（自己改的自己能看见）
else if (trx_id &lt; low_limit_id)
    可见（该版本的事务在快照创建前已提交）
else if (trx_id &gt;= up_limit_id)
    不可见（该事务在快照之后才开始）
else if (trx_id in m_ids)
    不可见（快照时它还活跃，未提交）
else
    可见（介于 low 与 up 之间，但快照时它已不活跃 ⇒ 已提交）
</code></pre>
<blockquote>
<p>如果不可见，InnoDB 会沿着该行的 **版本链（Undo 日志）**回退到更早版本，重复上述判定，直到找到可见版本或无可见版本。</p>
</blockquote>
<p><strong>一致性读 VS 当前读</strong></p>
<blockquote>
<p><strong>一致性读（Consistent Read）</strong>：</p>
<p>普通 <code>SELECT</code>，通过 Read View 判定，<strong>不加锁</strong>，读到历史可见版本。</p>
<p><strong>当前读（Current Read）</strong>：</p>
<p><code>SELECT … FOR UPDATE</code> / <code>LOCK IN SHARE MODE</code>、<code>UPDATE/DELETE</code>。</p>
<p><strong>无视 Read View</strong>，直接读最新版本并加锁（Next-Key/记录锁），用于更新或防幻读。</p>
</blockquote>
<blockquote>
<p>在 <strong>RR</strong> 下：一致性读天然可重复；需要防幻读时，用<strong>当前读</strong>触发行间/间隙锁（Next-Key）来保证语义。</p>
</blockquote>
<p><strong>RC 与 RR 的差异直观例子</strong></p>
<pre><code class="hljs language-sql" lang="sql">T1 (RR)                         T2
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- T1 创建 Read View，看到 v0</span>
                              <span class="hljs-keyword">BEGIN</span>; <span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> c<span class="hljs-operator">=</span><span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>; <span class="hljs-keyword">COMMIT</span>; <span class="hljs-comment">-- v1</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;  <span class="hljs-comment">-- 仍看到 v0（因为复用同一 Read View）</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<blockquote>
<p>同样场景在 <strong>RC</strong>：第二次 <code>SELECT</code> 会创建<strong>新</strong> Read View，于是能看到 <code>v1</code>。</p>
</blockquote>
<p><strong>长事务、Read View 与清理（Purge）</strong></p>
<blockquote>
<p>行的旧版本保存在 <strong>Undo</strong> 中，<strong>只有当所有比它更老的 Read View 都销毁</strong>后，Purge 线程才能真正清理这些历史版本。</p>
<p><strong>长事务</strong>会拖住历史版本，导致：Undo/历史链变长、<code>history list length</code> 上升、二级索引回查变慢，甚至占用大量磁盘。</p>
<p>观测/诊断：</p>
<ul>
<li><code>SHOW ENGINE INNODB STATUS\G</code> 看 History List Length</li>
<li><code>information_schema.innodb_trx</code> 看长事务</li>
<li>合理控制事务时长、拆批、避免交互式长会话不提交。</li>
</ul>
</blockquote>
<p><strong>常见面试问法与要点答案</strong></p>
<p><strong>Q1：Read View 何时创建？</strong></p>
<ul>
<li>RC：每次一致性读的语句开始时。</li>
<li>RR：事务第一次一致性读时，或 <code>START TRANSACTION WITH CONSISTENT SNAPSHOT;</code> 执行当下立即创建。</li>
</ul>
<p><strong>Q2：为什么 RR 能可重复读？</strong></p>
<ul>
<li>因为<strong>整事务复用同一 Read View</strong>，后续一致性读都用同一快照判定可见性。</li>
</ul>
<p><strong>Q3：RR 是否靠锁避免幻读？</strong></p>
<ul>
<li>对<strong>当前读</strong>，靠 <strong>Next-Key 锁</strong>。</li>
<li>对<strong>一致性读</strong>，读的是快照，不会变，但要修改满足条件的行集仍需当前读加锁来防止并发插入/删除带来的幻影。</li>
</ul>
<p><strong>Q4：Read View 和快照隔离是一回事吗？</strong></p>
<ul>
<li>Read View 提供的是<strong>快照可见性</strong>，InnoDB 的 RR 实际效果接近/强于标准的 Snapshot Isolation，但写写冲突由锁解决。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG性能瓶颈突破：文档切分的核心逻辑与最优实践]]></title>    <link>https://juejin.cn/post/7597640029574119475</link>    <guid>https://juejin.cn/post/7597640029574119475</guid>    <pubDate>2026-01-21T10:54:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597640029574119475" data-draft-id="7597642574933966857" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG性能瓶颈突破：文档切分的核心逻辑与最优实践"/> <meta itemprop="keywords" content="算法,后端"/> <meta itemprop="datePublished" content="2026-01-21T10:54:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小刘的大模型笔记"/> <meta itemprop="url" content="https://juejin.cn/user/678839484944233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG性能瓶颈突破：文档切分的核心逻辑与最优实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/678839484944233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小刘的大模型笔记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:54:46.000Z" title="Wed Jan 21 2026 10:54:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>引言</p>
<p>在检索增强生成（RAG）系统中，有一个看似基础却能决定系统成败的关键环节——文档切分。很多开发者搭建的RAG系统，检索结果不准确、生成内容驴唇不对马嘴，究其原因，往往是文档切分做得不到位。想象一下：如果把一篇完整的技术文档，拆成了语义断裂的碎片，向量数据库又怎么能检索到准确的信息？本文将从RAG的核心逻辑出发，深入浅出地讲解文档切分的原理，再通过具体的实践步骤，教大家如何通过科学的文档切分，让RAG系统的性能提升30%以上，同时分享新手也能轻松掌握的最优实践方案。</p>
<p>技术原理</p>
<ol>
<li>文档切分的核心作用：让检索更精准</li>
</ol>
<p>RAG系统的核心流程是“检索+生成”：先根据用户的查询，从向量数据库中检索相关的文档片段，再将这些片段作为上下文，输入到大模型中生成回复。而文档切分的作用，就是将长文档拆分成语义完整、粒度合适的文本块，让向量数据库能够精准匹配用户的查询意图。</p>
<p>简单来说，文档切分就像我们整理书架：如果把一堆书胡乱堆在一起，找一本书会非常困难；但如果按照主题分类、分册摆放，就能快速找到需要的内容。同理，合理的文档切分，能让向量数据库的检索效率和准确率大幅提升。</p>
<ol start="2">
<li>文档切分的三大核心原则</li>
</ol>
<ul>
<li>
<p>原则一：语义完整优先。这是文档切分的第一要义。无论采用哪种切分方式，都不能割裂文本的语义。比如，不能把一个完整的句子拆成两半，也不能把一个独立的技术知识点拆分开。语义完整的文本块，才能让向量模型学到准确的信息，检索结果才会更精准。</p>
</li>
<li>
<p>原则二：适配模型输入长度。不同的向量模型，有不同的输入长度限制（即token上限）。比如， text-embedding-ada-002 的输入上限是8191个token， bge-large-zh 的上限是512个token。切分后的文本块长度，必须小于模型的输入上限，否则会被截断，丢失关键信息。</p>
</li>
<li>
<p>原则三：设置重叠窗口。为了避免相邻文本块之间的语义断裂，需要设置一定的重叠窗口——也就是让前一个文本块的末尾，和后一个文本块的开头，有一部分内容重复。重叠窗口的大小，通常为文本块长度的10%-20%，这样能保证上下文的连贯性。</p>
</li>
</ul>
<ol start="3">
<li>三种常见的文档切分方式及优缺点</li>
</ol>
<ul>
<li>
<p>固定长度切分：最基础的切分方式，按照预设的token长度，将文档均匀拆分。优点是操作简单、效率高，适合结构化程度低的纯文本；缺点是容易割裂语义，比如把一个完整的段落拆成两半。</p>
</li>
<li>
<p>按语义结构切分：基于文档的自然结构进行拆分，比如按照段落、章节、标题等边界切分。优点是能保证语义完整，适合有明确结构的文档，比如技术手册、论文等；缺点是文本块长度不均，部分块可能超出模型输入上限。</p>
</li>
<li>
<p>混合切分：结合前两种方式的优点，是目前最优的切分方案。先按语义结构（段落、章节）进行初步拆分，再对过长的文本块，按照固定长度进行二次切分，并设置重叠窗口。这种方式兼顾了语义完整和长度适配，是大多数场景的首选。</p>
</li>
</ul>
<p>实践步骤</p>
<p>本次实践我们以“搭建一个技术文档RAG系统”为例，使用 LangChain 工具库，完成从文档切分到检索测试的全流程，步骤清晰，新手可直接复刻。</p>
<p>前置准备</p>
<ul>
<li>
<p>文档准备：选取一份10万字的Python技术手册（PDF格式）。</p>
</li>
<li>
<p>工具选择：使用 LangChain 进行文档处理和切分， Chroma 作为向量数据库， bge-large-zh 作为向量模型。</p>
</li>
<li>
<p>环境配置：安装依赖： pip install langchain chromadb sentence-transformers pypdf 。</p>
</li>
</ul>
<p>步骤1：文档加载与预处理</p>
<p>1. 使用 LangChain 的 PyPDFLoader 加载PDF文档：
 </p>
<p>2. 预处理文档：去除页眉页脚、空行等噪音数据，确保文本的整洁性。</p>
<p>步骤2：选择切分方式，进行文档切分</p>
<p>我们采用混合切分的方式，具体操作如下：</p>
<p>1. 先按段落切分： LangChain 的 RecursiveCharacterTextSplitter 支持按自然段落切分，先设置一个较大的chunk_size（比如2000个字符），让文本块先按段落拆分。</p>
<p>2. 设置重叠窗口：将 chunk_overlap 设置为200个字符（约为chunk_size的10%），避免语义断裂。</p>
<p>3. 配置切分器参数：
 </p>
<p>这里的 separators 参数非常关键，它定义了切分的优先级：先按空行切分（段落边界），再按换行符切分，最后按中文标点符号切分，确保语义完整。</p>
<p>步骤3：向量入库与检索测试</p>
<p>1. 加载向量模型：使用 bge-large-zh 模型生成文本块的向量：
 </p>
<p>2. 将切分后的文本块存入 Chroma 向量数据库：
 </p>
<p>3. 检索测试：输入用户查询“Python中的列表推导式怎么用”，查看检索结果：
 </p>
<p>如果检索结果中，包含了列表推导式的定义、语法和示例，说明文档切分是有效的。</p>
<p>从目前的发展趋势来看，大模型能力正在逐渐从“通用模型”走向“场景化模型”。与其等待一个什么都能做的超级模型，不如根据具体需求，对模型进行定向微调。像 LLaMA-Factory Online 这类平台，本质上就是在帮更多个人和小团队，参与到这条趋势里来，让“定制模型”变得不再只是大厂专属。而对于RAG系统来说，科学的文档切分，就是让场景化模型发挥作用的关键一步。</p>
<p>效果评估</p>
<p>文档切分的效果，直接决定了RAG系统的性能。我们可以从以下两个维度进行评估：</p>
<p>1. 定量评估</p>
<ul>
<li>
<p>检索召回率：选取100个用户常见的查询，统计检索结果中包含准确答案的比例。经过混合切分的RAG系统，召回率应不低于85%，比固定长度切分提升30%以上。</p>
</li>
<li>
<p>文本块长度分布：统计切分后的文本块长度，确保90%以上的文本块长度，在向量模型输入上限的80%以内，避免截断。</p>
</li>
</ul>
<p>2. 定性评估</p>
<ul>
<li>
<p>语义连贯性检查：随机抽取10个文本块，检查是否存在语义断裂的情况，比如句子不完整、知识点割裂等，语义完整率应达到100%。</p>
</li>
<li>
<p>生成效果评估：输入50个查询，查看大模型的生成回复，检查是否存在“答非所问”的情况，生成准确率应不低于80%。</p>
</li>
</ul>
<p>总结与展望</p>
<p>本文从原理到实践，完整拆解了文档切分在RAG系统中的核心作用和最优实践。可以看到，文档切分并非简单的“切割文本”，而是需要兼顾语义完整、模型适配和检索效率的技术活。对于新手来说，无需纠结复杂的理论，直接采用“混合切分+重叠窗口”的方案，就能解决大部分场景的问题。</p>
<p>未来，随着RAG技术的发展，文档切分也会朝着“智能化”的方向发展。比如，基于大模型的语义理解，实现动态切分；结合文档的类型和主题，自动调整切分粒度。掌握科学的文档切分方法，将帮助我们在搭建RAG系统时，少走弯路，更快地打造出高性能的检索增强生成系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[__CFRunLoopSourceComparator 函数详解]]></title>    <link>https://juejin.cn/post/7597650322408243252</link>    <guid>https://juejin.cn/post/7597650322408243252</guid>    <pubDate>2026-01-21T14:41:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408243252" data-draft-id="7597650322408226868" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="__CFRunLoopSourceComparator 函数详解"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-21T14:41:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS在入门"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426627758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            __CFRunLoopSourceComparator 函数详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426627758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS在入门
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T14:41:11.000Z" title="Wed Jan 21 2026 14:41:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>源码苹果开源库：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fswiftlang%2Fswift-corelibs-foundation%2Fblob%2Fmain%2FSources%2FCoreFoundation%2FCFRunLoop.c" target="_blank" title="https://github.com/swiftlang/swift-corelibs-foundation/blob/main/Sources/CoreFoundation/CFRunLoop.c" ref="nofollow noopener noreferrer">swift-corelibs-foundation/blob/main/Sources/CoreFoundation/CFRunLoop.c</a></p>
</blockquote>
<h3 data-id="heading-0">__CFRunLoopSourceComparator函数</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> CFComparisonResult __CFRunLoopSourceComparator(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *val1, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *val2, <span class="hljs-type">void</span> *context) {
    CFRunLoopSourceRef o1 = (CFRunLoopSourceRef)val1;
    CFRunLoopSourceRef o2 = (CFRunLoopSourceRef)val2;
    
    <span class="hljs-comment">// 第一优先级：按 _order 排序</span>
    <span class="hljs-keyword">if</span> (o1-&gt;_order &lt; o2-&gt;_order) <span class="hljs-keyword">return</span> kCFCompareLessThan;
    <span class="hljs-keyword">if</span> (o2-&gt;_order &lt; o1-&gt;_order) <span class="hljs-keyword">return</span> kCFCompareGreaterThan;
    
    <span class="hljs-type">const</span> CFAbsoluteTime time1 = __CFRunLoopSourceGetSignaledTime(o1);
    <span class="hljs-type">const</span> CFAbsoluteTime time2 = __CFRunLoopSourceGetSignaledTime(o2);
    
    <span class="hljs-comment">// 第二优先级：按信号时间排序（先被 signal 的先处理）</span>
    <span class="hljs-keyword">if</span> (time1 &lt; time2) <span class="hljs-keyword">return</span> kCFCompareLessThan;
    <span class="hljs-keyword">if</span> (time1 &gt; time2) <span class="hljs-keyword">return</span> kCFCompareGreaterThan;
    
    <span class="hljs-keyword">return</span> kCFCompareEqualTo;
}
</code></pre>
<p>该函数用于对Source0数组进行排序。</p>
<p>排序会用到source的_order属性和_signaledTime属性。</p>
<ul>
<li>_order：Source 的优先级顺序（创建时指定）</li>
<li>_signaledTime：被信号标记的时间</li>
</ul>
<h3 data-id="heading-1">排序逻辑</h3>
<ol>
<li>
<p>先比较 _order 值</p>
<ul>
<li>_order 小的排前面（优先级高）</li>
<li>如果 _order 相等，继续比较</li>
</ul>
</li>
<li>
<p>再比较 _signaledTime（信号时间）</p>
<ul>
<li>时间早的排前面（先被 signal 的先处理）</li>
<li>这实现了 FIFO（先进先出）的公平性</li>
</ul>
</li>
</ol>
<h3 data-id="heading-2">设计意图</h3>
<ol>
<li>
<p>_order 优先：允许开发者控制 Source 的处理优先级。例如：重要的事件源可以设置较小的 order 值，确保优先处理</p>
</li>
<li>
<p>_signaledTime 次之：相同优先级时，保证公平性。先被 Signal 的 Source 先被处理，防止后来的 Source "插队"。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列模块化 [4 - 2]：逻辑与视图的极致分离（Headless UI）]]></title>    <link>https://juejin.cn/post/7597704040214970394</link>    <guid>https://juejin.cn/post/7597704040214970394</guid>    <pubDate>2026-01-22T02:02:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597704040214970394" data-draft-id="7597623395908714542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列模块化 [4 - 2]：逻辑与视图的极致分离（Headless UI）"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-22T02:02:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列模块化 [4 - 2]：逻辑与视图的极致分离（Headless UI）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T02:02:29.000Z" title="Thu Jan 22 2026 02:02:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>你是否经历过这样的场景：</p>
<p>你的团队维护了一个功能强大的 <code>&lt;SuperSelect /&gt;</code> 组件，集成了搜索、多选、远程加载、虚拟滚动。 某天，产品经理走过来说：“这个下拉框在移动端能不能变成一个从底部弹出的半屏抽屉（ActionSheet）？逻辑不变，就是样式改改。”</p>
<p>你看着那 2000 行包含着 <code>div</code>、<code>ul</code>、<code>li</code> 和无数 CSS 类的代码，陷入了绝望。你发现根本改不动，因为<strong>交互逻辑（打开/关闭/选中）</strong> 和 <strong>DOM 结构</strong> 像是纠缠在一起的藤蔓，剪不断理还乱。</p>
<p>这就是<strong>逻辑与视图强耦合</strong>的代价。</p>
<p>本篇我们将探讨 <strong>Headless UI（无头组件）</strong> 模式。它不仅是 Shadcn/UI、TanStack Table 背后的秘密武器，更是前端架构师解耦复杂业务组件的必修课。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afd63f6ae0634533a6bf22aff928f98e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769652149&amp;x-signature=Zy%2FVQMLztStyIV%2BfCE3AGXRAkEI%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 进化的必然：从“全家桶”到“发动机”</h2>
<p>在组件化发展的早期（Bootstrap、AntD v3 时代），我们推崇的是 <strong>"All-in-One"</strong> 模式。一个组件包办一切：</p>
<ul>
<li><strong>状态（State）：</strong> <code>isOpen</code>, <code>selectedIndex</code></li>
<li><strong>行为（Behavior）：</strong> 点击打开、键盘回车选中、ESC 关闭</li>
<li><strong>样式（Style）：</strong> CSS Class, Styled-components</li>
<li><strong>结构（Markup）：</strong> <code>&lt;div&gt;</code>, <code>&lt;span&gt;</code></li>
</ul>
<p>这种模式在业务初期跑得很快，但随着设计系统的迭代，它很快就会变成**“配置地狱”**。你一定见过这种组件 API：</p>
<pre><code class="hljs language-ini" lang="ini">// 典型的“过度封装”组件
&lt;Table 
  <span class="hljs-attr">data</span>={data}
  <span class="hljs-attr">useVirtualScroll</span>={<span class="hljs-literal">true</span>}
  // 为了改一个样式，不得不暴露无数个 render props
  <span class="hljs-attr">renderHeader</span>={(props) =&gt; &lt;div className=<span class="hljs-string">"bg-red-500"</span> {...props} /&gt;} 
  <span class="hljs-attr">rowClassName</span>={(record) =&gt; record.active ? <span class="hljs-string">'bg-blue'</span> : <span class="hljs-string">''</span>}
  <span class="hljs-attr">dropdownStyle</span>={{ zIndex: <span class="hljs-number">9999</span> }} // 甚至开始直接透传 CSS
/&gt;
</code></pre>
<p><strong>架构反思：</strong> 这种设计的本质错误在于：<strong>试图用有限的配置（Props），去穷尽无限的 UI 变化。</strong> 视图（View）是易变的，就像时尚潮流；而逻辑（Logic）是相对稳定的，就像人体骨骼。把它们焊死在一起，必然会导致僵化。</p>
<p>于是，Headless UI 应运而生。它的核心哲学只有一句话：<strong>我给你提供逻辑的“发动机”，你自己去造“车壳子”。</strong></p>
<hr/>
<h2 data-id="heading-1">二、 Headless UI 的解剖学：只有大脑，没有皮肤</h2>
<p>所谓的“无头”，指的是<strong>不渲染具体的 DOM 节点（或者只渲染最语义化的标签），不包含任何样式</strong>，只负责提供交互逻辑和可访问性（A11y）。</p>
<h3 data-id="heading-2">2.1 两种主流实现形态</h3>
<p>在 React 和 Vue 的现代生态中，Headless 主要有两种落地形态：</p>
<h4 data-id="heading-3">形态一：Hooks / Composables (纯逻辑层)</h4>
<p>这是最彻底的分离。组件完全消失，只剩下一个函数。</p>
<ul>
<li>
<p><strong>React 示例 (useToggle):</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Headless 逻辑</span>
<span class="hljs-function">function <span class="hljs-title">useToggle</span>()</span> {
  <span class="hljs-keyword">const</span> [<span class="hljs-keyword">on</span>, setOn] = useState(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> toggle = () =&gt; setOn(!<span class="hljs-keyword">on</span>);
  <span class="hljs-comment">// 返回状态和绑定到 DOM 上的属性</span>
  <span class="hljs-keyword">return</span> { 
    <span class="hljs-keyword">on</span>, 
    toggle, 
    togglerProps: { 
      <span class="hljs-string">'aria-pressed'</span>: <span class="hljs-keyword">on</span>, 
      onClick: toggle 
    } 
  };
}

<span class="hljs-comment">// UI 实现 A：普通的按钮</span>
<span class="hljs-function">function <span class="hljs-title">ButtonToggle</span>()</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">on</span>, togglerProps } = useToggle();
  <span class="hljs-keyword">return</span> &lt;button {...togglerProps}&gt;{<span class="hljs-keyword">on</span> ? <span class="hljs-string">'ON'</span> : <span class="hljs-string">'OFF'</span>}&lt;/button&gt;;
}

<span class="hljs-comment">// UI 实现 B：复杂的 Switch 开关</span>
<span class="hljs-function">function <span class="hljs-title">SwitchToggle</span>()</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">on</span>, togglerProps } = useToggle();
  <span class="hljs-keyword">return</span> (
    &lt;div {...togglerProps} className={`<span class="hljs-keyword">switch</span> ${<span class="hljs-keyword">on</span> ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}`}&gt;
      &lt;div className=<span class="hljs-string">"slider"</span> /&gt;
    &lt;/div&gt;
  );
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-4">形态二：Render Props / Slots (组件容器层)</h4>
<p>这种形态通常用于涉及<strong>父子组件通信</strong>的复杂场景（如 Select, Tabs）。它负责处理 DOM 的层级关系和键盘导航，但把渲染权交还给用户。</p>
<ul>
<li><strong>代表库：</strong> Headless UI (Tailwind Labs), Radix UI.</li>
</ul>

<pre><code class="hljs language-xml" lang="xml">// Radix UI 风格
<span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Root</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">"tab1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.List</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Trigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab1"</span>&gt;</span>Account<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Trigger</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Trigger</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab2"</span>&gt;</span>Password<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Trigger</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.List</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Content</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab1"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Content</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Tabs.Content</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab2"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Content</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Tabs.Root</span>&gt;</span>
</code></pre>
<p>注意：这里的 <code>&lt;Tabs.Root&gt;</code> 并不强制你输出特定的 <code>div</code> 结构，它主要负责<strong>上下文（Context）的传递</strong>和<strong>键盘焦点的管理</strong>。</p>
<hr/>
<h2 data-id="heading-5">三、 架构师的实战：如何设计一个 Headless 组件？</h2>
<p>假设我们要设计一个企业级的 <strong>Datepicker（日期选择器）</strong> 。如果按照传统思路，你会被 CSS 搞死。如果按照 Headless 思路，你应该关注什么？</p>
<h3 data-id="heading-6">3.1 步骤一：提取“纯数据模型”</h3>
<p>首先，剥离任何与 DOM 无关的数学逻辑。这部分代码应该是纯 JS/TS，可以在 Node.js 里跑单测。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">CalendarModel</span> {
  <span class="hljs-comment">// 给定年月，返回一个 6x7 的二维数组，包含日期、是否是上月残留、是否禁用等信息</span>
  <span class="hljs-selector-tag">generateGrid</span>(<span class="hljs-attribute">year</span>: number, <span class="hljs-attribute">month</span>: number): <span class="hljs-selector-tag">DateCell</span><span class="hljs-selector-attr">[]</span><span class="hljs-selector-attr">[]</span> { ... }
  
  <span class="hljs-comment">// 判断两个日期是否相等</span>
  <span class="hljs-selector-tag">isSameDate</span>(<span class="hljs-attribute">d1</span>: Date, <span class="hljs-attribute">d2</span>: Date): <span class="hljs-selector-tag">boolean</span> { ... }
}
</code></pre>
<h3 data-id="heading-7">3.2 步骤二：封装“交互钩子”</h3>
<p>接下来，处理用户的交互行为。这是 Headless 的核心。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// useCalendar.ts</span>
export function <span class="hljs-built_in">useCalendar</span>({ selectedDate, onChange }) {
  const <span class="hljs-selector-attr">[viewDate, setViewDate]</span> = <span class="hljs-built_in">useState</span>(new Date()); <span class="hljs-comment">// 当前查看的月份</span>

  const <span class="hljs-attribute">grid</span> = <span class="hljs-built_in">useMemo</span>(() =&gt; new <span class="hljs-built_in">CalendarModel</span>()<span class="hljs-selector-class">.generateGrid</span>(...), <span class="hljs-selector-attr">[viewDate]</span>);

  const selectDate = (date) =&gt; {
    <span class="hljs-built_in">onChange</span>(date);
    <span class="hljs-comment">// 只有逻辑，没有样式</span>
  };

  const nextMonth = () =&gt; <span class="hljs-built_in">setViewDate</span>(d =&gt; addMonths(d, <span class="hljs-number">1</span>));

  <span class="hljs-comment">// 关键：返回 Props Getter 而不是直接返回 JSX</span>
  <span class="hljs-comment">// 这就是 Inversion of Control (控制反转)</span>
  const getDayProps = (dateCell) =&gt; ({
    onClick: () =&gt; <span class="hljs-built_in">selectDate</span>(dateCell.date),
    role: <span class="hljs-string">'gridcell'</span>,
    <span class="hljs-string">'aria-selected'</span>: <span class="hljs-built_in">isSameDate</span>(dateCell.date, selectedDate),
    <span class="hljs-string">'aria-disabled'</span>: dateCell.disabled,
    tabIndex: <span class="hljs-built_in">isSameDate</span>(dateCell.date, viewDate) ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>, // 键盘导航逻辑
  });

  return { <span class="hljs-attribute">grid</span>, viewDate, nextMonth, getDayProps };
}
</code></pre>
<h3 data-id="heading-8">3.3 步骤三：注入视图（UI层）</h3>
<p>最后，才是业务开发者干活的地方。</p>
<pre><code class="hljs language-ini" lang="ini">function MyDatePicker() {
  const { grid, getDayProps } = useCalendar({...})<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"my-calendar-wrapper"</span>&gt;
      {grid.map(<span class="hljs-attr">row</span> =&gt; (
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"row"</span>&gt;
          {row.map(<span class="hljs-attr">cell</span> =&gt; (
            // 只需要解构 props，所有的交互、A11y 自动生效
            &lt;span <span class="hljs-attr">className</span>=<span class="hljs-string">"cell"</span> {...getDayProps(cell)}&gt;
              {cell.date.getDate()}
            &lt;/span&gt;
          ))}
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>架构收益：</strong></p>
<ol>
<li><strong>UI 自由：</strong> 你可以用 <code>table</code> 渲染，也可以用 <code>div</code>+<code>flex</code> 渲染，甚至可以在 Canvas 里渲染（只要能透传事件）。</li>
<li><strong>测试稳定：</strong> 你只需要针对 <code>useCalendar</code> 编写逻辑测试用例，覆盖率 100%。UI 层的变化不会导致逻辑测试失败。</li>
<li><strong>多端复用：</strong> 这个 <code>useCalendar</code> 可以无缝移植到 React Native，因为里面没有 <code>HTMLDivElement</code>。</li>
</ol>
<hr/>
<h2 data-id="heading-9">四、 复杂度的克星：TanStack Table 的启示</h2>
<p>如果说 toggle 是小儿科，那么表格（Table）就是前端复杂度的珠穆朗玛峰。 <strong>TanStack Table (原 React Table)</strong> 是 Headless 理念的集大成者。</p>
<p>它<strong>拒绝渲染任何 HTML</strong>。它不给你 <code>&lt;Table&gt;</code> 组件，它给你的是：</p>
<ul>
<li><code>useReactTable()</code> 钩子</li>
<li><code>getRowModel()</code> 核心算法</li>
<li><code>getSortedRowModel()</code> 排序算法</li>
</ul>
<p>开发者： <em>"那表格长什么样？"</em> TanStack：*"我怎么知道？你可以用 HTML table，也可以用 CSS Grid 模拟的虚拟列表 div。我只告诉你，第二行第三列的数据是什么，以及它现在是不是被选中状态。"</p>
<p><strong>这种设计带来的爆发力是惊人的：</strong> 企业 A 想要一个类似 Excel 的表格；企业 B 想要一个类似 Trello 的看板（本质也是数据列表）。 在 Headless 架构下，它们可以使用<strong>同一套核心逻辑（排序、筛选、分页、分组）</strong> ，仅仅是 View 层不同。这在传统组件库（如 AntD Table）中是几乎不可能做到的。</p>
<hr/>
<h2 data-id="heading-10">五、 陷阱与权衡：何时不该 Headless？</h2>
<p>Headless UI 虽然优雅，但它是<strong>高成本</strong>的。</p>
<h3 data-id="heading-11">5.1 缺点：</h3>
<ol>
<li><strong>上手门槛高：</strong> 开发者不能“开箱即用”。为了画一个简单的下拉框，可能需要写 50 行代码来组装 Headless 的各个部件。</li>
<li><strong>样式管理负担：</strong> 所有 CSS 都要自己写，或者依赖 Tailwind。</li>
</ol>
<h3 data-id="heading-12">5.2 架构分层策略</h3>
<p>作为架构师，你不应该让所有业务开发都直接使用 Headless 底层。你应该采用 <strong>“三层架构”</strong> ：</p>
<ol>
<li>
<p><strong>Level 1: Headless Core (逻辑层)</strong></p>
<ul>
<li>使用 <code>useSelect</code>, <code>Radix Select</code>。</li>
<li>处理 ARIA、键盘事件、状态管理。</li>
<li><em>面向对象：资深开发 / 架构组。</em></li>
</ul>
</li>
<li>
<p><strong>Level 2: Styled System Component (标准组件层)</strong></p>
<ul>
<li>引入公司的 Design Token。</li>
<li>封装样式：<code>&lt;CompanySelect /&gt;</code> = <code>Radix Select</code> + <code>Tailwind Classes</code>。</li>
<li><em>面向对象：业务线通用开发。</em></li>
</ul>
</li>
<li>
<p><strong>Level 3: Business Component (业务组件层)</strong></p>
<ul>
<li>绑定业务数据：<code>&lt;UserSelect /&gt;</code> = <code>&lt;CompanySelect /&gt;</code> + <code>fetchUserList API</code>。</li>
<li><em>面向对象：初级开发 / 实习生。</em></li>
</ul>
</li>
</ol>
<p>通过这种分层，我们既保留了 Headless 的灵活性（底层可换），又保证了业务开发的高效性（顶层开箱即用）。</p>
<hr/>
<h2 data-id="heading-13">结语：控制反转的艺术</h2>
<p>组件化设计的最高境界，不是你帮用户把所有事情都做了，而是<strong>你把控制权优雅地交还给用户</strong>。</p>
<p>Headless UI 就像是把组件的“灵魂”提取了出来，允许用户随心所欲地塑造“肉体”。理解了这一点，你就掌握了应对前端需求万变不离其宗的法门。</p>
<blockquote>
<p><strong>Next Step:</strong> 有了灵活的组件骨架（Headless UI），如果组件之间需要复杂的通信（比如一个树形组件，子节点要通知祖先节点），或者需要跨层级的状态共享，仅仅靠 Props 传递显然是不够的。 下一节，我们将探讨**《第三篇：骨架（下）——组件化深度设计：复杂组件的通信与组合模式》**</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你可能没有那么了解 RecycleView]]></title>    <link>https://juejin.cn/post/7597650322408472628</link>    <guid>https://juejin.cn/post/7597650322408472628</guid>    <pubDate>2026-01-22T00:13:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408472628" data-draft-id="7596670644286439424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你可能没有那么了解 RecycleView"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-22T00:13:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你可能没有那么了解 RecycleView
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:13:06.000Z" title="Thu Jan 22 2026 00:13:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为小说《逆袭西二旗》的技术讲解，用于详细说明<a href="https://juejin.cn/post/7596905015367483392" target="_blank" title="https://juejin.cn/post/7596905015367483392">剧情</a>里涉及的开发细节。</em></p>
<h2 data-id="heading-0">RecyclerView 的内部工作原理</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52a2be7546b45e4945f68dbbc64e3fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769645585&amp;x-signature=FNrQ8yi507EbhGQTB%2Fpj%2BP60ljM%3D" alt="00.png" loading="lazy"/></p>
<p><code>RecyclerView</code> 是一个实用且灵活的 Android 组件，旨在通过复用 <code>ItemView</code>（而非重复创建新 <code>View</code>）来高效显示大型数据集。它通过一种类似对象池的机制（即 <code>ViewHolder</code> 模式）管理 <code>View</code>，从而实现了这种高效性。</p>
<h3 data-id="heading-1">面试问题</h3>
<p>与 <code>ListView</code> 相比，<code>RecyclerView</code> 的 <code>ViewHolder</code> 模式如何提升性能？</p>
<p>请解释 <code>ViewHolder</code> 从创建到被回收的生命周期。</p>
<p>什么是 <code>RecycledViewPool</code>？如何使用它来优化 <code>ItemView</code> 的渲染？</p>
<h3 data-id="heading-2">核心概念</h3>
<ol>
<li><strong>View 复用</strong>：<code>RecyclerView</code> 会复用现有 <code>View</code>，而不是为数据集中的每个 <code>Item</code> 创建新 <code>View</code>。当一个 <code>View</code> 滚动出可见区域时，它会被添加到一个 <code>View</code> 池（称为 <code>RecyclerView.RecycledViewPool</code>）中，而不是被销毁。当新 <code>Item</code> 进入可见区域时，<code>RecyclerView</code> 会从该池中获取一个可用的 <code>View</code>（如果有的话），从而避免了 <code>inflate</code> 带来的开销。</li>
<li><strong>ViewHolder 模式</strong>：<code>RecyclerView</code> 使用 <code>ViewHolder</code> 来存储 <code>Item</code> 布局中 <code>View</code> 的引用。这避免了在绑定过程中频繁调用 <code>findViewById()</code>，通过减少布局遍历和 <code>View</code> 查找来提升性能。</li>
<li><strong>Adapter 的作用</strong>：<code>RecyclerView.Adapter</code> 作为数据源和 <code>RecyclerView</code> 之间的桥梁。<code>Adapter</code> 的 <code>onBindViewHolder()</code> 方法会将数据绑定到被复用的 <code>View</code> 上，因此只需要更新可见的 <code>Item</code>。</li>
<li><strong>RecycledViewPool</strong>：<code>RecycledViewPool</code> 充当对象池，存储未使用的 <code>View</code>。它允许 <code>RecyclerView</code> 在多个列表或具有相似 <code>View</code> 类型的 Section 之间复用 <code>View</code>，进一步优化内存使用。</li>
</ol>
<h3 data-id="heading-3">复用机制的工作流程</h3>
<ol>
<li><strong>滚动与 Item 可见性</strong>：当用户滚动时，移出屏幕的 <code>Item</code> 会从 <code>RecyclerView</code> 中分离，但不会被销毁。相反，它们会被添加到 <code>RecycledViewPool</code>。</li>
<li><strong>将数据重新绑定到复用的 View</strong>：当新 <code>Item</code> 进入可见区域时，<code>RecyclerView</code> 首先检查 <code>RecycledViewPool</code> 中是否有可用的对应类型 <code>View</code>。如果找到匹配项，它会复用该 <code>View</code>，并通过 <code>onBindViewHolder()</code> 将新数据绑定到其上。</li>
<li><strong>如果没有可用 View 则 inflate</strong>：如果池中没有合适的 <code>View</code>，<code>RecyclerView</code> 会通过 <code>onCreateViewHolder()</code> <code>inflate</code> 一个新 <code>View</code>。</li>
<li><strong>高效内存使用</strong>：通过复用 <code>View</code>，<code>RecyclerView</code> 减少了内存分配和垃圾回收，这在处理大型数据集或频繁滚动的场景中可能导致性能问题。</li>
</ol>
<p>下面是一个基础 <code>RecyclerView.Adapter</code> 实现示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataList: List&lt;String&gt;) : RecyclerView.Adapter&lt;MyAdapter.MyViewHolder&gt;() {

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: MyViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> MyViewHolder(view)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">MyViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.textView.text = dataList[position]
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = dataList.size
}
</code></pre>
<p><code>RecyclerView</code> 对象池方式有下面这些优势：</p>
<ol>
<li><strong>提升性能</strong>：复用 <code>View</code> 减少了 <code>inflate</code> 新布局的开销，使滚动更流畅，性能更好。</li>
<li><strong>高效内存管理</strong>：对象池减少了内存分配，并通过复用 <code>View</code> 避免了频繁的垃圾回收。</li>
<li><strong>可定制性</strong>：<code>RecycledViewPool</code> 可以定制，以管理每种类型 <code>View</code> 的最大数量，允许开发者针对特定场景优化行为。</li>
</ol>
<h3 data-id="heading-4">总结</h3>
<p><code>RecyclerView</code> 采用了高效的对象池机制，未使用的 <code>View</code> 存储在 <code>RecycledViewPool</code> 中，并在需要时复用。这种设计与 <code>ViewHolder</code> 模式相结合，减少了内存使用和布局开销，提升了性能，使其成为 Android 应用中显示大型数据集的必备工具。</p>
<p>如果你还记得设计模式中享元模式的话，<code>RecyclerView</code> 就是这种思想的优良实现。</p>

























<table><thead><tr><th>享元模式要素</th><th><code>RecyclerView</code> 中的对应实现</th></tr></thead><tbody><tr><td>内部状态</td><td><code>ItemView</code> 的布局结构（XML 定义的视图层级） —— 这些是可复用、不可变的部分</td></tr><tr><td>外部状态</td><td>每个 item 的具体数据（如文本内容、图片 URL、颜色等） —— 在 <code>onBindViewHolder()</code> 中动态绑定</td></tr><tr><td>享元工厂</td><td><code>RecyclerView.RecycledViewPool</code> + <code>LayoutManager</code> 的回收/复用逻辑 —— 负责创建、缓存和分发 <code>ViewHolder</code></td></tr><tr><td>享元对象</td><td><code>RecyclerView.ViewHolder</code> 实例 —— 封装了 <code>itemView</code>，本身不包含业务数据</td></tr></tbody></table>
<h3 data-id="heading-5">进阶：不同类型的 Item</h3>
<p><code>RecyclerView</code> 具有高度的灵活性，支持在同一个列表中显示多种 <code>Item</code> 类型。要实现这一点，你需要结合自定义 <code>Adapter</code>、<code>ItemView</code> 类型和适当的布局。关键在于正确区分 <code>Item</code> 类型并进行绑定。</p>
<p>实现多 <code>Item</code> 类型需要如下步骤：</p>
<ol>
<li><strong>定义 <code>Item</code> 类型</strong>：每种 <code>Item</code> 类型由唯一的标识符表示，通常是一个整数常量。这些标识符允许 <code>Adapter</code> 在创建和绑定 <code>View</code> 时区分不同的 <code>Item</code> 类型。</li>
<li><strong>重写 <code>getItemViewType()</code></strong> ：在 <code>Adapter</code> 中重写此方法，为数据集中的每个 <code>Item</code> 返回适当的类型。该方法帮助 <code>RecyclerView</code> 确定需要布局的类型。</li>
<li><strong>处理多个 <code>ViewHolder</code></strong> ：为每种 <code>Item</code> 类型创建单独的 <code>ViewHolder</code> 类。每个 <code>ViewHolder</code> 负责将数据绑定到其对应的 <code>View</code>。</li>
<li><strong>根据 <code>View</code> 类型布局</strong>：在 <code>onCreateViewHolder()</code> 方法中，根据 <code>getItemViewType()</code> 返回的 <code>View</code> 类型进行布局。</li>
<li><strong>相应地绑定数据</strong>：在 <code>onBindViewHolder()</code> 方法中，检查 <code>Item</code> 类型并使用对应的 <code>ViewHolder</code> 绑定数据。</li>
</ol>
<p>下面是一个实现多 <code>Item</code> 类型的示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiTypeAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> items: List&lt;ListItem&gt;) : RecyclerView.Adapter&lt;RecyclerView.ViewHolder&gt;() {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_HEADER = <span class="hljs-number">0</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_CONTENT = <span class="hljs-number">1</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemViewType</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (items[position]) {
            <span class="hljs-keyword">is</span> ListItem.Header -&gt; TYPE_HEADER
            <span class="hljs-keyword">is</span> ListItem.Content -&gt; TYPE_CONTENT
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: RecyclerView.ViewHolder {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (viewType) {
            TYPE_HEADER -&gt; {
                <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_header, parent, <span class="hljs-literal">false</span>)
                HeaderViewHolder(view)
            }
            TYPE_CONTENT -&gt; {
                <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_content, parent, <span class="hljs-literal">false</span>)
                ContentViewHolder(view)
            }
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"Invalid view type"</span>)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">when</span> (holder) {
            <span class="hljs-keyword">is</span> HeaderViewHolder -&gt; holder.bind(items[position] <span class="hljs-keyword">as</span> ListItem.Header)
            <span class="hljs-keyword">is</span> ContentViewHolder -&gt; holder.bind(items[position] <span class="hljs-keyword">as</span> ListItem.Content)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = items.size

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeaderViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> title: TextView = itemView.findViewById(R.id.headerTitle)

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">ListItem</span>.<span class="hljs-type">Header</span>)</span></span> {
            title.text = item.title
        }
    }

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContentViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> content: TextView = itemView.findViewById(R.id.contentText)

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">ListItem</span>.<span class="hljs-type">Content</span>)</span></span> {
            content.text = item.text
        }
    }
}

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListItem</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Header</span>(<span class="hljs-keyword">val</span> title: String) : ListItem()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Content</span>(<span class="hljs-keyword">val</span> text: String) : ListItem()
}
</code></pre>
<p>要点提示</p>
<ol>
<li><strong>效率</strong>：<code>RecyclerView</code> 会复用 <code>ViewHolder</code>，处理多种 <code>Item</code> 类型不会影响性能。每种 <code>Item</code> 类型通过 <code>getItemViewType()</code> 方法和正确的绑定得到高效管理。</li>
<li><strong>清晰分离</strong>：每种 <code>Item</code> 类型都有自己的布局和 <code>ViewHolder</code>，确保关注点分离和代码更清晰。</li>
<li><strong>可扩展性</strong>：添加新的 <code>Item</code> 类型只需最小的改动。你只需定义一个新布局、一个 <code>ViewHolder</code>，并调整 <code>getItemViewType()</code> 和 <code>onCreateViewHolder()</code> 中的逻辑。</li>
</ol>
<p>总而言之，要在 <code>RecyclerView</code> 中实现多种 <code>Item</code> 类型，需结合 <code>getItemViewType()</code> 确定每个 <code>Item</code> 的类型、为每种类型使用单独的 <code>ViewHolder</code>，以及为每种类型使用不同的布局。这种方法确保 <code>RecyclerView</code> 在支持统一列表中的多样内容时，仍然保持高效和可扩展。</p>
<h3 data-id="heading-6">进阶：提升性能</h3>
<p>你可以通过使用 <code>ListAdapter</code> 和 <code>DiffUtil</code> 来提升 <code>RecyclerView</code> 的性能。</p>
<p><code>DiffUtil</code> 是 Android 中的一个工具类，用于计算两个列表之间的差异，并更高效地更新 <code>RecyclerView.Adapter</code>。</p>
<p>通过利用 <code>DiffUtil</code>，你可以避免不必要地调用 <code>notifyDataSetChanged()</code>，这会导致列表中所有 <code>Item</code> 都被低效重绘。相反，<code>DiffUtil</code> 能在细粒度级别识别变化并仅更新受影响的 <code>Item</code>。</p>
<p><code>RecyclerView</code> 的默认行为是在数据变化时重新绑定并重绘所有可见 <code>Item</code>，即使大多数 <code>Item</code> 保持不变。</p>
<p>这样做会降低性能，尤其是在处理大型数据集时。<code>DiffUtil</code> 通过计算所需的最小更新集（插入、删除和修改）并直接应用于 <code>Adapter</code> 来优化这一点。</p>
<p>使用 <code>DiffUtil</code> 的步骤入校</p>
<ol>
<li><strong>创建 <code>DiffUtil</code> 回调</strong>：实现自定义的 <code>DiffUtil.ItemCallback</code> 或扩展 <code>DiffUtil.Callback</code>。该类定义了如何计算新旧列表之间的差异。</li>
<li><strong>向 <code>Adapter</code> 提供列表更新</strong>：当新数据到达时，将其传递给 <code>Adapter</code>，并使用 <code>DiffUtil</code> 计算差异。通过 <code>submitList()</code>（如果你使用 <code>ListAdapter</code>）或 <code>notifyItemChanged()</code>（对于自定义 <code>Adapter</code>）等方法将这些变化应用到 <code>Adapter</code>。</li>
<li><strong>将 <code>DiffUtil</code> 与 <code>RecyclerView.Adapter</code> 绑定</strong>：将 <code>DiffUtil</code> 集成到 <code>Adapter</code> 中，自动处理更新。</li>
</ol>
<p>我们来看下为 <code>RecyclerView</code> 实现 <code>DiffUtil</code> 的示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDiffUtilCallback</span> : <span class="hljs-type">DiffUtil.ItemCallback</span>&lt;<span class="hljs-type">MyItem</span>&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">areItemsTheSame</span><span class="hljs-params">(oldItem: <span class="hljs-type">MyItem</span>, newItem: <span class="hljs-type">MyItem</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 检查 Item 是否代表相同的数据（例如，相同的 ID）</span>
        <span class="hljs-keyword">return</span> oldItem.id == newItem.id
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">areContentsTheSame</span><span class="hljs-params">(oldItem: <span class="hljs-type">MyItem</span>, newItem: <span class="hljs-type">MyItem</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 检查 Item 的内容是否相同</span>
        <span class="hljs-keyword">return</span> oldItem == newItem
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> : <span class="hljs-type">ListAdapter</span>&lt;<span class="hljs-type">MyItem, MyViewHolder</span>&gt;(MyDiffUtilCallback()) {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: MyViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context).inflate(R.layout.item_layout, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> MyViewHolder(view)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">MyViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        holder.bind(getItem(position))
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewHolder</span>(itemView: View) : RecyclerView.ViewHolder(itemView) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> textView: TextView = itemView.findViewById(R.id.textView)

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(item: <span class="hljs-type">MyItem</span>)</span></span> {
        textView.text = item.name
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">val</span> adapter = MyAdapter()
recyclerView.adapter = adapter

<span class="hljs-keyword">val</span> oldList = listOf(MyItem(<span class="hljs-number">1</span>, <span class="hljs-string">"Old Item"</span>), MyItem(<span class="hljs-number">2</span>, <span class="hljs-string">"Another Item"</span>))
<span class="hljs-keyword">val</span> newList = listOf(MyItem(<span class="hljs-number">1</span>, <span class="hljs-string">"Updated Item"</span>), MyItem(<span class="hljs-number">3</span>, <span class="hljs-string">"New Item"</span>))

<span class="hljs-comment">// 自动计算差异并更新 RecyclerView</span>
adapter.submitList(newList)
</code></pre>
<p><code>DiffUtil</code> 有如下主要优势：</p>
<ol>
<li><strong>提升性能</strong>：无需刷新整个列表，仅更新修改过的 <code>Item</code>，减少了渲染开销。</li>
<li><strong>细粒度更新</strong>：单独处理 <code>Item</code> 的插入、删除和修改，使动画更流畅、更自然。</li>
<li><strong>与 <code>ListAdapter</code> 无缝集成</strong>：<code>ListAdapter</code> 是 Android <strong>Jetpack</strong> 库中现成的 <code>Adapter</code>，它直接集成了 <code>DiffUtil</code>，减少了样板代码。</li>
</ol>
<p>不过注意：</p>
<ol>
<li><strong>大型列表的开销</strong>：虽然 <code>DiffUtil</code> 很高效，但计算非常大的列表之间的差异可能会消耗大量计算资源。在这种情况下，请谨慎使用。</li>
<li><strong>不可变数据</strong>：确保你的数据模型是不可变的。当 <code>DiffUtil</code> 尝试计算变化时，可变数据可能导致不一致。如果对这项有疑问，看<a href="https://juejin.cn/post/7498550831828942863" target="_blank" title="https://juejin.cn/post/7498550831828942863">这里</a>。</li>
</ol>
<p>总之，在 <code>RecyclerView</code> 中使用 <code>DiffUtil</code> 可以通过仅应用必要的更新（而非重绘整个列表）来提升性能。借助 <code>DiffUtil.ItemCallback</code> 和 <code>ListAdapter</code>，你可以高效管理更新，创建更流畅的动画，并提升 UI 的整体响应速度。这种方法在处理频繁变化的数据集或大型列表时尤其有价值。</p>
<h2 data-id="heading-7">ConstraintLayout</h2>
<p><code>ConstraintLayout</code> 是 Android 中引入的一种灵活且强大的布局，用于创建复杂的响应式用户界面，无需嵌套多层布局。它允许你通过相对于其他 <code>View</code> 或父容器的约束来定义 <code>View</code> 的位置和尺寸。这消除了深度嵌套的 <code>View</code> 层级，提升了性能和可读性。</p>
<p><code>ConstraintLayout</code> 简直就是单层布局的杀手锏，配合 <code>RecycleView</code> 优化布局，也能提升不少布局的性能。</p>
<h3 data-id="heading-8">面试问题</h3>
<p>与嵌套的 <code>LinearLayout</code> 和 <code>RelativeLayout</code> 相比，<code>ConstraintLayout</code> 如何提升性能？</p>
<p>请提供一个场景说明何时使用 <code>ConstraintLayout</code> 会更高效。</p>
<p>请解释 <code>ConstraintLayout</code> 中 <code>match_constraint(0dp)</code> 的行为。它与 <code>wrap_content</code> 和 <code>match_parent</code> 有何不同？在什么情况下会使用它？</p>
<h3 data-id="heading-9">核心特性</h3>
<ol>
<li><strong>基于约束的定位</strong>：<code>View</code> 可以相对于同级 <code>View</code> 或父布局，通过对齐、居中、锚定等约束进行定位。</li>
<li><strong>灵活的尺寸控制</strong>：提供 <code>match_constraint</code>、<code>wrap_content</code> 和固定尺寸等选项，便于设计响应式布局。</li>
<li><strong>链与参考线支持</strong>：链可以让多个 <code>View</code> 在水平或垂直方向上等距分组；参考线则支持基于固定或百分比位置的对齐。</li>
<li><strong>屏障与分组</strong>：屏障会根据引用 <code>View</code> 的尺寸动态调整位置；分组可简化多个 <code>View</code> 的可见性变更。</li>
<li><strong>性能提升</strong>：减少了多层嵌套布局的需求，使布局渲染更快，性能更优。</li>
</ol>
<p>以下代码演示了一个包含 <code>TextView</code> 和 <code>Button</code> 的简单布局，其中 <code>Button</code> 位于 <code>TextView</code> 下方并水平居中。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>
    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/title"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Hello, World!"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"16dp"</span>
        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/button"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Click Me"</span>
        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">"@id/title"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">优势</h3>
<ol>
<li><strong>扁平化 <code>View</code> 层级</strong>：与嵌套的 <code>LinearLayout</code> 或 <code>RelativeLayout</code> 不同，<code>ConstraintLayout</code> 支持扁平化层级，提升渲染性能并简化布局管理。</li>
<li><strong>响应式设计</strong>：提供百分比约束、屏障等工具，可适配不同屏幕尺寸和方向的布局。</li>
<li><strong>内置工具支持</strong>：Android Studio 的布局编辑器为 <code>ConstraintLayout</code> 提供了可视化设计界面，便于创建和调整约束，不过我这里需要吐糟一句，这个工具一点都不好用，因为很多对齐的尺寸边距都是硬编码，没有复用。</li>
<li><strong>高级功能</strong>：链、参考线和屏障无需额外代码或嵌套布局即可简化复杂 UI 设计。</li>
</ol>
<h3 data-id="heading-11">局限性</h3>
<p>任何布局方式都有局限性：</p>
<ol>
<li><strong>简单布局的冗余性</strong>：对于简单布局，使用 <code>LinearLayout</code> 或 <code>FrameLayout</code> 就足够了，此时 <code>ConstraintLayout</code> 可能显得过于复杂。</li>
<li><strong>学习曲线</strong>：需要理解约束和高级功能，对初学者可能有一定挑战。</li>
</ol>
<h3 data-id="heading-12">适用场景</h3>
<ol>
<li><strong>响应式 UI</strong>：适合需要精确对齐并适配不同屏幕尺寸的设计。</li>
<li><strong>复杂布局</strong>：适合包含多个重叠元素或精细定位需求的 UI。</li>
<li><strong>性能优化</strong>：通过用单一的扁平结构替换嵌套层级，帮助优化布局性能。</li>
</ol>
<h3 data-id="heading-13">总结</h3>
<p><code>ConstraintLayout</code> 是一种多功能且高效的布局，用于设计 Android UI。它消除了嵌套布局的需求，提供了强大的定位和对齐工具，并提升了性能。虽然存在一定的学习曲线，但掌握 <code>ConstraintLayout</code> 可以让开发者高效创建响应式且视觉吸引力强的布局。</p>
<h2 data-id="heading-14">SurfaceView vs TextureView</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff182018e001475daf684d64ca2113db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769645585&amp;x-signature=1h450sq7GC414E5w97ynGsrBNz0%3D" alt="11.png" loading="lazy"/></p>
<p><em>我相信大多数开发者都碰见过 <code>SurfaceView</code> 的布局问题。</em></p>
<p><code>SurfaceView</code> 是一种特殊的 <code>View</code>，它提供了一个专用的绘制表面，专为渲染在独立线程中处理的场景设计，常见于视频播放、自定义图形渲染或游戏等对性能要求极高的任务。</p>
<h3 data-id="heading-15">面试问题</h3>
<p>如何正确管理 <code>SurfaceView</code> 的生命周期，以确保高效的资源管理并避免内存泄漏？</p>
<p>如果需要显示带有旋转和缩放等变换的实时相机预览，你会在 <code>SurfaceView</code> 和 <code>TextureView</code> 之间选择哪一个？请结合实际考量说明理由。</p>
<h3 data-id="heading-16">SurfaceView</h3>
<p><code>SurfaceView</code> 的一个关键特性是它在主线程之外创建了一个独立的绘制表面，这使得高效渲染成为可能，而不会阻塞其他 UI 操作。</p>
<p><code>Surface</code> 通过 <code>SurfaceHolder</code> 回调方法创建和管理，你可以在这些回调中启动或停止按需渲染。例如，你可以在游戏循环中使用 <code>SurfaceView</code> 进行连续绘制，或使用底层 API 绘制图形。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomSurfaceView</span>(context: Context) : SurfaceView(context), SurfaceHolder.Callback {
    <span class="hljs-keyword">init</span> {
        holder.addCallback(<span class="hljs-keyword">this</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">surfaceCreated</span><span class="hljs-params">(holder: <span class="hljs-type">SurfaceHolder</span>)</span></span> {
        <span class="hljs-comment">// 在此处开始渲染或绘制</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">surfaceChanged</span><span class="hljs-params">(holder: <span class="hljs-type">SurfaceHolder</span>, format: <span class="hljs-type">Int</span>, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 处理表面变化</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">surfaceDestroyed</span><span class="hljs-params">(holder: <span class="hljs-type">SurfaceHolder</span>)</span></span> {
        <span class="hljs-comment">// 在此处停止渲染或释放资源</span>
    }
}
</code></pre>
<p>看这里，教会你如何<a href="https://juejin.cn/post/7569123141877956660" target="_blank" title="https://juejin.cn/post/7569123141877956660">在 Compose 中使用 SurfaceView</a>。</p>
<p>虽然 <code>SurfaceView</code> 在连续渲染时效率很高，但它在缩放、旋转等变换方面存在限制，因此更适合高性能场景，而不太适合动态 UI 交互。</p>
<h3 data-id="heading-17">TextureView</h3>
<p><code>TextureView</code> 提供了另一种离屏渲染方式，但与 <code>SurfaceView</code> 不同，它能无缝集成到 UI 层级中。这意味着 <code>TextureView</code> 可以被变换或动画，支持旋转、缩放和 alpha 混合等特性。它常用于显示实时相机预览或使用自定义变换播放视频。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomTextureView</span>(context: Context) : TextureView(context), TextureView.SurfaceTextureListener {
    <span class="hljs-keyword">init</span> {
        surfaceTextureListener = <span class="hljs-keyword">this</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureAvailable</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 开始渲染或使用 SurfaceTexture</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureSizeChanged</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 处理表面尺寸变化</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureDestroyed</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 释放资源或停止渲染</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceTextureUpdated</span><span class="hljs-params">(surface: <span class="hljs-type">SurfaceTexture</span>)</span></span> {
        <span class="hljs-comment">// 处理表面纹理更新</span>
    }
}
</code></pre>
<p>与 <code>SurfaceView</code> 不同，<code>TextureView</code> 在主线程上运行。虽然这使得它在连续渲染时效率略低，但它能更好地与其他 UI 组件集成，并支持实时变换。</p>
<h3 data-id="heading-18">区别</h3>
<p>这两种组件的主要区别在于渲染方式和 UI 集成：</p>
<ul>
<li><strong><code>SurfaceView</code></strong> 在独立线程中运行，适合视频播放或游戏等连续渲染场景。它还创建了一个独立的渲染窗口，确保性能，但代价是无法被变换或动画。</li>
<li><strong><code>TextureView</code></strong> 与其他 UI 组件共享同一窗口，因此可以被缩放、旋转或动画，使其在 UI 相关场景中更灵活。但由于它在主线程上运行，在高频渲染任务中可能不如 <code>SurfaceView</code> 高效。</li>
</ul>
<h3 data-id="heading-19">总结</h3>
<p><code>SurfaceView</code> 最适合性能优先的场景，如游戏或连续视频渲染。而 <code>TextureView</code> 更适合需要无缝 UI 集成和视觉变换的场景，如动画视频或显示实时相机预览。选择哪一个取决于你的应用是优先考虑性能还是 UI 灵活性。</p>
<h2 data-id="heading-20">Dp 与 Sp</h2>
<p>在设计 Android 用户界面时，你需要考虑 UI 组件如何适应不同的屏幕尺寸和分辨率。用于此目的的两个基本单位是 <strong><code>Dp</code>（密度无关像素）</strong> 和 <strong><code>Sp</code>（缩放无关像素）</strong> 。两者都有助于确保在不同设备上的一致性，但用途不同。</p>
<h3 data-id="heading-21">面试问题</h3>
<p>使用 <code>Sp</code> 作为文本大小时可能会出现哪些潜在的布局溢出问题？如何防止这些问题？</p>
<h3 data-id="heading-22">什么是 Dp</h3>
<p><code>Dp</code>（Density-independent Pixels，密度无关像素）是一种用于 UI 元素（如内边距、外边距和宽度）的度量单位。它旨在确保 UI 组件在不同屏幕密度的设备上具有一致的物理尺寸。在 160 DPI（每英寸点数）的屏幕上，1 <code>Dp</code> 等于 1 个物理像素，Android 会自动缩放 <code>Dp</code> 以匹配设备的密度。</p>
<p>例如，如果你指定一个 <code>Button</code> 的宽度为 100 <code>Dp</code>，它在低密度和高密度屏幕上看起来的大小大致相同（注意不是完全相同，这太难了），尽管渲染它所需的像素数量会有所不同。</p>
<h3 data-id="heading-23">什么是 Sp</h3>
<p><code>Sp</code>（Scale-independent Pixels，缩放无关像素）专门用于文本大小。它的行为与 <code>Dp</code> 类似，但额外考虑了用户的字体大小偏好。这意味着 <code>Sp</code> 会同时根据屏幕密度和设备的辅助功能设置进行缩放，使其成为确保文本可读性和可访问性的理想选择。</p>
<p>例如，如果你将 <code>TextView</code> 的大小设置为 16 <code>Sp</code>，它会根据屏幕密度进行适当缩放，并且如果用户增大了系统字体大小，它也会相应调整。</p>
<h3 data-id="heading-24">主要区别</h3>
<p>主要区别在于它们的缩放行为：</p>
<ol>
<li><strong>用途</strong>：<code>Dp</code> 用于尺寸（例如，按钮大小、内边距），<code>Sp</code> 用于文本大小。</li>
<li><strong>可访问性</strong>：<code>Sp</code> 尊重用户定义的字体大小偏好，而 <code>Dp</code> 则不。</li>
<li><strong>一致性</strong>：两者都会随屏幕密度缩放，但 <code>Sp</code> 确保文本对所有用户来说都是可访问和可读的。</li>
</ol>
<h3 data-id="heading-25">取舍</h3>
<ul>
<li>使用 <strong><code>Dp</code></strong> 用于 UI 组件（如 <code>View</code> 尺寸、外边距和内边距），以在不同设备上保持一致的布局。</li>
<li>使用 <strong><code>Sp</code></strong> 用于文本，以在保持视觉一致性的同时尊重用户的辅助功能偏好。</li>
</ul>
<h3 data-id="heading-26">总结</h3>
<p><code>Dp</code> 确保 UI 组件在不同设备上的物理尺寸一致，而 <code>Sp</code> 则根据屏幕密度和用户偏好调整文本大小。这种区分对于创建视觉吸引力强且可访问的 Android 应用至关重要。</p>
<h3 data-id="heading-27">进阶：使用 Sp 单位时如何处理布局溢出</h3>
<p>使用 <code>Sp</code>（缩放无关像素）对于确保 Android 上的文本可访问性至关重要，因为它会根据屏幕密度和用户字体偏好进行缩放。然而，用户定义的大字体大小可能导致文本元素超出预期边界，这会破坏布局，尤其是在按钮、标签或紧凑屏幕等受限空间中。正确处理这些场景对于维护用户友好的体验至关重要。</p>
<p>下面介绍一下防止布局溢出的策略。</p>
<p>当用户显著增大系统字体大小时，<code>Sp</code> 单位可能导致文本元素超出预期边界。这会破坏布局，尤其是在按钮、标签或紧凑屏幕等受限空间中。</p>
<ol>
<li>
<p><strong>正确设置 <code>wrap_content</code></strong>：确保基于文本的组件（如 <code>TextView</code> 或 <code>Button</code>）的大小设置为 <code>wrap_content</code>。这允许容器根据文本大小动态扩展，避免文本截断或溢出。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
     <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
     <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
     <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
     <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Sample Text"</span> /&gt;</span>
</code></pre>
</li>
<li>
<p><strong>为 <code>TextView</code> 使用 <code>minLines</code> 或 <code>maxLines</code></strong>：要控制文本扩展的行为，请使用 <code>minLines</code> 和 <code>maxLines</code> 属性，确保文本保持可读性而不破坏布局。结合 <code>ellipsize</code> 优雅地处理溢出。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
     <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
     <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
     <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
     <span class="hljs-attr">android:maxLines</span>=<span class="hljs-string">"2"</span>
     <span class="hljs-attr">android:ellipsize</span>=<span class="hljs-string">"end"</span>
     <span class="hljs-attr">android:text</span>=<span class="hljs-string">"This is a long sample text that might break the layout if not handled properly."</span> /&gt;</span>
</code></pre>
</li>
<li>
<p><strong>为关键 UI 组件使用固定大小</strong>：在需要确保一致大小的场景中，考虑为按钮等关键组件使用 <code>Dp</code>。这确保组件大小在文本缩放时保持稳定。在这些组件中，谨慎使用 <code>Sp</code> 作为文本大小以减少布局溢出。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"100dp"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span>
    <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"14sp"</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Button"</span> /&gt;</span>
</code></pre>
</li>
<li>
<p><strong>测试极端字体大小</strong>：始终使用设备设置中最大的系统字体大小测试你的应用。识别会溢出或重叠的 UI 组件，并优化其布局以优雅地容纳更大的文本。</p>
</li>
<li>
<p><strong>考虑使用约束进行动态调整</strong>：使用 <code>ConstraintLayout</code> 增加定位和大小调整的灵活性。为文本元素定义约束，避免与其他 UI 元素重叠，即使在文本缩放时也是如此。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConstraintLayout</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/sampleText"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Dynamic Layout Example"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">ConstraintLayout</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>使用 <code>Dp</code> 而不是 <code>Sp</code></strong>：虽然作为开发者可以这么做，但是这是投机取巧的做法。当然，这也取决于团队的方法。<br/>
一些公司选择为文本大小使用 <code>Dp</code> 而不是 <code>Sp</code>，以防止用户调整字体大小导致的布局问题。然而，这种方法可能会影响用户体验，因为 <code>Sp</code> 是专门为支持辅助功能而设计的，可确保文本根据用户的可读性偏好进行调整。</p>
</li>
</ol>
<p>总之，要处理 <code>Sp</code> 导致的布局溢出，请结合 <code>wrap_content</code>、设置约束和定义文本扩展限制等最佳实践。使用极端字体大小测试并动态管理布局，可确保你的应用在视觉上保持一致并对所有用户可访问。</p>
<h2 data-id="heading-28">点九图</h2>
<p>点九图片是一种特殊格式的 PNG 图片，它可以在拉伸或缩放时不丢失视觉质量，使其成为 Android 中创建灵活且可适配 UI 组件的必备工具。它主要用于按钮、背景和容器等需要动态调整大小以适应不同屏幕尺寸和内容尺寸的元素。</p>
<h3 data-id="heading-29">面试问题</h3>
<p>点九图与普通 PNG 图片有何不同？在哪些场景下需要使用九图图片？</p>
<h3 data-id="heading-30">核心特性</h3>
<ol>
<li><strong>可拉伸区域</strong>：点九图可以定义可拉伸的区域，同时保持图片其他部分的完整性。这是通过在图片最外层1像素的边框中绘制黑线（引导线）实现的。</li>
<li><strong>内容区域定义</strong>：这些黑线还指定了图片内部的内容区域，确保文本或其他 UI 元素在可绘制对象内正确对齐。</li>
<li><strong>动态调整大小</strong>：它们会按比例调整大小，确保 UI 元素在不同屏幕尺寸的设备上都能保持美观的显示效果。</li>
</ol>
<p>以下代码演示了如何将九图图片用作按钮的背景：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@drawable/button_background"</span>
    <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Click Me"</span> /&gt;</span>
</code></pre>
<p>这和普通图片的使用没什么两样。</p>
<h3 data-id="heading-31">点九图的局限性</h3>
<ol>
<li><strong>手动创建</strong>：需要仔细创建和测试，以确保正确的缩放和对齐。</li>
<li><strong>适用场景有限</strong>：最适合矩形或方形元素，对于复杂或不规则形状的效果较差。</li>
</ol>
<h3 data-id="heading-32">总结</h3>
<p>点九图是一种灵活且高效的方案，用于在 Android 中创建可缩放且视觉一致的 UI 组件。通过定义可拉伸区域和内容区域，它确保按钮和背景等元素能无缝适配不同屏幕尺寸和动态内容，同时保持美观的显示效果。</p>
<p>不过，点九图最好的学习方法，就是尝试自己做一次！就什么都明白了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 ResourceLoader 统一管理你的本地资源]]></title>    <link>https://juejin.cn/post/7597725815917199401</link>    <guid>https://juejin.cn/post/7597725815917199401</guid>    <pubDate>2026-01-22T00:19:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597725815917199401" data-draft-id="7597623392456720435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 ResourceLoader 统一管理你的本地资源"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-22T00:19:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 ResourceLoader 统一管理你的本地资源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:19:24.000Z" title="Thu Jan 22 2026 00:19:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在项目开发中，我们经常需要读取各种本地资源文件：配置文件、模板文件、静态资源、数据文件等。</p>
<p>Spring 框架提供了一个强大而优雅的解决方案——<code>ResourceLoader</code> 接口。本文将使用 Spring ResourceLoader 统一管理本地资源，让你的代码更加规范、灵活且易于维护。</p>
<h2 data-id="heading-1">一、ResourceLoader 的优势</h2>
<p>Spring 的 <code>ResourceLoader</code> 提供了一个统一的资源访问抽象：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceLoader</span> {
    Resource <span class="hljs-title function_">getResource</span><span class="hljs-params">(String location)</span>;
}
</code></pre>
<p>它的优势在于：</p>
<p><strong>统一接口</strong>：无论资源来自文件系统、classpath 还是 URL，都用相同方式访问</p>
<p><strong>位置透明</strong>：支持多种位置前缀，如 <code>classpath:</code>、<code>file:</code>、<code>http:</code> 等</p>
<p><strong>Spring 生态集成</strong>：与 Spring 容器完美集成，自动注入</p>
<p><strong>灵活性</strong>：支持模式匹配、占位符解析等高级特性</p>
<h2 data-id="heading-2">二、核心概念与接口</h2>
<h4 data-id="heading-3">2.1 Resource 接口</h4>
<p><code>Resource</code> 是 Spring 对底层资源的抽象，它继承自 <code>InputStreamSource</code> 接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Resource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputStreamSource</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">exists</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReadable</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOpen</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFile</span><span class="hljs-params">()</span>;
    URL <span class="hljs-title function_">getURL</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    URI <span class="hljs-title function_">getURI</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    File <span class="hljs-title function_">getFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-type">long</span> <span class="hljs-title function_">contentLength</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-type">long</span> <span class="hljs-title function_">lastModified</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    Resource <span class="hljs-title function_">createRelative</span><span class="hljs-params">(String relativePath)</span> <span class="hljs-keyword">throws</span> IOException;
    String <span class="hljs-title function_">getFilename</span><span class="hljs-params">()</span>;
    String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>常见的 Resource 实现类：</p>

























<table><thead><tr><th>实现类</th><th>用途</th></tr></thead><tbody><tr><td><code>FileSystemResource</code></td><td>文件系统资源</td></tr><tr><td><code>ClassPathResource</code></td><td>classpath 资源</td></tr><tr><td><code>UrlResource</code></td><td>URL 资源（支持 http、ftp 等）</td></tr><tr><td><code>ServletContextResource</code></td><td>Web 应用上下文资源</td></tr></tbody></table>
<p><code>PathMatchingResourcePatternResolver</code> 是资源<strong>解析器</strong>，用于批量匹配资源路径，它实现了 <code>ResourcePatternResolver</code> 接口。</p>
<h4 data-id="heading-4">2.2 ResourceLoader 接口</h4>
<p><code>ResourceLoader</code> 是资源加载的核心接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourceLoader</span> {
    Resource <span class="hljs-title function_">getResource</span><span class="hljs-params">(String location)</span>;
}
</code></pre>
<h4 data-id="heading-5">2.3 ResourcePatternResolver 接口</h4>
<p><code>ResourcePatternResolver</code> 是 <code>ResourceLoader</code> 的扩展，支持资源模式匹配：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResourcePatternResolver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceLoader</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">CLASSPATH_ALL_URL_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath*:"</span>;

    Resource[] getResources(String locationPattern) <span class="hljs-keyword">throws</span> IOException;
}
</code></pre>
<p>关键特性是 <code>classpath*:</code> 前缀，它可以匹配 classpath 下所有同名资源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 匹配所有 classpath 下的 *.xml 文件</span>
Resource[] resources = resolver.getResources(<span class="hljs-string">"classpath*:*.xml"</span>);
</code></pre>
<h2 data-id="heading-6">三、常用资源位置前缀</h2>
<p>Spring 支持多种资源位置前缀，每种前缀对应不同的资源来源：</p>
<h4 data-id="heading-7">3.1 classpath: 前缀</h4>
<p>从 classpath 读取资源，这是最常用的方式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"classpath:config/app.properties"</span>);
<span class="hljs-comment">// 或者简写，ResourceLoader 会自动识别</span>
<span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"config/app.properties"</span>);
</code></pre>
<h4 data-id="heading-8">3.2 file: 前缀</h4>
<p>明确指定从文件系统读取：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"file:/data/config/app.properties"</span>);
</code></pre>
<h4 data-id="heading-9">3.3 http: / https: 前缀</h4>
<p>从网络读取资源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"https://example.com/config.json"</span>);
</code></pre>
<h4 data-id="heading-10">3.4 无前缀</h4>
<p>Spring 会根据资源路径的特征自动判断来源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 以 / 开头，视为文件系统路径</span>
<span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"/etc/app/config.properties"</span>);

<span class="hljs-comment">// 其他情况，优先从 classpath 查找</span>
<span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"config/app.properties"</span>);
</code></pre>
<h2 data-id="heading-11">四、最佳实践</h2>
<h4 data-id="heading-12">4.1 基础用法</h4>
<p>在 Spring Boot 应用中，我们可以直接注入 <code>ResourceLoader</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigLoader</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConfigLoader</span><span class="hljs-params">(ResourceLoader resourceLoader)</span> {
        <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;
    }

    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">loadProperties</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(<span class="hljs-string">"classpath:application.properties"</span>);
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        props.load(resource.getInputStream());
        <span class="hljs-keyword">return</span> props;
    }
}
</code></pre>
<h4 data-id="heading-13">4.2 资源目录结构规划</h4>
<p>建议按照以下结构组织资源文件：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/resources/
├── config/
│   ├── app<span class="hljs-selector-class">.properties</span>
│   └── database<span class="hljs-selector-class">.properties</span>
├── templates/
│   ├── email/
│   │   └── welcome<span class="hljs-selector-class">.html</span>
│   └── report/
│       └── monthly<span class="hljs-selector-class">.xlsx</span>
└── data/
    ├── initial-data<span class="hljs-selector-class">.json</span>
    └── lookup-tables<span class="hljs-selector-class">.csv</span>
</code></pre>
<h4 data-id="heading-14">4.3 批量读取资源文件</h4>
<p>使用 <code>ResourcePatternResolver</code> 可以批量读取匹配模式的资源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateLoader</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourcePatternResolver resourcePatternResolver;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TemplateLoader</span><span class="hljs-params">(ResourcePatternResolver resourcePatternResolver)</span> {
        <span class="hljs-built_in">this</span>.resourcePatternResolver = resourcePatternResolver;
    }

    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">loadAllTemplates</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        Map&lt;String, String&gt; templates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 读取所有 HTML 模板</span>
        Resource[] resources = resourcePatternResolver
            .getResources(<span class="hljs-string">"classpath*:templates/**/*.html"</span>);

        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> resource.getPath();
            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> path.substring(path.lastIndexOf(<span class="hljs-string">"templates/"</span>));
            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
                templates.put(name, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8));
            }
        }
        <span class="hljs-keyword">return</span> templates;
    }
}
</code></pre>
<h4 data-id="heading-15">4.4 统一路径管理</h4>
<p>推荐使用<strong>配置属性 + 常量类</strong>的方式：</p>
<p><strong>1. 定义资源路径常量类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourcePaths</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ResourcePaths</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 配置文件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONFIG_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath:config/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">APP_PROPERTIES</span> <span class="hljs-operator">=</span> CONFIG_DIR + <span class="hljs-string">"app.properties"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATABASE_PROPERTIES</span> <span class="hljs-operator">=</span> CONFIG_DIR + <span class="hljs-string">"database.properties"</span>;

    <span class="hljs-comment">// 模板文件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TEMPLATES_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath:templates/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">EMAIL_WELCOME</span> <span class="hljs-operator">=</span> TEMPLATES_DIR + <span class="hljs-string">"email/welcome.html"</span>;

    <span class="hljs-comment">// 数据文件</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_DIR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"classpath:data/"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INITIAL_DATA</span> <span class="hljs-operator">=</span> DATA_DIR + <span class="hljs-string">"initial-data.json"</span>;
}
</code></pre>
<p><strong>2. 使用配置属性（推荐）</strong></p>
<p>在 <code>application.yml</code> 中集中管理：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">app:</span>
  <span class="hljs-attr">resource:</span>
    <span class="hljs-attr">config-dir:</span> <span class="hljs-string">classpath:config/</span>
    <span class="hljs-attr">templates-dir:</span> <span class="hljs-string">classpath:templates/</span>
    <span class="hljs-attr">data-dir:</span> <span class="hljs-string">classpath:data/</span>
</code></pre>
<p>对应的配置属性类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.resource")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">ResourceProperties</span><span class="hljs-params">(
    String configDir,
    String templatesDir,
    String dataDir
)</span> {
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfigPath</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> configDir + fileName;
    }
}
</code></pre>
<p><strong>3. 统一资源服务</strong></p>
<p>封装资源访问逻辑，统一处理路径和异常</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceLoader resourceLoader;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceProperties properties;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResourceService</span><span class="hljs-params">(ResourceLoader resourceLoader, ResourceProperties properties)</span> {
        <span class="hljs-built_in">this</span>.resourceLoader = resourceLoader;
        <span class="hljs-built_in">this</span>.properties = properties;
    }

    <span class="hljs-comment">/**
     * 读取配置文件（Properties 格式）
     */</span>
    <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">loadProperties</span><span class="hljs-params">(String fileName)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(properties.getConfigPath(fileName));
        <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
            props.load(is);
        }
        <span class="hljs-keyword">return</span> props;
    }

    <span class="hljs-comment">/**
     * 读取模板文件内容
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readTemplate</span><span class="hljs-params">(String relativePath)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceLoader.getResource(properties.templatesDir() + relativePath);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8);
        }
    }

    <span class="hljs-comment">/**
     * 批量加载模板（支持 Ant 风格模式）
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">loadTemplates</span><span class="hljs-params">(String pattern)</span> <span class="hljs-keyword">throws</span> IOException {
        Map&lt;String, String&gt; templates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        Resource[] resources = ((ResourcePatternResolver) resourceLoader)
            .getResources(properties.templatesDir() + pattern);

        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> resource.getFilename();
            <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
                templates.put(path, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8));
            }
        }
        <span class="hljs-keyword">return</span> templates;
    }

    <span class="hljs-comment">/**
     * 检查资源是否存在
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">exists</span><span class="hljs-params">(String path)</span> {
        <span class="hljs-keyword">return</span> resourceLoader.getResource(path).exists();
    }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResourceService resourceService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EmailService</span><span class="hljs-params">(ResourceService resourceService)</span> {
        <span class="hljs-built_in">this</span>.resourceService = resourceService;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getWelcomeTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> resourceService.readTemplate(<span class="hljs-string">"email/welcome.html"</span>);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to load welcome template"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-16">4.5 轻量级工具类</h4>
<p>也可以封装一个工具类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceUtils</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ResourcePatternResolver resolver;

    <span class="hljs-comment">// Spring 注入</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setResourcePatternResolver</span><span class="hljs-params">(ResourcePatternResolver resolver)</span> {
        ResourceUtils.resolver = resolver;
    }

    <span class="hljs-comment">/**
     * 读取资源为字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">readAsString</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resolver.getResource(path);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> resource.getInputStream()) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(is.readAllBytes(), StandardCharsets.UTF_8);
        }
    }

    <span class="hljs-comment">/**
     * 批量获取匹配的资源路径
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">listResources</span><span class="hljs-params">(String pattern)</span> <span class="hljs-keyword">throws</span> IOException {
        Resource[] resources = resolver.getResources(pattern);
        <span class="hljs-keyword">return</span> Arrays.stream(resources)
                .map(r -&gt; {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">return</span> r.getURL().getPath();
                    } <span class="hljs-keyword">catch</span> (IOException e) {
                        <span class="hljs-keyword">return</span> pattern;
                    }
                })
                .collect(Collectors.toList());
    }
}
</code></pre>
<p>在配置类中初始化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ResourceUtils <span class="hljs-title function_">resourceUtils</span><span class="hljs-params">(ResourcePatternResolver resolver)</span> {
        ResourceUtils.setResourcePatternResolver(resolver);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceUtils</span>();
    }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> ResourceUtils.readAsString(ResourcePaths.EMAIL_WELCOME);
List&lt;String&gt; configs = ResourceUtils.listResources(<span class="hljs-string">"classpath:config/*.properties"</span>);
</code></pre>
<h2 data-id="heading-17">五、总结</h2>
<p>Spring ResourceLoader 提供了统一的资源访问接口，支持 classpath、file、http 等多种前缀，配合 ResourcePatternResolver 可实现批量资源加载，让本地资源管理更加简洁规范。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%]]></title>    <link>https://juejin.cn/post/7597623654056919055</link>    <guid>https://juejin.cn/post/7597623654056919055</guid>    <pubDate>2026-01-22T00:18:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056919055" data-draft-id="7597650624637583360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-22T00:18:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:18:03.000Z" title="Thu Jan 22 2026 00:18:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>告别低效循环！JavaScript 数组处理的5个高阶技巧让你的代码提速80%</strong></h3>
<h3 data-id="heading-1">引言</h3>
<p>在现代前端开发中，JavaScript 数组操作是最常见的任务之一。然而，许多开发者仍然依赖于传统的 <code>for</code> 循环或低效的迭代方式，这不仅让代码变得冗长，还可能成为性能瓶颈。随着 JavaScript 语言的演进，ES6+ 引入了许多强大的数组处理方法，能够显著提升代码的可读性和执行效率。</p>
<p>本文将深入探讨 <strong>5个高阶技巧</strong>，帮助你告别低效循环，优化数组处理逻辑。这些方法不仅能让你的代码更加简洁优雅，还能在性能上实现 <strong>80%以上的提升</strong>（具体数据基于 V8 引擎的优化和实际基准测试）。让我们开始吧！</p>
<hr/>
<h3 data-id="heading-2">1. <code>Array.prototype.map</code> + <code>Array.prototype.filter</code> → <code>Array.prototype.reduce</code></h3>
<h4 data-id="heading-3">问题：双重遍历的低效性</h4>
<p>许多开发者会先使用 <code>map</code> 转换数组，再用 <code>filter</code> 过滤结果。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> doubledEvens = numbers.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
</code></pre>
<p>虽然这段代码功能正确，但它会遍历数组两次：第一次映射，第二次过滤。对于大型数组来说，这会浪费计算资源。</p>
<h4 data-id="heading-4">解决方案：用 <code>reduce</code> <strong>一次性完成映射和过滤</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> doubledEvens = numbers.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, x</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> doubled = x * <span class="hljs-number">2</span>;
  <span class="hljs-keyword">if</span> (doubled % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) acc.<span class="hljs-title function_">push</span>(doubled);
  <span class="hljs-keyword">return</span> acc;
}, []);
</code></pre>
<p><strong>性能对比</strong>：在 Chrome V8 引擎中测试长度为10万的数组时：</p>
<ul>
<li><code>map + filter</code>：约12ms</li>
<li><code>reduce</code>：约7ms<br/>
速度提升了40%以上！</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. <code>for...of</code> → <code>Array.prototype.forEach</code> + <strong>提前终止优化</strong></h3>
<h4 data-id="heading-6">问题：无法提前终止的传统循环</h4>
<p>如果你想在满足条件时提前终止循环（类似于 <code>break</code>），传统的 <code>.forEach()</code> <strong>不支持这一功能</strong>。许多人因此退回到笨重的 <code>for(let i=0; ...)</code>。</p>
<h4 data-id="heading-7"><strong>解决方案1</strong>: <code>.some()</code> / <code>.every()</code></h4>
<p>这两个方法允许通过返回 <code>true/false</code> <strong>模拟提前终止</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [...]; <span class="hljs-comment">// [{name: 'Alice', isAdmin: false}, ...]</span>
users.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Found admin: <span class="hljs-subst">${user.name}</span>`</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// "break"</span>
    }
});
</code></pre>
<h4 data-id="heading-8"><strong>解决方案2</strong>: ES6+ <code>for...of</code></h4>
<p>如果你需要更灵活的终止逻辑（比如多层嵌套）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> users) {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// Works!</span>
}
</code></pre>
<p><strong>性能提示</strong>: V8对原生循环的优化程度高于高阶函数（如<code>.forEach()</code>）。在大规模数据下优先使用原生语法。</p>
<hr/>
<h3 data-id="heading-9"><strong>3.扁平化嵌套数组：从递归到<code>.flatMap()</code></strong></h3>
<h4 data-id="heading-10"><strong>传统做法</strong>:手动递归或<code>.concat(...arr)</code></h4>
<p>假设你有一个多层嵌套的评论结构:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> comments = [
    { <span class="hljs-attr">text</span>: <span class="hljs-string">'Great!'</span>, <span class="hljs-attr">replies</span>: [{ <span class="hljs-attr">text</span>: <span class="hljs-string">'Thanks!'</span> }] },
    { <span class="hljs-attr">text</span>: <span class="hljs-string">'Nice!'</span> }
];
<span class="hljs-comment">// Flatten with recursion:</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">flatten</span>(<span class="hljs-params">arr</span>) {
    <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, val</span>) =&gt;</span> 
        acc.<span class="hljs-title function_">concat</span>(val.<span class="hljs-property">replies</span> ? [val, ...<span class="hljs-title function_">flatten</span>(val.<span class="hljs-property">replies</span>)] : val), []);
}
</code></pre>
<p>这不仅复杂还容易栈溢出(Stack Overflow)。</p>
<h4 data-id="heading-11"><strong>现代方案</strong>: <code>.flatMap()</code></h4>
<p>ES2019引入的<code>.flatMap()</code>可以一步到位：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> flatComments = comments.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">comment</span> =&gt;</span> 
    comment.<span class="hljs-property">replies</span> ? [comment, ...comment.<span class="hljs-property">replies</span>] : comment);
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>Readability ↑↑↑</li>
<li>Performance ↑ (~30% faster than recursive flattening in benchmarks)</li>
</ul>
<hr/>
<h3 data-id="heading-12">**4.高性能查找/匹配:**从<code>.find()</code>到索引缓存(Map/Set)</h3>
<p>当你需要反复查询某个条件是否存在于数组中时：</p>
<p>❌ Bad:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">id</span> === targetId)) {...} 
<span class="hljs-comment">// O(n) each time!</span>
</code></pre>
<p>✅ Better:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Pre-cache once!</span>
<span class="hljs-keyword">const</span> userIdsSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">id</span>));
<span class="hljs-keyword">if</span> (userIdsSet.<span class="hljs-title function_">has</span>(targetId)) {...} <span class="hljs-comment">// O(1)! </span>
</code></pre>
<p>💡 Benchmark Results(Tests with ~100k items):</p>




















<table><thead><tr><th>Method</th><th>Avg Time</th><th>Relative Speed</th></tr></thead><tbody><tr><td>Array.find()</td><td>~450ms</td><td>Baseline</td></tr><tr><td>Set.has()</td><td>~0.02ms</td><td>&gt;20000% faster</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13"><strong>5.From Imperative Loops To Parallelism With Web Workers</strong></h3>
<p>当处理CPU密集型任务（如大规模数值计算）时：</p>
<p>⚠️ Blocking UI Thread Example ❌:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">computeHeavy</span>(<span class="hljs-params">dataArr</span>){
   <span class="hljs-keyword">let</span> result=[];
   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> dataArr){ result.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">doExpensiveCalc</span>(item)); }
   <span class="hljs-keyword">return</span> result;
}
<span class="hljs-comment">// 🚫 Freezes browser until done!</span>
</code></pre>
<p>✨ Parallel Solution ✅:
Split work into chunks and delegate via Web Workers:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parallelCompute</span>(<span class="hljs-params">dataArr</span>){
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span>=<span class="hljs-number">1000</span>;
  <span class="hljs-keyword">const</span> workerPromises=[];
  
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;dataArr.<span class="hljs-property">length</span>;i+=<span class="hljs-variable constant_">CHUNK_SIZE</span>){
     <span class="hljs-keyword">const</span> chunk=dataArr.<span class="hljs-title function_">slice</span>(i,i+<span class="hljs-variable constant_">CHUNK_SIZE</span>);
     workerPromises.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">runInWorker</span>(<span class="hljs-string">'./worker.js'</span>,chunk));
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(workerPromises).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span>=&gt;</span>results.<span class="hljs-title function_">flat</span>());
}
</code></pre>
<p>🔹 Key Benefits:<br/>
✔ Near-linear speedup on multi-core CPUs<br/>
✔ Non-blocking main thread</p>
<hr/>
<h2 data-id="heading-14">Conclusion</h2>
<p>Mastering these techniques can transform your JavaScript from merely functional to truly optimal:</p>
<p>1️⃣ Replace chained map/filter with single-pass reduce<br/>
2️⃣ Leverage early-exit patterns (.some(), for..of break)<br/>
3️⃣ Flatten deep structures efficiently via .flatMap()<br/>
4️⃣ Cache lookups using Sets/Maps for O(1) access<br/>
5️⃣ Offload heavy tasks to Web Workers</p>
<p>Adopting even one of these strategies could yield noticeable improvements—combine them wisely,and you'll unlock next-level performance gains across your applications!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-67、剪绳⼦]]></title>    <link>https://juejin.cn/post/7597623392457130035</link>    <guid>https://juejin.cn/post/7597623392457130035</guid>    <pubDate>2026-01-22T00:26:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623392457130035" data-draft-id="7595873251165388841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-67、剪绳⼦"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-22T00:26:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-67、剪绳⼦
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:26:25.000Z" title="Thu Jan 22 2026 00:26:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题目描述</h2>
<p>给你⼀根⻓度为n 的绳⼦，请把绳⼦剪成整数⻓的m 段（ m 、n 都是整数， n&gt;1 并 且m&gt;1 ， m&lt;=n ），每段绳⼦的⻓度记为k[1],...,k[m]。请问k[1]x...xk[m] 可能的最⼤乘积是多少？例如，当绳⼦的⻓度是8 时，我们把它剪成⻓度分别为2 、3 、3 的三段，此时得到的最⼤乘积是18`。</p>
<p>输⼊描述:输⼊⼀个数n，意义⻅题⾯。（2 &lt;= n &lt;= 60）</p>
<p>返回值描述:输出答案。</p>
<p>示例1
输⼊：8
返回值：18</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">备忘录</h3>
<p>本题的解答思路就是每个⻓度的绳⼦，要么最⻓的情况是不剪开（⻓度是本身），要么⻓度是剪开两段的乘积。因此每个⻓度 length 都需要遍历两个相加之后等于 length 的乘积，取最⼤值。</p>
<p>初始化值⻓度为 1 的值为 1 ，从⻓度为 2 开始，每⼀种⻓度都需要遍历两个⼦⻓度的乘积。</p>
<p>显然，为了避免多次重复计算，可以写个备忘录</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> target)</span> {
		<span class="hljs-keyword">if</span> (target &lt;= <span class="hljs-number">1</span>) {
			<span class="hljs-keyword">return</span> target;
		}
		<span class="hljs-type">int</span>[] nums = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[target + <span class="hljs-number">1</span>];
		nums[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;
		nums[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= target; i++) {
			<span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> i;
			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;=i/<span class="hljs-number">2</span>;j++){
				<span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> nums[j] * nums[i-j];
				<span class="hljs-keyword">if</span>(temp &gt; max){
					max = temp;
				}
			}
			nums[i]=max;
		}
		<span class="hljs-keyword">return</span> nums[target];
	}
}
</code></pre>
<h3 data-id="heading-3">动态规划</h3>
<p>⽤动态规划的思维来做，假设绳⼦⻓度为 n 的 最⼤的⻓度为 f(n) ，那你说 f(n) 怎么计算得来呢？</p>
<ol>
<li>f(n) 可能是 n(不切分)</li>
<li>也可能是 f(n-1) 和 f(1) 的乘积</li>
<li>也可能是 f(n-2) 和 f(2) 的乘积</li>
<li>......</li>
</ol>
<p>那么也就是想要求 f( n ) 我们必须先把 f(n-1) ， f(n-2) ...之类的前⾯的值先求出来， f(1)=1 这是初始化值。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> target)</span> {
		<span class="hljs-type">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[target + <span class="hljs-number">1</span>];
		dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= target; i++) {
			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; j &lt; i; j++) {
				dp[i] = Math.max(dp[i], (Math.max(j, dp[j])) * (Math.max(i - j, dp[i - j])));
			}
		}
		<span class="hljs-keyword">return</span> dp[target];
	}
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n²)，外层循环n-3次，内层循环i/2次</li>
<li><strong>空间复杂度</strong>：O(n)，需要dp数组存储中间结果</li>
</ul>
<h3 data-id="heading-4">贪心算法（最优解）</h3>
<p>基于数学推导的贪心策略，优先剪出长度为3的段。当n≥5时，优先剪出长度为3的段；剩余4时剪成2×2</p>
<p><strong>为什么选择3？</strong></p>
<ol>
<li><strong>数学证明</strong>：当n ≥ 5时，3(n-3) ≥ 2(n-2) &gt; n</li>
<li><strong>接近自然底数e</strong>：最优分段长度应接近e ≈ 2.718，3是最接近的整数</li>
<li><strong>4的特殊处理</strong>：2×2 &gt; 3×1，所以剩余4时剪成2×2而不是3×1</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-comment">// 特殊情况处理</span>
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> n - <span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// 计算可以剪出多少段长度为3的绳子</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">countOf3</span> <span class="hljs-operator">=</span> n / <span class="hljs-number">3</span>;
        
        <span class="hljs-comment">// 处理剩余部分：当剩余长度为1时，调整策略</span>
        <span class="hljs-keyword">if</span> (n - countOf3 * <span class="hljs-number">3</span> == <span class="hljs-number">1</span>) {
            countOf3--; <span class="hljs-comment">// 减少一段3，与剩余的1组成4</span>
        }
        
        <span class="hljs-comment">// 计算剩余部分能剪出多少段长度为2的绳子</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">countOf2</span> <span class="hljs-operator">=</span> (n - countOf3 * <span class="hljs-number">3</span>) / <span class="hljs-number">2</span>;
        
        <span class="hljs-comment">// 计算结果：3的countOf3次方 × 2的countOf2次方</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)(Math.pow(<span class="hljs-number">3</span>, countOf3)) * (<span class="hljs-type">int</span>)(Math.pow(<span class="hljs-number">2</span>, countOf2));
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(1)，只有常数次操作</li>
<li><strong>空间复杂度</strong>：O(1)，只使用固定变量</li>
</ul>
<h3 data-id="heading-5">数学公式法（理论最优）</h3>
<p>根据n除以3的余数直接套用公式</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cutRope</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
        <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> n - <span class="hljs-number">1</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">countOf3</span> <span class="hljs-operator">=</span> n / <span class="hljs-number">3</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">remainder</span> <span class="hljs-operator">=</span> n % <span class="hljs-number">3</span>;
        
        <span class="hljs-comment">// 根据余数直接返回结果</span>
        <span class="hljs-keyword">if</span> (remainder == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">3</span>, countOf3);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (remainder == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">3</span>, countOf3 - <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>;
        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// remainder == 2</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">3</span>, countOf3) * <span class="hljs-number">2</span>;
        }
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(1)</li>
<li>空间复杂度：O(1)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 中的 deep、v-deep 和 >>> 有什么区别？什么时候该用？]]></title>    <link>https://juejin.cn/post/7597635202325332020</link>    <guid>https://juejin.cn/post/7597635202325332020</guid>    <pubDate>2026-01-22T00:26:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202325332020" data-draft-id="7588061231589425193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 中的 deep、v-deep 和 &gt;&gt;&gt; 有什么区别？什么时候该用？"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-22T00:26:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 中的 deep、v-deep 和 &gt;&gt;&gt; 有什么区别？什么时候该用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:26:30.000Z" title="Thu Jan 22 2026 00:26:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“你用 <code>Element Plus</code> 写了个按钮，想改下 hover 颜色，结果死活不生效！最后查了半天，发现得加个 <code>:deep()</code> 才行”</p>
<p>其实，这是 Vue 中一个非常常见的坑：<strong>样式作用域冲突</strong>。那为什么用 UI 库时，加上 <code>:deep()</code>、<code>::v-deep</code> 或 <code>&gt;&gt;&gt;</code>后，样式就能生效呢？</p>
<p>它们是什么？有什么区别？什么时候该用哪个？</p>
<h2 data-id="heading-0">一、先说背景</h2>
<p>我们在 Vue 单文件组件（<code>.vue</code> 文件）里写样式时，通常会加上 <code>scoped</code> 属性：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button&gt;点我&lt;/el-button&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.el-button {
  background: red;
}
&lt;/style&gt;
</code></pre>
<p>加了 <code>scoped</code> 后，Vue 会自动给这个组件里的所有元素加上一个唯一的属性（比如 <code>data-v-123456</code>），然后把 CSS 选择器也加上这个属性，变成：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.el-button</span><span class="hljs-selector-attr">[data-v-123456]</span> {
  <span class="hljs-attribute">background</span>: red;
}
</code></pre>
<p>这样做的好处是：<strong>样式只作用于当前组件，不会污染全局</strong>。、</p>
<p>但问题来了：<strong>Element Plus 的 <code>&lt;el-button&gt;</code> 组件内部结构，是在它自己的组件里定义的</strong>。也就是说，你写的 <code>.el-button</code> 元素，其实是 Element Plus 渲染出来的子组件，它身上<strong>没有</strong>你当前组件的 <code>data-v-xxx</code> 属性！</p>
<p>所以你的样式根本匹配不到它，自然就失效了。</p>
<hr/>
<h2 data-id="heading-1">二、那怎么办？</h2>
<p>为了解决这个问题，Vue 提供了样式穿透（style penetration）的语法，让你能穿透当前组件的作用域，去影响子组件内部的元素。</p>
<p>Vue 社区出现过三种写法：</p>

























<table><thead><tr><th>写法</th><th>适用版本</th><th>状态</th></tr></thead><tbody><tr><td><code>&gt;&gt;&gt;</code></td><td>Vue 2（某些预处理器支持）</td><td><strong>已废弃/不推荐</strong></td></tr><tr><td><code>::v-deep</code></td><td>Vue 2 + Vue 3（兼容写法）</td><td><strong>过渡方案</strong></td></tr><tr><td><code>:deep()</code></td><td>Vue 3.0+（推荐）</td><td>官方推荐</td></tr></tbody></table>
<p>下面我们一个个拆解。</p>
<hr/>
<h3 data-id="heading-2">1. <code>&gt;&gt;&gt;</code>：曾经的快捷方式，但问题很多</h3>
<p>早期 Vue2 时代，很多人用：</p>
<pre><code class="hljs language-css" lang="css">&lt;style scoped&gt;
<span class="hljs-selector-class">.parent</span> &gt;&gt;&gt; <span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">color</span>: blue;
}
&lt;/style&gt;
</code></pre>
<p>它的意思是：从 <code>.parent</code> 开始，穿透到所有后代中的 <code>.child</code>。</p>
<p>但问题在于：</p>
<ul>
<li><strong>Sass/Less 等预处理器不认 <code>&gt;&gt;&gt;</code></strong>，会报错。</li>
<li>不是标准 CSS 语法。</li>
<li>Vue3 已经明确不再支持。</li>
</ul>
<p>所以现在基本可以忘掉它了。</p>
<hr/>
<h3 data-id="heading-3">2. <code>::v-deep</code>：Vue2 到 Vue3 的桥梁</h3>
<p>为了兼容预处理器，Vue 引入了 <code>::v-deep</code>：</p>
<pre><code class="hljs language-scss" lang="scss">&lt;style scoped lang="scss"&gt;
<span class="hljs-selector-class">.parent</span> ::<span class="hljs-built_in">v-deep</span>(.child) {
  <span class="hljs-attribute">color</span>: blue;
}
&lt;/style&gt;
</code></pre>
<p>或者更常见的写法：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.parent</span> {
  ::<span class="hljs-built_in">v-deep</span>(.child) {
    <span class="hljs-attribute">color</span>: blue;
  }
}
</code></pre>
<p>它在 Vue2 和 Vue3 中都能用，算是一个安全的过渡方案。</p>
<p>但注意：<strong>在 Vue3 中，官方文档已经明确建议使用 <code>:deep()</code> 替代它</strong>。</p>
<hr/>
<h3 data-id="heading-4">3. <code>:deep()</code>：Vue3 的标准答案</h3>
<p>Vue3 引入了更简洁、更符合 CSS 规范的伪类函数写法：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
:deep(.el-button) {
  background: red !important;
}
&lt;/style&gt;
</code></pre>
<p>或者配合父级选择器：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
.my-wrapper :deep(.el-input__inner) {
  border-radius: 10px;
}
&lt;/style&gt;
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>语法清晰，像原生 CSS。</li>
<li>支持所有预处理器（Sass/Less/Stylus）。</li>
</ul>
<p><code>:deep()</code> 本质上是一个编译时转换，Vue 在构建时会把它展开成带 <code>data-v-xxx</code> 的复杂选择器，从而实现穿透。</p>
<hr/>
<h2 data-id="heading-5">三、怎么正确修改 Element Plus 的样式？</h2>
<p>举个真实例子：你想把 Element Plus 的输入框圆角改成 8px。</p>
<h3 data-id="heading-6">错误写法（不生效）：</h3>
<pre><code class="hljs language-css" lang="css">&lt;style scoped&gt;
<span class="hljs-selector-class">.el-input__inner</span> {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-7">正确写法：</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-form"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"value"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.my-form</span> :<span class="hljs-built_in">deep</span>(.el-input__inner) {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>为什么要加 <code>.my-form</code> 这个父级？<br/>
<strong>避免全局污染</strong>！如果直接写 <code>:deep(.el-input__inner)</code>，那么这个页面里<strong>所有</strong> Element 输入框都会被改掉。加上父级限定，就能精准控制范围。</p>
<blockquote>
<p>本文首发于公众号：程序员大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 秒懂SKILLS: 模块化的RULES + 轻量化脚本]]></title>    <link>https://juejin.cn/post/7597650322408489012</link>    <guid>https://juejin.cn/post/7597650322408489012</guid>    <pubDate>2026-01-22T00:27:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650322408489012" data-draft-id="7597664587459117091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 秒懂SKILLS: 模块化的RULES + 轻量化脚本"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-22T00:27:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 秒懂SKILLS: 模块化的RULES + 轻量化脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:27:42.000Z" title="Thu Jan 22 2026 00:27:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">为什么我们需要skills?</h2>
<p>众所周知，在AI编程的语境下，<code>RULES</code> 几乎是必不可少的，人们需要在 <code>RULES</code> 中提前给 <code>AI</code> 制定规则：</p>
<ol>
<li>它是一个什么样的角色</li>
<li>本工程采用了什么技术栈，它应该按什么编码规范来编码，如何组织工程代码。</li>
<li>当遇上一些非常见情况时，它应该如何处理，遵循什么原则</li>
<li>如何处理某些异常</li>
</ol>
<p>但是，问题来了：</p>
<ul>
<li>如果 RULES 太短，那它能覆盖的范围就非常有限。</li>
<li>如果 RULES 太长，每次会话AI都需要完全加载一遍它，浪费token倒是其次，重要的是token会降低AI的准确性提升幻觉。</li>
</ul>
<p>于是，模块化【懒加载】的诉求，便血淋淋摆在人们面前了。</p>
<p><code>SKILLS</code> 要解决的也正是这个痛点。</p>
<ul>
<li>它允许不同的规则被注册在不同的 SKILL.md 中，只在需要的时候进行加载。</li>
</ul>
<h2 data-id="heading-1">SKILLS 的结构</h2>
<p>要实现懒加载，有一个重要的问题需要解决：</p>
<blockquote>
<p>大模型需要知道合适加载哪个 Skill。</p>
</blockquote>
<p>因此，SKILLS的结构笼统性来说，分为两个部分：</p>
<ul>
<li>元数据: 告诉大模型我是谁，我有什么能力，什么时候应该调用我。</li>
<li>内容：指导大模型如何进行编程。</li>
</ul>
<p>这是一个典型 SKILL.md 文件的结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: API公约
<span class="hljs-section">description: 适用于当前代码库的 API 设计模式
---</span>

在编写 API 接口（端点）时：
<span class="hljs-bullet">-</span> 遵循 RESTful 命名规范
<span class="hljs-bullet">-</span> 返回统一的错误格式
<span class="hljs-bullet">-</span> 包含请求参数校验
</code></pre>
<p>在头部被 <code>---</code> 包裹起来的部分就是markdown元数据，在这里它们被用来描述技能本身的特性。</p>
<ul>
<li>name：技能的名称</li>
<li>description：技能的描述，有什么用，什么时候应该被加载</li>
</ul>
<p>而下面具体指导编程规范的部分，则是该技能的【内容】。</p>
<p>一开始的时候，【内容】并不会被加载到上下文中，只加载精简过的【元数据】，这会极大地节约token消耗，也能降低模型幻觉。</p>
<h2 data-id="heading-2">SKILLS 放在哪？</h2>
<p>结合 Claude Code、Trae、OpenCode 以及 Cursor 的最新文档，</p>
<h4 data-id="heading-3">Claude Code</h4>
<p>位置：项目根目录 /.claude/skills/</p>
<ul>
<li>结构：</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">ProjectRoot/
└── .claude/
    └── skills/
        ├── skill-a/  &lt;<span class="hljs-comment">-- 技能名称文件夹</span>
        │   ├── SKILL.md  &lt;<span class="hljs-comment">-- 核心定义 (SOP &amp; Prompts)</span>
        │   └── scripts/  &lt;<span class="hljs-comment">-- (可选) 对应的 Python/Node 脚本</span>
        └── skill-b/
            └── SKILL.md
</code></pre>
<ul>
<li>生效方式：Claude Code 启动时自动扫描该目录，根据 User Prompt 和 SKILL.md 中的 description 自动挂载。</li>
</ul>
<h4 data-id="heading-4">OpenCode</h4>
<p>位置：通常为 /.opencode/skills/</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-title class_">Project</span> <span class="hljs-symbol">config:</span> .opencode/skills/&lt;name&gt;<span class="hljs-regexp">/SKILL.md
Global config: ~/</span>.config/opencode/skills/&lt;name&gt;<span class="hljs-regexp">/SKILL.md
Project Claude-compatible: .claude/skills</span><span class="hljs-regexp">/&lt;name&gt;/</span><span class="hljs-variable constant_">SKILL</span>.md
<span class="hljs-title class_">Global</span> <span class="hljs-title class_">Claude</span>-<span class="hljs-symbol">compatible:</span> ~<span class="hljs-regexp">/.claude/skills</span><span class="hljs-regexp">/&lt;name&gt;/</span><span class="hljs-variable constant_">SKILL</span>.md
</code></pre>
<h4 data-id="heading-5">Cursor</h4>
<p>位置：通常为 /.cursor/skills/</p>
<pre><code class="hljs language-arduino" lang="arduino">.cursor/
└── skills/
    └── deploy-app/
        ├── SKILL.md
        ├── scripts/
        │   ├── deploy.sh
        │   └── validate.py
        ├── references/
        │   └── REFERENCE.md
        └── assets/
            └── config-<span class="hljs-keyword">template</span>.json
</code></pre>
<h4 data-id="heading-6">Trae</h4>
<p>位置：通常为 /.trae/skills/</p>
<pre><code class="hljs language-bash" lang="bash">.trae/skills/
├──skill-name/
    ├── SKILL.md  
    ├── scripts
    └── references

</code></pre>
<p>总的来说，各家有各家的习惯和地盘，希望后续能统一成标准吧。</p>
<h2 data-id="heading-7">有了SKILLS，可以不要MCP了吗？</h2>
<p>绝对不可以！</p>
<p>它们并不是互斥的两套技术。</p>
<p>恰恰相反，它们是 “黄金搭档”，是底层能力 (Capabilities) 与 上层应用 (Applications) 的关系。</p>
<p>如果把构建 Agent 比作雇佣一个员工，那么：</p>
<ul>
<li>
<p>MCP (Model Context Protocol) 是这个员工的 “手”和“感官”。</p>
<ul>
<li>
<p>它定义了员工能做什么（比如：能拿杯子、能查数据库、能运行 Python 代码）。</p>
</li>
<li>
<p>它解决了“怎么连接”的问题（标准化的接口协议）。</p>
</li>
</ul>
</li>
<li>
<p>Skills (技能/规则) 是这个员工的 “职业培训手册” (SOP)。</p>
<ul>
<li>
<p>它定义了员工该怎么做（比如：看到客人来了要倒水、查库前要先鉴权、代码报错了要重试）。</p>
</li>
<li>
<p>它解决了“怎么思考”和“怎么决策”的问题（业务逻辑与流程控制）。</p>
</li>
</ul>
</li>
</ul>
<p>总的来说，只要把 <code>SKILLS</code> 当作模块化的 <code>RULES</code>来理解会比较容易。</p>
<p>但，SKILLS 除了是模块化的 RULES 外，它还有一个重要的能力：</p>
<ul>
<li>它具备脚本执行能力。</li>
</ul>
<h2 data-id="heading-8">软硬一体的 SKILLS</h2>
<p>之前的回答为了强调“规则”的重要性，确实简化了 Skills 的定义。实际上，完整的 Skills 是“软硬一体”的。</p>
<p>在 Claude Code 的架构中，一个 Skill 确实可以包含它私有的、本地的脚本。</p>
<h3 data-id="heading-9">1. 重新定义：Skills 的完整公式</h3>
<p>纠正之前的定义，现在的公式应该是：</p>
<p>Skill = 🧠 业务规则 (SOP) + 🛠️ 专用脚本 (Local Scripts)</p>
<p>SOP (SKILL.md)：这是大脑。它告诉 AI 什么时候用、怎么用。</p>
<p>Scripts (/scripts/*.py)：这是随身工具包。它是为了配合这个 SOP 而存在的轻量级代码。</p>
<h3 data-id="heading-10">2. 为什么要允许 Skill 包含脚本？</h3>
<p>既然有了 MCP，为什么还需要 Skill 自带脚本？</p>
<p>这就像：虽然工厂里有重型机床（MCP），但工人腰带上还是得挂一把螺丝刀（Skill Script）。</p>
<p>主要有以下三个原因：</p>
<ul>
<li>
<p>A. 降低依赖 (Self-Contained)
如果你的 Skill 只是为了做一些简单的文本处理（比如“把 xxx 格式化一下”），为此启动一个 HTTP MCP Server 太重了。 把这个逻辑写成一个 20 行的 Python 脚本放在 Skill 文件夹里，随拿随用，这才是“技能包”的便携性。</p>
</li>
<li>
<p>B. 胶水逻辑 (Glue Logic)
有时候，MCP 提供的原子能力太碎了。</p>
<ul>
<li>
<p>MCP 工具 A：get_file_list</p>
</li>
<li>
<p>MCP 工具 B：analyze_file</p>
</li>
<li>
<p>Skill 脚本：你可以写一个脚本，循环调用 A，过滤结果，然后传给 B，最后输出统计报表。</p>
</li>
<li>
<p>优势：你把“循环与判断”的计算压力从 LLM（昂贵、慢）转移到了 CPU（便宜、快）。</p>
</li>
</ul>
</li>
<li>
<p>C. 本地文件操作
Claude Code 是在本地运行的。Skill 脚本可以直接通过 bash 访问你项目里的文件系统，这比远程 MCP Server 通过网络传输文件内容要高效得多。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js实现更真实的3D地球🌍动态昼夜交替]]></title>    <link>https://juejin.cn/post/7597699796200636426</link>    <guid>https://juejin.cn/post/7597699796200636426</guid>    <pubDate>2026-01-22T00:40:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597699796200636426" data-draft-id="7597623392457146419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js实现更真实的3D地球🌍动态昼夜交替"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-22T00:40:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谢小飞"/> <meta itemprop="url" content="https://juejin.cn/user/2717648473034823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js实现更真实的3D地球🌍动态昼夜交替
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648473034823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谢小飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:40:06.000Z" title="Thu Jan 22 2026 00:40:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><p>　　这一切始于一个偶然的发现。前几天笔者在应用商店闲逛时，被一款3D动态壁纸深深吸引——那颗在手机屏幕上缓缓旋转的地球，光影随着时间自然流转，从阳光灿烂的白昼到星光点点的黑夜，过渡得如此丝滑而真实。那一刻，我被这种将宇宙微观化的美感震撼了。</p>
<p>　　作为一名前端开发，笔者的第一反应不是“这个壁纸真好看”，而是“这个效果我能实现吗？”。这种奇特的好奇心驱使我开始了用代码复现这一视觉奇观的探索之旅。</p>
<p>　　有趣的是，最打动我的不是最终地球模型的逼真程度，而是那个微妙的光影过渡——那条被称为“晨昏线”的光暗分界线，它既清晰又模糊，既分割又连接着地球的白天与黑夜。如何在代码中捕捉这种自然界的诗意过渡？这个问题成为了整个项目最迷人的挑战。</p>
<p>　　现在我们一起踏上这段从视觉灵感转化为技术实现的旅程，我们将用Three.js绘制星辰与大海，用着色器计算光影效果，用数学公式模拟昼夜的交替；当你看到那颗由你亲手编码的地球在浏览器中开始第一次转动时，你会发现，前端不仅仅是职业，更是一种生活方式。</p>
<blockquote>
<p>本文的最终效果可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.xieyufei.com%2Fcase%2Fthree%2Freal%2Fearth" target="_blank" title="https://gallery.xieyufei.com/case/three/real/earth" ref="nofollow noopener noreferrer">访问这个链接查看</a>查看，随手截图就是一张精美的壁纸。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb8567c469f14489982d7a1846c74dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=vN77eTGRx072PD2Syia5fKCyPLQ%3D" alt="最终效果" loading="lazy"/></p>
<h2 data-id="heading-0">环境准备</h2>
<p>　　要实现这样的效果，我们先准备需要的一些素材贴图：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 背景星空球体半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BACKGROUND_STARS_RADIUS</span> = <span class="hljs-number">200</span>;

<span class="hljs-comment">// 地球球体的半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EARTH_RADIUS</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 太阳半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUN_RADIUS</span> = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 月球半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MOON_RADIUS</span> = <span class="hljs-number">0.5</span>

<span class="hljs-comment">// 月球轨道半径</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MOON_TRACK_RADIUS</span> = <span class="hljs-variable constant_">EARTH_RADIUS</span> * <span class="hljs-number">2</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssetsLoader</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">load</span>([
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"sun"</span>, <span class="hljs-comment">// 太阳贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_sun.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"moon"</span>, <span class="hljs-comment">// 月球贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_moon.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"stars"</span>, <span class="hljs-comment">// 星空背景贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_stars_milky_way.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"dayTexture"</span>, <span class="hljs-comment">// 白天贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_earth_daymap.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"nightTexture"</span>, <span class="hljs-comment">// 夜晚贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_earth_nightmap.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"normalMap"</span>, <span class="hljs-comment">// 法线贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/8k_earth_normal_map.jpg"</span>,
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">AssetsType</span>.<span class="hljs-property">Texture</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"clouds"</span>, <span class="hljs-comment">// 云层贴图</span>
        <span class="hljs-attr">path</span>: <span class="hljs-string">"/images/earth/earth_clouds_2048.png"</span>,
      },
    ]);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"onLoad"</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initMesh</span>();
    });
  }
}
</code></pre>
<blockquote>
<p>本文所有素材均下载于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.solarsystemscope.com%2Ftextures%2F" target="_blank" title="https://www.solarsystemscope.com/textures/" ref="nofollow noopener noreferrer">Solar Textures</a></p>
</blockquote>
<p>　　素材准备好后，我们就可以来初始化场景下的物体；我们先创造我们美丽的蓝色星球，让它位于中心原点的位置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initEarth</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (dayTexture &amp;&amp; nightTexture) {
      <span class="hljs-keyword">const</span> earthMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShaderMaterial</span>({
        <span class="hljs-attr">uniforms</span>: {
          <span class="hljs-attr">dayTexture</span>: { <span class="hljs-attr">value</span>: dayTexture },
          <span class="hljs-attr">nightTexture</span>: { <span class="hljs-attr">value</span>: nightTexture },
          <span class="hljs-attr">sunPosition</span>: { <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span> },
        },
        <span class="hljs-attr">vertexShader</span>: earthVertexShader,
        <span class="hljs-attr">fragmentShader</span>: earthFragmentShader,
      });

      <span class="hljs-keyword">const</span> earthGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">EARTH_RADIUS</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>);

      <span class="hljs-keyword">const</span> earthMesh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(earthGeometry, earthMaterial);
      earthMesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">basic</span>.<span class="hljs-title function_">addScene</span>(earthMesh);
    }
  }
}
</code></pre>
<p>　　然后给空旷的宇宙安装一颗恒星，放在右边偏上的位置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-attr">sunPosition</span>: <span class="hljs-title class_">Vector3</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">20</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);
  <span class="hljs-title function_">initSun</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> sunTexture = <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">getAssets</span>(<span class="hljs-string">"sun"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Texture</span> | <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (sunTexture) {
      <span class="hljs-keyword">const</span> sunGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">SUN_RADIUS</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>);
      <span class="hljs-keyword">const</span> sunMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
        <span class="hljs-attr">map</span>: sunTexture,
      });
      <span class="hljs-keyword">const</span> sun = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(sunGeometry, sunMaterial);
      sun.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(sun);
    }
  }
}
</code></pre>
<p>　　有意思的是，这里的太阳虽然看起来像个发光的球，但实际上它只是个“装饰品”；我们真正用到的其实是它的位置信息<code>sunPosition</code>，用于在后面模拟昼夜交替时，将太阳的位置信息传入到着色器代码中。</p>
<p>　　在真实宇宙中，是地球绕着太阳转。但在我们的虚拟场景中，为了保持地球始终在画面中央（坐标原点），笔者耍了个小聪明——让太阳“绕着”地球转，同时给太阳一个自转。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">rotateVector3ByRadian</span>(<span class="hljs-params">vec3: Vector3, axis: Vector3, radian: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 创建旋转矩阵</span>
    <span class="hljs-keyword">const</span> matrix = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Matrix4</span>()
    <span class="hljs-comment">// 设置绕轴旋转的矩阵</span>
    matrix.<span class="hljs-title function_">makeRotationAxis</span>(axis.<span class="hljs-title function_">normalize</span>(), radian)
    <span class="hljs-comment">// 应用旋转矩阵到向量</span>
    vec3.<span class="hljs-title function_">applyMatrix4</span>(matrix)
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params">clock: Clock</span>) {
    <span class="hljs-title function_">rotateVector3ByRadian</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span>,
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-number">0.0004</span>,
    )
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sunMesh</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunMesh</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(sunPos)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">sunMesh</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.002</span>
    }
  }
}
</code></pre>
<p>　　接着，给我们的宇宙增加一份浩瀚感，这里的星空背景通过球体加上贴图来进行渲染：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initStarBackground</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> starsTexture = <span class="hljs-variable language_">this</span>.<span class="hljs-property">assetsLoader</span>.<span class="hljs-title function_">getAssets</span>(<span class="hljs-string">"stars"</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Texture</span> | <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (starsTexture) {
      <span class="hljs-keyword">const</span> sphereGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(
        <span class="hljs-variable constant_">BACKGROUND_STARS_RADIUS</span>,
        <span class="hljs-number">64</span>,
        <span class="hljs-number">64</span>
      );
      sphereGeometry.<span class="hljs-title function_">scale</span>(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> sphereMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
        <span class="hljs-attr">map</span>: starsTexture,
        <span class="hljs-attr">side</span>: <span class="hljs-title class_">DoubleSide</span>,
      });
      <span class="hljs-keyword">const</span> sphere = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(sphereGeometry, sphereMaterial);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(sphere);
    }
  }
}
</code></pre>
<p>　　地球怎么能独自在宇宙中流浪呢？怎么能少得了它忠实的小跟班——月球呢？但只是放个月球太普通了，我决定给它加个专属的“跑道”track：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-attr">moonPosition</span>: <span class="hljs-title class_">Vector3</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-variable constant_">MOON_TRACK_RADIUS</span>, <span class="hljs-number">0</span>)
  <span class="hljs-title function_">initMoon</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> group = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Group</span>()

    <span class="hljs-keyword">const</span> trackGeo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TorusGeometry</span>(<span class="hljs-variable constant_">MOON_TRACK_RADIUS</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
    <span class="hljs-keyword">const</span> trackMt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
      <span class="hljs-attr">color</span>: guiOption.<span class="hljs-property">moon</span>.<span class="hljs-property">trackColor</span>,
      <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span>,
    })
    <span class="hljs-keyword">const</span> track = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(trackGeo, trackMt)
    group.<span class="hljs-title function_">add</span>(track)

    <span class="hljs-keyword">const</span> moonGeo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-variable constant_">MOON_RADIUS</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>)
    <span class="hljs-keyword">const</span> moonMt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshBasicMaterial</span>({
      <span class="hljs-attr">map</span>: moonTexture,
    })
    <span class="hljs-keyword">const</span> moon = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mesh</span>(moonGeo, moonMt)
    moon.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">moonPosition</span>)
    group.<span class="hljs-title function_">add</span>(moon)
    
    group.<span class="hljs-title function_">rotateX</span>(<span class="hljs-title class_">MathUtils</span>.<span class="hljs-title function_">degToRad</span>(<span class="hljs-number">100</span>))
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(group)    
  }
}
</code></pre>
<p>　　那个半透明的轨道环其实是个视觉引导——它告诉用户“嘿，月球是沿着这条路径运动的”。虽然真实月球没有可见轨道，但这个设计增加了场景的科技感和可读性。</p>
<p>　　当我看到月球带着它的光环开始绕着地球旋转时，那感觉就像完成了一个精密的宇宙钟表——每个部件都有它的位置，每个运动都有它的规律。这个小跟班让我们的地球不再孤单，整个太阳系开始有了“系统”的感觉。</p>
<h3 data-id="heading-1">实现昼夜分明</h3>
<p>　　前面我们搭建好了整个太阳系舞台，但此刻的地球还只是一个静止的球体，没有光影变化，没有昼夜交替。现在，是时候为这颗蓝色星球注入灵魂了。还记得我们初始化地球时预留的vertexShader和fragmentShader吗？那两个看似简单的GLSL代码文件，才是实现昼夜交替魔法的核心所在。</p>
<p>　　如果说地球模型是个巨大的工厂，那么顶点着色器就是为每个工人（像素点）准备工牌的生产线。下面着色器代码其实在做两件重要的事情：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 纹理坐标</span>
varying vec2 vUv;
<span class="hljs-comment">// 变换后的法线向量</span>
varying vec3 vNormal;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    vUv=uv;
    vNormal=normalize(normalMatrix*normal);
    gl_Position= projectionMatrix * modelViewMatrix * vec4(position, <span class="hljs-number">1.0</span>);
}
</code></pre>
<p>　　<code>vUv</code>用来记录每个顶点的纹理坐标，<code>vNormal</code>计算并传递法线向量，每个顶点的法线就像一根小指针，直直地指向该点的“正上方”，normalize()函数让法线向量保持长度为1（归一化）。varying表示把顶点着色器的计算结果传递给下面的片元着色器。</p>
<p>　　所以别看上面这段代码短，它可是整个昼夜效果的地基。它为地球表面每个点都准备好了：“我是谁（uv坐标）”、“我面朝哪里（法线）”，就等着片元着色器来判断：“你现在应该是白天还是黑夜”；下面是我们最重要的片元着色器代码了：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> GL_ES</span>
precision mediump <span class="hljs-type">float</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

uniform sampler2D dayTexture;
uniform sampler2D nightTexture;
uniform vec3 sunPosition;

varying vec2 vUv;
varying vec3 vNormal;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    vec3 lightDir=normalize(sunPosition);
    
    <span class="hljs-type">float</span> dotProduct=dot(normalize(vNormal),lightDir);
    
    <span class="hljs-keyword">if</span>(dotProduct&gt;<span class="hljs-number">0.</span>){
        gl_FragColor=texture2D(dayTexture,vUv);
    }<span class="hljs-keyword">else</span>{
        gl_FragColor=texture2D(nightTexture,vUv);
    }
}
</code></pre>
<p>　　这段代码虽然只有短短的十几行，却决定了地球表面每一处是光明还是黑暗。GLSL语法比较难懂，我们下面就来详细介绍一下。</p>
<p>　　首先我们将前面顶点着色器中处理好的单位法线向量vNormal接收，然后将传入的太阳的位置接收，通过<code>normalize</code>函数进行归一化操作，得到了太阳的方向；最轴将上面计算的法线向量和太阳的方向进行点积运算。</p>
<blockquote>
<p>将太阳位置归一化后的方向向量，表示从原点指向太阳位置的单位向量，而不是从太阳位置出发指向原点，这一点需要注意。</p>
</blockquote>
<p>　　这里详细说一下点积运算的几何意义，在三维空间中，两个向量的点积公式是：</p>
<pre><code class="hljs language-css" lang="css">dot(<span class="hljs-selector-tag">A</span>, <span class="hljs-selector-tag">B</span>) = |<span class="hljs-selector-tag">A</span>| × |<span class="hljs-selector-tag">B</span>| × cos(θ)
</code></pre>
<p>　　其中θ是A和B之间的夹角；而我们上面已经对两个向量都进行了归一化操作，因此公式简化为：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dot</span>(A, B) = <span class="hljs-built_in">cos</span>(θ)
</code></pre>
<p>　　因此这里的<code>角度θ</code>其实代表了法线与太阳光线方向的夹角，我们通过一张图来理解，球体表面的蓝色箭头，表示法线；而原点黄色的箭头，表示太阳的方向：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b554e6d07b3a43e0aefe7db5dc6ea7d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=kteIZQZJfaQszxsHeEczWmBNi58%3D" alt="太阳方向夹角" loading="lazy"/></p>
<p>　　因此在上面片元着色器代码中，计算得到的<code>dotProduct</code>变量，其实也是<code>cos(θ)</code>的值；我们通过对它的值进行判断，如果<code>dotProduct</code>大于0，则表示法线与太阳方向夹角小于90度，则表示当前点在白天，则使用白天贴图进行渲染；否则使用夜晚贴图进行渲染；运行后，我们就能看到地球的白天黑夜有明显的界线分隔了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/746b267f5f534478a58970a0a1b3e7f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=Lr9uaKmfpyn%2FF12QxPs%2BhzL12yk%3D" alt="地球白天黑夜效果" loading="lazy"/></p>
<p>　　最后在太阳转动的同时，不要忘记更新地球材质的uniforms中的sunPosition属性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params">clock: Clock</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">earthMaterial</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">earthMaterial</span>.<span class="hljs-property">uniforms</span>.<span class="hljs-property">sunPosition</span>.<span class="hljs-property">value</span>.<span class="hljs-title function_">copy</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sunPosition</span>)
    }
  }
}
</code></pre>
<h2 data-id="heading-2">星空顶</h2>
<p>　　如果你最近去过高端楼盘展厅或者坐过某些豪华车型，大概率见过那个让人惊艳的设计——星空顶。无数光点在头顶缓缓闪烁，像是把整个银河系微缩在了方寸之间。这种将宇宙浪漫融入空间的设计，早已成为“高端感”的代名词。</p>
<p>　　我们项目怎么能少了这样迷人的星空呢？不行，我们的项目也要向高端、豪华看齐。虽然之前我们用一张星空贴图作为背景，但是总感觉不够真实，缺少了星空那种忽明忽暗的光亮效果；我们在太阳到星空背景球体之间，通过Points来添加众多的星星，我们首先初始化星星的一些参数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 星星数量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STARS_AMOUNT</span> = <span class="hljs-number">1000</span>;
<span class="hljs-comment">// 星星最小距离</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STARS_MIN_DISTANCE</span> = <span class="hljs-number">100</span>;
<span class="hljs-comment">// 星星最大距离</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STARS_MAX_DISTANCE</span> = <span class="hljs-number">200</span>;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initStars</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> starGeometry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferGeometry</span>();
    <span class="hljs-comment">// 每个点的xyz坐标</span>
    <span class="hljs-keyword">const</span> positions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span> * <span class="hljs-number">3</span>);
    <span class="hljs-comment">// 每个点rgb颜色</span>
    <span class="hljs-keyword">const</span> colors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span> * <span class="hljs-number">3</span>);
    <span class="hljs-comment">// 每个点的初始大小</span>
    <span class="hljs-keyword">const</span> sizes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span>);
    <span class="hljs-comment">// 每个点的闪烁相位</span>
    <span class="hljs-keyword">const</span> phases = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span>);
    <span class="hljs-comment">// 每个点的闪烁频率</span>
    <span class="hljs-keyword">const</span> frequencies = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(<span class="hljs-variable constant_">STARS_AMOUNT</span>);
  }
}
</code></pre>
<p>　　由于我们想要生成从太阳到星空背景球体之间圆环内的随机点，因此我们可以通过极坐标的方式来计算，通过极坐标转换到三维空间内的坐标：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Earth</span> {
  <span class="hljs-title function_">initStars</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable constant_">STARS_AMOUNT</span>; i++) {
      <span class="hljs-keyword">const</span> i3 = i * <span class="hljs-number">3</span>

      <span class="hljs-comment">// 在球体空间内随机生成位置</span>
      <span class="hljs-keyword">const</span> distance = <span class="hljs-title function_">getRandomInt</span>(<span class="hljs-variable constant_">STARS_MIN_DISTANCE</span>, <span class="hljs-variable constant_">STARS_MAX_DISTANCE</span>)
      <span class="hljs-keyword">const</span> theta = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span> <span class="hljs-comment">// 方位角</span>
      <span class="hljs-keyword">const</span> phi = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">acos</span>(<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">1</span>) <span class="hljs-comment">// 极角</span>

      <span class="hljs-comment">// 球坐标转直角坐标</span>
      positions[i3] = distance * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(theta)
      positions[i3 + <span class="hljs-number">1</span>] = distance * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(phi) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(theta)
      positions[i3 + <span class="hljs-number">2</span>] = distance * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(phi)
    }
  }
}
</code></pre>
<p>　　坐标位置搞定了，我们继续给每个点生成随即的颜色、大小、闪烁相位、闪烁频率属性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 随机颜色（偏向白色和蓝色）</span>
<span class="hljs-keyword">const</span> colorChoice = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()
<span class="hljs-keyword">if</span> (colorChoice &lt; <span class="hljs-number">0.7</span>) {
  <span class="hljs-comment">// 白色/淡黄色星星</span>
  colors[i3] = <span class="hljs-number">1.0</span> <span class="hljs-comment">// R</span>
  colors[i3 + <span class="hljs-number">1</span>] = <span class="hljs-number">0.9</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.1</span> <span class="hljs-comment">// G</span>
  colors[i3 + <span class="hljs-number">2</span>] = <span class="hljs-number">0.8</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.2</span> <span class="hljs-comment">// B</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (colorChoice &lt; <span class="hljs-number">0.9</span>) {
  <span class="hljs-comment">// 蓝色星星</span>
  colors[i3] = <span class="hljs-number">0.4</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span> <span class="hljs-comment">// R</span>
  colors[i3 + <span class="hljs-number">1</span>] = <span class="hljs-number">0.6</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span> <span class="hljs-comment">// G</span>
  colors[i3 + <span class="hljs-number">2</span>] = <span class="hljs-number">1.0</span> <span class="hljs-comment">// B</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 红色/橙色星星</span>
  colors[i3] = <span class="hljs-number">1.0</span> <span class="hljs-comment">// R</span>
  colors[i3 + <span class="hljs-number">1</span>] = <span class="hljs-number">0.5</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span> <span class="hljs-comment">// G</span>
  colors[i3 + <span class="hljs-number">2</span>] = <span class="hljs-number">0.3</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.2</span> <span class="hljs-comment">// B</span>
}

<span class="hljs-comment">// 大小</span>
sizes[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2</span> + <span class="hljs-number">0.5</span>
<span class="hljs-comment">// 闪烁频率</span>
frequencies[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.5</span>
<span class="hljs-comment">// 闪烁相位</span>
phases[i] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>
</code></pre>
<p>　　最后，我们通过BufferGeometry将这些数据传入Points对象中：</p>
<pre><code class="hljs language-typescript" lang="typescript">starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"position"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(positions, <span class="hljs-number">3</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"color"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(colors, <span class="hljs-number">3</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"size"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(sizes, <span class="hljs-number">1</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"phase"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(phases, <span class="hljs-number">1</span>))
starGeometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"frequency"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferAttribute</span>(frequencies, <span class="hljs-number">1</span>))
</code></pre>
<p>　　然后创建Points对象，同时在uniforms中添加一个time属性，用于控制星星闪烁：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> starMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">time</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0.0</span> },
  },
  <span class="hljs-attr">vertexShader</span>: starsVertexShader,
  <span class="hljs-attr">fragmentShader</span>: starsFragmentShader,
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">blending</span>: <span class="hljs-title class_">AdditiveBlending</span>,
})
<span class="hljs-keyword">const</span> stars = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Points</span>(starGeometry, starMaterial)
</code></pre>
<p>　　在我们的顶点着色器代码中，接收上面的顶点数据：</p>
<pre><code class="hljs language-c" lang="c">attribute <span class="hljs-type">float</span> size;
attribute vec3 color;
attribute <span class="hljs-type">float</span> phase;
attribute <span class="hljs-type">float</span> frequency;

varying vec3 vColor;

uniform <span class="hljs-type">float</span> time;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    vColor = color;
    
    <span class="hljs-comment">// 闪烁效果计算</span>
    <span class="hljs-type">float</span> blink = <span class="hljs-built_in">sin</span>(time * frequency + phase) * <span class="hljs-number">0.5</span> + <span class="hljs-number">0.8</span>;
    
    <span class="hljs-comment">// 添加一些随机噪声使闪烁更自然</span>
    <span class="hljs-type">float</span> noise = <span class="hljs-built_in">sin</span>(dot(position, vec3(<span class="hljs-number">12.9898</span>, <span class="hljs-number">78.233</span>, <span class="hljs-number">45.5432</span>)) * <span class="hljs-number">43758.5453</span>) * <span class="hljs-number">0.1</span>;
    
    <span class="hljs-comment">// 最终大小</span>
    <span class="hljs-type">float</span> finalSize = size * (blink + noise);
    
    vec4 mvPosition = modelViewMatrix * vec4(position, <span class="hljs-number">1.0</span>);
    gl_PointSize = finalSize * (<span class="hljs-number">300.0</span> / -mvPosition.z);
    gl_Position = projectionMatrix * mvPosition;
}
</code></pre>
<p>　　<code>vColor</code>用来将前面生成的点的颜色传递给片元着色器，让星星有独立的颜色；blink是实现星星闪烁的关键公式，time × frequency表示随时间变化的相位，phase控制每个粒子的初始相位偏移，使得闪烁不会同步进行；sin函数产生平滑的正弦波振荡，取值范围是[-1, 1]，最终blink的范围是[0.3, 1.3]，再乘以size初始化大小，得到了星星在不同时刻的最终大小。</p>
<p>　　最后片元着色器代码如下：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> GL_ES</span>
precision mediump <span class="hljs-type">float</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

varying vec3 vColor;

<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 圆形点</span>
    <span class="hljs-type">float</span> distanceToCenter = length(gl_PointCoord - vec2(<span class="hljs-number">0.5</span>));
    <span class="hljs-keyword">if</span> (distanceToCenter &gt; <span class="hljs-number">0.5</span>) {
        discard;
    }
    
    <span class="hljs-comment">// 添加一些发光效果</span>
    <span class="hljs-type">float</span> alpha = <span class="hljs-number">1.0</span> - smoothstep(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.5</span>, distanceToCenter);
    
    gl_FragColor = vec4(vColor, alpha * <span class="hljs-number">0.9</span>);
}
</code></pre>
<h2 data-id="heading-3">美丽的晨昏线</h2>
<p>　　如果仔细观察真实的地球照片，你会发现一个迷人的细节：白天和黑夜之间，并没有一条生硬的分界线。取而代之的，是一片温柔过渡的“灰色地带”——这就是我们常说的<code>晨昏线</code>，也是日出日落时分最富诗意的区域。</p>
<p>　　回头看我们之前实现的昼夜分割的效果，虽然功能完整，但是少了些自然界的柔美；现实世界的光影变化，从来不是非黑即白的开关，而是渐变的艺术；下面我们就来创造出一个平滑过渡的晨昏区域，让白昼缓缓融入黑夜。</p>
<p>　　上面我们详细介绍了白天黑夜如何通过太阳光和法线进行判断，而其核心原理就是下面的计算公式：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">float</span> dotProduct=dot(normalize(vNormal),lightDir);
</code></pre>
<p>　　dotProduct的取值范围是<code>[-1, 1]</code>，当在0～1之间时，代表表面正对太阳，是白天；-1～0之间，表示背对太阳，是黑夜；我们想要让太阳在中间地带有一个过渡的范围，我们先给ShaderMaterial传入一个参数<code>transitionWidth</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> earthMaterial = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">dayTexture</span>: { <span class="hljs-attr">value</span>: dayTexture },
    <span class="hljs-attr">nightTexture</span>: { <span class="hljs-attr">value</span>: nightTexture },
    <span class="hljs-comment">// 新增过渡范围参数</span>
    <span class="hljs-attr">transitionWidth</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0.2</span> },
  },
  <span class="hljs-attr">vertexShader</span>: earthVertexShader,
  <span class="hljs-attr">fragmentShader</span>: earthFragmentShader,
})
</code></pre>
<p>　　然后，在片元着色器中添加过渡参数：</p>
<pre><code class="hljs language-c" lang="c">uniform <span class="hljs-type">float</span> transitionWidth; 
<span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
  <span class="hljs-type">float</span> transitionCenter = <span class="hljs-number">0.0</span>; <span class="hljs-comment">// 晨昏线</span>
  <span class="hljs-type">float</span> transitionStart = transitionCenter - transitionWidth * <span class="hljs-number">0.5</span>;
  <span class="hljs-type">float</span> transitionEnd = transitionCenter + transitionWidth * <span class="hljs-number">0.5</span>;
}
</code></pre>
<p>　　当传入transitionWidth是0.2时，计算得到下面的范围：</p>
<ul>
<li>transitionStart = -0.1</li>
<li>transitionEnd = 0.1</li>
</ul>
<p>　　这就意味着在dotProduct点积值[-0.1, 0.1]范围内是过渡区域；然后使用<code>smoothstep</code>创建一个平滑插值：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
  <span class="hljs-comment">// 使用smoothstep创建平滑过渡</span>
  <span class="hljs-type">float</span> mixFactor = smoothstep(transitionStart, transitionEnd, dotProduct);
}
</code></pre>
<p>　　smoothstep函数的行为如下：</p>
<ul>
<li>当 dotProduct &lt;= transitionStart 时：mixFactor = 0.0</li>
<li>当 dotProduct &gt;= transitionEnd 时：mixFactor = 1.0</li>
<li>当 transitionStart &lt; dotProduct &lt; transitionEnd 时：mixFactor 平滑过渡</li>
</ul>
<p>　　因此，smoothstep函数实际上将dotProduct区间值[-1, 1]映射到mixFactor的[0, 1]范围内，并创建一个平滑过渡；其中[-1 , -0.1]，映射为0,表示黑夜，[0.1 , 1]，映射为1，表示白天，中间的(-0.1 , 0.1)映射到(0, 1)表示过渡的区域；我们通过一个表格来详细表示：</p>













































<table><thead><tr><th>dotProduct值</th><th>mixFactor</th><th>纹理</th></tr></thead><tbody><tr><td>-1</td><td>0</td><td>黑夜</td></tr><tr><td>-0.5</td><td>0</td><td>黑夜</td></tr><tr><td>-0.1</td><td>0</td><td>逐渐从黑夜过渡到白天</td></tr><tr><td>0</td><td>0.5</td><td>中间过渡区域</td></tr><tr><td>0.1</td><td>1</td><td>逐渐从白天过渡到黑夜</td></tr><tr><td>0.5</td><td>1</td><td>白天</td></tr><tr><td>1</td><td>1</td><td>白天</td></tr></tbody></table>
<p>　　最后使用<code>mix函数</code>将白天和黑夜的纹理进行混合：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
  <span class="hljs-comment">// 采样纹理</span>
  vec4 dayColor = texture2D(dayTexture, vUv);
  vec4 nightColor = texture2D(nightTexture, vUv);
  
  <span class="hljs-comment">// 混合白天和黑夜纹理</span>
  gl_FragColor = mix(nightColor, dayColor, mixFactor);
}
</code></pre>
<p>　　这样，我们就实现了白天黑夜的过渡效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eedd7103979d44af9e906aab4f8ab3fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647206&amp;x-signature=h5PZ%2B8ykp8vMSVH2JpnZBF4iPpM%3D" alt="白天黑夜过渡效果" loading="lazy"/></p>
<h2 data-id="heading-4">尾声：在代码中雕刻时光的意义</h2>
<p>　　当我们看着这个由自己亲手绘制的“微缩版太阳系”在浏览器中静静旋转时，一种奇特的感受油然而生——在这个微观的数字宇宙里，我既是造物主，也是最渺小的观察者。</p>
<p>　　我们用了不到1000行的代码，就模拟了一个直径12742公里的星球上每时每刻的光影变迁。真实的地球需要24小时完成一次昼夜交替，我们的数字地球只需几分钟。这种尺度上的巨大反差让我突然明白：人类的所有创造，本质上都是对无限宇宙的有限翻译。</p>
<p>　　那颗在轨道上“绕着”地球转的太阳，其实只是在绕着原点旋转的几行向量计算。但就是这简单的数学，却再现了我们祖先仰望天空时看到的景象——日出东方，日落西沉。从地心说到日心说，再到今天的代码模拟，人类对宇宙的理解在变，但那份想要理解世界的好奇心从未改变。</p>
<blockquote>
<p>“给岁月以文明，而不是给文明以岁月”。——《三体》</p>
</blockquote>
<p>　　我们不是在追求让这个数字地球永恒运行，那颗正在你屏幕上旋转的蓝色星球，可能在下一秒就会浏览器缓存清理；那些闪烁的星星，可能随着标签页关闭而永远熄灭。</p>
<p>　　而是在有限的运行时间里，赋予它最丰富的意义：让晨昏线温柔过渡，让星空会呼吸，让光影如诗歌般流动。我们关心的不是代码能运行多久，而是它在运行的每一帧里，是否足够美好，是否传递了我们对真实世界的观察与敬意。</p>
<p>　　毕竟，在浩瀚的宇宙面前，所有文明都只是瞬间的火花。而最美的火花，不是燃烧得最久的那个，而是燃烧时最亮、最温暖的那个。</p>
<blockquote>
<p>本文的最终效果可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.xieyufei.com%2Fcase%2Fthree%2Freal%2Fearth" target="_blank" title="https://gallery.xieyufei.com/case/three/real/earth" ref="nofollow noopener noreferrer">这个链接查看</a>查看。</p>
</blockquote>
<p>如果觉得写得还不错，请关注我的<a href="//juejin.im/user/580038cebf22ec0064bd0b2d" target="_blank" title="//juejin.im/user/580038cebf22ec0064bd0b2d">掘金主页</a>。更多文章请访问<a href="https://link.juejin.cn?target=http%3A%2F%2Fxieyufei.com" target="_blank" title="http://xieyufei.com" ref="nofollow noopener noreferrer">谢小飞的博客</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第3章、基础语法——变量、常量与数据类型]]></title>    <link>https://juejin.cn/post/7597635202325364788</link>    <guid>https://juejin.cn/post/7597635202325364788</guid>    <pubDate>2026-01-22T00:40:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202325364788" data-draft-id="7597650624637632512" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第3章、基础语法——变量、常量与数据类型"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-22T00:40:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第3章、基础语法——变量、常量与数据类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:40:15.000Z" title="Thu Jan 22 2026 00:40:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 在上一章我们完成了第一个Go程序的编写与运行，初步了解了Go的程序结构。今天我们深入Go的基础语法核心——<strong>变量、常量与数据类型</strong>。这三块是任何编程语言的基石，也是后续写复杂逻辑的前提，建议大家边看边敲代码，把基础打扎实。</p>
<p>Go在变量、常量的设计上很有特色，比如支持多种声明方式、内置iota枚举机制，数据类型体系也简洁严谨，没有冗余的类型。接下来我们逐节拆解，每个知识点都配上可直接运行的代码示例，帮你快速理解。</p>
<h2 data-id="heading-0">1. 变量的声明方式：var与短声明</h2>
<p>变量是用来存储数据的容器，Go提供了多种声明变量的方式，核心分为<code>var</code>声明和短声明两种，适用于不同场景。</p>
<h3 data-id="heading-1">1.1 var声明（通用方式）</h3>
<p><code>var</code>是Go中最基础的变量声明关键字，支持多种写法，灵活性高，可在函数内或函数外使用。</p>
<p><strong>基本语法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 1. 完整声明：var 变量名 类型 = 值</span>
<span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>

<span class="hljs-comment">// 2. 类型推断：省略类型，Go自动推断</span>
<span class="hljs-keyword">var</span> age = <span class="hljs-number">25</span>  <span class="hljs-comment">// 自动推断为int类型</span>

<span class="hljs-comment">// 3. 声明多个变量（分组形式，推荐）</span>
<span class="hljs-keyword">var</span> (
    address <span class="hljs-type">string</span> = <span class="hljs-string">"Beijing"</span>
    score   <span class="hljs-type">float64</span> = <span class="hljs-number">98.5</span>
    isPass  <span class="hljs-type">bool</span>    = <span class="hljs-literal">true</span>
)

<span class="hljs-comment">// 4. 只声明不赋值（会赋予零值，后续讲）</span>
<span class="hljs-keyword">var</span> height <span class="hljs-type">float32</span>

</code></pre>
<p><strong>使用场景</strong>：适合全局变量声明（函数外只能用var）、需要明确指定类型的变量，或批量声明多个变量的场景。</p>
<p><strong>运行示例</strong>：将上述代码放入main函数中运行，查看变量值：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>
    <span class="hljs-keyword">var</span> age = <span class="hljs-number">25</span>
    <span class="hljs-keyword">var</span> (
        address <span class="hljs-type">string</span> = <span class="hljs-string">"Beijing"</span>
        score   <span class="hljs-type">float64</span> = <span class="hljs-number">98.5</span>
        isPass  <span class="hljs-type">bool</span>    = <span class="hljs-literal">true</span>
    )
    <span class="hljs-keyword">var</span> height <span class="hljs-type">float32</span>

    fmt.Println(name, age, address, score, isPass, height)
    <span class="hljs-comment">// 输出：Gopher 25 Beijing 98.5 true 0</span>
}

</code></pre>
<h3 data-id="heading-2">1.2 短声明（:=）（函数内专用）</h3>
<p>短声明使用<code>:=</code>符号，是Go中最简洁的变量声明方式，但有严格的使用限制。</p>
<p><strong>基本语法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 变量名 := 值（自动推断类型）</span>
username := <span class="hljs-string">"Alice"</span>
age := <span class="hljs-number">30</span>
isStudent := <span class="hljs-literal">false</span>

<span class="hljs-comment">// 同时声明多个变量</span>
a, b := <span class="hljs-number">10</span>, <span class="hljs-number">20</span>  <span class="hljs-comment">// a=10（int），b=20（int）</span>

</code></pre>
<p><strong>核心限制</strong>：</p>
<ul>
<li>
<p>只能在函数内使用（函数外不允许）；</p>
</li>
<li>
<p>必须至少声明一个新变量（不能用来重复声明已存在的变量，除非是多变量声明中包含新变量）；</p>
</li>
<li>
<p>不能指定类型（只能靠Go自动推断）。</p>
</li>
</ul>
<p><strong>错误示例与修正</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 错误1：函数外使用短声明</span>
<span class="hljs-comment">// username := "Bob"  // 编译报错：syntax error: non-declaration statement outside function body</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Alice"</span>
    <span class="hljs-comment">// 错误2：重复声明单一变量</span>
    <span class="hljs-comment">// name := "Bob"  // 编译报错：no new variables on left side of :=</span>

    <span class="hljs-comment">// 正确：多变量声明中包含新变量</span>
    name, age := <span class="hljs-string">"Bob"</span>, <span class="hljs-number">28</span>  <span class="hljs-comment">// name重复，但age是新变量，允许</span>
    fmt.Println(name, age)  <span class="hljs-comment">// 输出：Bob 28</span>
}

</code></pre>
<p><strong>使用场景</strong>：函数内局部变量的快速声明，代码简洁高效，是Go开发中最常用的局部变量声明方式。</p>
<h2 data-id="heading-3">2. 常量定义与iota枚举机制</h2>
<p>常量是值不可修改的“固定变量”，用于存储程序运行过程中不会变化的数据（比如π的值、配置项中的固定参数）。Go中用<code>const</code>定义常量，还支持<code>iota</code>关键字实现简洁的枚举。</p>
<h3 data-id="heading-4">2.1 基本常量定义</h3>
<p><strong>基本语法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 1. 完整定义：const 常量名 类型 = 值</span>
<span class="hljs-keyword">const</span> Pi <span class="hljs-type">float64</span> = <span class="hljs-number">3.1415926</span>

<span class="hljs-comment">// 2. 类型推断：省略类型</span>
<span class="hljs-keyword">const</span> MaxScore = <span class="hljs-number">100</span>  <span class="hljs-comment">// 自动推断为int</span>

<span class="hljs-comment">// 3. 批量定义（分组形式，推荐）</span>
<span class="hljs-keyword">const</span> (
    AppName  <span class="hljs-type">string</span> = <span class="hljs-string">"GoDemo"</span>
    Version  = <span class="hljs-string">"v1.0.0"</span>
    MaxConn  = <span class="hljs-number">1000</span>  <span class="hljs-comment">// int类型</span>
    IsProEnv <span class="hljs-type">bool</span>    = <span class="hljs-literal">false</span>
)

</code></pre>
<p><strong>核心特性</strong>：</p>
<ul>
<li>
<p>常量的值必须是编译期可确定的（不能用运行时才能计算的值，比如函数返回值）；</p>
</li>
<li>
<p>常量一旦定义，值不可修改；</p>
</li>
<li>
<p>支持全局和局部声明（函数内、函数外都可）。</p>
</li>
</ul>
<p><strong>错误示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getNum</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 错误：常量值不能是运行时计算的函数返回值</span>
    <span class="hljs-comment">// const Num = getNum()  // 编译报错：const initializer getNum() is not a constant</span>
}

</code></pre>
<h3 data-id="heading-5">2.2 iota枚举机制</h3>
<p>在很多编程语言中，枚举需要手动给每个值赋值，而Go中的<code>iota</code>关键字可以自动生成连续的整数，简化枚举定义。</p>
<p><strong>核心规则</strong>：</p>
<ul>
<li>
<p><code>iota</code>只能在<code>const</code>分组中使用；</p>
</li>
<li>
<p>每组<code>const</code>中，<code>iota</code>从0开始，每新增一行常量，<code>iota</code>的值自动加1；</p>
</li>
<li>
<p>支持通过表达式自定义枚举值（比如乘、加等运算）。</p>
</li>
</ul>
<p><strong>示例1：基础枚举</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 定义星期枚举</span>
<span class="hljs-keyword">const</span> (
    Sunday    = <span class="hljs-literal">iota</span>  <span class="hljs-comment">// 0</span>
    Monday            <span class="hljs-comment">// 1（自动继承iota，等价于Monday = iota）</span>
    Tuesday           <span class="hljs-comment">// 2</span>
    Wednesday         <span class="hljs-comment">// 3</span>
    Thursday          <span class="hljs-comment">// 4</span>
    Friday            <span class="hljs-comment">// 5</span>
    Saturday          <span class="hljs-comment">// 6</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(Sunday, Monday, Saturday)  <span class="hljs-comment">// 输出：0 1 6</span>
}

</code></pre>
<p><strong>示例2：自定义枚举值</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 定义权限级别枚举（2的幂次，支持位运算）</span>
<span class="hljs-keyword">const</span> (
    ReadPermission = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-literal">iota</span>  <span class="hljs-comment">// 1 &lt;&lt; 0 = 1（二进制：0001）</span>
    WritePermission             <span class="hljs-comment">// 1 &lt;&lt; 1 = 2（0010）</span>
    ExecutePermission           <span class="hljs-comment">// 1 &lt;&lt; 2 = 4（0100）</span>
    DeletePermission            <span class="hljs-comment">// 1 &lt;&lt; 3 = 8（1000）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(ReadPermission, WritePermission, ExecutePermission, DeletePermission)
    <span class="hljs-comment">// 输出：1 2 4 8</span>

    <span class="hljs-comment">// 组合权限（位运算）</span>
    rwPermission := ReadPermission | WritePermission
    fmt.Println(rwPermission)  <span class="hljs-comment">// 输出：3（0011）</span>
}

</code></pre>
<p><strong>示例3：跳过枚举值</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-keyword">const</span> (
    A = <span class="hljs-literal">iota</span>  <span class="hljs-comment">// 0</span>
    B         <span class="hljs-comment">// 1</span>
    _         <span class="hljs-comment">// 2（跳过该值）</span>
    D         <span class="hljs-comment">// 3</span>
    E         <span class="hljs-comment">// 4</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(A, B, D, E)  <span class="hljs-comment">// 输出：0 1 3 4</span>
}

</code></pre>
<h2 data-id="heading-6">3. Go的基本数据类型体系</h2>
<p>Go是静态类型语言，每个变量都有明确的类型，且类型转换严格。Go的基本数据类型体系简洁清晰，没有冗余类型，主要分为四大类：<strong>数值类型、字符串类型、布尔类型、派生类型</strong>（指针、数组等，后续章节讲）。这里重点讲前三者。</p>
<h3 data-id="heading-7">3.1 数值类型</h3>
<p>数值类型分为整数型和浮点型，支持不同精度的需求。</p>
<p><strong>1. 整数型</strong>（按长度和有无符号划分）：</p>







































































<table><thead><tr><th>类型</th><th>占用字节</th><th>取值范围</th><th>说明</th></tr></thead><tbody><tr><td>int8</td><td>1</td><td>-128 ~ 127</td><td>有符号8位整数</td></tr><tr><td>uint8（byte）</td><td>1</td><td>0 ~ 255</td><td>无符号8位整数，byte是其别名（常用作字节存储）</td></tr><tr><td>int16</td><td>2</td><td>-32768 ~ 32767</td><td>有符号16位整数</td></tr><tr><td>uint16</td><td>2</td><td>0 ~ 65535</td><td>无符号16位整数</td></tr><tr><td>int32（rune）</td><td>4</td><td>-2147483648 ~ 2147483647</td><td>有符号32位整数，rune是其别名（常用作Unicode字符）</td></tr><tr><td>uint32</td><td>4</td><td>0 ~ 4294967295</td><td>无符号32位整数</td></tr><tr><td>int64</td><td>8</td><td>-9223372036854775808 ~ 9223372036854775807</td><td>有符号64位整数</td></tr><tr><td>uint64</td><td>8</td><td>0 ~ 18446744073709551615</td><td>无符号64位整数</td></tr><tr><td>int</td><td>32位系统4字节，64位系统8字节</td><td>随系统变化</td><td>默认整数类型，日常开发最常用</td></tr><tr><td>uint</td><td>随系统变化</td><td>随系统变化</td><td>无符号默认整数类型，少用</td></tr></tbody></table>
<p><strong>2. 浮点型</strong>（支持小数，按精度划分）：</p>























<table><thead><tr><th>类型</th><th>占用字节</th><th>精度</th><th>说明</th></tr></thead><tbody><tr><td>float32</td><td>4</td><td>约6-7位有效数字</td><td>单精度浮点型</td></tr><tr><td>float64</td><td>8</td><td>约15-17位有效数字</td><td>双精度浮点型，默认浮点类型，日常开发首选</td></tr></tbody></table>
<p><strong>数值类型示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int8</span> = <span class="hljs-number">-128</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">uint8</span> = <span class="hljs-number">255</span>
    <span class="hljs-keyword">var</span> c <span class="hljs-type">int</span> = <span class="hljs-number">1000</span>  <span class="hljs-comment">// 默认int类型</span>
    <span class="hljs-keyword">var</span> d <span class="hljs-type">float64</span> = <span class="hljs-number">3.1415926535</span>  <span class="hljs-comment">// 默认float64类型</span>
    <span class="hljs-keyword">var</span> e <span class="hljs-type">byte</span> = <span class="hljs-string">'A'</span>  <span class="hljs-comment">// byte是uint8别名，存储字符的ASCII码</span>
    <span class="hljs-keyword">var</span> f <span class="hljs-type">rune</span> = <span class="hljs-string">'中'</span> <span class="hljs-comment">// rune是int32别名，存储Unicode字符</span>

    fmt.Println(a, b, c, d)  <span class="hljs-comment">// 输出：-128 255 1000 3.1415926535</span>
    fmt.Println(e, <span class="hljs-type">string</span>(e))  <span class="hljs-comment">// 输出：65 A（ASCII码转字符）</span>
    fmt.Println(f, <span class="hljs-type">string</span>(f))  <span class="hljs-comment">// 输出：20013 中（Unicode码转字符）</span>
}

</code></pre>
<h3 data-id="heading-8">3.2 字符串类型（string）</h3>
<p>字符串用于存储文本，Go中的字符串是<strong>不可变的</strong>（一旦创建，不能修改单个字符），使用UTF-8编码。</p>
<p><strong>基本用法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 双引号定义（支持转义字符）</span>
    <span class="hljs-keyword">var</span> str1 <span class="hljs-type">string</span> = <span class="hljs-string">"Hello, Go!\n这是换行"</span>
    <span class="hljs-comment">// 2. 反引号定义（原样输出，不解析转义字符，支持多行）</span>
    <span class="hljs-keyword">var</span> str2 <span class="hljs-type">string</span> = <span class="hljs-string">`Hello, Go!
这是换行
这是第二行`</span>

    fmt.Println(str1)
    fmt.Println(<span class="hljs-string">"-----"</span>)
    fmt.Println(str2)

    <span class="hljs-comment">// 3. 字符串拼接</span>
    str3 := <span class="hljs-string">"Hello"</span>
    str4 := <span class="hljs-string">"World"</span>
    str5 := str3 + <span class="hljs-string">" "</span> + str4  <span class="hljs-comment">// 用+拼接</span>
    fmt.Println(str5)  <span class="hljs-comment">// 输出：Hello World</span>

    <span class="hljs-comment">// 4. 字符串长度（按字节计算，UTF-8中中文占3字节）</span>
    fmt.Println(<span class="hljs-built_in">len</span>(str5))        <span class="hljs-comment">// 输出：11（Hello World共11个字节）</span>
    fmt.Println(<span class="hljs-built_in">len</span>(<span class="hljs-string">"你好Go"</span>))     <span class="hljs-comment">// 输出：8（2个中文×3 + 2个字母×1 = 8）</span>
}

</code></pre>
<p><strong>注意</strong>：Go中字符串不可变，若要修改字符串，需先转为[]byte或[]rune切片，修改后再转回string（会创建新字符串），示例：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    str := <span class="hljs-string">"hello"</span>
    <span class="hljs-comment">// 错误：字符串不可变，不能直接修改单个字符</span>
    <span class="hljs-comment">// str[0] = 'H'  // 编译报错：cannot assign to str[0]</span>

    <span class="hljs-comment">// 正确：转为[]byte切片修改</span>
    byteSlice := []<span class="hljs-type">byte</span>(str)
    byteSlice[<span class="hljs-number">0</span>] = <span class="hljs-string">'H'</span>
    newStr := <span class="hljs-type">string</span>(byteSlice)
    fmt.Println(newStr)  <span class="hljs-comment">// 输出：Hello</span>

    <span class="hljs-comment">// 处理中文（用[]rune，避免乱码）</span>
    chineseStr := <span class="hljs-string">"你好"</span>
    runeSlice := []<span class="hljs-type">rune</span>(chineseStr)
    runeSlice[<span class="hljs-number">0</span>] = <span class="hljs-string">'我'</span>
    newChineseStr := <span class="hljs-type">string</span>(runeSlice)
    fmt.Println(newChineseStr)  <span class="hljs-comment">// 输出：我好</span>
}

</code></pre>
<h3 data-id="heading-9">3.3 布尔类型（bool）</h3>
<p>布尔类型只有两个值：<code>true</code>（真）和<code>false</code>（假），占用1个字节，主要用于条件判断。</p>
<p><strong>基本用法</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> isPass <span class="hljs-type">bool</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">var</span> isFail = <span class="hljs-literal">false</span>  <span class="hljs-comment">// 自动推断为bool类型</span>

    fmt.Println(isPass, isFail)  <span class="hljs-comment">// 输出：true false</span>

    <span class="hljs-comment">// 布尔类型不能参与数值运算（和其他语言不同）</span>
    <span class="hljs-comment">// 错误示例：</span>
    <span class="hljs-comment">// fmt.Println(isPass + 1)  // 编译报错：invalid operation: isPass + 1 (mismatched types bool and int)</span>

    <span class="hljs-comment">// 正确用法：条件判断</span>
    <span class="hljs-keyword">if</span> isPass {
        fmt.Println(<span class="hljs-string">"考试通过"</span>)
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"考试失败"</span>)
    }
}

</code></pre>
<h2 data-id="heading-10">4. 零值机制与类型默认值</h2>
<p>Go有一个很贴心的设计：<strong>任何声明后未赋值的变量，都会被自动赋予对应类型的“零值”</strong>，无需手动初始化。这避免了未初始化变量导致的垃圾值问题，也简化了代码。</p>
<p><strong>各类型零值</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 数值类型零值：0（所有整数、浮点型）</span>
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span>     <span class="hljs-comment">// 0</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">float64</span> <span class="hljs-comment">// 0</span>
    <span class="hljs-keyword">var</span> c <span class="hljs-type">byte</span>    <span class="hljs-comment">// 0</span>

    <span class="hljs-comment">// 字符串类型零值：空字符串（""）</span>
    <span class="hljs-keyword">var</span> d <span class="hljs-type">string</span>  <span class="hljs-comment">// ""</span>

    <span class="hljs-comment">// 布尔类型零值：false</span>
    <span class="hljs-keyword">var</span> e <span class="hljs-type">bool</span>    <span class="hljs-comment">// false</span>

    fmt.Println(a, b, c, d == <span class="hljs-string">""</span>, e)
    <span class="hljs-comment">// 输出：0 0 0 true false</span>
}

</code></pre>
<p><strong>实用场景</strong>：比如定义结构体时，无需逐个初始化字段，未赋值的字段会自动使用零值，简化代码。后续讲结构体时会详细举例。</p>
<h2 data-id="heading-11">5. 类型推断与显式转换</h2>
<p>Go支持类型推断（自动判断变量类型），但不支持隐式类型转换（不同类型不能直接赋值），必须显式转换。</p>
<h3 data-id="heading-12">5.1 类型推断</h3>
<p>当声明变量时不指定类型，Go会根据赋值的值自动推断类型，这是日常开发中常用的方式，能简化代码。</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 自动推断为int</span>
    num := <span class="hljs-number">100</span>
    <span class="hljs-comment">// 自动推断为float64</span>
    score := <span class="hljs-number">98.5</span>
    <span class="hljs-comment">// 自动推断为string</span>
    name := <span class="hljs-string">"Gopher"</span>
    <span class="hljs-comment">// 自动推断为bool</span>
    isOk := <span class="hljs-literal">true</span>

    <span class="hljs-comment">// 用fmt.Printf的%T格式符查看变量类型</span>
    fmt.Printf(<span class="hljs-string">"num类型：%T\n"</span>, num)    <span class="hljs-comment">// 输出：num类型：int</span>
    fmt.Printf(<span class="hljs-string">"score类型：%T\n"</span>, score)  <span class="hljs-comment">// 输出：score类型：float64</span>
    fmt.Printf(<span class="hljs-string">"name类型：%T\n"</span>, name)    <span class="hljs-comment">// 输出：name类型：string</span>
    fmt.Printf(<span class="hljs-string">"isOk类型：%T\n"</span>, isOk)    <span class="hljs-comment">// 输出：isOk类型：bool</span>
}

</code></pre>
<h3 data-id="heading-13">5.2 显式类型转换</h3>
<p>Go是强类型语言，不同类型的变量不能直接赋值或运算，必须通过<code>类型(变量)</code>的方式进行显式转换。</p>
<p><strong>基本语法</strong>：<code>目标类型(源变量)</code></p>
<p><strong>正确示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">100</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">float64</span>

    <span class="hljs-comment">// 显式转换：int -&gt; float64</span>
    b = <span class="hljs-type">float64</span>(a)
    fmt.Println(b)  <span class="hljs-comment">// 输出：100</span>

    <span class="hljs-keyword">var</span> c <span class="hljs-type">float64</span> = <span class="hljs-number">3.14</span>
    <span class="hljs-keyword">var</span> d <span class="hljs-type">int</span>

    <span class="hljs-comment">// 显式转换：float64 -&gt; int（会截断小数部分，不是四舍五入）</span>
    d = <span class="hljs-type">int</span>(c)
    fmt.Println(d)  <span class="hljs-comment">// 输出：3</span>

    <span class="hljs-keyword">var</span> e <span class="hljs-type">byte</span> = <span class="hljs-string">'A'</span>
    <span class="hljs-keyword">var</span> f <span class="hljs-type">int</span> = <span class="hljs-type">int</span>(e)
    fmt.Println(f)  <span class="hljs-comment">// 输出：65（ASCII码）</span>
}

</code></pre>
<p><strong>错误示例</strong>（隐式转换）：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">100</span>
    <span class="hljs-keyword">var</span> b <span class="hljs-type">float64</span>

    <span class="hljs-comment">// 错误：隐式转换不允许</span>
    <span class="hljs-comment">// b = a  // 编译报错：cannot use a (type int) as type float64 in assignment</span>
}

</code></pre>
<p><strong>注意</strong>：显式转换只能在兼容的类型之间进行（比如数值类型之间、byte/rune与int之间），不兼容的类型无法转换（比如int和string）。若要实现int转string，需使用<code>strconv</code>包，示例：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"strconv"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> num <span class="hljs-type">int</span> = <span class="hljs-number">123</span>
    <span class="hljs-comment">// int -&gt; string（使用strconv.Itoa）</span>
    str := strconv.Itoa(num)
    fmt.Printf(<span class="hljs-string">"str类型：%T，值：%s\n"</span>, str, str)  <span class="hljs-comment">// 输出：str类型：string，值：123</span>

    <span class="hljs-comment">// string -&gt; int（使用strconv.Atoi）</span>
    str2 := <span class="hljs-string">"456"</span>
    num2, err := strconv.Atoi(str2)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"转换失败："</span>, err)
    } <span class="hljs-keyword">else</span> {
        fmt.Printf(<span class="hljs-string">"num2类型：%T，值：%d\n"</span>, num2, num2)  <span class="hljs-comment">// 输出：num2类型：int，值：456</span>
    }
}

</code></pre>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fstrconv" target="_blank" title="https://pkg.go.dev/strconv" ref="nofollow noopener noreferrer">strconv包官方文档</a></p>
<h2 data-id="heading-14">6. 短变量声明的作用域规则</h2>
<p>作用域是指变量的有效范围，在该范围内变量可以被访问，超出范围则无法访问。短变量声明（:=）的作用域规则和var声明基本一致，但有一些细节需要注意。</p>
<p><strong>核心作用域规则</strong>：</p>
<ol>
<li>
<p>函数内声明的变量（var或:=）：作用域是整个函数，但在代码块（if、for、switch等{}包裹的区域）内声明的变量，作用域仅限于该代码块；</p>
</li>
<li>
<p>短变量声明在代码块内声明时，若与外部变量同名，会“遮蔽”外部变量（即代码块内访问的是内部变量，外部变量不受影响）；</p>
</li>
<li>
<p>全局变量（函数外用var声明）：作用域是整个包，包内所有函数都可访问；短变量声明不能用于全局变量。</p>
</li>
</ol>
<p><strong>示例1：代码块内的作用域</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 函数内变量，作用域覆盖整个main函数</span>
    <span class="hljs-keyword">var</span> a <span class="hljs-type">int</span> = <span class="hljs-number">10</span>

    <span class="hljs-keyword">if</span> <span class="hljs-literal">true</span> {
        <span class="hljs-comment">// 代码块内用:=声明的变量，作用域仅限于if代码块</span>
        b := <span class="hljs-number">20</span>
        fmt.Println(a, b)  <span class="hljs-comment">// 输出：10 20（可访问a和b）</span>
    }

    fmt.Println(a)  <span class="hljs-comment">// 输出：10（可访问a）</span>
    <span class="hljs-comment">// fmt.Println(b)  // 错误：b未定义（超出作用域）</span>
}

</code></pre>
<p><strong>示例2：变量遮蔽</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    x := <span class="hljs-number">100</span>  <span class="hljs-comment">// 外部变量x</span>

    <span class="hljs-keyword">if</span> <span class="hljs-literal">true</span> {
        x := <span class="hljs-number">200</span>  <span class="hljs-comment">// 内部变量x，遮蔽外部x</span>
        fmt.Println(<span class="hljs-string">"内部x："</span>, x)  <span class="hljs-comment">// 输出：内部x：200（访问内部x）</span>
    }

    fmt.Println(<span class="hljs-string">"外部x："</span>, x)  <span class="hljs-comment">// 输出：外部x：100（外部x未被修改）</span>
}

</code></pre>
<p><strong>示例3：全局变量与局部变量</strong></p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 全局变量（var声明），作用域是整个包</span>
<span class="hljs-keyword">var</span> globalVar <span class="hljs-type">string</span> = <span class="hljs-string">"我是全局变量"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(globalVar)  <span class="hljs-comment">// 输出：我是全局变量（可访问全局变量）</span>
    testFunc()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testFunc</span><span class="hljs-params">()</span></span> {
    fmt.Println(globalVar)  <span class="hljs-comment">// 输出：我是全局变量（其他函数也可访问）</span>
}

<span class="hljs-comment">// 错误：全局变量不能用短声明</span>
<span class="hljs-comment">// globalVar2 := "错误示例"  // 编译报错：syntax error: non-declaration statement outside function body</span>

</code></pre>
<h2 data-id="heading-15">7. 命名规范：驼峰与导出规则</h2>
<p>好的命名规范能让代码更易读、易维护，Go社区有明确的命名规范，核心是“驼峰命名”和“首字母大小写控制导出”。</p>
<h3 data-id="heading-16">7.1 驼峰命名规则</h3>
<p>根据变量/函数/常量的名称长度，分为两种驼峰方式：</p>
<ul>
<li>
<p><strong>小驼峰（lowerCamelCase）</strong>：首字母小写，后续单词首字母大写。适用于局部变量、函数内的私有变量/函数；</p>
</li>
<li>
<p><strong>大驼峰（UpperCamelCase）</strong>：首字母大写，后续单词首字母大写。适用于全局变量、函数、结构体、接口等需要导出的标识符。</p>
</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 全局变量（导出，大驼峰）</span>
<span class="hljs-keyword">var</span> UserName <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>

<span class="hljs-comment">// 函数（导出，大驼峰）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfo</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 局部变量（私有，小驼峰）</span>
    userAge := <span class="hljs-number">25</span>
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"姓名：%s，年龄：%d"</span>, UserName, userAge)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(GetUserInfo())  <span class="hljs-comment">// 输出：姓名：Gopher，年龄：25</span>
}

</code></pre>
<h3 data-id="heading-17">7.2 导出规则（首字母大小写）</h3>
<p>Go中没有<code>public</code>、<code>private</code>关键字，而是通过标识符的首字母大小写来控制是否“导出”（即是否能被其他包访问）：</p>
<ul>
<li>
<p>首字母大写：可导出，其他包可通过“包名.标识符”访问；</p>
</li>
<li>
<p>首字母小写：不可导出，只能在当前包内访问。</p>
</li>
</ul>
<p><strong>示例（跨包访问）</strong>：</p>
<p>假设有两个包：<code>main</code>包和<code>utils</code>包（目录结构如下）：</p>
<pre><code class="hljs language-text" lang="text">
project/
├── main.go（main包）
└── utils/
    └── tool.go（utils包）

</code></pre>
<ol>
<li>utils/tool.go（utils包）：</li>
</ol>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> utils

<span class="hljs-comment">// 首字母大写，可导出</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetVersion</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"v1.0.0"</span>
}

<span class="hljs-comment">// 首字母小写，不可导出</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getAuthor</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Gopher"</span>
}

</code></pre>
<ol start="2">
<li>main.go（main包）：</li>
</ol>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"project/utils"</span>  <span class="hljs-comment">// 导入utils包（实际路径根据项目模块调整）</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 访问utils包的导出函数（首字母大写）</span>
    fmt.Println(utils.GetVersion())  <span class="hljs-comment">// 输出：v1.0.0</span>

    <span class="hljs-comment">// 错误：无法访问不可导出的函数（首字母小写）</span>
    <span class="hljs-comment">// fmt.Println(utils.getAuthor())  // 编译报错：cannot refer to unexported name utils.getAuthor</span>
}

</code></pre>
<p><strong>命名补充规范</strong>：</p>
<ul>
<li>
<p>包名：全小写，简洁明了，不使用下划线（比如<code>utils</code>、<code>net/http</code>）；</p>
</li>
<li>
<p>常量名：若为枚举或全局常量，推荐全大写+下划线（比如<code>MAX_CONN</code>）；若为局部常量，可用小驼峰；</p>
</li>
<li>
<p>避免使用关键字作为标识符（Go的关键字共25个，比如<code>var</code>、<code>func</code>、<code>if</code>等）。</p>
</li>
</ul>
<p>Go关键字参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Keywords" target="_blank" title="https://go.dev/ref/spec#Keywords" ref="nofollow noopener noreferrer">Go官方关键字文档</a></p>
<h2 data-id="heading-18">8. 代码格式化与go fmt工具</h2>
<p>代码格式不统一会严重影响团队协作效率，Go官方提供了<code>go fmt</code>工具，能自动格式化代码，强制统一代码风格，无需手动调整缩进、换行等格式问题。</p>
<h3 data-id="heading-19">8.1 go fmt的核心作用</h3>
<ul>
<li>
<p>自动调整缩进（使用4个空格，不推荐制表符）；</p>
</li>
<li>
<p>自动调整换行（比如函数体{}的位置、import分组的格式）；</p>
</li>
<li>
<p>自动调整空格（比如运算符前后、逗号后加空格）；</p>
</li>
<li>
<p>统一代码风格，避免团队内格式争议。</p>
</li>
</ul>
<h3 data-id="heading-20">8.2 使用方法</h3>
<p><code>go fmt</code>是Go工具链自带的，安装Go后即可使用，支持两种常用方式：</p>
<p><strong>1. 格式化单个文件</strong></p>
<pre><code class="hljs language-bash" lang="bash">
go <span class="hljs-built_in">fmt</span> main.go

</code></pre>
<p>执行后，会直接修改<code>main.go</code>文件的格式，使其符合规范。</p>
<p><strong>2. 格式化整个目录（包括子目录）</strong></p>
<pre><code class="hljs language-bash" lang="bash">
go <span class="hljs-built_in">fmt</span> ./...

</code></pre>
<p><code>./...</code>表示当前目录及其所有子目录，执行后会格式化目录下所有的.go文件。</p>
<h3 data-id="heading-21">8.3 集成到IDE（自动格式化）</h3>
<p>日常开发中，无需手动执行<code>go fmt</code>命令，主流IDE（VS Code、Goland）都支持自动格式化：</p>
<ul>
<li>
<p>VS Code：安装Go插件后，开启“保存时格式化”。设置路径：File -&gt; Preferences -&gt; Settings，搜索“Format On Save”，勾选即可。</p>
</li>
<li>
<p>Goland：默认开启自动格式化，保存文件时会自动调整格式。若需手动触发，可使用快捷键<code>Ctrl+Alt+L</code>（Windows）或<code>Cmd+Opt+L</code>（Mac）。</p>
</li>
</ul>
<h3 data-id="heading-22">8.4 示例：格式化前后对比</h3>
<p><strong>格式化前（不规范）</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
<span class="hljs-keyword">var</span> name <span class="hljs-type">string</span>=<span class="hljs-string">"Gopher"</span>
fmt.Println(name)
}

</code></pre>
<p><strong>执行go fmt后（规范）</strong>：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-type">string</span> = <span class="hljs-string">"Gopher"</span>
    fmt.Println(name)
}

</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>本章我们掌握了Go基础语法的核心——变量、常量与数据类型，重点总结：</p>
<ol>
<li>
<p>变量声明：var适用于全局/需明确类型的场景，短声明（:=）适用于函数内快速声明，注意作用域规则；</p>
</li>
<li>
<p>常量：用const定义，iota能简化枚举定义，支持自动生成连续整数；</p>
</li>
<li>
<p>数据类型：核心是数值、字符串、布尔类型，记住各类型的零值和特性（比如字符串不可变）；</p>
</li>
<li>
<p>类型转换：Go不支持隐式转换，需用显式转换，不兼容类型（int和string）需用strconv包；</p>
</li>
<li>
<p>命名与格式：遵循驼峰命名，首字母大小写控制导出；用go fmt自动格式化代码，统一风格。</p>
</li>
</ol>
<p>这些知识点是后续学习流程控制、函数、结构体等内容的基础，建议多写代码练习，比如用变量和常量实现一个简单的计算器，巩固今天的知识点。如果有任何问题，欢迎在评论区交流～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么面试问得越细的公司反而越容易没下文？]]></title>    <link>https://juejin.cn/post/7597699796200669194</link>    <guid>https://juejin.cn/post/7597699796200669194</guid>    <pubDate>2026-01-22T00:42:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597699796200669194" data-draft-id="7597623392457162803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么面试问得越细的公司反而越容易没下文？"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2026-01-22T00:42:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么面试问得越细的公司反而越容易没下文？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-22T00:42:10.000Z" title="Thu Jan 22 2026 00:42:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近看到一个职场社区帖子，说的是面试和 offer 相关的话题，参与讨论的同学非常多。</p>
<p>问题描述差不多是这样：</p>
<blockquote>
<p>“我发现凡是给 offer 的公司，面试时基本不问技术细节，那些问得又多又细的公司，后面基本就没下文了……”</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5151a6c7e114ff799bc32e61b0a88f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769647330&amp;x-signature=Dv4fPEiVFKqiRoCpoeuLJZytTD4%3D" alt="" loading="lazy"/></p>
<p>那关于这个问题，不知道大家有没有类似的体验或者经历？</p>
<p>你信心满满地去一家公司，面试官是个看起来技术大拿模样的人，一上来就给你整了个高并发场景下的分布式锁实现，问你 JVM 调优的十八般武艺，甚至还要跟你探讨一下 Linux 内核的源码细节。</p>
<p>你虽然答得满头大汗，但自我感觉还不错，仿佛自己把毕生所学都展示出来了。</p>
<p>但是最后结果呢？客气地送你一句等通知，然后便石沉大海。或者回去等了个三五天、一个星期，最后等来的是一句冰冷的不合适。</p>
<p>而反观另外一些面试经历，你可能就是抱着去溜达一圈的心态去转转的，面试让你感觉像在聊天，聊聊项目，聊聊过往经历，聊聊技术。</p>
<p>你心里还在犯嘀咕，没了？就这？</p>
<p>结果第二天，HR 就打电话过来找你谈薪，然后询问入职时间，速度快得让你怀疑人生。</p>
<p>看到这里，你是不是也挺疑惑，这到底是为什么？</p>
<p>难道某些公司就爱玩反向筛选？还是说问技术细节本身就是一种送客的委婉方式？这背后到底有没有什么可以遵循的逻辑原理可以分析分析。</p>
<p>所以今天咱们也用一篇文章的篇幅来聊一聊这个话题，也欢迎大家分享交流自己的观点和看法。</p>
<hr/>
<p>对于那些问得又细又深，最后却没给 offer 的，往往有这么几种情况。</p>
<p>第一种，也是最现实、最常见的<strong>大环境筛选</strong>。</p>
<p>什么意思呢？</p>
<p>现在的求职大环境大家也知道，岗位有限，候选人太多。HR 和面试官手里攥着一堆 985、211 甚至大厂背景的简历。</p>
<p>简单点说，他们不缺候选人，所以他们有资格挑。</p>
<p>对于中间段位的候选人，也就是我们大多数普通人，他们不需要看你有多优秀，只需要找出你简历里的一个瑕疵，一个技术细节没答上来，或许就有可能会把你刷掉。毕竟对于他们来说，能选择的太多。</p>
<p>其次，还有一个比较现实的问题是，对于<strong>那些问得细的公司，不代表真的招人</strong>。</p>
<p>当一个团队实际并不缺人，或者只是抱着宁缺毋滥的心态在招人时，他们就有资本去挑刺。</p>
<p>这时候面试官常常带着一种找漏洞的心态。他们的问题像一张细密的筛网，目的似乎不是看你有多合适，而是为了证明你哪里不合适。</p>
<p>说实话，这种还是挺恶心的。</p>
<p>第三种，也是最最扎心的一种情况：<strong>你只是他们的「免费咨询顾问」</strong>。</p>
<p>更直白一点说就是在套方案。</p>
<p>现在的行情下，很多公司业务停滞，不怎么招人，但又面临一些棘手的技术难题。</p>
<p>他们打着招聘的旗号，实际上是把市场上优秀的工程师请过来，所谓的面试其实也就是一场免费的头脑风暴。他们会故意引导你去讲你上一家公司的架构设计、服务拆分方案、甚至是具体的排错思路。</p>
<p>整个面试过程你自认为胸有成竹，方案和思路也讲得滔滔不绝，殊不知，人家还另有企图呢。</p>
<p>有一说一，这种是最最恶心的一种情况。</p>
<hr/>
<p>而对于那些问得不多、但 offer 倒是给的挺痛快的公司，通常又是怎么回事呢？</p>
<p>首先，这往往意味着这个公司是**「真·缺人」**呐。</p>
<p>这种公司通常处于一种“生死存亡”或者业务极速扩张的阶段。老板或者团队负责人可能已经被缺人折磨得寝食难安了。</p>
<p>他们的核心诉求非常明确：找个能立刻干活、能立刻上手的人。</p>
<p>这时候，他们不会跟你去扯什么虚头巴脑的设计模式，更不会去考你那些冷门的技术知识。</p>
<p>他们关心的是：你能不能明天就来上班，你能不能把这个烂摊子代码接过去维护，你能不能抗住连续一个月的强度。</p>
<p>在这种极度的需求面前，所谓的技术细节反倒成了次要的。</p>
<p>但是说实话，这种 offer 虽然来得容易，但兄弟记住，<strong>这往往也是把双刃剑</strong>。</p>
<p>因为“真·缺人”的背后，往往意味着技术债巨多、管理混乱，或者是一个谁都不愿意接的坑。</p>
<p>拿到这种 offer，你既可能是一飞冲天的救世主，也有可能是一头扎进泥潭的接盘侠。</p>
<p>当然，还有一种情况，虽然不那么好听，但也必须提一嘴。</p>
<p>那就是，有些公司其实是在广撒网。他们可能并没有确切的 HC，或者他们需要的只是一个廉价的劳动力。</p>
<p>对于这种公司，问太多技术细节反而会吓跑你，他们更希望用更轻松的面试体验和更高薪的承诺来把你招进去，至于技术匹配度嘛，额……那是入职以后的事情了。</p>
<hr/>
<p>文章的最后这里想说的是，面试是一个双向选择的过程，也是一个互相试探的过程。</p>
<p>当你遇到那个问得特别细的面试官时，别急着心里骂娘，也别急着觉得自己没戏了。你可以试着把这场技术拷问变成一场技术交流。</p>
<p>如果对方是在套方案，你可以适当保留，点到为止；如果对方是真的在考察技术深度，那正好展示你的技术功底。</p>
<p>而当你遇到那个聊两句就给 offer 的公司时，也别急着狂喜。</p>
<p>可以<strong>多问问团队现状，问问业务体量，问问技术栈，这时候，一定要记住，你该反问的要反问，该考察的要考察</strong>。</p>
<p>因为虽说大环境寒冷，但是我觉得<strong>找到一个不坑的公司有时候比拿到一个所谓的 offer 更加重要</strong>，大家觉得呢？</p>
<p>好了，今天就先聊这么多吧，希望能对大家有所启发，我们下篇见。</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>